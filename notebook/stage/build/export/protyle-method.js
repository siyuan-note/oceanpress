(()=>{var Vl=(Kt,Ke)=>()=>(Ke||Kt((Ke={exports:{}}).exports,Ke),Ke.exports);var Gl=Vl((Aa,Cn)=>{(function(Ke,Me){typeof Aa=="object"&&typeof Cn=="object"?Cn.exports=Me():typeof define=="function"&&define.amd?define([],Me):typeof Aa=="object"?Aa.Protyle=Me():Ke.Protyle=Me()})(self,()=>(()=>{var Kt={752:function(Te){(function(fe,re){Te.exports=re()})(this,function(){"use strict";var fe=1e3,re=6e4,vt=36e5,He="millisecond",ce="second",B="minute",$="hour",W="day",K="week",Z="month",Y="quarter",Q="year",ie="date",Ie="Invalid Date",ke=/^(\d{4})[-/]?(\d{1,2})?[-/]?(\d{0,2})[Tt\s]*(\d{1,2})?:?(\d{1,2})?:?(\d{1,2})?[.:]?(\d+)?$/,ue=/\[([^\]]+)]|Y{1,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,Dt={name:"en",weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_")},Et=function(X,F,O){var ee=String(X);return!ee||ee.length>=F?X:""+Array(F+1-ee.length).join(O)+X},Pe={s:Et,z:function(X){var F=-X.utcOffset(),O=Math.abs(F),ee=Math.floor(O/60),q=O%60;return(F<=0?"+":"-")+Et(ee,2,"0")+":"+Et(q,2,"0")},m:function X(F,O){if(F.date()<O.date())return-X(O,F);var ee=12*(O.year()-F.year())+(O.month()-F.month()),q=F.clone().add(ee,Z),j=O-q<0,z=F.clone().add(ee+(j?-1:1),Z);return+(-(ee+(O-q)/(j?q-z:z-q))||0)},a:function(X){return X<0?Math.ceil(X)||0:Math.floor(X)},p:function(X){return{M:Z,y:Q,w:K,d:W,D:ie,h:$,m:B,s:ce,ms:He,Q:Y}[X]||String(X||"").toLowerCase().replace(/s$/,"")},u:function(X){return X===void 0}},st="en",Qe={};Qe[st]=Dt;var $t=function(X){return X instanceof ze},kt=function X(F,O,ee){var q;if(!F)return st;if(typeof F=="string"){var j=F.toLowerCase();Qe[j]&&(q=j),O&&(Qe[j]=O,q=j);var z=F.split("-");if(!q&&z.length>1)return X(z[0])}else{var J=F.name;Qe[J]=F,q=J}return!ee&&q&&(st=q),q||!ee&&st},se=function(X,F){if($t(X))return X.clone();var O=typeof F=="object"?F:{};return O.date=X,O.args=arguments,new ze(O)},de=Pe;de.l=kt,de.i=$t,de.w=function(X,F){return se(X,{locale:F.$L,utc:F.$u,x:F.$x,$offset:F.$offset})};var ze=function(){function X(O){this.$L=kt(O.locale,null,!0),this.parse(O)}var F=X.prototype;return F.parse=function(O){this.$d=function(ee){var q=ee.date,j=ee.utc;if(q===null)return new Date(NaN);if(de.u(q))return new Date;if(q instanceof Date)return new Date(q);if(typeof q=="string"&&!/Z$/i.test(q)){var z=q.match(ke);if(z){var J=z[2]-1||0,oe=(z[7]||"0").substring(0,3);return j?new Date(Date.UTC(z[1],J,z[3]||1,z[4]||0,z[5]||0,z[6]||0,oe)):new Date(z[1],J,z[3]||1,z[4]||0,z[5]||0,z[6]||0,oe)}}return new Date(q)}(O),this.$x=O.x||{},this.init()},F.init=function(){var O=this.$d;this.$y=O.getFullYear(),this.$M=O.getMonth(),this.$D=O.getDate(),this.$W=O.getDay(),this.$H=O.getHours(),this.$m=O.getMinutes(),this.$s=O.getSeconds(),this.$ms=O.getMilliseconds()},F.$utils=function(){return de},F.isValid=function(){return this.$d.toString()!==Ie},F.isSame=function(O,ee){var q=se(O);return this.startOf(ee)<=q&&q<=this.endOf(ee)},F.isAfter=function(O,ee){return se(O)<this.startOf(ee)},F.isBefore=function(O,ee){return this.endOf(ee)<se(O)},F.$g=function(O,ee,q){return de.u(O)?this[ee]:this.set(q,O)},F.unix=function(){return Math.floor(this.valueOf()/1e3)},F.valueOf=function(){return this.$d.getTime()},F.startOf=function(O,ee){var q=this,j=!!de.u(ee)||ee,z=de.p(O),J=function(ot,me){var Ye=de.w(q.$u?Date.UTC(q.$y,me,ot):new Date(q.$y,me,ot),q);return j?Ye:Ye.endOf(W)},oe=function(ot,me){return de.w(q.toDate()[ot].apply(q.toDate("s"),(j?[0,0,0,0]:[23,59,59,999]).slice(me)),q)},le=this.$W,ye=this.$M,Ue=this.$D,Fe="set"+(this.$u?"UTC":"");switch(z){case Q:return j?J(1,0):J(31,11);case Z:return j?J(1,ye):J(0,ye+1);case K:var et=this.$locale().weekStart||0,it=(le<et?le+7:le)-et;return J(j?Ue-it:Ue+(6-it),ye);case W:case ie:return oe(Fe+"Hours",0);case $:return oe(Fe+"Minutes",1);case B:return oe(Fe+"Seconds",2);case ce:return oe(Fe+"Milliseconds",3);default:return this.clone()}},F.endOf=function(O){return this.startOf(O,!1)},F.$set=function(O,ee){var q,j=de.p(O),z="set"+(this.$u?"UTC":""),J=(q={},q[W]=z+"Date",q[ie]=z+"Date",q[Z]=z+"Month",q[Q]=z+"FullYear",q[$]=z+"Hours",q[B]=z+"Minutes",q[ce]=z+"Seconds",q[He]=z+"Milliseconds",q)[j],oe=j===W?this.$D+(ee-this.$W):ee;if(j===Z||j===Q){var le=this.clone().set(ie,1);le.$d[J](oe),le.init(),this.$d=le.set(ie,Math.min(this.$D,le.daysInMonth())).$d}else J&&this.$d[J](oe);return this.init(),this},F.set=function(O,ee){return this.clone().$set(O,ee)},F.get=function(O){return this[de.p(O)]()},F.add=function(O,ee){var q,j=this;O=Number(O);var z=de.p(ee),J=function(ye){var Ue=se(j);return de.w(Ue.date(Ue.date()+Math.round(ye*O)),j)};if(z===Z)return this.set(Z,this.$M+O);if(z===Q)return this.set(Q,this.$y+O);if(z===W)return J(1);if(z===K)return J(7);var oe=(q={},q[B]=re,q[$]=vt,q[ce]=fe,q)[z]||1,le=this.$d.getTime()+O*oe;return de.w(le,this)},F.subtract=function(O,ee){return this.add(-1*O,ee)},F.format=function(O){var ee=this,q=this.$locale();if(!this.isValid())return q.invalidDate||Ie;var j=O||"YYYY-MM-DDTHH:mm:ssZ",z=de.z(this),J=this.$H,oe=this.$m,le=this.$M,ye=q.weekdays,Ue=q.months,Fe=function(me,Ye,Zt,We){return me&&(me[Ye]||me(ee,j))||Zt[Ye].slice(0,We)},et=function(me){return de.s(J%12||12,me,"0")},it=q.meridiem||function(me,Ye,Zt){var We=me<12?"AM":"PM";return Zt?We.toLowerCase():We},ot={YY:String(this.$y).slice(-2),YYYY:this.$y,M:le+1,MM:de.s(le+1,2,"0"),MMM:Fe(q.monthsShort,le,Ue,3),MMMM:Fe(Ue,le),D:this.$D,DD:de.s(this.$D,2,"0"),d:String(this.$W),dd:Fe(q.weekdaysMin,this.$W,ye,2),ddd:Fe(q.weekdaysShort,this.$W,ye,3),dddd:ye[this.$W],H:String(J),HH:de.s(J,2,"0"),h:et(1),hh:et(2),a:it(J,oe,!0),A:it(J,oe,!1),m:String(oe),mm:de.s(oe,2,"0"),s:String(this.$s),ss:de.s(this.$s,2,"0"),SSS:de.s(this.$ms,3,"0"),Z:z};return j.replace(ue,function(me,Ye){return Ye||ot[me]||z.replace(":","")})},F.utcOffset=function(){return 15*-Math.round(this.$d.getTimezoneOffset()/15)},F.diff=function(O,ee,q){var j,z=de.p(ee),J=se(O),oe=(J.utcOffset()-this.utcOffset())*re,le=this-J,ye=de.m(this,J);return ye=(j={},j[Q]=ye/12,j[Z]=ye,j[Y]=ye/3,j[K]=(le-oe)/6048e5,j[W]=(le-oe)/864e5,j[$]=le/vt,j[B]=le/re,j[ce]=le/fe,j)[z]||le,q?ye:de.a(ye)},F.daysInMonth=function(){return this.endOf(Z).$D},F.$locale=function(){return Qe[this.$L]},F.locale=function(O,ee){if(!O)return this.$L;var q=this.clone(),j=kt(O,ee,!0);return j&&(q.$L=j),q},F.clone=function(){return de.w(this.$d,this)},F.toDate=function(){return new Date(this.valueOf())},F.toJSON=function(){return this.isValid()?this.toISOString():null},F.toISOString=function(){return this.$d.toISOString()},F.toString=function(){return this.$d.toUTCString()},X}(),S=ze.prototype;return se.prototype=S,[["$ms",He],["$s",ce],["$m",B],["$H",$],["$W",W],["$M",Z],["$y",Q],["$D",ie]].forEach(function(X){S[X[1]]=function(F){return this.$g(F,X[0],X[1])}}),se.extend=function(X,F){return X.$i||(X(F,ze,se),X.$i=!0),se},se.locale=kt,se.isDayjs=$t,se.unix=function(X){return se(1e3*X)},se.en=Qe[st],se.Ls=Qe,se.p={},se})},101:Te=>{"use strict";function fe(ce){if(typeof ce!="string")throw new TypeError("Path must be a string. Received "+JSON.stringify(ce))}function re(ce,B){for(var $="",W=0,K=-1,Z=0,Y,Q=0;Q<=ce.length;++Q){if(Q<ce.length)Y=ce.charCodeAt(Q);else{if(Y===47)break;Y=47}if(Y===47){if(!(K===Q-1||Z===1))if(K!==Q-1&&Z===2){if($.length<2||W!==2||$.charCodeAt($.length-1)!==46||$.charCodeAt($.length-2)!==46){if($.length>2){var ie=$.lastIndexOf("/");if(ie!==$.length-1){ie===-1?($="",W=0):($=$.slice(0,ie),W=$.length-1-$.lastIndexOf("/")),K=Q,Z=0;continue}}else if($.length===2||$.length===1){$="",W=0,K=Q,Z=0;continue}}B&&($.length>0?$+="/..":$="..",W=2)}else $.length>0?$+="/"+ce.slice(K+1,Q):$=ce.slice(K+1,Q),W=Q-K-1;K=Q,Z=0}else Y===46&&Z!==-1?++Z:Z=-1}return $}function vt(ce,B){var $=B.dir||B.root,W=B.base||(B.name||"")+(B.ext||"");return $?$===B.root?$+W:$+ce+W:W}var He={resolve:function(){for(var B="",$=!1,W,K=arguments.length-1;K>=-1&&!$;K--){var Z;K>=0?Z=arguments[K]:(W===void 0&&(W=process.cwd()),Z=W),fe(Z),Z.length!==0&&(B=Z+"/"+B,$=Z.charCodeAt(0)===47)}return B=re(B,!$),$?B.length>0?"/"+B:"/":B.length>0?B:"."},normalize:function(B){if(fe(B),B.length===0)return".";var $=B.charCodeAt(0)===47,W=B.charCodeAt(B.length-1)===47;return B=re(B,!$),B.length===0&&!$&&(B="."),B.length>0&&W&&(B+="/"),$?"/"+B:B},isAbsolute:function(B){return fe(B),B.length>0&&B.charCodeAt(0)===47},join:function(){if(arguments.length===0)return".";for(var B,$=0;$<arguments.length;++$){var W=arguments[$];fe(W),W.length>0&&(B===void 0?B=W:B+="/"+W)}return B===void 0?".":He.normalize(B)},relative:function(B,$){if(fe(B),fe($),B===$||(B=He.resolve(B),$=He.resolve($),B===$))return"";for(var W=1;W<B.length&&B.charCodeAt(W)===47;++W);for(var K=B.length,Z=K-W,Y=1;Y<$.length&&$.charCodeAt(Y)===47;++Y);for(var Q=$.length,ie=Q-Y,Ie=Z<ie?Z:ie,ke=-1,ue=0;ue<=Ie;++ue){if(ue===Ie){if(ie>Ie){if($.charCodeAt(Y+ue)===47)return $.slice(Y+ue+1);if(ue===0)return $.slice(Y+ue)}else Z>Ie&&(B.charCodeAt(W+ue)===47?ke=ue:ue===0&&(ke=0));break}var Dt=B.charCodeAt(W+ue),Et=$.charCodeAt(Y+ue);if(Dt!==Et)break;Dt===47&&(ke=ue)}var Pe="";for(ue=W+ke+1;ue<=K;++ue)(ue===K||B.charCodeAt(ue)===47)&&(Pe.length===0?Pe+="..":Pe+="/..");return Pe.length>0?Pe+$.slice(Y+ke):(Y+=ke,$.charCodeAt(Y)===47&&++Y,$.slice(Y))},_makeLong:function(B){return B},dirname:function(B){if(fe(B),B.length===0)return".";for(var $=B.charCodeAt(0),W=$===47,K=-1,Z=!0,Y=B.length-1;Y>=1;--Y)if($=B.charCodeAt(Y),$===47){if(!Z){K=Y;break}}else Z=!1;return K===-1?W?"/":".":W&&K===1?"//":B.slice(0,K)},basename:function(B,$){if($!==void 0&&typeof $!="string")throw new TypeError('"ext" argument must be a string');fe(B);var W=0,K=-1,Z=!0,Y;if($!==void 0&&$.length>0&&$.length<=B.length){if($.length===B.length&&$===B)return"";var Q=$.length-1,ie=-1;for(Y=B.length-1;Y>=0;--Y){var Ie=B.charCodeAt(Y);if(Ie===47){if(!Z){W=Y+1;break}}else ie===-1&&(Z=!1,ie=Y+1),Q>=0&&(Ie===$.charCodeAt(Q)?--Q===-1&&(K=Y):(Q=-1,K=ie))}return W===K?K=ie:K===-1&&(K=B.length),B.slice(W,K)}else{for(Y=B.length-1;Y>=0;--Y)if(B.charCodeAt(Y)===47){if(!Z){W=Y+1;break}}else K===-1&&(Z=!1,K=Y+1);return K===-1?"":B.slice(W,K)}},extname:function(B){fe(B);for(var $=-1,W=0,K=-1,Z=!0,Y=0,Q=B.length-1;Q>=0;--Q){var ie=B.charCodeAt(Q);if(ie===47){if(!Z){W=Q+1;break}continue}K===-1&&(Z=!1,K=Q+1),ie===46?$===-1?$=Q:Y!==1&&(Y=1):$!==-1&&(Y=-1)}return $===-1||K===-1||Y===0||Y===1&&$===K-1&&$===W+1?"":B.slice($,K)},format:function(B){if(B===null||typeof B!="object")throw new TypeError('The "pathObject" argument must be of type Object. Received type '+typeof B);return vt("/",B)},parse:function(B){fe(B);var $={root:"",dir:"",base:"",ext:"",name:""};if(B.length===0)return $;var W=B.charCodeAt(0),K=W===47,Z;K?($.root="/",Z=1):Z=0;for(var Y=-1,Q=0,ie=-1,Ie=!0,ke=B.length-1,ue=0;ke>=Z;--ke){if(W=B.charCodeAt(ke),W===47){if(!Ie){Q=ke+1;break}continue}ie===-1&&(Ie=!1,ie=ke+1),W===46?Y===-1?Y=ke:ue!==1&&(ue=1):Y!==-1&&(ue=-1)}return Y===-1||ie===-1||ue===0||ue===1&&Y===ie-1&&Y===Q+1?ie!==-1&&(Q===0&&K?$.base=$.name=B.slice(1,ie):$.base=$.name=B.slice(Q,ie)):(Q===0&&K?($.name=B.slice(1,Y),$.base=B.slice(1,ie)):($.name=B.slice(Q,Y),$.base=B.slice(Q,ie)),$.ext=B.slice(Y,ie)),Q>0?$.dir=B.slice(0,Q-1):K&&($.dir="/"),$},sep:"/",delimiter:":",win32:null,posix:null};He.posix=He,Te.exports=He}},Ke={};function Me(Te){var fe=Ke[Te];if(fe!==void 0)return fe.exports;var re=Ke[Te]={exports:{}};return Kt[Te].call(re.exports,re,re.exports,Me),re.exports}Me.d=(Te,fe)=>{for(var re in fe)Me.o(fe,re)&&!Me.o(Te,re)&&Object.defineProperty(Te,re,{enumerable:!0,get:fe[re]})},Me.o=(Te,fe)=>Object.prototype.hasOwnProperty.call(Te,fe);var zt={};return(()=>{"use strict";Me.d(zt,{default:()=>jl});var Te=(e,t,a)=>new Promise((n,o)=>{var i=r=>{try{l(a.next(r))}catch(c){o(c)}},s=r=>{try{l(a.throw(r))}catch(c){o(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(i,s);l((a=a.apply(e,t)).next())});const fe=(e,t)=>Te(void 0,null,function*(){if(document.getElementById(t))return!1;const a=new XMLHttpRequest;a.open("GET",e,!1),a.setRequestHeader("Accept","text/javascript, application/javascript, application/ecmascript, application/x-ecmascript, */*; q=0.01"),a.send("");const n=document.createElement("script");n.type="text/javascript",n.text=a.responseText,n.id=t,document.head.appendChild(n),typeof Lute=="undefined"&&window.location.reload()}),re=(e,t)=>new Promise(a=>{if(document.getElementById(t))return a(!1),!1;const n=document.createElement("script");n.src=e,n.async=!0,document.head.appendChild(n),n.onload=()=>{if(document.getElementById(t))return n.remove(),a(!1),!1;n.id=t,a(!0)}}),vt=new Set(["docker","ios","android","harmony"]),He=new Set(["ios","android","harmony"]),ce=()=>vt.has(window.siyuan.config.system.container),B=()=>He.has(window.siyuan.config.system.container),$=()=>!!document.getElementById("sidebar"),W=()=>ce()?window.siyuan.config.system.container:window.siyuan.config.system.os,K=()=>window.navigator.userAgent.startsWith("SiYuan/")?"mobile":"browser-mobile",Z=()=>!document.getElementById("toolbar"),Y=()=>"ontouchstart"in window&&navigator.maxTouchPoints>1,Q=(e,t)=>e.length===t.length&&e.every(a=>t.includes(a)),ie=(e,t)=>Math.floor(Math.random()*(t-e+1))+e,Ie=(e,t=window.location.search)=>{const a=t.substring(t.indexOf("?")),n=a.indexOf("#");return new URLSearchParams(a.substring(0,n>=0?n:void 0)).get(e)},ke=()=>!0,ue=e=>/^\(\(\d{14}-\w{7} '.*'\)\)$/.test(e),Dt=e=>/^<<assets\/.+\/\d{14}-\w{7} ".+">>$/.test(e),Et=e=>/^[_a-zA-Z][_.\-0-9a-zA-Z]*$/.test(e),Pe=e=>Function(`"use strict";return (${e})`)(),st=(e,t)=>{if(e===t||typeof e=="number"&&isNaN(e)&&typeof t=="number"&&isNaN(t))return!0;if(e instanceof Date&&t instanceof Date)return e.getTime()===t.getTime();if(!e||!t||typeof e!="object"&&typeof t!="object")return e===t;if(e.prototype!==t.prototype)return!1;const a=Object.keys(e);return a.length!==Object.keys(t).length?!1:a.every(n=>st(e[n],t[n]))},Qe=e=>{const t=e.match(/^(.*) \((\d+)\)$/);return t?e=`${t[1]} (${parseInt(t[2])+1})`:e=`${e} (1)`,e},$t="3.1.24",kt="production",se=navigator.platform.toUpperCase().indexOf("MAC")>-1?"\u2303":"\u2325",de=()=>{const e={};for(let t=1;t<=32;t++)e[t+111]="F"+t;return e},ze=class{};let S=ze;S.SIYUAN_VERSION=$t,S.NODE_ENV=kt,S.SIYUAN_APPID=Math.random().toString(36).substring(8),S.ASSETS_ADDRESS="https://assets.b3logfile.com/siyuan/",S.PROTYLE_CDN="/stage/protyle",S.UPLOAD_ADDRESS="/upload",S.SERVICE_WORKER_PATH="/service-worker.js",S.SIYUAN_DROP_FILE="application/siyuan-file",S.SIYUAN_DROP_GUTTER="application/siyuan-gutter",S.SIYUAN_DROP_TAB="application/siyuan-tab",S.SIYUAN_DROP_EDITOR="application/siyuan-editor",S.SIYUAN_CMD="siyuan-cmd",S.SIYUAN_GET="siyuan-get",S.SIYUAN_EVENT="siyuan-event",S.SIYUAN_CONFIG_TRAY="siyuan-config-tray",S.SIYUAN_QUIT="siyuan-quit",S.SIYUAN_HOTKEY="siyuan-hotkey",S.SIYUAN_INIT="siyuan-init",S.SIYUAN_SEND_WINDOWS="siyuan-send-windows",S.SIYUAN_SAVE_CLOSE="siyuan-save-close",S.SIYUAN_AUTO_LAUNCH="siyuan-auto-launch",S.SIYUAN_OPEN_WORKSPACE="siyuan-open-workspace",S.SIYUAN_OPEN_URL="siyuan-open-url",S.SIYUAN_OPEN_WINDOW="siyuan-open-window",S.SIYUAN_OPEN_FOLDER="siyuan-open-folder",S.SIYUAN_OPEN_FILE="siyuan-open-file",S.SIYUAN_EXPORT_PDF="siyuan-export-pdf",S.SIYUAN_EXPORT_NEWWINDOW="siyuan-export-newwindow",S.SIYUAN_CONTEXT_MENU="siyuan-context-menu",S.SIYUAN_SHOW_WINDOW="siyuan-show-window",S.CUSTOM_SY_READONLY="custom-sy-readonly",S.CUSTOM_SY_FULLWIDTH="custom-sy-fullwidth",S.CUSTOM_SY_AV_VIEW="custom-sy-av-view",S.CUSTOM_REMINDER_WECHAT="custom-reminder-wechat",S.CUSTOM_RIFF_DECKS="custom-riff-decks",S.SIZE_DATABASE_MAZ_SIZE=102400,S.SIZE_SCROLL_TB=24,S.SIZE_SCROLL_STEP=256,S.SIZE_LINK_TEXT_MAX=64,S.SIZE_TOOLBAR_HEIGHT=$()?0:32,S.SIZE_GET_MAX=102400,S.SIZE_UNDO=64,S.SIZE_TITLE=512,S.SIZE_EDITOR_WIDTH=760,S.SIZE_ZOOM=[{zoom:.67,position:{x:0,y:2}},{zoom:.75,position:{x:1,y:4}},{zoom:.8,position:{x:2,y:4}},{zoom:.9,position:{x:5,y:6}},{zoom:1,position:{x:8,y:8}},{zoom:1.1,position:{x:12,y:9}},{zoom:1.25,position:{x:18,y:12}},{zoom:1.5,position:{x:27,y:16}},{zoom:1.75,position:{x:36,y:20}},{zoom:2,position:{x:45,y:23}},{zoom:2.5,position:{x:63,y:31}},{zoom:3,position:{x:80,y:39}}],S.CB_MOVE_NOLIST="cb-move-nolist",S.CB_MOUNT_REMOVE="cb-mount-remove",S.CB_GET_APPEND="cb-get-append",S.CB_GET_BEFORE="cb-get-before",S.CB_GET_UNCHANGEID="cb-get-unchangeid",S.CB_GET_HL="cb-get-hl",S.CB_GET_FOCUS="cb-get-focus",S.CB_GET_FOCUSFIRST="cb-get-focusfirst",S.CB_GET_SETID="cb-get-setid",S.CB_GET_ALL="cb-get-all",S.CB_GET_BACKLINK="cb-get-backlink",S.CB_GET_UNUNDO="cb-get-unundo",S.CB_GET_SCROLL="cb-get-scroll",S.CB_GET_CONTEXT="cb-get-context",S.CB_GET_ROOTSCROLL="cb-get-rootscroll",S.CB_GET_HTML="cb-get-html",S.CB_GET_HISTORY="cb-get-history",S.CB_GET_OPENNEW="cb-get-opennew",S.LOCAL_ZOOM="local-zoom",S.LOCAL_SEARCHDATA="local-searchdata",S.LOCAL_SEARCHKEYS="local-searchkeys",S.LOCAL_SEARCHASSET="local-searchasset",S.LOCAL_SEARCHUNREF="local-searchunref",S.LOCAL_DOCINFO="local-docinfo",S.LOCAL_DAILYNOTEID="local-dailynoteid",S.LOCAL_HISTORY="local-history",S.LOCAL_CODELANG="local-codelang",S.LOCAL_FONTSTYLES="local-fontstyles",S.LOCAL_EXPORTPDF="local-exportpdf",S.LOCAL_EXPORTWORD="local-exportword",S.LOCAL_EXPORTIMG="local-exportimg",S.LOCAL_BAZAAR="local-bazaar",S.LOCAL_PDFTHEME="local-pdftheme",S.LOCAL_LAYOUTS="local-layouts",S.LOCAL_AI="local-ai",S.LOCAL_PLUGINTOPUNPIN="local-plugintopunpin",S.LOCAL_FLASHCARD="local-flashcard",S.LOCAL_FILEPOSITION="local-fileposition",S.LOCAL_FILESPATHS="local-filespaths",S.LOCAL_DIALOGPOSITION="local-dialogposition",S.LOCAL_SESSION_FIRSTLOAD="local-session-firstload",S.LOCAL_OUTLINE="local-outline",S.LOCAL_PLUGIN_DOCKS="local-plugin-docks",S.LOCAL_IMAGES="local-images",S.LOCAL_EMOJIS="local-emojis",S.LOCAL_MOVE_PATH="local-move-path",S.DIALOG_CONFIRM="dialog-confirm",S.DIALOG_OPENCARD="dialog-opencard",S.DIALOG_MAKECARD="dialog-makecard",S.DIALOG_VIEWCARDS="dialog-viewcards",S.DIALOG_DIALYNOTE="dialog-dialynote",S.DIALOG_RECENTDOCS="dialog-recentdocs",S.DIALOG_SWITCHTAB="dialog-switchtab",S.DIALOG_SEARCH="dialog-search",S.DIALOG_REPLACE="dialog-replace",S.DIALOG_GLOBALSEARCH="dialog-globalsearch",S.DIALOG_HISTORYCOMPARE="dialog-historycompare",S.DIALOG_ACCESSAUTHCODE="dialog-accessauthcode",S.DIALOG_AICUSTOMACTION="dialog-aicustomaction",S.DIALOG_AIUPDATECUSTOMACTION="dialog-aiupdatecustomaction",S.DIALOG_BACKGROUNDLINK="dialog-backgroundlink",S.DIALOG_BACKGROUNDRANDOM="dialog-backgroundrandom",S.DIALOG_CHANGELOG="dialog-changelog",S.DIALOG_COMMANDPANEL="dialog-commandpanel",S.DIALOG_DEACTIVATEUSER="dialog-deactivateuser",S.DIALOG_EMOJIS="dialog-emojis",S.DIALOG_EXPORTIMAGE="dialog-exportimage",S.DIALOG_EXPORTTEMPLATE="dialog-exporttemplate",S.DIALOG_EXPORTWORD="dialog-exportword",S.DIALOG_HISTORY="dialog-history",S.DIALOG_HISTORYDOC="dialog-historydoc",S.DIALOG_MOVEPATHTO="dialog-movepathto",S.DIALOG_RENAME="dialog-rename",S.DIALOG_RENAMEASSETS="dialog-renameassets",S.DIALOG_RENAMEBOOKMARK="dialog-renamebookmark",S.DIALOG_RENAMETAG="dialog-renametag",S.DIALOG_REPLACETYPE="dialog-replacetype",S.DIALOG_SAVECRITERION="dialog-savecriterion",S.DIALOG_SEARCHTYPE="dialog-searchtype",S.DIALOG_SEARCHASSETSTYPE="dialog-searchassetstype",S.DIALOG_SETTING="dialog-setting",S.DIALOG_SNAPSHOTTAG="dialog-snapshottag",S.DIALOG_SNAPSHOTMEMO="dialog-snapshotmemo",S.DIALOG_SNIPPETS="dialog-snippets",S.DIALOG_SYNCADDCLOUDDIR="dialog-syncaddclouddir",S.DIALOG_SYNCCHOOSEDIR="dialog-syncchoosedir",S.DIALOG_SYNCCHOOSEDIRECTION="dialog-syncchoosedirection",S.DIALOG_TRANSFERBLOCKREF="dialog-transferblockref",S.DIALOG_WECHATREMINDER="dialog-wechatreminder",S.DIALOG_PASSWORD="dialog-password",S.DIALOG_SETPASSWORD="dialog-setpassword",S.DIALOG_BOOTSYNCFAILED="dialog-bootsyncfailed",S.DIALOG_KERNELFAULT="dialog-kernelfault",S.DIALOG_STATEEXCEPTED="dialog-stateexcepted",S.DIALOG_ATTR="dialog-attr",S.DIALOG_SETCUSTOMATTR="dialog-setcustomattr",S.DIALOG_CREATENOTEBOOK="dialog-createnotebook",S.DIALOG_NOTEBOOKCONF="dialog-notebookconf",S.DIALOG_CREATEWORKSPACE="dialog-createworkspace",S.DIALOG_OPENWORKSPACE="dialog-openworkspace",S.DIALOG_SAVEWORKSPACE="dialog-saveworkspace",S.TIMEOUT_DBLCLICK=190,S.TIMEOUT_INPUT=256,S.TIMEOUT_LOAD=300,S.TIMEOUT_TRANSITION=300,S.TIMEOUT_COUNT=1e3,S.HELP_PATH={zh_CN:"20210808180117-czj9bvb",zh_CHT:"20211226090932-5lcq56f",ja_JP:"20240530133126-axarxgx",en_US:"20210808180117-6v0mkxr",fr_FR:"20210808180117-6v0mkxr",es_ES:"20210808180117-6v0mkxr",it_IT:"20210808180117-6v0mkxr",de_DE:"20210808180117-6v0mkxr",he_IL:"20210808180117-6v0mkxr",ru_RU:"20210808180117-6v0mkxr",pl_PL:"20210808180117-6v0mkxr",ar_SA:"20210808180117-6v0mkxr"},S.QUICK_DECK_ID="20230218211946-2kw8jgx",S.KEYCODELIST=Object.assign(de(),{8:"\u232B",9:"\u21E5",13:"\u21A9",16:"\u21E7",17:"\u2303",18:"\u2325",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"\u2190",38:"\u2191",39:"\u2192",40:"\u2193",44:"PrintScreen",45:"Insert",46:"\u2326",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",65:"A",66:"B",67:"C",68:"D",69:"E",70:"F",71:"G",72:"H",73:"I",74:"J",75:"K",76:"L",77:"M",78:"N",79:"O",80:"P",81:"Q",82:"R",83:"S",84:"T",85:"U",86:"V",87:"W",88:"X",89:"Y",90:"Z",91:"\u2318",92:"\u2318",93:"ContextMenu",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"*",107:"+",109:"-",110:".",111:"/",144:"NumLock",145:"ScrollLock",182:"MyComputer",183:"MyCalculator",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"}),S.SIYUAN_KEYMAP={general:{mainMenu:{default:"\u2325\\",custom:"\u2325\\"},commandPanel:{default:"\u2325\u21E7P",custom:"\u2325\u21E7P"},editReadonly:{default:"\u21E7\u2318G",custom:"\u21E7\u2318G"},syncNow:{default:"F9",custom:"F9"},enterBack:{default:"\u2325\u2190",custom:"\u2325\u2190"},enter:{default:"\u2325\u2192",custom:"\u2325\u2192"},goForward:{default:"\u2318]",custom:"\u2318]"},goBack:{default:"\u2318[",custom:"\u2318["},newFile:{default:"\u2318N",custom:"\u2318N"},search:{default:"\u2318F",custom:"\u2318F"},globalSearch:{default:"\u2318P",custom:"\u2318P"},stickSearch:{default:"\u21E7\u2318F",custom:"\u21E7\u2318F"},replace:{default:"\u2318R",custom:"\u2318R"},closeTab:{default:"\u2318W",custom:"\u2318W"},fileTree:{default:se+"1",custom:se+"1"},outline:{default:se+"2",custom:se+"2"},bookmark:{default:se+"3",custom:se+"3"},tag:{default:se+"4",custom:se+"4"},dailyNote:{default:se+"5",custom:se+"5"},inbox:{default:se+"6",custom:se+"6"},backlinks:{default:se+"7",custom:se+"7"},graphView:{default:se+"8",custom:se+"8"},globalGraph:{default:se+"9",custom:se+"9"},riffCard:{default:se+"0",custom:se+"0"},config:{default:"\u2325P",custom:"\u2325P"},dataHistory:{default:"\u2325H",custom:"\u2325H"},toggleWin:{default:"\u2325M",custom:"\u2325M"},lockScreen:{default:"\u2325N",custom:"\u2325N"},recentDocs:{default:"\u2318E",custom:"\u2318E"},goToTab1:{default:"\u23181",custom:"\u23181"},goToTab2:{default:"\u23182",custom:"\u23182"},goToTab3:{default:"\u23183",custom:"\u23183"},goToTab4:{default:"\u23184",custom:"\u23184"},goToTab5:{default:"\u23185",custom:"\u23185"},goToTab6:{default:"\u23186",custom:"\u23186"},goToTab7:{default:"\u23187",custom:"\u23187"},goToTab8:{default:"\u23188",custom:"\u23188"},goToTab9:{default:"\u23189",custom:"\u23189"},goToTabNext:{default:"\u21E7\u2318]",custom:"\u21E7\u2318]"},goToTabPrev:{default:"\u21E7\u2318[",custom:"\u21E7\u2318["},goToEditTabNext:{default:"\u2303\u21E5",custom:"\u2303\u21E5"},goToEditTabPrev:{default:"\u2303\u21E7\u21E5",custom:"\u2303\u21E7\u21E5"},move:{default:"",custom:""},selectOpen1:{default:"",custom:""},toggleDock:{default:"",custom:""},splitLR:{default:"",custom:""},splitMoveR:{default:"",custom:""},splitTB:{default:"",custom:""},splitMoveB:{default:"",custom:""},closeOthers:{default:"",custom:""},closeAll:{default:"",custom:""},closeUnmodified:{default:"",custom:""},closeLeft:{default:"",custom:""},closeRight:{default:"",custom:""},tabToWindow:{default:"",custom:""},addToDatabase:{default:"",custom:""},unsplit:{default:"",custom:""},unsplitAll:{default:"",custom:""}},editor:{general:{duplicate:{default:"\u2318D",custom:"\u2318D"},expandDown:{default:"\u2325\u21E7\u2193",custom:"\u2325\u21E7\u2193"},expandUp:{default:"\u2325\u21E7\u2191",custom:"\u2325\u21E7\u2191"},expand:{default:"\u2318\u2193",custom:"\u2318\u2193"},collapse:{default:"\u2318\u2191",custom:"\u2318\u2191"},insertBottom:{default:"\u2325\u2318.",custom:"\u2325\u2318."},refTab:{default:"\u21E7\u2318.",custom:"\u21E7\u2318."},openBy:{default:"\u2325,",custom:"\u2325,"},insertRight:{default:"\u2325.",custom:"\u2325."},attr:{default:"\u2325\u2318A",custom:"\u2325\u2318A"},quickMakeCard:{default:"\u2325\u2318F",custom:"\u2325\u2318F"},refresh:{default:"F5",custom:"F5"},copyBlockRef:{default:"\u21E7\u2318C",custom:"\u21E7\u2318C"},copyProtocol:{default:"\u21E7\u2318H",custom:"\u21E7\u2318H"},copyBlockEmbed:{default:"\u21E7\u2318E",custom:"\u21E7\u2318E"},copyHPath:{default:"\u21E7\u2318P",custom:"\u21E7\u2318P"},undo:{default:"\u2318Z",custom:"\u2318Z"},redo:{default:"\u2318Y",custom:"\u2318Y"},rename:{default:"F2",custom:"F2"},newNameFile:{default:"F3",custom:"F3"},newContentFile:{default:"F4",custom:"F4"},newNameSettingFile:{default:"\u2318F3",custom:"\u2318F3"},showInFolder:{default:"\u2325A",custom:"\u2325A"},outline:{default:"\u2325O",custom:"\u2325O"},backlinks:{default:"\u2325B",custom:"\u2325B"},graphView:{default:"\u2325G",custom:"\u2325G"},spaceRepetition:{default:"\u2325F",custom:"\u2325F"},fullscreen:{default:"\u2325Y",custom:"\u2325Y"},alignLeft:{default:"\u2325L",custom:"\u2325L"},alignCenter:{default:"\u2325C",custom:"\u2325C"},alignRight:{default:"\u2325R",custom:"\u2325R"},wysiwyg:{default:"\u2325\u23187",custom:"\u2325\u23187"},preview:{default:"\u2325\u23189",custom:"\u2325\u23189"},insertBefore:{default:"\u21E7\u2318B",custom:"\u21E7\u2318B"},insertAfter:{default:"\u21E7\u2318A",custom:"\u21E7\u2318A"},jumpToParentNext:{default:"\u21E7\u2318N",custom:"\u21E7\u2318N"},jumpToParentPrev:{default:"\u21E7\u2318M",custom:"\u21E7\u2318M"},jumpToParent:{default:"\u21E7\u2318J",custom:"\u21E7\u2318J"},moveToUp:{default:"\u21E7\u2318\u2191",custom:"\u21E7\u2318\u2191"},moveToDown:{default:"\u21E7\u2318\u2193",custom:"\u21E7\u2318\u2193"},duplicateCompletely:{default:"",custom:""},copyPlainText:{default:"",custom:""},copyID:{default:"",custom:""},copyProtocolInMd:{default:"",custom:""},netImg2LocalAsset:{default:"",custom:""},netAssets2LocalAssets:{default:"",custom:""},optimizeTypography:{default:"",custom:""},hLayout:{default:"",custom:""},vLayout:{default:"",custom:""},refPopover:{default:"",custom:""},copyText:{default:"",custom:""},exitFocus:{default:"",custom:""},ai:{default:"",custom:""},switchReadonly:{default:"",custom:""},switchAdjust:{default:"",custom:""},rtl:{default:"",custom:""},ltr:{default:"",custom:""},aiWriting:{default:"",custom:""},openInNewTab:{default:"",custom:""}},insert:{appearance:{default:"\u2325\u2318X",custom:"\u2325\u2318X"},lastUsed:{default:"\u2325X",custom:"\u2325X"},ref:{default:"\u2325[",custom:"\u2325["},kbd:{default:"\u2318'",custom:"\u2318'"},sup:{default:"\u2318H",custom:"\u2318H"},sub:{default:"\u2318J",custom:"\u2318J"},bold:{default:"\u2318B",custom:"\u2318B"},"inline-math":{default:"\u2318M",custom:"\u2318M"},memo:{default:"\u2325\u2318M",custom:"\u2325\u2318M"},underline:{default:"\u2318U",custom:"\u2318U"},italic:{default:"\u2318I",custom:"\u2318I"},mark:{default:"\u2325D",custom:"\u2325D"},tag:{default:"\u2318T",custom:"\u2318T"},strike:{default:"\u21E7\u2318S",custom:"\u21E7\u2318S"},"inline-code":{default:"\u2318G",custom:"\u2318G"},link:{default:"\u2318K",custom:"\u2318K"},check:{default:"\u2318L",custom:"\u2318L"},"ordered-list":{default:"",custom:""},list:{default:"",custom:""},table:{default:"\u2318O",custom:"\u2318O"},code:{default:"\u21E7\u2318K",custom:"\u21E7\u2318K"},quote:{default:"",custom:""},clearInline:{default:"\u2318\\",custom:"\u2318\\"}},heading:{paragraph:{default:"\u2325\u23180",custom:"\u2325\u23180"},heading1:{default:"\u2325\u23181",custom:"\u2325\u23181"},heading2:{default:"\u2325\u23182",custom:"\u2325\u23182"},heading3:{default:"\u2325\u23183",custom:"\u2325\u23183"},heading4:{default:"\u2325\u23184",custom:"\u2325\u23184"},heading5:{default:"\u2325\u23185",custom:"\u2325\u23185"},heading6:{default:"\u2325\u23186",custom:"\u2325\u23186"}},list:{indent:{default:"\u21E5",custom:"\u21E5"},outdent:{default:"\u21E7\u21E5",custom:"\u21E7\u21E5"},checkToggle:{default:"\u2318\u21A9",custom:"\u2318\u21A9"}},table:{insertRowAbove:{default:"\u21E7\u2318T",custom:"\u21E7\u2318T"},insertRowBelow:{default:"\u21E7\u2318D",custom:"\u21E7\u2318D"},insertColumnLeft:{default:"\u21E7\u2318L",custom:"\u21E7\u2318L"},insertColumnRight:{default:"\u21E7\u2318R",custom:"\u21E7\u2318R"},moveToUp:{default:"\u2325\u2318T",custom:"\u2325\u2318T"},moveToDown:{default:"\u2325\u2318B",custom:"\u2325\u2318B"},moveToLeft:{default:"\u2325\u2318L",custom:"\u2325\u2318L"},moveToRight:{default:"\u2325\u2318R",custom:"\u2325\u2318R"},"delete-row":{default:"\u2318-",custom:"\u2318-"},"delete-column":{default:"\u21E7\u2318-",custom:"\u21E7\u2318-"}}},plugin:{}},S.SIYUAN_EMPTY_LAYOUT={hideDock:!1,layout:{direction:"tb",size:"0px",type:"normal",instance:"Layout",children:[{direction:"lr",size:"auto",type:"normal",instance:"Layout",children:[{direction:"tb",size:"0px",type:"left",instance:"Layout",children:[{instance:"Wnd",children:[]},{instance:"Wnd",resize:"tb",children:[]}]},{direction:"lr",resize:"lr",size:"auto",type:"center",instance:"Layout",children:[{instance:"Wnd",children:[{instance:"Tab",children:[]}]}]},{direction:"tb",size:"0px",resize:"lr",type:"right",instance:"Layout",children:[{instance:"Wnd",children:[]},{instance:"Wnd",resize:"tb",children:[]}]}]},{direction:"lr",size:"0px",resize:"tb",type:"bottom",instance:"Layout",children:[{instance:"Wnd",children:[]},{instance:"Wnd",resize:"lr",children:[]}]}]},bottom:{pin:!0,data:[]},left:{pin:!0,data:[[{type:"file",size:{width:232,height:0},show:!0,icon:"iconFiles",hotkeyLangId:"fileTree"},{type:"outline",size:{width:232,height:0},show:!1,icon:"iconAlignCenter",hotkeyLangId:"outline"},{type:"inbox",size:{width:320,height:0},show:!1,icon:"iconInbox",hotkeyLangId:"inbox"}],[{type:"bookmark",size:{width:232,height:0},show:!1,icon:"iconBookmark",hotkeyLangId:"bookmark"},{type:"tag",size:{width:232,height:0},show:!1,icon:"iconTags",hotkeyLangId:"tag"}]]},right:{pin:!0,data:[[{type:"graph",size:{width:320,height:0},show:!1,icon:"iconGraph",hotkeyLangId:"graphView"},{type:"globalGraph",size:{width:320,height:0},show:!1,icon:"iconGlobalGraph",hotkeyLangId:"globalGraph"}],[{type:"backlink",size:{width:320,height:0},show:!1,icon:"iconLink",hotkeyLangId:"backlinks"}]]}},S.SIYUAN_DEFAULT_REPLACETYPES={text:!0,imgText:!0,imgTitle:!0,imgSrc:!0,aText:!0,aTitle:!0,aHref:!0,code:!0,em:!0,strong:!0,inlineMath:!0,inlineMemo:!0,blockRef:!0,fileAnnotationRef:!0,kbd:!0,mark:!0,s:!0,sub:!0,sup:!0,tag:!0,u:!0,docTitle:!0,codeBlock:!0,mathBlock:!0,htmlBlock:!0},S.SIYUAN_IMAGE_VIP=`<svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32">
<path fill="#ffd00f" d="M2.288 12.643l23.487 12.853c0.286 0.153 0.477 0.45 0.477 0.791 0 0.082-0.011 0.161-0.032 0.237l0.001-0.006c-0.119 0.395-0.479 0.678-0.905 0.678-0.004 0-0.009-0-0.013-0h-19.439c-0.958 0-1.766-0.684-1.885-1.595l-1.691-12.956z"></path>
<path fill="#ffd00f" d="M29.676 12.643l-1.691 12.957c-0.119 0.911-0.927 1.594-1.884 1.594h-19.442c-0.004 0-0.009 0-0.013 0-0.425 0-0.785-0.281-0.903-0.668l-0.002-0.007c-0.019-0.070-0.031-0.15-0.031-0.232 0-0.341 0.191-0.638 0.472-0.788l0.005-0.002 23.487-12.853z"></path>
<path fill="#ffe668" d="M15.413 8.369l10.394 15.921c0.378 0.579 0.407 1.317 0.076 1.924-0.328 0.591-0.948 0.985-1.66 0.985-0 0-0.001 0-0.001 0h-17.617c-0.694 0-1.331-0.378-1.661-0.985-0.144-0.26-0.229-0.569-0.229-0.899 0-0.382 0.114-0.736 0.31-1.033l-0.004 0.007 10.394-15.921z"></path>
<path fill="#ffdd4e" d="M15.396 8.403l11.659 15.921c0.401 0.579 0.432 1.317 0.081 1.924-0.361 0.594-1.005 0.985-1.741 0.985-0.008 0-0.017-0-0.025-0h-9.344l-0.63-18.83z"></path>
<path fill="#ffd00f" d="M13.868 6.478c0 0.946 0.767 1.712 1.712 1.712s1.712-0.767 1.712-1.712v0c0-0.945-0.766-1.712-1.712-1.712s-1.712 0.766-1.712 1.712v0zM28.577 10.818c0 0.945 0.766 1.712 1.712 1.712s1.712-0.766 1.712-1.712v0c0-0.945-0.766-1.712-1.712-1.712s-1.712 0.766-1.712 1.712v0zM0 10.822c0 0.945 0.766 1.712 1.712 1.712s1.712-0.766 1.712-1.712v0c0-0.945-0.766-1.712-1.712-1.712s-1.712 0.766-1.712 1.712v0z"></path>
</svg>`,S.SIYUAN_ASSETS_IMAGE=[".apng",".ico",".cur",".jpg",".jpe",".jpeg",".jfif",".pjp",".pjpeg",".png",".gif",".webp",".bmp",".svg",".avif"],S.SIYUAN_ASSETS_AUDIO=[".mp3",".wav",".ogg",".m4a",".aac",".flac"],S.SIYUAN_ASSETS_VIDEO=[".mov",".weba",".mkv",".mp4",".webm"],S.SIYUAN_ASSETS_EXTS=[".pdf"].concat(ze.SIYUAN_ASSETS_IMAGE).concat(ze.SIYUAN_ASSETS_AUDIO).concat(ze.SIYUAN_ASSETS_VIDEO),S.SIYUAN_ASSETS_SEARCH=[".txt",".md",".markdown",".docx",".xlsx",".pptx",".pdf",".json",".log",".sql",".html",".xml",".java",".h",".c",".cpp",".go",".rs",".swift",".kt",".py",".php",".js",".css",".ts",".sh",".bat",".cmd",".ini",".yaml",".rst",".adoc",".textile",".opml",".org",".wiki",".epub"],S.SIYUAN_CONFIG_APPEARANCE_DARK_CODE=["a11y-dark","agate","an-old-hope","androidstudio","arta","atom-one-dark","atom-one-dark-reasonable","base16/3024","base16/apathy","base16/apprentice","base16/ashes","base16/atelier-cave","base16/atelier-dune","base16/atelier-estuary","base16/atelier-forest","base16/atelier-heath","base16/atelier-lakeside","base16/atelier-plateau","base16/atelier-savanna","base16/atelier-seaside","base16/atelier-sulphurpool","base16/atlas","base16/bespin","base16/black-metal","base16/black-metal-bathory","base16/black-metal-burzum","base16/black-metal-dark-funeral","base16/black-metal-gorgoroth","base16/black-metal-immortal","base16/black-metal-khold","base16/black-metal-marduk","base16/black-metal-mayhem","base16/black-metal-nile","base16/black-metal-venom","base16/brewer","base16/bright","base16/brogrammer","base16/brush-trees-dark","base16/chalk","base16/circus","base16/classic-dark","base16/codeschool","base16/colors","base16/danqing","base16/darcula","base16/dark-violet","base16/darkmoss","base16/darktooth","base16/decaf","base16/default-dark","base16/dracula","base16/edge-dark","base16/eighties","base16/embers","base16/equilibrium-dark","base16/equilibrium-gray-dark","base16/espresso","base16/eva","base16/eva-dim","base16/flat","base16/framer","base16/gigavolt","base16/google-dark","base16/grayscale-dark","base16/green-screen","base16/gruvbox-dark-hard","base16/gruvbox-dark-medium","base16/gruvbox-dark-pale","base16/gruvbox-dark-soft","base16/hardcore","base16/harmonic16-dark","base16/heetch-dark","base16/helios","base16/hopscotch","base16/horizon-dark","base16/humanoid-dark","base16/ia-dark","base16/icy-dark","base16/ir-black","base16/isotope","base16/kimber","base16/london-tube","base16/macintosh","base16/marrakesh","base16/materia","base16/material","base16/material-darker","base16/material-palenight","base16/material-vivid","base16/mellow-purple","base16/mocha","base16/monokai","base16/nebula","base16/nord","base16/nova","base16/ocean","base16/oceanicnext","base16/onedark","base16/outrun-dark","base16/papercolor-dark","base16/paraiso","base16/pasque","base16/phd","base16/pico","base16/pop","base16/porple","base16/qualia","base16/railscasts","base16/rebecca","base16/ros-pine","base16/ros-pine-moon","base16/sandcastle","base16/seti-ui","base16/silk-dark","base16/snazzy","base16/solar-flare","base16/solarized-dark","base16/spacemacs","base16/summercamp","base16/summerfruit-dark","base16/synth-midnight-terminal-dark","base16/tango","base16/tender","base16/tomorrow-night","base16/twilight","base16/unikitty-dark","base16/vulcan","base16/windows-10","base16/windows-95","base16/windows-high-contrast","base16/windows-nt","base16/woodland","base16/xcode-dusk","base16/zenburn","codepen-embed","cybertopia-cherry","cybertopia-dimmer","cybertopia-icecap","cybertopia-saturated","dark","devibeans","far","felipec","github-dark","github-dark-dimmed","gml","gradient-dark","hybrid","ir-black","isbl-editor-dark","kimbie-dark","lioshi","monokai","monokai-sublime","night-owl","nnfx-dark","nord","obsidian","panda-syntax-dark","paraiso-dark","pojoaque","qtcreator-dark","rainbow","rose-pine","rose-pine-moon","shades-of-purple","srcery","stackoverflow-dark","sunburst","tomorrow-night-blue","tomorrow-night-bright","tokyo-night-dark","vs2015","xt256"],S.SIYUAN_CONFIG_APPEARANCE_LIGHT_CODE=["ant-design","1c-light","a11y-light","arduino-light","ascetic","atom-one-light","base16/atelier-cave-light","base16/atelier-dune-light","base16/atelier-estuary-light","base16/atelier-forest-light","base16/atelier-heath-light","base16/atelier-lakeside-light","base16/atelier-plateau-light","base16/atelier-savanna-light","base16/atelier-seaside-light","base16/atelier-sulphurpool-light","base16/brush-trees","base16/classic-light","base16/cupcake","base16/cupertino","base16/default-light","base16/dirtysea","base16/edge-light","base16/equilibrium-gray-light","base16/equilibrium-light","base16/fruit-soda","base16/github","base16/google-light","base16/grayscale-light","base16/gruvbox-light-hard","base16/gruvbox-light-medium","base16/gruvbox-light-soft","base16/harmonic16-light","base16/heetch-light","base16/humanoid-light","base16/horizon-light","base16/ia-light","base16/material-lighter","base16/mexico-light","base16/one-light","base16/papercolor-light","base16/ros-pine-dawn","base16/sagelight","base16/shapeshifter","base16/silk-light","base16/solar-flare-light","base16/solarized-light","base16/summerfruit-light","base16/synth-midnight-terminal-light","base16/tomorrow","base16/unikitty-light","base16/windows-10-light","base16/windows-95-light","base16/windows-high-contrast-light","brown-paper","base16/windows-nt-light","color-brewer","docco","foundation","github","googlecode","gradient-light","grayscale","idea","intellij-light","isbl-editor-light","kimbie-light","lightfair","magula","mono-blue","nnfx-light","panda-syntax-light","paraiso-light","purebasic","qtcreator-light","rose-pine-dawn","routeros","school-book","stackoverflow-light","tokyo-night-light","vs","xcode","default"],S.ZWSP="\u200B",S.INLINE_TYPE=["block-ref","kbd","text","file-annotation-ref","a","strong","em","u","s","mark","sup","sub","tag","code","inline-math","inline-memo","clear"],S.BLOCK_HINT_KEYS=["((","[[","\uFF08\uFF08","\u3010\u3010"],S.BLOCK_HINT_CLOSE_KEYS={"((":"))","[[":"]]","\uFF08\uFF08":"\uFF09\uFF09","\u3010\u3010":"\u3011\u3011"},S.ALIAS_CODE_LANGUAGES=["js","ts","html","toml","c#","bat"],S.SIYUAN_RENDER_CODE_LANGUAGES=["abc","plantuml","mermaid","flowchart","echarts","mindmap","graphviz","math"],S.PROTYLE_TOOLBAR=$()?["block-ref","a","|","text","strong","em","u","clear","|","code","tag","inline-math","inline-memo"]:["block-ref","a","|","text","strong","em","u","s","mark","sup","sub","clear","|","code","kbd","tag","inline-math","inline-memo"],S.ANALYTICS_EVT_ON_GET_CONFIG="siyuan.onGetConfig";const X=e=>{let t=!0;if(e){const a=e.getAttribute("data-readonly");if(typeof a=="string")t=a==="false";else return'<div class="protyle-icons"></div>'}return`<div class="protyle-icons">
    <span aria-label="${window.siyuan.languages.edit}" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-icon--first protyle-action__edit${t?"":" fn__none"}"><svg><use xlink:href="#iconEdit"></use></svg></span>
    <span aria-label="${window.siyuan.languages.more}" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-action__menu protyle-icon--last${t?"":" protyle-icon--first"}"><svg><use xlink:href="#iconMore"></use></svg></span>
</div>`},F=e=>{if(e.getAttribute("data-type")==="NodeHTMLBlock"){const t=e.querySelector("protyle-html");t.setAttribute("data-content",Lute.UnEscapeHTMLStr(t.getAttribute("data-content")))}return e},O=(e,t,a=!1)=>{let n=J(e,t,a),o=!1,i=!1;for(;n&&(a?n.tagName!=="BODY":!n.classList.contains("protyle-wysiwyg"))&&!i;)o=J(n.parentElement,t,a),o?n=o:i=!0;return n||!1},ee=(e,t)=>{let a=z(e,t),n=!1,o=!1;for(;a&&!a.classList.contains("protyle-wysiwyg")&&!o;)n=z(a.parentElement,t),n?a=n:o=!0;return a||!1},q=(e,t,a,n=!1)=>{let o=j(e,t,a,n),i=!1,s=!1;for(;o&&!o.classList.contains("protyle-wysiwyg")&&!s;)i=j(o.parentElement,t,a,n),i?o=i:s=!0;return o||!1},j=(e,t,a,n=!1)=>{var o;if(!e||e.nodeType===9)return!1;e.nodeType===3&&(e=e.parentElement);let i=e,s=!1;for(;i&&!s&&(n?i.tagName!=="BODY":!i.classList.contains("protyle-wysiwyg"));)typeof a=="string"&&((o=i.getAttribute(t))!=null&&o.split(" ").includes(a))||typeof a!="string"&&i.hasAttribute(t)?s=!0:i=i.parentElement;return s&&i},z=(e,t)=>{if(!e||e.nodeType===9)return!1;e.nodeType===3&&(e=e.parentElement);let a=e,n=!1;for(;a&&!n&&!a.classList.contains("protyle-wysiwyg");)a.nodeName===t?n=!0:a=a.parentElement;return n&&a},J=(e,t,a=!1)=>{var n;if(!e||e.nodeType===9)return!1;e.nodeType===3&&(e=e.parentElement);let o=e,i=!1;for(;o&&!i&&(a?o.tagName!=="BODY":!o.classList.contains("protyle-wysiwyg"));)(n=o.classList)!=null&&n.contains(t)?i=!0:o=o.parentElement;return i&&o},oe=e=>{var t;const a=j(e,"data-node-id",null);return a&&a.tagName!=="BUTTON"&&((t=a.getAttribute("data-type"))!=null&&t.startsWith("Node"))?a:!1},le=e=>{const t=q(e,"data-type","NodeBlockQueryEmbed");return t?t.isSameNode(e)?!1:t:!1},ye=(e,t=S.PROTYLE_CDN)=>{let a=[];e.getAttribute("data-subtype")==="graphviz"?a=[e]:a=Array.from(e.querySelectorAll('[data-subtype="graphviz"]')),a.length!==0&&re(`${t}/js/graphviz/viz.js?v=3.11.0`,"protyleGraphVizScript").then(()=>{const n=J(e,"protyle-wysiwyg",!0);a.forEach(o=>{if(o.getAttribute("data-render")==="true")return;o.firstElementChild.classList.contains("protyle-icons")||o.insertAdjacentHTML("afterbegin",X(n));const i=o.firstElementChild.nextElementSibling;try{Viz.instance().then(s=>{const l=s.renderSVGElement(Lute.UnEscapeHTMLStr(o.getAttribute("data-content")));i.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${S.ZWSP}</span><div contenteditable="false">${l.outerHTML}</div>`}).catch(s=>{i.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${S.ZWSP}</span><div class="ft__error" contenteditable="false">graphviz render error: <br>${s}</div>`})}catch(s){console.error("Graphviz error",s)}o.setAttribute("data-render","true")})})},Ue=e=>{let t=e;for(;t;){if(t.previousElementSibling&&t.previousElementSibling.getAttribute("data-node-id"))return t.previousElementSibling;const a=oe(t.parentElement);if(a)t=a;else return!1}},Fe=e=>{let t;return Array.from(e.querySelectorAll("[data-node-id]")).reverse().find(a=>{if(!isInEmbedBlock(a))return t=a,!0}),t||e},et=e=>{let t;return Array.from(e.querySelectorAll("[data-node-id]")).find(a=>{if(!le(a)&&!a.classList.contains("li")&&!a.classList.contains("sb"))return t=a,!0}),t||e},it=e=>{let t=e;for(;t;){if(t.nextElementSibling&&!t.nextElementSibling.classList.contains("protyle-attr"))return t.nextElementSibling;const a=oe(t.parentElement);if(a)t=a;else return!1}return!1},ot=e=>{let t=e;for(;t;)if(t.classList.contains("list")||t.classList.contains("li")||t.classList.contains("bq")||t.classList.contains("sb"))t=t.querySelector("[data-node-id]");else return t;return!1},me=e=>{if(!e||e.getAttribute("contenteditable")==="true"&&!e.classList.contains("protyle-wysiwyg"))return e;const t=e.querySelector('[contenteditable="true"]');if(t&&!j(t,"data-type","NodeBlockQueryEmbed"))return t},Ye=e=>["NodeBlockQueryEmbed","NodeThematicBreak","NodeMathBlock","NodeHTMLBlock","NodeIFrame","NodeWidget","NodeVideo","NodeAudio"].includes(e.getAttribute("data-type"))||e.getAttribute("data-type")==="NodeCodeBlock"&&e.classList.contains("render-node"),Zt=e=>{var t,a;let n=e;for(;n.parentElement&&!n.parentElement.classList.contains("protyle-wysiwyg");)if(!n.parentElement.getAttribute("data-node-id"))n=n.parentElement;else{let o=!1;if(Array.from(n.parentElement.querySelectorAll('[contenteditable="true"]')).find(i=>{if(i.textContent.replace(Constants.ZWSP,"").replace(`
`,"")!=="")return o=!0,!0}),o||(t=n.previousElementSibling)!=null&&t.getAttribute("data-node-id")||(a=n.nextElementSibling)!=null&&a.getAttribute("data-node-id"))break;n=n.parentElement}return n},We=e=>{if(e.parentElement.getAttribute("data-type")==="NodeBlockquote"&&e.parentElement.childElementCount===2)for(;!e.parentElement.classList.contains("protyle-wysiwyg");)if(e.parentElement.getAttribute("data-type")==="NodeBlockquote"&&e.parentElement.childElementCount===2)e=e.parentElement;else{e=We(e);break}else if(e.parentElement.getAttribute("data-type")==="NodeSuperBlock"&&e.parentElement.childElementCount===2)for(;!e.parentElement.classList.contains("protyle-wysiwyg");)if(e.parentElement.getAttribute("data-type")==="NodeSuperBlock"&&e.parentElement.childElementCount===2)e=e.parentElement;else{e=We(e);break}else if(e.parentElement.getAttribute("data-type")==="NodeListItem"&&e.parentElement.childElementCount===3)for(;!e.parentElement.classList.contains("protyle-wysiwyg");)if(e.parentElement.getAttribute("data-type")==="NodeListItem"&&e.parentElement.childElementCount===3)e=e.parentElement;else if(e.parentElement.getAttribute("data-type")==="NodeList"&&e.parentElement.childElementCount===2)e=e.parentElement;else{e=We(e);break}else if(e.parentElement.getAttribute("data-type")==="NodeList"&&e.parentElement.childElementCount===2)for(;!e.parentElement.classList.contains("protyle-wysiwyg");)if(e.parentElement.getAttribute("data-type")==="NodeList"&&e.parentElement.childElementCount===2)e=e.parentElement;else if(e.parentElement.getAttribute("data-type")==="NodeListItem"&&e.parentElement.childElementCount===3)e=e.parentElement;else{e=We(e);break}return e},La=e=>{let t=e.nextSibling;for(;t;)if(t.textContent===""&&t.nodeType===3)t=t.nextSibling;else return t;return!1},Kl=e=>{if(e.endContainer.textContent.length!==e.endOffset)return!1;let t=e.endContainer;for(;t;){if(La(t))return!1;if(t.parentElement.getAttribute("spellcheck"))return!0;t=t.parentElement}return!0},Ht=e=>{let t=e.previousSibling;for(;t;)if(t.textContent===""&&t.nodeType===3)t=t.previousSibling;else return t;return!1},zl=e=>{let t=e.nextElementSibling;if(t)return t.tagName==="LI"?t:t.tagName==="UL"?t.firstElementChild:!1;for(t=e.parentElement;t.tagName==="UL";)if(!t.nextElementSibling)t=t.parentElement;else{if(t.nextElementSibling.tagName==="LI")return t.nextElementSibling;if(t.nextElementSibling.tagName==="UL")return t.nextElementSibling.firstElementChild}return!1},Zl=e=>{let t=e.previousElementSibling;if(t)return t.tagName==="LI"?t:t.tagName==="UL"?t.lastElementChild:!1;for(t=e.parentElement;t.tagName==="UL";)if(!t.previousElementSibling)t=t.parentElement;else{if(t.previousElementSibling.tagName==="LI")return t.previousElementSibling;if(t.previousElementSibling.tagName==="UL"){const a=t.previousElementSibling.querySelectorAll(".b3-list-item");return a[a.length-1]}}return!1},fi=(e,t)=>{if(!t){if(getSelection().rangeCount===0)return!1;t=getSelection().getRangeAt(0)}const a=t.commonAncestorContainer;return e.isEqualNode(a)||e.contains(a)},gi=e=>{const t=j(e.startContainer,"data-type","NodeTable");if(e.toString()!==""&&t&&e.commonAncestorContainer.nodeType!==3){const a=e.commonAncestorContainer.tagName;if(a!=="TH"&&a!=="TD"){const n=z(e.startContainer,"TD")||z(e.startContainer,"TH"),o=z(e.endContainer,"TD")||z(e.endContainer,"TH");if(!n&&!o){const i=t.querySelector("th")||t.querySelector("td");e.setStart(i.firstChild,0),e.setEnd(i.lastChild,i.lastChild.textContent.length)}else n&&!n.contains(e.endContainer)&&Jt(n,e,!1)}}},Xl=(e,t,a)=>{const n=getContenteditableElement(t);if(n){let s;if(n.tagName==="TABLE"){const l=hasClosestByTag(a.startContainer,"TD")||hasClosestByTag(a.startContainer,"TH");if(l&&(s=Sa(l,t,a),s.start!==0||s.end!==l.textContent.length))return a.setStart(l.firstChild,0),a.setEndAfter(l.lastChild),e.toolbar.render(e,a),countSelectWord(a,e.block.rootID),!0}else if(s=Sa(n,t,a),s.start!==0||s.end!==n.textContent.length){let l=n.firstChild;for(;l;)if(l.nodeType===3){if(l.textContent!==""){a.setStart(l,0);break}l=l.nextSibling}else{if(l.classList.contains("render-node")||l.classList.contains("img")){a.setStartBefore(l);break}l=l.firstChild}let r=n.lastChild;for(;r;)if(r.nodeType===3){if(r.textContent!==""){a.setEnd(r,r.textContent.length);break}r=r.previousSibling}else{if(r.classList.contains("render-node")||r.classList.contains("img")||r.tagName==="BR"){a.setEndAfter(r);break}r=r.lastChild}return Ae(a),e.toolbar.render(e,a),countSelectWord(a,e.block.rootID),!0}}a.collapse(!0);const o=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(e.wysiwyg.element.childElementCount===o.length&&o[0].parentElement.isSameNode(e.wysiwyg.element))return!0;hideElements(["select"],e);const i=[];Array.from(e.wysiwyg.element.children).forEach(s=>{const l=s.getAttribute("data-node-id");l&&(s.classList.add("protyle-wysiwyg--select"),i.push(l))}),countBlockWord(i,e.block.rootID)},Jl=(e,t)=>{const a=document.caretRangeFromPoint(e,t),n=hasClosestByAttribute(a.startContainer,"data-type","img");return n&&(a.setStart(n.nextSibling,0),a.collapse()),a},lt=e=>{let t;if(getSelection().rangeCount>0&&(t=getSelection().getRangeAt(0),e.isSameNode(t.startContainer)||e.contains(t.startContainer))){if(t.toString()===""&&t.startContainer.nodeType===1&&t.startOffset===0&&t.startContainer.classList.contains("protyle-wysiwyg")){const n=Re(t.startContainer.firstChild);if(n)return n}return t}e.focus({preventScroll:!0});let a;return e.classList.contains("table")?a=e.querySelector("th")||e.querySelector("td"):(a=me(e),a?a.tagName==="TABLE"&&(a=a.querySelector("th")||e.querySelector("td")):a=e),t=a.ownerDocument.createRange(),t.setStart(a||e,0),t.collapse(!0),t},Ql=(e,t)=>{var a,n;if(t||(t=lt(e)),!e.contains(t.startContainer))return{left:0,top:0};let o;if(t.getClientRects().length===0)if(t.startContainer.nodeType===3){const i=(a=t.startContainer.parentElement)==null?void 0:a.getClientRects(),s=(n=t.startContainer.previousElementSibling)==null?void 0:n.getClientRects();if(i.length>0||s.length>0)i.length===0||s&&s.length>0&&i[0].top<s[s.length-1].bottom?o={left:s[s.length-1].left,top:s[s.length-1].bottom}:o=i[0];else return{left:0,top:0}}else{const i=t.startContainer.children;if(i[t.startOffset]&&i[t.startOffset].getClientRects().length>0)o=i[t.startOffset].getClientRects()[0];else if(t.startContainer.childNodes.length>0){const s=t.cloneRange();t.selectNode(t.startContainer.childNodes[Math.max(0,t.startOffset-1)]),o=t.getClientRects()[0],t.setEnd(s.endContainer,s.endOffset),t.setStart(s.startContainer,s.startOffset)}else o=t.startContainer.getClientRects()[0];if(!o){let s=t.startContainer.childNodes[t.startOffset];if(s||(s=t.startContainer.childNodes[t.startOffset-1]),!s)o=t.getBoundingClientRect();else{for(;!s.getClientRects||s.getClientRects&&s.getClientRects().length===0;)s=s.parentElement;o=s.getClientRects()[0]}}}else{const i=t.getClientRects();return t.toString()?{left:i[i.length-1].left,top:i[0].top}:{left:i[i.length-1].left,top:i[i.length-1].top}}return{left:o.left,top:o.top}},Sa=(e,t,a)=>{const n={end:0,start:0};if(!a){if(getSelection().rangeCount===0)return n;a=window.getSelection().getRangeAt(0)}if(t&&!fi(t,a))return n;const o=a.cloneRange();return e.childNodes[0]&&e.childNodes[0].childNodes[0]?o.setStart(e.childNodes[0].childNodes[0],0):o.selectNodeContents(e),o.setEnd(a.startContainer,a.startOffset),n.start=o.toString().length+o.cloneContents().querySelectorAll("br").length,n.end=n.start+a.toString().length+a.cloneContents().querySelectorAll("br").length,n};function Xt(e,t,a,n){if(!t)return!1;if(a(t))return!0;for(let o=0,i=t.childNodes.length;o<i;o++)if(Xt(t,t.childNodes[o],a,!0))return!0;if(!n){let o=t;for(;o&&o!==e;){let i=o.nextSibling;for(;i;){if(Xt(e,i,a,!0))return!0;i=i.nextSibling}o=o.parentNode}}return!1}const Jt=(e,t,a=!0)=>{if(!e)return t;let n=e.lastChild;for(;n&&n.nodeType!==3;){if(n.nodeType!==3&&n.tagName==="BR")return t;if(!n.lastChild)break;n=n.lastChild}return n||(n=e),a?n.nodeType!==3&&n.classList.contains("render-node")&&n.innerHTML===""?t.setStartAfter(n):t.setStart(n,n.textContent.length):n.nodeType!==3&&n.classList.contains("render-node")&&n.innerHTML===""?t.setStartAfter(n):t.setEnd(n,n.textContent.length),t},pi=(e,t)=>{if(!e)return t;let a=e.firstChild;for(;a&&a.nodeType!==3&&!a.classList.contains("render-node");){if(a.classList.contains("img"))return t.setStartBefore(a),t;a=a.firstChild}return a?(a.nodeType!==3&&a.classList.contains("render-node")?t.setStartBefore(a):t.setStart(a,0),t):(t.selectNodeContents(e),t)},xa=(e,t,a,n=!0)=>{if(!e)return!1;const o=me(e);if(o)e=o;else if(Ye(e)||e.classList.contains("av"))return Re(e);let i;Xt(e,e.firstChild,r=>{if(r.nodeType===Node.TEXT_NODE){const c=r.data.length;return t<=c?(i=r,!0):(t-=c,a-=c,!1)}});let s;i&&Xt(e,i,r=>{if(r.nodeType===Node.TEXT_NODE){const c=r.data.length;return a<=c?(s=r,!0):(a-=c,!1)}});const l=document.createRange();return i?t<i.data.length?l.setStart(i,t):l.setStartAfter(i):t===0?l.setStart(e,0):Jt(me(e),l),s?a<s.data.length?l.setEnd(s,a):l.setEndAfter(s):a===0?l.setEnd(e,0):Jt(me(e),l,!1),n&&Ae(l),l},er=(e,t,a)=>{const n=Sa(e,e,t),o=e.cloneNode(!0),i=xa(o,n.end,n.end,!1);i&&i.insertNode(document.createElement("wbr")),a.wysiwyg.lastHTMLs[e.getAttribute("data-node-id")]=o.outerHTML},Ta=(e,t)=>{var a;const n=e.querySelectorAll("wbr");if(n.length===0)return;n.forEach((i,s)=>{s!==0&&i.remove()});const o=n[0];if(!o.previousElementSibling)o.previousSibling?t.setStart(o.previousSibling,o.previousSibling.textContent.length):o.nextSibling?o.nextSibling.nodeType===3?t.setStart(o.nextSibling,0):t.setStartAfter(o):t.setStart(o.parentElement,0);else{const i=Ht(o);i&&o.previousElementSibling.isSameNode(i)?((a=o.previousElementSibling.lastChild)==null?void 0:a.nodeType)===3?t.setStart(o.previousElementSibling.lastChild,o.previousElementSibling.lastChild.textContent.length):i.nodeType!==3&&i.classList.contains("img")?t.setStartAfter(i):t.setStartBefore(o):t.setStart(o.previousSibling,o.previousSibling.textContent.length)}t.collapse(!0),o.remove(),Ae(t)},Ae=e=>{if(!e)return;const t=e.startContainer.childNodes[e.startOffset];if(t&&t.nodeType!==3&&["INPUT","TEXTAREA"].includes(t.tagName)){t.focus();return}const a=window.getSelection();a.removeAllRanges(),a.addRange(e)},Re=(e,t,a=!0)=>{var n,o,i;if(!e)return!1;if(e.classList.contains("render-node")||e.classList.contains("iframe")||e.classList.contains("hr")||e.classList.contains("av")){const l=document.createRange(),r=e.getAttribute("data-type");let c=!1;if(r==="NodeThematicBreak")l.selectNodeContents(e.firstElementChild),c=!0;else if(r==="NodeBlockQueryEmbed")(n=e.lastElementChild.previousElementSibling)!=null&&n.firstChild?(l.selectNodeContents(e.lastElementChild.previousElementSibling.firstChild),l.collapse(!0)):(l.selectNodeContents(e),l.collapse(!0)),c=!0;else if(["NodeMathBlock","NodeHTMLBlock"].includes(r))(i=(o=e.lastElementChild.previousElementSibling)==null?void 0:o.lastElementChild)!=null&&i.firstChild?(l.selectNodeContents(e.lastElementChild.previousElementSibling.lastElementChild.firstChild),l.collapse(!0)):e.lastElementChild.previousElementSibling&&(l.selectNodeContents(e.lastElementChild.previousElementSibling),l.collapse(!0)),c=!0;else if(r==="NodeIFrame"||r==="NodeWidget")l.setStart(e,0),c=!0;else if(r==="NodeVideo")l.setStart(e.firstElementChild,0),c=!0;else if(r==="NodeAudio")l.setStart(e.firstElementChild.lastChild,0),c=!0;else if(r==="NodeCodeBlock")l.selectNodeContents(e),l.collapse(!0),c=!0;else if(r==="NodeAttributeView")return!1;return c?(Ae(l),l):(mi(e),!1)}let s;if(a?s=me(e):Array.from(e.querySelectorAll('[contenteditable="true"]')).reverse().find(l=>{if(l.getBoundingClientRect().width>0)return s=l,!0}),s){if(s.tagName==="TABLE")if(a)s=s.querySelector("th, td");else{const r=s.querySelectorAll("th, td");s=r[r.length-1]}let l;if(a)l=pi(s,lt(s)),l.collapse(!0);else{let r=!1;if(s.classList.contains("hljs")){let c=s.lastChild;if(c||(s.innerHTML=`
`,c=s.lastChild),c.textContent===""&&c.nodeType===3&&(c=Ht(s.lastChild)),c&&c.textContent.endsWith(`
`)){if(c.nodeType===1)for(c=c.lastChild;c&&c.textContent.indexOf(`
`)===-1;)c=c.previousSibling;l=lt(s),l.setStart(c,c.textContent.length-1),r=!0}}r||(l=Jt(s,lt(s))),l.collapse(!1)}return Ae(l),l}else if(t)t.focus();else if(e.classList.contains("li"))return Re(e.querySelector("[data-node-id]"),t,a);return!1},mi=e=>{if(e.getAttribute("data-node-id")){let a,n;e.nextElementSibling&&!e.nextElementSibling.classList.contains("protyle-attr")?(n=!0,a=it(e)):e.previousElementSibling&&(n=!1,a=Ue(e)),a||(a=e),Re(a,void 0,n);return}const t=lt(e);e.nextSibling?(t.selectNodeContents(e.nextSibling),t.collapse(!0)):e.previousSibling&&(t.selectNodeContents(e.previousSibling),t.collapse(!1)),Ae(t)},Ia=(e,t)=>{if(!document.getElementById(t)){const a=document.createElement("link");a.id=t,a.rel="stylesheet",a.type="text/css",a.href=e;const n=document.querySelector("#pluginsStyle");n?n.before(a):document.getElementsByTagName("head")[0].appendChild(a)}},An=()=>([1e7].toString()+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,e=>(parseInt(e,10)^window.crypto.getRandomValues(new Uint32Array(1))[0]&15>>parseInt(e,10)/4).toString(16)),tr=()=>{const e=document.getElementById("message");e.innerHTML=`<div class="fn__flex-1"></div>
<button class="b3-button ft__smaller fn__none">${window.siyuan.languages.clearMessage}</button>`,e.addEventListener("click",a=>{let n=a.target;for(;n&&!n.isEqualNode(e);){if(n.classList.contains("b3-snackbar__close")){rt(n.parentElement.getAttribute("data-id")),a.preventDefault();break}else if(n.isSameNode(e.lastElementChild)){n.parentElement.classList.remove("b3-snackbars--show"),setTimeout(()=>{n.parentElement.firstElementChild.innerHTML=""},Constants.TIMEOUT_INPUT),a.preventDefault();break}else{if(n.tagName==="A"||n.tagName==="BUTTON")break;if(n.classList.contains("b3-snackbar")){(getSelection().rangeCount===0||!getSelection().getRangeAt(0).toString())&&rt(n.getAttribute("data-id")),a.preventDefault(),a.stopPropagation();break}}n=n.parentElement}});const t=document.getElementById("tempMessage");t&&(tt(t.innerHTML),t.remove())},tt=(e,t=6e3,a="info",n)=>{const o=document.getElementById("message").firstElementChild;if(!o){document.body.insertAdjacentHTML("beforeend",`<div style="top: 10px;
    position: fixed;
    z-index: 100;
    background: white;
    padding: 10px;
    border-radius: 5px;
    right: 10px;
    border: 1px solid #e0e0e0;" id='tempMessage'>${e}</div>`);return}const i=n||An(),s=o.querySelector(`.b3-snackbar[data-id="${i}"]`),l=e+(a==="error"?" v"+S.SIYUAN_VERSION:"");if(s){if(window.clearTimeout(parseInt(s.getAttribute("data-timeoutid"))),s.innerHTML=`<div data-type="textMenu" class="b3-snackbar__content${t===0?" b3-snackbar__content--close":""}">${l}</div>${t===0?'<svg class="b3-snackbar__close"><use xlink:href="#iconCloseRound"></use></svg>':""}`,a==="error"?s.classList.add("b3-snackbar--error"):s.classList.remove("b3-snackbar--error"),t>0){const c=window.setTimeout(()=>{rt(i)},t);s.setAttribute("data-timeoutid",c.toString())}return}let r=`<div data-id="${i}" class="b3-snackbar--hide b3-snackbar${a==="error"?" b3-snackbar--error":""}"><div data-type="textMenu" class="b3-snackbar__content${t===0?" b3-snackbar__content--close":""}">${l}</div>`;if(t===0)r+='<svg class="b3-snackbar__close"><use xlink:href="#iconCloseRound"></use></svg>';else if(t!==-1){const c=window.setTimeout(()=>{rt(i)},t);r=r.replace("<div data-id",`<div data-timeoutid="${c}" data-id`)}return o.parentElement.classList.add("b3-snackbars--show"),o.parentElement.style.zIndex=(++window.siyuan.zIndex).toString(),o.insertAdjacentHTML("afterbegin",r+"</div>"),setTimeout(()=>{o.querySelectorAll(".b3-snackbar--hide").forEach(c=>{c.classList.remove("b3-snackbar--hide")})}),o.firstElementChild.nextElementSibling&&o.firstElementChild.nextElementSibling.innerHTML===o.firstElementChild.innerHTML&&o.firstElementChild.nextElementSibling.remove(),o.scrollTo({top:0,behavior:"smooth"}),i},rt=e=>{const t=document.getElementById("message").firstElementChild;if(t)if(e){const a=t.querySelector(`[data-id="${e}"]`);a&&(a.classList.add("b3-snackbar--hide"),window.clearTimeout(parseInt(a.getAttribute("data-timeoutid"))),setTimeout(()=>{a.remove(),t.childElementCount===0&&(t.parentElement.classList.remove("b3-snackbars--show"),t.innerHTML="")},S.TIMEOUT_INPUT));let n=!1;Array.from(t.children).find(o=>{if(!o.classList.contains("b3-snackbar--hide"))return n=!0,!0}),n?t.parentElement.classList.add("b3-snackbars--show"):t.parentElement.classList.remove("b3-snackbars--show")}else t.parentElement.classList.remove("b3-snackbars--show"),setTimeout(()=>{t.innerHTML=""},S.TIMEOUT_INPUT)};var Ma=(e,t,a)=>new Promise((n,o)=>{var i=r=>{try{l(a.next(r))}catch(c){o(c)}},s=r=>{try{l(a.throw(r))}catch(c){o(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(i,s);l((a=a.apply(e,t)).next())});const Ln=e=>{if(e)if(Qt())if(e.startsWith("assets/"))window.webkit.messageHandlers.openLink.postMessage(location.origin+"/assets/"+encodeURIComponent(e.replace("assets/","")));else if(e.startsWith("/"))window.webkit.messageHandlers.openLink.postMessage(location.origin+e);else try{new URL(e),window.webkit.messageHandlers.openLink.postMessage(e)}catch(t){window.webkit.messageHandlers.openLink.postMessage("https://"+e)}else ct()?window.JSAndroid.openExternal(e):dt()?window.JSHarmony.openExternal(e):window.open(e)},bi=()=>ct()?window.JSAndroid.readClipboard():dt()?window.JSHarmony.readClipboard():navigator.clipboard.readText(),ar=()=>Ma(void 0,null,function*(){const e={textPlain:"",textHTML:""};try{const t=yield navigator.clipboard.read();for(const a of t){if(a.types.includes("text/html")){const n=yield a.getType("text/html");e.textHTML=yield n.text()}if(a.types.includes("text/plain")){const n=yield a.getType("text/plain");e.textPlain=yield n.text()}if(a.types.includes("image/png")){const n=yield a.getType("image/png");e.files=[new File([n],"image.png",{type:"image/png",lastModified:Date.now()})]}}return e}catch(t){return ct()?(e.textPlain=window.JSAndroid.readClipboard(),e.textHTML=window.JSAndroid.readHTMLClipboard()):dt()&&(e.textPlain=window.JSHarmony.readClipboard(),e.textHTML=window.JSHarmony.readHTMLClipboard()),e}}),Da=e=>{let t;getSelection().rangeCount>0&&(t=getSelection().getRangeAt(0).cloneRange());try{if(ct()){window.JSAndroid.writeClipboard(e);return}if(dt()){window.JSHarmony.writeClipboard(e);return}if(Qt()){window.webkit.messageHandlers.setClipboard.postMessage(e);return}navigator.clipboard.writeText(e)}catch(a){if(Qt())window.webkit.messageHandlers.setClipboard.postMessage(e);else if(ct())window.JSAndroid.writeClipboard(e);else if(dt())window.JSHarmony.writeClipboard(e);else{const n=document.createElement("textarea");n.value=e,n.style.position="fixed",document.body.appendChild(n),n.focus(),n.select(),document.execCommand("copy"),document.body.removeChild(n),t&&Ae(t)}}},nr=e=>Ma(void 0,null,function*(){e=e.replace(new RegExp(Constants.ZWSP,"g"),""),yield Da(e)}),yi=()=>wi()?"touchstart":"click",sr=e=>Sn()?!!(e.metaKey&&!e.ctrlKey):!!(!e.metaKey&&e.ctrlKey),hi=e=>!e.metaKey&&!e.ctrlKey,ir=()=>window.siyuan.config.system.osPlatform.toLowerCase().indexOf("huawei")>-1,or=e=>{var t;return((t=window.siyuan.config.system.disabledFeatures)==null?void 0:t.indexOf(e))>-1},wi=()=>navigator.userAgent.indexOf("iPhone")>-1,lr=()=>navigator.userAgent.indexOf("iPad")>-1,Sn=()=>navigator.platform.toUpperCase().indexOf("MAC")>-1,rr=()=>Ma(void 0,null,function*(){if(!navigator.userAgentData||!navigator.userAgentData.getHighEntropyValues)return!1;const e=yield navigator.userAgentData.getHighEntropyValues(["platformVersion"]);return navigator.userAgentData.platform==="Windows"&&parseInt(e.platformVersion.split(".")[0])>=13}),cr=()=>navigator.platform.toUpperCase().indexOf("WIN")>-1,ct=()=>window.siyuan.config.system.container==="android"&&window.JSAndroid,Qt=()=>{var e;return window.siyuan.config.system.container==="ios"&&((e=window.webkit)==null?void 0:e.messageHandlers)},dt=()=>window.siyuan.config.system.container==="harmony"&&window.JSHarmony,$a=e=>{if(Sn())return e;const t=new Map(Object.entries({"\u2318":"Ctrl","\u2303":"Ctrl","\u21E7":"Shift","\u2325":"Alt","\u21E5":"Tab","\u232B":"Backspace","\u2326":"Delete","\u21A9":"Enter"})),a=[];(e.indexOf("\u2318")>-1||e.indexOf("\u2303")>-1)&&a.push(t.get("\u2318")),e.indexOf("\u21E7")>-1&&a.push(t.get("\u21E7")),e.indexOf("\u2325")>-1&&a.push(t.get("\u2325"));const n=e.replace(/⌘|⇧|⌥|⌃/g,"");return n&&a.push(t.get(n)||n),a.join("+")},dr=e=>{fetchPost("/api/storage/getLocalStorage",void 0,t=>{window.siyuan.storage=t.data;const a={};a[Constants.LOCAL_SEARCHASSET]={keys:[],col:"",row:"",layout:0,method:0,types:{},sort:0,k:""},a[Constants.LOCAL_SEARCHUNREF]={col:"",row:"",layout:0},Constants.SIYUAN_ASSETS_SEARCH.forEach(n=>{a[Constants.LOCAL_SEARCHASSET].types[n]=!0}),a[Constants.LOCAL_SEARCHKEYS]={keys:[],replaceKeys:[],col:"",row:"",layout:0,colTab:"",rowTab:"",layoutTab:0},a[Constants.LOCAL_PDFTHEME]={light:"light",dark:"dark",annoColor:"var(--b3-pdf-background1)"},a[Constants.LOCAL_LAYOUTS]=[],a[Constants.LOCAL_AI]=[],a[Constants.LOCAL_PLUGIN_DOCKS]={},a[Constants.LOCAL_PLUGINTOPUNPIN]=[],a[Constants.LOCAL_OUTLINE]={keepExpand:!0},a[Constants.LOCAL_FILEPOSITION]={},a[Constants.LOCAL_DIALOGPOSITION]={},a[Constants.LOCAL_HISTORY]={notebookId:"%",type:0,operation:"all",sideWidth:"256px",sideDocWidth:"256px",sideDiffWidth:"256px"},a[Constants.LOCAL_FLASHCARD]={fullscreen:!1},a[Constants.LOCAL_BAZAAR]={theme:"0",template:"0",icon:"0",widget:"0"},a[Constants.LOCAL_EXPORTWORD]={removeAssets:!1,mergeSubdocs:!1},a[Constants.LOCAL_EXPORTPDF]={landscape:!1,marginType:"0",scale:1,pageSize:"A4",removeAssets:!0,keepFold:!1,mergeSubdocs:!1,watermark:!1},a[Constants.LOCAL_EXPORTIMG]={keepFold:!1,watermark:!1},a[Constants.LOCAL_DOCINFO]={id:""},a[Constants.LOCAL_IMAGES]={file:"1f4c4",note:"1f5c3",folder:"1f4d1"},a[Constants.LOCAL_EMOJIS]={currentTab:"emoji"},a[Constants.LOCAL_FONTSTYLES]=[],a[Constants.LOCAL_FILESPATHS]=[],a[Constants.LOCAL_SEARCHDATA]={page:1,sort:0,group:0,hasReplace:!1,method:0,hPath:"",idPath:[],k:"",r:"",types:{document:window.siyuan.config.search.document,heading:window.siyuan.config.search.heading,list:window.siyuan.config.search.list,listItem:window.siyuan.config.search.listItem,codeBlock:window.siyuan.config.search.codeBlock,htmlBlock:window.siyuan.config.search.htmlBlock,mathBlock:window.siyuan.config.search.mathBlock,table:window.siyuan.config.search.table,blockquote:window.siyuan.config.search.blockquote,superBlock:window.siyuan.config.search.superBlock,paragraph:window.siyuan.config.search.paragraph,embedBlock:window.siyuan.config.search.embedBlock,databaseBlock:window.siyuan.config.search.databaseBlock},replaceTypes:Object.assign({},Constants.SIYUAN_DEFAULT_REPLACETYPES)},a[Constants.LOCAL_ZOOM]=1,a[Constants.LOCAL_MOVE_PATH]={keys:[],k:""},[Constants.LOCAL_EXPORTIMG,Constants.LOCAL_SEARCHKEYS,Constants.LOCAL_PDFTHEME,Constants.LOCAL_BAZAAR,Constants.LOCAL_EXPORTWORD,Constants.LOCAL_EXPORTPDF,Constants.LOCAL_DOCINFO,Constants.LOCAL_FONTSTYLES,Constants.LOCAL_SEARCHDATA,Constants.LOCAL_ZOOM,Constants.LOCAL_LAYOUTS,Constants.LOCAL_AI,Constants.LOCAL_PLUGINTOPUNPIN,Constants.LOCAL_SEARCHASSET,Constants.LOCAL_FLASHCARD,Constants.LOCAL_DIALOGPOSITION,Constants.LOCAL_SEARCHUNREF,Constants.LOCAL_HISTORY,Constants.LOCAL_OUTLINE,Constants.LOCAL_FILEPOSITION,Constants.LOCAL_FILESPATHS,Constants.LOCAL_IMAGES,Constants.LOCAL_PLUGIN_DOCKS,Constants.LOCAL_EMOJIS,Constants.LOCAL_MOVE_PATH].forEach(n=>{if(typeof t.data[n]=="string")try{const o=JSON.parse(t.data[n]);typeof o=="number"?window.siyuan.storage[n]=o:window.siyuan.storage[n]=Object.assign(a[n],o)}catch(o){window.siyuan.storage[n]=a[n]}else typeof t.data[n]=="undefined"&&(window.siyuan.storage[n]=a[n])}),(!window.siyuan.storage[Constants.LOCAL_SEARCHDATA].replaceTypes||Object.keys(window.siyuan.storage[Constants.LOCAL_SEARCHDATA].replaceTypes).length===0)&&(window.siyuan.storage[Constants.LOCAL_SEARCHDATA].replaceTypes=Object.assign({},Constants.SIYUAN_DEFAULT_REPLACETYPES)),e()})},Ha=(e,t,a)=>{window.siyuan.config.readonly||he("/api/storage/setLocalStorageVal",{app:S.SIYUAN_APPID,key:e,val:t},()=>{a&&a()})},xn=e=>{var t,a,n;if(e.cmd==="msg"){const o=tt(e.msg,e.data.closeTimeout,e.code===0?"info":"error",e.data.id);return(t=document.querySelector("#message #addMicrosoftDefenderExclusion"))==null||t.addEventListener("click",i=>{i.target.innerHTML='<svg class="fn__rotate" style="margin-right: 0;"><use xlink:href="#iconRefresh"></use></svg>',he("/api/system/addMicrosoftDefenderExclusion",{},()=>{rt(o)})},{once:!0}),(a=document.querySelector("#message #ignoreAddMicrosoftDefenderExclusion"))==null||a.addEventListener("click",()=>{rt(o),he("/api/system/ignoreAddMicrosoftDefenderExclusion")},{once:!0}),!1}if(e.cmd==="cmsg")return rt(e.data.id),!1;if(e.cmd==="cprogress"){const o=document.getElementById("progress");return o&&o.remove(),!1}return e.cmd==="reloadui"?((n=e.data)!=null&&n.resetScroll?(window.siyuan.storage[S.LOCAL_FILEPOSITION]={},Ha(S.LOCAL_FILEPOSITION,window.siyuan.storage[S.LOCAL_FILEPOSITION],()=>{window.location.reload()})):window.location.reload(),!1):e.code<0?(tt(e.msg,e.data&&e.data.closeTimeout||0,e.code===-1?"error":"info"),!1):e};class Tn{constructor(t){this.disableClose=t.disableClose,this.id=An(),window.siyuan.dialogs.push(this),this.destroyCallback=t.destroyCallback,this.element=document.createElement("div");let a,n;if(!$()&&t.positionId){const o=window.siyuan.storage[S.LOCAL_DIALOGPOSITION][t.positionId];o&&o.left+o.width+34<=window.innerWidth&&o.top+o.height<=window.innerHeight&&(a=o.left+"px",n=o.top+"px",t.width=o.width+"px",t.height=o.height+"px")}this.element.innerHTML=`<div class="b3-dialog" style="z-index: ${++window.siyuan.zIndex};${typeof a=="string"?"display:block":""}">
<div class="b3-dialog__scrim"${t.transparent?'style="background-color:transparent"':""}></div>
<div class="b3-dialog__container ${t.containerClassName||""}" style="width:${t.width||"auto"};height:${t.height||"auto"};
left:${a||"auto"};top:${n||"auto"}">
  <svg ${$()&&t.title?'style="top:0;right:0;"':""} class="b3-dialog__close${this.disableClose||t.hideCloseIcon?" fn__none":""}"><use xlink:href="#iconCloseRound"></use></svg>
  <div class="resize__move b3-dialog__header${t.title?"":" fn__none"}" onselectstart="return false;">${t.title||""}</div>
  <div class="b3-dialog__body">${t.content}</div>
  <div class="resize__rd"></div><div class="resize__ld"></div><div class="resize__lt"></div><div class="resize__rt"></div><div class="resize__r"></div><div class="resize__d"></div><div class="resize__t"></div><div class="resize__l"></div>
</div></div>`,this.element.querySelector(".b3-dialog__scrim").addEventListener("click",o=>{this.disableClose||this.destroy(),o.preventDefault(),o.stopPropagation()}),this.disableClose||this.element.querySelector(".b3-dialog__close").addEventListener("click",o=>{this.destroy(),o.preventDefault(),o.stopPropagation()}),document.body.append(this.element),t.disableAnimation?this.element.classList.add("b3-dialog--open"):setTimeout(()=>{this.element.classList.add("b3-dialog--open")})}destroy(t){var a;this.element.querySelector(".b3-dialog").style.zIndex<window.siyuan.menus.menu.element.style.zIndex&&window.siyuan.menus.menu.remove(),this.element.remove(),this.destroyCallback&&this.destroyCallback(t),window.siyuan.dialogs.find((n,o)=>{if(n.id===this.id)return window.siyuan.dialogs.splice(o,1),!0}),(a=document.getElementById("drag"))==null||a.classList.remove("fn__hidden")}bindInput(t,a,n=!0){t.focus(),t.addEventListener("keydown",o=>{if(o.isComposing){o.preventDefault();return}if(o.key==="Escape"){this.destroy(),o.preventDefault(),o.stopPropagation();return}!o.shiftKey&&hi(o)&&o.key==="Enter"&&a&&n&&(a(),o.preventDefault(),o.stopPropagation())})}}const ur=(e,t,a,n,o=!1)=>{if(!t&&!e){a();return}const i=new Dialog({title:e,content:`<div class="b3-dialog__content">
    <div class="ft__breakword">${t}</div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel" id="cancelDialogConfirmBtn">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button ${o?"b3-button--remove":"b3-button--text"}" id="confirmDialogConfirmBtn">${window.siyuan.languages[o?"delete":"confirm"]}</button>
</div>`,width:isMobile()?"92vw":"520px"});i.element.addEventListener("click",s=>{let l=s.target;const r=typeof s.detail=="string";for(;l&&!l.isSameNode(i.element)||r;){if(l.id==="cancelDialogConfirmBtn"||r&&s.detail==="Escape"){n&&n(i),i.destroy();break}else if(l.id==="confirmDialogConfirmBtn"||r&&s.detail==="Enter"){a&&a(i),i.destroy();break}l=l.parentElement}}),i.element.setAttribute("data-key",Constants.DIALOG_CONFIRM)};var Na=Me(101);const fr=(e,t,a,n=0,o=0)=>{e.style.top=a+"px",e.style.left=t+"px";const i=e.getBoundingClientRect();if(i.bottom>window.innerHeight||i.top<Constants.SIZE_TOOLBAR_HEIGHT){const s=a-i.height-n;s>Constants.SIZE_TOOLBAR_HEIGHT&&s+i.height<window.innerHeight?e.style.top=s+"px":s<=Constants.SIZE_TOOLBAR_HEIGHT?e.style.top=Constants.SIZE_TOOLBAR_HEIGHT+"px":e.style.top=Math.max(Constants.SIZE_TOOLBAR_HEIGHT,window.innerHeight-i.height)+"px"}i.right>window.innerWidth?e.style.left=`${window.innerWidth-i.width-o}px`:i.left<0&&(e.style.left="0")};var Ze=Me(752);const _i=()=>{const e=window.siyuan.emojis[getRandom(0,window.siyuan.emojis.length-1)];return typeof e.items[getRandom(0,e.items.length-1)]=="undefined"?"1f600":e.items[getRandom(0,e.items.length-1)].unicode},Le=(e,t="",a=!1,n=!1)=>{if(!e)return"";let o="";if(e.startsWith("api/icon/getDynamicIcon"))o=`<img class="${t}" ${n?"data-":""}src="${e}"/>`;else if(e.indexOf(".")>-1)o=`<img class="${t}" ${n?"data-":""}src="/emojis/${e}"/>`;else try{e.split("-").forEach(i=>{i.length<5?o+=String.fromCodePoint(parseInt("0"+i,16)):o+=String.fromCodePoint(parseInt(i,16))}),a&&(o=`<span class="${t}">${o}</span>`)}catch(i){}return o},Ba=e=>{const t=new IntersectionObserver(a=>{a.forEach(n=>{const o=n.target.getAttribute("data-index");if((typeof n.isIntersecting=="undefined"?n.intersectionRatio!==0:n.isIntersecting)&&o){let i="";window.siyuan.emojis[parseInt(o)].items.forEach(s=>{i+=`<button data-unicode="${s.unicode}" class="emojis__item ariaLabel" aria-label="${At(s)}">
${Le(s.unicode)}</button>`}),n.target.innerHTML=i,n.target.removeAttribute("data-index"),n.target.style.minHeight=""}})});e.querySelectorAll(".emojis__content").forEach(a=>{t.observe(a)})},Pa=e=>{const t=new IntersectionObserver(a=>{a.forEach(n=>{const o=n.target.getAttribute("data-src");(typeof n.isIntersecting=="undefined"?n.intersectionRatio!==0:n.isIntersecting)&&o&&(n.target.src=o,n.target.removeAttribute("data-src"))})});e.querySelectorAll("img").forEach(a=>{t.observe(a)})},Ra=(e="",t)=>{let a="";const n=[];e&&(a=`<div class="emojis__title">${window.siyuan.languages.emoji}</div><div class="emojis__content">`);let o=0,i="";const s=[];window.siyuan.emojis.forEach((r,c)=>{e||(a+=`<div class="emojis__title" data-type="${c+1}">${je(c)}</div><div style="min-height:${c===0?"30px":"300px"}" class="emojis__content"${c>1?' data-index="'+c+'"':""}>`),r.items.length===0&&c===0&&!e&&(a+=`<div style="margin-left: 4px">${window.siyuan.languages.setEmojiTip}</div>`),r.items.forEach(d=>{if(e){if(window.siyuan.config.editor.emoji.includes(d.unicode)&&(Le(d.unicode)===e||d.keywords.toLowerCase().indexOf(e.toLowerCase())>-1||d.description.toLowerCase().indexOf(e.toLowerCase())>-1||d.description_zh_cn.toLowerCase().indexOf(e.toLowerCase())>-1||d.description_ja_jp.toLowerCase().indexOf(e.toLowerCase())>-1)&&n.push(d),t&&o>t)return;(Le(d.unicode)===e||d.keywords.toLowerCase().indexOf(e.toLowerCase())>-1||d.description.toLowerCase().indexOf(e.toLowerCase())>-1||d.description_zh_cn.toLowerCase().indexOf(e.toLowerCase())>-1||d.description_ja_jp.toLowerCase().indexOf(e.toLowerCase())>-1)&&(r.id==="custom"?s.push(d):i+=`<button data-unicode="${d.unicode}" class="emojis__item ariaLabel" aria-label="${At(d)}">
${Le(d.unicode,void 0,!1,!0)}</button>`,o++)}else window.siyuan.config.editor.emoji.includes(d.unicode)&&n.push(d),c<2&&(a+=`<button data-unicode="${d.unicode}" class="emojis__item ariaLabel" aria-label="${At(d)}">
${Le(d.unicode,void 0,!1,!0)}</button>`)}),e||(a+="</div>")}),e&&(s.sort((r,c)=>{const d=r.keywords.split("/"),u=c.keywords.split("/");return d[d.length-1].toLowerCase().indexOf(e.toLowerCase())<u[u.length-1].toLowerCase().indexOf(e.toLowerCase())?-1:0}).sort((r,c)=>{const d=r.keywords.split("/"),u=c.keywords.split("/");return d[d.length-1].toLowerCase().indexOf(e.toLowerCase())===u[u.length-1].toLowerCase().indexOf(e.toLowerCase())&&d[d.length-1].length<u[u.length-1].length?-1:0}).forEach(r=>{a+=`<button data-unicode="${r.unicode}" class="emojis__item ariaLabel" aria-label="${At(r)}">
${Le(r.unicode,void 0,!1,!0)}</button>`}),a=a+i+"</div>");let l="";return n.length>0&&(l=`<div class="emojis__title" data-type="0">${window.siyuan.languages.recentEmoji}</div><div class="emojis__content">`,window.siyuan.config.editor.emoji.forEach(r=>{const c=n.filter(d=>d.unicode===r);c[0]&&(l+=`<button data-unicode="${c[0].unicode}" class="emojis__item ariaLabel" aria-label="${At(c[0])}">
${Le(c[0].unicode,void 0,!1,!0)}
</button>`)}),l+="</div>"),l+a===""?`<div class="emojis__title">${window.siyuan.languages.emptyContent}</div>`:l+a},ea=e=>{window.siyuan.config.editor.emoji.unshift(e),window.siyuan.config.editor.emoji.length>Constants.SIZE_UNDO&&window.siyuan.config.editor.emoji.pop(),window.siyuan.config.editor.emoji=Array.from(new Set(window.siyuan.config.editor.emoji)),fetchPost("/api/setting/setEmoji",{emoji:window.siyuan.config.editor.emoji})},In=(e,t)=>{const a={1:["Sun","\u5468\u65E5","\u9031\u65E5"],2:["SUN","\u5468\u5929","\u9031\u5929"],3:["Sunday","\u661F\u671F\u65E5","\u661F\u671F\u65E5"],4:["SUNDAY","\u661F\u671F\u5929","\u661F\u671F\u5929"]};let n=0;return e===""&&(e=window.siyuan.config.lang),e==="zh_CN"?n=1:e==="zh_CHT"&&(n=2),`<option value="1" ${t==="1"?" selected":""}>${a[1][n]}</option>
<option value="2" ${t==="2"?" selected":""}>${a[2][n]}</option>
<option value="3" ${t==="3"?" selected":""}>${a[3][n]}</option>
<option value="4" ${t==="4"?" selected":""}>${a[4][n]}</option>`},Mn=(e,t)=>{if(!e)return;let a="";window.siyuan.emojis[parseInt(e)].items.forEach(n=>{a+=`<button data-unicode="${n.unicode}" class="emojis__item ariaLabel" aria-label="${At(n)}">${Le(n.unicode)}</button>`}),t.innerHTML=a,t.removeAttribute("data-index"),t.removeAttribute("style")},gr=(e,t,a,n,o)=>{t!=="av"?window.siyuan.menus.menu.remove():window.siyuan.menus.menu.removeScrollEvent();const i="api/icon/getDynamicIcon?",s={color:"#d23f31",lang:"",date:"",weekdayType:"1",type:"1",content:"SiYuan"};if(o&&o.getAttribute("src").startsWith(i)){const b=new URLSearchParams(o.getAttribute("src").replace(i,""));s.color=b.get("color")||"#d23f31",s.color.startsWith("#")||(s.color="#"+s.color),s.lang=b.get("lang")||"",s.date=b.get("date")||"",s.weekdayType=b.get("weekdayType")||"1",s.type=b.get("type")||"1",s.content=b.get("content")||"SiYuan"}const l=new Dialog({disableAnimation:!0,transparent:!0,hideCloseIcon:!0,width:isMobile()?"80vw":"368px",height:"50vh",content:`<div class="emojis">
    <div class="emojis__tabheader">
        <div data-type="tab-emoji" class="ariaLabel block__icon block__icon--show" aria-label="${window.siyuan.languages.emoji}"><svg><use xlink:href="#iconEmoji"></use></svg></div>
        <div class="fn__space"></div>
        <div data-type="tab-dynamic" class="ariaLabel block__icon block__icon--show" aria-label="${window.siyuan.languages.dynamicEmoji}"><svg><use xlink:href="#iconCalendar"></use></svg></div>
        <div class="fn__flex-1"></div>
        <span class="block__icon block__icon--show fn__flex-center ariaLabel" data-action="remove" aria-label="${window.siyuan.languages.remove}"><svg><use xlink:href="#iconTrashcan"></use></svg></span>
    </div>
    <div class="emojis__tabbody">
        <div class="fn__none" data-type="tab-emoji">
            <div class="fn__hr"></div>
            <div class="fn__flex">
                <span class="fn__space"></span>
                <label class="b3-form__icon fn__flex-1" style="overflow:initial;">
                    <svg class="b3-form__icon-icon"><use xlink:href="#iconSearch"></use></svg>
                    <input class="b3-form__icon-input b3-text-field fn__block" placeholder="${window.siyuan.languages.search}">
                </label>
                <span class="fn__space"></span>
                <span class="block__icon block__icon--show fn__flex-center ariaLabel" data-action="random" aria-label="${window.siyuan.languages.random}"><svg><use xlink:href="#iconRefresh"></use></svg></span>
                <span class="fn__space"></span>
            </div>
            <div class="emojis__panel">${Ra()}</div>
            <div class="fn__flex">
                ${[["2b50",window.siyuan.languages.recentEmoji],["1f527",je(0)],["1f60d",je(1)],["1f433",je(2)],["1f96a",je(3)],["1f3a8",je(4)],["1f3dd-fe0f",je(5)],["1f52e",je(6)],["267e-fe0f",je(7)],["1f6a9",je(8)]].map(([b,w],y)=>`<div data-type="${y}" class="emojis__type ariaLabel" aria-label="${w}">${Le(b)}</div>`).join("")}
            </div>
        </div>
        <div class="fn__none" data-type="tab-dynamic">
            <div class="fn__flex emoji__dynamic-color">
                <div class="color__square fn__pointer${s.color==="#d23f31"?" color__square--current":""}" style="background-color:#d23f31"></div>
                <div class="color__square fn__pointer${s.color==="#3575f0"?" color__square--current":""}" style="background-color:#3575f0"></div>
                <div class="color__square fn__pointer${s.color==="#f3a92f"?" color__square--current":""}" style="background-color:#f3a92f"></div>
                <div class="color__square fn__pointer${s.color==="#65b84d"?" color__square--current":""}" style="background-color:#65b84d"></div>
                <div class="color__square fn__pointer${s.color==="#e099ff"?" color__square--current":""}" style="background-color:#e099ff"></div>
                <div class="color__square fn__pointer${s.color==="#ea5d97"?" color__square--current":""}" style="background-color:#ea5d97"></div>
                <div class="color__square fn__pointer${s.color==="#93627f"?" color__square--current":""}" style="background-color:#93627f"></div>
                <div class="color__square fn__pointer${s.color==="#5f6368"?" color__square--current":""}" style="background-color:#5f6368"></div>
                <div class="fn__space--small"></div>
                <input type="text" class="b3-text-field fn__flex-1 fn__flex-center" value="${s.color}">
            </div>
            <div class="fn__flex">
                <span class="fn__space"></span>
                <span class="fn__flex-center ft__on-surface" style="width: 89px">${window.siyuan.languages.language}</span>
                <span class="fn__space--small"></span>
                <select class="b3-select fn__flex-1">
                    <option value="" ${s.lang===""?" selected":""}>${window.siyuan.languages.themeOS}</option>
                    <option value="en_US" ${s.lang==="en_US"?" selected":""}>English (en_US)</option>
                    <option value="zh_CHT" ${s.lang==="zh_CHT"?" selected":""}>\u7E41\u9AD4\u4E2D\u6587 (zh_CHT)</option>
                    <option value="zh_CN" ${s.lang==="zh_CN"?" selected":""}>\u7B80\u4F53\u4E2D\u6587 (zh_CN)</option>
                </select>
                <span class="fn__space"></span>
            </div>
            <div class="fn__hr"></div>
            <div class="fn__flex">
                <span class="fn__space"></span>
                <span class="fn__flex-center ft__on-surface" style="width: 89px">${window.siyuan.languages.date}</span>
                <span class="fn__space--small"></span>
                <input type="date" max="9999-12-31" class="b3-text-field fn__flex-1" value="${s.date}"/>
                <span class="fn__space"></span>
            </div>
            <div class="fn__hr"></div>
            <div class="fn__flex">
                <span class="fn__space"></span>
                <span class="fn__flex-center ft__on-surface" style="width: 89px">${window.siyuan.languages.format}</span>
                <span class="fn__space--small"></span>
                <select class="b3-select fn__flex-1">
                    ${In(s.lang,s.weekdayType)}
                </select>
                <span class="fn__space"></span>
            </div>
            <div class="fn__flex fn__flex-wrap">
                <img class="emoji__dynamic-item${s.type==="1"?" emoji__dynamic-item--current":""}" src="${i}type=1&color=${encodeURIComponent(s.color)}&date=${s.date}&weekdayType=${s.weekdayType}&lang=${s.lang}">
                <img class="emoji__dynamic-item${s.type==="2"?" emoji__dynamic-item--current":""}" src="${i}type=2&color=${encodeURIComponent(s.color)}&date=${s.date}&weekdayType=${s.weekdayType}&lang=${s.lang}">
                <img class="emoji__dynamic-item${s.type==="3"?" emoji__dynamic-item--current":""}" src="${i}type=3&color=${encodeURIComponent(s.color)}&date=${s.date}&weekdayType=${s.weekdayType}&lang=${s.lang}">
                <img class="emoji__dynamic-item${s.type==="4"?" emoji__dynamic-item--current":""}" src="${i}type=4&color=${encodeURIComponent(s.color)}&date=${s.date}&weekdayType=${s.weekdayType}&lang=${s.lang}">
                <img class="emoji__dynamic-item${s.type==="5"?" emoji__dynamic-item--current":""}" src="${i}type=5&color=${encodeURIComponent(s.color)}&date=${s.date}&weekdayType=${s.weekdayType}&lang=${s.lang}">
                <img class="emoji__dynamic-item${s.type==="6"?" emoji__dynamic-item--current":""}" src="${i}type=6&color=${encodeURIComponent(s.color)}&date=${s.date}&weekdayType=${s.weekdayType}&lang=${s.lang}">
                <img class="emoji__dynamic-item${s.type==="7"?" emoji__dynamic-item--current":""}" src="${i}type=7&color=${encodeURIComponent(s.color)}&date=${s.date}&weekdayType=${s.weekdayType}&lang=${s.lang}">
            </div>
            <div class="fn__hr"></div>
            <div class="fn__flex">
                <span class="fn__space"></span>
                <span class="fn__flex-center ft__on-surface" style="width: 89px">${window.siyuan.languages.custom}</span>
                <span class="fn__space--small"></span>
                <input type="text" class="b3-text-field fn__flex-1" value="${s.content}">
                <span class="fn__space"></span>
            </div>
            <div>
                <img data-type="text" class="emoji__dynamic-item${s.type==="8"?" emoji__dynamic-item--current":""}" src="${i}type=8&color=${encodeURIComponent(s.color)}&content=${s.content}&id=${e}">
            </div>
        </div>
    </div>
</div>`});l.element.setAttribute("data-key",Constants.DIALOG_EMOJIS),l.element.querySelector(".b3-dialog__container").setAttribute("data-menu","true");const r=l.element.querySelector(".b3-dialog");r.style.justifyContent="inherit",r.style.alignItems="inherit";const c=window.siyuan.storage[Constants.LOCAL_EMOJIS].currentTab;l.element.querySelector(`.emojis__tabheader [data-type="tab-${c}"]`).classList.add("block__icon--active"),l.element.querySelector(`.emojis__tabbody [data-type="tab-${c}"]`).classList.remove("fn__none"),setPosition(l.element.querySelector(".b3-dialog__container"),a.x,a.y,a.h,a.w),l.element.querySelector(".emojis__item").classList.add("emojis__item--current");const d=l.element.querySelector('[data-type="tab-emoji"] .b3-text-field'),u=l.element.querySelector(".emojis__panel");d.addEventListener("compositionend",()=>{var b;u.innerHTML=Ra(d.value),d.value?u.nextElementSibling.classList.add("fn__none"):u.nextElementSibling.classList.remove("fn__none"),u.scrollTop=0,(b=l.element.querySelector(".emojis__item"))==null||b.classList.add("emojis__item--current"),d.value===""&&Ba(l.element),Pa(l.element)}),d.addEventListener("input",b=>{var w;b.isComposing||(u.innerHTML=Ra(d.value),d.value?u.nextElementSibling.classList.add("fn__none"):u.nextElementSibling.classList.remove("fn__none"),u.scrollTop=0,(w=l.element.querySelector(".emojis__item"))==null||w.classList.add("emojis__item--current"),d.value===""&&Ba(l.element),Pa(l.element))}),d.addEventListener("keydown",b=>{var w,y,_,h;if(b.isComposing||b.key.indexOf("Arrow")===-1&&b.key!=="Enter")return;const E=l.element.querySelector(".emojis__item--current");if(!E)return;if(b.key==="Enter"){const k=E.getAttribute("data-unicode");t==="notebook"?fetchPost("/api/notebook/setNotebookIcon",{notebook:e,icon:k},()=>{l.destroy(),ea(k),Ct(k,e,"iconFilesRoot")}):t==="doc"&&fetchPost("/api/attr/setBlockAttrs",{id:e,attrs:{icon:k}},()=>{l.destroy(),ea(k),Ct(k,e),Oa(k,e)}),n&&n(k),b.preventDefault(),b.stopPropagation();return}let C;if(b.key==="ArrowLeft")E.previousElementSibling?(E.classList.remove("emojis__item--current"),C=E.previousElementSibling,b.preventDefault(),b.stopPropagation()):(w=E.parentElement.previousElementSibling)!=null&&w.previousElementSibling&&(E.classList.remove("emojis__item--current"),C=E.parentElement.previousElementSibling.previousElementSibling.lastElementChild,b.preventDefault(),b.stopPropagation());else if(b.key==="ArrowRight")E.nextElementSibling?(E.classList.remove("emojis__item--current"),C=E.nextElementSibling,b.preventDefault(),b.stopPropagation()):(y=E.parentElement.nextElementSibling)!=null&&y.nextElementSibling&&(E.classList.remove("emojis__item--current"),C=E.parentElement.nextElementSibling.nextElementSibling.firstElementChild,b.preventDefault(),b.stopPropagation());else if(b.key==="ArrowDown"){if(E.nextElementSibling){E.classList.remove("emojis__item--current");let k=Math.floor(E.parentElement.clientWidth/(E.clientWidth+2));for(C=E;C.nextElementSibling&&k>0;)C=C.nextElementSibling,k--}else{const k=(_=E.parentElement.nextElementSibling)==null?void 0:_.nextElementSibling;k&&(C=k.firstElementChild,E.classList.remove("emojis__item--current"))}b.preventDefault(),b.stopPropagation()}else if(b.key==="ArrowUp"){if(E.previousElementSibling){E.classList.remove("emojis__item--current");let k=Math.floor(E.parentElement.clientWidth/(E.clientWidth+2));for(C=E;C.previousElementSibling&&k>0;)C=C.previousElementSibling,k--}else{const k=(h=E.parentElement.previousElementSibling)==null?void 0:h.previousElementSibling;k&&(C=k.lastElementChild,E.classList.remove("emojis__item--current"))}b.preventDefault(),b.stopPropagation()}if(C){C.classList.add("emojis__item--current");const k=d.clientHeight+6;C.offsetTop-k<u.scrollTop?u.scrollTop=C.offsetTop-k-6:C.offsetTop-k-u.clientHeight+C.clientHeight>u.scrollTop&&(u.scrollTop=C.offsetTop-k-u.clientHeight+C.clientHeight)}}),!isMobile()&&c==="emoji"&&d.focus(),Ba(l.element),Pa(l.element),l.element.addEventListener("click",b=>{var w,y;let _=b.target;for(;_&&_!==l.element;){if(_.classList.contains("emojis__type")){const h=u.querySelector(`[data-type="${_.getAttribute("data-type")}"]`);if(h){const E=h.nextElementSibling.getAttribute("data-index");E&&(Mn((w=h.previousElementSibling)==null?void 0:w.getAttribute("data-index"),h.previousElementSibling),Mn(E,h.nextElementSibling)),u.scrollTo({top:h.offsetTop-77})}break}else if(_.getAttribute("data-action")==="remove"){t==="notebook"?fetchPost("/api/notebook/setNotebookIcon",{notebook:e,icon:""},()=>{l.destroy(),Ct("",e,"iconFilesRoot")}):t==="doc"&&fetchPost("/api/attr/setBlockAttrs",{id:e,attrs:{icon:""}},()=>{l.destroy(),Ct("",e),Oa("",e)}),n&&n("");break}else if(_.classList.contains("emojis__item")||_.getAttribute("data-action")==="random"||_.classList.contains("emoji__dynamic-item")){let h="";_.classList.contains("emojis__item")?(h=_.getAttribute("data-unicode"),l.destroy()):_.classList.contains("emoji__dynamic-item")?(h=_.getAttribute("src"),l.destroy()):h=_i(),t==="notebook"?fetchPost("/api/notebook/setNotebookIcon",{notebook:e,icon:h},()=>{ea(h),Ct(h,e,"iconFilesRoot")}):t==="doc"&&fetchPost("/api/attr/setBlockAttrs",{id:e,attrs:{icon:h}},()=>{ea(h),Ct(h,e),Oa(h,e)}),n&&n(h);break}else if((y=_.getAttribute("data-type"))!=null&&y.startsWith("tab-")){r.querySelectorAll('.emojis__tabheader [data-type|="tab"]').forEach(h=>{h.dataset.type===_.dataset.type?h.classList.add("block__icon--active"):h.classList.remove("block__icon--active")}),r.querySelectorAll(".emojis__tabbody > div").forEach(h=>{h.dataset.type===_.dataset.type?h.classList.remove("fn__none"):h.classList.add("fn__none")}),window.siyuan.storage[Constants.LOCAL_EMOJIS].currentTab=_.dataset.type.replace("tab-",""),setStorageVal(Constants.LOCAL_EMOJIS,window.siyuan.storage[Constants.LOCAL_EMOJIS]);break}else if(_.classList.contains("color__square")){p[0].value=_.getAttribute("style").replace("background-color:",""),p[0].dispatchEvent(new CustomEvent("input"));break}_=_.parentElement}});const g=l.element.querySelectorAll('[data-type="tab-dynamic"] .b3-select');g[0].addEventListener("change",()=>{l.element.querySelectorAll(".fn__flex-wrap .emoji__dynamic-item").forEach(b=>{const w=new URLSearchParams(b.getAttribute("src").replace(i,""));g[0].value?w.set("lang",g[0].value):w.delete("lang"),b.setAttribute("src",i+w.toString()),g[1].innerHTML=In(g[0].value,g[1].value)})}),g[1].addEventListener("change",()=>{l.element.querySelectorAll(".fn__flex-wrap .emoji__dynamic-item").forEach(b=>{const w=new URLSearchParams(b.getAttribute("src").replace(i,""));w.set("weekdayType",g[1].value),b.setAttribute("src",i+w.toString())})});const f=l.element.querySelector('[data-type="tab-dynamic"] [type="date"]');f.addEventListener("change",()=>{l.element.querySelectorAll(".fn__flex-wrap .emoji__dynamic-item").forEach(b=>{const w=new URLSearchParams(b.getAttribute("src").replace(i,""));w.set("date",f.value?dayjs(f.value).format("YYYY-MM-DD"):""),b.setAttribute("src",i+w.toString())})});const p=l.element.querySelectorAll('[data-type="tab-dynamic"] [type="text"]'),m=l.element.querySelector('.emoji__dynamic-item[data-type="text"]');p[0].addEventListener("input",()=>{p[0].value.startsWith("#")&&(l.element.querySelectorAll(".emoji__dynamic-item").forEach(b=>{const w=new URLSearchParams(b.getAttribute("src").replace(i,""));w.set("color",p[0].value),b.setAttribute("src",i+w.toString())}),l.element.querySelectorAll(".color__square").forEach(b=>{b.style.backgroundColor===p[0].value?b.classList.add("color__square--current"):b.classList.remove("color__square--current")}))}),p[1].addEventListener("input",()=>{const b=new URLSearchParams(m.getAttribute("src").replace(i,""));b.set("content",p[1].value),m.setAttribute("src",i+b.toString())})},Oa=(e,t)=>{},Ct=(e,t,a="iconFile")=>{let n;n=document.querySelector(`#sidebar [data-type="sidebar-file"] [data-node-id="${t}"] .b3-list-item__icon`),n&&(n.innerHTML=Le(e||(a==="iconFile"?n.previousElementSibling.classList.contains("fn__hidden")?window.siyuan.storage[Constants.LOCAL_IMAGES].file:window.siyuan.storage[Constants.LOCAL_IMAGES].folder:window.siyuan.storage[Constants.LOCAL_IMAGES].note))),a!=="iconFile"&&setNoteBook()},At=e=>window.siyuan.config.lang==="zh_CN"?e.description_zh_cn:window.siyuan.config.lang==="ja_JP"?e.description_ja_jp:e.description,je=e=>window.siyuan.config.lang==="zh_CN"?window.siyuan.emojis[e].title_zh_cn:window.siyuan.config.lang==="ja_JP"?window.siyuan.emojis[e].title_ja_jp:window.siyuan.emojis[e].title,vi=e=>{if(window.siyuan.emojis[0].items.length>0){const t={};window.siyuan.emojis[0].items.forEach(a=>{t[a.keywords]=e.options.hint.emojiPath+"/"+a.unicode}),e.lute.PutEmojis(t)}},pr=()=>{fetchPost("/api/system/getEmojiConf",{},e=>{window.siyuan.emojis=e.data,getAllEditor().forEach(t=>{vi(t.protyle)})})},mr=(e,t)=>{if(e.includes("\u2303")){if(!t.ctrlKey)return!1}else if(isMac()?t.ctrlKey:e.includes("\u2318")?!t.ctrlKey:t.ctrlKey)return!1;if(e.includes("\u2325")){if(!t.altKey)return!1}else if(t.altKey)return!1;if(e.includes("\u21E7")){if(!t.shiftKey)return!1}else if(t.shiftKey)return!1;if(e.includes("\u2318")){if(isMac()?!t.metaKey:!t.ctrlKey)return!1}else if(isMac()?t.metaKey:e.includes("\u2303")?!t.ctrlKey:t.ctrlKey)return!1;return!0},ta=(e,t)=>{const a=e.replace(t,Constants.ZWSP).split("");return a.forEach((n,o)=>{n===Constants.ZWSP&&(a[o]=t)}),a},br=(e,t)=>{if(!e)return!1;if(e.startsWith("\u2303")&&!isMac()){if(e==="\u2303D")return!1;e=e.replace("\u2318","").replace("\u2303","\u2318").replace("\u2318\u21E7","\u21E7\u2318").replace("\u2318\u2325\u21E7","\u2325\u21E7\u2318").replace("\u2318\u2325","\u2325\u2318")}if(e.indexOf("\u21E7")===-1&&e.indexOf("\u2318")===-1&&e.indexOf("\u2325")===-1&&e.indexOf("\u2303")===-1)return!!(isNotCtrl(t)&&!t.altKey&&!t.shiftKey&&e===Constants.KEYCODELIST[t.keyCode]);let a=e.split("");if(e.indexOf("F")>-1?a.forEach((o,i)=>{o==="F"&&(a[i]="F"+a.splice(i+1,1),a[i+1]&&(a[i+1]+=a.splice(i+1,1)))}):e.indexOf("PageUp")>-1?a=ta(e,"PageUp"):e.indexOf("PageDown")>-1?a=ta(e,"PageDown"):e.indexOf("Home")>-1?a=ta(e,"Home"):e.indexOf("End")>-1&&(a=ta(e,"End")),e.startsWith("\u21E7")&&a.length===2)return!!(isNotCtrl(t)&&!t.altKey&&t.shiftKey&&a[1]===Constants.KEYCODELIST[t.keyCode]);if(e.startsWith("\u2325")){let o=a.length===3?a[2]:a[1];a.length===4&&(o=a[3]);const i=o===Constants.KEYCODELIST[t.keyCode];return!!(i&&t.altKey&&!t.shiftKey&&a.length<4&&(a.length===3?isOnlyMeta(t)&&e.startsWith("\u2325\u2318"):isNotCtrl(t))||i&&e.startsWith("\u2325\u21E7\u2318")&&a.length===4&&t.altKey&&t.shiftKey&&isOnlyMeta(t)||i&&e.startsWith("\u2325\u21E7")&&a.length===3&&t.altKey&&t.shiftKey&&isNotCtrl(t))}if(e.startsWith("\u2303")){if(!isMac())return!1;let o=a.length===3?a[2]:a[1];a.length===4?o=a[3]:a.length===5&&(o=a[4]);const i=o===Constants.KEYCODELIST[t.keyCode];return!!(i&&t.ctrlKey&&!t.altKey&&!t.shiftKey&&a.length<4&&(a.length===3?t.metaKey&&e.startsWith("\u2303\u2318"):!t.metaKey)||i&&e.startsWith("\u2303\u21E7")&&a.length===3&&t.ctrlKey&&!t.altKey&&t.shiftKey&&!t.metaKey||i&&e.startsWith("\u2303\u2325")&&a.length===3&&t.ctrlKey&&t.altKey&&!t.shiftKey&&!t.metaKey||i&&a.length===4&&t.ctrlKey&&(e.startsWith("\u2303\u2325\u21E7")&&t.shiftKey&&!t.metaKey&&t.altKey||e.startsWith("\u2303\u2325\u2318")&&!t.shiftKey&&t.metaKey&&t.altKey||e.startsWith("\u2303\u21E7\u2318")&&t.shiftKey&&t.metaKey&&!t.altKey)||i&&a.length===5&&t.ctrlKey&&t.shiftKey&&t.metaKey&&t.altKey)}const n=a.length>2&&a[0]==="\u21E7";return isOnlyMeta(t)&&!t.altKey&&(!n&&!t.shiftKey||n&&t.shiftKey)?(n?a[2]:a[1])===Constants.KEYCODELIST[t.keyCode]:!1},yr=e=>{},hr=()=>{const e=new URLSearchParams(window.location.search),t=e.get("url");let a="",n=!1;if(/^web\+siyuan:\/\/blocks\/\d{14}-\w{7}/.test(t))a=t.substring(20,20+22),n=getSearch("focus",t)==="1";else if(window.JSAndroid){const o=window.JSAndroid.getBlockURL();a=Ei(o),n=getSearch("focus",o)==="1"}else a=e.get("id"),n=e.get("focus")==="1";return{id:a,isZoomIn:n}},wr=e=>/^siyuan:\/\/blocks\/\d{14}-\w{7}/.test(e),Ei=e=>e.substring(16,16+22),_r=(e=window.location.href)=>{const t=new URL(window.location.origin);t.pathname="/check-auth",t.searchParams.set("to",e),window.location.href=t.href},vr=()=>{let e=document.getElementById("baseURL");e||(e=document.createElement("base"),e.id="baseURL"),e.setAttribute("href",location.origin),document.getElementsByTagName("head")[0].appendChild(e)},Dn=(e,t=!0,a=!1)=>{let n=e;return t&&(n=qa().basename(e)),a&&n.endsWith(".sy")&&(n=n.substr(0,n.length-3)),n},ki=e=>qa().basename(e,qa().extname(e)).replace(/-\d{14}-\w{7}/,""),Er=e=>!e||(e=e.trim(),1>e.length)?!1:(e=e.toLowerCase(),e.startsWith("assets/")||e.startsWith("file://")||e.startsWith("\\\\")?!0:isWindows()?e.indexOf(":")===1:e.startsWith("/")),qa=()=>Na.posix?Na.posix:Na,kr=()=>path,Cr=e=>{const t=[];return e.forEach(a=>{if(a.getAttribute("data-type")!=="navigation-root"){const n=a.getAttribute("data-path");t.find(i=>{if(n.startsWith(i.replace(".sy","")))return!0})||t.push(n)}}),t},Ar=(e,t,a)=>{fetchPost("/api/filetree/moveDocs",{toNotebook:t,fromPaths:e,toPath:a})},Lr=(e,t,a,n,o=!1)=>{if(window.siyuan.dialogs.find(f=>{if(f.element.querySelector("#foldList"))return f.destroy(),!0}))return;const s=new Dialog({title:`<div style="padding: 8px;">
    ${n||window.siyuan.languages.move}
    <div style="max-height: 16px;overflow: auto;line-height: 14px;-webkit-mask-image: linear-gradient(to top, rgba(0, 0, 0, 0) 0, #000 6px);padding-bottom: 4px;margin-bottom: -4px" class="ft__smaller ft__on-surface fn__hidescrollbar"></div>
</div>`,content:`<div class="b3-form__icon" style="margin: 8px">
    <span data-menu="true" class="b3-form__icon-list fn__a b3-tooltips b3-tooltips__s" aria-label="${updateHotkeyTip("\u2325\u2193")}">
        <svg class="svg--mid"><use xlink:href="#iconSearch"></use></svg>
        <svg class="svg--smaller"><use xlink:href="#iconDown"></use></svg>
    </span>
    <input class="b3-text-field fn__block" style="padding-left: 42px;" value="" placeholder="${window.siyuan.languages.search}">
</div>
<ul id="foldList" class="fn__flex-1 fn__none b3-list b3-list--background${isMobile()?" b3-list--mobile":""}" style="overflow: auto;position: relative"></ul>
<div id="foldTree" class="fn__flex-1${isMobile()?" b3-list--mobile":""}" style="overflow: auto;position: relative"></div>
<div class="fn__hr"></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"50vw",height:isMobile()?"80vh":"70vh",destroyCallback(){a&&focusByRange(a)}});s.element.querySelector(".b3-dialog__header").setAttribute("style","padding:0"),s.element.setAttribute("data-key",Constants.DIALOG_MOVEPATHTO),t&&t.length>0&&fetchPost("/api/filetree/getHPathsByPaths",{paths:t},f=>{s.element.querySelector(".b3-dialog__header .ft__smaller").innerHTML=escapeHtml(f.data.join(" "))});const l=s.element.querySelector("#foldList"),r=s.element.querySelector("#foldTree");Ci(f=>{let p="";f.forEach(m=>{if(!m.closed){let b="";o&&(b=`<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardNewCard}">${m.newFlashcardCount}</span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardDueCard}">${m.dueFlashcardCount}</span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardCard}">${m.flashcardCount}</span>`),p+=`<ul class="b3-list b3-list--background">
<li class="b3-list-item${p===""?" b3-list-item--focus":""}" data-path="/" data-box="${m.id}">
    <span class="b3-list-item__toggle b3-list-item__toggle--hl">
        <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
    </span>
    ${unicode2Emoji(m.icon||window.siyuan.storage[Constants.LOCAL_IMAGES].note,"b3-list-item__graphic",!0)}
    <span class="b3-list-item__text">${escapeHtml(m.name)}</span>
    ${b}
</li></ul>`}}),r.innerHTML=p},o);const c=s.element.querySelector(".b3-text-field");c.value=window.siyuan.storage[Constants.LOCAL_MOVE_PATH].k;const d=f=>{if(!(f&&f.isComposing)){if(c.value.trim()===""){l.classList.add("fn__none"),r.classList.remove("fn__none");return}r.classList.add("fn__none"),l.classList.remove("fn__none"),l.scrollTo(0,0),fetchPost("/api/filetree/searchDocs",{k:c.value,flashcard:o},p=>{let m="";p.data.forEach(b=>{let w="";o&&(w=`<span class="fn__flex-1"></span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardNewCard}">${b.newFlashcardCount}</span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardDueCard}">${b.dueFlashcardCount}</span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardCard}">${b.flashcardCount}</span>`),m+=`<li class="b3-list-item${m===""?" b3-list-item--focus":""}" data-path="${b.path}" data-box="${b.box}">
    ${unicode2Emoji(b.boxIcon||window.siyuan.storage[Constants.LOCAL_IMAGES].note,"b3-list-item__graphic",!0)}
    <span class="b3-list-item__showall" style="padding: 4px 0">${escapeHtml(b.hPath)}</span>
    ${w}
</li>`}),l.innerHTML=m})}},u=()=>{const f=window.siyuan.storage[Constants.LOCAL_MOVE_PATH].keys;if(!f||f.length===0||f.length===1&&f[0]===c.value)return;const p=new Menu("move-path-history");if(p.isOpen)return;p.element.classList.add("b3-menu--list"),p.addItem({iconHTML:"",label:window.siyuan.languages.clearHistory,click(){window.siyuan.storage[Constants.LOCAL_MOVE_PATH].keys=[],setStorageVal(Constants.LOCAL_MOVE_PATH,window.siyuan.storage[Constants.LOCAL_MOVE_PATH])}});const m=p.addSeparator(1);let b=!0;f.forEach(y=>{if(y!==c.value&&y){const _=p.addItem({iconHTML:"",label:escapeHtml(y),action:"iconCloseRound",bind(h){h.addEventListener("click",E=>{var C;hasClosestByClassName(E.target,"b3-menu__action")?(f.find((k,v)=>{if(k===y)return f.splice(v,1),!0}),window.siyuan.storage[Constants.LOCAL_MOVE_PATH].keys=f,setStorageVal(Constants.LOCAL_MOVE_PATH,window.siyuan.storage[Constants.LOCAL_MOVE_PATH]),(C=h.previousElementSibling)!=null&&C.classList.contains("b3-menu__separator")&&!h.nextElementSibling?window.siyuan.menus.menu.remove():h.remove()):(c.value=h.textContent,d(),window.siyuan.menus.menu.remove()),E.preventDefault(),E.stopPropagation()})}});b&&_.classList.add("b3-menu__item--current"),b=!1}}),b&&m.remove();const w=c.getBoundingClientRect();p.open({x:w.left,y:w.bottom})};d(),c.addEventListener("compositionend",f=>{d(f)}),c.addEventListener("input",f=>{d(f)}),c.addEventListener("blur",()=>{if(!c.value)return;let f=window.siyuan.storage[Constants.LOCAL_MOVE_PATH].keys;f.splice(0,0,c.value),f=Array.from(new Set(f)),f.length>window.siyuan.config.search.limit&&f.splice(window.siyuan.config.search.limit,f.length-window.siyuan.config.search.limit),window.siyuan.storage[Constants.LOCAL_MOVE_PATH].k=c.value,window.siyuan.storage[Constants.LOCAL_MOVE_PATH].keys=f,setStorageVal(Constants.LOCAL_MOVE_PATH,window.siyuan.storage[Constants.LOCAL_MOVE_PATH])});const g=28;c.addEventListener("keydown",f=>{if(f.isComposing)return;if(matchHotKey("\u2325\u2193",f)){f.stopPropagation(),u();return}if(window.siyuan.menus.menu.element.getAttribute("data-name")==="move-path-history")return;const p=l.classList.contains("fn__none")?r:l,m=p.querySelectorAll(".b3-list-item--focus");if(m.length===0)return;let b=m[0];if(f.key.startsWith("Arrow")&&m.forEach((w,y)=>{y!==0&&w.classList.remove("b3-list-item--focus")}),l.classList.contains("fn__none")){if(f.key==="ArrowRight"&&!b.querySelector(".b3-list-item__arrow--open")&&!b.querySelector(".b3-list-item__toggle").classList.contains("fn__hidden")||f.key==="ArrowLeft"&&b.querySelector(".b3-list-item__arrow--open")){Ua(b,o),f.preventDefault();return}if(f.key==="ArrowLeft"){let w=b.parentElement.previousElementSibling;if(w){w.tagName!=="LI"&&(w=p.querySelector(".b3-list-item")),b.classList.remove("b3-list-item--focus"),w.classList.add("b3-list-item--focus");const y=w.getBoundingClientRect(),_=p.getBoundingClientRect();(y.top<_.top||y.bottom>_.bottom)&&w.scrollIntoView(y.top<_.top)}return f.preventDefault(),!0}if(f.key==="ArrowDown"||f.key==="ArrowRight"){let w=b;for(;w;)if(w.nextElementSibling)if(w.nextElementSibling.classList.contains("fn__none"))w=w.nextElementSibling;else{w.nextElementSibling.tagName==="UL"?w=w.nextElementSibling.firstElementChild:w=w.nextElementSibling;break}else{if(w.parentElement.id==="foldTree")break;w=w.parentElement}if(w.classList.contains("b3-list-item")){b.classList.remove("b3-list-item--focus"),w.classList.add("b3-list-item--focus");const y=w.getBoundingClientRect(),_=r.getBoundingClientRect();(y.top<_.top||y.bottom>_.bottom)&&w.scrollIntoView(y.top<_.top)}return f.preventDefault(),!0}if(f.key==="ArrowUp"){let w=b;for(;w;)if(w.previousElementSibling)if(w.previousElementSibling.classList.contains("fn__none"))w=w.previousElementSibling;else{if(w.previousElementSibling.tagName==="LI")w=w.previousElementSibling;else{const y=w.previousElementSibling.querySelectorAll(".b3-list-item");w=y[y.length-1]}break}else{if(w.parentElement.id==="foldTree")break;w=w.parentElement}if(w.classList.contains("b3-list-item")){b.classList.remove("b3-list-item--focus"),w.classList.add("b3-list-item--focus");const y=w.getBoundingClientRect(),_=r.getBoundingClientRect();(y.top<_.top||y.bottom>_.bottom)&&w.scrollIntoView(y.top<_.top)}f.preventDefault()}}else{if(f.key==="ArrowDown"){b.classList.remove("b3-list-item--focus"),b.nextElementSibling?b.nextElementSibling.classList.add("b3-list-item--focus"):p.children[0].classList.add("b3-list-item--focus"),b=p.querySelector(".b3-list-item--focus"),(p.scrollTop<b.offsetTop-p.clientHeight+g||p.scrollTop>b.offsetTop)&&(p.scrollTop=b.offsetTop-p.clientHeight+g),f.preventDefault();return}if(f.key==="ArrowUp"){if(b.classList.remove("b3-list-item--focus"),b.previousElementSibling)b.previousElementSibling.classList.add("b3-list-item--focus");else{const w=p.children.length;p.children[w-1].classList.add("b3-list-item--focus")}b=p.querySelector(".b3-list-item--focus"),(p.scrollTop<b.offsetTop-p.clientHeight+g||p.scrollTop>b.offsetTop-g*2)&&(p.scrollTop=b.offsetTop-g*2),f.preventDefault();return}}if(f.key==="Enter"){const w=p.querySelectorAll(".b3-list-item--focus");if(w.length===0)return;const y=[],_=[];w.forEach(h=>{y.push(h.getAttribute("data-path")),_.push(h.getAttribute("data-box"))}),e(y,_),s.destroy(),f.preventDefault()}}),s.element.addEventListener("click",f=>{let p=f.target;for(;p&&!p.isEqualNode(s.element);){if(p.classList.contains("b3-list-item__toggle")){Ua(p.parentElement,o),f.preventDefault(),f.stopPropagation();break}else if(p.classList.contains("b3-form__icon-list")){u(),f.preventDefault(),f.stopPropagation();break}else if(p.classList.contains("b3-button--text")){const b=(l.classList.contains("fn__none")?r:l).querySelectorAll(".b3-list-item--focus");if(b.length===0)return;const w=[],y=[];b.forEach(_=>{w.push(_.getAttribute("data-path")),y.push(_.getAttribute("data-box"))}),e(w,y),s.destroy(),f.preventDefault(),f.stopPropagation();break}else if(p.classList.contains("b3-button--cancel")){s.destroy(),f.preventDefault(),f.stopPropagation();break}else if(p.classList.contains("b3-list-item")){const b=(l.classList.contains("fn__none")?r:l).querySelectorAll(".b3-list-item--focus");if(b.length===0)return;n===window.siyuan.languages.specifyPath&&isOnlyMeta(f)?b.length===1&&b[0].isSameNode(p)||p.classList.toggle("b3-list-item--focus"):(b[0].classList.remove("b3-list-item--focus"),p.classList.add("b3-list-item--focus")),p.getAttribute("data-path")==="/"&&Ua(p,o),f.preventDefault(),f.stopPropagation();break}p=p.parentElement}})},Ua=(e,t)=>{const a=e.querySelector(".b3-list-item__arrow");if(a.classList.contains("b3-list-item__arrow--open")){a.classList.remove("b3-list-item__arrow--open"),e.nextElementSibling&&e.nextElementSibling.tagName==="UL"&&e.nextElementSibling.classList.add("fn__none");return}if(e.nextElementSibling&&e.nextElementSibling.tagName==="UL"){a.classList.add("b3-list-item__arrow--open"),e.nextElementSibling.classList.remove("fn__none");return}const n=e.getAttribute("data-box");fetchPost("/api/filetree/listDocsByPath",{notebook:n,path:e.getAttribute("data-path"),flashcard:t},o=>{if(o.data.files.length===0){showMessage(window.siyuan.languages.emptyContent);return}let i="";if(o.data.files.forEach(l=>{let r="";t?r=`<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardNewCard}">${l.newFlashcardCount}</span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardDueCard}">${l.dueFlashcardCount}</span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardCard}">${l.flashcardCount}</span>`:l.count&&l.count>0&&(r=`<span class="popover__block counter b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.ref}">${l.count}</span>`),i+=`<li data-box="${n}" class="b3-list-item" data-path="${l.path}">
    <span style="padding-left: ${l.path.split("/").length*8}px" class="b3-list-item__toggle b3-list-item__toggle--hl${l.subFileCount===0?" fn__hidden":""}">
        <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
    </span>
    ${unicode2Emoji(l.icon||(l.subFileCount===0?window.siyuan.storage[Constants.LOCAL_IMAGES].file:window.siyuan.storage[Constants.LOCAL_IMAGES].folder),"b3-list-item__graphic",!0)}
    <span class="b3-list-item__text ariaLabel" data-position="parentE" aria-label="${Dn(l.name,!0,!0)} <small class='ft__on-surface'>${l.hSize}</small>${l.bookmark?"<br>"+window.siyuan.languages.bookmark+" "+l.bookmark:""}${l.name1?"<br>"+window.siyuan.languages.name+" "+l.name1:""}${l.alias?"<br>"+window.siyuan.languages.alias+" "+l.alias:""}${l.memo?"<br>"+window.siyuan.languages.memo+" "+l.memo:""}${l.subFileCount!==0?window.siyuan.languages.includeSubFile.replace("x",l.subFileCount):""}<br>${window.siyuan.languages.modifiedAt} ${l.hMtime}<br>${window.siyuan.languages.createdAt} ${l.hCtime}">${Dn(l.name,!0,!0)}</span>
    ${r}
</li>`}),i==="")return;a.classList.add("b3-list-item__arrow--open"),e.insertAdjacentHTML("afterend",`<ul class="file-tree__sliderDown">${i}</ul>`);const s=e.nextElementSibling;setTimeout(()=>{s.setAttribute("style",`height:${s.childElementCount*e.clientHeight}px;`),setTimeout(()=>{s.classList.remove("file-tree__sliderDown"),s.removeAttribute("style")},120)},2)})},Sr=e=>{let t="";return window.siyuan.notebooks.find(a=>{if(a.id===e)return t=a.name,!0}),t},xr=e=>{let t="";return window.siyuan.notebooks.find(a=>{if(a.id===e)return t=a.icon,!0}),t},Tr=(e,t)=>{window.siyuan.notebooks.find(a=>{if(a.id===e)return a.name=t,!0})},Ir=()=>{let e=0;return window.siyuan.notebooks.forEach(t=>{t.closed||e++}),e},Ci=(e,t=!1)=>{fetchPost("/api/notebook/lsNotebooks",{flashcard:t},a=>{t||(window.siyuan.notebooks=a.data.notebooks),e&&e(a.data.notebooks)})},Mr=e=>{const t=new Dialog({title:window.siyuan.languages.rename,content:`<div class="b3-dialog__content"><input class="b3-text-field fn__block" value="${e}"></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px"});t.element.setAttribute("data-key",Constants.DIALOG_RENAMETAG);const a=t.element.querySelectorAll(".b3-button");a[0].addEventListener("click",()=>{t.destroy()});const n=t.element.querySelector("input");t.bindInput(n,()=>{a[1].click()}),n.focus(),n.select(),a[1].addEventListener("click",()=>{fetchPost("/api/tag/renameTag",{oldLabel:e,newLabel:n.value})})},Dr=()=>pathPosix().basename(window.siyuan.config.system.workspaceDir.replace(/\\/g,"/")),$r=(e,t)=>{e&&fetchPost("/api/block/checkBlockFold",{id:e},a=>{t(a.data.isFolded,a.data.isFolded?[Constants.CB_GET_FOCUS,Constants.CB_GET_ALL]:[Constants.CB_GET_FOCUS,Constants.CB_GET_CONTEXT,Constants.CB_GET_ROOTSCROLL],a.data.isRoot)})},Hr=()=>{const e=new Dialog({title:window.siyuan.languages.about5,content:`<div class="b3-dialog__content">
    <input class="b3-text-field fn__block" placeholder="${window.siyuan.languages.about5}" value="${window.siyuan.config.accessAuthCode}">
    <div class="b3-label__text">${window.siyuan.languages.about6}</div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px"}),t=e.element.querySelector("input"),a=e.element.querySelectorAll(".b3-button");e.element.setAttribute("data-key",Constants.DIALOG_ACCESSAUTHCODE),e.bindInput(t,()=>{a[1].click()}),t.select(),a[0].addEventListener("click",()=>{e.destroy()}),a[1].addEventListener("click",()=>{fetchPost("/api/system/setAccessAuthCode",{accessAuthCode:t.value})})},Ai=e=>`${window.siyuan.config.cloudRegion===0?"https://ld246.com":"https://liuyun.io"}/${e}`,Nr=e=>`https://b3log.org/siyuan${window.siyuan.config.lang==="zh_CN"?"":"/en"}/${e}`,Li=(e=window.siyuan.languages._kernel[29])=>window.siyuan.user&&(window.siyuan.user.userSiYuanProExpireTime===-1||window.siyuan.user.userSiYuanProExpireTime>0)?!1:(e&&(e===window.siyuan.languages._kernel[29]&&window.siyuan.config.system.container==="ios"?tt(window.siyuan.languages._kernel[122]):(e===window.siyuan.languages._kernel[29]&&(e=window.siyuan.languages._kernel[29].replace("${url}",Ai("subscribe/siyuan"))),tt(e))),!0),Si=()=>window.siyuan.user&&(window.siyuan.user.userSiYuanSubscriptionStatus===0||window.siyuan.user.userSiYuanOneTimePayStatus===1),$n="%%params",xi=e=>{let t={responsive:"resize"};const a=e.substring(0,e.indexOf(`
`));if(a.startsWith($n))try{t=Pe(a.substring($n.length))}catch(n){console.error(`Failed to parse ABCJS params: ${n}`)}return t},Fa=(e,t=S.PROTYLE_CDN)=>{let a=[];e.getAttribute("data-subtype")==="abc"?a=[e]:a=Array.from(e.querySelectorAll('[data-subtype="abc"]')),a.length!==0&&a.length>0&&re(`${t}/js/abcjs/abcjs-basic-min.js?v=6.2.2`,"protyleAbcjsScript").then(()=>{const n=J(e,"protyle-wysiwyg",!0);a.forEach(o=>{if(o.getAttribute("data-render")==="true")return;o.firstElementChild.classList.contains("protyle-icons")||o.insertAdjacentHTML("afterbegin",X(n));const i=o.firstElementChild.nextElementSibling;i.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${S.ZWSP}</span><div contenteditable="false"></div>`;const s=Lute.UnEscapeHTMLStr(o.getAttribute("data-content"));window.ABCJS.renderAbc(i.lastElementChild,s,xi(s)),o.setAttribute("data-render","true")})})};var Ti=(e,t,a)=>new Promise((n,o)=>{var i=r=>{try{l(a.next(r))}catch(c){o(c)}},s=r=>{try{l(a.throw(r))}catch(c){o(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(i,s);l((a=a.apply(e,t)).next())});const Ya=(e,t=S.PROTYLE_CDN)=>{let a=[];e.getAttribute("data-subtype")==="echarts"?a=[e]:a=Array.from(e.querySelectorAll('[data-subtype="echarts"]')),a.length!==0&&a.length>0&&re(`${t}/js/echarts/echarts.min.js?v=5.3.2`,"protyleEchartsScript").then(()=>{re(`${t}/js/echarts/echarts-gl.min.js?v=2.0.9`,"protyleEchartsGLScript").then(()=>{const n=J(e,"protyle-wysiwyg",!0);let o;n&&n.clientWidth>0&&a[0].firstElementChild.clientWidth===0&&n.firstElementChild&&(o=n.firstElementChild.clientWidth),a.forEach(i=>Ti(void 0,null,function*(){if(i.getAttribute("data-render")==="true")return;i.firstElementChild.classList.contains("protyle-icons")||i.insertAdjacentHTML("afterbegin",X(n));const s=i.firstElementChild.nextElementSibling;try{s.style.height=i.style.height;const l=yield Pe(Lute.UnEscapeHTMLStr(i.getAttribute("data-content")));window.echarts.init(s,window.siyuan.config.appearance.mode===1?"dark":void 0,{width:o}).setOption(l),i.setAttribute("data-render","true"),s.classList.remove("ft__error"),s.textContent.endsWith(S.ZWSP)||s.firstElementChild.insertAdjacentText("beforeend",S.ZWSP)}catch(l){window.echarts.dispose(s),s.classList.add("ft__error"),s.innerHTML=`echarts render error: <br>${l}`}}))})})},Wa=(e,t=S.PROTYLE_CDN,a=!1)=>{let n=[];e.getAttribute("data-subtype")==="math"?n=[e]:n=Array.from(e.querySelectorAll('[data-subtype="math"]')),n.length!==0&&(Ia(`${t}/js/katex/katex.min.css?v=0.16.9`,"protyleKatexStyle"),re(`${t}/js/katex/katex.min.js?v=0.16.9`,"protyleKatexScript").then(()=>{re(`${t}/js/katex/mhchem.min.js?v=0.16.9`,"protyleKatexMhchemScript").then(()=>{n.forEach(o=>{var i,s;if(o.getAttribute("data-render")==="true")return;o.setAttribute("data-render","true");let l=o;o.tagName==="DIV"&&(l=o.firstElementChild);let r={};try{r=Pe(window.siyuan.config.editor.katexMacros||"{}")}catch(c){console.warn("KaTex macros is not JSON",c)}try{l.innerHTML=window.katex.renderToString(Lute.UnEscapeHTMLStr(o.getAttribute("data-content")),{displayMode:o.tagName==="DIV",output:"html",macros:r,trust:!0,strict:d=>d==="unicodeTextInMathMode"?"ignore":"warn"}),l.classList.remove("ft__error");const c=oe(o);if(o.tagName==="DIV"){l.firstElementChild.setAttribute("contenteditable","false"),l.childElementCount<2&&l.insertAdjacentHTML("beforeend",`<span style="position: absolute;right: 0;top: 0;">${S.ZWSP}</span>`);const d=l.querySelectorAll(".base");d.length>0&&d[d.length-1].insertAdjacentHTML("afterend","<span class='fn__flex-1'></span>");const u=l.querySelector(".katex-html > .newline");u&&(u.parentElement.style.display="block")}else{c&&o.getBoundingClientRect().width>c.clientWidth?(o.style.maxWidth="100%",o.style.overflowX="auto",o.style.overflowY="hidden",o.style.display="inline-block"):(o.style.maxWidth="",o.style.overflowX="",o.style.overflowY="",o.style.display="");const d=La(o);d?d&&d.nodeType!==3&&(((i=d.getAttribute("data-type"))==null?void 0:i.indexOf("inline-math"))>-1||d.classList.contains("img"))?o.after(document.createTextNode(S.ZWSP)):d&&!d.textContent.startsWith(`
`)&&d.textContent!==S.ZWSP&&o.insertAdjacentHTML("beforeend","&#xFEFF;"):o.parentElement.tagName!=="TH"&&o.parentElement.tagName!=="TD"?o.insertAdjacentText("afterend",`
`):o.insertAdjacentText("afterend",S.ZWSP),(s=o.previousSibling)!=null&&s.textContent.endsWith(`
`)?o.insertAdjacentText("beforebegin",S.ZWSP):!Ht(o)&&["TH","TD"].includes(o.parentElement.tagName)&&o.insertAdjacentText("afterbegin",S.ZWSP)}a&&setTimeout(()=>{if(o.tagName==="DIV"){const d=o.querySelector(".katex-display");d.clientWidth<d.scrollWidth&&d.firstElementChild.setAttribute("style",`font-size:${d.clientWidth*100/d.scrollWidth}%`)}else c&&o.offsetWidth>c.clientWidth&&o.firstElementChild.setAttribute("style",`font-size:${c.clientWidth*100/o.offsetWidth}%`)})}catch(c){l.innerHTML=c.message,l.classList.add("ft__error")}})})}))};var Ii=(e,t,a)=>new Promise((n,o)=>{var i=r=>{try{l(a.next(r))}catch(c){o(c)}},s=r=>{try{l(a.throw(r))}catch(c){o(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(i,s);l((a=a.apply(e,t)).next())});const ja=(e,t=S.PROTYLE_CDN)=>{let a=[];e.getAttribute("data-subtype")==="mermaid"?a=[e]:a=Array.from(e.querySelectorAll('[data-subtype="mermaid"]')),a.length!==0&&re(`${t}/js/mermaid/mermaid.min.js?v=11.4.0`,"protyleMermaidScript").then(()=>{const n={securityLevel:"loose",altFontFamily:"sans-serif",fontFamily:"sans-serif",startOnLoad:!1,flowchart:{htmlLabels:!0,useMaxWidth:!0},sequence:{useMaxWidth:!0,diagramMarginX:8,diagramMarginY:8,boxMargin:8,showSequenceNumbers:!0},gantt:{leftPadding:75,rightPadding:20}};if(window.siyuan.config.appearance.mode===1&&(n.theme="dark"),window.mermaid.initialize(n),a[0].firstElementChild.clientWidth===0){const o=new MutationObserver(()=>{Hn(a),o.disconnect()}),i=j(a[0],"fold","1");if(i)o.observe(i,{attributeFilter:["fold"]});else{const s=J(a[0],"card__block",!0);s&&o.observe(s,{attributeFilter:["class"]})}}else Hn(a)})},Hn=e=>{const t=J(e[0],"protyle-wysiwyg",!0);e.forEach(a=>Ii(void 0,null,function*(){if(a.getAttribute("data-render")==="true")return;a.firstElementChild.classList.contains("protyle-icons")||a.insertAdjacentHTML("afterbegin",X(t));const n=a.firstElementChild.nextElementSibling,o="mermaid"+Lute.NewNodeID();n.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${S.ZWSP}</span><div contenteditable="false"><span id="${o}"></span></div>`;try{const i=yield window.mermaid.render(o,Lute.UnEscapeHTMLStr(a.getAttribute("data-content")));n.lastElementChild.innerHTML=i.svg}catch(i){const s=document.querySelector("#"+o);n.lastElementChild.innerHTML=`${s.outerHTML}<div class="fn__hr"></div><div class="ft__error">${i.message.replace(/\n/,"<br>")}</div>`,s.parentElement.remove()}a.setAttribute("data-render","true")}))},Va=(e,t=S.PROTYLE_CDN)=>{let a=[];e.getAttribute("data-subtype")==="mindmap"?a=[e]:a=Array.from(e.querySelectorAll('[data-subtype="mindmap"]')),a.length!==0&&re(`${t}/js/echarts/echarts.min.js?v=0.0.0`,"protyleEchartsScript").then(()=>{const n=J(e,"protyle-wysiwyg",!0);let o;n&&n.clientWidth>0&&a[0].firstElementChild.clientWidth===0&&n.firstElementChild&&(o=n.firstElementChild.clientWidth),a.forEach(i=>{if(i.getAttribute("data-render")==="true")return;i.firstElementChild.classList.contains("protyle-icons")||i.insertAdjacentHTML("afterbegin",X(n));const s=i.firstElementChild.nextElementSibling;try{s.style.height=i.style.height,window.echarts.init(s,window.siyuan.config.appearance.mode===1?"dark":void 0,{width:o}).setOption({series:[{data:[JSON.parse(Lute.EChartsMindmapStr(Lute.UnEscapeHTMLStr(i.getAttribute("data-content"))))],initialTreeDepth:-1,itemStyle:{borderWidth:0,color:"#4285f4"},label:{backgroundColor:"#f6f8fa",borderColor:"#d1d5da",borderRadius:6,borderWidth:.5,color:"#586069",lineHeight:20,offset:[-5,0],padding:[0,5],position:"insideRight"},lineStyle:{color:"#d1d5da",width:1},roam:!0,symbol:(l,r)=>{var c;return(c=r==null?void 0:r.data)!=null&&c.children?"circle":"path://"},type:"tree"}],tooltip:{trigger:"item",triggerOn:"mousemove"},backgroundColor:"transparent"}),i.setAttribute("data-render","true"),s.textContent.endsWith(S.ZWSP)||s.firstElementChild.insertAdjacentText("beforeend",S.ZWSP),s.classList.remove("ft__error")}catch(l){s.classList.add("ft__error"),s.innerHTML=`Mindmap render error: <br>${l}`}})})},Ga=(e,t=S.PROTYLE_CDN)=>{let a=[];e.getAttribute("data-subtype")==="flowchart"?a=[e]:a=Array.from(e.querySelectorAll('[data-subtype="flowchart"]')),a.length!==0&&re(`${t}/js/flowchart.js/flowchart.min.js?v=1.18.0`,"protyleFlowchartScript").then(()=>{if(a[0].firstElementChild.clientWidth===0){const n=new MutationObserver(()=>{Nn(a),n.disconnect()}),o=j(a[0],"fold","1");if(o)n.observe(o,{attributeFilter:["fold"]});else{const i=J(a[0],"card__block",!0);i&&n.observe(i,{attributeFilter:["class"]})}}else Nn(a)})},Nn=e=>{const t=J(e[0],"protyle-wysiwyg",!0);e.forEach(a=>{if(a.getAttribute("data-render")==="true")return;a.firstElementChild.classList.contains("protyle-icons")||a.insertAdjacentHTML("afterbegin",X(t));const n=a.firstElementChild.nextElementSibling;n.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${S.ZWSP}</span><div class="ft__error" contenteditable="false"></div>`;try{flowchart.parse(Lute.UnEscapeHTMLStr(a.getAttribute("data-content"))).drawSVG(n.lastElementChild)}catch(o){n.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${S.ZWSP}</span><div class="ft__error" contenteditable="false">Flow Chart render error: <br>${o}</div>`}a.setAttribute("data-render","true")})},Ka=(e,t=S.PROTYLE_CDN)=>{let a=[];e.getAttribute("data-subtype")==="plantuml"?a=[e]:a=Array.from(e.querySelectorAll('[data-subtype="plantuml"]')),a.length!==0&&re(`${t}/js/plantuml/plantuml-encoder.min.js?v=0.0.0`,"protylePlantumlScript").then(()=>{const n=J(e,"protyle-wysiwyg",!0);a.forEach(o=>{if(o.getAttribute("data-render")==="true")return;o.firstElementChild.classList.contains("protyle-icons")||o.insertAdjacentHTML("afterbegin",X(n));const i=o.firstElementChild.nextElementSibling;try{i.innerHTML=`<object type="image/svg+xml" data="${window.siyuan.config.editor.plantUMLServePath}${window.plantumlEncoder.encode(Lute.UnEscapeHTMLStr(o.getAttribute("data-content")))}"/>`,i.classList.remove("ft__error"),o.setAttribute("data-render","true")}catch(s){i.classList.add("ft__error"),i.innerHTML=`plantuml render error: <br>${s}`}})})},za=e=>{let t=[];e.getAttribute("data-type")==="NodeHTMLBlock"?t=[e]:t=Array.from(e.querySelectorAll('[data-type="NodeHTMLBlock"]')),t.length!==0&&t.length>0&&t.forEach(a=>{a.firstElementChild.firstElementChild.setAttribute("aria-label",window.siyuan.languages.edit),a.firstElementChild.lastElementChild.setAttribute("aria-label",window.siyuan.languages.more)})},Br=(e,t)=>{const a=document.createElement("div");a.innerHTML=e;let n=!1;if((a.childElementCount===1&&a.lastElementChild.style.fontFamily.indexOf("monospace")>-1||a.childElementCount===1&&a.querySelectorAll("pre").length===1||e.indexOf(`
<p class="p1">`)===0||a.childElementCount===1&&a.firstElementChild.tagName==="TABLE"&&a.querySelector(".line-number")&&a.querySelector(".line-content"))&&(n=!0),n){let o=t||e;return/\n/.test(o)?`<div data-type="NodeCodeBlock" class="code-block" data-node-id="${Lute.NewNodeID()}"><div class="protyle-action"><span class="protyle-action--first protyle-action__language" contenteditable="false">${window.siyuan.storage[Constants.LOCAL_CODELANG]}</span><span class="fn__flex-1"></span><span aria-label="${window.siyuan.languages.copy}" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-icon--first protyle-action__copy"><svg><use xlink:href="#iconCopy"></use></svg></span><span aria-label="${window.siyuan.languages.more}" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-icon--last protyle-action__menu"><svg><use xlink:href="#iconMore"></use></svg></span></div><div contenteditable="true" spellcheck="${window.siyuan.config.editor.spellcheck}">${o.replace(/&/g,"&amp;").replace(/</g,"&lt;")}<wbr></div><div class="protyle-attr" contenteditable="false">${Constants.ZWSP}</div></div>`:(o=o.replace("<","&lt;").replace(">","&gt;"),"`"+o+"`")}return!1},Lt=e=>{const t=e.getAttribute("data-subtype");if(!S.SIYUAN_RENDER_CODE_LANGUAGES.includes(t)||e.getAttribute("data-type")!=="NodeHTMLBlock"){Fa(e),za(e),Ka(e),ja(e),Ga(e),Ya(e),Va(e),ye(e),Wa(e);return}t==="abc"?Fa(e):t==="plantuml"?Ka(e):t==="mermaid"?ja(e):t==="flowchart"?Ga(e):t==="echarts"?Ya(e):t==="mindmap"?Va(e):t==="graphviz"?ye(e):t==="math"?Wa(e):e.getAttribute("data-type")==="NodeHTMLBlock"&&za(e)},Bn=(e,t)=>{let a="";switch(e){case"NodeDocument":a="iconFile";break;case"NodeThematicBreak":a="iconLine";break;case"NodeParagraph":a="iconParagraph";break;case"NodeHeading":t?a="icon"+t.toUpperCase():a="iconHeadings";break;case"NodeBlockquote":a="iconQuote";break;case"NodeList":t==="t"?a="iconCheck":t==="o"?a="iconOrderedList":a="iconList";break;case"NodeListItem":a="iconListItem";break;case"NodeCodeBlock":case"NodeYamlFrontMatter":a="iconCode";break;case"NodeTable":a="iconTable";break;case"NodeBlockQueryEmbed":a="iconSQL";break;case"NodeSuperBlock":a="iconSuper";break;case"NodeMathBlock":a="iconMath";break;case"NodeHTMLBlock":a="iconHTML5";break;case"NodeWidget":a="iconBoth";break;case"NodeIFrame":a="iconLanguage";break;case"NodeVideo":a="iconVideo";break;case"NodeAudio":a="iconRecord";break;case"NodeAttributeView":a="iconDatabase";break}return a},St=(e,t,a=!1)=>{if(!t){if(e.includes("dialog"))for(let n=0;n<window.siyuan.dialogs.length;n++)window.siyuan.dialogs[n].destroy(),n--;return}if(e.includes("hint")&&(clearTimeout(t.hint.timeId),t.hint.element.classList.add("fn__none")),t.gutter&&e.includes("gutter")&&(t.gutter.element.classList.add("fn__none"),t.gutter.element.innerHTML="",t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl").forEach(n=>{n.classList.remove("protyle-wysiwyg--hl")})),t.gutter&&e.includes("gutterOnly")&&(t.gutter.element.classList.add("fn__none"),t.gutter.element.innerHTML=""),t.toolbar&&e.includes("toolbar")&&(t.toolbar.element.classList.add("fn__none"),t.toolbar.element.style.display=""),t.toolbar&&e.includes("util")){const n=t.toolbar.subElement.querySelector('[data-type="pin"]');(a||!n||n&&n.getAttribute("aria-label")===window.siyuan.languages.pin)&&(t.toolbar.subElement.classList.add("fn__none"),t.toolbar.subElementCloseCB&&(t.toolbar.subElementCloseCB(),t.toolbar.subElementCloseCB=void 0))}e.includes("select")&&t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").forEach(n=>{n.classList.remove("protyle-wysiwyg--select"),n.removeAttribute("select-start"),n.removeAttribute("select-end")})},Pr=e=>{e.includes("toolbar")&&document.querySelectorAll(".protyle-toolbar").forEach(t=>{t.classList.add("fn__none"),t.style.display=""}),e.includes("util")&&getAllEditor().forEach(t=>{t.protyle.toolbar&&(t.protyle.toolbar.subElement.classList.add("fn__none"),t.protyle.toolbar.subElementCloseCB&&(t.protyle.toolbar.subElementCloseCB(),t.protyle.toolbar.subElementCloseCB=void 0))}),e.includes("pdfutil")&&document.querySelectorAll(".pdf__util").forEach(t=>{t.classList.add("fn__none")}),e.includes("gutter")&&document.querySelectorAll(".protyle-gutters").forEach(t=>{t.classList.add("fn__none"),t.innerHTML=""})},aa=e=>{e.classList.add("protyle-wysiwyg--hl"),setTimeout(function(){e.classList.remove("protyle-wysiwyg--hl")},1024)},Rr=(e,t,a=!1)=>{let n;const o=e.wysiwyg.element;if(!e.preview.element.classList.contains("fn__none")){n=document.getElementById(t),n&&(e.preview.element.scrollTop=n.offsetTop,aa(n));return}if(Array.from(o.querySelectorAll(`[data-node-id="${t}"]`)).find(i=>{if(!hasClosestByAttribute(i,"data-type","block-render",!0))return n=i,!0}),n)return Za(e,n,a),aa(n),n;if(t===e.block.rootID&&e.options.render.title&&e.title.editElement)return aa(e.title.editElement),e.title.editElement},Za=(e,t,a=!1,n="auto")=>{var o,i,s,l;if(!e.disabled&&!a&&getSelection().rangeCount>0){const g=getSelection().getRangeAt(0),f=oe(g.startContainer);if(f){if(f.classList.contains("code-block")){const _=document.createElement("br");g.insertNode(_),_.scrollIntoView({block:"nearest",behavior:n}),_.remove();return}if(f.classList.contains("av")&&f.dataset.render==="true"&&(((o=f.querySelector(".av__row--header").getAttribute("style"))==null?void 0:o.indexOf("transform"))>-1||((i=f.querySelector(".av__row--footer").getAttribute("style"))==null?void 0:i.indexOf("transform"))>-1))return;const p=g.cloneRange(),m=document.createElement("br");g.insertNode(m);const b=e.contentElement,w=m.getBoundingClientRect().top-b.getBoundingClientRect().top;let y=0;w<0?y=b.scrollTop+w:w>b.clientHeight-74&&(y=b.scrollTop+(w+74-b.clientHeight)),y!==0&&b.scroll({top:y,behavior:n}),m.remove(),Ae(p);return}}if(!t&&((s=document.activeElement)==null?void 0:s.tagName)!=="TEXTAREA"&&((l=document.activeElement)==null?void 0:l.tagName)!=="INPUT"&&(t=oe(lt(e.wysiwyg.element).startContainer)),!t)return;let r=0,c=t;for(;c&&!c.classList.contains("protyle-wysiwyg");)r+=c.offsetTop,c=c.parentElement;let d=0,u=e.element.firstElementChild;for(;u&&!u.classList.contains("protyle-content");)d+=u.clientHeight,u=u.nextElementSibling;if(a){e.contentElement.scroll({top:r-d,behavior:n});return}e.contentElement.scrollTop>r-32?e.contentElement.scroll({top:r-d,behavior:n}):e.contentElement.scrollTop+e.contentElement.clientHeight<r+t.clientHeight-d&&e.contentElement.scroll({top:r+t.clientHeight-d-e.contentElement.clientHeight,behavior:n})},Xa=(e,t=0,a=1e3)=>{e.scroll.lastScrollTop=-1,setTimeout(()=>{e.scroll.lastScrollTop=t},a)};class Or{constructor(){this.wheelEvent="onwheel"in document.createElement("div")?"wheel":"mousewheel",this.element=document.getElementById("commonMenu"),this.element.querySelector(".b3-menu__title .b3-menu__label").innerHTML=window.siyuan.languages.back,this.element.addEventListener(isMobile()?"click":"mouseover",t=>{const a=t.target;if(isMobile()&&(hasClosestByClassName(a,"b3-menu__title")||typeof t.detail=="string"&&t.detail==="back")){const s=this.element.querySelectorAll(".b3-menu__item--show");s.length>0?s[s.length-1].classList.remove("b3-menu__item--show"):(this.element.style.transform="",setTimeout(()=>{this.remove()},Constants.TIMEOUT_DBLCLICK));return}const n=hasClosestByClassName(a,"b3-menu__item");if(!n||n.classList.contains("b3-menu__item--readonly"))return;const o=n.querySelector(".b3-menu__submenu");this.element.querySelectorAll(".b3-menu__item--show").forEach(i=>{!i.contains(n)&&!i.isSameNode(n)&&!n.contains(i)&&i.classList.remove("b3-menu__item--show")}),this.element.querySelectorAll(".b3-menu__item--current").forEach(i=>{i.classList.remove("b3-menu__item--current")}),n.classList.add("b3-menu__item--current"),o&&(n.classList.add("b3-menu__item--show"),this.element.classList.contains("b3-menu--fullscreen")||this.showSubMenu(o))})}showSubMenu(t){const a=t.parentElement.getBoundingClientRect();t.style.top=a.top-8+"px",t.style.left=a.right+8+"px",t.style.bottom="auto";const n=t.getBoundingClientRect();n.right>window.innerWidth&&(a.left-8>n.width?t.style.left=a.left-8-n.width+"px":t.style.left=window.innerWidth-n.width+"px"),n.bottom>window.innerHeight&&(t.style.top="auto",t.style.bottom="8px")}preventDefault(t){!hasClosestByClassName(t.target,"b3-menu")&&!hasClosestByClassName(t.target,"keyboard__bar")&&t.preventDefault()}addItem(t){const a=new _e(t);return this.append(a.element,t.index),a.element}removeScrollEvent(){window.removeEventListener(isMobile()?"touchmove":this.wheelEvent,this.preventDefault,!1)}remove(){window.siyuan.menus.menu.removeCB&&(window.siyuan.menus.menu.removeCB(),window.siyuan.menus.menu.removeCB=void 0),this.removeScrollEvent(),this.element.firstElementChild.classList.add("fn__none"),this.element.lastElementChild.innerHTML="",this.element.lastElementChild.removeAttribute("style"),this.element.classList.add("fn__none"),this.element.classList.remove("b3-menu--list","b3-menu--fullscreen"),this.element.removeAttribute("style"),this.element.removeAttribute("data-name"),this.element.removeAttribute("data-from"),this.data=void 0}append(t,a){if(t){if(typeof a=="number"){const n=this.element.querySelectorAll(".b3-menu__items > .b3-menu__separator")[a];if(n){n.before(t);return}}this.element.lastElementChild.append(t)}}popup(t){this.element.lastElementChild.innerHTML!==""&&(window.addEventListener(isMobile()?"touchmove":this.wheelEvent,this.preventDefault,{passive:!1}),this.element.style.zIndex=(++window.siyuan.zIndex).toString(),this.element.classList.remove("fn__none"),setPosition(this.element,t.x-(t.isLeft?this.element.clientWidth:0),t.y,t.h,t.w))}fullscreen(t="all"){this.element.lastElementChild.innerHTML!==""&&(this.element.classList.add("b3-menu--fullscreen"),this.element.style.zIndex=(++window.siyuan.zIndex).toString(),this.element.firstElementChild.classList.remove("fn__none"),this.element.classList.remove("fn__none"),window.addEventListener("touchmove",this.preventDefault,{passive:!1}),setTimeout(()=>{t==="bottom"?(this.element.style.transform="translateY(-50vh)",this.element.style.height="50vh"):this.element.style.transform="translateY(-100vh)"}),this.element.lastElementChild.scrollTop=0)}}class _e{constructor(t){if(!t.ignore){if(t.type==="empty"){this.element=document.createElement("div"),this.element.innerHTML=t.label,t.bind&&t.bind(this.element);return}if(this.element=document.createElement("button"),t.disabled&&this.element.setAttribute("disabled","disabled"),t.id&&this.element.setAttribute("data-id",t.id),t.type==="separator"){this.element.classList.add("b3-menu__separator");return}if(this.element.classList.add("b3-menu__item"),t.current&&this.element.classList.add("b3-menu__item--selected"),t.click&&this.element.addEventListener("click",a=>{if(this.element.getAttribute("disabled"))return;let n=t.click(this.element,a);n instanceof Promise&&(n=!1),a.preventDefault(),a.stopImmediatePropagation(),a.stopPropagation(),this.element.parentElement&&!n&&window.siyuan.menus.menu.remove()}),t.type==="readonly"&&this.element.classList.add("b3-menu__item--readonly"),(t.icon==="iconTrashcan"||t.warning)&&this.element.classList.add("b3-menu__item--warning"),t.element)this.element.append(t.element);else{let a=`<span class="b3-menu__label">${t.label||"&nbsp;"}</span>`;typeof t.iconHTML=="string"?a=t.iconHTML+a:a=`<svg class="b3-menu__icon ${t.iconClass||""}" style="${t.icon==="iconClose"?"height:10px;":""}"><use xlink:href="#${t.icon||""}"></use></svg>${a}`,t.accelerator&&(a+=`<span class="b3-menu__accelerator">${$a(t.accelerator)}</span>`),t.action&&(a+=`<svg class="b3-menu__action${t.action==="iconCloseRound"?" b3-menu__action--close":""}"><use xlink:href="#${t.action}"></use></svg>`),t.checked&&(a+='<svg class="b3-menu__checked"><use xlink:href="#iconSelect"></use></svg></span>'),this.element.innerHTML=a}if(t.bind&&(this.element.classList.add("b3-menu__item--custom"),t.bind(this.element)),t.submenu){const a=document.createElement("div");a.classList.add("b3-menu__submenu"),a.innerHTML='<div class="b3-menu__items"></div>',t.submenu.forEach(n=>{a.firstElementChild.append(new _e(n).element)}),this.element.insertAdjacentHTML("beforeend",'<svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>'),this.element.append(a)}}}}const ut=(e,t)=>{let a=e;for(;a&&(a.classList.contains("b3-menu__separator")||a.classList.contains("b3-menu__item--readonly")||a.getBoundingClientRect().height===0)&&!a.querySelector(".b3-text-field");)t?a=a.nextElementSibling:a=a.previousElementSibling;return a},qr=e=>{if(window.siyuan.menus.menu.element.classList.contains("fn__none")||e.altKey||e.shiftKey||e.ctrlKey||e.metaKey)return!1;const t=e.target;if(window.siyuan.menus.menu.element.contains(t)&&["INPUT","TEXTAREA"].includes(t.tagName))return!1;const a=Constants.KEYCODELIST[e.keyCode];if(a==="\u2193"||a==="\u2191"){const n=window.siyuan.menus.menu.element.querySelector(".b3-menu__item--current");let o;if(n?(n.classList.remove("b3-menu__item--current","b3-menu__item--show"),a==="\u2191"?(o=ut(n.previousElementSibling,!1),o||(o=ut(n.parentElement.lastElementChild,!1))):(o=ut(n.nextElementSibling,!0),o||(o=ut(n.parentElement.firstElementChild,!0)))):a==="\u2191"?o=ut(window.siyuan.menus.menu.element.lastElementChild.lastElementChild,!1):o=ut(window.siyuan.menus.menu.element.lastElementChild.firstElementChild,!0),o){o.classList.add("b3-menu__item--current"),o.classList.remove("b3-menu__item--show");const i=o.parentElement.getBoundingClientRect(),s=o.getBoundingClientRect();(i.top>s.top||i.bottom<s.bottom)&&o.scrollIntoView(i.top>s.top)}return!0}else if(a==="\u2192"){const n=window.siyuan.menus.menu.element.querySelector(".b3-menu__item--current");if(!n)return!0;const o=n.querySelector(".b3-menu__submenu");if(!o)return!0;n.classList.remove("b3-menu__item--current"),n.classList.add("b3-menu__item--show");const i=ut(o.firstElementChild.firstElementChild,!0);return i&&i.classList.add("b3-menu__item--current"),window.siyuan.menus.menu.showSubMenu(o),!0}else if(a==="\u2190"){const n=window.siyuan.menus.menu.element.querySelector(".b3-menu__submenu .b3-menu__item--current");if(!n)return!0;const o=hasClosestByClassName(n,"b3-menu__item--show");return o&&(o.classList.remove("b3-menu__item--show"),o.classList.add("b3-menu__item--current"),n.classList.remove("b3-menu__item--current")),!0}else if(a==="\u21A9"){const n=window.siyuan.menus.menu.element.querySelector(".b3-menu__item--current");if(n){const o=n.querySelector(".b3-text-field"),i=n.querySelector(".b3-switch");if(o)return o.focus(),!0;i?i.click():n.dispatchEvent(new CustomEvent(getEventName())),window.siyuan.menus.menu.element.contains(n)&&window.siyuan.menus.menu.remove()}else return!1;return!0}};class Mi{constructor(){this.menus=[]}addSeparator(t,a){typeof t=="number"?this.menus.splice(t,0,{type:"separator",id:a}):this.menus.push({type:"separator",id:a})}addItem(t){typeof t.index=="number"?this.menus.splice(t.index,0,t):this.menus.push(t)}}class Ur{constructor(t=""){this.eventTarget=document.appendChild(document.createComment(t))}on(t,a){this.eventTarget.addEventListener(t,a)}once(t,a){this.eventTarget.addEventListener(t,a,{once:!0})}off(t,a){this.eventTarget.removeEventListener(t,a)}emit(t,a){return this.eventTarget.dispatchEvent(new CustomEvent(t,{detail:a,cancelable:!0}))}}const Di=e=>{const t=new Mi;e.detail.menu=t,e.plugins.forEach(a=>{a.eventBus.emit(e.type,e.detail)}),t.menus.length>0&&(e.separatorPosition==="top"&&window.siyuan.menus.menu.append(new _e({id:"separator_pluginTop",type:"separator"}).element),window.siyuan.menus.menu.append(new _e({id:"plugin",label:window.siyuan.languages.plugin,icon:"iconPlugin",type:"submenu",submenu:t.menus}).element),e.separatorPosition==="bottom"&&window.siyuan.menus.menu.append(new _e({id:"separator_pluginBottom",type:"separator"}).element))},Ja=(e,t,a)=>{if(e.getAttribute("custom-pinthead")==="true"){const n=e.querySelector("table");n.clientHeight+n.scrollTop<t.offsetTop+t.clientHeight?n.scrollTop=t.offsetTop-n.clientHeight+t.clientHeight+1:n.scrollTop>t.offsetTop-t.clientHeight&&(n.scrollTop=t.offsetTop-t.clientHeight+1)}else scrollCenter(a,t)},Xe=e=>{let t=e.previousElementSibling,a=0;for(;t;)a++,t=t.previousElementSibling;return a},Pn=(e,t,a=!0)=>{let n=e.previousElementSibling;return n||(e.parentElement.previousElementSibling?n=e.parentElement.previousElementSibling.lastElementChild:e.parentElement.parentElement.tagName==="TBODY"&&e.parentElement.parentElement.previousElementSibling?n=e.parentElement.parentElement.previousElementSibling.lastElementChild.lastElementChild:n=null),n&&(t.selectNodeContents(n),a||t.collapse(!1),focusByRange(t)),n},Qa=(e,t,a,n,o)=>{o.insertNode(document.createElement("wbr"));const i=a.outerHTML,s=a.querySelector("table"),l=s.rows[0].cells.length,r=s.rows.length,c=[];for(let d=0;d<r;d++){for(let u=0;u<l;u++)s.rows[d].cells[u].isSameNode(t[c.length])&&c.push(u);if(c.length>0)break}for(let d=0;d<r;d++)c.forEach(u=>{s.rows[d].cells[u].setAttribute("align",n)});updateTransaction(e,a.getAttribute("data-node-id"),a.outerHTML,i),focusByWbr(s,o)},Rn=(e,t,a,n)=>{const o=document.createElement("wbr");t.insertNode(o);const i=n.outerHTML;o.remove();let s="";for(let r=0;r<a.parentElement.childElementCount;r++)s+=`<td align="${a.parentElement.children[r].getAttribute("align")||""}"></td>`;let l;if(a.tagName==="TH"){const r=n.querySelector("tbody");r?(r.insertAdjacentHTML("afterbegin",`<tr>${s}</tr>`),l=r.firstElementChild):(a.parentElement.parentElement.insertAdjacentHTML("afterend",`<tbody><tr>${s}</tr></tbody>`),l=a.parentElement.parentElement.nextElementSibling.firstElementChild)}else a.parentElement.insertAdjacentHTML("afterend",`<tr>${s}</tr>`),l=a.parentElement.nextElementSibling;t.selectNodeContents(l.cells[Xe(a)]),t.collapse(!0),focusByRange(t),updateTransaction(e,n.getAttribute("data-node-id"),n.outerHTML,i),Ja(n,l,e)},$i=(e,t,a,n)=>{const o=document.createElement("wbr");t.insertNode(o);const i=n.outerHTML;o.remove();let s="",l=!1;for(let c=0;c<a.parentElement.childElementCount;c++){const d=a.parentElement.children[c];d.className==="fn__none"&&(l=!0),a.tagName==="TH"?s+=`<th class="${d.className}" colspan="${d.colSpan}" align="${d.getAttribute("align")}"></th>`:s+=`<td class="${d.className}" colspan="${d.colSpan}" align="${d.getAttribute("align")}"></td>`}if(l){let c=a.parentElement.previousElementSibling,d=1;for(;c;)d++,Array.from(c.children).forEach(u=>{u.rowSpan>=d&&u.rowSpan>1&&(u.rowSpan=u.rowSpan+1)}),c=c.previousElementSibling}let r;a.parentElement.parentElement.tagName==="THEAD"&&!a.parentElement.previousElementSibling?(a.parentElement.parentElement.insertAdjacentHTML("beforebegin",`<thead><tr>${s}</tr></thead>`),r=n.querySelector("thead tr"),a.parentElement.parentElement.nextElementSibling.insertAdjacentHTML("afterbegin",a.parentElement.parentElement.innerHTML),a.parentElement.parentElement.remove()):(a.parentElement.insertAdjacentHTML("beforebegin",`<tr>${s}</tr>`),r=a.parentElement.previousElementSibling),t.selectNodeContents(r.cells[Xe(a)]),t.collapse(!0),focusByRange(t),updateTransaction(e,n.getAttribute("data-node-id"),n.outerHTML,i),Ja(n,r,e)},On=(e,t,a,n,o)=>{const i=document.createElement("wbr");o.insertNode(i);const s=t.outerHTML;i.remove();const l=Xe(a),r=t.querySelector("table");for(let c=0;c<r.rows.length;c++){const d=r.rows[c].cells[l],u=document.createElement(d.tagName);d.insertAdjacentElement(n,u),d.isSameNode(a)?(u.innerHTML="<wbr> ",u.offsetLeft+u.clientWidth>t.firstElementChild.scrollLeft+t.firstElementChild.clientWidth&&(t.firstElementChild.scrollLeft=u.offsetLeft+u.clientWidth-t.firstElementChild.clientWidth)):u.textContent=" "}r.querySelectorAll("col")[l].insertAdjacentHTML(n,"<col>"),focusByWbr(t,o),updateTransaction(e,t.getAttribute("data-node-id"),t.outerHTML,s)},Hi=(e,t,a,n)=>{if(a.parentElement.parentElement.tagName!=="THEAD"){const o=document.createElement("wbr");t.insertNode(o);const i=n.outerHTML;o.remove();const s=Xe(a),l=a.parentElement.parentElement;let r=l.previousElementSibling.lastElementChild;a.parentElement.previousElementSibling&&(r=a.parentElement.previousElementSibling),l.childElementCount===1?l.remove():a.parentElement.remove(),t.selectNodeContents(r.cells[s]),t.collapse(!0),focusByRange(t),Ja(n,r,e),updateTransaction(e,n.getAttribute("data-node-id"),n.outerHTML,i)}},Ni=(e,t,a,n)=>{var o;const i=document.createElement("wbr");t.insertNode(i);const s=a.outerHTML;i.remove();const l=Xe(n),r=n.previousElementSibling||n.nextElementSibling;if(r)t.selectNodeContents(r),t.collapse(!0),r.offsetLeft+r.clientWidth>a.firstElementChild.scrollLeft+a.firstElementChild.clientWidth&&(a.firstElementChild.scrollLeft=r.offsetLeft+r.clientWidth-a.firstElementChild.clientWidth);else{a.classList.add("protyle-wysiwyg--select"),removeBlock(e,a,t,"remove");return}const c=a.querySelector("table");for(let d=0;d<c.rows.length;d++){const u=c.rows[d].cells;if(u.length===1){c.remove();break}u[l].remove()}(o=a.querySelectorAll("col")[l])==null||o.remove(),updateTransaction(e,a.getAttribute("data-node-id"),a.outerHTML,s),focusByRange(t)},Bi=(e,t,a,n)=>{const o=a.parentElement;if(o.parentElement.tagName==="THEAD")return;t.insertNode(document.createElement("wbr"));const i=n.outerHTML;if(o.previousElementSibling)o.after(o.previousElementSibling);else{const s=o.parentElement.previousElementSibling.firstElementChild;s.querySelectorAll("th").forEach(l=>{const r=document.createElement("td");r.innerHTML=l.innerHTML,l.parentNode.replaceChild(r,l)}),o.querySelectorAll("td").forEach(l=>{const r=document.createElement("th");r.innerHTML=l.innerHTML,l.parentNode.replaceChild(r,l)}),o.after(s),o.parentElement.previousElementSibling.append(o)}updateTransaction(e,n.getAttribute("data-node-id"),n.outerHTML,i),focusByWbr(n,t),scrollCenter(e,o)},Pi=(e,t,a,n)=>{const o=a.parentElement;if(o.parentElement.tagName==="TBODY"&&!o.nextElementSibling||o.parentElement.tagName==="THEAD"&&!o.parentElement.nextElementSibling)return;t.insertNode(document.createElement("wbr"));const i=n.outerHTML;if(o.nextElementSibling)o.before(o.nextElementSibling);else{const s=o.parentElement.nextElementSibling.firstElementChild;s.querySelectorAll("td").forEach(l=>{const r=document.createElement("th");r.innerHTML=l.innerHTML,l.parentNode.replaceChild(r,l)}),o.querySelectorAll("th").forEach(l=>{const r=document.createElement("td");r.innerHTML=l.innerHTML,l.parentNode.replaceChild(r,l)}),o.after(s),o.parentElement.nextElementSibling.insertAdjacentElement("afterbegin",o)}updateTransaction(e,n.getAttribute("data-node-id"),n.outerHTML,i),focusByWbr(n,t),scrollCenter(e,o)},Ri=(e,t,a,n)=>{if(!a.previousElementSibling)return;t.insertNode(document.createElement("wbr"));const o=n.outerHTML;let i=0;Array.from(a.parentElement.children).find((l,r)=>{if(a.isSameNode(l))return i=r,!0}),n.querySelectorAll("tr").forEach(l=>{l.cells[i].after(l.cells[i-1])}),a.offsetLeft<n.firstElementChild.scrollLeft&&(n.firstElementChild.scrollLeft=a.offsetLeft);const s=n.querySelectorAll("col");s[i].after(s[i-1]),updateTransaction(e,n.getAttribute("data-node-id"),n.outerHTML,o),focusByWbr(n,t)},Oi=(e,t,a,n)=>{if(!a.nextElementSibling)return;t.insertNode(document.createElement("wbr"));const o=n.outerHTML;let i=0;Array.from(a.parentElement.children).find((l,r)=>{if(a.isSameNode(l))return i=r,!0}),n.querySelectorAll("tr").forEach(l=>{l.cells[i].before(l.cells[i+1])}),a.offsetLeft+a.clientWidth>n.firstElementChild.scrollLeft+n.firstElementChild.clientWidth&&(n.firstElementChild.scrollLeft=a.offsetLeft+a.clientWidth-n.firstElementChild.clientWidth);const s=n.querySelectorAll("col");s[i].before(s[i+1]),updateTransaction(e,n.getAttribute("data-node-id"),n.outerHTML,o),focusByWbr(n,t)},Fr=(e,t,a)=>{var n,o;const i=hasClosestByTag(a.startContainer,"TD")||hasClosestByTag(a.startContainer,"TH"),s=hasClosestBlock(a.startContainer);if(!i||!s)return!1;if(t.key==="Enter"&&t.shiftKey&&isNotCtrl(t)&&!t.altKey){const k=document.createElement("wbr");a.insertNode(k);const v=s.outerHTML;if(k.remove(),i&&!i.innerHTML.endsWith("<br>")&&i.insertAdjacentHTML("beforeend","<br>"),a.extractContents(),e.toolbar.getCurrentType(a).includes("code")&&a.startContainer.nodeType!==3){const L=document.createElement("br");a.startContainer.after(L),a.setStartAfter(L)}else a.insertNode(document.createElement("br"));return a.collapse(!1),scrollCenter(e),updateTransaction(e,s.getAttribute("data-node-id"),s.outerHTML,v),t.preventDefault(),!0}if(!s.classList.contains("protyle-wysiwyg--select")&&!hasClosestByClassName(s,"protyle-wysiwyg--select")){if(isNotCtrl(t)&&!t.shiftKey&&!t.altKey&&t.key==="Enter"){t.preventDefault();const k=i.parentElement;if(!k.nextElementSibling&&k.parentElement.tagName==="TBODY"||k.parentElement.tagName==="THEAD"&&!k.parentElement.nextElementSibling)return insertEmptyBlock(e,"afterend",s.getAttribute("data-node-id")),!0;let v=k.nextElementSibling;return v||(v=k.parentElement.nextElementSibling.firstChild),v&&(a.selectNodeContents(v.cells[Xe(i)]),a.collapse(!0),scrollCenter(e)),!0}if(t.key==="ArrowRight"&&a.toString()===""&&!s.nextElementSibling&&i.isSameNode(s.querySelector("table").lastElementChild.lastElementChild.lastElementChild)&&getSelectionOffset(i,e.wysiwyg.element,a).start===i.textContent.length)return t.preventDefault(),insertEmptyBlock(e,"afterend",s.getAttribute("data-node-id")),!0;if(t.key==="Tab"&&isNotCtrl(t)){if(t.shiftKey)return Pn(i,a),t.preventDefault(),!0;let k=i.nextElementSibling;return k||(i.parentElement.nextElementSibling?k=i.parentElement.nextElementSibling.firstElementChild:i.parentElement.parentElement.tagName==="THEAD"&&i.parentElement.parentElement.nextElementSibling?k=i.parentElement.parentElement.nextElementSibling.firstElementChild.firstElementChild:k=null),k?a.selectNodeContents(k):(Rn(e,a,i,s),a.selectNodeContents(s.querySelector("tbody").lastElementChild.firstElementChild)),t.preventDefault(),!0}if(t.key==="ArrowUp"&&isNotCtrl(t)&&!t.shiftKey&&!t.altKey){const k=a.startContainer;let v;for(k.nodeType!==3&&(k.tagName==="TH"||k.tagName==="TD")?v=k.childNodes[Math.min(a.startOffset,k.childNodes.length-1)]:k.parentElement.tagName==="SPAN"?v=k.parentElement.previousElementSibling:v=k.previousElementSibling;v;){if(v.tagName==="BR"&&hasPreviousSibling(v))return!1;v=v.previousElementSibling}const A=i.parentElement;let L=A.previousElementSibling;return L||(L=A.parentElement.previousElementSibling.lastElementChild),!L||(L==null?void 0:L.tagName)==="COL"?!1:(a.selectNodeContents(L.cells[Xe(i)]),a.collapse(!1),scrollCenter(e),t.preventDefault(),!0)}if(t.key==="ArrowDown"&&isNotCtrl(t)&&!t.shiftKey&&!t.altKey){const k=a.endContainer;let v;for(k.nodeType!==3&&(k.tagName==="TH"||k.tagName==="TD")?v=(n=k.childNodes[Math.max(0,a.endOffset-1)])==null?void 0:n.nextElementSibling:k.parentElement.tagName==="SPAN"?v=k.parentElement.nextElementSibling:v=k.nextElementSibling;v;){if(v.tagName==="BR"&&v.nextSibling)return!1;v=v.nextElementSibling}const A=i.parentElement;if(!A.nextElementSibling&&A.parentElement.tagName==="TBODY"||A.parentElement.tagName==="THEAD"&&!A.parentElement.nextElementSibling)return!1;let L=A.nextElementSibling;return L||(L=A.parentElement.nextElementSibling.firstChild),L?(a.selectNodeContents(L.cells[Xe(i)]),a.collapse(!0),scrollCenter(e),t.preventDefault(),!0):!1}if(isNotCtrl(t)&&!t.shiftKey&&!t.altKey&&t.key==="Backspace"&&getSelectionOffset(i,e.wysiwyg.element,a).start===0&&a.toString()===""&&(a.startOffset===0||a.startOffset===1&&i.querySelectorAll("br").length===1))return!Pn(i,a,!1)&&s.previousElementSibling&&focusBlock(s.previousElementSibling,void 0,!1),scrollCenter(e),t.preventDefault(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.general.alignLeft.custom,t))return Qa(e,[i],s,"left",a),t.preventDefault(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.general.alignCenter.custom,t))return Qa(e,[i],s,"center",a),t.preventDefault(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.general.alignRight.custom,t))return Qa(e,[i],s,"right",a),t.preventDefault(),!0}const l=s.querySelector("table"),r=i.parentElement.querySelector(".fn__none");let c=!1,d=!1;Array.from(i.parentElement.children).forEach(k=>{k.colSpan>1&&(c=!0),k.rowSpan>1&&(d=!0)});let u=!1,g=!1,f=!1,p=i.parentElement.previousElementSibling;!p&&i.parentElement.parentElement.tagName==="TBODY"&&(p=l.querySelector("thead").lastElementChild),p&&(u=p.querySelector(".fn__none"),Array.from(p.children).forEach(k=>{k.colSpan>1&&(g=!0),k.rowSpan>1&&(f=!0)}));let m=!1,b=!1,w=!1,y=i.parentElement.nextElementSibling;!y&&i.parentElement.parentElement.tagName==="THEAD"&&(y=(o=l.querySelector("tbody"))==null?void 0:o.firstElementChild),y&&(m=y.querySelector(".fn__none"),Array.from(y.children).forEach(k=>{k.colSpan>1&&(b=!0),k.rowSpan>1&&(w=!0)}));const _=Xe(i);let h=!0;Array.from(l.rows).find(k=>{const v=k.cells[_];if(v.classList.contains("fn__none")||v.colSpan>1||v.rowSpan>1)return h=!1,!0});let E=!0;Array.from(l.rows).find(k=>{const v=k.cells[_+1];if(v&&(v.classList.contains("fn__none")||v.colSpan>1||v.rowSpan>1))return E=!1,!0});let C=!0;if(Array.from(l.rows).find(k=>{const v=k.cells[_-1];if(v&&(v.classList.contains("fn__none")||v.colSpan>1||v.rowSpan>1))return C=!1,!0}),matchHotKey(window.siyuan.config.keymap.editor.table.moveToUp.custom,t))return(!r||r&&!d&&c)&&(!u||u&&!f&&g)&&Bi(e,a,i,s),t.preventDefault(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.table.moveToDown.custom,t))return(!r||r&&!d&&c)&&(!m||m&&!w&&b)&&Pi(e,a,i,s),t.preventDefault(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.table.moveToLeft.custom,t))return h&&C&&Ri(e,a,i,s),t.preventDefault(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.table.moveToRight.custom,t))return h&&E&&Oi(e,a,i,s),t.preventDefault(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.table.insertRowAbove.custom,t))return $i(e,a,i,s),t.preventDefault(),t.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.table.insertRowBelow.custom,t))return(!m||m&&!w&&b)&&Rn(e,a,i,s),t.preventDefault(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.table.insertColumnLeft.custom,t))return(h||C)&&On(e,s,i,"beforebegin",a),t.preventDefault(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.table.insertColumnRight.custom,t))return(h||E)&&On(e,s,i,"afterend",a),t.preventDefault(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.table["delete-row"].custom,t))return(!r&&!d||r&&!d&&c)&&Hi(e,a,i,s),t.preventDefault(),t.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.table["delete-column"].custom,t))return h&&Ni(e,a,s,i),t.preventDefault(),!0},Yr=(e,t)=>{var a;if(!t)return;const n=t.querySelector(".table__select"),o=[],i=t.firstElementChild.scrollLeft;if(t.querySelectorAll("th, td").forEach(l=>{!l.classList.contains("fn__none")&&l.offsetLeft+6>n.offsetLeft+i&&l.offsetLeft+l.clientWidth-6<n.offsetLeft+i+n.clientWidth&&l.offsetTop+6>n.offsetTop&&l.offsetTop+l.clientHeight-6<n.offsetTop+n.clientHeight&&o.push(l)}),n.removeAttribute("style"),getSelection().rangeCount>0){const l=getSelection().getRangeAt(0);t.contains(l.startContainer)&&l.insertNode(document.createElement("wbr"))}const s=t.outerHTML;(a=t.querySelector("wbr"))==null||a.remove(),t.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),o.forEach(l=>{l.innerHTML=""}),updateTransaction(e,t.getAttribute("data-node-id"),t.outerHTML,s)},Wr=(e,t,a)=>{if(isMobile())return;const n=t.getBoundingClientRect();if(n.height===0||!e){na();return}const o=document.getElementById("tooltip");o.className=a?`tooltip tooltip--${a}`:"tooltip",o.innerHTML=e,o.removeAttribute("style");const i=t.getAttribute("data-position"),s=t.parentElement.getBoundingClientRect();let l,r;if(i==="parentE")r=Math.max(0,s.top-(o.clientHeight-s.height)/2),r>window.innerHeight-o.clientHeight&&(r=window.innerHeight-o.clientHeight),l=s.right+8,l+o.clientWidth>window.innerWidth&&(l=s.left-o.clientWidth-8);else if(i==="parentW")r=Math.max(0,s.top-(o.clientHeight-s.height)/2),r>window.innerHeight-o.clientHeight&&(r=window.innerHeight-o.clientHeight),l=s.left-o.clientWidth,l<0&&(l=s.right);else if(i!=null&&i.endsWith("west")){const c=parseInt(i)||.5;r=Math.max(0,n.top-(o.clientHeight-n.height)/2),r>window.innerHeight-o.clientHeight&&(r=window.innerHeight-o.clientHeight),l=n.left-o.clientWidth-c,l<0&&(l=n.right)}else if(i==="north")l=Math.max(0,n.left-(o.clientWidth-n.width)/2),r=n.top-o.clientHeight-.5,r<0&&(n.top<window.innerHeight-n.bottom?(r=n.bottom+.5,o.style.maxHeight=window.innerHeight-r+"px"):(r=0,o.style.maxHeight=n.top-.5+"px")),l+o.clientWidth>window.innerWidth&&(l=window.innerWidth-o.clientWidth);else{const c=parseInt(i)||.5;l=Math.max(0,n.left-(o.clientWidth-n.width)/2),r=n.bottom+c,r+o.clientHeight>window.innerHeight&&(n.top-c>window.innerHeight-r?(r=n.top-c-o.clientHeight,o.style.maxHeight=n.top-c+"px"):o.style.maxHeight=window.innerHeight-r+"px"),l+o.clientWidth>window.innerWidth&&(l=window.innerWidth-o.clientWidth)}o.style.top=r+"px",o.style.left=l+"px"},na=()=>{document.getElementById("tooltip").classList.add("fn__none")},qi=()=>{const e=[];return window.siyuan.mobile.editor&&e.push(window.siyuan.mobile.editor),window.siyuan.mobile.popEditor&&e.push(window.siyuan.mobile.popEditor),e},jr=()=>{},Ui=(e,t)=>{for(let a=0;a<e.children.length;a++){const n=e.children[a];n instanceof Wnd?t.push(n):n instanceof Layout&&Ui(n,t)}},Vr=()=>{const e=[],t=a=>{for(let n=0;n<a.children.length;n++){const o=a.children[n];o instanceof Tab?e.push(o):t(o)}};return window.siyuan.layout.centerLayout&&t(window.siyuan.layout.centerLayout),e},Gr=()=>{const e=[];return window.siyuan.config.uiLayout.left.data.forEach(t=>{t.forEach(a=>{e.push(a)})}),window.siyuan.config.uiLayout.right.data.forEach(t=>{t.forEach(a=>{e.push(a)})}),window.siyuan.config.uiLayout.bottom.data.forEach(t=>{t.forEach(a=>{e.push(a)})}),e},Fi=(e,t)=>/\r\n|\r|\n|\u2028|\u2029|\t|\//.test(e)?(t?showTooltip(window.siyuan.languages.fileNameRule,t,"error"):showMessage(window.siyuan.languages.fileNameRule),!1):e.length>Constants.SIZE_TITLE?(t?showTooltip(window.siyuan.languages._kernel[106],t,"error"):showMessage(window.siyuan.languages._kernel[106]),!1):!0,en=e=>e.replace(/\r\n|\r|\n|\u2028|\u2029|\t|\//g,"").substring(0,S.SIZE_TITLE),Kr=e=>e.replace(/\\\\|\/|"|:|\*|\?|\\|'|<|>|\|/g,""),zr=e=>{if(window.siyuan.config.readonly)return;const t=new Dialog({title:window.siyuan.languages.rename,content:`<div class="b3-dialog__content"><input class="b3-text-field fn__block" value=""></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px",destroyCallback(){e.range&&focusByRange(e.range)}});t.element.setAttribute("data-key",Constants.DIALOG_RENAME);const a=t.element.querySelector("input"),n=t.element.querySelectorAll(".b3-button");t.bindInput(a,()=>{n[1].click()}),a.value=Lute.UnEscapeHTMLStr(e.name),a.focus(),a.select(),n[0].addEventListener("click",()=>{t.destroy()}),n[1].addEventListener("click",()=>{if(!Fi(a.value))return!1;if(a.value===e.name)return t.destroy(),!1;a.value.trim()===""?a.value=window.siyuan.languages.untitled:a.value=en(a.value),e.type==="notebook"?fetchPost("/api/notebook/renameNotebook",{notebook:e.notebookId,name:a.value},()=>{setNotebookName(e.notebookId,a.value)}):fetchPost("/api/filetree/renameDoc",{notebook:e.notebookId,path:e.path,title:a.value}),t.destroy()})},Yi=e=>{const t=new Tn({title:window.siyuan.languages.rename,content:`<div class="b3-dialog__content"><input class="b3-text-field fn__block" value=""></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:$()?"92vw":"520px"});t.element.setAttribute("data-key",S.DIALOG_RENAMEASSETS);const a=t.element.querySelector("input"),n=t.element.querySelectorAll(".b3-button");t.bindInput(a,()=>{n[1].click()});const o=ki(e);a.value=o,a.focus(),a.select(),n[0].addEventListener("click",()=>{t.destroy()}),n[1].addEventListener("click",()=>{if(a.value===o||!a.value)return t.destroy(),!1;he("/api/asset/renameAsset",{oldPath:e,newName:a.value},i=>{qi().forEach(s=>{s.reload(!1)}),t.destroy()})})},Zr=e=>{if(getSelection().rangeCount===0)return;const t=getSelection().getRangeAt(0),a=hasClosestBlock(t.startContainer);if(!a)return;let n=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));n.length===0&&(n=[a]);let o="",i=t.toString();if(i===""){if(i=n[0].textContent,n.forEach(s=>{o+=removeEmbed(s)}),!i)return}else{const s=document.createElement("div");s.appendChild(t.cloneContents()),o=s.innerHTML}i.length>10&&(i=i.substr(0,10)+"..."),i=en(i),fetchPost("/api/filetree/createDoc",{notebook:e.notebookId,path:pathPosix().join(getDisplayName(e.path,!1,!0),Lute.NewNodeID()+".sy"),title:i,md:e.lute.BlockDOM2StdMd(o)})},Xr=(e,t)=>{},Jr=e=>{const t=new Dialog({title:window.siyuan.languages.exportAsImage,content:`<div class="b3-dialog__content" style="${isMobile()?"padding:8px;":""};background-color: var(--b3-theme-background)">
    <div style="${isMobile()?"padding: 16px;margin: 8px 0":"padding: 48px;margin: 8px 0"};" class="export-img">
        <div class="protyle-wysiwyg${window.siyuan.config.editor.displayBookmarkIcon?" protyle-wysiwyg--attr":""}"></div>
        <div class="export-img__watermark"></div>
    </div>
</div>
<div class="b3-dialog__action">
    <label class="fn__flex">
        ${window.siyuan.languages.exportPDF5}
        <span class="fn__space"></span>
        <input id="keepFold" class="b3-switch fn__flex-center" type="checkbox" ${window.siyuan.storage[Constants.LOCAL_EXPORTIMG].keepFold?"checked":""}>
    </label>
    <label class="fn__flex" style="margin-left: 24px">
        ${window.siyuan.languages.export30}
        <span class="fn__space"></span>
        <input id="watermark" class="b3-switch fn__flex-center" type="checkbox" ${window.siyuan.storage[Constants.LOCAL_EXPORTIMG].watermark?"checked":""}>
    </label>
    <span class="fn__flex-1 export-img__space"></span>
    <button disabled class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button disabled class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>
 <div class="fn__loading"><img height="128px" width="128px" src="stage/loading-pure.svg"></div>`,width:isMobile()?"92vw":"990px",height:"70vh"});t.element.setAttribute("data-key",Constants.DIALOG_EXPORTIMAGE);const a=t.element.querySelectorAll(".b3-button");a[0].addEventListener("click",()=>{t.destroy()}),a[1].addEventListener("click",()=>{const r=showMessage(window.siyuan.languages.exporting,0);t.element.querySelector(".b3-dialog__container").style.height="",setStorageVal(Constants.LOCAL_EXPORTIMG,window.siyuan.storage[Constants.LOCAL_EXPORTIMG]),setTimeout(()=>{addScript("/stage/protyle/js/html2canvas.min.js?v=1.4.1","protyleHtml2canvas").then(()=>{window.html2canvas(t.element.querySelector(".b3-dialog__content"),{useCORS:!0}).then(c=>{c.toBlob(d=>{const u=new FormData;u.append("file",d,a[1].getAttribute("data-title")),u.append("type","image/png"),fetchPost("/api/export/exportAsFile",u,g=>{openByMobile(g.data.file)}),hideMessage(r),t.destroy()})})})},Constants.TIMEOUT_LOAD)});const n=t.element.querySelector(".protyle-wysiwyg"),o=t.element.querySelector("#keepFold");o.addEventListener("change",()=>{a[0].setAttribute("disabled","disabled"),a[1].setAttribute("disabled","disabled"),a[1].parentElement.insertAdjacentHTML("afterend",'<div class="fn__loading"><img height="128px" width="128px" src="stage/loading-pure.svg"></div>'),window.siyuan.storage[Constants.LOCAL_EXPORTIMG].keepFold=o.checked,fetchPost("/api/export/exportPreviewHTML",{id:e,keepFold:o.checked,image:!0},r=>{l(r)})});const i=t.element.querySelector("#watermark");i.addEventListener("change",()=>{window.siyuan.storage[Constants.LOCAL_EXPORTIMG].watermark=i.checked,i.checked&&!isPaidUser()&&(i.checked=!1,showMessage(window.siyuan.languages._kernel[214])),s()});const s=()=>{if(!isPaidUser())return;const r=t.element.querySelector(".export-img__watermark");r.innerHTML="",i.checked?window.siyuan.config.export.imageWatermarkDesc?r.innerHTML=window.siyuan.config.export.imageWatermarkDesc:window.siyuan.config.export.imageWatermarkStr&&(window.siyuan.config.export.imageWatermarkStr.startsWith("http")?r.setAttribute("style",`background-image: url(${window.siyuan.config.export.imageWatermarkStr});background-repeat: repeat;position: absolute;top: 0;left: 0;width: 100%;height: 100%;border-radius: var(--b3-border-radius-b);`):addScript("/stage/protyle/js/html2canvas.min.js?v=1.4.1","protyleHtml2canvas").then(()=>{const c=Math.max(t.element.querySelector(".export-img").clientWidth/3,150);r.setAttribute("style",`width: ${c}px;height: ${c}px;display: flex;justify-content: center;align-items: center;color: var(--b3-border-color);font-size: 14px;`),r.innerHTML=`<div style="transform: rotate(-45deg)">${window.siyuan.config.export.imageWatermarkStr}</div>`,window.html2canvas(r,{useCORS:!0,scale:1}).then(d=>{r.innerHTML="",r.setAttribute("style",`background-image: url(${d.toDataURL("image/png")});background-repeat: repeat;position: absolute;top: 0;left: 0;width: 100%;height: 100%;border-radius: var(--b3-border-radius-b);`)})})):r.removeAttribute("style")},l=r=>{n.innerHTML=r.data.content,n.querySelectorAll('[data-type~="mark"], [data-type~="u"], [data-type~="text"], [data-type~="code"], [data-type~="tag"], [data-type~="kbd"]').forEach(c=>{c.childNodes.forEach(d=>{let u="";Array.from(d.textContent).forEach(f=>{u+=`<span style="${c.getAttribute("style")||""};border-radius: 0;padding-left: 0;padding-right: 0;box-shadow: none;border-left:0;border-right:0;border-top:0" data-type="${c.getAttribute("data-type")}">${f}</span>`});const g=document.createElement("template");g.innerHTML=u,d.after(g.content),d.remove()}),c.childNodes.length>0&&(c.setAttribute("style",""),c.setAttribute("data-type",c.getAttribute("data-type").replace(/mark|u|text|code|tag|kbd/g,"")))}),n.setAttribute("data-doc-type",r.data.type||"NodeDocument"),r.data.attrs.memo&&n.setAttribute("memo",r.data.attrs.memo),r.data.attrs.name&&n.setAttribute("name",r.data.attrs.name),r.data.attrs.bookmark&&n.setAttribute("bookmark",r.data.attrs.bookmark),r.data.attrs.alias&&n.setAttribute("alias",r.data.attrs.alias),n.querySelectorAll(".code-block").forEach(c=>{c.setAttribute("linewrap","true")}),processRender(n),highlightRender(n),n.querySelectorAll("table").forEach(c=>{c.clientWidth>c.parentElement.clientWidth&&(c.setAttribute("style",`margin-bottom:${c.parentElement.clientWidth*c.clientHeight/c.clientWidth-c.parentElement.clientHeight+1}px;transform: scale(${c.parentElement.clientWidth/c.clientWidth});transform-origin: top left;`),c.parentElement.style.overflow="hidden")}),n.querySelectorAll(".li > .protyle-action > svg").forEach(c=>{const d=c.firstElementChild.getAttribute("xlink:href"),u=document.querySelectorAll(d);let g="0 0 32 32";d==="#iconDot"&&(g="0 0 20 20"),c.setAttribute("viewBox",g),c.innerHTML=u[u.length-1].innerHTML}),n.querySelectorAll(".img img").forEach(c=>{const d=c.getAttribute("src");d.endsWith(".svg")?fetchGet(c.src,u=>{c.src=`data:image/svg+xml;base64,${btoa(unescape(encodeURIComponent(u)))}`}):d.startsWith("assets/")&&(c.src=location.origin+"/"+d)}),s(),a[0].removeAttribute("disabled"),a[1].removeAttribute("disabled"),t.element.querySelector(".fn__loading").remove()};fetchPost("/api/export/exportPreviewHTML",{id:e,keepFold:o.checked,image:!0},r=>{l(r),a[1].setAttribute("data-title",r.data.name+".png")})},Qr=(e,t,a,n)=>{!Wi()||(!t||t.length===0)&&!a||setTimeout(()=>{e.highlight.markHL.clear(),e.highlight.mark.clear(),e.highlight.ranges=[];let o=!1,i;typeof a=="string"&&Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id='${a}']`)).find(f=>{if(!isInEmbedBlock(f))return i=f,!0});const s=[],l=[];let r=0;const c=document.createTreeWalker(e.wysiwyg.element,NodeFilter.SHOW_TEXT);let d=c.nextNode();for(;d;)s.push(d),r+=d.textContent.length,l.push(r),d=c.nextNode();const u=e.wysiwyg.element.textContent,g=[];if(t&&t.length>0&&t.forEach(f=>{if(!f)return;let p=0,m=0,b=0;for(;(p=u.indexOf(f,p))!==-1;){const w=new Range;m=p+f.length;try{for(;b<s.length&&l[b]<=p;)b++;let y=s[b];for(w.setStart(y,p-(b?l[b-1]:0));b<s.length&&l[b]<m;)b++;y=s[b],w.setEnd(y,m-(b?l[b-1]:0));let _=!1;!o&&i&&i.contains(y)&&(o=!0,_=!0),g.push({range:w,startIndex:p,isCurrent:_})}catch(y){console.error("searchMarkRender error:",y)}p=m}}),!o&&i){const f=u.indexOf(i.textContent);if(f>-1){const p=new Range;let m=0;for(;s.length&&l[m]<=f;)m++;p.setStart(s[m],0),g.push({range:p,startIndex:f,isCurrent:!0})}}g.sort((f,p)=>p.startIndex>f.startIndex?-1:0).forEach((f,p)=>{typeof a=="string"&&f.isCurrent||typeof a=="number"&&a===p?(e.highlight.rangeIndex=p,e.highlight.markHL.add(f.range)):e.highlight.mark.add(f.range),e.highlight.ranges.push(f.range)}),CSS.highlights.set("search-mark-"+e.highlight.styleElement.dataset.uuid,e.highlight.mark),typeof a!="undefined"&&CSS.highlights.set("search-mark-hl-"+e.highlight.styleElement.dataset.uuid,e.highlight.markHL),n&&n()},e.wysiwyg.element.querySelector(".hljs")?Constants.TIMEOUT_TRANSITION:0)},Wi=()=>!!(CSS&&CSS.highlights),ec=e=>{var t,a;if(e){hideElements(["util"],e),isSupportCSSHL()&&(e.highlight.markHL.clear(),e.highlight.mark.clear(),e.highlight.ranges=[],e.highlight.rangeIndex=0),(t=e.observer)==null||t.disconnect(),(a=e.observerLoad)==null||a.disconnect(),e.element.classList.remove("protyle"),e.element.removeAttribute("style"),e.wysiwyg&&(e.wysiwyg.lastHTMLs={}),e.undo&&e.undo.clear();try{e.ws.send("closews",{})}catch(n){setTimeout(()=>{e.ws.send("closews",{})},10240)}e.app.plugins.forEach(n=>{n.eventBus.emit("destroy-protyle",{protyle:e})})}},tc=e=>{if(!e)return"";const t=pathPosix().extname(e).toLowerCase();return Constants.SIYUAN_ASSETS_IMAGE.includes(t)?`<img style="max-height: 100%" src="${e}">`:Constants.SIYUAN_ASSETS_AUDIO.includes(t)?`<audio style="max-width: 100%" controls="controls" src="${e}"></audio>`:Constants.SIYUAN_ASSETS_VIDEO.includes(t)?`<video style="max-width: 100%" controls="controls" src="${e}"></video>`:e},ac=()=>{},nc=(e,t,a,n)=>{let o="";if(Constants.SIYUAN_ASSETS_AUDIO.includes(e))o=`<div data-node-id="${Lute.NewNodeID()}" data-type="NodeAudio" class="iframe" updated="${dayjs().format("YYYYMMDDHHmmss")}"><div class="iframe-content"><audio controls="controls" src="${t}" data-src="${t}"></audio>${Constants.ZWSP}</div><div class="protyle-attr" contenteditable="false">${Constants.ZWSP}</div></div>`;else if(Constants.SIYUAN_ASSETS_IMAGE.includes(e)){let i="";t.startsWith("assets/")||(i='<span class="img__net"><svg><use xlink:href="#iconLanguage"></use></svg></span>'),o=`<span contenteditable="false" data-type="img" class="img"><span> </span><span><span class="protyle-action protyle-icons"><span class="protyle-icon protyle-icon--only"><svg><use xlink:href="#iconMore"></use></svg></span></span><img src="${t}" data-src="${t}" alt="${a}" /><span class="protyle-action__drag"></span>${i}<span class="protyle-action__title"></span></span><span> </span></span>`}else Constants.SIYUAN_ASSETS_VIDEO.includes(e)?o=`<div data-node-id="${Lute.NewNodeID()}" data-type="NodeVideo" class="iframe" updated="${dayjs().format("YYYYMMDDHHmmss")}"><div class="iframe-content">${Constants.ZWSP}<video controls="controls" src="${t}" data-src="${t}"></video><span class="protyle-action__drag" contenteditable="false"></span></div><div class="protyle-attr" contenteditable="false">${Constants.ZWSP}</div></div>`:o=`<span data-type="a" data-href="${t}">${n}</span>`;return o};class sc{constructor(){this.isUploading=!1,this.element=document.createElement("div"),this.element.className="protyle-upload"}}const ji=(e,t)=>{const a=[];let n="",o="";for(let s=t.length,l=0;l<s;l++){const r=t[l];let c=!0;r.name||(n+=`<li>${window.siyuan.languages.nameEmpty}</li>`,c=!1),r.size>e.options.upload.max&&(n+=`<li>${r.name} ${window.siyuan.languages.over} ${e.options.upload.max/1024/1024}M</li>`,c=!1);const d=r.name.lastIndexOf("."),u=d===-1?"":r.name.substr(d),g=d===-1?r.name:e.options.upload.filename(r.name.substr(0,d))+u;e.options.upload.accept&&(e.options.upload.accept.split(",").some(p=>{const m=p.trim();if(m.indexOf(".")===0){if(u.toLowerCase()===m.toLowerCase())return!0}else if(r.type.split("/")[0]===m.split("/")[0])return!0;return!1})||(n+=`<li>${r.name} ${window.siyuan.languages.fileTypeError}</li>`,c=!1)),c&&(a.push(r),o+=`<li>${g} ${window.siyuan.languages.uploading}</li>`)}let i;return(n!==""||o!=="")&&(i=showMessage(`<ul>${n}${o}</ul>`,-1)),{files:a,msgId:i}},qn=(e,t)=>{var a,n;const o=JSON.parse(e);let i="";o.code===1&&(i=`${o.msg}`),o.data.errFiles&&o.data.errFiles.length>0&&(i=`<ul><li>${i}</li>`,o.data.errFiles.forEach(f=>{const p=f.lastIndexOf("."),m=p===-1?f:t.options.upload.filename(f.substr(0,p))+f.substr(p);i+=`<li>${m} ${window.siyuan.languages.uploadError}</li>`}),i+="</ul>"),i&&showMessage(i);let s=!0;const l=getEditorRange(t.wysiwyg.element);l.toString()===""&&l.startContainer.nodeType===3&&t.toolbar.getCurrentType(l).length>0&&(l.setEndAfter(l.startContainer.parentElement),l.collapse(!1));const r=hasClosestBlock(l.startContainer);if(r)if(r.classList.contains("table"))s=!1;else{const f=getContenteditableElement(r);f&&f.textContent!==""&&r.classList.contains("p")&&(s=!1)}let c="";const d=Object.keys(o.data.succMap),u=[];let g=!1;if(d.forEach((f,p)=>{const m=o.data.succMap[f],b=pathPosix().extname(f).toLowerCase(),w=t.options.upload.filename(f),y=w.substring(0,w.length-b.length);g=Constants.SIYUAN_ASSETS_IMAGE.includes(b),u.push({type:Constants.SIYUAN_ASSETS_IMAGE.includes(b)?"image":"file",content:m,name:y}),c+=genAssetHTML(b,m,y,w),!Constants.SIYUAN_ASSETS_AUDIO.includes(b)&&!Constants.SIYUAN_ASSETS_VIDEO.includes(b)&&d.length-1!==p&&(r&&r.classList.contains("table")?c+="<br>":s?c+=`

`:c+=`
`)}),r&&r.classList.contains("av")){const f=[];if(r.querySelectorAll(".av__row--select:not(.av__row--header)").forEach(p=>{p.querySelectorAll(".av__cell").forEach(m=>{getTypeByCellElement(m)==="mAsset"&&f.push(m)})}),f.length===0&&t.wysiwyg.element.querySelectorAll(".av__cell--active").forEach(p=>{getTypeByCellElement(p)==="mAsset"&&f.push(p)}),f.length>0){updateCellsValue(t,r,u,f),(a=document.querySelector(".av__panel"))==null||a.remove();return}else return}if(document.querySelector(".av__panel")){const f=[document.querySelector('.custom-attr__avvalue[data-type="mAsset"][data-active="true"]')];if(f[0]||(f.splice(0,1),t.wysiwyg.element.querySelectorAll(".av__cell--active").forEach(p=>{getTypeByCellElement(p)==="mAsset"&&f.push(p)})),f.length>0){const p=hasClosestBlock(f[0]);if(p){updateCellsValue(t,p,u,f),(n=document.querySelector(".av__panel"))==null||n.remove();return}}else return}insertHTML(c,t,s),setTimeout(()=>{scrollCenter(t,void 0,!1,"smooth")},g?0:Constants.TIMEOUT_LOAD)},Vi=(e,t,a)=>{const n=showMessage(window.siyuan.languages.uploading,0);fetchPost("/api/asset/insertLocalAssets",{assetPaths:e,isUpload:a,id:t.block.rootID},o=>{hideMessage(n);let i="";Object.keys(o.data.succMap).forEach(s=>{o.data.succMap[s].startsWith("file:")&&(i+=s+", ")}),i&&showMessage(window.siyuan.languages.dndFolderTip.replace("${x}",`<b>${i.substring(0,i.length-2)}</b>`)),qn(JSON.stringify(o),t)})},ic=(e,t,a,n)=>{if(!e){const d=new FormData;for(let g=0,f=t.length;g<f;g++)d.append("file[]",t[g]);const u=new XMLHttpRequest;u.open("POST",Constants.UPLOAD_ADDRESS),u.onreadystatechange=()=>{u.readyState===XMLHttpRequest.DONE&&(u.status===200?n(u.responseText):u.status===0?showMessage(window.siyuan.languages.fileTypeError):showMessage(u.responseText),a&&(a.value=""))},u.send(d);return}let o=[];for(let d=0;d<t.length;d++){let u=t[d];u instanceof DataTransferItem&&(u=u.getAsFile()),u.size===0&&u.type===""&&u.name.indexOf(".")===-1?Vi([u.path],e,!1):o.push(u)}if(e.options.upload.handler){const d=e.options.upload.handler(o);if(typeof d=="string"){showMessage(d);return}return}if(!e.options.upload.url||!e.upload){a&&(a.value=""),showMessage("please config: options.upload.url");return}if(e.options.upload.file&&(o=e.options.upload.file(o)),e.options.upload.validate){const d=e.options.upload.validate(o);if(typeof d=="string"){showMessage(d);return}}const i=e.wysiwyg.element,s=ji(e,o);if(s.files.length===0){a&&(a.value="");return}const l=new FormData,r=e.options.upload.extraData;for(const d of Object.keys(r))l.append(d,r[d]);for(let d=0,u=s.files.length;d<u;d++)l.append(e.options.upload.fieldName,s.files[d]);l.append("id",e.block.rootID);const c=new XMLHttpRequest;c.open("POST",e.options.upload.url),e.options.upload.token&&c.setRequestHeader("X-Upload-Token",e.options.upload.token),e.options.upload.withCredentials&&(c.withCredentials=!0),e.upload.isUploading=!0,c.onreadystatechange=()=>{if(c.readyState===XMLHttpRequest.DONE){if(e.upload.isUploading=!1,!document.body.contains(e.element)){destroy(e);return}if(c.status===200)if(hideMessage(s.msgId),e.options.upload.success)e.options.upload.success(i,c.responseText);else if(n)n(c.responseText);else{let d=c.responseText;e.options.upload.format&&(d=e.options.upload.format(t,c.responseText)),qn(d,e)}else c.status===0?showMessage(window.siyuan.languages.fileTypeError):e.options.upload.error?e.options.upload.error(c.responseText):showMessage(c.responseText);a&&(a.value=""),e.upload.element.style.display="none"}},c.upload.onprogress=d=>{if(!d.lengthComputable)return;const u=d.loaded/d.total*100;e.upload.element.style.display="block";const g=e.upload.element;g.style.width=u+"%"},c.send(l)},oc=(e,t,a,n=!1)=>{let o=Lute.UnEscapeHTMLStr(t),i;if(isLocalPath(o)&&!o.startsWith("file://")&&o.indexOf(".pdf")>-1){const s=o.split("/");s.length===3&&s[0]==="assets"&&s[1].endsWith(".pdf")&&/\d{14}-\w{7}/.test(s[2])?(o=`assets/${s[1]}`,i=s[2]):(i=parseInt(getSearch("page",o)),o=o.split("?page")[0])}openByMobile(o)};var Gi=(e,t,a)=>new Promise((n,o)=>{var i=r=>{try{l(a.next(r))}catch(c){o(c)}},s=r=>{try{l(a.throw(r))}catch(c){o(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(i,s);l((a=a.apply(e,t)).next())});const Ki=e=>({id:"export",label:window.siyuan.languages.export,icon:"iconUpload",click(){return Gi(this,null,function*(){Ln(e)})}}),lc=(e,t,a,n,o=!1)=>{},rc=e=>{if(isInAndroid()){window.JSAndroid.writeImageClipboard(e);return}else{const t=document.createElement("canvas"),a=document.createElement("img");a.onload=n=>{t.width=n.target.width,t.height=n.target.height,t.getContext("2d").drawImage(n.target,0,0,n.target.width,n.target.height),t.toBlob(o=>{navigator.clipboard.write([new ClipboardItem({["image/png"]:o})])},"image/png",1)},a.src=e}},cc=e=>{addScript(`${Constants.PROTYLE_CDN}/js/viewerjs/viewer.js?v=1.11.7`,"protyleViewerScript").then(()=>{const t=document.createElement("ul");t.innerHTML=`<li><img src="${e}"></li>`,window.siyuan.viewer=new Viewer(t,{title:[1,(a,n)=>{let o=a.alt;return o||(o=a.src.substring(a.src.lastIndexOf("/")+1)),o=o.substring(0,o.lastIndexOf(".")).replace(/-\d{14}-\w{7}$/,""),`${o} [${n.naturalWidth} \xD7 ${n.naturalHeight}]`}],button:!1,transition:!1,hidden:function(){window.siyuan.viewer.destroy()},toolbar:{zoomIn:!0,zoomOut:!0,oneToOne:!0,reset:!0,prev:!0,play:!0,next:!0,rotateLeft:!0,rotateRight:!0,flipHorizontal:!0,flipVertical:!0,close:function(){window.siyuan.viewer.destroy()}}}),window.siyuan.viewer.show()})},dc=(e,t)=>{addScript(`${Constants.PROTYLE_CDN}/js/viewerjs/viewer.js?v=1.11.7`,"protyleViewerScript").then(()=>{fetchPost("/api/asset/getDocImageAssets",{id:t},a=>{const n=document.createElement("ul");let o="",i=-1;a.data.forEach((s,l)=>{s&&(o+=`<li><img src="${s}"></li>`,i===-1&&(e.endsWith(encodeURI(s))||e.endsWith(s))&&(i=l))}),n.innerHTML=o,window.siyuan.viewer=new Viewer(n,{title:[1,(s,l)=>{let r=s.alt;return r||(r=s.src.substring(s.src.lastIndexOf("/")+1)),r=r.substring(0,r.lastIndexOf(".")).replace(/-\d{14}-\w{7}$/,""),`${r} [${l.naturalWidth} \xD7 ${l.naturalHeight}]`}],button:!1,initialViewIndex:i,transition:!1,hidden:function(){window.siyuan.viewer.destroy()},toolbar:{zoomIn:!0,zoomOut:!0,oneToOne:!0,reset:!0,prev:!0,play:!0,next:!0,rotateLeft:!0,rotateRight:!0,flipHorizontal:!0,flipVertical:!0,close:function(){window.siyuan.viewer.destroy()}}}),window.siyuan.viewer.show()})})},zi=e=>{e.menuElement.querySelector("input").addEventListener("change",t=>{t.target.files.length!==0&&uploadFiles(e.protyle,t.target.files,t.target,a=>{const n=JSON.parse(a),o=[];Object.keys(n.data.succMap).forEach(i=>{o.push({name:i,content:n.data.succMap[i],type:Constants.SIYUAN_ASSETS_IMAGE.includes(pathPosix().extname(n.data.succMap[i]).toLowerCase())?"image":"file"})}),Nt({protyle:e.protyle,cellElements:e.cellElements,addValue:o,blockElement:e.blockElement})})})},Zi=e=>{let t="";return genCellValueByElement("mAsset",e[0]).mAsset.forEach((a,n)=>{let o;a.type==="image"?o=`<span data-type="openAssetItem" class="fn__flex-1 ariaLabel" aria-label="${a.content}">
    <img style="max-height: 180px;max-width: 360px;border-radius: var(--b3-border-radius);margin: 4px 0;" src="${a.content}"/>
</span>`:o=`<span data-type="openAssetItem" class="fn__ellipsis b3-menu__label ariaLabel" aria-label="${escapeAttr(a.content)}" style="max-width: 360px">${a.name||a.content}</span>`,t+=`<button class="b3-menu__item" draggable="true" data-index="${n}" data-name="${escapeAttr(a.name)}" data-type="${a.type}" data-content="${escapeAttr(a.content)}">
<svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>
${o}
<svg class="b3-menu__action" data-type="editAssetItem"><use xlink:href="#iconEdit"></use></svg>
</button>`}),`<div class="b3-menu__items">
    ${t}
    <button data-type="addAssetExist" class="b3-menu__item">
        <svg class="b3-menu__icon"><use xlink:href="#iconImage"></use></svg>
        <span class="b3-menu__label">${window.siyuan.languages.assets}</span>
    </button>
    <button class="b3-menu__item">
        <svg class="b3-menu__icon"><use xlink:href="#iconDownload"></use></svg>
        <span class="b3-menu__label">${window.siyuan.languages.insertAsset}</span> 
        <input multiple class="b3-form__upload" type="file">
    </button>
    <button data-type="addAssetLink" class="b3-menu__item">
        <svg class="b3-menu__icon"><use xlink:href="#iconLink"></use></svg>
        <span class="b3-menu__label">${window.siyuan.languages.link}</span>
    </button>
</div>`},Nt=e=>{const t=e.cellElements[0].dataset.colId,a=[],n=[];let o;e.cellElements.forEach((s,l)=>{var r,c;if(!e.blockElement.contains(s)){const p=hasClosestByClassName(s,"av__row");p&&(s=e.cellElements[l]=e.blockElement.querySelector(`.av__row[data-id="${p.dataset.id}"] .av__cell[data-col-id="${s.dataset.colId}"]`)||e.blockElement.querySelector(`.fn__flex-1[data-col-id="${s.dataset.colId}"]`))}const d=genCellValueByElement(getTypeByCellElement(s)||s.dataset.type,s),u=hasClosestByClassName(s,"av__row").dataset.id,g=JSON.parse(JSON.stringify(d));l===0?(typeof e.removeIndex=="number"?d.mAsset.splice(e.removeIndex,1):((r=e.addValue)==null?void 0:r.length)>0?d.mAsset=d.mAsset.concat(e.addValue):e.updateValue?d.mAsset.find((p,m)=>{if(m===e.updateValue.index)return p.content=e.updateValue.value.content,p.type=e.updateValue.value.type,p.name=e.updateValue.value.name,!0}):((c=e.replaceValue)==null?void 0:c.length)>0&&(d.mAsset=e.replaceValue),o=d.mAsset):d.mAsset=o;const f=e.blockElement.getAttribute("data-av-id");a.push({action:"updateAttrViewCell",id:d.id,keyID:t,rowID:u,avID:f,data:d}),n.push({action:"updateAttrViewCell",id:d.id,keyID:t,rowID:u,avID:f,data:g}),s.classList.contains("custom-attr__avvalue")?s.innerHTML=genAVValueHTML(d):updateAttrViewCellAnimation(s,d)}),transaction(e.protyle,a,n);const i=document.querySelector(".av__panel > .b3-menu");if(i){i.innerHTML=Zi(e.cellElements),zi({protyle:e.protyle,menuElement:i,cellElements:e.cellElements,blockElement:e.blockElement});const s=(e.cellElements[0].classList.contains("custom-attr__avvalue")?e.cellElements[0]:e.protyle.wysiwyg.element.querySelector(`.av__cell[data-id="${e.cellElements[0].dataset.id}"]`)).getBoundingClientRect();setTimeout(()=>{setPosition(i,s.left,s.bottom,s.height)},Constants.TIMEOUT_LOAD)}},uc=e=>{const t=e.content,a=e.type,n=new Menu("av-asset-edit",()=>{!s[1]&&s[0].value===t||s[1]&&s[0].value===t&&s[1].value===e.name||Nt({protyle:e.protyle,cellElements:e.cellElements,blockElement:e.blockElement,updateValue:{index:e.index,value:{content:s[0].value,name:s[1]?s[1].value:"",type:a}}})});if(n.isOpen)return;a==="file"?(n.addItem({id:"linkAndTitle",iconHTML:"",type:"readonly",label:`<div class="fn__flex">
    <span class="fn__flex-center">${window.siyuan.languages.link}</span>
    <span class="fn__space"></span>
    <span data-action="copy" class="block__icon block__icon--show b3-tooltips b3-tooltips__e fn__flex-center" aria-label="${window.siyuan.languages.copy}">
        <svg><use xlink:href="#iconCopy"></use></svg>
    </span>   
</div>
<textarea rows="1" style="margin:4px 0;width: ${isMobile()?"200":"360"}px;resize: vertical;" class="b3-text-field"></textarea>
<div class="fn__hr"></div>
<div class="fn__flex">
    <span class="fn__flex-center">${window.siyuan.languages.title}</span>
    <span class="fn__space"></span>
    <span data-action="copy" class="block__icon block__icon--show b3-tooltips b3-tooltips__e fn__flex-center" aria-label="${window.siyuan.languages.copy}">
        <svg><use xlink:href="#iconCopy"></use></svg>
    </span>   
</div>
<textarea style="width: ${isMobile()?"200":"360"}px;margin: 4px 0;resize: vertical;" rows="1" class="b3-text-field"></textarea>`,bind(l){l.addEventListener("click",r=>{let c=r.target;for(;c;){if(c.dataset.action==="copy"){writeText(c.parentElement.nextElementSibling.value),showMessage(window.siyuan.languages.copied);break}c=c.parentElement}})}}),n.addSeparator({id:"separator_1"}),n.addItem({id:"copy",label:window.siyuan.languages.copy,icon:"iconCopy",click(){writeText(`[${s[1].value||s[0].value}](${s[0].value})`)}})):(n.addItem({id:"link",iconHTML:"",type:"readonly",label:`<div class="fn__flex">
    <span class="fn__flex-center">${window.siyuan.languages.link}</span>
    <span class="fn__space"></span>
    <span data-action="copy" class="block__icon block__icon--show b3-tooltips b3-tooltips__e fn__flex-center" aria-label="${window.siyuan.languages.copy}">
        <svg><use xlink:href="#iconCopy"></use></svg>
    </span>   
</div>
<textarea rows="1" style="margin:4px 0;width: ${isMobile()?"200":"360"}px;resize: vertical;" class="b3-text-field"></textarea>`,bind(l){l.addEventListener("click",r=>{let c=r.target;for(;c;){if(c.dataset.action==="copy"){writeText(c.parentElement.nextElementSibling.value),showMessage(window.siyuan.languages.copied);break}c=c.parentElement}})}}),n.addSeparator({id:"separator_1"}),n.addItem({id:"copy",label:window.siyuan.languages.copy,icon:"iconCopy",click(){writeText(`![](${t.replace(/%20/g," ")})`)}}),n.addItem({id:"copyAsPNG",label:window.siyuan.languages.copyAsPNG,icon:"iconImage",click(){copyPNGByLink(t)}})),n.addItem({id:"delete",icon:"iconTrashcan",label:window.siyuan.languages.delete,click(){Nt({protyle:e.protyle,cellElements:e.cellElements,blockElement:e.blockElement,removeIndex:e.index})}}),t!=null&&t.startsWith("assets/")&&n.addItem({id:"rename",label:window.siyuan.languages.rename,icon:"iconEdit",click(){var l;renameAsset(t),(l=document.querySelector(".av__panel"))==null||l.remove()}});const o=openMenu(e.protyle?e.protyle.app:window.siyuan.ws.app,t,!0,!1);(a!=="file"||o.length>0)&&n.addSeparator({id:"separator_2"}),a!=="file"&&n.addItem({id:"cardPreview",icon:"iconPreview",label:window.siyuan.languages.cardPreview,click(){previewImage(t)}}),o.length>0&&window.siyuan.menus.menu.append(new MenuItem({id:"openBy",label:window.siyuan.languages.openBy,icon:"iconOpen",submenu:o}).element),t!=null&&t.startsWith("assets/")&&window.siyuan.menus.menu.append(new MenuItem(exportAsset(t)).element);const i=e.rect;n.open({x:i.right,y:i.top,w:i.width,h:i.height});const s=n.element.querySelectorAll("textarea");s[0].value=t,s[0].focus(),s[0].select(),s.length>1&&(s[1].value=e.name)},fc=(e,t,a,n)=>{const o=new Menu("av-asset-link",()=>{const s=o.element.querySelectorAll("textarea");!s[0].value&&!s[1].value||Nt({protyle:e,cellElements:t,blockElement:n,addValue:[{type:"file",name:s[1].value,content:s[0].value}]})});if(o.isOpen)return;o.addItem({iconHTML:"",type:"readonly",label:`${window.siyuan.languages.link}
<textarea rows="1" style="margin:4px 0;width: ${isMobile()?"200":"360"}px;resize: vertical;" class="b3-text-field"></textarea>
<div class="fn__hr"></div>
${window.siyuan.languages.title}
<textarea style="width: ${isMobile()?"200":"360"}px;margin: 4px 0;resize: vertical;" rows="1" class="b3-text-field"></textarea>`});const i=a.getBoundingClientRect();o.open({x:i.right,y:i.bottom,w:a.parentElement.clientWidth+8,h:i.height}),o.element.querySelector("textarea").focus()},gc=(e,t,a)=>{const n=showMessage(window.siyuan.languages.uploading,0);fetchPost("/api/asset/insertLocalAssets",{assetPaths:e,isUpload:!0,id:t.block.rootID},o=>{const i=hasClosestBlock(a);if(i){hideMessage(n);const s=[];Object.keys(o.data.succMap).forEach(l=>{const r=pathPosix().extname(l).toLowerCase(),c=l.substring(0,l.length-r.length);Constants.SIYUAN_ASSETS_IMAGE.includes(r)?s.push({type:"image",name:c,content:o.data.succMap[l]}):s.push({type:"file",name:c,content:o.data.succMap[l]})}),Nt({protyle:t,blockElement:i,cellElements:[a],addValue:s})}})},Xi=e=>{var t,a,n,o;let i="";switch(e.type){case"block":e!=null&&e.isDetached?i=`<span data-id="${(t=e.block)==null?void 0:t.id}">${((a=e.block)==null?void 0:a.content)||window.siyuan.languages.untitled}</span>`:i=`<span data-type="block-ref" data-id="${(n=e.block)==null?void 0:n.id}" data-subtype="s" class="av__celltext--ref">${((o=e.block)==null?void 0:o.content)||window.siyuan.languages.untitled}</span>`;break;case"text":i=e.text.content;break;case"number":i=e.number.formattedContent||e.number.content.toString();break;case"date":e[e.type]&&e[e.type].isNotEmpty&&(i=dayjs(e[e.type].content).format(e[e.type].isNotTime?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")),e[e.type]&&e[e.type].hasEndDate&&e[e.type].isNotEmpty&&e[e.type].isNotEmpty2&&(i+=`<svg class="av__cellicon"><use xlink:href="#iconForward"></use></svg>${dayjs(e[e.type].content2).format(e[e.type].isNotTime?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")}`),i&&(i=`<span class="av__celltext">${i}</span>`);break;case"url":i=e.url.content?`<a class="fn__a" href="${e.url.content}" target="_blank">${e.url.content}</a>`:"";break;case"phone":i=e.phone.content?`<a class="fn__a" href="tel:${e.phone.content}" target="_blank">${e.phone.content}</a>`:"";break;case"email":i=e.email.content?`<a class="fn__a" href="mailto:${e.email.content}" target="_blank">${e.email.content}</a>`:"";break}return i},Un=e=>{var t,a,n,o,i,s;let l="";switch(e.type){case"block":l=`<input value="${escapeAttr(e.block.content)}" type="text" class="b3-text-field b3-text-field--text fn__flex-1" placeholder="${window.siyuan.languages.empty}">`;break;case"text":l=`<textarea style="resize: vertical" rows="${e.text.content.split(`
`).length}" class="b3-text-field b3-text-field--text fn__flex-1" placeholder="${window.siyuan.languages.empty}">${e.text.content}</textarea>`;break;case"number":l=`<input value="${e.number.isNotEmpty?e.number.content:""}" type="number" class="b3-text-field b3-text-field--text fn__flex-1" placeholder="${window.siyuan.languages.empty}">
<span class="fn__space"></span><span class="fn__flex-center ft__on-surface b3-tooltips__w b3-tooltips" aria-label="${window.siyuan.languages.format}">${e.number.formattedContent}</span><span class="fn__space"></span>`;break;case"mSelect":case"select":(t=e.mSelect)==null||t.forEach((r,c)=>{e.type==="select"&&c>0||(l+=`<span class="b3-chip b3-chip--middle" style="background-color:var(--b3-font-background${r.color});color:var(--b3-font-color${r.color})">${escapeHtml(r.content)}</span>`)});break;case"mAsset":(a=e.mAsset)==null||a.forEach(r=>{r.type==="image"?l+=`<img class="av__cellassetimg ariaLabel" aria-label="${r.content}" src="${r.content}">`:l+=`<span class="b3-chip b3-chip--middle av__celltext--url ariaLabel" aria-label="${escapeAttr(r.content)}" data-name="${escapeAttr(r.name)}" data-url="${escapeAttr(r.content)}">${r.name||r.content}</span>`});break;case"date":l=`<span class="av__celltext" data-value='${JSON.stringify(e[e.type])}' placeholder="${window.siyuan.languages.empty}">`,e[e.type]&&e[e.type].isNotEmpty&&(l+=dayjs(e[e.type].content).format(e[e.type].isNotTime?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")),e[e.type]&&e[e.type].hasEndDate&&e[e.type].isNotEmpty&&e[e.type].isNotEmpty2&&(l+=`<svg class="av__cellicon"><use xlink:href="#iconForward"></use></svg>${dayjs(e[e.type].content2).format(e[e.type].isNotTime?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")}`),l+="</span>";break;case"created":case"updated":e[e.type].isNotEmpty&&(l=`<span data-content="${e[e.type].content}">${dayjs(e[e.type].content).format("YYYY-MM-DD HH:mm")}</span>`);break;case"url":l=`<input value="${e.url.content}" class="b3-text-field b3-text-field--text fn__flex-1" placeholder="${window.siyuan.languages.empty}">
<span class="fn__space"></span>
<a ${e.url.content?`href="${e.url.content}"`:""} target="_blank" aria-label="${window.siyuan.languages.openBy}" class="block__icon block__icon--show fn__flex-center b3-tooltips__w b3-tooltips"><svg><use xlink:href="#iconLink"></use></svg></a>`;break;case"phone":l=`<input value="${e.phone.content}" class="b3-text-field b3-text-field--text fn__flex-1" placeholder="${window.siyuan.languages.empty}">
<span class="fn__space"></span>
<a ${e.phone.content?`href="tel:${e.phone.content}"`:""} target="_blank" aria-label="${window.siyuan.languages.openBy}" class="block__icon block__icon--show fn__flex-center b3-tooltips__w b3-tooltips"><svg><use xlink:href="#iconPhone"></use></svg></a>`;break;case"checkbox":l=`<svg class="av__checkbox"><use xlink:href="#icon${e.checkbox.checked?"Check":"Uncheck"}"></use></svg>`;break;case"template":l=`<div class="fn__flex-1" placeholder="${window.siyuan.languages.empty}">${e.template.content}</div>`;break;case"email":l=`<input value="${e.email.content}" class="b3-text-field b3-text-field--text fn__flex-1" placeholder="${window.siyuan.languages.empty}">
<span class="fn__space"></span>
<a ${e.email.content?`href="mailto:${e.email.content}"`:""} target="_blank" aria-label="${window.siyuan.languages.openBy}" class="block__icon block__icon--show fn__flex-center b3-tooltips__w b3-tooltips"><svg><use xlink:href="#iconEmail"></use></svg></a>`;break;case"relation":(o=(n=e==null?void 0:e.relation)==null?void 0:n.contents)==null||o.forEach(r=>{var c;r&&r.block&&(r!=null&&r.isDetached?l+=`<span class="av__cell--relation"><span>\u2796 </span><span class="av__celltext" data-id="${(c=r.block)==null?void 0:c.id}">${Lute.EscapeHTMLStr(r.block.content||window.siyuan.languages.untitled)}</span></span>`:l+=`<span class="av__cell--relation" data-block-id="${r.block.id}"><span class="b3-menu__avemoji" data-unicode="${r.block.icon||""}">${unicode2Emoji(r.block.icon||window.siyuan.storage[Constants.LOCAL_IMAGES].file)}</span><span data-type="block-ref" data-id="${r.block.id}" data-subtype="s" class="av__celltext av__celltext--ref">${Lute.EscapeHTMLStr(r.block.content||window.siyuan.languages.untitled)}</span></span>`)}),l&&l.endsWith(", ")&&(l=l.substring(0,l.length-2));break;case"rollup":(s=(i=e==null?void 0:e.rollup)==null?void 0:i.contents)==null||s.forEach(r=>{const c=["select","mSelect","mAsset","checkbox","relation"].includes(r.type)?Un(r):Xi(r);c&&(l+=c+",&nbsp;")}),l&&l.endsWith(",&nbsp;")&&(l=l.substring(0,l.length-7));break}return l},pc=(e,t,a,n)=>{fetchPost("/api/av/getAttributeViewKeys",{id:t},o=>{let i="";if(o.data.forEach(s=>{var l;let r=`<div class="custom-attr__avheader">
    <div class="block__logo popover__block" style="max-width:calc(100% - 40px)" data-id='${JSON.stringify(s.blockIDs)}'>
        <svg class="block__logoicon"><use xlink:href="#iconDatabase"></use></svg>
        <span class="fn__ellipsis">${s.avName||window.siyuan.languages.database}</span>
    </div>
    <div class="fn__flex-1"></div>
    <span data-type="remove" class="block__icon block__icon--warning block__icon--show b3-tooltips__w b3-tooltips" aria-label="${window.siyuan.languages.removeAV}"><svg><use xlink:href="#iconTrashcan"></use></svg></span>
</div>`;(l=s.keyValues)==null||l.forEach(c=>{var d;r+=`<div class="block__icons av__row" data-id="${t}" data-col-id="${c.key.id}">
    <div class="block__icon" draggable="true"><svg><use xlink:href="#iconDrag"></use></svg></div>
    <div class="block__logo ariaLabel fn__pointer" data-type="editCol" data-position="parentW" aria-label="${escapeAriaLabel(c.key.name)}<div class='ft__on-surface'>${escapeAriaLabel(c.key.desc)}</div>">
        ${c.key.icon?unicode2Emoji(c.key.icon,"block__logoicon",!0):`<svg class="block__logoicon"><use xlink:href="#${getColIconByType(c.key.type)}"></use></svg>`}
        <span>${escapeHtml(c.key.name)}</span>
    </div>
    <div data-av-id="${s.avID}" data-col-id="${c.values[0].keyID}" data-block-id="${c.values[0].blockID}" data-id="${c.values[0].id}" data-type="${c.values[0].type}" 
data-options="${(d=c.key)!=null&&d.options?escapeAttr(JSON.stringify(c.key.options)):"[]"}" 
${["text","number","date","url","phone","template","email"].includes(c.values[0].type)?"":`placeholder="${window.siyuan.languages.empty}"`}  
class="fn__flex-1 fn__flex${["url","text","number","email","phone","block"].includes(c.values[0].type)?"":" custom-attr__avvalue"}${["created","updated"].includes(c.values[0].type)?" custom-attr__avvalue--readonly":""}">${Un(c.values[0])}</div>
</div>`}),r+=`<div class="fn__hr"></div>
<button data-type="addColumn" class="b3-button b3-button--cancel"><svg><use xlink:href="#iconAdd"></use></svg>${window.siyuan.languages.newCol}</button>
<div class="fn__hr--b"></div><div class="fn__hr--b"></div>`,i+=`<div data-av-id="${s.avID}" data-node-id="${t}" data-type="NodeAttributeView">${r}</div>`,e.innerHTML&&(e.querySelector(`div[data-node-id="${t}"][data-av-id="${s.avID}"]`).innerHTML=r)}),e.innerHTML===""){let s;e.addEventListener("dragstart",r=>{const c=r.target;window.siyuan.dragElement=c.parentElement,window.siyuan.dragElement.style.opacity=".1",s=hasClosestBlock(window.siyuan.dragElement);const d=document.createElement("div");d.className="block__icons",d.innerHTML=c.nextElementSibling.outerHTML,d.setAttribute("style","width: 160px;position:fixed;opacity:.1;"),document.body.append(d),r.dataTransfer.setDragImage(d,0,0),setTimeout(()=>{d.remove()})}),e.addEventListener("drop",r=>{var c,d;if(l=0,a.disabled){r.preventDefault(),r.stopPropagation();return}const u=e.querySelector(".dragover__bottom, .dragover__top");if(u&&s){const g=u.classList.contains("dragover__bottom"),f=g?u.dataset.colId:(c=u.previousElementSibling)==null?void 0:c.getAttribute("data-col-id"),p=(d=window.siyuan.dragElement.previousElementSibling)==null?void 0:d.getAttribute("data-col-id");f!==p&&f!==window.siyuan.dragElement.dataset.colId&&(transaction(a,[{action:"sortAttrViewKey",avID:s.dataset.avId,previousID:f,id:window.siyuan.dragElement.dataset.colId}],[{action:"sortAttrViewKey",avID:s.dataset.avId,previousID:p,id:t}]),g?u.after(window.siyuan.dragElement):u.before(window.siyuan.dragElement)),u.classList.remove("dragover__bottom","dragover__top")}else if(!window.siyuan.dragElement&&r.dataTransfer.types[0]==="Files"){const g=e.querySelector(".custom-attr__avvalue--active");if(g&&r.dataTransfer.types[0]==="Files"&&!isBrowser()){const f=[];for(let p=0;p<r.dataTransfer.files.length;p++)f.push(webUtils.getPathForFile(r.dataTransfer.files[p]));dragUpload(f,a,g)}}window.siyuan.dragElement&&(window.siyuan.dragElement.style.opacity="",window.siyuan.dragElement=void 0)}),e.addEventListener("dragover",r=>{const c=r.target;let d;if(r.dataTransfer.types.includes("Files")){e.querySelectorAll(".custom-attr__avvalue--active").forEach(f=>{f.classList.remove("custom-attr__avvalue--active")}),d=hasClosestByClassName(c,"custom-attr__avvalue"),d&&d.getAttribute("data-type")==="mAsset"&&(d.classList.add("custom-attr__avvalue--active"),r.preventDefault());return}if(d=hasClosestByClassName(c,"av__row"),d||(d=hasClosestByClassName(document.elementFromPoint(r.clientX,r.clientY-1),"av__row")),!d||d.isSameNode(window.siyuan.dragElement)||!s)return;const u=hasClosestBlock(d);if(!u||!u.isSameNode(s))return;r.preventDefault();const g=d.getBoundingClientRect();e.querySelectorAll(".dragover__bottom, .dragover__top").forEach(f=>{f.classList.remove("dragover__bottom","dragover__top")}),r.clientY>g.top+g.height/2?d.classList.add("dragover__bottom"):d.classList.add("dragover__top")});let l=0;e.addEventListener("dragleave",()=>{l--,l===0&&e.querySelectorAll(".dragover__bottom, .dragover__top").forEach(r=>{r.classList.remove("dragover__bottom","dragover__top")})}),e.addEventListener("dragenter",r=>{r.preventDefault(),l++}),e.addEventListener("dragend",()=>{window.siyuan.dragElement&&(window.siyuan.dragElement.style.opacity="",window.siyuan.dragElement=void 0)}),e.addEventListener("paste",r=>{var c;const d=r.clipboardData.files;if(document.querySelector(".av__panel .b3-form__upload"))if(d&&d.length>0)uploadFiles(a,d);else{const u=r.clipboardData.getData("text/plain"),g=r.target,f=hasClosestBlock(g),p=hasClosestByAttribute(g,"data-type","mAsset");f&&p&&u&&(updateCellsValue(a,f,u,[p],void 0,a.lute.Md2BlockDOM(u)),(c=document.querySelector(".av__panel"))==null||c.remove())}}),e.addEventListener("click",r=>{const c=hasClosestByAttribute(r.target,"data-type","remove");if(c){const d=hasClosestBlock(c);d&&(transaction(a,[{action:"removeAttrViewBlock",srcIDs:[t],avID:d.dataset.avId},{action:"doUpdateUpdated",id:t,data:dayjs().format("YYYYMMDDHHmmss")}]),d.remove(),e.innerHTML||window.siyuan.dialogs.find(u=>{if(u.element.getAttribute("data-key")===Constants.DIALOG_ATTR)return u.destroy(),!0})),r.stopPropagation();return}Fn(a,e,r)}),e.addEventListener("contextmenu",r=>{Fn(a,e,r)}),e.innerHTML=i}e.querySelectorAll(".b3-text-field--text").forEach(s=>{s.addEventListener("change",()=>{let l;const r=s.parentElement.dataset.type;if(["url","text","email","phone"].includes(r)){if(l={[r]:{content:s.value}},r!=="text"){const c=s.parentElement.querySelector("a");s.value?c.setAttribute("href",(r==="url"?"":r==="email"?"mailto:":"tel:")+s.value):c.removeAttribute("href")}}else r==="number"?s.value==="undefined"||!s.value?l={number:{content:null,isNotEmpty:!1}}:l={number:{content:parseFloat(s.value)||0,isNotEmpty:!0}}:r==="block"&&(l={block:{content:s.value,id:s.parentElement.dataset.blockId},isDetached:!1});fetchPost("/api/av/setAttributeViewBlockAttr",{avID:s.parentElement.dataset.avId,keyID:s.parentElement.dataset.colId,rowID:s.parentElement.dataset.blockId,value:l},c=>{r==="number"?s.parentElement.querySelector(".fn__flex-center").textContent=c.data.value.number.formattedContent:r==="block"&&!s.value&&(s.value=c.data.value.block.content)})})}),n&&n(e)})},Fn=(e,t,a)=>{let n=a.target;const o=hasClosestBlock(n);if(o)for(;n&&!t.isSameNode(n);){const i=n.getAttribute("data-type");if(n.classList.contains("av__celltext--url")||n.classList.contains("av__cellassetimg")){if(a.type==="contextmenu"||!n.dataset.url&&n.tagName!=="IMG"){let s=0;Array.from(n.parentElement.children).find((l,r)=>{if(l.isSameNode(n))return s=r,!0}),editAssetItem({protyle:e,cellElements:[n.parentElement],blockElement:hasClosestBlock(n),content:n.tagName==="IMG"?n.getAttribute("src"):n.getAttribute("data-url"),type:n.tagName==="IMG"?"image":"file",name:n.tagName==="IMG"?"":n.getAttribute("data-name"),index:s,rect:n.getBoundingClientRect()})}else n.tagName==="IMG"?previewImage(n.getAttribute("src")):openLink(e,n.dataset.url,a,a.ctrlKey||a.metaKey);a.stopPropagation(),a.preventDefault();break}else if(i==="date"){popTextCell(e,[n],"date"),a.stopPropagation(),a.preventDefault();break}else if(i==="select"||i==="mSelect"){popTextCell(e,[n],n.getAttribute("data-type")),a.stopPropagation(),a.preventDefault();break}else if(i==="mAsset"){t.querySelectorAll('.custom-attr__avvalue[data-type="mAsset"]').forEach(s=>{s.removeAttribute("data-active")}),n.setAttribute("data-active","true"),n.focus(),popTextCell(e,[n],"mAsset"),a.stopPropagation(),a.preventDefault();break}else if(i==="checkbox"){popTextCell(e,[n],"checkbox"),a.stopPropagation(),a.preventDefault();break}else if(i==="relation"){popTextCell(e,[n],"relation"),a.stopPropagation(),a.preventDefault();break}else if(i==="template"){popTextCell(e,[n],"template"),a.stopPropagation(),a.preventDefault();break}else if(i==="rollup"){popTextCell(e,[n],"rollup"),a.stopPropagation(),a.preventDefault();break}else if(i==="addColumn"){const s=o.querySelectorAll(".av__row"),l=addCol(e,o,s[s.length-1].getAttribute("data-col-id")),r=n.getBoundingClientRect();l.open({x:r.left,y:r.bottom,h:r.height}),a.stopPropagation(),a.preventDefault();break}else if(i==="editCol"){openMenuPanel({protyle:e,blockElement:o,type:"edit",colId:n.parentElement.dataset.colId}),a.stopPropagation(),a.preventDefault();break}n=n.parentElement}};var Ji=(e,t,a)=>new Promise((n,o)=>{var i=r=>{try{l(a.next(r))}catch(c){o(c)}},s=r=>{try{l(a.throw(r))}catch(c){o(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(i,s);l((a=a.apply(e,t)).next())});const mc=(e,t,a)=>{if(!e){t.innerHTML="";return}fetchPost("/api/template/render",{id:a,path:e,preview:!0},n=>{t.innerHTML=`<div class="protyle-wysiwyg" style="padding: 8px">${n.data.content.replace(/contenteditable="true"/g,"")}</div>`})},Yn=(e,t,a=!0)=>{if(!e.getAttribute("data-type")||!t.getAttribute("data-type"))return!1;e.setAttribute("data-type",e.getAttribute("data-type").replace("search-mark","").trim()),t.setAttribute("data-type",t.getAttribute("data-type").replace("search-mark","").trim());const n=e.attributes;let o=!0;for(let i=0;i<n.length;i++)t.getAttribute(n[i].name)!==n[i].value&&(o=!1);return o&&(a?e.innerHTML=e.innerHTML+t.innerHTML:e.innerHTML=t.innerHTML+e.innerHTML,t.remove()),o},bc=e=>{let t=e.previousSibling;for(;t&&t.nodeType!==3&&Yn(e,t,!1);)t=e.previousSibling;let a=e.nextSibling;for(;a&&a.nodeType!==3&&Yn(e,a);)a=e.nextSibling;(e.getAttribute("data-type")||"").includes("search-mark")&&e.setAttribute("data-type",e.getAttribute("data-type").replace("search-mark","").trim())},Qi=(e,t,a)=>{const n=e.getAttribute("data-type").split(" ");if(n.length===1){const o=e.parentElement;e.outerHTML=e.innerHTML.replace(S.ZWSP,"")+"<wbr>",a&&Ta(o,a)}else n.find((o,i)=>{if(t===o)return n.splice(i,1),!0}),e.setAttribute("data-type",n.join(" ")),t==="a"?e.removeAttribute("data-href"):t==="file-annotation-ref"?e.removeAttribute("data-id"):t==="block-ref"&&(e.removeAttribute("data-id"),e.removeAttribute("data-subtype")),a&&(a.selectNodeContents(e),a.collapse(!1),Ae(a))},yc=e=>{const t=[{name:"block-ref",hotkey:window.siyuan.config.keymap.editor.insert.ref.custom,lang:"ref",icon:"iconRef",tipPosition:"ne"},{name:"a",hotkey:window.siyuan.config.keymap.editor.insert.link.custom,lang:"link",icon:"iconLink",tipPosition:"n"},{name:"strong",lang:"bold",hotkey:window.siyuan.config.keymap.editor.insert.bold.custom,icon:"iconBold",tipPosition:"n"},{name:"em",lang:"italic",hotkey:window.siyuan.config.keymap.editor.insert.italic.custom,icon:"iconItalic",tipPosition:"n"},{name:"u",lang:"underline",hotkey:window.siyuan.config.keymap.editor.insert.underline.custom,icon:"iconUnderline",tipPosition:"n"},{name:"s",lang:"strike",hotkey:window.siyuan.config.keymap.editor.insert.strike.custom,icon:"iconStrike",tipPosition:"n"},{name:"mark",lang:"mark",hotkey:window.siyuan.config.keymap.editor.insert.mark.custom,icon:"iconMark",tipPosition:"n"},{name:"sup",lang:"sup",hotkey:window.siyuan.config.keymap.editor.insert.sup.custom,icon:"iconSup",tipPosition:"n"},{name:"sub",lang:"sub",hotkey:window.siyuan.config.keymap.editor.insert.sub.custom,icon:"iconSub",tipPosition:"n"},{name:"kbd",lang:"kbd",hotkey:window.siyuan.config.keymap.editor.insert.kbd.custom,icon:"iconKeymap",tipPosition:"n"},{name:"tag",lang:"tag",hotkey:window.siyuan.config.keymap.editor.insert.tag.custom,icon:"iconTags",tipPosition:"n"},{name:"code",lang:"inline-code",hotkey:window.siyuan.config.keymap.editor.insert["inline-code"].custom,icon:"iconInlineCode",tipPosition:"n"},{name:"inline-math",lang:"inline-math",hotkey:window.siyuan.config.keymap.editor.insert["inline-math"].custom,icon:"iconMath",tipPosition:"n"},{name:"inline-memo",lang:"memo",hotkey:window.siyuan.config.keymap.editor.insert.memo.custom,icon:"iconM",tipPosition:"n"},{name:"text",lang:"appearance",hotkey:window.siyuan.config.keymap.editor.insert.appearance.custom,icon:"iconFont",tipPosition:"n"},{name:"clear",lang:"clearInline",hotkey:window.siyuan.config.keymap.editor.insert.clearInline.custom,icon:"iconClear",tipPosition:"n"},{name:"|"}],a=[];return e.forEach(n=>{let o=n;t.find(i=>{if(typeof n=="string"&&i.name===n)return o=i,!0;if(typeof n=="object"&&i.name===n.name)return o=Object.assign({},i,n),!0}),a.push(o)}),a},hc=(e,t)=>Ji(void 0,null,function*(){let a="";for(let n=0;n<e.length;n++){const o=e[n];if(e.length>1&&(a+="* "),t==="ref"){const i=yield fetchSyncPost("/api/block/getRefText",{id:o});a+=`((${o} '${i.data}'))`}else if(t==="blockEmbed")a+=`{{select * from blocks where id='${o}'}}`;else if(t==="protocol")a+=`siyuan://blocks/${o}`;else if(t==="protocolMd"){const i=yield fetchSyncPost("/api/block/getRefText",{id:o});a+=`[${i.data}](siyuan://blocks/${o})`}else if(t==="hPath"){const i=yield fetchSyncPost("/api/filetree/getHPathByID",{id:o});a+=i.data}else t==="id"&&(a+=o);e.length>1&&n!==e.length-1&&(a+=`
`)}writeText(a)});var eo=(e,t,a)=>new Promise((n,o)=>{var i=r=>{try{l(a.next(r))}catch(c){o(c)}},s=r=>{try{l(a.throw(r))}catch(c){o(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(i,s);l((a=a.apply(e,t)).next())});const Wn=(e,t)=>{e.addEventListener("change",()=>{fetchPost("/api/attr/setBlockAttrs",{id:t,attrs:{[e.dataset.name]:e.value}})})},wc=e=>{const t=e.getAttribute("data-node-id"),a=getEditorRange(e),n=e.getAttribute(Constants.CUSTOM_REMINDER_WECHAT);let o="";n&&(o=dayjs(n).format("YYYY-MM-DD HH:mm"));const i=new Dialog({width:isMobile()?"92vw":"50vw",title:window.siyuan.languages.wechatReminder,content:`<div class="b3-dialog__content custom-attr">
    <div class="fn__flex">
        <span class="ft__on-surface fn__flex-center" style="text-align: right;white-space: nowrap;width: 100px">${window.siyuan.languages.notifyTime}</span>
        <div class="fn__space"></div>
        <input class="b3-text-field fn__flex-1" type="datetime-local" max="9999-12-31 23:59" value="${o}">
    </div>
    <div class="b3-label__text" style="text-align: center">${window.siyuan.languages.wechatTip}</div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.remove}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,destroyCallback(){focusByRange(a)}});i.element.setAttribute("data-key",Constants.DIALOG_WECHATREMINDER);const s=i.element.querySelectorAll(".b3-button");s[0].addEventListener("click",()=>{i.destroy()}),s[1].addEventListener("click",()=>{s[1].getAttribute("disabled")||(s[1].setAttribute("disabled","disabled"),fetchPost("/api/block/setBlockReminder",{id:t,timed:"0"},()=>{e.removeAttribute(Constants.CUSTOM_REMINDER_WECHAT),i.destroy()}))}),s[2].addEventListener("click",()=>{const l=i.element.querySelector("input").value;if(l){if(new Date(l)<=new Date){showMessage(window.siyuan.languages.reminderTip);return}if(s[2].getAttribute("disabled"))return;s[2].setAttribute("disabled","disabled");const r=dayjs(l).format("YYYYMMDDHHmmss");fetchPost("/api/block/setBlockReminder",{id:t,timed:r},()=>{e.setAttribute(Constants.CUSTOM_REMINDER_WECHAT,r),i.destroy()})}else showMessage(window.siyuan.languages.notEmpty)})},_c=e=>{fetchPost("/api/block/getDocInfo",{id:e.block.rootID},t=>{const a=t.data.ial[Constants.CUSTOM_REMINDER_WECHAT];let n="";a&&(n=dayjs(a).format("YYYY-MM-DD HH:mm"));const o=new Dialog({width:isMobile()?"92vw":"50vw",title:window.siyuan.languages.wechatReminder,content:`<div class="b3-dialog__content custom-attr">
    <div class="fn__flex">
        <span class="ft__on-surface fn__flex-center" style="text-align: right;white-space: nowrap;width: 100px">${window.siyuan.languages.notifyTime}</span>
        <div class="fn__space"></div>
        <input class="b3-text-field fn__flex-1" type="datetime-local" max="9999-12-31 23:59" value="${n}">
    </div>
    <div class="b3-label__text" style="text-align: center">${window.siyuan.languages.wechatTip}</div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.remove}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`});o.element.setAttribute("data-key",Constants.DIALOG_WECHATREMINDER);const i=o.element.querySelectorAll(".b3-button");i[0].addEventListener("click",()=>{o.destroy()}),i[1].addEventListener("click",()=>{fetchPost("/api/block/setBlockReminder",{id:e.block.rootID,timed:"0"},()=>{o.destroy()})}),i[2].addEventListener("click",()=>{const s=o.element.querySelector("input").value;if(s){if(new Date(s)<=new Date){showMessage(window.siyuan.languages.reminderTip);return}fetchPost("/api/block/setBlockReminder",{id:e.block.rootID,timed:dayjs(s).format("YYYYMMDDHHmmss")},()=>{o.destroy()})}else showMessage(window.siyuan.languages.notEmpty)})})},to=(e,t="bookmark",a)=>{let n="",o="",i=!1;const s=getSelection().rangeCount>0?getSelection().getRangeAt(0):null;Object.keys(e).forEach(r=>{Constants.CUSTOM_RIFF_DECKS===r||r.startsWith("custom-sy-")||(r===Constants.CUSTOM_REMINDER_WECHAT?o=`<label class="b3-label b3-label--noborder">
    ${window.siyuan.languages.wechatReminder}
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__block" type="datetime-local" max="9999-12-31 23:59" readonly data-name="${r}" value="${dayjs(e[r]).format("YYYY-MM-DD HH:mm")}">
</label>`:r.indexOf("custom-av")>-1?i=!0:r.indexOf("custom")>-1&&(n+=`<label class="b3-label b3-label--noborder">
     <div class="fn__flex">
        <span class="fn__flex-1">${r.replace("custom-","")}</span>
        <span data-action="remove" class="block__icon block__icon--show"><svg><use xlink:href="#iconMin"></use></svg></span>
    </div>
    <div class="fn__hr"></div>
    <textarea style="resize: vertical;" spellcheck="false" class="b3-text-field fn__block" rows="1" data-name="${r}">${e[r]}</textarea>
</label>`))});const l=new Dialog({width:isMobile()?"92vw":"50vw",containerClassName:"b3-dialog__container--theme",height:"80vh",content:`<div class="fn__flex-column">
    <div class="layout-tab-bar fn__flex" style="flex-shrink:0;border-radius: var(--b3-border-radius-b) var(--b3-border-radius-b) 0 0">
        <div class="item item--full item--focus" data-type="attr">
            <span class="fn__flex-1"></span>
            <span class="item__text">${window.siyuan.languages.builtIn}</span>
            <span class="fn__flex-1"></span>
        </div>
        <div class="item item--full${i?"":" fn__none"}" data-type="NodeAttributeView">
            <span class="fn__flex-1"></span>
            <span class="item__text">${window.siyuan.languages.database}</span>
            <span class="fn__flex-1"></span>
        </div>
        <div class="item item--full" data-type="custom">
            <span class="fn__flex-1"></span>
            <span class="item__text">${window.siyuan.languages.custom}</span>
            <span class="fn__flex-1"></span>
        </div>
    </div>
    <div class="fn__flex-1">
        <div class="custom-attr" data-type="attr">
            <label class="b3-label b3-label--noborder">
                <div class="fn__flex">
                    <span class="fn__flex-1">${window.siyuan.languages.bookmark}</span>
                    <span data-action="bookmark" class="block__icon block__icon--show"><svg><use xlink:href="#iconDown"></use></svg></span>
                </div>
                <div class="fn__hr"></div>
                <input spellcheck="${window.siyuan.config.editor.spellcheck}" class="b3-text-field fn__block" placeholder="${window.siyuan.languages.attrBookmarkTip}" data-name="bookmark">
            </label>
            <label class="b3-label b3-label--noborder">
                ${window.siyuan.languages.name}
                <div class="fn__hr"></div>
                <input spellcheck="${window.siyuan.config.editor.spellcheck}" class="b3-text-field fn__block" placeholder="${window.siyuan.languages.attrNameTip}" data-name="name">
            </label>
            <label class="b3-label b3-label--noborder">
                ${window.siyuan.languages.alias}
                <div class="fn__hr"></div>
                <input spellcheck="${window.siyuan.config.editor.spellcheck}" class="b3-text-field fn__block" placeholder="${window.siyuan.languages.attrAliasTip}" data-name="alias">
            </label>
            <label class="b3-label b3-label--noborder">
                ${window.siyuan.languages.memo}
                <div class="fn__hr"></div>
                <textarea style="resize: vertical" spellcheck="${window.siyuan.config.editor.spellcheck}" class="b3-text-field fn__block" placeholder="${window.siyuan.languages.attrMemoTip}" rows="2" data-name="memo">${e.memo||""}</textarea>
            </label>
            ${o}
        </div>
        <div data-type="NodeAttributeView" class="fn__none custom-attr"></div>
        <div data-type="custom" class="fn__none custom-attr">
           ${n}
           <div class="b3-label">
               <button data-action="addCustom" class="b3-button b3-button--cancel">
                   <svg><use xlink:href="#iconAdd"></use></svg>${window.siyuan.languages.addAttr}
               </button>
           </div>
        </div>
    </div>
</div>`,destroyCallback(){focusByRange(s),hideElements(["select"],a)}});l.element.setAttribute("data-key",Constants.DIALOG_ATTR),l.element.querySelector('.b3-text-field[data-name="bookmark"]').value=e.bookmark||"",l.element.querySelector('.b3-text-field[data-name="name"]').value=e.name||"",l.element.querySelector('.b3-text-field[data-name="alias"]').value=e.alias||"",l.element.addEventListener("click",r=>{let c=r.target;for(typeof r.detail=="string"&&(c=l.element.querySelector('.item--full[data-type="NodeAttributeView"]'));!c.isSameNode(l.element);){const d=c.dataset.action;if(c.classList.contains("item--full"))c.parentElement.querySelector(".item--focus").classList.remove("item--focus"),c.classList.add("item--focus"),l.element.querySelectorAll(".custom-attr").forEach(u=>{u.dataset.type===c.dataset.type?(u.dataset.type==="NodeAttributeView"&&u.innerHTML===""&&renderAVAttribute(u,e.id,a),u.classList.remove("fn__none")):u.classList.add("fn__none")});else if(d==="remove"){fetchPost("/api/attr/setBlockAttrs",{id:e.id,attrs:{["custom-"+c.previousElementSibling.textContent]:""}}),c.parentElement.parentElement.remove(),r.stopPropagation(),r.preventDefault();break}else if(d==="bookmark"){fetchPost("/api/attr/getBookmarkLabels",{},u=>{window.siyuan.menus.menu.remove(),u.data.length===0?window.siyuan.menus.menu.append(new MenuItem({id:"emptyContent",iconHTML:"",label:window.siyuan.languages.emptyContent,type:"readonly"}).element):u.data.forEach(g=>{window.siyuan.menus.menu.append(new MenuItem({label:g,click(){const f=c.parentElement.parentElement.querySelector("input");f.value=g,f.dispatchEvent(new CustomEvent("change"))}}).element)}),window.siyuan.menus.menu.element.classList.add("b3-menu--list"),window.siyuan.menus.menu.popup({x:r.clientX,y:r.clientY+16,w:16})}),r.stopPropagation(),r.preventDefault();break}else if(d==="addCustom"){const u=new Dialog({title:window.siyuan.languages.attrName,content:`<div class="b3-dialog__content"><input spellcheck="false" class="b3-text-field fn__block" value=""></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px"});u.element.setAttribute("data-key",Constants.DIALOG_SETCUSTOMATTR);const g=u.element.querySelector("input"),f=u.element.querySelectorAll(".b3-button");u.bindInput(g,()=>{f[1].click()}),g.focus(),g.select(),f[0].addEventListener("click",()=>{u.destroy()}),f[1].addEventListener("click",()=>{if(!isValidAttrName(g.value))return showMessage(window.siyuan.languages.attrName+" <b>"+escapeHtml(g.value)+"</b> "+window.siyuan.languages.invalid),!1;c.parentElement.insertAdjacentHTML("beforebegin",`<div class="b3-label b3-label--noborder">
    <div class="fn__flex">
        <span class="fn__flex-1">${g.value}</span>
        <span data-action="remove" class="block__icon block__icon--show"><svg><use xlink:href="#iconMin"></use></svg></span>
    </div>
    <div class="fn__hr"></div>
    <textarea style="resize: vertical" spellcheck="false" data-name="custom-${g.value}" class="b3-text-field fn__block" rows="1" placeholder="${window.siyuan.languages.attrValue1}"></textarea>
</div>`);const p=c.parentElement.previousElementSibling.querySelector(".b3-text-field");p.focus(),Wn(p,e.id),u.destroy()}),r.stopPropagation(),r.preventDefault();break}c=c.parentElement}}),l.element.querySelectorAll(".b3-text-field").forEach(r=>{t!=="av"&&t===r.getAttribute("data-name")&&r.focus(),Wn(r,e.id)}),t==="av"&&l.element.dispatchEvent(new CustomEvent("click",{detail:"av"}))},vc=(e,t="bookmark",a)=>{if(e.getAttribute("data-type")==="NodeThematicBreak")return;const n=e.getAttribute("data-node-id");fetchPost("/api/attr/getBlockAttrs",{id:n},o=>{to(o.data,t,a)})},Ec=(e,t=!0,a)=>[{id:"copyBlockRef",iconHTML:"",accelerator:t?window.siyuan.config.keymap.editor.general.copyBlockRef.custom:void 0,label:window.siyuan.languages.copyBlockRef,click:()=>{copyTextByType(e,"ref"),a&&focusBlock(a)}},{id:"copyBlockEmbed",iconHTML:"",label:window.siyuan.languages.copyBlockEmbed,accelerator:t?window.siyuan.config.keymap.editor.general.copyBlockEmbed.custom:void 0,click:()=>{copyTextByType(e,"blockEmbed"),a&&focusBlock(a)}},{id:"copyProtocol",iconHTML:"",label:window.siyuan.languages.copyProtocol,accelerator:t?window.siyuan.config.keymap.editor.general.copyProtocol.custom:void 0,click:()=>{copyTextByType(e,"protocol"),a&&focusBlock(a)}},{id:"copyProtocolInMd",iconHTML:"",label:window.siyuan.languages.copyProtocolInMd,accelerator:t?window.siyuan.config.keymap.editor.general.copyProtocolInMd.custom:void 0,click:()=>{copyTextByType(e,"protocolMd"),a&&focusBlock(a)}},{id:"copyHPath",iconHTML:"",label:window.siyuan.languages.copyHPath,accelerator:t?window.siyuan.config.keymap.editor.general.copyHPath.custom:void 0,click:()=>{copyTextByType(e,"hPath"),a&&focusBlock(a)}},{id:"copyID",iconHTML:"",label:window.siyuan.languages.copyID,accelerator:t?window.siyuan.config.keymap.editor.general.copyID.custom:void 0,click:()=>{copyTextByType(e,"id"),a&&focusBlock(a)}}],kc=e=>{if(!window.siyuan.isPublish)return new MenuItem({id:"export",label:window.siyuan.languages.export,type:"submenu",icon:"iconUpload",submenu:[{id:"exportTemplate",label:window.siyuan.languages.template,iconClass:"ft__error",icon:"iconMarkdown",click:()=>eo(void 0,null,function*(){const t=yield fetchSyncPost("/api/block/getRefText",{id:e}),a=new Dialog({title:window.siyuan.languages.fileName,content:`<div class="b3-dialog__content"><input class="b3-text-field fn__block" value=""></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px"});a.element.setAttribute("data-key",Constants.DIALOG_EXPORTTEMPLATE);const n=a.element.querySelector("input"),o=a.element.querySelectorAll(".b3-button");a.bindInput(n,()=>{o[1].click()});let i=replaceFileName(t.data);const s=32;i.length>s&&(i=i.substring(0,s)),n.value=i,n.focus(),n.select(),o[0].addEventListener("click",()=>{a.destroy()}),o[1].addEventListener("click",()=>{n.value.trim()===""?n.value=window.siyuan.languages.untitled:n.value=replaceFileName(n.value),i.length>s&&(i=i.substring(0,s)),fetchPost("/api/template/docSaveAsTemplate",{id:e,name:n.value,overwrite:!1},l=>{if(l.code===1){confirmDialog(window.siyuan.languages.export,window.siyuan.languages.exportTplTip,()=>{fetchPost("/api/template/docSaveAsTemplate",{id:e,name:n.value,overwrite:!0},r=>{r.code===0&&showMessage(window.siyuan.languages.exportTplSucc)})});return}showMessage(window.siyuan.languages.exportTplSucc)}),a.destroy()})})},{id:"exportMarkdown",label:"Markdown",icon:"iconMarkdown",click:()=>{const t=showMessage(window.siyuan.languages.exporting,-1);fetchPost("/api/export/exportMd",{id:e},a=>{hideMessage(t),openByMobile(a.data.zip)})}},{id:"exportSiYuanZip",label:"SiYuan .sy.zip",icon:"iconSiYuan",click:()=>{const t=showMessage(window.siyuan.languages.exporting,-1);fetchPost("/api/export/exportSY",{id:e},a=>{hideMessage(t),openByMobile(a.data.zip)})}},{id:"exportImage",label:window.siyuan.languages.image,icon:"iconImage",click:()=>{exportImage(e)}}]}).element},ao=(e,t,a,n)=>{const o=[];if(o.push({id:ct()||dt()?"useDefault":"useBrowserView",label:ct()||dt()?window.siyuan.languages.useDefault:window.siyuan.languages.useBrowserView,accelerator:n?window.siyuan.languages.click:"",click:()=>{Ln(t)}}),a)return o;window.siyuan.menus.menu.append(new _e({id:"openBy",label:window.siyuan.languages.openBy,icon:"iconOpen",submenu:o}).element)},Cc=e=>new MenuItem({id:"rename",accelerator:window.siyuan.config.keymap.editor.general.rename.custom,icon:"iconEdit",label:window.siyuan.languages.rename,click:()=>{rename(e)}}).element,Ac=e=>new MenuItem({id:"move",label:window.siyuan.languages.move,icon:"iconMove",accelerator:window.siyuan.config.keymap.general.move.custom,click(){movePathTo((t,a)=>{moveToPath(e,a[0],t[0])},e)}}).element;class Lc{constructor(){this.hasUndo=!1,this.redoStack=[],this.undoStack=[]}undo(t){if(t.disabled||this.undoStack.length===0)return;const a=this.undoStack.pop();if(this.render(t,a,!1),this.hasUndo=!0,this.redoStack.push(a),t.breadcrumb){const n=t.breadcrumb.element.parentElement.querySelector('[data-type="undo"]');n&&(this.undoStack.length===0&&n.setAttribute("disabled","true"),t.breadcrumb.element.parentElement.querySelector('[data-type="redo"]').removeAttribute("disabled"))}}redo(t){if(t.disabled||this.redoStack.length===0)return;const a=this.redoStack.pop();if(this.render(t,a,!0),this.undoStack.push(a),t.breadcrumb){const n=t.breadcrumb.element.parentElement.querySelector('[data-type="redo"]');n&&(t.breadcrumb.element.parentElement.querySelector('[data-type="undo"]').removeAttribute("disabled"),this.redoStack.length===0&&n.setAttribute("disabled","true"))}}render(t,a,n){hideElements(["hint","gutter"],t),t.wysiwyg.lastHTMLs={},n?(a.doOperations.forEach(o=>{onTransaction(t,o,!0)}),transaction(t,a.doOperations)):(a.undoOperations.forEach(o=>{onTransaction(t,o,!0)}),transaction(t,a.undoOperations)),preventScroll(t),scrollCenter(t)}replace(t,a){if(this.hasUndo&&this.redoStack.length>0&&(this.undoStack.push(this.redoStack.pop()),this.redoStack=[],this.hasUndo=!1,a.breadcrumb)){const n=a.breadcrumb.element.parentElement.querySelector('[data-type="redo"]');n&&n.setAttribute("disabled","true")}this.undoStack.length>0&&(this.undoStack[this.undoStack.length-1].doOperations=t)}add(t,a,n){if(this.undoStack.push({undoOperations:a,doOperations:t}),this.undoStack.length>Constants.SIZE_UNDO&&this.undoStack.shift(),this.hasUndo&&(this.redoStack=[],this.hasUndo=!1),n.breadcrumb){const o=n.breadcrumb.element.parentElement.querySelector('[data-type="undo"]');o&&o.removeAttribute("disabled")}}clear(){this.undoStack=[],this.redoStack=[]}}const sa=e=>!1,Sc=(e,t,a)=>{var n,o,i,s,l,r,c,d,u;let g,f="",p=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(p.length===0){let b=getTopAloneElement(t);const w=hasClosestByAttribute(b,"fold","1");w&&(b=w),(n=b.previousElementSibling)!=null&&n.classList.contains("protyle-action")&&(b=getTopAloneElement(b.parentElement)),p=[b]}const m=p[0].getAttribute("data-type");if(m==="NodeListItem"&&!p[0].previousElementSibling&&((i=(o=p[0].parentElement.previousElementSibling)==null?void 0:o.previousElementSibling)!=null&&i.classList.contains("protyle-action")))if((s=p[0].parentElement.parentElement.previousElementSibling)!=null&&s.classList.contains("li")){if(g=p[0].parentElement.parentElement.previousElementSibling.querySelector(".list"),a.insertNode(document.createElement("wbr")),f=p[0].parentElement.parentElement.parentElement.outerHTML,!g){const b=Lute.NewNodeID();p[0].parentElement.parentElement.previousElementSibling.lastElementChild.insertAdjacentHTML("beforebegin",`<div data-subtype="${p[0].getAttribute("data-subtype")}" data-node-id="${b}" data-type="NodeList" class="list" updated="${b.split("-")[0]}"><div id="moveTempLi"></div><div class="protyle-attr" contenteditable="false">&ZeroWidthSpace;</div></div>`),g=p[0].parentElement.parentElement.previousElementSibling.querySelector(".list")}}else return;if(m==="NodeList"&&((r=(l=p[0].previousElementSibling)==null?void 0:l.previousElementSibling)!=null&&r.classList.contains("protyle-action")))if((c=p[0].parentElement.previousElementSibling)!=null&&c.classList.contains("li")){if(g=p[0].parentElement.previousElementSibling.querySelector(".list"),a.insertNode(document.createElement("wbr")),f=p[0].parentElement.parentElement.outerHTML,!g){const b=Lute.NewNodeID();p[0].parentElement.previousElementSibling.lastElementChild.insertAdjacentHTML("beforebegin",`<div data-subtype="${p[0].getAttribute("data-subtype")}" data-node-id="${b}" data-type="NodeList" class="list" updated="${b.split("-")[0]}"><div id="moveTempLi"></div><div class="protyle-attr" contenteditable="false">&ZeroWidthSpace;</div></div>`),g=p[0].parentElement.previousElementSibling.querySelector(".list")}}else return;if(g){g=g.lastElementChild.previousElementSibling;const b=p[0].classList.contains("list")?p[0]:p[0].parentElement;p.reverse().forEach(w=>{w.classList.contains("list")?g.after(w.firstElementChild):g.after(w)}),g.id==="moveTempLi"&&(g=g.nextElementSibling,g.previousElementSibling.remove()),b.childElementCount===1?b.remove():b.getAttribute("data-subtype")==="o"&&b.classList.contains("list")&&updateListOrder(b,1),g.getAttribute("data-subtype")==="o"&&updateListOrder(g.parentElement),updateTransaction(e,g.parentElement.parentElement.parentElement.getAttribute("data-node-id"),g.parentElement.parentElement.parentElement.outerHTML,f),preventScroll(e),scrollCenter(e),focusByWbr(g.parentElement,a);return}if(!(!p[0].previousElementSibling||(d=p[0].previousElementSibling)!=null&&d.classList.contains("protyle-action"))){if(g=p[0].previousElementSibling,p[0].getAttribute("data-subtype")==="o"&&m==="NodeListItem"){const b=p[0].parentElement.outerHTML;p[p.length-1].after(g),updateListOrder(p[0].parentElement,1),updateTransaction(e,p[0].parentElement.getAttribute("data-node-id"),p[0].parentElement.outerHTML,b)}else{const b=g.getAttribute("data-node-id");transaction(e,[{action:"move",id:b,previousID:p[p.length-1].getAttribute("data-node-id")}],[{action:"move",id:b,previousID:(u=g.previousElementSibling)==null?void 0:u.getAttribute("data-node-id"),parentID:g.parentElement.getAttribute("data-node-id")||e.block.parentID}]),p[p.length-1].after(g)}preventScroll(e),scrollCenter(e)}},xc=(e,t,a)=>{var n,o,i,s,l,r,c;let d,u="",g=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(g.length===0){let p=getTopAloneElement(t);const m=hasClosestByAttribute(p,"fold","1");m&&(p=m),(n=p.previousElementSibling)!=null&&n.classList.contains("protyle-action")&&(p=getTopAloneElement(p.parentElement)),g=[p]}const f=g[0].getAttribute("data-type");if(f==="NodeListItem"&&g[g.length-1].nextElementSibling.classList.contains("protyle-attr")&&((o=g[0].parentElement.parentElement)!=null&&o.classList.contains("li")))if((i=g[0].parentElement.parentElement.nextElementSibling)!=null&&i.classList.contains("li")){if(d=g[0].parentElement.parentElement.nextElementSibling.querySelector(".list > .li"),a.insertNode(document.createElement("wbr")),u=g[0].parentElement.parentElement.parentElement.outerHTML,!d){const p=Lute.NewNodeID();g[0].parentElement.parentElement.nextElementSibling.lastElementChild.insertAdjacentHTML("beforebegin",`<div data-subtype="${g[0].getAttribute("data-subtype")}" data-node-id="${p}" data-type="NodeList" class="list" updated="${p.split("-")[0]}"><div class="protyle-attr" contenteditable="false">&ZeroWidthSpace;</div></div>`),d=g[0].parentElement.parentElement.nextElementSibling.querySelector(".list > div")}}else return;if(f==="NodeList"&&g[g.length-1].nextElementSibling.classList.contains("protyle-attr")&&((s=g[0].parentElement)!=null&&s.classList.contains("li")))if((l=g[0].parentElement.nextElementSibling)!=null&&l.classList.contains("li")){if(d=g[0].parentElement.nextElementSibling.querySelector(".list > .li"),a.insertNode(document.createElement("wbr")),u=g[0].parentElement.parentElement.outerHTML,!d){const p=Lute.NewNodeID();g[0].parentElement.nextElementSibling.lastElementChild.insertAdjacentHTML("beforebegin",`<div data-subtype="${g[0].getAttribute("data-subtype")}" data-node-id="${p}" data-type="NodeList" class="list" updated="${p.split("-")[0]}"><div class="protyle-attr" contenteditable="false">&ZeroWidthSpace;</div></div>`),d=g[0].parentElement.nextElementSibling.querySelector(".list > div")}}else return;if(d){const p=g[0].classList.contains("list")?g[0]:g[0].parentElement;g.forEach(m=>{m.classList.contains("list")?d.before(m.firstElementChild):d.before(m)}),p.childElementCount===1?p.remove():p.getAttribute("data-subtype")==="o"&&p.classList.contains("list")&&updateListOrder(p,1),d.getAttribute("data-subtype")==="o"&&updateListOrder(d.parentElement,1),updateTransaction(e,d.parentElement.parentElement.parentElement.getAttribute("data-node-id"),d.parentElement.parentElement.parentElement.outerHTML,u),preventScroll(e),scrollCenter(e),focusByWbr(d.parentElement,a);return}if(!(!g[g.length-1].nextElementSibling||(r=g[g.length-1].nextElementSibling)!=null&&r.classList.contains("protyle-attr"))){if(d=g[g.length-1].nextElementSibling,d.getAttribute("data-subtype")==="o"&&d.getAttribute("data-type")==="NodeListItem"){const p=d.parentElement.outerHTML;g[0].before(d),updateListOrder(d.parentElement,1),updateTransaction(e,d.parentElement.getAttribute("data-node-id"),d.parentElement.outerHTML,p)}else{const p=d.getAttribute("data-node-id");transaction(e,[{action:"move",id:p,previousID:(c=g[0].previousElementSibling)==null?void 0:c.getAttribute("data-node-id"),parentID:d.parentElement.getAttribute("data-node-id")||e.block.parentID}],[{action:"move",id:p,previousID:g[g.length-1].getAttribute("data-node-id")}]),g[0].before(d)}preventScroll(e),scrollCenter(e)}},no=e=>{let t="",a="";return window.siyuan.mobile.editor&&document.getElementById("empty").classList.contains("fn__none")&&(t=window.siyuan.mobile.editor.protyle.notebookId,e?a=window.siyuan.mobile.editor.protyle.path:a=pathPosix().dirname(window.siyuan.mobile.editor.protyle.path)),t||window.siyuan.notebooks.find(n=>{if(!n.closed)return t=n.id,a="/",!0}),{notebookId:t,currentPath:a}},so=e=>{if(getOpenNotebookCount()===0){showMessage(window.siyuan.languages.newFileTip);return}if(!e.notebookId){const t=no(e.useSavePath);e.notebookId=t.notebookId,e.currentPath=t.currentPath}fetchPost("/api/filetree/getDocCreateSavePath",{notebook:e.notebookId},t=>{if(e.useSavePath||(t.data.box=e.notebookId),t.data.path.indexOf("/")>-1&&e.useSavePath||e.name)if(t.data.path.startsWith("/")||e.currentPath==="/"){const a=pathPosix().join(t.data.path,e.name||(t.data.path.endsWith("/")?window.siyuan.languages.untitled:""));fetchPost("/api/filetree/createDocWithMd",{notebook:t.data.box,path:a,markdown:"",listDocTree:e.listDocTree},n=>{e.afterCB&&e.afterCB(n.data,pathPosix().basename(a)),openMobileFileById(e.app,n.data,[Constants.CB_GET_CONTEXT,Constants.CB_GET_OPENNEW])})}else fetchPost("/api/filetree/getHPathByPath",{notebook:t.data.box,path:e.notebookId===t.data.box?e.currentPath.endsWith(".sy")?e.currentPath:e.currentPath+".sy":t.data.path||"/"},a=>{const n=pathPosix().join(a.data,t.data.path,e.name||(t.data.path.endsWith("/")?window.siyuan.languages.untitled:""));fetchPost("/api/filetree/createDocWithMd",{notebook:t.data.box,path:n,parentID:getDisplayName(e.currentPath,!0,!0),markdown:"",listDocTree:e.listDocTree},o=>{e.afterCB&&e.afterCB(o.data,pathPosix().basename(n)),openMobileFileById(e.app,o.data,[Constants.CB_GET_CONTEXT,Constants.CB_GET_OPENNEW])})});else{const a=pathPosix().basename(t.data.path||window.siyuan.languages.untitled);if(!validateName(a))return;if(e.notebookId!==t.data.box){const i=pathPosix().join(t.data.path||"/",e.name||(t.data.path.endsWith("/")?window.siyuan.languages.untitled:""));fetchPost("/api/filetree/createDocWithMd",{notebook:t.data.box,path:i,markdown:"",listDocTree:e.listDocTree},s=>{e.afterCB&&e.afterCB(s.data,pathPosix().basename(i)),openMobileFileById(e.app,s.data,[Constants.CB_GET_CONTEXT,Constants.CB_GET_OPENNEW])});return}const n=Lute.NewNodeID(),o=pathPosix().join(getDisplayName(e.currentPath,!1,!0),n+".sy");e.paths&&(e.paths[e.paths.indexOf(void 0)]=o),fetchPost("/api/filetree/createDoc",{notebook:t.data.box,path:o,title:a,md:"",sorts:e.paths,listDocTree:e.listDocTree},()=>{e.afterCB&&e.afterCB(n,a),openMobileFileById(e.app,n,[Constants.CB_GET_CONTEXT,Constants.CB_GET_OPENNEW])})}})},Tc=(e,t,a)=>{fetchPost("/api/filetree/getRefCreateSavePath",{notebook:t},n=>{let o=e;t!==n.data.box&&(o=n.data.path||"/"),n.data.path?n.data.path.startsWith("/")?a(getDisplayName(n.data.path,!1,!0),n.data.box):fetchPost("/api/filetree/getHPathByPath",{notebook:n.data.box,path:o},i=>{a(getDisplayName(pathPosix().join(i.data,n.data.path),!1,!0),n.data.box)}):fetchPost("/api/filetree/getHPathByPath",{notebook:n.data.box,path:o},i=>{a(getDisplayName(i.data,!1,!0),n.data.box)})})},Ic=(e,t)=>{hideElements(["dialog"]),so({app:e,useSavePath:!0,name:replaceFileName(t.trim())||window.siyuan.languages.untitled})},Mc=(e,t,a,n,o)=>{const i=replaceFileName(t.trim()?t.trim():e.lute.BlockDOM2Content(a.outerHTML).replace(/\n/g,"").trim())||window.siyuan.languages.untitled,s=pathPosix().join(n,i);fetchPost("/api/filetree/getIDsByHPath",{path:s,notebook:o},l=>{const r=escapeHtml(i.substring(0,window.siyuan.config.editor.blockRefDynamicAnchorTextMaxLen));l.data&&l.data.length>0?e.toolbar.setInlineMark(e,"block-ref","range",{type:"id",color:`${l.data[0]}${Constants.ZWSP}d${Constants.ZWSP}${r}`}):fetchPost("/api/filetree/createDocWithMd",{notebook:o,path:s,parentID:e.notebookId===o?e.block.rootID:"",markdown:""},c=>{e.toolbar.setInlineMark(e,"block-ref","range",{type:"id",color:`${c.data}${Constants.ZWSP}d${Constants.ZWSP}${r}`})}),hideElements(["toolbar"],e)})},tn=(e,t,a)=>{t&&(setLastNodeRange(getContenteditableElement(a[a.length-1]),e.toolbar.range),e.toolbar.range.collapse(!0),insertHTML(t,e,!0,!0),blockRender(e,e.wysiwyg.element),processRender(e.wysiwyg.element),highlightRender(e.wysiwyg.element))},io=(e,t)=>{const a=new Dialog({title:window.siyuan.languages.update,content:`<div class="b3-dialog__content">
    <input class="b3-text-field fn__block" placeholder="${window.siyuan.languages.memo}">
    <div class="fn__hr"></div>
    <textarea class="b3-text-field fn__block" placeholder="${window.siyuan.languages.aiCustomAction}"></textarea>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--remove">${window.siyuan.languages.delete}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px"});a.element.setAttribute("data-key",Constants.DIALOG_AIUPDATECUSTOMACTION);const n=a.element.querySelector("input");n.value=e;const o=a.element.querySelector("textarea"),i=a.element.querySelectorAll(".b3-button");a.bindInput(o,()=>{i[2].click()}),o.value=t,i[1].addEventListener("click",()=>{a.destroy()}),i[2].addEventListener("click",()=>{window.siyuan.storage[Constants.LOCAL_AI].find(s=>{if(e===s.name&&t===s.memo)return s.name=n.value,s.memo=o.value,setStorageVal(Constants.LOCAL_AI,window.siyuan.storage[Constants.LOCAL_AI]),!0}),a.destroy()}),i[0].addEventListener("click",()=>{window.siyuan.storage[Constants.LOCAL_AI].find((s,l)=>{if(e===s.name&&t===s.memo)return window.siyuan.storage[Constants.LOCAL_AI].splice(l,1),setStorageVal(Constants.LOCAL_AI,window.siyuan.storage[Constants.LOCAL_AI]),!0}),a.destroy()}),n.focus()},jn=(e,t,a)=>{const n=new Dialog({title:window.siyuan.languages.aiCustomAction,content:`<div class="b3-dialog__content">
    <input class="b3-text-field fn__block" value="" placeholder="${window.siyuan.languages.memo}">
    <div class="fn__hr"></div>
    <textarea class="b3-text-field fn__block" placeholder="${window.siyuan.languages.aiCustomAction}"></textarea>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.use}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.save}</button>
</div>`,width:isMobile()?"92vw":"520px"});n.element.setAttribute("data-key",Constants.DIALOG_AICUSTOMACTION);const o=n.element.querySelector("input"),i=n.element.querySelector("textarea"),s=n.element.querySelectorAll(".b3-button");n.bindInput(i,()=>{s[1].click()}),s[0].addEventListener("click",()=>{n.destroy()}),s[1].addEventListener("click",()=>{if(!i.value){showMessage(window.siyuan.languages._kernel[142]);return}fetchPost("/api/ai/chatGPTWithAction",{ids:t,action:i.value},l=>{n.destroy(),tn(e,l.data,a)})}),s[2].addEventListener("click",()=>{if(!o.value&&!i.value){showMessage(window.siyuan.languages._kernel[142]);return}window.siyuan.storage[Constants.LOCAL_AI].push({name:o.value,memo:i.value}),setStorageVal(Constants.LOCAL_AI,window.siyuan.storage[Constants.LOCAL_AI]),n.destroy()}),o.focus()},Vn=(e,t)=>{e.querySelectorAll(".b3-list-item").forEach(a=>{a.textContent.indexOf(t.value)>-1?a.classList.remove("fn__none"):a.classList.add("fn__none")}),e.querySelectorAll(".b3-menu__separator").forEach(a=>{t.value?a.classList.add("fn__none"):a.classList.remove("fn__none")}),e.querySelector(".b3-list-item--focus").classList.remove("b3-list-item--focus"),e.querySelector(".b3-list-item:not(.fn__none)").classList.add("b3-list-item--focus")},Dc=(e,t)=>{window.siyuan.menus.menu.remove();const a=[];e.forEach(s=>{a.push(s.getAttribute("data-node-id"))});const n=new Menu("ai",()=>{focusByRange(t.toolbar.range)});let o="";window.siyuan.storage[Constants.LOCAL_AI].forEach((s,l)=>{o+=`<div data-action="${escapeAttr(s.memo||s.name)}" data-index="${l}" class="b3-list-item b3-list-item--narrow ariaLabel" aria-label="${escapeAriaLabel(s.memo)}">
    <span class="b3-list-item__text">${escapeHtml(s.name)}</span>
    <span data-type="edit" class="b3-list-item__action"><svg><use xlink:href="#iconEdit"></use></svg></span>
</div>`}),o&&(o=`<div class="b3-menu__separator"></div>${o}`);const i="Clear context";n.addItem({iconHTML:"",type:"empty",label:`<div class="fn__flex-column b3-menu__filter">
    <input class="b3-text-field fn__flex-shrink" placeholder="${window.siyuan.languages.ai}"/>
    <div class="fn__hr"></div>
    <div class="b3-list fn__flex-1 b3-list--background">
       <div class="b3-list-item b3-list-item--narrow b3-list-item--focus" data-action="Continue writing">
            ${window.siyuan.languages.aiContinueWrite}
        </div>
        <div class="b3-menu__separator"></div>
        <div class="b3-list-item b3-list-item--narrow" data-action="${window.siyuan.languages.aiExtractSummary}">
            ${window.siyuan.languages.aiExtractSummary}
        </div>
        <div class="b3-list-item b3-list-item--narrow" data-action="${window.siyuan.languages.aiBrainStorm}">
            ${window.siyuan.languages.aiBrainStorm}
        </div>
        <div class="b3-list-item b3-list-item--narrow" data-action="${window.siyuan.languages.aiFixGrammarSpell}">
            ${window.siyuan.languages.aiFixGrammarSpell}
        </div>
        <div class="b3-list-item b3-list-item--narrow" data-action="${i}">
            ${window.siyuan.languages.clearContext}
        </div>
        <div class="b3-menu__separator"></div>
        <div class="b3-list-item b3-list-item--narrow" data-type="custom">
            ${window.siyuan.languages.aiCustomAction}
        </div>
        ${o}
    </div>
</div>`,bind(s){s.setAttribute("style","height: 100%;padding: 0 16px;"),s.querySelectorAll(".b3-menu__separator").forEach(c=>{c.remove()});const l=s.querySelector(".b3-list"),r=s.querySelector("input");r.addEventListener("keydown",c=>{if(c.isComposing)return;if(upDownHint(l,c)&&c.stopPropagation(),c.key==="Enter"){c.preventDefault(),c.stopPropagation();const u=l.querySelector(".b3-list-item--focus");u.dataset.type==="custom"?(jn(t,a,e),n.close()):(fetchPost("/api/ai/chatGPTWithAction",{ids:a,action:u.dataset.action},g=>{tn(t,g.data,e)}),u.dataset.action===i?showMessage(window.siyuan.languages.clearContextSucc):n.close())}}),r.addEventListener("compositionend",()=>{Vn(s,r)}),r.addEventListener("input",c=>{c.isComposing||Vn(s,r)}),s.addEventListener("click",c=>{let d=c.target;for(;d&&!d.isSameNode(s);){if(d.classList.contains("b3-list-item__action")){const u=window.siyuan.storage[Constants.LOCAL_AI][d.parentElement.dataset.index];io(u.name,u.memo),n.close(),c.stopPropagation(),c.preventDefault();break}else if(d.classList.contains("b3-list-item")){d.dataset.type==="custom"?(jn(t,a,e),n.close()):(fetchPost("/api/ai/chatGPTWithAction",{ids:a,action:d.dataset.action},u=>{tn(t,u.data,e)}),d.dataset.action===i?showMessage(window.siyuan.languages.clearContextSucc):n.close()),c.stopPropagation(),c.preventDefault();break}d=d.parentElement}})}}),n.element.querySelector(".b3-menu__items").setAttribute("style","overflow: initial"),n.fullscreen()},$c=(e,t)=>{const a=new Dialog({title:"\u2728 "+window.siyuan.languages.aiWriting,content:`<div class="b3-dialog__content"><textarea class="b3-text-field fn__block"></textarea></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px"}),n=a.element.querySelector("textarea"),o=a.element.querySelectorAll(".b3-button");a.bindInput(n,()=>{o[1].click()}),n.focus(),o[0].addEventListener("click",()=>{a.destroy()}),o[1].addEventListener("click",()=>{let i=n.value;fetchPost("/api/ai/chatGPT",{msg:i},s=>{a.destroy();let l="";s.data&&s.data!==""&&(l=`

`+s.data),i==="Clear context"&&(i=""),fillContent(e,`${i}${l}`,[t])})})};class Hc{constructor(t){this.enableSlash=!0,this.enableEmoji=!0,this.enableExtend=!1,this.splitChar="",this.lastIndex=-1,this.element=document.createElement("div"),this.element.setAttribute("data-close","false"),this.element.className="protyle-hint b3-list b3-list--background fn__none",this.element.addEventListener("click",a=>{var n;const o=a.target;if(o.tagName==="INPUT"){a.stopPropagation();return}const i=hasClosestByTag(o,"BUTTON");if(i&&!i.classList.contains("emojis__item")&&!i.classList.contains("emojis__type")){this.fill(decodeURIComponent(i.getAttribute("data-value")),t,!1,this.source==="search"?isNotCtrl(a):isOnlyMeta(a)),a.preventDefault(),a.stopPropagation();return}const s=this.element.querySelector(".emojis__panel"),l=hasClosestByClassName(o,"emojis__type");if(l){const c=s.querySelector(`[data-type="${l.getAttribute("data-type")}"]`);if(c){const d=c.nextElementSibling.getAttribute("data-index");if(d){let u="";window.siyuan.emojis[parseInt(d)].items.forEach(g=>{u+=`<button data-unicode="${g.unicode}" class="emojis__item ariaLabel" aria-label="${getEmojiDesc(g)}">
${unicode2Emoji(g.unicode)}</button>`}),c.nextElementSibling.innerHTML=u,c.nextElementSibling.removeAttribute("data-index")}s.scrollTo({top:c.offsetTop})}return}const r=hasClosestByClassName(o,"emojis__item");if(r){const c=r.getAttribute("data-unicode");if(this.element.querySelectorAll(".emojis__title").length>2){const d=getSelection().getRangeAt(0);d.endContainer.nodeType!==3?(n=d.endContainer.childNodes[d.endOffset-1])==null||n.remove():d.endContainer.textContent===":"&&(d.endContainer.textContent=""),addEmoji(c);let u;c.indexOf(".")>-1?u=`:${c.split(".")[0]}: `:u=unicode2Emoji(c)+" ",insertHTML(t.lute.SpinBlockDOM(u),t,!1,!0),this.element.classList.add("fn__none")}else this.fill(c,t)}})}render(t){if(!window.getSelection().focusNode){this.element.classList.add("fn__none"),clearTimeout(this.timeId);return}if(!this.enableExtend){clearTimeout(this.timeId);return}if(t.toolbar.range=getSelection().getRangeAt(0),t.toolbar.range.startContainer.nodeType===3&&t.toolbar.range.startContainer.textContent===""){const i=hasPreviousSibling(t.toolbar.range.startContainer);if(i&&i.nodeType===3){if(i.wholeText!==i.textContent){let s=i.previousSibling;for(;s&&s.nodeType===3;)if(s.textContent==="")s=s.previousSibling,s.nextSibling.remove();else{i.textContent=s.textContent+i.textContent,s.remove();break}}t.toolbar.range.setStart(i,i.textContent.length),t.toolbar.range.collapse(!0)}}const a=getSelectionOffset(t.toolbar.range.startContainer,t.wysiwyg.element).start,n=t.toolbar.range.startContainer.textContent.substring(0,a)||"",o=this.getKey(n,t.options.hint.extend);if(typeof o=="undefined"||hasClosestByAttribute(t.toolbar.range.startContainer,"data-type","code")||hasClosestByAttribute(t.toolbar.range.startContainer,"data-type","NodeCodeBlock")){this.element.classList.add("fn__none"),clearTimeout(this.timeId);return}if(this.splitChar==="#"){const i=hasClosestBlock(t.toolbar.range.startContainer);if(i&&i.getAttribute("data-type")==="NodeHeading"){const s=getSelectionOffset(t.toolbar.range.startContainer,i).start;if(i.textContent.startsWith("#".repeat(s))){this.element.classList.add("fn__none"),clearTimeout(this.timeId);return}}}if(this.splitChar===":"){clearTimeout(this.timeId),o?this.genEmojiHTML(t,o):this.element.classList.add("fn__none");return}if(this.splitChar==="/"||this.splitChar==="\u3001"){clearTimeout(this.timeId),this.enableSlash&&!isMobile()&&this.genHTML(hintSlash(o,t),t,!1,"hint");return}t.options.hint.extend.forEach(i=>{i.key===this.splitChar&&(clearTimeout(this.timeId),this.timeId=window.setTimeout(()=>{this.genHTML(i.hint(o,t,"hint"),t,!1,"hint")},t.options.hint.delay))})}genLoading(t){if(this.element.classList.contains("fn__none")){this.element.innerHTML='<div class="fn__loading" style="height: 128px;position: initial"><img width="64px" src="/stage/loading-pure.svg"></div>',this.element.classList.remove("fn__none");const a=getSelectionPosition(t.wysiwyg.element);setPosition(this.element,a.left,a.top+26,30)}else this.element.insertAdjacentHTML("beforeend",'<div class="fn__loading"><img width="64px" src="/stage/loading-pure.svg"></div>')}bindUploadEvent(t,a){a.querySelectorAll('input[type="file"]').forEach(n=>{n.addEventListener("change",o=>{if(o.target.files.length===0)return;const i=getEditorRange(t.wysiwyg.element);this.lastIndex>-1&&i.setStart(i.startContainer,this.lastIndex),i.deleteContents(),uploadFiles(t,o.target.files,o.target),hideElements(["hint","toolbar"],t)})})}getHTMLByData(t){let a='<div style="flex: 1;overflow:auto;">';return this.source!=="hint"&&(a='<input style="margin:0 8px 4px 8px" class="b3-text-field"><div style="flex: 1;overflow:auto;">'),t.forEach((n,o)=>{let i="";(o===1&&t[o].focus||o===0&&(t.length===1||!t[1].focus))&&(i=" b3-list-item--focus"),n.html==="separator"?a+=`<button data-id="${n.id||""}" class="b3-menu__separator"></button>`:a+=`<button data-id="${n.id||""}" style="width: calc(100% - 16px)" class="b3-list-item b3-list-item--two${i}" data-value="${encodeURIComponent(n.value)}">${n.html}</button>`}),`${a}</div>`}genHTML(t,a,n=!1,o){var i;if(this.source=o,t.length===0){(!this.element.querySelector(".fn__loading")||n)&&this.element.classList.add("fn__none");return}if(this.element.innerHTML=this.getHTMLByData(t),this.element.classList.remove("fn__none"),t[0].filter?this.element.classList.add("hint--menu"):this.element.classList.remove("hint--menu"),this.source==="av"){const s=hasClosestByClassName(a.toolbar.range.startContainer,"av__cell");if(s){const l=s.getBoundingClientRect();setPosition(this.element,l.left,l.bottom,l.height)}}else{const s=getSelectionPosition(a.wysiwyg.element);setPosition(this.element,s.left,s.top+26,30)}if(this.element.scrollTop=0,this.bindUploadEvent(a,this.element),this.source!=="hint"){const s=this.element.querySelector("input.b3-text-field"),l=((i=this.element.querySelector("mark"))==null?void 0:i.textContent)||"";s.value=l,s.select(),s.addEventListener("keydown",c=>{c.key!=="Meta"&&c.key!=="Control"&&c.stopPropagation(),!c.isComposing&&(upDownHint(this.element.lastElementChild,c),c.key==="Enter"?(this.fill(decodeURIComponent(this.element.querySelector(".b3-list-item--focus").getAttribute("data-value")),a,!1,isNotCtrl(c)),c.preventDefault()):c.key==="Escape"&&(this.element.classList.add("fn__none"),focusByRange(a.toolbar.range)))});const r=a.toolbar.range?hasClosestBlock(a.toolbar.range.startContainer):!1;s.addEventListener("input",c=>{c.isComposing||(c.stopPropagation(),this.genSearchHTML(a,s,r,l,o))}),s.addEventListener("compositionend",c=>{c.stopPropagation(),this.genSearchHTML(a,s,r,l,o)})}}genSearchHTML(t,a,n,o,i){this.element.lastElementChild.innerHTML='<div class="ft__center"><img style="height:32px;width:32px;" src="/stage/loading-pure.svg"></div>',fetchPost("/api/search/searchRefBlock",{k:a.value,id:n?n.getAttribute("data-node-id"):t.block.parentID,beforeLen:Math.floor((Math.max(t.element.clientWidth/2,320)-58)/28.8),rootID:i==="av"?"":t.block.rootID,isDatabase:i==="av"},s=>{let l="";if(s.data.newDoc){const r=`((newFile "${o}"${Constants.ZWSP}'${s.data.k}${Lute.Caret}'))`;l+=`<button style="width: calc(100% - 16px)" class="b3-list-item b3-list-item--two${s.data.blocks.length===0?" b3-list-item--focus":""}" data-value="${encodeURIComponent(r)}"><div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg>
<span class="b3-list-item__text">${window.siyuan.languages.newFile} <mark>${s.data.k}</mark></span></div></button>`}s.data.blocks.forEach((r,c)=>{let d;if(i==="av"){let u=r.name||r.refText.replace(new RegExp(Constants.ZWSP,"g"),"");n&&(u=r.ial["custom-sy-av-s-text-"+n.getAttribute("data-av-id")]||u),d=`<span data-type="block-ref" data-id="${r.id}" data-subtype="s">${u}</span>`}else d=`<span data-type="block-ref" data-id="${r.id}" data-subtype="s">${o}</span>`;l+=`<button style="width: calc(100% - 16px)" class="b3-list-item b3-list-item--two${c===0?" b3-list-item--focus":""}" data-value="${encodeURIComponent(d)}">
${genHintItemHTML(r)}
</button>`}),l===""&&(l=`<button style="width: calc(100% - 16px)" class="b3-list-item b3-list-item--two" data-value="">${window.siyuan.languages.emptyContent}</button>`),this.element.lastElementChild.innerHTML=l,setPosition(this.element,parseInt(this.element.style.left),parseInt(this.element.style.right))})}genEmojiHTML(t,a=""){if(a&&!this.enableEmoji)return;const n=this.element.querySelector(".emojis__panel");n?(n.innerHTML=filterEmoji(a,256),a?n.nextElementSibling.classList.add("fn__none"):n.nextElementSibling.classList.remove("fn__none"),lazyLoadEmojiImg(n)):(this.element.innerHTML=`<div style="padding:0;max-height:min(402px,40vh);width:366px" class="emojis">
<div class="emojis__panel">${filterEmoji(a,256)}</div>
<div class="fn__flex${a?" fn__none":""}">
    ${[["2b50",window.siyuan.languages.recentEmoji],["1f527",getEmojiTitle(0)],["1f60d",getEmojiTitle(1)],["1f433",getEmojiTitle(2)],["1f96a",getEmojiTitle(3)],["1f3a8",getEmojiTitle(4)],["1f3dd-fe0f",getEmojiTitle(5)],["1f52e",getEmojiTitle(6)],["267e-fe0f",getEmojiTitle(7)],["1f6a9",getEmojiTitle(8)]].map(([i,s],l)=>`<button data-type="${l}" class="emojis__type ariaLabel" aria-label="${s}">${unicode2Emoji(i)}</button>`).join("")}
</div>
</div>`,lazyLoadEmoji(this.element),lazyLoadEmojiImg(this.element));const o=this.element.querySelector(".emojis__item");if(o){o.classList.add("emojis__item--current"),this.element.classList.remove("fn__none");const i=getSelectionPosition(t.wysiwyg.element);setPosition(this.element,i.left,i.top+26,30),this.element.querySelector(".emojis__panel").scrollTop=0}else this.element.classList.add("fn__none")}fill(t,a,n=!0,o=!1){var i;hideElements(["hint","toolbar"],a),n&&this.source!=="av"&&(a.toolbar.range=getEditorRange(a.wysiwyg.element));const s=a.toolbar.range;let l=hasClosestBlock(a.toolbar.range.startContainer);if(!l)return;if(this.source==="av"){let u=hasClosestByClassName(a.toolbar.range.startContainer,"av__cell");if(u||(u=l.querySelector(".av__cell--select")),!u)return;const g=hasClosestByClassName(u,"av__row");if(!g)return;const f=u.dataset.blockId,p=l.getAttribute("data-av-id");let m=document.createElement("div");if(m.innerHTML=t.replace(/<mark>/g,"").replace(/<\/mark>/g,""),m=m.firstElementChild,t.startsWith("((newFile ")&&t.endsWith(`${Lute.Caret}'))`)){const b=t.substring(11,t.length-4).split(`"${Constants.ZWSP}'`),w=b.length===1?b[0]:b[1],y=Lute.NewNodeID();g.dataset.id=y,getSavePath(a.path,a.notebookId,(_,h)=>{fetchPost("/api/filetree/createDocWithMd",{notebook:h,path:pathPosix().join(_,w),parentID:a.notebookId===h?a.block.rootID:"",markdown:"",id:y},()=>{transaction(a,[{action:"replaceAttrViewBlock",avID:p,previousID:f,nextID:y,isDetached:!1}],[{action:"replaceAttrViewBlock",avID:p,previousID:y,nextID:f,isDetached:!0}])})}),updateAttrViewCellAnimation(u,{type:"block",isDetached:!1,block:{content:w,id:y}})}else{const b=m.getAttribute("data-id");g.dataset.id=b,transaction(a,[{action:"replaceAttrViewBlock",avID:p,previousID:f,nextID:b,isDetached:!1}],[{action:"replaceAttrViewBlock",avID:p,previousID:b,nextID:f,isDetached:!0}]),updateAttrViewCellAnimation(u,{type:"block",isDetached:!1,block:{content:m.textContent,id:b}})}return}this.enableExtend=!1;let r="";l&&(r=l.getAttribute("data-node-id"));const c=l.outerHTML,d=Constants.BLOCK_HINT_CLOSE_KEYS[this.splitChar];if(Constants.BLOCK_HINT_KEYS.includes(this.splitChar)&&d&&s.startContainer.nodeType===3&&s.startContainer.wholeText.indexOf(d)>-1&&s.startContainer.wholeText.indexOf(this.splitChar)>-1){let u=0,g=s.startContainer;for(;g&&u<2;){const f=g.textContent.indexOf(d),p=g.textContent.indexOf(this.splitChar);if(f>-1&&(f<p||p<0)){u=2,s.setEnd(g,f+2);break}const m=g.textContent.indexOf(d.substr(1));if(m>-1&&(u+=1),u===2){s.setEnd(g,m+1);break}g=g.nextSibling}}if(this.lastIndex>-1&&(s.setStart(s.startContainer,this.lastIndex),isIPhone()&&focusByRange(s)),Constants.BLOCK_HINT_KEYS.includes(this.splitChar)&&t.startsWith("((newFile ")&&t.endsWith(`${Lute.Caret}'))`)){const u=t.substring(11,t.length-4).split(`"${Constants.ZWSP}'`),g=u.length===1?u[0]:u[1];getSavePath(a.path,a.notebookId,(f,p)=>{fetchPost("/api/filetree/createDocWithMd",{notebook:p,path:pathPosix().join(f,g),parentID:a.notebookId===p?a.block.rootID:"",markdown:""},m=>{a.toolbar.range=s,a.toolbar.setInlineMark(a,"block-ref","range",{type:"id",color:`${m.data}${Constants.ZWSP}${o?"s":"d"}${Constants.ZWSP}${(o?u[0]:g).substring(0,window.siyuan.config.editor.blockRefDynamicAnchorTextMaxLen)}`})})});return}if(Constants.BLOCK_HINT_KEYS.includes(this.splitChar)){if(t===""){const g=getContenteditableElement(l);g.textContent===""&&(g.innerHTML="<wbr>",focusByWbr(g,s));return}let u=document.createElement("div");if(u.innerHTML=t.replace(/<mark>/g,"").replace(/<\/mark>/g,""),u=u.firstElementChild,o){const g=s.toString().replace(this.splitChar,"");g&&(u.setAttribute("data-subtype","s"),u.innerText=g)}else{u.setAttribute("data-subtype","d");const g=u.innerText.split(Constants.ZWSP);g.length===2&&(u.innerText=g[1])}a.toolbar.setInlineMark(a,"block-ref","range",{type:"id",color:`${u.getAttribute("data-id")}${Constants.ZWSP}${u.getAttribute("data-subtype")}${Constants.ZWSP}${u.textContent}`});return}else if(this.splitChar===":"){addEmoji(t);let u;t.indexOf(".")>-1?u=`:${t.split(".")[0]}: `:u=unicode2Emoji(t)+" ",insertHTML(a.lute.SpinBlockDOM(u),a)}else if(["\u300C\u300C","\u300C\u300E","\u300E\u300C","\u300E\u300E","{{"].includes(this.splitChar)||this.splitChar==="#"||this.splitChar===":"){if(t===""){const u=getContenteditableElement(l);u.textContent===""&&(u.innerHTML="<wbr>",focusByWbr(u,s));return}insertHTML(a.lute.SpinBlockDOM(t),a,!1,isMobile()),blockRender(a,a.wysiwyg.element);return}else if(this.splitChar==="/"||this.splitChar==="\u3001")if(this.enableExtend=!0,t==="(("||t==="{{"){t==="(("?hintRef("",a,"hint"):hintEmbed("",a),this.splitChar=t,this.lastIndex=0,s.deleteContents();const u=document.createTextNode(t);s.insertNode(u),s.setEnd(u,t.length),s.collapse(!1),focusByRange(s);return}else if(t===Constants.ZWSP){s.deleteContents(),this.fixImageCursor(s),a.toolbar.showTpl(a,l,s),updateTransaction(a,r,l.outerHTML,c);return}else if(t===Constants.ZWSP+1){s.deleteContents(),this.fixImageCursor(s),a.toolbar.showWidget(a,l,s),updateTransaction(a,r,l.outerHTML,c);return}else if(t===Constants.ZWSP+2){s.deleteContents(),this.fixImageCursor(s),a.toolbar.range=s;const u=getSelectionPosition(l,s);assetMenu(a,{x:u.left,y:u.top+26,w:0,h:26}),updateTransaction(a,r,l.outerHTML,c);return}else if(t===Constants.ZWSP+3){s.deleteContents();return}else if(t===Constants.ZWSP+4){newFile({app:a.app,notebookId:a.notebookId,useSavePath:!0,currentPath:a.path,afterCB:(u,g)=>{insertHTML(`<span data-type="block-ref" data-id="${u}" data-subtype="d">${g}</span>`,a)}});return}else if(t===Constants.ZWSP+6){const u=Lute.NewNodeID();fetchPost("/api/filetree/createDoc",{notebook:a.notebookId,path:pathPosix().join(getDisplayName(a.path,!1,!0),u+".sy"),title:window.siyuan.languages.untitled,md:""},()=>{insertHTML(`<span data-type="block-ref" data-id="${u}" data-subtype="d">${window.siyuan.languages.untitled}</span>`,a),openMobileFileById(a.app,u,[Constants.CB_GET_CONTEXT,Constants.CB_GET_OPENNEW])});return}else if(t===Constants.ZWSP+5){s.deleteContents(),AIChat(a,l);return}else if(Constants.INLINE_TYPE.includes(t)){if(s.deleteContents(),focusByRange(s),["a","block-ref","inline-math","inline-memo","text"].includes(t)){a.toolbar.element.querySelector(`[data-type="${t}"]`).dispatchEvent(new CustomEvent("click"));return}a.toolbar.setInlineMark(a,t,"range");return}else if(t==="emoji"){s.deleteContents(),s.insertNode(document.createTextNode(":")),s.collapse(!1),focusByRange(s),this.genEmojiHTML(a);return}else if(t.indexOf("style")>-1){s.deleteContents(),this.fixImageCursor(s),l.setAttribute("style",t.split(Constants.ZWSP)[1]||""),updateTransaction(a,r,l.outerHTML,c);return}else if(t.startsWith("plugin")){a.app.plugins.find(u=>{const g=t.split(Constants.ZWSP);if(g[1]===u.name)return u.protyleSlash.find(f=>{if(f.id===g[2])return f.callback(a.getInstance(),l),!0}),!0});return}else{s.deleteContents(),t!=="![]()"&&this.fixImageCursor(s);let u=t;t==="```"&&(u=t+(Constants.SIYUAN_RENDER_CODE_LANGUAGES.includes(window.siyuan.storage[Constants.LOCAL_CODELANG])?"":window.siyuan.storage[Constants.LOCAL_CODELANG])+Lute.Caret+"\n```");const g=getContenteditableElement(l);if(t==="![]()"){let f="";s.insertNode(document.createElement("wbr")),s.insertNode(document.createTextNode(t)),f=a.lute.SpinBlockDOM(l.outerHTML),l.outerHTML=f,l=a.wysiwyg.element.querySelector(`[data-node-id="${r}"]`),focusByWbr(l,s),updateTransaction(a,r,l.outerHTML,c);let p=s.startContainer.childNodes[s.startOffset-1]||s.startContainer;p&&p.nodeType!==3&&p.classList.contains("img")||(((i=p.previousSibling)==null?void 0:i.nodeType)!==3&&p.previousSibling.classList.contains("img")?p=p.previousSibling:Array.from(l.querySelectorAll(".img")).find(b=>{if(b.querySelector("img").getAttribute("data-src")==="")return p=b,!0}));const m=p.getBoundingClientRect();imgMenu(a,s,p,{clientX:m.left,clientY:m.top});return}else if(g.textContent===""&&l.getAttribute("data-type")==="NodeParagraph"){let f="";t==="<div>"?f=`<div data-node-id="${r}" data-type="NodeHTMLBlock" class="render-node" data-subtype="block">${genIconHTML()}<div><protyle-html data-content=""></protyle-html><span style="position: absolute">${Constants.ZWSP}</span></div><div class="protyle-attr" contenteditable="false"></div></div>`:(g.textContent=u,f=a.lute.SpinBlockDOM(l.outerHTML)),l.outerHTML=f,l=a.wysiwyg.element.querySelector(`[data-node-id="${r}"]`),l.getAttribute("data-type")==="NodeTable"&&(l.querySelectorAll("colgroup col").forEach(p=>{p.style.minWidth="60px"}),f=l.outerHTML),updateTransaction(a,r,f,c)}else{let f=a.lute.SpinBlockDOM(u);t==="<div>"&&(f=`<div data-node-id="${Lute.NewNodeID()}" data-type="NodeHTMLBlock" class="render-node" data-subtype="block">${genIconHTML()}<div><protyle-html data-content=""></protyle-html><span style="position: absolute">${Constants.ZWSP}</span></div><div class="protyle-attr" contenteditable="false"></div></div>`),l.insertAdjacentHTML("afterend",f);const p=l.outerHTML,m=f.substr(f.indexOf('data-node-id="')+14,22);l=a.wysiwyg.element.querySelector(`[data-node-id="${m}"]`),l.getAttribute("data-type")==="NodeTable"&&l.querySelectorAll("colgroup col").forEach(b=>{b.style.minWidth="60px"}),transaction(a,[{data:p,id:r,action:"update"},{data:l.outerHTML,id:m,previousID:r,action:"insert"}],[{id:m,action:"delete"},{data:c,id:r,action:"update"}])}if(t==="<div>"||t==="$$"||t.indexOf("```")>-1&&(t.length>3||l.classList.contains("render-node")))a.toolbar.showRender(a,l),processRender(l);else if(t.startsWith("```"))highlightRender(l);else if(t.startsWith("<iframe")||t.startsWith("<video")||t.startsWith("<audio")){a.gutter.renderMenu(a,l);const f=l.getBoundingClientRect();window.siyuan.menus.menu.popup({x:f.left,y:f.top,isLeft:!0});const p=window.siyuan.menus.menu.element.querySelector('[data-id="assetVideo"], [data-id="assetAudio"], [data-id="assetIFrame"]');p.classList.add("b3-menu__item--show"),window.siyuan.menus.menu.showSubMenu(p.querySelector(".b3-menu__submenu")),window.siyuan.menus.menu.element.querySelector("textarea").focus()}else t==="---"?focusBlock(l):l.classList.contains("av")?avRender(l,a,()=>{l.querySelector(".av__title").focus()}):focusByWbr(l,s)}}select(t,a){var n,o,i,s,l;const r=this.element.firstElementChild.classList.contains("emojis");if(this.element.querySelectorAll("button").length===0&&!r)return!1;if(t.key==="Enter"){if(r){const c=this.element.querySelector(".emojis__item--current");if(!c)return!1;const d=c.getAttribute("data-unicode");if(this.element.querySelectorAll(".emojis__title").length>2){const u=getSelection().getRangeAt(0);u.endContainer.nodeType!==3&&((n=u.endContainer.childNodes[u.endOffset-1])==null||n.remove()),addEmoji(d);let g;d.indexOf(".")>-1?g=`:${d.split(".")[0]}: `:g=unicode2Emoji(d)+" ",insertHTML(a.lute.SpinBlockDOM(g),a),this.element.classList.add("fn__none")}else this.fill(d,a)}else{const c=decodeURIComponent(this.element.querySelector(".b3-list-item--focus").getAttribute("data-value"));c===Constants.ZWSP+3?this.element.querySelector(".b3-list-item--focus input").click():this.fill(c,a,!0,isOnlyMeta(t))}return t.preventDefault(),t.stopPropagation(),!0}if(r){const c=this.element.querySelector(".emojis__item--current");if(!c)return!1;let d;if(t.key==="ArrowLeft")c.previousElementSibling?(c.classList.remove("emojis__item--current"),d=c.previousElementSibling):(o=c.parentElement.previousElementSibling)!=null&&o.previousElementSibling&&(c.classList.remove("emojis__item--current"),d=c.parentElement.previousElementSibling.previousElementSibling.lastElementChild);else if(t.key==="ArrowRight")c.nextElementSibling?(c.classList.remove("emojis__item--current"),d=c.nextElementSibling):(i=c.parentElement.nextElementSibling)!=null&&i.nextElementSibling&&(c.classList.remove("emojis__item--current"),d=c.parentElement.nextElementSibling.nextElementSibling.firstElementChild);else if(t.key==="ArrowDown"){if(c.nextElementSibling){c.classList.remove("emojis__item--current");let u=Math.floor(c.parentElement.clientWidth/(c.clientWidth+2));for(d=c;d.nextElementSibling&&u>0;)d=d.nextElementSibling,u--}else{const u=(s=c.parentElement.nextElementSibling)==null?void 0:s.nextElementSibling;u&&(d=u.firstElementChild,c.classList.remove("emojis__item--current"))}t.preventDefault(),t.stopPropagation()}else if(t.key==="ArrowUp"){if(c.previousElementSibling){c.classList.remove("emojis__item--current");let u=Math.floor(c.parentElement.clientWidth/(c.clientWidth+2));for(d=c;d.previousElementSibling&&u>0;)d=d.previousElementSibling,u--}else{const u=(l=c.parentElement.previousElementSibling)==null?void 0:l.previousElementSibling;u&&(d=u.lastElementChild,c.classList.remove("emojis__item--current"))}t.preventDefault(),t.stopPropagation()}if(d){d.classList.add("emojis__item--current");const u=this.element.querySelector(".emojis__panel");if(d.offsetTop-8<u.scrollTop)u.scrollTop=d.offsetTop-8;else{const g=u.nextElementSibling.classList.contains("fn__none")?8:36;d.offsetTop+g-this.element.clientHeight+d.clientHeight>u.scrollTop&&(u.scrollTop=d.offsetTop+g-this.element.clientHeight+d.clientHeight)}}return t.preventDefault(),t.stopPropagation(),!0}else if(t.key==="ArrowDown"||t.key==="ArrowUp")return upDownHint(this.element.firstElementChild,t),t.preventDefault(),t.stopPropagation(),!0;return t.key==="ArrowLeft"||t.key==="ArrowRight"?(hideElements(["hint"],a),!0):!1}fixImageCursor(t){const a=hasPreviousSibling(t.startContainer);a&&a.nodeType!==3&&a.classList.contains("img")&&(hasNextSibling(a)||(t.insertNode(document.createTextNode(Constants.ZWSP)),t.collapse(!1)))}getKey(t,a){if(this.lastIndex=-1,this.splitChar="",a.forEach(i=>{let s=t.lastIndexOf(i.key);Constants.BLOCK_HINT_KEYS.includes(i.key)&&s>-1&&t.lastIndexOf(i.key+i.key.substring(0,1))>-1&&(s=Math.min(s,t.lastIndexOf(i.key+i.key.substring(0,1)))),this.lastIndex<s&&(Constants.BLOCK_HINT_KEYS.includes(this.splitChar)&&(i.key===":"||i.key==="#"||i.key==="/"||i.key==="\u3001")||this.splitChar==="#"&&(i.key==="/"||i.key==="\u3001")||(this.splitChar=i.key,this.lastIndex=s))}),this.lastIndex===-1)return;this.splitChar===":"&&(this.enableEmoji=!(/\d/.test(t.substr(this.lastIndex-1,1))||t.substr(this.lastIndex-1,2)==="::"));const n=t.split(this.splitChar),o=n[n.length-1];if(n.length>1&&o.trimStart()===o&&o.length<Constants.SIZE_TITLE)return this.splitChar==="\u3010\u3010"&&t.endsWith("\u3010\u3010\u3011")?"":o}}const Nc=(e,t)=>{if(typeof speechSynthesis=="undefined"||typeof SpeechSynthesisUtterance=="undefined")return;const a='<svg><use xlink:href="#iconPlay"></use></svg>',n='<svg><use xlink:href="#iconPause"></use></svg>';let o=document.querySelector(".protyle-speech");if(!o){o=document.createElement("div"),o.className="protyle-speech",document.body.insertAdjacentElement("beforeend",o);const i=()=>{const l=speechSynthesis.getVoices();let r,c;return l.forEach(d=>{d.lang===t.replace("_","-")&&(r=d),d.default&&(c=d)}),r||(r=c),r};speechSynthesis.onvoiceschanged!==void 0&&(speechSynthesis.onvoiceschanged=i);const s=i();o.onclick=()=>{if(o.className==="protyle-speech"){const l=new SpeechSynthesisUtterance(o.getAttribute("data-text"));l.voice=s,l.onend=()=>{o.className="protyle-speech",speechSynthesis.cancel(),o.innerHTML=a},speechSynthesis.speak(l),o.className="protyle-speech protyle-speech--current",o.innerHTML=n}else speechSynthesis.speaking&&(speechSynthesis.paused?(speechSynthesis.resume(),o.innerHTML=n):(speechSynthesis.pause(),o.innerHTML=a));focusByRange(window.protyleSpeechRange)},document.body.addEventListener("click",()=>{getSelection().toString().trim()===""&&o.style.display==="block"&&(o.className="protyle-speech",speechSynthesis.cancel(),o.style.display="none")})}e.addEventListener("mouseup",i=>{const s=getSelection().toString().trim();if(speechSynthesis.cancel(),getSelection().toString().trim()===""){o.style.display==="block"&&(o.className="protyle-speech",o.style.display="none");return}window.protyleSpeechRange=getSelection().getRangeAt(0).cloneRange();const l=getSelection().getRangeAt(0).getBoundingClientRect();o.innerHTML=a,o.style.display="block",o.style.top=l.top+l.height+document.querySelector("html").scrollTop-20+"px",o.style.left=i.screenX+2+"px",o.setAttribute("data-text",s)})};class Bc{constructor(t){this.element=document.createElement("div"),this.element.className="protyle-preview fn__none";const a=document.createElement("div");a.className="b3-typography",t.options.classes.preview&&a.classList.add(t.options.classes.preview);const n=t.options.preview.actions,o=document.createElement("div");o.className="protyle-preview__action";const i=[];for(let s=0;s<n.length;s++){const l=n[s];if(typeof l=="object"){i.push(`<button type="button" data-type="${l.key}" class="${l.className}">${l.text}</button>`);continue}switch(l){case"desktop":i.push(`<button type="button" class="protyle-preview__action--current" data-type="desktop">${window.siyuan.languages.desktop}</button>`);break;case"tablet":i.push(`<button type="button" data-type="tablet">${window.siyuan.languages.tablet}</button>`);break;case"mobile":i.push(`<button type="button" data-type="mobile">${window.siyuan.languages.mobile}</button>`);break;case"mp-wechat":i.push(`<button type="button" data-type="mp-wechat" class="b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.copyToWechatMP}"><svg><use xlink:href="#iconMp"></use></svg></button>`);break;case"zhihu":i.push(`<button type="button" data-type="zhihu" class="b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.copyToZhihu}"><svg><use xlink:href="#iconZhihu"></use></svg></button>`);break;case"yuque":i.push(`<button type="button" data-type="yuque" class="b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.copyToYuque}"><svg><use xlink:href="#iconYuque"></use></svg></button>`);break}}o.innerHTML=i.join(""),this.element.appendChild(o),this.element.appendChild(a),this.element.addEventListener("click",s=>{let l=s.target;for(;l&&!l.isEqualNode(this.element);){if(l.tagName==="A"){const c=l.getAttribute("href");if(c.startsWith("#")){const d=c.substring(1);a.querySelector('[data-node-id="'+d+'"], [id="'+d+'"]').scrollIntoView(),s.stopPropagation(),s.preventDefault();break}if(isMobile()){openByMobile(c),s.stopPropagation(),s.preventDefault();break}s.stopPropagation(),s.preventDefault(),isLocalPath(c)||window.open(c);break}else if(l.tagName==="IMG"){previewDocImage(s.target.getAttribute("src"),t.block.rootID),s.stopPropagation(),s.preventDefault();break}else if(l.tagName==="BUTTON"){const c=l.getAttribute("data-type"),d=n.find(u=>(u==null?void 0:u.key)===c);d?d.click(c):c==="mp-wechat"||c==="zhihu"||c==="yuque"?this.copyToX(this.element.lastElementChild.cloneNode(!0),t,c):c==="desktop"?(a.style.width="",a.style.padding=t.wysiwyg.element.style.padding):c==="tablet"?(a.style.width="1024px",a.style.padding="8px 16px"):(a.style.width="360px",a.style.padding="8px"),c!=="mp-wechat"&&c!=="zhihu"&&c!=="yuque"&&(o.querySelectorAll("button").forEach(u=>{u.classList.remove("protyle-preview__action--current")}),l.classList.add("protyle-preview__action--current"))}l=l.parentElement}const r=hasClosestByAttribute(s.target,"id",void 0);r&&(this.element.querySelectorAll(".protyle-wysiwyg--select").forEach(c=>{c.classList.remove("selected")}),r.classList.add("selected"))}),this.previewElement=a}render(t){var a;if(this.element.style.display==="none")return;if((a=this.element.querySelector('.protyle-preview__action [data-type="desktop"]'))!=null&&a.classList.contains("protyle-preview__action--current")){const o=getPadding(t);this.previewElement.style.padding=`${o.top}px ${o.left}px ${o.bottom}px ${o.right}px`}let n=this.element.querySelector(".fn__loading");n||(this.element.insertAdjacentHTML("beforeend",`<div style="flex-direction: column;" class="fn__loading">
    <img width="48px" src="/stage/loading-pure.svg">
</div>`),n=this.element.querySelector(".fn__loading")),this.mdTimeoutId=window.setTimeout(()=>{fetchPost("/api/export/preview",{id:t.block.parentID||t.options.blockId},o=>{const i=t.preview.previewElement.scrollTop;t.preview.previewElement.innerHTML=o.data.html,processRender(t.preview.previewElement),highlightRender(t.preview.previewElement),avRender(t.preview.previewElement,t),speechRender(t.preview.previewElement,t.options.lang),t.preview.previewElement.scrollTop=i,n.remove()})},t.options.preview.delay)}link2online(t){needSubscribe("")||t.querySelectorAll("[href],[src]").forEach(a=>{const n=a.getAttribute("href")||a.getAttribute("src");if(n&&n.startsWith("assets/")){const o=Constants.ASSETS_ADDRESS+window.siyuan.user.userId+"/"+n;a.getAttribute("href")?a.setAttribute("href",o):a.setAttribute("src",o)}})}copyToX(t,a,n){if(n==="mp-wechat")this.link2online(t),t.querySelectorAll(".katex-html .base").forEach(s=>{s.style.display="initial"}),t.querySelectorAll("mjx-container > svg").forEach(s=>{s.setAttribute("width",parseInt(s.getAttribute("width"))*8+"px")});else if(n==="zhihu")this.link2online(t),t.querySelectorAll('[data-subtype="math"]').forEach(s=>{s.outerHTML=`<img class="Formula-image" data-eeimg="true" src="//www.zhihu.com/equation?tex=" alt="${s.getAttribute("data-content")}" style="${s.tagName==="DIV"?"display: block; max-width: 100%;":""}margin: 0 auto;">`}),t.querySelectorAll("blockquote").forEach(s=>{const l=[];this.processZHBlockquote(s,l),l.reverse().forEach(r=>{s.insertAdjacentElement("afterend",r)}),s.remove()}),this.processZHTable(t);else if(n==="yuque"){fetchPost("/api/lute/copyStdMarkdown",{id:a.block.rootID},s=>{writeText(s.data),showMessage(`${window.siyuan.languages.pasteToYuque}`)});return}t.style.backgroundColor="#fff",t.querySelectorAll("code").forEach(s=>{s.style.backgroundImage="none"}),this.element.append(t);let o;getSelection().rangeCount>0&&(o=getSelection().getRangeAt(0).cloneRange());const i=t.ownerDocument.createRange();i.selectNodeContents(t),focusByRange(i),document.execCommand("copy"),this.element.lastElementChild.remove(),focusByRange(o),n&&showMessage(`${n==="zhihu"?window.siyuan.languages.pasteToZhihu:window.siyuan.languages.pasteToWechatMP}`)}processZHBlockquote(t,a){Array.from(t.children).forEach(n=>{if(n.tagName==="BLOCKQUOTE")this.processZHBlockquote(n,a);else if(n.tagName!=="P"||n.querySelector("img"))a.push(n);else{const o=a[a.length-1];(!o||o&&o.tagName!=="BLOCKQUOTE")&&a.push(document.createElement("blockquote")),a[a.length-1].append(n)}})}processZHTable(t){t.querySelectorAll("table").forEach(a=>{const n=a.querySelector("thead");if(!n)return;const o=a.querySelector("tbody");o?o.insertAdjacentElement("afterbegin",n.firstElementChild):a.innerHTML=`<tbody>${n.innerHTML}</tbody>`,n.remove()})}}class Pc{constructor(t){this.defaultOptions={mode:"wysiwyg",blockId:"",render:{background:!1,title:!1,gutter:!0,scroll:!1,breadcrumb:!0,breadcrumbDocName:!1},action:[],after:void 0,classes:{preview:""},hint:{delay:200,emoji:{"+1":"\u{1F44D}","-1":"\u{1F44E}",confused:"\u{1F615}",eyes:"\u{1F440}\uFE0F",heart:"\u2764\uFE0F",rocket:"\u{1F680}\uFE0F",smile:"\u{1F604}",tada:"\u{1F389}\uFE0F"},emojiPath:"/emojis",extend:[{key:"((",hint:hintRef},{key:"\u3010\u3010",hint:hintRef},{key:"\uFF08\uFF08",hint:hintRef},{key:"[[",hint:hintRef},{key:"{{",hint:hintEmbed},{key:"\u300C\u300C",hint:hintEmbed},{key:"\u300C\u300E",hint:hintEmbed},{key:"\u300E\u300C",hint:hintEmbed},{key:"\u300E\u300E",hint:hintEmbed},{key:"#",hint:hintTag},{key:"/",hint:hintSlash},{key:"\u3001",hint:hintSlash},{key:":"}]},lang:window.siyuan.config.appearance.lang,preview:{actions:["desktop","tablet","mobile","mp-wechat","zhihu","yuque"],delay:0,markdown:{paragraphBeginningSpace:window.siyuan.config.export.paragraphBeginningSpace,listStyle:!1,sanitize:!0},mode:"both"},toolbar:Constants.PROTYLE_TOOLBAR,typewriterMode:!1,upload:{max:1024*1024*1024*8,url:Constants.UPLOAD_ADDRESS,extraData:{},fieldName:"file[]",filename:a=>a.replace(/[\\/:*?"'<>|\[\]\(\)~!`&{}=#%$]/g,""),linkToImgUrl:"",withCredentials:!1}},this.options=t}merge(){var t;return this.options&&(this.options.toolbar?this.options.toolbar=this.mergeToolbar(this.options.toolbar):this.options.toolbar=this.mergeToolbar(this.defaultOptions.toolbar),(t=this.options.hint)!=null&&t.emoji&&(this.defaultOptions.hint.emoji=this.options.hint.emoji)),merge(this.defaultOptions,this.options)}mergeToolbar(t){return toolbarKeyToMenu(t)}}const Rc=(e,t)=>{e.element.querySelector(".wysiwygLoading")||(addLoading(e),hideElements(["toolbar"],e),fetchPost(`/api/format/net${t}2LocalAssets`,{id:e.block.rootID},()=>{reloadProtyle(e,!1)}))},Oc=(e,t)=>{var a,n;setTimeout(()=>{hideAllElements(["gutter"])},Constants.TIMEOUT_TRANSITION);const o=e.className.includes("fullscreen");if(o?(e.classList.remove("fullscreen"),(a=document.getElementById("drag"))==null||a.classList.remove("fn__hidden")):(e.classList.add("fullscreen"),(n=document.getElementById("drag"))==null||n.classList.add("fn__hidden")),isWindow(),t){o?t.querySelector("use").setAttribute("xlink:href","#iconFullscreen"):t.querySelector("use").setAttribute("xlink:href","#iconFullscreenExit");const i=hasClosestByClassName(e,"layout--float");i&&(o?(i.setAttribute("data-temp",i.style.transform),i.style.transform="none"):(i.style.transform=i.getAttribute("data-temp"),i.removeAttribute("data-temp")));return}},oo=(e,t)=>{if(!window.siyuan.config.readonly){const a=e.querySelector("use").getAttribute("xlink:href")!=="#iconUnlock";window.siyuan.config.editor.readOnly?a?Us(t):Ea(t):he("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{[S.CUSTOM_SY_READONLY]:a?"false":"true"}})}},qc=(e,t,a)=>{if(matchHotKey(window.siyuan.config.keymap.editor.general.netImg2LocalAsset.custom,t))return net2LocalAssets(e,"Img"),t.preventDefault(),t.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.general.netAssets2LocalAssets.custom,t))return net2LocalAssets(e,"Assets"),t.preventDefault(),t.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.general.optimizeTypography.custom,t))return fetchPost("/api/format/autoSpace",{id:e.block.rootID}),t.preventDefault(),t.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.general.copyHPath.custom,t))return fetchPost("/api/filetree/getHPathByID",{id:e.block.rootID},n=>{writeText(n.data)}),t.preventDefault(),t.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.general.copyProtocolInMd.custom,t)){if(a){const n=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));n.length===0&&n.push(a),copyTextByType(n.map(o=>o.getAttribute("data-node-id")),"protocolMd")}else copyTextByType([e.block.rootID],"protocolMd");return t.preventDefault(),t.stopPropagation(),!0}if(matchHotKey(window.siyuan.config.keymap.editor.general.copyID.custom,t)){if(a){const n=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));n.length===0&&n.push(a),copyTextByType(n.map(o=>o.getAttribute("data-node-id")),"id")}else copyTextByType([e.block.rootID],"id");return t.preventDefault(),t.stopPropagation(),!0}if(matchHotKey(window.siyuan.config.keymap.editor.general.copyProtocol.custom,t)){if(a){const n=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));n.length===0&&n.push(a),copyTextByType(n.map(o=>o.getAttribute("data-node-id")),"protocol")}else copyTextByType([e.block.rootID],"protocol");return t.preventDefault(),t.stopPropagation(),!0}if(matchHotKey(window.siyuan.config.keymap.editor.general.copyBlockEmbed.custom,t)){if(a){const n=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));n.length===0&&n.push(a),copyTextByType(n.map(o=>o.getAttribute("data-node-id")),"blockEmbed")}else copyTextByType([e.block.rootID],"blockEmbed");return t.preventDefault(),t.stopPropagation(),!0}},Uc=e=>{const t=e.protyle.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(t.length>0)e.event.stopPropagation(),e.event.preventDefault();else{const o=hasClosestByTag(e.range.startContainer,"TD")||hasClosestByTag(e.range.startContainer,"TH")||getContenteditableElement(e.nodeElement)||e.nodeElement,i=getSelectionOffset(o,e.editorElement,e.range).start,s=o.innerText,l=matchHotKey(window.siyuan.config.keymap.editor.general.expandUp.custom,e.event);if(!(!isMac()&&l)){if(i>0){s.substr(0,i).indexOf(`
`)===-1&&e.range.getBoundingClientRect().top-o.getBoundingClientRect().top-parseInt(getComputedStyle(o).paddingTop)<14&&(setFirstNodeRange(o,e.range),e.event.preventDefault());return}}}e.range.collapse(!0),hideElements(["toolbar"],e.protyle),t.length===0?e.nodeElement.classList.add("protyle-wysiwyg--select"):e.cb(t);const a=[];e.protyle.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").forEach(n=>{a.push(n.getAttribute("data-node-id"))}),countBlockWord(a,e.protyle.block.rootID),e.event.stopPropagation(),e.event.preventDefault()},Fc=e=>{const t=e.protyle.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(t.length>0)e.event.stopPropagation(),e.event.preventDefault();else{const o=hasClosestByTag(e.range.startContainer,"TD")||hasClosestByTag(e.range.startContainer,"TH")||getContenteditableElement(e.nodeElement)||e.nodeElement,i=getSelectionOffset(o,e.editorElement,e.range).end,s=o.innerText,l=matchHotKey(window.siyuan.config.keymap.editor.general.expandDown.custom,e.event);if(!(!isMac()&&l)){if(i<s.length){!getNextBlock(e.nodeElement)&&s.trimRight().substr(i).indexOf(`
`)===-1&&o.getBoundingClientRect().bottom-e.range.getBoundingClientRect().bottom-parseInt(getComputedStyle(o).paddingBottom)<14&&(setLastNodeRange(o,e.range,!1),e.nodeElement.classList.contains("code-block")&&l&&e.event.preventDefault());return}}}e.range.collapse(!1),hideElements(["toolbar"],e.protyle),t.length===0?e.nodeElement.classList.add("protyle-wysiwyg--select"):e.cb(t);const a=[];e.protyle.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").forEach(n=>{a.push(n.getAttribute("data-node-id"))}),countBlockWord(a,e.protyle.block.rootID),e.event.stopPropagation(),e.event.preventDefault()},Yc=e=>{let t,a;return e.forEach(n=>{n.getAttribute("select-start")&&(t=n),n.getAttribute("select-end")&&(a=n)}),t||(t=e[0],t.setAttribute("select-start","true")),a||(a=e[e.length-1],a.setAttribute("select-end","true")),{startElement:t,endElement:a}},Wc=(e,t)=>{let a;const n=[],o=[];let i;if(e[e.length-1].classList.contains("li")&&e[e.length-1].getAttribute("data-subtype")==="o"&&(i=parseInt(e[e.length-1].getAttribute("data-marker"),10)),e.reverse().forEach((s,l)=>{var r;const c=s.cloneNode(!0);l===0&&(a=c);const d=Lute.NewNodeID();if(c.setAttribute("data-node-id",d),c.setAttribute("data-node-id",d),c.removeAttribute(Constants.CUSTOM_RIFF_DECKS),c.classList.remove("protyle-wysiwyg--select","protyle-wysiwyg--hl"),c.setAttribute("updated",d.split("-")[0]),c.removeAttribute("refcount"),(r=c.lastElementChild.querySelector(".protyle-attr--refcount"))==null||r.remove(),c.querySelectorAll("[data-node-id]").forEach(u=>{var g;u.setAttribute("data-node-id",d),u.removeAttribute(Constants.CUSTOM_RIFF_DECKS),u.classList.remove("protyle-wysiwyg--select","protyle-wysiwyg--hl"),u.setAttribute("updated",d.split("-")[0]),u.removeAttribute("refcount"),(g=u.lastElementChild.querySelector(".protyle-attr--refcount"))==null||g.remove()}),s.classList.remove("protyle-wysiwyg--select"),typeof i=="number"){const u=i+(e.length-l);c.setAttribute("data-marker",u+"."),c.querySelector(".protyle-action--order").textContent=u+"."}e[0].after(processClonePHElement(c)),n.push({action:"insert",data:c.outerHTML,id:d,previousID:e[0].getAttribute("data-node-id")}),o.push({action:"delete",id:d})}),typeof i=="number"){let s=a.nextElementSibling;for(i=i+e.length;s&&s.getAttribute("data-subtype")==="o";){i++;const l=s.getAttribute("data-node-id");o.push({action:"update",id:l,data:s.outerHTML}),s.setAttribute("data-marker",i+"."),s.querySelector(".protyle-action--order").textContent=i+".",n.push({action:"update",data:s.outerHTML,id:l}),s=s.nextElementSibling}}transaction(t,n,o),focusBlock(a),scrollCenter(t)},jc=e=>{e.wysiwyg.element.firstElementChild.getAttribute("data-node-index")==="0"||e.wysiwyg.element.firstElementChild.getAttribute("data-eof")==="1"||e.options.backlinkData?(focusBlock(e.wysiwyg.element.firstElementChild),e.contentElement.scrollTop=0,e.scroll.lastScrollTop=1):fetchPost("/api/filetree/getDoc",{id:e.block.rootID,mode:0,size:window.siyuan.config.editor.dynamicLoadBlocks},t=>{onGet({data:t,protyle:e,action:[Constants.CB_GET_FOCUS]})})},Vc=e=>{!e.scroll.element.classList.contains("fn__none")&&e.wysiwyg.element.lastElementChild.getAttribute("data-eof")!=="2"?fetchPost("/api/filetree/getDoc",{id:e.block.rootID,mode:4,size:window.siyuan.config.editor.dynamicLoadBlocks},t=>{onGet({data:t,protyle:e,action:[Constants.CB_GET_FOCUS],afterCB(){focusBlock(e.wysiwyg.element.lastElementChild,void 0,!1)}})}):(e.contentElement.scrollTop=e.contentElement.scrollHeight,e.scroll.lastScrollTop=e.contentElement.scrollTop,focusBlock(e.wysiwyg.element.lastElementChild,void 0,!1))},Gc=(e,t,a,n,o)=>{t.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),a.forEach(i=>{i.style.minWidth="calc(100% - 0.1em)"}),updateTransaction(e,n,t.outerHTML,o)},Kc=(e,t,a,n,o)=>{t.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),a.forEach(i=>{i.removeAttribute("style")}),updateTransaction(e,n,t.outerHTML,o)};class zc{constructor(t){this.parentElement=document.createElement("div"),this.parentElement.classList.add("protyle-scroll"),this.parentElement.innerHTML=`<div class="protyle-scroll__up ariaLabel" data-position="north" aria-label="${updateHotkeyTip("\u2318Home")}">
    <svg><use xlink:href="#iconUp"></use></svg>
</div>
<div class="fn__none protyle-scroll__bar ariaLabel" data-position="2west" aria-label="Blocks 1/1">
    <input class="b3-slider" type="range" max="1" min="1" step="1" value="1" />
</div>
<div class="protyle-scroll__down ariaLabel" aria-label="${updateHotkeyTip("\u2318End")}">
    <svg><use xlink:href="#iconDown"></use></svg>
</div>`,this.element=this.parentElement.querySelector(".protyle-scroll__bar"),this.keepLazyLoad=!1,t.options.render.scroll||this.parentElement.classList.add("fn__none"),this.lastScrollTop=0,this.inputElement=this.element.firstElementChild,this.inputElement.addEventListener("input",()=>{this.element.setAttribute("aria-label",`Blocks ${this.inputElement.value}/${t.block.blockCount}`),showTooltip(this.element.getAttribute("aria-label"),this.element)}),this.inputElement.addEventListener("change",()=>{this.setIndex(t)}),this.inputElement.addEventListener("touchend",()=>{this.setIndex(t)}),this.parentElement.addEventListener("click",a=>{const n=a.target;hasClosestByClassName(n,"protyle-scroll__up")?goHome(t):hasClosestByClassName(n,"protyle-scroll__down")?goEnd(t):n.classList.contains("b3-slider")&&this.setIndex(t)}),this.parentElement.addEventListener("mousewheel",a=>{a.deltaY!==0&&t.scroll.lastScrollTop!==-1&&(t.contentElement.scrollTop+=a.deltaY)},{passive:!0})}setIndex(t){t.wysiwyg.element.getAttribute("data-top")||(t.wysiwyg.element.setAttribute("data-top",t.wysiwyg.element.scrollTop.toString()),t.contentElement.style.overflow="hidden",fetchPost("/api/filetree/getDoc",{index:parseInt(this.inputElement.value),id:t.block.parentID,mode:0,size:window.siyuan.config.editor.dynamicLoadBlocks},a=>{onGet({data:a,protyle:t,action:[Constants.CB_GET_FOCUSFIRST,Constants.CB_GET_UNCHANGEID],afterCB:()=>{setTimeout(()=>{t.contentElement.style.overflow=""},Constants.TIMEOUT_INPUT),showTooltip(this.element.getAttribute("aria-label"),this.element)}})}))}updateIndex(t,a,n){fetchPost("/api/block/getBlockIndex",{id:a},o=>{if(!o.data)return;const i=t.scroll.element.querySelector(".b3-slider");i.value=o.data,t.scroll.element.setAttribute("aria-label",`Blocks ${o.data}/${t.block.blockCount}`),n&&n(o.data)})}update(t){typeof t.block.blockCount=="number"&&(this.inputElement.setAttribute("max",t.block.blockCount.toString()),this.element.setAttribute("aria-label",`Blocks ${this.inputElement.value}/${t.block.blockCount}`)),t.block.showAll?this.element.classList.add("fn__none"):t.block.scroll&&!t.contentElement.classList.contains("fn__none")?this.element.classList.remove("fn__none"):this.element.classList.add("fn__none")}}class Zc{constructor(t){this.app=t.app,t.msgCallback&&this.connect(t)}connect(t){const a=`${window.location.protocol==="https:"?"wss":"ws"}://${window.location.host}/ws`,n=new WebSocket(`${a}?app=${Constants.SIYUAN_APPID}&id=${t.id}${t.type?"&type="+t.type:""}`);n.onopen=()=>{t.callback&&t.callback.call(this),document.getElementById("errorLog")&&(reloadSync(this.app,{upsertRootIDs:[],removeRootIDs:[]}),window.siyuan.dialogs.find(i=>{if(i.element.id==="errorLog")return i.destroy(),!0}))},n.onmessage=o=>{if(t.msgCallback){const i=processMessage(JSON.parse(o.data));t.msgCallback.call(this,i)}},n.onclose=o=>{0<=o.reason.indexOf("unauthenticated")||0>o.reason.indexOf("close websocket")&&(console.warn("WebSocket is closed. Reconnect will be attempted in 3 second.",o),setTimeout(()=>{this.connect({id:t.id,type:t.type,msgCallback:t.msgCallback})},3e3))},n.onerror=o=>{o.target.url.endsWith("&type=main")&&o.target.readyState===3&&kernelError()},this.ws=n}send(t,a,n=!1){this.ws&&(this.reqId=n?0:new Date().getTime(),this.ws.send(JSON.stringify({cmd:t,reqId:this.reqId,param:a})))}}var ia=(e,t,a)=>new Promise((n,o)=>{var i=r=>{try{l(a.next(r))}catch(c){o(c)}},s=r=>{try{l(a.throw(r))}catch(c){o(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(i,s);l((a=a.apply(e,t)).next())});const lo=e=>{const t=e.dataset.type;let a="";if(["NodeHeading","NodeParagraph"].includes(t))a=getContenteditableElement(e).innerHTML;else if(t==="NodeHTMLBlock")a="HTML";else if(t==="NodeAttributeView")a=e.querySelector(".av__title").textContent||window.siyuan.languages.database;else if(t==="NodeThematicBreak")a=window.siyuan.languages.line;else if(t==="NodeIFrame")a="IFrame";else if(t==="NodeWidget")a=window.siyuan.languages.widget;else if(t==="NodeVideo")a=window.siyuan.languages.video;else if(t==="NodeAudio")a=window.siyuan.languages.audio;else if(["NodeCodeBlock","NodeTable"].includes(t))a=Gn(e);else if(e.classList.contains("render-node"))a+=e.dataset.subtype||Lute.UnEscapeHTMLStr(e.getAttribute("data-content"));else if(["NodeBlockquote","NodeList","NodeSuperBlock","NodeListItem"].includes(t)&&(Array.from(e.querySelectorAll("[data-node-id]")).find(n=>{if(!["NodeBlockquote","NodeList","NodeSuperBlock","NodeListItem"].includes(n.getAttribute("data-type")))return a=lo(e.querySelector("[data-node-id]")),!0}),a))return a;return a+` <span data-type="block-ref" data-subtype="s" data-id="${e.getAttribute("data-node-id")}">*</span>`},Gn=(e,t=!1)=>{let a="";const n=e.dataset.type;return n==="NodeHTMLBlock"?a+=Lute.UnEscapeHTMLStr(e.querySelector("protyle-html").getAttribute("data-content")):n==="NodeAttributeView"?(e.querySelectorAll(".av__row").forEach(o=>{o.querySelectorAll(".av__cell").forEach(i=>{a+=getCellText(i)+" "}),a+=`
`}),a=a.trimEnd()):n==="NodeThematicBreak"?a+="---":n==="NodeIFrame"||n==="NodeWidget"?a+=e.querySelector("iframe").getAttribute("src"):n==="NodeVideo"?a+=e.querySelector("video").getAttribute("src"):n==="NodeAudio"?a+=e.querySelector("audio").getAttribute("src"):e.classList.contains("render-node")?a+=Lute.UnEscapeHTMLStr(e.getAttribute("data-content")):["NodeHeading","NodeParagraph","NodeCodeBlock","NodeTable"].includes(n)?a+=e.querySelector("[spellcheck]").textContent:!t&&["NodeBlockquote","NodeList","NodeSuperBlock","NodeListItem"].includes(n)&&e.querySelectorAll("[data-node-id]").forEach(o=>{const i=Gn(o,!0);a+=i?i+`
`:""}),a},Xc=(e,t)=>ia(void 0,null,function*(){try{let a=yield readText();a=a.replace(/<span data-type="text".*?>(.*?)<\/span>/g,"$1"),a=a.replace(/\\/g,"\\\\").replace(/\*/g,"\\*").replace(/_/g,"\\_").replace(/\[/g,"\\[").replace(/]/g,"\\]").replace(/!/g,"\\!").replace(/`/g,"\\`").replace(/</g,"\\<").replace(/>/g,"\\>").replace(/&/g,"\\&").replace(/~/g,"\\~").replace(/\{/g,"\\{").replace(/}/g,"\\}").replace(/\(/g,"\\(").replace(/\)/g,"\\)").replace(/=/g,"\\=").replace(/#/g,"\\#").replace(/\$/g,"\\$").replace(/\^/g,"\\^").replace(/\|/g,"\\|").replace(/\./g,"\\."),uo(e,{textPlain:a,textHTML:"",target:t})}catch(a){console.log(a)}}),oa=(e,t)=>{let a=!0;e.options.hint.extend.find(n=>{if(n.key===t)return a=!1,!0}),a&&e.hint.render(e)},Jc=e=>ia(void 0,null,function*(){[].length===0&&navigator.clipboard.readText().then(a=>{if(getSelection().rangeCount>0){const o=getSelection().getRangeAt(0);if(hasClosestByAttribute(o.startContainer,"data-type","code")||hasClosestByClassName(o.startContainer,"hljs")){insertHTML(a.replace(/\u200D```/g,"```").replace(/```/g,"\u200D```"),e);return}}a=a.replace(/<sub>/g,"__@sub@__").replace(/<\/sub>/g,"__@/sub@__"),a=a.replace(/<sup>/g,"__@sup@__").replace(/<\/sup>/g,"__@/sup@__"),a=a.replace(/<kbd>/g,"__@kbd@__").replace(/<\/kbd>/g,"__@/kbd@__"),a=a.replace(/<u>/g,"__@u@__").replace(/<\/u>/g,"__@/u@__"),a=a.replace(/<span data-type="text".*?>(.*?)<\/span>/g,"$1"),a=a.replace(/</g,";;;lt;;;").replace(/>/g,";;;gt;;;"),a=a.replace(/__@sub@__/g,"<sub>").replace(/__@\/sub@__/g,"</sub>"),a=a.replace(/__@sup@__/g,"<sup>").replace(/__@\/sup@__/g,"</sup>"),a=a.replace(/__@kbd@__/g,"<kbd>").replace(/__@\/kbd@__/g,"</kbd>"),a=a.replace(/__@u@__/g,"<u>").replace(/__@\/u@__/g,"</u>"),ro(e);const n=e.lute.BlockDOM2EscapeMarkerContent(e.lute.Md2BlockDOM(a));co(e),insertHTML(n,e,!1,!1,!0),oa(e,a)})}),ro=e=>{e.lute.SetInlineAsterisk(!0),e.lute.SetGFMStrikethrough(!0),e.lute.SetInlineMath(!0),e.lute.SetSub(!0),e.lute.SetSup(!0),e.lute.SetTag(!0),e.lute.SetInlineUnderscore(!0)},co=e=>{e.lute.SetInlineAsterisk(window.siyuan.config.editor.markdown.inlineAsterisk),e.lute.SetGFMStrikethrough(window.siyuan.config.editor.markdown.inlineStrikethrough),e.lute.SetInlineMath(window.siyuan.config.editor.markdown.inlineMath),e.lute.SetSub(window.siyuan.config.editor.markdown.inlineSub),e.lute.SetSup(window.siyuan.config.editor.markdown.inlineSup),e.lute.SetTag(window.siyuan.config.editor.markdown.inlineTag),e.lute.SetInlineUnderscore(window.siyuan.config.editor.markdown.inlineUnderscore),e.lute.SetMark(window.siyuan.config.editor.markdown.inlineMark)},Qc=(e,t)=>ia(void 0,null,function*(){if(e&&e.app&&e.app.plugins)for(let a=0;a<e.app.plugins.length;a++){const n=yield new Promise(o=>{e.app.plugins[a].eventBus.emit("paste",{protyle:e,resolve:o,textHTML:"",textPlain:"",siyuanHTML:"",files:t})&&o(void 0)});n!=null&&n.files&&(t=n.files)}uploadLocalFiles(t,e,!0)}),uo=(e,t)=>ia(void 0,null,function*(){("clipboardData"in t||"dataTransfer"in t)&&(t.stopPropagation(),t.preventDefault());let a,n,o,i;if("clipboardData"in t?(a=t.clipboardData.getData("text/html"),n=t.clipboardData.getData("text/plain"),o=t.clipboardData.getData("text/siyuan"),i=t.clipboardData.files):"dataTransfer"in t?(a=t.dataTransfer.getData("text/html"),n=t.dataTransfer.getData("text/plain"),o=t.dataTransfer.getData("text/siyuan"),t.dataTransfer.types[0]==="Files"&&(i=t.dataTransfer.items)):(a=t.textHTML,n=t.textPlain,i=t.files),n=n.replace(/\r\n|\r|\u2028|\u2029/g,`
`),(a.replace(/&amp;/g,"&").replace(/<(|\/)(html|body|meta)[^>]*?>/ig,"").trim()===`<a href="${n}">${n}</a>`||a.replace(/&amp;/g,"&").replace(/<(|\/)(html|body|meta)[^>]*?>/ig,"").trim()===`<!--StartFragment--><a href="${n}">${n}</a><!--EndFragment-->`)&&(a=""),n.endsWith(Constants.ZWSP)&&!a&&!o&&(o=n.substr(0,n.length-1)),!o){const d=new DOMParser().parseFromString(a,"text/html");d.body&&d.body.innerHTML&&(a=d.body.innerHTML),a.startsWith(`
<!--StartFragment-->`)&&a.endsWith(`<!--EndFragment-->

`)&&(a=d.body.innerHTML.trim().replace("<!--StartFragment-->","").replace("<!--EndFragment-->","")),a=Lute.Sanitize(a)}if(e&&e.app&&e.app.plugins)for(let d=0;d<e.app.plugins.length;d++){const u=yield new Promise(g=>{e.app.plugins[d].eventBus.emit("paste",{protyle:e,resolve:g,textHTML:a,textPlain:n,siyuanHTML:o,files:i})&&g(void 0)});u!=null&&u.textHTML&&(a=u.textHTML),u!=null&&u.textPlain&&(n=u.textPlain),u!=null&&u.siyuanHTML&&(o=u.siyuanHTML),u!=null&&u.files&&(i=u.files)}const s=hasClosestBlock(t.target);if(!s){i&&i.length>0&&uploadFiles(e,i);return}hideElements(["select"],e),e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl").forEach(d=>{d.classList.remove("protyle-wysiwyg--hl")});const l=processPasteCode(a,n),r=getEditorRange(e.wysiwyg.element);if(s.getAttribute("data-type")==="NodeCodeBlock"||e.toolbar.getCurrentType(r).includes("code")){insertHTML(n.replace(/\u200D```/g,"```").replace(/```/g,"\u200D```"),e);return}else if(o){const d=document.createElement("div");d.innerHTML=o;let u=!1;d.querySelectorAll("[data-node-id]").forEach(f=>{const p=Lute.NewNodeID();f.setAttribute("data-node-id",p),f.removeAttribute(Constants.CUSTOM_RIFF_DECKS),f.classList.remove("protyle-wysiwyg--select","protyle-wysiwyg--hl"),f.setAttribute("updated",p.split("-")[0]),f.removeAttribute("refcount"),u=!0}),s.classList.contains("table")&&(u=!1),d.querySelectorAll('[contenteditable="false"][spellcheck]').forEach(f=>{f.setAttribute("contenteditable","true")});let g=d.innerHTML;if(!s.classList.contains("av")&&g.startsWith("[[{")&&g.endsWith("}]]"))try{const f=JSON.parse(g);f.length>0&&f[0].length>0&&f[0][0].id&&f[0][0].type?insertHTML(n,e,u):insertHTML(g,e,u)}catch(f){insertHTML(g,e,u)}else-1<g.indexOf("NodeHTMLBlock")&&(g=Lute.UnEscapeHTMLStr(g)),g=g.replace(/\u200D```/g,"```"),insertHTML(g,e,u,!1,!0);oa(e,e.lute.BlockDOM2StdMd(g)),blockRender(e,e.wysiwyg.element),processRender(e.wysiwyg.element),highlightRender(e.wysiwyg.element),avRender(e.wysiwyg.element,e)}else if(l)l.startsWith('<div data-type="NodeCodeBlock" class="code-block" data-node-id="')?(insertHTML(l,e,!0,!1,!0),highlightRender(e.wysiwyg.element)):insertHTML(l,e),hideElements(["hint"],e);else{let d=!1;if(a.replace("<!--StartFragment--><!--EndFragment-->","").trim()!==""&&(a=a.replace("<!--StartFragment-->","").replace("<!--EndFragment-->","").trim(),i&&i.length===1&&(a.startsWith("<img")||a.startsWith("<table")&&a.indexOf("<img")>-1)?d=!1:d=!0,n&&n.trim()!==""&&a.startsWith("<span")&&-1<a.indexOf("white-space: pre;")&&(d=!1)),d){const u=document.createElement("div");u.innerHTML=a,u.querySelectorAll("[style]").forEach(g=>{g.removeAttribute("style")}),u.querySelectorAll("a").forEach(g=>{g.innerHTML.trim()===""&&g.remove()}),fetchPost("/api/lute/html2BlockDOM",{dom:u.innerHTML},g=>{insertHTML(g.data,e,!1,!1,!0),e.wysiwyg.element.querySelectorAll('[data-type~="block-ref"]').forEach(f=>{f.textContent===""&&fetchPost("/api/block/getRefText",{id:f.getAttribute("data-id")},p=>{f.innerHTML=p.data})}),blockRender(e,e.wysiwyg.element),processRender(e.wysiwyg.element),highlightRender(e.wysiwyg.element),avRender(e.wysiwyg.element,e),oa(e,g.data),scrollCenter(e,void 0,!1,"smooth")});return}else if(i&&i.length>0){uploadFiles(e,i);return}else if(n.trim()!==""&&(i&&i.length===0||!i)){if(r.toString()!==""){const g=n.split(`
`)[0];if(isDynamicRef(n)){e.toolbar.setInlineMark(e,"block-ref","range",{type:"id",color:`${n.substring(2,22+2)}${Constants.ZWSP}s${Constants.ZWSP}${r.toString()}`});return}else if(isFileAnnotation(g)){e.toolbar.setInlineMark(e,"file-annotation-ref","range",{type:"file-annotation-ref",color:g.substring(2).replace(/ ".+">>$/,"")});return}else{const f=n.startsWith("assets/")?n:e.lute.GetLinkDest(n);if(f){e.toolbar.setInlineMark(e,"a","range",{type:"a",color:f});return}}}n=n.replace(/\u200D```/g,"```");const u=e.lute.Md2BlockDOM(n);insertHTML(u,e,!1,!1,!0),oa(e,n)}blockRender(e,e.wysiwyg.element),processRender(e.wysiwyg.element),highlightRender(e.wysiwyg.element),avRender(e.wysiwyg.element,e)}const c=s.querySelector(".av__cell--select");s.classList.contains("av")&&c?cellScrollIntoView(s,c):scrollCenter(e,void 0,!1,"smooth")});var la=(e,t,a)=>new Promise((n,o)=>{var i=r=>{try{l(a.next(r))}catch(c){o(c)}},s=r=>{try{l(a.throw(r))}catch(c){o(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(i,s);l((a=a.apply(e,t)).next())});const Kn=(e,t,a,n,o,i,s)=>{let l;const r=a.getAttribute("data-node-id"),c=n.getAttribute("data-node-id"),d=[],u=[];return a.insertAdjacentElement(i?"afterend":"beforebegin",n),i?d.push({action:"insert",data:n.outerHTML,id:c,previousID:r}):d.push({action:"insert",data:n.outerHTML,id:c,nextID:r}),t.reverse().forEach((g,f)=>{var p;const m=g.getAttribute("data-node-id");f===t.length-1&&(l=getTopAloneElement(g),l.isSameNode(g)&&(l=void 0,Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${g.getAttribute("data-node-id")}"]`)).find(w=>{if(!isInEmbedBlock(w)&&w.parentElement.querySelectorAll(".li").length===1)return l=w.parentElement,!0})));const b=Lute.NewNodeID();if(s?u.push({action:"delete",id:b}):u.push({action:"move",id:m,previousID:(p=g.previousElementSibling)==null?void 0:p.getAttribute("data-node-id"),parentID:g.parentElement.getAttribute("data-node-id")||e.block.rootID}),!o&&!s){const w=e.wysiwyg.element.querySelector(`[data-node-id="${m}"]`);w&&w.remove()}if(s){const w=g.cloneNode(!0);w.setAttribute("data-node-id",b),w.querySelectorAll("[data-node-id]").forEach(y=>{const _=Lute.NewNodeID();y.setAttribute("data-node-id",_),y.setAttribute("updated",_.split("-")[0])}),n.insertAdjacentElement("afterbegin",w),d.push({action:"insert",id:b,data:w.outerHTML,parentID:c})}else n.insertAdjacentElement("afterbegin",g),d.push({action:"move",id:m,parentID:c})}),u.reverse(),n.getAttribute("data-subtype")==="o"&&(u.splice(0,0,{action:"update",id:c,data:n.outerHTML}),updateListOrder(n,1),d.push({action:"update",id:c,data:n.outerHTML})),u.push({action:"delete",id:c}),{doOperations:d,undoOperations:u,topSourceElement:l}},zn=(e,t,a,n,o,i)=>la(void 0,null,function*(){let s;const l=[],r=[],c=[],d=a.getAttribute("data-node-id");let u=a;t.reverse().forEach((g,f)=>{var p,m,b,w,y;const _=g.getAttribute("data-node-id"),h=g.parentElement.getAttribute("data-node-id")||e.block.rootID;f===t.length-1&&(s=getTopAloneElement(g),s.isSameNode(g)?s=void 0:s.contains(g)&&s.contains(a)&&(s=a)),i&&g.getAttribute("data-type")==="NodeHeading"&&g.getAttribute("fold")==="1"&&(g.removeAttribute("fold"),c.push({id:_,parentID:h}));let E,C;if(i?(E=Lute.NewNodeID(),r.push({action:"delete",id:E})):r.push({action:"move",id:_,previousID:(p=g.previousElementSibling)==null?void 0:p.getAttribute("data-node-id"),parentID:h}),!n&&!i){const k=e.wysiwyg.element.querySelector(`[data-node-id="${_}"]`);k&&k.remove()}i?(C=g.cloneNode(!0),C.setAttribute("data-node-id",E),C.querySelectorAll("[data-node-id]").forEach(k=>{const v=Lute.NewNodeID();k.setAttribute("data-node-id",v),k.setAttribute("updated",v.split("-")[0])}),u.insertAdjacentElement(o,C),l.push({action:"insert",id:E,data:C.outerHTML,previousID:o==="afterend"?d:(m=C.previousElementSibling)==null?void 0:m.getAttribute("data-node-id"),parentID:((b=C.parentElement)==null?void 0:b.getAttribute("data-node-id"))||e.block.parentID||e.block.rootID})):(u.insertAdjacentElement(o,g),l.push({action:"move",id:_,previousID:o==="afterend"?d:(w=g.previousElementSibling)==null?void 0:w.getAttribute("data-node-id"),parentID:((y=g.parentElement)==null?void 0:y.getAttribute("data-node-id"))||e.block.parentID||e.block.rootID})),o!=="afterend"&&(u=i?C:g)}),r.reverse();for(let g=0;g<c.length;g++){const f=c[g];(yield fetchSyncPost("/api/block/getHeadingChildrenIDs",{id:f.id})).data.reverse().forEach(m=>{r.push({action:"move",id:m,previousID:f.id,parentID:f.parentID})}),r.push({action:"foldHeading",id:f.id,data:"remove"}),l.push({action:"unfoldHeading",id:f.id})}return{doOperations:l,undoOperations:r,topSourceElement:s}}),Zn=(e,t,a,n,o,i)=>la(void 0,null,function*(){var s,l,r,c,d,u;const g=e.element.contains(t[0]);let f;t[0].getAttribute("data-type")==="NodeListItem"&&a.getAttribute("data-type")!=="NodeListItem"&&(f=document.createElement("div"),f.setAttribute("data-node-id",Lute.NewNodeID()),f.setAttribute("data-type","NodeList"),f.setAttribute("data-subtype",t[0].getAttribute("data-subtype")),f.className="list",f.insertAdjacentHTML("beforeend",`<div class="protyle-attr" contenteditable="false">${Constants.ZWSP}</div>`));const p=[{action:"move",id:a.getAttribute("data-node-id"),previousID:(s=a.previousElementSibling)==null?void 0:s.getAttribute("data-node-id"),parentID:((l=a.parentElement)==null?void 0:l.getAttribute("data-node-id"))||e.block.parentID||e.block.rootID}];let m,b=t[0].parentElement;const w=genSBElement(o);a.parentElement.replaceChild(w,a);const y=[{action:"insert",data:w.outerHTML,id:w.getAttribute("data-node-id"),nextID:(r=w.nextElementSibling)==null?void 0:r.getAttribute("data-node-id"),previousID:(c=w.previousElementSibling)==null?void 0:c.getAttribute("data-node-id"),parentID:w.parentElement.getAttribute("data-node-id")||e.block.parentID||e.block.rootID}];let _=!1;if(f){const h=f.getAttribute("data-node-id");w.insertAdjacentElement("afterbegin",a),y.push({action:"move",id:a.getAttribute("data-node-id"),parentID:w.getAttribute("data-node-id")}),n?(a.insertAdjacentElement("afterend",f),y.push({action:"insert",data:f.outerHTML,id:h,previousID:a.getAttribute("data-node-id")})):(a.insertAdjacentElement("beforebegin",f),y.push({action:"insert",data:f.outerHTML,id:h,nextID:a.getAttribute("data-node-id")})),t.reverse().forEach((E,C)=>{var k;C===t.length-1&&(m=getTopAloneElement(E),m.isSameNode(E)&&(m=void 0));const v=Lute.NewNodeID();if(i?p.push({action:"delete",id:v}):p.push({action:"move",id:E.getAttribute("data-node-id"),previousID:(k=E.previousElementSibling)==null?void 0:k.getAttribute("data-node-id"),parentID:E.parentElement.getAttribute("data-node-id")||e.block.rootID}),!g&&!i){const A=e.wysiwyg.element.querySelector(`[data-node-id="${E.getAttribute("data-node-id")}"]`);A&&A.remove()}if(i){const A=E.cloneNode(!0);A.setAttribute("data-node-id",v),A.querySelectorAll("[data-node-id]").forEach(L=>{const x=Lute.NewNodeID();L.setAttribute("data-node-id",x),L.setAttribute("updated",x.split("-")[0])}),f.insertAdjacentElement("afterbegin",A),y.push({action:"insert",id:v,data:A.outerHTML,parentID:h})}else f.insertAdjacentElement("afterbegin",E),y.push({action:"move",id:E.getAttribute("data-node-id"),parentID:h})}),p.reverse(),p.push({action:"delete",id:h})}else{const h=[];let E;t.reverse().forEach((C,k)=>{var v;const A=C.getAttribute("data-node-id"),L=C.parentElement.getAttribute("data-node-id")||e.block.rootID;k===t.length-1&&(m=getTopAloneElement(C),m.isSameNode(C)&&(m=void 0));const x=Lute.NewNodeID();if(k===0&&(E=i?x:A),C.getAttribute("data-type")==="NodeHeading"&&C.getAttribute("fold")==="1"&&(i&&(C.removeAttribute("fold"),h.push({id:A,parentID:L})),_=!0),i?p.push({action:"delete",id:x}):p.push({action:"move",id:A,previousID:(v=C.previousElementSibling)==null?void 0:v.getAttribute("data-node-id"),parentID:L}),!g&&!i){const T=e.wysiwyg.element.querySelector(`[data-node-id="${A}"]`);T&&T.remove()}if(i){const T=C.cloneNode(!0);T.setAttribute("data-node-id",x),T.querySelectorAll("[data-node-id]").forEach(M=>{const I=Lute.NewNodeID();M.setAttribute("data-node-id",I),M.setAttribute("updated",I.split("-")[0])}),w.insertAdjacentElement("afterbegin",T),y.push({action:"insert",id:x,data:T.outerHTML,parentID:w.getAttribute("data-node-id")})}else w.insertAdjacentElement("afterbegin",C),y.push({action:"move",id:A,parentID:w.getAttribute("data-node-id")})}),p.reverse();for(let C=0;C<h.length;C++){const k=h[C],v=yield fetchSyncPost("/api/block/getHeadingChildrenIDs",{id:k.id});v.data.reverse().forEach(A=>{p.push({action:"move",id:A,previousID:k.id,parentID:k.parentID})}),C===0&&(E=v.data[0]),p.push({action:"foldHeading",id:k.id,data:"remove"}),y.push({action:"unfoldHeading",id:k.id})}n?(w.insertAdjacentElement("afterbegin",a),y.push({action:"move",id:a.getAttribute("data-node-id"),parentID:w.getAttribute("data-node-id")})):(w.lastElementChild.insertAdjacentElement("beforebegin",a),y.push({action:"move",id:a.getAttribute("data-node-id"),previousID:E}))}if(p.push({action:"delete",id:w.getAttribute("data-node-id")}),!i&&b&&b.classList.contains("list")&&b.getAttribute("data-subtype")==="o"&&!b.isSameNode(t[0].parentElement)&&b.childElementCount>1&&(Array.from(b.children).forEach(h=>{h.classList.contains("protyle-attr")||p.splice(0,0,{action:"update",id:h.getAttribute("data-node-id"),data:h.outerHTML})}),updateListOrder(b,1),Array.from(b.children).forEach(h=>{h.classList.contains("protyle-attr")||y.push({action:"update",id:h.getAttribute("data-node-id"),data:h.outerHTML})})),!i&&m){if(y.push({action:"delete",id:m.getAttribute("data-node-id")}),p.splice(0,0,{action:"insert",data:m.outerHTML,id:m.getAttribute("data-node-id"),previousID:(d=m.previousElementSibling)==null?void 0:d.getAttribute("data-node-id"),parentID:((u=m.parentElement)==null?void 0:u.getAttribute("data-node-id"))||e.block.parentID||e.block.rootID}),!g){const h=e.wysiwyg.element.querySelector(`[data-node-id="${m.getAttribute("data-node-id")}"]`);h&&h.remove()}b=m.parentElement,m.remove()}if(!i&&b&&b.classList.contains("sb")&&b.childElementCount===2){if(g){const h=cancelSB(e,b);y.push(h.doOperations[0],h.doOperations[1]),p.splice(0,0,h.undoOperations[0],h.undoOperations[1])}}else!i&&b&&b.classList.contains("protyle-wysiwyg")&&b.innerHTML;g||i?transaction(e,y,p):transaction(e,y),!i&&o==="col"&&(a.getAttribute("data-type")==="NodeHeading"&&a.getAttribute("fold")==="1"&&turnsIntoOneTransaction({protyle:e,selectsElement:[a],type:"BlocksMergeSuperBlock",level:"row"}),(t.length>1||_)&&turnsIntoOneTransaction({protyle:e,selectsElement:t.reverse(),type:"BlocksMergeSuperBlock",level:"row"})),focusBlock(t[0])}),Xn=(e,t,a,n,o)=>la(void 0,null,function*(){var i,s;const l=e.element.contains(t[0]),r=[],c=[];let d;t[0].getAttribute("data-type")==="NodeListItem"&&a.getAttribute("data-type")!=="NodeListItem"&&(d=document.createElement("div"),d.setAttribute("data-node-id",Lute.NewNodeID()),d.setAttribute("data-type","NodeList"),d.setAttribute("data-subtype",t[0].getAttribute("data-subtype")),d.className="list",d.insertAdjacentHTML("beforeend",`<div class="protyle-attr" contenteditable="false">${Constants.ZWSP}</div>`));let u,g=t[0].parentElement;if(n)if(d){const p=Kn(e,t,a,d,l,n,o);r.push(...p.doOperations),c.push(...p.undoOperations),u=p.topSourceElement}else{const p=yield zn(e,t,a,l,"afterend",o);r.push(...p.doOperations),c.push(...p.undoOperations),u=p.topSourceElement}else if(d){const p=Kn(e,t,a,d,l,n,o);r.push(...p.doOperations),c.push(...p.undoOperations),u=p.topSourceElement}else{const p=yield zn(e,t,a,l,"beforebegin",o);r.push(...p.doOperations),c.push(...p.undoOperations),u=p.topSourceElement}if(a.getAttribute("data-type")==="NodeListItem"&&a.getAttribute("data-subtype")==="o"&&(Array.from(a.parentElement.children).forEach(p=>{p.classList.contains("protyle-attr")||c.splice(0,0,{action:"update",id:p.getAttribute("data-node-id"),data:p.outerHTML})}),updateListOrder(a.parentElement,1),Array.from(a.parentElement.children).forEach(p=>{p.classList.contains("protyle-attr")||r.push({action:"update",id:p.getAttribute("data-node-id"),data:p.outerHTML})})),!o&&l&&g&&g.classList.contains("list")&&g.getAttribute("data-subtype")==="o"&&!g.isSameNode(t[0].parentElement)&&g.childElementCount>1&&(Array.from(g.children).forEach(p=>{p.classList.contains("protyle-attr")||(g.contains(a)?c.splice(0,0,{action:"update",id:p.getAttribute("data-node-id"),data:p.outerHTML}):c.splice(a.parentElement.childElementCount-1,0,{action:"update",id:p.getAttribute("data-node-id"),data:p.outerHTML}))}),updateListOrder(g,1),Array.from(g.children).forEach(p=>{p.classList.contains("protyle-attr")||r.push({action:"update",id:p.getAttribute("data-node-id"),data:p.outerHTML})})),!o&&u&&(r.push({action:"delete",id:u.getAttribute("data-node-id")}),c.splice(0,0,{action:"insert",data:u.outerHTML,id:u.getAttribute("data-node-id"),previousID:(i=u.previousElementSibling)==null?void 0:i.getAttribute("data-node-id"),parentID:((s=u.parentElement)==null?void 0:s.getAttribute("data-node-id"))||e.block.parentID||e.block.rootID}),g=u.parentElement,u.remove(),!l)){const p=e.wysiwyg.element.querySelector(`[data-node-id="${u.getAttribute("data-node-id")}"]`);p&&p.remove()}if(!o&&g&&g.classList.contains("sb")&&g.childElementCount===2){if(l){const p=cancelSB(e,g);r.push(p.doOperations[0],p.doOperations[1]),c.splice(0,0,p.undoOperations[0],p.undoOperations[1])}}else!o&&g&&g.classList.contains("protyle-wysiwyg")&&g.childElementCount;l||o?transaction(e,r,c):transaction(e,r);let f=!1;t.find(p=>{if(p.getAttribute("data-type")==="NodeHeading"&&p.getAttribute("fold")==="1")return f=!0,!0}),!o&&(t.length>1||f)&&t[0].parentElement.classList.contains("sb")&&t[0].parentElement.getAttribute("data-sb-layout")==="col"&&turnsIntoOneTransaction({protyle:e,selectsElement:t.reverse(),type:"BlocksMergeSuperBlock",level:"row"}),focusBlock(t[0])}),ed=(e,t)=>{t.addEventListener("dragstart",i=>{const s=i.target;if(s.tagName==="IMG"){window.siyuan.dragElement=void 0,i.preventDefault();return}if(s.classList){if(hasClosestByClassName(s,"protyle-wysiwyg__embed"))window.siyuan.dragElement=void 0,i.preventDefault();else if(s.classList.contains("protyle-action")){s.parentElement.classList.add("protyle-wysiwyg--select");const l=document.createElement("div");l.className=e.wysiwyg.element.className,l.append(processClonePHElement(s.parentElement.cloneNode(!0))),l.setAttribute("style",`position:fixed;opacity:.1;width:${s.parentElement.clientWidth}px;padding:0;`),document.body.append(l),i.dataTransfer.setDragImage(l,0,0),setTimeout(()=>{l.remove()}),window.siyuan.dragElement=e.wysiwyg.element,i.dataTransfer.setData(`${Constants.SIYUAN_DROP_GUTTER}NodeListItem${Constants.ZWSP}${s.parentElement.getAttribute("data-subtype")}${Constants.ZWSP}${[s.parentElement.getAttribute("data-node-id")]}`,e.wysiwyg.element.innerHTML);return}else if(s.classList.contains("av__cell--header")){window.siyuan.dragElement=s,i.dataTransfer.setData(`${Constants.SIYUAN_DROP_GUTTER}NodeAttributeView${Constants.ZWSP}Col${Constants.ZWSP}${[s.getAttribute("data-col-id")]}`,s.outerHTML);return}}i.dataTransfer.setData(Constants.SIYUAN_DROP_EDITOR,Constants.SIYUAN_DROP_EDITOR),e.element.style.userSelect="auto",document.onmousemove=null,document.onmouseup=null}),t.addEventListener("drop",i=>la(void 0,null,function*(){var s,l,r,c,d;if(o=0,e.disabled||i.dataTransfer.getData(Constants.SIYUAN_DROP_EDITOR)){i.preventDefault(),i.stopPropagation();return}let u="";for(const f of i.dataTransfer.items)f.type.startsWith(Constants.SIYUAN_DROP_GUTTER)&&(u=f.type);const g=t.querySelector(".dragover__left, .dragover__right, .dragover__bottom, .dragover__top");if(g&&(g.classList.remove("dragover"),g.removeAttribute("select-start"),g.removeAttribute("select-end")),u){const f=[],p=u.replace(Constants.SIYUAN_DROP_GUTTER,"").split(Constants.ZWSP),m=p[2].split(",");if(i.altKey||i.shiftKey)if(i.y>e.wysiwyg.element.lastElementChild.getBoundingClientRect().bottom)insertEmptyBlock(e,"afterend",e.wysiwyg.element.lastElementChild.getAttribute("data-node-id"));else{const b=getRangeByPoint(i.clientX,i.clientY);if(hasClosestByAttribute(b.startContainer,"data-type","NodeBlockQueryEmbed"))return;focusByRange(b)}if(i.altKey){let b="";for(let w=0;w<m.length;w++){const y=yield fetchSyncPost("/api/block/getRefText",{id:m[w]});b+=e.lute.Md2BlockDOM(`((${m[w]} '${y.data}'))`)}insertHTML(b,e)}else if(i.shiftKey){let b="";m.forEach(w=>{b+=`{{select * from blocks where id='${w}'}}
`}),insertHTML(e.lute.SpinBlockDOM(b),e,!0),blockRender(e,e.wysiwyg.element)}else if(g&&g.className.indexOf("dragover__")>-1){let b="";if(m.forEach(h=>{b+=`[data-node-id="${h}"],`}),window.siyuan.dragElement)window.siyuan.dragElement.querySelectorAll(b.substring(0,b.length-1)).forEach(h=>{isInEmbedBlock(h)||f.push(h)});else if(window.siyuan.config.system.workspaceDir.toLowerCase()===p[3]){const h=document.createElement("template");h.innerHTML=`<div>${i.dataTransfer.getData(u)}</div>`,h.content.querySelectorAll(b.substring(0,b.length-1)).forEach(E=>{isInEmbedBlock(E)||f.push(E)})}const w=[],y=[];f.forEach(h=>{h.classList.remove("protyle-wysiwyg--hl"),h.removeAttribute("select-start"),h.removeAttribute("select-end"),h.querySelectorAll('[data-type="search-mark"]').forEach(C=>{C.outerHTML=C.innerHTML});const E=h.getAttribute("data-node-id");w.push(E),y.push({id:E,isDetached:!1})}),hideElements(["gutter"],e);const _=g.className.split(" ");if(g.classList.remove("dragover__bottom","dragover__top","dragover__left","dragover__right"),g.classList.contains("av__cell")){const h=hasClosestBlock(g);if(h){const E=h.getAttribute("data-av-id");let C="";_.includes("dragover__left")?g.previousElementSibling&&(g.previousElementSibling.classList.contains("av__colsticky")?C=g.previousElementSibling.lastElementChild.getAttribute("data-col-id"):C=g.previousElementSibling.getAttribute("data-col-id")):C=g.getAttribute("data-col-id");let k="";const v=hasClosestByClassName(g,"av__row");if(v){const A=(s=v.querySelector(`[data-col-id="${p[2]}"`))==null?void 0:s.previousElementSibling;A&&(A.classList.contains("av__colsticky")?k=A.lastElementChild.getAttribute("data-col-id"):k=A.getAttribute("data-col-id"))}C!==k&&C!==p[2]&&transaction(e,[{action:"sortAttrViewCol",avID:E,previousID:C,id:p[2],blockID:h.dataset.nodeId}],[{action:"sortAttrViewCol",avID:E,previousID:k,id:p[2],blockID:h.dataset.nodeId}])}}else if(g.classList.contains("av__row")){const h=hasClosestBlock(g);if(h){let E="";_.includes("dragover__bottom")?E=g.getAttribute("data-id")||"":E=((l=g.previousElementSibling)==null?void 0:l.getAttribute("data-id"))||"";const C=h.getAttribute("data-av-id");if(p[0]==="nodeattributeviewrowmenu"){const k=[],v=[],A=h.querySelector(`.av__row[data-id="${m[0]}"]`).previousElementSibling.getAttribute("data-id")||"";m.reverse().forEach(L=>{E!==L&&A!==E&&(k.push({action:"sortAttrViewRow",avID:C,previousID:E,id:L,blockID:h.dataset.nodeId}),v.push({action:"sortAttrViewRow",avID:C,previousID:A,id:L,blockID:h.dataset.nodeId}))}),transaction(e,k,v)}else{const k=dayjs().format("YYYYMMDDHHmmss");transaction(e,[{action:"insertAttrViewBlock",avID:C,previousID:E,srcs:y,blockID:h.dataset.nodeId},{action:"doUpdateUpdated",id:h.dataset.nodeId,data:k}],[{action:"removeAttrViewBlock",srcIDs:w,avID:C},{action:"doUpdateUpdated",id:h.dataset.nodeId,data:h.getAttribute("updated")}]),h.setAttribute("updated",k),insertAttrViewBlockAnimation(e,h,w,E)}}}else f.length>0&&(g.parentElement.getAttribute("data-type")==="NodeSuperBlock"&&g.parentElement.getAttribute("data-sb-layout")==="col"?_.includes("dragover__left")||_.includes("dragover__right")?Xn(e,f,g,_.includes("dragover__right"),i.ctrlKey):Zn(e,f,g,_.includes("dragover__bottom"),"row",i.ctrlKey):_.includes("dragover__left")||_.includes("dragover__right")?Zn(e,f,g,_.includes("dragover__right"),"col",i.ctrlKey):Xn(e,f,g,_.includes("dragover__bottom"),i.ctrlKey),t.querySelectorAll(".protyle-wysiwyg--empty").forEach(h=>{h.classList.remove("protyle-wysiwyg--empty")}),f.forEach(h=>{h.getAttribute("data-type")==="NodeBlockQueryEmbed"&&(h.removeAttribute("data-render"),blockRender(e,h))}),g.getAttribute("data-type")==="NodeBlockQueryEmbed"&&(g.removeAttribute("data-render"),blockRender(e,g)));a=void 0}}else if(((r=i.dataTransfer.getData(Constants.SIYUAN_DROP_FILE))==null?void 0:r.split("-").length)>1){const f=i.dataTransfer.getData(Constants.SIYUAN_DROP_FILE).split(",");if(!i.altKey&&(!g||!g.classList.contains("av__row"))){if(i.y>e.wysiwyg.element.lastElementChild.getBoundingClientRect().bottom)insertEmptyBlock(e,"afterend",e.wysiwyg.element.lastElementChild.getAttribute("data-node-id"));else{const m=getRangeByPoint(i.clientX,i.clientY);if(hasClosestByAttribute(m.startContainer,"data-type","NodeBlockQueryEmbed"))return;focusByRange(m)}let p="";for(let m=0;m<f.length;m++){f.length>1&&(p+="* ");const b=yield fetchSyncPost("/api/block/getRefText",{id:f[m]});p+=`((${f[m]} '${b.data}'))`,f.length>1&&m!==f.length-1&&(p+=`
`)}insertHTML(e.lute.Md2BlockDOM(p),e)}else if(g&&!e.options.backlinkData&&g.className.indexOf("dragover__")>-1){const p=e.contentElement.scrollTop;if(g.classList.contains("av__row")){const m=hasClosestBlock(g);if(m){let b="";g.classList.contains("dragover__bottom")?b=g.getAttribute("data-id")||"":b=((c=g.previousElementSibling)==null?void 0:c.getAttribute("data-id"))||"";const w=m.getAttribute("data-av-id"),y=dayjs().format("YYYYMMDDHHmmss"),_=[];f.forEach(h=>{_.push({id:h,isDetached:!1})}),transaction(e,[{action:"insertAttrViewBlock",avID:w,previousID:b,srcs:_,blockID:m.dataset.nodeId},{action:"doUpdateUpdated",id:m.dataset.nodeId,data:y}],[{action:"removeAttrViewBlock",srcIDs:f,avID:w},{action:"doUpdateUpdated",id:m.dataset.nodeId,data:m.getAttribute("updated")}]),insertAttrViewBlockAnimation(e,m,f,b),m.setAttribute("updated",y)}}else{if(g.classList.contains("dragover__bottom"))for(let m=f.length-1;m>-1;m--)f[m]&&(yield fetchSyncPost("/api/filetree/doc2Heading",{srcID:f[m],after:!0,targetID:g.getAttribute("data-node-id")}));else for(let m=0;m<f.length;m++)f[m]&&(yield fetchSyncPost("/api/filetree/doc2Heading",{srcID:f[m],after:!1,targetID:g.getAttribute("data-node-id")}));fetchPost("/api/filetree/getDoc",{id:e.block.id,size:window.siyuan.config.editor.dynamicLoadBlocks},m=>{onGet({data:m,protyle:e}),setTimeout(()=>{e.contentElement.scrollTop=p,e.scroll.lastScrollTop=p-1},Constants.TIMEOUT_LOAD)})}g.classList.remove("dragover__bottom","dragover__top","dragover__left","dragover__right")}}else if(!window.siyuan.dragElement&&(i.dataTransfer.types[0]==="Files"||i.dataTransfer.types.includes("text/html"))){const f=hasClosestByClassName(i.target,"av");if(f){const p=hasClosestByClassName(i.target,"av__cell");if(p&&((d=f.querySelector(`.av__row--header [data-col-id="${p.dataset.colId}"]`))==null?void 0:d.getAttribute("data-dtype"))==="mAsset"&&i.dataTransfer.types[0]==="Files"&&!isBrowser()){const b=[];for(let w=0;w<i.dataTransfer.files.length;w++)b.push(webUtils.getPathForFile(i.dataTransfer.files[w]));dragUpload(b,e,p)}}else{if(focusByRange(getRangeByPoint(i.clientX,i.clientY)),i.dataTransfer.types[0]==="Files"&&!isBrowser()){const p=[];for(let m=0;m<i.dataTransfer.files.length;m++)p.push(webUtils.getPathForFile(i.dataTransfer.files[m]));uploadLocalFiles(p,e,!i.altKey)}else paste(e,i);e.wysiwyg.element.querySelectorAll(".av__cell--select, .av__cell--active").forEach(p=>{var m;p.classList.remove("av__cell--select","av__cell--active"),(m=p.querySelector(".av__drag-fill"))==null||m.remove()})}}window.siyuan.dragElement&&(window.siyuan.dragElement.style.opacity="",window.siyuan.dragElement=void 0)}));let a,n;t.addEventListener("dragover",i=>{var s,l,r;if(e.disabled||i.dataTransfer.types.includes(Constants.SIYUAN_DROP_EDITOR)){i.preventDefault(),i.stopPropagation(),i.dataTransfer.dropEffect="none";return}const c=e.contentElement.getBoundingClientRect();!hasClosestByClassName(i.target,"av__cell")&&(i.clientY<c.top+Constants.SIZE_SCROLL_TB||i.clientY>c.bottom-Constants.SIZE_SCROLL_TB)&&e.contentElement.scroll({top:e.contentElement.scrollTop+(i.clientY<c.top+Constants.SIZE_SCROLL_TB?-Constants.SIZE_SCROLL_STEP:Constants.SIZE_SCROLL_STEP),behavior:"smooth"});let d;if(i.dataTransfer.types.includes("Files")){if(d=hasClosestByClassName(i.target,"av__cell"),d&&d.getAttribute("data-dtype")==="mAsset"&&!d.classList.contains("av__cell--header")){if(i.preventDefault(),a&&d.isSameNode(a))return;hasClosestBlock(d)&&(e.wysiwyg.element.querySelectorAll(".av__cell--select, .av__cell--active").forEach(m=>{var b;m.classList.remove("av__cell--select","av__cell--active"),(b=m.querySelector(".av__drag-fill"))==null||b.remove()}),d.classList.add("av__cell--select"),addDragFill(d),a=d)}return}let u="";for(const p of i.dataTransfer.items)p.type.startsWith(Constants.SIYUAN_DROP_GUTTER)&&(u=p.type);if(!u&&!window.siyuan.dragElement){i.preventDefault();return}const g=i.dataTransfer.types.includes(Constants.SIYUAN_DROP_FILE)&&window.siyuan.dragElement?window.siyuan.dragElement.innerText:"";if(i.shiftKey||i.altKey&&g.indexOf("-")===-1){const p=hasClosestBlock(i.target);p?(p.classList.remove("dragover__top","protyle-wysiwyg--select","dragover__bottom","dragover__left","dragover__right"),p.removeAttribute("select-start"),p.removeAttribute("select-end")):t.querySelectorAll(".dragover__top, .protyle-wysiwyg--select, .dragover__bottom, .dragover__left, .dragover__right").forEach(m=>{m.classList.remove("dragover__top","protyle-wysiwyg--select","dragover__bottom","dragover__left","dragover__right"),m.removeAttribute("select-start"),m.removeAttribute("select-end")}),i.preventDefault();return}i.preventDefault(),d=hasClosestByClassName(i.target,"av__row")||hasClosestByClassName(i.target,"av__row--util")||hasClosestBlock(i.target);const f={x:i.clientX,y:i.clientY,className:""};if(d&&(d.classList.contains("bq")||d.classList.contains("sb")||d.classList.contains("list")||d.classList.contains("li"))){let p=hasClosestBlock(document.elementFromPoint(f.x,f.y-6));for(;p&&d.contains(p);)(s=p.nextElementSibling)!=null&&s.getAttribute("data-node-id")&&(d=p),p=p.parentElement}if(d)d&&d.classList.contains("list")&&(u&&u.replace(Constants.SIYUAN_DROP_GUTTER,"").split(Constants.ZWSP)[0]!=="nodelistitem"?d=hasClosestBlock(document.elementFromPoint(i.clientX,i.clientY-6)):d=hasClosestByClassName(document.elementFromPoint(i.clientX,i.clientY-6),"li"));else if(i.clientY>t.lastElementChild.getBoundingClientRect().bottom)d=t.lastElementChild,f.className="dragover__bottom";else if(i.clientY<t.firstElementChild.getBoundingClientRect().top)d=t.firstElementChild,f.className="dragover__top";else if(c){const p={left:c.left+parseInt(t.style.paddingLeft),right:c.left+e.contentElement.clientWidth-parseInt(t.style.paddingRight)};i.clientX<p.left?(f.x=p.left,f.className="dragover__left"):i.clientX>=p.right&&(f.x=p.right-6,f.className="dragover__right"),d=document.elementFromPoint(f.x,f.y),d.classList.contains("protyle-wysiwyg")&&(d=document.elementFromPoint(f.x,f.y-6)),d=hasTopClosestByAttribute(d,"data-node-id",null)}if(u&&u.startsWith(`${Constants.SIYUAN_DROP_GUTTER}NodeAttributeView${Constants.ZWSP}Col${Constants.ZWSP}`.toLowerCase())){if(d=hasClosestByClassName(i.target,"av__cell"),d){const p=hasClosestByClassName(d,"av__row--header"),m=hasClosestByClassName(window.siyuan.dragElement,"av__row--header");(d.isSameNode(window.siyuan.dragElement)||!p||!m||p&&m&&!p.isSameNode(m))&&(d=!1)}}else d&&u&&u.startsWith(`${Constants.SIYUAN_DROP_GUTTER}NodeAttributeViewRowMenu${Constants.ZWSP}`.toLowerCase())&&(!d.classList.contains("av__row")&&!d.classList.contains("av__row--util")||window.siyuan.dragElement&&!window.siyuan.dragElement.contains(d))&&(d=!1);if(d){if(d&&a&&d.isSameNode(a)){const p=d.getBoundingClientRect();if(t.querySelectorAll(".dragover__left, .dragover__right, .dragover__bottom, .dragover__top, .dragover").forEach(m=>{m.classList.remove("dragover__top","dragover__bottom","dragover__left","dragover__right","dragover"),m.removeAttribute("select-start"),m.removeAttribute("select-end")}),g.indexOf("-")>-1&&!d.classList.contains("av__row")&&!d.classList.contains("av__row--util"))if(i.altKey){if(g.split(",").includes(e.block.rootID)&&i.altKey)return}else return;if(d.getAttribute("data-type")==="NodeAttributeView"&&hasClosestByTag(i.target,"TD"))return;if(f.className){d.classList.add(f.className),ft(d);return}if(d.getAttribute("data-type")==="NodeListItem"){i.clientY>p.top+p.height/2?(d.classList.add("dragover__bottom"),ft(d)):d.classList.contains("av__row--header")||(d.classList.add("dragover__top"),ft(d));return}if(d.classList.contains("av__cell")){i.clientX<p.left+p.width/2&&i.clientX>p.left&&!d.classList.contains("av__row")&&!d.previousElementSibling.isSameNode(window.siyuan.dragElement)?d.classList.add("dragover__left"):i.clientX>p.right-p.width/2&&i.clientX<=p.right+1&&!d.classList.contains("av__row")&&!d.isSameNode(window.siyuan.dragElement.previousElementSibling)&&(window.siyuan.dragElement.previousElementSibling.classList.contains("av__colsticky")&&d.isSameNode(window.siyuan.dragElement.previousElementSibling.lastElementChild)||d.classList.add("dragover__right"));return}i.clientX<p.left+32&&i.clientX>=p.left-1&&!d.classList.contains("av__row")?(d.classList.add("dragover__left"),ft(d)):i.clientX>p.right-32&&i.clientX<p.right&&!d.classList.contains("av__row")?(d.classList.add("dragover__right"),ft(d)):d.classList.contains("av__row--header")?d.classList.add("dragover__bottom"):d.classList.contains("av__row--util")?d.previousElementSibling.classList.add("dragover__bottom"):i.clientY>p.top+p.height/2&&n!=="bottom"?(d.classList.add("dragover__bottom"),ft(d)):n!=="top"&&(d.classList.add("dragover__top"),ft(d));return}if(g.indexOf("-")>-1){g.split(",").includes(e.block.rootID)&&!d.classList.contains("av__row")&&!d.classList.contains("av__row--util")&&i.altKey?(a=void 0,t.querySelectorAll(".dragover__left, .dragover__right, .dragover__bottom, .dragover__top, .dragover").forEach(p=>{p.classList.remove("dragover__top","dragover__bottom","dragover__left","dragover__right","dragover"),p.removeAttribute("select-start"),p.removeAttribute("select-end")})):a=d;return}if(u){n="",a&&(a.classList.remove("dragover__top","dragover__bottom","dragover__left","dragover__right","dragover"),a=void 0);const p=u.replace(Constants.SIYUAN_DROP_GUTTER,"").split(Constants.ZWSP);if(p[0]==="nodeattributeview"&&p[1]==="col"&&d.getAttribute("data-id")===p[2]||p[0]==="nodeattributeviewrowmenu"&&p[2]===d.getAttribute("data-id")||p[2].split(",").find(b=>{if(b&&hasClosestByAttribute(d,"data-node-id",b))return!0})&&p[0]!=="nodeattributeviewrowmenu"||isInEmbedBlock(d)||p[0]==="nodelistitem"&&p[1]!==d.getAttribute("data-subtype")&&d.getAttribute("data-type")==="NodeListItem"||p[0]!=="nodelistitem"&&d.getAttribute("data-type")==="NodeListItem")return;p[0]==="nodelistitem"&&d.parentElement.classList.contains("li")&&((l=d.previousElementSibling)!=null&&l.classList.contains("protyle-action"))&&(n="top"),p[0]==="nodelistitem"&&((r=d.nextElementSibling)!=null&&r.classList.contains("list"))&&(n="bottom"),d&&d.classList.contains("av__row--header")&&(n="top"),a=d}}});let o=0;t.addEventListener("dragleave",i=>{if(e.disabled){i.preventDefault(),i.stopPropagation();return}o--,o===0&&(t.querySelectorAll(".dragover__left, .dragover__right, .dragover__bottom, .dragover__top, .dragover").forEach(s=>{s.classList.remove("dragover__top","dragover__bottom","dragover__left","dragover__right","dragover")}),a=void 0)}),t.addEventListener("dragenter",i=>{i.preventDefault(),o++})},ft=e=>{(e.classList.contains("sb")||e.classList.contains("li")||e.classList.contains("list")||e.classList.contains("bq"))&&e.classList.add("dragover")},td=(e,t,a)=>{var n;if(hasClosestByClassName(e,"protyle-wysiwyg__embed"))return;const o=isNotEditBlock(e);if(!o&&e.classList.contains("protyle-wysiwyg--select")){setLastNodeRange(getContenteditableElement(e),t,!1),t.collapse(!1),hideElements(["select"],a);return}if(o||e.classList.contains("table")){if(e.parentElement.classList.contains("li")){const h=e.parentElement.parentElement.outerHTML,E=genListItemElement(e.parentElement,0,!0);e.parentElement.insertAdjacentElement("afterend",E),updateTransaction(a,e.parentElement.parentElement.getAttribute("data-node-id"),e.parentElement.parentElement.outerHTML,h),focusByWbr(E,t),Bt(E),scrollCenter(a);return}if(e.classList.contains("hr")){insertEmptyBlock(a,"afterend");return}e.classList.contains("protyle-wysiwyg--select")&&e.classList.contains("render-node")?a.toolbar.showRender(a,e):insertEmptyBlock(a,"afterend");return}const i=getContenteditableElement(e);if(i.querySelectorAll(".img--select").forEach(h=>{h.classList.remove("img--select")}),e.getAttribute("data-type")==="NodeAttributeView")return!0;const s=i.innerHTML.trimStart();if((s.startsWith("```")||s.startsWith("\xB7\xB7\xB7")||s.startsWith("~~~")||s.indexOf("\n```")>-1||s.indexOf(`
~~~`)>-1||s.indexOf(`
\xB7\xB7\xB7`)>-1)&&!(s.indexOf(`
`)===-1&&s.replace(/·|~/g,"`").replace(/^`{3,}/g,"").indexOf("`")>-1)){if(e.classList.contains("p")){const h=e.outerHTML;let E=i.innerHTML.replace(/\n(~|·|`){3,}/g,"\n```").trim().replace(/^(~|·|`){3,}/g,"```");E.endsWith("\n```")||(E+="<wbr>\n```"),i.innerHTML=E,e.outerHTML=a.lute.SpinBlockDOM(e.outerHTML),e=a.wysiwyg.element.querySelector(`[data-node-id="${e.getAttribute("data-node-id")}"]`);const C=e.querySelector(".protyle-action__language");return C?(window.siyuan.storage[Constants.LOCAL_CODELANG]&&C.textContent===""?C.textContent=window.siyuan.storage[Constants.LOCAL_CODELANG]:Constants.SIYUAN_RENDER_CODE_LANGUAGES.includes(C.textContent)||(window.siyuan.storage[Constants.LOCAL_CODELANG]=C.textContent,setStorageVal(Constants.LOCAL_CODELANG,window.siyuan.storage[Constants.LOCAL_CODELANG])),Constants.SIYUAN_RENDER_CODE_LANGUAGES.includes(C.textContent)?(e.dataset.content="",e.dataset.subtype=C.textContent,e.className="render-node",e.innerHTML=`<div spin="1"></div><div class="protyle-attr" contenteditable="false">${Constants.ZWSP}</div>`,a.toolbar.showRender(a,e),processRender(e)):highlightRender(e)):(a.toolbar.showRender(a,e),processRender(e)),updateTransaction(a,e.getAttribute("data-node-id"),e.outerHTML,h),!0}}if(e.getAttribute("data-type")==="NodeCodeBlock"){const h=document.createElement("wbr");t.insertNode(h);const E=e.outerHTML;return h.remove(),t.extractContents(),i.textContent.endsWith(`
`)||i.insertAdjacentText("beforeend",`
`),t.insertNode(document.createTextNode(`
`)),t.collapse(!1),t.insertNode(h),i.parentElement.removeAttribute("data-render"),highlightRender(e),updateTransaction(a,e.getAttribute("data-node-id"),e.outerHTML,E),scrollCenter(a),!0}if(i.textContent.replace(Constants.ZWSP,"").replace(`
`,"")===""&&e.nextElementSibling&&e.nextElementSibling.classList.contains("protyle-attr")&&e.parentElement.getAttribute("data-type")==="NodeBlockquote"){t.insertNode(document.createElement("wbr"));const h=getTopEmptyElement(e),E=e.getAttribute("data-node-id"),C=h.getAttribute("data-node-id"),k={action:"insert",id:E,data:e.outerHTML},v={action:"insert",id:C,data:h.outerHTML};return C===E?(k.previousID=e.parentElement.getAttribute("data-node-id"),v.previousID=e.previousElementSibling.getAttribute("data-node-id"),e.parentElement.after(e)):(k.previousID=h.previousElementSibling?h.previousElementSibling.getAttribute("data-node-id"):void 0,k.parentID=h.parentElement.getAttribute("data-node-id")||a.block.parentID,v.previousID=k.previousID,v.parentID=k.parentID,h.after(e),h.remove()),transaction(a,[{action:"delete",id:C},k],[{action:"delete",id:E},v]),C===E&&e.parentElement.classList.contains("sb")&&e.parentElement.getAttribute("data-sb-layout")==="col"&&turnsIntoOneTransaction({protyle:a,selectsElement:[e.previousElementSibling,e],type:"BlocksMergeSuperBlock",level:"row"}),focusByWbr(e,t),!0}const l=getSelectionOffset(i,a.wysiwyg.element,t);if(e.parentElement.getAttribute("data-type")==="NodeListItem"&&(e.nextElementSibling.classList.contains("protyle-attr")||e.nextElementSibling.classList.contains("list")&&((n=e.previousElementSibling)!=null&&n.classList.contains("protyle-action"))||l.start===0&&e.previousElementSibling.classList.contains("protyle-action")||e.parentElement.getAttribute("fold")==="1")&&fo(a,e,t))return!0;if(i.textContent!==""&&t.toString()===""&&l.start===0){const h=genEmptyElement(!1,!0),E=h.getAttribute("data-node-id");return transaction(a,[{action:"insert",data:h.outerHTML,id:E,previousID:e.previousElementSibling?e.previousElementSibling.getAttribute("data-node-id"):"",parentID:e.parentElement.getAttribute("data-node-id")||a.block.parentID}],[{action:"delete",id:E}]),h.querySelector("wbr").remove(),e.insertAdjacentElement("beforebegin",h),Bt(h),!0}const r=document.createElement("wbr");t.insertNode(r);const c=e.outerHTML;if(r.remove(),t.toString()!==""){const h=hasClosestByAttribute(t.startContainer,"data-type","inline-math");if(h){const E=hasNextSibling(h);return E&&(t=getSelection().getRangeAt(0),t.setEnd(E,E.textContent.startsWith(Constants.ZWSP)?1:0),t.collapse(!1)),!0}t.extractContents()}i.lastChild&&t.setEndAfter(i.lastChild);const d=e.getAttribute("data-node-id"),u=document.createElement("div");u.appendChild(genEmptyElement(!1,!1));const g=u.querySelector('[contenteditable="true"]');g.appendChild(t.extractContents());const f=g.innerHTML.trimStart();if((f.startsWith("```")||f.startsWith("\xB7\xB7\xB7")||f.startsWith("~~~")||f.indexOf("\n```")>-1||f.indexOf(`
~~~`)>-1||f.indexOf(`
\xB7\xB7\xB7`)>-1)&&!(f.indexOf(`
`)===-1&&f.replace(/·|~/g,"`").replace(/^`{3,}/g,"").indexOf("`")>-1)){let h=g.innerHTML.replace(/\n(~|·|`){3,}/g,"\n```").trim().replace(/^(~|·|`){3,}/g,"```");h.endsWith("\n```")||(h+="\n```"),g.innerHTML=h}u.innerHTML=a.lute.SpinBlockDOM(u.innerHTML);const p=document.createElement("div");p.innerHTML=a.lute.SpinBlockDOM(i.parentElement.outerHTML);const m=[],b=[];let w=e;const y=[];Array.from(p.children).forEach(h=>{h.dataset.nodeId===d?(e.before(h),e.remove(),m.push({action:"update",data:h.outerHTML,id:d}),b.push({action:"update",data:c,id:d})):(m.push({action:"insert",data:h.outerHTML,id:h.dataset.nodeId,nextID:d}),w.insertAdjacentElement("afterend",h),b.push({action:"delete",id:h.dataset.nodeId})),mathRender(h),w=h,y.push(h)}),Array.from(u.children).forEach(h=>{const E=h.getAttribute("data-node-id");m.push({action:"insert",data:h.outerHTML,id:E,previousID:w.getAttribute("data-node-id")}),b.push({action:"delete",id:E}),w.insertAdjacentElement("afterend",h),h.classList.contains("code-block")?highlightRender(h):mathRender(w.nextElementSibling),w=h,y.push(h)});const _=w.parentElement;return transaction(a,m,b),_.classList.contains("sb")&&_.getAttribute("data-sb-layout")==="col"&&turnsIntoOneTransaction({protyle:a,selectsElement:y,type:"BlocksMergeSuperBlock",level:"row"}),focusBlock(w),scrollCenter(a),!0},fo=(e,t,a)=>{var n,o,i;const s=t.parentElement,l=getContenteditableElement(t);if(["",`
`].includes(l.textContent)&&t.previousElementSibling.classList.contains("protyle-action")&&!t.querySelector("img")){if((n=s.nextElementSibling)!=null&&n.classList.contains("protyle-attr"))return listOutdent(e,[t.parentElement],a),!0;if(!s.parentElement.classList.contains("protyle-wysiwyg"))return breakList(e,t,a),!0}const r=getSelectionOffset(l,e.wysiwyg.element,a);if(a.toString()===""&&r.start===0&&!hasPreviousSibling(a.startContainer)){if(s.parentElement.classList.contains("protyle-wysiwyg"))return!0;const p=document.createElement("wbr");a.insertNode(p);const m=s.parentElement.outerHTML;p.remove();let b=genListItemElement(s,-1,!0);if(t.previousElementSibling.classList.contains("protyle-action"))getContenteditableElement(t).textContent===""?s.insertAdjacentElement("afterend",b):s.insertAdjacentElement("beforebegin",b);else{if(getContenteditableElement(t).textContent!=="")return!1;t.remove(),b=genListItemElement(s,-1,!0),s.insertAdjacentElement("afterend",b)}return s.getAttribute("data-subtype")==="o"&&updateListOrder(s.parentElement),updateTransaction(e,s.parentElement.getAttribute("data-node-id"),s.parentElement.outerHTML,m),focusByWbr(b,a),scrollCenter(e),Bt(b),!0}const c=s.querySelector(".list");let d;if(c&&s.getAttribute("fold")!=="1"&&t.nextElementSibling.isSameNode(c)){if(r.end>=l.textContent.length-(l.textContent.endsWith(Constants.ZWSP)?1:0)){a.insertNode(document.createElement("wbr"));const p=c.outerHTML;t.querySelector("wbr").remove(),d=genListItemElement(c.firstElementChild,-1,!0),c.firstElementChild.before(d),c.getAttribute("data-subtype")==="o"&&updateListOrder(c),updateTransaction(e,c.getAttribute("data-node-id"),c.outerHTML,p),focusByWbr(s,a),scrollCenter(e)}else{a.insertNode(document.createElement("wbr"));const p=s.outerHTML,m=s.parentElement.outerHTML;a.toString()!==""&&(a.extractContents(),a.insertNode(document.createElement("wbr"))),a.setEndAfter(l.lastChild),d=genListItemElement(s,0,!1),getContenteditableElement(d).appendChild(a.extractContents());let w=c.nextElementSibling;for(d.lastElementChild.before(c);!w.classList.contains("protyle-attr");)w=w.nextElementSibling,d.lastElementChild.before(w.previousElementSibling);s.insertAdjacentElement("afterend",d),s.getAttribute("data-subtype")==="o"&&updateListOrder(s.parentElement),s.parentElement.classList.contains("protyle-wysiwyg")?transaction(e,[{action:"update",data:s.outerHTML,id:s.getAttribute("data-node-id")},{action:"insert",id:d.getAttribute("data-node-id"),data:d.outerHTML,previousID:s.getAttribute("data-node-id")}],[{action:"delete",id:d.getAttribute("data-node-id")},{action:"update",data:p,id:s.getAttribute("data-node-id")}]):updateTransaction(e,s.parentElement.getAttribute("data-node-id"),s.parentElement.outerHTML,m),focusByWbr(d,a),scrollCenter(e)}return Bt(d),!0}if((a.toString()===""||a.toString()===Constants.ZWSP)&&a.startContainer.nodeType===3&&a.startOffset===0){let p=a.startContainer;for(;p;)if(p.textContent===Constants.ZWSP){a.setStart(p,1),a.collapse(!1);break}else p=p.nextSibling}a.insertNode(document.createElement("wbr"));const u=s.outerHTML,g=s.parentElement.outerHTML;if(a.toString()!==""){const p=hasClosestByAttribute(a.startContainer,"data-type","inline-math");if(p){const m=hasNextSibling(p);return m&&(a=getSelection().getRangeAt(0),a.setEnd(m,m.textContent.startsWith(Constants.ZWSP)?1:0),a.collapse(!1)),!0}a.extractContents(),a.insertNode(document.createElement("wbr"))}a.setEndAfter(l.lastChild),d=genListItemElement(s,0,!1);const f=a.extractContents();return f.firstChild.nodeType!==3&&f.firstChild.textContent===""&&(f.firstChild.after(document.createElement("wbr")),f.firstChild.remove()),(((o=l==null?void 0:l.lastElementChild)==null?void 0:o.getAttribute("data-type"))||"").indexOf("inline-math")>-1&&!hasNextSibling(l==null?void 0:l.lastElementChild)&&l.insertAdjacentText("beforeend",`
`),(i=l==null?void 0:l.lastElementChild)!=null&&i.classList.contains("img")&&!hasNextSibling(l==null?void 0:l.lastElementChild)&&l.insertAdjacentText("beforeend",Constants.ZWSP),getContenteditableElement(d).appendChild(f),s.insertAdjacentElement("afterend",d),s.getAttribute("data-subtype")==="o"&&updateListOrder(s.parentElement),s.parentElement.classList.contains("protyle-wysiwyg")?transaction(e,[{action:"update",id:s.getAttribute("data-node-id"),data:s.outerHTML},{action:"insert",id:d.getAttribute("data-node-id"),data:d.outerHTML,previousID:s.getAttribute("data-node-id")}],[{action:"delete",id:d.getAttribute("data-node-id")},{action:"update",id:s.getAttribute("data-node-id"),data:u}]):updateTransaction(e,s.parentElement.getAttribute("data-node-id"),s.parentElement.outerHTML,g),focusByWbr(d,a),scrollCenter(e),Bt(d),!0},Bt=e=>{const t=getContenteditableElement(e).childNodes;for(let a=0;a<t.length;a++)t[a].nodeType===3&&t[a].textContent.length===0&&(t[a].remove(),a--)},ad=(e,t,a)=>{let n=e.startContainer;const o=hasNextSibling(n);if(t.getAttribute("data-type")==="NodeAttributeView")return!0;if(o&&o.nodeType!==3&&getSelectionOffset(e.startContainer,a.wysiwyg.element,e).end===e.endContainer.textContent.length&&(o.classList.contains("img")||o.getAttribute("data-type")==="inline-math")){o.insertAdjacentHTML("beforebegin","<wbr>");const s=t.outerHTML;o.previousElementSibling.remove();const l=document.createTextNode(`
`);return n.after(document.createTextNode(Constants.ZWSP)),n.after(l),e.selectNode(l),e.collapse(!1),updateTransaction(a,t.getAttribute("data-node-id"),t.outerHTML,s),!0}if(n.nodeType===3&&(n=n.parentElement),n&&a.toolbar.getCurrentType(e).length>0&&getSelectionOffset(n,n,e).end===n.textContent.length)return Jn(e,t,a,n),!0;if(isIPad()||isMobile()){n=e.startContainer;const i=hasNextSibling(n);return i&&i.textContent.trim()!==""?(document.execCommand("insertHTML",!1,`
`),!0):(Jn(e,t,a,n),!0)}return!1},Jn=(e,t,a,n)=>{const o=document.createElement("wbr");n.nodeType===3?e.insertNode(o):n.insertAdjacentElement("afterend",o);const i=t.outerHTML;o.remove();let s;hasNextSibling(n)||(s=document.createTextNode(`
`),n.after(s));const l=document.createTextNode(`
`);n.after(l),s?e.setStart(s,0):e.setStart(l,1),e.collapse(!0),focusByRange(e),updateTransaction(a,t.getAttribute("data-node-id"),t.outerHTML,i)};class Pt{constructor(t,a){this.element=document.createElement("button");const n=a.hotkey?` ${$a(a.hotkey)}`:"",o=a.tip||window.siyuan.languages[a.lang];this.element.classList.add("protyle-toolbar__item","b3-tooltips",`b3-tooltips__${a.tipPosition}`),this.element.setAttribute("data-type",a.name),this.element.setAttribute("aria-label",o+n),this.element.innerHTML=`<svg><use xlink:href="#${a.icon}"></use></svg>`,!["text","a","block-ref","inline-math","inline-memo"].includes(a.name)&&this.element.addEventListener(yi(),i=>{i.preventDefault(),S.INLINE_TYPE.includes(a.name)?t.toolbar.setInlineMark(t,a.name,"toolbar"):a.click&&a.click(t.getInstance())})}}class nd extends Pt{constructor(t,a){super(t,a),this.element.addEventListener("click",()=>{t.toolbar.element.classList.add("fn__none"),t.toolbar.subElement.innerHTML="",t.toolbar.subElement.style.width="",t.toolbar.subElement.style.padding="",t.toolbar.subElement.append(go(t,po(t))),t.toolbar.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),t.toolbar.subElement.classList.remove("fn__none"),t.toolbar.subElementCloseCB=void 0,Ae(t.toolbar.range)})}}const go=(e,t)=>{let a="";["","var(--b3-font-color1)","var(--b3-font-color2)","var(--b3-font-color3)","var(--b3-font-color4)","var(--b3-font-color5)","var(--b3-font-color6)","var(--b3-font-color7)","var(--b3-font-color8)","var(--b3-font-color9)","var(--b3-font-color10)","var(--b3-font-color11)","var(--b3-font-color12)","var(--b3-font-color13)"].forEach(d=>{a+=`<button ${d?`class="color__square" style="color:${d}"`:`class="color__square ariaLabel" data-position="3south" aria-label="${window.siyuan.languages.default}"`} data-type="color">A</button>`});let n="";["","var(--b3-font-background1)","var(--b3-font-background2)","var(--b3-font-background3)","var(--b3-font-background4)","var(--b3-font-background5)","var(--b3-font-background6)","var(--b3-font-background7)","var(--b3-font-background8)","var(--b3-font-background9)","var(--b3-font-background10)","var(--b3-font-background11)","var(--b3-font-background12)","var(--b3-font-background13)"].forEach(d=>{n+=`<button ${d?`class="color__square" style="background-color:${d}"`:`class="color__square ariaLabel" data-position="3south" aria-label="${window.siyuan.languages.default}"`} data-type="backgroundColor"></button>`});const o=document.createElement("div");o.classList.add("protyle-font");let i=!1;t==null||t.find(d=>{if(d.classList.contains("list")||d.classList.contains("li"))return i=!0,!0});let s="";const l=window.siyuan.storage[S.LOCAL_FONTSTYLES];l.length>0&&(s=`<div class="fn__flex">
    ${window.siyuan.languages.lastUsed}
    <span class="fn__space"></span>
    <kbd class="fn__kbd fn__flex-center">${$a(window.siyuan.config.keymap.editor.insert.lastUsed.custom)}</kbd>
</div>
<div class="fn__hr--small"></div>
<div class="fn__flex fn__flex-wrap" style="align-items: center">`,l.forEach(d=>{const u=d.split(S.ZWSP);switch(u[0]){case"color":s+=`<button class="color__square ariaLabel" data-position="3south" aria-label="${window.siyuan.languages.colorFont}${u[1]?"":" "+window.siyuan.languages.default}" ${u[1]?`style="color:${u[1]}"`:""} data-type="${u[0]}">A</button>`;break;case"backgroundColor":s+=`<button class="color__square ariaLabel" data-position="3south" aria-label="${window.siyuan.languages.colorPrimary}${u[1]?"":" "+window.siyuan.languages.default}" ${u[1]?`style="background-color:${u[1]}"`:""} data-type="${u[0]}"></button>`;break;case"style2":s+=`<button data-type="${u[0]}" class="protyle-font__style" style="-webkit-text-stroke: 0.2px var(--b3-theme-on-background);-webkit-text-fill-color : transparent;">${window.siyuan.languages.hollow}</button>`;break;case"style4":s+=`<button data-type="${u[0]}" class="protyle-font__style" style="text-shadow: 1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)">${window.siyuan.languages.shadow}</button>`;break;case"fontSize":i||(s+=`<button data-type="${u[0]}" class="protyle-font__style">${u[1]}</button>`);break;case"style1":s+=`<button class="color__square ariaLabel" data-position="3south" aria-label="${window.siyuan.languages.color}${u[1]?"":" "+window.siyuan.languages.default}" ${u[1]?`style="background-color:${u[1]};color:${u[2]}"`:""} data-type="${u[0]}">A</button>`;break;case"clear":s+=`<button style="height: 26px;display: flex;align-items: center;padding: 0 5px;" data-type="${u[0]}" class="protyle-font__style ariaLabel" aria-label="${window.siyuan.languages.clearFontStyle}"><svg class="svg--mid"><use xlink:href="#iconTrashcan"></use></svg></button>`;break}}),s+="</div>");let r,c="16px";return t&&t.length>0?r=t[0]:(r=e.toolbar.range.cloneContents().querySelector('[data-type~="text"]'),r||(r=j(e.toolbar.range.startContainer,"data-type","text"))),r&&(c=r.style.fontSize||"16px"),o.innerHTML=`${s}
<div class="fn__hr"></div>
<div>${window.siyuan.languages.color}</div>
<div class="fn__hr--small"></div>
<div class="fn__flex fn__flex-wrap">
    <button class="color__square ariaLabel" data-position="3south" data-type="style1" aria-label="${window.siyuan.languages.default}">A</button>
    <button class="color__square" data-type="style1" style="color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);">A</button>
    <button class="color__square" data-type="style1" style="color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);">A</button>
    <button class="color__square" data-type="style1" style="color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);">A</button>
    <button class="color__square" data-type="style1" style="color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);">A</button>
</div>
<div class="fn__hr"></div>
<div>${window.siyuan.languages.colorFont}</div>
<div class="fn__hr--small"></div>
<div class="fn__flex fn__flex-wrap">
    ${a}
</div>
<div class="fn__hr"></div>
<div>${window.siyuan.languages.colorPrimary}</div>
<div class="fn__hr--small"></div>
<div class="fn__flex fn__flex-wrap">
    ${n}
</div>
<div class="fn__hr"></div>
<div>${window.siyuan.languages.fontStyle}</div>
<div class="fn__hr--small"></div>
<div class="fn__flex">
    <button data-type="style2" class="protyle-font__style" style="-webkit-text-stroke: 0.2px var(--b3-theme-on-background);-webkit-text-fill-color : transparent;">${window.siyuan.languages.hollow}</button>
    <button data-type="style4" class="protyle-font__style" style="text-shadow: 1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)">${window.siyuan.languages.shadow}</button>
</div>
<div class="fn__hr${i?" fn__none":""}"></div>
<div class="${i?" fn__none":""}">${window.siyuan.languages.fontSize}</div>
<div class="fn__hr--small${i?" fn__none":""}"></div>
<div class="fn__flex${i?" fn__none":""}">
    <div class="fn__space--small"></div>
    <select class="b3-select fn__block">
        <option ${c==="12px"?"selected":""} value="12px">12px</option>
        <option ${c==="13px"?"selected":""} value="13px">13px</option>
        <option ${c==="14px"?"selected":""} value="14px">14px</option>
        <option ${c==="15px"?"selected":""} value="15px">15px</option>
        <option ${c==="16px"?"selected":""} value="16px">16px</option>
        <option ${c==="19px"?"selected":""} value="19px">19px</option>
        <option ${c==="22px"?"selected":""} value="22px">22px</option>
        <option ${c==="24px"?"selected":""} value="24px">24px</option>
        <option ${c==="29px"?"selected":""} value="29px">29px</option>
        <option ${c==="32px"?"selected":""} value="32px">32px</option>
        <option ${c==="40px"?"selected":""} value="40px">40px</option>
        <option ${c==="48px"?"selected":""} value="48px">48px</option>
    </select>
    <div class="fn__space--small"></div>
</div>
<div class="fn__hr--b"></div>
<div class="fn__flex">
    <div class="fn__space--small"></div>
    <button class="b3-button b3-button--remove fn__block" data-type="clear">
        <svg><use xlink:href="#iconTrashcan"></use></svg>${window.siyuan.languages.clearFontStyle}
    </button>
    <div class="fn__space--small"></div>
</div>`,o.addEventListener("click",function(d){let u=d.target;for(;u&&!u.isEqualNode(o);){const g=u.getAttribute("data-type");if(u.tagName==="BUTTON"){g==="style1"?xt(e,t,g,u.style.backgroundColor+S.ZWSP+u.style.color):g==="fontSize"?xt(e,t,g,u.textContent.trim()):g==="backgroundColor"?xt(e,t,g,u.style.backgroundColor):g==="color"?xt(e,t,g,u.style.color):xt(e,t,g);break}u=u.parentElement}}),o.querySelector("select").addEventListener("change",function(d){xt(e,t,"fontSize",d.target.value)}),o},xt=(e,t,a,n)=>{let o=window.siyuan.storage[S.LOCAL_FONTSTYLES];if(a)o.splice(0,0,`${a}${S.ZWSP}${n}`),o=[...new Set(o)],o.length>8&&o.splice(8,1),window.siyuan.storage[S.LOCAL_FONTSTYLES]=o,Ha(S.LOCAL_FONTSTYLES,window.siyuan.storage[S.LOCAL_FONTSTYLES]);else if(o.length===0)a="style1",n="var(--b3-card-error-color)"+S.ZWSP+"var(--b3-card-error-background)";else{const i=o[0].split(S.ZWSP);a=i.splice(0,1)[0],n=i.join(S.ZWSP)}t&&t.length>0?(Dl(t,e,i=>{if(a==="clear")i.style.color="",i.style.webkitTextFillColor="",i.style.webkitTextStroke="",i.style.textShadow="",i.style.backgroundColor="",i.style.fontSize="",i.style.removeProperty("--b3-parent-background");else if(a==="style1"){const s=n.split(S.ZWSP);i.style.backgroundColor=s[0],i.style.color=s[1],i.style.setProperty("--b3-parent-background",s[0])}else a==="style2"?(i.style.webkitTextStroke="0.2px var(--b3-theme-on-background)",i.style.webkitTextFillColor="transparent"):a==="style4"?i.style.textShadow="1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)":a==="color"?i.style.color=n:a==="backgroundColor"?(i.style.backgroundColor=n,i.style.setProperty("--b3-parent-background",n)):a==="fontSize"&&(i.style.fontSize=n);(a==="fontSize"||a==="clear")&&i.getAttribute("data-type")==="NodeCodeBlock"&&li(i.querySelector(".hljs"))}),Ae(e.toolbar.range)):a==="clear"?e.toolbar.setInlineMark(e,"clear","range",{type:"text"}):e.toolbar.setInlineMark(e,"text","range",{type:a,color:n})},sd=(e,t)=>{const a=i=>{const s=i.split(Constants.ZWSP);e.setAttribute("data-id",s.splice(0,1)[0]),e.setAttribute("data-subtype",s.splice(0,1)[0]),e.removeAttribute("data-href"),e.innerText=s.join("")},n=i=>{const s=i.split(Constants.ZWSP);e.setAttribute("data-href",s[0]),e.removeAttribute("data-subtype"),e.removeAttribute("data-id"),s[1]&&(e.textContent=s[1])},o=i=>{const s=i.split(Constants.ZWSP);e.setAttribute("data-id",s[0]),e.removeAttribute("data-href"),e.removeAttribute("data-subtype"),s[1]&&(e.textContent=s[1])};if(t){switch(t.type){case"color":e.style.color=t.color;break;case"fontSize":e.style.fontSize=t.color;break;case"backgroundColor":e.style.backgroundColor=t.color;break;case"style1":e.style.backgroundColor=t.color.split(Constants.ZWSP)[0],e.style.color=t.color.split(Constants.ZWSP)[1];break;case"style2":e.style.webkitTextStroke="0.2px var(--b3-theme-on-background)",e.style.webkitTextFillColor="transparent";break;case"style4":e.style.textShadow="1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)";break;case"id":a(t.color);break;case"inline-math":e.className="render-node",e.setAttribute("contenteditable","false"),e.setAttribute("data-subtype","math"),e.setAttribute("data-content",e.textContent.replace(Constants.ZWSP,"")),e.removeAttribute("data-render"),e.textContent="";break;case"a":n(t.color);break;case"file-annotation-ref":o(t.color);break;case"inline-memo":e.removeAttribute("contenteditable"),e.removeAttribute("data-subtype"),e.removeAttribute("data-content");break}e.getAttribute("style")||e.removeAttribute("style")}},id=(e,t,a)=>{if(!a)return e.nodeType!==3&&t.nodeType!==3&&t.style.color===e.style.color&&t.style.webkitTextFillColor===e.style.webkitTextFillColor&&t.style.webkitTextStroke===e.style.webkitTextStroke&&t.style.textShadow===e.style.textShadow&&t.style.backgroundColor===e.style.backgroundColor&&t.style.fontSize===e.style.fontSize;if(a.type==="inline-math"||a.type==="inline-memo"||a.type==="a")return!1;if(a.type==="id"){if(e.nodeType!==3)return e.getAttribute("data-id")===t.getAttribute("data-id")&&e.getAttribute("data-subtype")===t.getAttribute("data-subtype")&&e.textContent===t.textContent;const c=a.color.split(Constants.ZWSP);return c[0]===t.getAttribute("data-id")&&c[1]===t.getAttribute("data-subtype")&&c[2]===t.textContent}if(a.type==="file-annotation-ref")return e.nodeType!==3?e.getAttribute("data-id")===t.getAttribute("data-id")&&e.textContent===t.textContent:a.color===t.getAttribute("data-id");let n="",o="",i="",s="",l="",r="";return e.nodeType!==3&&(n=e.style.color,o=e.style.webkitTextFillColor,i=e.style.webkitTextStroke,s=e.style.textShadow,l=e.style.backgroundColor,r=e.style.fontSize),a.type==="text"?n===t.style.color&&o===t.style.webkitTextFillColor&&i===t.style.webkitTextStroke&&s===t.style.textShadow&&r===t.style.fontSize&&l===t.style.backgroundColor:a.type==="color"?a.color===t.style.color&&o===t.style.webkitTextFillColor&&i===t.style.webkitTextStroke&&s===t.style.textShadow&&r===t.style.fontSize&&l===t.style.backgroundColor:a.type==="backgroundColor"?n===t.style.color&&o===t.style.webkitTextFillColor&&i===t.style.webkitTextStroke&&s===t.style.textShadow&&r===t.style.fontSize&&a.color===t.style.backgroundColor:a.type==="style1"?a.color.split(Constants.ZWSP)[0]===t.style.color&&o===t.style.webkitTextFillColor&&i===t.style.webkitTextStroke&&s===t.style.textShadow&&r===t.style.fontSize&&a.color.split(Constants.ZWSP)[1]===t.style.backgroundColor:a.type==="style2"?n===t.style.color&&t.style.webkitTextFillColor==="transparent"&&t.style.webkitTextStroke==="0.2px var(--b3-theme-on-background)"&&s===t.style.textShadow&&r===t.style.fontSize&&l===t.style.backgroundColor:a.type==="style4"?n===t.style.color&&o===t.style.webkitTextFillColor&&i===t.style.webkitTextStroke&&r===t.style.fontSize&&t.style.textShadow==="1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)"&&l===t.style.backgroundColor:a.type==="fontSize"?n===t.style.color&&o===t.style.webkitTextFillColor&&i===t.style.webkitTextStroke&&s===t.style.textShadow&&a.color===t.style.fontSize&&l===t.style.backgroundColor:!0},po=e=>{let t;if(e.toolbar.range.toString()===""&&(t=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select")),t.length===0)){const a=oe(e.toolbar.range.startContainer);a&&(t=[a])}return t},od=(e,t,a)=>{var n,o,i,s;if(!t.classList.contains("av")||!window.siyuan.menus.menu.element.classList.contains("fn__none"))return!1;if(e.isComposing)return!0;if(matchHotKey("\u2318B",e)||matchHotKey("\u2318I",e)||matchHotKey("\u2318U",e))return e.preventDefault(),!0;const l=t.querySelector(".av__cell--select");if(l){const c=hasClosestByClassName(l,"av__row");if(!c)return!1;const d=document.querySelector(".av__panel");if(d&&(e.key==="Backspace"||e.key==="Delete"||e.key==="Escape"||e.key.startsWith("ArrowLeft")||e.key==="Enter"||matchHotKey("\u21E5",e)||matchHotKey("\u21E7\u21E5",e)))return d.remove(),e.preventDefault(),e.stopPropagation(),!0;if(e.key==="Backspace"||e.key==="Delete")return updateCellsValue(a,t,void 0,Array.from(t.querySelectorAll(".av__cell--active, .av__cell--select"))),e.preventDefault(),!0;if(e.key==="Escape")return t.querySelectorAll(".av__cell--select, .av__cell--active").forEach(g=>{var f;g.classList.remove("av__cell--select","av__cell--active"),(f=g.querySelector(".av__drag-fill"))==null||f.remove()}),selectRow(c.querySelector(".av__firstcol"),"select"),e.preventDefault(),!0;if(e.key==="Enter")return popTextCell(a,[l]),e.preventDefault(),!0;let u;if(e.key==="ArrowLeft"||matchHotKey("\u21E7\u21E5",e)){const g=c.previousElementSibling;if(l.previousElementSibling&&!l.previousElementSibling.classList.contains("av__firstcol"))l.previousElementSibling.classList.contains("av__cell")?u=l.previousElementSibling:u=l.previousElementSibling.lastElementChild;else if(g&&!g.classList.contains("av__row--header")){const f=g.querySelectorAll(".av__cell");u=f[f.length-1]}return u&&(l.classList.remove("av__cell--select","av__cell--active"),(n=l.querySelector(".av__drag-fill"))==null||n.remove(),u.classList.add("av__cell--select"),addDragFill(u),cellScrollIntoView(t,u,!1)),e.preventDefault(),!0}if(e.key==="ArrowRight"||matchHotKey("\u21E5",e)){const g=c.nextElementSibling;return l.nextElementSibling&&l.nextElementSibling.classList.contains("av__cell")?u=l.nextElementSibling:!l.nextElementSibling&&l.parentElement.nextElementSibling?u=l.parentElement.nextElementSibling:g&&!g.classList.contains("av__row--footer")&&(u=g.querySelector(".av__cell")),u&&(l.classList.remove("av__cell--select","av__cell--active"),(o=l.querySelector(".av__drag-fill"))==null||o.remove(),u.classList.add("av__cell--select"),addDragFill(u),cellScrollIntoView(t,u,!1)),e.preventDefault(),!0}if(e.key==="ArrowUp"){const g=c.previousElementSibling;return g&&!g.classList.contains("av__row--header")&&(u=g.querySelector(`.av__cell[data-col-id="${l.dataset.colId}"]`)),u&&(l.classList.remove("av__cell--select","av__cell--active"),(i=l.querySelector(".av__drag-fill"))==null||i.remove(),u.classList.add("av__cell--select"),addDragFill(u),cellScrollIntoView(t,u)),e.preventDefault(),!0}if(e.key==="ArrowDown"){const g=c.nextElementSibling;return g&&!g.classList.contains("av__row--footer")&&(u=g.querySelector(`.av__cell[data-col-id="${l.dataset.colId}"]`)),u&&(l.classList.remove("av__cell--select","av__cell--active"),(s=l.querySelector(".av__drag-fill"))==null||s.remove(),u.classList.add("av__cell--select"),addDragFill(u),cellScrollIntoView(t,u)),e.preventDefault(),!0}if(!Constants.KEYCODELIST[e.keyCode]||Constants.KEYCODELIST[e.keyCode].length===1&&!e.metaKey&&!e.ctrlKey&&!["\u21E7","\u2303","\u2325","\u2318"].includes(Constants.KEYCODELIST[e.keyCode]))return l.style.backgroundColor?e.preventDefault():popTextCell(a,[l]),!0}const r=t.querySelectorAll(".av__row--select:not(.av__row--header)");if(r.length>0){if(matchHotKey("\u2318/",e))return e.stopPropagation(),e.preventDefault(),avContextmenu(a,r[0],{x:t.querySelector(".layout-tab-bar").getBoundingClientRect().left,y:r[0].getBoundingClientRect().bottom}),!0;if(e.key==="Escape")return e.preventDefault(),selectRow(r[0].querySelector(".av__firstcol"),"unselectAll"),!0;if(e.key==="Backspace")return e.preventDefault(),deleteRow(t,a),!0;if(e.key==="Enter")return selectRow(r[0].querySelector(".av__firstcol"),"unselectAll"),popTextCell(a,[r[0].querySelector(".av__cell")]),e.preventDefault(),!0;if(e.key==="ArrowUp"){const c=r[0].previousElementSibling;return selectRow(r[0].querySelector(".av__firstcol"),"unselectAll"),c&&!c.classList.contains("av__row--header")?(selectRow(c.querySelector(".av__firstcol"),"select"),cellScrollIntoView(t,c)):t.classList.add("protyle-wysiwyg--select"),e.preventDefault(),!0}if(e.key==="ArrowDown"){const c=r[r.length-1].nextElementSibling;return selectRow(r[0].querySelector(".av__firstcol"),"unselectAll"),c&&!c.classList.contains("av__row--util")?(selectRow(c.querySelector(".av__firstcol"),"select"),cellScrollIntoView(t,c)):t.classList.add("protyle-wysiwyg--select"),e.preventDefault(),!0}}return!1},ld=e=>{var t;if(e.command==="switchReadonly")return updateReadonly(e.protyle.breadcrumb.element.parentElement.querySelector('.block__icon[data-type="readonly"]'),e.protyle),!0;if(e.command==="switchAdjust"){let n;const o=e.protyle.wysiwyg.element.getAttribute(Constants.CUSTOM_SY_FULLWIDTH);return o?n=o==="true"?"false":"true":n=window.siyuan.config.editor.fullWidth?"false":"true",fetchPost("/api/attr/setBlockAttrs",{id:e.protyle.block.rootID,attrs:{[Constants.CUSTOM_SY_FULLWIDTH]:n}}),!0}const a=hasClosestBlock(e.previousRange.startContainer);if(!a)return!1;if(e.command==="enter"){let n=getTopAloneElement(a);n.parentElement.classList.contains("li")&&n.parentElement.parentElement.classList.contains("list")&&((t=n.nextElementSibling)!=null&&t.classList.contains("list"))&&n.previousElementSibling.classList.contains("protyle-action")&&(n=n.parentElement);const o=n.getAttribute("data-node-id");return e.protyle.options.backlinkData||zoomOut({protyle:e.protyle,id:o}),!0}return e.command==="enterBack"?(enterBack(e.protyle,a.getAttribute("data-node-id")),!0):!1},Qn=(e,t)=>{let a="";Array.from(e.cloneContents().childNodes).forEach(n=>{n.nodeType===3?a+=n.textContent:a+=n.outerHTML}),fetchPost("/api/block/getDOMText",{dom:a},n=>{t(n.data)})},rd=(e,t)=>{t.addEventListener("keydown",a=>{var n,o,i,s,l,r;if(a.target.localName==="protyle-html"||a.target.localName==="input"){a.stopPropagation();return}if(e.disabled||!e.selectElement.classList.contains("fn__none")){a.stopPropagation(),a.preventDefault();return}e.wysiwyg.preventKeyup=!1,hideElements(["util"],e),a.shiftKey&&a.key.indexOf("Arrow")>-1||!a.repeat&&a.code!==""&&hideElements(["toolbar"],e);const c=getEditorRange(e.wysiwyg.element),d=hasClosestBlock(c.startContainer);if(!d)return;const u=hasClosestBlock(c.endContainer);if(!matchHotKey("\u2318C",a)&&u&&!d.isSameNode(u)){a.stopPropagation(),a.preventDefault();return}if(avKeydown(a,d,e))return;if(d.classList.contains("protyle-wysiwyg--select")&&isNotCtrl(a)&&!a.shiftKey&&!a.altKey){if(a.key.toLowerCase()==="a")return a.stopPropagation(),a.preventDefault(),e.wysiwyg.element.blur(),setTimeout(()=>{insertEmptyBlock(e,"afterend")},100),!1;if(a.key.toLowerCase()==="b")return a.stopPropagation(),a.preventDefault(),e.wysiwyg.element.blur(),setTimeout(()=>{insertEmptyBlock(e,"beforebegin")},100),!1}if(a.isComposing){a.stopPropagation();return}if(["\u2318","\u21E7","\u2325","\u2303"].includes(Constants.KEYCODELIST[a.keyCode])||(Constants.KEYCODELIST[a.keyCode]==="/"||a.key==="/"||a.code==="Slash"&&a.key==="Process"&&a.keyCode===229?e.hint.enableSlash=!0:(Constants.KEYCODELIST[a.keyCode]==="\\"||a.key==="\\"||a.key===","&&a.keyCode===229||a.code==="Backslash"&&a.key==="Process"&&a.keyCode===229)&&(e.hint.enableSlash=!1,hideElements(["hint"],e))),a.key!=="PageUp"&&a.key!=="PageDown"&&a.key!=="Home"&&a.key!=="End"&&a.key.indexOf("Arrow")===-1&&a.key!=="Escape"&&a.key!=="Shift"&&a.key!=="Meta"&&a.key!=="Alt"&&a.key!=="Control"&&a.key!=="CapsLock"&&!isNotEditBlock(d)&&!/^F\d{1,2}$/.test(a.key)&&a.key!=="Process"&&(setInsertWbrHTML(d,c,e),e.wysiwyg.preventKeyup=!0),!window.siyuan.menus.menu.element.classList.contains("fn__none")&&(["\u2190","\u2191","\u2192","\u2193"].includes(Constants.KEYCODELIST[a.keyCode])||Constants.KEYCODELIST[a.keyCode]==="\u21A9")&&!a.altKey&&!a.shiftKey&&isNotCtrl(a)){a.preventDefault();return}else a.key!=="Escape"&&window.siyuan.menus.menu.remove();if(!["Alt","Meta","Shift","Control","CapsLock","Escape"].includes(a.key)&&e.options.render.breadcrumb&&e.breadcrumb.hide(),!a.altKey&&!a.shiftKey&&isNotCtrl(a)&&(a.key==="ArrowDown"||a.key==="ArrowUp")){const y=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(y.length>0){if(a.preventDefault(),a.stopPropagation(),hideElements(["select"],e),a.key==="ArrowDown"){const _=y[y.length-1];let h=getNextBlock(_);if(h)if(h.getBoundingClientRect().width===0){const C=hasTopClosestByAttribute(h,"fold","1");C?(h=getNextBlock(C),h?h=getFirstBlock(h):h=_):h=_}else h.getAttribute("fold")==="1"&&(h.classList.contains("sb")||h.classList.contains("bq"))||(h=getFirstBlock(h));else h=_;h.classList.add("protyle-wysiwyg--select"),countBlockWord([h.getAttribute("data-node-id")]);const E=h.getBoundingClientRect().bottom-e.contentElement.getBoundingClientRect().bottom;E>0&&(e.contentElement.scrollTop=e.contentElement.scrollTop+E,e.scroll.lastScrollTop=e.contentElement.scrollTop-1),focusBlock(h)}else if(a.key==="ArrowUp"){let _=getPreviousBlock(y[0]);if(_){if(_=getLastBlock(_),_.getBoundingClientRect().width===0){const h=hasTopClosestByAttribute(_,"fold","1");h?_=getFirstBlock(h):_=y[0]}else if(_){const h=hasTopClosestByAttribute(_,"fold","1");h&&(h.classList.contains("sb")||h.classList.contains("bq"))&&(_=h)}}else if(e.title&&e.title.editElement&&(e.wysiwyg.element.firstElementChild.getAttribute("data-eof")==="1"||e.contentElement.scrollTop===0)){const h=setLastNodeRange(e.title.editElement,c,!1);h.collapse(!1),focusByRange(h),a.stopPropagation(),a.preventDefault()}else e.contentElement.scrollTop!==0?(e.contentElement.scrollTop=0,e.scroll.lastScrollTop=8):_=y[0];if(_){_.classList.add("protyle-wysiwyg--select"),countBlockWord([_.getAttribute("data-node-id")]);const h=_.getBoundingClientRect().top-e.contentElement.getBoundingClientRect().top;h<0&&(e.contentElement.scrollTop=e.contentElement.scrollTop+h,e.scroll.lastScrollTop=e.contentElement.scrollTop+1),focusBlock(_)}}return}}if(a.key!=="PageUp"&&a.key!=="PageDown"&&a.key!=="Home"&&a.key!=="End"&&a.key.indexOf("Arrow")===-1&&isNotCtrl(a)&&a.key!=="Escape"&&!a.shiftKey&&!a.altKey&&!/^F\d{1,2}$/.test(a.key)&&a.key!=="Enter"&&a.key!=="Tab"&&a.key!=="Backspace"&&a.key!=="Delete"&&a.key!=="ContextMenu")return a.stopPropagation(),hideElements(["select"],e),!1;if(matchHotKey(window.siyuan.config.keymap.editor.general.collapse.custom,a)&&!a.repeat){const y=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");return y.length>0?setFold(e,y[0]):d.parentElement.getAttribute("data-type")==="NodeListItem"?d.parentElement.childElementCount>3?setFold(e,d.parentElement):setFold(e,d):d.getAttribute("data-type")==="NodeHeading"?setFold(e,d):setFold(e,getTopAloneElement(d)),a.stopPropagation(),a.preventDefault(),!1}if(matchHotKey(window.siyuan.config.keymap.editor.general.expand.custom,a)&&!a.repeat){const y=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");y.length>0?setFold(e,y[0],!0):d.parentElement.getAttribute("data-type")==="NodeListItem"?d.parentElement.childElementCount>3?setFold(e,d.parentElement,!0):setFold(e,d,!0):d.getAttribute("data-type")==="NodeHeading"?setFold(e,d,!0):setFold(e,getTopAloneElement(d),!0),a.stopPropagation(),a.preventDefault();return}if(a.shiftKey&&(a.key==="ArrowLeft"||a.key==="ArrowRight")){if(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").length>0){a.stopPropagation(),a.preventDefault();return}if(!c.toString()){if(a.key==="ArrowRight"&&isEndOfBlock(c)){a.preventDefault(),a.stopPropagation();return}const _=getContenteditableElement(d);if(getSelectionOffset(_,e.wysiwyg.element,c).start===0&&a.key==="ArrowLeft"){a.preventDefault(),a.stopPropagation();return}}}if(matchHotKey(window.siyuan.config.keymap.editor.general.expandUp.custom,a)){upSelect({protyle:e,event:a,nodeElement:d,editorElement:t,range:c,cb(y){const _=y[0].previousElementSibling;if(_&&_.getAttribute("data-node-id")){_.classList.add("protyle-wysiwyg--select"),y.forEach(E=>{E.removeAttribute("select-end")}),_.setAttribute("select-end","true");const h=_.getBoundingClientRect().top-e.contentElement.getBoundingClientRect().top;h<0&&(e.contentElement.scrollTop=e.contentElement.scrollTop+h,e.scroll.lastScrollTop=e.contentElement.scrollTop+1)}else y[0].parentElement.classList.contains("protyle-wysiwyg")||(hideElements(["select"],e),y[0].parentElement.classList.add("protyle-wysiwyg--select"))}});return}if(matchHotKey(window.siyuan.config.keymap.editor.general.expandDown.custom,a)){downSelect({protyle:e,event:a,nodeElement:d,editorElement:t,range:c,cb(y){const _=y[y.length-1],h=_.nextElementSibling;if(h&&h.getAttribute("data-node-id")){h.classList.add("protyle-wysiwyg--select"),y.forEach(C=>{C.removeAttribute("select-end")}),h.setAttribute("select-end","true");const E=h.getBoundingClientRect().bottom-e.contentElement.getBoundingClientRect().bottom;E>0&&(e.contentElement.scrollTop=e.contentElement.scrollTop+E,e.scroll.lastScrollTop=e.contentElement.scrollTop-1)}else _.parentElement.classList.contains("protyle-wysiwyg")||(hideElements(["select"],e),_.parentElement.classList.add("protyle-wysiwyg--select"))}});return}if(matchHotKey("\u21E7\u2191",a)){upSelect({protyle:e,event:a,nodeElement:d,editorElement:t,range:c,cb(y){const _=getStartEndElement(y);if(_.startElement.getBoundingClientRect().top>=_.endElement.getBoundingClientRect().top){const h=_.endElement.previousElementSibling;if(h&&h.getAttribute("data-node-id")){h.classList.add("protyle-wysiwyg--select"),h.setAttribute("select-end","true"),_.endElement.removeAttribute("select-end");const E=h.getBoundingClientRect().top-e.contentElement.getBoundingClientRect().top;E<0&&(e.contentElement.scrollTop=e.contentElement.scrollTop+E,e.scroll.lastScrollTop=e.contentElement.scrollTop+1)}else _.endElement.parentElement.classList.contains("protyle-wysiwyg")||(hideElements(["select"],e),_.endElement.parentElement.classList.add("protyle-wysiwyg--select"))}else{_.endElement.classList.remove("protyle-wysiwyg--select"),_.endElement.removeAttribute("select-end");const h=getPreviousBlock(_.endElement);h&&(h.setAttribute("select-end","true"),h.getBoundingClientRect().top<=e.contentElement.getBoundingClientRect().top&&(preventScroll(e),h.scrollIntoView(!0)))}}});return}if(matchHotKey("\u21E7\u2193",a)){downSelect({protyle:e,event:a,nodeElement:d,editorElement:t,range:c,cb(y){const _=getStartEndElement(y);if(_.startElement.getBoundingClientRect().top<=_.endElement.getBoundingClientRect().top){const h=_.endElement.nextElementSibling;if(h&&h.getAttribute("data-node-id"))if(h.getBoundingClientRect().width===0)hideElements(["select"],e),_.endElement.parentElement.classList.add("protyle-wysiwyg--select");else{h.classList.add("protyle-wysiwyg--select"),h.setAttribute("select-end","true"),_.endElement.removeAttribute("select-end");const E=h.getBoundingClientRect().bottom-e.contentElement.getBoundingClientRect().bottom;E>0&&(e.contentElement.scrollTop=e.contentElement.scrollTop+E,e.scroll.lastScrollTop=e.contentElement.scrollTop-1)}else _.endElement.parentElement.classList.contains("protyle-wysiwyg")||(hideElements(["select"],e),_.endElement.parentElement.classList.add("protyle-wysiwyg--select"))}else{_.endElement.classList.remove("protyle-wysiwyg--select"),_.endElement.removeAttribute("select-end");const h=getNextBlock(_.endElement);h&&(h.setAttribute("select-end","true"),h.getBoundingClientRect().bottom>=e.contentElement.getBoundingClientRect().bottom&&(preventScroll(e),h.scrollIntoView(!1)))}}});return}if(matchHotKey(window.siyuan.config.keymap.general.enter.custom,a)){onlyProtyleCommand({protyle:e,command:"enter",previousRange:c}),a.preventDefault(),a.stopPropagation();return}if(matchHotKey(window.siyuan.config.keymap.general.enterBack.custom,a)){onlyProtyleCommand({protyle:e,command:"enterBack",previousRange:c}),a.preventDefault(),a.stopPropagation();return}if(a.shiftKey&&!a.altKey&&isNotCtrl(a)&&(a.key==="Home"||a.key==="End")&&isMac()||a.shiftKey&&!a.altKey&&isOnlyMeta(a)&&(a.key==="Home"||a.key==="End")&&!isMac()){const y=hasTopClosestByAttribute(d,"data-node-id",null);if(y){y.querySelectorAll(".protyle-wysiwyg--select").forEach(h=>{h.classList.remove("protyle-wysiwyg--select")}),y.classList.add("protyle-wysiwyg--select");let _=a.key==="Home"?y.previousElementSibling:y.nextElementSibling;for(;_;)_.classList.add("protyle-wysiwyg--select"),_=a.key==="Home"?_.previousElementSibling:_.nextElementSibling;a.key==="Home"?e.wysiwyg.element.firstElementChild.scrollIntoView():e.wysiwyg.element.lastElementChild.scrollIntoView(!1)}a.stopPropagation(),a.preventDefault();return}if((a.key==="Home"||a.key==="End")&&!a.shiftKey&&!a.altKey&&isNotCtrl(a)&&hideElements(["hint"],e),!a.altKey&&!a.shiftKey&&isNotCtrl(a)&&(a.key==="PageUp"||a.key==="PageDown")){a.key==="PageUp"?(e.contentElement.scrollTop=e.contentElement.scrollTop-e.contentElement.clientHeight+60,e.scroll.lastScrollTop=e.contentElement.scrollTop+1):(e.contentElement.scrollTop=e.contentElement.scrollTop+e.contentElement.clientHeight-60,e.scroll.lastScrollTop=e.contentElement.scrollTop-1);const y=e.contentElement.getBoundingClientRect();let _=document.elementFromPoint(y.x+y.width/2,y.y+y.height/2);_.classList.contains("protyle-wysiwyg")&&(_=document.elementFromPoint(y.x+y.width/2,y.y+y.height/2+Constants.SIZE_TOOLBAR_HEIGHT));const h=hasClosestBlock(_);h&&!h.isSameNode(d)&&focusBlock(h,void 0,!1),a.stopPropagation(),a.preventDefault();return}if(!a.altKey&&!a.shiftKey&&(a.key.indexOf("Arrow")>-1&&isNotCtrl(a)||a.key==="Enter")&&!e.hint.element.classList.contains("fn__none")&&e.hint.select(a,e))return;if(matchHotKey("\u2318/",a)){a.stopPropagation(),a.preventDefault();const y=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(y.length===0){const h=hasClosestByAttribute(c.startContainer,"data-type",null);if(h&&h.tagName==="SPAN"){const E=h.getAttribute("data-type").split(" ");if(E.length>0&&(e.toolbar.range=c,removeSearchMark(h)),E.includes("block-ref")){refMenu(e,h);return}else if(E.includes("inline-memo")){e.toolbar.showRender(e,h);return}else if(E.includes("file-annotation-ref")){fileAnnotationRefMenu(e,h);return}else if(E.includes("a")){linkMenu(e,h);return}else if(E.includes("tag")){tagMenu(e,h);return}}if(c.startOffset===0&&c.startContainer.nodeType===3){const E=hasPreviousSibling(c.startContainer);if(E&&E.nodeType!==3&&((n=E.getAttribute("data-type"))==null?void 0:n.indexOf("inline-math"))>-1){inlineMathMenu(e,E);return}else if(!E&&c.startContainer.parentElement.previousSibling&&c.startContainer.parentElement.previousSibling.isSameNode(c.startContainer.parentElement.previousElementSibling)&&((o=c.startContainer.parentElement.previousElementSibling.getAttribute("data-type"))==null?void 0:o.indexOf("inline-math"))>-1){inlineMathMenu(e,c.startContainer.parentElement.previousElementSibling);return}}y.push(d)}y.length===1?e.gutter.renderMenu(e,y[0]):e.gutter.renderMultipleMenu(e,y);const _=d.getBoundingClientRect();window.siyuan.menus.menu.popup({x:_.left,y:_.top,isLeft:!0});return}if(fixTable(e,a,c)){a.preventDefault();return}const g=c.toString();if(!a.altKey&&!a.shiftKey&&isNotCtrl(a)&&!a.isComposing&&a.key.indexOf("Arrow")>-1){const y=hasClosestByTag(c.startContainer,"TD")||hasClosestByTag(c.startContainer,"TH"),_=y||getContenteditableElement(d)||d,h=getSelectionOffset(_,e.wysiwyg.element,c);if(d.classList.contains("code-block")&&h.end===_.innerText.length&&(h.end-=1),a.key==="ArrowDown"&&(_==null?void 0:_.innerText.trimRight().substr(h.start).indexOf(`
`))===-1&&(y&&!y.parentElement.nextElementSibling&&d.getAttribute("data-type")==="NodeTable"&&!getNextBlock(d)||d.getAttribute("data-type")==="NodeCodeBlock"&&!getNextBlock(d)||d.parentElement.getAttribute("data-type")==="NodeBlockquote"&&d.nextElementSibling.classList.contains("protyle-attr")&&!getNextBlock(d.parentElement)))d.parentElement.getAttribute("data-type")==="NodeBlockquote"?insertEmptyBlock(e,"afterend",d.parentElement.getAttribute("data-node-id")):insertEmptyBlock(e,"afterend",d.getAttribute("data-node-id"));else if(a.key==="ArrowUp"){const E=getContenteditableElement(e.wysiwyg.element.firstElementChild);if(!getPreviousBlock(d)&&d.contains(E)||!E&&d.isSameNode(e.wysiwyg.element.firstElementChild)){if(getSelectionPosition(_,c).top-_.getBoundingClientRect().top<20||d.classList.contains("av"))if(e.title&&e.title.editElement&&(e.wysiwyg.element.firstElementChild.getAttribute("data-eof")==="1"||e.contentElement.scrollTop===0)){const C=setLastNodeRange(e.title.editElement,c,!1);C.collapse(!1),focusByRange(C),a.stopPropagation(),a.preventDefault()}else e.contentElement.scrollTop=0,e.scroll.lastScrollTop=8}else if(((_==null?void 0:_.innerText.substr(0,h.end).indexOf(`
`))===-1||h.start===0)&&getSelectionPosition(_,c).top-_.getBoundingClientRect().top<20){let C=getPreviousBlock(d);if(C&&(C=getLastBlock(C),C)){const k=hasClosestByAttribute(C,"fold","1");!k&&C.classList.contains("code-block")?(focusBlock(C,void 0,!1),scrollCenter(e,C),a.stopPropagation(),a.preventDefault()):k&&k.getAttribute("data-type")!=="NodeListItem"&&(k.scrollTop=0,focusBlock(k,void 0,!0),scrollCenter(e,k),a.stopPropagation(),a.preventDefault())}}}else if(g===""&&(a.key==="ArrowDown"||a.key==="ArrowRight")&&d.isSameNode(getLastBlock(e.wysiwyg.element.lastElementChild))&&!hasClosestByTag(c.startContainer,"TD")&&!hasClosestByTag(c.startContainer,"TH")){const E=getContenteditableElement(d);E&&!E.querySelector(".emoji")&&E.textContent.replace(/\n$/,"").length<=getSelectionOffset(E,void 0,c).end&&(a.stopPropagation(),a.preventDefault(),focusByRange(c))}else if(g===""&&a.key==="ArrowLeft"&&d.isSameNode(getFirstBlock(e.wysiwyg.element.firstElementChild))){const E=getContenteditableElement(d);E&&getSelectionOffset(E,void 0,c).start===0&&(a.stopPropagation(),a.preventDefault(),focusByRange(c))}if(a.key==="ArrowDown"){if((_==null?void 0:_.innerText.trimRight().substr(h.start).indexOf(`
`))===-1&&d.isSameNode(e.wysiwyg.element.lastElementChild)){setLastNodeRange(getContenteditableElement(_),c,!1),c.collapse(!1),a.stopPropagation(),a.preventDefault();return}const E=hasClosestByAttribute(c.startContainer,"fold","1");if(E){let C=getNextBlock(E);C&&(C.getAttribute("fold")==="1"&&(C.classList.contains("sb")||C.classList.contains("bq"))||(C=getFirstBlock(C)),focusBlock(C),scrollCenter(e,C)),a.stopPropagation(),a.preventDefault()}else if((_==null?void 0:_.innerText.substr(h.end).indexOf(`
`))===-1||h.end>=_.innerText.trimEnd().length){c.collapse(!1);const C=getNextBlock(d);C&&(C.getAttribute("fold")==="1"||C.classList.contains("code-block"))&&_.getBoundingClientRect().bottom-getSelectionPosition(d,c).top<40&&(focusBlock(C),scrollCenter(e,C),a.stopPropagation(),a.preventDefault())}}return}if(!a.altKey&&(a.key==="Backspace"||a.key==="Delete")||matchHotKey("\u2303D",a)){if(e.wysiwyg.element.querySelector(".protyle-wysiwyg--select")){removeBlock(e,d,c,a.key==="Backspace"?"Backspace":"Delete"),a.stopPropagation(),a.preventDefault();return}if(g===""&&a.key==="Backspace"&&c.startOffset===c.startContainer.textContent.length&&c.startContainer.textContent.endsWith(`
`+Constants.ZWSP)){c.setStart(c.startContainer,c.startOffset-1),c.collapse(!0),a.stopPropagation(),a.preventDefault();return}const y=hasPreviousSibling(c.startContainer);if(c.startOffset===1&&c.startContainer.textContent===Constants.ZWSP&&y&&y.nodeType!==3&&a.key==="Backspace"){if(y.classList.contains("img"))y.classList.add("img--select");else if(((i=y.getAttribute("data-type"))==null?void 0:i.indexOf("inline-math"))>-1){y.after(document.createElement("wbr"));const h=d.outerHTML;c.startContainer.textContent="",y.remove(),updateTransaction(e,d.getAttribute("data-node-id"),d.outerHTML,h),focusByWbr(d,c),a.stopPropagation(),a.preventDefault();return}}const _=e.wysiwyg.element.querySelector(".img--select");if(_){if(_.classList.remove("img--select"),d.contains(_)){removeImage(_,d,c,e),a.stopPropagation(),a.preventDefault();return}}else if(g===""){if(d.classList.contains("table")&&d.querySelector(".table__select").clientHeight>0){clearTableCell(e,d),a.stopPropagation(),a.preventDefault();return}const h=getContenteditableElement(d);if(!h){d.classList.add("protyle-wysiwyg--select"),removeBlock(e,d,c,a.key==="Backspace"?"Backspace":"Delete"),a.stopPropagation(),a.preventDefault();return}const E=getSelectionOffset(h,e.wysiwyg.element,c);if(a.key==="Delete"||matchHotKey("\u2303D",a)){if(c.startOffset===0&&c.startContainer.textContent.length===1){const C=hasPreviousSibling(c.startContainer),k=hasNextSibling(c.startContainer);if(C&&C.nodeType===1&&C.classList.contains("img")&&k&&k.nodeType===1&&k.classList.contains("img")){const v=document.createElement("wbr");c.insertNode(v);const A=d.outerHTML;v.nextSibling.textContent=Constants.ZWSP,updateTransaction(e,d.getAttribute("data-node-id"),d.outerHTML,A),focusByWbr(d,c),a.preventDefault();return}}if(E.end===h.innerText.length||E.end===h.innerText.length-1&&h.innerText.endsWith(`
`)||E.end===h.innerText.length-1&&h.innerText.endsWith(Constants.ZWSP)){const C=getNextBlock(getTopAloneElement(d));if(C){const k=focusBlock(C);if(k){const v=hasClosestBlock(k.startContainer);v&&removeBlock(e,v,k,"Delete")}a.stopPropagation(),a.preventDefault();return}}else if(E.end===h.innerText.length-1&&d.getAttribute("data-type")==="NodeCodeBlock"){a.stopPropagation(),a.preventDefault();return}else{let C=hasNextSibling(c.startContainer);if(C){if(C.nodeType===3&&C.textContent===Constants.ZWSP){if(!C.nextSibling){const k=getNextBlock(d);k&&removeBlock(e,k,c,"remove"),a.stopPropagation(),a.preventDefault();return}C=C.nextSibling}if(C.nodeType===1&&C.classList.contains("img")&&getSelectionOffset(c.startContainer,e.wysiwyg.element,c).start===c.startContainer.textContent.length){removeImage(C,d,c,e),a.stopPropagation(),a.preventDefault();return}}}}else{const C=c.startContainer.childNodes[c.startOffset-1];if(E.start===0&&(c.startOffset===0||C&&C.nodeType===3&&!hasPreviousSibling(C)&&C.textContent==="")){removeBlock(e,d,c,"Backspace"),a.stopPropagation(),a.preventDefault();return}if(c.startContainer.nodeType!==3&&d.getAttribute("data-type")==="NodeTable"&&((s=c.startContainer.children[c.startOffset-1])==null?void 0:s.tagName)==="TABLE"){d.classList.add("protyle-wysiwyg--select"),removeBlock(e,d,c,"Backspace"),a.stopPropagation(),a.preventDefault();return}if(C&&C.nodeType!==3&&C.classList.contains("img")){removeImage(C,d,c,e),a.stopPropagation(),a.preventDefault();return}if(c.startOffset===1&&c.startContainer.textContent.length===1){const v=hasPreviousSibling(c.startContainer),A=hasNextSibling(c.startContainer);if(v&&v.nodeType===1&&v.classList.contains("img")&&A&&A.nodeType===1&&A.classList.contains("img")){const L=document.createElement("wbr");c.insertNode(L);const x=d.outerHTML;L.previousSibling.textContent=Constants.ZWSP,updateTransaction(e,d.getAttribute("data-node-id"),d.outerHTML,x),focusByWbr(d,c),a.preventDefault();return}}if(d.classList.contains("code-block")&&isOnlyMeta(a)&&c.startContainer.nodeType===3&&c.startContainer.textContent.substring(c.startOffset-1,c.startOffset)===`
`){a.stopPropagation(),a.preventDefault();return}const k=hasClosestByTag(c.startContainer,"SPAN");if(E.start===2&&k&&getSelectionOffset(k,e.wysiwyg.element,c).start===1&&k.innerText.startsWith(Constants.ZWSP)&&h.innerText.startsWith(Constants.ZWSP)){focusBlock(d),a.stopPropagation(),a.preventDefault();return}if(E.start===1&&!k&&h.innerText.startsWith(Constants.ZWSP)&&h.innerText.length>1){setFirstNodeRange(h,c),removeBlock(e,d,c,"Backspace"),a.stopPropagation(),a.preventDefault();return}}}else if(d.classList.contains("code-block")&&getContenteditableElement(d).textContent===`
`){c.collapse(!0),a.stopPropagation(),a.preventDefault();return}}if(matchHotKey("\u21E7\u21A9",a)&&g===""&&softEnter(c,d,e)){a.stopPropagation(),a.preventDefault();return}if(isNotCtrl(a)&&a.key==="Enter"){if(a.altKey)addSubList(e,d,c);else if(!a.shiftKey){enter(d,c,e),a.stopPropagation(),a.preventDefault();return}}if(matchHotKey("\u2318A",a))return a.preventDefault(),selectAll(e,d,c),!0;if(matchHotKey(window.siyuan.config.keymap.editor.general.undo.custom,a)){e.undo.undo(e),a.preventDefault(),a.stopPropagation();return}if(matchHotKey(window.siyuan.config.keymap.editor.general.redo.custom,a)){e.undo.redo(e),a.preventDefault(),a.stopPropagation();return}if(matchHotKey(window.siyuan.config.keymap.editor.general.copyText.custom,a)){if(g!=="")Qn(c,y=>{writeText(`${y.trim()} ((${d.getAttribute("data-node-id")} "*"))`)});else{const y=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");y.length>0?(y[0].setAttribute("data-reftext","true"),focusByRange(getEditorRange(d)),document.execCommand("copy")):writeText(`((${d.getAttribute("data-node-id")} "*"))`)}return a.preventDefault(),a.stopPropagation(),!0}if(matchHotKey(window.siyuan.config.keymap.editor.general.attr.custom,a)){const y=getTopAloneElement(d);if(g===""){const _=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");let h;_.length===1?h=_[0]:h=y,openAttr(h,"bookmark",e)}else Qn(c,_=>{const h=y.outerHTML,E=y.lastElementChild.querySelector(".protyle-attr--name");E?E.innerHTML=`<svg><use xlink:href="#iconN"></use></svg>${_.trim()}`:y.lastElementChild.insertAdjacentHTML("afterbegin",`<div class="protyle-attr--name"><svg><use xlink:href="#iconN"></use></svg>${_.trim()}</div>`),y.setAttribute("name",_.trim()),updateTransaction(e,y.getAttribute("data-node-id"),y.outerHTML,h)});return a.preventDefault(),a.stopPropagation(),!0}if(matchHotKey(window.siyuan.config.keymap.editor.general.rename.custom,a)&&!e.disabled){g===""?fetchPost("/api/block/getDocInfo",{id:e.block.rootID},y=>{rename({notebookId:e.notebookId,path:e.path,name:y.data.ial.title,range:c,type:"file"})}):fetchPost("/api/filetree/renameDoc",{notebook:e.notebookId,path:e.path,title:replaceFileName(g)}),a.preventDefault(),a.stopPropagation();return}const f=matchHotKey(window.siyuan.config.keymap.editor.general.newNameFile.custom,a);if(f||matchHotKey(window.siyuan.config.keymap.editor.general.newNameSettingFile.custom,a)){!g.trim()&&(d.querySelector("tr")||d.querySelector("span"))||(!g.trim()&&getContenteditableElement(d).textContent&&selectAll(e,d,c),f?fetchPost("/api/filetree/getHPathByPath",{notebook:e.notebookId,path:e.path},y=>{newFileBySelect(e,g,d,y.data,e.notebookId)}):getSavePath(e.path,e.notebookId,(y,_)=>{newFileBySelect(e,g,d,y,_)})),a.preventDefault(),a.stopPropagation();return}if(matchHotKey(window.siyuan.config.keymap.editor.general.newContentFile.custom,a)){newFileContentBySelect(e),a.preventDefault(),a.stopPropagation();return}if(matchHotKey(window.siyuan.config.keymap.editor.general.alignLeft.custom,a)){const y=d.querySelectorAll(".img--select");if(y.length>0)alignImgLeft(e,d,Array.from(y),d.getAttribute("data-node-id"),d.outerHTML);else{let _=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));_.length===0&&(_=[d]),updateBatchTransaction(_,e,h=>{h.classList.contains("av")?h.style.justifyContent="":h.style.textAlign="left"})}a.stopPropagation(),a.preventDefault();return}if(matchHotKey(window.siyuan.config.keymap.editor.general.alignCenter.custom,a)){const y=d.querySelectorAll(".img--select");if(y.length>0)alignImgCenter(e,d,Array.from(y),d.getAttribute("data-node-id"),d.outerHTML);else{let _=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));_.length===0&&(_=[d]),updateBatchTransaction(_,e,h=>{h.classList.contains("av")?h.style.justifyContent="center":h.style.textAlign="center"})}a.stopPropagation(),a.preventDefault();return}if(matchHotKey(window.siyuan.config.keymap.editor.general.alignRight.custom,a)){let y=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));y.length===0&&(y=[d]),updateBatchTransaction(y,e,_=>{_.classList.contains("av")?_.style.justifyContent="flex-end":_.style.textAlign="right"}),a.stopPropagation(),a.preventDefault();return}if(matchHotKey(window.siyuan.config.keymap.editor.general.rtl.custom,a)){let y=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));y.length===0&&(y=[d]),updateBatchTransaction(y,e,_=>{_.style.direction="rtl"}),a.stopPropagation(),a.preventDefault();return}if(matchHotKey(window.siyuan.config.keymap.editor.general.ltr.custom,a)){let y=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));y.length===0&&(y=[d]),updateBatchTransaction(y,e,_=>{_.style.direction="ltr"}),a.stopPropagation(),a.preventDefault();return}if(a.key==="Escape"){if(a.repeat){const y=hasClosestByClassName(c.startContainer,"card__main",!0);y&&document.activeElement&&document.activeElement.classList.contains("protyle-wysiwyg")&&(y.querySelector(".card__action:not(.fn__none) button:not([disabled])").focus(),hideElements(["select"],e))}else!e.toolbar.element.classList.contains("fn__none")||!e.hint.element.classList.contains("fn__none")||!e.toolbar.subElement.classList.contains("fn__none")?(hideElements(["toolbar","hint","util"],e),e.hint.enableExtend=!1):d.classList.contains("protyle-wysiwyg--select")?(hideElements(["select"],e),countBlockWord([],e.block.rootID)):window.siyuan.menus.menu.element.classList.contains("fn__none")?(hideElements(["select"],e),c.collapse(!1),d.classList.add("protyle-wysiwyg--select"),countBlockWord([d.getAttribute("data-node-id")],e.block.rootID)):window.siyuan.menus.menu.remove();a.stopPropagation(),a.preventDefault();return}if(matchHotKey(window.siyuan.config.keymap.editor.heading.paragraph.custom,a)){const y=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(y.length===0&&y.push(d),y.length>1)turnsIntoTransaction({protyle:e,nodeElement:y[0],type:"Blocks2Ps"});else{const _=y[0].getAttribute("data-type");_==="NodeHeading"?turnsIntoTransaction({protyle:e,nodeElement:y[0],type:"Blocks2Ps"}):_==="NodeList"?turnsOneInto({protyle:e,nodeElement:y[0],id:y[0].getAttribute("data-node-id"),type:"CancelList"}):_==="NodeBlockquote"&&turnsOneInto({protyle:e,nodeElement:y[0],id:y[0].getAttribute("data-node-id"),type:"CancelBlockquote"})}return a.preventDefault(),a.stopPropagation(),!0}if(matchHotKey(window.siyuan.config.keymap.editor.heading.heading1.custom,a))return turnsIntoTransaction({protyle:e,nodeElement:d,type:"Blocks2Hs",level:1}),a.preventDefault(),a.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.heading.heading2.custom,a))return turnsIntoTransaction({protyle:e,nodeElement:d,type:"Blocks2Hs",level:2}),a.preventDefault(),a.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.heading.heading3.custom,a))return turnsIntoTransaction({protyle:e,nodeElement:d,type:"Blocks2Hs",level:3}),a.preventDefault(),a.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.heading.heading4.custom,a))return turnsIntoTransaction({protyle:e,nodeElement:d,type:"Blocks2Hs",level:4}),a.preventDefault(),a.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.heading.heading5.custom,a))return turnsIntoTransaction({protyle:e,nodeElement:d,type:"Blocks2Hs",level:5}),a.preventDefault(),a.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.heading.heading6.custom,a))return turnsIntoTransaction({protyle:e,nodeElement:d,type:"Blocks2Hs",level:6}),a.preventDefault(),a.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.insert.code.custom,a)&&!["NodeCodeBlock","NodeHeading"].includes(d.getAttribute("data-type"))){const y=d.getAttribute("data-node-id"),_=d.outerHTML,h=getContenteditableElement(d);h.innerHTML="```"+window.siyuan.storage[Constants.LOCAL_CODELANG]+`
`+Lute.EscapeHTMLStr(h.textContent)+"<wbr>\n```";const E=e.lute.SpinBlockDOM(d.outerHTML);d.outerHTML=E;const C=e.wysiwyg.element.querySelector(`[data-node-id="${y}"]`);return updateTransaction(e,y,E,_),highlightRender(C),a.preventDefault(),a.stopPropagation(),!0}if(matchHotKey(window.siyuan.config.keymap.editor.insert.lastUsed.custom,a)){e.toolbar.range=c;const y=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));g===""&&y.length===0&&y.push(d),fontEvent(e,y),a.stopPropagation(),a.preventDefault();return}if(!d.classList.contains("code-block")&&!a.repeat&&!isInEmbedBlock(d)){let y=!1;if(e.options.toolbar.find(_=>{if(!_.hotkey)return!1;if(matchHotKey(_.hotkey,a))return e.toolbar.range=c,["block-ref"].includes(_.name)&&e.toolbar.range.toString()===""||(y=!0,["a","block-ref","inline-math","inline-memo","text"].includes(_.name)?e.toolbar.element.querySelector(`[data-type="${_.name}"]`).dispatchEvent(new CustomEvent("click")):Constants.INLINE_TYPE.includes(_.name)?e.toolbar.setInlineMark(e,_.name,"range"):_.click&&_.click(e.getInstance())),!0}),y)return a.preventDefault(),a.stopPropagation(),e.wysiwyg.preventKeyup=!0,!0}if(matchHotKey(window.siyuan.config.keymap.editor.list.outdent.custom,a)){const y=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(y.length>0){let _=!0;return y.forEach((h,E)=>{h.nextElementSibling&&y[E+1]&&(y[E+1].isSameNode(h.nextElementSibling)||(_=!1))}),_&&(y[0].classList.contains("li")||y[0].parentElement.classList.contains("li"))&&listOutdent(e,Array.from(y),c),a.preventDefault(),a.stopPropagation(),!0}else if(d.parentElement.classList.contains("li")&&d.getAttribute("data-type")!=="NodeCodeBlock")return listOutdent(e,[d.parentElement],c),a.preventDefault(),a.stopPropagation(),!0}if(matchHotKey(window.siyuan.config.keymap.editor.list.indent.custom,a)){const y=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(y.length>0){let _=!0;return y.forEach((h,E)=>{h.nextElementSibling&&y[E+1]&&(y[E+1].isSameNode(h.nextElementSibling)||(_=!1))}),_&&(y[0].classList.contains("li")||y[0].parentElement.classList.contains("li"))&&listIndent(e,Array.from(y),c),a.preventDefault(),a.stopPropagation(),!0}else if(d.parentElement.classList.contains("li")&&d.getAttribute("data-type")!=="NodeCodeBlock")return listIndent(e,[d.parentElement],c),a.preventDefault(),a.stopPropagation(),!0}const p=matchHotKey(window.siyuan.config.keymap.editor.insert.list.custom,a),m=matchHotKey(window.siyuan.config.keymap.editor.insert.check.custom,a),b=matchHotKey(window.siyuan.config.keymap.editor.insert["ordered-list"].custom,a),w=matchHotKey(window.siyuan.config.keymap.editor.insert.quote.custom,a);if(p||b||m||w){const y=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(y.length===0&&y.push(d),y.length===1){const _=y[0].dataset.subtype,h=y[0].dataset.type;if(w)["NodeHeading","NodeParagraph","NodeList"].includes(h)?turnsIntoOneTransaction({protyle:e,selectsElement:y,type:"Blocks2Blockquote"}):(e.hint.splitChar="/",e.hint.lastIndex=-1,e.hint.fill(">"+Lute.Caret,e));else if(h==="NodeParagraph")turnsIntoOneTransaction({protyle:e,selectsElement:y,type:m?"Blocks2TLs":p?"Blocks2ULs":"Blocks2OLs"});else if(h==="NodeList"){const E=y[0].dataset.nodeId;_==="o"&&(p||m)?turnsOneInto({protyle:e,nodeElement:y[0],id:E,type:m?"UL2TL":"OL2UL"}):_==="t"&&(p||b)?turnsOneInto({protyle:e,nodeElement:y[0],id:E,type:p?"TL2UL":"TL2OL"}):_==="u"&&(m||b)&&turnsOneInto({protyle:e,nodeElement:y[0],id:E,type:m?"OL2TL":"UL2OL"})}else e.hint.splitChar="/",e.hint.lastIndex=-1,e.hint.fill((m?"* [ ] ":p?"* ":"1. ")+Lute.Caret,e)}else{let _=!1,h=!1;y.find((E,C)=>{if(E.classList.contains("li"))return _=!0,!0;if(E.nextElementSibling&&y[C+1]&&E.nextElementSibling.isSameNode(y[C+1]))h=!0;else if(C!==y.length-1)return h=!1,!0}),!_&&h&&turnsIntoOneTransaction({protyle:e,selectsElement:y,type:w?"Blocks2Blockquote":m?"Blocks2TLs":p?"Blocks2ULs":"Blocks2OLs"})}a.preventDefault(),a.stopPropagation();return}if(matchHotKey(window.siyuan.config.keymap.editor.insert.table.custom,a)){e.hint.splitChar="/",e.hint.lastIndex=-1,e.hint.fill(`| ${Lute.Caret} |  |  |
| --- | --- | --- |
|  |  |  |
|  |  |  |`,e),a.preventDefault(),a.stopPropagation();return}if(matchHotKey(window.siyuan.config.keymap.editor.list.checkToggle.custom,a)){const y=hasClosestByAttribute(c.startContainer,"data-subtype","t");if(!y)return;const _=y.outerHTML;y.classList.contains("protyle-task--done")?(y.querySelector("use").setAttribute("xlink:href","#iconUncheck"),y.classList.remove("protyle-task--done")):(y.querySelector("use").setAttribute("xlink:href","#iconCheck"),y.classList.add("protyle-task--done")),y.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,y.getAttribute("data-node-id"),y.outerHTML,_),a.preventDefault(),a.stopPropagation();return}if(matchHotKey(window.siyuan.config.keymap.editor.general.insertBefore.custom,a))return insertEmptyBlock(e,"beforebegin"),a.preventDefault(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.general.insertAfter.custom,a))return insertEmptyBlock(e,"afterend"),a.preventDefault(),a.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.general.jumpToParentNext.custom,a))return jumpToParent(e,d,"next"),a.preventDefault(),a.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.general.jumpToParent.custom,a))return jumpToParent(e,d,"parent"),a.preventDefault(),a.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.general.jumpToParentPrev.custom,a))return jumpToParent(e,d,"previous"),a.preventDefault(),a.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.general.moveToUp.custom,a)){a.preventDefault(),a.stopPropagation(),moveToUp(e,d,c);return}if(matchHotKey(window.siyuan.config.keymap.editor.general.moveToDown.custom,a)){a.preventDefault(),a.stopPropagation(),moveToDown(e,d,c);return}if(matchHotKey(window.siyuan.config.keymap.editor.general.vLayout.custom,a)){a.preventDefault(),a.stopPropagation();const y=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(y.length===1&&y[0].getAttribute("data-type")==="NodeSuperBlock"){if(y[0].getAttribute("data-sb-layout")==="col"){const _=y[0].outerHTML;y[0].setAttribute("data-sb-layout","row"),y[0].setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,y[0].getAttribute("data-node-id"),y[0].outerHTML,_)}else{c.insertNode(document.createElement("wbr"));const _=cancelSB(e,y[0]);transaction(e,_.doOperations,_.undoOperations),focusByWbr(e.wysiwyg.element,c)}return}if(y.length<2||(l=y[0])!=null&&l.classList.contains("li"))return;turnsIntoOneTransaction({protyle:e,selectsElement:y,type:"BlocksMergeSuperBlock",level:"row"});return}if(matchHotKey(window.siyuan.config.keymap.editor.general.hLayout.custom,a)){a.preventDefault(),a.stopPropagation();const y=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(y.length===1&&y[0].getAttribute("data-type")==="NodeSuperBlock"){if(y[0].getAttribute("data-sb-layout")==="row"){const _=y[0].outerHTML;y[0].setAttribute("data-sb-layout","col"),y[0].setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,y[0].getAttribute("data-node-id"),y[0].outerHTML,_)}else{c.insertNode(document.createElement("wbr"));const _=cancelSB(e,y[0]);transaction(e,_.doOperations,_.undoOperations),focusByWbr(e.wysiwyg.element,c)}return}if(y.length<2||(r=y[0])!=null&&r.classList.contains("li"))return;turnsIntoOneTransaction({protyle:e,selectsElement:y,type:"BlocksMergeSuperBlock",level:"col"});return}if(!a.repeat&&matchHotKey(window.siyuan.config.keymap.editor.general.ai.custom,a)){a.preventDefault(),a.stopPropagation();let y=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));y.length===0&&(y=[d]),AIActions(y,e);return}if(!a.repeat&&matchHotKey(window.siyuan.config.keymap.editor.general.aiWriting.custom,a)){a.preventDefault(),a.stopPropagation(),AIChat(e,d);return}if(!a.repeat&&matchHotKey(window.siyuan.config.keymap.editor.general.openInNewTab.custom,a)){a.preventDefault(),a.stopPropagation();const y=window.siyuan.blockPanels.find(h=>{if(h.element.contains(d))return!0}),_=d.getAttribute("data-node-id");checkFold(_,(h,E)=>{openFileById({app:e.app,id:_,action:E,zoomIn:h,openNewTab:!0}),y.destroy()});return}if(a.key==="Tab"&&isNotCtrl(a)&&!a.altKey){a.preventDefault();const y=window.siyuan.config.editor.codeTabSpaces===0?"	":"".padStart(window.siyuan.config.editor.codeTabSpaces," ");if(d.getAttribute("data-type")==="NodeCodeBlock"&&g!==""){!hasNextSibling(c.endContainer)&&c.endContainer.textContent.endsWith(`
`)&&c.endOffset>0&&c.setEnd(c.endContainer,c.endOffset-1);const _=document.createElement("wbr");c.insertNode(_),c.setStartAfter(_);const h=d.outerHTML;let E="";a.shiftKey?c.extractContents().textContent.split(`
`).forEach(v=>{v.startsWith(y)?E+=v.replace(y,"")+`
`:E+=v+`
`}):c.extractContents().textContent.split(`
`).forEach(v=>{E+=y+v+`
`});let C=d.querySelector(".protyle-action__language").textContent;window.hljs.getLanguage(C)||(C="plaintext"),_.insertAdjacentHTML("afterend",window.hljs.highlight(E.substr(0,E.length-1),{language:C,ignoreIllegals:!0}).value+"<br>"),c.setStart(_.nextSibling,0);const k=_.parentElement.querySelector("br");setLastNodeRange(k.previousSibling,c,!1),k.remove(),updateTransaction(e,d.getAttribute("data-node-id"),d.outerHTML,h),_.remove();return}if(!a.shiftKey){const _=document.createElement("wbr");c.insertNode(_);const h=d.outerHTML;return c.extractContents(),c.insertNode(document.createTextNode(y)),c.collapse(!1),focusByRange(c),_.remove(),updateTransaction(e,d.getAttribute("data-node-id"),d.outerHTML,h),!0}}if(a.key==="ContextMenu"){const y=getSelectionPosition(d,c);e.wysiwyg.element.dispatchEvent(new CustomEvent("contextmenu",{detail:{target:d,y:y.top+8,x:y.left}})),a.preventDefault(),a.stopPropagation();return}if(matchHotKey("\u21E7\u2318V",a)){a.returnValue=!1,a.preventDefault(),a.stopPropagation(),pasteAsPlainText(e);return}if(matchHotKey(window.siyuan.config.keymap.editor.general.openBy.custom,a)){const y=hasClosestByAttribute(c.startContainer,"data-type","a");if(y){openLink(e,y.getAttribute("data-href"),void 0,!1),a.preventDefault(),a.stopPropagation();return}const _=hasClosestByAttribute(c.startContainer,"data-type","file-annotation-ref");if(_){const E=`assets/${_.getAttribute("data-id").split("/")[1]}`;openLink(e,E,void 0,!1),a.preventDefault(),a.stopPropagation();return}return}if(isNotCtrl(a)&&a.key!=="Backspace"&&a.key!=="Escape"&&a.key!=="Delete"&&!a.shiftKey&&!a.altKey&&a.key!=="Enter"&&hideElements(["select"],e),matchHotKey("\u2318B",a)||matchHotKey("\u2318I",a)||matchHotKey("\u2318U",a)){a.preventDefault(),a.stopPropagation();return}})};var mo=(e,t,a)=>new Promise((n,o)=>{var i=r=>{try{l(a.next(r))}catch(c){o(c)}},s=r=>{try{l(a.throw(r))}catch(c){o(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(i,s);l((a=a.apply(e,t)).next())});const bo=(e,t)=>{const a=new Dialog({title:window.siyuan.languages.searchType,content:`<div class="b3-dialog__content">
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconMath"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.math}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="mathBlock" type="checkbox"${e.types.mathBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconTable"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.table}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="table" type="checkbox"${e.types.table?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconParagraph"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.paragraph}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="paragraph" type="checkbox"${e.types.paragraph?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconHeadings"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.headings}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="heading" type="checkbox"${e.types.heading?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconCode"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.code}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="codeBlock" type="checkbox"${e.types.codeBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconHTML5"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            HTML
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="htmlBlock" type="checkbox"${e.types.htmlBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconDatabase"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.database}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="databaseBlock" type="checkbox"${e.types.databaseBlock?" checked":""}>
    </label>    
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconSQL"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.embedBlock}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="embedBlock" type="checkbox"${e.types.embedBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconVideo"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.video}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="videoBlock" type="checkbox"${e.types.videoBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconRecord"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.audio}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="audioBlock" type="checkbox"${e.types.audioBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconLanguage"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            IFrame
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="iframeBlock" type="checkbox"${e.types.iframeBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconBoth"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.widget}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="widgetBlock" type="checkbox"${e.types.widgetBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconQuote"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.quote} <sup>[1]</sup>
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="blockquote" type="checkbox"${e.types.blockquote?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconSuper"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.superBlock} <sup>[1]</sup>
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="superBlock" type="checkbox"${e.types.superBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconList"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.list1} <sup>[1]</sup>
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="list" type="checkbox"${e.types.list?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconListItem"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.listItem} <sup>[1]</sup>
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="listItem" type="checkbox"${e.types.listItem?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconFile"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.doc}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="document" type="checkbox"${e.types.document?" checked":""}>
    </label>
    <span class="fn__space"></span>
    <div class="fn__flex-1">
        <div class="b3-label__text">[1] ${window.siyuan.languages.containerBlockTip1}</div>
    </div>    
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px",height:"70vh"});a.element.setAttribute("data-key",Constants.DIALOG_SEARCHTYPE);const n=a.element.querySelectorAll(".b3-button");n[0].addEventListener("click",()=>{a.destroy()}),n[1].addEventListener("click",()=>{a.element.querySelectorAll(".b3-switch").forEach(o=>{e.types[o.getAttribute("data-type")]=o.checked}),t(),a.destroy()})},yo=e=>{let t="";Object.keys(Constants.SIYUAN_DEFAULT_REPLACETYPES).forEach(o=>{t+=`<label class="fn__flex b3-label">
    <span class="fn__space"></span>
    <div class="fn__flex-1 fn__flex-center">
        ${window.siyuan.languages.replaceTypes[o]}
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" data-type="${o}" type="checkbox"${e.replaceTypes[o]?" checked":""}>
</label>`});const a=new Dialog({title:window.siyuan.languages.replaceType,content:`<div class="b3-dialog__content">${t}</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px",height:"70vh"});a.element.setAttribute("data-key",Constants.DIALOG_REPLACETYPE);const n=a.element.querySelectorAll(".b3-button");n[0].addEventListener("click",()=>{a.destroy()}),n[1].addEventListener("click",()=>{a.element.querySelectorAll(".b3-switch").forEach(o=>{e.replaceTypes[o.getAttribute("data-type")]=o.checked}),a.destroy()})},cd=(e,t)=>{if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="searchMethod"){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name","searchMethod"),window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",label:window.siyuan.languages.keyword,current:e.method===0,click(){e.method=0,t()}}).element),window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",label:window.siyuan.languages.querySyntax,current:e.method===1,click(){e.method=1,t()}}).element),window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",label:"SQL",current:e.method===2,click(){e.method=2,t()}}).element),window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",label:window.siyuan.languages.regex,current:e.method===3,click(){e.method=3,t()}}).element)},ra=(e,t,a,n,o)=>{e.removed=!1;const i=e;i.name=n,t.push(Object.assign({},i)),window.siyuan.storage[Constants.LOCAL_SEARCHDATA]=Object.assign({},e),setStorageVal(Constants.LOCAL_SEARCHDATA,window.siyuan.storage[Constants.LOCAL_SEARCHDATA]),fetchPost("/api/storage/setCriterion",{criterion:i},()=>{var s;o.destroy();const l=a.querySelector("#criteria").firstElementChild;l.classList.remove("fn__none"),(s=l.querySelector(".b3-chip--current"))==null||s.classList.remove("b3-chip--current"),l.insertAdjacentHTML("beforeend",`<div data-type="set-criteria" class="b3-chip b3-chip--current b3-chip--middle b3-chip--pointer">${i.name}<svg class="b3-chip__close" data-type="remove-criteria"><use xlink:href="#iconCloseRound"></use></svg></div>`)})},ho=(e,t,a)=>{const n=new Dialog({title:window.siyuan.languages.saveCriterion,content:`<div class="b3-dialog__content">
        <input class="b3-text-field fn__block" placeholder="${window.siyuan.languages.memo}">
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px"});n.element.setAttribute("data-key",Constants.DIALOG_SAVECRITERION);const o=n.element.querySelectorAll(".b3-button");n.bindInput(n.element.querySelector("input"),()=>{o[1].dispatchEvent(new CustomEvent("click"))}),o[0].addEventListener("click",()=>{n.destroy()}),o[1].addEventListener("click",()=>{const i=n.element.querySelector("input"),s=i.value.trim();if(!s){showMessage(window.siyuan.languages._kernel[142]);return}isMobile()?(e.k=document.querySelector("#toolbarSearch").value,e.r=a.querySelector("#toolbarReplace").value):(e.k=a.querySelector("#searchInput").value,e.r=a.querySelector("#replaceInput").value);const l=a.querySelector("#criteria").firstElementChild;let r="",c="";if(t.forEach(d=>{d.name===s&&(r=d.name),es(d,e)&&(c=d.name)}),i.blur(),r&&!c)confirmDialog(window.siyuan.languages.confirm,window.siyuan.languages.searchOverwrite,()=>{Array.from(l.children).forEach(d=>{d.textContent===s&&d.remove()}),t.find((d,u)=>{if(d.name===s)return t.splice(u,1),!0}),ra(e,t,a,s,n)});else if(r&&c)if(r===c)n.destroy();else{const d=r===s?c:r;confirmDialog(window.siyuan.languages.confirm,window.siyuan.languages.searchRemoveName.replace("${x}",d).replace("${y}",s),()=>{Array.from(l.children).forEach(u=>{(u.textContent===c||u.textContent===r)&&u.remove()}),t.find((u,g)=>{if(u.name===d||u.name===r)return fetchPost("/api/storage/removeCriterion",{name:d}),t.splice(g,1),!0}),ra(e,t,a,s,n)})}else!r&&c?confirmDialog(window.siyuan.languages.confirm,window.siyuan.languages.searchUpdateName.replace("${x}",c).replace("${y}",s),()=>{Array.from(l.children).forEach(d=>{d.textContent===c&&d.remove()}),t.find((d,u)=>{if(d.name===c)return fetchPost("/api/storage/removeCriterion",{name:c}),t.splice(u,1),!0}),ra(e,t,a,s,n)}):ra(e,t,a,s,n)})},dd=(e,t,a,n,o,i)=>mo(void 0,null,function*(){if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="searchMore"){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name","searchMore"),window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",label:window.siyuan.languages.listInvalidRefBlocks,click(){goUnRef()}}).element),window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",label:window.siyuan.languages.searchType,click(){bo(e,()=>{updateSearchResult(e,a,!0)})}}).element),window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",label:window.siyuan.languages.replaceType,click(){yo(e)}}).element),window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",label:window.siyuan.languages.searchMethod,type:"submenu",submenu:[{iconHTML:"",label:window.siyuan.languages.keyword,current:e.method===0,click(){e.method=0,e.page=1,updateSearchResult(e,a,!0)}},{iconHTML:"",label:window.siyuan.languages.querySyntax,current:e.method===1,click(){e.method=1,e.page=1,updateSearchResult(e,a,!0)}},{iconHTML:"",label:"SQL",current:e.method===2,click(){e.method=2,e.page=1,updateSearchResult(e,a,!0)}},{iconHTML:"",label:window.siyuan.languages.regex,current:e.method===3,click(){e.method=3,e.page=1,updateSearchResult(e,a,!0)}}]}).element);const s=[{iconHTML:"",label:window.siyuan.languages.type,current:e.sort===0,click(){e.sort=0,n()}},{iconHTML:"",label:window.siyuan.languages.createdASC,current:e.sort===1,click(){e.sort=1,n()}},{iconHTML:"",label:window.siyuan.languages.createdDESC,current:e.sort===2,click(){e.sort=2,n()}},{iconHTML:"",label:window.siyuan.languages.modifiedASC,current:e.sort===3,click(){e.sort=3,n()}},{iconHTML:"",label:window.siyuan.languages.modifiedDESC,current:e.sort===4,click(){e.sort=4,n()}},{iconHTML:"",label:window.siyuan.languages.sortByRankAsc,current:e.sort===6,click(){e.sort=6,n()}},{iconHTML:"",label:window.siyuan.languages.sortByRankDesc,current:e.sort===7,click(){e.sort=7,n()}}];e.group===1&&s.push({iconHTML:"",label:window.siyuan.languages.sortByContent,current:e.sort===5,click(){e.sort=5,n()}}),window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",label:window.siyuan.languages.sort,type:"submenu",submenu:s}).element),window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",label:window.siyuan.languages.group,type:"submenu",submenu:[{iconHTML:"",label:window.siyuan.languages.noGroupBy,current:e.group===0,click(){isMobile()?(a.querySelector('[data-type="expand"]').classList.add("fn__none"),a.querySelector('[data-type="contract"]').classList.add("fn__none")):a.querySelector("#searchCollapse").parentElement.classList.add("fn__none"),e.group=0,e.sort===5&&(e.sort=0),n()}},{iconHTML:"",label:window.siyuan.languages.groupByDoc,current:e.group===1,click(){isMobile()?(a.querySelector('[data-type="expand"]').classList.remove("fn__none"),a.querySelector('[data-type="contract"]').classList.remove("fn__none")):a.querySelector("#searchCollapse").parentElement.classList.remove("fn__none"),e.group=1,n()}}]}).element),i&&i(),window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.saveCriterion,iconHTML:"",click(){ho(e,t,a)}}).element),window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",label:window.siyuan.languages.removeCriterion,click(){o()}}).element)}),es=(e,t)=>!!(t.group===e.group&&t.hPath===e.hPath&&t.hasReplace===e.hasReplace&&t.k===e.k&&t.method===e.method&&t.r===e.r&&t.sort===e.sort&&objEquals(t.types,e.types)&&objEquals(t.replaceTypes,e.replaceTypes)&&objEquals(t.idPath,e.idPath)),ud=(e,t,a)=>{fetchPost("/api/storage/getCriteria",{},n=>{let o="";n.data.forEach(i=>{t.push(i);let s=!1;es(i,a)&&(s=!0),o+=`<div data-type="set-criteria" class="${s?"b3-chip--current ":""}b3-chip b3-chip--middle b3-chip--pointer">${escapeHtml(i.name)}<svg class="b3-chip__close" data-type="remove-criteria"><use xlink:href="#iconCloseRound"></use></svg></div>`}),e.innerHTML=`<div class="b3-chips${o?"":" fn__none"}">
    ${o}
</div>`})},fd=e=>{const t=[];return e.querySelectorAll("mark").forEach(a=>{t.push(a.textContent)}),[...new Set(t)].join(" ")},gd=(e,t)=>{};let ts;const as=(e,t,a=1)=>{var n;const o=e.parentElement.querySelector(".fn__loading--top");if(!isPaidUser()){o.classList.add("fn__none"),(n=e.querySelector(".search__drag"))==null||n.classList.add("fn__none"),e.querySelector("#searchAssetPreview").classList.add("fn__none"),e.querySelector("#searchAssetList").innerHTML=`<div class="search__empty">
    ${window.siyuan.languages._kernel[214]}
</div>`;return}o.classList.remove("fn__none"),clearTimeout(ts),ts=window.setTimeout(()=>{t||(t=window.siyuan.storage[Constants.LOCAL_SEARCHASSET]);const i=e.querySelector('[data-type="assetPrevious"]');a>1?i.removeAttribute("disabled"):i.setAttribute("disabled","disabled");const s=e.querySelector("#searchAssetInput");fetchPost("/api/search/fullTextSearchAssetContent",{page:a,query:s.value,types:t.types,method:t.method,orderBy:t.sort},l=>{var r,c;o.classList.add("fn__none");const d=e.querySelector('[data-type="assetNext"]');a<l.data.pageCount?d.removeAttribute("disabled"):d.setAttribute("disabled","disabled");let u="";l.data.assetContents.forEach((f,p)=>{u+=`<div data-type="search-item" class="b3-list-item${p===0?" b3-list-item--focus":""}" data-id="${f.id}">
<span class="ft__on-surface">${f.ext}</span>
<span class="fn__space"></span>
<span class="b3-list-item__text">${f.content}</span>
<span class="b3-list-item__meta">${f.hSize}</span>
<span class="b3-list-item__meta b3-list-item__meta--ellipsis ariaLabel" aria-label="${escapeAriaLabel(f.path)}">${f.name}</span>
</div>`});const g=e.querySelector("#searchAssetPreview");l.data.assetContents.length>0?(g.classList.remove("fn__none"),(r=e.querySelector(".search__drag"))==null||r.classList.remove("fn__none"),wo(g,l.data.assetContents[0].id,s.value,t.method)):(g.classList.add("fn__none"),(c=e.querySelector(".search__drag"))==null||c.classList.add("fn__none")),e.querySelector("#searchAssetResult").innerHTML=`<span class="fn__flex-center">${a}/${l.data.pageCount||1}</span><span class="fn__space"></span>
<span class="ft__on-surface">${window.siyuan.languages.total} ${l.data.matchedAssetCount}</span>`,e.querySelector("#searchAssetList").innerHTML=u||`<div class="search__empty">
    ${window.siyuan.languages.emptyContent}
</div>`})},Constants.TIMEOUT_INPUT)},wo=(e,t,a,n)=>{fetchPost("/api/search/getAssetContent",{id:t,query:a,queryMethod:n},o=>{e.innerHTML=`<p style="white-space: pre-wrap;">${o.data.assetContent.content}</p>`;const i=e.querySelector("mark");if(i){i.classList.add("mark--hl");const s=e.getBoundingClientRect();e.scrollTop=e.scrollTop+i.getBoundingClientRect().top-s.top-s.height/2}})},pd=e=>{let t;const a=Array.from(e.querySelectorAll("mark"));if(a.find((n,o)=>{if(n.classList.contains("mark--hl")){n.classList.remove("mark--hl"),t=a[o+1];return}}),t||(t=a[0]),t){t.classList.add("mark--hl");const n=e.getBoundingClientRect();e.scrollTop=e.scrollTop+t.getBoundingClientRect().top-n.top-n.height/2}},md=(e,t)=>{const a=window.siyuan.storage[Constants.LOCAL_SEARCHASSET].method;if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="searchAssetMethod"){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name","searchAssetMethod"),window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",label:window.siyuan.languages.keyword,current:a===0,click(){window.siyuan.storage[Constants.LOCAL_SEARCHASSET].method=0,t()}}).element),window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",label:window.siyuan.languages.querySyntax,current:a===1,click(){window.siyuan.storage[Constants.LOCAL_SEARCHASSET].method=1,t()}}).element),window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",label:window.siyuan.languages.regex,current:a===3,click(){window.siyuan.storage[Constants.LOCAL_SEARCHASSET].method=3,t()}}).element),window.siyuan.menus.menu.fullscreen()},_o=e=>{let t="";return Constants.SIYUAN_ASSETS_SEARCH.sort((a,n)=>a.localeCompare(n)).forEach(a=>{t+=`<label class="fn__flex b3-label">
        <div class="fn__flex-1 fn__flex-center">
            ${a}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="${a}" type="checkbox" ${e[a]?" checked":""}>
    </label>`}),t},bd=e=>{const t=window.siyuan.storage[Constants.LOCAL_SEARCHASSET].types,a=new Dialog({title:window.siyuan.languages.type,content:`<div class="b3-dialog__content">${_o(t)}</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:"520px",height:"70vh"});a.element.setAttribute("data-key",Constants.DIALOG_SEARCHASSETSTYPE);const n=a.element.querySelectorAll(".b3-button");n[0].addEventListener("click",()=>{a.destroy()}),n[1].addEventListener("click",()=>{a.element.querySelectorAll(".b3-switch").forEach(o=>{t[o.getAttribute("data-type")]=o.checked}),as(e),setStorageVal(Constants.LOCAL_SEARCHASSET,window.siyuan.storage[Constants.LOCAL_SEARCHASSET]),a.destroy()})},yd=(e,t,a)=>{if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="searchAssetMore"){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name","searchAssetMore");const n=window.siyuan.storage[Constants.LOCAL_SEARCHASSET],o=[{iconHTML:"",label:window.siyuan.languages.sortByRankAsc,current:n.sort===1,click(){n.sort=1,a()}},{iconHTML:"",label:window.siyuan.languages.sortByRankDesc,current:n.sort===0,click(){n.sort=0,a()}},{iconHTML:"",label:window.siyuan.languages.modifiedASC,current:n.sort===3,click(){n.sort=3,a()}},{iconHTML:"",label:window.siyuan.languages.modifiedDESC,current:n.sort===2,click(){n.sort=2,a()}}];window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",label:window.siyuan.languages.sort,type:"submenu",submenu:o}).element),window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",label:window.siyuan.languages.rebuildIndex,click(){if(!isPaidUser()){showMessage(window.siyuan.languages._kernel[214]);return}t.parentElement.querySelector(".fn__loading--top").classList.remove("fn__none"),fetchPost("/api/asset/fullReindexAssetContent",{},()=>{as(t,n)})}}).element),window.siyuan.menus.menu.fullscreen()},hd=e=>{const t=window.siyuan.storage[Constants.LOCAL_SEARCHKEYS];if(!t.replaceKeys||t.replaceKeys.length===0||t.length===1&&t[0]===e.value)return;const a=new Menu("search-replace-history");if(a.isOpen)return;a.element.classList.add("b3-menu--list"),a.addItem({iconHTML:"",label:window.siyuan.languages.clearHistory,click(){window.siyuan.storage[Constants.LOCAL_SEARCHKEYS].replaceKeys=[],setStorageVal(Constants.LOCAL_SEARCHKEYS,window.siyuan.storage[Constants.LOCAL_SEARCHKEYS])}});const n=a.addSeparator(1);let o=!0;t.replaceKeys.forEach(s=>{if(s!==e.value&&s){const l=a.addItem({iconHTML:"",label:escapeHtml(s),action:"iconCloseRound",bind(r){r.addEventListener("click",c=>{var d;hasClosestByClassName(c.target,"b3-menu__action")?(t.replaceKeys.find((u,g)=>{if(u===s)return t.replaceKeys.splice(g,1),!0}),window.siyuan.storage[Constants.LOCAL_SEARCHKEYS].replaceKeys=t.replaceKeys,setStorageVal(Constants.LOCAL_SEARCHKEYS,window.siyuan.storage[Constants.LOCAL_SEARCHKEYS]),(d=r.previousElementSibling)!=null&&d.classList.contains("b3-menu__separator")&&!r.nextElementSibling?window.siyuan.menus.menu.remove():r.remove()):(e.value=r.textContent,window.siyuan.menus.menu.remove()),c.preventDefault(),c.stopPropagation()})}});o&&l.classList.add("b3-menu__item--current"),o=!1}}),o&&n.remove();const i=e.previousElementSibling.getBoundingClientRect();a.open({x:i.left,y:i.bottom})},wd=(e,t,a)=>{const n=e.querySelector("#searchInput, #toolbarSearch"),o=window.siyuan.storage[Constants.LOCAL_SEARCHKEYS];if(!o.keys||o.keys.length===0||o.length===1&&o[0]===n.value)return;const i=new Menu("search-history");if(i.isOpen)return;i.element.classList.add("b3-menu--list"),i.addItem({iconHTML:"",label:window.siyuan.languages.clearHistory,click(){window.siyuan.storage[Constants.LOCAL_SEARCHKEYS].keys=[],setStorageVal(Constants.LOCAL_SEARCHKEYS,window.siyuan.storage[Constants.LOCAL_SEARCHKEYS])}});const s=i.addSeparator(1);let l=!0;o.keys.forEach(c=>{if(c!==n.value&&c){const d=i.addItem({iconHTML:"",label:escapeHtml(c),action:"iconCloseRound",bind(u){u.addEventListener("click",g=>{var f;hasClosestByClassName(g.target,"b3-menu__action")?(o.keys.find((p,m)=>{if(p===c)return o.keys.splice(m,1),!0}),window.siyuan.storage[Constants.LOCAL_SEARCHKEYS].keys=o.keys,setStorageVal(Constants.LOCAL_SEARCHKEYS,window.siyuan.storage[Constants.LOCAL_SEARCHKEYS]),(f=u.previousElementSibling)!=null&&f.classList.contains("b3-menu__separator")&&!u.nextElementSibling?window.siyuan.menus.menu.remove():u.remove()):(n.value=u.textContent,t.page=1,updateSearchResult(t,e,!0),window.siyuan.menus.menu.remove()),g.preventDefault(),g.stopPropagation()})}});l&&d.classList.add("b3-menu__item--current"),l=!1}}),l&&s.remove();const r=n.previousElementSibling.getBoundingClientRect();i.open({x:r.left,y:r.bottom})},_d=e=>{const t=e.querySelector("#searchAssetInput"),a=window.siyuan.storage[Constants.LOCAL_SEARCHASSET].keys;if(!a||a.length===0||a.length===1&&a[0]===t.value)return;const n=new Menu("search-asset-history");if(n.isOpen)return;n.element.classList.add("b3-menu--list"),n.addItem({iconHTML:"",label:window.siyuan.languages.clearHistory,click(){window.siyuan.storage[Constants.LOCAL_SEARCHASSET].keys=[],setStorageVal(Constants.LOCAL_SEARCHASSET,window.siyuan.storage[Constants.LOCAL_SEARCHASSET])}});const o=n.addSeparator(1);let i=!0;a.forEach(l=>{if(l!==t.value&&l){const r=n.addItem({iconHTML:"",label:escapeHtml(l),action:"iconCloseRound",bind(c){c.addEventListener("click",d=>{var u;hasClosestByClassName(d.target,"b3-menu__action")?(a.find((g,f)=>{if(g===l)return a.splice(f,1),!0}),window.siyuan.storage[Constants.LOCAL_SEARCHASSET].keys=a,setStorageVal(Constants.LOCAL_SEARCHASSET,window.siyuan.storage[Constants.LOCAL_SEARCHASSET]),(u=c.previousElementSibling)!=null&&u.classList.contains("b3-menu__separator")&&!c.nextElementSibling?window.siyuan.menus.menu.remove():c.remove()):(t.value=c.textContent,assetInputEvent(e),window.siyuan.menus.menu.remove()),d.preventDefault(),d.stopPropagation()})}});i&&r.classList.add("b3-menu__item--current"),i=!1}}),i&&o.remove();const s=t.previousElementSibling.getBoundingClientRect();n.open({x:s.left,y:s.bottom})},vd=(e,t)=>{let a=window.siyuan.storage[Constants.LOCAL_SEARCHKEYS][e];a.splice(0,0,t),a=Array.from(new Set(a)),a.length>window.siyuan.config.search.limit&&a.splice(window.siyuan.config.search.limit,a.length-window.siyuan.config.search.limit),window.siyuan.storage[Constants.LOCAL_SEARCHKEYS][e]=a,setStorageVal(Constants.LOCAL_SEARCHKEYS,window.siyuan.storage[Constants.LOCAL_SEARCHKEYS])},Ed=e=>{if(!e.value)return;let t=window.siyuan.storage[Constants.LOCAL_SEARCHASSET].keys;t.splice(0,0,e.value),t=Array.from(new Set(t)),t.length>window.siyuan.config.search.limit&&t.splice(window.siyuan.config.search.limit,t.length-window.siyuan.config.search.limit),window.siyuan.storage[Constants.LOCAL_SEARCHASSET].k=e.value,window.siyuan.storage[Constants.LOCAL_SEARCHASSET].keys=t,setStorageVal(Constants.LOCAL_SEARCHASSET,window.siyuan.storage[Constants.LOCAL_SEARCHASSET])},ns=(e,t,a)=>{if(t.method===1||t.method===2){showMessage(window.siyuan.languages._kernel[132]);return}const n=e.querySelector("#searchList"),o=e.querySelector("#toolbarReplace"),i=o.parentElement.querySelector(".fn__rotate");if(!i.classList.contains("fn__none"))return;saveKeyList("replaceKeys",o.value);let s=n.querySelector(".b3-list-item--focus");if(!s)return;i.classList.remove("fn__none"),i.nextElementSibling.classList.add("fn__none");let l=[];a?n.querySelectorAll('.b3-list-item[data-type="search-item"]').forEach(r=>{l.push(r.getAttribute("data-node-id"))}):l=[s.getAttribute("data-node-id")],fetchPost("/api/search/findReplace",{k:t.method===0?getKeyByLiElement(s):document.querySelector("#toolbarSearch").value,r:o.value,ids:l,types:t.types,method:t.method,replaceTypes:t.replaceTypes},r=>{var c;if(i.classList.add("fn__none"),i.nextElementSibling.classList.remove("fn__none"),r.code===1){showMessage(r.msg);return}if(!(l.length>1)){if(reloadProtyle(window.siyuan.mobile.editor.protyle,!1),s.nextElementSibling?s.nextElementSibling.classList.add("b3-list-item--focus"):s.previousElementSibling&&s.previousElementSibling.classList.add("b3-list-item--focus"),t.group===1)if(s.nextElementSibling||s.previousElementSibling)s.remove();else{const d=s.parentElement.nextElementSibling||((c=s.parentElement.previousElementSibling.previousElementSibling)==null?void 0:c.previousElementSibling);d&&(d.nextElementSibling.firstElementChild.classList.add("b3-list-item--focus"),d.nextElementSibling.classList.remove("fn__none"),d.firstElementChild.firstElementChild.classList.add("b3-list-item__arrow--open")),s.parentElement.previousElementSibling.remove(),s.parentElement.remove()}else s.remove();if(s=n.querySelector(".b3-list-item--focus"),!s){n.innerHTML=`<div class="b3-list--empty">${window.siyuan.languages.emptyContent}</div>`;return}(n.scrollTop<s.offsetTop-n.clientHeight+30||n.scrollTop>s.offsetTop)&&(n.scrollTop=s.offsetTop-n.clientHeight+30)}})},an=(e,t,a)=>{a.hasReplace!==t.hasReplace&&(t.hasReplace?(e.querySelector('[data-type="toggle-replace"]').classList.add("toolbar__icon--active"),e.querySelector(".toolbar").classList.remove("fn__none")):(e.querySelector('[data-type="toggle-replace"]').classList.remove("toolbar__icon--active"),e.querySelector(".toolbar").classList.add("fn__none")));const n=e.querySelector("#searchPath");t.hPath?(n.classList.remove("fn__none"),n.innerHTML=`<div class="b3-chip b3-chip--middle">${escapeHtml(t.hPath)}<svg data-type="remove-path" class="b3-chip__close"><use xlink:href="#iconCloseRound"></use></svg></div>`):n.classList.add("fn__none"),a.group!==t.group&&(t.group===0?(e.querySelector('[data-type="expand"]').classList.add("fn__none"),e.querySelector('[data-type="contract"]').classList.add("fn__none")):(e.querySelector('[data-type="expand"]').classList.remove("fn__none"),e.querySelector('[data-type="contract"]').classList.remove("fn__none")));let o=!0,i=!1;t.idPath.forEach(l=>{l.endsWith(".sy")&&(o=!1),l.split("/").length>1&&(i=!0)});const s=e.querySelector('[data-type="include"]');o?s.classList.add("toolbar__icon--active"):s.classList.remove("toolbar__icon--active"),i?s.removeAttribute("disabled"):s.setAttribute("disabled","disabled"),document.querySelector("#toolbarSearch").value=t.k,e.querySelector("#toolbarReplace").value=t.r,Object.assign(a,t),window.siyuan.storage[Constants.LOCAL_SEARCHDATA]=Object.assign({},a),setStorageVal(Constants.LOCAL_SEARCHDATA,window.siyuan.storage[Constants.LOCAL_SEARCHDATA]),Ne(a,e),window.siyuan.menus.menu.remove()},ss=(e,t,a)=>{const n=document.querySelector("#searchList");let o="";e.forEach((s,l)=>{const r=getNotebookName(s.box)+getDisplayName(s.hPath,!1);s.children?(o+=`<div class="b3-list-item">
<span class="b3-list-item__toggle b3-list-item__toggle--hl">
    <svg class="b3-list-item__arrow b3-list-item__arrow--open"><use xlink:href="#iconRight"></use></svg>
</span>
${unicode2Emoji(getNotebookIcon(s.box)||window.siyuan.storage[Constants.LOCAL_IMAGES].note,"b3-list-item__graphic",!0)}
<span class="b3-list-item__text" style="color: var(--b3-theme-on-surface)">${escapeGreat(r)}</span>
</div><div>`,s.children.forEach((c,d)=>{o+=`<div style="padding-left: 36px" data-type="search-item" class="b3-list-item${d===0&&l===0?" b3-list-item--focus":""}" data-node-id="${c.id}">
<svg class="b3-list-item__graphic"><use xlink:href="#${getIconByType(c.type)}"></use></svg>
${unicode2Emoji(c.ial.icon,"b3-list-item__graphic",!0)}
<span class="b3-list-item__text">${c.content}</span>
</div>`}),o+="</div>"):o+=`<div class="b3-list-item b3-list-item--two${l===0?" b3-list-item--focus":""}" data-type="search-item" data-node-id="${s.id}">
<div class="b3-list-item__first">
    <svg class="b3-list-item__graphic"><use xlink:href="#${getIconByType(s.type)}"></use></svg>
    ${unicode2Emoji(s.ial.icon,"b3-list-item__graphic",!0)}
    <span class="b3-list-item__text">${s.content}</span>
</div>
<span class="b3-list-item__text b3-list-item__meta">${escapeGreat(r)}</span>
</div>`}),n.innerHTML=o||`<div class="b3-list-item b3-list-item--focus" data-type="search-new">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg>
    <span class="b3-list-item__text">
        ${window.siyuan.languages.newFile} <mark>${document.querySelector("#toolbarSearch").value}</mark>
    </span>
</div>`,n.scrollTop=0;let i="";if(a){let s=window.siyuan.languages.findInDoc.replace("${x}",a.data.matchedRootCount).replace("${y}",a.data.matchedBlockCount);a.data.docMode&&(s=window.siyuan.languages.matchDoc.replace("${x}",a.data.matchedRootCount)),i=`<span class="fn__flex-center">${s}</span>
<span class="fn__flex-1"></span>
<span class="fn__flex-center">${t.page}/${a.data.pageCount||1}</span>`}n.previousElementSibling.querySelector('[data-type="result"]').innerHTML=i};let is=0;const Ne=(e,t,a=!1)=>{clearTimeout(is),is=window.setTimeout(()=>{var n;a&&((n=t.querySelector("#criteria .b3-chip--current"))==null||n.classList.remove("b3-chip--current"));const o=t.querySelector(".fn__loading--top");o.classList.remove("fn__none");const i=t.querySelector('[data-type="previous"]'),s=t.querySelector('[data-type="next"]'),l=document.getElementById("toolbarSearch");l.value===""&&(!e.idPath||e.idPath.length===0)?fetchPost("/api/block/getRecentUpdatedBlocks",{},r=>{ss(r.data,e),o.classList.add("fn__none"),i.setAttribute("disabled","true"),s.setAttribute("disabled","true")}):(e.page||(e.page=1),e.page>1?i.removeAttribute("disabled"):i.setAttribute("disabled","disabled"),fetchPost("/api/search/fullTextSearchBlock",{query:l.value,method:e.method,types:e.types,paths:e.idPath||[],groupBy:e.group,orderBy:e.sort,page:e.page},r=>{ss(r.data.blocks,e,r),o.classList.add("fn__none"),e.page<r.data.pageCount?s.removeAttribute("disabled"):s.setAttribute("disabled","disabled")}))},Constants.TIMEOUT_INPUT)},vo=(e,t,a)=>{const n=document.getElementById("toolbarSearch");n.value=a.k||"",n.addEventListener("compositionend",d=>{d&&d.isComposing||(a.page=1,Ne(a,t,!0))}),n.addEventListener("input",d=>{d&&d.isComposing||(a.page=1,Ne(a,t,!0))}),n.addEventListener("blur",()=>{a.removed&&(a.k=n.value,window.siyuan.storage[Constants.LOCAL_SEARCHDATA]=Object.assign({},a),setStorageVal(Constants.LOCAL_SEARCHDATA,window.siyuan.storage[Constants.LOCAL_SEARCHDATA])),saveKeyList("keys",n.value)}),addClearButton({inputElement:n,className:"toolbar__icon",clearCB(){a.page=1,Ne(a,t)}});const o=t.querySelector(".toolbar .toolbar__title");o.value=a.r||"",addClearButton({inputElement:o,className:"toolbar__icon"});const i=[];initCriteriaMenu(t.querySelector("#criteria"),i,a);const s=document.querySelector("#searchAssetsPanel"),l=document.querySelector("#searchUnRefPanel"),r=t.querySelector("#searchList"),c=window.siyuan.storage[Constants.LOCAL_SEARCHASSET];t.addEventListener("click",d=>{var u,g;let f=d.target;for(;f&&!f.isSameNode(t);){const p=f.getAttribute("data-type");if(p==="replaceHistory"){toggleReplaceHistory(f.nextElementSibling),d.stopPropagation(),d.preventDefault();break}else if(p==="assetHistory"){toggleAssetHistory(s),d.stopPropagation(),d.preventDefault();break}else if(p==="previous"){f.getAttribute("disabled")||(a.page--,Ne(a,t)),d.stopPropagation(),d.preventDefault();break}else if(p==="next"){f.getAttribute("disabled")||(a.page++,Ne(a,t)),d.stopPropagation(),d.preventDefault();break}else if(p==="set-criteria"){a.removed=!1,(u=f.parentElement.querySelector(".b3-chip--current"))==null||u.classList.remove("b3-chip--current"),f.classList.add("b3-chip--current"),i.find(m=>{if(m.name===f.innerText.trim())return an(t,m,a),!0}),d.stopPropagation(),d.preventDefault();break}else if(p==="remove-criteria"){const m=f.parentElement.innerText.trim();fetchPost("/api/storage/removeCriterion",{name:m}),i.find((b,w)=>{if(b.name===m)return i.splice(w,1),!0}),f.parentElement.classList.contains("b3-chip--current")&&an(t,{removed:!0,sort:0,group:0,hasReplace:!1,method:0,hPath:"",idPath:[],k:"",r:"",page:1,types:getDefaultType(),replaceTypes:Object.assign({},Constants.SIYUAN_DEFAULT_REPLACETYPES)},a),f.parentElement.parentElement.childElementCount===1&&f.parentElement.parentElement.classList.add("fn__none"),f.parentElement.remove(),d.stopPropagation(),d.preventDefault();break}else if(p==="remove-path"){a.idPath=[],a.hPath="",t.querySelector("#searchPath").classList.add("fn__none"),a.page=1,Ne(a,t,!0);const m=t.querySelector('[data-type="include"]');m.classList.remove("toolbar__icon--active"),m.setAttribute("disabled","disabled"),d.stopPropagation(),d.preventDefault();break}else if(p==="expand"){Array.from(r.children).forEach(m=>{m.classList.contains("b3-list-item")&&(m.querySelector(".b3-list-item__arrow").classList.add("b3-list-item__arrow--open"),m.nextElementSibling.classList.remove("fn__none"))}),d.stopPropagation(),d.preventDefault();break}else if(p==="contract"){Array.from(r.children).forEach(m=>{m.classList.contains("b3-list-item")&&(m.querySelector(".b3-list-item__arrow").classList.remove("b3-list-item__arrow--open"),m.nextElementSibling.classList.add("fn__none"))}),d.stopPropagation(),d.preventDefault();break}else if(p==="currentPath"&&!f.hasAttribute("disabled")){const m=getCurrentEditor().protyle;fetchPost("/api/filetree/getHPathsByPaths",{paths:[m.path]},b=>{a.idPath=[pathPosix().join(m.notebookId,m.path)],a.hPath=b.data[0];const w=t.querySelector("#searchPath");w.classList.remove("fn__none"),w.innerHTML=`<div class="b3-chip b3-chip--middle">${escapeHtml(a.hPath)}<svg data-type="remove-path" class="b3-chip__close"><use xlink:href="#iconCloseRound"></use></svg></div>`;const y=t.querySelector('[data-type="include"]');y.classList.remove("toolbar__icon--active"),y.removeAttribute("disabled"),a.page=1,Ne(a,t,!0)}),d.stopPropagation(),d.preventDefault();break}else if(p==="path"){movePathTo((m,b)=>{fetchPost("/api/filetree/getHPathsByPaths",{paths:m},w=>{a.idPath=[];const y=[];let _=!1;m.forEach((C,k)=>{C==="/"?(a.idPath.push(b[k]),y.push(getNotebookName(b[k]))):(_=!0,a.idPath.push(pathPosix().join(b[k],C.replace(".sy",""))))}),w.data&&y.push(...w.data),a.hPath=y.join(" ");const h=t.querySelector("#searchPath");h.classList.remove("fn__none"),h.innerHTML=`<div class="b3-chip b3-chip--middle">${escapeHtml(a.hPath)}<svg data-type="remove-path" class="b3-chip__close"><use xlink:href="#iconCloseRound"></use></svg></div>`;const E=t.querySelector('[data-type="include"]');E.classList.add("toolbar__icon--active"),_?E.removeAttribute("disabled"):E.setAttribute("disabled","disabled"),a.page=1,Ne(a,t,!0)})},[],void 0,window.siyuan.languages.specifyPath),d.stopPropagation(),d.preventDefault();break}else if(p==="include"&&!f.hasAttribute("disabled")){f.classList.toggle("toolbar__icon--active"),f.classList.contains("toolbar__icon--active")?a.idPath.forEach((m,b)=>{m.endsWith(".sy")&&(a.idPath[b]=m.replace(".sy",""))}):a.idPath.forEach((m,b)=>{!m.endsWith(".sy")&&m.split("/").length>1&&(a.idPath[b]=m+".sy")}),a.page=1,Ne(a,t,!0),d.stopPropagation(),d.preventDefault();break}else if(p==="toggle-replace"){a.hasReplace=!a.hasReplace,o.parentElement.classList.toggle("fn__none"),f.classList.toggle("toolbar__icon--active"),d.stopPropagation(),d.preventDefault();break}else if(p==="more"){moreMenu(a,i,t,()=>{a.page=1,Ne(a,t,!0)},()=>{an(t,{removed:!0,sort:0,group:0,hasReplace:!1,method:0,hPath:"",idPath:[],k:"",r:"",page:1,types:getDefaultType(),replaceTypes:Object.assign({},Constants.SIYUAN_DEFAULT_REPLACETYPES)},a)}),window.siyuan.menus.menu.fullscreen(),d.stopPropagation(),d.preventDefault();break}else if(p==="replace-all"){ns(t,a,!0),d.stopPropagation(),d.preventDefault();break}else if(p==="refreshUnRef"){ca(l),d.stopPropagation(),d.preventDefault();break}else if(p==="unRefPrevious"){if(!f.getAttribute("disabled")){let m=parseInt(l.querySelector("#searchUnRefResult").lastElementChild.textContent);m>1&&(m--,ca(l,m))}d.stopPropagation(),d.preventDefault();break}else if(p==="unRefNext"){const m=l.querySelector("#searchUnRefResult").lastElementChild;let b=parseInt(m.textContent);b<parseInt(m.textContent.split("/")[1])&&(b++,ca(l,b)),d.stopPropagation(),d.preventDefault();break}else if(p==="queryAsset"){assetMethodMenu(f,()=>{assetInputEvent(s,c),setStorageVal(Constants.LOCAL_SEARCHASSET,c)}),d.stopPropagation(),d.preventDefault();break}else if(p==="filterAsset"){assetFilterMenu(s),d.stopPropagation(),d.preventDefault();break}else if(p==="moreAsset"){assetMoreMenu(f,s,()=>{assetInputEvent(s),setStorageVal(Constants.LOCAL_SEARCHASSET,c)}),d.stopPropagation(),d.preventDefault();break}else if(p==="goAsset"){Eo(),d.stopPropagation(),d.preventDefault();break}else if(p==="goSearch"){s.classList.add("fn__none"),l.classList.add("fn__none"),d.stopPropagation(),d.preventDefault();break}else if(p==="assetPrevious"){f.getAttribute("disabled")||assetInputEvent(s,c,parseInt(s.querySelector("#searchAssetResult .fn__flex-center").textContent.split("/")[1])-1),d.stopPropagation(),d.preventDefault();break}else if(p==="assetNext"){f.getAttribute("disabled")||assetInputEvent(s,c,parseInt(s.querySelector("#searchAssetResult .fn__flex-center").textContent.split("/")[1])+1),d.stopPropagation(),d.preventDefault();break}else if(p==="replace"){ns(t,a,!1),d.stopPropagation(),d.preventDefault();break}else if(f.classList.contains("b3-list-item__toggle")){f.parentElement.nextElementSibling.classList.toggle("fn__none"),f.firstElementChild.classList.toggle("b3-list-item__arrow--open"),d.stopPropagation(),d.preventDefault();break}else if(f.classList.contains("b3-list-item")){if(f.getAttribute("data-type")==="search-new")newFileByName(e,n.value);else if(f.getAttribute("data-type")==="search-item"){const m=f.getAttribute("data-node-id");m?((g=window.siyuan.mobile.editor)!=null&&g.protyle&&preventScroll(window.siyuan.mobile.editor.protyle),checkFold(m,b=>{openMobileFileById(e,m,b?[Constants.CB_GET_ALL]:[Constants.CB_GET_HL,Constants.CB_GET_CONTEXT,Constants.CB_GET_ROOTSCROLL])}),closePanel()):f.classList.contains("b3-list-item--focus")?f.classList.contains("b3-list-item--focus")&&renderNextAssetMark(t.querySelector("#searchAssetPreview")):(t.querySelector("#searchAssetList .b3-list-item--focus").classList.remove("b3-list-item--focus"),f.classList.add("b3-list-item--focus"),renderPreview(t.querySelector("#searchAssetPreview"),f.dataset.id,t.querySelector("#searchAssetInput").value,window.siyuan.storage[Constants.LOCAL_SEARCHASSET].method))}else f.querySelector(".b3-list-item__toggle")&&(f.nextElementSibling.classList.toggle("fn__none"),f.firstElementChild.firstElementChild.classList.toggle("b3-list-item__arrow--open"));d.stopPropagation(),d.preventDefault();break}f=f.parentElement}},!1)},kd=(e,t)=>{var a;const n=JSON.parse(JSON.stringify(window.siyuan.storage[Constants.LOCAL_SEARCHDATA])),o=(((a=getCurrentEditor())==null?void 0:a.protyle.toolbar.range)||(getSelection().rangeCount>0?getSelection().getRangeAt(0):document.createRange())).toString();o&&(n.k=o),t&&Object.keys(t).forEach(l=>{n[l]=t[l]}),activeBlur(),hideKeyboardToolbar();let i=!0,s=!1;n.idPath.forEach(l=>{l.endsWith(".sy")&&(i=!1),l.split("/").length>1&&(s=!0)}),openModel({title:`<div class="fn__flex">
    <span data-menu="true" class="toolbar__icon toolbar__icon--history" data-type="history">
        <svg class="svg--mid"><use xlink:href="#iconSearch"></use></svg>
        <svg class="svg--smaller"><use xlink:href="#iconDown"></use></svg>
    </span>
    <input id="toolbarSearch" placeholder="${window.siyuan.languages.showRecentUpdatedBlocks}" class="toolbar__title fn__block">
    <svg id="toolbarSearchNew" class="toolbar__icon"><use xlink:href="#iconFile"></use></svg>
</div>`,html:`<div class="fn__flex-column" style="height: 100%">
    <div class="toolbar toolbar--border${n.hasReplace?"":" fn__none"}">
        <span data-menu="true" class="toolbar__icon toolbar__icon--history" data-type="replaceHistory">
            <svg class="svg--mid"><use xlink:href="#iconReplace"></use></svg>
            <svg class="svg--smaller"><use xlink:href="#iconDown"></use></svg>
        </span>
        <input id="toolbarReplace" class="toolbar__title">
        <svg class="fn__rotate fn__none toolbar__icon"><use xlink:href="#iconRefresh"></use></svg>
        <div class="fn__space"></div>
        <button data-type="replace-all" class="b3-button b3-button--outline fn__flex-center">${window.siyuan.languages.replaceAll}</button>
        <div class="fn__space"></div>
        <button data-type="replace" class="b3-button b3-button--outline fn__flex-center">${window.siyuan.languages.replace}</button>
        <div class="fn__space"></div>
    </div>
    <div id="criteria" style="background-color: var(--b3-theme-background);"></div>
    <div class="toolbar">
        <span class="fn__space"></span>
        <span data-type="result" class="fn__flex-1 fn__flex"></span>
        <span class="fn__space"></span>
        <svg data-type="previous" disabled="disabled" class="toolbar__icon"><use xlink:href="#iconLeft"></use></svg>
        <svg data-type="next" disabled="disabled" class="toolbar__icon"><use xlink:href="#iconRight"></use></svg>
    </div>
    <div id="searchList" style="overflow:auto;" class="fn__flex-1 b3-list b3-list--background"></div>
    <div id="searchPath" class="b3-chips${n.hPath?"":" fn__none"}" style="background-color: var(--b3-theme-background);">
        <div class="b3-chip b3-chip--middle">
            ${escapeHtml(n.hPath)}
            <svg data-type="remove-path" class="b3-chip__close"><use xlink:href="#iconCloseRound"></use></svg>
        </div>
    </div>
    <div class="toolbar">
        <span class="fn__flex-1"></span>
        <svg data-type="toggle-replace" class="toolbar__icon${n.hasReplace?" toolbar__icon--active":""}"><use xlink:href="#iconReplace"></use></svg>
        <svg ${s?"":"disabled"} data-type="include" class="toolbar__icon${i?" toolbar__icon--active":""}"><use xlink:href="#iconCopy"></use></svg>
        <svg data-type="path" class="toolbar__icon"><use xlink:href="#iconFolder"></use></svg>
        <svg ${document.querySelector("#empty").classList.contains("fn__none")?"":"disabled"} data-type="currentPath" class="toolbar__icon"><use xlink:href="#iconFocus"></use></svg>
        <svg data-type="expand" class="toolbar__icon${n.group===0?" fn__none":""}"><use xlink:href="#iconExpand"></use></svg>
        <svg data-type="contract" class="toolbar__icon${n.group===0?" fn__none":""}"><use xlink:href="#iconContract"></use></svg>
        <svg data-type="more" class="toolbar__icon"><use xlink:href="#iconMore"></use></svg>
        <svg data-type="goAsset" class="toolbar__icon"><use xlink:href="#iconExact"></use></svg>
        <span class="fn__flex-1"></span>
     </div>
     <div class="fn__none fn__flex-column" style="position: fixed;top: 0;width: 100%;background: var(--b3-theme-surface);height: 100%;" id="searchAssetsPanel">
        <div class="toolbar toolbar--border">
           <span data-menu="true" class="toolbar__icon toolbar__icon--history" data-type="assetHistory">
                <svg class="svg--mid"><use xlink:href="#iconSearch"></use></svg>
                <svg class="svg--smaller"><use xlink:href="#iconDown"></use></svg>
            </span>
            <input id="searchAssetInput" placeholder="${window.siyuan.languages.keyword}" class="toolbar__title fn__block">
        </div>
        <div class="toolbar">
            <span class="fn__space"></span>
            <span id="searchAssetResult" class="fn__flex-1 fn__flex"><span class="fn__flex-1"></span></span>
            <span class="fn__space"></span>
            <svg data-type="assetPrevious" disabled="disabled" class="toolbar__icon"><use xlink:href="#iconLeft"></use></svg>
            <svg data-type="assetNext" disabled="disabled" class="toolbar__icon"><use xlink:href="#iconRight"></use></svg>
        </div>
        <div id="searchAssetList" style="overflow:auto;" class="fn__flex-1 b3-list b3-list--background"></div>
        <div id="searchAssetPreview" class="fn__flex-1 search__preview b3-typography" style="padding: 8px;border-bottom: 1px solid var(--b3-border-color);"></div>
        <div class="toolbar">
            <span class="fn__flex-1"></span>
            <svg data-type="queryAsset" class="toolbar__icon"><use xlink:href="#iconRegex"></use></svg>
            <svg data-type="filterAsset" class="toolbar__icon"><use xlink:href="#iconFilter"></use></svg>
            <svg data-type="moreAsset" class="toolbar__icon"><use xlink:href="#iconMore"></use></svg>
            <svg data-type="goSearch" class="toolbar__icon"><use xlink:href="#iconBack"></use></svg>
            <span class="fn__flex-1"></span>
         </div>
    </div>
     <div class="fn__none fn__flex-column" style="position: fixed;top: 0;width: 100%;background: var(--b3-theme-surface);height: 100%;" id="searchUnRefPanel">
        <div class="toolbar">
            <span class="fn__space"></span>
            <span id="searchUnRefResult" class="fn__flex-1 fn__flex"></span>
            <span class="fn__space"></span>
            <svg data-type="unRefPrevious" disabled="disabled" class="toolbar__icon"><use xlink:href="#iconLeft"></use></svg>
            <svg data-type="unRefNext" disabled="disabled" class="toolbar__icon"><use xlink:href="#iconRight"></use></svg>
        </div>
        <div id="searchUnRefList" style="overflow:auto;" class="fn__flex-1 b3-list b3-list--background"></div>
        <div class="toolbar">
            <span class="fn__flex-1"></span>
            <svg data-type="refreshUnRef" class="toolbar__icon"><use xlink:href="#iconRefresh"></use></svg>
            <svg data-type="goSearch" class="toolbar__icon"><use xlink:href="#iconBack"></use></svg>
            <span class="fn__flex-1"></span>
         </div>
    </div>
     <div class="fn__loading fn__loading--top"><img width="120px" src="/stage/loading-pure.svg"></div>
</div>`,bindEvent(l){document.querySelector("#toolbarSearchNew").addEventListener("click",()=>{newFileByName(e,document.querySelector("#toolbarSearch").value)}),document.querySelector('.toolbar [data-type="history"]').addEventListener("click",()=>{toggleSearchHistory(document.querySelector("#model"),n,void 0)}),vo(e,l.firstElementChild,n),Ne(n,l)}})},Eo=()=>{const e=document.querySelector("#searchAssetsPanel");if(e.classList.remove("fn__none"),e.querySelector("#searchAssetList").innerHTML)return;const a=window.siyuan.storage[Constants.LOCAL_SEARCHASSET],n=e.querySelector("input");n.value=a.k,n.addEventListener("compositionend",o=>{o.isComposing||assetInputEvent(e,a)}),n.addEventListener("input",o=>{o.isComposing||assetInputEvent(e,a)}),n.addEventListener("blur",()=>{saveAssetKeyList(n)}),assetInputEvent(e,a),addClearButton({inputElement:n,className:"toolbar__icon",clearCB(){assetInputEvent(e,a)}})},Cd=()=>{window.siyuan.menus.menu.remove();const e=document.querySelector("#searchUnRefPanel");e.classList.remove("fn__none"),!e.querySelector("#searchUnRefList").innerHTML&&ca(e)},ca=(e,t=1)=>{const a=e.querySelector('[data-type="unRefPrevious"]');t>1?a.removeAttribute("disabled"):a.setAttribute("disabled","disabled"),fetchPost("/api/search/listInvalidBlockRefs",{page:t},n=>{e.parentElement.querySelector(".fn__loading--top").classList.add("fn__none");const o=e.querySelector('[data-type="unRefNext"]');t<n.data.pageCount?o.removeAttribute("disabled"):o.setAttribute("disabled","disabled");let i="";n.data.blocks.forEach((s,l)=>{const r=getNotebookName(s.box)+getDisplayName(s.hPath,!1);i+=`<div class="b3-list-item b3-list-item--two${l===0?" b3-list-item--focus":""}" data-type="search-item" data-node-id="${s.id}">
<div class="b3-list-item__first">
    <svg class="b3-list-item__graphic"><use xlink:href="#${getIconByType(s.type)}"></use></svg>
    ${unicode2Emoji(s.ial.icon,"b3-list-item__graphic",!0)}
    <span class="b3-list-item__text">${s.content}</span>
</div>
<span class="b3-list-item__text b3-list-item__meta">${escapeGreat(r)}</span>
</div>`}),e.querySelector("#searchUnRefResult").innerHTML=`<span class="fn__flex-center">${window.siyuan.languages.findInDoc.replace("${x}",n.data.matchedRootCount).replace("${y}",n.data.matchedBlockCount)}</span>
<span class="fn__flex-1"></span>
<span class="fn__flex-center">${t}/${n.data.pageCount||1}</span>`,e.querySelector("#searchUnRefList").innerHTML=i||`<div class="search__empty">
    ${window.siyuan.languages.emptyContent}
</div>`})},Ad=(e,t,a)=>{const n=isMobile(),o=hasClosestByClassName(e.target,"protyle-attr--bookmark");if(o)return!n&&isOnlyMeta(e)||(a?openFileAttr(a,"bookmark",t):openAttr(o.parentElement.parentElement,"bookmark",t)),e.stopPropagation(),!0;const i=hasClosestByClassName(e.target,"protyle-attr--name");if(i)return!n&&isOnlyMeta(e)||(a?openFileAttr(a,"name",t):openAttr(i.parentElement.parentElement,"name",t)),e.stopPropagation(),!0;const s=hasClosestByClassName(e.target,"protyle-attr--av");if(s)return a?openFileAttr(a,"av",t):openAttr(s.parentElement.parentElement,"av",t),e.stopPropagation(),!0;const l=hasClosestByClassName(e.target,"protyle-attr--alias");if(l)return!n&&isOnlyMeta(e)||(a?openFileAttr(a,"alias",t):openAttr(l.parentElement.parentElement,"alias",t)),e.stopPropagation(),!0;const r=hasClosestByClassName(e.target,"protyle-attr--memo");if(r)return!n&&isOnlyMeta(e)||(a?openFileAttr(a,"memo",t):openAttr(r.parentElement.parentElement,"memo",t)),e.stopPropagation(),!0},Ld=e=>{if(e.protyle.disabled)return;const t=new Menu("av-view");if(t.isOpen)return;t.addItem({id:"rename",icon:"iconEdit",label:window.siyuan.languages.rename,click(){var n;(n=document.querySelector(".av__panel"))==null||n.remove(),openMenuPanel({protyle:e.protyle,blockElement:e.blockElement,type:"config",cb:o=>{o.querySelector('.b3-text-field[data-type="name"]').focus()}})}}),t.addItem({id:"config",icon:"iconSettings",label:window.siyuan.languages.config,click(){var n;(n=document.querySelector(".av__panel"))==null||n.remove(),openMenuPanel({protyle:e.protyle,blockElement:e.blockElement,type:"config"})}}),t.addSeparator(),t.addItem({id:"duplicate",icon:"iconCopy",label:window.siyuan.languages.duplicate,click(){var n;(n=document.querySelector(".av__panel"))==null||n.remove();const o=Lute.NewNodeID();transaction(e.protyle,[{action:"duplicateAttrViewView",avID:e.blockElement.dataset.avId,previousID:e.element.dataset.id,id:o,blockID:e.blockElement.dataset.nodeId}],[{action:"removeAttrViewView",avID:e.blockElement.dataset.avId,id:o,blockID:e.blockElement.dataset.nodeId}]),e.blockElement.setAttribute(Constants.CUSTOM_SY_AV_VIEW,o)}}),e.blockElement.querySelectorAll(".layout-tab-bar .item").length>1&&t.addItem({id:"delete",icon:"iconTrashcan",label:window.siyuan.languages.delete,click(){var n;(n=document.querySelector(".av__panel"))==null||n.remove(),transaction(e.protyle,[{action:"removeAttrViewView",avID:e.blockElement.dataset.avId,id:e.element.dataset.id,blockID:e.blockElement.dataset.nodeId}])}});const a=e.element.getBoundingClientRect();t.open({x:a.left,y:a.bottom})},Sd=e=>{const t=e.menuElement.querySelector('.b3-text-field[data-type="name"]');t.addEventListener("blur",()=>{t.value!==t.dataset.value&&(transaction(e.protyle,[{action:"setAttrViewViewName",avID:e.data.id,id:e.data.viewID,data:t.value}],[{action:"setAttrViewViewName",avID:e.data.id,id:e.data.viewID,data:t.dataset.value}]),t.dataset.value=t.value)}),t.addEventListener("keydown",o=>{o.isComposing||o.key==="Enter"&&(o.preventDefault(),t.blur(),e.menuElement.parentElement.remove())}),t.select(),t.value=t.dataset.value;const a=e.menuElement.querySelector('.b3-text-field[data-type="desc"]');t.nextElementSibling.addEventListener("click",()=>{const o=a.parentElement;o.classList.toggle("fn__none"),o.classList.contains("fn__none")||a.focus()}),a.addEventListener("blur",()=>{a.value!==a.dataset.value&&(transaction(e.protyle,[{action:"setAttrViewViewDesc",avID:e.data.id,id:e.data.viewID,data:a.value}],[{action:"setAttrViewViewDesc",avID:e.data.id,id:e.data.viewID,data:a.dataset.value}]),a.dataset.value=a.value)}),a.addEventListener("keydown",o=>{o.isComposing||o.key==="Enter"&&(o.preventDefault(),a.blur(),e.menuElement.parentElement.remove())}),a.addEventListener("input",()=>{t.nextElementSibling.setAttribute("aria-label",a.value?escapeHtml(a.value):window.siyuan.languages.addDesc)});const n=e.menuElement.querySelector('.b3-switch[data-type="toggle-view-title"]');n.addEventListener("change",()=>{const o=e.blockElement.getAttribute("data-av-id"),i=e.blockElement.getAttribute("data-node-id");n.checked?(transaction(e.protyle,[{action:"hideAttrViewName",avID:o,blockID:i,data:!1}],[{action:"hideAttrViewName",avID:o,blockID:i,data:!0}]),e.blockElement.querySelector(".av__title").classList.remove("fn__none")):(transaction(e.protyle,[{action:"hideAttrViewName",avID:o,blockID:i,data:!0}],[{action:"hideAttrViewName",avID:o,blockID:i,data:!1}]),e.blockElement.querySelector(".av__title").classList.add("fn__none"))})},xd=e=>{const t=e.view;return`<div class="b3-menu__items">
<button class="b3-menu__item" data-type="nobg">
    <span class="b3-menu__label ft__center">${window.siyuan.languages.config}</span>
</button>
<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="nobg">
    <div class="fn__block">
        <div class="fn__flex">
            <span class="b3-menu__avemoji" data-type="update-view-icon">${t.icon?unicode2Emoji(t.icon):'<svg style="height: 14px;width: 14px"><use xlink:href="#iconTable"></use></svg>'}</span>
            <div class="b3-form__icona fn__block">
                <input data-type="name" class="b3-text-field b3-form__icona-input" type="text" data-value="${escapeAttr(t.name)}">
                <svg data-position="north" class="b3-form__icona-icon ariaLabel" aria-label="${t.desc?escapeAriaLabel(t.desc):window.siyuan.languages.addDesc}"><use xlink:href="#iconInfo"></use></svg>
            </div>
        </div>
        <div class="fn__none">
            <div class="fn__hr"></div>
            <textarea style="margin-left: 22px;width: calc(100% - 22px);" placeholder="${window.siyuan.languages.addDesc}" rows="1" data-type="desc" class="b3-text-field fn__size200" type="text" data-value="${escapeAttr(t.desc)}">${t.desc}</textarea>
        </div>
    </div>
</button>
<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="go-properties">
    <svg class="b3-menu__icon"></svg>
    <span class="b3-menu__label">${window.siyuan.languages.fields}</span>
    <span class="b3-menu__accelerator">${t.columns.filter(a=>!a.hidden).length}/${t.columns.length}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<button class="b3-menu__item" data-type="goFilters">
    <svg class="b3-menu__icon"><use xlink:href="#iconFilter"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.filter}</span>
    <span class="b3-menu__accelerator">${t.filters.length}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<button class="b3-menu__item" data-type="goSorts">
    <svg class="b3-menu__icon"><use xlink:href="#iconSort"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.sort}</span>
    <span class="b3-menu__accelerator">${t.sorts.length}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<button class="b3-menu__item" data-type="set-page-size" data-size="${t.pageSize}">
    <svg class="b3-menu__icon"></svg>
    <span class="b3-menu__label">${window.siyuan.languages.entryNum}</span>
    <span class="b3-menu__accelerator">${t.pageSize===Constants.SIZE_DATABASE_MAZ_SIZE?window.siyuan.languages.all:t.pageSize}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<label class="b3-menu__item">
    <svg class="b3-menu__icon"></svg>
    <span class="fn__flex-center">${window.siyuan.languages.showTitle}</span>
    <span class="fn__space fn__flex-1"></span>
    <input data-type="toggle-view-title" type="checkbox" class="b3-switch b3-switch--menu" ${t.hideAttrViewName?"":"checked"}>
</label>
<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="duplicate-view">
    <svg class="b3-menu__icon">
        <use xlink:href="#iconCopy"></use>
    </svg>
    <span class="b3-menu__label">${window.siyuan.languages.duplicate}</span>
</button>
<button class="b3-menu__item${e.views.length>1?"":" fn__none"}" data-type="delete-view">
    <svg class="b3-menu__icon"><use xlink:href="#iconTrashcan"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.delete}</span>
</button>
</div>`},Td=e=>{const t=e.menuElement.querySelector(".b3-text-field");t.focus(),t.addEventListener("keydown",a=>{if(a.stopPropagation(),!a.isComposing)if(upDownHint(e.menuElement.querySelector(".fn__flex-1"),a,"b3-menu__item--current"),a.key==="Enter"){const n=e.menuElement.querySelector(".b3-menu__item--current");n&&(e.blockElement.removeAttribute("data-render"),avRender(e.blockElement,e.protyle,void 0,n.dataset.id),e.menuElement.remove(),focusBlock(e.blockElement))}else a.key==="Escape"&&(e.menuElement.remove(),focusBlock(e.blockElement))}),t.addEventListener("input",a=>{a.isComposing||os(e.menuElement)}),t.addEventListener("compositionend",()=>{os(e.menuElement)})},os=e=>{var t;const n=e.querySelector(".b3-text-field").value;e.querySelectorAll('.b3-menu__item[draggable="true"]').forEach(o=>{!n||n.toLowerCase().indexOf(o.textContent.trim().toLowerCase())>-1||o.textContent.trim().toLowerCase().indexOf(n.toLowerCase())>-1?o.classList.remove("fn__none"):(o.classList.add("fn__none"),o.classList.remove("b3-menu__item--current"))}),e.querySelector(".b3-menu__item--current")||(t=e.querySelector(".fn__flex-1 .b3-menu__item:not(.fn__none)"))==null||t.classList.add("b3-menu__item--current")},Id=(e,t)=>{let a="";return e.forEach(n=>{a+=`<button draggable="true" class="b3-menu__item${n.id===t?" b3-menu__item--current":""}" data-id="${n.id}">
    <svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>
    <div class="b3-menu__label fn__flex" data-type="av-view-switch">
        ${n.icon?unicode2Emoji(n.icon,"b3-menu__icon",!0):'<svg class="b3-menu__icon"><use xlink:href="#iconTable"></use></svg>'}
        <span class="fn__ellipsis">${n.name}</span>
    </div>
    <svg class="b3-menu__action" data-type="av-view-edit"><use xlink:href="#iconEdit"></use></svg>
</button>`}),`<div class="b3-menu__items fn__flex-column">
<button class="b3-menu__item" data-type="av-add">
    <svg class="b3-menu__icon"><use xlink:href="#iconAdd"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.newView}</span>
</button>
<button class="b3-menu__separator"></button>
<div class="b3-menu__item fn__flex-shrink" data-type="nobg">
    <input class="b3-text-field fn__block" type="text" style="margin: 4px 0" placeholder="${window.siyuan.languages.search}">
</div>
<div class="fn__flex-1" style="overflow: auto">
    ${a}
</div>
</div>`},Md=(e,t)=>{const a=Lute.NewNodeID(),n=t.getAttribute("data-av-id");transaction(e,[{action:"addAttrViewView",avID:n,id:a,blockID:t.getAttribute("data-node-id")}],[{action:"removeAttrViewView",avID:n,id:a,blockID:t.getAttribute("data-node-id")}]),t.setAttribute(Constants.CUSTOM_SY_AV_VIEW,a)},ko=e=>{!window.siyuan.menus.menu.element.contains(e)&&!hasClosestByAttribute(e,"data-menu","true")&&(getSelection().rangeCount>0&&window.siyuan.menus.menu.element.contains(getSelection().getRangeAt(0).startContainer)&&window.siyuan.menus.menu.element.contains(document.activeElement)||window.siyuan.menus.menu.remove())},Dd=e=>{cancelDrag(),ko(e.target),hasClosestByClassName(e.target,"pdf__outer")||hideAllElements(["pdfutil"]),!isWindow()&&window.siyuan.layout.leftDock&&!hasClosestByClassName(e.target,"b3-dialog--open",!0)&&!hasClosestByClassName(e.target,"b3-menu")&&!hasClosestByClassName(e.target,"block__popover")&&!hasClosestByClassName(e.target,"dock")&&!hasClosestByClassName(e.target,"layout--float",!0)&&(window.siyuan.layout.bottomDock.hideDock(),window.siyuan.layout.leftDock.hideDock(),window.siyuan.layout.rightDock.hideDock());const t=hasClosestByClassName(e.target,"protyle",!0);if(t){const o=t.querySelector(".protyle-wysiwyg");(o.getAttribute("data-readonly")==="true"||!o.contains(e.target))&&o.dispatchEvent(new Event("focusin"))}const a=hasTopClosestByClassName(e.target,"protyle-action__copy");if(a){let o=a.parentElement.nextElementSibling.textContent.replace(/\n$/,"");o=o.replace(/\u00A0/g," "),writeText(o),showMessage(window.siyuan.languages.copied,2e3),e.preventDefault();return}if(hasClosestByAttribute(e.target,"id","secondaryToolbarToggleButton")||hasClosestByAttribute(e.target,"id","viewFindButton")||hasClosestByAttribute(e.target,"id","findbar"))return;let n;getAllModels().asset.find(o=>{if(o.pdfObject&&!o.pdfObject.appConfig.appContainer.classList.contains("fn__none"))return n=o.pdfObject,!0}),n&&(n.secondaryToolbar.isOpen&&n.secondaryToolbar.close(),!n.supportsIntegratedFind&&n.findBar.opened&&n.findBar.close())};var Co=(e,t,a)=>new Promise((n,o)=>{var i=r=>{try{l(a.next(r))}catch(c){o(c)}},s=r=>{try{l(a.throw(r))}catch(c){o(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(i,s);l((a=a.apply(e,t)).next())});class $d{constructor(t){this.lastHTMLs={},this.element=document.createElement("div"),this.element.className="protyle-wysiwyg",this.element.setAttribute("spellcheck","false"),isMobile()?this.element.setAttribute("contenteditable","false"):this.element.setAttribute("contenteditable","true"),window.siyuan.config.editor.displayBookmarkIcon&&this.element.classList.add("protyle-wysiwyg--attr"),this.bindCommonEvent(t),!t.options.action.includes(Constants.CB_GET_HISTORY)&&(this.bindEvent(t),keydown(t,this.element),dropEvent(t,this.element))}renderCustom(t){let a=t[Constants.CUSTOM_SY_FULLWIDTH];a||(a=window.siyuan.config.editor.fullWidth?"true":"false"),a==="true"?this.element.parentElement.setAttribute("data-fullwidth","true"):this.element.parentElement.removeAttribute("data-fullwidth");const n=Object.keys(t);for(let o=0;o<this.element.attributes.length;o++){const i=this.element.attributes[o].nodeName;!["type","class","spellcheck","contenteditable","data-doc-type","style","data-realwidth","data-readonly"].includes(i)&&!n.includes(i)&&(this.element.removeAttribute(i),o--)}n.forEach(o=>{["title-img","title","updated","icon","id","type","class","spellcheck","contenteditable","data-doc-type","style","data-realwidth","data-readonly"].includes(o)||this.element.setAttribute(o,t[o])})}escapeInline(t,a,n){if(!n.data&&n.inputType!=="insertLineBreak")return;const o=n.data;t.toolbar.range=a;const i=a.startContainer.parentElement,s=t.toolbar.getCurrentType();if(n.inputType==="insertLineBreak"){s.length>0&&a.toString()===""&&i.tagName==="SPAN"&&i.textContent.startsWith(`
`)&&a.startContainer.previousSibling&&a.startContainer.previousSibling.textContent===`
`&&i.before(a.startContainer.previousSibling);return}let l=o.length;if(o==="<"||o===">"?l=4:o==="&"&&(l=5),s.length>0&&a.toString()===""&&a.startOffset===o.length&&i.tagName==="SPAN"&&i.textContent.replace(Constants.ZWSP,"")!==o&&i.textContent.replace(Constants.ZWSP,"").length>=o.length&&!hasPreviousSibling(a.startContainer)&&!hasPreviousSibling(i)){const r=i.innerHTML.replace(Constants.ZWSP,"");i.innerHTML=r.substr(l);const c=document.createTextNode(o);i.before(c),a.selectNodeContents(c),a.collapse(!1);return}if(i.tagName==="SPAN"&&i.textContent!==o&&!s.includes("search-mark")&&!s.includes("code")&&!s.includes("kbd")&&!s.includes("tag")&&a.toString()===""&&a.startContainer.nodeType===3&&(s.includes("inline-memo")||s.includes("text")||s.includes("block-ref")||s.includes("file-annotation-ref")||s.includes("a"))&&!hasNextSibling(a.startContainer)&&a.startContainer.textContent.length===a.startOffset&&i.textContent.length>o.length){const r=getSelectionOffset(i,t.wysiwyg.element,a),c=i.innerHTML;if(r.start===i.textContent.length){i.innerHTML=c.substr(0,c.length-l);const d=document.createTextNode(o);i.after(d),a.selectNodeContents(d),a.collapse(!1)}}}setEmptyOutline(t,a){t.wysiwyg.element.querySelectorAll(".img--select, .av__cell--select, .av__cell--active, .av__row--select").forEach(o=>{var i;o.classList.contains("av__row--select")&&!hasClosestByClassName(a,"av")?(o.classList.remove("av__row--select"),o.querySelector(".av__firstcol use").setAttribute("xlink:href","#iconUncheck"),updateHeader(o)):(o.classList.remove("img--select","av__cell--select","av__cell--active"),(i=o.querySelector(".av__drag-fill"))==null||i.remove())});let n=a;if(!a.getAttribute("data-node-id")){const o=hasClosestBlock(a);if(!o)return;n=o}t.disabled&&(t.toolbar.range=getEditorRange(n))}emojiToMd(t){t.querySelectorAll(".emoji").forEach(a=>{a.outerHTML=`:${a.getAttribute("alt")}:`})}bindCommonEvent(t){this.element.addEventListener("copy",a=>{var n;if(window.siyuan.ctrlIsPressed=!1,a.target.tagName==="PROTYLE-HTML"||a.target.localName==="input"){a.stopPropagation();return}a.stopPropagation(),a.preventDefault();const o=getEditorRange(t.wysiwyg.element),i=hasClosestBlock(o.startContainer);if(!i)return;const s=i.querySelector(".img--select"),l=i.querySelector(".av__row--select, .av__cell--select"),r=((n=i.querySelector(".table__select"))==null?void 0:n.clientWidth)>0;let c=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));c.length===0&&o.toString()===""&&!o.cloneContents().querySelector("img")&&!s&&!l&&!r&&(i.classList.add("protyle-wysiwyg--select"),countBlockWord([i.getAttribute("data-node-id")]),c=[i]);let d="",u="";if(c.length>0){const g=c[0].getAttribute("data-reftext")==="true";c[0].getAttribute("data-type")==="NodeListItem"&&c[0].parentElement.classList.contains("list")&&c[0].parentElement.childElementCount-1===c.length?g?d=getTextStar(c[0].parentElement):d=c[0].parentElement.outerHTML:c.forEach((f,p)=>{g&&p===0?d+=getTextStar(f)+`

`:d+=removeEmbed(f)}),g&&c[0].removeAttribute("data-reftext")}else if(l){const g=Array.from(i.querySelectorAll(".av__cell--active, .av__cell--select"))||[];g.length===0&&i.querySelectorAll(".av__row--select:not(.av__row--header)").forEach(f=>{f.querySelectorAll(".av__cell").forEach(p=>{g.push(p)})}),g.length>0&&(d="[",g.forEach((f,p)=>{const m=getCellText(f);(p===0||!g[p-1].isSameNode(f.previousElementSibling))&&(d+="["),d+=JSON.stringify(genCellValueByElement(getTypeByCellElement(f),f))+",",(p===g.length-1||!g[p+1].isSameNode(f.nextElementSibling))&&(d=d.substring(0,d.length-1)+"],"),u+=m+(g[p+1]&&f.nextElementSibling&&f.nextElementSibling.isSameNode(g[p+1])?"	":`

`)}),u=u.substring(0,u.length-2),d=d.substring(0,d.length-1)+"]")}else if(r){const g=[],f=i.firstElementChild.scrollLeft,p=i.querySelector(".table__select");d="<table>",i.querySelectorAll("th, td").forEach(m=>{!m.classList.contains("fn__none")&&m.offsetLeft+6>p.offsetLeft+f&&m.offsetLeft+m.clientWidth-6<p.offsetLeft+f+p.clientWidth&&m.offsetTop+6>p.offsetTop&&m.offsetTop+m.clientHeight-6<p.offsetTop+p.clientHeight&&g.push(m)}),g.forEach((m,b)=>{(b===0||!m.previousElementSibling||!m.previousElementSibling.isSameNode(g[b-1]))&&(d+="<tr>"),d+=m.outerHTML,(!m.nextElementSibling||!g[b+1]||!m.nextElementSibling.isSameNode(g[b+1]))&&(d+="</tr>")}),d+="</table>",u=t.lute.HTML2Md(d)}else{const g=document.createElement("div"),f=t.toolbar.getCurrentType(o),p=hasClosestByTag(o.startContainer,"SPAN"),m=hasClosestByAttribute(o.startContainer,"data-type","NodeHeading");if(f.length>0&&p&&p.textContent.replace(Constants.ZWSP,"")===o.toString()||m&&m.textContent.replace(Constants.ZWSP,"")===o.toString())m?g.append(m.cloneNode(!0)):["DIV","TD","TH","TR"].includes(o.startContainer.parentElement.tagName)?(g.append(o.cloneContents()),this.emojiToMd(g)):(g.append(o.startContainer.parentElement.cloneNode(!0)),this.emojiToMd(g)),d=g.innerHTML,u=o.toString();else if(s)d=s.outerHTML,u=s.querySelector("img").getAttribute("data-src");else if(f.length>0&&o.startContainer.nodeType===3&&o.startContainer.parentElement.tagName==="SPAN"&&o.startContainer.parentElement.isSameNode(o.endContainer.parentElement)){const b=o.startContainer.parentElement.attributes,w=document.createElement("span");for(let y=0;y<b.length;y++)w.setAttribute(b[y].name,b[y].value);w.getAttribute("data-type").indexOf("block-ref")>-1&&w.getAttribute("data-subtype")==="d"&&w.setAttribute("data-subtype","s"),w.textContent=o.toString(),d=w.outerHTML,u=o.toString()}else{g.append(o.cloneContents()),this.emojiToMd(g);const b=hasClosestByAttribute(o.commonAncestorContainer,"data-type","inline-math");b?d=b.outerHTML:d=g.innerHTML,u=g.textContent,hasClosestByAttribute(o.startContainer,"data-type","NodeCodeBlock")?isEndOfBlock(o)&&(u=u.replace(/\n$/,"")):hasClosestByTag(o.startContainer,"CODE")||(u=o.toString())}}t.disabled&&(d=getEnableHTML(d)),u=u||t.lute.BlockDOM2StdMd(d).trimEnd(),u=u.replace(/\u00A0/g," ").replace(new RegExp(Constants.ZWSP,"g"),""),a.clipboardData.setData("text/plain",u),a.clipboardData.setData("text/html",r?d:t.lute.BlockDOM2HTML(l?u:d)),a.clipboardData.setData("text/siyuan",r?t.lute.HTML2BlockDOM(d):d)}),this.element.addEventListener("mousedown",a=>{var n;if(t.wysiwyg.element.classList.remove("protyle-wysiwyg--hiderange"),a.button===2||window.siyuan.ctrlIsPressed)return;window.siyuan.shiftIsPressed&&getSelection().rangeCount>0&&(this.shiftStartElement=hasClosestBlock(getSelection().getRangeAt(0).startContainer)),window.siyuan.shiftIsPressed||hideElements(["select"],t);let o=a.target;if(hasClosestByClassName(o,"protyle-action")||hasClosestByClassName(o,"av__cell--header")&&!hasClosestByClassName(o,"av__widthdrag"))return;const i=document,s=t.element.getBoundingClientRect(),l=s.left+(parseInt(t.wysiwyg.element.style.paddingLeft)||24)+1,r=l+(t.wysiwyg.element.clientWidth-(parseInt(t.wysiwyg.element.style.paddingLeft)||24)-(parseInt(t.wysiwyg.element.style.paddingRight)||16))-2,c=s.bottom,d=a.clientY,u=t.contentElement.getBoundingClientRect();if(!t.disabled&&o.classList.contains("av__widthdrag")){const k=hasClosestBlock(o);if(!k)return;const v=k.getAttribute("data-av-id"),A=k.dataset.nodeId,L=o.parentElement,x=L.clientWidth,T=L.getAttribute("data-col-id");let M;const I=k.querySelector(".av__scroll");i.onmousemove=D=>{M=Math.max(x+(D.clientX-a.clientX),25),I.querySelectorAll(".av__row, .av__row--footer").forEach(N=>{N.querySelector(`[data-col-id="${T}"]`).style.width=M+"px"}),stickyRow(k,u,"bottom")},i.onmouseup=()=>{if(i.onmousemove=null,i.onmouseup=null,i.ondragstart=null,i.onselectstart=null,i.onselect=null,!M||M===x)return;const D=k.getAttribute("custom-sy-av-view");transaction(t,[{action:"setAttrViewColWidth",id:T,avID:v,data:M+"px",blockID:A,keyID:D}],[{action:"setAttrViewColWidth",id:T,avID:v,data:x+"px",blockID:A,keyID:D}])},this.preventClick=!0,a.preventDefault();return}const g=hasClosestByClassName(o,"av__drag-fill");if(!t.disabled&&g){const k=hasClosestBlock(g);if(!k)return;const v={};let A;const L=[];k.querySelectorAll(".av__cell--active").forEach(D=>{const N=hasClosestByClassName(D,"av__row");N&&(v[N.dataset.id]||(v[N.dataset.id]=[]),v[N.dataset.id].push(genCellValueByElement(getTypeByCellElement(D),D)),A=D,L.push(D.dataset.id))});const x=getPositionByCellElement(A),T=getPositionByCellElement(k.querySelector(".av__cell--active"));let M,I;return i.onmousemove=D=>{const N=hasClosestByClassName(D.target,"av__cell");if(!(M&&N&&N.isSameNode(M))&&(M=N,M&&M.dataset.id)){const H=getPositionByCellElement(M);if(k.querySelectorAll(".av__cell--active").forEach(P=>{L.includes(P.dataset.id)||P.classList.remove("av__cell--active")}),H.celIndex!==x.celIndex){I=void 0;return}k.querySelectorAll(".av__row").forEach((P,ne)=>{(H.rowIndex<T.rowIndex&&ne>=H.rowIndex&&ne<T.rowIndex||H.rowIndex>x.rowIndex&&ne<=H.rowIndex&&ne>x.rowIndex)&&P.querySelectorAll(".av__cell").forEach((U,V)=>{V>=T.celIndex&&V<=H.celIndex&&(U.classList.add("av__cell--active"),I=U)})})}},i.onmouseup=()=>{if(i.onmousemove=null,i.onmouseup=null,i.ondragstart=null,i.onselectstart=null,i.onselect=null,I){dragFillCellsValue(t,k,v,L);const D=k.querySelectorAll(".av__cell--active");addDragFill(D[D.length-1])}return!1},this.preventClick=!0,!1}const f=hasClosestByClassName(o,"av__cell");if(!t.disabled&&f&&f.dataset.id&&!isInEmbedBlock(f)){const k=hasClosestBlock(f);if(!k)return;k.querySelectorAll(".av__cell--select").forEach(M=>{M.classList.remove("av__cell--select")}),k.querySelectorAll(".av__drag-fill").forEach(M=>{M.remove()}),f.classList.add("av__cell--select");const v=getPositionByCellElement(f);let A,L;const x=k.getBoundingClientRect(),T=k.querySelector(".av__scroll");return i.onmousemove=M=>{const I=hasClosestByClassName(M.target,"av__cell");if(T.scrollWidth>T.clientWidth+2&&(M.clientX>x.right-10?T.scrollLeft+=10:M.clientX<x.left+34&&(T.scrollLeft-=10),M.clientY<u.top+48?t.contentElement.scrollTop-=5:M.clientY>u.bottom-48&&(t.contentElement.scrollTop+=5)),!(A&&I&&I.isSameNode(A))&&I&&I.dataset.id&&(a.clientX!==M.clientX||a.clientY!==M.clientY)){const D=getPositionByCellElement(I);k.querySelectorAll(".av__cell--active").forEach(N=>{N.classList.remove("av__cell--active")}),k.querySelectorAll(".av__row").forEach((N,H)=>{H>=Math.min(v.rowIndex,D.rowIndex)&&H<=Math.max(v.rowIndex,D.rowIndex)&&N.querySelectorAll(".av__cell").forEach((P,ne)=>{ne>=Math.min(v.celIndex,D.celIndex)&&ne<=Math.max(v.celIndex,D.celIndex)&&(P.classList.add("av__cell--active"),L=P)})}),A=I}},i.onmouseup=()=>(i.onmousemove=null,i.onmouseup=null,i.ondragstart=null,i.onselectstart=null,i.onselect=null,L&&(selectRow(k.querySelector(".av__firstcol"),"unselectAll"),focusBlock(k),addDragFill(L),this.preventClick=!0),!1),!1}if(!t.disabled&&o.classList.contains("protyle-action__drag")){const k=hasClosestBlock(o);if(!k)return;let v=!0;["NodeIFrame","NodeWidget","NodeVideo"].includes(k.getAttribute("data-type"))?(k.classList.add("iframe--drag"),(k.style.textAlign==="left"||k.style.textAlign==="right")&&(v=!1)):o.parentElement.parentElement.getAttribute("data-type")==="img"&&o.parentElement.parentElement.classList.add("img--drag");const A=k.getAttribute("data-node-id"),L=k.outerHTML,x=a.clientX,T=o.previousElementSibling,M=T.clientWidth,I=T.clientHeight,D=T.parentElement.parentElement;T.tagName==="IMG"&&img3115(D),i.onmousemove=N=>{if(T.tagName==="IMG"&&(T.style.height=""),N.clientX>x-M+8&&N.clientX<r){const H=T.tagName==="IMG"&&!D.style.minWidth&&k.style.textAlign!=="center"||!v?1:2;T.tagName==="IMG"?T.parentElement.style.width=Math.max(17,M+(N.clientX-x)*H)+"px":T.style.width=Math.max(17,M+(N.clientX-x)*H)+"px"}T.tagName!=="IMG"&&N.clientY>d-I+8&&N.clientY<c&&(T.style.height=I+(N.clientY-d)+"px")},i.onmouseup=()=>{i.onmousemove=null,i.onmouseup=null,i.ondragstart=null,i.onselectstart=null,i.onselect=null,o.classList.contains("protyle-action__drag")&&k&&updateTransaction(t,A,k.outerHTML,L),k.classList.remove("iframe--drag"),o.parentElement.parentElement.classList.remove("img--drag")};return}let p;const m=hasClosestByTag(o,"TH")||hasClosestByTag(o,"TD");if(m&&(o=m),(o.tagName==="TH"||o.tagName==="TD"||((n=o.firstElementChild)==null?void 0:n.tagName)==="TABLE"||o.classList.contains("table__resize")||o.classList.contains("table__select"))&&(p=hasClosestBlock(o),p&&(p.querySelector(".table__select").removeAttribute("style"),window.siyuan.menus.menu.remove(),hideElements(["toolbar"],t),a.stopPropagation())),!t.disabled&&o.classList.contains("table__resize")){const k=hasClosestBlock(o);if(!k)return;const v=k.outerHTML;getSelection().rangeCount>0&&getSelection().getRangeAt(0).collapse(!1),k.firstElementChild.style.webkitUserModify="read-only",k.style.cursor="col-resize",o.removeAttribute("style");const A=k.getAttribute("data-node-id"),L=a.clientX,x=parseInt(o.getAttribute("data-col-index")),T=k.querySelectorAll("table col")[x];T.style.minWidth&&(T.style.width=k.querySelectorAll("table td, table th")[x].offsetWidth+"px",T.style.minWidth=""),k.querySelectorAll("tr").forEach(D=>{D.cells[x].style.width=""});const M=T.clientWidth,I=k.firstElementChild.clientWidth<k.firstElementChild.scrollWidth;i.onmousemove=D=>{k.style.textAlign==="center"&&!I?T.style.width=M+(D.clientX-L)*2+"px":T.style.width=M+(D.clientX-L)+"px"},i.onmouseup=()=>{k.firstElementChild.style.webkitUserModify="",k.style.cursor="",i.onmousemove=null,i.onmouseup=null,i.ondragstart=null,i.onselectstart=null,i.onselect=null,k&&updateTransaction(t,A,k.outerHTML,v)};return}let b=a.clientX;a.clientX>r?b=r:a.clientX<l&&(b=l);const w=s.top+(t.options.render.breadcrumb?t.breadcrumb.element.parentElement.clientHeight:0);let y,_,h,E;this.element.querySelectorAll("iframe").forEach(k=>{k.style.pointerEvents="none"});const C=["IMG","VIDEO","AUDIO"].includes(o.tagName)||o.classList.contains("img");i.onmousemove=k=>{let v=k.target;if(p&&p.contains(v)&&!hasClosestByClassName(p,"protyle-wysiwyg__embed")){if(v.classList.contains("table__select")){v.classList.add("fn__none");const U=document.elementFromPoint(k.clientX,k.clientY);v.classList.remove("fn__none"),v=hasClosestByTag(U,"TH")||hasClosestByTag(U,"TD")}if(v&&v.isSameNode(o))return p.querySelector(".table__select").removeAttribute("style"),t.wysiwyg.element.classList.remove("protyle-wysiwyg--hiderange"),_=v,!1;if(v&&(v.tagName==="TH"||v.tagName==="TD")&&(!_||!_.isSameNode(v))){p.firstElementChild.style.webkitUserModify="read-only";let U=o.offsetLeft+o.clientWidth-v.offsetLeft,V=v.offsetLeft;o.offsetLeft===v.offsetLeft?U=Math.max(o.clientWidth,v.clientWidth):o.offsetLeft<v.offsetLeft&&(U=v.offsetLeft+v.clientWidth-o.offsetLeft,V=o.offsetLeft);let be=o.offsetTop+o.clientHeight-v.offsetTop,we=v.offsetTop;o.offsetTop===v.offsetTop?be=Math.max(o.clientHeight,v.clientHeight):o.offsetTop<v.offsetTop&&(be=v.offsetTop+v.clientHeight-o.offsetTop,we=o.offsetTop),Array.from(p.querySelectorAll("th, td")).find(G=>{const qe=G.offsetLeft<V+U&&G.offsetLeft+G.clientWidth>V+U,ae=G.offsetLeft<V&&G.offsetLeft+G.clientWidth>V;G.offsetTop<we&&G.offsetTop+G.clientHeight>we?((G.offsetLeft+6>V&&G.offsetLeft+G.clientWidth-6<V+U||qe||ae)&&(be=we+be-G.offsetTop,we=G.offsetTop),qe&&(U=G.offsetLeft+G.clientWidth-V),ae&&(U=V+U-G.offsetLeft,V=G.offsetLeft)):G.offsetTop<we+be&&G.offsetTop+G.clientHeight>we+be?((G.offsetLeft+6>V&&G.offsetLeft+G.clientWidth-6<V+U||qe||ae)&&(be=G.clientHeight+G.offsetTop-we),qe&&(U=G.offsetLeft+G.clientWidth-V),ae&&(U=V+U-G.offsetLeft,V=G.offsetLeft)):ae&&G.offsetTop+6>we&&G.offsetTop+G.clientHeight-6<we+be?(U=V+U-G.offsetLeft,V=G.offsetLeft):qe&&G.offsetTop+6>we&&G.offsetTop+G.clientHeight-6<we+be&&(U=G.offsetLeft+G.clientWidth-V)}),t.wysiwyg.element.classList.add("protyle-wysiwyg--hiderange"),p.querySelector(".table__select").setAttribute("style",`left:${V-p.firstElementChild.scrollLeft}px;top:${we}px;height:${be}px;width:${U+1}px;`),_=v}return}C&&(k.clientY<u.top+Constants.SIZE_SCROLL_TB||k.clientY>u.bottom-Constants.SIZE_SCROLL_TB)&&t.contentElement.scroll({top:t.contentElement.scrollTop+(k.clientY<u.top+Constants.SIZE_SCROLL_TB?-Constants.SIZE_SCROLL_STEP:Constants.SIZE_SCROLL_STEP),behavior:"smooth"}),t.selectElement.classList.remove("fn__none"),hideElements(["gutter"],t);let A=0,L=0,x=0,T=0;if(k.clientX<b?(k.clientX<l?L=l:L=k.clientX,x=b-L):k.clientX>r?(L=b,x=r-L):(L=b,x=k.clientX-b),k.clientY>d?k.clientY>c?(A=d,T=c-d):(A=d,T=k.clientY-d):(k.clientY<w?A=w:A=k.clientY,T=d-A),T<4)return;t.selectElement.setAttribute("style",`background-color: ${t.selectElement.style.backgroundColor};top:${A}px;height:${T}px;left:${L+2}px;width:${x-2}px;`);const M=document.elementFromPoint(k.clientX,k.clientY);if(y&&y.isSameNode(M)&&!y.classList.contains("protyle-wysiwyg")&&!y.classList.contains("list")&&!y.classList.contains("bq")&&!y.classList.contains("sb"))return;y=M,hideElements(["select"],t);let I;if(k.clientY>d?(I=h||document.elementFromPoint(L,A),E=void 0):(I=document.elementFromPoint(L,A),h=void 0),!I||((I.classList.contains("protyle-wysiwyg")||I.classList.contains("list")||I.classList.contains("li")||I.classList.contains("sb")||I.classList.contains("bq"))&&(I=document.elementFromPoint(L,A+16)),!I))return;let D=hasClosestBlock(I);!D&&I.classList.contains("protyle-breadcrumb__bar")&&(D=I.nextElementSibling),k.clientY>d?h||(D||(D=t.wysiwyg.element.firstElementChild,D.classList.contains("protyle-breadcrumb__bar")&&(D=D.nextElementSibling)),h=D):!D&&k.clientY<t.wysiwyg.element.lastElementChild.getBoundingClientRect().bottom&&(D=t.wysiwyg.element.firstElementChild,D.classList.contains("protyle-breadcrumb__bar")&&(D=D.nextElementSibling));let N=[],H=D;if(H){const U=isInEmbedBlock(H);U&&(H=U)}let P=!1;const ne=E?E.getBoundingClientRect().bottom:A+T;for(;H;)if(H&&!H.classList.contains("protyle-attr")){const U=H.getBoundingClientRect();if(U.height>0&&U.top<ne&&U.left<L+x)if(P)if(H.nextElementSibling&&!H.nextElementSibling.classList.contains("protyle-attr")){const V=H.nextElementSibling.getBoundingClientRect();if(V.top<ne&&V.left<L+x)N=[H],H=H.nextElementSibling,P=!1;else if(H.parentElement.classList.contains("sb"))H=hasClosestBlock(H.parentElement),P=!0;else break}else H=hasClosestBlock(H.parentElement),P=!0;else H.classList.contains("protyle-breadcrumb__bar")||N.push(H),H=H.nextElementSibling;else if(H.parentElement.classList.contains("sb"))H=hasClosestBlock(H.parentElement),P=!0;else if(U.height===0&&U.width===0&&H.parentElement.getAttribute("fold")==="1")H=H.parentElement,N=[];else break}else H=hasClosestBlock(H.parentElement),P=!0;k.clientY<=d&&!E&&(E=N[N.length-1]),N.length===1&&!N[0].classList.contains("list")&&!N[0].classList.contains("bq")&&!N[0].classList.contains("sb")?t.selectElement.style.backgroundColor="transparent":(N.forEach(U=>{hasClosestByClassName(U,"protyle-wysiwyg__embed")||U.classList.add("protyle-wysiwyg--select")}),t.selectElement.style.backgroundColor="")},i.onmouseup=k=>{var v;if(i.onmousemove=null,i.onmouseup=null,i.ondragstart=null,i.onselectstart=null,i.onselect=null,h=void 0,E=void 0,this.element.querySelectorAll("iframe").forEach(x=>{x.style.pointerEvents=""}),t.selectElement.classList.add("fn__none"),t.selectElement.removeAttribute("style"),p){p.firstElementChild.style.webkitUserModify="";const x=p.querySelector(".table__select");if(x.getAttribute("style")){if(getSelection().rangeCount>0&&getSelection().getRangeAt(0).collapse(!1),window.siyuan.menus.menu.remove(),t.disabled||(window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.mergeCell,click:()=>{if(p){const T=[],M=[],I=p.querySelectorAll("th").length;let D=0;const N=p.firstElementChild.scrollLeft;let H=!1,P=!1;p.querySelectorAll("th, td").forEach((ae,xe)=>{ae.classList.contains("fn__none")?(ae.previousElementSibling&&ae.previousElementSibling.isSameNode(T[T.length-1])||xe<D&&M.includes((xe+1)%I))&&(T.push(ae),!H&&ae.parentElement.parentElement.tagName==="THEAD"?H=!0:!P&&ae.parentElement.parentElement.tagName==="TBODY"&&(P=!0)):ae.offsetLeft+6>x.offsetLeft+N&&ae.offsetLeft+ae.clientWidth-6<x.offsetLeft+N+x.clientWidth&&ae.offsetTop+6>x.offsetTop&&ae.offsetTop+ae.clientHeight-6<x.offsetTop+x.clientHeight&&(T.push(ae),!H&&ae.parentElement.parentElement.tagName==="THEAD"?H=!0:!P&&ae.parentElement.parentElement.tagName==="TBODY"&&(P=!0),M.push((xe+1)%I),D=Math.max((ae.rowSpan-1)*I+xe+1,D))}),x.removeAttribute("style");const ne=p.outerHTML;let U=T[0],V=U.colSpan,be=1;for(;U.nextElementSibling&&U.nextElementSibling.isSameNode(T[be]);)U=U.nextElementSibling,U.classList.contains("fn__none")||(V+=U.colSpan),be++;let we="",G=T[0].parentElement,qe=T[0].rowSpan;if(T.forEach((ae,xe)=>{let R=ae.innerHTML.trim();R.endsWith("<br>")&&(R=R.substr(0,R.length-4)),we+=R+(!R||xe===T.length-1?"":"<br>"),xe!==0&&(G.isSameNode(ae.parentElement)||(ae.classList.contains("fn__none")||(qe+=ae.rowSpan),G=ae.parentElement,T[0].parentElement.parentElement.tagName==="THEAD"&&ae.parentElement.parentElement.tagName!=="THEAD"&&T[0].parentElement.parentElement.insertAdjacentElement("beforeend",ae.parentElement)),ae.classList.add("fn__none"),ae.innerHTML="")}),H&&P)for(G=G.parentElement.nextElementSibling.firstElementChild;G&&G.parentElement.tagName!=="THEAD";){let ae=0,xe=0;if(Array.from(G.children).forEach(R=>{ae+=R.colSpan-1,R.classList.contains("fn__none")&&xe++}),ae!==xe)T[0].parentElement.parentElement.insertAdjacentElement("beforeend",G),G=G.parentElement.nextElementSibling.firstElementChild;else break}setTimeout(()=>{p&&(T[0].innerHTML=we+"<wbr>",T[0].colSpan=V,T[0].rowSpan=qe,focusByWbr(T[0],document.createRange()),updateTransaction(t,p.getAttribute("data-node-id"),p.outerHTML,ne))})}}}).element),window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({icon:"iconAlignLeft",accelerator:window.siyuan.config.keymap.editor.general.alignLeft.custom,label:window.siyuan.languages.alignLeft,click:()=>{if(p){const T=[],M=p.firstElementChild.scrollLeft;p.querySelectorAll("th, td").forEach(I=>{!I.classList.contains("fn__none")&&I.offsetLeft+6>x.offsetLeft+M&&I.offsetLeft+I.clientWidth-6<x.offsetLeft+M+x.clientWidth&&I.offsetTop+6>x.offsetTop&&I.offsetTop+I.clientHeight-6<x.offsetTop+x.clientHeight&&(T.length===0||T.length>0&&I.offsetTop===T[0].offsetTop)&&T.push(I)}),x.removeAttribute("style"),setTableAlign(t,T,p,"left",getEditorRange(p))}}}).element),window.siyuan.menus.menu.append(new MenuItem({icon:"iconAlignCenter",accelerator:window.siyuan.config.keymap.editor.general.alignCenter.custom,label:window.siyuan.languages.alignCenter,click:()=>{if(p){const T=[],M=p.firstElementChild.scrollLeft;p.querySelectorAll("th, td").forEach(I=>{!I.classList.contains("fn__none")&&I.offsetLeft+6>x.offsetLeft+M&&I.offsetLeft+I.clientWidth-6<x.offsetLeft+M+x.clientWidth&&I.offsetTop+6>x.offsetTop&&I.offsetTop+I.clientHeight-6<x.offsetTop+x.clientHeight&&(T.length===0||T.length>0&&I.offsetTop===T[0].offsetTop)&&T.push(I)}),x.removeAttribute("style"),setTableAlign(t,T,p,"center",getEditorRange(p))}}}).element),window.siyuan.menus.menu.append(new MenuItem({icon:"iconAlignRight",accelerator:window.siyuan.config.keymap.editor.general.alignRight.custom,label:window.siyuan.languages.alignRight,click:()=>{if(p){const T=[],M=p.firstElementChild.scrollLeft;p.querySelectorAll("th, td").forEach(I=>{!I.classList.contains("fn__none")&&I.offsetLeft+6>x.offsetLeft+M&&I.offsetLeft+I.clientWidth-6<x.offsetLeft+M+x.clientWidth&&I.offsetTop+6>x.offsetTop&&I.offsetTop+I.clientHeight-6<x.offsetTop+x.clientHeight&&(T.length===0||T.length>0&&I.offsetTop===T[0].offsetTop)&&T.push(I)}),x.removeAttribute("style"),setTableAlign(t,T,p,"right",getEditorRange(p))}}}).element),window.siyuan.menus.menu.append(new MenuItem({icon:"",label:window.siyuan.languages.useDefaultAlign,click:()=>{if(p){const T=[],M=p.firstElementChild.scrollLeft;p.querySelectorAll("th, td").forEach(I=>{!I.classList.contains("fn__none")&&I.offsetLeft+6>x.offsetLeft+M&&I.offsetLeft+I.clientWidth-6<x.offsetLeft+M+x.clientWidth&&I.offsetTop+6>x.offsetTop&&I.offsetTop+I.clientHeight-6<x.offsetTop+x.clientHeight&&(T.length===0||T.length>0&&I.offsetTop===T[0].offsetTop)&&T.push(I)}),x.removeAttribute("style"),setTableAlign(t,T,p,"",getEditorRange(p))}}}).element),window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element)),window.siyuan.menus.menu.append(new MenuItem({icon:"iconCopy",accelerator:"\u2318C",label:window.siyuan.languages.copy,click(){p&&(focusByRange(getEditorRange(p)),document.execCommand("copy"))}}).element),!t.disabled){let T;window.siyuan.menus.menu.append(new MenuItem({icon:"iconCut",accelerator:"\u2318X",label:window.siyuan.languages.cut,click(){p&&(focusByRange(getEditorRange(p)),document.execCommand("cut"))}}).element),window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.clear,icon:"iconTrashcan",accelerator:"\u2326",click(){clearTableCell(t,p)}}).element),window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.paste,icon:"iconPaste",accelerator:"\u2318V",click(){return Co(this,null,function*(){if(document.queryCommandSupported("paste"))document.execCommand("paste");else if(p)try{const M=yield readClipboard();paste(t,Object.assign(M,{target:p}))}catch(M){console.log(M)}})}}).element)}window.siyuan.menus.menu.popup({x:k.clientX-8,y:k.clientY-16})}}const A=[],L=t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(L.forEach(x=>{A.push(x.getAttribute("data-node-id"))}),countBlockWord(A),getSelection().rangeCount>0){const x=getSelection().getRangeAt(0);if((x.toString()===""||window.siyuan.shiftIsPressed)&&a.detail>2){let I=hasClosestBlock(x.startContainer);if(I){if((v=I.nextElementSibling)!=null&&v.classList.contains("table"))setLastNodeRange(getContenteditableElement(I),x,!1);else if(I.classList.contains("table")){const D=I.querySelectorAll("th, td");I=D[D.length-1],I.contains(x.startContainer)&&setLastNodeRange(I,x,!1)}}return}if(L.length>0){x.collapse(!0);return}const T=hasClosestBlock(x.startContainer);let M;k.detail>2&&x.endContainer.nodeType!==3&&x.endContainer.tagName==="DIV"&&x.endOffset===0?x.endContainer.classList.contains("protyle-attr")&&T&&setLastNodeRange(getContenteditableElement(T),x,!1):M=hasClosestBlock(x.endContainer),T&&M&&!M.isSameNode(T)&&(x.startContainer.nodeType===1&&x.startContainer.tagName==="DIV"&&x.startContainer.classList.contains("protyle-attr")||a.clientY>k.clientY?setFirstNodeRange(getContenteditableElement(M),x):x.endOffset===0&&x.endContainer.nodeType===1&&x.endContainer.tagName==="DIV"?setLastNodeRange(getContenteditableElement(T),x,!1):x.collapse(!0))}}})}bindEvent(t){t.observer=new ResizeObserver(()=>{const s=t.contentElement.getBoundingClientRect();t.wysiwyg.element.querySelectorAll(".av").forEach(l=>{l.querySelector(".av__title")&&stickyRow(l,s,"all")})}),this.element.addEventListener("focusout",()=>{if(getSelection().rangeCount===0)return;const s=getSelection().getRangeAt(0);(this.element.isSameNode(s.startContainer)||this.element.contains(s.startContainer))&&(t.toolbar.range=s)}),this.element.addEventListener("cut",s=>{var l,r,c;if(window.siyuan.ctrlIsPressed=!1,t.disabled)return;if(s.target.tagName==="PROTYLE-HTML"||s.target.localName==="input"){s.stopPropagation();return}t.options.render.breadcrumb&&t.breadcrumb.hide();const d=getEditorRange(t.wysiwyg.element);let u=hasClosestBlock(d.startContainer);if(!u){s.stopPropagation(),s.preventDefault();return}const g=isInEmbedBlock(u);g&&(u=g),s.stopPropagation(),s.preventDefault();const f=u.querySelector(".img--select"),p=u.querySelector(".av__row--select, .av__cell--select"),m=((l=u.querySelector(".table__select"))==null?void 0:l.clientWidth)>0;let b=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));b.length===0&&d.toString()===""&&!d.cloneContents().querySelector("img")&&!f&&!p&&!m&&(u.classList.add("protyle-wysiwyg--select"),b=[u]);let w="",y="";if(b.length>0){b[0].getAttribute("data-type")==="NodeListItem"&&b[0].parentElement.classList.contains("list")&&b[0].parentElement.childElementCount-1===b.length?w=b[0].parentElement.outerHTML:(b.forEach(h=>{const E=getTopAloneElement(h);h.getAttribute("data-type")==="NodeHeading"&&h.getAttribute("fold")==="1"?w+=removeEmbed(E).replace('fold="1"',""):w+=removeEmbed(E)}),b[0].getAttribute("data-type")==="NodeListItem"&&(w=`<div data-subtype="${b[0].getAttribute("data-subtype")}" data-node-id="${Lute.NewNodeID()}" data-type="NodeList" class="list">${w}<div class="protyle-attr" contenteditable="false">${Constants.ZWSP}</div></div>`));const _=getNextBlock(b[b.length-1]);removeBlock(t,u,d,"remove"),_&&focusBlock(_)}else if(p){const _=updateCellsValue(t,u);w=JSON.stringify(_.json),y=_.text}else if(m){const _=[],h=u.firstElementChild.scrollLeft,E=u.querySelector(".table__select");if(w="<table>",u.querySelectorAll("th, td").forEach(k=>{!k.classList.contains("fn__none")&&k.offsetLeft+6>E.offsetLeft+h&&k.offsetLeft+k.clientWidth-6<E.offsetLeft+h+E.clientWidth&&k.offsetTop+6>E.offsetTop&&k.offsetTop+k.clientHeight-6<E.offsetTop+E.clientHeight&&_.push(k)}),E.removeAttribute("style"),getSelection().rangeCount>0){const k=getSelection().getRangeAt(0);u.contains(k.startContainer)&&k.insertNode(document.createElement("wbr"))}const C=u.outerHTML;(r=u.querySelector("wbr"))==null||r.remove(),u.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),_.forEach((k,v)=>{(v===0||!k.previousElementSibling||!k.previousElementSibling.isSameNode(_[v-1]))&&(w+="<tr>"),w+=k.outerHTML,(!k.nextElementSibling||!_[v+1]||!k.nextElementSibling.isSameNode(_[v+1]))&&(w+="</tr>"),k.innerHTML=""}),w+="</table>",y=t.lute.HTML2Md(w),updateTransaction(t,u.getAttribute("data-node-id"),u.outerHTML,C)}else{const _=u.getAttribute("data-node-id");setInsertWbrHTML(u,d,t);const h=t.wysiwyg.lastHTMLs[_]||u.outerHTML,E=document.createElement("div");let C=d.startContainer;if(C.nodeType===3&&C.textContent===""){const v=hasNextSibling(d.startContainer);v&&(C=v)}const k=hasClosestByAttribute(C,"data-type","NodeHeading");if(k&&d.toString()===k.firstElementChild.textContent)E.insertAdjacentHTML("afterbegin",k.firstElementChild.innerHTML),k.firstElementChild.innerHTML="";else if(d.toString()!==""&&C.isSameNode(d.endContainer)&&d.startContainer.nodeType===3&&d.endOffset===d.endContainer.textContent.length&&d.startOffset===0&&!["DIV","TD","TH","TR"].includes(d.startContainer.parentElement.tagName))E.append(d.startContainer.parentElement);else if(f)E.append(f);else if(d.startContainer.nodeType===3&&d.startContainer.parentElement.tagName==="SPAN"&&d.startContainer.parentElement.getAttribute("data-type")&&d.startContainer.parentElement.isSameNode(d.endContainer.parentElement)){const v=d.startContainer.parentElement,A=v.attributes,L=document.createElement("span");for(let x=0;x<A.length;x++)L.setAttribute(A[x].name,A[x].value);v.getAttribute("data-type").indexOf("block-ref")>-1&&v.getAttribute("data-subtype")==="d"&&(L.setAttribute("data-subtype","s"),v.setAttribute("data-subtype","s")),L.textContent=d.toString(),d.deleteContents(),E.append(L)}else if(d.cloneContents().querySelectorAll("td, th").length>0){const v=document.createElement("wbr");d.insertNode(v),d.setStartAfter(v),E.append(d.extractContents()),u.outerHTML=t.lute.SpinBlockDOM(u.outerHTML),u=t.wysiwyg.element.querySelector(`[data-node-id="${_}"]`),mathRender(u),focusByWbr(u,d)}else{const v=hasClosestByAttribute(d.commonAncestorContainer,"data-type","inline-math");if(v)E.append(v);else{E.append(d.extractContents());let A;u.classList.contains("av")?updateAVName(t,u):u.classList.contains("table")?A=hasClosestByTag(d.startContainer,"TD")||hasClosestByTag(d.startContainer,"TH"):A=getContenteditableElement(u),A&&Array.from(A.children).forEach(L=>{L.textContent===""&&L.nodeType===1&&!["BR","IMG"].includes(L.tagName)&&L.remove()})}}if(this.emojiToMd(E),w=E.innerHTML,(hasClosestByAttribute(d.startContainer,"data-type","NodeCodeBlock")||hasClosestByTag(d.startContainer,"CODE"))&&(y=E.textContent.replace(Constants.ZWSP,"")),!u.classList.contains("table")){const v=getContenteditableElement(u);v&&v.textContent===""&&(v.innerHTML="")}u.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),u.getAttribute("data-type")==="NodeCodeBlock"&&(d.insertNode(document.createElement("wbr")),(c=u.querySelector('[data-render="true"]'))==null||c.removeAttribute("data-render"),highlightRender(u)),u.parentElement.parentElement&&!u.classList.contains("av")&&(setInsertWbrHTML(u,d,t),updateTransaction(t,_,t.wysiwyg.lastHTMLs[_]||u.outerHTML,h))}t.hint.render(t),p||(y=y||t.lute.BlockDOM2StdMd(w).trimEnd()),y=y.replace(/\u00A0/g," "),s.clipboardData.setData("text/plain",y),s.clipboardData.setData("text/html",m?w:t.lute.BlockDOM2HTML(p?y:w)),s.clipboardData.setData("text/siyuan",m?t.lute.HTML2BlockDOM(w):w)});let a;this.element.addEventListener("contextmenu",s=>{var l,r,c,d,u;if(s.shiftKey)return;s.stopPropagation(),s.preventDefault();const g=s.clientX||s.detail.x,f=s.clientY||s.detail.y,p=t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(p.length>1){hideElements(["util"],t),t.gutter.renderMenu(t,p[0]),window.siyuan.menus.menu.popup({x:g,y:f});return}const m=s.detail.target||s.target,b=isInEmbedBlock(m);if(b)return getSelection().rangeCount===0&&focusSideBlock(b),t.gutter.renderMenu(t,b),window.siyuan.menus.menu.fullscreen(),!1;const w=hasClosestBlock(m);if(!w)return!1;const y=hasClosestByClassName(m,"av__cell");if(y){if(y.classList.contains("av__cell--header")){t.disabled||showColMenu(t,w,y),s.stopPropagation(),s.preventDefault();return}if(getTypeByCellElement(y)==="mAsset"){const C=hasClosestByClassName(m,"av__cellassetimg")||hasClosestByClassName(m,"av__celltext--url");if(C){let k=0;Array.from(y.children).find((v,A)=>{if(v===C)return k=A,!0}),editAssetItem({protyle:t,cellElements:[y],blockElement:hasClosestBlock(C),content:m.tagName==="IMG"?m.getAttribute("src"):m.getAttribute("data-url"),type:m.tagName==="IMG"?"image":"file",name:m.tagName==="IMG"?"":m.getAttribute("data-name"),index:k,rect:m.getBoundingClientRect()}),s.stopPropagation(),s.preventDefault();return}}}const _=hasClosestByClassName(m,"av__row");if(_&&avContextmenu(t,_,{x:s.clientX,y:_.getBoundingClientRect().bottom,h:_.clientHeight})){s.stopPropagation(),s.preventDefault();return}const h=hasClosestByClassName(m,"item");if(w.classList.contains("av")&&h){h.classList.contains("item--focus")?openViewMenu({protyle:t,blockElement:w,element:h}):(w.removeAttribute("data-render"),avRender(w,t,()=>{openViewMenu({protyle:t,blockElement:w,element:w.querySelector(".item.item--focus")})},h.dataset.id)),s.stopPropagation(),s.preventDefault();return}if(t.toolbar.range=getEditorRange(t.element),m.tagName==="SPAN"&&!isNotEditBlock(w)){let C=((l=m.getAttribute("data-type"))==null?void 0:l.split(" "))||[];if(C.length===0&&(C=(m.dataset.type||"").split(" ")),C.length>0&&removeSearchMark(m),C.includes("block-ref"))return refMenu(t,m),m.setAttribute("prevent-popover","true"),setTimeout(()=>{m.removeAttribute("prevent-popover")},620),!1;if(C.includes("file-annotation-ref")&&!t.disabled)return fileAnnotationRefMenu(t,m),!1;if(C.includes("tag")&&!t.disabled)return tagMenu(t,m),!1;if(C.includes("inline-memo"))return t.toolbar.showRender(t,m),!1;if(C.includes("a"))return linkMenu(t,m),window.siyuan.config.editor.floatWindowMode===0&&((r=m.getAttribute("data-href"))!=null&&r.startsWith("siyuan://blocks"))&&(m.setAttribute("prevent-popover","true"),setTimeout(()=>{m.removeAttribute("prevent-popover")},620)),!1}const E=hasClosestByAttribute(m,"data-type","inline-math");if(E)return inlineMathMenu(t,E),!1;if(m.tagName==="IMG"&&hasClosestByClassName(m,"img"))return imgMenu(t,t.toolbar.range,m.parentElement.parentElement,{clientX:g+4,clientY:f}),!1;!isNotEditBlock(w)&&!w.classList.contains("protyle-wysiwyg--select")&&!hasClosestByClassName(m,"protyle-action")&&(isMobile()||s.detail.target||a&&w.contains(a.startContainer))?(!isMobile()||(c=t.toolbar)!=null&&c.element.classList.contains("fn__none"))&&!w.classList.contains("av")&&(contentMenu(t,w),window.siyuan.menus.menu.popup({x:g,y:f+13,h:26}),(d=t.toolbar)==null||d.element.classList.add("fn__none"),w.classList.contains("table")&&w.querySelector(".table__select").removeAttribute("style")):t.toolbar.range.toString()===""&&(hideElements(["util"],t),t.gutter&&t.gutter.renderMenu(t,w),window.siyuan.menus.menu.fullscreen(),(u=t.toolbar)==null||u.element.classList.add("fn__none"))}),this.element.addEventListener("pointerdown",()=>{getSelection().rangeCount>0?a=getSelection().getRangeAt(0):a=void 0});let n=!1;this.element.addEventListener("mousewheel",s=>{if(hideTooltip(),!n&&s.deltaY<0&&!t.scroll.element.classList.contains("fn__none")&&t.contentElement.clientHeight===t.contentElement.scrollHeight&&t.wysiwyg.element.firstElementChild.getAttribute("data-eof")!=="1"&&(fetchPost("/api/filetree/getDoc",{id:t.wysiwyg.element.firstElementChild.getAttribute("data-node-id"),mode:1,size:window.siyuan.config.editor.dynamicLoadBlocks},r=>{n=!1,onGet({data:r,protyle:t,action:[Constants.CB_GET_BEFORE,Constants.CB_GET_UNCHANGEID]})}),n=!0),s.deltaX===0)return;const l=hasClosestByClassName(s.target,"table");if(l){const r=l.querySelector(".table__select");r!=null&&r.style.width&&(r.removeAttribute("style"),window.siyuan.menus.menu.remove())}},{passive:!0}),this.element.addEventListener("paste",s=>{if(s.target.localName==="input"&&s.target.getAttribute("data-type")==="av-search")return;if(t.disabled){s.stopPropagation(),s.preventDefault();return}if(window.siyuan.ctrlIsPressed=!1,s.target.tagName==="PROTYLE-HTML"||s.target.localName==="input"){s.stopPropagation();return}if(!hasClosestByAttribute(s.target,"contenteditable","true")){s.stopPropagation(),s.preventDefault();return}const l=hasClosestBlock(s.target);if(l&&!getContenteditableElement(l)){s.stopPropagation(),s.preventDefault();return}if(!l)return;const r=getSelection().getRangeAt(0),c=r.startContainer.parentElement;if(r.toString()===""&&c.tagName==="SPAN"){const d=(c.getAttribute("data-type")||"").split(" ");if(d.includes("inline-memo")||d.includes("text")||d.includes("block-ref")||d.includes("file-annotation-ref")||d.includes("a")){const u=getSelectionOffset(c,l,r);u.start===0?(r.setStartBefore(c),r.collapse(!0)):u.start===c.textContent.length&&(r.setEndAfter(c),r.collapse(!1))}}paste(t,s)});let o=!1;this.element.addEventListener("compositionstart",s=>{o=!0;const l=getEditorRange(t.wysiwyg.element),r=hasClosestBlock(l.startContainer);!isMac()&&r&&setInsertWbrHTML(r,l,t),s.stopPropagation()}),this.element.addEventListener("compositionend",s=>{s.stopPropagation(),o=!1;const l=getEditorRange(this.element),r=hasClosestBlock(l.startContainer);if(r)if(s.data!=="")this.escapeInline(t,l,s),input(t,r,l,!0);else{const c=r.getAttribute("data-node-id");t.wysiwyg.lastHTMLs[c]&&updateTransaction(t,c,r.outerHTML,t.wysiwyg.lastHTMLs[c])}});let i;this.element.addEventListener("input",s=>{const l=s.target;if(l.tagName==="VIDEO"||l.tagName==="AUDIO"||s.inputType==="historyRedo")return;if(s.inputType==="historyUndo"){window.siyuan.menus.menu.remove();return}const r=getEditorRange(this.element),c=hasClosestBlock(r.startContainer);c&&([":","(","\u3010","\uFF08","[","{","\u300C","\u300E","#","/","\u3001"].includes(s.data)&&(t.hint.enableExtend=!0),!(s.isComposing||o||s.inputType==="deleteByDrag"||s.inputType==="insertFromDrop")&&(this.escapeInline(t,r,s),/^\d{1}$/.test(s.data)||s.data==="\u2018"||s.data==="\u201C"||s.data==="\u201D"||s.data==="\u300C"?(clearTimeout(i),i=window.setTimeout(()=>{input(t,c,r,!0)})):input(t,c,r,!0,s),s.stopPropagation()))}),this.element.addEventListener("keyup",s=>{const l=getEditorRange(this.element).cloneRange(),r=hasClosestBlock(l.startContainer);if(s.key!=="PageUp"&&s.key!=="PageDown"&&s.key!=="Home"&&s.key!=="End"&&s.key.indexOf("Arrow")===-1&&s.key!=="Escape"&&s.key!=="Shift"&&s.key!=="Meta"&&s.key!=="Alt"&&s.key!=="Control"&&s.key!=="CapsLock"&&!s.ctrlKey&&!s.shiftKey&&!s.metaKey&&!s.altKey&&!/^F\d{1,2}$/.test(s.key)){!isMac()&&r&&!o&&(typeof t.wysiwyg.lastHTMLs[r.getAttribute("data-node-id")]=="undefined"||l.toString()!==""||!this.preventKeyup)&&setInsertWbrHTML(r,l,t),this.preventKeyup=!1;return}if(this.preventKeyup){this.preventKeyup=!1;return}if((s.shiftKey||isOnlyMeta(s))&&!s.isComposing&&l.toString()!==""&&(t.toolbar.render(t,l,s),countSelectWord(l)),s.eventPhase!==3&&!s.shiftKey&&(s.key.indexOf("Arrow")>-1||s.key==="Home"||s.key==="End"||s.key==="PageUp"||s.key==="PageDown")&&!s.isComposing){if(r&&(this.setEmptyOutline(t,r),l.toString()===""&&!r.classList.contains("protyle-wysiwyg--select")&&countSelectWord(l,t.block.rootID),t.breadcrumb)){const c=t.breadcrumb.element.parentElement.querySelector('[data-type="indent"]');if(c){const d=t.breadcrumb.element.parentElement.querySelector('[data-type="outdent"]');r.parentElement.classList.contains("li")?(c.removeAttribute("disabled"),d.removeAttribute("disabled")):(c.setAttribute("disabled","true"),d.setAttribute("disabled","true"))}}s.stopPropagation()}if((s.key==="ArrowLeft"||s.key==="ArrowRight")&&r&&!r.classList.contains("protyle-wysiwyg--select")){const c=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));let d=!1;c.find(u=>{if(u.contains(l.startContainer))return d=!0,!0}),!d&&c.length>0&&(c.forEach(u=>{u.classList.remove("protyle-wysiwyg--select")}),r.classList.add("protyle-wysiwyg--select"))}}),this.element.addEventListener("dblclick",s=>{if(s.target.tagName==="IMG"&&!s.target.classList.contains("emoji")){previewDocImage(s.target.getAttribute("src"),t.block.rootID);return}}),this.element.addEventListener("click",s=>{if(this.preventClick){this.preventClick=!1;return}t.app.plugins.forEach(L=>{L.eventBus.emit("click-editorcontent",{protyle:t,event:s})}),hideElements(["hint","util"],t);const l=isOnlyMeta(s);s.shiftKey||(this.shiftStartElement=void 0),this.setEmptyOutline(t,s.target);const r=hasClosestByClassName(s.target,"table");this.element.querySelectorAll(".table").forEach(L=>{(!r||!L.isSameNode(r))&&L.querySelector(".table__select").removeAttribute("style"),r&&r.isSameNode(L)&&L.querySelector(".table__select").getAttribute("style")&&s.stopPropagation()}),t.options.render.breadcrumb&&t.breadcrumb.render(t,!1,hasClosestBlock(s.target));const c=getEditorRange(this.element);c.startContainer.nodeType!==3&&c.startContainer.classList.contains("protyle-action")&&c.startContainer.parentElement.classList.contains("code-block")&&setFirstNodeRange(c.startContainer.parentElement.querySelector(".hljs").lastElementChild,c);const d=hasClosestByAttribute(s.target,"data-type","a")||hasClosestByClassName(s.target,"av__celltext--url");let u=d&&d.getAttribute("data-href")||"";d&&!u&&d.classList.contains("av__celltext--url")&&(u=d.textContent.trim(),d.dataset.type==="phone"?u="tel:"+u:d.dataset.type==="email"?u="mailto:"+u:d.classList.contains("b3-chip")&&(u=d.dataset.url));const g=hasClosestByAttribute(s.target,"data-type","block-ref");if((g||u.startsWith("siyuan://blocks/"))&&(s.stopPropagation(),s.preventDefault(),hideElements(["dialog","toolbar"],t),c.toString()===""||s.shiftKey)){let L;g?L=g.getAttribute("data-id"):d&&(L=u.substring(16,38)),checkFold(L,(x,T,M)=>{M||T.push(Constants.CB_GET_HL),openMobileFileById(t.app,L,x?[Constants.CB_GET_ALL]:[Constants.CB_GET_HL,Constants.CB_GET_CONTEXT,Constants.CB_GET_ROOTSCROLL]),activeBlur(),hideKeyboardToolbar()});return}const f=hasClosestByAttribute(s.target,"data-type","virtual-block-ref");if(f){const L=hasClosestBlock(f);L&&fetchPost("/api/block/getBlockDefIDsByRefText",{anchor:f.textContent,excludeIDs:[L.getAttribute("data-node-id")]},x=>{checkFold(x.data[0],T=>{openMobileFileById(t.app,x.data[0],T?[Constants.CB_GET_ALL]:[Constants.CB_GET_HL,Constants.CB_GET_CONTEXT,Constants.CB_GET_ROOTSCROLL]),activeBlur(),hideKeyboardToolbar()})});return}const p=hasClosestByAttribute(s.target,"data-type","file-annotation-ref");if(p&&c.toString()===""){s.stopPropagation(),s.preventDefault(),openLink(t,p.getAttribute("data-id"),s,l);return}if(d&&(s.shiftKey||c.toString()==="")&&u){s.stopPropagation(),s.preventDefault(),openLink(t,u,s,l);return}if(d&&d.classList.contains("av__celltext--url")&&!u){let L=0;Array.from(d.parentElement.children).find((x,T)=>{if(x===d)return L=T,!0}),editAssetItem({protyle:t,cellElements:[d.parentElement],blockElement:hasClosestBlock(d),content:d.getAttribute("data-url"),type:"file",name:d.getAttribute("data-name"),index:L,rect:d.getBoundingClientRect()});return}const m=hasClosestByAttribute(s.target,"data-type","tag");if(m&&!s.altKey&&!s.shiftKey&&c.toString()===""){popSearch(t.app,{hasReplace:!1,method:0,hPath:"",idPath:[],k:`#${m.textContent}#`,r:"",page:1});return}const b=hasClosestByClassName(s.target,"protyle-wysiwyg__embed");if(b){const L=b.getAttribute("data-id");if(checkFold(L,(x,T)=>{openMobileFileById(t.app,L,x?[Constants.CB_GET_ALL]:[Constants.CB_GET_HL,Constants.CB_GET_CONTEXT,Constants.CB_GET_ROOTSCROLL]),activeBlur(),hideKeyboardToolbar()}),!l){s.stopPropagation();return}}if(commonClick(s,t)||hasTopClosestByClassName(s.target,"protyle-action__copy"))return;const w=hasClosestByClassName(s.target,"protyle-action__edit");if(w&&!t.disabled){t.toolbar.showRender(t,w.parentElement.parentElement),s.stopPropagation(),s.preventDefault();return}const y=hasClosestByClassName(s.target,"protyle-action__menu");if(y){t.gutter.renderMenu(t,y.parentElement.parentElement),window.siyuan.menus.menu.fullscreen(),s.stopPropagation(),s.preventDefault();return}const _=hasClosestByClassName(s.target,"protyle-action__reload");if(_){const L=isInEmbedBlock(_);L&&(L.removeAttribute("data-render"),blockRender(t,L)),s.stopPropagation(),s.preventDefault();return}const h=hasClosestByClassName(s.target,"protyle-action__language");if(h&&!t.disabled&&!l){t.toolbar.showCodeLanguage(t,h),s.stopPropagation(),s.preventDefault();return}const E=hasClosestByAttribute(s.target,"data-subtype","math");if(!s.shiftKey&&!l&&E&&!t.disabled){t.toolbar.showRender(t,E),s.stopPropagation();return}const C=hasClosestByClassName(s.target,"protyle-action");if(C){if(C.parentElement.parentElement.getAttribute("data-type")==="img"&&!t.disabled){imgMenu(t,c,C.parentElement.parentElement,{clientX:s.clientX+4,clientY:s.clientY}),s.stopPropagation();return}else if(C.parentElement.classList.contains("li")){const x=C.parentElement.getAttribute("data-node-id");if(s.altKey&&!t.disabled){if(C.parentElement.parentElement.classList.contains("protyle-wysiwyg"))setFold(t,C.parentElement);else{let T=!0;const M=C.parentElement.parentElement.outerHTML;Array.from(C.parentElement.parentElement.children).find(I=>{if(I.classList.contains("li")&&I.getAttribute("fold")!=="1"&&I.childElementCount>3)return T=!1,!0}),Array.from(C.parentElement.parentElement.children).find(I=>{I.classList.contains("li")&&(T?I.removeAttribute("fold"):I.childElementCount>3&&I.setAttribute("fold","1"))}),updateTransaction(t,C.parentElement.parentElement.getAttribute("data-node-id"),C.parentElement.parentElement.outerHTML,M)}hideElements(["gutter"],t)}else if(s.shiftKey&&!t.disabled)openAttr(C.parentElement,"bookmark",t);else if(l)zoomOut({protyle:t,id:x});else if(C.classList.contains("protyle-action--task")){if(!t.disabled){const T=C.parentElement.outerHTML;C.parentElement.classList.contains("protyle-task--done")?(C.querySelector("use").setAttribute("xlink:href","#iconUncheck"),C.parentElement.classList.remove("protyle-task--done")):(C.querySelector("use").setAttribute("xlink:href","#iconCheck"),C.parentElement.classList.add("protyle-task--done")),C.parentElement.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(t,x,C.parentElement.outerHTML,T)}}else window.siyuan.config.editor.listItemDotNumberClickFocus&&(t.block.showAll&&t.block.id===x?enterBack(t,x):zoomOut({protyle:t,id:x}));s.stopPropagation();return}}const k=hasClosestByClassName(s.target,"hr")||hasClosestByClassName(s.target,"iframe");if(!s.shiftKey&&!l&&k){k.classList.add("protyle-wysiwyg--select"),globalClickHideMenu(s.target),s.stopPropagation();return}const v=hasTopClosestByClassName(s.target,"img");if(!s.shiftKey&&!l&&v){v.classList.add("img--select");const L=hasNextSibling(v);L&&(L.textContent.startsWith(Constants.ZWSP)?c.setStart(L,1):c.setStart(L,0),c.collapse(!0),focusByRange(c),t.options.render.breadcrumb&&t.breadcrumb.render(t));return}const A=hasTopClosestByClassName(s.target,"emoji");if(!t.disabled&&!s.shiftKey&&!l&&A){const L=hasClosestBlock(A);if(L){const x=A.getBoundingClientRect();openEmojiPanel("","av",{x:x.left,y:x.bottom,h:x.height,w:x.width},T=>{A.insertAdjacentHTML("afterend","<wbr>");const M=L.outerHTML;let I;if(T.startsWith("api/icon/getDynamicIcon"))I=`<img class="emoji" src="${T}"/>`;else if(T.indexOf(".")>-1){const D=T.split(".");I=`<img alt="${D[0]}" class="emoji" src="/emojis/${T}" title="${D[0]}">`}else I=unicode2Emoji(T);A.outerHTML=I,hideElements(["dialog"]),updateTransaction(t,L.getAttribute("data-node-id"),L.outerHTML,M),focusByWbr(L,c)},A)}return}if(!avClick(t,s)){if(setTimeout(()=>{let L=getEditorRange(this.element);const x=hasClosestByClassName(L.endContainer,"protyle-attr");x&&(L=setLastNodeRange(x.previousElementSibling,L,!1)),t.wysiwyg.element.querySelector(".protyle-wysiwyg--select")||countSelectWord(L,t.block.rootID),getSelection().rangeCount===0&&focusByRange(L)},isMobile()||isInIOS()?520:0),t.hint.enableExtend=!1,s.shiftKey){s.preventDefault(),s.stopPropagation();let L=this.shiftStartElement,x=hasClosestBlock(s.target);if(this.shiftStartElement&&x&&!this.shiftStartElement.isSameNode(x)){let T=!0;c.collapse(!0);const M=L.getBoundingClientRect(),I=x.getBoundingClientRect();let D=M.top,N=I.top;if(D===N&&(D=M.left,N=I.left),D>N){const U=x;x=L,L=U;const V=N;N=D,D=V,T=!1}let H=[],P=L,ne=!1;for(;P;)if(P&&!P.classList.contains("protyle-attr")){const U=P.getBoundingClientRect();if(M.top===I.top?U.left<=N:U.top<=N)if(ne)if(P.nextElementSibling&&!P.nextElementSibling.classList.contains("protyle-attr")){const V=P.nextElementSibling.getBoundingClientRect();if(M.top===I.top?V.left<=N&&V.bottom<=I.bottom:V.top<=N)H=[P],P=P.nextElementSibling,ne=!1;else if(P.parentElement.classList.contains("sb"))P=hasClosestBlock(P.parentElement),ne=!0;else break}else P=hasClosestBlock(P.parentElement),ne=!0;else H.push(P),P=P.nextElementSibling;else if(P.parentElement.classList.contains("sb"))P=hasClosestBlock(P.parentElement),ne=!0;else break}else P=hasClosestBlock(P.parentElement),ne=!0;if(H.length===1&&!H[0].classList.contains("list")&&!H[0].classList.contains("bq")&&!H[0].classList.contains("sb"))this.shiftStartElement=void 0;else{const U=[];!t.wysiwyg.element.querySelector(".protyle-wysiwyg--select")&&t.scroll&&!t.scroll.element.classList.contains("fn__none")&&!t.scroll.keepLazyLoad&&(L.getBoundingClientRect().top<-t.contentElement.clientHeight*2||x.getBoundingClientRect().bottom>t.contentElement.clientHeight*2)&&showMessage(window.siyuan.languages.crossKeepLazyLoad),H.forEach(V=>{V.classList.add("protyle-wysiwyg--select"),U.push(V.getAttribute("data-node-id")),V.querySelectorAll(".protyle-wysiwyg--select").forEach(be=>{be.classList.remove("protyle-wysiwyg--select")})}),countBlockWord(U),T?focusBlock(H[H.length-1],t.wysiwyg.element,!1):focusBlock(H[0],t.wysiwyg.element,!1)}}}if(this.element.querySelector(".protyle-wysiwyg--select")&&c.toString()!==""&&(c.collapse(!1),focusByRange(c)),l&&c.toString()===""&&!s.shiftKey&&!s.altKey){let L=hasClosestBlock(s.target);if(L){const x=isInEmbedBlock(L);x&&(L=x),L=getTopAloneElement(L),L.classList.contains("protyle-wysiwyg--select")?(L.classList.remove("protyle-wysiwyg--select"),L.removeAttribute("select-start"),L.removeAttribute("select-end")):L.classList.add("protyle-wysiwyg--select"),L.querySelectorAll(".protyle-wysiwyg--select").forEach(I=>{I.classList.remove("protyle-wysiwyg--select"),I.removeAttribute("select-start"),I.removeAttribute("select-end")});const T=hasClosestByClassName(L.parentElement,"protyle-wysiwyg--select");T&&(T.classList.remove("protyle-wysiwyg--select"),T.removeAttribute("select-start"),T.removeAttribute("select-end"));const M=[];t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").forEach(I=>{M.push(I.getAttribute("data-node-id"))}),countBlockWord(M)}}}})}}var Ao=(e,t,a)=>new Promise((n,o)=>{var i=r=>{try{l(a.next(r))}catch(c){o(c)}},s=r=>{try{l(a.throw(r))}catch(c){o(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(i,s);l((a=a.apply(e,t)).next())});class Hd extends Pt{constructor(t,a){super(t,a),this.element.addEventListener("click",n=>Ao(this,null,function*(){t.toolbar.element.classList.add("fn__none"),n.stopPropagation();const o=t.toolbar.range;if(!oe(o.startContainer))return;const s=j(o.startContainer,"data-type","a");if(s){Ko(t,s);return}const l=o.toString().trim().replace(S.ZWSP,"");let r="",c="";try{const d=yield bi();if(r=t.lute.GetLinkDest(l),r||(r=t.lute.GetLinkDest(d)),!r){const u=d.lastIndexOf(" ");u>-1&&(r=t.lute.GetLinkDest(d.substring(u)),r&&(c=d.substring(0,u)))}!r&&d.startsWith("assets/")&&(r=d)}catch(d){console.log(d)}t.toolbar.setInlineMark(t,"a","range",{type:"a",color:r+(c?S.ZWSP+c:"")})}))}}class Nd extends Pt{constructor(t,a){super(t,a),this.element.addEventListener("click",n=>{t.toolbar.range.toString()!==""&&(gi(t.toolbar.range),al(t.toolbar.range.toString(),t,"search"),t.toolbar.element.classList.add("fn__none"),n.stopPropagation())})}}var Lo=(e,t,a)=>new Promise((n,o)=>{var i=r=>{try{l(a.next(r))}catch(c){o(c)}},s=r=>{try{l(a.throw(r))}catch(c){o(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(i,s);l((a=a.apply(e,t)).next())});class Bd extends Pt{constructor(t,a){super(t,a),this.element.addEventListener("click",n=>Lo(this,null,function*(){t.toolbar.element.classList.add("fn__none"),n.stopPropagation();const o=t.toolbar.range;if(!oe(o.startContainer))return;let s=j(o.startContainer,"data-type","inline-math");if(!s&&o.startContainer.nodeType!==3&&o.startContainer.childNodes[o.startOffset]){const l=Ht(o.startContainer.childNodes[o.startOffset]);l&&l.nodeType!==3&&l.getAttribute("data-type").indexOf("inline-math")>-1&&(s=l)}if(!s&&o.startOffset===o.startContainer.textContent.length&&o.startContainer.nodeType===3){let l=!0,r=!1;if(o.cloneContents().childNodes.forEach(c=>{c.nodeType!==3&&(c.getAttribute("data-type")||"").indexOf("inline-math")>-1||c.nodeType==3&&c.textContent===""?r=!0:l=!1}),l&&r){const c=La(o.startContainer);if(c&&c.nodeType!==3&&c.getAttribute("data-type").indexOf("inline-math")>-1)s=c;else{const d=Ht(o.startContainer);o.startOffset===0&&d&&d.nodeType!==3&&d.getAttribute("data-type").indexOf("inline-math")>-1&&(s=d)}}}if(s){t.toolbar.showRender(t,s);return}t.toolbar.setInlineMark(t,"inline-math","range",{type:"inline-math"})}))}}var So=(e,t,a)=>new Promise((n,o)=>{var i=r=>{try{l(a.next(r))}catch(c){o(c)}},s=r=>{try{l(a.throw(r))}catch(c){o(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(i,s);l((a=a.apply(e,t)).next())});class Pd extends Pt{constructor(t,a){super(t,a),this.element.addEventListener("click",n=>So(this,null,function*(){t.toolbar.element.classList.add("fn__none"),n.stopPropagation();const o=t.toolbar.range;if(!oe(o.startContainer))return;const s=j(o.startContainer,"data-type","inline-memo");if(s&&s.textContent===o.toString()){t.toolbar.showRender(t,s);return}o.toString()!==""&&t.toolbar.setInlineMark(t,"inline-memo","range",{type:"inline-memo"})}))}}const Rd=(e,t,a)=>{e.addEventListener("mousedown",n=>{const o=hasClosestByClassName(t,"b3-dialog__body")||hasClosestByClassName(t,"protyle-util");if(!o)return;o.style.userSelect="none",o.style.pointerEvents="none";const i=document;i.ondragstart=()=>!1;const s=n.clientX,l=t.clientWidth,r=o.clientWidth-256;i.onmousemove=c=>{const d=l+(c.clientX-s);d<256||d>r||(t.style.width=d+"px")},i.onmouseup=()=>{o.style.userSelect="auto",o.style.pointerEvents="",i.onmousemove=null,i.onmouseup=null,i.ondragstart=null,i.onselectstart=null,i.onselect=null,a&&(window.siyuan.storage[Constants.LOCAL_HISTORY][a]=t.clientWidth+"px",setStorageVal(Constants.LOCAL_HISTORY,window.siyuan.storage[Constants.LOCAL_HISTORY]))}})};var xo=(e,t,a)=>new Promise((n,o)=>{var i=r=>{try{l(a.next(r))}catch(c){o(c)}},s=r=>{try{l(a.throw(r))}catch(c){o(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(i,s);l((a=a.apply(e,t)).next())});class Od{constructor(t){const a=t.options,n=document.createElement("div");n.className="protyle-toolbar fn__none",this.element=n,this.subElement=document.createElement("div"),this.subElement.className="protyle-util fn__none protyle-util--mobile",this.toolbarHeight=29,t.app.plugins.forEach(o=>{const i=o.updateProtyleToolbar(a.toolbar);i.forEach(s=>{typeof s=="string"||Constants.INLINE_TYPE.concat("|").includes(s.name)||!s.hotkey||window.siyuan.config.keymap.plugin&&window.siyuan.config.keymap.plugin[o.name]&&window.siyuan.config.keymap.plugin[o.name][s.name]&&(s.hotkey=window.siyuan.config.keymap.plugin[o.name][s.name].custom)}),a.toolbar=toolbarKeyToMenu(i)}),a.toolbar.forEach(o=>{const i=this.genItem(t,o);this.element.appendChild(i)})}update(t){this.element.innerHTML="",t.options.toolbar=toolbarKeyToMenu(Constants.PROTYLE_TOOLBAR),t.app.plugins.forEach(a=>{const n=a.updateProtyleToolbar(t.options.toolbar);n.forEach(o=>{typeof o=="string"||Constants.INLINE_TYPE.concat("|").includes(o.name)||!o.hotkey||window.siyuan.config.keymap.plugin&&window.siyuan.config.keymap.plugin[a.name]&&window.siyuan.config.keymap.plugin[a.name][o.name]&&(o.hotkey=window.siyuan.config.keymap.plugin[a.name][o.name].custom)}),t.options.toolbar=toolbarKeyToMenu(n)}),t.options.toolbar.forEach(a=>{const n=this.genItem(t,a);this.element.appendChild(n)})}render(t,a,n){this.range=a;let o=hasClosestBlock(a.startContainer);if(isMobile()||!o||t.disabled||o.classList.contains("av")){this.element.classList.add("fn__none");return}let i=!1;if(Array.from(a.cloneContents().childNodes).find(u=>{if(u.textContent.length>0&&u.textContent!==Constants.ZWSP&&!(u.nodeType===1&&u.classList.contains("img")))return i=!0,!0}),!i||a.commonAncestorContainer.nodeType!==3&&a.commonAncestorContainer.classList.contains("img")){this.element.classList.add("fn__none");return}const s=hasClosestBlock(a.startContainer),l=hasClosestBlock(a.endContainer);if(s&&l&&!s.isSameNode(l)){if(n)if(n.key==="ArrowLeft")this.range=setLastNodeRange(getContenteditableElement(s),a,!1);else if(n.key==="ArrowRight")this.range=setFirstNodeRange(getContenteditableElement(l),a),this.range.collapse(!1);else if(n.key==="ArrowUp"){if(this.range=setFirstNodeRange(getContenteditableElement(l),a),o=hasClosestBlock(l),!o)return}else n.key==="ArrowDown"&&(this.range=setLastNodeRange(getContenteditableElement(s),a,!1));else this.range=setLastNodeRange(getContenteditableElement(o),a,!1);if(focusByRange(this.range),this.range.toString()===""){this.element.classList.add("fn__none");return}}if(o.getAttribute("data-type")==="NodeCodeBlock"){this.element.classList.add("fn__none");return}const r=getSelectionPosition(o,a);this.element.classList.remove("fn__none"),this.toolbarHeight=this.element.clientHeight;const c=r.top-this.toolbarHeight-4;this.element.setAttribute("data-inity",c+Constants.ZWSP+t.contentElement.scrollTop.toString()),setPosition(this.element,r.left-52,Math.max(c,t.element.getBoundingClientRect().top+30)),this.element.querySelectorAll(".protyle-toolbar__item--current").forEach(u=>{u.classList.remove("protyle-toolbar__item--current")}),this.getCurrentType().forEach(u=>{if(["search-mark","a","block-ref","virtual-block-ref","text","file-annotation-ref","inline-math","inline-memo","","backslash"].includes(u))return;const g=this.element.querySelector(`[data-type="${u}"]`);g&&g.classList.add("protyle-toolbar__item--current")})}getCurrentType(t=this.range){var a,n;let o=[],i=t.startContainer;if(i.nodeType===3?i=i.parentElement:i.childElementCount>0&&((a=i.childNodes[t.startOffset])==null?void 0:a.nodeType)!==3&&(i=i.childNodes[t.startOffset]),!i||i.nodeType===3)return[];["DIV","TD","TH","TR"].includes(i.tagName)||(o=(i.getAttribute("data-type")||"").split(" "));let s=t.endContainer;return s.nodeType===3?s=s.parentElement:s.childElementCount>0&&((n=s.childNodes[t.endOffset])==null?void 0:n.nodeType)!==3&&(s=s.childNodes[t.endOffset]),!s||s.nodeType===3?[]:(!["DIV","TD","TH","TR"].includes(s.tagName)&&!i.isSameNode(s)&&(o=o.concat((s.getAttribute("data-type")||"").split(" "))),t.cloneContents().childNodes.forEach(l=>{l.nodeType!==3&&(o=o.concat((l.getAttribute("data-type")||"").split(" ")))}),o=[...new Set(o)],o.find((l,r)=>{if(l==="")return o.splice(r,1),!0}),o)}setInlineMark(t,a,n,o){var i;const s=hasClosestBlock(this.range.startContainer);if(!s||s.getAttribute("data-type")==="NodeCodeBlock")return;const l=hasClosestBlock(this.range.endContainer);if(!l)return;s.isSameNode(l)||(this.range=setLastNodeRange(getContenteditableElement(s),this.range,!1));const r=this.getCurrentType(this.range);if(r.length===1&&["block-ref","file-annotation-ref","a","inline-memo","inline-math","tag"].includes(r[0])&&a==="clear")return;const c=this.range.toString();fixTableRange(this.range);let d,u,g,f;const p=hasPreviousSibling(this.range.startContainer);["DIV","TD","TH","TR"].includes(this.range.startContainer.parentElement.tagName)?p&&p.nodeType!==3&&this.range.startOffset===0&&(d=p):this.range.startOffset===0&&!p?(d=this.range.startContainer.parentElement.previousSibling,this.range.setStartBefore(this.range.startContainer.parentElement)):d=this.range.startContainer.parentElement;let m=!1;const b=hasNextSibling(this.range.endContainer);["DIV","TD","TH","TR"].includes(this.range.endContainer.parentElement.tagName)?b&&b.nodeType!==3&&this.range.endOffset===this.range.endContainer.textContent.length&&(u=b):this.range.endOffset===this.range.endContainer.textContent.length&&!b?(u=this.range.endContainer.parentElement.nextSibling,this.range.setEndAfter(this.range.endContainer.parentElement),c===""&&(m=!0,this.range.collapse(!1))):u=this.range.endContainer.parentElement,this.range.insertNode(document.createElement("wbr"));const w=s.outerHTML,y=this.range.extractContents();if(this.mergeNode(y.childNodes),d&&u&&d.isSameNode(u)&&((i=y.firstChild)==null?void 0:i.nodeType)===3){const v=d.attributes;y.childNodes.forEach(A=>{const L=document.createElement("span");for(let x=0;x<v.length;x++)L.setAttribute(v[x].name,v[x].value);L.innerHTML=A.textContent,A.replaceWith(L)})}const _=isMobile()?document.querySelector("#keyboardToolbar .keyboard__dynamic").nextElementSibling:this.element,h=n==="toolbar"?_.querySelector(`[data-type="${a}"]`):void 0,E=[];if(a==="clear"||h!=null&&h.classList.contains("protyle-toolbar__item--current")||n==="range"&&r.length>0&&r.includes(a)&&!o){if(a==="clear"?_.querySelectorAll('[data-type="strong"],[data-type="em"],[data-type="u"],[data-type="s"],[data-type="mark"],[data-type="sup"],[data-type="sub"],[data-type="kbd"],[data-type="mark"],[data-type="code"]').forEach(v=>{v.classList.remove("protyle-toolbar__item--current")}):h&&h.classList.remove("protyle-toolbar__item--current"),y.childNodes.length===0)if(r.find((v,A)=>{if(a===v)return r.splice(A,1),!0}),r.length===0||a==="clear")E.push(document.createTextNode(Constants.ZWSP));else{let v=0;for(;v<r.length;)["inline-memo","text","block-ref","file-annotation-ref","a"].includes(r[v])?r.splice(v,1):++v;const A=document.createElement("span");A.setAttribute("data-type",r.join(" ")),A.textContent=Constants.ZWSP,E.push(A)}y.childNodes.forEach((v,A)=>{if(v.nodeType!==3&&v.tagName!=="BR"&&v.tagName!=="IMG"&&!v.classList.contains("img")){if(v.textContent==="")return;const L=(v.getAttribute("data-type")||"").split(" ");if(a==="clear")for(let x=0;x<L.length;x++)o&&o.type==="text"?L[x]==="text"&&(L.splice(x,1),x--):["kbd","text","strong","em","u","s","mark","sup","sub","code"].includes(L[x])&&(L.splice(x,1),x--);else L.find((x,T)=>{if(a===x)return L.splice(T,1),!0});if(L.length===0)v.textContent===""&&(v.textContent=Constants.ZWSP),E.push(document.createTextNode(v.textContent));else{if(c&&a==="clear"&&o&&o.type==="text"&&v.style.color===""&&v.style.webkitTextFillColor===""&&v.style.webkitTextStroke===""&&v.style.textShadow===""&&v.style.backgroundColor===""&&v.style.fontSize==="")return v.setAttribute("data-type",L.join(" ")),E.push(v),!0;a==="clear"&&(v.style.color="",v.style.webkitTextFillColor="",v.style.webkitTextStroke="",v.style.textShadow="",v.style.backgroundColor="",v.style.fontSize=""),A===0&&d&&d.nodeType!==3&&isArrayEqual(L,(d.getAttribute("data-type")||"").split(" "))&&hasSameTextStyle(v,d,o)?(g=d.textContent.length,d.innerHTML=d.innerHTML+v.innerHTML):A===y.childNodes.length-1&&u&&u.nodeType!==3&&isArrayEqual(L,(u.getAttribute("data-type")||"").split(" "))&&hasSameTextStyle(v,u,o)?(f=v.textContent.length,u.innerHTML=v.innerHTML+u.innerHTML):(v.setAttribute("data-type",L.join(" ")),E.push(v))}}else E.push(v)})}else if(!this.element.classList.contains("fn__none")&&a!=="text"&&h&&h.classList.add("protyle-toolbar__item--current"),c===""){const v=document.createElement("span");if(r.push(a),m){let A=0;for(;A<r.length;)["inline-memo","text","block-ref","file-annotation-ref","a"].includes(r[A])?r.splice(A,1):++A}v.setAttribute("data-type",[...new Set(r)].join(" ")),v.textContent=Constants.ZWSP,setFontStyle(v,o),E.push(v)}else{if(a==="block-ref")for(;y.childNodes.length>1;)y.childNodes[0].remove();y.childNodes.forEach((v,A)=>{let L="";if(v.nodeType===3)if(A===0&&d&&d.nodeType!==3&&a===d.getAttribute("data-type")&&hasSameTextStyle(v,d,o))g=d.textContent.length,d.innerHTML=d.innerHTML+v.textContent;else if(A===y.childNodes.length-1&&u&&u.nodeType!==3&&a===u.getAttribute("data-type")&&hasSameTextStyle(v,u,o))f=v.textContent.length,u.innerHTML=v.textContent+u.innerHTML;else if(v.textContent!==Constants.ZWSP||v.textContent===Constants.ZWSP&&!r.includes("img")){for(v.textContent.startsWith(Constants.ZWSP)&&(E.push(document.createTextNode(Constants.ZWSP)),v.textContent=v.textContent.substring(1));v.textContent.endsWith(`
`);)v.textContent=v.textContent.substring(0,v.textContent.length-1),L+=`
`;const x=document.createElement("span");x.setAttribute("data-type",a),x.textContent=v.textContent,setFontStyle(x,o),a==="text"&&!x.getAttribute("style")?E.push(v):E.push(x)}else E.push(v);else{let x=(v.getAttribute("data-type")||"").split(" ");for(let T=0;T<x.length;T++)["backslash","virtual-block-ref","search-mark"].includes(x[T])&&(x.splice(T,1),T--);if(x.includes("img")||x.push(a),(x.includes("code")||x.includes("tag")||x.includes("kbd"))&&!v.textContent.startsWith(Constants.ZWSP)&&v.insertAdjacentText("afterbegin",Constants.ZWSP),a==="sub"&&x.includes("sup")?x.find((T,M)=>{if(T==="sup")return x.splice(M,1),_.querySelector('[data-type="sup"]').classList.remove("protyle-toolbar__item--current"),!0}):a==="sup"&&x.includes("sub")?x.find((T,M)=>{if(T==="sub")return x.splice(M,1),_.querySelector('[data-type="sub"]').classList.remove("protyle-toolbar__item--current"),!0}):a==="block-ref"&&(x.includes("a")||x.includes("file-annotation-ref"))?x.find((T,M)=>{if(T==="a"||T==="file-annotation-ref")return x.splice(M,1),!0}):a==="a"&&(x.includes("block-ref")||x.includes("file-annotation-ref"))?x.find((T,M)=>{if(T==="block-ref"||T==="file-annotation-ref")return x.splice(M,1),!0}):a==="file-annotation-ref"&&(x.includes("block-ref")||x.includes("a"))?x.find((T,M)=>{if(T==="block-ref"||T==="a")return x.splice(M,1),!0}):a==="inline-memo"&&x.includes("inline-math")?(x.find((T,M)=>{if(T==="inline-math")return x.splice(M,1),!0}),v.querySelector(".katex")&&(v.textContent=v.getAttribute("data-content"))):a==="inline-math"&&x.includes("inline-memo")&&x.find((T,M)=>{if(T==="inline-memo")return x.splice(M,1),!0}),x=[...new Set(x)],A===0&&d&&d.nodeType!==3&&isArrayEqual(x,(d.getAttribute("data-type")||"").split(" "))&&hasSameTextStyle(v,d,o))g=d.textContent.length,d.innerHTML=d.innerHTML+v.innerHTML;else if(A===y.childNodes.length-1&&u&&u.nodeType!==3&&isArrayEqual(x,(u.getAttribute("data-type")||"").split(" "))&&hasSameTextStyle(v,u,o))f=v.textContent.length,u.innerHTML=v.innerHTML+u.innerHTML;else if(v.tagName!=="BR"&&v.tagName!=="IMG")if(v.setAttribute("data-type",x.join(" ")),setFontStyle(v,o),x.includes("text")&&!v.getAttribute("style"))if(x.length===1){const T=document.createTextNode(v.textContent);E.push(T)}else x.splice(x.indexOf("text"),1),v.setAttribute("data-type",x.join(" ")),E.push(v);else E.push(v);else E.push(v)}L&&E.push(document.createTextNode(L))})}if(this.range.startContainer.nodeType!==3&&this.range.startContainer.tagName==="SPAN"&&this.range.startContainer.isSameNode(this.range.endContainer)&&!m){const v=this.range.startContainer,A=document.createElement("span"),L=v.attributes;for(let T=0;T<L.length;T++)A.setAttribute(L[T].name,L[T].value);this.range.setEnd(v.lastChild,v.lastChild.textContent.length),A.append(this.range.extractContents()),v.after(A);const x=v.getAttribute("data-type").split(" ");x.includes("code")||x.includes("tag")||x.includes("kbd")?(A.insertAdjacentText("beforebegin",Constants.ZWSP+Constants.ZWSP),A.insertAdjacentText("afterbegin",Constants.ZWSP),this.range.setStart(A.previousSibling,1)):this.range.setStartBefore(A),this.range.collapse(!0)}for(let v=0;v<E.length;v++){const A=E[v],L=E[v+1],x=A.nodeType!==3&&A.getAttribute("data-type")||"";if(A.nodeType!==3&&L&&L.nodeType!==3&&L.tagName===A.tagName&&A.tagName!=="BR"&&isArrayEqual((L.getAttribute("data-type")||"").split(" "),x.split(" "))&&A.getAttribute("data-id")===L.getAttribute("data-id")&&A.getAttribute("data-subtype")===L.getAttribute("data-subtype")&&A.style.color===L.style.color&&A.style.webkitTextFillColor===L.style.webkitTextFillColor&&A.style.webkitTextStroke===L.style.webkitTextStroke&&A.style.textShadow===L.style.textShadow&&A.style.fontSize===L.style.fontSize&&A.style.backgroundColor===L.style.backgroundColor)x.indexOf("inline-math")>-1?L.setAttribute("data-content",A.getAttribute("data-content")+L.getAttribute("data-content")):(L.innerHTML=A.innerHTML+L.innerHTML,x.indexOf("inline-memo")>-1&&L.setAttribute("data-inline-memo-content",(A.getAttribute("data-inline-memo-content")||"")+(L.getAttribute("data-inline-memo-content")||""))),E.splice(v,1),v--;else{if(this.range.insertNode(A),A.nodeType===1&&["code","tag","kbd"].includes(a)){const T=hasPreviousSibling(A);(!T||T.textContent.endsWith(`
`))&&A.before(document.createTextNode(Constants.ZWSP)),A.textContent.startsWith(Constants.ZWSP)||(A.textContent=Constants.ZWSP+A.textContent);const M=hasNextSibling(A);(!M||M&&(M.nodeType!==3||M.nodeType===3&&!M.textContent.startsWith(Constants.ZWSP)))&&A.after(document.createTextNode(Constants.ZWSP))}else if(A.nodeType===3&&["code","tag","kbd","clear"].includes(a)){const T=hasPreviousSibling(A);let M=!1;if(T)if(T.nodeType===1){const N=T.dataset.type.split(" ");(N.includes("code")||N.includes("tag")||N.includes("kbd"))&&(M=!0)}else T.textContent.endsWith(Constants.ZWSP)&&(T.textContent=T.textContent.substring(0,T.textContent.length-1));const I=hasNextSibling(A);let D=!1;if(I)if(I.nodeType===1){const N=I.dataset.type.split(" ");(N.includes("code")||N.includes("tag")||N.includes("kbd"))&&(D=!0)}else I.textContent.startsWith(Constants.ZWSP)&&(I.textContent=I.textContent.substring(1));A&&(M?A.textContent.startsWith(Constants.ZWSP)||(A.textContent=Constants.ZWSP+A.textContent):A.textContent.startsWith(Constants.ZWSP)&&(A.textContent=A.textContent.substring(1)),D?I.textContent.startsWith(Constants.ZWSP)||(I.textContent=Constants.ZWSP+I.textContent):A.textContent.endsWith(Constants.ZWSP)&&(A.textContent=A.textContent.substring(0,A.textContent.length-1)))}this.range.collapse(!1)}}if(d&&(d.nodeType!==3&&d.textContent===Constants.ZWSP?d.remove():this.mergeNode(d.childNodes)),u&&this.mergeNode(u.childNodes),g?this.range.setStart(d.firstChild,g):E.length>0?E[0].nodeType!==3&&E[0].getAttribute("data-type")==="inline-math"||(E[0].firstChild?E[0].firstChild.textContent===Constants.ZWSP?this.range.setStart(E[0].firstChild,1):this.range.setStart(E[0].firstChild,0):E[0].nodeType===3?this.range.setStart(E[0],0):this.range.setStartBefore(E[0])):u&&this.range.setStart(u.firstChild,0),f)this.range.setEnd(u.lastChild,f);else if(E.length>0){const v=E[E.length-1];if(v.nodeType!==3&&v.getAttribute("data-type").indexOf("inline-math")>-1){const A=hasPreviousSibling(v);A&&A.nodeType===3?this.range.setStart(A,A.textContent.length):this.range.setStartBefore(v);const L=hasNextSibling(v);L&&L.nodeType===3?this.range.setEnd(L,0):this.range.setEndAfter(v)}else v.lastChild?v.lastChild.textContent===Constants.ZWSP?this.range.collapse(!0):this.range.setEnd(v.lastChild,v.lastChild.textContent.length):v.nodeType===3?(this.range.setEnd(v,v.textContent.length),v.textContent===Constants.ZWSP&&this.range.collapse(!1)):this.range.setEndAfter(v)}else d&&this.range.setEnd(d.firstChild,d.firstChild.textContent.length);let C=!0;if(a==="inline-math"){if(mathRender(s),c===""){t.toolbar.showRender(t,E[0],void 0,w);return}}else if(a==="inline-memo"){t.toolbar.showRender(t,E[0],E,w);return}else if(a==="block-ref")this.range.collapse(!1);else if(a==="a"){const v=E[0];v.textContent.replace(Constants.ZWSP,"")===""||!v.getAttribute("data-href")?(C=!1,linkMenu(t,v,!!v.getAttribute("data-href"))):this.range.collapse(!1)}s.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(t,s.getAttribute("data-node-id"),s.outerHTML,w);const k=s.querySelector("wbr");k&&k.remove(),C&&focusByRange(this.range)}showRender(t,a,n,o){var i;const s=hasClosestBlock(a);if(!s)return;hideElements(["hint"],t),window.siyuan.menus.menu.remove();const l=s.getAttribute("data-node-id"),r=(a.getAttribute("data-type")||"").split(" "),c=o||s.outerHTML;let d="HTML",u="";const g=r.includes("inline-memo");switch(a.getAttribute("data-subtype")){case"abc":d=window.siyuan.languages.staff;break;case"echarts":d=window.siyuan.languages.chart;break;case"flowchart":d="Flow Chart";break;case"graphviz":d="Graphviz";break;case"mermaid":d="Mermaid";break;case"mindmap":u=`- foo
  - bar
- baz`,d=window.siyuan.languages.mindmap;break;case"plantuml":d="UML";break;case"math":r.includes("NodeMathBlock")?d=window.siyuan.languages.math:d=window.siyuan.languages["inline-math"];break}r.includes("NodeBlockQueryEmbed")?d=window.siyuan.languages.blockEmbed:g&&(d=window.siyuan.languages.memo);const f=((i=this.subElement.querySelector('[data-type="pin"]'))==null?void 0:i.getAttribute("aria-label"))===window.siyuan.languages.unpin,p={};if(f){const h=this.subElement.querySelector(".b3-text-field");p.styleH=h.style.height,p.styleW=h.style.width}else this.subElement.style.width="",this.subElement.style.padding="0";this.subElement.innerHTML=`<div ${f&&this.subElement.firstElementChild.getAttribute("data-drag")==="true"?'data-drag="true"':""}><div class="block__icons block__icons--menu fn__flex" style="border-radius: var(--b3-border-radius-b) var(--b3-border-radius-b) 0 0;">
    <span class="fn__flex-1 resize__move">
        ${d}
    </span>
    <span class="fn__space"></span>
    <button data-type="refresh" class="block__icon block__icon--show b3-tooltips b3-tooltips__nw${f&&!this.subElement.querySelector('[data-type="refresh"]').classList.contains("block__icon--active")?"":" block__icon--active"}${r.includes("NodeBlockQueryEmbed")?" fn__none":""}" aria-label="${window.siyuan.languages.refresh}"><svg><use xlink:href="#iconRefresh"></use></svg></button>
    <span class="fn__space"></span>
    <button data-type="before" class="block__icon block__icon--show b3-tooltips b3-tooltips__nw${t.disabled?" fn__none":""}" aria-label="${window.siyuan.languages["insert-before"]}"><svg><use xlink:href="#iconBefore"></use></svg></button>
    <span class="fn__space${t.disabled?" fn__none":""}"></span>
    <button data-type="after" class="block__icon block__icon--show b3-tooltips b3-tooltips__nw${t.disabled?" fn__none":""}" aria-label="${window.siyuan.languages["insert-after"]}"><svg><use xlink:href="#iconAfter"></use></svg></button>
    <span class="fn__space${t.disabled?" fn__none":""}"></span>
    <button data-type="export" class="block__icon block__icon--show b3-tooltips b3-tooltips__nw" aria-label="${window.siyuan.languages.export} ${window.siyuan.languages.image}"><svg><use xlink:href="#iconImage"></use></svg></button>
    <span class="fn__space"></span>
    <button data-type="pin" class="block__icon block__icon--show b3-tooltips b3-tooltips__nw" aria-label="${f?window.siyuan.languages.unpin:window.siyuan.languages.pin}"><svg><use xlink:href="#icon${f?"Unpin":"Pin"}"></use></svg></button>
    <span class="fn__space"></span>
    <button data-type="close" class="block__icon block__icon--show b3-tooltips b3-tooltips__nw" aria-label="${window.siyuan.languages.close}"><svg style="width: 10px;margin: 0 2px;"><use xlink:href="#iconClose"></use></svg></button>
</div>
<textarea ${t.disabled?" readonly":""} spellcheck="false" class="b3-text-field b3-text-field--text fn__block" placeholder="${u}" style="${isMobile()?"":"width:"+Math.max(480,a.clientWidth*.7)+"px"};max-height:calc(80vh - 44px);min-height: 48px;min-width: 268px;border-radius: 0 0 var(--b3-border-radius-b) var(--b3-border-radius-b);font-family: var(--b3-font-family-code);"></textarea></div>`;const m=()=>{if(y.style.height=y.scrollHeight+"px",isMobile()){setPosition(this.subElement,0,0);return}if(this.subElement.firstElementChild.getAttribute("data-drag")==="true"){y.getBoundingClientRect().bottom>window.innerHeight&&(this.subElement.style.top=window.innerHeight-this.subElement.clientHeight+"px");return}const h=_.bottom===_.top?_.bottom+26:_.bottom;this.subElement.clientHeight<=window.innerHeight-h||this.subElement.clientHeight<=_.top?r.includes("inline-math")||g?setPosition(this.subElement,_.left,h,_.height||26):setPosition(this.subElement,_.left+(_.width-this.subElement.clientWidth)/2,h,_.height||26):setPosition(this.subElement,_.right,h)},b=this.subElement.querySelector(".block__icons");b.addEventListener("click",h=>{const E=h.target,C=hasClosestByClassName(E,"b3-tooltips");if(!C){if(h.detail===2){const k=b.querySelector('[data-type="pin"]');k.getAttribute("aria-label")===window.siyuan.languages.unpin?(k.querySelector("svg use").setAttribute("xlink:href","#iconPin"),k.setAttribute("aria-label",window.siyuan.languages.pin)):(k.querySelector("svg use").setAttribute("xlink:href","#iconUnpin"),k.setAttribute("aria-label",window.siyuan.languages.unpin)),h.preventDefault(),h.stopPropagation()}return}switch(h.stopPropagation(),C.getAttribute("data-type")){case"close":this.subElement.querySelector('[data-type="pin"]').setAttribute("aria-label",window.siyuan.languages.pin),hideElements(["util"],t);break;case"pin":C.getAttribute("aria-label")===window.siyuan.languages.unpin?(C.querySelector("svg use").setAttribute("xlink:href","#iconPin"),C.setAttribute("aria-label",window.siyuan.languages.pin)):(C.querySelector("svg use").setAttribute("xlink:href","#iconUnpin"),C.setAttribute("aria-label",window.siyuan.languages.unpin));break;case"refresh":C.classList.toggle("block__icon--active");break;case"before":insertEmptyBlock(t,"beforebegin",l),hideElements(["util"],t);break;case"after":insertEmptyBlock(t,"afterend",l),hideElements(["util"],t);break;case"export":w();break}});const w=()=>{const h=showMessage(window.siyuan.languages.exporting,0);if(a.getAttribute("data-subtype")==="plantuml"){fetch(a.querySelector("img").getAttribute("src")).then(function(E){return E.blob()}).then(function(E){const C=new FormData;C.append("file",E),C.append("type","image/png"),fetchPost("/api/export/exportAsFile",C,k=>{openByMobile(k.data.file),hideMessage(h)})});return}setTimeout(()=>{addScript("/stage/protyle/js/html2canvas.min.js?v=1.4.1","protyleHtml2canvas").then(()=>{window.html2canvas(a,{useCORS:!0}).then(E=>{E.toBlob(C=>{const k=new FormData;k.append("file",C),k.append("type","image/png"),fetchPost("/api/export/exportAsFile",k,v=>{openByMobile(v.data.file),hideMessage(h)})})})})},Constants.TIMEOUT_LOAD)},y=this.subElement.querySelector(".b3-text-field");r.includes("NodeHTMLBlock")?y.value=Lute.UnEscapeHTMLStr(a.querySelector("protyle-html").getAttribute("data-content")||""):g?y.value=Lute.UnEscapeHTMLStr(a.getAttribute("data-inline-memo-content")||""):y.value=Lute.UnEscapeHTMLStr(a.getAttribute("data-content")||""),y.addEventListener("input",h=>{if(a.parentElement&&(y.clientHeight!==y.scrollHeight&&m(),!!this.subElement.querySelector('[data-type="refresh"]').classList.contains("block__icon--active"))){if(r.includes("NodeHTMLBlock"))a.querySelector("protyle-html").setAttribute("data-content",Lute.EscapeHTMLStr(y.value));else if(g){let E;n?E=n:E=[a],E.forEach(C=>{C.setAttribute("data-inline-memo-content",Lute.EscapeHTMLStr(y.value))})}else a.setAttribute("data-content",Lute.EscapeHTMLStr(y.value)),a.removeAttribute("data-render");(!r.includes("NodeBlockQueryEmbed")||!r.includes("NodeHTMLBlock")||!g)&&processRender(a),h.stopPropagation()}}),y.addEventListener("keydown",h=>{if(h.stopPropagation(),matchHotKey(window.siyuan.config.keymap.editor.insert["inline-math"].custom,h)){h.preventDefault();return}if(!h.isComposing){if(h.key==="Escape"||matchHotKey("\u2318\u21A9",h))this.subElement.querySelector('[data-type="pin"]').setAttribute("aria-label",window.siyuan.languages.pin),hideElements(["util"],t);else if(h.key==="Tab")document.execCommand("insertText",!1,"	"),h.preventDefault();else if(electronUndo(h))return}}),this.subElementCloseCB=()=>{var h;if(!a.parentElement||t.disabled)return;let E;if(r.includes("NodeHTMLBlock")){let C=y.value;C&&(C=C.trim().replace(/\n+/g,`
`),C.startsWith("<div>")&&C.endsWith("</div>")||(C=`<div>
${C}
</div>`)),a.querySelector("protyle-html").setAttribute("data-content",Lute.EscapeHTMLStr(C))}else if(g){let C;n?C=n:C=[a],C.forEach((k,v)=>{if(y.value)k.setAttribute("data-inline-memo-content",Lute.EscapeHTMLStr(y.value));else{const A=k.getAttribute("data-type").split(" ");A.length===1&&A[0]==="inline-memo"?k.outerHTML=k.innerHTML+(v===C.length-1?"<wbr>":""):(A.find((L,x)=>{if(L==="inline-memo")return A.splice(x,1),!0}),k.setAttribute("data-type",A.join(" ")),k.removeAttribute("data-inline-memo-content")),v===C.length-1&&(E=k)}})}else r.includes("inline-math")?y.value?(a.setAttribute("data-content",Lute.EscapeHTMLStr(y.value)),a.removeAttribute("data-render"),processRender(a)):(E=a,a.outerHTML="<wbr>"):(a.setAttribute("data-content",Lute.EscapeHTMLStr(y.value)),a.removeAttribute("data-render"),r.includes("NodeBlockQueryEmbed")?blockRender(t,a):processRender(a));if(getSelection().rangeCount===0||getSelection().rangeCount>0&&hasClosestByClassName(getSelection().getRangeAt(0).startContainer,"protyle-util")?a.tagName==="SPAN"?E?E.parentElement?(this.range.setStartAfter(E),this.range.collapse(!0),focusByRange(this.range)):focusByWbr(s,this.range):a.parentElement&&(this.range.setStartAfter(a),this.range.collapse(!0),focusByRange(this.range)):(focusBlock(a),a.classList.add("protyle-wysiwyg--select")):(h=s.querySelector("wbr"))==null||h.remove(),s.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),r.includes("NodeHTMLBlock")){const C=document.createElement("template");C.innerHTML=t.lute.SpinBlockDOM(s.outerHTML),C.content.childElementCount>1&&showMessage(window.siyuan.languages.htmlBlockTip)}updateTransaction(t,l,s.outerHTML,c)},this.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),this.subElement.classList.remove("fn__none");const _=a.getBoundingClientRect();this.element.classList.add("fn__none"),f?(y.style.width=p.styleW,y.style.height=p.styleH):m(),t.disabled||y.select(),t.app.plugins.forEach(h=>{h.eventBus.emit("open-noneditableblock",{protyle:t,toolbar:this,blockElement:s,renderElement:a})})}showCodeLanguage(t,a){var n,o;const i=hasClosestBlock(a);if(!i)return;hideElements(["hint"],t),window.siyuan.menus.menu.remove(),this.range=getEditorRange(i);const s=i.getAttribute("data-node-id");let l=i.outerHTML,r=`<div class="b3-list-item">${window.siyuan.languages.clear}</div>`;const c=Constants.ALIAS_CODE_LANGUAGES.concat((o=(n=window.hljs)==null?void 0:n.listLanguages())!=null?o:[]).sort();c.forEach((g,f)=>{r+=`<div class="b3-list-item${f===0?" b3-list-item--focus":""}">${g}</div>`}),this.subElement.style.width="",this.subElement.style.padding="",this.subElement.innerHTML=`<div class="fn__flex-column" style="max-height:50vh">
    <input placeholder="${window.siyuan.languages.search}" style="margin: 0 8px 4px 8px" class="b3-text-field"/>
    <div class="b3-list fn__flex-1 b3-list--background" style="position: relative">${r}</div>
</div>`;const d=this.subElement.lastElementChild.lastElementChild,u=this.subElement.querySelector("input");u.addEventListener("keydown",g=>{if(g.stopPropagation(),!g.isComposing){if(upDownHint(d,g),g.key==="Enter"){l=this.updateLanguage(a,t,s,i,l,this.subElement.querySelector(".b3-list-item--focus").textContent),g.preventDefault(),g.stopPropagation();return}g.key==="Escape"&&(this.subElement.classList.add("fn__none"),focusByRange(this.range))}}),u.addEventListener("input",g=>{const f=u.value.toLowerCase(),p=c.filter(w=>w.includes(f));let m="",b=!1;p.sort((w,y)=>w.startsWith(f)&&y.startsWith(f)?w.length<y.length?-1:w.length===y.length?0:1:w.startsWith(f)?-1:y.startsWith(f)?1:0).forEach(w=>{u.value===w&&(b=!0),m+=`<div class="b3-list-item">${w.replace(f,"<b>"+f+"</b>")}</div>`}),u.value.trim()&&!b&&(m=`<div class="b3-list-item"><b>${escapeHtml(u.value.replace(/`| /g,"_"))}</b></div>${m}`),m=`<div class="b3-list-item">${window.siyuan.languages.clear}</div>`+m,d.innerHTML=m,d.firstElementChild.nextElementSibling?d.firstElementChild.nextElementSibling.classList.add("b3-list-item--focus"):d.firstElementChild.classList.add("b3-list-item--focus"),g.stopPropagation()}),d.addEventListener("click",g=>{const f=g.target,p=hasClosestByClassName(f,"b3-list-item");p&&(l=this.updateLanguage(a,t,s,i,l,p.textContent))}),this.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),this.subElement.classList.remove("fn__none"),this.subElementCloseCB=void 0,setPosition(this.subElement,0,0),this.element.classList.add("fn__none"),u.select()}showTpl(t,a,n){this.range=n,hideElements(["hint"],t),window.siyuan.menus.menu.remove(),this.subElement.style.width="",this.subElement.style.padding="",this.subElement.innerHTML=`<div style="max-height:50vh" class="fn__flex">
<div class="fn__flex-column" style="${isMobile()?"width: 100%":"width: 256px"}">
    <div class="fn__flex" style="margin: 0 8px 4px 8px">
        <input class="b3-text-field fn__flex-1"/>
        <span class="fn__space"></span>
        <span data-type="previous" class="block__icon block__icon--show"><svg><use xlink:href="#iconLeft"></use></svg></span>
        <span class="fn__space"></span>
        <span data-type="next" class="block__icon block__icon--show"><svg><use xlink:href="#iconRight"></use></svg></span>
    </div>
    <div class="b3-list fn__flex-1 b3-list--background" style="position: relative"><img style="margin: 0 auto;display: block;width: 64px;height: 64px" src="/stage/loading-pure.svg"></div>
</div>
<div class="toolbarResize" style="    cursor: col-resize;
    box-shadow: 2px 0 0 0 var(--b3-theme-surface) inset, 3px 0 0 0 var(--b3-border-color) inset;
    width: 5px;
    margin-left: -2px;"></div>
<div style="width: 520px;${isMobile()||window.outerWidth<window.outerWidth/2+520?"display:none;":""}overflow: auto;"></div>
</div>`;const o=this.subElement.querySelector(".b3-list");resizeSide(this.subElement.querySelector(".toolbarResize"),o.parentElement);const i=this.subElement.firstElementChild.lastElementChild;let s;o.addEventListener("mouseover",r=>{const c=r.target,d=hasClosestByClassName(c,"b3-list-item");if(!d)return;const u=d.getAttribute("data-value");s!==u&&(s=u,previewTemplate(s,i,t.block.parentID),r.stopPropagation())});const l=this.subElement.querySelector("input");l.addEventListener("keydown",r=>{if(r.stopPropagation(),r.isComposing)return;const c=!this.subElement.querySelector(".b3-list-item");if(!c){const d=upDownHint(o,r);if(d){const u=d.getAttribute("data-value");if(s===u)return;s=u,previewTemplate(s,i,t.block.parentID)}}r.key==="Enter"?(c?focusByRange(this.range):hintRenderTemplate(decodeURIComponent(this.subElement.querySelector(".b3-list-item--focus").getAttribute("data-value")),t,a),this.subElement.classList.add("fn__none"),r.preventDefault()):r.key==="Escape"&&(this.subElement.classList.add("fn__none"),focusByRange(this.range))}),l.addEventListener("input",r=>{r.stopPropagation(),fetchPost("/api/search/searchTemplate",{k:l.value},c=>{var d;let u="";c.data.blocks.forEach((f,p)=>{u+=`<div data-value="${f.path}" class="b3-list-item${p===0?" b3-list-item--focus":""}">${f.content}</div>`}),o.innerHTML=u||`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;const g=(d=c.data.blocks[0])==null?void 0:d.path;s!==g&&(s=g,previewTemplate(s,i,t.block.parentID))})}),this.subElement.lastElementChild.addEventListener("click",r=>{const c=r.target;if(c.classList.contains("b3-list--empty")){this.subElement.classList.add("fn__none"),focusByRange(this.range),r.stopPropagation();return}const d=hasClosestByClassName(c,"b3-list-item__action");if(d&&d.getAttribute("data-type")==="remove"){confirmDialog(window.siyuan.languages.remove,window.siyuan.languages.confirmDelete+"?",()=>{fetchPost("/api/search/removeTemplate",{path:d.parentElement.getAttribute("data-value")},()=>{if(d.parentElement.parentElement.childElementCount===1)d.parentElement.parentElement.innerHTML=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`,previewTemplate("",i,t.block.parentID);else{if(d.parentElement.classList.contains("b3-list-item--focus")){const p=d.parentElement.previousElementSibling||d.parentElement.nextElementSibling;p.classList.add("b3-list-item--focus");const m=p.getAttribute("data-value");if(s===m)return;s=m,previewTemplate(s,i,t.block.parentID)}d.parentElement.remove()}})}),r.stopPropagation();return}if(hasClosestByAttribute(c,"data-type","previous")){l.dispatchEvent(new KeyboardEvent("keydown",{key:"ArrowUp"})),r.stopPropagation();return}if(hasClosestByAttribute(c,"data-type","next")){l.dispatchEvent(new KeyboardEvent("keydown",{key:"ArrowDown"})),r.stopPropagation();return}const f=hasClosestByClassName(c,"b3-list-item");f&&(hintRenderTemplate(decodeURIComponent(f.getAttribute("data-value")),t,a),r.stopPropagation())}),this.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),this.subElement.classList.remove("fn__none"),this.subElementCloseCB=void 0,this.element.classList.add("fn__none"),l.select(),fetchPost("/api/search/searchTemplate",{k:""},r=>{let c="";r.data.blocks.forEach((d,u)=>{c+=`<div data-value="${d.path}" class="b3-list-item--hide-action b3-list-item${u===0?" b3-list-item--focus":""}">
<span class="b3-list-item__text">${d.content}</span>`,c+=`<span data-type="remove" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.remove}">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
</span></div>`}),this.subElement.querySelector(".b3-list--background").innerHTML=c||`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`,setPosition(this.subElement,0,0),s=o.firstElementChild.getAttribute("data-value"),previewTemplate(s,i,t.block.parentID)})}showWidget(t,a,n){this.range=n,hideElements(["hint"],t),window.siyuan.menus.menu.remove(),this.subElement.style.width="",this.subElement.style.padding="",this.subElement.innerHTML=`<div class="fn__flex-column" style="max-height:50vh">
    <input style="margin: 0 8px 4px 8px" class="b3-text-field"/>
    <div class="b3-list fn__flex-1 b3-list--background" style="position: relative"><img style="margin: 0 auto;display: block;width: 64px;height:64px" src="/stage/loading-pure.svg"></div>
</div>`;const o=this.subElement.lastElementChild.lastElementChild,i=this.subElement.querySelector("input");i.addEventListener("keydown",s=>{s.stopPropagation(),!s.isComposing&&(upDownHint(o,s),s.key==="Enter"?(hintRenderWidget(this.subElement.querySelector(".b3-list-item--focus").getAttribute("data-content"),t),this.subElement.classList.add("fn__none"),s.preventDefault()):s.key==="Escape"&&(this.subElement.classList.add("fn__none"),focusByRange(this.range)))}),i.addEventListener("input",s=>{s.stopPropagation(),fetchPost("/api/search/searchWidget",{k:i.value},l=>{let r="";l.data.blocks.forEach((c,d)=>{r+=`<div data-value="${c.path}" data-content="${c.content}" class="b3-list-item${d===0?" b3-list-item--focus":""}">
    ${c.name}
    <span class="b3-list-item__meta">${c.content}</span>
</div>`}),o.innerHTML=r})}),this.subElement.lastElementChild.addEventListener("click",s=>{const l=s.target,r=hasClosestByClassName(l,"b3-list-item");r&&hintRenderWidget(r.dataset.content,t)}),this.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),this.subElement.classList.remove("fn__none"),this.subElementCloseCB=void 0,this.element.classList.add("fn__none"),i.select(),fetchPost("/api/search/searchWidget",{k:""},s=>{let l="";s.data.blocks.forEach((r,c)=>{l+=`<div class="b3-list-item${c===0?" b3-list-item--focus":""}" data-content="${r.content}">
${r.name}
<span class="b3-list-item__meta">${r.content}</span>
</div>`}),this.subElement.querySelector(".b3-list--background").innerHTML=l,setPosition(this.subElement,0,0)})}showContent(t,a,n){var o,i;this.range=a,hideElements(["hint"],t),this.subElement.style.width="auto",this.subElement.style.padding="0 8px";let s="";const l=a.toString()!==""||((i=(o=a.cloneContents().childNodes[0])==null?void 0:o.classList)==null?void 0:i.contains("emoji"));l&&(s+='<button class="keyboard__action" data-action="copy"><svg><use xlink:href="#iconCopy"></use></svg></button>',t.disabled||(s+=`<button class="keyboard__action" data-action="cut"><svg><use xlink:href="#iconCut"></use></svg></button>
<button class="keyboard__action" data-action="delete"><svg><use xlink:href="#iconTrashcan"></use></svg></button>`)),t.disabled||(s+=`<button class="keyboard__action" data-action="paste"><svg><use xlink:href="#iconPaste"></use></svg></button>
<button class="keyboard__action" data-action="select"><svg><use xlink:href="#iconSelect"></use></svg></button>`),(l||!t.disabled)&&(s+='<button class="keyboard__action" data-action="more"><svg><use xlink:href="#iconMore"></use></svg></button>'),this.subElement.innerHTML=`<div class="fn__flex">${s}</div>`,this.subElement.lastElementChild.addEventListener("click",c=>xo(this,null,function*(){const d=hasClosestByClassName(c.target,"keyboard__action");if(!d)return;const u=d.getAttribute("data-action");if(u==="copy")focusByRange(getEditorRange(n)),document.execCommand("copy"),this.subElement.classList.add("fn__none");else if(u==="cut")focusByRange(getEditorRange(n)),document.execCommand("cut"),this.subElement.classList.add("fn__none");else if(u==="delete"){const g=getEditorRange(n);g.insertNode(document.createElement("wbr"));const f=n.outerHTML;g.extractContents(),focusByWbr(n,g),focusByRange(g),updateTransaction(t,n.getAttribute("data-node-id"),n.outerHTML,f),this.subElement.classList.add("fn__none")}else if(u==="paste"){if(document.queryCommandSupported("paste"))document.execCommand("paste");else try{const g=yield readClipboard();paste(t,Object.assign(g,{target:n}))}catch(g){console.log(g)}this.subElement.classList.add("fn__none")}else u==="select"?(selectAll(t,n,a),this.subElement.classList.add("fn__none")):u==="copyPlainText"?(focusByRange(getEditorRange(n)),copyPlainText(getSelection().getRangeAt(0).toString()),this.subElement.classList.add("fn__none")):u==="pasteAsPlainText"?(focusByRange(getEditorRange(n)),pasteAsPlainText(t),this.subElement.classList.add("fn__none")):u==="pasteEscaped"?(pasteEscaped(t,n),this.subElement.classList.add("fn__none")):u==="back"?this.subElement.lastElementChild.innerHTML=s:u==="more"&&(this.subElement.lastElementChild.innerHTML=`<button class="keyboard__action${l?"":" fn__none"}" data-action="copyPlainText"><span>${window.siyuan.languages.copyPlainText}</span></button>
<div class="keyboard__split${l?"":" fn__none"}"></div>
<button class="keyboard__action${t.disabled?" fn__none":""}" data-action="pasteAsPlainText"><span>${window.siyuan.languages.pasteAsPlainText}</span></button>
<div class="keyboard__split${t.disabled?" fn__none":""}"></div>
<button class="keyboard__action${t.disabled?" fn__none":""}" data-action="pasteEscaped"><span>${window.siyuan.languages.pasteEscaped}</span></button>
<div class="keyboard__split${t.disabled?" fn__none":""}"></div>
<button class="keyboard__action" data-action="back"><svg><use xlink:href="#iconBack"></use></svg></button>`,setPosition(this.subElement,r.left,r.top+28,Constants.SIZE_TOOLBAR_HEIGHT))})),this.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),this.subElement.classList.remove("fn__none"),this.subElementCloseCB=void 0,this.element.classList.add("fn__none");const r=getSelectionPosition(n,a);setPosition(this.subElement,r.left,r.top-48,Constants.SIZE_TOOLBAR_HEIGHT)}genItem(t,a){let n;switch(a.name){case"strong":case"em":case"s":case"code":case"mark":case"tag":case"u":case"sup":case"clear":case"sub":case"kbd":n=new ToolbarItem(t,a);break;case"block-ref":n=new BlockRef(t,a);break;case"inline-math":n=new InlineMath(t,a);break;case"inline-memo":n=new InlineMemo(t,a);break;case"|":n=new Divider;break;case"text":n=new Font(t,a);break;case"a":n=new Link(t,a);break;default:n=new ToolbarItem(t,a);break}if(n)return n.element}mergeNode(t){for(let a=0;a<t.length;a++)t[a].nodeType!==3&&t[a].tagName==="WBR"&&(t[a].remove(),a--);for(let a=0;a<t.length;a++)t[a].nodeType===3&&(t[a].textContent===""?(t[a].remove(),a--):t[a+1]&&t[a+1].nodeType===3&&(t[a].textContent=t[a].textContent+t[a+1].textContent,t[a+1].remove(),a--))}updateLanguage(t,a,n,o,i,s){t.textContent=s===window.siyuan.languages.clear?"":s,Constants.SIYUAN_RENDER_CODE_LANGUAGES.includes(t.textContent)||(window.siyuan.storage[Constants.LOCAL_CODELANG]=t.textContent,setStorageVal(Constants.LOCAL_CODELANG,window.siyuan.storage[Constants.LOCAL_CODELANG]));const l=getContenteditableElement(o);return Constants.SIYUAN_RENDER_CODE_LANGUAGES.includes(t.textContent)?(o.dataset.content=l.textContent.trim(),o.dataset.subtype=t.textContent,o.className="render-node",o.innerHTML=`<div spin="1"></div><div class="protyle-attr" contenteditable="false">${Constants.ZWSP}</div>`,processRender(o)):(l.textContent=l.textContent,l.parentElement.removeAttribute("data-render"),highlightRender(o)),o.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(a,n,o.outerHTML,i),this.subElement.classList.add("fn__none"),focusByRange(this.range),o.outerHTML}}const qd=(e,t,a,n,o)=>{let i=1,s;fetchPost(`/api/riff/get${n}RiffCards`,{id:t,page:i},l=>{var r;const c=new Dialog({positionId:Constants.DIALOG_VIEWCARDS,content:`<div class="fn__flex-column" style="height: 100%">
    <div class="block__icons">
        <span class="fn__flex-1 fn__flex-center resize__move">${escapeHtml(a)}</span>
        <span class="fn__space"></span>
        <span data-type="resetAll" class="block__icon block__icon--show b3-tooltips b3-tooltips__w${n===""&&t===""?" fn__none":""}" aria-label="${window.siyuan.languages.reset}"><svg><use xlink:href='#iconUndo'></use></svg></span>
        <span class="fn__space"></span>
        <span data-type="previous" class="block__icon block__icon--show b3-tooltips b3-tooltips__w" disabled="disabled" aria-label="${window.siyuan.languages.previousLabel}"><svg><use xlink:href='#iconLeft'></use></svg></span>
        <span class="fn__space"></span>
        <span data-type="next" class="block__icon block__icon--show b3-tooltips b3-tooltips__w" disabled="disabled" aria-label="${window.siyuan.languages.nextLabel}"><svg><use xlink:href='#iconRight'></use></svg></span>
        <span class="fn__space"></span>
        <span class="fn__flex-center ft__on-surface">${i}/${l.data.pageCount||1}</span>
        <span class="fn__space"></span>
        <span class="counter">${l.data.total}</span>
        ${isMobile()?`<span class="fn__space"></span>
<div data-type="close" class="block__icon block__icon--show">
    <svg><use xlink:href="#iconCloseRound"></use></svg>
</div>`:""}
    </div>
    <div class="${isMobile()?"fn__flex-column":"fn__flex"} fn__flex-1" style="min-height: auto">
        <ul class="fn__flex-1 b3-list b3-list--background" style="user-select: none">
            ${nn(l.data.blocks,a,n)}
        </ul>
        <div id="cardPreview" style="border-bottom-right-radius:var(--b3-border-radius-b);" class="fn__flex-1 fn__none"></div>
        <div class="fn__flex-1 card__empty">${window.siyuan.languages.emptyContent}</div>
    </div>
</div>`,width:isMobile()?"100vw":"80vw",height:isMobile()?"100vh":"70vh",destroyCallback(){s&&(s.destroy(),window.siyuan.mobile&&(window.siyuan.mobile.popEditor=null))},resizeCallback(f){f!=="d"&&f!=="t"&&s&&s.resize()}});l.data.blocks.length>0&&(s=new Protyle(e,c.element.querySelector("#cardPreview"),{blockId:"",render:{gutter:!0,breadcrumbDocName:!0}}),window.siyuan.mobile&&(window.siyuan.mobile.popEditor=s),c.editors={card:s},s.resize(),gt(s,(r=c.element.querySelector(".b3-list-item--focus"))==null?void 0:r.getAttribute("data-id")));const d=c.element.querySelector('[data-type="previous"]'),u=c.element.querySelector('[data-type="next"]'),g=c.element.querySelector(".b3-list--background");l.data.pageCount>1&&u.removeAttribute("disabled"),c.element.setAttribute("data-key",Constants.DIALOG_VIEWCARDS),c.element.addEventListener("click",f=>{var p;if(typeof f.detail=="string"){let b=g.querySelector(".b3-list-item--focus");if(b){b.classList.remove("b3-list-item--focus"),f.detail==="arrowup"?b=b.previousElementSibling||b.parentElement.lastElementChild:f.detail==="arrowdown"?b=b.nextElementSibling||b.parentElement.firstElementChild:f.detail==="home"?b=b.parentElement.firstElementChild:f.detail==="end"&&(b=b.parentElement.lastElementChild);const w=b.getBoundingClientRect(),y=b.parentElement.getBoundingClientRect();(w.top<y.top||w.bottom>y.bottom)&&b.scrollIntoView(w.top<y.top),gt(s,b.getAttribute("data-id")),b.classList.add("b3-list-item--focus")}f.stopPropagation(),f.preventDefault();return}let m=f.target;for(;m&&!c.element.isSameNode(m);){const b=m.getAttribute("data-type");if(b==="close"){c.destroy(),f.stopPropagation(),f.preventDefault();break}else if(b==="previous"){if(i<=1)return;i--,i<=1&&d.setAttribute("disabled","disabled"),fetchPost(`/api/riff/get${n}RiffCards`,{id:t,page:i},w=>{var y;i===w.data.pageCount?u.setAttribute("disabled","disabled"):w.data.pageCount>1&&u.removeAttribute("disabled"),u.nextElementSibling.nextElementSibling.textContent=`${i}/${w.data.pageCount||1}`,g.innerHTML=nn(w.data.blocks,a,n),g.scrollTop=0,gt(s,(y=c.element.querySelector(".b3-list-item--focus"))==null?void 0:y.getAttribute("data-id"))}),f.stopPropagation(),f.preventDefault();break}else if(b==="next"){if(i>=l.data.pageCount)return;i++,d.removeAttribute("disabled"),fetchPost(`/api/riff/get${n}RiffCards`,{id:t,page:i},w=>{var y;i===w.data.pageCount?u.setAttribute("disabled","disabled"):w.data.pageCount>1&&u.removeAttribute("disabled"),u.nextElementSibling.nextElementSibling.textContent=`${i}/${w.data.pageCount||1}`,g.innerHTML=nn(w.data.blocks,a,n),g.scrollTop=0,gt(s,(y=c.element.querySelector(".b3-list-item--focus"))==null?void 0:y.getAttribute("data-id"))}),f.stopPropagation(),f.preventDefault();break}else if(b==="reset"){fetchPost("/api/riff/resetRiffCards",{type:n===""?"deck":n.toLowerCase(),deckID:n===""?t:Constants.QUICK_DECK_ID,id:t,blockIDs:[m.getAttribute("data-id")]},()=>{m.parentElement.querySelector(".ariaLabel.b3-list-item__meta").textContent=dayjs().format("YYYY-MM-DD")}),f.stopPropagation(),f.preventDefault();break}else if(b==="resetAll"){confirmDialog(window.siyuan.languages.reset,window.siyuan.languages.resetCardTip.replace("${x}",c.element.querySelector(".counter").textContent),()=>{fetchPost("/api/riff/resetRiffCards",{type:n===""?"deck":n.toLowerCase(),deckID:n===""?t:Constants.QUICK_DECK_ID,id:t},()=>{c.element.querySelectorAll(".ariaLabel.b3-list-item__meta").forEach(w=>{w.textContent=dayjs().format("YYYY-MM-DD")})})}),f.stopPropagation(),f.preventDefault();break}else if(b==="card-item"){gt(s,m.getAttribute("data-id")),(p=g.querySelector(".b3-list-item--focus"))==null||p.classList.remove("b3-list-item--focus"),m.classList.add("b3-list-item--focus"),f.stopPropagation(),f.preventDefault();break}else if(b==="remove"){fetchPost("/api/riff/removeRiffCards",{deckID:n===""?t:Constants.QUICK_DECK_ID,blockIDs:[m.getAttribute("data-id")]},w=>{var y;let _=m.parentElement.nextElementSibling;_||(_=m.parentElement.previousElementSibling),!_&&m.parentElement.parentElement.childElementCount>1&&(_=m.parentElement.parentElement.firstElementChild),_?(gt(s,_.getAttribute("data-id")),(y=g.querySelector(".b3-list-item--focus"))==null||y.classList.remove("b3-list-item--focus"),_.classList.add("b3-list-item--focus"),m.parentElement.remove()):(gt(s,""),g.innerHTML=`<div class="b3-list--empty">${window.siyuan.languages.emptyContent}</div>`),c.element.querySelector(".counter").textContent=(parseInt(c.element.querySelector(".counter").textContent)-1).toString(),o&&o(w)}),f.stopPropagation(),f.preventDefault();break}m=m.parentElement}})})},nn=(e,t,a)=>{let n="",o=!0;const i=t.split("/");return i.splice(0,1),e.forEach(s=>{var l,r,c,d;if(s.type){let u;a===""?u=getNotebookName(s.box)+getDisplayName(Lute.UnEscapeHTMLStr(s.hPath),!1):(u=getDisplayName(Lute.UnEscapeHTMLStr(s.hPath),!1).replace("/"+i.join("/"),""),u.startsWith("/")&&(u=u.substring(1))),n+=`<div data-type="card-item" class="b3-list-item${o?" b3-list-item--focus":""}${isMobile()?"":" b3-list-item--hide-action"}" data-id="${s.id}">
<svg class="b3-list-item__graphic"><use xlink:href="#${getIconByType(s.type)}"></use></svg>
${unicode2Emoji(s.ial.icon,"b3-list-item__graphic",!0)}
<span class="b3-list-item__text">${s.content||Constants.ZWSP}</span>
<span class="${isMobile()||!u?"fn__none ":""}b3-list-item__meta b3-list-item__meta--ellipsis" title="${escapeAttr(u)}">${escapeHtml(u)}</span>
<span data-position="parentE" aria-label="${window.siyuan.languages.revisionCount}" class="ariaLabel counter${((l=s.riffCard)==null?void 0:l.reps)===0?" fn__none":""}">${(r=s.riffCard)==null?void 0:r.reps}</span>
<span data-position="parentE" aria-label="${window.siyuan.languages.nextDue}" class="ariaLabel b3-list-item__meta${(c=s.riffCard)!=null&&c.due?"":" fn__none"}">${dayjs((d=s.riffCard)==null?void 0:d.due).format("YYYY-MM-DD")}</span>
<span data-position="parentE" data-type="reset" data-id="${s.id}" class="b3-list-item__action ariaLabel" aria-label="${window.siyuan.languages.reset}">
    <svg><use xlink:href="#iconUndo"></use></svg>
</span>
<span data-position="parentE" data-type="remove" data-id="${s.id}" class="b3-list-item__action b3-list-item__action--warning ariaLabel" aria-label="${window.siyuan.languages.removeDeck}">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
</span>
</div>`,o=!1}else n+=`<div data-type="card-item" class="b3-list-item${isMobile()?"":" b3-list-item--hide-action"}">
<span class="b3-list-item__text">${s.content}</span>
<span data-position="parentE" data-type="remove" data-id="${s.id}" class="b3-list-item__action b3-list-item__action--warning ariaLabel" aria-label="${window.siyuan.languages.removeDeck}">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
</span>
</div>`}),e.length===0&&(n=`<div class="b3-list--empty">${window.siyuan.languages.emptyContent}</div>`),n},gt=(e,t)=>{if(!t){e.protyle.element.classList.add("fn__none"),e.protyle.element.nextElementSibling.classList.remove("fn__none");return}e.protyle.element.classList.remove("fn__none"),e.protyle.element.nextElementSibling.classList.add("fn__none"),e.protyle.scroll.lastScrollTop=0,addLoading(e.protyle),fetchPost("/api/block/getDocInfo",{id:t},a=>{e.protyle.wysiwyg.renderCustom(a.data.ial),fetchPost("/api/filetree/getDoc",{id:t,mode:0,size:Constants.SIZE_GET_MAX},n=>{onGet({updateReadonly:!0,data:n,protyle:e.protyle,action:n.data.rootID===n.data.id?[Constants.CB_GET_HTML]:[Constants.CB_GET_ALL,Constants.CB_GET_HTML]})})})},Rt=e=>`<li data-id="${e.id}" data-name="${escapeAttr(e.name)}" class="b3-list-item b3-list-item--narrow${isMobile()?"":" b3-list-item--hide-action"}">
<span class="b3-list-item__text">
    <span>${escapeHtml(e.name)}</span>
    <span class="b3-list-item__meta">${e.size}</span>
</span>
<span data-type="rename" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.rename}">
    <svg><use xlink:href="#iconEdit"></use></svg>
</span>
<span data-type="delete" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.delete}">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
</span>
<span data-type="view" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.cardPreview}">
    <svg><use xlink:href="#iconEye"></use></svg>
</span>
<span data-type="remove" class="b3-list-item__action b3-list-item__action--warning b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.removeDeck}">
    <svg><use xlink:href="#iconMin"></use></svg>
</span>
<span data-type="add" style="display: flex" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.addDeck}">
    <svg><use xlink:href="#iconAdd"></use></svg>
</span>
<span class="b3-list-item__meta${isMobile()?" fn__none":""}">${e.updated}</span>
</li>`,Ud=(e,t)=>{window.siyuan.dialogs.find(a=>{if(a.element.getAttribute("data-key")===Constants.DIALOG_MAKECARD)return hideElements(["dialog"]),!0}),fetchPost("/api/riff/getRiffDecks",{},a=>{let n="";a.data.forEach(i=>{n+=Rt(i)});const o=new Dialog({positionId:Constants.DIALOG_MAKECARD,width:isMobile()?"92vw":"50vw",height:"70vh",title:window.siyuan.languages.riffCard,content:`<div class="b3-dialog__content fn__flex-column" style="box-sizing: border-box;height: 100%">
    <div class="fn__flex">
        <input class="b3-text-field fn__flex-1">
        <span class="fn__space"></span>
        <span data-type="create" class="block__icon block__icon--show b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.createDeck}">
            <svg><use xlink:href="#iconAdd"></use></svg>
        </span>
        <span class="fn__space"></span>
        <span data-type="viewall" class="block__icon block__icon--show b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.cardPreview}">
            <svg><use xlink:href="#iconEye"></use></svg>
        </span>
    </div>
    <div class="fn__hr"></div>
    <ul class="b3-list b3-list--background fn__flex-1">${n}</ul>
</div>`});o.element.setAttribute("data-key",Constants.DIALOG_MAKECARD),o.element.addEventListener("click",i=>{let s=i.target;for(;s&&!s.isSameNode(o.element);){const l=s.getAttribute("data-type");if(l==="create"){let r="";const c=o.element.querySelector(".b3-text-field");c.value?(r&&hideMessage(r),fetchPost("/api/riff/createRiffDeck",{name:c.value},d=>{o.element.querySelector(".b3-list").insertAdjacentHTML("afterbegin",Rt(d.data)),c.value=""})):(r=showMessage(window.siyuan.languages._kernel[142]),c.focus()),i.stopPropagation(),i.preventDefault();break}else if(l==="add"){fetchPost("/api/riff/addRiffCards",{deckID:s.parentElement.getAttribute("data-id"),blockIDs:t},r=>{s.parentElement.outerHTML=Rt(r.data)}),i.stopPropagation(),i.preventDefault();break}else if(l==="remove"){fetchPost("/api/riff/removeRiffCards",{deckID:s.parentElement.getAttribute("data-id"),blockIDs:t},r=>{s.parentElement.outerHTML=Rt(r.data)}),i.stopPropagation(),i.preventDefault();break}else if(l==="delete"){confirmDialog(window.siyuan.languages.deleteOpConfirm,`${window.siyuan.languages.confirmDelete} <b>${escapeHtml(s.parentElement.getAttribute("data-name"))}</b>?`,()=>{fetchPost("/api/riff/removeRiffDeck",{deckID:s.parentElement.getAttribute("data-id")},()=>{s.parentElement.remove()})},void 0,!0),i.stopPropagation(),i.preventDefault();break}else if(l==="view"){viewCards(e,s.parentElement.getAttribute("data-id"),s.parentElement.getAttribute("data-name"),"",r=>{s.parentElement.outerHTML=Rt(r.data)}),i.stopPropagation(),i.preventDefault();break}else if(l==="viewall"){viewCards(e,"",window.siyuan.languages.all,""),i.stopPropagation(),i.preventDefault();break}else if(l==="rename"){const r=new Dialog({title:window.siyuan.languages.rename,content:`<div class="b3-dialog__content"><input class="b3-text-field fn__block" value=""></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px"}),c=r.element.querySelector("input"),d=r.element.querySelectorAll(".b3-button");r.bindInput(c,()=>{d[1].click()}),c.value=s.parentElement.getAttribute("data-name"),c.focus(),c.select(),d[0].addEventListener("click",()=>{r.destroy()}),d[1].addEventListener("click",()=>{fetchPost("/api/riff/renameRiffDeck",{name:c.value,deckID:s.parentElement.getAttribute("data-id")},()=>{s.parentElement.querySelector(".b3-list-item__text span").textContent=c.value,s.parentElement.setAttribute("data-name",c.value)}),r.destroy()}),i.stopPropagation(),i.preventDefault();break}s=s.parentElement}})})},Fd=(e,t)=>{let a=!0;const n=[];t.forEach(o=>{o.getAttribute("data-type")!=="NodeThematicBreak"&&(o.classList.remove("protyle-wysiwyg--select"),n.push(o.getAttribute("data-node-id")),(o.getAttribute(Constants.CUSTOM_RIFF_DECKS)||"").indexOf(Constants.QUICK_DECK_ID)===-1&&(a=!1))}),a?transaction(e,[{action:"removeFlashcards",deckID:Constants.QUICK_DECK_ID,blockIDs:n}],[{action:"addFlashcards",deckID:Constants.QUICK_DECK_ID,blockIDs:n}]):transaction(e,[{action:"addFlashcards",deckID:Constants.QUICK_DECK_ID,blockIDs:n}],[{action:"removeFlashcards",deckID:Constants.QUICK_DECK_ID,blockIDs:n}])},Yd=e=>{window.siyuan.menus.menu.append(new MenuItem({id:"transferBlockRef",label:window.siyuan.languages.transferBlockRef,icon:"iconScrollHoriz",click(){const t=new Dialog({title:window.siyuan.languages.transferBlockRef,content:`<div class="b3-dialog__content">
    <input class="b3-text-field fn__block" placeholder="${window.siyuan.languages.targetBlockID}">
    <div class="b3-label__text">${window.siyuan.languages.transferBlockRefTip}</div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px"});t.element.setAttribute("data-key",Constants.DIALOG_TRANSFERBLOCKREF);const a=t.element.querySelector("input"),n=t.element.querySelectorAll(".b3-button");t.bindInput(a,()=>{n[1].click()}),a.focus(),n[0].addEventListener("click",()=>{t.destroy()}),n[1].addEventListener("click",()=>{fetchPost("/api/block/transferBlockRef",{fromID:e,toID:a.value}),t.destroy()})}}).element)},sn=(e,t,a,n=!0,o)=>{fetchPost("/api/av/searchAttributeView",{keyword:t,excludes:n&&a?[a]:void 0},i=>{let s="";i.data.results.forEach((l,r)=>{s+=`<div class="b3-list-item b3-list-item--narrow${r===0?" b3-list-item--focus":""}" data-av-id="${l.avID}" data-block-id="${l.blockID}">
    <div class="b3-list-item--two fn__flex-1">
        <div class="b3-list-item__first">
            <span class="b3-list-item__text">${escapeHtml(l.avName||window.siyuan.languages.title)}</span>
        </div>
        <div class="b3-list-item__meta b3-list-item__showall">${escapeGreat(l.hPath)}</div>
    </div>
    <svg aria-label="${window.siyuan.languages.thisDatabase}" style="margin: 0 0 0 4px" class="b3-list-item__hinticon ariaLabel${l.avID===a?"":" fn__none"}"><use xlink:href="#iconInfo"></use></svg>
</div>`}),e.innerHTML=s,o&&o()})},ls=(e,t,a)=>{t.dataset.avId=a.dataset.avId,t.dataset.blockId=a.dataset.blockId,t.querySelector(".b3-menu__accelerator").textContent=a.querySelector(".b3-list-item__hinticon").classList.contains("fn__none")?a.querySelector(".b3-list-item__text").textContent:window.siyuan.languages.thisDatabase;const n=hasClosestByClassName(t,"b3-menu__items");n&&To(n,e,!0)},Wd=(e,t,a,n=!0)=>{window.siyuan.menus.menu.remove();const o=new Menu;o.addItem({iconHTML:"",type:"empty",label:`<div class="fn__flex-column b3-menu__filter">
    <input class="b3-text-field fn__flex-shrink"/>
    <div class="fn__hr"></div>
    <div class="b3-list fn__flex-1 b3-list--background">
        <img style="margin: 0 auto;display: block;width: 64px;height: 64px" src="/stage/loading-pure.svg">
    </div>
</div>`,bind(s){const l=s.querySelector(".b3-list"),r=s.querySelector("input");r.addEventListener("keydown",c=>{if(c.isComposing)return;if(upDownHint(l,c)&&c.stopPropagation(),c.key==="Enter"){c.preventDefault(),c.stopPropagation();const u=l.querySelector(".b3-list-item--focus");a?a(u):ls(e,t,u),window.siyuan.menus.menu.remove()}}),r.addEventListener("input",c=>{c.stopPropagation(),!c.isComposing&&sn(l,r.value,e,n)}),r.addEventListener("compositionend",()=>{sn(l,r.value,e,n)}),s.lastElementChild.addEventListener("click",c=>{const d=hasClosestByClassName(c.target,"b3-list-item");d&&(c.stopPropagation(),a?a(d):ls(e,t,d),window.siyuan.menus.menu.remove())}),sn(l,"",e,n,()=>{const c=t.getBoundingClientRect();o.open({x:c.left,y:c.bottom,h:c.height}),s.querySelector("input").focus()})}}),o.element.querySelector(".b3-menu__items").setAttribute("style","overflow: initial");const i=hasTopClosestByClassName(t,"block__popover",!0);o.element.setAttribute("data-from",i?i.dataset.level+"popover":"app")},jd=e=>{const t=e.avElement.querySelector('input[data-type="colName"]'),n=e.avElement.querySelector('.b3-menu__item[data-type="goSearchAV"]').getAttribute("data-av-id"),o=e.avElement.querySelector(".b3-menu__item").getAttribute("data-col-id");let i;e.colsData.find(l=>{if(l.id===o)return l.relation||(l.relation={}),i=l,!0});const s=e.avElement.querySelector('[data-type="name"]').value;transaction(e.protyle,[{action:"updateAttrViewColRelation",avID:e.avID,keyID:o,id:n||i.relation.avID,backRelationKeyID:i.relation.avID===n&&i.relation.backKeyID||Lute.NewNodeID(),isTwoWay:e.avElement.querySelector(".b3-switch").checked,name:t.value,format:s}],[{action:"updateAttrViewColRelation",avID:e.avID,keyID:o,id:i.relation.avID||n,backRelationKeyID:i.relation.backKeyID,isTwoWay:i.relation.isTwoWay,name:t.dataset.oldValue,format:i.name}]),e.avElement.remove(),updateAttrViewCellAnimation(e.blockElement.querySelector(`.av__row--header .av__cell[data-col-id="${o}"]`),void 0,{name:s}),focusBlock(e.blockElement)},To=(e,t,a=!1)=>{const n=e.querySelector('.b3-menu__item[data-type="goSearchAV"]'),o=n.nextElementSibling,i=o.querySelector(".b3-switch"),s=o.nextElementSibling,l=s.nextElementSibling,r=JSON.parse(n.dataset.oldValue);if(r.avID){const c=s.querySelector("input");a&&(n.dataset.avId!==r.avID?(c.value="",i.checked=!1):(c.value=c.dataset.oldValue,i.checked=r.isTwoWay)),i.checked?s.classList.remove("fn__none"):s.classList.add("fn__none"),n.dataset.avId&&r.avID!==n.dataset.avId||r.isTwoWay!==i.checked||c.dataset.oldValue!==c.value?l.classList.remove("fn__none"):l.classList.add("fn__none")}else n.dataset.avId&&(i.checked?s.classList.remove("fn__none"):s.classList.add("fn__none"),l.classList.remove("fn__none"))},Oe=(e,t,a,n)=>{if(e==="selected")return`<svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>
<span class="b3-menu__label fn__ellipsis ${a?"":" popover__block"}" ${a?"":'style="color:var(--b3-protyle-inline-blockref-color)"'} data-id="${t}">${n}</span>
<svg class="b3-menu__action"><use xlink:href="#iconMin"></use></svg>`;if(e==="empty")return t?`<button class="b3-menu__item" data-type="setRelationCell">
    <span class="b3-menu__label fn__ellipsis">${window.siyuan.languages.newRowInRelation.replace("${x}",n).replace("${y}",t)}</span>
</button>`:`<button class="b3-menu__item">
    <span class="b3-menu__label">${window.siyuan.languages.emptyContent}</span>
</button>`;if(e=="unselect")return`<button data-id="${t}" class="b3-menu__item ariaLabel" data-position="west" data-type="setRelationCell">
    <span class="b3-menu__label fn__ellipsis${a?"":" popover__block"}" ${a?"":'style="color:var(--b3-protyle-inline-blockref-color)"'} data-id="${t}">${n}</span>
    <svg class="b3-menu__action"><use xlink:href="#iconAdd"></use></svg>
</button>`},rs=(e,t,a)=>{fetchPost("/api/av/getAttributeViewPrimaryKeyValues",{id:e.firstElementChild.getAttribute("data-av-id"),keyword:a},n=>{const o=n.data.rows.values||[];let i="",s="";const l=[];t.querySelectorAll(".av__cell--relation").forEach(r=>{const c=r.querySelector(".av__celltext");l.push(c.dataset.id),s+=`<button data-id="${c.dataset.id}" data-position="west" data-type="setRelationCell" 
class="b3-menu__item ariaLabel${c.textContent.indexOf(a)>-1?"":" fn__none"}" 
draggable="true">${Oe("selected",c.dataset.id,!c.classList.contains("av__celltext--ref"),Lute.EscapeHTMLStr(c.textContent||window.siyuan.languages.untitled))}</button>`}),o.forEach(r=>{l.includes(r.block.id)||(i+=Oe("unselect",r.block.id,r.isDetached,Lute.EscapeHTMLStr(r.block.content||window.siyuan.languages.untitled)))}),e.querySelector(".b3-menu__items").innerHTML=`${s}
<button class="b3-menu__separator"></button>
${i}
${a?Oe("empty",Lute.EscapeHTMLStr(a),void 0,e.querySelector(".popover__block").outerHTML):i?"":Oe("empty")}`,e.querySelector(".b3-menu__items .b3-menu__item:not(.fn__none)").classList.add("b3-menu__item--current")})},Vd=e=>{fetchPost("/api/av/getAttributeViewPrimaryKeyValues",{id:e.menuElement.firstElementChild.getAttribute("data-av-id"),keyword:""},t=>{const a=t.data.rows.values||[];let n="",o="";const i=[];e.cellElements[0].querySelectorAll(".av__cell--relation").forEach(d=>{const u=d.querySelector(".av__celltext");i.push(u.dataset.id),o+=`<button data-id="${u.dataset.id}" data-position="west" data-type="setRelationCell" class="b3-menu__item ariaLabel" 
draggable="true">${Oe("selected",u.dataset.id,!u.classList.contains("av__celltext--ref"),Lute.EscapeHTMLStr(u.textContent||window.siyuan.languages.untitled))}</button>`}),a.forEach(d=>{i.includes(d.block.id)||(n+=Oe("unselect",d.block.id,d.isDetached,Lute.EscapeHTMLStr(d.block.content||window.siyuan.languages.untitled)))}),e.menuElement.querySelector(".b3-menu__items").innerHTML=`${o}
<button class="b3-menu__separator"></button>
${n||Oe("empty")}`;const s=e.cellElements[e.cellElements.length-1].getBoundingClientRect();setPosition(e.menuElement,s.left,s.bottom,s.height),e.menuElement.querySelector(".b3-menu__items .b3-menu__item:not(.fn__none)").classList.add("b3-menu__item--current");const l=e.menuElement.querySelector("input");l.focus();const r=l.parentElement.querySelector(".popover__block");r.innerHTML=Lute.EscapeHTMLStr(t.data.name),r.setAttribute("data-id",t.data.blockIDs[0]);const c=e.menuElement.querySelector(".b3-menu__items");l.addEventListener("keydown",d=>{if(d.isComposing)return;upDownHint(c,d,"b3-menu__item--current");const u=e.menuElement.querySelector(".b3-menu__item--current");d.key==="Enter"&&u&&u.getAttribute("data-type")==="setRelationCell"?(Io(e.protyle,e.blockElement,u,e.cellElements),d.preventDefault(),d.stopPropagation()):d.key==="Escape"&&(e.menuElement.parentElement.remove(),d.preventDefault(),d.stopPropagation())}),l.addEventListener("input",d=>{d.isComposing||(rs(e.menuElement,e.cellElements[0],l.value),d.stopPropagation())}),l.addEventListener("compositionend",d=>{d.stopPropagation(),rs(e.menuElement,e.cellElements[0],l.value)})})},Gd=(e,t)=>{let a;return e.view.columns.find(n=>{if(n.id===t[0].dataset.colId)return a=n.relation,!0}),a&&a.avID?`<div data-av-id="${a.avID}" class="fn__flex-column">
<div class="b3-menu__item" data-type="nobg">
    <input class="b3-text-field fn__flex-1"/>
    <span class="fn__space"></span>
    <span style="color: var(--b3-protyle-inline-blockref-color);" data-id="" class="popover__block fn__pointer"></span>
</div>
<div class="fn__hr"></div>
<div class="b3-menu__items">
    <img style="margin: 0 auto;display: block;width: 64px;height: 64px" src="/stage/loading-pure.svg">
</div>`:""},Io=(e,t,a,n)=>{var o;const i=hasClosestByClassName(a,"b3-menu");if(!i||i.querySelector(".dragover__bottom, .dragover__top"))return;const s=hasClosestByClassName(n[0],"av__row");if(!s)return;t.contains(n[0])||(n[0]=t.querySelector(`.av__row[data-id="${s.dataset.id}"] .av__cell[data-col-id="${n[0].dataset.colId}"]`)||t.querySelector(`.fn__flex-1[data-col-id="${n[0].dataset.colId}"]`));const l={blockIDs:[],contents:[]};if(i.querySelectorAll('[draggable="true"]').forEach(r=>{const c=r.getAttribute("data-id");l.blockIDs.push(c),l.contents.push({type:"block",block:{id:c,content:r.querySelector(".b3-menu__label").textContent},isDetached:!r.querySelector(".popover__block")})}),a.classList.contains("b3-menu__item")){const r=a.getAttribute("data-id"),c=i.querySelector(".b3-menu__separator"),d=i.querySelector("input").value;if(a.getAttribute("draggable")){!c.nextElementSibling.getAttribute("data-id")&&!d&&c.nextElementSibling.remove();const u=l.blockIDs.indexOf(r);l.blockIDs.splice(u,1),l.contents.splice(u,1),c.after(a),a.outerHTML=Oe("unselect",r,!a.querySelector(".popover__block"),Lute.EscapeHTMLStr(a.querySelector(".b3-menu__label").textContent))}else if(r)l.blockIDs.push(r),l.contents.push({type:"block",block:{id:r,content:a.firstElementChild.textContent},isDetached:!a.firstElementChild.getAttribute("style")}),c.before(a),a.outerHTML=`<button data-id="${r}" data-position="west" data-type="setRelationCell" class="b3-menu__item ariaLabel" 
draggable="true">${Oe("selected",r,!a.querySelector(".popover__block"),Lute.EscapeHTMLStr(a.querySelector(".b3-menu__label").textContent))}</button>`,c.nextElementSibling||c.insertAdjacentHTML("afterend",Oe("empty"));else{const u=a.querySelector(".popover__block").getAttribute("data-id"),g=a.querySelector("b").textContent,f=Lute.NewNodeID();transaction(e,[{action:"insertAttrViewBlock",ignoreFillFilter:!0,avID:i.firstElementChild.getAttribute("data-av-id"),srcs:[{id:f,isDetached:!0,content:g}],blockID:u},{action:"doUpdateUpdated",id:u,data:dayjs().format("YYYYMMDDHHmmss")}]),l.blockIDs.push(f),l.contents.push({type:"block",block:{id:f,content:g},isDetached:!0}),c.insertAdjacentHTML("beforebegin",`<button data-id="${f}" data-position="west" data-type="setRelationCell" 
class="b3-menu__item ariaLabel" draggable="true">${Oe("selected",f,!0,Lute.EscapeHTMLStr(g))}</button>`)}(o=i.querySelector(".b3-menu__item--current"))==null||o.classList.remove("b3-menu__item--current"),i.querySelector(".b3-menu__items .b3-menu__item:not(.fn__none)").classList.add("b3-menu__item--current")}updateCellsValue(e,t,l,n)},Kd=e=>{const t=[];e.forEach(a=>{const n=a.getAttribute("data-node-id");n&&t.push({id:n,isDetached:!1})}),t.length>0&&openSearchAV("",e[0],a=>{const n=a.dataset.avId;transaction(void 0,[{action:"insertAttrViewBlock",avID:n,ignoreFillFilter:!0,srcs:t,blockID:a.dataset.blockId},{action:"doUpdateUpdated",id:a.dataset.blockId,data:dayjs().format("YYYYMMDDHHmmss")}])})},zd=(e,t,a)=>{var n,o;if(t&&((o=(n=e.title)==null?void 0:n.editElement)!=null&&o.contains(t.startContainer))||a==="title")openSearchAV("",e.breadcrumb.element,i=>{const s=i.dataset.avId;transaction(e,[{action:"insertAttrViewBlock",avID:s,ignoreFillFilter:!0,srcs:[{id:e.block.rootID,isDetached:!1}],blockID:i.dataset.blockId},{action:"doUpdateUpdated",id:i.dataset.blockId,data:dayjs().format("YYYYMMDDHHmmss")}],[{action:"removeAttrViewBlock",srcIDs:[e.block.rootID],avID:s}]),focusByRange(t)});else{let i;const s=[];if(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").forEach(l=>{i||(i=l),s.push(l.getAttribute("data-node-id"))}),!i){const l=hasClosestBlock(t.startContainer);l&&(i=l,s.push(l.getAttribute("data-node-id")))}i||(i=e.wysiwyg.element,s.push(e.block.rootID)),openSearchAV("",i,l=>{const r=[],c=[];s.forEach(u=>{r.push(u),c.push({id:u,isDetached:!1})});const d=l.dataset.avId;transaction(e,[{action:"insertAttrViewBlock",avID:d,ignoreFillFilter:!0,srcs:c,blockID:l.dataset.blockId},{action:"doUpdateUpdated",id:l.dataset.blockId,data:dayjs().format("YYYYMMDDHHmmss")}],[{action:"removeAttrViewBlock",srcIDs:r,avID:d}]),focusByRange(t)})}};class Zd{constructor(t){isMac()?this.gutterTip=window.siyuan.languages.gutterTip.replace("\u2325\u2192",updateHotkeyTip(window.siyuan.config.keymap.general.enter.custom)):this.gutterTip=window.siyuan.languages.gutterTip.replace("\u2325\u2192",updateHotkeyTip(window.siyuan.config.keymap.general.enter.custom)).replace("\u2318\u2191",updateHotkeyTip(window.siyuan.config.keymap.editor.general.collapse.custom)).replace("\u2325\u2318A",updateHotkeyTip(window.siyuan.config.keymap.editor.general.attr.custom)).replace(/⌘/g,"Ctrl+").replace(/⌥/g,"Alt+").replace(/⇧/g,"Shift+").replace(/⌃/g,"Ctrl+"),t.options.backlinkData&&(this.gutterTip=this.gutterTip.replace(window.siyuan.languages.enter,window.siyuan.languages.openBy)),this.element=document.createElement("div"),this.element.className="protyle-gutters",this.element.addEventListener("dragstart",a=>{hideTooltip(),window.siyuan.menus.menu.remove();const n=a.target.parentElement;let o=[],i=[],s;if(n.dataset.rowId){s=Array.from(t.wysiwyg.element.querySelectorAll(`.av[data-node-id="${n.dataset.nodeId}"]`)).find(c=>{if(!isInEmbedBlock(c))return!0});const r=s.querySelector(`.av__row[data-id="${n.dataset.rowId}"]`);r.classList.add("av__row--select"),r.querySelector(".av__firstcol use").setAttribute("xlink:href","#iconCheck"),updateHeader(r),s.querySelectorAll(".av__row--select:not(.av__row--header)").forEach(c=>{o.push(c.getAttribute("data-id")),i.push(c)})}else{const r=n.getAttribute("data-node-id");i=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));let c=!1;if(i.forEach(d=>{const u=d.getAttribute("data-node-id");u===r&&(c=!0),o.push(u)}),!c){let d;Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${r}"]`)).find(u=>{if(!isInEmbedBlock(u)&&this.isMatchNode(u))return d=u,!0}),d&&(i.forEach(u=>{u.classList.remove("protyle-wysiwyg--select")}),d.classList.add("protyle-wysiwyg--select"),i=[d],o=[r])}}const l=document.createElement("div");l.className=t.wysiwyg.element.className,i.forEach(r=>{if(r.querySelector("iframe")){const c=r.getAttribute("data-type"),d=genEmptyElement();d.classList.add("protyle-wysiwyg--select"),getContenteditableElement(d).innerHTML=`<svg class="svg"><use xlink:href="${n.querySelector("use").getAttribute("xlink:href")}"></use></svg> ${getLangByType(c)}`,l.append(d)}else l.append(processClonePHElement(r.cloneNode(!0)))}),l.setAttribute("style",`position:fixed;opacity:.1;width:${i[0].clientWidth}px;padding:0;`),document.body.append(l),a.dataTransfer.setDragImage(l,0,0),setTimeout(()=>{l.remove()}),n.style.opacity="0.1",window.siyuan.dragElement=s||t.wysiwyg.element,a.dataTransfer.setData(`${Constants.SIYUAN_DROP_GUTTER}${n.getAttribute("data-type")}${Constants.ZWSP}${n.getAttribute("data-subtype")}${Constants.ZWSP}${o}${Constants.ZWSP}${window.siyuan.config.system.workspaceDir}`,t.wysiwyg.element.innerHTML)}),this.element.addEventListener("dragend",()=>{this.element.querySelectorAll("button").forEach(a=>{a.style.opacity=""}),window.siyuan.dragElement=void 0}),this.element.addEventListener("click",a=>{var n;const o=hasClosestByTag(a.target,"BUTTON");if(!o)return;a.preventDefault(),a.stopPropagation(),hideTooltip();const i=o.getAttribute("data-node-id");if(!i){if(o.getAttribute("disabled"))return;o.setAttribute("disabled","disabled");let l;if(Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${(o.previousElementSibling||o.nextElementSibling).getAttribute("data-node-id")}"]`)).find(r=>{if(!isInEmbedBlock(r)&&this.isMatchNode(r))return l=r,!0}),!l)return;if(a.altKey){let r=!0;Array.from(l.children).find(u=>{if(u.classList.contains("list")&&Array.from(u.children).find(f=>{if(f.classList.contains("li")&&f.getAttribute("fold")!=="1"&&f.childElementCount>3)return r=!1,!0}))return!0});const c=[],d=[];Array.from(l.children).forEach(u=>{u.classList.contains("list")&&Array.from(u.children).forEach(g=>{if(g.classList.contains("li")){r?g.removeAttribute("fold"):g.childElementCount>3&&g.setAttribute("fold","1");const f=g.getAttribute("data-node-id");c.push({action:"setAttrs",id:f,data:JSON.stringify({fold:r?"":"1"})}),d.push({action:"setAttrs",id:f,data:JSON.stringify({fold:r?"1":""})})}})}),transaction(t,c,d),o.removeAttribute("disabled")}else{const r=setFold(t,l);r===1?o.firstElementChild.style.transform="":r===0&&(o.firstElementChild.style.transform="rotate(90deg)")}hideElements(["select"],t),window.siyuan.menus.menu.remove();return}const s=o.getBoundingClientRect();if(o.dataset.type==="NodeAttributeViewRowMenu"||o.dataset.type==="NodeAttributeViewRow"){const l=Array.from(t.wysiwyg.element.querySelectorAll(`.av[data-node-id="${o.dataset.nodeId}"] .av__row[data-id="${o.dataset.rowId}"]`)).find(c=>{if(!isInEmbedBlock(c))return!0});if(!l)return;const r=hasClosestBlock(l);if(!r)return;if(o.dataset.type==="NodeAttributeViewRow"){r.querySelectorAll(".av__cell--select, .av__cell--active").forEach(f=>{var p;f.classList.remove("av__cell--select","av__cell--active"),(p=f.querySelector(".av__drag-fill"))==null||p.remove()});const c=r.getAttribute("data-av-id"),d=[Lute.NewNodeID()],u=a.altKey?l.previousElementSibling.getAttribute("data-id")||"":o.dataset.rowId,g=dayjs().format("YYYYMMDDHHmmss");transaction(t,[{action:"insertAttrViewBlock",avID:c,previousID:u,srcs:[{id:d[0],isDetached:!0,content:""}],blockID:i},{action:"doUpdateUpdated",id:i,data:g}],[{action:"removeAttrViewBlock",srcIDs:d,avID:c},{action:"doUpdateUpdated",id:i,data:r.getAttribute("updated")}]),insertAttrViewBlockAnimation(t,r,d,u,c),a.altKey&&this.element.querySelectorAll("button").forEach(f=>{f.dataset.rowId=d[0]}),r.setAttribute("updated",g)}else{if(!t.disabled&&a.shiftKey){const c=(n=l.querySelector('[data-dtype="block"] .av__celltext--ref'))==null?void 0:n.getAttribute("data-id");if(c){fetchPost("/api/attr/getBlockAttrs",{id:c},d=>{openFileAttr(d.data,"av",t)});return}}avContextmenu(t,l,{x:s.left,y:s.bottom,w:s.width,h:s.height,isLeft:!0})}return}if(isOnlyMeta(a))t.options.backlinkData?checkFold(i,(l,r)=>{openFileById({app:t.app,id:i,action:r,zoomIn:l})}):zoomOut({protyle:t,id:i});else if(a.altKey){let l;if(Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${i}"]`)).find(r=>{if(!isInEmbedBlock(r)&&this.isMatchNode(r))return l=r,!0}),!l)return;if(o.getAttribute("data-type")==="NodeListItem"&&l.parentElement.getAttribute("data-node-id")){let r=!0;Array.from(l.parentElement.children).find(u=>{if(u.classList.contains("li")&&u.getAttribute("fold")!=="1"&&u.childElementCount>3)return r=!1,!0}),o.parentElement.querySelector("[data-type='fold'] > svg").style.transform=r?"rotate(90deg)":"";const c=[],d=[];Array.from(l.parentElement.children).find(u=>{if(u.classList.contains("li")){r?u.removeAttribute("fold"):u.childElementCount>3&&u.setAttribute("fold","1");const g=u.getAttribute("data-node-id");c.push({action:"setAttrs",id:g,data:JSON.stringify({fold:r?"":"1"})}),d.push({action:"setAttrs",id:g,data:JSON.stringify({fold:r?"1":""})})}}),transaction(t,c,d)}else{const r=setFold(t,l),c=o.parentElement.querySelector("[data-type='fold'] > svg");r!==-1&&c&&(c.style.transform=r===0?"rotate(90deg)":"")}l.classList.remove("protyle-wysiwyg--hl")}else window.siyuan.shiftIsPressed&&!t.disabled?openAttr(t.wysiwyg.element.querySelector(`[data-node-id="${i}"]`),"bookmark",t):!window.siyuan.ctrlIsPressed&&!window.siyuan.altIsPressed&&!window.siyuan.shiftIsPressed&&(this.renderMenu(t,o),t.toolbar.range||(t.toolbar.range=getEditorRange(t.wysiwyg.element.querySelector(`[data-node-id="${i}"]`)||t.wysiwyg.element.firstElementChild)),window.siyuan.menus.menu.fullscreen())}),this.element.addEventListener("contextmenu",a=>{const n=hasClosestByTag(a.target,"BUTTON");if(!(!n||n.getAttribute("data-type")==="fold")){if(!window.siyuan.ctrlIsPressed&&!window.siyuan.altIsPressed&&!window.siyuan.shiftIsPressed){hideTooltip();const o=n.getBoundingClientRect();if(n.dataset.type==="NodeAttributeViewRowMenu"){const i=Array.from(t.wysiwyg.element.querySelectorAll(`.av[data-node-id="${n.dataset.nodeId}"] .av__row[data-id="${n.dataset.rowId}"]`)).find(s=>{if(!isInEmbedBlock(s))return!0});i&&avContextmenu(t,i,{x:o.left,y:o.bottom,w:o.width,h:o.height,isLeft:!0})}else n.dataset.type!=="NodeAttributeViewRow"&&(this.renderMenu(t,n),t.toolbar.range||(t.toolbar.range=getEditorRange(t.wysiwyg.element.querySelector(`[data-node-id="${n.getAttribute("data-node-id")}"]`)||t.wysiwyg.element.firstElementChild)),window.siyuan.menus.menu.fullscreen())}a.preventDefault(),a.stopPropagation()}}),this.element.addEventListener("mouseleave",a=>{Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl, .av__row--hl")).forEach(n=>{n.classList.remove("protyle-wysiwyg--hl","av__row--hl")}),a.preventDefault(),a.stopPropagation()}),this.element.addEventListener("mousewheel",a=>{hideElements(["gutter"],t),a.stopPropagation()},{passive:!0})}isMatchNode(t){const a=t.getBoundingClientRect();let n=this.element.getBoundingClientRect().top+6;return a.height<Math.floor(window.siyuan.config.editor.fontSize*1.625)+8&&(n=n-(a.height-this.element.clientHeight)/2),a.top<=n&&a.bottom>=n}turnsOneInto(t){return{id:t.menuId,icon:t.icon,label:t.label,accelerator:t.accelerator,click(){turnsOneInto(t)}}}turnsIntoOne(t){return{id:t.menuId,icon:t.icon,label:t.label,accelerator:t.accelerator,click(){turnsIntoOneTransaction(t)}}}turnsInto(t){return{id:t.menuId,icon:t.icon,label:t.label,accelerator:t.accelerator,click(){turnsIntoTransaction(t)}}}showMobileAppearance(t){const a=document.getElementById("keyboardToolbar"),n=a.querySelectorAll("#keyboardToolbar .keyboard__dynamic");n[0].classList.add("fn__none"),n[1].classList.remove("fn__none"),a.querySelector('.keyboard__action[data-type="text"]').classList.add("protyle-toolbar__item--current"),a.querySelector('.keyboard__action[data-type="done"] use').setAttribute("xlink:href","#iconCloseRound"),a.classList.remove("fn__none");const o=t.contentElement.scrollTop+333.5;renderTextMenu(t,a),showKeyboardToolbarUtil(o)}renderMultipleMenu(t,a){var n;let o=!1,i=!1,s=!1;if(a.find((u,g)=>{if(u.classList.contains("li"))return o=!0,!0;if((u.classList.contains("sb")||u.classList.contains("p"))&&(s=!0),u.nextElementSibling&&a[g+1]&&u.nextElementSibling.isSameNode(a[g+1]))i=!0;else if(g!==a.length-1)return i=!1,!0}),!o&&!t.disabled){const u=[];i&&(u.push(this.turnsIntoOne({menuId:"list",icon:"iconList",label:window.siyuan.languages.list,protyle:t,accelerator:window.siyuan.config.keymap.editor.insert.list.custom,selectsElement:a,type:"Blocks2ULs"})),u.push(this.turnsIntoOne({menuId:"orderedList",icon:"iconOrderedList",label:window.siyuan.languages["ordered-list"],accelerator:window.siyuan.config.keymap.editor.insert["ordered-list"].custom,protyle:t,selectsElement:a,type:"Blocks2OLs"})),u.push(this.turnsIntoOne({menuId:"check",icon:"iconCheck",label:window.siyuan.languages.check,accelerator:window.siyuan.config.keymap.editor.insert.check.custom,protyle:t,selectsElement:a,type:"Blocks2TLs"})),u.push(this.turnsIntoOne({menuId:"quote",icon:"iconQuote",label:window.siyuan.languages.quote,accelerator:window.siyuan.config.keymap.editor.insert.quote.custom,protyle:t,selectsElement:a,type:"Blocks2Blockquote"}))),s||u.push(this.turnsInto({menuId:"paragraph",icon:"iconParagraph",label:window.siyuan.languages.paragraph,accelerator:window.siyuan.config.keymap.editor.heading.paragraph.custom,protyle:t,selectsElement:a,type:"Blocks2Ps",isContinue:i})),u.push(this.turnsInto({menuId:"heading1",icon:"iconH1",label:window.siyuan.languages.heading1,accelerator:window.siyuan.config.keymap.editor.heading.heading1.custom,protyle:t,selectsElement:a,level:1,type:"Blocks2Hs",isContinue:i})),u.push(this.turnsInto({menuId:"heading2",icon:"iconH2",label:window.siyuan.languages.heading2,accelerator:window.siyuan.config.keymap.editor.heading.heading2.custom,protyle:t,selectsElement:a,level:2,type:"Blocks2Hs",isContinue:i})),u.push(this.turnsInto({menuId:"heading3",icon:"iconH3",label:window.siyuan.languages.heading3,accelerator:window.siyuan.config.keymap.editor.heading.heading3.custom,protyle:t,selectsElement:a,level:3,type:"Blocks2Hs",isContinue:i})),u.push(this.turnsInto({menuId:"heading4",icon:"iconH4",label:window.siyuan.languages.heading4,accelerator:window.siyuan.config.keymap.editor.heading.heading4.custom,protyle:t,selectsElement:a,level:4,type:"Blocks2Hs",isContinue:i})),u.push(this.turnsInto({menuId:"heading5",icon:"iconH5",label:window.siyuan.languages.heading5,accelerator:window.siyuan.config.keymap.editor.heading.heading5.custom,protyle:t,selectsElement:a,level:5,type:"Blocks2Hs",isContinue:i})),u.push(this.turnsInto({menuId:"heading6",icon:"iconH6",label:window.siyuan.languages.heading6,accelerator:window.siyuan.config.keymap.editor.heading.heading6.custom,protyle:t,selectsElement:a,level:6,type:"Blocks2Hs",isContinue:i})),window.siyuan.menus.menu.append(new MenuItem({id:"turnInto",icon:"iconRefresh",label:window.siyuan.languages.turnInto,type:"submenu",submenu:u}).element),i&&!(a[0].parentElement.classList.contains("sb")&&a.length+1===a[0].parentElement.childElementCount)&&window.siyuan.menus.menu.append(new MenuItem({id:"mergeSuperBlock",icon:"iconSuper",label:window.siyuan.languages.merge+" "+window.siyuan.languages.superBlock,type:"submenu",submenu:[this.turnsIntoOne({menuId:"hLayout",label:window.siyuan.languages.hLayout,accelerator:window.siyuan.config.keymap.editor.general.hLayout.custom,icon:"iconSplitLR",protyle:t,selectsElement:a,type:"BlocksMergeSuperBlock",level:"col"}),this.turnsIntoOne({menuId:"vLayout",label:window.siyuan.languages.vLayout,accelerator:window.siyuan.config.keymap.editor.general.vLayout.custom,icon:"iconSplitTB",protyle:t,selectsElement:a,type:"BlocksMergeSuperBlock",level:"row"})]}).element)}t.disabled||window.siyuan.menus.menu.append(new MenuItem({id:"ai",icon:"iconSparkles",label:window.siyuan.languages.ai,accelerator:window.siyuan.config.keymap.editor.general.ai.custom,click(){AIActions(a,t)}}).element);const l=copySubMenu(Array.from(a).map(u=>u.getAttribute("data-node-id")),!0,a[0]).concat([{id:"copyPlainText",iconHTML:"",label:window.siyuan.languages.copyPlainText,accelerator:window.siyuan.config.keymap.editor.general.copyPlainText.custom,click(){let u="";a.forEach(g=>{u+=getPlainText(g)+`
`}),copyPlainText(u.trimEnd()),focusBlock(a[0])}},{id:"copy",iconHTML:"",label:window.siyuan.languages.copy,accelerator:"\u2318C",click(){isNotEditBlock(a[0])?focusBlock(a[0]):focusByRange(getEditorRange(a[0])),document.execCommand("copy")}},{id:"duplicate",iconHTML:"",label:window.siyuan.languages.duplicate,accelerator:window.siyuan.config.keymap.editor.general.duplicate.custom,disabled:t.disabled,click(){duplicateBlock(a,t)}}]);l.splice(4,1,{id:"copyHPath",iconHTML:"",label:window.siyuan.languages.copyHPath,accelerator:window.siyuan.config.keymap.editor.general.copyHPath.custom,click:()=>{copyTextByType([a[0].getAttribute("data-node-id")],"hPath"),focusBlock(a[0])}});const r=this.genCopyTextRef(a);if(r&&l.splice(7,0,r),window.siyuan.menus.menu.append(new MenuItem({id:"copy",label:window.siyuan.languages.copy,icon:"iconCopy",type:"submenu",submenu:l}).element),t.disabled)return;window.siyuan.menus.menu.append(new MenuItem({id:"cut",label:window.siyuan.languages.cut,accelerator:"\u2318X",icon:"iconCut",click:()=>{focusBlock(a[0]),document.execCommand("cut")}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"move",label:window.siyuan.languages.move,accelerator:window.siyuan.config.keymap.general.move.custom,icon:"iconMove",click:()=>{movePathTo(u=>{hintMoveBlock(u[0],a,t)})}}).element);const c=getSelection().rangeCount>0?getSelection().getRangeAt(0):void 0;window.siyuan.menus.menu.append(new MenuItem({id:"addToDatabase",label:window.siyuan.languages.addToDatabase,accelerator:window.siyuan.config.keymap.general.addToDatabase.custom,icon:"iconDatabase",click:()=>{addEditorToDatabase(t,c)}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"delete",label:window.siyuan.languages.delete,icon:"iconTrashcan",accelerator:"\u232B",click:()=>{var u;(u=t.breadcrumb)==null||u.hide(),removeBlock(t,a[0],getEditorRange(a[0]),"Backspace")}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"separator_appearance",type:"separator"}).element);const d=new MenuItem({id:"appearance",label:window.siyuan.languages.appearance,icon:"iconFont",accelerator:window.siyuan.config.keymap.editor.insert.appearance.custom,click:()=>{this.showMobileAppearance(t)}}).element;return window.siyuan.menus.menu.append(d),isMobile()||d.lastElementChild.classList.add("b3-menu__submenu--row"),this.genAlign(a,t),this.genWidths(a,t),window.siyuan.config.readonly||(window.siyuan.menus.menu.append(new MenuItem({id:"separator_quickMakeCard",type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({id:"quickMakeCard",label:window.siyuan.languages.quickMakeCard,accelerator:window.siyuan.config.keymap.editor.general.quickMakeCard.custom,iconHTML:'<svg class="b3-menu__icon" style="color:var(--b3-theme-primary)"><use xlink:href="#iconRiffCard"></use></svg>',icon:"iconRiffCard",click(){quickMakeCard(t,a)}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"addToDeck",label:window.siyuan.languages.addToDeck,icon:"iconRiffCard",ignore:!window.siyuan.config.flashcard.deck,click(){const u=[];a.forEach(g=>{g.getAttribute("data-type")!=="NodeThematicBreak"&&u.push(g.getAttribute("data-node-id"))}),makeCard(t.app,u)}}).element)),(n=t==null?void 0:t.app)!=null&&n.plugins&&emitOpenMenu({plugins:t.app.plugins,type:"click-blockicon",detail:{protyle:t,blockElements:a},separatorPosition:"top"}),window.siyuan.menus.menu}renderMenu(t,a){var n,o;if(!a)return;hideElements(["util","toolbar","hint"],t),window.siyuan.menus.menu.remove(),isMobile()&&activeBlur();const i=a.getAttribute("data-node-id"),s=t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(s.length>1&&Array.from(s).find(m=>{if(i===m.getAttribute("data-node-id"))return!0}))return this.renderMultipleMenu(t,Array.from(s));let l;if(a.tagName==="BUTTON"?Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${i}"]`)).find(p=>{if(!isInEmbedBlock(p)&&this.isMatchNode(p))return l=p,!0}):l=a,!l)return;const r=l.getAttribute("data-type"),c=l.getAttribute("data-subtype"),d=[];hideElements(["select"],t),l.classList.add("protyle-wysiwyg--select"),countBlockWord([i],t.block.rootID),r==="NodeParagraph"&&!t.disabled?(d.push(this.turnsIntoOne({menuId:"list",icon:"iconList",label:window.siyuan.languages.list,accelerator:window.siyuan.config.keymap.editor.insert.list.custom,protyle:t,selectsElement:[l],type:"Blocks2ULs"})),d.push(this.turnsIntoOne({menuId:"orderedList",icon:"iconOrderedList",label:window.siyuan.languages["ordered-list"],accelerator:window.siyuan.config.keymap.editor.insert["ordered-list"].custom,protyle:t,selectsElement:[l],type:"Blocks2OLs"})),d.push(this.turnsIntoOne({menuId:"check",icon:"iconCheck",label:window.siyuan.languages.check,accelerator:window.siyuan.config.keymap.editor.insert.check.custom,protyle:t,selectsElement:[l],type:"Blocks2TLs"})),d.push(this.turnsIntoOne({menuId:"quote",icon:"iconQuote",label:window.siyuan.languages.quote,accelerator:window.siyuan.config.keymap.editor.insert.quote.custom,protyle:t,selectsElement:[l],type:"Blocks2Blockquote"})),d.push(this.turnsInto({menuId:"heading1",icon:"iconH1",label:window.siyuan.languages.heading1,accelerator:window.siyuan.config.keymap.editor.heading.heading1.custom,protyle:t,selectsElement:[l],level:1,type:"Blocks2Hs"})),d.push(this.turnsInto({menuId:"heading2",icon:"iconH2",label:window.siyuan.languages.heading2,accelerator:window.siyuan.config.keymap.editor.heading.heading2.custom,protyle:t,selectsElement:[l],level:2,type:"Blocks2Hs"})),d.push(this.turnsInto({menuId:"heading3",icon:"iconH3",label:window.siyuan.languages.heading3,accelerator:window.siyuan.config.keymap.editor.heading.heading3.custom,protyle:t,selectsElement:[l],level:3,type:"Blocks2Hs"})),d.push(this.turnsInto({menuId:"heading4",icon:"iconH4",label:window.siyuan.languages.heading4,accelerator:window.siyuan.config.keymap.editor.heading.heading4.custom,protyle:t,selectsElement:[l],level:4,type:"Blocks2Hs"})),d.push(this.turnsInto({menuId:"heading5",icon:"iconH5",label:window.siyuan.languages.heading5,accelerator:window.siyuan.config.keymap.editor.heading.heading5.custom,protyle:t,selectsElement:[l],level:5,type:"Blocks2Hs"})),d.push(this.turnsInto({menuId:"heading6",icon:"iconH6",label:window.siyuan.languages.heading6,accelerator:window.siyuan.config.keymap.editor.heading.heading6.custom,protyle:t,selectsElement:[l],level:6,type:"Blocks2Hs"}))):r==="NodeHeading"&&!t.disabled?(d.push(this.turnsInto({menuId:"paragraph",icon:"iconParagraph",label:window.siyuan.languages.paragraph,accelerator:window.siyuan.config.keymap.editor.heading.paragraph.custom,protyle:t,selectsElement:[l],type:"Blocks2Ps"})),d.push(this.turnsIntoOne({menuId:"quote",icon:"iconQuote",label:window.siyuan.languages.quote,accelerator:window.siyuan.config.keymap.editor.insert.quote.custom,protyle:t,selectsElement:[l],type:"Blocks2Blockquote"})),c!=="h1"&&d.push(this.turnsInto({menuId:"heading1",icon:"iconH1",label:window.siyuan.languages.heading1,accelerator:window.siyuan.config.keymap.editor.heading.heading1.custom,protyle:t,selectsElement:[l],level:1,type:"Blocks2Hs"})),c!=="h2"&&d.push(this.turnsInto({menuId:"heading2",icon:"iconH2",label:window.siyuan.languages.heading2,accelerator:window.siyuan.config.keymap.editor.heading.heading2.custom,protyle:t,selectsElement:[l],level:2,type:"Blocks2Hs"})),c!=="h3"&&d.push(this.turnsInto({menuId:"heading3",icon:"iconH3",label:window.siyuan.languages.heading3,accelerator:window.siyuan.config.keymap.editor.heading.heading3.custom,protyle:t,selectsElement:[l],level:3,type:"Blocks2Hs"})),c!=="h4"&&d.push(this.turnsInto({menuId:"heading4",icon:"iconH4",label:window.siyuan.languages.heading4,accelerator:window.siyuan.config.keymap.editor.heading.heading4.custom,protyle:t,selectsElement:[l],level:4,type:"Blocks2Hs"})),c!=="h5"&&d.push(this.turnsInto({menuId:"heading5",icon:"iconH5",label:window.siyuan.languages.heading5,accelerator:window.siyuan.config.keymap.editor.heading.heading5.custom,protyle:t,selectsElement:[l],level:5,type:"Blocks2Hs"})),c!=="h6"&&d.push(this.turnsInto({menuId:"heading6",icon:"iconH6",label:window.siyuan.languages.heading6,accelerator:window.siyuan.config.keymap.editor.heading.heading6.custom,protyle:t,selectsElement:[l],level:6,type:"Blocks2Hs"}))):r==="NodeList"&&!t.disabled?(d.push(this.turnsOneInto({menuId:"paragraph",id:i,icon:"iconParagraph",label:window.siyuan.languages.paragraph,accelerator:window.siyuan.config.keymap.editor.heading.paragraph.custom,protyle:t,nodeElement:l,type:"CancelList"})),d.push(this.turnsIntoOne({menuId:"quote",icon:"iconQuote",label:window.siyuan.languages.quote,accelerator:window.siyuan.config.keymap.editor.insert.quote.custom,protyle:t,selectsElement:[l],type:"Blocks2Blockquote"})),l.getAttribute("data-subtype")==="o"?(d.push(this.turnsOneInto({menuId:"list",id:i,icon:"iconList",label:window.siyuan.languages.list,accelerator:window.siyuan.config.keymap.editor.insert.list.custom,protyle:t,nodeElement:l,type:"OL2UL"})),d.push(this.turnsOneInto({menuId:"check",id:i,icon:"iconCheck",label:window.siyuan.languages.check,accelerator:window.siyuan.config.keymap.editor.insert.check.custom,protyle:t,nodeElement:l,type:"UL2TL"}))):l.getAttribute("data-subtype")==="t"?(d.push(this.turnsOneInto({menuId:"list",id:i,icon:"iconList",label:window.siyuan.languages.list,accelerator:window.siyuan.config.keymap.editor.insert.list.custom,protyle:t,nodeElement:l,type:"TL2UL"})),d.push(this.turnsOneInto({menuId:"orderedList",id:i,icon:"iconOrderedList",label:window.siyuan.languages["ordered-list"],accelerator:window.siyuan.config.keymap.editor.insert["ordered-list"].custom,protyle:t,nodeElement:l,type:"TL2OL"}))):(d.push(this.turnsOneInto({menuId:"orderedList",id:i,icon:"iconOrderedList",label:window.siyuan.languages["ordered-list"],accelerator:window.siyuan.config.keymap.editor.insert["ordered-list"].custom,protyle:t,nodeElement:l,type:"UL2OL"})),d.push(this.turnsOneInto({menuId:"check",id:i,icon:"iconCheck",label:window.siyuan.languages.check,accelerator:window.siyuan.config.keymap.editor.insert.check.custom,protyle:t,nodeElement:l,type:"OL2TL"})))):r==="NodeBlockquote"&&!t.disabled&&d.push(this.turnsOneInto({menuId:"paragraph",id:i,icon:"iconParagraph",label:window.siyuan.languages.paragraph,accelerator:window.siyuan.config.keymap.editor.heading.paragraph.custom,protyle:t,nodeElement:l,type:"CancelBlockquote"})),d.length>0&&!t.disabled&&window.siyuan.menus.menu.append(new MenuItem({id:"turnInto",icon:"iconRefresh",label:window.siyuan.languages.turnInto,type:"submenu",submenu:d}).element),!t.disabled&&!l.classList.contains("hr")&&window.siyuan.menus.menu.append(new MenuItem({id:"ai",icon:"iconSparkles",label:window.siyuan.languages.ai,accelerator:window.siyuan.config.keymap.editor.general.ai.custom,click(){AIActions([l],t)}}).element);const u=copySubMenu([i],!0,l).concat([{id:"copyPlainText",iconHTML:"",label:window.siyuan.languages.copyPlainText,accelerator:window.siyuan.config.keymap.editor.general.copyPlainText.custom,click(){copyPlainText(getPlainText(l).trimEnd()),focusBlock(l)}},{id:r==="NodeAttributeView"?"copyMirror":"copy",iconHTML:"",label:r==="NodeAttributeView"?window.siyuan.languages.copyMirror:window.siyuan.languages.copy,accelerator:"\u2318C",click(){isNotEditBlock(l)?focusBlock(l):focusByRange(getEditorRange(l)),document.execCommand("copy")}},{id:r==="NodeAttributeView"?"duplicateMirror":"duplicate",iconHTML:"",label:r==="NodeAttributeView"?window.siyuan.languages.duplicateMirror:window.siyuan.languages.duplicate,accelerator:window.siyuan.config.keymap.editor.general.duplicate.custom,disabled:t.disabled,click(){duplicateBlock([l],t)}}]);r==="NodeAttributeView"&&u.push({id:"duplicateCompletely",iconHTML:"",label:window.siyuan.languages.duplicateCompletely,accelerator:window.siyuan.config.keymap.editor.general.duplicateCompletely.custom,disabled:t.disabled,click(){duplicateCompletely(t,l)}});const g=this.genCopyTextRef([l]);if(g&&u.splice(7,0,g),window.siyuan.menus.menu.append(new MenuItem({id:"copy",icon:"iconCopy",label:window.siyuan.languages.copy,type:"submenu",submenu:u}).element),!t.disabled){window.siyuan.menus.menu.append(new MenuItem({id:"cut",icon:"iconCut",label:window.siyuan.languages.cut,accelerator:"\u2318X",click:()=>{focusBlock(l),document.execCommand("cut")}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"move",icon:"iconMove",label:window.siyuan.languages.move,accelerator:window.siyuan.config.keymap.general.move.custom,click:()=>{movePathTo(m=>{hintMoveBlock(m[0],[l],t)})}}).element);const p=getSelection().rangeCount>0?getSelection().getRangeAt(0):void 0;window.siyuan.menus.menu.append(new MenuItem({id:"addToDatabase",icon:"iconDatabase",label:window.siyuan.languages.addToDatabase,accelerator:window.siyuan.config.keymap.general.addToDatabase.custom,click:()=>{addEditorToDatabase(t,p)}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"delete",icon:"iconTrashcan",label:window.siyuan.languages.delete,accelerator:"\u232B",click:()=>{var m;(m=t.breadcrumb)==null||m.hide(),removeBlock(t,l,getEditorRange(l),"Backspace")}}).element)}if(r==="NodeSuperBlock"&&!t.disabled){window.siyuan.menus.menu.append(new MenuItem({id:"separator_cancelSuperBlock",type:"separator"}).element);const p=l.getAttribute("data-sb-layout")==="col";window.siyuan.menus.menu.append(new MenuItem({id:"cancelSuperBlock",label:window.siyuan.languages.cancel+" "+window.siyuan.languages.superBlock,accelerator:window.siyuan.config.keymap.editor.general[p?"hLayout":"vLayout"].custom,click(){const m=cancelSB(t,l);transaction(t,m.doOperations,m.undoOperations),focusBlock(t.wysiwyg.element.querySelector(`[data-node-id="${m.previousId}"]`)),hideElements(["gutter"],t)}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"turnInto"+(p?"VLayout":"HLayout"),accelerator:window.siyuan.config.keymap.editor.general[p?"vLayout":"hLayout"].custom,label:window.siyuan.languages.turnInto+" "+window.siyuan.languages[p?"vLayout":"hLayout"],click(){const m=l.outerHTML;p?l.setAttribute("data-sb-layout","row"):l.setAttribute("data-sb-layout","col"),l.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(t,i,l.outerHTML,m),focusByRange(t.toolbar.range),hideElements(["gutter"],t)}}).element)}else if(r==="NodeCodeBlock"&&!t.disabled&&!l.getAttribute("data-subtype")){window.siyuan.menus.menu.append(new MenuItem({id:"separator_code",type:"separator"}).element);const p=l.getAttribute("linewrap"),m=l.getAttribute("ligatures"),b=l.getAttribute("linenumber");window.siyuan.menus.menu.append(new MenuItem({id:"code",type:"submenu",icon:"iconCode",label:window.siyuan.languages.code,submenu:[{id:"md31",iconHTML:"",label:`<div class="fn__flex" style="margin-bottom: 4px"><span>${window.siyuan.languages.md31}</span><span class="fn__space fn__flex-1"></span>
<input type="checkbox" class="b3-switch fn__flex-center"${p==="true"||window.siyuan.config.editor.codeLineWrap&&p!=="false"?" checked":""}></div>`,bind(w){w.addEventListener("click",y=>{const _=w.querySelector("input");y.target.tagName!=="INPUT"&&(_.checked=!_.checked),l.setAttribute("linewrap",_.checked.toString()),l.querySelector(".hljs").removeAttribute("data-render"),highlightRender(l),fetchPost("/api/attr/setBlockAttrs",{id:i,attrs:{linewrap:_.checked.toString()}}),window.siyuan.menus.menu.remove()})}},{id:"md2",iconHTML:"",label:`<div class="fn__flex" style="margin-bottom: 4px"><span>${window.siyuan.languages.md2}</span><span class="fn__space fn__flex-1"></span>
<input type="checkbox" class="b3-switch fn__flex-center"${m==="true"||window.siyuan.config.editor.codeLigatures&&m!=="false"?" checked":""}></div>`,bind(w){w.addEventListener("click",y=>{const _=w.querySelector("input");y.target.tagName!=="INPUT"&&(_.checked=!_.checked),l.setAttribute("ligatures",_.checked.toString()),l.querySelector(".hljs").removeAttribute("data-render"),highlightRender(l),fetchPost("/api/attr/setBlockAttrs",{id:i,attrs:{ligatures:_.checked.toString()}}),window.siyuan.menus.menu.remove()})}},{id:"md27",iconHTML:"",label:`<div class="fn__flex" style="margin-bottom: 4px"><span>${window.siyuan.languages.md27}</span><span class="fn__space fn__flex-1"></span>
<input type="checkbox" class="b3-switch fn__flex-center"${b==="true"||window.siyuan.config.editor.codeSyntaxHighlightLineNum&&b!=="false"?" checked":""}></div>`,bind(w){w.addEventListener("click",y=>{const _=w.querySelector("input");y.target.tagName!=="INPUT"&&(_.checked=!_.checked),l.setAttribute("linenumber",_.checked.toString()),l.querySelector(".hljs").removeAttribute("data-render"),highlightRender(l),fetchPost("/api/attr/setBlockAttrs",{id:i,attrs:{linenumber:_.checked.toString()}}),window.siyuan.menus.menu.remove()})}}]}).element)}else if(r==="NodeCodeBlock"&&!t.disabled&&["echarts","mindmap"].includes(l.getAttribute("data-subtype"))){window.siyuan.menus.menu.append(new MenuItem({id:"separator_chart",type:"separator"}).element);const p=l.style.height;let m=l.outerHTML;window.siyuan.menus.menu.append(new MenuItem({id:"chart",label:window.siyuan.languages.chart,icon:"iconCode",submenu:[{id:"height",label:`${window.siyuan.languages.height}<span class="fn__space"></span>
<input style="margin: 4px 0;width: 84px" type="number" step="1" min="148" class="b3-text-field" value="${p?parseInt(p):"420"}">`,bind:b=>{b.querySelector("input").addEventListener("change",w=>{const y=(w.target.value||"420")+"px";l.style.height=y,l.firstElementChild.nextElementSibling.style.height=y,updateTransaction(t,i,l.outerHTML,m),m=l.outerHTML,w.stopPropagation();const _=window.echarts.getInstanceById(l.firstElementChild.nextElementSibling.getAttribute("_echarts_instance_"));_&&_.resize()})}},{id:"update",label:window.siyuan.languages.update,icon:"iconEdit",click(){t.toolbar.showRender(t,l)}}]}).element)}else if(r==="NodeTable"&&!t.disabled){let p=getEditorRange(l);const m=l.querySelector("table");m.contains(p.startContainer)||(p=getEditorRange(m.querySelector("th")));const b=hasClosestByTag(p.startContainer,"TD")||hasClosestByTag(p.startContainer,"TH");b&&(window.siyuan.menus.menu.append(new MenuItem({id:"separator_table",type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({id:"table",type:"submenu",icon:"iconTable",label:window.siyuan.languages.table,submenu:tableMenu(t,l,b,p).menus}).element))}else if(r==="NodeAttributeView"&&!t.disabled)window.siyuan.menus.menu.append(new MenuItem({id:"separator_exportCSV",type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({id:"exportCSV",icon:"iconDatabase",label:window.siyuan.languages.export+" CSV",click(){fetchPost("/api/export/exportAttributeView",{id:l.getAttribute("data-av-id"),blockID:i},p=>{openByMobile(p.data.zip)})}}).element);else if((r==="NodeVideo"||r==="NodeAudio")&&!t.disabled)window.siyuan.menus.menu.append(new MenuItem({id:"separator_VideoOrAudio",type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({id:r==="NodeVideo"?"assetVideo":"assetAudio",type:"submenu",icon:r==="NodeVideo"?"iconVideo":"iconRecord",label:window.siyuan.languages.assets,submenu:videoMenu(t,l,r)}).element);else if(r==="NodeIFrame"&&!t.disabled)window.siyuan.menus.menu.append(new MenuItem({id:"separator_IFrame",type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({id:"assetIFrame",type:"submenu",icon:"iconLanguage",label:window.siyuan.languages.assets,submenu:iframeMenu(t,l)}).element);else if(r==="NodeHTMLBlock"&&!t.disabled)window.siyuan.menus.menu.append(new MenuItem({id:"separator_html",type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({id:"html",icon:"iconHTML5",label:"HTML",click(){t.toolbar.showRender(t,l)}}).element);else if(r==="NodeBlockQueryEmbed"&&!t.disabled){window.siyuan.menus.menu.append(new MenuItem({id:"separator_blockEmbed",type:"separator"}).element);const p=l.getAttribute("breadcrumb");window.siyuan.menus.menu.append(new MenuItem({id:"blockEmbed",type:"submenu",icon:"iconSQL",label:window.siyuan.languages.blockEmbed,submenu:[{id:"refresh",icon:"iconRefresh",label:`${window.siyuan.languages.refresh} SQL`,click(){l.removeAttribute("data-render"),blockRender(t,l)}},{id:"update",icon:"iconEdit",label:`${window.siyuan.languages.update} SQL`,click(){t.toolbar.showRender(t,l)}},{type:"separator"},{id:"embedBlockBreadcrumb",label:`<div class="fn__flex" style="margin-bottom: 4px"><span>${window.siyuan.languages.embedBlockBreadcrumb}</span><span class="fn__space fn__flex-1"></span>
<input type="checkbox" class="b3-switch fn__flex-center"${p==="true"||window.siyuan.config.editor.embedBlockBreadcrumb&&p!=="false"?" checked":""}></div>`,bind(m){m.addEventListener("click",b=>{const w=m.querySelector("input");b.target.tagName!=="INPUT"&&(w.checked=!w.checked),l.setAttribute("breadcrumb",w.checked.toString()),fetchPost("/api/attr/setBlockAttrs",{id:i,attrs:{breadcrumb:w.checked.toString()}}),l.removeAttribute("data-render"),blockRender(t,l),window.siyuan.menus.menu.remove()})}},{id:"hideHeadingBelowBlocks",label:`<div class="fn__flex" style="margin-bottom: 4px"><span>${window.siyuan.languages.hideHeadingBelowBlocks}</span><span class="fn__space fn__flex-1"></span>
<input type="checkbox" class="b3-switch fn__flex-center"${l.getAttribute("custom-heading-mode")==="1"?" checked":""}></div>`,bind(m){m.addEventListener("click",b=>{const w=m.querySelector("input");b.target.tagName!=="INPUT"&&(w.checked=!w.checked),l.setAttribute("custom-heading-mode",w.checked?"1":"0"),fetchPost("/api/attr/setBlockAttrs",{id:i,attrs:{"custom-heading-mode":w.checked?"1":"0"}}),l.removeAttribute("data-render"),blockRender(t,l),window.siyuan.menus.menu.remove()})}}]}).element)}else if(r==="NodeHeading"&&!t.disabled){window.siyuan.menus.menu.append(new MenuItem({id:"separator_1",type:"separator"}).element);const p=[];c!=="h1"&&p.push(this.genHeadingTransform(t,i,1)),c!=="h2"&&p.push(this.genHeadingTransform(t,i,2)),c!=="h3"&&p.push(this.genHeadingTransform(t,i,3)),c!=="h4"&&p.push(this.genHeadingTransform(t,i,4)),c!=="h5"&&p.push(this.genHeadingTransform(t,i,5)),c!=="h6"&&p.push(this.genHeadingTransform(t,i,6)),window.siyuan.menus.menu.append(new MenuItem({id:"tWithSubtitle",type:"submenu",icon:"iconRefresh",label:window.siyuan.languages.tWithSubtitle,submenu:p}).element),window.siyuan.menus.menu.append(new MenuItem({id:"copyHeadings1",icon:"iconCopy",label:`${window.siyuan.languages.copy} ${window.siyuan.languages.headings1}`,click(){fetchPost("/api/block/getHeadingChildrenDOM",{id:i},m=>{isInAndroid()?window.JSAndroid.writeHTMLClipboard(t.lute.BlockDOM2StdMd(m.data).trimEnd(),m.data+Constants.ZWSP):isInHarmony()?window.JSHarmony.writeHTMLClipboard(t.lute.BlockDOM2StdMd(m.data).trimEnd(),m.data+Constants.ZWSP):writeText(m.data+Constants.ZWSP)})}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"cutHeadings1",icon:"iconCut",label:`${window.siyuan.languages.cut} ${window.siyuan.languages.headings1}`,click(){fetchPost("/api/block/getHeadingChildrenDOM",{id:i},m=>{isInAndroid()?window.JSAndroid.writeHTMLClipboard(t.lute.BlockDOM2StdMd(m.data).trimEnd(),m.data+Constants.ZWSP):isInHarmony()?window.JSHarmony.writeHTMLClipboard(t.lute.BlockDOM2StdMd(m.data).trimEnd(),m.data+Constants.ZWSP):writeText(m.data+Constants.ZWSP),fetchPost("/api/block/getHeadingDeleteTransaction",{id:i},b=>{b.data.doOperations.forEach(w=>{t.wysiwyg.element.querySelectorAll(`[data-node-id="${w.id}"]`).forEach(y=>{y.remove()})}),transaction(t,b.data.doOperations,b.data.undoOperations)})})}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"deleteHeadings1",icon:"iconTrashcan",label:`${window.siyuan.languages.delete} ${window.siyuan.languages.headings1}`,click(){fetchPost("/api/block/getHeadingDeleteTransaction",{id:i},m=>{m.data.doOperations.forEach(b=>{t.wysiwyg.element.querySelectorAll(`[data-node-id="${b.id}"]`).forEach(w=>{w.remove()})}),transaction(t,m.data.doOperations,m.data.undoOperations)})}}).element)}if(window.siyuan.menus.menu.append(new MenuItem({id:"separator_2",type:"separator"}).element),t.options.backlinkData||(window.siyuan.menus.menu.append(new MenuItem({id:"enter",accelerator:`${updateHotkeyTip(window.siyuan.config.keymap.general.enter.custom)}/${updateHotkeyTip("\u2318"+window.siyuan.languages.click)}`,label:window.siyuan.languages.enter,click:()=>{zoomOut({protyle:t,id:i})}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"enterBack",accelerator:window.siyuan.config.keymap.general.enterBack.custom,label:window.siyuan.languages.enterBack,click:()=>{enterBack(t,i)}}).element)),!t.disabled){window.siyuan.menus.menu.append(new MenuItem({id:"insertBefore",icon:"iconBefore",label:window.siyuan.languages["insert-before"],accelerator:window.siyuan.config.keymap.editor.general.insertBefore.custom,click(){hideElements(["select"],t),countBlockWord([],t.block.rootID),insertEmptyBlock(t,"beforebegin",i)}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"insertAfter",icon:"iconAfter",label:window.siyuan.languages["insert-after"],accelerator:window.siyuan.config.keymap.editor.general.insertAfter.custom,click(){hideElements(["select"],t),countBlockWord([],t.block.rootID),insertEmptyBlock(t,"afterend",i)}}).element);const p=l.lastElementChild.querySelector(".protyle-attr--refcount");p&&p.textContent&&transferBlockRef(i)}if(window.siyuan.menus.menu.append(new MenuItem({id:"jumpToParentNext",label:window.siyuan.languages.jumpToParentNext,accelerator:window.siyuan.config.keymap.editor.general.jumpToParentNext.custom,click(){hideElements(["select"],t),jumpToParent(t,l,"next")}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"jumpToParentPrev",label:window.siyuan.languages.jumpToParentPrev,accelerator:window.siyuan.config.keymap.editor.general.jumpToParentPrev.custom,click(){hideElements(["select"],t),jumpToParent(t,l,"previous")}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"jumpToParent",label:window.siyuan.languages.jumpToParent,accelerator:window.siyuan.config.keymap.editor.general.jumpToParent.custom,click(){hideElements(["select"],t),jumpToParent(t,l,"parent")}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"separator_3",type:"separator"}).element),r!=="NodeThematicBreak"&&(window.siyuan.menus.menu.append(new MenuItem({id:"fold",label:window.siyuan.languages.fold,accelerator:`${updateHotkeyTip(window.siyuan.config.keymap.editor.general.collapse.custom)}/${updateHotkeyTip("\u2325"+window.siyuan.languages.click)}`,click(){setFold(t,l),focusBlock(l)}}).element),t.disabled||window.siyuan.menus.menu.append(new MenuItem({id:"attr",label:window.siyuan.languages.attr,icon:"iconAttr",accelerator:window.siyuan.config.keymap.editor.general.attr.custom+"/"+updateHotkeyTip("\u21E7"+window.siyuan.languages.click),click(){openAttr(l,"bookmark",t)}}).element)),!t.disabled){const p=new MenuItem({id:"appearance",label:window.siyuan.languages.appearance,icon:"iconFont",accelerator:window.siyuan.config.keymap.editor.insert.appearance.custom,click:()=>{this.showMobileAppearance(t)}}).element;window.siyuan.menus.menu.append(p),isMobile()||p.lastElementChild.classList.add("b3-menu__submenu--row"),this.genAlign([l],t),this.genWidths([l],t)}window.siyuan.menus.menu.append(new MenuItem({id:"separator_4",type:"separator"}).element),window.siyuan.config.cloudRegion===0&&!["NodeThematicBreak","NodeBlockQueryEmbed","NodeIFrame","NodeHTMLBlock","NodeWidget","NodeVideo","NodeAudio"].includes(r)&&((n=getContenteditableElement(l))==null?void 0:n.textContent.trim())!==""&&(r!=="NodeCodeBlock"||r==="NodeCodeBlock"&&!l.getAttribute("data-subtype"))&&window.siyuan.menus.menu.append(new MenuItem({id:"wechatReminder",icon:"iconMp",label:window.siyuan.languages.wechatReminder,ignore:window.siyuan.config.readonly,click(){openWechatNotify(l)}}).element),r!=="NodeThematicBreak"&&!window.siyuan.config.readonly&&(window.siyuan.menus.menu.append(new MenuItem({id:"quickMakeCard",icon:"iconRiffCard",label:window.siyuan.languages.quickMakeCard,accelerator:window.siyuan.config.keymap.editor.general.quickMakeCard.custom,iconHTML:'<svg class="b3-menu__icon" style="color:var(--b3-theme-primary)"><use xlink:href="#iconRiffCard"></use></svg>',click(){quickMakeCard(t,[l])}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"addToDeck",label:window.siyuan.languages.addToDeck,ignore:!window.siyuan.config.flashcard.deck,icon:"iconRiffCard",click(){makeCard(t.app,[i])}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"separator_5",type:"separator"}).element)),(o=t==null?void 0:t.app)!=null&&o.plugins&&emitOpenMenu({plugins:t.app.plugins,type:"click-blockicon",detail:{protyle:t,blockElements:[l]},separatorPosition:"bottom"});let f=l.getAttribute("updated")||"";return f&&(f=`${window.siyuan.languages.modifiedAt} ${dayjs(f).format("YYYY-MM-DD HH:mm:ss")}<br>`),window.siyuan.menus.menu.append(new MenuItem({id:"updateAndCreatedAt",iconHTML:"",type:"readonly",label:`${f}${window.siyuan.languages.createdAt} ${dayjs(i.substr(0,14)).format("YYYY-MM-DD HH:mm:ss")}`}).element),window.siyuan.menus.menu}genHeadingTransform(t,a,n){return{id:"heading"+n,iconHTML:"",icon:"iconHeading"+n,label:window.siyuan.languages["heading"+n],click(){fetchPost("/api/block/getHeadingLevelTransaction",{id:a,level:n},o=>{o.data.doOperations.forEach((i,s)=>{t.wysiwyg.element.querySelectorAll(`[data-node-id="${i.id}"]`).forEach(l=>{l.outerHTML=i.data}),t.wysiwyg.element.querySelectorAll(`[data-node-id="${i.id}"]`).forEach(l=>{mathRender(l)}),s===0&&focusBlock(t.wysiwyg.element.querySelector(`[data-node-id="${i.id}"]`),t.wysiwyg.element,!0)}),transaction(t,o.data.doOperations,o.data.undoOperations)})}}}genClick(t,a,n){updateBatchTransaction(t,a,n),focusBlock(t[0])}genAlign(t,a){window.siyuan.menus.menu.append(new MenuItem({id:"layout",label:window.siyuan.languages.layout,type:"submenu",submenu:[{id:"alignLeft",icon:"iconAlignLeft",label:window.siyuan.languages.alignLeft,accelerator:window.siyuan.config.keymap.editor.general.alignLeft.custom,click:()=>{this.genClick(t,a,n=>{n.classList.contains("av")?n.style.justifyContent="":n.style.textAlign="left"})}},{id:"alignCenter",icon:"iconAlignCenter",label:window.siyuan.languages.alignCenter,accelerator:window.siyuan.config.keymap.editor.general.alignCenter.custom,click:()=>{this.genClick(t,a,n=>{n.classList.contains("av")?n.style.justifyContent="center":n.style.textAlign="center"})}},{id:"alignRight",icon:"iconAlignRight",label:window.siyuan.languages.alignRight,accelerator:window.siyuan.config.keymap.editor.general.alignRight.custom,click:()=>{this.genClick(t,a,n=>{n.classList.contains("av")?n.style.justifyContent="flex-end":n.style.textAlign="right"})}},{id:"justify",icon:"iconMenu",label:window.siyuan.languages.justify,click:()=>{this.genClick(t,a,n=>{n.style.textAlign="justify"})}},{id:"separator_1",type:"separator"},{id:"ltr",icon:"iconLtr",label:window.siyuan.languages.ltr,accelerator:window.siyuan.config.keymap.editor.general.ltr.custom,click:()=>{this.genClick(t,a,n=>{n.style.direction="ltr"})}},{id:"rtl",icon:"iconRtl",label:window.siyuan.languages.rtl,accelerator:window.siyuan.config.keymap.editor.general.rtl.custom,click:()=>{this.genClick(t,a,n=>{n.classList.contains("av")||(n.style.direction="rtl")})}},{id:"separator_2",type:"separator"},{id:"clearFontStyle",icon:"iconTrashcan",label:window.siyuan.languages.clearFontStyle,click:()=>{this.genClick(t,a,n=>{n.classList.contains("av")?n.style.justifyContent="":(n.style.textAlign="",n.style.direction="")})}}]}).element)}updateNodeElements(t,a,n){const o=[],i=[];t.forEach(s=>{o.push({action:"update",id:s.getAttribute("data-node-id"),data:s.outerHTML})}),n.addEventListener(n.type==="number"?"blur":"change",()=>{t.forEach(s=>{i.push({action:"update",id:s.getAttribute("data-node-id"),data:s.outerHTML})}),transaction(a,i,o),window.siyuan.menus.menu.remove(),focusBlock(t[0])})}genWidths(t,a){let n;const o=t[0],i=[{id:"widthInput",iconHTML:"",type:"readonly",label:`<div class="fn__flex-center">
<input class="b3-text-field" value="${o.style.width.endsWith("px")?parseInt(o.style.width):""}" type="number" style="margin: 4px" placeholder="${window.siyuan.languages.width}"> px
</div>`,bind:l=>{const r=l.querySelector("input");r.addEventListener("input",()=>{t.forEach(c=>{c.style.width=r.value+"px",c.style.flex="none"}),n.value="0",n.parentElement.setAttribute("aria-label",r.value+"px")}),this.updateNodeElements(t,a,r)}}];["25%","33%","50%","67%","75%","100%"].forEach(l=>{i.push({id:"width_"+l,iconHTML:"",label:l,click:()=>{this.genClick(t,a,r=>{r.style.width=l,r.style.flex="none"})}})}),i.push({id:"separator_1",type:"separator"});const s=o.style.width.endsWith("%")?parseInt(o.style.width):0;window.siyuan.menus.menu.append(new MenuItem({id:"width",label:window.siyuan.languages.width,submenu:i.concat([{id:"widthDrag",iconHTML:"",type:"readonly",label:`<div style="margin: 4px 0;"  aria-label="${o.style.width.endsWith("px")?o.style.width:o.style.width||window.siyuan.languages.default}" class="b3-tooltips b3-tooltips__n${isMobile()?"":" fn__size200"}">
    <input style="box-sizing: border-box" value="${s}" class="b3-slider fn__block" max="100" min="1" step="1" type="range">
</div>`,bind:l=>{n=l.querySelector("input"),n.addEventListener("input",()=>{t.forEach(r=>{r.style.width=n.value+"%",r.style.flex="none"}),n.parentElement.setAttribute("aria-label",`${n.value}%`)}),this.updateNodeElements(t,a,n)}},{id:"separator_2",type:"separator"},{id:"default",iconHTML:"",label:window.siyuan.languages.default,click:()=>{this.genClick(t,a,l=>{l.style.width&&(l.style.width="",l.style.flex="")})}}])}).element)}genHeights(t,a){if(t.find(r=>{if(!r.classList.contains("p")&&!r.classList.contains("code-block")&&!r.classList.contains("render-node"))return!0}))return;let o;const i=t[0],s=[{id:"heightInput",iconHTML:"",type:"readonly",label:`<div class="fn__flex-center">
<input class="b3-text-field" value="${i.style.height.endsWith("px")?parseInt(i.style.height):""}" type="number" style="margin: 4px" placeholder="${window.siyuan.languages.height}"> px
</div>`,bind:r=>{const c=r.querySelector("input");c.addEventListener("input",()=>{t.forEach(d=>{d.style.height=c.value+"px",d.style.flex="none"}),o.value="0",o.parentElement.setAttribute("aria-label",c.value+"px")}),this.updateNodeElements(t,a,c)}}];["25%","33%","50%","67%","75%","100%"].forEach(r=>{s.push({id:"height_"+r,iconHTML:"",label:r,click:()=>{this.genClick(t,a,c=>{c.style.height=r,c.style.flex="none"})}})}),s.push({type:"separator"});const l=i.style.height.endsWith("%")?parseInt(i.style.height):0;window.siyuan.menus.menu.append(new MenuItem({id:"heightDrag",label:window.siyuan.languages.height,submenu:s.concat([{iconHTML:"",type:"readonly",label:`<div style="margin: 4px 0;"  aria-label="${i.style.height.endsWith("px")?i.style.height:i.style.height||window.siyuan.languages.default}" class="b3-tooltips b3-tooltips__n${isMobile()?"":" fn__size200"}">
    <input style="box-sizing: border-box" value="${l}" class="b3-slider fn__block" max="100" min="1" step="1" type="range">
</div>`,bind:r=>{o=r.querySelector("input"),o.addEventListener("input",()=>{t.forEach(c=>{c.style.height=o.value+"%",c.style.flex="none"}),o.parentElement.setAttribute("aria-label",`${o.value}%`)}),this.updateNodeElements(t,a,o)}},{type:"separator"},{id:"default",iconHTML:"",label:window.siyuan.languages.default,click:()=>{this.genClick(t,a,r=>{r.style.height&&(r.style.height="",r.style.overflow="")})}}])}).element)}genCopyTextRef(t){return isNotEditBlock(t[0])?!1:{id:"copyText",iconHTML:"",accelerator:window.siyuan.config.keymap.editor.general.copyText.custom,label:window.siyuan.languages.copyText,click(){t[0].setAttribute("data-reftext","true"),focusByRange(getEditorRange(t[0])),document.execCommand("copy")}}}render(t,a,n,o){var i;if(t.title&&t.title.element.getAttribute("data-render")!=="true")return;const s=n.parentElement.parentElement.querySelector(".protyle-select");if(s&&!s.classList.contains("fn__none"))return;let l="",r=a,c=0,d=0,u,g=!1;for(;r;){const _=!g||g&&r.getAttribute("fold")==="1";if(!isInEmbedBlock(r)){let E;_&&(E=r.getAttribute("data-type"));let C=r.getAttribute("data-node-id");if(E==="NodeAttributeView"&&o){const x=hasClosestByClassName(o,"av__row");if(x&&!x.classList.contains("av__row--header")){a=x;let T=isMac()?window.siyuan.languages.rowTip:window.siyuan.languages.rowTip.replace("\u21E7","Shift+");t.disabled?T=window.siyuan.languages.rowTip.substring(0,window.siyuan.languages.rowTip.indexOf("<br")):((i=x.querySelector('[data-dtype="block"]'))==null?void 0:i.getAttribute("data-detached"))==="true"&&(T=window.siyuan.languages.rowTip.substring(0,window.siyuan.languages.rowTip.lastIndexOf("<br"))),l=`<button data-type="NodeAttributeViewRowMenu" data-node-id="${C}" data-row-id="${x.dataset.id}" class="ariaLabel" data-position="west" aria-label="${T}"><svg><use xlink:href="#iconDrag"></use></svg><span ${t.disabled?"":'draggable="true" class="fn__grab"'}></span></button>`,t.disabled||(l=`<button data-type="NodeAttributeViewRow" data-node-id="${C}" data-row-id="${x.dataset.id}" class="ariaLabel" data-position="west" aria-label="${isMac()?window.siyuan.languages.addBelowAbove:window.siyuan.languages.addBelowAbove.replace("\u2325","Alt+")}"><svg><use xlink:href="#iconAdd"></use></svg></button>${l}`);break}}if(d===0){if(["NodeBlockquote","NodeList","NodeSuperBlock"].includes(E))return;const x=getTopAloneElement(r);u=x.querySelector(".li")||x.querySelector(".list"),isInEmbedBlock(u)&&(u=void 0),!x.isSameNode(r)&&E!=="NodeHeading"&&(r=x,E=r.getAttribute("data-type"),C=r.getAttribute("data-node-id"))}E==="NodeListItem"&&d===1&&!_&&(l=""),d+=1;let k=this.gutterTip;t.disabled&&(k=this.gutterTip.split("<br>").splice(0,2).join("<br>"));let v="";t.options.backlinkData&&(v=`class="popover__block" data-id="${C}"`);const A=`<button class="ariaLabel" data-position="west" aria-label="${k}" 
data-type="${E}" data-subtype="${r.getAttribute("data-subtype")}" data-node-id="${C}">
    <svg><use xlink:href="#${getIconByType(E,r.getAttribute("data-subtype"))}"></use></svg>
    <span ${v} ${t.disabled?"":'draggable="true"'}></span>
</button>`;_&&(l=A+l);let L="";if(E==="NodeListItem"&&r.childElementCount>3||E==="NodeHeading"){const x=r.getAttribute("fold");L=`<button class="ariaLabel" data-position="west" aria-label="${window.siyuan.languages.fold}" 
data-type="fold" style="cursor:inherit;"><svg style="width: 10px${x&&x==="1"?"":";transform:rotate(90deg)"}"><use xlink:href="#iconPlay"></use></svg></button>`}(E==="NodeListItem"||E==="NodeList")&&(u=r,E==="NodeListItem"&&r.childElementCount>3&&(l=A+L)),E==="NodeHeading"&&(l=l+L),E==="NodeBlockquote"&&(c+=8),r.previousElementSibling&&r.previousElementSibling.getAttribute("data-node-id")&&(g=!0)}const h=hasClosestBlock(r.parentElement);if(h)r=h;else break}let f=!0;const p=this.element.querySelectorAll("button");if(p.length!==l.split("</button>").length-1?f=!1:Array.from(p).find(_=>{const h=_.getAttribute("data-node-id");if(h&&l.indexOf(h)===-1)return f=!1,!0;const E=_.getAttribute("data-row-id");if(E&&l.indexOf(E)===-1||!E&&l.indexOf("NodeAttributeViewRowMenu")>-1)return f=!1,!0}),f&&this.element.childElementCount>0){this.element.classList.remove("fn__none");return}this.element.innerHTML=l,this.element.classList.remove("fn__none"),this.element.style.width="";const m=n.parentElement.getBoundingClientRect().top;let b=a.getBoundingClientRect(),w=0;if(u&&!window.siyuan.config.editor.rtl){const _=u.firstElementChild.getBoundingClientRect();_.right<=b.right&&(b=_,c=0)}else r.getAttribute("data-type")==="NodeBlockQueryEmbed"?(b=r.getBoundingClientRect(),c=0):a.classList.contains("av__row")||(b.height<Math.floor(window.siyuan.config.editor.fontSize*1.625)+8||b.height>Math.floor(window.siyuan.config.editor.fontSize*1.625)+8&&b.height<Math.floor(window.siyuan.config.editor.fontSize*1.625)*2+8?w=(b.height-this.element.clientHeight)/2:(r.getAttribute("data-type")==="NodeAttributeView"||a.getAttribute("data-type")==="NodeAttributeView")&&m<b.top&&(w=8));this.element.style.top=`${Math.max(b.top,m)+w}px`;let y=b.left-this.element.clientWidth-c;r.getAttribute("data-type")==="NodeBlockQueryEmbed"&&this.element.childElementCount===1?y=r.getBoundingClientRect().left-this.element.clientWidth-c:a.classList.contains("av__row")&&(y=r.getBoundingClientRect().left-this.element.clientWidth-c+parseInt(getComputedStyle(r).paddingLeft)),this.element.style.left=`${y}px`,y<this.element.parentElement.getBoundingClientRect().left?(this.element.style.width="24px",this.element.style.left=`${b.left-this.element.clientWidth-c/2+3}px`,l="",Array.from(this.element.children).reverse().forEach((_,h)=>{h!==0&&(_.firstElementChild.style.height="14px"),l+=_.outerHTML}),this.element.innerHTML=l):this.element.querySelectorAll("svg").forEach(_=>{_.style.height=""})}}const Mo=(e,t)=>{if(window.siyuan.config.fileTree.removeDocWithoutConfirm){fetchPost("/api/filetree/removeDoc",{notebook:e,path:t});return}fetchPost("/api/block/getDocInfo",{id:getDisplayName(t,!0,!0)},a=>{const n=escapeHtml(a.data.name);let o=`${window.siyuan.languages.confirmDeleteTip.replace("${x}",n)}
<div class="fn__hr"></div>
<div class="ft__smaller ft__on-surface">${window.siyuan.languages.rollbackTip.replace("${x}",window.siyuan.config.editor.historyRetentionDays)}</div>`;a.data.subFileCount>0&&(o=`${window.siyuan.languages.andSubFile.replace("${x}",n).replace("${y}",a.data.subFileCount)}
<div class="fn__hr"></div>
<div class="ft__smaller ft__on-surface">${window.siyuan.languages.rollbackTip.replace("${x}",window.siyuan.config.editor.historyRetentionDays)}</div>`),confirmDialog(window.siyuan.languages.deleteOpConfirm,o,()=>{fetchPost("/api/filetree/removeDoc",{notebook:e,path:t})},void 0,!0)})},Xd=e=>{if(e.length===1){const t=hasTopClosestByTag(e[0],"UL");if(t){const a=t.getAttribute("data-url");e[0].getAttribute("data-type")==="navigation-file"?Mo(a,e[0].getAttribute("data-path")):confirmDialog(window.siyuan.languages.deleteOpConfirm,`${window.siyuan.languages.confirmDeleteTip.replace("${x}",Lute.EscapeHTMLStr(getNotebookName(a)))}
<div class="fn__hr"></div>
<div class="ft__smaller ft__on-surface">${window.siyuan.languages.rollbackTip.replace("${x}",window.siyuan.config.editor.historyRetentionDays)}</div>`,()=>{fetchPost("/api/notebook/removeNotebook",{notebook:a,callback:Constants.CB_MOUNT_REMOVE})},void 0,!0)}}else{const t=[];if(e.forEach(a=>{a.getAttribute("data-path")!=="/"&&t.push(a.getAttribute("data-path"))}),t.length===0){showMessage(window.siyuan.languages.notBatchRemove);return}confirmDialog(window.siyuan.languages.deleteOpConfirm,`${window.siyuan.languages.confirmRemoveAll.replace("${count}",t.length)}
<div class="fn__hr"></div>
<div class="ft__smaller ft__on-surface">${window.siyuan.languages.rollbackTip.replace("${x}",window.siyuan.config.editor.historyRetentionDays)}</div>`,()=>{fetchPost("/api/filetree/removeDocs",{paths:t})},void 0,!0)}};var da=(e,t,a)=>new Promise((n,o)=>{var i=r=>{try{l(a.next(r))}catch(c){o(c)}},s=r=>{try{l(a.throw(r))}catch(c){o(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(i,s);l((a=a.apply(e,t)).next())});const ua=(e,t=0)=>{let a=0,n=0;return e.cards.forEach((o,i)=>{i>t||(o.state===0?a++:n++)}),`<span class="ariaLabel" aria-label="${window.siyuan.languages.flashcardNewCard}">
    <span class="ft__error">${a}</span> /
    <span class="ariaLabel ft__primary" aria-label="${window.siyuan.languages.flashcardNewCard}">${e.unreviewedNewCardCount}</span>
</span>
<span class="fn__space"></span>+<span class="fn__space"></span>
<span class="ariaLabel" aria-label="${window.siyuan.languages.flashcardReviewCard}">
    <span class="ft__error">${n}</span> /
    <span class="ft__success">${e.unreviewedOldCardCount}</span>
</span>`},Do=e=>{let t;return t=`<div class="toolbar toolbar--border">
    <svg class="toolbar__icon"><use xlink:href="#iconRiffCard"></use></svg>
    <span class="fn__flex-1 fn__flex-center toolbar__text">${window.siyuan.languages.riffCard}</span>
    <div data-type="count" class="${e.cardsData.cards.length===0?"fn__none":"fn__flex"}">${ua(e.cardsData)}</span></div>
    <svg class="toolbar__icon" data-id="${e.id||""}" data-cardtype="${e.cardType}" data-type="filter"><use xlink:href="#iconFilter"></use></svg>
    <svg class="toolbar__icon" data-type="more"><use xlink:href="#iconMore"></use></svg>
    <svg class="toolbar__icon" data-type="close"><use xlink:href="#iconCloseRound"></use></svg>
</div>`,`<div class="card__main">
    ${t}
    <div class="card__block fn__flex-1 ${e.cardsData.cards.length===0?"fn__none":""}" data-type="render"></div>
    <div class="card__empty card__empty--space${e.cardsData.cards.length===0?"":" fn__none"}" data-type="empty">
        <div>\u{1F52E}</div>
        ${window.siyuan.languages.noDueCard}
    </div>
    <div class="fn__flex card__action fn__none">
        <button class="b3-button b3-button--cancel" disabled="disabled" data-type="-2" style="width: 25%;min-width: 86px;display: flex">
            <svg><use xlink:href="#iconLeft"></use></svg>
            ${isMobile()?"":"(p / q)"}
        </button>
        <span class="fn__space"></span>
        <button data-type="-1" class="b3-button fn__flex-1">${window.siyuan.languages.cardShowAnswer}${isMobile()?"":" ("+window.siyuan.languages.space+" / "+window.siyuan.languages.enterKey+")"}</button>
    </div>
    <div class="fn__flex card__action fn__none">
        <div>
            <button class="b3-button b3-button--cancel" disabled="disabled" style="display: flex;margin-bottom: 8px;height: 28px;padding: 0;" data-type="-2"><svg><use xlink:href="#iconLeft"></use></svg>${isMobile()?"":"(p / q)"}</button>
            <button data-type="-3" aria-label="0 / x" class="b3-button b3-button--cancel b3-tooltips__n b3-tooltips">
                <div class="card__icon">\u{1F4A4}</div>
                ${window.siyuan.languages.skip}${isMobile()?"":" (0)"}
            </button>
        </div>
        <div>
            <span></span>
            <button data-type="1" aria-label="1 / j / a" class="b3-button b3-button--error b3-tooltips__n b3-tooltips">
                <div class="card__icon">\u{1F648}</div>
                ${window.siyuan.languages.cardRatingAgain}${isMobile()?"":" (1)"}
            </button>
        </div>
        <div>
            <span></span>
            <button data-type="2" aria-label="2 / k / s" class="b3-button b3-button--warning b3-tooltips__n b3-tooltips">
                <div class="card__icon">\u{1F62C}</div>
                ${window.siyuan.languages.cardRatingHard}${isMobile()?"":" (2)"}
            </button>
        </div>
        <div>
            <span></span>
            <button data-type="3" aria-label="3 / l / d / ${window.siyuan.languages.space} / ${window.siyuan.languages.enterKey}" class="b3-button b3-button--info b3-tooltips__n b3-tooltips">
                <div class="card__icon">\u{1F60A}</div>
                ${window.siyuan.languages.cardRatingGood}${isMobile()?"":" (3)"}
            </button>
        </div>
        <div>
            <span></span>
            <button data-type="4" aria-label="4 / ; / f" class="b3-button b3-button--success b3-tooltips__n b3-tooltips">
                <div class="card__icon">\u{1F308}</div>
                ${window.siyuan.languages.cardRatingEasy}${isMobile()?"":" (4)"}
            </button>
        </div>
    </div>
</div>`},cs=(e,t,a,n)=>{fetchPost("/api/block/getDocInfo",{id:e},o=>{t.wysiwyg.renderCustom(o.data.ial),fetchPost("/api/filetree/getDoc",{id:e,mode:0,size:Constants.SIZE_GET_MAX},i=>{onGet({updateReadonly:!0,data:i,protyle:t,action:i.data.rootID===i.data.id?[Constants.CB_GET_HTML]:[Constants.CB_GET_ALL,Constants.CB_GET_HTML],afterCB:()=>{let s=!1;!window.siyuan.config.flashcard.superBlock&&!window.siyuan.config.flashcard.heading&&!window.siyuan.config.flashcard.list&&!window.siyuan.config.flashcard.mark?s=!1:(window.siyuan.config.flashcard.superBlock&&t.wysiwyg.element.querySelector(":scope > .sb")&&(s=!0),window.siyuan.config.flashcard.heading&&t.wysiwyg.element.querySelector(':scope > [data-type="NodeHeading"]')&&(s=!0),window.siyuan.config.flashcard.list&&t.wysiwyg.element.querySelector(".list, .li")&&(s=!0),window.siyuan.config.flashcard.mark&&t.wysiwyg.element.querySelector('span[data-type~="mark"]')&&(s=!0));const l=a.querySelectorAll(".card__action");s?(window.siyuan.config.flashcard.superBlock&&t.element.classList.add("card__block--hidesb"),window.siyuan.config.flashcard.heading&&t.element.classList.add("card__block--hideh"),window.siyuan.config.flashcard.list&&t.element.classList.add("card__block--hideli"),window.siyuan.config.flashcard.mark&&t.element.classList.add("card__block--hidemark"),l[0].classList.remove("fn__none"),l[1].classList.add("fn__none")):(t.element.classList.remove("card__block--hidemark","card__block--hideli","card__block--hidesb","card__block--hideh"),l[0].classList.add("fn__none"),l[1].querySelectorAll("button.b3-button").forEach((r,c)=>{c<2||(r.previousElementSibling.textContent=n.nextDues[c-1])}),l[1].classList.remove("fn__none"))}})})})},$o=e=>da(void 0,null,function*(){window.siyuan.storage[Constants.LOCAL_FLASHCARD].fullscreen&&fullscreen(e.element.querySelector(".card__main"),e.element.querySelector('[data-type="fullscreen"]'));let t=0;typeof e.index=="number"&&(t=e.index);const a=new Protyle(e.app,e.element.querySelector("[data-type='render']"),{blockId:"",action:[Constants.CB_GET_ALL],render:{background:!1,gutter:!0,breadcrumbDocName:!0},typewriterMode:!1});window.siyuan.mobile&&(window.siyuan.mobile.popEditor=a),e.cardsData.cards.length>0&&cs(e.cardsData.cards[t].blockID,a.protyle,e.element,e.cardsData.cards[t]),e.element.setAttribute("data-key",Constants.DIALOG_OPENCARD);const n=e.element.querySelectorAll(".card__action");e.index===0||typeof e.index=="undefined"?(n[0].firstElementChild.setAttribute("disabled","disabled"),n[1].querySelector(".b3-button").setAttribute("disabled","disabled")):(n[0].firstElementChild.removeAttribute("disabled"),n[1].querySelector(".b3-button").removeAttribute("disabled"));const o=e.element.querySelector('[data-type="count"]'),i=e.element.querySelector('[data-type="filter"]'),s=()=>{const l=i.getAttribute("data-cardtype"),r=i.getAttribute("data-id");fetchPost(l==="all"?"/api/riff/getRiffDueCards":l==="doc"?"/api/riff/getTreeRiffDueCards":"/api/riff/getNotebookRiffDueCards",{rootID:r,deckID:r,notebook:r},c=>da(void 0,null,function*(){t=0,e.cardsData=c.data;for(let d=0;d<e.app.plugins.length;d++)e.cardsData=yield e.app.plugins[d].updateCards(e.cardsData);e.cardsData.cards.length>0?ga({countElement:o,editor:a,actionElements:n,index:t,cardsData:e.cardsData}):ds(o,a,n)}))};return o.innerHTML=ua(e.cardsData,t),e.element.addEventListener("click",l=>{const r=l.target;let c="";const d=e.cardsData.cards[t],u=i.getAttribute("data-id");if(typeof l.detail=="string")["1","j","a"].includes(l.detail)?c="1":["2","k","s"].includes(l.detail)?c="2":["3","l","d"].includes(l.detail)?c="3":["4",";","f"].includes(l.detail)?c="4":[" ","enter"].includes(l.detail)?c="-1":["p","q"].includes(l.detail)?c="-2":["0","x"].includes(l.detail)&&(c="-3");else{if(hasClosestByAttribute(r,"data-type","fullscreen")){fullscreen(e.element.querySelector(".card__main"),e.element.querySelector('[data-type="fullscreen"]')),resize(a.protyle),window.siyuan.storage[Constants.LOCAL_FLASHCARD].fullscreen=!window.siyuan.storage[Constants.LOCAL_FLASHCARD].fullscreen,setStorageVal(Constants.LOCAL_FLASHCARD,window.siyuan.storage[Constants.LOCAL_FLASHCARD]),l.stopPropagation(),l.preventDefault();return}if(hasClosestByAttribute(r,"data-type","more")){if(l.stopPropagation(),l.preventDefault(),i.getAttribute("data-cardtype")==="all"&&i.getAttribute("data-id")){showMessage(window.siyuan.languages.noSupportTip);return}const w=new Menu;w.addItem({id:"setDueTime",icon:"iconClock",label:window.siyuan.languages.setDueTime,click(){const y=new Dialog({title:window.siyuan.languages.setDueTime,content:`<div class="b3-dialog__content">
    <div class="b3-label__text">${window.siyuan.languages.showCardDay}</div>
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__block" value="1" type="number" step="1" min="1">
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px"}),_=y.element.querySelector("input"),h=y.element.querySelectorAll(".b3-button");y.bindInput(_,()=>{h[1].click()}),_.focus(),_.select(),h[0].addEventListener("click",()=>{y.destroy()}),h[1].addEventListener("click",()=>{fetchPost("/api/riff/batchSetRiffCardsDueTime",{cardDues:[{id:d.cardID,due:dayjs().add(parseInt(_.value),"day").format("YYYYMMDDHHmmss")}]},()=>{n[0].classList.add("fn__none"),n[1].classList.remove("fn__none"),d.state===0?e.cardsData.unreviewedNewCardCount--:e.cardsData.unreviewedOldCardCount--,e.element.dispatchEvent(new CustomEvent("click",{detail:"0"})),e.cardsData.cards.splice(t,1),t--,y.destroy()})})}}),d.state!==0&&w.addItem({id:"reset",icon:"iconRefresh",label:window.siyuan.languages.reset,click(){fetchPost("/api/riff/resetRiffCards",{type:i.getAttribute("data-cardtype"),id:u,deckID:Constants.QUICK_DECK_ID,blockIDs:[d.blockID]},()=>{const y=window.siyuan.languages._time["1m"].replace("%s","");d.lapses=0,d.lastReview=-621355968e5,d.reps=0,d.state=0,d.nextDues={1:y,2:y.replace("1","5"),3:y.replace("1","10"),4:window.siyuan.languages._time["1d"].replace("%s","").replace("1","6")},n[1].querySelectorAll("button.b3-button").forEach((_,h)=>{h<2||(_.previousElementSibling.textContent=d.nextDues[h-1])}),e.cardsData.unreviewedOldCardCount--,e.cardsData.unreviewedNewCardCount++,o.innerHTML=ua(e.cardsData,t)})}}),w.addItem({id:"removeRiffCard",icon:"iconTrashcan",label:`${window.siyuan.languages.remove} <b>${window.siyuan.languages.riffCard}</b>`,click(){n[0].classList.add("fn__none"),n[1].classList.remove("fn__none"),d.state===0?e.cardsData.unreviewedNewCardCount--:e.cardsData.unreviewedOldCardCount--,e.element.dispatchEvent(new CustomEvent("click",{detail:"0"})),transaction(void 0,[{action:"removeFlashcards",deckID:Constants.QUICK_DECK_ID,blockIDs:[d.blockID]}]),e.cardsData.cards.splice(t,1),t--}}),w.addSeparator(),w.addItem({id:"forgetCountAndRevisionCountAndCardStatusAndLastReviewTime",iconHTML:"",type:"readonly",label:`<div class="fn__flex">
    <div class="fn__flex-1 ft__breakword">${window.siyuan.languages.forgetCount}</div>
    <div class="fn__space"></div>
    <div>${d.lapses}</div>
</div><div class="fn__flex">
    <div class="fn__flex-1 ft__breakword">${window.siyuan.languages.revisionCount}</div>
    <div class="fn__space"></div>
    <div>${d.reps}</div>
</div><div class="fn__flex">
    <div class="fn__flex-1 ft__breakword">${window.siyuan.languages.cardStatus}</div>
    <div class="fn__space"></div>
    <div class="${d.state===0?"ft__primary":"ft__success"}">${d.state===0?window.siyuan.languages.flashcardNewCard:window.siyuan.languages.flashcardReviewCard}</div>
</div><div class="fn__flex${d.lastReview>0?"":" fn__none"}">
    <div class="fn__flex-1 ft__breakword" style="width: 170px;">${window.siyuan.languages.lastReviewTime}</div>
    <div class="fn__space"></div>
    <div>${dayjs(d.lastReview).format("YYYY-MM-DD")}</div>
</div>`}),w.fullscreen();return}if(hasClosestByAttribute(r,"data-type","close")){e.dialog&&e.dialog.destroy(),l.stopPropagation(),l.preventDefault();return}const m=hasClosestByAttribute(r,"data-type","filter");if(m){fetchPost("/api/riff/getRiffDecks",{},w=>{window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.append(new MenuItem({id:"all",iconHTML:"",label:window.siyuan.languages.all,click(){i.setAttribute("data-id",""),i.setAttribute("data-cardtype","all"),s()}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"fileTree",iconHTML:"",label:window.siyuan.languages.fileTree,click(){movePathTo((_,h)=>{i.setAttribute("data-id",_[0]==="/"?h[0]:getDisplayName(_[0],!0,!0)),i.setAttribute("data-cardtype",_[0]==="/"?"notebook":"doc"),s()},[],void 0,window.siyuan.languages.specifyPath,!0)}}).element),(e.title||w.data.length>0)&&window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element),e.title&&(window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",label:escapeHtml(e.title),click(){i.setAttribute("data-id",e.id),i.setAttribute("data-cardtype",e.cardType),s()}}).element),w.data.length>0&&window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element)),w.data.forEach(_=>{window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",label:escapeHtml(_.name),click(){i.setAttribute("data-id",_.id),i.setAttribute("data-cardtype","all"),s()}}).element)});const y=m.getBoundingClientRect();window.siyuan.menus.menu.popup({x:y.left,y:y.bottom})}),l.stopPropagation(),l.preventDefault();return}if(hasClosestByAttribute(r,"data-type","newround")){s(),l.stopPropagation(),l.preventDefault();return}}if(!c){const g=hasClosestByClassName(r,"b3-button");g&&(c=g.getAttribute("data-type"))}if(!(!c||!d)){if(l.preventDefault(),l.stopPropagation(),hideElements(["toolbar","hint","util","gutter"],a.protyle),c==="-1")if(n[0].classList.contains("fn__none"))c="3";else{a.protyle.element.classList.remove("card__block--hidemark","card__block--hideli","card__block--hidesb","card__block--hideh"),n[0].classList.add("fn__none"),n[1].querySelectorAll("button.b3-button").forEach((g,f)=>{f<2||(g.previousElementSibling.textContent=d.nextDues[f-1])}),n[1].classList.remove("fn__none"),fa(e.app,d,c);return}else if(c==="-2"){t>0&&(t--,ga({countElement:o,editor:a,actionElements:n,index:t,cardsData:e.cardsData}),fa(e.app,e.cardsData.cards[t+1],c));return}["1","2","3","4","-3"].includes(c)&&n[0].classList.contains("fn__none")&&fetchPost(c==="-3"?"/api/riff/skipReviewRiffCard":"/api/riff/reviewRiffCard",{deckID:d.deckID,cardID:d.cardID,rating:parseInt(c),reviewedCards:e.cardsData.cards},()=>{if(c!=="-3"&&(window.siyuan.config.sync.provider!==0&&isPaidUser()||window.siyuan.config.sync.provider===0&&!needSubscribe(""))&&window.siyuan.config.repo.key&&window.siyuan.config.sync.enabled&&document.getElementById("toolbarSync").classList.remove("fn__none"),t++,t>e.cardsData.cards.length-1){const g=i.getAttribute("data-cardtype");fetchPost(g==="all"?"/api/riff/getRiffDueCards":g==="doc"?"/api/riff/getTreeRiffDueCards":"/api/riff/getNotebookRiffDueCards",{rootID:u,deckID:u,notebook:u,reviewedCards:e.cardsData.cards},f=>da(void 0,null,function*(){fa(e.app,e.cardsData.cards[t-1],c),t=0,e.cardsData=f.data;for(let p=0;p<e.app.plugins.length;p++)e.cardsData=yield e.app.plugins[p].updateCards(e.cardsData);e.cardsData.cards.length===0?e.cardsData.unreviewedCount>0?No(o,a,n,f.data.unreviewedCount):ds(o,a,n):ga({countElement:o,editor:a,actionElements:n,index:t,cardsData:e.cardsData})}));return}ga({countElement:o,editor:a,actionElements:n,index:t,cardsData:e.cardsData}),fa(e.app,e.cardsData.cards[t-1],c)})}}),a}),fa=(e,t,a)=>{e.plugins.forEach(n=>{n.eventBus.emit("click-flashcard-action",{type:a,card:t})})},Jd=e=>{window.siyuan.config.readonly||fetchPost("/api/riff/getRiffDueCards",{deckID:""},t=>{Ho(e,t.data,"all")})},Ho=(e,t,a,n,o)=>da(void 0,null,function*(){if(window.siyuan.dialogs.find(c=>{if(c.element.getAttribute("data-key")===Constants.DIALOG_OPENCARD)return c.destroy(),!0}))return;let s;getSelection().rangeCount>0&&(s=getSelection().getRangeAt(0));for(let c=0;c<e.plugins.length;c++)t=yield e.plugins[c].updateCards(t);const l=new Dialog({positionId:Constants.DIALOG_OPENCARD,content:Do({id:n,cardType:a,cardsData:t,isTab:!1}),width:isMobile()?"100vw":"80vw",height:isMobile()?"100vh":"70vh",destroyCallback(){r&&(r.destroy(),window.siyuan.mobile&&(window.siyuan.mobile.popEditor=null)),s&&focusByRange(s)},resizeCallback(c){c!=="d"&&c!=="t"&&r&&r.resize()}});l.element.querySelector(".b3-dialog__scrim").style.backgroundColor="var(--b3-theme-background)",l.element.querySelector(".b3-dialog__container").style.maxWidth="1024px";const r=yield $o({app:e,element:l.element,cardsData:t,title:o,id:n,cardType:a,dialog:l});r.resize(),l.editors={card:r},updateCardHV()}),ga=e=>{e.editor.protyle.element.classList.remove("fn__none"),e.editor.protyle.element.nextElementSibling.classList.add("fn__none"),e.countElement.innerHTML=ua(e.cardsData,e.index),e.countElement.classList.remove("fn__none"),e.index===0?(e.actionElements[0].firstElementChild.setAttribute("disabled","disabled"),e.actionElements[1].querySelector(".b3-button").setAttribute("disabled","disabled")):(e.actionElements[0].firstElementChild.removeAttribute("disabled"),e.actionElements[1].querySelector(".b3-button").removeAttribute("disabled")),cs(e.cardsData.cards[e.index].blockID,e.editor.protyle,hasClosestByAttribute(e.countElement,"data-key",Constants.DIALOG_OPENCARD),e.cardsData.cards[e.index])},ds=(e,t,a)=>{e.classList.add("fn__none"),t.protyle.element.classList.add("fn__none");const n=t.protyle.element.nextElementSibling;n.innerHTML=`<div>\u{1F52E}</div>${window.siyuan.languages.noDueCard}`,n.classList.remove("fn__none"),a[0].classList.add("fn__none"),a[1].classList.add("fn__none")},No=(e,t,a,n)=>{e.classList.add("fn__none"),t.protyle.element.classList.add("fn__none");const o=t.protyle.element.nextElementSibling;o.innerHTML=`<div>\u267B\uFE0F </div>
<span>${window.siyuan.languages.continueReview2.replace("${count}",n)}</span>
<div class="fn__hr"></div>
<button data-type="newround" class="b3-button fn__size200">${window.siyuan.languages.continueReview1}</button>`,o.classList.remove("fn__none"),a[0].classList.add("fn__none"),a[1].classList.add("fn__none")};let Ot,qt=!1;const pa=(e,t,a)=>{const n=e.querySelector('[data-type="docprevious"]'),o=e.querySelector('[data-type="docnext"]');t>1?n.removeAttribute("disabled"):n.setAttribute("disabled","disabled");const i=e.querySelector('.b3-select[data-type="opselect"]'),s=e.querySelector(".b3-list--background");e.querySelector(".protyle-title__input").classList.add("fn__none"),e.querySelector('.history__text[data-type="docPanel"]').classList.add("fn__none"),e.querySelector('.history__text[data-type="mdPanel"]').classList.add("fn__none"),fetchPost("/api/history/searchHistory",{query:a,page:t,op:i.value,type:3},l=>{t<l.data.pageCount?o.removeAttribute("disabled"):o.setAttribute("disabled","disabled");const r=e.querySelector('[data-type="jumpRepoPage"]');l.data.pageCount>1?r.removeAttribute("disabled"):r.setAttribute("disabled","disabled"),r.setAttribute("data-totalpage",l.data.pageCount.toString()),r.textContent=t.toString();const c=o.nextElementSibling.nextElementSibling;if(c.classList.remove("fn__none"),c.textContent=window.siyuan.languages.pageCountAndHistoryCount.replace("${x}",l.data.pageCount).replace("${y}",l.data.totalCount),l.data.histories.length===0){s.innerHTML=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;return}let d="";l.data.histories.forEach(u=>{d+=`<li class="b3-list-item b3-list-item--hide-action" data-created="${u}">
    <span class="b3-list-item__text">${dayjs(parseInt(u)*1e3).format("YYYY-MM-DD HH:mm:ss")}</span>
    <span class="fn__space"></span>
    <span class="b3-list-item__action b3-tooltips b3-tooltips__w" data-type="rollback" aria-label="${window.siyuan.languages.rollback}">
        <svg><use xlink:href="#iconUndo"></use></svg>
    </span>
</li>`}),s.innerHTML=d})},Qd=e=>{const t=`<div class="history__action">
    <div class="block__icons">
        <span data-type="docprevious" class="block__icon block__icon--show b3-tooltips b3-tooltips__e" disabled="disabled" aria-label="${window.siyuan.languages.previousLabel}"><svg><use xlink:href="#iconLeft"></use></svg></span>
        <button class="b3-button b3-button--text ft__selectnone" data-type="jumpRepoPage" disabled>1</button>
        <span data-type="docnext" class="block__icon block__icon--show b3-tooltips b3-tooltips__e" disabled="disabled" aria-label="${window.siyuan.languages.nextLabel}"><svg><use xlink:href="#iconRight"></use></svg></span>
        <span class="fn__space"></span>
        <span class="ft__on-surface fn__flex-shrink ft__selectnone fn__none">${window.siyuan.languages.pageCountAndHistoryCount}</span>
        <span class="fn__space"></span>
        <div class="fn__flex-1"></div>
        <select data-type="opselect" class="b3-select">
            <option value="all" selected>${window.siyuan.languages.allOp}</option>
            <option value="update">${window.siyuan.languages.historyUpdate}</option>
            <option value="format">${window.siyuan.languages.historyFormat}</option>
            <option value="sync">${window.siyuan.languages.historySync}</option>
            <option value="replace">${window.siyuan.languages.historyReplace}</option>
            <option value="outline">${window.siyuan.languages.historyOutline}</option>
        </select>
    </div>
</div>
<div class="fn__flex fn__flex-1 history__panel">
    <ul class="b3-list b3-list--background history__side" ${isMobile()?"":`style="width: ${window.siyuan.storage[Constants.LOCAL_HISTORY].sideDocWidth}"`}>
        <li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>
    </ul>
    <div class="history__resize"></div>
    <div class="fn__flex-1 fn__flex-column">
        <div class="protyle-title__input fn__none ft__center ft__breakword"></div>
        <textarea class="fn__flex-1 history__text fn__none" readonly data-type="mdPanel"></textarea>
        <div class="fn__flex-1 history__text fn__none" style="padding: 0" data-type="docPanel"></div>
    </div>
</div>`,a=new Dialog({title:e.pathString,content:t,width:isMobile()?"100vw":"90vw",height:isMobile()?"100vh":"80vh",containerClassName:"b3-dialog__container--theme",destroyCallback(){Ot=void 0}});a.element.setAttribute("data-key",Constants.DIALOG_HISTORYDOC);const n=a.element.querySelector(".b3-select");n.addEventListener("change",()=>{pa(a.element,1,e.id)});const o=a.element.querySelector('.history__text[data-type="docPanel"]'),i=a.element.querySelector('.history__text[data-type="mdPanel"]');pa(a.element,1,e.id),Ot=new Protyle(e.app,o,{blockId:"",history:{created:""},action:[Constants.CB_GET_HISTORY],render:{background:!1,gutter:!1,breadcrumb:!1,breadcrumbDocName:!1},typewriterMode:!1}),disabledProtyle(Ot.protyle);const s=a.element.querySelector('[data-type="jumpRepoPage"]'),l=a.element.querySelector(".protyle-title__input");a.element.addEventListener("click",r=>{let c=r.target;for(;c&&!c.isEqualNode(a.element);){const d=c.getAttribute("data-type");if(d==="rollback"&&!qt){us(c.parentElement,n.value,e.id,u=>{const g=u.path;qt=!1;const f=window.siyuan.languages.rollbackConfirm.replace("${name}",u.title).replace("${time}",c.previousElementSibling.previousElementSibling.textContent.trim());confirmDialog("\u26A0\uFE0F "+window.siyuan.languages.rollback,f,()=>{fetchPost("/api/history/rollbackDocHistory",{notebook:e.notebookId,historyPath:g})})}),r.stopPropagation(),r.preventDefault();break}else if(c.classList.contains("b3-list-item")&&!qt){us(c,n.value,e.id,u=>{var g;const f=u.path;fetchPost("/api/history/getDocHistoryContent",{historyPath:f},p=>{p.data.isLargeDoc?(i.value=p.data.content,i.classList.remove("fn__none"),o.classList.add("fn__none")):(i.classList.add("fn__none"),o.classList.remove("fn__none"),onGet({data:p,protyle:Ot.protyle,action:[Constants.CB_GET_HISTORY,Constants.CB_GET_HTML]})),l.textContent=u.title,l.classList.remove("fn__none"),qt=!1}),(g=c.parentElement.querySelector(".b3-list-item--focus"))==null||g.classList.remove("b3-list-item--focus"),c.classList.add("b3-list-item--focus")}),r.stopPropagation(),r.preventDefault();break}else if((d==="docprevious"||d==="docnext")&&c.getAttribute("disabled")!=="disabled"){const u=parseInt(s.textContent);pa(a.element,d==="docprevious"?u-1:u+1,e.id),r.stopPropagation(),r.preventDefault();break}else if(d==="jumpRepoPage"){const u=parseInt(c.getAttribute("data-totalpage")||"1");confirmDialog(window.siyuan.languages.jumpToPage.replace("${x}",u),`<input class="b3-text-field fn__block" type="number" min="1" max="${u}" value="${s.textContent}">`,g=>{const f=g.element.querySelector(".b3-text-field");f.value!==""&&pa(a.element,Math.max(1,Math.min(parseInt(f.value),u)),e.id)})}c=c.parentElement}}),resizeSide(a.element.querySelector(".history__resize"),a.element.querySelector(".history__side"),"sideDocWidth")},us=(e,t,a,n)=>{qt=!0;const o=e.getAttribute("data-path");o&&n(o);const i=e.getAttribute("data-created");Ot.protyle.options.history.created=i,fetchPost("/api/history/getHistoryItems",{query:a,op:t,type:3,created:i},s=>{n(s.data.items[0])})},fs=(e,t)=>{let a=`<option value="">${window.siyuan.languages.currentNotebook}</option>`;const n=[];return Object.keys(Constants.HELP_PATH).forEach(o=>{n.push(Constants.HELP_PATH[o])}),window.siyuan.notebooks.forEach(o=>{n.includes(o.id)||o.id===t||(a+=`<option value="${o.id}" ${e===o.id?"selected":""}>${escapeHtml(o.name)}</option>`)}),a},eu=e=>{const t=`<div class="fn__flex">${escapeHtml(e.name)}
<div class="fn__space"></div>
<button class="b3-button b3-button--small fn__flex-center">${window.siyuan.languages.copy} ID</button></div>`,a=`<div class="b3-dialog__content" style="background-color: var(--b3-theme-background);">
<div class="b3-label config__item">
    ${window.siyuan.languages.fileTree12}
    <div class="b3-label__text">${window.siyuan.languages.fileTree13}</div>
    <span class="fn__hr"></span>
    <div class="fn__flex">
        <select style="min-width: 200px" class="b3-select" id="docCreateSaveBox">${fs(e.conf.docCreateSaveBox,e.box)}</select>
        <div class="fn__space"></div>
        <input class="b3-text-field fn__flex-1" id="docCreateSavePath" value="">
    </div>
</div>
<div class="b3-label config__item">
    ${window.siyuan.languages.fileTree5}
    <div class="b3-label__text">${window.siyuan.languages.fileTree6}</div>
    <span class="fn__hr"></span>
    <div class="fn__flex">
        <select style="min-width: 200px" class="b3-select" id="refCreateSaveBox">${fs(e.conf.refCreateSaveBox,e.box)}</select>
        <div class="fn__space"></div>
        <input class="b3-text-field fn__flex-1" id="refCreateSavePath" value="">
    </div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.fileTree11}
    <div class="b3-label__text">${window.siyuan.languages.fileTree14}</div>
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__flex-center fn__block" id="dailyNoteSavePath" value="">
    <div class="fn__hr"></div>
    <div class="b3-label__text">${window.siyuan.languages.fileTree15}</div>
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__flex-center fn__block" id="dailyNoteTemplatePath" value="${e.conf.dailyNoteTemplatePath}">
</div></div>`;if(isMobile())openModel({title:t,icon:"iconSettings",html:`<div>${a}</div>`,bindEvent(){gs(document.querySelector("#model"),e)}});else{const n=new Dialog({width:"80vw",title:t,content:a});n.element.setAttribute("data-key",Constants.DIALOG_NOTEBOOKCONF),gs(n.element,e)}},gs=(e,t)=>{e.querySelector(".b3-button--small").addEventListener("click",()=>{writeText(t.box),showMessage(window.siyuan.languages.copied)});const a=e.querySelector("#dailyNoteSavePath");a.value=t.conf.dailyNoteSavePath;const n=e.querySelector("#docCreateSavePath");n.value=t.conf.docCreateSavePath;const o=e.querySelector("#refCreateSavePath");o.value=t.conf.refCreateSavePath;const i=e.querySelector("#dailyNoteTemplatePath");i.value=t.conf.dailyNoteTemplatePath,e.querySelectorAll("input, select").forEach(s=>{s.addEventListener("change",()=>{fetchPost("/api/notebook/setNotebookConf",{notebook:t.box,conf:{refCreateSavePath:o.value,refCreateSaveBox:e.querySelector("#refCreateSaveBox").value,docCreateSaveBox:e.querySelector("#docCreateSaveBox").value,docCreateSavePath:n.value,dailyNoteSavePath:a.value,dailyNoteTemplatePath:i.value}})})})};var ps=(e,t,a)=>new Promise((n,o)=>{var i=r=>{try{l(a.next(r))}catch(c){o(c)}},s=r=>{try{l(a.throw(r))}catch(c){o(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(i,s);l((a=a.apply(e,t)).next())});const ms=(e,t)=>{if(!Array.from(e).find(o=>{if(o.getAttribute("data-type")==="navigation-file")return!0}))return window.siyuan.menus.menu;const n=[];if(e.forEach(o=>{const i=o.getAttribute("data-node-id");i&&n.push(i)}),n.length>0&&window.siyuan.menus.menu.append(new MenuItem({id:"copy",label:window.siyuan.languages.copy,type:"submenu",icon:"iconCopy",submenu:copySubMenu(n).concat([{id:"duplicate",iconHTML:"",label:window.siyuan.languages.duplicate,accelerator:window.siyuan.config.keymap.editor.general.duplicate.custom,click(){n.forEach(o=>{fetchPost("/api/filetree/duplicateDoc",{id:o})})}}])}).element),window.siyuan.menus.menu.append(movePathToMenu(getTopPaths(Array.from(e)))),n.length>0&&window.siyuan.menus.menu.append(new MenuItem({id:"addToDatabase",label:window.siyuan.languages.addToDatabase,accelerator:window.siyuan.config.keymap.general.addToDatabase.custom,icon:"iconDatabase",click:()=>{addFilesToDatabase(Array.from(e))}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"delete",icon:"iconTrashcan",label:window.siyuan.languages.delete,accelerator:"\u2326",click:()=>{deleteFiles(Array.from(e))}}).element),n.length===0)return window.siyuan.menus.menu;if(window.siyuan.menus.menu.append(new MenuItem({id:"separator_1",type:"separator"}).element),!window.siyuan.config.readonly){const o=[{id:"quickMakeCard",iconHTML:"",accelerator:window.siyuan.config.keymap.editor.general.quickMakeCard.custom,label:window.siyuan.languages.quickMakeCard,click:()=>{transaction(void 0,[{action:"addFlashcards",deckID:Constants.QUICK_DECK_ID,blockIDs:n}],[{action:"removeFlashcards",deckID:Constants.QUICK_DECK_ID,blockIDs:n}])}},{id:"removeCard",iconHTML:"",label:window.siyuan.languages.removeCard,click:()=>{transaction(void 0,[{action:"removeFlashcards",deckID:Constants.QUICK_DECK_ID,blockIDs:n}],[{action:"addFlashcards",deckID:Constants.QUICK_DECK_ID,blockIDs:n}])}}];window.siyuan.config.flashcard.deck&&o.push({id:"addToDeck",iconHTML:"",label:window.siyuan.languages.addToDeck,click:()=>{makeCard(t,n)}}),window.siyuan.menus.menu.append(new MenuItem({id:"riffCard",label:window.siyuan.languages.riffCard,icon:"iconRiffCard",submenu:o}).element),window.siyuan.menus.menu.append(new MenuItem({id:"separator_2",type:"separator"}).element)}return openEditorTab(t,n),window.siyuan.menus.menu.append(new MenuItem({id:"export",label:window.siyuan.languages.export,type:"submenu",icon:"iconUpload",submenu:[{id:"exportMarkdown",label:"Markdown",icon:"iconMarkdown",click:()=>{const o=showMessage(window.siyuan.languages.exporting,-1);fetchPost(" /api/export/exportMds",{ids:n},i=>{hideMessage(o),openByMobile(i.data.zip)})}}]}).element),t.plugins&&emitOpenMenu({plugins:t.plugins,type:"open-menu-doctree",detail:{elements:e,type:"docs"},separatorPosition:"top"}),window.siyuan.menus.menu},tu=(e,t)=>{window.siyuan.menus.menu.remove();const a=hasClosestByTag(t,"DIV");if(!a)return window.siyuan.menus.menu;t.classList.contains("b3-list-item--focus")||(a.querySelectorAll(".b3-list-item--focus").forEach(s=>{s.classList.remove("b3-list-item--focus"),s.removeAttribute("select-end"),s.removeAttribute("select-start")}),t.classList.add("b3-list-item--focus"));const n=a.querySelectorAll(".b3-list-item--focus");if(n.length>1)return ms(n,e);const o=t.parentElement.getAttribute("data-url"),i=getNotebookName(o);if(!window.siyuan.config.readonly){window.siyuan.menus.menu.append(renameMenu({path:"/",notebookId:o,name:i,type:"notebook"})),window.siyuan.menus.menu.append(new MenuItem({id:"config",label:window.siyuan.languages.config,icon:"iconSettings",click:()=>{fetchPost("/api/notebook/getNotebookConf",{notebook:o},l=>{onGetnotebookconf(l.data)})}}).element);const s=Bo("notebook",parseInt(t.parentElement.getAttribute("data-sortmode")),l=>(fetchPost("/api/notebook/setNotebookConf",{notebook:o,conf:{sortMode:l}},()=>{var r;t.parentElement.setAttribute("data-sortmode",l.toString());let c;c=window.siyuan.mobile.docks.file;const d=t.querySelector(".b3-list-item__arrow--open");d&&(d.classList.remove("b3-list-item__arrow--open"),(r=t.nextElementSibling)==null||r.remove(),c.getLeaf(t,o))}),!0));window.siyuan.menus.menu.append(new MenuItem({id:"sort",icon:"iconSort",label:window.siyuan.languages.sort,type:"submenu",submenu:s}).element)}return window.siyuan.config.readonly||window.siyuan.menus.menu.append(new MenuItem({id:"riffCard",label:window.siyuan.languages.riffCard,type:"submenu",icon:"iconRiffCard",submenu:[{id:"spaceRepetition",iconHTML:"",label:window.siyuan.languages.spaceRepetition,accelerator:window.siyuan.config.keymap.editor.general.spaceRepetition.custom,click:()=>{fetchPost("/api/riff/getNotebookRiffDueCards",{notebook:o},s=>{openCardByData(e,s.data,"notebook",o,i)}),closePanel()}},{id:"manage",iconHTML:"",label:window.siyuan.languages.manage,click:()=>{viewCards(e,o,i,"Notebook"),closePanel()}}]}).element),window.siyuan.menus.menu.append(new MenuItem({id:"search",label:window.siyuan.languages.search,accelerator:window.siyuan.config.keymap.general.search.custom,icon:"iconSearch",click(){popSearch(e,{hasReplace:!1,hPath:getNotebookName(o),idPath:[o],page:1})}}).element),window.siyuan.config.readonly||window.siyuan.menus.menu.append(new MenuItem({id:"replace",label:window.siyuan.languages.replace,accelerator:window.siyuan.config.keymap.general.replace.custom,icon:"iconReplace",click(){popSearch(e,{hasReplace:!0,hPath:getNotebookName(o),idPath:[o],page:1})}}).element),window.siyuan.config.readonly||(window.siyuan.menus.menu.append(new MenuItem({id:"separator_1",type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({id:"close",label:window.siyuan.languages.close,icon:"iconClose",click:()=>{fetchPost("/api/notebook/closeNotebook",{notebook:o})}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"delete",icon:"iconTrashcan",label:window.siyuan.languages.delete,accelerator:"\u2326",click:()=>{deleteFiles(Array.from(a.querySelectorAll(".b3-list-item--focus")))}}).element)),window.siyuan.menus.menu.append(new MenuItem({id:"separator_2",type:"separator"}).element),bs(o,"/"),window.siyuan.menus.menu.append(new MenuItem({id:"export",label:window.siyuan.languages.export,type:"submenu",icon:"iconUpload",submenu:[{id:"exportMarkdown",label:"Markdown",icon:"iconMarkdown",click:()=>{const s=showMessage(window.siyuan.languages.exporting,-1);fetchPost("/api/export/exportNotebookMd",{notebook:o},l=>{hideMessage(s),openByMobile(l.data.zip)})}},{id:"exportSiYuanZip",label:"SiYuan .sy.zip",icon:"iconSiYuan",click:()=>{const s=showMessage(window.siyuan.languages.exporting,-1);fetchPost("/api/export/exportNotebookSY",{id:o},l=>{hideMessage(s),openByMobile(l.data.zip)})}}]}).element),e.plugins&&emitOpenMenu({plugins:e.plugins,type:"open-menu-doctree",detail:{elements:n,type:"notebook"},separatorPosition:"top"}),window.siyuan.menus.menu},au=(e,t,a,n)=>{window.siyuan.menus.menu.remove();const o=hasClosestByTag(n,"DIV");if(!o)return window.siyuan.menus.menu;n.classList.contains("b3-list-item--focus")||(o.querySelectorAll(".b3-list-item--focus").forEach(r=>{r.classList.remove("b3-list-item--focus"),r.removeAttribute("select-end"),r.removeAttribute("select-start")}),n.classList.add("b3-list-item--focus"));const i=o.querySelectorAll(".b3-list-item--focus");if(i.length>1)return ms(i,e);const s=n.getAttribute("data-node-id");let l=n.getAttribute("data-name");if(l=getDisplayName(l,!1,!0),!window.siyuan.config.readonly){let r,c;const d=hasTopClosestByTag(n,"UL");if((window.siyuan.config.fileTree.sort===6||d&&d.dataset.sortmode==="6")&&(window.siyuan.menus.menu.append(new MenuItem({id:"newDocAbove",icon:"iconBefore",label:window.siyuan.languages.newDocAbove,click:()=>{const u=[];Array.from(n.parentElement.children).forEach(g=>{g.tagName==="LI"&&(g.isSameNode(n)&&u.push(void 0),u.push(g.getAttribute("data-path")))}),newFile({app:e,notebookId:t,currentPath:pathPosix().dirname(a),paths:u,useSavePath:!1,listDocTree:!0})}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"newDocBelow",icon:"iconAfter",label:window.siyuan.languages.newDocBelow,click:()=>{const u=[];Array.from(n.parentElement.children).forEach(g=>{g.tagName==="LI"&&(u.push(g.getAttribute("data-path")),g.isSameNode(n)&&u.push(void 0))}),newFile({app:e,notebookId:t,currentPath:pathPosix().dirname(a),paths:u,useSavePath:!1,listDocTree:!0})}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"separator_1",type:"separator"}).element)),window.siyuan.menus.menu.append(new MenuItem({id:"copy",label:window.siyuan.languages.copy,type:"submenu",icon:"iconCopy",submenu:copySubMenu([s]).concat([{id:"duplicate",iconHTML:"",label:window.siyuan.languages.duplicate,accelerator:window.siyuan.config.keymap.editor.general.duplicate.custom,click(){fetchPost("/api/filetree/duplicateDoc",{id:s})}}])}).element),window.siyuan.menus.menu.append(movePathToMenu(getTopPaths(Array.from(o.querySelectorAll(".b3-list-item--focus"))))),window.siyuan.menus.menu.append(new MenuItem({id:"addToDatabase",label:window.siyuan.languages.addToDatabase,accelerator:window.siyuan.config.keymap.general.addToDatabase.custom,icon:"iconDatabase",click:()=>{addFilesToDatabase([n])}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"delete",icon:"iconTrashcan",label:window.siyuan.languages.delete,accelerator:"\u2326",click:()=>{deleteFiles(Array.from(o.querySelectorAll(".b3-list-item--focus")))}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"separator_2",type:"separator"}).element),window.siyuan.menus.menu.append(renameMenu({path:a,notebookId:t,name:l,type:"file"})),window.siyuan.menus.menu.append(new MenuItem({id:"attr",label:window.siyuan.languages.attr,icon:"iconAttr",click(){fetchPost("/api/block/getDocInfo",{id:s},u=>{openFileAttr(u.data.ial)})}}).element),!window.siyuan.config.readonly){const u=[{id:"spaceRepetition",iconHTML:"",label:window.siyuan.languages.spaceRepetition,accelerator:window.siyuan.config.keymap.editor.general.spaceRepetition.custom,click:()=>{fetchPost("/api/riff/getTreeRiffDueCards",{rootID:s},g=>{openCardByData(e,g.data,"doc",s,l)}),closePanel()}},{id:"manage",iconHTML:"",label:window.siyuan.languages.manage,click:()=>{fetchPost("/api/filetree/getHPathByID",{id:s},g=>{viewCards(e,s,pathPosix().join(getNotebookName(t),g.data),"Tree")}),closePanel()}},{id:"quickMakeCard",iconHTML:"",accelerator:window.siyuan.config.keymap.editor.general.quickMakeCard.custom,label:window.siyuan.languages.quickMakeCard,click:()=>{transaction(void 0,[{action:"addFlashcards",deckID:Constants.QUICK_DECK_ID,blockIDs:[s]}],[{action:"removeFlashcards",deckID:Constants.QUICK_DECK_ID,blockIDs:[s]}])}},{id:"removeCard",iconHTML:"",label:window.siyuan.languages.removeCard,click:()=>{transaction(void 0,[{action:"removeFlashcards",deckID:Constants.QUICK_DECK_ID,blockIDs:[s]}],[{action:"addFlashcards",deckID:Constants.QUICK_DECK_ID,blockIDs:[s]}])}}];window.siyuan.config.flashcard.deck&&u.push({id:"addToDeck",iconHTML:"",label:window.siyuan.languages.addToDeck,click:()=>{makeCard(e,[s])}}),window.siyuan.menus.menu.append(new MenuItem({id:"riffCard",label:window.siyuan.languages.riffCard,type:"submenu",icon:"iconRiffCard",submenu:u}).element)}window.siyuan.menus.menu.append(new MenuItem({id:"search",label:window.siyuan.languages.search,icon:"iconSearch",accelerator:window.siyuan.config.keymap.general.search.custom,click(){return ps(this,null,function*(){const u=getDisplayName(a,!1,!0),g=yield fetchSyncPost("/api/filetree/getHPathByPath",{notebook:t,path:u+".sy"});popSearch(e,{hasReplace:!1,hPath:pathPosix().join(getNotebookName(t),g.data),idPath:[pathPosix().join(t,u)],page:1})})}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"replace",label:window.siyuan.languages.replace,accelerator:window.siyuan.config.keymap.general.replace.custom,icon:"iconReplace",click(){return ps(this,null,function*(){const u=getDisplayName(a,!1,!0),g=yield fetchSyncPost("/api/filetree/getHPathByPath",{notebook:t,path:u+".sy"});popSearch(e,{hasReplace:!0,hPath:pathPosix().join(getNotebookName(t),g.data),idPath:[pathPosix().join(t,u)],page:1})})}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"separator_3",type:"separator"}).element)}return openEditorTab(e,[s],t,a),window.siyuan.config.readonly||window.siyuan.menus.menu.append(new MenuItem({id:"fileHistory",label:window.siyuan.languages.fileHistory,icon:"iconHistory",click(){openDocHistory({app:e,id:s,notebookId:t,pathString:l})}}).element),bs(t,a),window.siyuan.menus.menu.append(exportMd(s)),e.plugins&&emitOpenMenu({plugins:e.plugins,type:"open-menu-doctree",detail:{elements:i,type:"doc"},separatorPosition:"top"}),window.siyuan.menus.menu.element.setAttribute("data-name","docTreeMore"),window.siyuan.menus.menu},bs=(e,t)=>{if(window.siyuan.config.readonly)return;const a=()=>{let n;n=window.siyuan.mobile.docks.file;const o=n.element.querySelector(`[data-path="${t}"]`);o.querySelector(".b3-list-item__toggle").classList.remove("fn__hidden"),n.getLeaf(o,e,!0),window.siyuan.menus.menu.remove()};window.siyuan.menus.menu.append(new MenuItem({id:"import",icon:"iconDownload",label:window.siyuan.languages.import,submenu:[{id:"importSiYuanZip",icon:"iconSiYuan",label:'SiYuan .sy.zip<input class="b3-form__upload" type="file" accept="application/zip">',bind:n=>{n.querySelector(".b3-form__upload").addEventListener("change",o=>{const i=new FormData;i.append("file",o.target.files[0]),i.append("notebook",e),i.append("toPath",t),fetchPost("/api/import/importSY",i,()=>{a()})})}}]}).element)},Bo=(e,t,a)=>{const n=[{id:"fileNameASC",icon:t===0?"iconSelect":void 0,label:window.siyuan.languages.fileNameASC,click:()=>{a(0)}},{id:"fileNameDESC",icon:t===1?"iconSelect":void 0,label:window.siyuan.languages.fileNameDESC,click:()=>{a(1)}},{id:"fileNameNatASC",icon:t===4?"iconSelect":void 0,label:window.siyuan.languages.fileNameNatASC,click:()=>{a(4)}},{id:"fileNameNatDESC",icon:t===5?"iconSelect":void 0,label:window.siyuan.languages.fileNameNatDESC,click:()=>{a(5)}},{id:"separator_1",type:"separator"},{id:"createdASC",icon:t===9?"iconSelect":void 0,label:window.siyuan.languages.createdASC,click:()=>{a(9)}},{id:"createdDESC",icon:t===10?"iconSelect":void 0,label:window.siyuan.languages.createdDESC,click:()=>{a(10)}},{id:"modifiedASC",icon:t===2?"iconSelect":void 0,label:window.siyuan.languages.modifiedASC,click:()=>{a(2)}},{id:"modifiedDESC",icon:t===3?"iconSelect":void 0,label:window.siyuan.languages.modifiedDESC,click:()=>{a(3)}},{id:"separator_2",type:"separator"},{id:"refCountASC",icon:t===7?"iconSelect":void 0,label:window.siyuan.languages.refCountASC,click:()=>{a(7)}},{id:"refCountDESC",icon:t===8?"iconSelect":void 0,label:window.siyuan.languages.refCountDESC,click:()=>{a(8)}},{id:"separator_3",type:"separator"},{id:"docSizeASC",icon:t===11?"iconSelect":void 0,label:window.siyuan.languages.docSizeASC,click:()=>{a(11)}},{id:"docSizeDESC",icon:t===12?"iconSelect":void 0,label:window.siyuan.languages.docSizeDESC,click:()=>{a(12)}},{id:"separator_4",type:"separator"},{id:"subDocCountASC",icon:t===13?"iconSelect":void 0,label:window.siyuan.languages.subDocCountASC,click:()=>{a(13)}},{id:"subDocCountDESC",icon:t===14?"iconSelect":void 0,label:window.siyuan.languages.subDocCountDESC,click:()=>{a(14)}},{id:"separator_5",type:"separator"},{id:"customSort",icon:t===6?"iconSelect":void 0,label:window.siyuan.languages.customSort,click:()=>{a(6)}}];return e==="notebook"&&n.push({id:"sortByFiletree",icon:t===15?"iconSelect":void 0,label:window.siyuan.languages.sortByFiletree,click:()=>{a(15)}}),n};var Po=(e,t,a)=>new Promise((n,o)=>{var i=r=>{try{l(a.next(r))}catch(c){o(c)}},s=r=>{try{l(a.throw(r))}catch(c){o(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(i,s);l((a=a.apply(e,t)).next())});const nu=(e,t)=>{if(hideTooltip(),!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="titleMenu"){window.siyuan.menus.menu.remove();return}fetchPost("/api/block/getDocInfo",{id:e.block.rootID},a=>{var n;if(window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name","titleMenu"),window.siyuan.menus.menu.append(new MenuItem({id:"copy",label:window.siyuan.languages.copy,icon:"iconCopy",type:"submenu",submenu:copySubMenu([e.block.rootID])}).element),!e.disabled){window.siyuan.menus.menu.append(movePathToMenu([e.path]));const i=getSelection().rangeCount>0?getSelection().getRangeAt(0):void 0;window.siyuan.menus.menu.append(new MenuItem({id:"addToDatabase",label:window.siyuan.languages.addToDatabase,accelerator:window.siyuan.config.keymap.general.addToDatabase.custom,icon:"iconDatabase",click:()=>{addEditorToDatabase(e,i,"title")}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"delete",icon:"iconTrashcan",label:window.siyuan.languages.delete,click:()=>{deleteFile(e.notebookId,e.path)}}).element)}if(window.siyuan.menus.menu.append(new MenuItem({id:"separator_2",type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({id:"attr",label:window.siyuan.languages.attr,icon:"iconAttr",accelerator:window.siyuan.config.keymap.editor.general.attr.custom+"/"+updateHotkeyTip("\u21E7"+window.siyuan.languages.click),click(){openFileAttr(a.data.ial,"bookmark",e)}}).element),!window.siyuan.config.readonly){window.siyuan.config.cloudRegion===0&&window.siyuan.menus.menu.append(new MenuItem({id:"wechatReminder",label:window.siyuan.languages.wechatReminder,icon:"iconMp",click(){openFileWechatNotify(e)}}).element);const i=[{id:"spaceRepetition",iconHTML:"",label:window.siyuan.languages.spaceRepetition,accelerator:window.siyuan.config.keymap.editor.general.spaceRepetition.custom,click:()=>{fetchPost("/api/riff/getTreeRiffDueCards",{rootID:e.block.rootID},s=>{openCardByData(e.app,s.data,"doc",e.block.rootID,s.data.name)})}},{id:"manage",iconHTML:"",label:window.siyuan.languages.manage,click:()=>{fetchPost("/api/filetree/getHPathByID",{id:e.block.rootID},s=>{viewCards(e.app,e.block.rootID,pathPosix().join(getNotebookName(e.notebookId),s.data),"Tree")})}},{id:"quickMakeCard",iconHTML:"",label:window.siyuan.languages.quickMakeCard,accelerator:window.siyuan.config.keymap.editor.general.quickMakeCard.custom,click:()=>{var s;let l=(s=e.title)==null?void 0:s.element;l||(l=document.createElement("div"),l.setAttribute("data-node-id",e.block.rootID),l.setAttribute(Constants.CUSTOM_RIFF_DECKS,a.data.ial[Constants.CUSTOM_RIFF_DECKS])),quickMakeCard(e,[l])}}];window.siyuan.config.flashcard.deck&&i.push({id:"addToDeck",iconHTML:"",label:window.siyuan.languages.addToDeck,click:()=>{makeCard(e.app,[e.block.rootID])}}),window.siyuan.menus.menu.append(new MenuItem({id:"riffCard",label:window.siyuan.languages.riffCard,type:"submenu",icon:"iconRiffCard",submenu:i}).element)}window.siyuan.menus.menu.append(new MenuItem({id:"search",label:window.siyuan.languages.search,icon:"iconSearch",accelerator:window.siyuan.config.keymap.general.search.custom,click(){return Po(this,null,function*(){const i=getDisplayName(e.path,!1,!0),s=yield fetchSyncPost("/api/filetree/getHPathByPath",{notebook:e.notebookId,path:i+".sy"});popSearch(e.app,{hasReplace:!1,hPath:pathPosix().join(getNotebookName(e.notebookId),s.data),idPath:[pathPosix().join(e.notebookId,i)],page:1})})}}).element),e.disabled||transferBlockRef(e.block.rootID),window.siyuan.menus.menu.append(new MenuItem({id:"separator_3",type:"separator"}).element),e.disabled||window.siyuan.menus.menu.append(new MenuItem({id:"fileHistory",label:window.siyuan.languages.fileHistory,icon:"iconHistory",click(){openDocHistory({app:e.app,id:e.block.rootID,notebookId:e.notebookId,pathString:a.data.name})}}).element),genImportMenu(e.notebookId,e.path),window.siyuan.menus.menu.append(exportMd(e.block.showAll?e.block.id:e.block.rootID)),window.siyuan.menus.menu.append(new MenuItem({id:"separator_4",type:"separator"}).element),(n=e==null?void 0:e.app)!=null&&n.plugins&&emitOpenMenu({plugins:e.app.plugins,type:"click-editortitleicon",detail:{protyle:e,data:a.data},separatorPosition:"bottom"}),window.siyuan.menus.menu.append(new MenuItem({id:"updateAndCreatedAt",iconHTML:"",type:"readonly",label:`${window.siyuan.languages.modifiedAt} ${dayjs(a.data.ial.updated).format("YYYY-MM-DD HH:mm:ss")}<br>${window.siyuan.languages.createdAt} ${dayjs(a.data.ial.id.substr(0,14)).format("YYYY-MM-DD HH:mm:ss")}`}).element),window.siyuan.menus.menu.fullscreen();const o=hasTopClosestByClassName(e.element,"block__popover",!0);window.siyuan.menus.menu.element.setAttribute("data-from",o?o.dataset.level+"popover":"app")})};var Ro=(e,t,a)=>new Promise((n,o)=>{var i=r=>{try{l(a.next(r))}catch(c){o(c)}},s=r=>{try{l(a.throw(r))}catch(c){o(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(i,s);l((a=a.apply(e,t)).next())});class su{constructor(t){const a=document.createElement("div");a.className="protyle-breadcrumb";let n="";a.innerHTML=`${isMobile()?`<button class="protyle-breadcrumb__icon" data-type="mobile-menu">${window.siyuan.languages.breadcrumb}</button>`:'<div class="protyle-breadcrumb__bar"></div>'}
<span class="protyle-breadcrumb__space"></span>
<button class="protyle-breadcrumb__icon fn__none ariaLabel" aria-label="${updateHotkeyTip(window.siyuan.config.keymap.editor.general.exitFocus.custom)}" data-type="exit-focus">${window.siyuan.languages.exitFocus}</button>
${n}
<button class="block__icon fn__flex-center ariaLabel${window.siyuan.config.readonly?" fn__none":""}" aria-label="${window.siyuan.languages.lockEdit}" data-type="readonly"><svg><use xlink:href="#iconUnlock"></use></svg></button>
<button class="block__icon fn__flex-center ariaLabel" data-type="doc" aria-label="${isMac()?window.siyuan.languages.gutterTip2:window.siyuan.languages.gutterTip2.replace("\u21E7","Shift+")}"><svg><use xlink:href="#iconFile"></use></svg></button>
<button class="block__icon fn__flex-center ariaLabel" data-type="more" aria-label="${window.siyuan.languages.more}"><svg><use xlink:href="#iconMore"></use></svg></button>
<button class="block__icon fn__flex-center fn__none ariaLabel" data-type="context" aria-label="${window.siyuan.languages.context}"><svg><use xlink:href="#iconAlignCenter"></use></svg></button>`,this.element=a.firstElementChild,a.addEventListener("click",o=>{let i=o.target;for(;i&&!i.isEqualNode(a);){const s=i.getAttribute("data-node-id"),l=i.getAttribute("data-type");if(s){o.preventDefault();break}else if(l==="mobile-menu"){this.genMobileMenu(t),o.preventDefault(),o.stopPropagation();break}else if(l==="doc"){if(window.siyuan.shiftIsPressed)fetchPost("/api/block/getDocInfo",{id:t.block.rootID},r=>{openFileAttr(r.data.ial,"bookmark",t)});else{const r=i.getBoundingClientRect();openTitleMenu(t,{x:r.right,y:r.bottom,isLeft:!0})}o.stopPropagation(),o.preventDefault();break}else if(l==="more"){const r=i.getBoundingClientRect();this.showMenu(t,{x:r.right,y:r.bottom,isLeft:!0}),o.stopPropagation(),o.preventDefault();break}else if(l==="readonly"){updateReadonly(i,t),o.stopPropagation(),o.preventDefault();break}else if(l==="exit-focus"){zoomOut({protyle:t,id:t.block.rootID,focusId:t.block.id}),o.stopPropagation(),o.preventDefault();break}else if(l==="context"){o.stopPropagation(),o.preventDefault(),i.classList.contains("block__icon--active")?(zoomOut({protyle:t,id:t.options.blockId}),i.classList.remove("block__icon--active")):(fetchPost("/api/filetree/getDoc",{id:t.options.blockId,mode:3,size:window.siyuan.config.editor.dynamicLoadBlocks},r=>{onGet({data:r,protyle:t,action:[Constants.CB_GET_HL]})}),i.classList.add("block__icon--active"));break}else if(l==="undo"){t.undo.undo(t),o.preventDefault(),o.stopPropagation();break}else if(l==="redo"){t.undo.redo(t),o.preventDefault(),o.stopPropagation();break}else if(l==="outdent"){if(t.toolbar.range){const r=hasClosestBlock(t.toolbar.range.startContainer);r&&listOutdent(t,[r.parentElement],t.toolbar.range)}o.preventDefault(),o.stopPropagation();break}else if(l==="indent"){if(t.toolbar.range){const r=hasClosestBlock(t.toolbar.range.startContainer);r&&listIndent(t,[r.parentElement],t.toolbar.range)}o.preventDefault(),o.stopPropagation();break}i=i.parentElement}})}startRecord(t){this.messageId=showMessage(`<div class="fn__flex fn__flex-wrap">
<span class="fn__flex-center">${window.siyuan.languages.recording}</span><span class="fn__space"></span>
<button class="b3-button b3-button--white">${window.siyuan.languages.endRecord}</button></div>`,-1),document.querySelector(`#message [data-id="${this.messageId}"] button`).addEventListener("click",()=>{this.mediaRecorder.stopRecording(),hideMessage(this.messageId);const a=new File([this.mediaRecorder.buildWavFileBlob()],`record${new Date().getTime()}.wav`,{type:"video/webm"});uploadFiles(t,[a])}),this.mediaRecorder.startRecordingNewWavFile()}genMobileMenu(t){const a=new Menu("breadcrumb-mobile-path");let n;if(getSelection().rangeCount>0){const i=getSelection().getRangeAt(0);!t.wysiwyg.element.isEqualNode(i.startContainer)&&!t.wysiwyg.element.contains(i.startContainer)?n=getNoContainerElement(t.wysiwyg.element.firstElementChild)||t.wysiwyg.element.firstElementChild:n=hasClosestBlock(i.startContainer)}n||(n=getNoContainerElement(t.wysiwyg.element.firstElementChild)||t.wysiwyg.element.firstElementChild);const o=n.getAttribute("data-node-id");fetchPost("/api/block/getBlockBreadcrumb",{id:o,excludeTypes:[]},i=>{i.data.forEach(s=>{let l=!1;(!t.block.showAll&&s.id===t.block.parentID||t.block.showAll&&s.id===t.block.id)&&(l=!0),a.addItem({current:l,icon:getIconByType(s.type,s.subType),label:s.name,click(){zoomOut({protyle:t,id:s.id,focusId:o})}})}),a.fullscreen()})}toggleExit(t){const a=this.element.parentElement.querySelector('[data-type="exit-focus"]');t?a.classList.add("fn__none"):a.classList.remove("fn__none")}showMenu(t,a){if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="breadcrumbMore"){window.siyuan.menus.menu.remove();return}let n;const o=hasClosestBlock(getEditorRange(t.element).startContainer);o&&(n=o.getAttribute("data-node-id")),fetchPost("/api/block/getTreeStat",{id:n||(t.block.showAll?t.block.id:t.block.rootID)},i=>{var s,l,r,c;if(window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name","breadcrumbMore"),!t.contentElement.classList.contains("fn__none")&&!t.disabled){let u="";u='<input class="b3-form__upload" type="file" multiple="multiple"',t.options.upload.accept?u+=` accept="${t.options.upload.accept}">`:u+=">";const g=new MenuItem({id:"insertAsset",icon:"iconDownload",label:`${window.siyuan.languages.insertAsset}${u}`}).element;g.querySelector("input").addEventListener("change",f=>{f.target.files.length!==0&&(uploadFiles(t,f.target.files,f.target),window.siyuan.menus.menu.remove())}),window.siyuan.menus.menu.append(g),!isInAndroid()&&!isInHarmony()&&window.siyuan.menus.menu.append(new MenuItem({id:(s=this.mediaRecorder)!=null&&s.isRecording?"endRecord":"startRecord",current:this.mediaRecorder&&this.mediaRecorder.isRecording,icon:"iconRecord",label:(l=this.mediaRecorder)!=null&&l.isRecording?window.siyuan.languages.endRecord:window.siyuan.languages.startRecord,click:()=>Ro(this,null,function*(){if(!this.mediaRecorder){navigator.mediaDevices.getUserMedia({audio:!0}).then(f=>{this.mediaRecorder=new RecordMedia(f),this.mediaRecorder.recorder.onaudioprocess=p=>{if(!this.mediaRecorder.isRecording)return;const m=p.inputBuffer.getChannelData(0),b=p.inputBuffer.getChannelData(1);this.mediaRecorder.cloneChannelData(m,b)},this.startRecord(t)}).catch(()=>{showMessage(window.siyuan.languages["record-tip"])});return}if(this.mediaRecorder.isRecording){this.mediaRecorder.stopRecording(),hideMessage(this.messageId);const f=new File([this.mediaRecorder.buildWavFileBlob()],`record${new Date().getTime()}.wav`,{type:"video/webm"});uploadFiles(t,[f])}else hideMessage(this.messageId),this.startRecord(t)})}).element)}if(t.disabled||(window.siyuan.menus.menu.append(new MenuItem({id:"netImg2LocalAsset",label:window.siyuan.languages.netImg2LocalAsset,icon:"iconImgDown",accelerator:window.siyuan.config.keymap.editor.general.netImg2LocalAsset.custom,click(){net2LocalAssets(t,"Img")}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"netAssets2LocalAssets",label:window.siyuan.languages.netAssets2LocalAssets,icon:"iconTransform",accelerator:window.siyuan.config.keymap.editor.general.netAssets2LocalAssets.custom,click(){net2LocalAssets(t,"Assets")}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"uploadAssets2CDN",label:window.siyuan.languages.uploadAssets2CDN,icon:"iconCloudSucc",click(){needSubscribe()||confirmDialog("\u{1F4E6} "+window.siyuan.languages.uploadAssets2CDN,window.siyuan.languages.uploadAssets2CDNConfirmTip,()=>{fetchPost("/api/asset/uploadCloud",{id:t.block.parentID})})}}).element),window.siyuan.user&&window.siyuan.menus.menu.append(new MenuItem({id:"share2Liandi",label:window.siyuan.languages.share2Liandi,icon:"iconLiandi",click(){confirmDialog("\u{1F680} "+window.siyuan.languages.share2Liandi,window.siyuan.languages.share2LiandiConfirmTip,()=>{fetchPost("/api/export/export2Liandi",{id:t.block.parentID})})}}).element)),(r=t.scroll)!=null&&r.element.classList.contains("fn__none")||window.siyuan.menus.menu.append(new MenuItem({id:"keepLazyLoad",current:t.scroll.keepLazyLoad,label:window.siyuan.languages.keepLazyLoad,click:()=>{t.scroll.keepLazyLoad=!t.scroll.keepLazyLoad}}).element),window.siyuan.menus.menu.element.lastElementChild.childElementCount>0&&window.siyuan.menus.menu.append(new MenuItem({id:"separator_1",type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({id:"refresh",icon:"iconRefresh",accelerator:window.siyuan.config.keymap.editor.general.refresh.custom,label:window.siyuan.languages.refresh,click:()=>{reloadProtyle(t,!isMobile())}}).element),t.disabled||window.siyuan.menus.menu.append(new MenuItem({id:"optimizeTypography",label:window.siyuan.languages.optimizeTypography,accelerator:window.siyuan.config.keymap.editor.general.optimizeTypography.custom,icon:"iconFormat",click:()=>{hideElements(["toolbar"],t),fetchPost("/api/format/autoSpace",{id:t.block.rootID})}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"editMode",icon:"iconEdit",label:window.siyuan.languages["edit-mode"],type:"submenu",submenu:[{id:"wysiwyg",current:!t.contentElement.classList.contains("fn__none"),label:window.siyuan.languages.wysiwyg,accelerator:window.siyuan.config.keymap.editor.general.wysiwyg.custom,click:()=>{setEditMode(t,"wysiwyg"),t.scroll.lastScrollTop=0,fetchPost("/api/filetree/getDoc",{id:t.block.parentID,size:window.siyuan.config.editor.dynamicLoadBlocks},u=>{onGet({data:u,protyle:t})})}},{id:"preview",current:!t.preview.element.classList.contains("fn__none"),icon:"iconPreview",label:window.siyuan.languages.preview,accelerator:window.siyuan.config.keymap.editor.general.preview.custom,click:()=>{setEditMode(t,"preview"),window.siyuan.menus.menu.remove()}}]}).element),!window.siyuan.config.editor.readOnly&&!window.siyuan.config.readonly){const u=t.wysiwyg.element.getAttribute(Constants.CUSTOM_SY_READONLY);window.siyuan.menus.menu.append(new MenuItem({id:"editReadonly",label:window.siyuan.languages.editReadonly,icon:"iconLock",type:"submenu",submenu:[{id:"enable",iconHTML:"",current:u==="true",label:window.siyuan.languages.enable,click(){fetchPost("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{[Constants.CUSTOM_SY_READONLY]:"true"}})}},{id:"disable",iconHTML:"",current:!u||u==="false",label:window.siyuan.languages.disable,click(){fetchPost("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{[Constants.CUSTOM_SY_READONLY]:"false"}})}}]}).element)}(c=t==null?void 0:t.app)!=null&&c.plugins&&emitOpenMenu({plugins:t.app.plugins,type:"open-menu-breadcrumbmore",detail:{protyle:t,data:i.data.stat},separatorPosition:"top"}),window.siyuan.menus.menu.append(new MenuItem({id:"separator_2",type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({id:"docInfo",iconHTML:"",type:"readonly",label:`<div class="fn__flex">${window.siyuan.languages.runeCount}<span class="fn__space fn__flex-1"></span>${i.data.stat.runeCount}</div><div class="fn__flex">${window.siyuan.languages.wordCount}<span class="fn__space fn__flex-1"></span>${i.data.stat.wordCount}</div><div class="fn__flex">${window.siyuan.languages.linkCount}<span class="fn__space fn__flex-1"></span>${i.data.stat.linkCount}</div><div class="fn__flex">${window.siyuan.languages.imgCount}<span class="fn__space fn__flex-1"></span>${i.data.stat.imageCount}</div><div class="fn__flex">${window.siyuan.languages.refCount}<span class="fn__space fn__flex-1"></span>${i.data.stat.refCount}</div><div class="fn__flex">${window.siyuan.languages.blockCount}<span class="fn__space fn__flex-1"></span>${i.data.stat.blockCount}</div>`}).element),window.siyuan.menus.menu.fullscreen();const d=hasTopClosestByClassName(t.element,"block__popover",!0);window.siyuan.menus.menu.element.setAttribute("data-from",d?d.dataset.level+"popover":"app")})}render(t,a=!1,n){}hide(){isMobile()||(this.element.classList.add("protyle-breadcrumb__bar--hide"),window.siyuan.hideBreadcrumb=!0)}}class iu{constructor(t){this.element=document.createElement("div"),this.element.className="protyle-title",window.siyuan.config.editor.displayBookmarkIcon&&this.element.classList.add("protyle-wysiwyg--attr"),this.element.innerHTML='<div class="protyle-attr"></div>',this.element.querySelector(".protyle-attr").addEventListener("click",a=>{fetchPost("/api/block/getDocInfo",{id:t.block.rootID},n=>{commonClick(a,t,n.data.ial)})})}rename(t){if(clearTimeout(this.timeout),!validateName(this.editElement.textContent,this.editElement)){const a=getSelectionOffset(this.editElement);return this.setTitle(this.editElement.textContent.substring(0,Constants.SIZE_TITLE)),focusByOffset(this.editElement,a.start,a.end),!1}hideTooltip(),this.timeout=window.setTimeout(()=>{const a=replaceFileName(this.editElement.textContent);fetchPost("/api/filetree/renameDoc",{notebook:t.notebookId,path:t.path,title:a}),this.setTitle(a),setTitle(a)},Constants.TIMEOUT_INPUT)}setTitle(t){const a=document.getElementById("toolbarName");code160to32(t)!==code160to32(a.value)&&(a.value=t===window.siyuan.languages.untitled?"":t)}render(t,a){var n;if(this.element.getAttribute("data-render")==="true")return!1;this.element.setAttribute("data-node-id",t.block.rootID),a.data.ial[Constants.CUSTOM_RIFF_DECKS]&&this.element.setAttribute(Constants.CUSTOM_RIFF_DECKS,a.data.ial[Constants.CUSTOM_RIFF_DECKS]),(n=t.background)==null||n.render(a.data.ial,t.block.rootID),t.wysiwyg.renderCustom(a.data.ial),this.element.setAttribute("data-render","true"),this.setTitle(a.data.ial.title);let o="";if(a.data.ial.bookmark&&(o+=`<div class="protyle-attr--bookmark">${Lute.EscapeHTMLStr(a.data.ial.bookmark)}</div>`),a.data.ial.name&&(o+=`<div class="protyle-attr--name"><svg><use xlink:href="#iconN"></use></svg>${Lute.EscapeHTMLStr(a.data.ial.name)}</div>`),a.data.ial.alias&&(o+=`<div class="protyle-attr--alias"><svg><use xlink:href="#iconA"></use></svg>${Lute.EscapeHTMLStr(a.data.ial.alias)}</div>`),a.data.ial.memo&&(o+=`<div class="protyle-attr--memo b3-tooltips b3-tooltips__sw" aria-label="${Lute.EscapeHTMLStr(a.data.ial.memo)}"><svg><use xlink:href="#iconM"></use></svg></div>`),a.data.ial["custom-avs"]){let i="";a.data.attrViews.forEach(s=>{i+=`<span data-av-id="${s.id}" data-popover-url="/api/av/getMirrorDatabaseBlocks" class="popover__block">${s.name}</span>&nbsp;`}),i&&(i=i.substring(0,i.length-6)),o+=`<div class="protyle-attr--av"><svg><use xlink:href="#iconDatabase"></use></svg>${i}</div>`}if(this.element.querySelector(".protyle-attr").innerHTML=o,a.data.refCount!==0&&this.element.querySelector(".protyle-attr").insertAdjacentHTML("beforeend",`<div class="protyle-attr--refcount popover__block">${a.data.refCount}</div>`),this.editElement&&new Date().getTime()-dayjs(a.data.id.split("-")[0]).toDate().getTime()<2e3){const i=this.editElement.ownerDocument.createRange();i.selectNodeContents(this.editElement),focusByRange(i)}}}var ys=(e,t,a)=>new Promise((n,o)=>{var i=r=>{try{l(a.next(r))}catch(c){o(c)}},s=r=>{try{l(a.throw(r))}catch(c){o(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(i,s);l((a=a.apply(e,t)).next())});const ma=null;class ou{constructor(t){this.transparentData="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=",this.element=document.createElement("div"),this.element.className="protyle-background",this.element.innerHTML=`<div class="protyle-background__img">
    <img src="${this.transparentData}">
    <div class="protyle-icons">
        <span class="protyle-icon protyle-icon--first" style="position: relative;overflow: hidden"><input aria-label="${window.siyuan.languages.upload}" class="ariaLabel" type="file" style="position: absolute;height: 100%;top: 0;right: 0;opacity: .001;overflow: hidden;cursor: pointer;"><svg><use xlink:href="#iconUpload"></use></svg></span>
        <span class="protyle-icon ariaLabel" data-type="link" aria-label="${window.siyuan.languages.link}"><svg><use xlink:href="#iconLink"></use></svg></span>
        <span class="protyle-icon ariaLabel" data-type="asset" aria-label="${window.siyuan.languages.assets}"><svg><use xlink:href="#iconImage"></use></svg></span>
        <span class="protyle-icon ariaLabel" data-type="show-random" aria-label="${window.siyuan.languages.builtIn}"><svg><use xlink:href="#iconRefresh"></use></svg></span>
        <span class="protyle-icon ariaLabel fn__none" data-type="position" aria-label="${window.siyuan.languages.dragPosition}"><svg><use xlink:href="#iconMove"></use></svg></span>
        <span class="protyle-icon protyle-icon--last ariaLabel" data-type="remove" aria-label="${window.siyuan.languages.remove}"><svg><use xlink:href="#iconTrashcan"></use></svg></span>
    </div>
    <div class="protyle-icons fn__none"><span class="protyle-icon protyle-icon--text">${window.siyuan.languages.dragPosition}</span></div>
    <div class="protyle-icons fn__none" style="opacity: .86;">
        <span class="protyle-icon protyle-icon--first" data-type="cancel">${window.siyuan.languages.cancel}</span>
        <span class="protyle-icon protyle-icon--last" data-type="confirm">${window.siyuan.languages.confirm}</span>
    </div>
</div>
<div class="protyle-background__ia">
    <div class="protyle-background__icon" data-menu="true" data-type="open-emoji"></div>
    <div class="b3-chips b3-chips__doctag fn__none"></div>
    <div class="protyle-background__action">
        <button class="b3-button b3-button--cancel" data-menu="true" data-type="tag">
            <svg><use xlink:href="#iconTags"></use></svg>
            ${window.siyuan.languages.addTag}
        </button>
        <button class="b3-button b3-button--cancel" data-type="icon">
            <svg><use xlink:href="#iconEmoji"></use></svg>
            ${window.siyuan.languages.addIcon}
        </button>
        <button class="b3-button b3-button--cancel" data-type="random">
            <svg><use xlink:href="#iconImage"></use></svg>
            ${window.siyuan.languages.titleBg}
        </button>
    </div>
</div>`,this.tagsElement=this.element.querySelector(".b3-chips"),this.iconElement=this.element.querySelector(".protyle-background__icon"),this.imgElement=this.element.querySelector(".protyle-background__img img"),this.actionElements=this.element.querySelectorAll(".protyle-background__action:not(.fn__flex-center) .b3-button"),this.element.addEventListener("dragover",a=>ys(this,null,function*(){a.preventDefault()})),this.element.addEventListener("drop",a=>ys(this,null,function*(){a.dataTransfer.types[0]==="Files"&&a.dataTransfer.files[0].type.indexOf("image")!==-1&&uploadFiles(t,[a.dataTransfer.files[0]],void 0,n=>{const o=JSON.parse(n),i=`background-image:url("${o.data.succMap[Object.keys(o.data.succMap)[0]]}")`;this.ial["title-img"]=i,this.render(this.ial,t.block.rootID),fetchPost("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{"title-img":i}})})})),this.imgElement.addEventListener("mousedown",a=>{if(a.preventDefault(),!this.element.firstElementChild.querySelector(".protyle-icons").classList.contains("fn__none"))return;const n=a.clientY,o=document,i=this.imgElement.naturalHeight*this.imgElement.clientWidth/this.imgElement.naturalWidth-this.imgElement.clientHeight;let s=parseFloat(this.imgElement.style.objectPosition.substring(7))||50;this.imgElement.style.objectPosition.endsWith("px")&&(s=-parseInt(this.imgElement.style.objectPosition.substring(7))/i*100),o.onmousemove=l=>{this.imgElement.style.objectPosition=`center ${((n-l.clientY)/i*100+s).toFixed(2)}%`,a.preventDefault()},o.onmouseup=()=>{o.onmousemove=null,o.onmouseup=null,o.ondragstart=null,o.onselectstart=null,o.onselect=null}}),this.element.querySelector("input").addEventListener("change",a=>{a.target.files.length!==0&&uploadFiles(t,a.target.files,a.target,n=>{const o=JSON.parse(n),i=`background-image:url("${o.data.succMap[Object.keys(o.data.succMap)[0]]}")`;this.ial["title-img"]=i,this.render(this.ial,t.block.rootID),fetchPost("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{"title-img":i}})})}),this.element.addEventListener(getEventName(),a=>{if(t.disabled)return;let n=a.target;for(hideElements(["gutter"],t);n&&!n.isEqualNode(this.element);){const o=n.getAttribute("data-type");if(n.tagName==="IMG"&&n.parentElement.classList.contains("protyle-background__img")){const i=n.getAttribute("src");a.detail>1&&!i.startsWith("data:image/png;base64")&&(previewImage(i),a.preventDefault(),a.stopPropagation()),window.siyuan.menus.menu.remove();break}else if(o==="position"){const i=this.element.firstElementChild.querySelectorAll(".protyle-icons");i[0].classList.add("fn__none"),i[1].classList.remove("fn__none"),i[2].classList.remove("fn__none"),this.imgElement.style.cursor="move",a.preventDefault(),a.stopPropagation();break}else if(o==="cancel"||o==="confirm"){this.imgElement.style.cursor="";const i=this.element.firstElementChild.querySelectorAll(".protyle-icons");if(i[0].classList.remove("fn__none"),i[1].classList.add("fn__none"),i[2].classList.add("fn__none"),o==="confirm"){const s=`background-image:url("${this.imgElement.getAttribute("src")}");object-position:${this.imgElement.style.objectPosition}`;this.ial["title-img"]=s,fetchPost("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{"title-img":s}})}else this.render(this.ial,t.block.rootID);a.preventDefault(),a.stopPropagation();break}else if(o==="open-emoji"){const i=this.iconElement.getBoundingClientRect();openEmojiPanel(t.block.rootID,"doc",{x:i.left,y:i.bottom,h:i.height,w:i.width},void 0,n.querySelector("img")),a.preventDefault(),a.stopPropagation();break}else if(o==="show-random"){let i="";ma.forEach((l,r)=>{i+=`<div data-index="${r}" style="height: 128px;${l}" class="b3-card b3-card--wrap"></div>`});const s=new Dialog({title:window.siyuan.languages.builtIn,content:`<div class="b3-cards">${i}</div>`,width:isMobile()?"92vw":"912px",height:isMobile()?"80vh":"70vh"});s.element.setAttribute("data-key",Constants.DIALOG_BACKGROUNDRANDOM),s.element.addEventListener("click",l=>{const r=l.target;r.classList.contains("b3-card")&&(this.ial["title-img"]=ma[parseInt(r.getAttribute("data-index"))],this.render(this.ial,t.block.rootID),fetchPost("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{"title-img":this.ial["title-img"]}}),s.destroy())}),a.preventDefault(),a.stopPropagation();break}else if(o==="random"){this.ial["title-img"]=ma[getRandom(0,ma.length-1)],this.render(this.ial,t.block.rootID),fetchPost("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{"title-img":this.ial["title-img"]}}),a.preventDefault(),a.stopPropagation();break}else if(o==="asset"){const i=n.getBoundingClientRect();assetMenu(t,{x:n.parentElement.getBoundingClientRect().right,y:i.bottom+8,isLeft:!0},s=>{this.ial["title-img"]=`background-image:url("${s}")`,this.render(this.ial,t.block.rootID),fetchPost("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{"title-img":this.ial["title-img"]}}),window.siyuan.menus.menu.remove()},Constants.SIYUAN_ASSETS_IMAGE),a.preventDefault(),a.stopPropagation();break}else if(o==="remove"){delete this.ial["title-img"],this.render(this.ial,t.block.rootID),fetchPost("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{"title-img":""}}),a.preventDefault(),a.stopPropagation();break}else if(o==="icon"){const i=getRandomEmoji();if(i){updateFileTreeEmoji(i,t.block.rootID),updateOutlineEmoji(i,t.block.rootID),fetchPost("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{icon:i}}),t.model&&t.model.parent.setDocIcon(i),this.iconElement.classList.remove("fn__none");const s=this.iconElement.getBoundingClientRect();openEmojiPanel(t.block.rootID,"doc",{x:s.left,y:s.bottom,h:s.height,w:s.width})}a.preventDefault(),a.stopPropagation();break}else if(o==="tag"){this.openTag(t,n),a.preventDefault(),a.stopPropagation();break}else if(o==="link"){const i=new Dialog({title:window.siyuan.languages.link,width:isMobile()?"92vw":"520px",content:`<div class="b3-dialog__content">
        <input class="b3-text-field fn__block" value="${this.imgElement.src.startsWith("data:")?"":this.imgElement.getAttribute("src")}">
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`});i.element.setAttribute("data-key",Constants.DIALOG_BACKGROUNDLINK);const s=i.element.querySelectorAll(".b3-button");s[0].addEventListener("click",()=>{i.destroy()}),s[1].addEventListener("click",()=>{const l=`background-image:url("${i.element.querySelector("input").value}");`;this.ial["title-img"]=l,this.render(this.ial,t.block.rootID),fetchPost("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{"title-img":this.ial["title-img"]}}),i.destroy()}),i.element.querySelector("input").focus(),a.preventDefault(),a.stopPropagation();break}else if(o==="open-search"){popSearch(t.app,{hasReplace:!1,method:0,hPath:"",idPath:[],k:`#${n.textContent}#`,r:"",page:1}),a.preventDefault(),a.stopPropagation();break}else if(o==="remove-tag"){n.parentElement.remove(),this.removeTag(t),a.preventDefault(),a.stopPropagation();break}n=n.parentElement}})}removeTag(t){const a=this.getTags();fetchPost("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{tags:a.toString()}}),a.length===0?delete this.ial.tags:this.ial.tags=a.toString(),this.render(this.ial,t.block.rootID)}render(t,a){var n;const o=t["title-img"],i=t.icon,s=t.tags;if(this.ial=t,this.element.setAttribute("data-node-id",a),s){let l="";const r=["secondary","primary","info","success","warning","error","pink"];Array.from(new Set(s.split(",").map(c=>c.trim()))).forEach((c,d)=>{c.replace(/ /g,"")&&(l+=`<div class="b3-chip b3-chip--middle b3-chip--pointer b3-chip--${r[d%7]}" data-type="open-search">${escapeHtml(c)}<svg class="b3-chip__close" data-type="remove-tag"><use xlink:href="#iconCloseRound"></use></svg></div>`)}),this.tagsElement.innerHTML=`${l}
<div class="protyle-background__action fn__flex-center">
    <button class="b3-button b3-button--cancel" style="margin-bottom: 8px" data-menu="true" data-type="tag"><svg><use xlink:href="#iconAdd"></use></svg>${window.siyuan.languages.addTag}</button>
</div>`,this.tagsElement.classList.remove("fn__none"),this.actionElements[0].classList.add("fn__none")}else this.tagsElement.classList.add("fn__none"),this.actionElements[0].classList.remove("fn__none");if(i?(this.iconElement.classList.remove("fn__none"),this.iconElement.innerHTML=unicode2Emoji(i),this.actionElements[1].classList.add("fn__none")):(this.actionElements[1].classList.remove("fn__none"),this.iconElement.classList.add("fn__none")),o){if(this.imgElement.setAttribute("style",Lute.UnEscapeHTMLStr(o)),o.indexOf("url(")>-1){const l=this.imgElement.style.backgroundPosition||this.imgElement.style.objectPosition,r=(n=this.imgElement.style.backgroundImage)==null?void 0:n.replace(/^url\(["']?/,"").replace(/["']?\)$/,"");this.imgElement.removeAttribute("style"),this.imgElement.setAttribute("src",r),this.imgElement.style.objectPosition=l,this.element.querySelector('[data-type="position"]').classList.remove("fn__none")}else this.imgElement.setAttribute("src",this.transparentData),this.element.querySelector('[data-type="position"]').classList.add("fn__none");this.actionElements[2].classList.add("fn__none"),this.imgElement.parentElement.classList.remove("fn__none"),this.iconElement.style.marginTop="",this.imgElement.style.height="200px"}else this.imgElement.parentElement.classList.add("fn__none"),this.actionElements[2].classList.remove("fn__none"),this.iconElement.style.marginTop="8px";o||i?this.iconElement.parentElement.style.marginTop="":this.iconElement.parentElement.style.marginTop="8px"}openTag(t,a){window.siyuan.menus.menu.remove();const n=new Menu;n.addItem({iconHTML:"",type:"empty",label:`<div class="fn__flex-column b3-menu__filter">
    <input class="b3-text-field fn__flex-shrink" placeholder="${window.siyuan.languages.tag}"/>
    <div class="fn__hr"></div>
    <div class="b3-list fn__flex-1 b3-list--background">
        <img style="margin: 0 auto;display: block;width: 64px;height: 64px" src="/stage/loading-pure.svg">
    </div>
</div>`,bind:i=>{const s=i.querySelector(".b3-list--background");fetchPost("/api/search/searchTag",{k:""},r=>{let c="";const d=this.getTags();r.data.tags.forEach((u,g)=>{c+=`<div class="b3-list-item b3-list-item--narrow${g===0?" b3-list-item--focus":""}">
    <div class="fn__flex-1">${u}</div>
    ${d.includes(Lute.UnEscapeHTMLStr(u))?'<svg class="b3-menu__checked"><use xlink:href="#iconSelect"></use></svg>':""}
</div>`}),s.innerHTML=c});const l=i.querySelector("input");l.addEventListener("keydown",r=>{if(r.stopPropagation(),!r.isComposing)if(upDownHint(s,r),r.key==="Enter"){const c=s.querySelector(".b3-list-item--focus");c?this.addTags(c.textContent.trim(),t):this.addTags(l.value.trim(),t),l.value="",l.dispatchEvent(new CustomEvent("input"))}else r.key==="Escape"&&window.siyuan.menus.menu.remove()}),l.addEventListener("input",r=>{r.stopPropagation(),fetchPost("/api/search/searchTag",{k:l.value},c=>{let d="",u=!1;const g=this.getTags();c.data.tags.forEach(f=>{d+=`<div class="b3-list-item b3-list-item--narrow">
    <div class="fn__flex-1">${f}</div>
    ${g.includes(Lute.UnEscapeHTMLStr(f.replace(/<mark>/g,"").replace(/<\/mark>/g,"")))?'<svg class="b3-menu__checked"><use xlink:href="#iconSelect"></use></svg>':""}
</div>`,f===`<mark>${c.data.k}</mark>`&&(u=!0)}),!u&&c.data.k&&(d=`<div class="b3-list-item b3-list-item--narrow"><mark>${escapeHtml(c.data.k)}</mark></div>`+d),s.innerHTML=d,s.firstElementChild.classList.add("b3-list-item--focus")})}),s.addEventListener("click",r=>{const c=r.target,d=hasClosestByClassName(c,"b3-list-item");d&&(this.addTags(d.textContent.trim(),t),l.dispatchEvent(new CustomEvent("input")))})}});const o=n.element.querySelector(".b3-menu__items");o.setAttribute("style","overflow: initial"),n.fullscreen(),o.firstElementChild.setAttribute("style","padding: 0 8px;height: 100%;")}getTags(t){const a=[];return this.tagsElement.querySelectorAll(".b3-chip").forEach(n=>{const o=n.textContent.trim();t&&o===t&&n.remove(),a.push(o)}),a}addTags(t,a){const n=this.getTags(t);if(n.includes(t)){this.removeTag(a);return}n.push(t),fetchPost("/api/attr/setBlockAttrs",{id:a.block.rootID,attrs:{tags:n.toString()}}),this.ial.tags=n.toString(),this.render(this.ial,a.block.rootID)}}const on=(e,t)=>{fetchPost("/api/filetree/createDailyNote",{notebook:t,app:Constants.SIYUAN_APPID},a=>{openMobileFileById(e,a.data.id)})},lu=e=>{if(window.siyuan.dialogs.find(i=>{if(i.element.getAttribute("data-key")===Constants.DIALOG_DIALYNOTE)return i.destroy(),!0}))return;const a=getOpenNotebookCount();if(a===0){showMessage(window.siyuan.languages.newFileTip);return}if(a===1){let i="";window.siyuan.notebooks.find(s=>{s.closed||(i=s.id)}),on(e,i);return}const n=window.siyuan.storage[Constants.LOCAL_DAILYNOTEID],o=window.siyuan.notebooks.find(i=>{if(i.id===n&&!i.closed)return!0});if(n&&o&&!isMobile())on(e,n);else{let i="";window.siyuan.notebooks.forEach(c=>{c.closed||(i+=`<option value="${c.id}">${c.name}</option>`)});const s=new Dialog({positionId:Constants.DIALOG_DIALYNOTE,title:window.siyuan.languages.plsChoose,content:`<div class="b3-dialog__content">
    <select class="b3-select fn__block">${i}</select>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px"});s.element.setAttribute("data-key",Constants.DIALOG_DIALYNOTE);const l=s.element.querySelectorAll(".b3-button"),r=s.element.querySelector(".b3-select");r.value=n,l[0].addEventListener("click",()=>{s.destroy()}),l[1].addEventListener("click",()=>{const c=r.value;window.siyuan.storage[Constants.LOCAL_DAILYNOTEID]=c,setStorageVal(Constants.LOCAL_DAILYNOTEID,window.siyuan.storage[Constants.LOCAL_DAILYNOTEID]),on(e,c),s.destroy()})}},ru=()=>{const e=Constants.HELP_PATH[window.siyuan.config.appearance.lang];fetchPost("/api/notebook/removeNotebook",{notebook:e,callback:Constants.CB_MOUNT_REMOVE},()=>{fetchPost("/api/notebook/openNotebook",{notebook:e,app:Constants.SIYUAN_APPID})})},cu=()=>{const e=new Dialog({title:window.siyuan.languages.newNotebook,content:`<div class="b3-dialog__content">
    <input placeholder="${window.siyuan.languages.notebookName}" class="b3-text-field fn__block">
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px"});e.element.setAttribute("data-key",Constants.DIALOG_CREATENOTEBOOK);const t=e.element.querySelectorAll(".b3-button");e.bindInput(e.element.querySelector("input"),()=>{t[1].dispatchEvent(new CustomEvent("click"))}),t[0].addEventListener("click",()=>{e.destroy()}),t[1].addEventListener("click",()=>{const a=e.element.querySelector("input").value;if(!validateName(a))return!1;fetchPost("/api/notebook/createNotebook",{name:a}),e.destroy()})},du=e=>{fetchPost("/api/storage/getRecentDocs",{},t=>{let a="";t.data.forEach((n,o)=>{a+=`<li data-index="${o}" data-node-id="${n.rootID}" class="b3-list-item${o===0?" b3-list-item--focus":""}">
${unicode2Emoji(n.icon||window.siyuan.storage[Constants.LOCAL_IMAGES].file,"b3-list-item__graphic",!0)}
<span class="b3-list-item__text">${escapeHtml(n.title)}</span>
</li>`}),openModel({title:window.siyuan.languages.recentDocs,icon:"iconList",html:`<ul class="b3-list b3-list--mobile">${a}</ul>`,bindEvent(n){n.firstElementChild.addEventListener("click",o=>{const i=hasClosestByClassName(o.target,"b3-list-item");i&&openMobileFileById(e,i.dataset.nodeId,[Constants.CB_GET_SCROLL])})}})})},ln=(e,t)=>{if(!e||e.length===0)return`<li style="padding-left: 40px;" class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;let a="";return e.forEach((n,o)=>{let i="";t&&(i=`data-id2="${t[o].fileID}"`),a+=`<li style="padding-left: 40px;" class="b3-list-item" ${i} data-id="${n.fileID}">
    <span class="b3-list-item__text" title="${escapeAttr(n.path)} ${n.hSize}">${escapeHtml(n.title)}</span>
</li>`}),a};let pt,Tt;const hs=(e,t)=>{if(!hasClosestByClassName(t,"history__side"))return;const n=hasClosestByClassName(t,"b3-dialog__container");if(!n)return;const o=n.querySelector('[data-type="editors"]'),i=o.firstElementChild,s=o.lastElementChild;pt||(pt=new Protyle(e,i.lastElementChild,{blockId:"",history:{snapshot:""},action:[Constants.CB_GET_HISTORY],render:{background:!1,gutter:!1,breadcrumb:!1,breadcrumbDocName:!1},typewriterMode:!1}),disabledProtyle(pt.protyle),Tt=new Protyle(e,s.lastElementChild,{blockId:"",action:[Constants.CB_GET_HISTORY],history:{snapshot:""},render:{background:!1,gutter:!1,breadcrumb:!1,breadcrumbDocName:!1},typewriterMode:!1}),disabledProtyle(Tt.protyle)),fetchPost("/api/repo/openRepoSnapshotDoc",{id:t.getAttribute("data-id")},r=>{i.classList.remove("fn__none");const c=i.querySelector("textarea"),d=pathPosix().extname(r.data.content).toLowerCase(),u=i.querySelector(".protyle-title__input");Constants.SIYUAN_ASSETS_IMAGE.concat(Constants.SIYUAN_ASSETS_AUDIO).concat(Constants.SIYUAN_ASSETS_VIDEO).includes(d)?(c.previousElementSibling.innerHTML=renderAssetsPreview(r.data.content),c.previousElementSibling.classList.remove("fn__none"),c.classList.add("fn__none"),i.lastElementChild.classList.add("fn__none")):r.data.displayInText?(c.value=r.data.content,c.classList.remove("fn__none"),i.lastElementChild.classList.add("fn__none"),c.previousElementSibling.classList.add("fn__none")):(c.classList.add("fn__none"),i.lastElementChild.classList.remove("fn__none"),c.previousElementSibling.classList.add("fn__none"),pt.protyle.options.history.snapshot=n.querySelector(".b3-dialog__header code").getAttribute("data-snapshot"),onGet({data:r,protyle:pt.protyle,action:[Constants.CB_GET_HISTORY,Constants.CB_GET_HTML]})),u.textContent=r.data.title,i.querySelector(".history__date").textContent=dayjs(r.data.updated).format("YYYY-MM-DD HH:mm")});const l=t.getAttribute("data-id2");l?(s.classList.remove("fn__none"),fetchPost("/api/repo/openRepoSnapshotDoc",{id:l},r=>{const c=s.querySelector("textarea"),d=pathPosix().extname(r.data.content).toLowerCase(),u=s.querySelector(".protyle-title__input");Constants.SIYUAN_ASSETS_IMAGE.concat(Constants.SIYUAN_ASSETS_AUDIO).concat(Constants.SIYUAN_ASSETS_VIDEO).includes(d)?(c.previousElementSibling.innerHTML=renderAssetsPreview(r.data.content),c.previousElementSibling.classList.remove("fn__none"),c.classList.add("fn__none"),s.lastElementChild.classList.add("fn__none")):r.data.displayInText?(c.value=r.data.content,c.classList.remove("fn__none"),s.lastElementChild.classList.add("fn__none"),c.previousElementSibling.classList.add("fn__none")):(c.classList.add("fn__none"),s.lastElementChild.classList.remove("fn__none"),c.previousElementSibling.classList.add("fn__none"),Tt.protyle.options.history.snapshot=n.querySelectorAll(".b3-dialog__header code")[1].getAttribute("data-snapshot"),onGet({data:r,protyle:Tt.protyle,action:[Constants.CB_GET_HISTORY,Constants.CB_GET_HTML]})),u.textContent=r.data.title,s.querySelector(".history__date").textContent=dayjs(r.data.updated).format("YYYY-MM-DD HH:mm")})):s.classList.add("fn__none")},uu=(e,t)=>{if(t.length!==2)return;let a,n;t[0].time>t[1].time?(a=t[1].id,n=t[0].id):(a=t[0].id,n=t[1].id);const o=new Dialog({title:window.siyuan.languages.compare,content:"",width:isMobile()?"92vw":"90vw",height:"80vh",containerClassName:"b3-dialog__container--theme",destroyCallback(){pt=void 0,Tt=void 0}});o.element.setAttribute("data-key",Constants.DIALOG_HISTORYCOMPARE),o.element.addEventListener("click",i=>{var s;if(typeof i.detail=="string"){hs(e,o.element.querySelector(".history__side .b3-list-item--focus")),i.stopPropagation(),i.preventDefault();return}let l=i.target;for(;l&&l!==o.element;){if(l.classList.contains("b3-list-item")&&!l.dataset.id){l.nextElementSibling.classList.toggle("fn__none"),l.querySelector("svg").classList.toggle("b3-list-item__arrow--open"),i.preventDefault(),i.stopPropagation();break}else if(l.classList.contains("b3-list-item")&&l.dataset.id){if(l.classList.contains("b3-list-item--focus"))return;(s=o.element.querySelector(".history__side .b3-list-item--focus"))==null||s.classList.remove("b3-list-item--focus"),l.classList.add("b3-list-item--focus"),hs(e,l),i.preventDefault(),i.stopPropagation();break}else if(l.classList.contains("block__icon")){l.getAttribute("data-direct")==="left"?(l.setAttribute("data-direct","right"),rn(n,a,o,"right")):(l.setAttribute("data-direct","left"),rn(a,n,o,"left")),i.preventDefault(),i.stopPropagation();break}l=l.parentElement}}),rn(a,n,o,"left")},rn=(e,t,a,n)=>{pt=void 0,Tt=void 0;const o=isMobile();fetchPost("/api/repo/diffRepoSnapshots",{left:e,right:t},i=>{const s=a.element.querySelector(".b3-dialog__header");s.innerHTML=`<div style="padding: 0;min-height: auto;" class="block__icons">
    <span class="fn__flex-1"></span>
    <code class="fn__code${o?" fn__none":""}" data-snapshot="${e}">${e.substring(0,7)}</code>
    ${o?"":'<span class="fn__space"></span>'}
    ${dayjs(i.data.left.created).format("YYYY-MM-DD HH:mm")}
    <span class="fn__space"></span>
    <span class="block__icon block__icon--show b3-tooltips b3-tooltips__s" aria-label="${window.siyuan.languages.switchDirect}" data-direct="${n}"><svg><use xlink:href="#iconScrollHoriz"></use></svg></span>
    <span class="fn__space"></span>
    <code class="fn__code${o?" fn__none":""}" data-snapshot="${t}">${t.substring(0,7)}</code>
    ${o?"":'<span class="fn__space"></span>'}
    ${dayjs(i.data.right.created).format("YYYY-MM-DD HH:mm")}
    <span class="fn__flex-1"></span>
</div>`,s.nextElementSibling.innerHTML=`<div class="fn__flex history__panel" style="height: 100%">
    <div class="history__side" ${isMobile()?"":`style="width: ${window.siyuan.storage[Constants.LOCAL_HISTORY].sideDiffWidth}"`}>
        <ul class="b3-list b3-list--background">
            <li class="b3-list-item">
                <span class="b3-list-item__toggle b3-list-item__toggle--hl">
                    <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
                </span>
                <span style="padding-left: 4px" class="b3-list-item__text">${window.siyuan.languages.update}</span>
                <span class="counter${i.data.updatesLeft.length===0?" fn__none":""}">${i.data.updatesLeft.length}</span>
            </li>
            <ul class="fn__none">${ln(i.data.updatesLeft,i.data.updatesRight)}</ul>
        </ul>
        <ul class="b3-list b3-list--background">
            <li class="b3-list-item">
                <span class="b3-list-item__toggle b3-list-item__toggle--hl">
                    <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
                </span>
                <span style="padding-left: 4px" class="b3-list-item__text">${window.siyuan.languages.addAttr}</span>
                <span class="counter${i.data.addsLeft.length===0?" fn__none":""}">${i.data.addsLeft.length}</span>
            </li>
            <ul class="fn__none">${ln(i.data.addsLeft)}</ul>
        </ul>
        <ul class="b3-list b3-list--background">
            <li class="b3-list-item">
                <span class="b3-list-item__toggle b3-list-item__toggle--hl">
                    <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
                </span>
                <span style="padding-left: 4px" class="b3-list-item__text">${window.siyuan.languages.remove}</span>
                <span class="counter${i.data.removesRight.length===0?" fn__none":""}">${i.data.removesRight.length}</span>
            </li>
            <ul class="fn__none">${ln(i.data.removesRight)}</ul>
        </ul>
    </div>
    <div class="history__resize"></div>
    <div class="fn__flex-1 fn__flex" data-type="editors">
        <div class="fn__none fn__flex-1 fn__flex-column">
            <div class="history__date">${dayjs(i.data.left.created).format("YYYY-MM-DD HH:mm")}</div>
            <div class="protyle-title__input ft__center ft__breakword">${i.data.left.title}</div>
            <div class="ft__center"></div>
            <textarea class="history__text fn__none fn__flex-1" readonly></textarea>
            <div class="fn__flex-1"></div>
        </div>
        <div class="fn__none fn__flex-1 fn__flex-column" style="border-left: 1px solid var(--b3-border-color);">
            <div class="history__date">${i.data.right.title} ${dayjs(i.data.right.created).format("YYYY-MM-DD HH:mm")}</div>
            <div class="protyle-title__input ft__center ft__breakword">${i.data.right.title}</div>
            <div class="ft__center"></div>
            <textarea class="history__text fn__none fn__flex-1" readonly></textarea>
            <div class="fn__flex-1"></div>
        </div>
    </div>
</div>`,resizeSide(a.element.querySelector(".history__resize"),a.element.querySelector(".history__side"),"sideDiffWidth")})};let mt;const It=(e,t)=>{const a=e.querySelector('[data-type="docprevious"]'),n=e.querySelector('[data-type="docnext"]');e.setAttribute("data-page",t.toString()),t>1?a.removeAttribute("disabled"):a.setAttribute("disabled","disabled");const o=e.querySelector('button[data-type="jumpHistoryPage"]');o.textContent=`${t}`;const i=e.querySelector(".b3-text-field"),s=e.querySelector('.b3-select[data-type="opselect"]'),l=e.querySelector('.b3-select[data-type="typeselect"]'),r=e.querySelector('.b3-select[data-type="notebookselect"]'),c=e.querySelector('.history__text[data-type="docPanel"]'),d=e.querySelector('.history__text[data-type="assetPanel"]'),u=e.querySelector('.history__text[data-type="mdPanel"]'),g=e.querySelector(".b3-list");e.querySelector(".protyle-title__input").classList.add("fn__none"),d.classList.add("fn__none"),u.classList.add("fn__none"),c.classList.add("fn__none"),l.value==="2"?(r.setAttribute("disabled","disabled"),window.siyuan.storage[Constants.LOCAL_HISTORY].type!==2&&(s.value="all"),s.querySelector('option[value="clean"]').classList.remove("fn__none"),s.querySelector('option[value="update"]').classList.remove("fn__none"),s.querySelector('option[value="delete"]').classList.add("fn__none"),s.querySelector('option[value="format"]').classList.add("fn__none"),s.querySelector('option[value="sync"]').classList.remove("fn__none"),s.querySelector('option[value="replace"]').classList.add("fn__none"),s.querySelector('option[value="outline"]').classList.add("fn__none")):(r.removeAttribute("disabled"),window.siyuan.storage[Constants.LOCAL_HISTORY].type===2&&(s.value="all"),s.querySelector('option[value="clean"]').classList.add("fn__none"),s.querySelector('option[value="update"]').classList.remove("fn__none"),s.querySelector('option[value="delete"]').classList.remove("fn__none"),s.querySelector('option[value="format"]').classList.remove("fn__none"),s.querySelector('option[value="sync"]').classList.remove("fn__none"),s.querySelector('option[value="replace"]').classList.remove("fn__none"),s.querySelector('option[value="outline"]').classList.remove("fn__none")),window.siyuan.storage[Constants.LOCAL_HISTORY].notebookId=r.value,window.siyuan.storage[Constants.LOCAL_HISTORY].type=parseInt(l.value),window.siyuan.storage[Constants.LOCAL_HISTORY].operation=s.value,setStorageVal(Constants.LOCAL_HISTORY,window.siyuan.storage[Constants.LOCAL_HISTORY]),fetchPost("/api/history/searchHistory",{notebook:r.value,query:i.value,page:t,op:s.value,type:parseInt(l.value)},f=>{t<f.data.pageCount?n.removeAttribute("disabled"):n.setAttribute("disabled","disabled"),o.setAttribute("data-totalpage",(f.data.pageCount||1).toString());const p=n.nextElementSibling.nextElementSibling;if(p.textContent=`${window.siyuan.languages.pageCountAndHistoryCount.replace("${x}",f.data.pageCount).replace("${y}",f.data.totalCount||1)}`,p.classList.remove("fn__none"),f.data.histories.length===0){g.innerHTML=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;return}let m="";f.data.histories.forEach(b=>{m+=`<li class="b3-list-item" data-type="toggle" data-created="${b}">
    <span class="b3-list-item__toggle b3-list-item__toggle--hl"><svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg></span>
    <span style="padding-left: 4px" class="b3-list-item__text">${dayjs(parseInt(b)*1e3).format("YYYY-MM-DD HH:mm:ss")}</span>
</li>`}),g.innerHTML=m})},ws=(e,t,a)=>{if(e.data.snapshots.length===0){t.lastElementChild.innerHTML=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;return}let n="";a==="getCloudRepoTagSnapshots"?n=`<span class="fn__flex-1"></span>
<span class="b3-list-item__action" data-type="downloadSnapshot">
    <svg><use xlink:href="#iconDownload"></use></svg>
    <span class="fn__space"></span>
    ${window.siyuan.languages.download}
</span>
<span class="fn__flex-1"></span>
<span class="b3-list-item__action" data-type="removeCloudRepoTagSnapshot">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
    <span class="fn__space"></span>
    ${window.siyuan.languages.remove}
</span>
<span class="fn__flex-1"></span>`:a==="getCloudRepoSnapshots"?n=`<span class="fn__flex-1"></span>
<span class="b3-list-item__action" data-type="downloadSnapshot">
    <svg><use xlink:href="#iconDownload"></use></svg>
    <span class="fn__space"></span>
    ${window.siyuan.languages.download}
</span>
<span class="fn__flex-1"></span>`:a==="getRepoTagSnapshots"?n=`<span class="fn__flex-1"></span>
<span class="b3-list-item__action" data-type="uploadSnapshot">
    <svg><use xlink:href="#iconUpload"></use></svg>
    <span class="fn__space"></span>
    ${window.siyuan.languages.upload}
</span>
<span class="fn__flex-1"></span>
<span class="b3-list-item__action" data-type="rollback">
    <svg><use xlink:href="#iconUndo"></use></svg>
    <span class="fn__space"></span>
    ${window.siyuan.languages.rollback}
</span>
<span class="fn__flex-1"></span>
<span class="b3-list-item__action" data-type="removeRepoTagSnapshot">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
    <span class="fn__space"></span>
    ${window.siyuan.languages.remove}
</span>
<span class="fn__flex-1"></span>`:a==="getRepoSnapshots"&&(n=`<span class="fn__flex-1"></span>
<span class="b3-list-item__action" data-type="genTag">
    <svg><use xlink:href="#iconTags"></use></svg>
    <span class="fn__space"></span>
    ${window.siyuan.languages.tagSnapshot}
</span>
<span class="fn__flex-1"></span>
<span class="b3-list-item__action" data-type="rollback">
    <svg><use xlink:href="#iconUndo"></use></svg>
    <span class="fn__space"></span>
    ${window.siyuan.languages.rollback}
</span>
<span class="fn__flex-1"></span>`);let o="";const i=isMobile();e.data.snapshots.forEach(s=>{let l="";s.typesCount&&(l=`<div class="b3-list-item__meta${i?" fn__none":""}">
${window.siyuan.languages.fileCount} ${s.count}<span class="fn__space"></span>`,s.typesCount.forEach(c=>{l+=`${c.type} ${c.count}<span class="fn__space"></span>`}),l+="</div>");const r=`<div${i?' style="padding-top:8px"':""}>
    <span data-type="hCreated">${s.hCreated}</span>
    <span class="fn__space"></span>
    ${s.hSize}
    <span class="fn__space"></span>
    ${s.systemOS}${s.systemName&&s.systemOS?"/":""}${s.systemName}
    <span class="fn__space"></span>
    <span class="b3-chip b3-chip--secondary b3-chip--small${s.tag?"":" fn__none"}">${s.tag}</span>
</div>
<div class="b3-list-item__meta${i?" fn__none":""}">
    ${escapeHtml(s.memo)}
    <span class="fn__space"></span>
    <code class="fn__code">${s.id.substring(0,7)}</code>
</div>
${l}`;o+=`<li class="b3-list-item" data-type="repoitem" data-id="${s.id}" data-tag="${s.tag}">
<div class="fn__flex-1">
    ${r}
    <div class="fn__flex" style="height: 26px" data-id="${s.id}" data-tag="${s.tag}">
        ${n}
        <span class="b3-list-item__action" data-type="more">
            <svg><use xlink:href="#iconMore"></use></svg>
            <span class="fn__space"></span>
            ${window.siyuan.languages.more}
        </span>
        <span class="fn__flex-1"></span>
    </div>
</div>
</li>`}),t.lastElementChild.innerHTML=`${o}`},at=(e,t)=>{const a=e.querySelector(".b3-select");a.disabled=!0;const n=a.value;e.lastElementChild.innerHTML='<li style="position: relative;height: 100%;"><div class="fn__loading"><img width="64px" src="/stage/loading-pure.svg"></div></li>';const o=e.querySelector('button[data-type="jumpRepoPage"]');o.textContent=`${t}`;const i=e.querySelector('[data-type="previous"]'),s=e.querySelector('[data-type="next"]'),l=s.nextElementSibling.nextElementSibling;e.setAttribute("data-init","true"),n==="getRepoTagSnapshots"||n==="getCloudRepoTagSnapshots"?(fetchPost(`/api/repo/${n}`,{},r=>{ws(r,e,n),a.disabled=!1}),i.classList.add("fn__none"),s.classList.add("fn__none"),l.classList.add("fn__none"),o.classList.add("fn__none")):(i.classList.remove("fn__none"),s.classList.remove("fn__none"),o.classList.remove("fn__none"),e.setAttribute("data-page",t.toString()),t>1?i.removeAttribute("disabled"):i.setAttribute("disabled","disabled"),s.setAttribute("disabled","disabled"),fetchPost(`/api/repo/${n}`,{page:t},r=>{a.disabled=!1,t<r.data.pageCount?s.removeAttribute("disabled"):s.setAttribute("disabled","disabled"),o.setAttribute("data-totalpage",(r.data.pageCount||1).toString()),l.textContent=`${window.siyuan.languages.pageCountAndSnapshotCount.replace("${x}",r.data.pageCount).replace("${y}",r.data.totalCount||1)}`,l.classList.remove("fn__none"),ws(r,e,n)}))},Oo=e=>{e.setAttribute("data-init","true"),fetchPost("/api/history/getNotebookHistory",{},t=>{if(t.data.histories.length===0){e.innerHTML=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;return}let a="";t.data.histories.forEach((n,o)=>{a+=`<li class="b3-list-item" style="padding-left: 0" data-type="rmtoggle">
    <span style="padding-left: 8px" class="b3-list-item__toggle"><svg class="b3-list-item__arrow${o===0?" b3-list-item__arrow--open":""}${n.items.length>0?"":" fn__hidden"}"><use xlink:href="#iconRight"></use></svg></span>
    <span class="b3-list-item__text">${n.hCreated}</span>
</li>`,n.items.length>0&&(a+=`<ul class="${o===0?"":"fn__none"}">`,n.items.forEach(i=>{a+=`<li data-type="notebook" data-path="${i.path}" class="b3-list-item b3-list-item--hide-action" style="padding-left: 32px">
    <span class="b3-list-item__text">${escapeHtml(i.title)}</span>
    <span class="fn__space"></span>
    <span class="b3-list-item__action b3-tooltips b3-tooltips__w" data-type="rollback" aria-label="${window.siyuan.languages.rollback}">
        <svg><use xlink:href="#iconUndo"></use></svg>
    </span>
</li>`}),a+="</ul>")}),e.innerHTML=a})},fu=e=>{if(window.siyuan.config.readonly||window.siyuan.dialogs.find(i=>{if(i.element.querySelector("#historyContainer"))return i.destroy(),!0}))return;const a=window.siyuan.storage[Constants.LOCAL_HISTORY];let n=`<option value='%' ${a.notebookId==="%"?"selected":""}>${window.siyuan.languages.allNotebooks}</option>`;window.siyuan.notebooks.forEach(i=>{i.closed||(n+=` <option value="${i.id}"${i.id===a.notebookId?" selected":""}>${escapeHtml(i.name)}</option>`)});const o=`<div class="fn__flex-column" style="height: 100%;">
    <div class="layout-tab-bar fn__flex" ${isMobile()?"":'style="border-radius: var(--b3-border-radius-b) var(--b3-border-radius-b) 0 0"'}>
        <div data-type="doc" class="item item--full item--focus"><span class="fn__flex-1"></span><span class="item__text">${window.siyuan.languages.fileHistory}</span><span class="fn__flex-1"></span></div>
        <div data-type="notebook" style="min-width: 160px" class="item item--full"><span class="fn__flex-1"></span><span class="item__text">${window.siyuan.languages.removedNotebook}</span><span class="fn__flex-1"></span></div>
        <div data-type="repo" class="item item--full"><span class="fn__flex-1"></span><span class="item__text">${window.siyuan.languages.dataSnapshot}</span><span class="fn__flex-1"></span></div>
    </div>
    <div class="fn__flex-1 fn__flex" id="historyContainer">
        <div data-type="doc" class="history__repo fn__block" data-init="true">
            <div class="history__action">
                <div class="block__icons">
                    <span data-type="docprevious" class="block__icon block__icon--show b3-tooltips b3-tooltips__e" disabled="disabled" aria-label="${window.siyuan.languages.previousLabel}"><svg><use xlink:href='#iconLeft'></use></svg></span>
                    <button class="b3-button b3-button--text ft__selectnone" data-type="jumpHistoryPage" data-totalpage="1">1</button>
                    <span data-type="docnext" class="block__icon block__icon--show b3-tooltips b3-tooltips__e" disabled="disabled" aria-label="${window.siyuan.languages.nextLabel}"><svg><use xlink:href='#iconRight'></use></svg></span>
                    <span class="fn__space"></span>
                    <span class="ft__on-surface fn__flex-shrink ft__selectnone fn__none">${window.siyuan.languages.pageCountAndHistoryCount}</span>
                    <span class="fn__space"></span>
                    <div class="fn__flex-1"></div>
                    <div style="position: relative">
                        <svg class="b3-form__icon-icon ft__on-surface"><use xlink:href="#iconSearch"></use></svg>
                        <input class="b3-text-field b3-form__icon-input ${isMobile()?"fn__size96":"fn__size200"}">
                    </div>
                    <span class="fn__space"></span>
                    <select data-type="typeselect" class="b3-select ${isMobile()?"fn__size96":"fn__size200"}">
                        <option value="0" ${a.type===0?"selected":""}>${window.siyuan.languages.docName}</option>
                        <option value="1" ${a.type===1?"selected":""}>${window.siyuan.languages.docNameAndContent}</option>
                        <option value="2" ${a.type===2?"selected":""}>${window.siyuan.languages.assets}</option>
                    </select>
                    <span class="fn__space"></span>
                    <select data-type="opselect" class="b3-select${isMobile()?" fn__size96":""}">
                        <option value="all" ${a.operation==="all"?"selected":""}>${window.siyuan.languages.allOp}</option>
                        <option value="clean" ${a.operation==="clean"?"selected":""}>${window.siyuan.languages.historyClean}</option>
                        <option value="update" ${a.operation==="update"?"selected":""}>${window.siyuan.languages.historyUpdate}</option>
                        <option value="delete" ${a.operation==="delete"?"selected":""}>${window.siyuan.languages.historyDelete}</option>
                        <option value="format" ${a.operation==="format"?"selected":""}>${window.siyuan.languages.historyFormat}</option>
                        <option value="sync" ${a.operation==="sync"?"selected":""}>${window.siyuan.languages.historySync}</option>
                        <option value="replace" ${a.operation==="replace"?"selected":""}>${window.siyuan.languages.historyReplace}</option>
                        <option value="outline" ${a.operation==="outline"?"selected":""}>${window.siyuan.languages.historyOutline}</option>
                    </select>
                    <span class="fn__space"></span>
                    <select data-type="notebookselect" class="b3-select ${isMobile()?"fn__size96":"fn__size200"}">
                        ${n}
                    </select>
                    <span class="fn__space"></span>
                    <button data-type="rebuildIndex" class="b3-button b3-button--outline">${window.siyuan.languages.rebuildIndex}</button>
                </div>
            </div>
            <div class="fn__flex fn__flex-1 history__panel">
                <ul class="b3-list b3-list--background history__side" ${isMobile()?"":`style="width: ${a.sideWidth}"`}>
                    <li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>
                </ul>
                <div class="history__resize"></div>
                <div class="fn__flex-column fn__flex-1">
                    <div class="protyle-title__input ft__center ft__breakword fn__none"></div>
                    <div class="fn__flex-1 history__text fn__none" data-type="assetPanel"></div>
                    <textarea class="fn__flex-1 history__text fn__none" data-type="mdPanel"></textarea>
                    <div class="fn__flex-1 history__text fn__none" style="padding: 0" data-type="docPanel"></div>
                </div>
            </div>
        </div>
        <ul data-type="notebook" style="padding: 8px 0;" class="fn__none b3-list b3-list--background">
            <li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>
        </ul>
        <div data-type="repo" class="fn__none history__repo">
            <div class="history__action">
                <div class="block__icons">
                    <span data-type="previous" class="block__icon block__icon--show b3-tooltips b3-tooltips__e" disabled="disabled" aria-label="${window.siyuan.languages.previousLabel}"><svg><use xlink:href='#iconLeft'></use></svg></span>
                    <button class="b3-button b3-button--text ft__selectnone" data-type="jumpRepoPage" data-totalpage="1">1</button>
                    <span data-type="next" class="block__icon block__icon--show b3-tooltips b3-tooltips__e" disabled="disabled" aria-label="${window.siyuan.languages.nextLabel}"><svg><use xlink:href='#iconRight'></use></svg></span>
                    <span class="fn__space"></span>
                    <span class="ft__on-surface fn__flex-shrink ft__selectnone fn__none">${window.siyuan.languages.pageCountAndSnapshotCount}</span>
                    <span class="fn__space"></span>
                    <div class="fn__flex-1"></div>
                    <select class="b3-select ${isMobile()?"fn__size96":"fn__size200"}">
                        <option value="getRepoSnapshots">${window.siyuan.languages.localSnapshot}</option>
                        <option value="getRepoTagSnapshots">${window.siyuan.languages.localTagSnapshot}</option>
                        <option value="getCloudRepoSnapshots">${window.siyuan.languages.cloudSnapshot}</option>
                        <option value="getCloudRepoTagSnapshots">${window.siyuan.languages.cloudTagSnapshot}</option>
                    </select>
                    <span class="fn__space"></span>
                    <button class="b3-button b3-button--outline" disabled data-type="compare">${window.siyuan.languages.compare}</button>
                    <span class="fn__space"></span>
                    <button class="b3-button b3-button--outline" data-type="genRepo">
                        <svg><use xlink:href="#iconAdd"></use></svg>${window.siyuan.languages.createSnapshot}
                    </button>
                </div>    
            </div>
            <ul class="b3-list b3-list--background fn__flex-1" style="padding-bottom: 8px">
                <li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>
            </ul>
        </div>
    </div>
</div>`;if(isMobile())openModel({html:o,icon:"iconHistory",title:window.siyuan.languages.dataHistory,bindEvent(i){i.firstElementChild.setAttribute("style","background-color:var(--b3-theme-background);height:100%"),_s(e,i.firstElementChild)}});else{const i=new Dialog({content:o,width:"90vw",height:"80vh",containerClassName:"b3-dialog__container--theme",destroyCallback(){mt=void 0}});i.element.setAttribute("data-key",Constants.DIALOG_HISTORY),i.element.querySelector("input").focus(),_s(e,i.element,i),resizeSide(i.element.querySelector(".history__resize"),i.element.querySelector(".history__side"),"sideWidth")}},_s=(e,t,a)=>{const n=t.querySelector("#historyContainer [data-type=doc]");n.querySelectorAll(".b3-select").forEach(u=>{u.addEventListener("change",()=>{It(n,1)})}),n.querySelector(".b3-text-field").addEventListener("input",u=>{u.isComposing||It(n,1)}),n.querySelector(".b3-text-field").addEventListener("compositionend",()=>{It(n,1)});const o=n.querySelector('.history__text[data-type="docPanel"]'),i=n.querySelector('.history__text[data-type="assetPanel"]'),s=n.querySelector('.history__text[data-type="mdPanel"]'),l=n.querySelector(".protyle-title__input");It(n,1),mt=new Protyle(e,o,{blockId:"",history:{created:""},action:[Constants.CB_GET_HISTORY],render:{background:!1,gutter:!1,breadcrumb:!1,breadcrumbDocName:!1},typewriterMode:!1}),disabledProtyle(mt.protyle);const r=t.querySelector('#historyContainer [data-type="repo"]'),c=t.querySelector('#historyContainer [data-type="doc"]'),d=r.querySelector(".b3-select");d.addEventListener("change",()=>{at(r,1);const u=t.querySelector(".b3-button[data-type='compare']");u.setAttribute("disabled","disabled"),u.removeAttribute("data-ids")}),t.addEventListener("click",u=>{var g;let f=u.target;for(;f&&!f.isEqualNode(t);){const p=f.getAttribute("data-type");if(f.classList.contains("item")){f.parentElement.querySelector(".item--focus").classList.remove("item--focus"),Array.from(t.querySelector("#historyContainer").children).forEach(m=>{m.getAttribute("data-type")===p?(m.classList.remove("fn__none"),m.classList.add("fn__block"),f.classList.add("item--focus"),m.getAttribute("data-init")!=="true"&&(p==="notebook"?Oo(m):p==="repo"&&at(m,1))):(m.classList.add("fn__none"),m.classList.remove("fn__block"))}),u.stopPropagation(),u.preventDefault();break}else if(f.classList.contains("b3-list-item__action")&&p==="rollback"&&!window.siyuan.config.readonly){const m=f.parentElement.getAttribute("data-type");let b=f.previousElementSibling.previousElementSibling.textContent.trim(),w=dayjs(parseInt(f.parentElement.getAttribute("data-created"))*1e3).format("YYYY-MM-DD HH:mm:ss");m==="notebook"?w=f.parentElement.parentElement.previousElementSibling.textContent.trim():m==="repoitem"&&(b=window.siyuan.languages.workspaceData,w=f.parentElement.querySelector("span[data-type='hCreated']").textContent.trim());const y=window.siyuan.languages.rollbackConfirm.replace("${name}",b).replace("${time}",w);confirmDialog("\u26A0\uFE0F "+window.siyuan.languages.rollback,y,()=>{m==="assets"?fetchPost("/api/history/rollbackAssetsHistory",{historyPath:f.parentElement.getAttribute("data-path")}):m==="doc"?fetchPost("/api/history/rollbackDocHistory",{notebook:f.parentElement.getAttribute("data-notebook-id"),historyPath:f.parentElement.getAttribute("data-path")}):m==="notebook"?fetchPost("/api/history/rollbackNotebookHistory",{historyPath:f.parentElement.getAttribute("data-path")}):fetchPost("/api/repo/checkoutRepo",{id:f.parentElement.getAttribute("data-id")})}),u.stopPropagation(),u.preventDefault();break}else if(p==="more"){f.parentElement.parentElement.querySelectorAll(".b3-list-item__meta").forEach(m=>{m.classList.toggle("fn__none")}),u.stopPropagation(),u.preventDefault();break}else if(p==="toggle"){const m=f.firstElementChild.firstElementChild;if(m.classList.contains("b3-list-item__arrow--open"))f.nextElementSibling.classList.add("fn__none"),m.classList.remove("b3-list-item__arrow--open");else if(f.nextElementSibling&&f.nextElementSibling.tagName==="UL")f.nextElementSibling.classList.remove("fn__none"),m.classList.add("b3-list-item__arrow--open");else{const b=n.querySelector(".b3-text-field"),w=n.querySelector('.b3-select[data-type="opselect"]'),y=n.querySelector('.b3-select[data-type="typeselect"]'),_=n.querySelector('.b3-select[data-type="notebookselect"]'),h=f.getAttribute("data-created");fetchPost("/api/history/getHistoryItems",{notebook:_.value,query:b.value,op:w.value,type:parseInt(y.value),created:h},E=>{m.classList.add("b3-list-item__arrow--open");let C="",k="";E.data.items.forEach(v=>{let A=" b3-chip b3-chip--list ";v.op==="clean"?(A+="b3-chip--primary ",k=window.siyuan.languages.historyClean):v.op==="update"?(A+="b3-chip--info ",k=window.siyuan.languages.historyUpdate):v.op==="delete"?(A+="b3-chip--error ",k=window.siyuan.languages.historyDelete):v.op==="format"?(A+="b3-chip--pink ",k=window.siyuan.languages.historyFormat):v.op==="sync"?(A+="b3-chip--success ",k=window.siyuan.languages.historySync):v.op==="replace"?(A+="b3-chip--secondary ",k=window.siyuan.languages.historyReplace):v.op==="outline"&&(A+="b3-chip--warning ",k=window.siyuan.languages.historyOutline),C+=`<li data-notebook-id="${v.notebook}" data-created="${h}" data-type="${y.value==="2"?"assets":"doc"}" data-path="${v.path}" class="b3-list-item b3-list-item--hide-action" style="padding-left: 22px">
    <span class="${w.value==="all"?"":"fn__none"}${A}ariaLabel" data-position="6south" aria-label="${k}">${v.op.substring(0,1).toUpperCase()}</span>
    <span class="b3-list-item__text" title="${escapeAttr(v.title)}">${escapeHtml(v.title)}</span>
    <span class="fn__space"></span>
    <span class="b3-list-item__action ariaLabel" data-type="rollback" data-position="6south" aria-label="${window.siyuan.languages.rollback}">
        <svg><use xlink:href="#iconUndo"></use></svg>
    </span>
</li>`}),f.insertAdjacentHTML("afterend",`<ul>${C}</ul>`)})}u.stopPropagation(),u.preventDefault();break}else if(p==="rmtoggle"){f.nextElementSibling.classList.toggle("fn__none"),f.firstElementChild.firstElementChild.classList.toggle("b3-list-item__arrow--open"),u.stopPropagation(),u.preventDefault();break}else if(f.classList.contains("b3-list-item")&&p==="repoitem"&&["getRepoSnapshots","getRepoTagSnapshots"].includes(d.value)){const m=t.querySelector(".b3-button[data-type='compare']"),b=JSON.parse(m.getAttribute("data-ids")||"[]"),w=f.getAttribute("data-id");if(f.classList.contains("b3-list-item--focus"))f.classList.remove("b3-list-item--focus"),b.forEach((y,_)=>{w===y.id&&b.splice(_,1)});else{for(f.classList.add("b3-list-item--focus");b.length>1;)b[0].id!==w&&((g=f.parentElement.querySelector(`.b3-list-item[data-id="${b.splice(0,1)[0].id}"]`))==null||g.classList.remove("b3-list-item--focus"));b.push({id:w,time:f.querySelector('[data-type="hCreated"]').textContent})}b.length===2?m.removeAttribute("disabled"):m.setAttribute("disabled","disabled"),m.setAttribute("data-ids",JSON.stringify(b)),u.stopPropagation(),u.preventDefault();break}else if(f.classList.contains("b3-list-item")&&(p==="assets"||p==="doc")){const m=f.getAttribute("data-path");if(p==="assets")i.classList.remove("fn__none"),i.innerHTML=renderAssetsPreview(m);else if(p==="doc"){const w=n.querySelector(".b3-text-field").value;fetchPost("/api/history/getDocHistoryContent",{historyPath:m,highlight:!isSupportCSSHL(),k:w},y=>{y.data.isLargeDoc?(s.value=y.data.content,s.classList.remove("fn__none"),o.classList.add("fn__none")):(s.classList.add("fn__none"),o.classList.remove("fn__none"),mt.protyle.options.history.created=f.dataset.created,onGet({data:y,protyle:mt.protyle,action:[Constants.CB_GET_HISTORY,Constants.CB_GET_HTML]}),searchMarkRender(mt.protyle,w.split(" ")))})}l.classList.remove("fn__none"),l.textContent=f.querySelector(".b3-list-item__text").textContent;let b=hasClosestByClassName(f,"b3-list");b&&(b=b.querySelector(".b3-list-item--focus"),b&&b.classList.remove("b3-list-item--focus")),f.classList.add("b3-list-item--focus"),u.stopPropagation(),u.preventDefault();break}else if(p==="genRepo"){const m=new Dialog({title:window.siyuan.languages.snapshotMemo,content:`<div class="b3-dialog__content">
    <textarea class="b3-text-field fn__block" placeholder="${window.siyuan.languages.snapshotMemoTip}"></textarea>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px"});m.element.setAttribute("data-key",Constants.DIALOG_SNAPSHOTMEMO);const b=m.element.querySelector("textarea");b.focus();const w=m.element.querySelectorAll(".b3-button");m.bindInput(b,()=>{w[1].click()}),w[0].addEventListener("click",()=>{m.destroy()}),w[1].addEventListener("click",()=>{fetchPost("/api/repo/createSnapshot",{memo:b.value},()=>{at(r,1)}),m.destroy()}),u.stopPropagation(),u.preventDefault();break}else if(p==="removeRepoTagSnapshot"||p==="removeCloudRepoTagSnapshot"){const m=f.parentElement.getAttribute("data-tag");confirmDialog(window.siyuan.languages.deleteOpConfirm,`${window.siyuan.languages.confirmDelete} <i>${m}</i>?`,()=>{fetchPost("/api/repo/"+p,{tag:m},()=>{at(r,1)})},void 0,!0),u.stopPropagation(),u.preventDefault();break}else if(p==="uploadSnapshot"){fetchPost("/api/repo/uploadCloudSnapshot",{tag:f.parentElement.getAttribute("data-tag"),id:f.parentElement.getAttribute("data-id")}),u.stopPropagation(),u.preventDefault();break}else if(p==="downloadSnapshot"){fetchPost("/api/repo/downloadCloudSnapshot",{tag:f.parentElement.getAttribute("data-tag"),id:f.parentElement.getAttribute("data-id")}),u.stopPropagation(),u.preventDefault();break}else if(p==="genTag"){const m=new Dialog({title:window.siyuan.languages.tagSnapshot,content:`<div class="b3-dialog__content">
    <input class="b3-text-field fn__block" value="${dayjs().format("YYYYMMDDHHmmss")}" placeholder="${window.siyuan.languages.tagSnapshotTip}">
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.tagSnapshot}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.tagSnapshotUpload}</button>
</div>`,width:isMobile()?"92vw":"520px"});m.element.setAttribute("data-key",Constants.DIALOG_SNAPSHOTTAG);const b=m.element.querySelector(".b3-text-field");b.select();const w=m.element.querySelectorAll(".b3-button");w[0].addEventListener("click",()=>{m.destroy()}),w[2].addEventListener("click",()=>{fetchPost("/api/repo/tagSnapshot",{id:f.parentElement.getAttribute("data-id"),name:b.value},()=>{fetchPost("/api/repo/uploadCloudSnapshot",{tag:b.value,id:f.parentElement.getAttribute("data-id")},()=>{at(r,1)})}),m.destroy()}),w[1].addEventListener("click",()=>{fetchPost("/api/repo/tagSnapshot",{id:f.parentElement.getAttribute("data-id"),name:b.value},()=>{at(r,1)}),m.destroy()}),u.stopPropagation(),u.preventDefault();break}else if((p==="previous"||p==="next")&&f.getAttribute("disabled")!=="disabled"){const m=parseInt(r.getAttribute("data-page"));at(r,p==="previous"?m-1:m+1),u.stopPropagation(),u.preventDefault();break}else if(p==="jumpRepoPage"){const m=parseInt(r.getAttribute("data-page")),b=parseInt(f.getAttribute("data-totalpage")||"1");b>1&&confirmDialog(window.siyuan.languages.jumpToPage.replace("${x}",b),`<input class="b3-text-field fn__block" type="number" min="1" max="${b}" value="${m}">`,w=>{const y=w.element.querySelector(".b3-text-field");if(y.value==="")return;let _=parseInt(y.value);_=Math.max(1,Math.min(_,b)),at(r,_)})}else if(p==="jumpHistoryPage"){const m=parseInt(c.getAttribute("data-page")),b=parseInt(f.getAttribute("data-totalpage")||"1");b>1&&confirmDialog(window.siyuan.languages.jumpToPage.replace("${x}",b),`<input class="b3-text-field fn__block" type="number" min="1" max="${b}" value="${m}">`,w=>{const y=w.element.querySelector(".b3-text-field");if(y.value==="")return;let _=parseInt(y.value);_=Math.max(1,Math.min(_,b)),It(n,_)})}else if((p==="docprevious"||p==="docnext")&&f.getAttribute("disabled")!=="disabled"){const m=parseInt(n.getAttribute("data-page"));It(n,p==="docprevious"?m-1:m+1),u.stopPropagation(),u.preventDefault();break}else if(p==="rebuildIndex"){fetchPost("/api/history/reindexHistory"),a?a.destroy():(closeModel(),mt=void 0),u.stopPropagation(),u.preventDefault();break}else if(p==="compare"&&!f.getAttribute("disabled")){showDiff(e,JSON.parse(f.getAttribute("data-ids")||"[]")),u.stopPropagation(),u.preventDefault();break}f=f.parentElement}})},gu=e=>{setTitle(window.siyuan.languages.siyuanNote),document.getElementById("toolbarName").classList.add("fn__hidden"),document.getElementById("editor").classList.add("fn__none");const t=document.getElementById("empty");t.classList.remove("fn__none"),t.innerHTML===""&&(t.innerHTML=`<div id="emptySearch" class="b3-list-item">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconSearch"></use></svg><span class="fn__space"></span><span class="b3-list-item__text">${window.siyuan.languages.search}</span>
</div>
<div id="emptyRecent" class="b3-list-item">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconList"></use></svg><span class="fn__space"></span><span class="b3-list-item__text">${window.siyuan.languages.recentDocs}</span>
</div>
<div id="emptyHistory" class="b3-list-item${window.siyuan.config.readonly?" fn__none":""}">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconHistory"></use></svg><span class="fn__space"></span><span class="b3-list-item__text">${window.siyuan.languages.dataHistory}</span>
</div>
<div id="emptyNewFile" class="b3-list-item${getOpenNotebookCount()>0||!window.siyuan.config.readonly?"":" fn__none"}">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg><span class="fn__space"></span><span class="b3-list-item__text">${window.siyuan.languages.newFile}</span>
</div>
<div class="b3-list-item" id="emptyNewNotebook${window.siyuan.config.readonly?" fn__none":""}">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconFilesRoot"></use></svg><span class="fn__space"></span><span class="b3-list-item__text">${window.siyuan.languages.newNotebook}</span>
</div>
<div class="b3-list-item${isIPhone()||window.siyuan.config.readonly?" fn__none":""}" id="emptyHelp">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconHelp"></use></svg><span class="fn__space"></span><span class="b3-list-item__text">${window.siyuan.languages.userGuide}</span>
</div>`,t.addEventListener("click",a=>{let n=a.target;for(;n&&!n.isEqualNode(t);){if(n.id==="emptySearch"){popSearch(e),a.stopPropagation(),a.preventDefault();break}else if(n.id==="emptyRecent"){getRecentDocs(e),a.stopPropagation(),a.preventDefault();break}else if(n.id==="emptyHistory"){openHistory(e),a.stopPropagation(),a.preventDefault();break}else if(n.id==="emptyNewFile"){newFile({app:e,useSavePath:!0}),a.stopPropagation(),a.preventDefault();break}else if(n.id==="emptyNewNotebook"){newNotebook(),a.stopPropagation(),a.preventDefault();break}else if(n.id==="emptyHelp"){mountHelp(),a.stopPropagation(),a.preventDefault();break}n=n.parentElement}}))},pu=()=>{const e=document.getElementById("toolbarName");setTitle(e.value),e.classList.remove("fn__hidden"),document.getElementById("editor").classList.remove("fn__none"),document.getElementById("empty").classList.add("fn__none")},mu=(e,t=!1)=>{if(!e.wysiwyg.element.firstElementChild||window.siyuan.config.readonly)return;const a={rootId:e.block.rootID,startId:e.wysiwyg.element.firstElementChild.getAttribute("data-node-id"),endId:e.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),scrollTop:e.contentElement.scrollTop||parseInt(e.contentElement.getAttribute("data-scrolltop"))||0};let n;if(getSelection().rangeCount>0&&(n=getSelection().getRangeAt(0)),(!n||!e.wysiwyg.element.contains(n.startContainer))&&(n=e.toolbar.range),n&&e.wysiwyg.element.contains(n.startContainer)){const o=hasClosestBlock(n.startContainer);if(o){const i=getSelectionOffset(o,void 0,n);a.focusId=o.getAttribute("data-node-id"),a.focusStart=i.start,a.focusEnd=i.end}}return e.block.showAll&&(a.zoomInId=e.block.id),t?a:(window.siyuan.storage[Constants.LOCAL_FILEPOSITION][e.block.rootID]=a,new Promise(o=>{setStorageVal(Constants.LOCAL_FILEPOSITION,window.siyuan.storage[Constants.LOCAL_FILEPOSITION],()=>{o(!0)})}))},bu=e=>{var t,a,n,o,i,s,l,r,c,d,u,g,f;let p=[];if(e.mergedOptions?p=e.mergedOptions.action:e.focus?p=[Constants.CB_GET_UNUNDO,Constants.CB_GET_FOCUS]:p=[Constants.CB_GET_UNUNDO],(t=e.scrollAttr)!=null&&t.zoomInId){fetchPost("/api/filetree/getDoc",{id:e.scrollAttr.zoomInId,size:Constants.SIZE_GET_MAX,query:(a=e.protyle.query)==null?void 0:a.key,queryMethod:(n=e.protyle.query)==null?void 0:n.method,queryTypes:(o=e.protyle.query)==null?void 0:o.types,highlight:!isSupportCSSHL()},m=>{var b,w,y,_,h;m.code===1?fetchPost("/api/filetree/getDoc",{id:e.scrollAttr.rootId||((b=e.mergedOptions)==null?void 0:b.blockId)||((w=e.protyle.block)==null?void 0:w.rootID)||e.scrollAttr.startId,query:(y=e.protyle.query)==null?void 0:y.key,queryMethod:(_=e.protyle.query)==null?void 0:_.method,queryTypes:(h=e.protyle.query)==null?void 0:h.types,highlight:!isSupportCSSHL()},E=>{onGet({data:E,protyle:e.protyle,action:p,scrollAttr:e.scrollAttr,afterCB:e.cb?()=>{e.cb(E.data.keywords)}:void 0,updateReadonly:e.updateReadonly})}):(p.push(Constants.CB_GET_ALL),onGet({data:m,protyle:e.protyle,action:p,scrollAttr:e.scrollAttr,afterCB:e.cb?()=>{e.cb(m.data.keywords)}:void 0,updateReadonly:e.updateReadonly}))});return}fetchPost("/api/filetree/getDoc",{id:((i=e.scrollAttr)==null?void 0:i.rootId)||((s=e.mergedOptions)==null?void 0:s.blockId)||((l=e.protyle.block)==null?void 0:l.rootID)||((r=e.scrollAttr)==null?void 0:r.startId),startID:(c=e.scrollAttr)==null?void 0:c.startId,endID:(d=e.scrollAttr)==null?void 0:d.endId,query:(u=e.protyle.query)==null?void 0:u.key,queryMethod:(g=e.protyle.query)==null?void 0:g.method,queryTypes:(f=e.protyle.query)==null?void 0:f.types,highlight:!isSupportCSSHL()},m=>{onGet({data:m,protyle:e.protyle,action:p,scrollAttr:e.scrollAttr,afterCB:e.cb?()=>{e.cb(m.data.keywords)}:void 0,updateReadonly:e.updateReadonly})})};class yu{constructor(t,a,n){this.version=Constants.SIYUAN_VERSION;let o=n;t.plugins.forEach(l=>{l.protyleOptions&&(o=merge(o,l.protyleOptions))});const s=new Options(o).merge();if(this.protyle={getInstance:()=>this,app:t,transactionTime:new Date().getTime(),id:genUUID(),disabled:!1,updated:!1,element:a,options:s,block:{},highlight:{mark:isSupportCSSHL()?new Highlight:void 0,markHL:isSupportCSSHL()?new Highlight:void 0,ranges:[],rangeIndex:0,styleElement:document.createElement("style")}},isSupportCSSHL()){const l=genUUID();this.protyle.highlight.styleElement.dataset.uuid=l,this.protyle.highlight.styleElement.textContent=`.protyle-wysiwyg::highlight(search-mark-${l}) {background-color: var(--b3-highlight-background);color: var(--b3-highlight-color);}
  .protyle-wysiwyg::highlight(search-mark-hl-${l}) {color: var(--b3-highlight-color);background-color: var(--b3-highlight-current-background)}`}if(this.protyle.hint=new Hint(this.protyle),s.render.breadcrumb&&(this.protyle.breadcrumb=new Breadcrumb(this.protyle)),s.render.title&&(this.protyle.title=new Title(this.protyle)),s.render.background&&(this.protyle.background=new Background(this.protyle)),this.protyle.element.innerHTML="",this.protyle.element.classList.add("protyle"),s.render.breadcrumb&&this.protyle.element.appendChild(this.protyle.breadcrumb.element.parentElement),this.protyle.undo=new Undo,this.protyle.wysiwyg=new WYSIWYG(this.protyle),this.protyle.toolbar=new Toolbar(this.protyle),this.protyle.scroll=new Scroll(this.protyle),this.protyle.options.render.gutter&&(this.protyle.gutter=new Gutter(this.protyle)),(s.upload.url||s.upload.handler)&&(this.protyle.upload=new Upload),this.init(),s.action.includes(Constants.CB_GET_HISTORY))this.protyle.contentElement.classList.add("protyle-content--transition");else{if(this.protyle.ws=new Model({app:t,id:this.protyle.id,type:"protyle",msgCallback:l=>{var r;switch(l.cmd){case"reload":l.data===this.protyle.block.rootID&&(reloadProtyle(this.protyle,!1),getAllModels().outline.forEach(c=>{c.blockId===l.data&&fetchPost("/api/outline/getDocOutline",{id:c.blockId,preview:c.isPreview},d=>{c.update(d)})}));break;case"refreshAttributeView":Array.from(this.protyle.wysiwyg.element.querySelectorAll(`[data-av-id="${l.data.id}"]`)).forEach(c=>{c.removeAttribute("data-render"),avRender(c,this.protyle)});break;case"addLoading":l.data===this.protyle.block.rootID&&addLoading(this.protyle,l.msg);break;case"transactions":l.data[0].doOperations.find(c=>{if(!this.protyle.preview.element.classList.contains("fn__none")&&c.action!=="updateAttrs")this.protyle.preview.render(this.protyle);else{if(n.backlinkData&&["delete","move"].includes(c.action))return getAllModels().backlink.find(d=>{if(d.element.contains(this.protyle.element))return d.refresh(),!0}),!0;onTransaction(this.protyle,c,!1)}});break;case"readonly":window.siyuan.config.editor.readOnly=l.data,setReadonlyByConfig(this.protyle,!0);break;case"heading2doc":case"li2doc":this.protyle.block.rootID===l.data.srcRootBlockID&&(this.protyle.block.showAll&&l.cmd==="heading2doc"&&!this.protyle.options.backlinkData?fetchPost("/api/filetree/getDoc",{id:this.protyle.block.rootID,size:window.siyuan.config.editor.dynamicLoadBlocks},c=>{onGet({data:c,protyle:this.protyle})}):reloadProtyle(this.protyle,!1));break;case"rename":this.protyle.path===l.data.path&&(this.protyle.model&&this.protyle.model.parent.updateTitle(l.data.title),this.protyle.background&&(this.protyle.background.ial.title=l.data.title)),this.protyle.options.render.title&&this.protyle.block.parentID===l.data.id&&(!document.body.classList.contains("body--blur")&&getSelection().rangeCount>0&&((r=this.protyle.title.editElement)!=null&&r.contains(getSelection().getRangeAt(0).startContainer))||this.protyle.title.setTitle(l.data.title)),this.protyle.wysiwyg.element.querySelectorAll(`[data-type~="block-ref"][data-id="${l.data.id}"]`).forEach(c=>{c.getAttribute("data-subtype")==="d"&&(c.innerHTML=l.data.refText)});break;case"moveDoc":this.protyle.path===l.data.fromPath&&(this.protyle.path=l.data.newPath,this.protyle.notebookId=l.data.toNotebook);break;case"unmount":this.protyle.notebookId===l.data.box&&setEmpty(t);break;case"removeDoc":l.data.ids.includes(this.protyle.block.rootID)&&(setEmpty(t),delete window.siyuan.storage[Constants.LOCAL_FILEPOSITION][this.protyle.block.rootID],setStorageVal(Constants.LOCAL_FILEPOSITION,window.siyuan.storage[Constants.LOCAL_FILEPOSITION]));break}}}),n.backlinkData){this.protyle.block.rootID=n.blockId,renderBacklink(this.protyle,n.backlinkData),this.protyle.wysiwyg.element.style.paddingLeft="16px";return}if(!n.blockId){removeLoading(this.protyle);return}this.protyle.options.mode!=="preview"&&n.rootId&&window.siyuan.storage[Constants.LOCAL_FILEPOSITION][n.rootId]&&(s.action.includes(Constants.CB_GET_SCROLL)||s.action.includes(Constants.CB_GET_ROOTSCROLL)&&n.rootId===n.blockId)?getDocByScroll({protyle:this.protyle,scrollAttr:window.siyuan.storage[Constants.LOCAL_FILEPOSITION][n.rootId],mergedOptions:s,cb:()=>{this.afterOnGet(s)}}):this.getDoc(s)}}getDoc(t){var a;fetchPost("/api/filetree/getDoc",{id:t.blockId,isBacklink:t.action.includes(Constants.CB_GET_BACKLINK),originalRefBlockIDs:t.originalRefBlockIDs,mode:t.action&&t.action.includes(Constants.CB_GET_CONTEXT)?3:0,size:(a=t.action)!=null&&a.includes(Constants.CB_GET_ALL)?Constants.SIZE_GET_MAX:window.siyuan.config.editor.dynamicLoadBlocks},n=>{onGet({data:n,protyle:this.protyle,action:t.action,afterCB:()=>{this.afterOnGet(t)}})})}afterOnGet(t){this.protyle.model,resize(this.protyle),this.protyle.wysiwyg.element.addEventListener("focusin",()=>{}),t.after&&t.after(this),this.protyle.contentElement.classList.add("protyle-content--transition")}init(){this.protyle.lute=setLute({emojiSite:this.protyle.options.hint.emojiPath,emojis:this.protyle.options.hint.emoji,headingAnchor:!1,listStyle:this.protyle.options.preview.markdown.listStyle,paragraphBeginningSpace:this.protyle.options.preview.markdown.paragraphBeginningSpace,sanitize:this.protyle.options.preview.markdown.sanitize}),this.protyle.preview=new Preview(this.protyle),initUI(this.protyle)}focus(){this.protyle.wysiwyg.element.focus()}isUploading(){return this.protyle.upload.isUploading}clearStack(){this.protyle.undo.clear()}destroy(){destroy(this.protyle)}resize(){resize(this.protyle)}reload(t){reloadProtyle(this.protyle,t)}insert(t,a=!1,n=!1){insertHTML(t,this.protyle,a,n)}transaction(t,a){transaction(this.protyle,t,a)}turnIntoOneTransaction(t,a,n){turnsIntoOneTransaction({protyle:this.protyle,selectsElement:t,type:a,level:n})}turnIntoTransaction(t,a,n){turnsIntoTransaction({protyle:this.protyle,nodeElement:t,type:a,level:n})}updateTransaction(t,a,n){updateTransaction(this.protyle,t,a,n)}updateBatchTransaction(t,a){updateBatchTransaction(t,this.protyle,a)}getRange(t){return getEditorRange(t)}hasClosestBlock(t){return hasClosestBlock(t)}focusBlock(t,a=!0){return focusBlock(t,void 0,a)}disable(){disabledProtyle(this.protyle)}enable(){enableProtyle(this.protyle)}renderAVAttribute(t,a,n){renderAVAttribute(t,a,this.protyle,n)}}const qo=()=>window.siyuan.mobile.popEditor||window.siyuan.mobile.editor,hu=(e,t,a=[Constants.CB_GET_HL])=>{window.siyuan.storage[Constants.LOCAL_DOCINFO]={id:t},setStorageVal(Constants.LOCAL_DOCINFO,window.siyuan.storage[Constants.LOCAL_DOCINFO]);const n=document.querySelector(".av__panel");if(n&&!n.classList.contains("fn__none")&&n.dispatchEvent(new CustomEvent("click",{detail:"close"})),window.siyuan.mobile.editor){saveScroll(window.siyuan.mobile.editor.protyle),hideElements(["toolbar","hint","util"],window.siyuan.mobile.editor.protyle),window.siyuan.mobile.editor.protyle.contentElement.classList.contains("fn__none")&&setEditMode(window.siyuan.mobile.editor.protyle,"wysiwyg");let o;if(Array.from(window.siyuan.mobile.editor.protyle.wysiwyg.element.querySelectorAll(`[data-node-id="${t}"]`)).find(i=>{if(!isInEmbedBlock(i))return o=i,!0}),o){pushBack(),scrollCenter(window.siyuan.mobile.editor.protyle,o,!0),closePanel();return}}fetchPost("/api/block/getBlockInfo",{id:t},o=>{if(o.code===3){showMessage(o.msg);return}const i={blockId:t,rootId:o.data.rootID,action:a,render:{scroll:!0,title:!0,background:!0,gutter:!0},typewriterMode:!0,preview:{actions:["mp-wechat","zhihu","yuque"]}};window.siyuan.mobile.editor?(window.siyuan.mobile.editor.protyle.title.element.removeAttribute("data-render"),pushBack(),addLoading(window.siyuan.mobile.editor.protyle),window.siyuan.mobile.editor.protyle.block.rootID!==o.data.rootID&&(window.siyuan.mobile.editor.protyle.wysiwyg.element.innerHTML=""),a.includes(Constants.CB_GET_SCROLL)&&window.siyuan.storage[Constants.LOCAL_FILEPOSITION][o.data.rootID]?getDocByScroll({protyle:window.siyuan.mobile.editor.protyle,scrollAttr:window.siyuan.storage[Constants.LOCAL_FILEPOSITION][o.data.rootID],mergedOptions:i,cb(){e.plugins.forEach(s=>{s.eventBus.emit("switch-protyle",{protyle:window.siyuan.mobile.editor.protyle})})}}):fetchPost("/api/filetree/getDoc",{id:t,size:a.includes(Constants.CB_GET_ALL)?Constants.SIZE_GET_MAX:window.siyuan.config.editor.dynamicLoadBlocks,mode:a.includes(Constants.CB_GET_CONTEXT)?3:0},s=>{onGet({data:s,protyle:window.siyuan.mobile.editor.protyle,action:a,afterCB(){e.plugins.forEach(l=>{l.eventBus.emit("switch-protyle",{protyle:window.siyuan.mobile.editor.protyle})})}})}),window.siyuan.mobile.editor.protyle.undo.clear()):window.siyuan.mobile.editor=new Protyle(e,document.getElementById("editor"),i),setEditor(),closePanel()})};let vs,Ut=!1;const te=(e,t,a,n="false")=>{let o;return t&&t.startsWith("icon")?o=`<svg class="keyboard__slash-icon"><use xlink:href="#${t}"></use></svg>`:o=t,`<button class="keyboard__slash-item" data-focus="${n}" data-value="${encodeURIComponent(e)}">
    ${o}
    <span class="keyboard__slash-text">${a}</span>
</button>`},Uo=(e,t)=>{let a="";["","var(--b3-font-color1)","var(--b3-font-color2)","var(--b3-font-color3)","var(--b3-font-color4)","var(--b3-font-color5)","var(--b3-font-color6)","var(--b3-font-color7)","var(--b3-font-color8)","var(--b3-font-color9)","var(--b3-font-color10)","var(--b3-font-color11)","var(--b3-font-color12)","var(--b3-font-color13)"].forEach((u,g)=>{a+=`<button class="keyboard__slash-item" data-type="color">
    <span class="keyboard__slash-icon" ${u?`style="color:${u}"`:""}>A</span>
    <span class="keyboard__slash-text">${window.siyuan.languages.colorFont} ${u?g+1:window.siyuan.languages.default}</span>
</button>`});let n="";["","var(--b3-font-background1)","var(--b3-font-background2)","var(--b3-font-background3)","var(--b3-font-background4)","var(--b3-font-background5)","var(--b3-font-background6)","var(--b3-font-background7)","var(--b3-font-background8)","var(--b3-font-background9)","var(--b3-font-background10)","var(--b3-font-background11)","var(--b3-font-background12)","var(--b3-font-background13)"].forEach((u,g)=>{n+=`<button class="keyboard__slash-item" data-type="backgroundColor">
    <span class="keyboard__slash-icon" ${u?`style="background-color:${u}"`:""}>A</span>
    <span class="keyboard__slash-text">${window.siyuan.languages.colorPrimary} ${u?g+1:window.siyuan.languages.default}</span>
</button>`});const o=getFontNodeElements(e);let i=!1;o==null||o.find(u=>{if(u.classList.contains("list")||u.classList.contains("li"))return i=!0,!0});let s="";const l=window.siyuan.storage[Constants.LOCAL_FONTSTYLES];l.length>0&&(s=`<div class="keyboard__slash-title">
    ${window.siyuan.languages.lastUsed}
</div>
<div class="keyboard__slash-block">`,l.forEach(u=>{const g=u.split(Constants.ZWSP);switch(g[0]){case"color":s+=`<button class="keyboard__slash-item" data-type="${g[0]}">
    <span class="keyboard__slash-icon" ${g[1]?`style="color:${g[1]}"`:""} >A</span>
    <span class="keyboard__slash-text">${window.siyuan.languages.colorFont} ${g[1]?parseInt(g[1].replace("var(--b3-font-color",""))+1:window.siyuan.languages.default}</span>
</button>`;break;case"backgroundColor":s+=`<button class="keyboard__slash-item" data-type="${g[0]}">
    <span class="keyboard__slash-icon" ${g[1]?`style="background-color:${g[1]}"`:""}>A</span>
    <span class="keyboard__slash-text">${window.siyuan.languages.colorPrimary} ${g[1]?parseInt(g[1].replace("var(--b3-font-background",""))+1:window.siyuan.languages.default}</span>
</button>`;break;case"style2":s+=`<button class="keyboard__slash-item" data-type="${g[0]}">
    <span class="keyboard__slash-text" style="-webkit-text-stroke: 0.2px var(--b3-theme-on-background);-webkit-text-fill-color : transparent;">${window.siyuan.languages.hollow}</span>
</button>`;break;case"style4":s+=`<button class="keyboard__slash-item" data-type="${g[0]}">
    <span class="keyboard__slash-text" style="text-shadow: 1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)">${window.siyuan.languages.shadow}</span>
</button>`;break;case"fontSize":i||(s+=`<button class="keyboard__slash-item" data-type="${g[0]}">
    <span class="keyboard__slash-text">${g[1]}</span>
</button>`);break;case"style1":g[1]?s+=`<button class="keyboard__slash-item" data-type="${g[0]}">
    <span class="keyboard__slash-icon" style="background-color:${g[1]};color:${g[2]}">A</span>
    <span class="keyboard__slash-text">${window.siyuan.languages[g[2].replace("var(--b3-card-","").replace("-color)","")+"Style"]}</span>
</button>`:s+=`<button class="keyboard__slash-item" data-type="${g[0]}">
    <span class="keyboard__slash-icon">A</span>
    <span class="keyboard__slash-text">${window.siyuan.languages.color} ${window.siyuan.languages.default}</span>
</button>`;break;case"clear":s+=`<button class="keyboard__slash-item" data-type="${g[0]}">
    <span class="keyboard__slash-text">${window.siyuan.languages.clearFontStyle}</span>
</button>`;break}}),s+="</div>");let r,c="16px";o&&o.length>0?r=o[0]:(r=e.toolbar.range.cloneContents().querySelector('[data-type~="text"]'),r||(r=hasClosestByAttribute(e.toolbar.range.startContainer,"data-type","text"))),r&&(c=r.style.fontSize||"16px");const d=t.querySelector(".keyboard__util");d.innerHTML=`${s}
<div class="keyboard__slash-title">${window.siyuan.languages.color}</div>
<div class="keyboard__slash-block">
    <button class="keyboard__slash-item" data-type="style1">
        <span class="keyboard__slash-icon">A</span>
        <span class="keyboard__slash-text">${window.siyuan.languages.color} ${window.siyuan.languages.default}</span>
    </button>
    <button class="keyboard__slash-item" data-type="style1">
        <span class="keyboard__slash-icon" style="color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);">A</span>
        <span class="keyboard__slash-text">${window.siyuan.languages.errorStyle}</span>
    </button>
    <button class="keyboard__slash-item" data-type="style1">
        <span class="keyboard__slash-icon" style="color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);">A</span>
        <span class="keyboard__slash-text">${window.siyuan.languages.warningStyle}</span>
    </button>
    <button class="keyboard__slash-item" data-type="style1">
        <span class="keyboard__slash-icon" style="color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);">A</span>
        <span class="keyboard__slash-text">${window.siyuan.languages.infoStyle}</span>
    </button>
    <button class="keyboard__slash-item" data-type="style1">
        <span class="keyboard__slash-icon" style="color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);">A</span>
        <span class="keyboard__slash-text">${window.siyuan.languages.successStyle}</span>
    </button>
</div>
<div class="keyboard__slash-title">${window.siyuan.languages.colorFont}</div>
<div class="keyboard__slash-block">
    ${a}
</div>
<div class="keyboard__slash-title">${window.siyuan.languages.colorPrimary}</div>
<div class="keyboard__slash-block">
    ${n}
</div>
<div class="keyboard__slash-title">${window.siyuan.languages.fontStyle}</div>
<div class="keyboard__slash-block">
    <button class="keyboard__slash-item" data-type="style2">
        <span class="keyboard__slash-text" style="-webkit-text-stroke: 0.2px var(--b3-theme-on-background);-webkit-text-fill-color : transparent;">${window.siyuan.languages.hollow}</span>
    </button>
    <button class="keyboard__slash-item" data-type="style4">
        <span class="keyboard__slash-text" style="text-shadow: 1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)">${window.siyuan.languages.shadow}</span>
    </button>
    <button class="keyboard__slash-item" data-type="clear">
        <svg class="keyboard__slash-icon"><use xlink:href="#iconTrashcan"></use></svg>
        <span class="keyboard__slash-text">${window.siyuan.languages.clearFontStyle}</span>
    </button>
</div>
<div class="keyboard__slash-title${i?" fn__none":""}">${window.siyuan.languages.fontSize}</div>
<div class="keyboard__slash-block${i?" fn__none":""}">
    <select class="b3-select fn__block" style="width: calc(50% - 8px);margin: 4px 0 8px 0;">
        <option ${c==="12px"?"selected":""} value="12px">12px</option>
        <option ${c==="13px"?"selected":""} value="13px">13px</option>
        <option ${c==="14px"?"selected":""} value="14px">14px</option>
        <option ${c==="15px"?"selected":""} value="15px">15px</option>
        <option ${c==="16px"?"selected":""} value="16px">16px</option>
        <option ${c==="19px"?"selected":""} value="19px">19px</option>
        <option ${c==="22px"?"selected":""} value="22px">22px</option>
        <option ${c==="24px"?"selected":""} value="24px">24px</option>
        <option ${c==="29px"?"selected":""} value="29px">29px</option>
        <option ${c==="32px"?"selected":""} value="32px">32px</option>
        <option ${c==="40px"?"selected":""} value="40px">40px</option>
        <option ${c==="48px"?"selected":""} value="48px">48px</option>
    </select>
</div>`,d.querySelector("select").addEventListener("change",function(u){fontEvent(e,o,"fontSize",u.target.value)})},Fo=(e,t)=>{e.hint.splitChar="/",e.hint.lastIndex=-1;let a="";e.app.plugins.forEach(o=>{o.protyleSlash.forEach(i=>{a+=te(`plugin${Constants.ZWSP}${o.name}${Constants.ZWSP}${i.id}`,"",i.html,"true")})}),a&&(a=`<div class="keyboard__slash-title"></div><div class="keyboard__slash-block">${a}</div>`);const n=t.querySelector(".keyboard__util");n.innerHTML=`<div class="keyboard__slash-title"></div>
<div class="keyboard__slash-block">
    ${te(Constants.ZWSP,"iconMarkdown",window.siyuan.languages.template)}
    ${te(Constants.ZWSP+1,"iconBoth",window.siyuan.languages.widget)}
    ${te(Constants.ZWSP+2,"iconImage",window.siyuan.languages.assets)}
    ${te("((","iconRef",window.siyuan.languages.ref,"true")}
    ${te("{{","iconSQL",window.siyuan.languages.blockEmbed,"true")}
    ${te(Constants.ZWSP+5,"iconSparkles",window.siyuan.languages.aiWriting)}
    ${te('<div data-type="NodeAttributeView" data-av-type="table"></div>',"iconDatabase",window.siyuan.languages.database,"true")}
    ${te(Constants.ZWSP+4,"iconFile",window.siyuan.languages.newSubDocRef)}
</div>
<div class="keyboard__slash-title"></div>
<div class="keyboard__slash-block">
    ${te(Constants.ZWSP+3,"iconDownload",window.siyuan.languages.insertAsset+'<input class="b3-form__upload" type="file"'+(e.options.upload.accept?' multiple="'+e.options.upload.accept+'"':"")+"/>","true")}
    ${isInAndroid()?te(Constants.ZWSP+3,"iconCamera",window.siyuan.languages.insertPhoto+'<input class="b3-form__upload" capture="user" type="file"'+(e.options.upload.accept?' multiple="'+e.options.upload.accept+'"':"")+"/>","true"):""}
    ${te('<iframe sandbox="allow-forms allow-presentation allow-same-origin allow-scripts allow-modals allow-popups" src="" border="0" frameborder="no" framespacing="0" allowfullscreen="true"></iframe>',"iconLanguage",window.siyuan.languages.insertIframeURL,"true")}
    ${te("![]()","iconImage",window.siyuan.languages.insertImgURL,"true")}
    ${te('<video controls="controls" src=""></video>',"iconVideo",window.siyuan.languages.insertVideoURL,"true")}
    ${te('<audio controls="controls" src=""></audio>',"iconRecord",window.siyuan.languages.insertAudioURL,"true")}
    ${te("emoji","iconEmoji",window.siyuan.languages.emoji,"true")}
</div>
<div class="keyboard__slash-title"></div>
<div class="keyboard__slash-block">
    ${te("# "+Lute.Caret,"iconH1",window.siyuan.languages.heading1,"true")}
    ${te("## "+Lute.Caret,"iconH2",window.siyuan.languages.heading2,"true")}
    ${te("### "+Lute.Caret,"iconH3",window.siyuan.languages.heading3,"true")}
    ${te("#### "+Lute.Caret,"iconH4",window.siyuan.languages.heading4,"true")}
    ${te("##### "+Lute.Caret,"iconH5",window.siyuan.languages.heading5,"true")}
    ${te("###### "+Lute.Caret,"iconH6",window.siyuan.languages.heading6,"true")}
    ${te("* "+Lute.Caret,"iconList",window.siyuan.languages.list,"true")}
    ${te("1. "+Lute.Caret,"iconOrderedList",window.siyuan.languages["ordered-list"],"true")}
    ${te("* [ ] "+Lute.Caret,"iconCheck",window.siyuan.languages.check,"true")}
    ${te("> "+Lute.Caret,"iconQuote",window.siyuan.languages.quote,"true")}
    ${te("```","iconCode",window.siyuan.languages.code,"true")}
    ${te(`| ${Lute.Caret} |  |  |
| --- | --- | --- |
|  |  |  |
|  |  |  |`,"iconTable",window.siyuan.languages.table,"true")}
    ${te("---","iconLine",window.siyuan.languages.line,"true")}
    ${te("$$","iconMath",window.siyuan.languages.math)}
    ${te("<div>","iconHTML5","HTML")}
</div>
<div class="keyboard__slash-title"></div>
<div class="keyboard__slash-block">
    ${te("```abc\n```","",window.siyuan.languages.staff,"true")}
    ${te("```echarts\n```","",window.siyuan.languages.chart,"true")}
    ${te("```flowchart\n```","","Flow Chart","true")}
    ${te("```graphviz\n```","","Graph","true")}
    ${te("```mermaid\n```","","Mermaid","true")}
    ${te("```mindmap\n```","",window.siyuan.languages.mindmap,"true")}
    ${te("```plantuml\n```","","UML","true")}
</div>
<div class="keyboard__slash-title"></div>
<div class="keyboard__slash-block">
    ${te(`style${Constants.ZWSP}color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);`,'<div style="color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);" class="keyboard__slash-icon">A</div>',window.siyuan.languages.infoStyle,"true")}
    ${te(`style${Constants.ZWSP}color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);`,'<div style="color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);" class="keyboard__slash-icon">A</div>',window.siyuan.languages.successStyle,"true")}
    ${te(`style${Constants.ZWSP}color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);`,'<div style="color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);" class="keyboard__slash-icon">A</div>',window.siyuan.languages.warningStyle,"true")}
    ${te(`style${Constants.ZWSP}color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);`,'<div style="color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);" class="keyboard__slash-icon">A</div>',window.siyuan.languages.errorStyle,"true")}
    ${te(`style${Constants.ZWSP}`,'<div class="keyboard__slash-icon">A</div>',window.siyuan.languages.clearFontStyle,"true")}
</div>${a}`,e.hint.bindUploadEvent(e,n)},Es=e=>{window.siyuan.menus.menu.remove(),Ut=!0;const t=document.getElementById("keyboardToolbar");let a=t.getAttribute("data-keyboardheight");a=(a?parseInt(a)+42:window.outerHeight/2)+"px";const n=getCurrentEditor();n&&(n.protyle.element.parentElement.style.paddingBottom=a,n.protyle.contentElement.scrollTop=e),setTimeout(()=>{t.style.height=a},Constants.TIMEOUT_TRANSITION),setTimeout(()=>{Ut=!1},1e3)},Ft=()=>{const e=document.getElementById("keyboardToolbar");e.style.height="";const t=getCurrentEditor();t&&(t.protyle.element.parentElement.style.paddingBottom="42px"),e.querySelector('.keyboard__action[data-type="add"]').classList.remove("protyle-toolbar__item--current"),e.querySelector('.keyboard__action[data-type="text"]').classList.remove("protyle-toolbar__item--current"),e.querySelector('.keyboard__action[data-type="done"] use').setAttribute("xlink:href","#iconKeyboardHide")},Yo=()=>{clearTimeout(vs),vs=window.setTimeout(()=>{if(getSelection().rangeCount===0||window.siyuan.config.readonly||document.getElementById("toolbarName").getAttribute("readonly")==="readonly"||window.screen.height-window.innerHeight<160||!document.activeElement||document.activeElement&&!["INPUT","TEXTAREA"].includes(document.activeElement.tagName)&&!document.activeElement.classList.contains("protyle-wysiwyg")&&document.activeElement.getAttribute("contenteditable")!=="true"){ba();return}if(document.activeElement&&!["INPUT","TEXTAREA"].includes(document.activeElement.tagName)&&(document.getElementById("menu").style.transform==="translateX(0px)"||document.getElementById("model").style.transform==="translateY(0px)")){ba();return}Ut||Ft(),Wo();const e=document.querySelectorAll("#keyboardToolbar .keyboard__dynamic"),t=getSelection().getRangeAt(0);if(!hasClosestByClassName(t.startContainer,"protyle-wysiwyg",!0)){e[0].classList.add("fn__none"),e[1].classList.add("fn__none");return}t.toString()||e[0].querySelector('[data-type="goinline"]').classList.contains("protyle-toolbar__item--current")?(e[0].classList.add("fn__none"),e[1].classList.remove("fn__none")):(e[0].classList.remove("fn__none"),e[1].classList.add("fn__none"));const o=getCurrentEditor().protyle;if(!e[0].classList.contains("fn__none")){o.undo.undoStack.length===0?e[0].querySelector('[data-type="undo"]').setAttribute("disabled","disabled"):e[0].querySelector('[data-type="undo"]').removeAttribute("disabled"),o.undo.redoStack.length===0?e[0].querySelector('[data-type="redo"]').setAttribute("disabled","disabled"):e[0].querySelector('[data-type="redo"]').removeAttribute("disabled");const i=hasClosestBlock(t.startContainer);if(i){const s=e[0].querySelector('[data-type="outdent"]');i.parentElement.classList.contains("li")?(s.classList.remove("fn__none"),s.nextElementSibling.classList.remove("fn__none")):(s.classList.add("fn__none"),s.nextElementSibling.classList.add("fn__none"))}}e[1].classList.contains("fn__none")||(e[1].querySelectorAll(".protyle-toolbar__item--current").forEach(s=>{s.classList.remove("protyle-toolbar__item--current")}),o.toolbar.getCurrentType(t).forEach(s=>{if(["search-mark","a","block-ref","virtual-block-ref","text","file-annotation-ref","inline-math","inline-memo","","backslash"].includes(s))return;const l=e[1].querySelector(`[data-type="${s}"]`);l&&l.classList.add("protyle-toolbar__item--current")}))},620)},Wo=()=>{Ut||Ft();const e=document.getElementById("keyboardToolbar");if(!e.classList.contains("fn__none"))return;e.classList.remove("fn__none"),e.style.zIndex=(++window.siyuan.zIndex).toString();const t=document.getElementById("model");t.style.transform==="translateY(0px)"&&(t.style.paddingBottom="42px");const a=getSelection().getRangeAt(0),n=getCurrentEditor();n&&n.protyle.wysiwyg.element.contains(a.startContainer)&&(n.protyle.element.parentElement.style.paddingBottom="42px"),getCurrentEditor().protyle.app.plugins.forEach(o=>{o.eventBus.emit("mobile-keyboard-show")}),setTimeout(()=>{const o=hasClosestByClassName(a.startContainer,"protyle-content",!0);if(o){const i=o.getBoundingClientRect().top,s=getSelectionPosition(o).top;if(s<window.innerHeight-42&&s>i)return;o.scroll({top:o.scrollTop+s-window.innerHeight+42+26,left:o.scrollLeft,behavior:"smooth"})}},Constants.TIMEOUT_TRANSITION)},ba=()=>{if(Ut)return;const e=document.getElementById("keyboardToolbar");if(e.classList.contains("fn__none"))return;e.classList.add("fn__none"),e.style.height="";const t=getCurrentEditor();t&&(t.protyle.element.parentElement.style.paddingBottom="");const a=document.getElementById("model");a.style.transform==="translateY(0px)"&&(a.style.paddingBottom=""),getCurrentEditor().protyle.app.plugins.forEach(n=>{n.eventBus.emit("mobile-keyboard-hide")})},ks=()=>{document.activeElement.blur()},wu=()=>{let e=!1;document.addEventListener("selectionchange",()=>{e||Yo()},!1);const t=document.getElementById("keyboardToolbar");t.innerHTML=`<div class="fn__flex keyboard__bar">
    <div class="fn__flex-1">
        <div class="fn__none keyboard__dynamic">
            <button class="keyboard__action" data-type="outdent"><svg><use xlink:href="#iconOutdent"></use></svg></button>
            <button class="keyboard__action" data-type="indent"><svg><use xlink:href="#iconIndent"></use></svg></button>
            <button class="keyboard__action" data-type="add"><svg><use xlink:href="#iconAdd"></use></svg></button>
            <button class="keyboard__action" data-type="block"><svg><use xlink:href="#iconParagraph"></use></svg></button>
            <button class="keyboard__action" data-type="goinline"><svg class="keyboard__svg--big"><use xlink:href="#iconBIU"></use></svg></button>
            <button class="keyboard__action" data-type="softLine"><svg><use xlink:href="#iconSoftWrap"></use></svg></button>
            <span class="keyboard__split"></span>
            <button class="keyboard__action" data-type="undo"><svg><use xlink:href="#iconUndo"></use></svg></button>
            <button class="keyboard__action" data-type="redo"><svg><use xlink:href="#iconRedo"></use></svg></button>
            <span class="keyboard__split"></span>
            <button class="keyboard__action" data-type="moveup"><svg><use xlink:href="#iconUp"></use></svg></button>
            <button class="keyboard__action" data-type="movedown"><svg><use xlink:href="#iconDown"></use></svg></button>
        </div>
        <div class="fn__none keyboard__dynamic">
            <button class="keyboard__action" data-type="goback"><svg><use xlink:href="#iconBack"></use></svg></button>
            <button class="keyboard__action" data-type="block-ref"><svg><use xlink:href="#iconRef"></use></svg></button>
            <button class="keyboard__action" data-type="a"><svg><use xlink:href="#iconLink"></use></svg></button>
            <button class="keyboard__action" data-type="text"><svg><use xlink:href="#iconFont"></use></svg></button>
            <button class="keyboard__action" data-type="strong"><svg><use xlink:href="#iconBold"></use></svg></button>
            <button class="keyboard__action" data-type="em"><svg><use xlink:href="#iconItalic"></use></svg></button>
            <button class="keyboard__action" data-type="u"><svg><use xlink:href="#iconUnderline"></use></svg></button>
            <button class="keyboard__action" data-type="s"><svg><use xlink:href="#iconStrike"></use></svg></button>
            <button class="keyboard__action" data-type="mark"><svg><use xlink:href="#iconMark"></use></svg></button>
            <button class="keyboard__action" data-type="sup"><svg><use xlink:href="#iconSup"></use></svg></button>
            <button class="keyboard__action" data-type="sub"><svg><use xlink:href="#iconSub"></use></svg></button>
            <button class="keyboard__action" data-type="clear"><svg><use xlink:href="#iconClear"></use></svg></button>
            <button class="keyboard__action" data-type="code"><svg><use xlink:href="#iconInlineCode"></use></svg></button>
            <button class="keyboard__action" data-type="kbd"<use xlink:href="#iconKeymap"></use></svg></button>
            <button class="keyboard__action" data-type="tag"><svg><use xlink:href="#iconTags"></use></svg></button>
            <button class="keyboard__action" data-type="inline-math"><svg><use xlink:href="#iconMath"></use></svg></button>
            <button class="keyboard__action" data-type="inline-memo"><svg><use xlink:href="#iconM"></use></svg></button>
            <button class="keyboard__action" data-type="goback"><svg><use xlink:href="#iconCloseRound"></use></svg></button>
        </div>
    </div>
    <span class="keyboard__split"></span>
    <button class="keyboard__action" data-type="done"><svg style="width: 36px"><use xlink:href="#iconKeyboardHide"></use></svg></button>
</div>
<div class="keyboard__util"></div>`,t.addEventListener("click",a=>{var n;const o=(n=getCurrentEditor())==null?void 0:n.protyle,i=a.target,s=hasClosestByClassName(a.target,"keyboard__slash-item");if(s&&!s.getAttribute("data-type")){const u=decodeURIComponent(s.getAttribute("data-value"));o.hint.fill(u,o,!1),u!==Constants.ZWSP+3&&(a.preventDefault(),a.stopPropagation()),s.getAttribute("data-focus")==="true"&&focusByRange(o.toolbar.range);return}const l=hasClosestByTag(i,"BUTTON");if(!l||l.getAttribute("disabled"))return;const r=l.getAttribute("data-type");if(["clear","style2","style4","color","backgroundColor","fontSize","style1"].includes(r)){const u=getFontNodeElements(o),g=l.firstElementChild;r==="style1"?fontEvent(o,u,r,g.style.backgroundColor+Constants.ZWSP+g.style.color):r==="fontSize"?fontEvent(o,u,r,g.textContent.trim()):r==="backgroundColor"?fontEvent(o,u,r,g.style.backgroundColor):r==="color"?fontEvent(o,u,r,g.style.color):fontEvent(o,u,r)}if(a.preventDefault(),a.stopPropagation(),getSelection().rangeCount===0)return;const c=getSelection().getRangeAt(0);if(r==="done"){t.clientHeight>100?(Ft(),focusByRange(c)):(ks(),ba());return}if(window.siyuan.config.readonly||!o||o.disabled)return;if(r==="undo"){o.undo.undo(o);return}else if(r==="redo"){o.undo.redo(o);return}if(getSelection().rangeCount===0)return;const d=hasClosestBlock(c.startContainer);if(d){if(r==="goback"){t.querySelector('.keyboard__action[data-type="goinline"]').classList.remove("protyle-toolbar__item--current");const u=document.querySelectorAll("#keyboardToolbar .keyboard__dynamic");u[0].classList.remove("fn__none"),u[1].classList.add("fn__none"),focusByRange(c),e=!0,setTimeout(()=>{e=!1},1e3);return}else if(r==="goinline"){l.classList.add("protyle-toolbar__item--current");const u=document.querySelectorAll("#keyboardToolbar .keyboard__dynamic");u[1].classList.remove("fn__none"),u[0].classList.add("fn__none"),focusByRange(c);return}else if(["a","block-ref","inline-math","inline-memo"].includes(r)){hasClosestByAttribute(c.startContainer,"data-type","NodeCodeBlock")||(hideElements(["util"],o),o.toolbar.element.querySelector(`[data-type="${r}"]`).dispatchEvent(new CustomEvent("click")));return}else if(l.classList.contains("keyboard__action")&&["strong","em","s","code","mark","tag","u","sup","clear","sub","kbd"].includes(r)){hasClosestByAttribute(c.startContainer,"data-type","NodeCodeBlock")||o.toolbar.setInlineMark(o,r,"toolbar");return}else if(r==="text"){if(l.classList.contains("protyle-toolbar__item--current"))Ft(),focusByRange(c);else{l.classList.add("protyle-toolbar__item--current"),t.querySelector('.keyboard__action[data-type="done"] use').setAttribute("xlink:href","#iconCloseRound");const u=o.contentElement.scrollTop;Uo(o,t),Es(u)}return}else if(r==="moveup"){moveToUp(o,d,c),focusByRange(c);return}else if(r==="movedown"){moveToDown(o,d,c),focusByRange(c);return}else if(r==="softLine"){c.extractContents(),softEnter(c,d,o),focusByRange(c);return}else if(r==="add"){if(l.classList.contains("protyle-toolbar__item--current"))Ft(),focusByRange(c);else{l.classList.add("protyle-toolbar__item--current"),t.querySelector('.keyboard__action[data-type="done"] use').setAttribute("xlink:href","#iconCloseRound");const u=o.contentElement.scrollTop;Fo(o,t),Es(u)}return}else if(r==="block"){o.gutter.renderMenu(o,d),window.siyuan.menus.menu.fullscreen(),ks(),ba();return}else if(r==="outdent"){listOutdent(o,[d.parentElement],c),focusByRange(c);return}else if(r==="indent"){listIndent(o,[d.parentElement],c),focusByRange(c);return}}})},_u=()=>{document.getElementById("menu").style.transform="",document.getElementById("sidebar").style.transform="",document.getElementById("model").style.transform="";const e=document.querySelector(".side-mask");e.classList.add("fn__none"),e.style.opacity="",window.siyuan.menus.menu.remove()},vu=()=>{document.getElementById("model").style.transform="",activeBlur(),hideKeyboardToolbar()},cn=null,jo=e=>{const t=getCurrentEditor().protyle;if(t.observerLoad.disconnect(),window.siyuan.storage[Constants.LOCAL_DOCINFO]={id:e.id},setStorageVal(Constants.LOCAL_DOCINFO,window.siyuan.storage[Constants.LOCAL_DOCINFO]),hideElements(["toolbar","hint","util"],t),t.contentElement.classList.contains("fn__none")&&setEditMode(t,"wysiwyg"),t.notebookId=e.data.notebookId,t.path=e.data.path,e.data.startId===t.wysiwyg.element.firstElementChild.getAttribute("data-node-id")&&e.data.endId===t.wysiwyg.element.lastElementChild.getAttribute("data-node-id")){t.contentElement.scrollTo({top:e.scrollTop,behavior:"smooth"});return}if(e.id!==t.block.rootID&&fetchPost("/api/block/getDocInfo",{id:e.id},a=>{setTitle(a.data.name),t.title.setTitle(a.data.name),t.background.render(a.data.ial,t.block.rootID),t.wysiwyg.renderCustom(a.data.ial)}),e.zoomId){e.zoomId!==t.block.id?fetchPost("/api/block/checkBlockExist",{id:e.id},a=>{a.data&&zoomOut({protyle:t,id:e.id,isPushBack:!1,callback:()=>{t.contentElement.scrollTop=e.scrollTop}})}):t.contentElement.scrollTop=e.scrollTop;return}fetchPost("/api/filetree/getDoc",{id:e.id,startID:e.data.startId,endID:e.data.endId},a=>{t.block.parentID=a.data.parentID,t.block.parent2ID=a.data.parent2ID,t.block.rootID=a.data.rootID,t.block.showAll=!1,t.block.mode=a.data.mode,t.block.blockCount=a.data.blockCount,t.block.id=a.data.id,t.block.action=e.callback,t.wysiwyg.element.setAttribute("data-doc-type",a.data.type),t.wysiwyg.element.innerHTML=a.data.content,processRender(t.wysiwyg.element),highlightRender(t.wysiwyg.element),avRender(t.wysiwyg.element,t),blockRender(t,t.wysiwyg.element,e.scrollTop),a.data.isSyncing?disabledForeverProtyle(t):setReadonlyByConfig(t,!0),t.contentElement.scrollTop=e.scrollTop,setTimeout(()=>{t.contentElement.scrollTop=e.scrollTop},Constants.TIMEOUT_LOAD)})},Vo=()=>{const e=qo().protyle;e.wysiwyg.element.firstElementChild&&window.siyuan.backStack.push({id:e.block.showAll?e.block.id:e.block.rootID,data:{startId:e.wysiwyg.element.firstElementChild.getAttribute("data-node-id"),endId:e.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),notebookId:e.notebookId,path:e.path},scrollTop:e.contentElement.scrollTop,callback:e.block.action,zoomId:e.block.showAll?e.block.id:void 0})},Eu=()=>{const e=getCurrentEditor();if(window.siyuan.menus.menu.element.classList.contains("b3-menu--fullscreen")&&!window.siyuan.menus.menu.element.classList.contains("fn__none")){window.siyuan.menus.menu.element.dispatchEvent(new CustomEvent("click",{detail:"back"}));return}else if(document.getElementById("model").style.transform==="translateY(0px)"){const a=document.getElementById("searchAssetsPanel");!a||a.classList.contains("fn__none")?document.getElementById("model").style.transform="":a.classList.add("fn__none");return}else if(window.siyuan.viewer&&!window.siyuan.viewer.destroyed){window.siyuan.viewer.destroy();return}else if(document.getElementById("menu").style.transform==="translateX(0px)"||document.getElementById("sidebar").style.transform==="translateX(0px)"){closePanel();return}else if(e&&!e.protyle.toolbar.subElement.classList.contains("fn__none")){hideElements(["util"],e.protyle),closePanel();return}else if(window.siyuan.dialogs.length!==0){hideElements(["dialog"]),closePanel();return}if((window.JSAndroid||window.JSHarmony)&&window.siyuan.backStack.length<1){document.querySelector('#message [data-id="exitTip"]')?window.JSAndroid?window.JSAndroid.returnDesktop():window.JSHarmony&&window.JSHarmony.returnDesktop():showMessage(window.siyuan.languages.returnDesktop,3e3,"info","exitTip");return}if(window.siyuan.backStack.length<1)return;if(cn.length===0&&e){const a=e.protyle;cn.push({id:a.block.showAll?a.block.id:a.block.rootID,data:{startId:a.wysiwyg.element.firstElementChild.getAttribute("data-node-id"),endId:a.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),notebookId:a.notebookId,path:a.path},scrollTop:a.contentElement.scrollTop,callback:a.block.action,zoomId:a.block.showAll?a.block.id:void 0})}const t=window.siyuan.backStack.pop();cn.push(t),jo(t)};var Go=(e,t,a)=>new Promise((n,o)=>{var i=r=>{try{l(a.next(r))}catch(c){o(c)}},s=r=>{try{l(a.throw(r))}catch(c){o(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(i,s);l((a=a.apply(e,t)).next())});const dn=(e,t,a,n=[])=>{fetchPost("/api/search/searchAsset",{k:t,exts:n},o=>{let i="";o.data.forEach((c,d)=>{i+=`<div data-value="${c.path}" class="b3-list-item${d===0?" b3-list-item--focus":""}"><div class="b3-list-item__text">${c.hName}</div></div>`});const s=e.querySelector(".b3-list"),l=e.querySelector("#preview"),r=e.querySelector("input");s.innerHTML=i||`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`,o.data.length>0?l.innerHTML=renderAssetsPreview(o.data[0].path):l.innerHTML=window.siyuan.languages.emptyContent,window.siyuan.menus.menu.fullscreen(),t||r.select()})},ku=(e,t,a,n)=>{const o=new Menu("background-asset");o.isOpen||o.addItem({iconHTML:"",type:"readonly",label:`<div class="fn__flex" style="max-height: 50vh">
<div class="fn__flex-column" style="${isMobile()?"width:100%":"min-width: 260px;max-width:420px"}">
    <div class="fn__flex" style="margin: 0 8px 4px 8px">
        <input class="b3-text-field fn__flex-1"/>
        <span class="fn__space"></span>
        <span data-type="previous" class="block__icon block__icon--show"><svg><use xlink:href="#iconLeft"></use></svg></span>
        <span class="fn__space"></span>
        <span data-type="next" class="block__icon block__icon--show"><svg><use xlink:href="#iconRight"></use></svg></span>
    </div>
    <div class="b3-list fn__flex-1 b3-list--background" style="position: relative"><img style="margin: 0 auto;display: block;width: 64px;height: 64px" src="/stage/loading-pure.svg"></div>
</div>
<div id="preview" style="width: 360px;display: ${isMobile()||window.outerWidth<window.outerWidth/2+260?"none":"flex"};padding: 8px;overflow: auto;justify-content: center;align-items: center;word-break: break-all;"></div>
</div>`,bind(i){i.style.maxWidth="none";const s=i.querySelector(".b3-list"),l=i.querySelector("#preview");s.addEventListener("mouseover",c=>{const d=c.target,u=hasClosestByClassName(d,"b3-list-item");u&&(l.innerHTML=renderAssetsPreview(u.getAttribute("data-value")))});const r=i.querySelector("input");r.addEventListener("keydown",c=>{if(c.isComposing)return;const d=i.querySelector(".b3-list--empty");if(!d){const u=upDownHint(s,c);u&&(l.innerHTML=renderAssetsPreview(u.getAttribute("data-value")),c.stopPropagation())}if(c.key==="Enter"){if(d)a||(window.siyuan.menus.menu.remove(),focusByRange(e.toolbar.range));else{const u=i.querySelector(".b3-list-item--focus");a?a(u.getAttribute("data-value"),u.textContent):(hintRenderAssets(u.getAttribute("data-value"),e),window.siyuan.menus.menu.remove())}c.preventDefault(),c.stopPropagation()}else c.key==="Escape"&&(a||focusByRange(e.toolbar.range))}),r.addEventListener("input",c=>{c.isComposing||(c.stopPropagation(),dn(i,r.value,t,n))}),r.addEventListener("compositionend",c=>{c.stopPropagation(),dn(i,r.value,t,n)}),i.lastElementChild.addEventListener("click",c=>{const d=c.target;if(hasClosestByAttribute(d,"data-type","previous")){r.dispatchEvent(new KeyboardEvent("keydown",{key:"ArrowUp"})),c.stopPropagation();return}if(hasClosestByAttribute(d,"data-type","next")){r.dispatchEvent(new KeyboardEvent("keydown",{key:"ArrowDown"})),c.stopPropagation();return}const f=hasClosestByClassName(d,"b3-list-item");if(f){c.stopPropagation();const p=f.getAttribute("data-value");a?a(p,f.textContent):(hintRenderAssets(p,e),window.siyuan.menus.menu.remove())}}),dn(i,"",t,n)}})},Cu=(e,t)=>{var a;const n=hasClosestBlock(t);if(!n)return;hideElements(["util","toolbar","hint"],e);const o=n.getAttribute("data-node-id");let i=n.outerHTML;window.siyuan.menus.menu.remove();let s;window.siyuan.menus.menu.append(new MenuItem({id:"idAndAnchor",iconHTML:"",type:"readonly",label:`<div>ID</div>
<textarea spellcheck="false" rows="1" style="margin:4px 0;width: ${isMobile()?"200":"360"}px" class="b3-text-field" readonly>${t.getAttribute("data-id")||""}</textarea>
<div class="fn__hr"></div>
<div>${window.siyuan.languages.anchor}</div>
<textarea rows="1" style="margin:4px 0;width: ${isMobile()?"200":"360"}px" class="b3-text-field"></textarea>`,bind(c){c.style.maxWidth="none",s=c.querySelectorAll(".b3-text-field")[1],s.value=t.textContent;const d=()=>{s.value?t.innerHTML=Lute.EscapeHTMLStr(s.value):t.innerHTML="*"};s.addEventListener("input",u=>{u.isComposing||(d(),u.stopPropagation())}),s.addEventListener("compositionend",u=>{u.isComposing||(d(),u.stopPropagation())}),s.addEventListener("keydown",u=>{if(!u.isComposing){if(u.key==="Enter"&&!u.isComposing)window.siyuan.menus.menu.remove();else if(electronUndo(u))return}})}}).element),window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({id:"turnInto",label:window.siyuan.languages.turnInto,icon:"iconRefresh",submenu:[{id:"text",iconHTML:"",label:window.siyuan.languages.text,click(){n.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),removeInlineType(t,"file-annotation-ref",e.toolbar.range),updateTransaction(e,o,n.outerHTML,i),i=n.outerHTML}},{id:"text*",iconHTML:"",label:window.siyuan.languages.text+" *",click(){t.insertAdjacentHTML("beforebegin",t.innerHTML+" "),t.textContent="*",n.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,o,n.outerHTML,i),i=n.outerHTML}}]}).element),window.siyuan.menus.menu.append(new MenuItem({id:"remove",icon:"iconTrashcan",label:window.siyuan.languages.remove,click(){t.insertAdjacentHTML("afterend","<wbr>"),t.remove(),n.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,o,n.outerHTML,i),focusByWbr(n,e.toolbar.range),i=n.outerHTML}}).element),(a=e==null?void 0:e.app)!=null&&a.plugins&&emitOpenMenu({plugins:e.app.plugins,type:"open-menu-fileannotationref",detail:{protyle:e,element:t},separatorPosition:"top"});const l=t.getBoundingClientRect();window.siyuan.menus.menu.popup({x:l.left,y:l.top+26,h:26});const r=hasTopClosestByClassName(e.element,"block__popover",!0);window.siyuan.menus.menu.element.setAttribute("data-from",r?r.dataset.level+"popover":"app"),s.select(),window.siyuan.menus.menu.removeCB=()=>{n.outerHTML!==i&&(n.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,o,n.outerHTML,i));const c=getSelection().rangeCount===0?void 0:getSelection().getRangeAt(0);c&&!e.element.contains(c.startContainer)&&(e.toolbar.range.selectNodeContents(t),e.toolbar.range.collapse(!1),focusByRange(e.toolbar.range))}},Au=(e,t)=>{var a;const n=hasClosestBlock(t);if(!n)return;hideElements(["util","toolbar","hint"],e);const o=t.getAttribute("data-id"),i=n.getAttribute("data-node-id");let s=n.outerHTML;if(window.siyuan.menus.menu.remove(),e.disabled||(window.siyuan.menus.menu.append(new MenuItem({id:"anchor",iconHTML:"",type:"readonly",label:`<input style="margin: 4px 0" class="b3-text-field fn__block" placeholder="${window.siyuan.languages.anchor}">`,bind(c){const d=c.querySelector("input");d.value=t.getAttribute("data-subtype")==="d"?"":t.textContent,d.addEventListener("input",()=>{d.value?t.innerHTML=Lute.EscapeHTMLStr(d.value):fetchPost("/api/block/getRefText",{id:o},u=>{t.innerHTML=u.data}),t.setAttribute("data-subtype",d.value?"s":"d")}),d.addEventListener("keydown",u=>{if(!u.isComposing){if(u.key==="Enter"&&!u.isComposing)window.siyuan.menus.menu.remove();else if(electronUndo(u))return}})}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"separator_1",type:"separator"}).element)),!e.disabled){let c=[];t.getAttribute("data-subtype")==="s"?c.push({id:"turnToDynamic",iconHTML:"",label:window.siyuan.languages.turnToDynamic,click(){t.setAttribute("data-subtype","d"),fetchPost("/api/block/getRefText",{id:o},d=>{t.innerHTML=d.data,n.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,i,n.outerHTML,s),s=n.outerHTML}),focusByRange(e.toolbar.range)}}):c.push({id:"turnToStatic",iconHTML:"",label:window.siyuan.languages.turnToStatic,click(){t.setAttribute("data-subtype","s"),n.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,i,n.outerHTML,s),focusByRange(e.toolbar.range),s=n.outerHTML}}),c=c.concat([{id:"text",iconHTML:"",label:window.siyuan.languages.text,click(){n.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),removeInlineType(t,"block-ref",e.toolbar.range),updateTransaction(e,i,n.outerHTML,s),s=n.outerHTML}},{id:"*",iconHTML:"",label:"*",click(){t.setAttribute("data-subtype","s"),t.textContent="*",n.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,i,n.outerHTML,s),focusByRange(e.toolbar.range),s=n.outerHTML}},{id:"text*",iconHTML:"",label:window.siyuan.languages.text+" *",click(){t.insertAdjacentHTML("beforebegin",t.innerHTML+" "),t.setAttribute("data-subtype","s"),t.textContent="*",n.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,i,n.outerHTML,s),focusByRange(e.toolbar.range),s=n.outerHTML}},{id:"link",label:window.siyuan.languages.link,iconHTML:"",click(){t.outerHTML=`<span data-type="a" data-href="siyuan://blocks/${t.getAttribute("data-id")}">${t.innerHTML}</span><wbr>`,n.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,i,n.outerHTML,s),focusByWbr(n,e.toolbar.range),s=n.outerHTML}}]),t.parentElement.textContent.trim()===t.textContent.trim()&&t.parentElement.tagName==="DIV"&&c.push({id:"blockEmbed",iconHTML:"",label:window.siyuan.languages.blockEmbed,click(){const d=`<div data-content="select * from blocks where id='${o}'" data-node-id="${i}" data-type="NodeBlockQueryEmbed" class="render-node" updated="${dayjs().format("YYYYMMDDHHmmss")}">${n.querySelector(".protyle-attr").outerHTML}</div>`;n.outerHTML=d,updateTransaction(e,i,d,s),blockRender(e,e.wysiwyg.element),s=n.outerHTML}}),c.push({id:"defBlock",iconHTML:"",label:window.siyuan.languages.defBlock,click(){fetchPost("/api/block/swapBlockRef",{refID:i,defID:o,includeChildren:!1})}}),c.push({id:"defBlockChildren",iconHTML:"",label:window.siyuan.languages.defBlockChildren,click(){fetchPost("/api/block/swapBlockRef",{refID:i,defID:o,includeChildren:!0})}}),window.siyuan.menus.menu.append(new MenuItem({id:"iconRefresh",label:window.siyuan.languages.turnInto,icon:"iconRefresh",submenu:c}).element)}window.siyuan.menus.menu.append(new MenuItem({id:"copy",label:window.siyuan.languages.copy,icon:"iconCopy",click(){writeText(e.lute.BlockDOM2StdMd(t.outerHTML))}}).element),e.disabled||(window.siyuan.menus.menu.append(new MenuItem({id:"cut",label:window.siyuan.languages.cut,icon:"iconCut",click(){writeText(e.lute.BlockDOM2StdMd(t.outerHTML)),t.insertAdjacentHTML("afterend","<wbr>"),t.remove(),n.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,i,n.outerHTML,s),focusByWbr(n,e.toolbar.range),s=n.outerHTML}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"remove",label:window.siyuan.languages.remove,icon:"iconTrashcan",click(){t.insertAdjacentHTML("afterend","<wbr>"),t.remove(),n.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,i,n.outerHTML,s),focusByWbr(n,e.toolbar.range),s=n.outerHTML}}).element)),(a=e==null?void 0:e.app)!=null&&a.plugins&&emitOpenMenu({plugins:e.app.plugins,type:"open-menu-blockref",detail:{protyle:e,element:t},separatorPosition:"top"});const l=t.getBoundingClientRect();window.siyuan.menus.menu.popup({x:l.left,y:l.top+26,h:26});const r=hasTopClosestByClassName(e.element,"block__popover",!0);window.siyuan.menus.menu.data=t,window.siyuan.menus.menu.element.setAttribute("data-from",r?r.dataset.level+"popover":"app"),e.disabled||(window.siyuan.menus.menu.element.querySelector("input").select(),window.siyuan.menus.menu.removeCB=()=>{n.outerHTML!==s&&(n.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,i,n.outerHTML,s));const c=getSelection().rangeCount===0?void 0:getSelection().getRangeAt(0);c&&!e.element.contains(c.startContainer)&&(e.toolbar.range.selectNodeContents(t),e.toolbar.range.collapse(!1),focusByRange(e.toolbar.range))})},Lu=(e,t)=>{var a;const n=getEditorRange(t);window.siyuan.menus.menu.remove(),e.toolbar.showContent(e,n,t),(a=e==null?void 0:e.app)!=null&&a.plugins&&emitOpenMenu({plugins:e.app.plugins,type:"open-menu-content",detail:{protyle:e,range:n,element:t},separatorPosition:"top"})},Su=(e,t)=>{if(e.block.showAll)Cs({protyle:e,id:e.block.parent2ID,focusId:t});else{const a=e.path.split("/");a.length>2&&openMobileFileById(e.app,a[a.length-2],[Constants.CB_GET_FOCUS,Constants.CB_GET_SCROLL])}},Cs=e=>{var t,a;if(e.protyle.options.backlinkData)return;typeof e.isPushBack=="undefined"&&(e.isPushBack=!0),typeof e.reload=="undefined"&&(e.reload=!1);const n=(t=e.protyle.breadcrumb)==null?void 0:t.element.querySelector(".protyle-breadcrumb__item--active");if(!e.reload&&n&&n.getAttribute("data-node-id")===e.id){if(e.id===e.protyle.block.rootID)return;const o=e.protyle.wysiwyg.element.querySelector(`[data-node-id="${e.focusId||e.id}"]`);if(o){Re(o),o.scrollIntoView();return}}(a=window.siyuan.mobile)!=null&&a.editor&&(window.siyuan.storage[S.LOCAL_DOCINFO]={id:e.id},Ha(S.LOCAL_DOCINFO,window.siyuan.storage[S.LOCAL_DOCINFO]),e.isPushBack&&Vo()),he("/api/filetree/getDoc",{id:e.id,size:e.id===e.protyle.block.rootID?window.siyuan.config.editor.dynamicLoadBlocks:S.SIZE_GET_MAX},o=>Go(void 0,null,function*(){if(e.isPushBack?Wt({data:o,protyle:e.protyle,action:e.id===e.protyle.block.rootID?[S.CB_GET_FOCUS,S.CB_GET_HTML]:[S.CB_GET_ALL,S.CB_GET_FOCUS,S.CB_GET_HTML],afterCB:e.callback}):Wt({data:o,protyle:e.protyle,action:e.id===e.protyle.block.rootID?[S.CB_GET_FOCUS,S.CB_GET_HTML,S.CB_GET_UNUNDO]:[S.CB_GET_ALL,S.CB_GET_FOCUS,S.CB_GET_UNUNDO,S.CB_GET_HTML],afterCB:e.callback}),e.focusId){let i=e.protyle.wysiwyg.element.querySelector(`[data-node-id="${e.focusId}"]`);if(!i){const s=yield ai("/api/block/getUnfoldedParentID",{id:e.focusId});e.focusId=s.data.parentID,i=e.protyle.wysiwyg.element.querySelector(`[data-node-id="${s.data.parentID}"]`)}if(i){let s=i;for(;s.getBoundingClientRect().height===0;)s=s.parentElement;s.classList.contains("protyle-wysiwyg")?s=i.previousElementSibling||i.nextElementSibling:s=et(s),Re(s);const l=new ResizeObserver(()=>{s.scrollIntoView()});l.observe(e.protyle.wysiwyg.element),setTimeout(()=>{l.disconnect()},1e3*3)}else if(e.id===e.protyle.block.rootID){he("/api/filetree/getDoc",{id:e.focusId,mode:3,size:window.siyuan.config.editor.dynamicLoadBlocks},s=>{Wt({data:s,protyle:e.protyle,action:e.isPushBack?[S.CB_GET_FOCUS]:[S.CB_GET_FOCUS,S.CB_GET_UNUNDO]})});return}}else e.id!==e.protyle.block.rootID&&(e.protyle.wysiwyg.element.classList.add("protyle-wysiwyg--animate"),setTimeout(()=>{e.protyle.wysiwyg.element.classList.remove("protyle-wysiwyg--animate")},365))}))},xu=(e,t,a,n)=>{var o;window.siyuan.menus.menu.remove();const i=hasClosestBlock(a);if(!i)return;hideElements(["util","toolbar","hint"],e);const s=i.getAttribute("data-node-id"),l=a.querySelector("img"),r=a.querySelector(".protyle-action__title span"),c=i.outerHTML;if(e.disabled||(window.siyuan.menus.menu.append(new MenuItem({id:"imageUrlAndTitleAndTooltipText",iconHTML:"",type:"readonly",label:`<div class="fn__flex">
    <span class="fn__flex-center">${window.siyuan.languages.imageURL}</span>
    <span class="fn__space"></span>
    <span data-action="copy" class="block__icon block__icon--show b3-tooltips b3-tooltips__e fn__flex-center" aria-label="${window.siyuan.languages.copy}">
        <svg><use xlink:href="#iconCopy"></use></svg>
    </span>   
</div>
<textarea spellcheck="false" style="margin:4px 0;width: ${isMobile()?"200":"360"}px" rows="1" class="b3-text-field">${l.getAttribute("src")}</textarea>
<div class="fn__hr"></div>
<div class="fn__flex">
    <span class="fn__flex-center">${window.siyuan.languages.title}</span>
    <span class="fn__space"></span>
    <span data-action="copy" class="block__icon block__icon--show b3-tooltips b3-tooltips__e fn__flex-center" aria-label="${window.siyuan.languages.copy}">
        <svg><use xlink:href="#iconCopy"></use></svg>
    </span>   
</div>
<textarea style="margin:4px 0;width: ${isMobile()?"200":"360"}px" rows="1" class="b3-text-field"></textarea>
<div class="fn__hr"></div>
<div class="fn__flex">
    <span class="fn__flex-center">${window.siyuan.languages.tooltipText}</span>
    <span class="fn__space"></span>
    <span data-action="copy" class="block__icon block__icon--show b3-tooltips b3-tooltips__e fn__flex-center" aria-label="${window.siyuan.languages.copy}">
        <svg><use xlink:href="#iconCopy"></use></svg>
    </span>   
</div>
<textarea style="margin:4px 0;width: ${isMobile()?"200":"360"}px" rows="1" class="b3-text-field"></textarea>`,bind(f){f.style.maxWidth="none";const p=f.querySelectorAll("textarea");p[0].addEventListener("input",m=>{const b=m.target.value.replace(/\n|\r\n|\r|\u2028|\u2029/g,"").trim();if(l.setAttribute("src",b),l.setAttribute("data-src",b),b.startsWith("assets/")){const w=a.querySelector(".img__net");w&&w.remove()}else window.siyuan.config.editor.displayNetImgMark&&a.querySelector(".protyle-action__drag").insertAdjacentHTML("afterend",'<span class="img__net"><svg><use xlink:href="#iconLanguage"></use></svg></span>')}),p[1].value=r.innerText,p[1].addEventListener("input",m=>{const b=m.target.value;l.setAttribute("title",b),r.innerText=b,mathRender(r)}),p[2].value=l.getAttribute("alt")||"",f.addEventListener("click",m=>{let b=m.target;for(;b;){if(b.dataset.action==="copy"){writeText(b.parentElement.nextElementSibling.value),showMessage(window.siyuan.languages.copied);break}b=b.parentElement}})}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"separator_1",type:"separator"}).element)),window.siyuan.menus.menu.append(new MenuItem({id:"copy",label:window.siyuan.languages.copy,accelerator:"\u2318C",icon:"iconCopy",click(){let f=e.lute.BlockDOM2StdMd(a.outerHTML);f=f.replace(/%20/g," "),writeText(f)}}).element),e.disabled&&window.siyuan.menus.menu.append(new MenuItem({id:"copyImageURL",label:window.siyuan.languages.copy+" "+window.siyuan.languages.imageURL,icon:"iconLink",click(){writeText(l.getAttribute("src"))}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"copyAsPNG",label:window.siyuan.languages.copyAsPNG,accelerator:window.siyuan.config.keymap.editor.general.copyBlockRef.custom,icon:"iconImage",click(){copyPNGByLink(l.getAttribute("src"))}}).element),!e.disabled){window.siyuan.menus.menu.append(new MenuItem({id:"cut",icon:"iconCut",accelerator:"\u2318X",label:window.siyuan.languages.cut,click(){let b=e.lute.BlockDOM2StdMd(a.outerHTML);b=b.replace(/%20/g," "),writeText(b),a.outerHTML="<wbr>",i.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,s,i.outerHTML,c),focusByWbr(e.wysiwyg.element,t)}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"delete",icon:"iconTrashcan",accelerator:"\u232B",label:window.siyuan.languages.delete,click:function(){a.outerHTML="<wbr>",i.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,s,i.outerHTML,c),focusByWbr(e.wysiwyg.element,t)}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"separator_2",type:"separator"}).element);const f=l.getAttribute("data-src");f.startsWith("assets/")&&window.siyuan.menus.menu.append(new MenuItem({id:"rename",label:window.siyuan.languages.rename,icon:"iconEdit",click(){renameAsset(f)}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"ocr",label:"OCR",submenu:[{id:"ocrResult",iconHTML:"",type:"readonly",label:`<textarea spellcheck="false" data-type="ocr" style="margin: 4px 0" rows="1" class="b3-text-field fn__size200" placeholder="${window.siyuan.languages.ocrResult}"></textarea>`,bind(b){b.style.maxWidth="none",fetchPost("/api/asset/getImageOCRText",{path:l.getAttribute("src")},w=>{const y=b.querySelector("textarea");y.value=w.data.text,y.dataset.ocrText=w.data.text})}},{type:"separator"},{id:"reOCR",iconHTML:"",label:window.siyuan.languages.reOCR,click(){fetchPost("/api/asset/ocr",{path:l.getAttribute("src"),force:!0})}}]}).element),window.siyuan.menus.menu.append(new MenuItem({id:"alignCenter",icon:"iconAlignCenter",label:window.siyuan.languages.alignCenter,accelerator:window.siyuan.config.keymap.editor.general.alignCenter.custom,click(){alignImgCenter(e,i,[a],s,c)}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"alignLeft",icon:"iconAlignLeft",label:window.siyuan.languages.alignLeft,accelerator:window.siyuan.config.keymap.editor.general.alignLeft.custom,click(){alignImgLeft(e,i,[a],s,c)}}).element);let p;window.siyuan.menus.menu.append(new MenuItem({id:"width",label:window.siyuan.languages.width,submenu:[{id:"widthInput",iconHTML:"",type:"readonly",label:`<div class="fn__flex-center">
<input class="b3-text-field" style="margin: 4px 8px 4px 0" value="${l.parentElement.style.width.endsWith("px")?parseInt(l.parentElement.style.width):""}" type="number" placeholder="${window.siyuan.languages.width}">px
</div>`,bind(b){const w=b.querySelector("input");w.addEventListener("input",()=>{p.value="0",p.parentElement.setAttribute("aria-label",w.value?w.value+"px":window.siyuan.languages.default),img3115(a),l.parentElement.style.width=w.value?w.value+"px":"",l.style.height=""}),w.addEventListener("blur",()=>{w.value!==l.parentElement.style.width.replace("px","")&&(i.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,s,i.outerHTML,c),window.siyuan.menus.menu.remove(),focusBlock(i))})}},bt("25%",l,e,s,i,c),bt("33%",l,e,s,i,c),bt("50%",l,e,s,i,c),bt("67%",l,e,s,i,c),bt("75%",l,e,s,i,c),bt("100%",l,e,s,i,c),{id:"separator_1",type:"separator"},{id:"widthDrag",iconHTML:"",type:"readonly",label:`<div style="margin: 4px 0;" aria-label="${l.parentElement.style.width?l.parentElement.style.width.replace("vw","%").replace("calc(","").replace(" - 8px)",""):window.siyuan.languages.default}" class="b3-tooltips b3-tooltips__n${isMobile()?"":" fn__size200"}">
    <input style="box-sizing: border-box" value="${l.parentElement.style.width.indexOf("%")>-1||l.parentElement.style.width.endsWith("vw")?parseInt(l.parentElement.style.width.replace("calc(","")):0}" class="b3-slider fn__block" max="100" min="1" step="1" type="range">
</div>`,bind(b){p=b.querySelector("input"),p.addEventListener("input",()=>{img3115(a),l.parentElement.style.width=`calc(${p.value}% - 8px)`,l.style.height="",p.parentElement.setAttribute("aria-label",`${p.value}%`)}),p.addEventListener("change",()=>{i.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,s,i.outerHTML,c),window.siyuan.menus.menu.remove(),focusBlock(i)})}},{id:"separator_2",type:"separator"},bt(window.siyuan.languages.default,l,e,s,i,c)]}).element);let m;window.siyuan.menus.menu.append(new MenuItem({id:"height",label:window.siyuan.languages.height,submenu:[{id:"heightInput",iconHTML:"",type:"readonly",label:`<div class="fn__flex-center">
<input class="b3-text-field" value="${l.style.height.endsWith("px")?parseInt(l.style.height):""}" type="number" style="margin: 4px 8px 4px 0" placeholder="${window.siyuan.languages.height}">px
</div>`,bind(b){const w=b.querySelector("input");w.addEventListener("input",()=>{m.value="0",m.parentElement.setAttribute("aria-label",w.value?w.value+"px":window.siyuan.languages.default),l.style.height=w.value?w.value+"px":"",img3115(a),l.parentElement.style.width=""}),w.addEventListener("blur",()=>{w.value!==l.style.height.replace("px","")&&(i.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,s,i.outerHTML,c),window.siyuan.menus.menu.remove(),focusBlock(i))})}},yt("25%",l,e,s,i,c),yt("33%",l,e,s,i,c),yt("50%",l,e,s,i,c),yt("67%",l,e,s,i,c),yt("75%",l,e,s,i,c),yt("100%",l,e,s,i,c),{id:"separator_1",type:"separator"},{id:"heightDrag",iconHTML:"",type:"readonly",label:`<div style="margin: 4px 0;" aria-label="${l.style.height?l.style.height.replace("vh","%"):window.siyuan.languages.default}" class="b3-tooltips b3-tooltips__n${isMobile()?"":" fn__size200"}">
    <input style="box-sizing: border-box" value="${l.style.height.endsWith("vh")?parseInt(l.style.height):0}" class="b3-slider fn__block" max="100" min="1" step="1" type="range">
</div>`,bind(b){m=b.querySelector("input"),m.addEventListener("input",()=>{img3115(a),l.parentElement.style.width="",l.style.height=m.value+"vh",m.parentElement.setAttribute("aria-label",`${m.value}%`)}),m.addEventListener("change",()=>{i.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,s,i.outerHTML,c),window.siyuan.menus.menu.remove(),focusBlock(i)})}},{id:"separator_2",type:"separator"},yt(window.siyuan.languages.default,l,e,s,i,c)]}).element)}const d=l.getAttribute("src");d&&(window.siyuan.menus.menu.append(new MenuItem({id:"separator_3",type:"separator"}).element),openMenu(e.app,d,!1,!1));const u=l.getAttribute("data-src");u&&u.startsWith("assets/")&&window.siyuan.menus.menu.append(new MenuItem(exportAsset(u)).element),(o=e==null?void 0:e.app)!=null&&o.plugins&&emitOpenMenu({plugins:e.app.plugins,type:"open-menu-image",detail:{protyle:e,element:a},separatorPosition:"top"}),window.siyuan.menus.menu.popup({x:n.clientX,y:n.clientY});const g=hasTopClosestByClassName(e.element,"block__popover",!0);if(window.siyuan.menus.menu.element.setAttribute("data-from",g?g.dataset.level+"popover":"app"),!e.disabled){const f=window.siyuan.menus.menu.element.querySelectorAll("textarea");f[0].value?f[1].select():f[0].select(),window.siyuan.menus.menu.removeCB=()=>{const p=window.siyuan.menus.menu.element.querySelector('[data-type="ocr"]');p&&p.dataset.ocrText!==p.value&&fetchPost("/api/asset/setImageOCRText",{path:l.getAttribute("src"),text:p.value}),l.setAttribute("alt",f[2].value.replace(/\n|\r\n|\r|\u2028|\u2029/g,"")),i.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,s,i.outerHTML,c)}}},Ko=(e,t,a=!1)=>{var n;window.siyuan.menus.menu.remove();const o=oe(t);if(!o)return;na(),St(["util","toolbar","hint"],e);const i=o.getAttribute("data-node-id");let s=o.outerHTML;const l=t.getAttribute("data-href");let r;e.disabled||(window.siyuan.menus.menu.append(new _e({id:"linkAndAnchorAndTitle",iconHTML:"",type:"readonly",label:`<div class="fn__flex">
    <span class="fn__flex-center">${window.siyuan.languages.link}</span>
    <span class="fn__space"></span>
    <span data-action="copy" class="block__icon block__icon--show b3-tooltips b3-tooltips__e fn__flex-center" aria-label="${window.siyuan.languages.copy}">
        <svg><use xlink:href="#iconCopy"></use></svg>
    </span>   
</div>
<textarea spellcheck="false" rows="1" style="margin:4px 0;width: ${$()?"200":"360"}px" class="b3-text-field"></textarea>
<div class="fn__hr"></div>
<div class="fn__flex">
    <span class="fn__flex-center">${window.siyuan.languages.anchor}</span>
    <span class="fn__space"></span>
    <span data-action="copy" class="block__icon block__icon--show b3-tooltips b3-tooltips__e fn__flex-center" aria-label="${window.siyuan.languages.copy}">
        <svg><use xlink:href="#iconCopy"></use></svg>
    </span>   
</div>
<textarea style="width: ${$()?"200":"360"}px;margin: 4px 0;" rows="1" class="b3-text-field"></textarea>
<div class="fn__hr"></div>
<div class="fn__flex">
    <span class="fn__flex-center">${window.siyuan.languages.title}</span>
    <span class="fn__space"></span>
    <span data-action="copy" class="block__icon block__icon--show b3-tooltips b3-tooltips__e fn__flex-center" aria-label="${window.siyuan.languages.copy}">
        <svg><use xlink:href="#iconCopy"></use></svg>
    </span>   
</div>
<textarea style="width: ${$()?"200":"360"}px;margin: 4px 0;" rows="1" class="b3-text-field"></textarea>`,bind(u){u.style.maxWidth="none",r=u.querySelectorAll("textarea"),r[0].value=Lute.UnEscapeHTMLStr(l)||"",r[0].addEventListener("keydown",f=>{if((f.key==="Enter"||f.key==="Escape")&&!f.isComposing)f.preventDefault(),f.stopPropagation(),window.siyuan.menus.menu.remove();else if(f.key==="Tab"&&!f.isComposing)f.preventDefault(),f.stopPropagation(),r[1].focus();else if(sa(f))return});let g=t.textContent.replace(S.ZWSP,"");!g&&l&&(g=decodeURIComponent(l.replace("https://","").replace("http://","")),g.length>S.SIZE_LINK_TEXT_MAX&&(g=g.substring(0,S.SIZE_LINK_TEXT_MAX)+"..."),t.innerHTML=Lute.EscapeHTMLStr(g)),r[1].value=g,r[1].addEventListener("compositionend",()=>{t.innerHTML=Lute.EscapeHTMLStr(r[1].value.replace(/\n|\r\n|\r|\u2028|\u2029/g,"")||"*")}),r[1].addEventListener("input",f=>{f.isComposing||(t.innerHTML=Lute.EscapeHTMLStr(r[1].value.replace(/\n|\r\n|\r|\u2028|\u2029/g,""))||"*")}),r[1].addEventListener("keydown",f=>{if((f.key==="Enter"||f.key==="Escape")&&!f.isComposing)f.preventDefault(),f.stopPropagation(),window.siyuan.menus.menu.remove();else if(f.key==="Tab"&&!f.isComposing)f.preventDefault(),f.stopPropagation(),f.shiftKey?r[0].focus():r[2].focus();else if(sa(f))return}),r[2].value=Lute.UnEscapeHTMLStr(t.getAttribute("data-title")||""),r[2].addEventListener("keydown",f=>{if((f.key==="Enter"||f.key==="Escape")&&!f.isComposing)f.preventDefault(),f.stopPropagation(),window.siyuan.menus.menu.remove();else if(f.key==="Tab"&&f.shiftKey&&!f.isComposing)f.preventDefault(),f.stopPropagation(),r[1].focus();else if(sa(f))return}),u.addEventListener("click",f=>{let p=f.target;for(;p;){if(p.dataset.action==="copy"){Da(p.parentElement.nextElementSibling.value),tt(window.siyuan.languages.copied);break}p=p.parentElement}})}}).element),window.siyuan.menus.menu.append(new _e({id:"separator_1",type:"separator"}).element)),window.siyuan.menus.menu.append(new _e({id:"copy",label:window.siyuan.languages.copy,icon:"iconCopy",click(){const u=document.createRange();u.selectNode(t),Ae(u),document.execCommand("copy")}}).element),e.disabled&&window.siyuan.menus.menu.append(new _e({id:"copyAHref",label:window.siyuan.languages.copy+" "+window.siyuan.languages.replaceTypes.aHref,icon:"iconLink",click(){Da(l)}}).element),e.disabled||(window.siyuan.menus.menu.append(new _e({id:"cut",icon:"iconCut",label:window.siyuan.languages.cut,click(){const u=document.createRange();u.selectNode(t),Ae(u),document.execCommand("cut")}}).element),window.siyuan.menus.menu.append(new _e({id:"remove",icon:"iconTrashcan",label:window.siyuan.languages.remove,click(){t.insertAdjacentHTML("afterend","<wbr>"),t.remove(),o.setAttribute("updated",Ze().format("YYYYMMDDHHmmss")),Vt(e,i,o.outerHTML,s),Ta(o,e.toolbar.range),s=o.outerHTML}}).element),l!=null&&l.startsWith("assets/")&&window.siyuan.menus.menu.append(new _e({id:"rename",label:window.siyuan.languages.rename,icon:"iconEdit",click(){Yi(l)}}).element),l!=null&&l.startsWith("siyuan://blocks/")&&window.siyuan.menus.menu.append(new _e({id:"turnIntoRef",label:`${window.siyuan.languages.turnInto} <b>${window.siyuan.languages.ref}</b>`,icon:"iconRef",click(){t.setAttribute("data-subtype","s");const u=t.getAttribute("data-type").split(" ");u.push("block-ref"),u.splice(u.indexOf("a"),1),t.setAttribute("data-type",u.join(" ")),t.setAttribute("data-id",r[0].value.replace("siyuan://blocks/","")),r[0].value="",r[2].value="",t.removeAttribute("data-href"),t.removeAttribute("data-title"),o.setAttribute("updated",Ze().format("YYYYMMDDHHmmss")),Vt(e,i,o.outerHTML,s),e.toolbar.range.selectNode(t),e.toolbar.range.collapse(!1),Ae(e.toolbar.range),s=o.outerHTML}}).element),window.siyuan.menus.menu.append(new _e({id:"turnIntoText",label:`${window.siyuan.languages.turnInto} <b>${window.siyuan.languages.text}</b>`,icon:"iconRefresh",click(){r[0].value="",r[2].value="",o.setAttribute("updated",Ze().format("YYYYMMDDHHmmss")),Qi(t,"a",e.toolbar.range),Vt(e,i,o.outerHTML,s),s=o.outerHTML}}).element)),l&&(window.siyuan.menus.menu.append(new _e({id:"separator_2",type:"separator"}).element),ao(e.app,l,!1,!0),l!=null&&l.startsWith("assets/")&&window.siyuan.menus.menu.append(new _e(Ki(l)).element)),!e.disabled&&((n=e==null?void 0:e.app)!=null&&n.plugins)&&Di({plugins:e.app.plugins,type:"open-menu-link",detail:{protyle:e,element:t},separatorPosition:"top"});const c=t.getBoundingClientRect();window.siyuan.menus.menu.popup({x:c.left,y:c.top+26,h:26});const d=O(e.element,"block__popover",!0);window.siyuan.menus.menu.element.setAttribute("data-from",d?d.dataset.level+"popover":"app"),!e.disabled&&(a||e.lute.GetLinkDest(l)||l!=null&&l.startsWith("assets/")?r[1].select():r[0].select(),window.siyuan.menus.menu.removeCB=()=>{r[2].value?t.setAttribute("data-title",Lute.EscapeHTMLStr(r[2].value.replace(/\n|\r\n|\r|\u2028|\u2029/g,""))):t.removeAttribute("data-title"),t.getAttribute("data-type").indexOf("a")>-1?t.setAttribute("data-href",Lute.EscapeHTMLStr(r[0].value.replace(/\n|\r\n|\r|\u2028|\u2029/g,""))):t.removeAttribute("data-href");const u=getSelection().rangeCount===0?void 0:getSelection().getRangeAt(0);u&&!e.element.contains(u.startContainer)&&(e.toolbar.range.selectNodeContents(t),e.toolbar.range.collapse(!1),Ae(e.toolbar.range)),s!==o.outerHTML&&(o.setAttribute("updated",Ze().format("YYYYMMDDHHmmss")),Vt(e,i,o.outerHTML,s))})},Tu=(e,t)=>{var a;window.siyuan.menus.menu.remove();const n=hasClosestBlock(t);if(!n)return;hideElements(["util","toolbar","hint"],e);const o=n.getAttribute("data-node-id");let i=n.outerHTML;window.siyuan.menus.menu.append(new MenuItem({id:"tag",iconHTML:"",type:"readonly",label:`<input class="b3-text-field fn__size200" style="margin: 4px 0" placeholder="${window.siyuan.languages.tag}">`,bind(r){const c=r.querySelector("input");c.value=t.textContent.replace(Constants.ZWSP,""),c.addEventListener("change",()=>{updateTransaction(e,o,n.outerHTML,i),i=n.outerHTML}),c.addEventListener("compositionend",()=>{t.innerHTML=Constants.ZWSP+Lute.EscapeHTMLStr(c.value||"")}),c.addEventListener("input",d=>{d.isComposing||(t.innerHTML=Constants.ZWSP+Lute.EscapeHTMLStr(c.value||""))}),c.addEventListener("keydown",d=>{if((d.key==="Enter"||d.key==="Escape")&&!d.isComposing){if(d.preventDefault(),d.stopPropagation(),c.value)e.toolbar.range.selectNodeContents(t),e.toolbar.range.collapse(!1),focusByRange(e.toolbar.range);else{const u=n.outerHTML;t.insertAdjacentHTML("afterend","<wbr>"),t.remove(),n.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,o,n.outerHTML,u),focusByWbr(n,e.toolbar.range)}window.siyuan.menus.menu.remove()}else if(electronUndo(d))return})}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"separator_1",type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({id:"search",label:window.siyuan.languages.search,accelerator:window.siyuan.languages.click,icon:"iconSearch",click(){popSearch(e.app,{hasReplace:!1,method:0,hPath:"",idPath:[],k:`#${t.textContent}#`,r:"",page:1})}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"rename",label:window.siyuan.languages.rename,icon:"iconEdit",click(){renameTag(t.textContent.replace(Constants.ZWSP,""))}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"separator_2",type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({id:"turnIntoText",label:`${window.siyuan.languages.turnInto} <b>${window.siyuan.languages.text}</b>`,icon:"iconRefresh",click(){e.toolbar.range.setStart(t.firstChild,0),e.toolbar.range.setEnd(t.lastChild,t.lastChild.textContent.length),e.toolbar.setInlineMark(e,"tag","range")}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"copy",label:window.siyuan.languages.copy,icon:"iconCopy",click(){const r=document.createRange();r.selectNode(t),focusByRange(r),document.execCommand("copy")}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"cut",label:window.siyuan.languages.cut,icon:"iconCut",click(){const r=document.createRange();r.selectNode(t),focusByRange(r),document.execCommand("cut")}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"remove",icon:"iconTrashcan",label:window.siyuan.languages.remove,click(){const r=n.outerHTML;t.insertAdjacentHTML("afterend","<wbr>"),t.remove(),n.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,o,n.outerHTML,r),focusByWbr(n,e.toolbar.range)}}).element),(a=e==null?void 0:e.app)!=null&&a.plugins&&emitOpenMenu({plugins:e.app.plugins,type:"open-menu-tag",detail:{protyle:e,element:t},separatorPosition:"top"});const s=t.getBoundingClientRect();window.siyuan.menus.menu.popup({x:s.left,y:s.top+26,h:26});const l=hasTopClosestByClassName(e.element,"block__popover",!0);window.siyuan.menus.menu.element.setAttribute("data-from",l?l.dataset.level+"popover":"app"),window.siyuan.menus.menu.element.querySelector("input").select()},Iu=(e,t)=>{window.siyuan.menus.menu.remove();const a=hasClosestBlock(t);if(!a)return;const n=a.getAttribute("data-node-id"),o=a.outerHTML;window.siyuan.menus.menu.append(new MenuItem({id:"copy",label:window.siyuan.languages.copy,icon:"iconCopy",click(){const s=document.createRange();s.selectNode(t),focusByRange(s),document.execCommand("copy")}}).element),e.disabled||(window.siyuan.menus.menu.append(new MenuItem({id:"cut",icon:"iconCut",label:window.siyuan.languages.cut,click(){const s=document.createRange();s.selectNode(t),focusByRange(s),document.execCommand("cut")}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"remove",icon:"iconTrashcan",label:window.siyuan.languages.remove,click(){t.insertAdjacentHTML("afterend","<wbr>"),t.remove(),a.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,n,a.outerHTML,o),focusByWbr(a,e.toolbar.range)}}).element));const i=t.getBoundingClientRect();window.siyuan.menus.menu.popup({x:i.left,y:i.top+26,h:26})},bt=(e,t,a,n,o,i)=>({id:e===window.siyuan.languages.default?"default":"width_"+e,iconHTML:"",label:e,click(){o.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),img3115(t.parentElement.parentElement),t.parentElement.style.width=e===window.siyuan.languages.default?"":`calc(${e} - 8px)`,t.style.height="",updateTransaction(a,n,o.outerHTML,i),focusBlock(o)}}),yt=(e,t,a,n,o,i)=>({id:e===window.siyuan.languages.default?"default":"width_"+e,iconHTML:"",label:e,click(){o.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),t.style.height=e===window.siyuan.languages.default?"":parseInt(e)+"vh",img3115(t.parentElement.parentElement),t.parentElement.style.width="",updateTransaction(a,n,o.outerHTML,i),focusBlock(o)}}),Mu=(e,t)=>{const a=t.getAttribute("data-node-id"),n=t.querySelector("iframe");let o=t.outerHTML;const i=[{id:"asset",iconHTML:"",type:"readonly",label:`<textarea spellcheck="false" rows="1" class="b3-text-field fn__size200" placeholder="${window.siyuan.languages.link}" style="margin: 4px 0">${n.getAttribute("src")||""}</textarea>`,bind(l){l.style.maxWidth="none",l.querySelector("textarea").addEventListener("change",r=>{const c=r.target.value.replace(/\n|\r\n|\r|\u2028|\u2029/g,"").trim(),d=c.match(/(?:www\.|\/\/)bilibili\.com\/video\/(\w+)/);if(c.indexOf("bilibili.com")>-1&&(c.indexOf("bvid=")>-1||d&&d[1])){const u={bvid:getSearch("bvid",c)||d&&d[1],page:"1",high_quality:"1",as_wide:"1",allowfullscreen:"true",autoplay:"0"};new URL(c.startsWith("http")?c:"https:"+c).search.split("&").forEach((p,m)=>{if(!p)return;m===0&&(p=p.substr(1));const b=p.split("=");u[b[0]]=b[1]});let g="https://player.bilibili.com/player.html?";const f=Object.keys(u);f.forEach((p,m)=>{g+=`${p}=${u[p]}`,m<f.length-1&&(g+="&")}),n.setAttribute("src",g),n.setAttribute("sandbox","allow-top-navigation-by-user-activation allow-same-origin allow-forms allow-scripts allow-popups"),n.style.height||(n.style.height="360px"),n.style.width||(n.style.width="640px")}else n.setAttribute("src",c);updateTransaction(e,a,t.outerHTML,o),o=t.outerHTML,r.stopPropagation()})}}],s=n.getAttribute("src");return s?(i.push({type:"separator"}),i.concat(openMenu(e.app,s,!0,!1))):i},Du=(e,t,a)=>{const n=t.getAttribute("data-node-id"),o=t.querySelector(a==="NodeVideo"?"video":"audio");let i=t.outerHTML;const s=[{id:"asset",iconHTML:"",type:"readonly",label:`<textarea spellcheck="false" rows="1" style="margin: 4px 0" class="b3-text-field" placeholder="${window.siyuan.languages.link}">${o.getAttribute("src")}</textarea>`,bind(r){r.style.maxWidth="none",r.querySelector("textarea").addEventListener("change",c=>{o.setAttribute("src",c.target.value.replace(/\n|\r\n|\r|\u2028|\u2029/g,"").trim()),updateTransaction(e,n,t.outerHTML,i),i=t.outerHTML,c.stopPropagation()})}}],l=o.getAttribute("src");return l&&l.startsWith("assets/")&&(s.push({type:"separator"}),s.push({id:"rename",label:window.siyuan.languages.rename,icon:"iconEdit",click(){renameAsset(l)}})),l&&s.push({id:"openBy",label:window.siyuan.languages.openBy,icon:"iconOpen",submenu:openMenu(e.app,l,!0,!1)}),l&&l.startsWith("assets/")&&s.push(exportAsset(l)),s},$u=(e,t,a,n)=>{var o;const i=[],s=getColIndex(a);(a.rowSpan>1||a.colSpan>1)&&i.push({id:"cancelMerged",label:window.siyuan.languages.cancelMerged,click:()=>{const T=t.outerHTML;let M=a.rowSpan,I=a.parentElement;const D=a.colSpan;for(;M>0&&I;){let N=I.children[s],H=D;for(;H>0&&N;)N.classList.remove("fn__none"),N.colSpan=1,N.rowSpan=1,N=N.nextElementSibling,H--;I=I.nextElementSibling,M--}if(a.rowSpan=1,a.colSpan=1,a.tagName==="TH"){let N;if(Array.from(t.querySelectorAll("thead tr")).find(H=>{if(N=H,Array.from(H.children).forEach(P=>{(P.rowSpan!==1||P.classList.contains("fn__none"))&&(N=void 0)}),N)return!0}),N){const H=t.querySelector("tbody"),P=t.querySelector("thead");for(;!N.isSameNode(P.lastElementChild);)H.insertAdjacentElement("afterbegin",P.lastElementChild)}}focusByRange(n),updateTransaction(e,t.getAttribute("data-node-id"),t.outerHTML,T)}});const l=t.querySelectorAll("col")[s];(l.style.width||l.style.minWidth)&&i.push({id:"useDefaultWidth",label:window.siyuan.languages.useDefaultWidth,click:()=>{const T=t.outerHTML;l.style.width="",l.style.minWidth="",updateTransaction(e,t.getAttribute("data-node-id"),t.outerHTML,T)}});const r=t.getAttribute("custom-pinthead");i.push({id:r?"unpinTableHead":"pinTableHead",icon:r?"iconUnpin":"iconPin",label:r?window.siyuan.languages.unpinTableHead:window.siyuan.languages.pinTableHead,click:()=>{const T=t.outerHTML;r?t.removeAttribute("custom-pinthead"):t.setAttribute("custom-pinthead","true"),updateTransaction(e,t.getAttribute("data-node-id"),t.outerHTML,T)}}),i.push({id:"separator_1",type:"separator"}),i.push({id:"alignLeft",icon:"iconAlignLeft",accelerator:window.siyuan.config.keymap.editor.general.alignLeft.custom,label:window.siyuan.languages.alignLeft,click:()=>{setTableAlign(e,[a],t,"left",n)}}),i.push({id:"alignCenter",icon:"iconAlignCenter",label:window.siyuan.languages.alignCenter,accelerator:window.siyuan.config.keymap.editor.general.alignCenter.custom,click:()=>{setTableAlign(e,[a],t,"center",n)}}),i.push({id:"alignRight",icon:"iconAlignRight",label:window.siyuan.languages.alignRight,accelerator:window.siyuan.config.keymap.editor.general.alignRight.custom,click:()=>{setTableAlign(e,[a],t,"right",n)}}),i.push({id:"useDefaultAlign",icon:"",label:window.siyuan.languages.useDefaultAlign,click:()=>{setTableAlign(e,[a],t,"",n)}});const c=[];c.push(...i),c.push({type:"separator"});const d=t.querySelector("table"),u=a.parentElement.querySelector(".fn__none");let g=!1,f=!1;Array.from(a.parentElement.children).forEach(T=>{T.colSpan>1&&(g=!0),T.rowSpan>1&&(f=!0)});let p=!1,m=!1,b=!1,w=a.parentElement.previousElementSibling;!w&&a.parentElement.parentElement.tagName==="TBODY"&&(w=d.querySelector("thead").lastElementChild),w&&(p=w.querySelector(".fn__none"),Array.from(w.children).forEach(T=>{T.colSpan>1&&(m=!0),T.rowSpan>1&&(b=!0)}));let y=!1,_=!1,h=!1,E=a.parentElement.nextElementSibling;!E&&a.parentElement.parentElement.tagName==="THEAD"&&(E=(o=d.querySelector("tbody"))==null?void 0:o.firstElementChild),E&&(y=E.querySelector(".fn__none"),Array.from(E.children).forEach(T=>{T.colSpan>1&&(_=!0),T.rowSpan>1&&(h=!0)}));let C=!0;Array.from(d.rows).find(T=>{const M=T.cells[s];if(M.classList.contains("fn__none")||M.colSpan>1||M.rowSpan>1)return C=!1,!0});let k=!0;Array.from(d.rows).find(T=>{const M=T.cells[s+1];if(M&&(M.classList.contains("fn__none")||M.colSpan>1||M.rowSpan>1))return k=!1,!0});let v=!0;Array.from(d.rows).find(T=>{const M=T.cells[s-1];if(M&&(M.classList.contains("fn__none")||M.colSpan>1||M.rowSpan>1))return v=!1,!0});const A=[];A.push({id:"insertRowAbove",icon:"iconBefore",label:window.siyuan.languages.insertRowAbove,accelerator:window.siyuan.config.keymap.editor.table.insertRowAbove.custom,click:()=>{insertRowAbove(e,n,a,t)}}),(!y||y&&!h&&_)&&A.push({id:"insertRowBelow",icon:"iconAfter",label:window.siyuan.languages.insertRowBelow,accelerator:window.siyuan.config.keymap.editor.table.insertRowBelow.custom,click:()=>{insertRow(e,n,a,t)}}),(C||v)&&A.push({id:"insertColumnLeft",icon:"iconInsertLeft",label:window.siyuan.languages.insertColumnLeft,accelerator:window.siyuan.config.keymap.editor.table.insertColumnLeft.custom,click:()=>{insertColumn(e,t,a,"beforebegin",n)}}),(C||k)&&A.push({id:"insertColumnRight",icon:"iconInsertRight",label:window.siyuan.languages.insertColumnRight,accelerator:window.siyuan.config.keymap.editor.table.insertColumnRight.custom,click:()=>{insertColumn(e,t,a,"afterend",n)}}),c.push(...A);const L=[];((!u||u&&!f&&g)&&(!p||p&&!b&&m)||(!u||u&&!f&&g)&&(!y||y&&!h&&_)||C&&v||C&&k)&&L.push({id:"separator_2",type:"separator"}),(!u||u&&!f&&g)&&(!p||p&&!b&&m)&&L.push({id:"moveToUp",icon:"iconUp",label:window.siyuan.languages.moveToUp,accelerator:window.siyuan.config.keymap.editor.table.moveToUp.custom,click:()=>{moveRowToUp(e,n,a,t)}}),(!u||u&&!f&&g)&&(!y||y&&!h&&_)&&L.push({id:"moveToDown",icon:"iconDown",label:window.siyuan.languages.moveToDown,accelerator:window.siyuan.config.keymap.editor.table.moveToDown.custom,click:()=>{moveRowToDown(e,n,a,t)}}),C&&v&&L.push({id:"moveToLeft",icon:"iconLeft",label:window.siyuan.languages.moveToLeft,accelerator:window.siyuan.config.keymap.editor.table.moveToLeft.custom,click:()=>{moveColumnToLeft(e,n,a,t)}}),C&&k&&L.push({id:"moveToRight",icon:"iconRight",label:window.siyuan.languages.moveToRight,accelerator:window.siyuan.config.keymap.editor.table.moveToRight.custom,click:()=>{moveColumnToRight(e,n,a,t)}}),c.push(...L),(a.parentElement.parentElement.tagName!=="THEAD"&&(!u&&!f||u&&!f&&g)||C)&&c.push({type:"separator"});const x=[];return a.parentElement.parentElement.tagName!=="THEAD"&&(!u&&!f||u&&!f&&g)&&x.push({id:"deleteRow",icon:"iconDeleteRow",label:window.siyuan.languages["delete-row"],accelerator:window.siyuan.config.keymap.editor.table["delete-row"].custom,click:()=>{deleteRow(e,n,a,t)}}),C&&x.push({id:"deleteColumn",icon:"iconDeleteColumn",label:window.siyuan.languages["delete-column"],accelerator:window.siyuan.config.keymap.editor.table["delete-column"].custom,click:()=>{deleteColumn(e,n,t,a)}}),c.push(...x),{menus:c,removeMenus:x,insertMenus:A,otherMenus:i,other2Menus:L}},Hu=(e,t,a,n,o=!0)=>{if(t.getAttribute("data-type")==="NodeListItem"&&t.childElementCount<4||t.getAttribute("data-type")==="NodeThematicBreak")return-1;const i=t.getAttribute("fold")==="1";if(i){if(typeof a=="boolean"&&!a)return-1;t.removeAttribute("fold"),t.querySelectorAll(".protyle-linenumber__rows").forEach(l=>{lineNumberRender(l.parentElement)})}else{if(typeof a=="boolean"&&a)return-1;if(t.setAttribute("fold","1"),getSelection().rangeCount>0){const l=getSelection().getRangeAt(0),r=hasClosestBlock(l.startContainer);r&&r.getBoundingClientRect().width===0&&focusBlock(t,void 0,!1)}t.querySelectorAll(".img--select, .av__cell--select, .av__cell--active, .av__row--select").forEach(l=>{var r;l.classList.contains("av__row--select")?(l.classList.remove("av__row--select"),l.querySelector(".av__firstcol use").setAttribute("xlink:href","#iconUncheck"),updateHeader(l)):((r=l.querySelector(".av__drag-fill"))==null||r.remove(),l.classList.remove("img--select","av__cell--select","av__cell--active"))})}const s=t.getAttribute("data-node-id");return t.getAttribute("data-type")==="NodeHeading"?i?(o&&t.insertAdjacentHTML("beforeend",'<div spin="1" style="text-align: center"><img width="24px" height="24px" src="/stage/loading-pure.svg"></div>'),transaction(e,[{action:"unfoldHeading",id:s,data:n?"remove":void 0}],[{action:"foldHeading",id:s}])):(transaction(e,[{action:"foldHeading",id:s}],[{action:"unfoldHeading",id:s}]),removeFoldHeading(t)):transaction(e,[{action:"setAttrs",id:s,data:JSON.stringify({fold:i?"":"1"})}],[{action:"setAttrs",id:s,data:JSON.stringify({fold:i?"1":""})}]),preventScroll(e),i?0:1},zo=(e,t,a,n)=>{var o,i,s,l,r,c,d;preventScroll(e);const u=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if((u==null?void 0:u.length)>0){const k=[],v=[];let A,L=!1;n==="Backspace"?(A=u[0].previousElementSibling,A||(L=!0,A=u[u.length-1].nextElementSibling)):(A=u[u.length-1].nextElementSibling,L=!0,A||(L=!1,A=u[0].previousElementSibling));let x,T;hideElements(["select"],e);let M;if(u.find(I=>{const D=getTopAloneElement(I);T=D.parentElement;const N=D.getAttribute("data-node-id");if(k.push({action:"delete",id:N}),n==="Backspace"?(A=getPreviousBlock(D),A||(L=!0,A=getNextBlock(D))):(A=getNextBlock(D),L=!0,A||(L=!1,A=getPreviousBlock(D))),A||(A=D.parentElement||e.wysiwyg.element.firstElementChild,L=!1),D.getAttribute("data-type")==="NodeHeading"&&D.getAttribute("fold")==="1"){setFold(e,D,void 0,!0);let H=D.previousElementSibling?D.previousElementSibling.getAttribute("data-node-id"):"";typeof M!="undefined"&&(H=M),v.push({action:"insert",data:D.outerHTML,id:N,previousID:H,parentID:D.parentElement.getAttribute("data-node-id")||e.block.parentID});let P=getPreviousBlock(D);for(;P&&P.childElementCount===3;)P=getPreviousBlock(P);P?M=P.getAttribute("data-node-id"):M="",D.firstElementChild.removeAttribute("contenteditable");const ne=D.nextElementSibling;if(ne){const U=ne.getAttribute("data-type");if(U!=="NodeHeading"||U==="NodeHeading"&&ne.getAttribute("data-subtype")>D.getAttribute("data-subtype"))return!0}}else{let H=D.outerHTML;(D.classList.contains("render-node")||D.querySelector("div.render-node"))&&(H=e.lute.SpinBlockDOM(D.outerHTML));let P=D.previousElementSibling?D.previousElementSibling.getAttribute("data-node-id"):"";typeof M!="undefined"&&(P=M),v.push({action:"insert",data:H,id:N,previousID:P,parentID:D.parentElement.getAttribute("data-node-id")||e.block.parentID}),D.getAttribute("data-subtype")==="o"&&D.classList.contains("li")?x=D.parentElement:x=void 0,D.remove()}}),A)if(e.block.showAll&&A.classList.contains("protyle-wysiwyg")&&e.wysiwyg.element.childElementCount===0)setTimeout(()=>{zoomOut({protyle:e,id:e.block.parent2ID,focusId:e.block.parent2ID})},Constants.TIMEOUT_INPUT*2+100);else{if(A.classList.contains("protyle-wysiwyg")&&e.wysiwyg.element.childElementCount===0){const I=Lute.NewNodeID(),D=genEmptyElement(!1,!0,I);A.insertAdjacentElement("afterbegin",D),k.push({action:"insert",data:D.outerHTML,id:I,parentID:A.getAttribute("data-node-id")||e.block.parentID}),v.push({action:"delete",id:I}),A=void 0,focusByWbr(D,a)}n!=="Backspace"&&L?focusBlock(A):focusBlock(A,void 0,!1),scrollCenter(e,A),x&&(v.push({action:"update",id:x.getAttribute("data-node-id"),data:x.outerHTML}),updateListOrder(x,1),k.push({action:"update",id:x.getAttribute("data-node-id"),data:x.outerHTML}))}if(k.length>0)if(T&&T.getAttribute("data-type")==="NodeSuperBlock"&&T.childElementCount===2){const I=cancelSB(e,T);transaction(e,k.concat(I.doOperations),I.undoOperations.concat(v.reverse()))}else transaction(e,k,v.reverse());hideElements(["util"],e);return}const g=t.getAttribute("data-type");if(g==="NodeCodeBlock"&&getContenteditableElement(t).textContent.trim()===""){t.classList.add("protyle-wysiwyg--select"),zo(e,t,a,n);return}if(!t.previousElementSibling&&t.parentElement.getAttribute("data-type")==="NodeBlockquote"){a.insertNode(document.createElement("wbr"));const k=t.parentElement;k.insertAdjacentElement("beforebegin",t),k.childElementCount===1?(transaction(e,[{action:"move",id:t.getAttribute("data-node-id"),previousID:(o=t.previousElementSibling)==null?void 0:o.getAttribute("data-node-id"),parentID:k.parentElement.getAttribute("data-node-id")||e.block.parentID},{action:"delete",id:k.getAttribute("data-node-id")}],[{action:"insert",id:k.getAttribute("data-node-id"),data:k.outerHTML,previousID:(i=t.previousElementSibling)==null?void 0:i.getAttribute("data-node-id"),parentID:k.parentElement.getAttribute("data-node-id")||e.block.parentID},{action:"move",id:t.getAttribute("data-node-id"),parentID:k.getAttribute("data-node-id")}]),k.remove()):transaction(e,[{action:"move",id:t.getAttribute("data-node-id"),previousID:(s=t.previousElementSibling)==null?void 0:s.getAttribute("data-node-id"),parentID:k.parentElement.getAttribute("data-node-id")||e.block.parentID}],[{action:"move",id:t.getAttribute("data-node-id"),parentID:k.getAttribute("data-node-id")}]),focusByWbr(t,a);return}if(t.parentElement.classList.contains("li")&&t.getAttribute("data-type")!=="NodeHeading"&&t.previousElementSibling.classList.contains("protyle-action")){Zo(e,t,a,n==="Delete");return}const f=getPreviousBlock(t);if(["NodeCodeBlock","NodeTable","NodeAttributeView"].includes(g)){if(f)if(f.classList.contains("p")&&getContenteditableElement(f).textContent===""){const k=getPreviousBlock(f);transaction(e,[{action:"delete",id:f.getAttribute("data-node-id")}],[{action:"insert",data:f.outerHTML,id:f.getAttribute("data-node-id"),parentID:f.parentElement.getAttribute("data-node-id")||e.block.parentID,previousID:k&&(!f.previousElementSibling||!f.previousElementSibling.classList.contains("protyle-action"))?k.getAttribute("data-node-id"):void 0}]),f.remove()}else focusBlock(f,void 0,!1);return}if(g==="NodeHeading"){turnsIntoTransaction({protyle:e,selectsElement:[t],type:"Blocks2Ps",range:un(t,a,n==="Delete")});return}if(t.previousElementSibling&&t.previousElementSibling.classList.contains("protyle-breadcrumb__bar"))return;if(!f){if(e.wysiwyg.element.childElementCount>1&&getContenteditableElement(t).textContent===""){focusBlock(e.wysiwyg.element.firstElementChild.nextElementSibling);const k=getTopAloneElement(t);transaction(e,[{action:"delete",id:k.getAttribute("data-node-id")}],[{action:"insert",data:k.outerHTML,id:k.getAttribute("data-node-id"),parentID:e.block.parentID}]),k.remove()}return}const p=t.parentElement,m=getContenteditableElement(t),b=getLastBlock(f);if(a.toString()===""&&isMobile()&&b&&b.classList.contains("hr")&&getSelectionOffset(m).start===0){transaction(e,[{action:"delete",id:b.getAttribute("data-node-id")}],[{action:"insert",data:b.outerHTML,id:b.getAttribute("data-node-id"),previousID:(l=b.previousElementSibling)==null?void 0:l.getAttribute("data-node-id"),parentID:b.parentElement.getAttribute("data-node-id")}]),b.remove();return}const w=b&&(b.classList.contains("table")||b.classList.contains("render-node")||b.classList.contains("iframe")||b.classList.contains("hr")||b.classList.contains("av")||b.classList.contains("code-block")),y=b.getAttribute("data-node-id");if(w){if(b.classList.contains("code-block")){if(m.textContent.trim()===""){const k=t.getAttribute("data-node-id"),v=[{action:"delete",id:k}],A=[{action:"insert",data:t.outerHTML,id:k,previousID:(r=t.previousElementSibling)==null?void 0:r.getAttribute("data-node-id"),parentID:t.parentElement.getAttribute("data-node-id")}];if(t.remove(),p.getAttribute("data-type")==="NodeSuperBlock"&&p.childElementCount===2){const L=cancelSB(e,p);transaction(e,v.concat(L.doOperations),L.undoOperations.concat(A))}else transaction(e,v,A);focusBlock(e.wysiwyg.element.querySelector(`[data-node-id="${y}"]`),void 0,!1)}else focusBlock(b,void 0,!1);return}if(m.textContent!==""||t.classList.contains("av")){focusBlock(b,void 0,!1);return}}const _=getTopEmptyElement(t),h=_.getAttribute("data-node-id");a.insertNode(document.createElement("wbr"));const E=[{action:"update",data:b.outerHTML,id:y},{action:"insert",data:_.outerHTML,id:h,previousID:(c=t.previousElementSibling)==null?void 0:c.getAttribute("data-node-id"),parentID:p.getAttribute("data-node-id")}],C=[{action:"delete",id:h}];if(w)_.remove(),focusBlock(b,void 0,!1),E.splice(0,1);else{const k=getContenteditableElement(b);if(m&&(m.textContent!==""||m.querySelector(".emoji"))&&(a.setEndAfter(m.lastChild),(((d=k==null?void 0:k.lastElementChild)==null?void 0:d.getAttribute("data-type"))||"").indexOf("inline-math")>-1)){const L=hasNextSibling(k==null?void 0:k.lastElementChild);L&&L.textContent===`
`&&L.remove()}const v=e.contentElement.scrollTop,A=a.extractContents();a.selectNodeContents(k),a.collapse(!1),a.insertNode(A),_.remove(),e.contentElement.scrollTop=v,e.scroll.lastScrollTop=v-1,C.push({action:"update",data:b.outerHTML,id:y})}if(p.getAttribute("data-type")==="NodeSuperBlock"&&p.childElementCount===2){const k=cancelSB(e,p);transaction(e,C.concat(k.doOperations),k.undoOperations.concat(E))}else transaction(e,C,E);focusByWbr(e.wysiwyg.element,a)},un=(e,t,a)=>{if(a){const n=getPreviousBlock(e);if(n){const o=getContenteditableElement(getLastBlock(n));if(o)return setLastNodeRange(o,t,!1)}}},Nu=(e,t,a,n)=>{const o=t.outerHTML,i=hasPreviousSibling(e);i&&i.textContent.endsWith(Constants.ZWSP)&&(i.textContent=i.textContent.substring(0,i.textContent.length-1));const s=hasNextSibling(e);s&&s.textContent.startsWith(Constants.ZWSP)&&(s.textContent=s.textContent.replace(Constants.ZWSP,"")),e.insertAdjacentHTML("afterend","<wbr>"),e.remove(),updateTransaction(n,t.getAttribute("data-node-id"),t.outerHTML,o),focusByWbr(t,a);const l=getContenteditableElement(t);l.innerHTML.trim()===""&&(l.innerHTML="")},Zo=(e,t,a,n=!1)=>{var o;if(!t.parentElement.previousElementSibling&&t.parentElement.nextElementSibling&&t.parentElement.nextElementSibling.classList.contains("protyle-attr")){listOutdent(e,[t.parentElement],a,n,t);return}if(!t.parentElement.previousElementSibling&&t.parentElement.parentElement.parentElement.classList.contains("list")){a.insertNode(document.createElement("wbr"));const g=t.parentElement.parentElement,f=g.outerHTML,p=t.parentElement.parentElement.previousElementSibling.lastElementChild,m=p.parentElement.outerHTML;t.parentElement.firstElementChild.remove(),t.parentElement.lastElementChild.remove(),p.insertAdjacentHTML("beforebegin",t.parentElement.innerHTML),t.parentElement.remove(),g.getAttribute("data-subtype")==="o"&&updateListOrder(g),transaction(e,[{action:"update",id:g.getAttribute("data-node-id"),data:g.outerHTML},{action:"update",data:p.parentElement.outerHTML,id:p.parentElement.getAttribute("data-node-id")}],[{action:"update",data:m,id:p.parentElement.getAttribute("data-node-id")},{action:"update",data:f,id:g.getAttribute("data-node-id")}]),focusByWbr(p.parentElement,a);return}if(!t.parentElement.previousElementSibling){if(t.parentElement.parentElement.classList.contains("protyle-wysiwyg"))return;un(t,a,n),a.insertNode(document.createElement("wbr"));const g=t.parentElement.parentElement,f=g.outerHTML;t.parentElement.firstElementChild.remove(),t.parentElement.lastElementChild.remove();const p=document.createElement("div");p.innerHTML=t.parentElement.innerHTML;const m=[],b=[];if(Array.from(p.children).forEach((w,y)=>{var _;m.push({action:"insert",id:w.getAttribute("data-node-id"),data:w.outerHTML,previousID:y===0?(_=g.previousElementSibling)==null?void 0:_.getAttribute("data-node-id"):m[y-1].id,parentID:g.parentElement.getAttribute("data-node-id")||e.block.parentID}),b.push({action:"delete",id:w.getAttribute("data-node-id")})}),g.insertAdjacentHTML("beforebegin",t.parentElement.innerHTML),t.parentElement.remove(),g.getAttribute("data-subtype")==="o"&&updateListOrder(g,parseInt(g.firstElementChild.getAttribute("data-marker"))-1),m.splice(0,0,{action:"update",id:g.getAttribute("data-node-id"),data:g.outerHTML}),b.push({action:"update",data:f,id:g.getAttribute("data-node-id")}),transaction(e,m,b),g.parentElement.classList.contains("sb")&&g.parentElement.getAttribute("data-sb-layout")==="col"){const w=[];let y=g;for(;y&&(w.push(y),b[0].id!==y.getAttribute("data-node-id"));)y=y.previousElementSibling;turnsIntoOneTransaction({protyle:e,selectsElement:w.reverse(),type:"BlocksMergeSuperBlock",level:"row"})}focusByWbr(e.wysiwyg.element,a);return}const i=t.parentElement;if(i.previousElementSibling&&i.previousElementSibling.classList.contains("protyle-breadcrumb__bar"))return;const s=i.getAttribute("data-node-id"),l=i.parentElement;un(t,a,n),a.insertNode(document.createElement("wbr"));const r=l.outerHTML,c=[],d=[{action:"insert",id:s,data:"",previousID:i.previousElementSibling.getAttribute("data-node-id")}],u=i.previousElementSibling.lastElementChild;if(i.previousElementSibling.getAttribute("fold")==="1")if(getContenteditableElement(t).textContent.trim()===""&&t.nextElementSibling.classList.contains("protyle-attr"))c.push({action:"delete",id:s}),d[0].data=i.outerHTML,setLastNodeRange(getContenteditableElement(i.previousElementSibling),a),a.collapse(!0),i.remove();else{setLastNodeRange(getContenteditableElement(i.previousElementSibling),a),a.collapse(!0),focusByRange(a),(o=t.querySelector("wbr"))==null||o.remove();return}else{let g=u.previousElementSibling.getAttribute("data-node-id");Array.from(t.parentElement.children).forEach((f,p)=>{if(f.classList.contains("protyle-action")||f.classList.contains("protyle-attr"))return;const m=f.getAttribute("data-node-id");c.push({action:"move",id:m,previousID:g}),d.push({action:"move",id:m,previousID:p===1?void 0:g,parentID:s}),g=m,u.before(f)}),c.push({action:"delete",id:s}),d[0].data=i.outerHTML,i.remove()}l.classList.contains("protyle-wysiwyg")?transaction(e,c,d):(l.getAttribute("data-subtype")==="o"&&updateListOrder(l),updateTransaction(e,l.getAttribute("data-node-id"),l.outerHTML,r)),focusByWbr(u.parentElement,a)},Ve=(e,t)=>{if(e.getAttribute("data-subtype")!=="o")return;let a;Array.from(e.children).forEach((n,o)=>{o===0?t?(a=t,n.setAttribute("data-marker",a+"."),n.querySelector(".protyle-action--order").textContent=a+"."):a=parseInt(n.getAttribute("data-marker")):n.classList.contains("li")&&(a++,n.setAttribute("data-marker",a+"."),n.querySelector(".protyle-action--order").textContent=a+".")})},Xo=(e,t=0,a=!1)=>{const n=document.createElement("template"),o=e.getAttribute("data-subtype");if(o==="o"){const i=parseInt(e.getAttribute("data-marker"))+t;n.innerHTML=`<div data-marker="${i+1}." data-subtype="${o}" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div contenteditable="false" class="protyle-action protyle-action--order" draggable="true">${i+1}.</div>${genEmptyBlock(!1,a)}<div class="protyle-attr" contenteditable="false"></div></div>`}else o==="t"?n.innerHTML=`<div data-marker="*" data-subtype="${o}" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#iconUncheck"></use></svg></div>${genEmptyBlock(!1,a)}<div class="protyle-attr" contenteditable="false"></div></div>`:n.innerHTML=`<div data-marker="*" data-subtype="${o}" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div class="protyle-action" draggable="true"><svg><use xlink:href="#iconDot"></use></svg></div>${genEmptyBlock(!1,a)}<div class="protyle-attr" contenteditable="false"></div></div>`;return n.content.firstElementChild},Bu=(e,t,a)=>{var n;const o=hasClosestByClassName(t,"li");if(!o)return;const i=(n=o.querySelector(".list"))==null?void 0:n.lastElementChild.previousElementSibling;if(!i)return;const s=Xo(i,0,!0),l=s.getAttribute("data-node-id");i.after(s),i.parentElement.getAttribute("fold")==="1"&&setFold(e,i.parentElement,!0),o.getAttribute("fold")==="1"&&setFold(e,o,!0),transaction(e,[{action:"insert",id:l,data:s.outerHTML,previousID:i.getAttribute("data-node-id")}],[{action:"delete",id:l}]),focusByWbr(s,a)},Pu=(e,t,a)=>{if(t.forEach(i=>{i.removeAttribute("select-start"),i.removeAttribute("select-end")}),!t[0].classList.contains("li"))if(t[0].parentElement.childElementCount===t.length+2)t=[t[0].parentElement];else return;const n=t[0].previousElementSibling;if(!n)return;a.collapse(!1),a.insertNode(document.createElement("wbr"));const o=n.parentElement.outerHTML;if(n.lastElementChild.previousElementSibling.getAttribute("data-type")==="NodeList"){const i=n.lastElementChild.previousElementSibling.outerHTML,s=[],l=[],r=n.lastElementChild.previousElementSibling.getAttribute("data-subtype");let c=n.lastElementChild.previousElementSibling.lastElementChild.previousElementSibling.getAttribute("data-node-id");t.forEach((d,u)=>{s.push({action:"move",id:d.getAttribute("data-node-id"),previousID:c}),l.push({action:"move",id:d.getAttribute("data-node-id"),previousID:u===0?n.getAttribute("data-node-id"):c}),c=d.getAttribute("data-node-id"),d.setAttribute("data-subtype",r);const g=d.querySelector(".protyle-action");r==="o"?(g.classList.add("protyle-action--order"),g.classList.remove("protyle-action--task"),n.lastElementChild.previousElementSibling.lastElementChild.before(d)):r==="t"?(d.setAttribute("data-marker","*"),g.innerHTML=`<svg><use xlink:href="#icon${d.classList.contains("protyle-task--done")?"Check":"Uncheck"}"></use></svg>`,g.classList.remove("protyle-action--order"),g.classList.add("protyle-action--task"),n.lastElementChild.previousElementSibling.lastElementChild.before(d)):(d.setAttribute("data-marker","*"),g.innerHTML='<svg><use xlink:href="#iconDot"></use></svg>',g.classList.remove("protyle-action--order","protyle-action--task"),n.lastElementChild.previousElementSibling.lastElementChild.before(d))}),r==="o"?(Ve(n.lastElementChild.previousElementSibling),Ve(n.parentElement)):n.getAttribute("data-subtype")==="o"&&Ve(n.parentElement),n.parentElement.classList.contains("protyle-wysiwyg")&&(s.push({action:"update",data:n.lastElementChild.previousElementSibling.outerHTML,id:n.lastElementChild.previousElementSibling.getAttribute("data-node-id")}),l.push({action:"update",data:i,id:n.lastElementChild.previousElementSibling.getAttribute("data-node-id")}),transaction(e,s,l))}else{const i=n.outerHTML,s=t[0].getAttribute("data-subtype"),l=document.createElement("div"),r=Lute.NewNodeID();l.setAttribute("data-node-id",r),l.setAttribute("data-type","NodeList"),l.setAttribute("class","list"),l.setAttribute("data-subtype",s),l.innerHTML='<div class="protyle-attr" contenteditable="false"></div>';const c=[{action:"insert",data:l.outerHTML,id:r,previousID:n.lastElementChild.previousElementSibling.getAttribute("data-node-id")}];n.lastElementChild.before(l);const d=[];let u;t.forEach((g,f)=>{c.push({action:"move",id:g.getAttribute("data-node-id"),parentID:r,previousID:u}),d.push({action:"move",id:g.getAttribute("data-node-id"),previousID:f===0?n.getAttribute("data-node-id"):u}),u=g.getAttribute("data-node-id"),l.lastElementChild.before(g)}),d.push({action:"delete",id:r}),s==="o"&&(Ve(l,1),Ve(n.parentElement)),n.parentElement.classList.contains("protyle-wysiwyg")&&(c.push({action:"update",data:n.outerHTML,id:n.getAttribute("data-node-id")}),d.push({action:"update",data:i,id:n.getAttribute("data-node-id")}),transaction(e,c,d))}n.parentElement.classList.contains("protyle-wysiwyg")||updateTransaction(e,n.parentElement.getAttribute("data-node-id"),n.parentElement.outerHTML,o),focusByWbr(n,a)},Ru=(e,t,a)=>{var n,o;const i=t.parentElement,s=i.getAttribute("data-node-id"),l=[],r=[];a.insertNode(document.createElement("wbr"));const c=Lute.NewNodeID();let d="",u=0;Array.from(i.parentElement.children).forEach(f=>{!u&&f.isSameNode(i)?u=1:u&&!f.classList.contains("protyle-attr")&&(r.push({id:f.getAttribute("data-node-id"),action:"move",previousID:s}),l.push({id:f.getAttribute("data-node-id"),action:"delete"}),f.getAttribute("data-subtype")==="o"&&(r.push({id:f.getAttribute("data-node-id"),action:"update",data:f.outerHTML}),f.setAttribute("data-marker",u+"."),f.firstElementChild.innerHTML=u+"."),d+=f.outerHTML,f.remove(),u++)}),r.reverse(),d=`<div data-subtype="${i.getAttribute("data-subtype")}" data-node-id="${c}" data-type="NodeList" class="list" updated="${dayjs().format("YYYYMMDDHHmmss")}">${d}<div class="protyle-attr" contenteditable="false">${Constants.ZWSP}</div></div>`,i.parentElement.insertAdjacentHTML("afterend",d),l.push({id:c,action:"insert",previousID:i.parentElement.getAttribute("data-node-id"),data:d}),r.push({id:c,action:"delete"}),Array.from(i.children).reverse().forEach(f=>{!f.classList.contains("protyle-action")&&!f.classList.contains("protyle-attr")&&(l.push({id:f.getAttribute("data-node-id"),action:"move",previousID:i.parentElement.getAttribute("data-node-id")}),r.push({id:f.getAttribute("data-node-id"),action:"move",parentID:s}),i.parentElement.after(f))});const g=i.parentElement.getAttribute("data-node-id");i.parentElement.childElementCount===2?(r.splice(0,0,{id:g,action:"insert",data:i.parentElement.outerHTML,previousID:(n=i.parentElement.previousElementSibling)==null?void 0:n.getAttribute("data-node-id"),parentID:i.parentElement.parentElement.getAttribute("data-node-id")||e.block.rootID}),i.parentElement.remove(),l.push({id:g,action:"delete"})):(r.splice(0,0,{id:s,action:"insert",data:i.outerHTML,previousID:(o=i.previousElementSibling)==null?void 0:o.getAttribute("data-node-id"),parentID:g}),i.remove(),l.push({id:s,action:"delete"})),transaction(e,l,r),focusByWbr(e.wysiwyg.element,a)},Ou=(e,t,a,n=!1,o)=>{var i,s,l,r,c,d,u,g;if(t.forEach(v=>{v.removeAttribute("select-start"),v.removeAttribute("select-end")}),!t[0].classList.contains("li"))if(t[0].parentElement.childElementCount===t.length+2)t=[t[0].parentElement];else return;const f=t[0].parentElement,p=f.getAttribute("data-node-id");if(!p)return;const m=f.parentElement,b=m.parentElement;if((i=f.previousElementSibling)!=null&&i.classList.contains("protyle-action")&&!b.getAttribute("data-node-id"))return;if(m.classList.contains("protyle-wysiwyg")||m.classList.contains("sb")||m.classList.contains("bq")){const v=[],A=[];a.collapse(!1),moveToPrevious(o,a,n),a.insertNode(document.createElement("wbr"));let L;!t[0].previousElementSibling&&f.getAttribute("data-subtype")==="o"&&(L=parseInt(t[0].getAttribute("data-marker")));let x=p,T=f,M=t[t.length-1].nextElementSibling,I=t[t.length-1].lastElementChild.previousElementSibling;if(t.forEach(N=>{Array.from(N.children).forEach((H,P)=>{const ne=H.getAttribute("data-node-id");ne&&(v.push({action:"move",id:ne,previousID:x,parentID:m.getAttribute("data-node-id")||e.block.parentID}),A.push({action:"move",id:ne,previousID:P===1?void 0:x,parentID:N.getAttribute("data-node-id"),data:H.contains(a.startContainer)?"focus":""}),x=ne,T.after(H),T=H)})}),!window.siyuan.config.editor.listLogicalOutdent&&!M.classList.contains("protyle-attr")){let N;I.getAttribute("data-subtype")!==M.getAttribute("data-subtype")&&(N=Lute.NewNodeID(),I=document.createElement("div"),I.classList.add("list"),I.setAttribute("data-subtype",M.getAttribute("data-subtype")),I.setAttribute("data-node-id",N),I.setAttribute("data-type","NodeList"),I.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),I.innerHTML=`<div class="protyle-attr" contenteditable="false">${Constants.ZWSP}</div>`,T.after(I),v.push({action:"insert",id:N,data:I.outerHTML,previousID:T.getAttribute("data-node-id")}));let H;for(;M&&!M.classList.contains("protyle-attr");){v.push({action:"move",id:M.getAttribute("data-node-id"),previousID:H||((s=I.lastElementChild.previousElementSibling)==null?void 0:s.getAttribute("data-node-id")),parentID:I.getAttribute("data-node-id")}),A.push({action:"move",id:M.getAttribute("data-node-id"),parentID:I.getAttribute("data-node-id"),previousID:H||((l=M.previousElementSibling)==null?void 0:l.getAttribute("data-node-id"))}),H=M.getAttribute("data-node-id");const P=M;M=M.nextElementSibling,I.lastElementChild.before(P)}I.getAttribute("data-subtype")==="o"&&(Array.from(I.children).forEach(P=>{const ne=P.getAttribute("data-node-id");ne&&A.push({action:"update",id:ne,data:P.outerHTML})}),Ve(I,1),Array.from(I.children).forEach(P=>{const ne=P.getAttribute("data-node-id");ne&&v.push({action:"update",id:ne,data:P.outerHTML})})),N&&A.push({action:"delete",id:N})}const D=f.outerHTML;t.forEach(N=>{N.remove()}),f.childElementCount===1?(v.push({action:"delete",id:p}),p===e.block.id&&(e.block.id=e.block.parentID),A.splice(0,0,{action:"insert",data:D,id:p,previousID:(r=f.previousElementSibling)==null?void 0:r.getAttribute("data-node-id"),parentID:m.getAttribute("data-node-id")||e.block.parentID}),f.remove()):(f.getAttribute("data-subtype")==="o"&&Ve(f,L),v.push({action:"update",id:p,data:f.outerHTML}),A.splice(0,0,{action:"update",id:p,data:D})),transaction(e,v,A),f.childElementCount!==1&&m.classList.contains("sb")&&m.getAttribute("data-sb-layout")==="col"&&turnsIntoOneTransaction({protyle:e,selectsElement:[f,f.nextElementSibling],type:"BlocksMergeSuperBlock",level:"row"}),focusByWbr(m,a);return}if(f.childElementCount===2&&m.childElementCount===3){a.collapse(!1),moveToPrevious(o,a,n),a.insertNode(document.createElement("wbr"));const v=m.outerHTML;t[0].firstElementChild.remove(),t[0].lastElementChild.remove(),f.outerHTML=t[0].innerHTML,updateTransaction(e,m.getAttribute("data-node-id"),m.outerHTML,v),focusByWbr(m,a);return}a.collapse(!1),moveToPrevious(o,a,n),a.insertNode(document.createElement("wbr"));const w=[],y=[],_=(c=t[0].previousElementSibling)==null?void 0:c.getAttribute("data-node-id");let h;!t[0].previousElementSibling&&f.getAttribute("data-subtype")==="o"&&(h=parseInt(t[0].getAttribute("data-marker")));const E=m.parentElement.outerHTML;let C=t[t.length-1].nextElementSibling,k=t[t.length-1].lastElementChild.previousElementSibling;if(t.reverse().forEach(v=>{const A=v.getAttribute("data-node-id");w.push({action:"move",id:A,previousID:m.getAttribute("data-node-id")}),y.push({action:"move",id:A,previousID:_,parentID:f.getAttribute("data-node-id")}),m.after(v),(v.getAttribute("data-subtype")==="o"||v.getAttribute("data-subtype")==="t")&&m.getAttribute("data-subtype")==="u"?(y.push({action:"update",id:A,data:v.outerHTML}),v.querySelector(".protyle-action").outerHTML='<div class="protyle-action" draggable="true"><svg><use xlink:href="#iconDot"></use></svg></div>',v.setAttribute("data-subtype","u"),v.setAttribute("data-marker","*"),v.classList.remove("protyle-task--done"),w.push({action:"update",id:A,data:v.outerHTML})):(v.getAttribute("data-subtype")==="u"||v.getAttribute("data-subtype")==="t")&&m.getAttribute("data-subtype")==="o"?(y.push({action:"update",id:A,data:v.outerHTML}),v.querySelector(".protyle-action").outerHTML='<div contenteditable="false" draggable="true" class="protyle-action protyle-action--order">1.</div>',v.setAttribute("data-subtype","o"),v.setAttribute("data-marker","1."),w.push({action:"update",id:A,data:v.outerHTML})):(v.getAttribute("data-subtype")==="u"||v.getAttribute("data-subtype")==="o")&&m.getAttribute("data-subtype")==="t"&&(y.push({action:"update",id:A,data:v.outerHTML}),v.querySelector(".protyle-action").outerHTML='<div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#iconUncheck"></use></svg></div>',v.setAttribute("data-subtype","t"),v.setAttribute("data-marker","*"),w.push({action:"update",id:A,data:v.outerHTML}))}),!window.siyuan.config.editor.listLogicalOutdent&&!C.classList.contains("protyle-attr")){let v;k.classList.contains("list")||(v=Lute.NewNodeID(),k=document.createElement("div"),k.classList.add("list"),k.setAttribute("data-subtype",C.getAttribute("data-subtype")),k.setAttribute("data-node-id",v),k.setAttribute("data-type","NodeList"),k.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),k.innerHTML=`<div class="protyle-attr" contenteditable="false">${Constants.ZWSP}</div>`,w.push({action:"insert",id:v,data:k.outerHTML,previousID:t[0].lastElementChild.previousElementSibling.getAttribute("data-node-id")}),t[0].lastElementChild.before(k));let A;for(;C&&!C.classList.contains("protyle-attr");){const L=C.getAttribute("data-node-id");C.getAttribute("data-subtype")!==k.getAttribute("data-subtype")&&(y.push({action:"update",id:L,data:C.outerHTML}),C.querySelector(".protyle-action").outerHTML=k.querySelector(".protyle-action").outerHTML,C.setAttribute("data-subtype",k.getAttribute("data-subtype")),C.setAttribute("data-marker",k.getAttribute("data-marker")),w.push({action:"update",id:L,data:C.outerHTML})),w.push({action:"move",id:L,previousID:A||((d=k.lastElementChild.previousElementSibling)==null?void 0:d.getAttribute("data-node-id")),parentID:k.getAttribute("data-node-id")}),y.push({action:"move",id:L,previousID:A||((u=k.parentElement)==null?void 0:u.getAttribute("data-node-id"))}),A=L;const x=C;C=C.nextElementSibling,k.lastElementChild.before(x)}k.getAttribute("data-subtype")==="o"&&(Array.from(k.children).forEach(L=>{const x=L.getAttribute("data-node-id");x&&y.push({action:"update",id:x,data:L.outerHTML})}),Ve(k,1),Array.from(k.children).forEach(L=>{const x=L.getAttribute("data-node-id");x&&w.push({action:"update",id:x,data:L.outerHTML})})),v&&y.push({action:"delete",id:v})}if(!window.siyuan.config.editor.listLogicalOutdent&&f.nextElementSibling){C=f.nextElementSibling;let v;for(;C&&!C.classList.contains("protyle-attr");){const A=C.getAttribute("data-node-id");w.push({action:"move",id:A,previousID:v||k.getAttribute("data-node-id")}),y.push({action:"move",id:A,previousID:v||f.getAttribute("data-node-id")}),v=A;const L=C;C=C.nextElementSibling,k.after(L),k=L}}f.childElementCount===1&&m.childElementCount===3?(w.push({action:"delete",id:m.getAttribute("data-node-id")}),y.splice(0,0,{action:"insert",id:m.getAttribute("data-node-id"),data:m.outerHTML,previousID:(g=m.previousElementSibling)==null?void 0:g.getAttribute("data-node-id"),parentID:m.parentElement.getAttribute("data-node-id")}),m.remove()):f.childElementCount===1?(w.push({action:"delete",id:f.getAttribute("data-node-id")}),y.splice(0,0,{action:"insert",id:f.getAttribute("data-node-id"),data:f.outerHTML,previousID:f.previousElementSibling.getAttribute("data-node-id")}),f.remove()):f.getAttribute("data-subtype")==="o"&&(y.splice(0,0,{action:"update",data:f.outerHTML,id:f.getAttribute("data-node-id")}),Ve(f,h),w.push({action:"update",data:f.outerHTML,id:f.getAttribute("data-node-id")})),b.classList.contains("protyle-wysiwyg")?transaction(e,w,y):(m&&m.getAttribute("data-subtype")==="o"&&Ve(b),updateTransaction(e,b.getAttribute("data-node-id"),b.outerHTML,E)),focusByWbr(b,a)},qu=(e,t)=>{const a=[],n=[];let o=t.previousElementSibling?t.previousElementSibling.getAttribute("data-node-id"):void 0;t.classList.remove("protyle-wysiwyg--select"),t.removeAttribute("select-start"),t.removeAttribute("select-end");const i=t.getAttribute("data-node-id"),s=t.cloneNode();return s.innerHTML=t.lastElementChild.outerHTML,n.push({action:"insert",id:i,data:s.outerHTML,previousID:t.previousElementSibling?t.previousElementSibling.getAttribute("data-node-id"):void 0,parentID:t.parentElement.getAttribute("data-node-id")||e.block.parentID}),Array.from(t.children).forEach((l,r)=>{if(r===t.childElementCount-1){a.push({action:"delete",id:i}),t.lastElementChild.remove(),t.querySelectorAll("protyle-html").forEach(c=>{c.setAttribute("data-content",c.getAttribute("data-content").replace(/&lt;/g,"<").replace(/&gt;/g,">"))}),t.outerHTML=t.innerHTML;return}a.push({action:"move",id:l.getAttribute("data-node-id"),previousID:o,parentID:t.parentElement.getAttribute("data-node-id")||e.block.parentID}),n.push({action:"move",id:l.getAttribute("data-node-id"),previousID:l.previousElementSibling?l.previousElementSibling.getAttribute("data-node-id"):void 0,parentID:i}),o=l.getAttribute("data-node-id")}),a.forEach(l=>{const r=e.wysiwyg.element.querySelector(`[data-node-id="${l.id}"]`);r&&r.getAttribute("data-type")==="NodeBlockQueryEmbed"&&(r.removeAttribute("data-render"),blockRender(e,r))}),{doOperations:a,undoOperations:n,previousId:o}},Uu=(e,t,a)=>{const n=document.createElement("div");return n.setAttribute("data-node-id",t||Lute.NewNodeID()),n.setAttribute("data-type","NodeSuperBlock"),n.setAttribute("class","sb"),n.setAttribute("data-sb-layout",e),n.innerHTML=a||`<div class="protyle-attr" contenteditable="false">${Constants.ZWSP}</div>`,n},Fu=(e,t,a)=>{fetchPost("/api/block/getBlockSiblingID",{id:t.getAttribute("data-node-id")},n=>{const o=n.data[a];o&&openMobileFileById(e.app,o,o!==e.block.rootID&&e.block.showAll?[Constants.CB_GET_ALL,Constants.CB_GET_FOCUS]:[Constants.CB_GET_FOCUS])})},Yu=(e,t,a)=>{const n=getEditorRange(e.wysiwyg.element);let o;if(a)o=e.wysiwyg.element.querySelector(`[data-node-id="${a}"]`);else{const c=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");c.length>0?(t==="beforebegin"?o=c[0]:o=c[c.length-1],hideElements(["select"],e)):(o=hasClosestBlock(n.startContainer),o=getTopAloneElement(o))}if(!o)return;let i=fn(!1,!0),s=1;o.getAttribute("data-type")==="NodeListItem"&&(i=genListItemElement(o,0,!0),s=parseInt(o.parentElement.firstElementChild.getAttribute("data-marker")));const l=o.parentElement.outerHTML,r=i.getAttribute("data-node-id");if(o.insertAdjacentElement(t,i),o.getAttribute("data-type")==="NodeListItem"&&o.getAttribute("data-subtype")==="o"&&!i.parentElement.classList.contains("protyle-wysiwyg"))updateListOrder(i.parentElement,s),updateTransaction(e,i.parentElement.getAttribute("data-node-id"),i.parentElement.outerHTML,l);else{let c;t==="beforebegin"?c=[{action:"insert",data:i.outerHTML,id:r,nextID:o.getAttribute("data-node-id")}]:c=[{action:"insert",data:i.outerHTML,id:r,previousID:o.getAttribute("data-node-id")}],transaction(e,c,[{action:"delete",id:r}])}o.parentElement.classList.contains("sb")&&o.parentElement.getAttribute("data-sb-layout")==="col"&&turnsIntoOneTransaction({protyle:e,selectsElement:t==="afterend"?[o,o.nextElementSibling]:[o.previousElementSibling,o],type:"BlocksMergeSuperBlock",level:"row"}),focusByWbr(e.wysiwyg.element,n),scrollCenter(e)},Wu=(e=!0,t=!0,a)=>{let n="";return e&&(n=Constants.ZWSP),t&&(n+="<wbr>"),a&&(n+=a),`<div data-node-id="${Lute.NewNodeID()}" data-type="NodeParagraph" class="p"><div contenteditable="true" spellcheck="${window.siyuan.config.editor.spellcheck}">${n}</div><div contenteditable="false" class="protyle-attr">${Constants.ZWSP}</div></div>`},fn=(e=!0,t=!0,a)=>{const n=document.createElement("div");return n.setAttribute("data-node-id",a||Lute.NewNodeID()),n.setAttribute("data-type","NodeParagraph"),n.classList.add("p"),n.innerHTML=`<div contenteditable="true" spellcheck="${window.siyuan.config.editor.spellcheck}">${e?S.ZWSP:""}${t?"<wbr>":""}</div><div class="protyle-attr" contenteditable="false">${S.ZWSP}</div>`,n},ju=e=>{let t=e;switch(e){case"NodeIFrame":t="IFrame";break;case"NodeAttributeView":t=window.siyuan.languages.database;break;case"NodeThematicBreak":t=window.siyuan.languages.line;break;case"NodeWidget":t=window.siyuan.languages.widget;break;case"NodeVideo":t=window.siyuan.languages.video;break;case"NodeAudio":t=window.siyuan.languages.audio;break;case"NodeBlockQueryEmbed":t=window.siyuan.languages.blockEmbed;break}return t},Vu=(e,t,a,n,o)=>{var i;if(t!=="NodeCodeBlock"&&!((i=a.previousElementSibling)!=null&&i.classList.contains("protyle-action--task"))&&(["[ ]","[x]","[X]","\u3010 \u3011","\u3010x\u3011","\u3010X\u3011"].includes(n.innerHTML.substring(0,3))||["[]","\u3010\u3011"].includes(n.innerHTML.substring(0,2)))){const s=n.innerHTML.indexOf("]")+1||n.innerHTML.indexOf("\u3011")+1,l=n.innerHTML.substring(1,2).toLowerCase()==="x";if(a.parentElement.classList.contains("li")&&a.parentElement.childElementCount===3){if(!a.parentElement.parentElement.classList.contains("protyle-wysiwyg")&&a.parentElement.parentElement.childElementCount===2){const r=a.parentElement.parentElement,c=r.outerHTML;return r.setAttribute("data-subtype","t"),r.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),a.parentElement.setAttribute("data-subtype","t"),l&&a.parentElement.classList.add("protyle-task--done"),a.previousElementSibling.outerHTML=`<div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#icon${l?"C":"Unc"}heck"></use></svg></div>`,n.innerHTML=n.innerHTML.substring(s),updateTransaction(e,r.getAttribute("data-node-id"),r.outerHTML,c),focusByWbr(e.wysiwyg.element,o),!0}return!1}else{const r=a.getAttribute("data-node-id"),c=Lute.NewNodeID(),d=Lute.NewNodeID(),u=Lute.NewNodeID(),g=a.outerHTML;return n.innerHTML=n.innerHTML.substring(s),transaction(e,[{action:"update",id:r,data:a.outerHTML},{action:"insert",id:c,data:`<div data-subtype="t" data-node-id="${c}" updated="${c.split("-")[0]}" data-type="NodeList" class="list"><div data-marker="*" data-subtype="t" data-node-id="${u}" data-type="NodeListItem" class="li${l?" protyle-task--done":""}" updated="${u.split("-")[0]}"><div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#icon${l?"C":"Unc"}heck"></use></svg></div><div data-node-id="${d}" data-type="NodeParagraph" class="p"><div contenteditable="true" spellcheck="${window.siyuan.config.editor.spellcheck}"></div><div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div>`,previousID:r},{action:"move",id:r,previousID:d},{action:"delete",id:d}],[{action:"move",id:r,previousID:c},{action:"delete",id:c},{action:"update",id:r,data:g}]),a.outerHTML=`<div data-subtype="t" data-node-id="${c}" data-type="NodeList" class="list" updated="${c.split("-")[0]}"><div data-marker="*" data-subtype="t" data-node-id="${u}" data-type="NodeListItem" class="li${l?" protyle-task--done":""}" updated="${u.split("-")[0]}"><div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#icon${l?"C":"Unc"}heck"></use></svg></div>${a.outerHTML}<div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div>`,focusByWbr(e.wysiwyg.element,o),!0}}return!1},Gu=(e,t,a,n,o)=>{if(t==="NodeHeading"&&["* ","- "].includes(n.innerHTML.substring(0,2))&&a.parentElement.getAttribute("data-type")!=="NodeListItem"){const i=a.getAttribute("data-node-id"),s=Lute.NewNodeID(),l=Lute.NewNodeID(),r=Lute.NewNodeID(),c=a.outerHTML,d=n.innerHTML.substring(0,1);return n.innerHTML=n.innerHTML.substring(2),transaction(e,[{action:"update",id:i,data:a.outerHTML},{action:"insert",id:s,data:`<div data-subtype="u" data-node-id="${s}" data-type="NodeList" class="list" updated="${s.split("-")[0]}"><div data-marker="${d}" data-subtype="u" data-node-id="${r}" data-type="NodeListItem" class="li" updated="${r.split("-")[0]}"><div class="protyle-action" draggable="true"><svg><use xlink:href="#iconDot"></use></svg></div><div data-node-id="${l}" data-type="NodeParagraph" class="p"><div contenteditable="true" spellcheck="${window.siyuan.config.editor.spellcheck}"></div><div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div>`,previousID:i},{action:"move",id:i,previousID:l},{action:"delete",id:l}],[{action:"update",id:i,data:c},{action:"move",id:i,previousID:s},{action:"delete",id:s}]),a.outerHTML=`<div data-subtype="u" data-node-id="${s}" data-type="NodeList" class="list" updated="${s.split("-")[0]}"><div data-marker="${d}" data-subtype="u" data-node-id="${r}" data-type="NodeListItem" class="li" updated="${r.split("-")[0]}"><div class="protyle-action" draggable="true"><svg><use xlink:href="#iconDot"></use></svg></div>${a.outerHTML}<div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div>`,focusByWbr(e.wysiwyg.element,o),!0}return!1};var Jo=(e,t,a)=>new Promise((n,o)=>{var i=r=>{try{l(a.next(r))}catch(c){o(c)}},s=r=>{try{l(a.throw(r))}catch(c){o(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(i,s);l((a=a.apply(e,t)).next())});const Ku=(e,t,a,n=!0,o)=>Jo(void 0,null,function*(){var i,s,l,r,c;if(!t.parentElement)return;if(t.classList.contains("av")){hasClosestByClassName(a.startContainer,"av__cursor")?a.startContainer.textContent=Constants.ZWSP:updateAVName(e,t);return}const d=getContenteditableElement(t),u=t.getAttribute("data-type");if(!d){u==="NodeThematicBreak"?t.innerHTML="<div><wbr></div>":u==="NodeBlockQueryEmbed"?t.lastElementChild.previousElementSibling.innerHTML="<wbr>"+Constants.ZWSP:u==="NodeMathBlock"||u==="NodeHTMLBlock"?t.lastElementChild.previousElementSibling.lastElementChild.innerHTML="<wbr>"+Constants.ZWSP:u==="NodeIFrame"||u==="NodeWidget"?t.innerHTML="<wbr>"+t.firstElementChild.outerHTML+t.lastElementChild.outerHTML:u==="NodeVideo"?t.firstElementChild.innerHTML="<wbr>"+Constants.ZWSP+t.firstElementChild.firstElementChild.outerHTML+t.firstElementChild.lastElementChild.outerHTML:u==="NodeAudio"?t.firstElementChild.innerHTML=t.firstElementChild.firstElementChild.outerHTML+"<wbr>"+Constants.ZWSP:u==="NodeCodeBlock"&&(a.startContainer.textContent=Constants.ZWSP),focusByWbr(t,a);return}t.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss"));const g=document.createElement("wbr");if(a.insertNode(g),o){const h=hasNextSibling(g);if(o.inputType==="deleteContentForward"&&h&&h.nodeType===1&&!h.textContent.startsWith(Constants.ZWSP)){const E=(h.getAttribute("data-type")||"").split(" ");(E.includes("code")||E.includes("kbd")||E.includes("tag"))&&h.insertAdjacentElement("afterbegin",g)}if((o.inputType==="deleteContentBackward"||o.inputType==="deleteContentForward")&&h&&h.nodeType===1&&h.tagName==="BR"){const E=hasNextSibling(h);E&&E.nodeType===1&&((i=E.getAttribute("data-type"))==null?void 0:i.indexOf("inline-math"))>-1&&h.remove()}}const f=t.getAttribute("data-node-id");if(u!=="NodeCodeBlock"&&u!=="NodeHeading"&&(d.innerHTML.endsWith(`
<wbr>`)||d.innerHTML.endsWith(`
<wbr>
`))){updateTransaction(e,f,t.outerHTML,e.wysiwyg.lastHTMLs[f]||t.outerHTML.replace(`
<wbr>`,"<wbr>")),g.remove();return}if(turnIntoTaskList(e,u,t,d,a)||headingTurnIntoList(e,u,t,d,a))return;const p=t.querySelector("br");p&&p.parentElement.tagName!=="TD"&&p.parentElement.tagName!=="TH"&&(p.parentElement.textContent.trim()===""||((l=(s=p.previousSibling)==null?void 0:s.previousSibling)==null?void 0:l.textContent)===`
`)&&p.remove(),u!=="NodeHeading"&&(d.innerHTML.startsWith("\u300B<wbr>")||d.innerHTML.indexOf(`
\u300B<wbr>`)>-1)&&(d.innerHTML=d.innerHTML.replace("\u300B<wbr>","><wbr>"));const m=d.innerHTML.trimStart();if(!((m.startsWith("````")||m.startsWith("\xB7\xB7\xB7\xB7")||m.startsWith("~~~~"))&&m.indexOf(`
`)===-1)){if((m.startsWith("```")||m.startsWith("\xB7\xB7\xB7")||m.startsWith("~~~"))&&m.indexOf(`
`)===-1&&m.replace(/·|~/g,"`").replace(/^`{3,}/g,"").indexOf("`")===-1){updateTransaction(e,f,t.outerHTML,e.wysiwyg.lastHTMLs[f]),g.remove();return}}u==="NodeParagraph"&&(d.innerHTML.startsWith("\xA5\xA5<wbr>")||d.innerHTML.startsWith("\uFFE5\uFFE5<wbr>")||m.indexOf(`
\xA5\xA5<wbr>`)>-1||m.indexOf(`
\uFFE5\uFFE5<wbr>`)>-1)&&(d.innerHTML=d.innerHTML.replace("\xA5\xA5<wbr>","$$$$<wbr>").replace("\uFFE5\uFFE5<wbr>","$$$$<wbr>"));const b=hasClosestByAttribute(a.startContainer,"data-type","block-ref");b&&b.getAttribute("data-subtype")==="d"&&(yield fetchSyncPost("/api/block/getRefText",{id:b.getAttribute("data-id")})).data!==b.innerHTML.replace("<wbr>","")&&b.setAttribute("data-subtype","s");let w=t.outerHTML,y=!1;if(["---","___","***"].includes(d.textContent)&&u!=="NodeCodeBlock"){w=`<div data-node-id="${f}" data-type="NodeThematicBreak" class="hr"><div></div></div>`;const h=t.nextElementSibling;h&&h.getAttribute("data-node-id")?isNotEditBlock(h)?y=!0:focusBlock(h):w+=genEmptyBlock(!1,!0)}else{if(u!=="NodeCodeBlock"&&(m.startsWith("```")||m.startsWith("~~~")||m.startsWith("\xB7\xB7\xB7")||m.indexOf("\n```")>-1||m.indexOf(`
~~~`)>-1||m.indexOf(`
\xB7\xB7\xB7`)>-1)&&!(m.indexOf(`
`)===-1&&m.replace(/·|~/g,"`").replace(/^`{3,}/g,"").indexOf("`")>-1)){let h=d.innerHTML.trim().replace(/^(~|·|`){3,}/g,"```").replace(/\n(~|·|`){3,}/g,"\n```").trim();h.endsWith("\n```")||(h=h.replace("<wbr>","")+"<wbr>\n```"),d.innerHTML=h,w=t.outerHTML}w=e.lute.SpinBlockDOM(w)}hideElements(["util"],e,!0),u==="NodeTable"&&t.querySelector(".table__select").removeAttribute("style");const _=document.createElement("template");if(_.innerHTML=w,n&&(((r=getContenteditableElement(_.content.firstElementChild))==null?void 0:r.innerHTML)!==getContenteditableElement(t).innerHTML||_.content.childElementCount===1&&((c=getContenteditableElement(_.content.firstElementChild))==null?void 0:c.innerHTML)==="<wbr>")&&!(_.content.childElementCount===1&&_.content.firstElementChild.classList.contains("code-block")&&u==="NodeCodeBlock")){t.getAttribute("data-type")==="NodeHeading"&&t.getAttribute("fold")==="1"&&_.content.firstElementChild.getAttribute("data-subtype")!==t.dataset.subtype&&(setFold(e,t,void 0,void 0,!1),w=w.replace(' fold="1"',""),e.wysiwyg.lastHTMLs[f]=t.outerHTML);let h;t.classList.contains("table")&&(h=t.firstElementChild.scrollLeft),/<span data-type="backslash">.+<\/span><wbr>/.test(w)?t.outerHTML=w:t.outerHTML=w.replace("</span><wbr>","</span>"+Constants.ZWSP+"<wbr>"),e.wysiwyg.element.querySelectorAll(`[data-node-id="${f}"]`).forEach(E=>{isInEmbedBlock(E)||(t=E)}),w.split('<span data-type="inline-math" data-subtype="math"').length>1&&Array.from(t.querySelectorAll('[data-type="inline-math"]')).find(E=>{if(E.dataset.content.indexOf("<wbr>")>-1)return E.setAttribute("data-content",E.dataset.content.replace("<wbr>","")),e.toolbar.showRender(e,E),!0}),Array.from(_.content.children).forEach((E,C)=>{const k=E.getAttribute("data-node-id");let v;k===f?v=t:v=e.wysiwyg.element.querySelector(`[data-node-id="${k}"]`);const A=v.getAttribute("data-type");if(A==="NodeCodeBlock"){const L=v.querySelector(".protyle-action__language");L?(window.siyuan.storage[Constants.LOCAL_CODELANG]&&L.textContent===""&&(L.textContent=window.siyuan.storage[Constants.LOCAL_CODELANG]),highlightRender(v)):_.content.childElementCount===1&&e.toolbar.showRender(e,v)}else if(["NodeMathBlock","NodeHTMLBlock"].includes(A))A==="NodeMathBlock"&&mathRender(v),e.toolbar.showRender(e,v);else if(A==="NodeBlockQueryEmbed")blockRender(e,v),e.toolbar.showRender(e,v),hideElements(["hint"],e);else if(A==="NodeThematicBreak"&&y)focusBlock(t);else if(v.querySelectorAll('[data-type="block-ref"][data-subtype="d"]').forEach(L=>{L.textContent===""&&fetchPost("/api/block/getRefText",{id:L.getAttribute("data-id")},x=>{L.innerHTML=x.data})}),mathRender(v),C===_.content.childElementCount-1){const L=t.querySelector("wbr");if(L&&L.parentElement.tagName==="SPAN"&&L.parentElement.innerHTML==="<wbr>"){const x=L.parentElement.getAttribute("data-type")||"";(x.includes("sup")||x.includes("u")||x.includes("sub"))&&L.insertAdjacentText("beforebegin",Constants.ZWSP)}focusByWbr(e.wysiwyg.element,a),e.hint.render(e),h>0&&(t.firstElementChild.scrollLeft=h)}})}else t.getAttribute("data-type")==="NodeCodeBlock"?(d.parentElement.removeAttribute("data-render"),highlightRender(t)):(focusByWbr(e.wysiwyg.element,a),e.hint.render(e));hideElements(["gutter"],e),Qo(w,e,f)}),Qo=(e,t,a)=>{const n=document.createElement("template");n.innerHTML=e;const o=[],i=[];Array.from(n.content.children).forEach((s,l)=>{var r;s.getAttribute("spellcheck")==="false"&&s.getAttribute("contenteditable")==="false"&&s.setAttribute("contenteditable","true");const c=s.getAttribute("data-node-id");if(c===a)o.push({id:a,data:s.outerHTML,action:"update"}),i.push({id:a,data:t.wysiwyg.lastHTMLs[a],action:"update"}),t.wysiwyg.lastHTMLs[a]=s.outerHTML;else{let d;l===0&&(d=t.wysiwyg.element.querySelector(`[data-node-id="${c}"]`)),o.push({action:"insert",data:s.outerHTML,id:c,previousID:l===0?(r=d==null?void 0:d.previousElementSibling)==null?void 0:r.getAttribute("data-node-id"):s.previousElementSibling.getAttribute("data-node-id"),parentID:(d==null?void 0:d.parentElement.getAttribute("data-node-id"))||t.block.parentID}),i.push({id:c,action:"delete"})}}),transaction(t,o,i)},el=(e,t,a,n)=>{const o=document.createElement("template");o.innerHTML=t;let i=[];if(t.endsWith("]")&&t.startsWith("["))try{i=JSON.parse(t)}catch(l){console.warn("insert cell: JSON.parse error")}else o.content.querySelector("table")&&o.content.querySelectorAll("tr").forEach(l=>{i.push([]),Array.from(l.children).forEach(r=>{i[i.length-1].push({text:{content:r.textContent},type:"text"})})});const s=n.dataset.avId;fetchPost("/api/av/getAttributeViewKeysByAvID",{avID:s},l=>{var r,c;const d=l.data;if(i&&Array.isArray(i)&&i.length>0){const b=Array.from(n.querySelectorAll(".av__cell--active, .av__cell--select"))||[];b.length===0&&n.querySelectorAll(".av__row--select:not(.av__row--header)").forEach(k=>{k.querySelectorAll(".av__cell").forEach(v=>{b.push(v)})}),b.length===0&&b.push(n.querySelector(".av__row:not(.av__row--header) .av__cell"));const w=[],y=[],_=n.dataset.avId,h=n.dataset.nodeId;let E;const C=b[0].getAttribute("data-col-id");i.find(k=>{if(E?E=E.nextElementSibling:E=b[0].parentElement,!E.classList.contains("av__row"))return!0;let v;k.find(A=>{var L;if(v?v=v.nextElementSibling:v=E.querySelector(`.av__cell[data-col-id="${C}"]`),!v.classList.contains("av__cell"))return!0;const x=getTypeByCellElement(v)||v.dataset.type;if(["created","updated","template","rollup"].includes(x)||x==="block"&&!v.dataset.detached)return;const T=E.getAttribute("data-id"),M=v.getAttribute("data-id"),I=v.getAttribute("data-col-id"),D=genCellValueByElement(x,v);if(A.type!==x&&!(["select","mSelect"].includes(x)&&["select","mSelect"].includes(A.type))){if(x==="date"||!((L=A[A.type])==null?void 0:L.content))return;A=genCellValue(x,A[A.type].content.toString())}if(A.type==="block")A.isDetached=!0,delete A.block.id;else if(x==="select"||x==="mSelect"){x==="select"&&A.type==="mSelect"&&A.mSelect.length>0&&A.mSelect.splice(1,A.mSelect.length-1);const N=mergeAddOption(d.find(H=>H.id===v.dataset.colId),A,_);w.push(...N.doOperations),y.push(...N.undoOperations)}A.id=M,!(A.type==="date"&&typeof A.date=="string"||A.type==="relation"&&typeof A.relation=="string")&&(objEquals(A,D)||(w.push({action:"updateAttrViewCell",id:M,avID:_,keyID:I,rowID:T,data:A}),y.push({action:"updateAttrViewCell",id:M,avID:_,keyID:I,rowID:T,data:D}),updateAttrViewCellAnimation(v,A)))})}),w.length>0&&(w.push({action:"doUpdateUpdated",id:h,data:dayjs().format("YYYYMMDDHHmmss")}),y.push({action:"doUpdateUpdated",id:h,data:n.getAttribute("updated")}),transaction(a,w,y));return}const u=getContenteditableElement(o.content.firstElementChild);if(u&&u.childNodes.length===1&&((r=u.firstElementChild)==null?void 0:r.getAttribute("data-type"))==="block-ref"){const b=n.querySelector(".av__cell--select");if(b){const w=u.firstElementChild.getAttribute("data-id"),y=b.dataset.blockId;transaction(a,[{action:"replaceAttrViewBlock",avID:s,previousID:y,nextID:w,isDetached:!1}],[{action:"replaceAttrViewBlock",avID:s,previousID:w,nextID:y,isDetached:b.dataset.detached==="true"}]),updateAttrViewCellAnimation(b,{type:"block",isDetached:!1,block:{content:u.firstElementChild.textContent,id:w}});return}}const g=a.lute.BlockDOM2Content(t),f=Array.from(n.querySelectorAll(".av__cell--active, .av__cell--select")),p=n.querySelectorAll(".av__row--select"),m=[];if(g.split(`
`).forEach(b=>{m.push(b.split("	"))}),p.length>0&&m.length===1&&m[0].length===1){updateCellsValue(a,n,g,void 0,d,t);return}if(p.length>0&&p.forEach(b=>{b.querySelectorAll(".av__cell").forEach(w=>{f.push(w)})}),f.length>0){if(m.length===1&&m[0].length===1)updateCellsValue(a,n,g,f,d,t);else{let b;const w=f[0].getAttribute("data-col-id");m.forEach(y=>{if(b?b=b.nextElementSibling:b=f[0].parentElement,!b.classList.contains("av__row"))return!0;let _;y.forEach(h=>{if(_?_=_.nextElementSibling:_=b.querySelector(`.av__cell[data-col-id="${w}"]`),!_.classList.contains("av__cell"))return!0;updateCellsValue(a,n,h,[_],d,t)})})}(c=document.querySelector(".av__panel"))==null||c.remove()}else if(hasClosestByClassName(e.startContainer,"av__title")){const b=document.createTextNode(g);e.insertNode(b),e.setEnd(b,g.length),e.collapse(!1),focusByRange(e),updateAVName(a,n)}})},tl=(e,t,a,n)=>{const o=document.createElement("template");o.innerHTML=t;const i=o.content.querySelectorAll("th, td");if(i.length===0)return!1;const s=n.firstElementChild.scrollLeft,l=n.querySelector(".table__select");let r=0;const c=[];n.querySelectorAll("th, td").forEach(u=>{!u.classList.contains("fn__none")&&u.offsetLeft+6>l.offsetLeft+s&&u.offsetLeft+u.clientWidth-6<l.offsetLeft+s+l.clientWidth&&u.offsetTop+6>l.offsetTop&&u.offsetTop+u.clientHeight-6<l.offsetTop+l.clientHeight&&i.length>r&&(c.push(u),r++)}),l.removeAttribute("style");const d=n.outerHTML;return n.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),c.forEach((u,g)=>{u.innerHTML=i[g].innerHTML,g===c.length-1&&setLastNodeRange(u,e,!1)}),e.collapse(!1),updateTransaction(a,n.getAttribute("data-node-id"),n.outerHTML,d),!0},zu=(e,t,a=!1,n=!1,o=!1)=>{var i,s,l,r;if(e==="")return;const c=n?t.toolbar.range:getEditorRange(t.wysiwyg.element);fixTableRange(c);let d;hasClosestByAttribute(c.startContainer,"data-type","NodeTable")&&!a&&(hasClosestByTag(c.startContainer,"TABLE")?d=t.lute.BlockDOM2InlineBlockDOM(e):a=!0);let u=hasClosestBlock(c.startContainer);if(u||(t.toolbar.range?u=hasClosestBlock(t.toolbar.range.startContainer):u=t.wysiwyg.element.firstElementChild),!u)return;if(u.classList.contains("av")){c.deleteContents(),el(c,e,t,u);return}if(u.classList.contains("table")&&u.querySelector(".table__select").clientWidth>0&&tl(c,e,t,u))return;let g=u.getAttribute("data-node-id");c.insertNode(document.createElement("wbr"));let f=u.outerHTML;const p=u.getAttribute("data-type")==="NodeCodeBlock",m=getContenteditableElement(u);if(!a&&(p||t.toolbar.getCurrentType(c).includes("code"))){c.deleteContents(),p&&m.textContent===""&&(e+=`
`),c.insertNode(document.createTextNode(e.replace(/\r\n|\r|\u2028|\u2029/g,`
`))),c.collapse(!1),c.insertNode(document.createElement("wbr")),p?((i=u.querySelector('[data-render="true"]'))==null||i.removeAttribute("data-render"),highlightRender(u)):focusByWbr(u,c),u.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(t,g,u.outerHTML,f),setTimeout(()=>{scrollCenter(t,u,!1,"smooth")},Constants.TIMEOUT_LOAD);return}const b=[],w=[];if(c.toString()!==""){const A=hasClosestByAttribute(c.commonAncestorContainer,"data-type","inline-math");A?A.remove():c.startContainer.nodeType===3&&((s=c.startContainer.parentElement.getAttribute("data-type"))==null?void 0:s.indexOf("block-ref"))>-1?(c.deleteContents(),c.startContainer.nodeType!==3&&c.startContainer.textContent===""&&c.startContainer.remove()):c.deleteContents(),c.insertNode(document.createElement("wbr")),b.push({action:"update",id:g,data:f}),w.push({action:"update",id:g,data:u.outerHTML})}const y=document.createElement("template");e.startsWith("&gt;")&&m.textContent.replace(Constants.ZWSP,"")!==""&&(d=e);let _=d||t.lute.SpinBlockDOM(e)||e;_=_.replace(/;;;lt;;;/g,"&lt;").replace(/;;;gt;;;/g,"&gt;"),y.innerHTML=_;let h=!1;if((m.textContent.replace(Constants.ZWSP,"")!==""||u.getAttribute("data-type")==="NodeHeading")&&y.content.childElementCount===1&&y.content.firstChild.nodeType!==3&&y.content.firstElementChild.getAttribute("data-type")==="NodeHeading"&&(a=!1,h=!0),!a&&(y.content.firstChild.nodeType===3||h||y.content.firstChild.nodeType!==3&&(y.content.firstElementChild.classList.contains("p")&&y.content.childElementCount===1||y.content.firstElementChild.tagName!=="DIV"))){y.content.firstChild.nodeType!==3&&y.content.firstElementChild.classList.contains("p")&&(y.innerHTML=y.content.firstElementChild.firstElementChild.innerHTML.trim());const A=c.startContainer.nodeType===3?c.startContainer.parentElement:c.startContainer;if(A.tagName==="SPAN"&&A.isSameNode(c.endContainer.nodeType===3?c.endContainer.parentElement:c.endContainer)&&y.content.querySelector("span, img")){const L=document.createElement("span"),x=A.attributes;for(let T=0;T<x.length;T++)L.setAttribute(x[T].name,x[T].value);c.setEnd(A.lastChild,A.lastChild.textContent.length),L.append(c.extractContents()),A.after(L),c.setStartBefore(L),c.collapse(!0)}c.insertNode(y.content.cloneNode(!0)),c.collapse(!1),(l=u.querySelector("wbr"))==null||l.remove(),t.wysiwyg.lastHTMLs[g]=f,input(t,u,c);return}const E=hasClosestByClassName(u,"li");if(((r=y.content.children[0])==null?void 0:r.getAttribute("data-type"))==="NodeListItem")if(E)u=E,g=u.getAttribute("data-node-id"),f=u.outerHTML;else{const L=y.content.children[0].getAttribute("data-subtype");y.innerHTML=`<div${L==="o"?' data-marker="1."':""} data-subtype="${L}" data-node-id="${Lute.NewNodeID()}" data-type="NodeList" class="list">${e}<div class="protyle-attr" contenteditable="false">${Constants.ZWSP}</div></div>`}let C,k=!1;!c.toString()&&o&&getSelectionOffset(u,t.wysiwyg.element,c).start===0&&m.textContent!==""&&(k=!0),(k?Array.from(y.content.children):Array.from(y.content.children).reverse()).forEach(A=>{A.getAttribute("data-type")==="NodeHeading"&&A.getAttribute("fold")==="1"&&A.removeAttribute("fold");let L=A.getAttribute("data-node-id");if(L===g)w.push({action:"update",data:A.outerHTML,id:L}),b.push({action:"update",id:L,data:f});else{if(A.classList.contains("li")&&!u.parentElement.classList.contains("list")){L=Lute.NewNodeID();const x=document.createElement("div");x.setAttribute("data-subtype",A.getAttribute("data-subtype")),x.setAttribute("data-node-id",L),x.setAttribute("data-type","NodeList"),x.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),x.classList.add("list"),x.append(A),A=x}w.push({action:"insert",data:A.outerHTML,id:L,nextID:k?g:void 0,previousID:k?void 0:g}),b.push({action:"delete",id:L})}k?u.before(A):u.after(A),C||(C=A)}),m&&m.textContent===""&&u.classList.contains("p")&&(w.find((A,L)=>{if(A.id===g)return w.splice(L,1),!0}),w.push({action:"delete",id:g}),b.find((A,L)=>{if(A.id===g&&A.action==="update")return b.splice(L,1),!0}),b.push({action:"insert",data:f,id:g,previousID:u.previousElementSibling?u.previousElementSibling.getAttribute("data-node-id"):"",parentID:u.parentElement.getAttribute("data-node-id")||t.block.parentID}),u.remove()),C&&focusBlock(C,void 0,!1);const v=t.wysiwyg.element.querySelector("wbr");v&&v.remove(),transaction(t,w,b)},Be=(e,t)=>e?`<span class="b3-menu__accelerator">${updateHotkeyTip(e)}</span>`:t?`<span class="b3-list-item__meta">${t}</span>`:"",Zu=(e,t)=>{const a=[{filter:[window.siyuan.languages.template,"template","\u6A21\u677F","moban","muban","mb"],id:"template",value:Constants.ZWSP,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconMarkdown"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.template}</span></div>`},{filter:[window.siyuan.languages.widget,"widget","\u6302\u4EF6","guajian","gj"],id:"widget",value:Constants.ZWSP+1,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconBoth"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.widget}</span></div>`},{filter:[window.siyuan.languages.assets,"assets","\u8D44\u6E90","ziyuan","zy"],id:"assets",value:Constants.ZWSP+2,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconImage"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.assets}</span></div>`},{filter:[window.siyuan.languages.ref,"block reference","\u5757\u5F15\u7528","kuaiyinyong","kyy"],id:"ref",value:"((",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconRef"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.ref}</span><span class="b3-list-item__meta">((</span></div>`},{filter:[window.siyuan.languages.blockEmbed,"embed block","\u5D4C\u5165\u5757","qianrukuai","qrk"],id:"blockEmbed",value:"{{",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconSQL"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.blockEmbed}</span><span class="b3-list-item__meta">{{</span></div>`},{filter:[window.siyuan.languages.aiWriting,"ai writing","ai\u7F16\u5199","aibianxie","aibx","\u4EBA\u5DE5\u667A\u80FD","rengongzhineng","rgzn"],id:"aiWriting",value:Constants.ZWSP+5,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconSparkles"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.aiWriting}</span>${Be(window.siyuan.config.keymap.editor.general.aiWriting.custom,"")}</div>`},{filter:[window.siyuan.languages.database,"database","db","\u6570\u636E\u5E93","shujuku","sjk","\u89C6\u56FE","view"],id:"database",value:'<div data-type="NodeAttributeView" data-av-type="table"></div>',html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconDatabase"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.database}</span></div>`},{filter:[window.siyuan.languages.newFileRef,"create new doc with reference","\u65B0\u5EFA\u6587\u6863\u5E76\u5F15\u7528","xinjianwendangbingyinyong","xjwdbyy"],id:"newFileRef",value:Constants.ZWSP+4,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.newFileRef}</span></div>`},{filter:[window.siyuan.languages.newSubDocRef,"create sub doc with reference","\u65B0\u5EFA\u5B50\u6587\u6863\u5E76\u5F15\u7528","xinjianziwendangbingyinyong","xjzwdbyy"],id:"newSubDocRef",value:Constants.ZWSP+6,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.newSubDocRef}</span></div>`},{value:"",id:"separator_1",html:"separator"},{filter:[window.siyuan.languages.heading1,"heading1","h1","\u4E00\u7EA7\u6807\u9898","yijibiaoti","yjbt"],id:"heading1",value:"# "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH1"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading1}</span>${Be(window.siyuan.config.keymap.editor.heading.heading1.custom,"# ")}</div>`},{filter:[window.siyuan.languages.heading2,"heading2","h2","\u4E8C\u7EA7\u6807\u9898","erjibiaoti","ejbt"],id:"heading2",value:"## "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH2"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading2}</span>${Be(window.siyuan.config.keymap.editor.heading.heading2.custom,"## ")}</div>`},{filter:[window.siyuan.languages.heading3,"heading3","h3","\u4E09\u7EA7\u6807\u9898","sanjibiaoti","sjbt"],id:"heading3",value:"### "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH3"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading3}</span>${Be(window.siyuan.config.keymap.editor.heading.heading3.custom,"### ")}</div>`},{filter:[window.siyuan.languages.heading4,"heading4","h4","\u56DB\u7EA7\u6807\u9898","sijibiaoti","sjbt"],id:"heading4",value:"#### "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH4"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading4}</span>${Be(window.siyuan.config.keymap.editor.heading.heading4.custom,"#### ")}</div>`},{filter:[window.siyuan.languages.heading5,"heading5","h5","\u4E94\u7EA7\u6807\u9898","wujibiaoti","wjbt"],id:"heading5",value:"##### "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH5"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading5}</span>${Be(window.siyuan.config.keymap.editor.heading.heading5.custom,"##### ")}</div>`},{filter:[window.siyuan.languages.heading6,"heading6","h6","\u516D\u7EA7\u6807\u9898","liujibiaoti","ljbt"],id:"heading6",value:"###### "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH6"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading6}</span>${Be(window.siyuan.config.keymap.editor.heading.heading6.custom,"###### ")}</div>`},{filter:[window.siyuan.languages.list,"unordered list","\u65E0\u5E8F\u5217\u8868","wuxvliebiao","wuxuliebiao","wxlb"],id:"list",value:"* "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconList"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.list}</span>${Be(window.siyuan.config.keymap.editor.insert.list.custom,"* ")}</div>`},{filter:[window.siyuan.languages["ordered-list"],"order list","ordered list","\u6709\u5E8F\u5217\u8868","youxvliebiao","youxuliebiao","yxlb"],id:"orderedList",value:"1. "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconOrderedList"></use></svg><span class="b3-list-item__text">${window.siyuan.languages["ordered-list"]}</span>${Be(window.siyuan.config.keymap.editor.insert["ordered-list"].custom,"1. ")}</div>`},{filter:[window.siyuan.languages.check,"task list","todo list","\u4EFB\u52A1\u5217\u8868","renwuliebiao","rwlb"],id:"check",value:"* [ ] "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconCheck"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.check}</span>${Be(window.siyuan.config.keymap.editor.insert.check.custom,"[]")}</div>`},{filter:[window.siyuan.languages.quote,"blockquote","bq","\u5F15\u8FF0","yinshu","ys"],id:"quote",value:"> "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconQuote"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.quote}</span>${Be(window.siyuan.config.keymap.editor.insert.quote.custom,">")}</div>`},{filter:[window.siyuan.languages.code,"code block","\u4EE3\u7801\u5757","daimakuai","dmk"],id:"code",value:"```",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconCode"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.code}</span>${Be(window.siyuan.config.keymap.editor.insert.code.custom,"```"+window.siyuan.languages.enterKey)}</div>`},{filter:[window.siyuan.languages.table,"table","\u8868\u683C","biaoge","bg"],id:"table",value:`| ${Lute.Caret} |  |  |
| --- | --- | --- |
|  |  |  |
|  |  |  |`,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconTable"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.table}</span><span class="b3-menu__accelerator">${updateHotkeyTip(window.siyuan.config.keymap.editor.insert.table.custom)}</span></div>`},{filter:[window.siyuan.languages.line,"thematic break","divider","\u5206\u9694\u7EBF","\u5206\u5272\u7EBF","fengexian","fgx"],id:"line",value:"---",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconLine"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.line}</span><span class="b3-list-item__meta">---</span></div>`},{filter:[window.siyuan.languages.math,"formulas block","math block","\u6570\u5B66\u516C\u5F0F\u5757","shuxuegongshikuai","sxgsk"],id:"math",value:"$$",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconMath"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.math}</span><span class="b3-list-item__meta">$$</span></div>`},{filter:["html"],id:"html",value:"<div>",html:'<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconHTML5"></use></svg><span class="b3-list-item__text">HTML</span></div>'},{value:"",id:"separator_2",html:"separator"},{filter:[window.siyuan.languages.emoji,"emoji","\u8868\u60C5","biaoqing","bq"],id:"emoji",value:"emoji",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconEmoji"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.emoji}</span><span class="b3-list-item__meta">:</span></div>`},{filter:[window.siyuan.languages.link,"link","a","\u94FE\u63A5","lianjie","lj"],id:"link",value:"a",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconLink"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.link}</span><span class="b3-menu__accelerator">${updateHotkeyTip(window.siyuan.config.keymap.editor.insert.link.custom)}</span></div>`},{filter:[window.siyuan.languages.bold,"bold","strong","\u7C97\u4F53","cuti","ct","\u52A0\u7C97","jiacu","jc"],id:"bold",value:"strong",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconBold"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.bold}</span><span class="b3-menu__accelerator">${updateHotkeyTip(window.siyuan.config.keymap.editor.insert.bold.custom)}</span></div>`},{filter:[window.siyuan.languages.italic,"italic","em","\u659C\u4F53","xieti","xt"],id:"italic",value:"em",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconItalic"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.italic}</span><span class="b3-menu__accelerator">${updateHotkeyTip(window.siyuan.config.keymap.editor.insert.italic.custom)}</span></div>`},{filter:[window.siyuan.languages.underline,"underline","\u4E0B\u5212\u7EBF","xiahuaxian","xhx"],id:"underline",value:"u",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconUnderline"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.underline}</span><span class="b3-menu__accelerator">${updateHotkeyTip(window.siyuan.config.keymap.editor.insert.underline.custom)}</span></div>`},{filter:[window.siyuan.languages.strike,"strike","delete","\u5220\u9664\u7EBF","shanchuxian","scx"],id:"strike",value:"s",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconStrike"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.strike}</span><span class="b3-menu__accelerator">${updateHotkeyTip(window.siyuan.config.keymap.editor.insert.strike.custom)}</span></div>`},{filter:[window.siyuan.languages.mark,"mark","\u6807\u8BB0","biaoji","bj","\u9AD8\u4EAE","gaoliang","gl"],id:"mark",value:"mark",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconMark"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.mark}</span><span class="b3-menu__accelerator">${updateHotkeyTip(window.siyuan.config.keymap.editor.insert.mark.custom)}</span></div>`},{filter:[window.siyuan.languages.sup,"superscript","\u4E0A\u6807","shangbiao","sb"],id:"sup",value:"sup",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconSup"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.sup}</span><span class="b3-menu__accelerator">${updateHotkeyTip(window.siyuan.config.keymap.editor.insert.sup.custom)}</span></div>`},{filter:[window.siyuan.languages.sub,"subscript","\u4E0B\u6807","xiaobiao","xb"],id:"sub",value:"sub",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconSub"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.sub}</span><span class="b3-menu__accelerator">${updateHotkeyTip(window.siyuan.config.keymap.editor.insert.sub.custom)}</span></div>`},{filter:[window.siyuan.languages["inline-code"],"inline code","\u884C\u7EA7\u4EE3\u7801","hangjidaima","hjdm"],id:"inlineCode",value:"code",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconInlineCode"></use></svg><span class="b3-list-item__text">${window.siyuan.languages["inline-code"]}</span><span class="b3-menu__accelerator">${updateHotkeyTip(window.siyuan.config.keymap.editor.insert["inline-code"].custom)}</span></div>`},{filter:[window.siyuan.languages.kbd,"kbd","\u952E\u76D8","jianpan","jp"],id:"kbd",value:"kbd",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconKeymap"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.kbd}</span><span class="b3-menu__accelerator">${updateHotkeyTip(window.siyuan.config.keymap.editor.insert.kbd.custom)}</span></div>`},{filter:[window.siyuan.languages.tag,"tags","\u6807\u7B7E","biaoqian","bq"],id:"tag",value:"tag",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconTags"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.tag}</span><span class="b3-menu__accelerator">${updateHotkeyTip(window.siyuan.config.keymap.editor.insert.tag.custom)}</span></div>`},{filter:[window.siyuan.languages["inline-math"],"inline formulas","inline math","\u884C\u7EA7\u516C\u5F0F","hangjigongshi","hjgs","\u884C\u7EA7\u6570\u5B66\u516C\u5F0F","hangjishuxvegongshi","hangjishuxuegongshi","hjsxgs"],id:"inlineMath",value:"inline-math",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconMath"></use></svg><span class="b3-list-item__text">${window.siyuan.languages["inline-math"]}</span><span class="b3-menu__accelerator">${updateHotkeyTip(window.siyuan.config.keymap.editor.insert["inline-math"].custom)}</span></div>`},{value:"",id:"separator_3",html:"separator"},{filter:[window.siyuan.languages.insertAsset,"insert image or file","upload","\u63D2\u5165\u56FE\u7247\u6216\u6587\u4EF6","charutupianhuowenjian","crtphwj","\u4E0A\u4F20","sc"],id:"insertAsset",value:Constants.ZWSP+3,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconDownload"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.insertAsset}</span>
<input class="b3-form__upload" type="file" ${t.options.upload.accept?'multiple="'+t.options.upload.accept+'"':""}></div>`},{filter:[window.siyuan.languages.insertIframeURL,"insert iframe link","\u63D2\u5165 iframe \u94FE\u63A5","charuiframelianjie","criframelj"],id:"insertIframeURL",value:'<iframe sandbox="allow-forms allow-presentation allow-same-origin allow-scripts allow-modals allow-popups" src="" border="0" frameborder="no" framespacing="0" allowfullscreen="true"></iframe>',html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconLanguage"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.insertIframeURL}</span></div>`},{filter:[window.siyuan.languages.insertImgURL,"insert image link","image","img","\u63D2\u5165\u56FE\u7247\u94FE\u63A5","charutupianlianjie","crtplj"],id:"insertImgURL",value:"![]()",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconImage"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.insertImgURL}</span></div>`},{filter:[window.siyuan.languages.insertVideoURL,"insert video link","\u63D2\u5165\u89C6\u9891\u94FE\u63A5","charushipinlianjie","crsplj"],id:"insertVideoURL",value:'<video controls="controls" src=""></video>',html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconVideo"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.insertVideoURL}</span></div>`},{filter:[window.siyuan.languages.insertAudioURL,"insert audio link","\u63D2\u5165\u97F3\u9891\u94FE\u63A5","charuyinpinlianjie","cryplj"],id:"insertAudioURL",value:'<audio controls="controls" src=""></audio>',html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconRecord"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.insertAudioURL}</span></div>`},{value:"",id:"separator_4",html:"separator"},{filter:[window.siyuan.languages.staff,"staff","\u4E94\u7EBF\u8C31","wuxianpu","wxp"],id:"staff",value:"```abc\n```",html:`<div class="b3-list-item__first"><span class="b3-list-item__text">ABC</span><span class="b3-list-item__meta">${window.siyuan.languages.staff}</span></div>`},{filter:[window.siyuan.languages.chart,"chart","\u56FE\u8868","tubiao","tb"],id:"chart",value:"```echarts\n```",html:`<div class="b3-list-item__first"><span class="b3-list-item__text">Chart</span><span class="b3-list-item__meta">${window.siyuan.languages.chart}</span></div>`},{filter:["flowchart","flow chart","\u6D41\u7A0B\u56FE","liuchengtu","lct"],id:"flowChart",value:"```flowchart\n```",html:'<div class="b3-list-item__first"><span class="b3-list-item__text">FlowChart</span><span class="b3-list-item__meta">Flow Chart</span></div>'},{filter:["graphviz","\u72B6\u6001\u56FE","zhuangtaitu","ztt"],id:"graph",value:"```graphviz\n```",html:'<div class="b3-list-item__first"><span class="b3-list-item__text">Graphviz</span><span class="b3-list-item__meta">Graph</span></div>'},{filter:["mermaid","diagram","\u56FE\u8868","tubiao","tb"],id:"mermaid",value:"```mermaid\n```",html:'<div class="b3-list-item__first"><span class="b3-list-item__text">Mermaid</span><span class="b3-list-item__meta">Mermaid</span></div>'},{filter:[window.siyuan.languages.mindmap,"mindmap","\u8111\u56FE","naotu","nt"],id:"mindmap",value:"```mindmap\n```",html:`<div class="b3-list-item__first"><span class="b3-list-item__text">Mind map</span><span class="b3-list-item__meta">${window.siyuan.languages.mindmap}</span></div>`},{filter:["plantuml","\u5EFA\u6A21\u8BED\u8A00","jianmoyuyan","jmyy"],id:"UML",value:"```plantuml\n```",html:'<div class="b3-list-item__first"><span class="b3-list-item__text">PlantUML</span><span class="b3-list-item__meta">UML</span></div>'},{value:"",id:"separator_5",html:"separator"},{filter:[window.siyuan.languages.infoStyle,"info style","\u4FE1\u606F\u6837\u5F0F","xinxiyangshi","xxys"],id:"infoStyle",value:`style${Constants.ZWSP}color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);`,html:`<div class="b3-list-item__first"><div style="color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);" class="color__square color__square--list">A</div><span class="b3-list-item__text">${window.siyuan.languages.infoStyle}</span></div>`},{filter:[window.siyuan.languages.successStyle,"success style","\u6210\u529F\u6837\u5F0F","chenggongyangshi","cgys"],id:"successStyle",value:`style${Constants.ZWSP}color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);`,html:`<div class="b3-list-item__first"><div style="color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);" class="color__square color__square--list">A</div><span class="b3-list-item__text">${window.siyuan.languages.successStyle}</span></div>`},{filter:[window.siyuan.languages.warningStyle,"warning style","\u8B66\u544A\u6837\u5F0F","jinggaoyangshi","jgys"],id:"warningStyle",value:`style${Constants.ZWSP}color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);`,html:`<div class="b3-list-item__first"><div style="color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);" class="color__square color__square--list">A</div><span class="b3-list-item__text">${window.siyuan.languages.warningStyle}</span></div>`},{filter:[window.siyuan.languages.errorStyle,"error style","\u9519\u8BEF\u6837\u5F0F","cuowuyangshi","cwys"],id:"errorStyle",value:`style${Constants.ZWSP}color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);`,html:`<div class="b3-list-item__first"><div style="color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);" class="color__square color__square--list">A</div><span class="b3-list-item__text">${window.siyuan.languages.errorStyle}</span></div>`},{filter:[window.siyuan.languages.clearFontStyle,"clear style","\u6E05\u9664\u6837\u5F0F","qingchuyangshi","qcys"],id:"clearFontStyle",value:`style${Constants.ZWSP}`,html:`<div class="b3-list-item__first"><div class="color__square color__square--list">A</div><span class="b3-list-item__text">${window.siyuan.languages.clearFontStyle}</span></div>`},{value:"",id:"separator_6",html:"separator"}];let n=!1;return t.app.plugins.forEach(o=>{o.protyleSlash.forEach(i=>{a.push({filter:i.filter,value:`plugin${Constants.ZWSP}${o.name}${Constants.ZWSP}${i.id}`,html:i.html}),n=!0})}),n||a.pop(),e===""?a:a.filter(o=>o.filter?!!o.filter.find(s=>{if(s.toLowerCase().indexOf(e.toLowerCase())>-1)return!0}):!1)},Xu=(e,t)=>(t.hint.genLoading(t),fetchPost("/api/search/searchTag",{k:e},a=>{const n=[];let o=!1;a.data.tags.forEach(i=>{const s=i.replace(/<mark>/g,"").replace(/<\/mark>/g,"");n.push({value:`<span data-type="tag">${s}</span>`,html:`<div class="b3-list-item__text">${i}</div>`}),s===a.data.k&&(o=!0)}),a.data.k&&!o&&(n.splice(0,0,{value:`<span data-type="tag">${a.data.k}</span>`,html:`<div class="b3-list-item__text">${window.siyuan.languages.new} <mark>${escapeHtml(a.data.k)}</mark></div>`}),n.length>1&&(n[1].focus=!0)),t.hint.genHTML(n,t,!0,"hint")}),[]),As=e=>{let t;e.type==="NodeDocument"&&e.ial.icon?(t=Le(e.ial.icon,"b3-list-item__graphic popover__block",!0),t=t.replace('popover__block"',`popover__block" data-id="${e.id}"`)):t=`<svg class="b3-list-item__graphic popover__block" data-id="${e.id}"><use xlink:href="#${Bn(e.type)}"></use></svg>`;let a="";return e.name&&(a+=`<span class="fn__flex"><svg class="b3-list-item__hinticon"><use xlink:href="#iconN"></use></svg><span>${e.name}</span></span><span class="fn__space"></span>`),e.alias&&(a+=`<span class="fn__flex"><svg class="b3-list-item__hinticon"><use xlink:href="#iconA"></use></svg><span>${e.alias}</span></span><span class="fn__space"></span>`),e.memo&&(a+=`<span class="fn__flex"><svg class="b3-list-item__hinticon"><use xlink:href="#iconM"></use></svg><span>${e.memo}</span></span>`),a&&(a=`<div class="fn__flex b3-list-item__meta b3-list-item__showall">${a}</div>`),`${a}<div class="b3-list-item__first">
    ${t}
    <span class="b3-list-item__text">${e.content}</span>
</div>
<div class="b3-list-item__meta b3-list-item__showall">${e.hPath}</div>`},al=(e,t,a)=>{const n=oe(lt(t.wysiwyg.element).startContainer);return t.hint.genLoading(t),he("/api/search/searchRefBlock",{k:e,id:n?n.getAttribute("data-node-id"):t.block.parentID,beforeLen:Math.floor((Math.max(t.element.clientWidth/2,320)-58)/28.8),rootID:a==="av"?"":t.block.rootID,isDatabase:a==="av",isSquareBrackets:["[[","\u3010\u3010"].includes(t.hint.splitChar)},o=>{const i=[];if(o.data.newDoc){const s=Lute.UnEscapeHTMLStr(en(o.data.k));i.push({value:`((newFile "${s}"${S.ZWSP}'${s}${Lute.Caret}'))`,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg>
<span class="b3-list-item__text">${window.siyuan.languages.newFile} <mark>${o.data.k}</mark></span></div>`})}o.data.blocks.forEach(s=>{let l=`<span data-type="block-ref" data-id="${s.id}" data-subtype="d">${s.name||s.refText.replace(new RegExp(S.ZWSP,"g"),"")}</span>`;if(a==="search")l=`<span data-type="block-ref" data-id="${s.id}" data-subtype="s">${e}${S.ZWSP}${s.name||s.refText.replace(new RegExp(S.ZWSP,"g"),"")}</span>`;else if(a==="av"){let r=s.name||s.refText.replace(new RegExp(S.ZWSP,"g"),"");n&&(r=s.ial["custom-sy-av-s-text-"+n.getAttribute("data-av-id")]||r),l=`<span data-type="block-ref" data-id="${s.id}" data-subtype="s">${r}</span>`}i.push({value:l,html:As(s)})}),a==="search"&&(t.hint.splitChar="((",t.hint.lastIndex=-1),i.length===0?i.push({value:"",html:window.siyuan.languages.emptyContent}):o.data.newDoc&&i.length>1&&(i[1].focus=!0),t.hint.genHTML(i,t,!0,a)}),[]},Ju=(e,t)=>{if(e.endsWith("}}")||e.endsWith("\u300D\u300D"))return[];t.hint.genLoading(t);const a=hasClosestBlock(getEditorRange(t.wysiwyg.element).startContainer);return fetchPost("/api/search/searchRefBlock",{k:e,isDatabase:!1,beforeLen:Math.floor((Math.max(t.element.clientWidth/2,320)-58)/28.8),id:a?a.getAttribute("data-node-id"):t.block.parentID,rootID:t.block.rootID},n=>{const o=[];n.data.blocks.forEach(i=>{o.push({value:`{{select * from blocks where id='${i.id}'}}`,html:As(i)})}),o.length===0&&o.push({value:"",html:window.siyuan.languages.emptyContent}),t.hint.genHTML(o,t,!0,"hint")}),[]},Qu=(e,t,a)=>{fetchPost("/api/template/render",{id:t.block.parentID,path:e},n=>{focusByRange(t.toolbar.range);const o=getContenteditableElement(a);o&&o.textContent.trim()===""?insertHTML(n.data.content,t,!0):insertHTML(n.data.content,t),t.wysiwyg.element.querySelectorAll('[status="temp"]').forEach(i=>{i.remove()}),blockRender(t,t.wysiwyg.element),processRender(t.wysiwyg.element),highlightRender(t.wysiwyg.element),avRender(t.wysiwyg.element,t),hideElements(["util"],t)})},ef=(e,t)=>{focusByRange(t.toolbar.range),insertHTML(t.lute.SpinBlockDOM(`<iframe src="/widgets/${e}/" data-subtype="widget" border="0" frameborder="no" framespacing="0" allowfullscreen="true"></iframe>`),t,!0),hideElements(["util"],t)},tf=(e,t)=>{focusByRange(t.toolbar.range);const a=pathPosix().extname(e).toLowerCase(),n=e.startsWith("assets/")?getAssetName(e):e;insertHTML(genAssetHTML(a,e,n,e.startsWith("assets/")?n+a:e),t),hideElements(["util"],t)},af=(e,t,a)=>{if(e==="/")return;const n=getDisplayName(e,!0,!0);if(a.block.rootID===n)return;const o=[];let i;const s=t[0].parentElement;let l;if(t.forEach((r,c)=>{c===t.length-1&&r.parentElement&&(i=getTopAloneElement(r),l=i.nextElementSibling||i.previousElementSibling,i.isSameNode(r)&&(i=void 0)),o.push({action:"append",id:r.getAttribute("data-node-id"),parentID:n}),r.remove()}),i)o.push({action:"delete",id:i.getAttribute("data-node-id")}),i.remove();else if(s.classList.contains("list")&&s.getAttribute("data-subtype")==="o"&&s.childElementCount>1)updateListOrder(s,1),Array.from(s.children).forEach(r=>{r.classList.contains("protyle-attr")||o.push({action:"update",id:r.getAttribute("data-node-id"),data:r.outerHTML})});else if(a.block.showAll&&s.classList.contains("protyle-wysiwyg")&&s.childElementCount===0)setTimeout(()=>{zoomOut({protyle:a,id:a.block.parent2ID,focusId:a.block.parent2ID})},Constants.TIMEOUT_INPUT*2+100);else if(s.classList.contains("protyle-wysiwyg")&&s.innerHTML===""&&!hasClosestByClassName(s,"block__edit",!0)&&a.block.id===a.block.rootID){const r=Lute.NewNodeID(),c=genEmptyElement(!1,!1,r);o.splice(0,0,{action:"insert",id:r,data:c.outerHTML,parentID:a.block.parentID}),s.innerHTML=c.outerHTML,focusBlock(c)}else l&&focusBlock(l);transaction(a,o)};var nl=(e,t,a)=>new Promise((n,o)=>{var i=r=>{try{l(a.next(r))}catch(c){o(c)}},s=r=>{try{l(a.throw(r))}catch(c){o(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(i,s);l((a=a.apply(e,t)).next())});const pe=e=>{e.menu.addItem({iconHTML:"",label:Ls(e.operator,!!e.data),click(){if(!e.data)transaction(e.protyle,[{action:"setAttrViewColCalc",avID:e.avId,id:e.colId,data:{operator:e.operator},blockID:e.blockID}],[{action:"setAttrViewColCalc",avID:e.avId,id:e.colId,data:{operator:e.oldOperator},blockID:e.blockID}]);else{e.target.querySelector(".b3-menu__accelerator").textContent=Ls(e.operator,!0);const t=e.data.view.columns.find(a=>{if(a.id===e.colId)return a.rollup||(a.rollup={}),!0});t.rollup.calc={operator:e.operator},transaction(e.protyle,[{action:"updateAttrViewColRollup",id:e.colId,avID:e.avId,parentID:t.rollup.relationKeyID,keyID:t.rollup.keyID,data:{calc:t.rollup.calc}}],[{action:"updateAttrViewColRollup",id:e.colId,avID:e.avId,parentID:t.rollup.relationKeyID,keyID:t.rollup.keyID,data:{calc:{operator:e.oldOperator}}}])}}})},nf=(e,t,a,n)=>nl(void 0,null,function*(){let o,i,s,l,r,c;if(a)l=a.data.id,i=t.dataset.colType,r=t.dataset.calc,s=a.colId,c=a.blockID;else{const f=hasClosestBlock(t);if(!f||(o=hasClosestByClassName(t,"av__row--footer"),!o))return;o.classList.add("av__row--show"),i=t.dataset.dtype,s=t.dataset.colId,l=f.dataset.avId,r=t.dataset.operator,c=f.dataset.nodeId}if(i==="lineNumber")return;const d=new Menu("av-calc",()=>{o&&o.classList.remove("av__row--show")});if(d.isOpen)return;pe({menu:d,protyle:e,colId:s,avId:l,oldOperator:r,operator:"",data:a==null?void 0:a.data,blockID:c,target:t}),pe({menu:d,protyle:e,colId:s,avId:l,oldOperator:r,operator:"Count all",data:a==null?void 0:a.data,blockID:c,target:t}),i!=="checkbox"?(pe({menu:d,protyle:e,colId:s,avId:l,oldOperator:r,operator:"Count empty",data:a==null?void 0:a.data,blockID:c,target:t}),pe({menu:d,protyle:e,colId:s,avId:l,oldOperator:r,operator:"Count not empty",data:a==null?void 0:a.data,blockID:c,target:t}),pe({menu:d,protyle:e,colId:s,avId:l,oldOperator:r,operator:"Count values",data:a==null?void 0:a.data,blockID:c,target:t}),pe({menu:d,protyle:e,colId:s,avId:l,oldOperator:r,operator:"Count unique values",data:a==null?void 0:a.data,blockID:c,target:t}),pe({menu:d,protyle:e,colId:s,avId:l,oldOperator:r,operator:"Percent empty",data:a==null?void 0:a.data,blockID:c,target:t}),pe({menu:d,protyle:e,colId:s,avId:l,oldOperator:r,operator:"Percent not empty",data:a==null?void 0:a.data,blockID:c,target:t}),pe({menu:d,protyle:e,colId:s,avId:l,oldOperator:r,operator:"Percent unique values",data:a==null?void 0:a.data,blockID:c,target:t})):(pe({menu:d,protyle:e,colId:s,avId:l,oldOperator:r,operator:"Checked",data:a==null?void 0:a.data,blockID:c,target:t}),pe({menu:d,protyle:e,colId:s,avId:l,oldOperator:r,operator:"Unchecked",data:a==null?void 0:a.data,blockID:c,target:t}),pe({menu:d,protyle:e,colId:s,avId:l,oldOperator:r,operator:"Percent checked",data:a==null?void 0:a.data,blockID:c,target:t}),pe({menu:d,protyle:e,colId:s,avId:l,oldOperator:r,operator:"Percent unchecked",data:a==null?void 0:a.data,blockID:c,target:t}));let u=!1;if(i==="rollup"){let f,p,m=a==null?void 0:a.data;if(m||(m=(yield fetchSyncPost("api/av/renderAttributeView",{id:l})).data),m.view.columns.find(b=>{var w,y;if(b.id===s)return f=(w=b.rollup)==null?void 0:w.relationKeyID,p=(y=b.rollup)==null?void 0:y.keyID,!0}),f&&p){let b;m.view.columns.find(w=>{var y;if(w.id===f)return b=(y=w.relation)==null?void 0:y.avID,!0}),b&&(yield fetchSyncPost("api/av/getAttributeView",{id:b})).data.av.keyValues.find(y=>{if(y.key.id===p)return u=y.key.type==="number",!0})}}["number","template"].includes(i)||u?(pe({menu:d,protyle:e,colId:s,avId:l,oldOperator:r,operator:"Sum",data:a==null?void 0:a.data,blockID:c,target:t}),pe({menu:d,protyle:e,colId:s,avId:l,oldOperator:r,operator:"Average",data:a==null?void 0:a.data,blockID:c,target:t}),pe({menu:d,protyle:e,colId:s,avId:l,oldOperator:r,operator:"Median",data:a==null?void 0:a.data,blockID:c,target:t}),pe({menu:d,protyle:e,colId:s,avId:l,oldOperator:r,operator:"Min",data:a==null?void 0:a.data,blockID:c,target:t}),pe({menu:d,protyle:e,colId:s,avId:l,oldOperator:r,operator:"Max",data:a==null?void 0:a.data,blockID:c,target:t}),pe({menu:d,protyle:e,colId:s,avId:l,oldOperator:r,operator:"Range",data:a==null?void 0:a.data,blockID:c,target:t})):["date","created","updated"].includes(i)&&(pe({menu:d,protyle:e,colId:s,avId:l,oldOperator:r,operator:"Earliest",data:a==null?void 0:a.data,blockID:c,target:t}),pe({menu:d,protyle:e,colId:s,avId:l,oldOperator:r,operator:"Latest",data:a==null?void 0:a.data,blockID:c,target:t}),pe({menu:d,protyle:e,colId:s,avId:l,oldOperator:r,operator:"Range",data:a==null?void 0:a.data,blockID:c,target:t}));const g=t.getBoundingClientRect();d.open({x:Math.max(n||0,g.left),y:g.bottom,h:g.height})}),sl=e=>{if(!e.calc||!e.calc.result)return"";let t=e.calc.result.number;(e.calc.operator==="Earliest"||e.calc.operator==="Latest"||e.calc.operator==="Range"&&["date","created","updated"].includes(e.type))&&(t=e.calc.result[e.type]);let a="";switch(e.calc.operator){case"Count all":a=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.calcResultCountAll}</small>`;break;case"Count values":a=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.calcResultCountValues}</small>`;break;case"Count unique values":a=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.calcResultCountUniqueValues}</small>`;break;case"Count empty":a=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.calcResultCountEmpty}</small>`;break;case"Count not empty":a=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.calcResultCountNotEmpty}</small>`;break;case"Percent empty":a=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.calcResultPercentEmpty}</small>`;break;case"Percent not empty":a=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.calcResultPercentNotEmpty}</small>`;break;case"Percent unique values":a=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.calcResultPercentUniqueValues}</small>`;break;case"Sum":a=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.calcResultSum}</small>`;break;case"Average":a=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.calcResultAverage}</small>`;break;case"Median":a=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.calcResultMedian}</small>`;break;case"Min":a=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.calcResultMin}</small>`;break;case"Max":a=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.calcResultMax}</small>`;break;case"Range":a=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.calcResultRange}</small>`;break;case"Earliest":a=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.calcOperatorEarliest}</small>`;break;case"Latest":a=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.calcOperatorLatest}</small>`;break;case"Checked":a=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.checked}</small>`;break;case"Unchecked":a=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.unchecked}</small>`;break;case"Percent checked":a=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.percentChecked}</small>`;break;case"Percent unchecked":a=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.percentUnchecked}</small>`;break}return a},Ls=(e,t)=>{switch(e){case void 0:case"":return t?window.siyuan.languages.original:window.siyuan.languages.calcOperatorNone;case"Count all":return window.siyuan.languages.calcOperatorCountAll;case"Count values":return window.siyuan.languages.calcOperatorCountValues;case"Count unique values":return window.siyuan.languages.calcOperatorCountUniqueValues;case"Count empty":return window.siyuan.languages.calcOperatorCountEmpty;case"Count not empty":return window.siyuan.languages.calcOperatorCountNotEmpty;case"Percent empty":return window.siyuan.languages.calcOperatorPercentEmpty;case"Percent not empty":return window.siyuan.languages.calcOperatorPercentNotEmpty;case"Percent unique values":return window.siyuan.languages.calcOperatorPercentUniqueValues;case"Checked":return window.siyuan.languages.checked;case"Unchecked":return window.siyuan.languages.unchecked;case"Percent checked":return window.siyuan.languages.percentChecked;case"Percent unchecked":return window.siyuan.languages.percentUnchecked;case"Sum":return window.siyuan.languages.calcOperatorSum;case"Average":return window.siyuan.languages.calcOperatorAverage;case"Median":return window.siyuan.languages.calcOperatorMedian;case"Min":return window.siyuan.languages.calcOperatorMin;case"Max":return window.siyuan.languages.calcOperatorMax;case"Range":return window.siyuan.languages.calcOperatorRange;case"Earliest":return window.siyuan.languages.calcOperatorEarliest;case"Latest":return window.siyuan.languages.calcOperatorLatest;default:return""}};var il=(e,t,a)=>new Promise((n,o)=>{var i=r=>{try{l(a.next(r))}catch(c){o(c)}},s=r=>{try{l(a.throw(r))}catch(c){o(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(i,s);l((a=a.apply(e,t)).next())});const sf=(e,t)=>{if(isOnlyMeta(t))return!1;const a=hasClosestBlock(t.target);if(!a)return!1;if(hasClosestByAttribute(t.target,"data-type","av-load-more")&&!hasClosestByAttribute(t.target,"data-type","set-page-size"))return a.querySelector(".av__row--footer").style.transform="",a.removeAttribute("data-render"),a.dataset.pageSize=(parseInt(a.dataset.pageSize)+parseInt(a.querySelector('[data-type="set-page-size"]').getAttribute("data-size"))).toString(),avRender(a,e),t.preventDefault(),t.stopPropagation(),!0;const o=hasClosestByClassName(t.target,"av__firstcol");if(o)return window.siyuan.menus.menu.remove(),selectRow(o,"toggle"),t.preventDefault(),t.stopPropagation(),!0;const i=hasClosestByClassName(t.target,"av__cellassetimg");if(i)return previewImage(i.src),t.preventDefault(),t.stopPropagation(),!0;if(t.shiftKey){const d=hasClosestByClassName(t.target,"av__row");if(d&&!d.classList.contains("av__row--header"))return selectRow(d.querySelector(".av__firstcol"),"toggle"),t.preventDefault(),t.stopPropagation(),!0}const s=hasClosestByAttribute(t.target,"data-type","copy");if(s)return writeText(getCellText(hasClosestByClassName(s,"av__cell"))),showMessage(window.siyuan.languages.copied),t.preventDefault(),t.stopPropagation(),!0;if(hasClosestByAttribute(t.target,"data-type","av-search-icon")){const d=a.querySelector('input[data-type="av-search"]');d.style.width="128px",d.style.paddingLeft="",d.style.paddingRight="";const u=hasClosestByClassName(d,"av__views");return u&&u.classList.add("av__views--show"),setTimeout(()=>{d.focus()},Constants.TIMEOUT_TRANSITION),t.preventDefault(),t.stopPropagation(),!0}const r=hasClosestByClassName(t.target,"item");if(r&&r.parentElement.classList.contains("layout-tab-bar"))return r.classList.contains("item--focus")?openViewMenu({protyle:e,blockElement:a,element:r}):(a.removeAttribute("data-render"),avRender(a,e,void 0,r.dataset.id)),t.preventDefault(),t.stopPropagation(),!0;if(e.disabled)return!1;let c=t.target;for(;c&&!c.isEqualNode(a);){const d=c.getAttribute("data-type");if(d==="av-header-add"){const u=addCol(e,a),g=c.getBoundingClientRect();return u.open({x:g.left,y:g.bottom,h:g.height}),t.preventDefault(),t.stopPropagation(),!0}else{if(d==="av-header-more")return openMenuPanel({protyle:e,blockElement:a,type:"properties"}),t.preventDefault(),t.stopPropagation(),!0;if(d==="av-add-more")return insertRows(a,e,1,void 0),t.preventDefault(),t.stopPropagation(),!0;if(d==="av-more")return openMenuPanel({protyle:e,blockElement:a,type:"config"}),t.preventDefault(),t.stopPropagation(),!0;if(d==="av-switcher")return openMenuPanel({protyle:e,blockElement:a,type:"switcher"}),t.preventDefault(),t.stopPropagation(),!0;if(d==="av-sort")return openMenuPanel({protyle:e,blockElement:a,type:"sorts"}),t.preventDefault(),t.stopPropagation(),!0;if(d==="av-filter")return openMenuPanel({protyle:e,blockElement:a,type:"filters"}),t.preventDefault(),t.stopPropagation(),!0;if(d==="av-add")return addView(e,a),t.preventDefault(),t.stopPropagation(),!0;if(d==="block-more")return window.siyuan.menus.menu.remove(),e.toolbar.range=document.createRange(),e.toolbar.range.selectNodeContents(c),focusByRange(e.toolbar.range),c.parentElement.classList.add("av__cell--select"),addDragFill(c.parentElement),hintRef(c.previousElementSibling.textContent.trim(),e,"av"),t.preventDefault(),t.stopPropagation(),!0;if(d==="set-page-size")return setPageSize({target:c,protyle:e,avID:a.getAttribute("data-av-id"),nodeElement:a}),t.preventDefault(),t.stopPropagation(),!0;if(d==="av-add-bottom")return insertRows(a,e,1,a.querySelector(".av__row--util").previousElementSibling.getAttribute("data-id")||""),t.preventDefault(),t.stopPropagation(),!0;if(c.classList.contains("av__cell--header"))return showColMenu(e,a,c),t.preventDefault(),t.stopPropagation(),!0;if(c.classList.contains("av__cell")){if(!hasClosestByClassName(c,"av__row--header")){const u=hasClosestByClassName(c,"av__scroll");if(!u||c.querySelector(".av__pulse"))return;const g=hasClosestByClassName(c,"av__row");if(!g)return;const f=getTypeByCellElement(c);f==="updated"||f==="created"||f==="lineNumber"?selectRow(g.querySelector(".av__firstcol"),"toggle"):(u.querySelectorAll(".av__row--select").forEach(p=>{p.querySelector(".av__firstcol use").setAttribute("xlink:href","#iconUncheck"),p.classList.remove("av__row--select")}),updateHeader(g),popTextCell(e,[c]))}return t.preventDefault(),t.stopPropagation(),!0}else{if(c.classList.contains("av__calc"))return openCalcMenu(e,c,void 0,t.clientX-64),t.preventDefault(),t.stopPropagation(),!0;if(c.classList.contains("b3-menu__avemoji")){const u=c.getBoundingClientRect();return openEmojiPanel(c.parentElement.getAttribute("data-block-id"),"doc",{x:u.left,y:u.bottom,h:u.height,w:u.width},g=>{c.innerHTML=unicode2Emoji(g||window.siyuan.storage[Constants.LOCAL_IMAGES].file)},c.querySelector("img")),t.preventDefault(),t.stopPropagation(),!0}}}c=c.parentElement}return!1},of=(e,t,a)=>{var n;if(hideElements(["hint"],e),t.classList.contains("av__row--header"))return!1;const o=hasClosestBlock(t);if(!o)return!1;o.querySelectorAll(".av__cell--select, .av__cell--active").forEach(u=>{var g;u.classList.remove("av__cell--select","av__cell--active"),(g=u.querySelector(".av__drag-fill"))==null||g.remove()}),t.classList.contains("av__row--select")||(o.querySelectorAll(".av__row--select").forEach(u=>{u.classList.remove("av__row--select")}),o.querySelectorAll(".av__firstcol use").forEach(u=>{u.setAttribute("xlink:href","#iconUncheck")}));const i=new Menu;t.classList.add("av__row--select"),t.querySelector(".av__firstcol use").setAttribute("xlink:href","#iconCheck");const s=o.querySelectorAll(".av__row--select:not(.av__row--header)");updateHeader(t);const l=s[0].querySelector(".av__cell[data-block-id]"),r=Array.from(s).map(u=>u.getAttribute("data-id"));s.length===1&&l.getAttribute("data-detached");let c=!1;s.forEach(u=>{u.querySelector('.av__cell[data-dtype="block"]').getAttribute("data-detached")!=="true"&&(c=!0)});const d=[{id:"copyKeyContent",iconHTML:"",label:window.siyuan.languages.copyKeyContent,click(){let u="";s.forEach((g,f)=>{s.length>1&&(u+="* "),u+=g.querySelector('.av__cell[data-dtype="block"] .av__celltext').textContent.trim(),r.length>1&&f!==r.length-1&&(u+=`
`)}),writeText(u)}}];if(c&&d.splice(1,0,{id:"copyBlockRef",iconHTML:"",label:window.siyuan.languages.copyBlockRef,click:()=>{let u="";for(let g=0;g<r.length;g++){const f=r[g];let p="";const m=s[g].querySelector(".av__cell[data-dtype='block']");m.getAttribute("data-detached")==="true"?p=m.querySelector(".av__celltext").textContent:p=`((${f} '${m.querySelector(".av__celltext").textContent.replace(/[\n]+/g," ")}'))`,r.length>1&&(u+="* "),u+=p,r.length>1&&g!==r.length-1&&(u+=`
`)}writeText(u)}},{id:"copyBlockEmbed",iconHTML:"",label:window.siyuan.languages.copyBlockEmbed,click:()=>{let u="";r.forEach((g,f)=>{r.length>1&&(u+="* ");const p=s[f].querySelector(".av__cell[data-dtype='block']");p.getAttribute("data-detached")==="true"?u+=p.querySelector(".av__celltext").textContent:u+=`{{select * from blocks where id='${g}'}}`,r.length>1&&f!==r.length-1&&(u+=`
`)}),writeText(u)}},{id:"copyProtocol",iconHTML:"",label:window.siyuan.languages.copyProtocol,click:()=>{let u="";r.forEach((g,f)=>{r.length>1&&(u+="* ");const p=s[f].querySelector(".av__cell[data-dtype='block']");p.getAttribute("data-detached")==="true"?u+=p.querySelector(".av__celltext").textContent:u+=`siyuan://blocks/${g}`,r.length>1&&f!==r.length-1&&(u+=`
`)}),writeText(u)}},{id:"copyProtocolInMd",iconHTML:"",label:window.siyuan.languages.copyProtocolInMd,click:()=>{let u="";for(let g=0;g<r.length;g++){const f=r[g];let p="";const m=s[g].querySelector(".av__cell[data-dtype='block']");m.getAttribute("data-detached")==="true"?p=m.querySelector(".av__celltext").textContent:p=`[${m.querySelector(".av__celltext").textContent.replace(/[\n]+/g," ")}](siyuan://blocks/${f})`,r.length>1&&(u+="* "),u+=p,r.length>1&&g!==r.length-1&&(u+=`
`)}writeText(u)}},{id:"copyHPath",iconHTML:"",label:window.siyuan.languages.copyHPath,click:()=>il(void 0,null,function*(){let u="";for(let g=0;g<r.length;g++){const f=r[g];let p="";const m=s[g].querySelector(".av__cell[data-dtype='block']");m.getAttribute("data-detached")==="true"?p=m.querySelector(".av__celltext").textContent:p=(yield fetchSyncPost("/api/filetree/getHPathByID",{id:f})).data,r.length>1&&(u+="* "),u+=p,r.length>1&&g!==r.length-1&&(u+=`
`)}writeText(u)})},{id:"copyID",iconHTML:"",label:window.siyuan.languages.copyID,click:()=>{let u="";r.forEach((g,f)=>{r.length>1&&(u+="* ");const p=s[f].querySelector(".av__cell[data-dtype='block']");p.getAttribute("data-detached")==="true"?u+=p.querySelector(".av__celltext").textContent:u+=g,r.length>1&&f!==r.length-1&&(u+=`
`)}),writeText(u)}}),i.addItem({id:"copy",label:window.siyuan.languages.copy,icon:"iconCopy",type:"submenu",submenu:d}),!e.disabled){i.addItem({id:"addToDatabase",label:window.siyuan.languages.addToDatabase,icon:"iconDatabase",click(){openSearchAV(o.getAttribute("data-av-id"),s[0],g=>{const f=[],p=[];s.forEach(b=>{const w=b.getAttribute("data-id"),y=genCellValueByElement("block",b.querySelector(".av__cell[data-block-id]"));f.push({content:y.block.content,id:w,isDetached:y.isDetached}),p.push(w)});const m=g.dataset.avId;transaction(e,[{action:"insertAttrViewBlock",avID:m,ignoreFillFilter:!0,srcs:f,blockID:g.dataset.blockId},{action:"doUpdateUpdated",id:g.dataset.blockId,data:dayjs().format("YYYYMMDDHHmmss")}],[{action:"removeAttrViewBlock",srcIDs:p,avID:m}])})}}),s.length===1&&(l.getAttribute("data-detached")!=="true"&&i.addSeparator({id:"separator_1"}),i.addItem({id:"insertRowBefore",icon:"iconBefore",label:`<div class="fn__flex" style="align-items: center;">
${window.siyuan.languages.insertRowBefore.replace("${x}",`<span class="fn__space"></span><input style="width:64px" type="number" step="1" min="1" value="1" placeholder="${window.siyuan.languages.enterKey}" class="b3-text-field"><span class="fn__space"></span>`)}
</div>`,bind(g){const f=g.querySelector("input");g.addEventListener("click",()=>{document.activeElement.isSameNode(f)||(insertRows(o,e,parseInt(f.value),s[0].previousElementSibling.getAttribute("data-id")),i.close())}),f.addEventListener("keydown",p=>{!p.isComposing&&p.key==="Enter"&&(insertRows(o,e,parseInt(f.value),s[0].previousElementSibling.getAttribute("data-id")),i.close())})}}),i.addItem({id:"insertRowAfter",icon:"iconAfter",label:`<div class="fn__flex" style="align-items: center;">
${window.siyuan.languages.insertRowAfter.replace("${x}",`<span class="fn__space"></span><input style="width:64px" type="number" step="1" min="1" placeholder="${window.siyuan.languages.enterKey}" class="b3-text-field" value="1"><span class="fn__space"></span>`)}
</div>`,bind(g){const f=g.querySelector("input");g.addEventListener("click",()=>{document.activeElement.isSameNode(f)||(insertRows(o,e,parseInt(f.value),s[0].getAttribute("data-id")),i.close())}),f.addEventListener("keydown",p=>{!p.isComposing&&p.key==="Enter"&&(insertRows(o,e,parseInt(f.value),s[0].getAttribute("data-id")),i.close())})}}),i.addSeparator({id:"separator_2"}),l.getAttribute("data-detached")!=="true"&&i.addItem({id:"unbindBlock",label:window.siyuan.languages.unbindBlock,icon:"iconLinkOff",click(){updateCellsValue(e,o,{content:l.querySelector(".av__celltext").textContent},[l])}})),i.addItem({id:"delete",icon:"iconTrashcan",label:window.siyuan.languages.delete,click(){deleteRow(o,e)}});const u=[];t.parentElement.querySelectorAll(".av__row--header .av__cell").forEach(g=>{const f=Array.from(o.querySelectorAll(`.av__row--select:not(.av__row--header) .av__cell[data-col-id="${g.dataset.colId}"]`)),p=g.getAttribute("data-dtype");if(!["updated","created"].includes(p)){const m=g.dataset.icon;u.push({iconHTML:m?unicode2Emoji(m,"b3-menu__icon",!0):`<svg class="b3-menu__icon"><use xlink:href="#${getColIconByType(p)}"></use></svg>`,label:escapeHtml(g.querySelector(".av__celltext").textContent.trim()),click(){popTextCell(e,f)}})}}),i.addItem({id:"fields",icon:"iconAttr",label:window.siyuan.languages.fields,type:"submenu",submenu:u})}return(n=e==null?void 0:e.app)!=null&&n.plugins&&emitOpenMenu({plugins:e.app.plugins,type:"open-menu-av",detail:{protyle:e,element:o,selectRowElements:s},separatorPosition:"top"}),i.open(a),!0},lf=(e,t)=>{const a=t.getAttribute("data-av-id"),n=t.getAttribute("data-node-id"),o=t.querySelector(".av__title"),i=o.textContent.trim();if(i===o.dataset.title.trim())return;const s=dayjs().format("YYYYMMDDHHmmss");transaction(e,[{action:"setAttrViewName",id:a,data:i},{action:"doUpdateUpdated",id:n,data:s}],[{action:"setAttrViewName",id:a,data:o.dataset.title},{action:"doUpdateUpdated",id:n,data:t.getAttribute("updated")}]),t.setAttribute("updated",s),o.dataset.title=i,Array.from(e.wysiwyg.element.querySelectorAll(`[data-av-id="${a}"]`)).forEach(l=>{if(t.isSameNode(l))return;const r=l.querySelector(".av__title");r&&(r.textContent=i,r.dataset.title=i)})},rf=(e,t,a)=>{if(e)if(a)updateHeaderCell(e,a);else{const n=e.querySelector(".av__drag-fill");e.innerHTML=renderCell(t),n&&addDragFill(e),renderCellAttr(e,t)}},cf=(e,t)=>{e.querySelectorAll(`.av__cell[data-col-id="${t}"]`).forEach(a=>{a.remove()})},df=(e,t)=>{fetchPost("/api/av/duplicateAttributeViewBlock",{avID:t.getAttribute("data-av-id")},a=>{t.classList.remove("protyle-wysiwyg--select");const n=document.createElement("template");n.innerHTML=e.lute.SpinBlockDOM(`<div data-node-id="${a.data.blockID}" data-av-id="${a.data.avID}" data-type="NodeAttributeView" data-av-type="table"></div>`);const o=n.content.firstElementChild;t.after(o),avRender(o,e,()=>{focusBlock(o),scrollCenter(e)}),transaction(e,[{action:"insert",data:o.outerHTML,id:a.data.blockID,previousID:t.dataset.nodeId}],[{action:"delete",id:a.data.blockID}])})};let Se;const gn=(e,t,a=[])=>{let n="",o=!1;if(a.length===0&&document.querySelectorAll(".av__panel .b3-chips .b3-chip").forEach(i=>{a.push(i.dataset.content)}),t&&t.forEach(i=>{if(!e||e.toLowerCase().indexOf(i.name.toLowerCase())>-1||i.name.toLowerCase().indexOf(e.toLowerCase())>-1){const s=i.desc?`${escapeAriaLabel(i.name)}<div class='ft__on-surface'>${escapeAriaLabel(i.desc||"")}</div>`:"";n+=`<button data-type="addColOptionOrCell" class="b3-menu__item" data-name="${escapeAttr(i.name)}" data-desc="${escapeAttr(i.desc||"")}" draggable="true" data-color="${i.color}">
    <svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>
    <div class="fn__flex-1 ariaLabel" data-position="parentW" aria-label="${s}">
        <span class="b3-chip" style="background-color:var(--b3-font-background${i.color});color:var(--b3-font-color${i.color})">
            <span class="fn__ellipsis">${escapeHtml(i.name)}</span>
        </span>
    </div>
    <svg class="b3-menu__action" data-type="setColOption"><use xlink:href="#iconEdit"></use></svg>
    ${a.includes(i.name)?'<svg class="b3-menu__checked"><use xlink:href="#iconSelect"></use></svg></span>':""}
</button>`}e===i.name&&(o=!0)}),!o&&e){const i=((t==null?void 0:t.length)||0)%14+1;n=`<button data-type="addColOptionOrCell" class="b3-menu__item b3-menu__item--current" data-name="${e}" data-color="${i}">
<svg class="b3-menu__icon"><use xlink:href="#iconAdd"></use></svg>
<div class="fn__flex-1">
    <span class="b3-chip" style="background-color:var(--b3-font-background${i});color:var(--b3-font-color${i})">
        <span class="fn__ellipsis">${escapeHtml(e)}</span>
    </span>
</div>
<span class="b3-menu__accelerator">${window.siyuan.languages.enterKey}</span>
</button>${n}`}return n},Ss=(e,t,a,n)=>{if(!a)return;const o=t[0].dataset.colId,i=[],s=[];let l;const r=n.getAttribute("data-av-id");t.forEach((c,d)=>{var u;if(!n.contains(c)){const m=hasClosestByClassName(c,"av__row");m&&(c=t[d]=n.querySelector(`.av__row[data-id="${m.dataset.id}"] .av__cell[data-col-id="${c.dataset.colId}"]`)||n.querySelector(`.fn__flex-1[data-col-id="${c.dataset.colId}"]`))}const g=hasClosestByClassName(c,"av__row").dataset.id,f=Se[d],p=JSON.parse(JSON.stringify(f));d===0?((u=f.mSelect)==null||u.find((m,b)=>{if(m.content===a.dataset.content)return f.mSelect.splice(b,1),!0}),l=f.mSelect):f.mSelect=l,i.push({action:"updateAttrViewCell",id:f.id,keyID:o,rowID:g,avID:r,data:f}),s.push({action:"updateAttrViewCell",id:f.id,keyID:o,rowID:g,avID:r,data:p}),c.classList.contains("custom-attr__avvalue")?c.innerHTML=genAVValueHTML(f):updateAttrViewCellAnimation(c,f)}),transaction(e,i,s),Array.from(document.querySelectorAll(".av__panel .b3-menu__item")).find(c=>{var d;if(c.dataset.name===a.dataset.content)return(d=c.querySelector(".b3-menu__checked"))==null||d.remove(),!0}),a.remove()},uf=(e,t,a,n,o,i)=>{const s=hasClosestByClassName(a,"b3-menu");if(!s)return;const l=n.getAttribute("data-node-id"),r=i?i[0].dataset.colId:s.querySelector(".b3-menu__item").getAttribute("data-col-id");let c=a.parentElement.dataset.name,d=a.parentElement.dataset.desc,u=a.parentElement.dataset.color;const g=new Menu("av-col-option",()=>{if(c===m.value&&d===b.value||!m.value)return;transaction(e,[{action:"updateAttrViewColOption",id:r,avID:t.id,data:{newColor:u,oldName:c,newName:m.value,newDesc:b.value}}],[{action:"updateAttrViewColOption",id:r,avID:t.id,data:{newColor:u,oldName:m.value,newName:c,newDesc:d}}]),t.view.columns.find(h=>{if(h.id===r){let E=!1;return h.options.find(C=>{if(C.name===m.value)return E=!0,!0}),E||h.options.find(C=>{if(C.name===c)return C.name=m.value,C.desc=b.value,!0}),!0}});const w=s.querySelector(".b3-menu__items").scrollTop,y=s.querySelector(".b3-chips"),_=y?y.clientHeight:0;i?(i.forEach((h,E)=>{const C=hasClosestByClassName(h,"av__row");C&&(h=i[E]=n.querySelector(`.av__row[data-id="${C.dataset.id}"] .av__cell[data-col-id="${h.dataset.colId}"]`)||n.querySelector(`.fn__flex-1[data-col-id="${h.dataset.colId}"]`)),Se[E].mSelect.find(k=>{if(k.content===c)return k.content=m.value,!0}),h.classList.contains("custom-attr__avvalue")?h.innerHTML=genAVValueHTML(Se[E]):updateAttrViewCellAnimation(h,Se[E])}),s.innerHTML=ha(t.view,i),ya(e,t,s,i,n)):(s.innerHTML=getEditHTML({protyle:e,data:t,colId:r,isCustomAttr:o}),bindEditEvent({protyle:e,data:t,menuElement:s,isCustomAttr:o,blockID:l})),y&&(s.querySelector(".b3-menu__items").scrollTop=w+(s.querySelector(".b3-chips").clientHeight-_))});if(g.isOpen)return;g.addItem({iconHTML:"",type:"empty",label:`<div class="fn__hr"></div>
<div class="b3-form__icona fn__block">
    <input class="b3-text-field b3-form__icona-input" type="text">
    <svg data-position="north" class="b3-form__icona-icon ariaLabel" aria-label="${d?escapeAriaLabel(d):window.siyuan.languages.addDesc}"><use xlink:href="#iconInfo"></use></svg>
</div>
<div class="fn__none">
    <div class="fn__hr"></div>
    <textarea rows="1" placeholder="${window.siyuan.languages.addDesc}" class="b3-text-field fn__block" type="text" data-value="${escapeAttr(d)}">${d}</textarea>
</div>
<div class="fn__hr--small"></div>`,bind(w){const y=w.querySelector("input");y.addEventListener("keydown",h=>{h.isComposing||h.key==="Enter"&&g.close()}),y.value=c;const _=w.querySelector("textarea");y.nextElementSibling.addEventListener("click",()=>{const h=_.parentElement;h.classList.toggle("fn__none"),h.classList.contains("fn__none")||_.focus()}),_.addEventListener("keydown",h=>{h.isComposing||h.key==="Enter"&&g.close()}),_.addEventListener("input",()=>{y.nextElementSibling.setAttribute("aria-label",_.value?escapeHtml(_.value):window.siyuan.languages.addDesc)})}}),g.addItem({id:"delete",label:window.siyuan.languages.delete,icon:"iconTrashcan",click(){confirmDialog(window.siyuan.languages.deleteOpConfirm,window.siyuan.languages.confirmDelete,()=>{let w=[];t.view.columns.find(C=>{if(C.id===r)return w=C.options,!0});const y=a.parentElement.dataset.name;transaction(e,[{action:"removeAttrViewColOption",id:r,avID:t.id,data:y}],[{action:"updateAttrViewColOptions",id:r,avID:t.id,data:w}]),w.find((C,k)=>{if(C.name===y)return w.splice(k,1),!0});const _=s.querySelector(".b3-menu__items").scrollTop,h=s.querySelector(".b3-chips"),E=h?h.clientHeight:0;i?(i.forEach((C,k)=>{const v=hasClosestByClassName(C,"av__row");v&&(C=i[k]=n.querySelector(`.av__row[data-id="${v.dataset.id}"] .av__cell[data-col-id="${C.dataset.colId}"]`)||n.querySelector(`.fn__flex-1[data-col-id="${C.dataset.colId}"]`)),Se[k].mSelect.find((A,L)=>{if(A.content===y)return Se[k].mSelect.splice(L,1),!0}),C.classList.contains("custom-attr__avvalue")?C.innerHTML=genAVValueHTML(Se[k]):updateAttrViewCellAnimation(C,Se[k])}),s.innerHTML=ha(t.view,i),ya(e,t,s,i,n)):(s.innerHTML=getEditHTML({protyle:e,data:t,colId:r,isCustomAttr:o}),bindEditEvent({protyle:e,data:t,menuElement:s,isCustomAttr:o,blockID:l})),h&&(s.querySelector(".b3-menu__items").scrollTop=_+(s.querySelector(".b3-chips").clientHeight-E))},void 0,!0)}}),g.addSeparator();let f='<div class="fn__flex fn__flex-wrap" style="width: 238px">';Array.from(Array(14).keys()).forEach(w=>{f+=`<button data-color="${w+1}" class="color__square${parseInt(u)===w+1?" color__square--current":""}" style="color: var(--b3-font-color${w+1});background-color: var(--b3-font-background${w+1});">A</button>`}),g.addItem({type:"empty",iconHTML:"",label:f+"</div>",bind(w){w.addEventListener("click",y=>{var _;const h=y.target;if(h.classList.contains("color__square")&&!h.classList.contains("color__square--current")){(_=w.querySelector(".color__square--current"))==null||_.classList.remove("color__square--current"),h.classList.add("color__square--current");const E=h.getAttribute("data-color");transaction(e,[{action:"updateAttrViewColOption",id:r,avID:t.id,data:{oldName:c,newName:m.value,oldColor:u,newColor:E,newDesc:b.value}}],[{action:"updateAttrViewColOption",id:r,avID:t.id,data:{oldName:m.value,newName:c,oldColor:E,newColor:u,newDesc:b.value}}]),t.view.columns.find(k=>{if(k.id===r)return k.options.find(v=>{if(v.name===c)return v.name=m.value,v.color=E,!0}),!0});const C=s.querySelector(".b3-menu__items").scrollTop;i?(i.forEach((k,v)=>{const A=hasClosestByClassName(k,"av__row");A&&(k=i[v]=n.querySelector(`.av__row[data-id="${A.dataset.id}"] .av__cell[data-col-id="${k.dataset.colId}"]`)||n.querySelector(`.fn__flex-1[data-col-id="${k.dataset.colId}"]`)),Se[v].mSelect.find(L=>{if(L.content===c)return L.content=m.value,L.color=E,!0}),k.classList.contains("custom-attr__avvalue")?k.innerHTML=genAVValueHTML(Se[v]):updateAttrViewCellAnimation(k,Se[v])}),s.innerHTML=ha(t.view,i),ya(e,t,s,i,n)):(s.innerHTML=getEditHTML({protyle:e,data:t,colId:r,isCustomAttr:o}),bindEditEvent({protyle:e,data:t,menuElement:s,isCustomAttr:o,blockID:l})),s.querySelector(".b3-menu__items").scrollTop=C,c=m.value,d=b.value,u=E}})}});const p=a.getBoundingClientRect();g.open({x:p.right,y:p.bottom,w:p.width,h:p.height});const m=window.siyuan.menus.menu.element.querySelector("input");m.select();const b=window.siyuan.menus.menu.element.querySelector("textarea")},ya=(e,t,a,n,o)=>{const i=a.querySelector("input"),s=n[0].dataset.colId;let l;t.view.columns.find(c=>{if(c.id===s){l=c;return}}),l.options||(l.options=[]);const r=a.lastElementChild.lastElementChild;i.addEventListener("input",c=>{c.isComposing||(r.innerHTML=gn(i.value,l.options))}),i.addEventListener("compositionend",()=>{r.innerHTML=gn(i.value,l.options)}),i.addEventListener("keydown",c=>{if(c.isComposing)return;let d=upDownHint(r,c,"b3-menu__item--current",r.firstElementChild);c.key==="Enter"?(d||(d=a.querySelector(".b3-menu__item--current")),d.querySelector(".b3-menu__checked")?Ss(e,n,a.querySelector(`.b3-chips .b3-chip[data-content="${escapeAttr(d.dataset.name)}"]`),o):ol(e,t,n,d,a,o)):c.key==="Backspace"&&i.value===""&&Ss(e,n,i.previousElementSibling,o)})},ol=(e,t,a,n,o,i)=>{let s=!1;if(Array.from(o.querySelectorAll(".b3-chips .b3-chip")).find(f=>{if(f.dataset.content===n.dataset.name)return s=!0,!0}),s){o.querySelector("input").focus();return}hasClosestBlock(a[0])||a.forEach((f,p)=>{const m=hasClosestByClassName(f,"av__row");m&&(a[p]=i.querySelector(`.av__row[data-id="${m.dataset.id}"] .av__cell[data-col-id="${f.dataset.colId}"]`)||i.querySelector(`.fn__flex-1[data-col-id="${f.dataset.colId}"]`))});const r=a[0].dataset.colId;let c;t.view.columns.find(f=>{if(f.id===r){c=f,c.options||(c.options=[]);return}});const d=[],u=[];let g;if(a.forEach((f,p)=>{const m=hasClosestByClassName(f,"av__row");if(!m)return;const b=m.dataset.id,w=Se[p],y=JSON.parse(JSON.stringify(w));if(p===0){if(c.type==="mSelect"){let _=!1;w.mSelect.find(h=>{if(h.content===n.dataset.name)return _=!0,!0}),_||w.mSelect.push({color:n.dataset.color,content:n.dataset.name})}else w.mSelect=[{color:n.dataset.color,content:n.dataset.name}];g=w.mSelect}else w.mSelect=g;d.push({action:"updateAttrViewCell",id:w.id,keyID:r,rowID:b,avID:t.id,data:w}),u.push({action:"updateAttrViewCell",id:w.id,keyID:r,rowID:b,avID:t.id,data:y}),f.classList.contains("custom-attr__avvalue")?f.innerHTML=genAVValueHTML(w):updateAttrViewCellAnimation(f,w)}),n.querySelector(".b3-menu__accelerator")?(c.options.push({color:n.dataset.color,name:n.dataset.name}),d.splice(0,0,{action:"updateAttrViewColOptions",id:r,avID:t.id,data:c.options}),transaction(e,d,[{action:"removeAttrViewColOption",id:r,avID:t.id,data:n.dataset.name}])):transaction(e,d,u),c.type==="select")o.parentElement.remove();else{const f=o.querySelector(".b3-menu__items").scrollTop,p=o.querySelector(".b3-chips").clientHeight;o.innerHTML=ha(t.view,a),ya(e,t,o,a,i),o.querySelector("input").focus(),o.querySelector(".b3-menu__items").scrollTop=f+(o.querySelector(".b3-chips").clientHeight-p)}},ha=(e,t,a=!1)=>{var n;if(a){Se=[];const r=t[0].classList.contains("custom-attr__avvalue");t.forEach(c=>{Se.push(genCellValueByElement(r?c.dataset.type:getTypeByCellElement(c),c))})}const o=t[0].dataset.colId,i=e.columns.find(r=>{if(r.id===o)return r});let s="";const l=[];return(n=Se[0].mSelect)==null||n.forEach(r=>{l.push(r.content),s+=`<div class="b3-chip b3-chip--middle" data-content="${escapeAttr(r.content)}" style="white-space: nowrap;max-width:100%;background-color:var(--b3-font-background${r.color});color:var(--b3-font-color${r.color})"><span class="fn__ellipsis">${escapeHtml(r.content)}</span><svg class="b3-chip__close" data-type="removeCellOption"><use xlink:href="#iconCloseRound"></use></svg></div>`}),`<div class="b3-menu__items">
<div class="b3-chips" style="max-width: 50vw">
    ${s}
    <input>
</div>
<div>${gn("",i.options,l)}</div>
</div>`},ff=(e,t,a)=>{const n=[],o=[];return t.mSelect.forEach(i=>{var s;if(e.options||(e.options=[]),!e.options.find(r=>{if(r.name===i.content)return i.color=r.color,!0})){const r=((((s=e.options)==null?void 0:s.length)||0)%14+1).toString();e.options.push({name:i.content,color:r}),i.color=r,n.push({action:"updateAttrViewColOptions",id:e.id,avID:a,data:e.options}),o.push({action:"removeAttrViewColOption",id:e.id,avID:a,data:i.content})}}),{doOperations:n,undoOperations:o}},gf=e=>{const t=new Menu("av-add-sort");e.data.view.columns.forEach(a=>{let n=!1;a.type==="lineNumber"?n=!0:e.data.view.sorts.find(o=>{if(o.column===a.id)return n=!0,!0}),n||t.addItem({label:a.name,iconHTML:a.icon?unicode2Emoji(a.icon,"b3-menu__icon",!0):`<svg class="b3-menu__icon"><use xlink:href="#${getColIconByType(a.type)}"></use></svg>`,click:()=>{const o=Object.assign([],e.data.view.sorts);e.data.view.sorts.push({column:a.id,order:"ASC"}),transaction(e.protyle,[{action:"setAttrViewSorts",avID:e.data.id,data:e.data.view.sorts,blockID:e.blockID}],[{action:"setAttrViewSorts",avID:e.data.id,data:o,blockID:e.blockID}]),e.menuElement.innerHTML=rl(e.data.view.columns,e.data.view.sorts),ll(e.protyle,e.menuElement,e.data,e.blockID),setPosition(e.menuElement,e.tabRect.right-e.menuElement.clientWidth,e.tabRect.bottom,e.tabRect.height)}})}),t.open({x:e.rect.left,y:e.rect.bottom,h:e.rect.height})},ll=(e,t,a,n)=>{t.querySelectorAll("select").forEach(o=>{o.addEventListener("change",()=>{const i=o.parentElement.getAttribute("data-id"),s=JSON.parse(JSON.stringify(a.view.sorts));o.previousElementSibling.classList.contains("b3-menu__icon")?a.view.sorts.find(l=>{if(l.column===i)return l.column=o.value,o.parentElement.setAttribute("data-id",o.value),!0}):a.view.sorts.find(l=>l.column===i).order=o.value,transaction(e,[{action:"setAttrViewSorts",avID:a.id,data:a.view.sorts,blockID:n}],[{action:"setAttrViewSorts",avID:a.id,data:s,blockID:n}])})})},rl=(e,t)=>{let a="";const n=o=>{let i="";return e.forEach(s=>{i+=`<option value="${s.id}" ${s.id===o?"selected":""}>${s.icon&&unicode2Emoji(s.icon)}${s.name}</option>`}),i};return t.forEach(o=>{a+=`<button draggable="true" class="b3-menu__item" data-id="${o.column}">
    <svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>
    <select class="b3-select" style="margin: 4px 0">
        ${n(o.column)}
    </select>
    <span class="fn__space"></span>
    <select class="b3-select" style="margin: 4px 0">
        <option value="ASC" ${o.order==="ASC"?"selected":""}>${window.siyuan.languages.asc}</option>
        <option value="DESC" ${o.order==="DESC"?"selected":""}>${window.siyuan.languages.desc}</option>
    </select>
    <svg class="b3-menu__action" data-type="removeSort"><use xlink:href="#iconTrashcan"></use></svg>
</button>`}),`<div class="b3-menu__items">
<button class="b3-menu__item" data-type="nobg">
    <span class="block__icon" style="padding: 8px;margin-left: -4px;" data-type="go-config">
        <svg><use xlink:href="#iconLeft"></use></svg>
    </span>
    <span class="b3-menu__label ft__center">${window.siyuan.languages.sort}</span>
</button>
<button class="b3-menu__separator"></button>
${a}
<button class="b3-menu__item${t.length===e.length?" fn__none":""}" data-type="addSort">
    <svg class="b3-menu__icon"><use xlink:href="#iconAdd"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.new}</span>
</button>
<button class="b3-menu__item${a?"":" fn__none"}" data-type="removeSorts">
    <svg class="b3-menu__icon"><use xlink:href="#iconTrashcan"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.delete}</span>
</button>
</div>`},pf=e=>{const t=genCellValueByElement("date",e[0]).date,a=t.isNotTime;let n="";const o=new Date().getTime();if(t.isNotEmpty){n=dayjs(t.content).format(a?"YYYY-MM-DD":"YYYY-MM-DD HH:mm");const s=n.split("-")[0];s.length!==4&&(n=new Array(4-s.length).fill(0).join("")+n)}else n=dayjs(o).format(a?"YYYY-MM-DD":"YYYY-MM-DD HH:mm");let i="";if(t.isNotEmpty2){i=dayjs(t.content2).format(a?"YYYY-MM-DD":"YYYY-MM-DD HH:mm");const s=n.split("-")[0];s.length!==4&&(n=new Array(4-s.length).fill(0).join("")+n)}else t.hasEndDate&&(i=dayjs(o).format(a?"YYYY-MM-DD":"YYYY-MM-DD HH:mm"));return`<div class="b3-menu__items">
<div>
    <input type="${a?"date":"datetime-local"}" max="${a?"9999-12-31":"9999-12-31 23:59"}" value="${n}" data-value="${dayjs(t.content||o).format("YYYY-MM-DD HH:mm")}" class="b3-text-field fn__size200" style="margin-top: 4px;"><br>
    <input type="${a?"date":"datetime-local"}" max="${a?"9999-12-31":"9999-12-31 23:59"}" value="${i}" data-value="${t.isNotEmpty2?dayjs(t.content2).format("YYYY-MM-DD HH:mm"):""}" style="margin-top: 8px;margin-bottom: 4px" class="b3-text-field fn__size200${t.hasEndDate?"":" fn__none"}">
    <button class="b3-menu__separator"></button>
    <label class="b3-menu__item">
        <span class="fn__flex-center">${window.siyuan.languages.endDate}</span>
        <span class="fn__space fn__flex-1"></span>
        <input type="checkbox" class="b3-switch b3-switch--menu"${t.hasEndDate?" checked":""}>
    </label>
    <label class="b3-menu__item">
        <span class="fn__flex-center">${window.siyuan.languages.includeTime}</span>
        <span class="fn__space fn__flex-1"></span>
        <input type="checkbox" class="b3-switch b3-switch--menu"${a?"":" checked"}>
    </label>
    <button class="b3-menu__separator"></button>
    <button class="b3-menu__item" data-type="clearDate">
        <svg class="b3-menu__icon"><use xlink:href="#iconTrashcan"></use></svg>
        <span class="b3-menu__label">${window.siyuan.languages.clear}</span>
    </button>
</div>
</div>`},mf=e=>{const t=e.menuElement.querySelectorAll("input");return t.forEach(a=>{a.addEventListener("keydown",n=>{var o;n.isComposing||n.key==="Enter"&&(updateCellsValue(e.protyle,e.blockElement,{content:wa(t[0].dataset.value),isNotEmpty:t[0].value!=="",content2:wa(t[1].dataset.value),isNotEmpty2:t[1].value!=="",hasEndDate:t[2].checked,isNotTime:!t[3].checked},e.cellElements),(o=document.querySelector(".av__panel"))==null||o.remove())})}),t[0].addEventListener("change",()=>{t[0].dataset.value=t[0].value.length>10?t[0].value:t[0].value+" 00:00"}),t[1].addEventListener("change",()=>{t[1].dataset.value=t[1].value.length>10?t[1].value:t[1].value+" 00:00"}),t[2].addEventListener("change",()=>{if(t[2].checked){if(!t[1].dataset.value){const a=new Date().getTime();t[1].dataset.value=dayjs(a).format("YYYY-MM-DD HH:mm"),t[1].value=dayjs(a).format(t[3].checked?"YYYY-MM-DD HH:mm":"YYYY-MM-DD")}t[1].classList.remove("fn__none")}else t[1].classList.add("fn__none")}),t[3].addEventListener("change",()=>{t[3].checked?(t[0].setAttribute("type","datetime-local"),t[1].setAttribute("type","datetime-local"),t[0].setAttribute("max","9999-12-31 23:59"),t[1].setAttribute("max","9999-12-31 23:59"),t[0].value=t[0].dataset.value,t[1].value=t[1].dataset.value):(t[0].setAttribute("type","date"),t[1].setAttribute("type","date"),t[0].setAttribute("max","9999-12-31"),t[1].setAttribute("max","9999-12-31"),t[0].value=t[0].dataset.value.substring(0,10),t[1].value=t[1].dataset.value.substring(0,10))}),()=>{updateCellsValue(e.protyle,e.blockElement,{content:wa(t[0].dataset.value),isNotEmpty:t[0].value!=="",content2:wa(t[1].dataset.value),isNotEmpty2:t[1].value!=="",hasEndDate:t[2].checked,isNotTime:!t[3].checked},e.cellElements)}},wa=e=>{const t=e.split("-")[0],a=new Date(e);return(t.startsWith("00")||t.startsWith("000")||t.length<3)&&a.setFullYear(parseInt(t)),a.getTime()},De=e=>{e.menu.addItem({iconHTML:"",label:cl(e.format),click(){transaction(e.protyle,[{action:"updateAttrViewColNumberFormat",id:e.colId,avID:e.avID,format:e.format,type:"number"}],[{action:"updateAttrViewColNumberFormat",id:e.colId,avID:e.avID,format:e.oldFormat,type:"number"}]),e.avPanelElement.remove()}})},bf=e=>{const t=new Menu("av-col-format-number");De({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),De({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"commas",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),De({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"percent",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),De({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"usDollar",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),De({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"yuan",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),De({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"euro",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),De({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"pound",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),De({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"yen",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),De({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"ruble",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),De({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"rupee",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),De({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"won",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),De({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"canadianDollar",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),De({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"franc",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement});const a=e.element.getBoundingClientRect();t.open({x:a.left,y:a.bottom,h:a.height,w:a.width,isLeft:!0})},cl=e=>{switch(e){case"":return window.siyuan.languages.numberFormatNone;case"commas":return window.siyuan.languages.numberFormatCommas;case"percent":return window.siyuan.languages.numberFormatPercent;case"usDollar":return window.siyuan.languages.numberFormatUSDollar;case"yuan":return window.siyuan.languages.numberFormatYuan;case"euro":return window.siyuan.languages.numberFormatEuro;case"pound":return window.siyuan.languages.numberFormatPound;case"yen":return window.siyuan.languages.numberFormatYen;case"ruble":return window.siyuan.languages.numberFormatRuble;case"rupee":return window.siyuan.languages.numberFormatRupee;case"won":return window.siyuan.languages.numberFormatWon;case"canadianDollar":return window.siyuan.languages.numberFormatCanadianDollar;case"franc":return window.siyuan.languages.numberFormatFranc}},xs=(e,t)=>{var a,n;if(t.classList.contains("b3-list--empty"))return;e.target.querySelector(".b3-menu__accelerator").textContent=t.querySelector(".b3-list-item__text").textContent;const o=e.data.view.columns.find(s=>{if(s.id===e.colId)return s.rollup||(s.rollup={}),!0});if(e.isRelation){if(t.dataset.colId===((a=o.rollup)==null?void 0:a.relationKeyID))return;o.rollup={relationKeyID:t.dataset.colId};const s=e.target.nextElementSibling;s.querySelector(".b3-menu__accelerator").textContent="",s.setAttribute("data-av-id",t.dataset.targetAvId);const l=s.nextElementSibling;l.removeAttribute("data-col-type"),l.removeAttribute("data-calc"),l.querySelector(".b3-menu__accelerator").textContent=window.siyuan.languages.original}else{if(t.dataset.colId===((n=o.rollup)==null?void 0:n.keyID))return;o.rollup.keyID=t.dataset.colId,delete o.rollup.calc;const s=e.target.nextElementSibling;s.removeAttribute("data-calc"),s.setAttribute("data-col-type",t.dataset.colType),s.querySelector(".b3-menu__accelerator").textContent=window.siyuan.languages.original}const i=JSON.parse(JSON.stringify(o.rollup));transaction(e.protyle,[{action:"updateAttrViewColRollup",id:e.colId,avID:e.data.id,parentID:o.rollup.relationKeyID,keyID:o.rollup.keyID,data:{calc:o.rollup.calc}}],[{action:"updateAttrViewColRollup",id:e.colId,avID:e.data.id,parentID:i.relationKeyID,keyID:i.keyID,data:{calc:i.calc}}])},Ts=(e,t,a,n,o)=>{if(!n&&!a){showMessage(window.siyuan.languages.selectRelation);return}fetchPost(n?"/api/av/searchAttributeViewRelationKey":"/api/av/searchAttributeViewNonRelationKey",{avID:a,keyword:t},i=>{let s="";i.data.keys.forEach((l,r)=>{s+=`<div class="b3-list-item b3-list-item--narrow${r===0?" b3-list-item--focus":""}" data-col-id="${l.id}" ${n?`data-target-av-id="${l.relation.avID}"`:`data-col-type="${l.type}"`}>
        ${l.icon?unicode2Emoji(l.icon,"b3-list-item__graphic",!0):`<svg class="b3-list-item__graphic"><use xlink:href="#${getColIconByType(l.type)}"></use></svg>`}
        <span class="b3-list-item__text">${escapeHtml(l.name||window.siyuan.languages.title)}</span>
</div>`}),e.innerHTML=s||`<div class="b3-list--empty">${window.siyuan.languages.emptyContent}</div>`,o&&o()})},yf=e=>{window.siyuan.menus.menu.remove();const t=new Menu;t.addItem({iconHTML:"",type:"empty",label:`<div class="fn__flex-column b3-menu__filter">
    <input class="b3-text-field fn__flex-shrink" placeholder="${window.siyuan.languages[e.isRelation?"searchRelation":"searchRollupProperty"]}"/>
    <div class="fn__hr"></div>
    <div class="b3-list fn__flex-1 b3-list--background">
        <img style="margin: 0 auto;display: block;width: 64px;height: 64px" src="/stage/loading-pure.svg">
    </div>
</div>`,bind(a){const n=a.querySelector(".b3-list"),o=a.querySelector("input");o.addEventListener("keydown",i=>{if(i.isComposing)return;upDownHint(n,i)&&i.stopPropagation(),i.key==="Enter"&&(i.preventDefault(),i.stopPropagation(),xs(e,n.querySelector(".b3-list-item--focus")),window.siyuan.menus.menu.remove())}),o.addEventListener("input",i=>{i.stopPropagation(),Ts(n,o.value,e.isRelation?e.data.id:e.target.dataset.avId,e.isRelation)}),a.lastElementChild.addEventListener("click",i=>{const s=hasClosestByClassName(i.target,"b3-list-item");s&&(i.stopPropagation(),xs(e,s),window.siyuan.menus.menu.remove())}),Ts(n,"",e.isRelation?e.data.id:e.target.dataset.avId,e.isRelation,()=>{const i=e.target.getBoundingClientRect();t.open({x:i.left,y:i.bottom,h:i.height}),a.querySelector("input").focus()})}}),t.element.querySelector(".b3-menu__items").setAttribute("style","overflow: initial")},hf=e=>{var t,a;let n;return e.colData?n=e.colData:e.data.view.columns.find(o=>{if(o.id===e.cellElements[0].dataset.colId)return n=o,!0}),`<button class="b3-menu__item" data-type="goSearchRollupCol" data-old-value='${JSON.stringify(n.rollup||{})}'>
    <span class="b3-menu__label">${window.siyuan.languages.relation}</span>
    <span class="b3-menu__accelerator"></span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<button class="b3-menu__item" data-type="goSearchRollupTarget">
    <span class="b3-menu__label">${window.siyuan.languages.rollupProperty}</span>
    <span class="b3-menu__accelerator"></span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<button class="b3-menu__item" data-type="goSearchRollupCalc">
    <span class="b3-menu__label">${window.siyuan.languages.rollupCalc}</span>
    <span class="b3-menu__accelerator">${getNameByOperator((a=(t=n.rollup)==null?void 0:t.calc)==null?void 0:a.operator,!0)}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>`},wf=e=>{const t=e.menuElement.querySelector('[data-type="goSearchRollupCol"]');if(t){const a=JSON.parse(t.dataset.oldValue),n=e.menuElement.querySelector('[data-type="goSearchRollupTarget"]');let o="";a.relationKeyID&&e.data.view.columns.find(i=>{if(i.id===a.relationKeyID)return t.querySelector(".b3-menu__accelerator").textContent=i.name,o=i.relation.avID,n.dataset.avId=o,!0}),a.keyID&&o&&fetchPost("/api/av/getAttributeView",{id:o},i=>{i.data.av.keyValues.find(s=>{if(s.key.id===a.keyID){n.querySelector(".b3-menu__accelerator").textContent=s.key.name;const l=e.menuElement.querySelector('[data-type="goSearchRollupCalc"]');return l.dataset.colType=s.key.type,a.calc&&(l.dataset.calc=a.calc.operator),!0}})})}},dl=e=>{var t;let a=document.querySelector(".av__panel");if(a){a.remove();return}const n=e.blockElement.getAttribute("data-av-id");fetchPost("/api/av/renderAttributeView",{id:n,query:((t=e.blockElement.querySelector('[data-type="av-search"]'))==null?void 0:t.value.trim())||"",pageSize:parseInt(e.blockElement.getAttribute("data-page-size"))||void 0,viewID:e.blockElement.getAttribute(Constants.CUSTOM_SY_AV_VIEW)},o=>{var i;if(a=document.querySelector(".av__panel"),a){a.remove();return}window.siyuan.menus.menu.remove();const s=e.blockElement.getAttribute("data-node-id"),l=!e.blockElement.classList.contains("av"),r=o.data;let c;if(e.type==="config")c=getViewHTML(r);else if(e.type==="properties")c=ht(r.view);else if(e.type==="sorts")c=getSortsHTML(r.view.columns,r.view.sorts);else if(e.type==="switcher")c=getSwitcherHTML(r.views,r.viewID);else if(e.type==="filters")c=getFiltersHTML(r.view);else if(e.type==="select")c=getSelectHTML(r.view,e.cellElements,!0);else if(e.type==="asset")c=getAssetHTML(e.cellElements);else if(e.type==="edit")e.editData&&(e.editData.previousID?r.view.columns.find((m,b)=>{if(m.id===e.editData.previousID)return r.view.columns.splice(b+1,0,e.editData.colData),!0}):r.view.columns.splice(0,0,e.editData.colData)),c=getEditHTML({protyle:e.protyle,data:r,colId:e.colId,isCustomAttr:l});else if(e.type==="date")c=getDateHTML(e.cellElements);else if(e.type==="rollup")c=`<div class="b3-menu__items">${getRollupHTML({data:r,cellElements:e.cellElements})}</div>`;else if(e.type==="relation"&&(c=getRelationHTML(r,e.cellElements),!c)){dl({protyle:e.protyle,blockElement:e.blockElement,type:"edit",colId:e.cellElements[0].dataset.colId});return}document.body.insertAdjacentHTML("beforeend",`<div class="av__panel" style="z-index: ${++window.siyuan.zIndex}">
    <div class="b3-dialog__scrim" data-type="close"></div>
    <div class="b3-menu">${c}</div>
</div>`),a=document.querySelector(".av__panel");let d;const u=a.lastElementChild;let g=(i=e.blockElement.querySelector(`.av__views, .av__row[data-col-id="${e.colId}"] > .block__logo`))==null?void 0:i.getBoundingClientRect();if(["select","date","asset","relation","rollup"].includes(e.type)){const m=e.cellElements[e.cellElements.length-1].getBoundingClientRect();if(e.type==="select"?bindSelectEvent(e.protyle,r,u,e.cellElements,e.blockElement):e.type==="date"?d=bindDateEvent({protyle:e.protyle,data:r,menuElement:u,cellElements:e.cellElements,blockElement:e.blockElement}):e.type==="asset"?(bindAssetEvent({protyle:e.protyle,menuElement:u,cellElements:e.cellElements,blockElement:e.blockElement}),setTimeout(()=>{setPosition(u,m.left,m.bottom,m.height)},Constants.TIMEOUT_LOAD)):e.type==="relation"?bindRelationEvent({menuElement:u,cellElements:e.cellElements,protyle:e.protyle,blockElement:e.blockElement}):e.type==="rollup"&&bindRollupData({protyle:e.protyle,data:r,menuElement:u}),["select","date","relation","rollup"].includes(e.type)){const b=u.querySelector("input");b&&(b.select(),b.focus()),setPosition(u,m.left,m.bottom,m.height)}}else setPosition(u,g.right-u.clientWidth,g.bottom,g.height),e.type==="sorts"?bindSortsEvent(e.protyle,u,r,s):e.type==="edit"?bindEditEvent({protyle:e.protyle,data:r,menuElement:u,isCustomAttr:l,blockID:s}):e.type==="config"?bindViewEvent({protyle:e.protyle,data:r,menuElement:u,blockElement:e.blockElement}):e.type==="switcher"&&bindSwitcherEvent({protyle:e.protyle,menuElement:u,blockElement:e.blockElement});e.cb&&e.cb(a),a.addEventListener("dragstart",m=>{window.siyuan.dragElement=m.target,window.siyuan.dragElement.style.opacity=".1"}),a.addEventListener("drop",m=>{var b,w,y,_;if(p=0,!window.siyuan.dragElement){m.preventDefault(),m.stopPropagation();return}window.siyuan.dragElement.style.opacity="";const h=window.siyuan.dragElement;if(window.siyuan.dragElement=void 0,e.protyle&&e.protyle.disabled){m.preventDefault(),m.stopPropagation();return}if(!e.protyle&&window.siyuan.config.readonly){m.preventDefault(),m.stopPropagation();return}const E=a.querySelector(".dragover__bottom, .dragover__top");if(!E)return;const C=E.classList.contains("dragover__top"),k=h.dataset.id,v=E.dataset.id;if(E.querySelector('[data-type="removeSort"]')){const A=r.view.sorts,L=Object.assign([],A);let x;A.find((T,M)=>{if(T.column===k)return x=A.splice(M,1)[0],!0}),A.find((T,M)=>{if(T.column===v)return C?A.splice(M,0,x):A.splice(M+1,0,x),!0}),transaction(e.protyle,[{action:"setAttrViewSorts",avID:n,data:A,blockID:s}],[{action:"setAttrViewSorts",avID:n,data:L,blockID:s}]),u.innerHTML=getSortsHTML(r.view.columns,r.view.sorts),bindSortsEvent(e.protyle,u,r,s);return}if(E.querySelector('[data-type="removeFilter"]')){const A=r.view.filters,L=Object.assign([],A);let x;A.find((T,M)=>{if(T.column===k)return x=A.splice(M,1)[0],!0}),A.find((T,M)=>{if(T.column===v)return C?A.splice(M,0,x):A.splice(M+1,0,x),!0}),transaction(e.protyle,[{action:"setAttrViewFilters",avID:n,data:A,blockID:s}],[{action:"setAttrViewFilters",avID:n,data:L,blockID:s}]),u.innerHTML=getFiltersHTML(r.view);return}if(E.querySelector('[data-type="av-view-edit"]')){transaction(e.protyle,[{action:"sortAttrViewView",avID:n,blockID:s,id:k,previousID:C?(b=E.previousElementSibling)==null?void 0:b.getAttribute("data-id"):E.getAttribute("data-id")}],[{action:"sortAttrViewView",avID:n,blockID:s,id:k,previousID:(w=h.previousElementSibling)==null?void 0:w.getAttribute("data-id")}]),C?(E.before(h),E.classList.remove("dragover__top")):(E.after(h),E.classList.remove("dragover__bottom"));return}if(E.querySelector('[data-type="editAssetItem"]')){C?E.before(h):E.after(h);const A=[];Array.from(E.parentElement.children).forEach(L=>{L.dataset.content&&A.push({content:L.dataset.content,name:L.dataset.name,type:L.dataset.type})}),updateAssetCell({protyle:e.protyle,cellElements:e.cellElements,replaceValue:A,blockElement:e.blockElement});return}if(E.querySelector('[data-type="setColOption"]')){const A=e.cellElements?e.cellElements[0].dataset.colId:u.querySelector(".b3-menu__item").getAttribute("data-col-id"),L=r.view.columns.find(I=>I.id===A).options,x=Object.assign([],L);let T;L.find((I,D)=>{if(I.name===h.dataset.name)return T=L.splice(D,1)[0],!0}),L.find((I,D)=>{if(I.name===E.dataset.name)return C?L.splice(D,0,T):L.splice(D+1,0,T),!0}),transaction(e.protyle,[{action:"updateAttrViewColOptions",id:A,avID:n,data:L}],[{action:"updateAttrViewColOptions",id:A,avID:n,data:x}]);const M=u.querySelector(".b3-menu__items").scrollTop;e.cellElements?(u.innerHTML=getSelectHTML(r.view,e.cellElements),bindSelectEvent(e.protyle,r,u,e.cellElements,e.blockElement)):(u.innerHTML=getEditHTML({protyle:e.protyle,data:r,colId:A,isCustomAttr:l}),bindEditEvent({protyle:e.protyle,data:r,menuElement:u,isCustomAttr:l,blockID:s})),u.querySelector(".b3-menu__items").scrollTop=M;return}if(E.getAttribute("data-type")==="setRelationCell"){C?E.before(h):E.after(h),E.classList.remove("dragover__bottom","dragover__top");const A=[],L=[];E.parentElement.querySelectorAll(".fn__grab").forEach(x=>{const T=x.nextElementSibling;A.push(T.dataset.id),L.push({isDetached:!T.style.color,type:"block",block:{content:T.textContent,id:T.dataset.id}})}),updateCellsValue(e.protyle,e.blockElement,{blockIDs:A,contents:L},e.cellElements);return}if(E.getAttribute("data-type")==="editCol"){const A=(E.classList.contains("dragover__top")?(y=E.previousElementSibling)==null?void 0:y.getAttribute("data-id"):E.getAttribute("data-id"))||"",L=((_=h.previousElementSibling)==null?void 0:_.getAttribute("data-id"))||"";if(A!==L&&A!==k){transaction(e.protyle,[{action:"sortAttrViewCol",avID:n,previousID:A,id:k,blockID:s}],[{action:"sortAttrViewCol",avID:n,previousID:L,id:k,blockID:s}]);let x;r.view.columns.find((T,M)=>{if(T.id===k)return x=r.view.columns.splice(M,1)[0],!0}),r.view.columns.find((T,M)=>{if(T.id===v)return C?r.view.columns.splice(M,0,x):r.view.columns.splice(M+1,0,x),!0})}u.innerHTML=ht(r.view);return}});let f;a.addEventListener("dragover",m=>{if(m.dataTransfer.types.includes("Files")){m.preventDefault();return}const b=m.target;let w=hasClosestByAttribute(b,"draggable","true");if(w||(w=hasClosestByAttribute(document.elementFromPoint(m.clientX,m.clientY-1),"draggable","true")),!(!w||w.isSameNode(window.siyuan.dragElement))){if(m.preventDefault(),f&&w.isSameNode(f)){const y=w.getBoundingClientRect();a.querySelectorAll(".dragover__bottom, .dragover__top").forEach(_=>{_.classList.remove("dragover__bottom","dragover__top")}),m.clientY>y.top+y.height/2?w.classList.add("dragover__bottom"):w.classList.add("dragover__top");return}f=w}});let p=0;a.addEventListener("dragleave",()=>{p--,p===0&&a.querySelectorAll(".dragover__bottom, .dragover__top").forEach(m=>{m.classList.remove("dragover__bottom","dragover__top")})}),a.addEventListener("dragenter",m=>{m.preventDefault(),p++}),a.addEventListener("dragend",()=>{window.siyuan.dragElement&&(window.siyuan.dragElement.style.opacity="",window.siyuan.dragElement=void 0)}),a.addEventListener("mousedown",m=>{m.button===1&&!hasClosestByClassName(m.target,"b3-menu")&&document.querySelector(".av__panel").dispatchEvent(new CustomEvent("click",{detail:"close"}))}),a.addEventListener("click",m=>{var b,w,y;let _;typeof m.detail=="string"&&(_=m.detail);let h=m.target;for(;h&&!h.isSameNode(a)||_;){if(_=(h==null?void 0:h.dataset.type)||_,_==="close"){e.protyle.toolbar.subElement.classList.contains("fn__none")?window.siyuan.menus.menu.element.classList.contains("fn__none")?(d==null||d(),a.remove(),focusBlock(e.blockElement)):window.siyuan.menus.menu.remove():hideElements(["util"],e.protyle),window.siyuan.menus.menu.remove(),m.preventDefault(),m.stopPropagation();break}else if(_==="go-config"){u.innerHTML=getViewHTML(r),setPosition(u,g.right-u.clientWidth,g.bottom,g.height),bindViewEvent({protyle:e.protyle,data:r,menuElement:u,blockElement:e.blockElement}),window.siyuan.menus.menu.remove(),m.preventDefault(),m.stopPropagation();break}else if(_==="go-properties"){g=e.blockElement.querySelector(".av__views").getBoundingClientRect(),u.innerHTML=ht(r.view),setPosition(u,g.right-u.clientWidth,g.bottom,g.height),window.siyuan.menus.menu.remove(),m.preventDefault(),m.stopPropagation();break}else if(_==="goSorts"){u.innerHTML=getSortsHTML(r.view.columns,r.view.sorts),bindSortsEvent(e.protyle,u,r,s),setPosition(u,g.right-u.clientWidth,g.bottom,g.height),window.siyuan.menus.menu.remove(),m.preventDefault(),m.stopPropagation();break}else if(_==="removeSorts"){transaction(e.protyle,[{action:"setAttrViewSorts",avID:n,data:[],blockID:s}],[{action:"setAttrViewSorts",avID:n,data:r.view.sorts,blockID:s}]),r.view.sorts=[],u.innerHTML=getSortsHTML(r.view.columns,r.view.sorts),bindSortsEvent(e.protyle,u,r,s),setPosition(u,g.right-u.clientWidth,g.bottom,g.height),m.preventDefault(),m.stopPropagation();break}else if(_==="addSort"){addSort({data:r,rect:h.getBoundingClientRect(),menuElement:u,tabRect:g,avId:n,protyle:e.protyle,blockID:s}),m.preventDefault(),m.stopPropagation();break}else if(_==="removeSort"){const E=Object.assign([],r.view.sorts);r.view.sorts.find((C,k)=>{if(C.column===h.parentElement.dataset.id)return r.view.sorts.splice(k,1),!0}),transaction(e.protyle,[{action:"setAttrViewSorts",avID:n,data:r.view.sorts,blockID:s}],[{action:"setAttrViewSorts",avID:n,data:E,blockID:s}]),u.innerHTML=getSortsHTML(r.view.columns,r.view.sorts),bindSortsEvent(e.protyle,u,r,s),setPosition(u,g.right-u.clientWidth,g.bottom,g.height),m.preventDefault(),m.stopPropagation();break}else if(_==="goFilters"){u.innerHTML=getFiltersHTML(r.view),setPosition(u,g.right-u.clientWidth,g.bottom,g.height),window.siyuan.menus.menu.remove(),m.preventDefault(),m.stopPropagation();break}else if(_==="removeFilters"){transaction(e.protyle,[{action:"setAttrViewFilters",avID:n,data:[],blockID:s}],[{action:"setAttrViewFilters",avID:n,data:r.view.filters,blockID:s}]),r.view.filters=[],u.innerHTML=getFiltersHTML(r.view),setPosition(u,g.right-u.clientWidth,g.bottom,g.height),window.siyuan.menus.menu.remove(),m.preventDefault(),m.stopPropagation();break}else if(_==="addFilter"){addFilter({data:r,rect:h.getBoundingClientRect(),menuElement:u,tabRect:g,avId:n,protyle:e.protyle,blockElement:e.blockElement}),m.preventDefault(),m.stopPropagation();break}else if(_==="removeFilter"){window.siyuan.menus.menu.remove();const E=Object.assign([],r.view.filters);r.view.filters.find((C,k)=>{if(C.column===h.parentElement.dataset.id&&C.value.type===h.parentElement.dataset.filterType)return r.view.filters.splice(k,1),!0}),transaction(e.protyle,[{action:"setAttrViewFilters",avID:n,data:r.view.filters,blockID:s}],[{action:"setAttrViewFilters",avID:n,data:E,blockID:s}]),u.innerHTML=getFiltersHTML(r.view),setPosition(u,g.right-u.clientWidth,g.bottom,g.height),m.preventDefault(),m.stopPropagation();break}else if(_==="setFilter"){r.view.filters.find(E=>{if(E.column===h.parentElement.parentElement.dataset.id&&E.value.type===h.parentElement.parentElement.dataset.filterType)return setFilter({filter:E,protyle:e.protyle,data:r,target:h,blockElement:e.blockElement}),!0}),m.preventDefault(),m.stopPropagation();break}else if(_==="numberFormat"){formatNumber({avPanelElement:a,element:h,protyle:e.protyle,oldFormat:h.dataset.format,colId:u.querySelector(".b3-menu__item").getAttribute("data-col-id"),avID:n}),m.preventDefault(),m.stopPropagation();break}else if(_==="newCol"){a.remove(),addCol(e.protyle,e.blockElement).open({x:g.right,y:g.bottom,h:g.height,isLeft:!0}),m.preventDefault(),m.stopPropagation();break}else if(_==="update-view-icon"){const E=h.getBoundingClientRect();openEmojiPanel("","av",{x:E.left,y:E.bottom+4,h:E.height,w:E.width},C=>{transaction(e.protyle,[{action:"setAttrViewViewIcon",avID:n,id:r.viewID,data:C}],[{action:"setAttrViewViewIcon",id:r.viewID,avID:n,data:h.dataset.icon}]),h.innerHTML=C?unicode2Emoji(C):'<svg style="width: 14px;height: 14px;"><use xlink:href="#iconTable"></use></svg>',h.dataset.icon=C},h.querySelector("img")),m.preventDefault(),m.stopPropagation();break}else if(_==="set-page-size"){setPageSize({target:h,protyle:e.protyle,avID:n,nodeElement:e.blockElement}),m.preventDefault(),m.stopPropagation();break}else if(_==="duplicate-view"){const E=Lute.NewNodeID();transaction(e.protyle,[{action:"duplicateAttrViewView",avID:n,previousID:r.viewID,id:E,blockID:s}],[{action:"removeAttrViewView",avID:n,id:E,blockID:s}]),e.blockElement.setAttribute(Constants.CUSTOM_SY_AV_VIEW,E),a.remove(),m.preventDefault(),m.stopPropagation();break}else if(_==="delete-view"){transaction(e.protyle,[{action:"removeAttrViewView",avID:n,id:r.viewID,blockID:s}]),a.remove(),m.preventDefault(),m.stopPropagation();break}else if(_==="update-icon"){const E=h.getBoundingClientRect();openEmojiPanel("","av",{x:E.left,y:E.bottom+4,h:E.height,w:E.width},C=>{const k=u.querySelector(".b3-menu__item").getAttribute("data-col-id");if(transaction(e.protyle,[{action:"setAttrViewColIcon",id:k,avID:n,data:C}],[{action:"setAttrViewColIcon",id:k,avID:n,data:h.dataset.icon}]),h.innerHTML=C?unicode2Emoji(C):`<svg style="height: 14px;width: 14px"><use xlink:href="#${getColIconByType(h.dataset.colType)}"></use></svg>`,l){const v=e.blockElement.querySelector(`.av__row[data-col-id="${k}"] .block__logoicon`);v.outerHTML=C?unicode2Emoji(C,"block__logoicon",!0):`<svg class="block__logoicon"><use xlink:href="#${getColIconByType(v.nextElementSibling.getAttribute("data-type"))}"></use></svg>`}else updateAttrViewCellAnimation(e.blockElement.querySelector(`.av__row--header .av__cell[data-col-id="${k}"]`),void 0,{icon:C});h.dataset.icon=C},h.querySelector("img")),m.preventDefault(),m.stopPropagation();break}else if(_==="showAllCol"){const E=[],C=[];r.view.columns.forEach(k=>{k.hidden&&(E.push({action:"setAttrViewColHidden",id:k.id,avID:n,data:!1,blockID:s}),C.push({action:"setAttrViewColHidden",id:k.id,avID:n,data:!0,blockID:s}),k.hidden=!1)}),E.length>0&&(transaction(e.protyle,E,C),u.innerHTML=ht(r.view),setPosition(u,g.right-u.clientWidth,g.bottom,g.height)),m.preventDefault(),m.stopPropagation();break}else if(_==="hideAllCol"){const E=[],C=[];r.view.columns.forEach(k=>{!k.hidden&&k.type!=="block"&&(E.push({action:"setAttrViewColHidden",id:k.id,avID:n,data:!0,blockID:s}),C.push({action:"setAttrViewColHidden",id:k.id,avID:n,data:!1,blockID:s}),k.hidden=!0)}),E.length>0&&(transaction(e.protyle,E,C),u.innerHTML=ht(r.view),setPosition(u,g.right-u.clientWidth,g.bottom,g.height)),m.preventDefault(),m.stopPropagation();break}else if(_==="editCol"){u.innerHTML=getEditHTML({protyle:e.protyle,data:r,colId:h.dataset.id,isCustomAttr:l}),bindEditEvent({protyle:e.protyle,data:r,menuElement:u,isCustomAttr:l,blockID:s}),setPosition(u,g.right-u.clientWidth,g.bottom,g.height),m.preventDefault(),m.stopPropagation();break}else if(_==="updateColType"){if(h.dataset.newType!==h.dataset.oldType){const C=a.querySelector('.b3-text-field[data-type="name"]').value;let k=C;if(r.view.columns.find(v=>{if(v.id===e.colId)return v.type=h.dataset.newType,getColNameByType(h.dataset.oldType)===C&&(k=getColNameByType(h.dataset.newType),v.name=k),!0}),transaction(e.protyle,[{action:"updateAttrViewCol",id:e.colId,avID:n,name:k,type:h.dataset.newType}],[{action:"updateAttrViewCol",id:e.colId,avID:n,name:C,type:h.dataset.oldType}]),h.dataset.newType==="lineNumber"){if(r.view.sorts.find(L=>L.column===e.colId)){const L=Object.assign([],r.view.sorts),x=r.view.sorts.filter(T=>T.column!==e.colId);transaction(e.protyle,[{action:"setAttrViewSorts",avID:r.id,data:x,blockID:s}],[{action:"setAttrViewSorts",avID:r.id,data:L,blockID:s}])}if(r.view.filters.find(L=>L.column===e.colId)){const L=JSON.parse(JSON.stringify(r.view.filters)),x=r.view.filters.filter(T=>T.column!==e.colId);transaction(e.protyle,[{action:"setAttrViewFilters",avID:r.id,data:x,blockID:s}],[{action:"setAttrViewFilters",avID:r.id,data:L,blockID:s}])}}}u.innerHTML=getEditHTML({protyle:e.protyle,data:r,colId:e.colId,isCustomAttr:l}),bindEditEvent({protyle:e.protyle,data:r,menuElement:u,isCustomAttr:l,blockID:s}),setPosition(u,g.right-u.clientWidth,g.bottom,g.height),m.preventDefault(),m.stopPropagation();break}else if(_==="goUpdateColType"){const E=hasClosestByClassName(h,"b3-menu");E&&(E.firstElementChild.classList.add("fn__none"),E.lastElementChild.classList.remove("fn__none")),setPosition(u,g.right-u.clientWidth,g.bottom,g.height),m.preventDefault(),m.stopPropagation();break}else if(_==="goSearchAV"){openSearchAV(n,h,void 0,!1),m.preventDefault(),m.stopPropagation();break}else if(_==="goSearchRollupCol"){goSearchRollupCol({target:h,data:r,isRelation:!0,protyle:e.protyle,colId:e.colId||u.querySelector(".b3-menu__item").getAttribute("data-col-id")}),m.preventDefault(),m.stopPropagation();break}else if(_==="goSearchRollupTarget"){goSearchRollupCol({target:h,data:r,isRelation:!1,protyle:e.protyle,colId:e.colId||u.querySelector(".b3-menu__item").getAttribute("data-col-id")}),m.preventDefault(),m.stopPropagation();break}else if(_==="goSearchRollupCalc"){openCalcMenu(e.protyle,h,{data:r,colId:e.colId||u.querySelector(".b3-menu__item").getAttribute("data-col-id"),blockID:s}),m.preventDefault(),m.stopPropagation();break}else if(_==="updateRelation"){updateRelation({protyle:e.protyle,avElement:a,avID:n,colsData:r.view.columns,blockElement:e.blockElement}),m.preventDefault(),m.stopPropagation();break}else if(_==="goEditCol"){const E=hasClosestByClassName(h,"b3-menu");E&&(E.firstElementChild.classList.remove("fn__none"),E.lastElementChild.classList.add("fn__none")),setPosition(u,g.right-u.clientWidth,g.bottom,g.height),m.preventDefault(),m.stopPropagation();break}else if(_==="hideCol"){const E=u.querySelector('[data-type="go-properties"]'),C=E?u.querySelector(".b3-menu__item").getAttribute("data-col-id"):h.parentElement.getAttribute("data-id");transaction(e.protyle,[{action:"setAttrViewColHidden",id:C,avID:n,data:!0,blockID:s}],[{action:"setAttrViewColHidden",id:C,avID:n,data:!1,blockID:s}]),r.view.columns.find(k=>k.id===C).hidden=!0,E?(u.innerHTML=getEditHTML({protyle:e.protyle,data:r,colId:C,isCustomAttr:l}),bindEditEvent({protyle:e.protyle,data:r,menuElement:u,isCustomAttr:l,blockID:s})):u.innerHTML=ht(r.view),setPosition(u,g.right-u.clientWidth,g.bottom,g.height),m.preventDefault(),m.stopPropagation();break}else if(_==="showCol"){const E=u.querySelector('[data-type="go-properties"]'),C=E?u.querySelector(".b3-menu__item").getAttribute("data-col-id"):h.parentElement.getAttribute("data-id");transaction(e.protyle,[{action:"setAttrViewColHidden",id:C,avID:n,data:!1,blockID:s}],[{action:"setAttrViewColHidden",id:C,avID:n,data:!0,blockID:s}]),r.view.columns.find(k=>k.id===C).hidden=!1,E?(u.innerHTML=getEditHTML({protyle:e.protyle,data:r,colId:C,isCustomAttr:l}),bindEditEvent({protyle:e.protyle,data:r,menuElement:u,isCustomAttr:l,blockID:s})):u.innerHTML=ht(r.view),setPosition(u,g.right-u.clientWidth,g.bottom,g.height),m.preventDefault(),m.stopPropagation();break}else if(_==="duplicateCol"){duplicateCol({blockElement:e.blockElement,protyle:e.protyle,colId:u.querySelector(".b3-menu__item").getAttribute("data-col-id"),data:r,viewID:r.viewID}),m.preventDefault(),m.stopPropagation();break}else if(_==="removeCol"){l||(g=e.blockElement.querySelector(".av__views").getBoundingClientRect());const E=u.querySelector(".b3-menu__item").getAttribute("data-col-id"),C=r.view.columns.find(v=>{if(v.id===E)return!0}),k=C.type==="relation"&&((b=C.relation)==null?void 0:b.isTwoWay);if(l||k){const v=new Dialog({title:k?window.siyuan.languages.removeCol.replace("${x}",u.querySelector("input").value):window.siyuan.languages.deleteOpConfirm,content:`<div class="b3-dialog__content">
    ${k?window.siyuan.languages.confirmRemoveRelationField.replace("${x}",u.querySelector('.b3-menu__item[data-type="goSearchAV"] .b3-menu__accelerator').textContent):window.siyuan.languages.removeCol.replace("${x}",u.querySelector("input").value)}
    <div class="fn__hr--b"></div>
    <button class="fn__block b3-button b3-button--remove" data-action="delete">${window.siyuan.languages.delete}</button>
    <div class="fn__hr"></div>
    <button class="fn__block b3-button b3-button--remove${k?"":" fn__none"}" data-action="keep-relation">${window.siyuan.languages.removeButKeepRelationField}</button>
    <div class="fn__hr"></div>
    <button class="fn__block b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button>
</div>`});v.element.addEventListener("click",A=>{let L=A.target;const x=typeof A.detail=="string";for(;L&&!L.isSameNode(v.element)||x;){const T=L.getAttribute("data-action");if(T==="delete"||x&&A.detail==="Enter"){removeCol({protyle:e.protyle,data:r,avID:n,blockID:s,menuElement:u,isCustomAttr:l,blockElement:e.blockElement,avPanelElement:a,tabRect:g,isTwoWay:!0}),v.destroy();break}else if(T==="keep-relation"){removeCol({protyle:e.protyle,data:r,avID:n,blockID:s,menuElement:u,isCustomAttr:l,blockElement:e.blockElement,avPanelElement:a,tabRect:g,isTwoWay:!1}),v.destroy();break}else if(L.classList.contains("b3-button--cancel")||x&&A.detail==="Escape"){v.destroy();break}L=L.parentElement}}),v.element.setAttribute("data-key",Constants.DIALOG_CONFIRM)}else removeCol({protyle:e.protyle,data:r,avID:n,blockID:s,menuElement:u,isCustomAttr:l,blockElement:e.blockElement,avPanelElement:a,tabRect:g,isTwoWay:!1});m.preventDefault(),m.stopPropagation();break}else if(_==="setColOption"){setColOption(e.protyle,r,h,e.blockElement,l,e.cellElements),m.preventDefault(),m.stopPropagation();break}else if(_==="setRelationCell"){setRelationCell(e.protyle,e.blockElement,h,e.cellElements),m.preventDefault(),m.stopPropagation();break}else if(_==="addColOptionOrCell"){h.querySelector(".b3-menu__checked")?removeCellOption(e.protyle,e.cellElements,u.querySelector(`.b3-chips .b3-chip[data-content="${escapeAttr(h.dataset.name)}"]`),e.blockElement):addColOptionOrCell(e.protyle,r,e.cellElements,h,u,e.blockElement),window.siyuan.menus.menu.remove(),m.preventDefault(),m.stopPropagation();break}else if(_==="removeCellOption"){removeCellOption(e.protyle,e.cellElements,h.parentElement,e.blockElement),m.preventDefault(),m.stopPropagation();break}else if(_==="addAssetLink"){addAssetLink(e.protyle,e.cellElements,h,e.blockElement),m.preventDefault(),m.stopPropagation();break}else if(_==="addAssetExist"){const E=h.getBoundingClientRect();assetMenu(e.protyle,{x:E.right,y:E.bottom,w:h.parentElement.clientWidth+8,h:E.height},(C,k)=>{let v;Constants.SIYUAN_ASSETS_IMAGE.includes(pathPosix().extname(C).toLowerCase())?v={type:"image",content:C,name:""}:v={type:"file",content:C,name:k},updateAssetCell({protyle:e.protyle,cellElements:e.cellElements,addValue:[v],blockElement:e.blockElement}),window.siyuan.menus.menu.remove()}),m.preventDefault(),m.stopPropagation();break}else if(_==="openAssetItem"){const E=h.parentElement.dataset.content,C=pathPosix().extname(E);Constants.SIYUAN_ASSETS_IMAGE.includes(C)?previewImage(E):window.open(E),m.preventDefault(),m.stopPropagation();break}else if(_==="editAssetItem"){editAssetItem({protyle:e.protyle,cellElements:e.cellElements,blockElement:e.blockElement,content:h.parentElement.dataset.content,type:h.parentElement.dataset.type,name:h.parentElement.dataset.name,index:parseInt(h.parentElement.dataset.index),rect:h.parentElement.getBoundingClientRect()}),m.preventDefault(),m.stopPropagation();break}else if(_==="clearDate"){updateCellsValue(e.protyle,e.blockElement,{isNotEmpty2:!1,isNotEmpty:!1,content:null,content2:null,hasEndDate:!1,isNotTime:!0},e.cellElements),a.remove(),m.preventDefault(),m.stopPropagation();break}else if(_==="av-add"){window.siyuan.menus.menu.remove(),addView(e.protyle,e.blockElement),a.remove(),m.preventDefault(),m.stopPropagation();break}else if(_==="av-view-switch"){h.parentElement.classList.contains("b3-menu__item--current")||((w=a.querySelector(".b3-menu__item--current"))==null||w.classList.remove("b3-menu__item--current"),h.parentElement.classList.add("b3-menu__item--current"),e.blockElement.removeAttribute("data-render"),avRender(e.blockElement,e.protyle,void 0,h.parentElement.dataset.id)),m.preventDefault(),m.stopPropagation();break}else if(_==="av-view-edit"){h.parentElement.classList.contains("b3-menu__item--current")?openViewMenu({protyle:e.protyle,blockElement:e.blockElement,element:h.parentElement}):((y=a.querySelector(".b3-menu__item--current"))==null||y.classList.remove("b3-menu__item--current"),h.parentElement.classList.add("b3-menu__item--current"),e.blockElement.removeAttribute("data-render"),avRender(e.blockElement,e.protyle,()=>{openViewMenu({protyle:e.protyle,blockElement:e.blockElement,element:h.parentElement}),a.querySelector(".b3-chip--primary").classList.remove("b3-chip--primary"),h.parentElement.querySelector(".b3-chip").classList.add("b3-chip--primary")},h.parentElement.dataset.id)),m.preventDefault(),m.stopPropagation();break}if(!h||!h.parentElement)break;h=h.parentElement}})})},ht=e=>{let t="",a="";return e.columns.forEach(n=>{n.hidden?a+=`<button class="b3-menu__item" data-type="editCol" draggable="true" data-id="${n.id}">
    <svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>
    <div class="b3-menu__label fn__flex">
        ${n.icon?unicode2Emoji(n.icon,"b3-menu__icon",!0):`<svg class="b3-menu__icon"><use xlink:href="#${getColIconByType(n.type)}"></use></svg>`}
        ${escapeHtml(n.name)||"&nbsp;"}
    </div>
    <svg class="b3-menu__action" data-type="showCol"><use xlink:href="#iconEye"></use></svg>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>`:t+=`<button class="b3-menu__item" data-type="editCol" draggable="true" data-id="${n.id}">
    <svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>
    <div class="b3-menu__label fn__flex">
        ${n.icon?unicode2Emoji(n.icon,"b3-menu__icon",!0):`<svg class="b3-menu__icon"><use xlink:href="#${getColIconByType(n.type)}"></use></svg>`}
        ${escapeHtml(n.name)||"&nbsp;"}
    </div>
    <svg class="b3-menu__action${n.type==="block"?" fn__none":""}" data-type="hideCol"><use xlink:href="#iconEyeoff"></use></svg>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>`}),a&&(a=`<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="nobg">
    <span class="b3-menu__label">
        ${window.siyuan.languages.hideCol} 
    </span>
    <span class="block__icon" data-type="showAllCol">
        ${window.siyuan.languages.showAll}
        <span class="fn__space"></span>
        <svg><use xlink:href="#iconEye"></use></svg>
    </span>
</button>
${a}`),`<div class="b3-menu__items">
<button class="b3-menu__item" data-type="nobg">
    <span class="block__icon" style="padding: 8px;margin-left: -4px;" data-type="go-config">
        <svg><use xlink:href="#iconLeft"></use></svg>
    </span>
    <span class="b3-menu__label ft__center">${window.siyuan.languages.fields}</span>
</button>
<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="nobg">
    <span class="b3-menu__label">
        ${window.siyuan.languages.showCol} 
    </span>
    <span class="block__icon" data-type="hideAllCol">
        ${window.siyuan.languages.hideAll}
        <span class="fn__space"></span>
        <svg><use xlink:href="#iconEyeoff"></use></svg>
    </span>
</button>
${t}
${a}
<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="newCol">
    <svg class="b3-menu__icon"><use xlink:href="#iconAdd"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.new}</span>
</button>
</div>`},pn=e=>e&&e.replace(/&/g,"&amp;").replace(/</g,"&lt;"),_f=e=>e.replace(/</g,"&lt;"),Yt=e=>e&&e.replace(/"/g,"&quot;").replace(/'/g,"&apos;"),ul=e=>e&&e.replace(/"/g,"&quot;").replace(/'/g,"&apos;").replace(/</g,"&amp;lt;").replace(/&lt;/g,"&amp;lt;"),Is=e=>{let t=e,a="";try{const n=new URL(e);n.protocol.startsWith("http")&&(t=n.host,a=n.href.replace(n.origin,""),a.length>12&&(a=a.substring(0,4)+"..."+a.substring(a.length-6)))}catch(n){t=Lute.EscapeHTMLStr(e)}return`<span class="av__celltext av__celltext--url" data-type="url" data-href="${Yt(e)}"><span>${t}</span><span class="ft__on-surface">${a}</span></span>`},fl=e=>{if(!e)return"";let t="";const a=e.querySelectorAll(".b3-chip, .av__celltext--ref, .av__celltext");return a.length>0?(a.forEach(n=>{n.querySelector(".av__cellicon")?t+=`${n.firstChild.textContent} \u2192 ${n.lastChild.textContent}, `:n.getAttribute("data-type")==="url"?t=n.getAttribute("data-href")+", ":n.getAttribute("data-type")!=="block-more"&&(t+=n.textContent+", ")}),t=t.substring(0,t.length-2)):t=e.textContent,t},Ms=(e,t)=>{var a;const n={type:e,id:t.dataset.id};if(e==="number"){const o=t.querySelector(".av__celltext").getAttribute("data-content");n.number={content:parseFloat(o)||0,isNotEmpty:!!o}}else if(["text","block","url","phone","email","template"].includes(e)){const o=t.querySelector(".av__celltext");n[e]={content:e==="url"?o.dataset.href:o.textContent},e==="block"&&o.dataset.id&&(n.block.id=o.dataset.id,(a=o.previousElementSibling)!=null&&a.classList.contains("b3-menu__avemoji")&&(n.block.icon=o.previousElementSibling.getAttribute("data-unicode")))}else if(e==="mSelect"||e==="select"){const o=[];t.querySelectorAll(".b3-chip").forEach(i=>{o.push({content:i.textContent.trim(),color:i.style.color.replace("var(--b3-font-color","").replace(")","")})}),n.mSelect=o}else if(["date","created","updated"].includes(e))n[e]=JSON.parse(t.querySelector(".av__celltext").getAttribute("data-value"));else if(e==="checkbox")n.checkbox={checked:t.querySelector("use").getAttribute("xlink:href")==="#iconCheck"};else if(e==="relation"){const o=[],i=[];Array.from(t.querySelectorAll(".av__cell--relation")).forEach(s=>{const l=s.querySelector(".av__celltext");o.push(l.dataset.id),i.push({isDetached:!l.classList.contains("av__celltext--ref"),block:{content:l.textContent,id:l.dataset.id},type:"block"})}),n.relation={blockIDs:o,contents:i}}else if(e==="mAsset"){const o=[];Array.from(t.children).forEach(i=>{if(i.classList.contains("av__drag-fill"))return;const s=i.classList.contains("av__cellassetimg");o.push({type:s?"image":"file",content:s?i.getAttribute("src"):i.getAttribute("data-url"),name:s?"":i.getAttribute("data-name")})}),n.mAsset=o}return e==="block"&&(n.isDetached=t.dataset.detached==="true"),n},gl=(e,t)=>{let a={type:e,[e==="select"?"mSelect":e]:t};if(typeof t=="string"&&t){if(e==="number")a={type:e,number:{content:parseFloat(t)||0,isNotEmpty:!0}};else if(["text","block","url","phone","email","template"].includes(e))a={type:e,[e]:{content:t}};else if(e==="mSelect"||e==="select")a={type:e,mSelect:[{content:t,color:"1"}]};else if(e==="checkbox")a={type:e,checkbox:{checked:!0}};else if(e==="date"){let n=t.split("\u2192");n.length!==2&&(n=t.split("-"),n.length!==2&&(n=t.split("~")));const o=dayjs(n[0]),i=dayjs(n[1]||"");isNaN(o.valueOf())?a={type:e,date:{content:null,isNotEmpty:!1,content2:null,isNotEmpty2:!1,formattedContent:"",hasEndDate:!1,isNotTime:!0}}:a={type:e,date:{content:o.valueOf(),isNotEmpty:!0,content2:i.valueOf()||0,isNotEmpty2:!isNaN(i.valueOf()),hasEndDate:!isNaN(i.valueOf()),isNotTime:o.hour()===0,formattedContent:""}}}else if(e==="relation")a={type:e,relation:{blockIDs:[t],contents:[]}};else if(e==="mAsset"){const n=pathPosix().extname(t).toLowerCase();a={type:e,mAsset:[{type:Constants.SIYUAN_ASSETS_IMAGE.includes(n)?"image":"file",content:t,name:""}]}}}else(typeof t=="undefined"||!t)&&(e==="number"?a={type:e,number:{content:null,isNotEmpty:!1}}:["text","block","url","phone","email","template"].includes(e)?a={type:e,[e]:{content:""}}:e==="mSelect"||e==="select"||e==="mAsset"?a={type:e,[e==="select"?"mSelect":e]:[]}:["date","created","updated"].includes(e)?a={type:e,[e]:{content:null,isNotEmpty:!1,content2:null,isNotEmpty2:!1,hasEndDate:!1,isNotTime:!0}}:e==="checkbox"?a={type:e,checkbox:{checked:!1}}:e==="relation"?a={type:e,relation:{blockIDs:[],contents:[]}}:e==="rollup"&&(a={type:e,rollup:{contents:[]}}));return e==="block"&&(typeof t=="object"&&t.id?a.isDetached=!1:a.isDetached=!0),a},Ds=(e,t,a=!0)=>{const n=t.getBoundingClientRect();if(!a){const i=e.querySelector(".av__scroll"),s=J(t,"av__row");if(i&&s){const l=s.querySelector(".av__colsticky");if(!l.contains(t)){const r=l.getBoundingClientRect().right,c=i.getBoundingClientRect();r>n.left||c.right<n.left?i.scrollLeft=i.scrollLeft+n.left-r:r<n.left&&c.right<n.right&&(n.width+r>c.right?i.scrollLeft=i.scrollLeft+n.left-r:i.scrollLeft=i.scrollLeft+n.right-c.right)}}}const o=J(e,"protyle-content",!0);if(o&&t.getAttribute("data-dtype")!=="checkbox"){const i=document.getElementById("keyboardToolbar"),s=parseInt(i.getAttribute("data-keyboardheight"))||window.outerHeight/2-42;n.bottom>window.innerHeight-s-42?o.scrollTop+=n.bottom-window.innerHeight+42+s:n.top<110&&(o.scrollTop-=110-n.top)}},mn=e=>{const t=hasClosestByClassName(e,"av__scroll");if(t)return t.querySelector(".av__row--header").querySelector(`[data-col-id="${e.getAttribute("data-col-id")}"]`).getAttribute("data-dtype")},vf=(e,t,a)=>{var n;if(t.length===0||t.length===1&&!t[0]||(a||(a=mn(t[0])),a==="updated"||a==="created"||document.querySelector(".av__mask")))return;const o=hasClosestBlock(t[0]);if(!o)return;let i=t[0].getBoundingClientRect();const s=hasClosestByClassName(o,"protyle-content",!0);Ds(o,t[0],!1),i=t[0].getBoundingClientRect();let l="",r=i.height,c;if(s){const f=s.getBoundingClientRect();i.bottom>f.bottom&&(r=f.bottom-i.top);const p=Math.min(Math.max(i.width,25),f.width);c=`style="padding-top: 6.5px;position:absolute;left: ${i.left<f.left||i.left+p>f.right?f.left:i.left}px;top: ${i.top}px;width:${p}px;height: ${r}px"`}else c=`style="padding-top: 6.5px;position:absolute;left: ${i.left}px;top: ${i.top}px;width:${Math.max(i.width,25)}px;height: ${r}px"`;if(["text","email","phone","block","template"].includes(a))l=`<textarea ${c} spellcheck="false" class="b3-text-field"></textarea>`;else if(a==="url")l=`<textarea ${c} spellcheck="false" class="b3-text-field">${t[0].firstElementChild.getAttribute("data-href")}</textarea>`;else if(a==="number")l=`<input type="number" spellcheck="false" value="${t[0].firstElementChild.getAttribute("data-content")}" ${c} class="b3-text-field">`;else{["select","mSelect"].includes(a)?openMenuPanel({protyle:e,blockElement:o,type:"select",cellElements:t}):a==="mAsset"?(openMenuPanel({protyle:e,blockElement:o,type:"asset",cellElements:t}),focusBlock(o)):a==="date"?openMenuPanel({protyle:e,blockElement:o,type:"date",cellElements:t}):a==="checkbox"?bn(e,a,o,t):a==="relation"?openMenuPanel({protyle:e,blockElement:o,type:"relation",cellElements:t}):a==="rollup"&&openMenuPanel({protyle:e,blockElement:o,type:"rollup",cellElements:t,colId:t[0].dataset.colId}),hasClosestByClassName(t[0],"custom-attr")||(t[0].classList.add("av__cell--select"),_a(t[0]));return}window.siyuan.menus.menu.remove(),document.body.insertAdjacentHTML("beforeend",`<div class="av__mask" style="z-index: ${++window.siyuan.zIndex}">
    ${l}
</div>`);const d=document.querySelector(".av__mask"),u=d.querySelector(".b3-text-field");u&&(["text","email","phone","block","template"].includes(a)&&(u.value=((n=t[0].querySelector(".av__celltext"))==null?void 0:n.textContent)||""),u.select(),u.focus(),a==="template"&&fetchPost("/api/av/renderAttributeView",{id:o.dataset.avId,viewID:o.getAttribute(Constants.CUSTOM_SY_AV_VIEW)},f=>{f.data.view.columns.find(p=>{if(p.id===t[0].dataset.colId)return u.value=p.template,u.dataset.template=p.template,!0})}),a==="block"&&u.addEventListener("input",f=>{if(Constants.BLOCK_HINT_KEYS.includes(u.value.substring(0,2))){if(e.toolbar.range=document.createRange(),!o.contains(t[0])){const m=hasClosestByClassName(t[0],"av__row");t[0]&&(t[0]=o.querySelector(`.av__row[data-id="${m.dataset.id}"] .av__cell[data-col-id="${t[0].dataset.colId}"]`))}e.toolbar.range.selectNodeContents(t[0].lastChild),focusByRange(e.toolbar.range),t[0].classList.add("av__cell--select"),_a(t[0]);let p=u.value;isDynamicRef(p)?p=p.substring(2,22+2):p=p.substring(2),hintRef(p,e,"av"),d==null||d.remove(),f.preventDefault(),f.stopPropagation()}}),u.addEventListener("keydown",f=>{f.isComposing||electronUndo(f)||(f.key==="Escape"||f.key==="Tab"||f.key==="Enter"&&!f.shiftKey&&isNotCtrl(f))&&(bn(e,a,o,t),f.key==="Tab"&&e.wysiwyg.element.dispatchEvent(new KeyboardEvent("keydown",{shiftKey:f.shiftKey,ctrlKey:f.ctrlKey,altKey:f.altKey,metaKey:f.metaKey,key:"Tab",keyCode:9})),f.preventDefault(),f.stopPropagation())}));const g=f=>{f.target.classList.contains("av__mask")&&document.activeElement.tagName!=="TEXTAREA"&&document.activeElement.tagName!=="INPUT"&&(bn(e,a,o,t),d==null||d.remove())};d.addEventListener("click",f=>{g(f)}),d.addEventListener("contextmenu",f=>{g(f)}),d.addEventListener("mousedown",f=>{f.button===1&&(f.target.classList.contains("av__mask")&&document.activeElement&&document.activeElement.nodeType===1&&document.activeElement.blur(),g(f))})},bn=(e,t,a,n)=>{const o=hasClosestByClassName(n[0],"av__row");if(!o||n.length===1&&n[0].dataset.detached==="true"&&!o.dataset.id)return;const i=document.querySelector(".av__mask"),s=a.getAttribute("data-av-id");if(t==="template"){const l=n[0].getAttribute("data-col-id"),r=i.querySelector(".b3-text-field");r.value!==r.dataset.template&&!a.getAttribute("data-loading")&&(transaction(e,[{action:"updateAttrViewColTemplate",id:l,avID:s,data:r.value,type:"template"}],[{action:"updateAttrViewColTemplate",id:l,avID:s,data:r.dataset.template,type:"template"}]),a.setAttribute("data-loading","true"))}else pl(e,a,t==="checkbox"?{checked:n[0].querySelector("use").getAttribute("xlink:href")==="#iconUncheck"}:i.querySelector(".b3-text-field").value,n);n[0]&&!hasClosestByClassName(n[0],"custom-attr")&&(n[0].classList.add("av__cell--select"),_a(n[0])),document.querySelector(".b3-dialog")||focusBlock(a),document.querySelectorAll(".av__mask").forEach(l=>{l.remove()})},pl=(e,t,a,n,o,i)=>{const s=[],l=[],r=t.dataset.avId,c=t.dataset.nodeId;let d="";const u=[];let g;(n==null?void 0:n.length)>0?g=n:(g=Array.from(t.querySelectorAll(".av__cell--active, .av__cell--select")),g.length===0&&t.querySelectorAll(".av__row--select:not(.av__row--header)").forEach(p=>{p.querySelectorAll(".av__cell").forEach(m=>{g.push(m)})}));const f=hasClosestByClassName(g[0],"custom-attr");return g.forEach((p,m)=>{const b=hasClosestByClassName(p,"av__row");if(!b||(t.contains(p)||(p=g[m]=t.querySelector(`.av__row[data-id="${b.dataset.id}"] .av__cell[data-col-id="${p.dataset.colId}"]`)||t.querySelector(`.fn__flex-1[data-col-id="${p.dataset.colId}"]`)),!p))return;const w=mn(p)||p.dataset.type;if(["created","updated","template","rollup"].includes(w))return;const y=b.getAttribute("data-id"),_=p.dataset.id,h=p.dataset.colId;d+=fl(p)+(g[m+1]&&p.nextElementSibling&&p.nextElementSibling.isSameNode(g[m+1])?"	":`

`);const E=Ms(w,p);(m===0||!g[m-1].isSameNode(p.previousElementSibling))&&u.push([]),u[u.length-1].push(E);let C=a;if(w==="mAsset"){if(Array.isArray(a))C=E.mAsset.concat(a);else if(typeof a!="undefined"){let v=e.lute.GetLinkDest(a),A="",L="";if(!v&&a.startsWith("assets/")&&(v=a,A=getAssetName(a)+pathPosix().extname(a)),i){const x=document.createElement("template");x.innerHTML=i;const T=x.content.querySelector('[data-type~="a"]');if(T)v=T.getAttribute("data-href"),A=T.textContent;else{const M=x.content.querySelector(".img img");M&&(L=M.getAttribute("data-src"))}}if(v||(A=a),!v&&!A&&!L)return;L?C=E.mAsset.concat({type:"image",content:L,name:""}):C=E.mAsset.concat({type:"file",content:v,name:A})}}else if(w==="mSelect"){if(typeof a=="string"){const v=[];let A=E.mSelect.length;[...new Set(a.split(",").map(L=>L.trim().replace(/\n|\r\n|\r|\u2028|\u2029/g,"")))].forEach(L=>{if(!L)return;let x=!1;E.mSelect.find(T=>{if(T.content===L)return x=!0,!0}),!x&&(A++,v.push({content:L,color:A.toString()}))}),C=E.mSelect.concat(v)}}else w==="block"&&typeof a=="string"&&E.block.id&&(C={content:a,id:E.block.id},E.block.icon&&(C.icon=E.block.icon));const k=gl(w,C);if(k.id=_,!(k.type==="date"&&typeof k.date=="string"||k.type==="relation"&&typeof k.relation=="string")){if(o&&(w==="select"||w==="mSelect")){const v=mergeAddOption(o.find(A=>A.id===h),k,r);s.push(...v.doOperations),l.push(...v.undoOperations)}objEquals(k,E)||(s.push({action:"updateAttrViewCell",id:_,avID:r,keyID:h,rowID:y,data:k}),l.push({action:"updateAttrViewCell",id:_,avID:r,keyID:h,rowID:y,data:E}),f?p.innerHTML=genAVValueHTML(k):updateAttrViewCellAnimation(p,k))}}),s.length>0&&(s.push({action:"doUpdateUpdated",id:c,data:dayjs().format("YYYYMMDDHHmmss")}),l.push({action:"doUpdateUpdated",id:c,data:t.getAttribute("updated")}),transaction(e,s,l)),{text:d.substring(0,d.length-2),json:u}},ml=(e,t)=>{t.type==="checkbox"?t.checkbox.checked?(e.classList.add("av__cell-check"),e.classList.remove("av__cell-uncheck")):(e.classList.remove("av__cell-check"),e.classList.add("av__cell-uncheck")):t.type==="block"&&(t.block.id&&e.setAttribute("data-block-id",t.block.id),t.isDetached?e.setAttribute("data-detached","true"):e.removeAttribute("data-detached"))},yn=(e,t=0)=>{var a,n,o,i,s,l,r,c,d,u;let g="";if(e.type==="template")g=`<span class="av__celltext">${e&&e.template.content||""}</span>`;else if(e.type==="text")g=`<span class="av__celltext">${e?Lute.EscapeHTMLStr(e.text.content||""):""}</span>`;else if(["email","phone"].includes(e.type))g=`<span class="av__celltext av__celltext--url" data-type="${e.type}">${e?Lute.EscapeHTMLStr(e[e.type].content||""):""}</span>`;else if(e.type==="url")g=Is(((a=e==null?void 0:e.url)==null?void 0:a.content)||"");else if(e.type==="block")e!=null&&e.isDetached?g=`<span class="av__celltext">${Lute.EscapeHTMLStr(e.block.content||"")}</span><span class="b3-chip b3-chip--info b3-chip--small" data-type="block-more">${window.siyuan.languages.more}</span>`:g=`<span class="b3-menu__avemoji" data-unicode="${e.block.icon||""}">${Le(e.block.icon||window.siyuan.storage[S.LOCAL_IMAGES].file)}</span><span data-type="block-ref" data-id="${e.block.id}" data-subtype="s" class="av__celltext av__celltext--ref">${Lute.EscapeHTMLStr(e.block.content)}</span><span class="b3-chip b3-chip--info b3-chip--small" data-type="block-more">${window.siyuan.languages.update}</span>`;else if(e.type==="number")g=`<span class="av__celltext" data-content="${e!=null&&e.number.isNotEmpty?e==null?void 0:e.number.content:""}">${(e==null?void 0:e.number.formattedContent)||(e==null?void 0:e.number.content)||""}</span>`;else if(e.type==="mSelect"||e.type==="select")(n=e==null?void 0:e.mSelect)==null||n.forEach((f,p)=>{e.type==="select"&&p>0||(g+=`<span class="b3-chip" style="background-color:var(--b3-font-background${f.color});color:var(--b3-font-color${f.color})">${pn(f.content)}</span>`)});else if(e.type==="date"){const f=e?e.date:null;g=`<span class="av__celltext" data-value='${JSON.stringify(f)}'>`,f&&f.isNotEmpty&&(g+=Ze(f.content).format(f.isNotTime?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")),f&&f.hasEndDate&&f.isNotEmpty&&f.isNotEmpty2&&(g+=`<svg class="av__cellicon"><use xlink:href="#iconForward"></use></svg>${Ze(f.content2).format(f.isNotTime?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")}`),g+="</span>"}else if(["created","updated"].includes(e.type)){const f=e?e[e.type]:null;g=`<span class="av__celltext" data-value='${JSON.stringify(f)}'>`,f&&f.isNotEmpty&&(g+=Ze(f.content).format("YYYY-MM-DD HH:mm")),g+="</span>"}else["lineNumber"].includes(e.type)?g=`<span class="av__celltext" data-value='${t+1}'>${t+1}</span>`:e.type==="mAsset"?(o=e==null?void 0:e.mAsset)==null||o.forEach(f=>{f.type==="image"?g+=`<img class="av__cellassetimg ariaLabel" aria-label="${f.content}" src="${f.content}">`:g+=`<span class="b3-chip av__celltext--url ariaLabel" aria-label="${Yt(f.content)}" data-name="${Yt(f.name)}" data-url="${Yt(f.content)}">${f.name||f.content}</span>`}):e.type==="checkbox"?g+=`<svg class="av__checkbox"><use xlink:href="#icon${(i=e==null?void 0:e.checkbox)!=null&&i.checked?"Check":"Uncheck"}"></use></svg>`:e.type==="rollup"?((l=(s=e==null?void 0:e.rollup)==null?void 0:s.contents)==null||l.forEach(f=>{const p=["select","mSelect","mAsset","checkbox","relation"].includes(f.type)?yn(f):bl(f);p&&(g+=p+", ")}),g&&g.endsWith(", ")&&(g=g.substring(0,g.length-2))):e.type==="relation"&&((c=(r=e==null?void 0:e.relation)==null?void 0:r.contents)==null||c.forEach(f=>{var p;f&&f.block&&(f!=null&&f.isDetached?g+=`<span class="av__cell--relation"><span>\u2796 </span><span class="av__celltext" data-id="${(p=f.block)==null?void 0:p.id}">${Lute.EscapeHTMLStr(f.block.content||window.siyuan.languages.untitled)}</span></span>`:g+=`<span class="av__cell--relation" data-block-id="${f.block.id}"><span class="b3-menu__avemoji" data-unicode="${f.block.icon||""}">${Le(f.block.icon||window.siyuan.storage[S.LOCAL_IMAGES].file)}</span><span data-type="block-ref" data-id="${f.block.id}" data-subtype="s" class="av__celltext av__celltext--ref">${Lute.EscapeHTMLStr(f.block.content||window.siyuan.languages.untitled)}</span></span>`)}),g&&g.endsWith(", ")&&(g=g.substring(0,g.length-2)));return(["text","template","url","email","phone","number","date","created","updated"].includes(e.type)&&((d=e[e.type])!=null&&d.content)||e.type==="lineNumber"||e.type==="block"&&((u=e.block)!=null&&u.content))&&(g+=`<span ${e.type!=="number"?"":'style="right:auto;left:5px"'} data-type="copy" class="block__icon"><svg><use xlink:href="#iconCopy"></use></svg></span>`),g},bl=e=>{var t,a,n,o,i;let s="";if(["text"].includes(e.type))s=e&&e[e.type].content||"";else if(["email","phone"].includes(e.type)){const l=e?e[e.type].content:"";l&&(s=`<span class="av__celltext av__celltext--url" data-type="${e.type}">${l}</span>`)}else if(e.type==="url"){const l=((t=e==null?void 0:e.url)==null?void 0:t.content)||"";l&&(s=Is(l))}else if(e.type==="block")e!=null&&e.isDetached?s=`<span class="av__celltext" data-id="${(a=e.block)==null?void 0:a.id}">${Lute.EscapeHTMLStr(((n=e.block)==null?void 0:n.content)||window.siyuan.languages.untitled)}</span>`:s=`<span data-type="block-ref" data-id="${(o=e.block)==null?void 0:o.id}" data-subtype="s" class="av__celltext av__celltext--ref">${Lute.EscapeHTMLStr(((i=e.block)==null?void 0:i.content)||window.siyuan.languages.untitled)}</span>`;else if(e.type==="number")s=(e==null?void 0:e.number.formattedContent)||(e==null?void 0:e.number.content.toString())||"";else if(e.type==="date"){const l=e?e.date:null;l.formattedContent?s=l.formattedContent:(l&&l.isNotEmpty&&(s=Ze(l.content).format(l.isNotTime?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")),l&&l.hasEndDate&&l.isNotEmpty&&l.isNotEmpty2&&(s=`<svg class="av__cellicon"><use xlink:href="#iconForward"></use></svg>${Ze(l.content2).format(l.isNotTime?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")}`)),s&&(s=`<span class="av__celltext">${s}</span>`)}return s},Ef=(e,t)=>{var a;if(typeof t.icon!="undefined"&&(e.dataset.icon=t.icon,e.querySelector(".av__cellheadericon").outerHTML=t.icon?unicode2Emoji(t.icon,"av__cellheadericon",!0):`<svg class="av__cellheadericon"><use xlink:href="#${getColIconByType(e.dataset.dtype)}"></use></svg>`),typeof t.name!="undefined"&&(e.querySelector(".av__celltext").textContent=t.name),typeof t.pin!="undefined"){const n=e.querySelector(".av__celltext");t.pin?e.querySelector(".av__cellheadericon--pin")||n.insertAdjacentHTML("afterend",'<svg class="av__cellheadericon av__cellheadericon--pin"><use xlink:href="#iconPin"></use></svg>'):(a=e.querySelector(".av__cellheadericon--pin"))==null||a.remove()}},kf=e=>{let t=hasClosestByClassName(e,"av__row");if(!t)return;let a=-1;for(;t;)t=t.previousElementSibling,a++;let n=-2;for(;e;)e=e.previousElementSibling,e&&e.classList.contains("av__colsticky")&&(e=e.lastElementChild),n++;return{rowIndex:a,celIndex:n}},Cf=(e,t,a,n)=>{var o;(o=t.querySelector(".av__drag-fill"))==null||o.remove();const i={};t.querySelectorAll(".av__cell--active").forEach(d=>{if(n.includes(d.dataset.id))return;const u=hasClosestByClassName(d,"av__row");if(!u)return;i[u.dataset.id]||(i[u.dataset.id]=[]);const g=Ms(mn(d),d);g.colId=d.dataset.colId,g.element=d,i[u.dataset.id].push(g)});const s=[],l=[],r=t.dataset.avId,c=Object.keys(a);Object.keys(i).forEach((d,u)=>{i[d].forEach((g,f)=>{if(["rollup","template","created","updated"].includes(g.type)||g.type==="block"&&g.element.getAttribute("data-detached")!=="true")return;const p=JSON.parse(JSON.stringify(a[c[u%c.length]][f]));p.id=g.id;const m=g.colId;p.type==="block"&&(p.isDetached=!0,delete p.block.id),s.push({action:"updateAttrViewCell",id:g.id,avID:r,keyID:m,rowID:d,data:p}),g.element.innerHTML=yn(p),ml(g.element,p),delete g.colId,delete g.element,l.push({action:"updateAttrViewCell",id:g.id,avID:r,keyID:m,rowID:d,data:g})})}),focusBlock(t),s.length>0&&transaction(e,s,l)},_a=e=>{e&&(e.classList.add("av__cell--active"),e.querySelector(".av__drag-fill")||e.insertAdjacentHTML("beforeend",`<div aria-label="${window.siyuan.languages.dragFill}" class="av__drag-fill ariaLabel"></div>`))};var yl=(e,t,a)=>new Promise((n,o)=>{var i=r=>{try{l(a.next(r))}catch(c){o(c)}},s=r=>{try{l(a.throw(r))}catch(c){o(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(i,s);l((a=a.apply(e,t)).next())});const hl=e=>{if(["select","number","date","created","updated"].includes(e))return"=";if(["checkbox"].includes(e))return"Is false";if(["rollup","relation","rollup","text","mSelect","url","block","email","phone","template"].includes(e))return"Contains"},$s=(e,t,a)=>{const n=hasClosestByClassName(e,"b3-menu");if(n){if(["date","updated","created"].includes(a)){const o=n.querySelector('.b3-menu__item div[data-type="filter1"]'),i=o.nextElementSibling;t==="Is between"?(i.classList.remove("fn__none"),o.classList.remove("fn__none")):t==="Is empty"||t==="Is not empty"?(i.classList.add("fn__none"),o.classList.add("fn__none")):(o.classList.remove("fn__none"),i.classList.add("fn__none"));return}n.querySelectorAll("input, .b3-chip").forEach(o=>{const i=hasClosestByClassName(o,"b3-menu__item");i&&(t!=="Is empty"&&t!=="Is not empty"?i.classList.remove("fn__none"):i.classList.add("fn__none"))})}},Hs=e=>{window.siyuan.menus.menu.element.querySelectorAll(".b3-menu__item").forEach(t=>{const a=t.querySelector(".b3-chip.b3-chip--middle");if(a){const n=a.dataset.name.toLowerCase();!e||e.indexOf(n)>-1||n.indexOf(e)>-1?t.classList.remove("fn__none"):t.classList.add("fn__none")}})},wl=e=>yl(void 0,null,function*(){var t,a,n,o,i,s,l,r,c,d,u,g,f,p,m,b,w,y;let _=e.target.getBoundingClientRect();_.height===0&&(_=e.protyle.wysiwyg.element.querySelector(`[data-col-id="${e.target.dataset.colId}"]`).getBoundingClientRect());const h=e.blockElement.getAttribute("data-node-id"),E=new Menu("set-filter-"+e.filter.column,()=>{const M=JSON.parse(JSON.stringify(e.data.view.filters)),I=E.element.querySelector(".b3-select");if(!I||!I.value)return;const D={column:e.filter.column,value:{type:e.filter.value.type},operator:I.value};let N=!1,H;if(v.type==="select"||v.type==="mSelect"){const U=[];window.siyuan.menus.menu.element.querySelectorAll("svg").forEach(V=>{if(V.firstElementChild.getAttribute("xlink:href")==="#iconCheck"){const be=V.nextElementSibling.firstElementChild;U.push({color:be.dataset.color,content:be.dataset.name})}}),H=genCellValue(v.type,U)}else if(["date","updated","created"].includes(v.type)){const U=E.element.querySelector('.b3-select[data-type="dateType"]'),V=E.element.querySelectorAll('.b3-select[data-type="dataDirection"]');U.value==="custom"?(D.relativeDate={count:parseInt(V[0].parentElement.querySelector(".b3-text-field").value||"1"),unit:parseInt(V[0].parentElement.lastElementChild.value),direction:parseInt(V[0].value)},D.relativeDate2={count:parseInt(V[1].parentElement.querySelector(".b3-text-field").value||"1"),unit:parseInt(V[1].parentElement.lastElementChild.value),direction:parseInt(V[1].value)},H={type:v.type}):(H=genCellValue(v.type,{isNotEmpty2:T[2].value!=="",isNotEmpty:T[0].value!=="",content:T[0].value?new Date(T[0].value+" 00:00").getTime():null,content2:T[2].value?new Date(T[2].value+" 00:00").getTime():null,hasEndDate:D.operator==="Is between",isNotTime:!0}),D.relativeDate=null,D.relativeDate2=null)}else["text","url","block","email","phone","template","relation","number"].includes(v.type)?H=genCellValue(v.type,T[0].value):v.type==="checkbox"?H=genCellValue(v.type,{checked:D.operator==="Is true"}):H=genCellValue(v.type,void 0);e.filter.value.type==="rollup"?D.value={rollup:{contents:[H]},type:"rollup"}:D.value=H;let P=!1;if(e.data.view.filters.find((U,V)=>{if(U.column===e.filter.column&&U.value.type===e.filter.value.type)return U.value.type==="checkbox"?(N=!0,e.data.view.filters[V]=D,!0):objEquals(U,D)?(P=!0,!0):(e.data.view.filters[V]=D,N=!0,!0)}),P||!N)return;transaction(e.protyle,[{action:"setAttrViewFilters",avID:e.data.id,data:e.data.view.filters,blockID:h}],[{action:"setAttrViewFilters",avID:e.data.id,data:M,blockID:h}]);const ne=hasClosestByClassName(e.target,"b3-menu");ne&&(ne.innerHTML=hn(e.data.view))});if(E.isOpen)return;let C="",k;e.data.view.columns.find(M=>{if(M.id===e.filter.column)return k=M,!0});let v=JSON.parse(JSON.stringify(e.filter.value));if(k.type==="rollup"){if(!k.rollup||!k.rollup.relationKeyID||!k.rollup.keyID){showMessage(window.siyuan.languages.plsChoose),openMenuPanel({protyle:e.protyle,blockElement:e.blockElement,type:"edit",colId:k.id});return}let M="";e.data.view.columns.find(D=>{if(D.id===k.rollup.relationKeyID)return M=D.relation.avID,!0}),(yield fetchSyncPost("/api/av/getAttributeView",{id:M})).data.av.keyValues.find(D=>{if(D.key.id===k.rollup.keyID)return v.type=D.key.type,!0}),e.data.view.filters.find(D=>{if(D.column===k.id&&D.value.type==="rollup")return!D.value.rollup||!D.value.rollup.contents||D.value.rollup.contents.length===0?v={[v.type]:genCellValue(v.type,v.type==="checkbox"?{checked:void 0}:""),type:v.type}:v=D.value.rollup.contents[0],!0})}let A=!1;switch(v.type==="checkbox"&&(A=typeof v.checkbox=="undefined"||typeof v.checkbox.checked=="undefined"),v.type){case"checkbox":C=`<option ${e.filter.operator==="Is true"&&!A?"selected":""} value="Is true">${window.siyuan.languages.checked}</option>
<option ${e.filter.operator==="Is false"&&!A?"selected":""} value="Is false">${window.siyuan.languages.unchecked}</option>`,A&&(C=`<option selected></option>${C}`);break;case"block":case"text":case"url":case"phone":case"email":C=`<option ${e.filter.operator==="="?"selected":""} value="=">${window.siyuan.languages.filterOperatorIs}</option>
<option ${e.filter.operator==="!="?"selected":""} value="!=">${window.siyuan.languages.filterOperatorIsNot}</option>
<option ${e.filter.operator==="Contains"?"selected":""} value="Contains">${window.siyuan.languages.filterOperatorContains}</option>
<option ${e.filter.operator==="Does not contains"?"selected":""} value="Does not contains">${window.siyuan.languages.filterOperatorDoesNotContain}</option>
<option ${e.filter.operator==="Starts with"?"selected":""} value="Starts with">${window.siyuan.languages.filterOperatorStartsWith}</option>
<option ${e.filter.operator==="Ends with"?"selected":""} value="Ends with">${window.siyuan.languages.filterOperatorEndsWith}</option>
<option ${e.filter.operator==="Is empty"?"selected":""} value="Is empty">${window.siyuan.languages.filterOperatorIsEmpty}</option>
<option ${e.filter.operator==="Is not empty"?"selected":""} value="Is not empty">${window.siyuan.languages.filterOperatorIsNotEmpty}</option>`;break;case"template":C=`<option ${e.filter.operator==="="?"selected":""} value="=">${window.siyuan.languages.filterOperatorIs}</option>
<option ${e.filter.operator==="!="?"selected":""} value="!=">${window.siyuan.languages.filterOperatorIsNot}</option>
<option ${e.filter.operator==="Contains"?"selected":""} value="Contains">${window.siyuan.languages.filterOperatorContains}</option>
<option ${e.filter.operator==="Does not contains"?"selected":""} value="Does not contains">${window.siyuan.languages.filterOperatorDoesNotContain}</option>
<option ${e.filter.operator==="Starts with"?"selected":""} value="Starts with">${window.siyuan.languages.filterOperatorStartsWith}</option>
<option ${e.filter.operator==="Ends with"?"selected":""} value="Ends with">${window.siyuan.languages.filterOperatorEndsWith}</option>
<option ${e.filter.operator==="Is empty"?"selected":""} value="Is empty">${window.siyuan.languages.filterOperatorIsEmpty}</option>
<option ${e.filter.operator==="Is not empty"?"selected":""} value="Is not empty">${window.siyuan.languages.filterOperatorIsNotEmpty}</option>
<option ${e.filter.operator===">"?"selected":""} value=">">&gt;</option>
<option ${e.filter.operator==="<"?"selected":""} value="<">&lt;</option>
<option ${e.filter.operator===">="?"selected":""} value=">=">&GreaterEqual;</option>
<option ${e.filter.operator==="<="?"selected":""} value="<=">&le;</option>`;break;case"date":case"created":case"updated":C=`<option ${e.filter.operator==="="?"selected":""} value="=">${window.siyuan.languages.filterOperatorIs}</option>
<option ${e.filter.operator===">"?"selected":""} value=">">${window.siyuan.languages.filterOperatorIsAfter}</option>
<option ${e.filter.operator==="<"?"selected":""} value="<">${window.siyuan.languages.filterOperatorIsBefore}</option>
<option ${e.filter.operator===">="?"selected":""} value=">=">${window.siyuan.languages.filterOperatorIsOnOrAfter}</option>
<option ${e.filter.operator==="<="?"selected":""} value="<=">${window.siyuan.languages.filterOperatorIsOnOrBefore}</option>
<option ${e.filter.operator==="Is between"?"selected":""} value="Is between">${window.siyuan.languages.filterOperatorIsBetween}</option>
<option ${e.filter.operator==="Is empty"?"selected":""} value="Is empty">${window.siyuan.languages.filterOperatorIsEmpty}</option>
<option ${e.filter.operator==="Is not empty"?"selected":""} value="Is not empty">${window.siyuan.languages.filterOperatorIsNotEmpty}</option>`;break;case"number":C=`<option ${e.filter.operator==="="?"selected":""} value="=">=</option>
<option ${e.filter.operator==="!="?"selected":""} value="!=">!=</option>
<option ${e.filter.operator===">"?"selected":""} value=">">&gt;</option>
<option ${e.filter.operator==="<"?"selected":""} value="<">&lt;</option>
<option ${e.filter.operator===">="?"selected":""} value=">=">&GreaterEqual;</option>
<option ${e.filter.operator==="<="?"selected":""} value="<=">&le;</option>
<option ${e.filter.operator==="Is empty"?"selected":""} value="Is empty">${window.siyuan.languages.filterOperatorIsEmpty}</option>
<option ${e.filter.operator==="Is not empty"?"selected":""} value="Is not empty">${window.siyuan.languages.filterOperatorIsNotEmpty}</option>`;break;case"mSelect":case"relation":C=`<option ${e.filter.operator==="Contains"?"selected":""} value="Contains">${window.siyuan.languages.filterOperatorContains}</option>
<option ${e.filter.operator==="Does not contains"?"selected":""} value="Does not contains">${window.siyuan.languages.filterOperatorDoesNotContain}</option>
<option ${e.filter.operator==="Is empty"?"selected":""} value="Is empty">${window.siyuan.languages.filterOperatorIsEmpty}</option>
<option ${e.filter.operator==="Is not empty"?"selected":""} value="Is not empty">${window.siyuan.languages.filterOperatorIsNotEmpty}</option>`;break;case"select":C=`<option ${e.filter.operator==="="?"selected":""} value="=">${window.siyuan.languages.filterOperatorIs}</option>
<option ${e.filter.operator==="!="?"selected":""} value="!=">${window.siyuan.languages.filterOperatorIsNot}</option>
<option ${e.filter.operator==="Is empty"?"selected":""} value="Is empty">${window.siyuan.languages.filterOperatorIsEmpty}</option>
<option ${e.filter.operator==="Is not empty"?"selected":""} value="Is not empty">${window.siyuan.languages.filterOperatorIsNotEmpty}</option>`;break}if(E.addItem({iconHTML:"",type:"readonly",label:`<select style="margin: 4px 0" class="b3-select fn__size200">${C}</select>`}),v.type==="select"||v.type==="mSelect")((t=k.options)==null?void 0:t.length)>0&&E.addItem({iconHTML:"",type:"readonly",label:`<input class="b3-text-field fn__size200" style="margin: 4px 0" placeholder="${window.siyuan.languages.search}">`,bind(M){const I=M.querySelector("input");I.addEventListener("keydown",D=>{if(D.isComposing)return;let N=upDownHint(E.element.querySelector(".b3-menu__items"),D,"b3-menu__item--current",M.nextElementSibling);D.key==="Enter"&&(N||(N=E.element.querySelector(".b3-menu__item--current")),N.dispatchEvent(new CustomEvent("click")))}),I.addEventListener("input",D=>{D.isComposing||Hs(I.value.toLowerCase())}),I.addEventListener("compositionend",()=>{Hs(I.value.toLowerCase())})}}),(a=k.options)==null||a.forEach(M=>{var I;let D="iconUncheck";(I=v==null?void 0:v.mSelect)==null||I.find(N=>{N.content===M.name&&(D="iconCheck")}),E.addItem({icon:D,label:`<span class="b3-chip b3-chip--middle" data-name="${M.name}" data-color="${M.color}" style="max-width: 178px;margin:3px 0;background-color:var(--b3-font-background${M.color});color:var(--b3-font-color${M.color})">
    <span class="fn__ellipsis">${M.name}</span>
</span>`,bind(N){N.addEventListener("click",()=>{const H=N.querySelector("use");H.getAttribute("xlink:href")==="#iconUncheck"?H.setAttribute("xlink:href","#iconCheck"):H.setAttribute("xlink:href","#iconUncheck")})}})});else if(["text","url","block","email","phone","template","relation"].includes(v.type)){let M="";v&&(v.type==="relation"?M=v.relation.blockIDs[0]||"":M=v[v.type].content||""),E.addItem({iconHTML:"",type:"readonly",label:`<input style="margin: 4px 0" value="${M}" class="b3-text-field fn__size200">`})}else if(v.type==="number")E.addItem({iconHTML:"",type:"readonly",label:`<input style="margin: 4px 0" value="${v!=null&&v.number.isNotEmpty?v.number.content:""}" class="b3-text-field fn__size200">`});else if(["date","updated","created"].includes(v.type)){const M=v?v[v.type]:null,I=!((n=e.filter.relativeDate)!=null&&n.direction),D=!((o=e.filter.relativeDate2)!=null&&o.direction);E.addItem({iconHTML:"",type:"readonly",label:`<div data-type="filter1">
    <div class="fn__size200">
        <select class="b3-select fn__block" data-type="dateType">
            <option value="time"${e.filter.relativeDate?"":" selected"}>${window.siyuan.languages.includeTime}</option>
            <option value="custom"${e.filter.relativeDate?" selected":""}>${window.siyuan.languages.relativeToToday}</option>
        </select>
    </div>
    <div class="fn__hr"></div>
    <div class="fn__size200 ${e.filter.relativeDate?"fn__none":""}">
        <input value="${M&&(M.isNotEmpty||v.type!=="date")?dayjs(M.content).format("YYYY-MM-DD"):""}" type="date" max="9999-12-31" class="b3-text-field fn__block">
    </div>
    <div class="fn__flex fn__size200 ${e.filter.relativeDate?"":"fn__none"}">
        <select class="b3-select" data-type="dataDirection">
            <option value="-1"${((i=e.filter.relativeDate)==null?void 0:i.direction)===-1?" selected":""}>${window.siyuan.languages.pastDate}</option>
            <option value="1"${((s=e.filter.relativeDate)==null?void 0:s.direction)===1?" selected":""}>${window.siyuan.languages.nextDate}</option>
            <option value="0"${I?" selected":""}>${window.siyuan.languages.current}</option>
        </select>
        <span class="fn__space"></span>
        <input type="number" min="1" oninput="this.value = Math.max(this.value, 1)" step="1" value="${((l=e.filter.relativeDate)==null?void 0:l.count)||1}" class="b3-text-field fn__flex-1${I?" fn__none":""}"/>
        <span class="fn__space${I?" fn__none":""}"></span>
        <select class="b3-select fn__flex-1">
            <option value="0"${((r=e.filter.relativeDate)==null?void 0:r.unit)===0?" selected":""}>${window.siyuan.languages.day}</option>
            <option value="1"${!e.filter.relativeDate||((c=e.filter.relativeDate)==null?void 0:c.unit)===1?" selected":""}>${window.siyuan.languages.week}</option>
            <option value="2"${((d=e.filter.relativeDate)==null?void 0:d.unit)===2?" selected":""}>${window.siyuan.languages.month}</option>
            <option value="3"${((u=e.filter.relativeDate)==null?void 0:u.unit)===3?" selected":""}>${window.siyuan.languages.year}</option>
        </select>
    </div>
    <div class="fn__hr--small"></div>
</div>
<div data-type="filter2 fn__none">
    <div class="fn__hr--small"></div>
    <div class="fn__size200 ${e.filter.relativeDate2?"fn__none":""}">
        <input value="${M&&M.isNotEmpty2?dayjs(M.content2).format("YYYY-MM-DD"):""}" type="date" max="9999-12-31" class="b3-text-field fn__block">
    </div>
    <div class="fn__flex fn__size200 ${e.filter.relativeDate2?"":"fn__none"}">
        <select class="b3-select" data-type="dataDirection">
            <option value="-1"${((g=e.filter.relativeDate2)==null?void 0:g.direction)===-1?" selected":""}>${window.siyuan.languages.pastDate}</option>
            <option value="1"${((f=e.filter.relativeDate2)==null?void 0:f.direction)===1?" selected":""}>${window.siyuan.languages.nextDate}</option>
            <option value="0"${D?" selected":""}>${window.siyuan.languages.current}</option>
        </select>
        <span class="fn__space"></span>
        <input type="number" min="1" step="1" oninput="this.value = Math.max(this.value, 1)" value="${((p=e.filter.relativeDate2)==null?void 0:p.count)||1}" class="b3-text-field fn__flex-1${D?" fn__none":""}"/>
        <span class="fn__space${D?" fn__none":""}"></span>
        <select class="b3-select fn__flex-1">
            <option value="0"${((m=e.filter.relativeDate2)==null?void 0:m.unit)===0?" selected":""}>${window.siyuan.languages.day}</option>
            <option value="1"${!e.filter.relativeDate2||((b=e.filter.relativeDate2)==null?void 0:b.unit)===1?" selected":""}>${window.siyuan.languages.week}</option>
            <option value="2"${((w=e.filter.relativeDate2)==null?void 0:w.unit)===2?" selected":""}>${window.siyuan.languages.month}</option>
            <option value="3"${((y=e.filter.relativeDate2)==null?void 0:y.unit)===3?" selected":""}>${window.siyuan.languages.year}</option>
        </select>
    </div>
    <div class="fn__hr--small"></div>
</div>`})}E.addItem({icon:"iconTrashcan",label:window.siyuan.languages.removeFilters,click(){const M=Object.assign([],e.data.view.filters);e.data.view.filters.find((D,N)=>{if(D.column===e.filter.column&&e.filter.value.type===D.value.type)return e.data.view.filters.splice(N,1),!0}),transaction(e.protyle,[{action:"setAttrViewFilters",avID:e.data.id,data:e.data.view.filters,blockID:h}],[{action:"setAttrViewFilters",avID:e.data.id,data:M,blockID:h}]);const I=hasClosestByClassName(e.target,"b3-menu");I&&(I.innerHTML=hn(e.data.view))}});const L=E.element.querySelector(".b3-select");L.addEventListener("change",()=>{$s(L,L.value,v.type)});const x=E.element.querySelector('.b3-select[data-type="dateType"]');x==null||x.addEventListener("change",()=>{const M=E.element.querySelectorAll('[data-type="dataDirection"]'),I=M[0].parentElement,D=M[1].parentElement,N=I.previousElementSibling,H=D.previousElementSibling;x.value==="custom"?(I.classList.remove("fn__none"),D.classList.remove("fn__none"),N.classList.add("fn__none"),H.classList.add("fn__none")):(I.classList.add("fn__none"),D.classList.add("fn__none"),N.classList.remove("fn__none"),H.classList.remove("fn__none"))}),E.element.querySelectorAll('.b3-select[data-type="dataDirection"]').forEach(M=>{M.addEventListener("change",()=>{const I=M.nextElementSibling.nextElementSibling;M.value==="0"?(I.classList.add("fn__none"),I.nextElementSibling.classList.add("fn__none")):(I.classList.remove("fn__none"),I.nextElementSibling.classList.remove("fn__none"))})});const T=E.element.querySelectorAll(".b3-text-field");v.type!=="select"&&v.type!=="mSelect"&&T.forEach(M=>{M.addEventListener("keydown",I=>{if(I.isComposing){I.preventDefault();return}I.key==="Enter"&&(E.close(),I.preventDefault())})}),$s(L,L.value,v.type),E.open({x:_.left,y:_.bottom}),T.length>0&&T[0].select()}),Af=e=>{const t=new Menu("av-add-filter");e.data.view.columns.forEach(a=>{let n;e.data.view.filters.find(o=>{if(o.column===a.id&&o.value.type===a.type)return n=o,!0}),!n&&a.type!=="mAsset"&&a.type!=="lineNumber"&&t.addItem({label:a.name,iconHTML:a.icon?unicode2Emoji(a.icon,"b3-menu__icon",!0):`<svg class="b3-menu__icon"><use xlink:href="#${getColIconByType(a.type)}"></use></svg>`,click:()=>{const o=genCellValue(a.type,a.type==="checkbox"?{checked:void 0}:"");n={column:a.id,operator:hl(a.type),value:o},e.data.view.filters.push(n),e.menuElement.innerHTML=hn(e.data.view),setPosition(e.menuElement,e.tabRect.right-e.menuElement.clientWidth,e.tabRect.bottom,e.tabRect.height);const i=e.menuElement.querySelector(`[data-id="${a.id}"] .b3-chip`);wl({filter:n,protyle:e.protyle,data:e.data,target:i,blockElement:e.blockElement})}})}),t.open({x:e.rect.left,y:e.rect.bottom,h:e.rect.height})},hn=e=>{let t="";const a=n=>{let o="";return e.columns.find(i=>{var s,l,r,c,d;if(i.id===n.column&&i.type===n.value.type){let u="";const g=i.type==="rollup"?((l=(s=n.value.rollup)==null?void 0:s.contents)==null?void 0:l.length)>0?n.value.rollup.contents[0]:{type:"rollup"}:n.value;if(n.operator==="Is empty")u=": "+window.siyuan.languages.filterOperatorIsEmpty;else if(n.operator==="Is not empty")u=": "+window.siyuan.languages.filterOperatorIsNotEmpty;else if(n.operator==="Is false")(g.type!=="checkbox"||typeof g.checkbox.checked=="boolean")&&(u=": "+window.siyuan.languages.unchecked);else if(n.operator==="Is true")(g.type!=="checkbox"||typeof g.checkbox.checked=="boolean")&&(u=": "+window.siyuan.languages.checked);else if(["created","updated","date"].includes(g.type)){let f="",p="";n.relativeDate?(f=`${window.siyuan.languages[["pastDate","current","nextDate"][n.relativeDate.direction+1]]}
 ${n.relativeDate.direction?n.relativeDate.count:""}
 ${window.siyuan.languages[["day","week","month","year"][n.relativeDate.unit]]}`,n.relativeDate2&&(p=`${window.siyuan.languages[["pastDate","current","nextDate"][n.relativeDate2.direction+1]]}
 ${n.relativeDate2.direction?n.relativeDate2.count:""}
 ${window.siyuan.languages[["day","week","month","year"][n.relativeDate2.unit]]}`)):g&&((r=g[g.type])!=null&&r.content)&&(f=dayjs(g[g.type].content).format("YYYY-MM-DD"),p=dayjs(g[g.type].content2).format("YYYY-MM-DD")),f&&(n.operator==="Is between"?u=` ${window.siyuan.languages.filterOperatorIsBetween} ${f} ${p}`:n.operator==="="?u=`: ${f}`:[">","<"].includes(n.operator)?u=` ${n.operator} ${f}`:n.operator===">="?u=` \u2265 ${f}`:n.operator==="<="&&(u=` \u2264 ${f}`))}else if(["mSelect","select"].includes(g.type)&&((c=g.mSelect)==null?void 0:c.length)>0){let f="";g.mSelect.forEach((p,m)=>{f+=p.content,m!==g.mSelect.length-1&&(f+=", ")}),n.operator==="Contains"?u=`: ${f}`:n.operator==="Does not contains"?u=` ${window.siyuan.languages.filterOperatorDoesNotContain} ${f}`:n.operator==="="?u=`: ${f}`:n.operator==="!="&&(u=` ${window.siyuan.languages.filterOperatorIsNot} ${f}`)}else if(g.type==="number"&&g.number&&g.number.isNotEmpty)["=","!=",">","<"].includes(n.operator)?u=` ${n.operator} ${g.number.content}`:n.operator===">="?u=` \u2265 ${g.number.content}`:n.operator==="<="&&(u=` \u2264 ${g.number.content}`);else if(["text","block","url","phone","email","relation","template"].includes(g.type)&&g[g.type]){const f=g[g.type].content||((d=g.relation)==null?void 0:d.blockIDs[0])||"";["=","Contains"].includes(n.operator)?u=`: ${f}`:n.operator==="Does not contains"?u=` ${window.siyuan.languages.filterOperatorDoesNotContain} ${f}`:n.operator==="!="?u=` ${window.siyuan.languages.filterOperatorIsNot} ${f}`:n.operator==="Starts with"?u=` ${window.siyuan.languages.filterOperatorStartsWith} ${f}`:n.operator==="Ends with"?u=` ${window.siyuan.languages.filterOperatorEndsWith} ${f}`:[">","<"].includes(n.operator)?u=` ${n.operator} ${f}`:n.operator===">="?u=` \u2265 ${f}`:n.operator==="<="&&(u=` \u2264 ${f}`)}return o+=`<span data-type="setFilter" class="b3-chip${u?" b3-chip--primary":""}">
    ${i.icon?unicode2Emoji(i.icon,"icon",!0):`<svg class="icon"><use xlink:href="#${getColIconByType(i.type)}"></use></svg>`}
    <span class="fn__ellipsis">${i.name}${u}</span>
</span>`,!0}}),o};return e.filters.forEach(n=>{const o=a(n);o&&(t+=`<button class="b3-menu__item" draggable="true" data-id="${n.column}" data-filter-type="${n.value.type}">
    <svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>
    <div class="fn__flex-1">${o}</div>
    <svg class="b3-menu__action" data-type="removeFilter"><use xlink:href="#iconTrashcan"></use></svg>
</button>`)}),`<div class="b3-menu__items">
<button class="b3-menu__item" data-type="nobg">
    <span class="block__icon" style="padding: 8px;margin-left: -4px;" data-type="go-config">
        <svg><use xlink:href="#iconLeft"></use></svg>
    </span>
    <span class="b3-menu__label ft__center">${window.siyuan.languages.filter}</span>
</button>
<button class="b3-menu__separator"></button>
${t}
<button class="b3-menu__item${e.filters.length===e.columns.length?" fn__none":""}" data-type="addFilter">
    <svg class="b3-menu__icon"><use xlink:href="#iconAdd"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.addFilter}</span>
</button>
<button class="b3-menu__item${t?"":" fn__none"}" data-type="removeFilters">
    <svg class="b3-menu__icon"><use xlink:href="#iconTrashcan"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.removeFilters}</span>
</button>
</div>`};var _l=(e,t,a)=>new Promise((n,o)=>{var i=r=>{try{l(a.next(r))}catch(c){o(c)}},s=r=>{try{l(a.throw(r))}catch(c){o(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(i,s);l((a=a.apply(e,t)).next())});const vl=e=>{let t;e.data.view.columns.find((o,i)=>{if(o.id===e.colId)return t=JSON.parse(JSON.stringify(o)),e.data.view.columns.splice(i+1,0,t),!0}),t.name=duplicateNameAddOne(t.name),t.id=Lute.NewNodeID();const a=dayjs().format("YYYYMMDDHHmmss"),n=e.blockElement.getAttribute("data-node-id");transaction(e.protyle,[{action:"duplicateAttrViewKey",keyID:e.colId,nextID:t.id,avID:e.data.id},{action:"doUpdateUpdated",id:n,data:a}],[{action:"removeAttrViewCol",id:t.id,avID:e.data.id},{action:"doUpdateUpdated",id:n,data:e.blockElement.getAttribute("updated")}]),Ee({blockElement:e.blockElement,protyle:e.protyle,type:t.type,name:t.name,icon:t.icon,previousID:e.colId,data:e.data,id:t.id}),e.blockElement.setAttribute("updated",a)},Ns=e=>{var t,a,n,o;let i;e.data.view.columns.find(l=>{if(l.id===e.colId)return i=l,!0});let s=`<button class="b3-menu__item" data-type="nobg" data-col-id="${e.colId}">
    <span class="block__icon${e.isCustomAttr?" fn__none":""}" style="padding: 8px;margin-left: -4px;" data-type="go-properties">
        <svg><use xlink:href="#iconLeft"></use></svg>
    </span>
    <span class="b3-menu__label ft__center">${window.siyuan.languages.edit}</span>
</button>
<button class="b3-menu__separator" data-id="separator_1"></button>
<button class="b3-menu__item" data-type="nobg">
    <div class="fn__block">
        <div class="fn__flex">
            <span class="b3-menu__avemoji" data-col-type="${i.type}" data-icon="${i.icon}" data-type="update-icon">${i.icon?unicode2Emoji(i.icon):`<svg style="width: 14px;height: 14px"><use xlink:href="#${nt(i.type)}"></use></svg>`}</span>
            <div class="b3-form__icona fn__block">
                <input data-type="name" class="b3-text-field b3-form__icona-input" type="text">
                <svg data-position="north" class="b3-form__icona-icon ariaLabel" aria-label="${i.desc?escapeAriaLabel(i.desc):window.siyuan.languages.addDesc}"><use xlink:href="#iconInfo"></use></svg>
            </div>
        </div>
        <div class="fn__none">
            <div class="fn__hr"></div>
            <textarea style="margin-left: 22px;width: calc(100% - 22px);" placeholder="${window.siyuan.languages.addDesc}" rows="1" data-type="desc" class="b3-text-field fn__size200" type="text" data-value="${escapeAttr(i.desc)}">${i.desc}</textarea>
        </div>
        <div class="fn__hr--small"></div>
    </div>
</button>
<button class="b3-menu__item" data-type="goUpdateColType" ${i.type==="block"?"disabled":""}>
    <span class="b3-menu__label">${window.siyuan.languages.type}</span>
    <span class="fn__space"></span>
    <svg class="b3-menu__icon"><use xlink:href="#${nt(i.type)}"></use></svg>
    <span class="b3-menu__accelerator" style="margin-left: 0">${va(i.type)}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>`;if(["mSelect","select"].includes(i.type))s+=`<button class="b3-menu__separator" data-id="separator_2"></button>
<button class="b3-menu__item" data-type="nobg">
    <svg class="b3-menu__icon"><use xlink:href="#iconAdd"></use></svg>
    <input data-type="addOption" class="b3-text-field fn__block" type="text" placeholder="${window.siyuan.languages.enterKey} ${window.siyuan.languages.addAttr}" style="margin: 4px 0">
</button>`,i.options||(i.options=[]),i.options.forEach(l=>{const r=l.desc?`${escapeAriaLabel(l.name)}<div class='ft__on-surface'>${escapeAriaLabel(l.desc||"")}</div>`:"";s+=`<button class="b3-menu__item${s?"":" b3-menu__item--current"}" draggable="true" data-name="${escapeAttr(l.name)}" data-desc="${escapeAttr(l.desc||"")}" data-color="${l.color}">
    <svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>
    <div class="fn__flex-1 ariaLabel" data-position="parentW" aria-label="${r}">
        <span class="b3-chip" style="background-color:var(--b3-font-background${l.color});color:var(--b3-font-color${l.color})">
            <span class="fn__ellipsis">${escapeHtml(l.name)}</span>
        </span>
    </div>
    <svg class="b3-menu__action" data-type="setColOption"><use xlink:href="#iconEdit"></use></svg>
</button>`});else if(i.type==="number")s+=`<button class="b3-menu__separator" data-id="separator_2"></button>
<button class="b3-menu__item" data-type="numberFormat" data-format="${i.numberFormat}">
    <svg class="b3-menu__icon"><use xlink:href="#iconFormat"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.format}</span>
    <span class="b3-menu__accelerator">${getLabelByNumberFormat(i.numberFormat)}</span>
</button>`;else if(i.type==="template")s+=`<button class="b3-menu__separator" data-id="separator_2"></button>
<button class="b3-menu__item" data-type="nobg">
    <textarea spellcheck="false" rows="${Math.min(i.template.split(`
`).length,8)}" placeholder="${window.siyuan.languages.template}" data-type="updateTemplate" style="margin: 4px 0" rows="1" class="fn__block b3-text-field">${i.template}</textarea>
</button>`;else if(i.type==="relation"){const l=((t=i.relation)==null?void 0:t.avID)===e.data.id;s+=`<button class="b3-menu__separator" data-id="separator_2"></button>
<button class="b3-menu__item" data-type="goSearchAV" data-av-id="${((a=i.relation)==null?void 0:a.avID)||""}" data-old-value='${JSON.stringify(i.relation||{})}'>
    <span class="b3-menu__label">${window.siyuan.languages.relatedTo}</span>
    <span class="b3-menu__accelerator">${l?window.siyuan.languages.thisDatabase:""}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<label class="b3-menu__item">
    <span class="fn__flex-center">${window.siyuan.languages.backRelation}</span>
    <svg class="b3-menu__icon b3-menu__icon--small fn__none"><use xlink:href="#iconHelp"></use></svg>
    <span class="fn__space fn__flex-1"></span>
    <input data-type="backRelation" type="checkbox" class="b3-switch b3-switch--menu" ${(n=i.relation)!=null&&n.isTwoWay?"checked":""}>
</label>
<div class="b3-menu__item fn__flex-column fn__none" data-type="nobg">
    <input data-old-value="" data-type="colName" style="margin: 8px 0 4px" class="b3-text-field fn__block" placeholder="${e.data.name} ${i.name}">
</div>
<div class="b3-menu__item fn__flex-column fn__none" data-type="nobg">
    <button style="margin: 4px 0 8px;" class="b3-button fn__block" data-type="updateRelation">${window.siyuan.languages.confirm}</button>
</div>`}else i.type==="rollup"?s+='<button class="b3-menu__separator" data-id="separator_2"></button>'+getRollupHTML({colData:i}):i.type==="date"&&(s+=`<button class="b3-menu__separator" data-id="separator_2"></button>
<label class="b3-menu__item">
    <span class="fn__flex-center">${window.siyuan.languages.fillCreated}</span>
    <span class="fn__space fn__flex-1"></span>
    <input data-type="fillCreated" type="checkbox" class="b3-switch b3-switch--menu" ${(o=i.date)!=null&&o.autoFillNow?"checked":""}>
</label>`);return i.type!=="block"&&(s+=`<button class="b3-menu__separator" data-id="separator_3"></button>
<button class="b3-menu__item" data-type="${i.hidden?"showCol":"hideCol"}">
    <svg class="b3-menu__icon" style=""><use xlink:href="#icon${i.hidden?"Eye":"Eyeoff"}"></use></svg>
    <span class="b3-menu__label">${i.hidden?window.siyuan.languages.showCol:window.siyuan.languages.hideCol}</span>
</button>
<button class="b3-menu__item${i.type==="relation"?" fn__none":""}" data-type="duplicateCol">
    <svg class="b3-menu__icon" style=""><use xlink:href="#iconCopy"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.duplicate}</span>
</button>
<button class="b3-menu__item" data-type="removeCol">
    <svg class="b3-menu__icon" style=""><use xlink:href="#iconTrashcan"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.delete}</span>
</button>`),`<div class="b3-menu__items">
    ${s}
    <button class="b3-menu__separator" data-id="separator_4"></button>
    <label class="b3-menu__item" data-type="wrap">
        <span class="fn__flex-center">${window.siyuan.languages.wrap}</span>
        <span class="fn__space fn__flex-1"></span>
        <input data-type="wrap" type="checkbox" class="b3-switch b3-switch--menu" ${i.wrap?" checked":""}>
    </label>
</div>
<div class="b3-menu__items fn__none">
    <button class="b3-menu__item" data-type="nobg" data-col-id="${i.id}">
        <span class="block__icon" style="padding: 8px;margin-left: -4px;" data-type="goEditCol">
            <svg><use xlink:href="#iconLeft"></use></svg>
        </span>
        <span class="b3-menu__label ft__center">${window.siyuan.languages.edit}</span>
    </button>
    <button class="b3-menu__separator"></button>
    ${Ce("text",i.type)}
    ${Ce("number",i.type)}
    ${Ce("select",i.type)}
    ${Ce("mSelect",i.type)}
    ${Ce("date",i.type)}
    ${Ce("mAsset",i.type)}
    ${Ce("checkbox",i.type)}
    ${Ce("url",i.type)}
    ${Ce("email",i.type)}
    ${Ce("phone",i.type)}
    ${Ce("template",i.type)}
    ${Ce("relation",i.type)}
    ${Ce("rollup",i.type)}
    ${Ce("lineNumber",i.type)}
    ${Ce("created",i.type)}
    ${Ce("updated",i.type)}
</div>`},Bs=e=>{const t=e.data.id,a=e.menuElement.querySelector(".b3-menu__item").getAttribute("data-col-id"),n=e.data.view.columns.find(u=>u.id===a),o=e.menuElement.querySelector('[data-type="name"]');o.addEventListener("blur",()=>{const u=o.value;u!==n.name&&(transaction(e.protyle,[{action:"updateAttrViewCol",id:a,avID:t,name:u,type:n.type}],[{action:"updateAttrViewCol",id:a,avID:t,name:n.name,type:n.type}]),n.name=u,updateAttrViewCellAnimation(e.protyle.wysiwyg.element.querySelector(`.av__row--header .av__cell[data-col-id="${a}"]`),void 0,{name:u}))}),o.addEventListener("keydown",u=>{u.isComposing||(u.key==="Escape"?e.menuElement.parentElement.remove():u.key==="Enter"&&(o.dispatchEvent(new CustomEvent("blur")),e.menuElement.parentElement.remove()))}),o.addEventListener("keyup",u=>{if(u.isComposing)return;const g=e.menuElement.querySelector('[data-type="colName"]');g&&g.setAttribute("placeholder",`${e.data.name} ${o.value}`)}),o.select(),o.value=n.name;const i=e.menuElement.querySelector('.b3-text-field[data-type="desc"]');o.nextElementSibling.addEventListener("click",()=>{const u=i.parentElement;u.classList.toggle("fn__none"),u.classList.contains("fn__none")||i.focus()}),i.addEventListener("blur",()=>{const u=i.value;u!==n.desc&&(transaction(e.protyle,[{action:"setAttrViewColDesc",id:a,avID:t,data:u}],[{action:"setAttrViewColDesc",id:a,avID:t,data:n.desc}]),n.desc=u)}),i.addEventListener("keydown",u=>{u.isComposing||(u.key==="Escape"?e.menuElement.parentElement.remove():u.key==="Enter"&&(i.dispatchEvent(new CustomEvent("blur")),e.menuElement.parentElement.remove()))}),i.addEventListener("input",()=>{o.nextElementSibling.setAttribute("aria-label",i.value?escapeHtml(i.value):window.siyuan.languages.addDesc)});const s=e.menuElement.querySelector('[data-type="updateTemplate"]');s&&(s.addEventListener("blur",()=>{const u=s.value;u!==n.template&&(transaction(e.protyle,[{action:"updateAttrViewColTemplate",id:a,avID:t,data:u,type:n.type}],[{action:"updateAttrViewColTemplate",id:a,avID:t,data:n.template,type:n.type}]),n.template=u)}),s.addEventListener("keydown",u=>{u.isComposing||(u.key==="Escape"?e.menuElement.parentElement.remove():u.key==="Enter"&&!u.shiftKey&&(s.dispatchEvent(new CustomEvent("blur")),e.menuElement.parentElement.remove()))}));const l=e.menuElement.querySelector('.b3-switch[data-type="wrap"]');l&&l.addEventListener("change",()=>{transaction(e.protyle,[{action:"setAttrViewColWrap",id:a,avID:t,data:l.checked,blockID:e.blockID}],[{action:"setAttrViewColWrap",id:a,avID:t,data:!l.checked,blockID:e.blockID}])});const r=e.menuElement.querySelector('[data-type="addOption"]');r&&r.addEventListener("keydown",u=>{if(!u.isComposing&&(u.key==="Escape"&&e.menuElement.parentElement.remove(),u.key==="Enter")){let g=!1;if(n.options.find(f=>{if(r.value===f.name)return g=!0,!0}),g||!r.value)return;n.options.push({color:((n.options.length||0)%14+1).toString(),name:r.value}),transaction(e.protyle,[{action:"updateAttrViewColOptions",id:a,avID:t,data:n.options}],[{action:"removeAttrViewColOption",id:a,avID:t,data:r.value}]),e.menuElement.innerHTML=Ns({protyle:e.protyle,colId:a,data:e.data,isCustomAttr:e.isCustomAttr}),Bs({protyle:e.protyle,menuElement:e.menuElement,data:e.data,isCustomAttr:e.isCustomAttr,blockID:e.blockID}),e.menuElement.querySelector('[data-type="addOption"]').focus()}});const c=e.menuElement.querySelector('[data-type="fillCreated"]');c&&c.addEventListener("change",()=>{transaction(e.protyle,[{avID:t,action:"setAttrViewColDate",id:a,data:c.checked}],[{avID:t,action:"setAttrViewColDate",id:a,data:!c.checked}])});const d=e.menuElement.querySelector('[data-type="backRelation"]');if(d){d.addEventListener("change",()=>{toggleUpdateRelationBtn(e.menuElement,t)});const u=e.menuElement.querySelector('[data-type="goSearchAV"]'),g=JSON.parse(u.getAttribute("data-old-value")),f=e.menuElement.querySelector('[data-type="colName"]');f.addEventListener("input",()=>{toggleUpdateRelationBtn(e.menuElement,t)}),g.avID?fetchPost("/api/av/getAttributeView",{id:g.avID},p=>{u.querySelector(".b3-menu__accelerator").textContent=g.avID===t?window.siyuan.languages.thisDatabase:p.data.av.name||window.siyuan.languages.title,p.data.av.keyValues.find(m=>{if(m.key.id===g.backKeyID)return f.setAttribute("data-old-value",m.key.name||window.siyuan.languages.title),f.value=m.key.name||window.siyuan.languages.title,!0}),toggleUpdateRelationBtn(e.menuElement,t)}):toggleUpdateRelationBtn(e.menuElement,t)}bindRollupData(e)},va=e=>{switch(e){case"text":case"number":case"select":case"date":case"phone":case"email":case"template":return window.siyuan.languages[e];case"mSelect":return window.siyuan.languages.multiSelect;case"relation":return window.siyuan.languages.relation;case"rollup":return window.siyuan.languages.rollup;case"updated":return window.siyuan.languages.updatedTime;case"created":return window.siyuan.languages.createdTime;case"url":return window.siyuan.languages.link;case"mAsset":return window.siyuan.languages.assets;case"checkbox":return window.siyuan.languages.checkbox;case"block":return window.siyuan.languages._attrView.key;case"lineNumber":return window.siyuan.languages.lineNumber}},nt=e=>{switch(e){case"text":return"iconAlignLeft";case"block":return"iconKey";case"number":return"iconNumber";case"select":return"iconListItem";case"mSelect":return"iconList";case"relation":return"iconOpen";case"rollup":return"iconSearch";case"date":return"iconCalendar";case"updated":case"created":return"iconClock";case"url":return"iconLink";case"mAsset":return"iconImage";case"email":return"iconEmail";case"phone":return"iconPhone";case"template":return"iconMath";case"checkbox":return"iconCheck";case"lineNumber":return"iconOrderedList"}},Ee=e=>{if(!e.blockElement)return;const t=e.blockElement.getAttribute("data-node-id");e.blockElement.classList.contains("av")?e.blockElement.querySelectorAll(".av__row").forEach((n,o)=>{let i;e.previousID?i=n.querySelector(`[data-col-id="${e.previousID}"]`):i=n.lastElementChild.previousElementSibling;let s="";o===0?s=`<div class="av__cell av__cell--header" draggable="true" data-icon="${e.icon||""}" data-col-id="${e.id}" data-dtype="${e.type}" data-wrap="false" style="width: 200px;">
    ${e.icon?unicode2Emoji(e.icon,"av__cellheadericon",!0):`<svg class="av__cellheadericon"><use xlink:href="#${nt(e.type)}"></use></svg>`}
    <span class="av__celltext fn__flex-1">${e.name}</span>
    <div class="av__widthdrag av__pulse"></div>
</div>`:s='<div class="av__cell" style="width: 200px"><span class="av__pulse"></span></div>',i.insertAdjacentHTML("afterend",s)}):e.blockElement.querySelector(".fn__hr").insertAdjacentHTML("beforebegin",`<div class="block__icons av__row" data-id="${t}" data-col-id="${e.id}">
    <div class="block__icon" draggable="true"><svg><use xlink:href="#iconDrag"></use></svg></div>
    <div class="block__logo ariaLabel fn__pointer" data-type="editCol" data-position="parentW" aria-label="${va(e.type)}">
        <svg class="block__logoicon"><use xlink:href="#${nt(e.type)}"></use></svg>
        <span>${va(e.type)}</span>
    </div>
    <div data-col-id="${e.id}" data-block-id="${t}" data-type="${e.type}" data-options="[]" class="fn__flex-1 fn__flex">
        <div class="fn__flex-1"></div>
    </div>
</div>`);const a=document.querySelector(".av__panel .b3-menu");if(a&&e.data&&e.blockElement.classList.contains("av")){a.innerHTML=Ns({protyle:e.protyle,data:e.data,colId:e.id,isCustomAttr:!1}),Bs({protyle:e.protyle,data:e.data,menuElement:a,isCustomAttr:!1,blockID:t});const n=e.blockElement.querySelector(".av__views").getBoundingClientRect();n&&setPosition(a,n.right-a.clientWidth,n.bottom,n.height);return}openMenuPanel({protyle:e.protyle,blockElement:e.blockElement,type:"edit",colId:e.id,editData:{previousID:e.previousID,colData:El(e.type,e.id,e.name)}}),window.siyuan.menus.menu.remove()},Lf=(e,t,a)=>{const n=a.getAttribute("data-dtype"),o=a.getAttribute("data-col-id"),i=t.getAttribute("data-av-id"),s=t.getAttribute("data-node-id"),l=a.querySelector(".av__celltext").textContent.trim(),r=a.dataset.desc,c=new Menu("av-header-cell",()=>{const f=c.element.querySelector(".b3-text-field").value;f!==l&&(transaction(e,[{action:"updateAttrViewCol",id:o,avID:i,name:f,type:n}],[{action:"updateAttrViewCol",id:o,avID:i,name:l,type:n}]),updateAttrViewCellAnimation(t.querySelector(`.av__row--header .av__cell[data-col-id="${o}"]`),void 0,{name:f}));const p=c.element.querySelector("textarea").value;p!==r&&transaction(e,[{action:"setAttrViewColDesc",id:o,avID:i,data:p}],[{action:"setAttrViewColDesc",id:o,avID:i,data:r}]),focusBlock(t)});c.addItem({iconHTML:"",type:"empty",label:`<div class="fn__hr"></div><div class="fn__flex">
    <span class="b3-menu__avemoji">${a.dataset.icon?unicode2Emoji(a.dataset.icon):`<svg style="height: 14px;width: 14px;"><use xlink:href="#${nt(n)}"></use></svg>`}</span>
    <div class="b3-form__icona fn__block">
        <input class="b3-text-field b3-form__icona-input" type="text">
        <svg data-position="north" class="b3-form__icona-icon ariaLabel" aria-label="${r?escapeAriaLabel(r):window.siyuan.languages.addDesc}"><use xlink:href="#iconInfo"></use></svg>
    </div>
</div>
<div class="fn__none">
    <div class="fn__hr"></div>
    <textarea style="margin-left: 22px;width: calc(100% - 22px);" placeholder="${window.siyuan.languages.addDesc}" rows="1" class="b3-text-field fn__size200" type="text" data-value="${escapeAttr(r)}">${r}</textarea>
</div>
<div class="fn__hr--small"></div>`,bind(f){const p=f.querySelector(".b3-menu__avemoji");p.addEventListener("click",w=>{const y=p.getBoundingClientRect();openEmojiPanel("","av",{x:y.left,y:y.bottom+4,h:y.height,w:y.width},_=>{transaction(e,[{action:"setAttrViewColIcon",id:o,avID:i,data:_}],[{action:"setAttrViewColIcon",id:o,avID:i,data:a.dataset.icon}]),p.innerHTML=_?unicode2Emoji(_):`<svg style="height: 14px;width: 14px"><use xlink:href="#${nt(n)}"></use></svg>`,updateAttrViewCellAnimation(t.querySelector(`.av__row--header .av__cell[data-col-id="${o}"]`),void 0,{icon:_})},p.querySelector("img")),w.preventDefault(),w.stopPropagation()});const m=f.querySelector("input");m.value=l,m.addEventListener("keydown",w=>{w.isComposing||w.key==="Enter"&&(c.close(),w.preventDefault())});const b=f.querySelector("textarea");m.nextElementSibling.addEventListener("click",()=>{const w=b.parentElement;w.classList.toggle("fn__none"),w.classList.contains("fn__none")||b.focus()}),b.addEventListener("keydown",w=>{w.isComposing||w.key==="Enter"&&(c.close(),w.preventDefault())}),b.addEventListener("input",()=>{m.nextElementSibling.setAttribute("aria-label",b.value?escapeHtml(b.value):window.siyuan.languages.addDesc)})}}),c.addItem({id:"edit",icon:"iconEdit",label:window.siyuan.languages.edit,click(){const f=c.element.querySelector(".b3-text-field").value;openMenuPanel({protyle:e,blockElement:t,type:"edit",colId:o,cb(p){const m=p.querySelector('.b3-text-field[data-type="name"]');m.value=f,m.select()}})}}),c.addSeparator({id:"separator_1"}),n!=="lineNumber"&&(c.addItem({id:"asc",icon:"iconUp",label:window.siyuan.languages.asc,click(){fetchPost("/api/av/renderAttributeView",{id:i},f=>{transaction(e,[{action:"setAttrViewSorts",avID:f.data.id,data:[{column:o,order:"ASC"}],blockID:s}],[{action:"setAttrViewSorts",avID:f.data.id,data:f.data.view.sorts,blockID:s}])})}}),c.addItem({id:"desc",icon:"iconDown",label:window.siyuan.languages.desc,click(){fetchPost("/api/av/renderAttributeView",{id:i},f=>{transaction(e,[{action:"setAttrViewSorts",avID:f.data.id,data:[{column:o,order:"DESC"}],blockID:s}],[{action:"setAttrViewSorts",avID:f.data.id,data:f.data.view.sorts,blockID:s}])})}}),n!=="mAsset"&&c.addItem({id:"filter",icon:"iconFilter",label:window.siyuan.languages.filter,click(){fetchPost("/api/av/renderAttributeView",{id:i},f=>{const p=f.data;let m;p.view.filters.find(b=>{if(b.column===o&&b.value.type===n)return m=b,!0}),m||(m={column:o,operator:getDefaultOperatorByType(n),value:genCellValue(n,"")},p.view.filters.push(m)),setFilter({filter:m,protyle:e,data:p,blockElement:t,target:t.querySelector(`.av__row--header .av__cell[data-col-id="${o}"]`)})})}}),c.addSeparator({id:"separator_2"})),c.addItem({id:"insertColumnLeft",icon:"iconInsertLeft",label:window.siyuan.languages.insertColumnLeft,click(){var f;const p=Ps(e,t,((f=a.previousElementSibling)==null?void 0:f.getAttribute("data-col-id"))||"");t.contains(a)||(a=t.querySelector(`.av__row--header .av__cell--header[data-col-id="${o}"]`));const m=a.getBoundingClientRect();p.open({x:m.left,y:m.bottom,h:m.height})}}),c.addItem({id:"insertColumnRight",icon:"iconInsertRight",label:window.siyuan.languages.insertColumnRight,click(){const f=Ps(e,t,o);t.contains(a)||(a=t.querySelector(`.av__row--header .av__cell--header[data-col-id="${o}"]`));const p=a.getBoundingClientRect();f.open({x:p.left,y:p.bottom,h:p.height})}}),n!=="block"&&c.addItem({id:"hide",icon:"iconEyeoff",label:window.siyuan.languages.hide,click(){transaction(e,[{action:"setAttrViewColHidden",id:o,avID:i,data:!0,blockID:s}],[{action:"setAttrViewColHidden",id:o,avID:i,data:!1,blockID:s}])}});const d=a.dataset.pin==="true";if(c.addItem({id:d?"unfreezeCol":"freezeCol",icon:d?"iconUnpin":"iconPin",label:d?window.siyuan.languages.unfreezeCol:window.siyuan.languages.freezeCol,click(){transaction(e,[{action:"setAttrViewColPin",id:o,avID:i,data:!d,blockID:s}],[{action:"setAttrViewColPin",id:o,avID:i,data:d,blockID:s}]),updateAttrViewCellAnimation(t.querySelector(`.av__row--header .av__cell[data-col-id="${o}"]`),void 0,{pin:!d})}}),n!=="block"){let f;n!=="relation"&&c.addItem({id:"duplicate",icon:"iconCopy",label:window.siyuan.languages.duplicate,click(){fetchPost("/api/av/renderAttributeView",{id:i},p=>{vl({blockElement:t,viewID:t.getAttribute(Constants.CUSTOM_SY_AV_VIEW),protyle:e,colId:o,data:p.data})})}}),c.addItem({id:"delete",icon:"iconTrashcan",label:window.siyuan.languages.delete,click(){return _l(this,null,function*(){var p;if(n==="relation"){const b=(yield fetchSyncPost("/api/av/getAttributeView",{id:i})).data.av.keyValues.find(w=>w.key.id===o);if((p=b.key.relation)!=null&&p.isTwoWay){const w=yield fetchSyncPost("/api/av/getAttributeView",{id:b.key.relation.avID}),y=new Dialog({title:window.siyuan.languages.removeCol.replace("${x}",b.key.name),content:`<div class="b3-dialog__content">
    ${window.siyuan.languages.confirmRemoveRelationField.replace("${x}",w.data.av.name)}
    <div class="fn__hr--b"></div>
    <button class="fn__block b3-button b3-button--remove" data-action="delete">${window.siyuan.languages.delete}</button>
    <div class="fn__hr"></div>
    <button class="fn__block b3-button b3-button--remove" data-action="keep-relation">${window.siyuan.languages.removeButKeepRelationField}</button>
    <div class="fn__hr"></div>
    <button class="fn__block b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button>
</div>`});y.element.addEventListener("click",_=>{let h=_.target;const E=typeof _.detail=="string";for(;h&&!h.isSameNode(y.element)||E;){const C=h.getAttribute("data-action");if(C==="delete"||E&&_.detail==="Enter"){wn({protyle:e,colId:o,avID:i,blockID:s,oldValue:l,type:n,cellElement:a,blockElement:t,removeDest:!0}),y.destroy();break}else if(C==="keep-relation"){wn({protyle:e,colId:o,avID:i,blockID:s,oldValue:l,type:n,cellElement:a,blockElement:t,removeDest:!1}),y.destroy();break}else if(h.classList.contains("b3-button--cancel")||E&&_.detail==="Escape"){y.destroy();break}h=h.parentElement}}),y.element.querySelector("button").focus(),y.element.setAttribute("data-key",Constants.DIALOG_CONFIRM);return}}wn({protyle:e,colId:o,avID:i,blockID:s,oldValue:l,type:n,cellElement:a,blockElement:t,removeDest:!1})})}}),c.addSeparator({id:"separator_3"})}c.addItem({id:"wrap",label:`<label class="fn__flex"><span class="fn__flex-center">${window.siyuan.languages.wrap}</span><span class="fn__space fn__flex-1"></span>
<input type="checkbox" class="b3-switch b3-switch--menu"${a.dataset.wrap==="true"?" checked":""}></label>`,bind(f){const p=f.querySelector("input");p.addEventListener("change",()=>{transaction(e,[{action:"setAttrViewColWrap",id:o,avID:i,data:p.checked,blockID:s}],[{action:"setAttrViewColWrap",id:o,avID:i,data:!p.checked,blockID:s}])})}});const u=a.getBoundingClientRect();c.open({x:u.left,y:u.bottom,h:u.height});const g=window.siyuan.menus.menu.element.querySelector(".b3-text-field");g&&(g.select(),g.focus())},wn=e=>{var t;const a=dayjs().format("YYYYMMDDHHmmss");transaction(e.protyle,[{action:"removeAttrViewCol",id:e.colId,avID:e.avID,removeDest:e.removeDest},{action:"doUpdateUpdated",id:e.blockID,data:a}],[{action:"addAttrViewCol",name:e.oldValue,avID:e.avID,type:e.type,id:e.colId,previousID:((t=e.cellElement.previousElementSibling)==null?void 0:t.getAttribute("data-col-id"))||""},{action:"doUpdateUpdated",id:e.blockID,data:e.blockElement.getAttribute("updated")}]),removeAttrViewColAnimation(e.blockElement,e.colId),e.blockElement.setAttribute("updated",a)},Sf=e=>{const t=e.menuElement.querySelector(".b3-menu__item").getAttribute("data-col-id");let a="";const n=e.data.view.columns.find((i,s)=>{var l;if(i.id===t)return a=(l=e.data.view.columns[s-1])==null?void 0:l.id,e.data.view.columns.splice(s,1),!0}),o=dayjs().format("YYYYMMDDHHmmss");transaction(e.protyle,[{action:"removeAttrViewCol",id:t,avID:e.avID,removeDest:e.isTwoWay},{action:"doUpdateUpdated",id:e.blockID,data:o}],[{action:"addAttrViewCol",name:n.name,avID:e.avID,type:n.type,id:t,previousID:a},{action:"doUpdateUpdated",id:e.blockID,data:e.blockElement.getAttribute("updated")}]),removeAttrViewColAnimation(e.blockElement,t),e.blockElement.setAttribute("updated",o),e.isCustomAttr?e.avPanelElement.remove():(e.menuElement.innerHTML=getPropertiesHTML(e.data.view),setPosition(e.menuElement,e.tabRect.right-e.menuElement.clientWidth,e.tabRect.bottom,e.tabRect.height))},Ce=(e,t)=>`<button class="b3-menu__item" data-type="updateColType" data-old-type="${t}" data-new-type="${e}">
    <svg class="b3-menu__icon"><use xlink:href="#${nt(e)}"></use></svg>
    <span class="b3-menu__label">${va(e)}</span>
    ${e===t?'<svg class="b3-menu__checked"><use xlink:href="#iconSelect"></use></svg></span>':""}
</button>`,Ps=(e,t,a)=>{const n=new Menu("av-header-add"),o=t.getAttribute("data-av-id");typeof a=="undefined"&&(a=Array.from(t.querySelectorAll(".av__row--header .av__cell")).pop().getAttribute("data-col-id"));const i=t.getAttribute("data-node-id");return n.addItem({id:"text",icon:"iconAlignLeft",label:window.siyuan.languages.text,click(){const s=Lute.NewNodeID(),l=dayjs().format("YYYYMMDDHHmmss");transaction(e,[{action:"addAttrViewCol",name:window.siyuan.languages.text,avID:o,type:"text",id:s,previousID:a},{action:"doUpdateUpdated",id:i,data:l}],[{action:"removeAttrViewCol",id:s,avID:o},{action:"doUpdateUpdated",id:i,data:t.getAttribute("updated")}]),Ee({blockElement:t,protyle:e,type:"text",name:window.siyuan.languages.text,id:s,previousID:a}),t.setAttribute("updated",l)}}),n.addItem({id:"number",icon:"iconNumber",label:window.siyuan.languages.number,click(){const s=Lute.NewNodeID(),l=dayjs().format("YYYYMMDDHHmmss");transaction(e,[{action:"addAttrViewCol",name:window.siyuan.languages.number,avID:o,type:"number",id:s,previousID:a},{action:"doUpdateUpdated",id:i,data:l}],[{action:"removeAttrViewCol",id:s,avID:o},{action:"doUpdateUpdated",id:i,data:t.getAttribute("updated")}]),Ee({blockElement:t,protyle:e,type:"number",name:window.siyuan.languages.number,id:s,previousID:a}),t.setAttribute("updated",l)}}),n.addItem({id:"select",icon:"iconListItem",label:window.siyuan.languages.select,click(){const s=Lute.NewNodeID(),l=dayjs().format("YYYYMMDDHHmmss");transaction(e,[{action:"addAttrViewCol",name:window.siyuan.languages.select,avID:o,type:"select",id:s,previousID:a},{action:"doUpdateUpdated",id:i,data:l}],[{action:"removeAttrViewCol",id:s,avID:o},{action:"doUpdateUpdated",id:i,data:t.getAttribute("updated")}]),Ee({blockElement:t,protyle:e,type:"select",name:window.siyuan.languages.select,id:s,previousID:a}),t.setAttribute("updated",l)}}),n.addItem({id:"multiSelect",icon:"iconList",label:window.siyuan.languages.multiSelect,click(){const s=Lute.NewNodeID(),l=dayjs().format("YYYYMMDDHHmmss");transaction(e,[{action:"addAttrViewCol",name:window.siyuan.languages.multiSelect,avID:o,type:"mSelect",id:s,previousID:a},{action:"doUpdateUpdated",id:i,data:l}],[{action:"removeAttrViewCol",id:s,avID:o},{action:"doUpdateUpdated",id:i,data:t.getAttribute("updated")}]),Ee({blockElement:t,protyle:e,type:"mSelect",name:window.siyuan.languages.multiSelect,id:s,previousID:a}),t.setAttribute("updated",l)}}),n.addItem({id:"date",icon:"iconCalendar",label:window.siyuan.languages.date,click(){const s=Lute.NewNodeID(),l=dayjs().format("YYYYMMDDHHmmss");transaction(e,[{action:"addAttrViewCol",name:window.siyuan.languages.date,avID:o,type:"date",id:s,previousID:a},{action:"doUpdateUpdated",id:i,data:l}],[{action:"removeAttrViewCol",id:s,avID:o},{action:"doUpdateUpdated",id:i,data:t.getAttribute("updated")}]),Ee({blockElement:t,protyle:e,type:"date",name:window.siyuan.languages.date,id:s,previousID:a}),t.setAttribute("updated",l)}}),n.addItem({id:"assets",icon:"iconImage",label:window.siyuan.languages.assets,click(){const s=Lute.NewNodeID(),l=dayjs().format("YYYYMMDDHHmmss");transaction(e,[{action:"addAttrViewCol",name:window.siyuan.languages.assets,avID:o,type:"mAsset",id:s,previousID:a},{action:"doUpdateUpdated",id:i,data:l}],[{action:"removeAttrViewCol",id:s,avID:o},{action:"doUpdateUpdated",id:i,data:t.getAttribute("updated")}]),Ee({blockElement:t,protyle:e,type:"mAsset",name:window.siyuan.languages.assets,id:s,previousID:a}),t.setAttribute("updated",l)}}),n.addItem({id:"checkbox",icon:"iconCheck",label:window.siyuan.languages.checkbox,click(){const s=Lute.NewNodeID(),l=dayjs().format("YYYYMMDDHHmmss");transaction(e,[{action:"addAttrViewCol",name:window.siyuan.languages.checkbox,avID:o,type:"checkbox",id:s,previousID:a},{action:"doUpdateUpdated",id:i,data:l}],[{action:"removeAttrViewCol",id:s,avID:o},{action:"doUpdateUpdated",id:i,data:t.getAttribute("updated")}]),Ee({blockElement:t,protyle:e,type:"checkbox",name:window.siyuan.languages.checkbox,id:s,previousID:a}),t.setAttribute("updated",l)}}),n.addItem({id:"link",icon:"iconLink",label:window.siyuan.languages.link,click(){const s=Lute.NewNodeID(),l=dayjs().format("YYYYMMDDHHmmss");transaction(e,[{action:"addAttrViewCol",name:window.siyuan.languages.link,avID:o,type:"url",id:s,previousID:a},{action:"doUpdateUpdated",id:i,data:l}],[{action:"removeAttrViewCol",id:s,avID:o},{action:"doUpdateUpdated",id:i,data:t.getAttribute("updated")}]),Ee({blockElement:t,protyle:e,type:"url",name:window.siyuan.languages.link,id:s,previousID:a}),t.setAttribute("updated",l)}}),n.addItem({id:"email",icon:"iconEmail",label:window.siyuan.languages.email,click(){const s=Lute.NewNodeID(),l=dayjs().format("YYYYMMDDHHmmss");transaction(e,[{action:"addAttrViewCol",name:window.siyuan.languages.email,avID:o,type:"email",id:s,previousID:a},{action:"doUpdateUpdated",id:i,data:l}],[{action:"removeAttrViewCol",id:s,avID:o},{action:"doUpdateUpdated",id:i,data:t.getAttribute("updated")}]),Ee({blockElement:t,protyle:e,type:"email",name:window.siyuan.languages.email,id:s,previousID:a}),t.setAttribute("updated",l)}}),n.addItem({id:"phone",icon:"iconPhone",label:window.siyuan.languages.phone,click(){const s=Lute.NewNodeID(),l=dayjs().format("YYYYMMDDHHmmss");transaction(e,[{action:"addAttrViewCol",name:window.siyuan.languages.phone,avID:o,type:"phone",id:s,previousID:a},{action:"doUpdateUpdated",id:i,data:l}],[{action:"removeAttrViewCol",id:s,avID:o},{action:"doUpdateUpdated",id:i,data:t.getAttribute("updated")}]),Ee({blockElement:t,protyle:e,type:"phone",name:window.siyuan.languages.phone,id:s,previousID:a}),t.setAttribute("updated",l)}}),n.addItem({id:"template",icon:"iconMath",label:window.siyuan.languages.template,click(){const s=Lute.NewNodeID(),l=dayjs().format("YYYYMMDDHHmmss");transaction(e,[{action:"addAttrViewCol",name:window.siyuan.languages.template,avID:o,type:"template",id:s,previousID:a},{action:"doUpdateUpdated",id:i,data:l}],[{action:"removeAttrViewCol",id:s,avID:o},{action:"doUpdateUpdated",id:i,data:t.getAttribute("updated")}]),Ee({blockElement:t,protyle:e,type:"template",name:window.siyuan.languages.template,id:s,previousID:a}),t.setAttribute("updated",l)}}),n.addItem({id:"relation",icon:"iconOpen",label:window.siyuan.languages.relation,click(){const s=Lute.NewNodeID(),l=dayjs().format("YYYYMMDDHHmmss");transaction(e,[{action:"addAttrViewCol",name:window.siyuan.languages.relation,avID:o,type:"relation",id:s,previousID:a},{action:"doUpdateUpdated",id:i,data:l}],[{action:"removeAttrViewCol",id:s,avID:o},{action:"doUpdateUpdated",id:i,data:t.getAttribute("updated")}]),Ee({blockElement:t,protyle:e,type:"relation",name:window.siyuan.languages.relation,id:s,previousID:a}),t.setAttribute("updated",l)}}),n.addItem({id:"rollup",icon:"iconSearch",label:window.siyuan.languages.rollup,click(){const s=Lute.NewNodeID(),l=dayjs().format("YYYYMMDDHHmmss");transaction(e,[{action:"addAttrViewCol",name:window.siyuan.languages.rollup,avID:o,type:"rollup",id:s,previousID:a},{action:"doUpdateUpdated",id:i,data:l}],[{action:"removeAttrViewCol",id:s,avID:o},{action:"doUpdateUpdated",id:i,data:t.getAttribute("updated")}]),Ee({blockElement:t,protyle:e,type:"rollup",name:window.siyuan.languages.rollup,id:s,previousID:a}),t.setAttribute("updated",l)}}),n.addItem({id:"lineNumber",icon:"iconOrderedList",label:window.siyuan.languages.lineNumber,click(){const s=Lute.NewNodeID(),l=dayjs().format("YYYYMMDDHHmmss");transaction(e,[{action:"addAttrViewCol",name:window.siyuan.languages.lineNumber,avID:o,type:"lineNumber",id:s,previousID:a},{action:"doUpdateUpdated",id:i,data:l}],[{action:"removeAttrViewCol",id:s,avID:o},{action:"doUpdateUpdated",id:i,data:t.getAttribute("updated")}]),Ee({blockElement:t,protyle:e,type:"lineNumber",name:window.siyuan.languages.lineNumber,id:s,previousID:a}),t.setAttribute("updated",l)}}),n.addItem({id:"createdTime",icon:"iconClock",label:window.siyuan.languages.createdTime,click(){const s=Lute.NewNodeID(),l=dayjs().format("YYYYMMDDHHmmss");transaction(e,[{action:"addAttrViewCol",name:window.siyuan.languages.createdTime,avID:o,type:"created",id:s,previousID:a},{action:"doUpdateUpdated",id:i,data:l}],[{action:"removeAttrViewCol",id:s,avID:o},{action:"doUpdateUpdated",id:i,data:t.getAttribute("updated")}]),Ee({blockElement:t,protyle:e,type:"created",name:window.siyuan.languages.createdTime,id:s,previousID:a}),t.setAttribute("updated",l)}}),n.addItem({id:"updatedTime",icon:"iconClock",label:window.siyuan.languages.updatedTime,click(){const s=Lute.NewNodeID(),l=dayjs().format("YYYYMMDDHHmmss");transaction(e,[{action:"addAttrViewCol",name:window.siyuan.languages.updatedTime,avID:o,type:"updated",id:s,previousID:a},{action:"doUpdateUpdated",id:i,data:l}],[{action:"removeAttrViewCol",id:s,avID:o},{action:"doUpdateUpdated",id:i,data:t.getAttribute("updated")}]),Ee({blockElement:t,protyle:e,type:"updated",name:window.siyuan.languages.updatedTime,id:s,previousID:a}),t.setAttribute("updated",l)}}),n},El=(e,t,a)=>({hidden:!1,icon:"",id:t,name:a,desc:"",numberFormat:"",pin:!1,template:"",type:e,width:"",wrap:!1,calc:null}),_n=(e,t,a)=>{e.value===""?(t.classList.add("fn__none"),typeof a=="number"&&(e.style.paddingRight=e.dataset.oldPaddingRight)):(t.classList.remove("fn__none"),typeof a=="number"&&e.style.setProperty("padding-right",`${a*2+t.clientWidth}px`,"important"))},kl=e=>{e.inputElement.dataset.oldPaddingRight=e.inputElement.style.paddingRight,e.inputElement.insertAdjacentHTML("afterend",`<svg class="${e.className||"b3-form__icon-clear"} ariaLabel" aria-label="${window.siyuan.languages.clear}" style="${e.right?"right: "+e.right+"px;":""}${e.height?"height:"+e.height+"px;":""}${e.width?"width:"+e.width:""}">
<use xlink:href="#iconCloseRound"></use></svg>`);const t=e.inputElement.nextElementSibling;t.addEventListener("click",()=>{e.inputElement.value="",e.inputElement.focus(),_n(e.inputElement,t,e.right),e.clearCB&&e.clearCB()}),e.inputElement.addEventListener("input",()=>{_n(e.inputElement,t,e.right)}),_n(e.inputElement,t,e.right)},Je=(e,t,a,n,o=!0)=>{let i=[];e.getAttribute("data-type")==="NodeAttributeView"?i=[e]:i=Array.from(e.querySelectorAll('[data-type="NodeAttributeView"]')),i.length!==0&&i.length>0&&i.forEach(s=>{var l,r,c,d,u;if(s.getAttribute("data-render")==="true")return;const g=s.style.alignSelf;if(s.firstElementChild.innerHTML===""){s.style.alignSelf="";let T="";[1,2,3].forEach(()=>{T+=`<div class="av__row">
    <div style="width: 24px;flex-shrink: 0"></div>
    <div class="av__cell" style="width: 200px"><span class="av__pulse"></span></div>
    <div class="av__cell" style="width: 200px"><span class="av__pulse"></span></div>
    <div class="av__cell" style="width: 200px"><span class="av__pulse"></span></div>
    <div class="av__cell" style="width: 200px"><span class="av__pulse"></span></div>
</div>`}),s.firstElementChild.innerHTML=T}const f=((l=s.querySelector(".av__scroll"))==null?void 0:l.scrollLeft)||0,p=(r=s.querySelector(".av__row--header"))==null?void 0:r.style.transform,m=(c=s.querySelector(".av__row--footer"))==null?void 0:c.style.transform,b=[];s.querySelectorAll(".av__row--select").forEach(T=>{const M=T.getAttribute("data-id");M&&b.push(M)});let w="";const y=s.querySelector(".av__cell--select");y&&(w=J(y,"av__row").dataset.id+S.ZWSP+y.getAttribute("data-col-id"));let _="";const h=s.querySelector(".av__drag-fill");h&&(_=J(h,"av__row").dataset.id+S.ZWSP+h.parentElement.getAttribute("data-col-id"));const E=[];s.querySelectorAll(".av__cell--active").forEach(T=>{E.push(J(T,"av__row").dataset.id+S.ZWSP+T.getAttribute("data-col-id"))});const C=(d=t.options.history)==null?void 0:d.created,k=(u=t.options.history)==null?void 0:u.snapshot;let v=s.getAttribute(S.CUSTOM_SY_AV_VIEW)||"";if(typeof n=="string"){const T=s.querySelector(`.av__views > .layout-tab-bar > .item[data-id="${n}"]`);T&&(s.dataset.pageSize=T.dataset.page),v=n,he("/api/av/setDatabaseBlockView",{id:s.dataset.nodeId,viewID:n}),s.setAttribute(S.CUSTOM_SY_AV_VIEW,v)}let A=s.querySelector('[data-type="av-search"]');const L=A&&document.activeElement.isSameNode(A),x=(A==null?void 0:A.value)||"";he(C?"/api/av/renderHistoryAttributeView":k?"/api/av/renderSnapshotAttributeView":"/api/av/renderAttributeView",{id:s.getAttribute("data-av-id"),created:C,snapshot:k,pageSize:parseInt(s.dataset.pageSize)||void 0,viewID:v,query:x.trim()},T=>{var M;const I=T.data.view;s.dataset.pageSize||(s.dataset.pageSize=I.pageSize.toString());let D='<div class="av__row av__row--header"><div class="av__colsticky"><div class="av__firstcol"><svg><use xlink:href="#iconUncheck"></use></svg></div></div>',N="",H=-1,P=-1,ne=0;const U=s.clientWidth;let V=!1;I.columns.forEach((R,ve)=>{V||I.filters.find(ge=>{if(ge.value.type===R.type&&R.id===ge.column)return V=!0,!0}),R.hidden||(R.pin&&(H=ve),ne<U-200&&(ne+=parseInt(R.width)||200,P=ve))}),H=Math.min(H,P),H>-1&&(D='<div class="av__row av__row--header"><div class="av__colsticky"><div class="av__firstcol"><svg><use xlink:href="#iconUncheck"></use></svg></div>',N='<div class="av__colsticky">');let be=!1;I.columns.forEach((R,ve)=>{var ge;R.hidden||(D+=`<div class="av__cell av__cell--header" data-col-id="${R.id}"  draggable="true" 
data-icon="${R.icon}" data-dtype="${R.type}" data-wrap="${R.wrap}" data-pin="${R.pin}" 
data-desc="${Yt(R.desc)}" data-position="north" 
style="width: ${R.width||"200px"};">
    ${R.icon?Le(R.icon,"av__cellheadericon",!0):`<svg class="av__cellheadericon"><use xlink:href="#${nt(R.type)}"></use></svg>`}
    <span class="av__celltext fn__flex-1">${pn(R.name)}</span>
    ${R.pin?'<svg class="av__cellheadericon av__cellheadericon--pin"><use xlink:href="#iconPin"></use></svg>':""}
    <div class="av__widthdrag"></div>
</div>`,H===ve&&(D+="</div>"),R.type==="lineNumber"?N+=`<div data-col-id="${R.id}" data-dtype="${R.type}" class="av__calc" style="width: ${R.width||"200px"}">&nbsp;</div>`:N+=`<div class="av__calc${R.calc&&R.calc.operator!==""?" av__calc--ashow":""}" data-col-id="${R.id}" data-dtype="${R.type}" data-operator="${((ge=R.calc)==null?void 0:ge.operator)||""}" 
style="width: ${R.width||"200px"}">${sl(R)||`<svg><use xlink:href="#iconDown"></use></svg><small>${window.siyuan.languages.calc}</small>`}</div>`,R.calc&&R.calc.operator!==""&&(be=!0),H===ve&&(N+="</div>"))}),D+=`<div class="block__icons" style="min-height: auto">
    <div class="block__icon block__icon--show" data-type="av-header-more"><svg><use xlink:href="#iconMore"></use></svg></div>
    <div class="fn__space"></div>
    <div class="block__icon block__icon--show ariaLabel" aria-label="${window.siyuan.languages.newCol}" data-type="av-header-add" data-position="4south"><svg><use xlink:href="#iconAdd"></use></svg></div>
</div>
</div>`,I.rows.forEach((R,ve)=>{D+=`<div class="av__row" data-id="${R.id}">`,H>-1?D+='<div class="av__colsticky"><div class="av__firstcol"><svg><use xlink:href="#iconUncheck"></use></svg></div>':D+='<div class="av__colsticky"><div class="av__firstcol"><svg><use xlink:href="#iconUncheck"></use></svg></div></div>',R.cells.forEach((ge,Mt)=>{var ri,ci,di;if(I.columns[Mt].hidden)return;let ui="";ge.valueType==="checkbox"&&(ui=(ci=(ri=ge.value)==null?void 0:ri.checkbox)!=null&&ci.checked?" av__cell-check":" av__cell-uncheck"),D+=`<div class="av__cell${ui}" data-id="${ge.id}" data-col-id="${I.columns[Mt].id}"
${ge.valueType==="block"?'data-block-id="'+(ge.value.block.id||"")+'"':""} data-wrap="${I.columns[Mt].wrap}" 
data-dtype="${I.columns[Mt].type}" 
${(di=ge.value)!=null&&di.isDetached?' data-detached="true"':""} 
style="width: ${I.columns[Mt].width||"200px"};
${ge.valueType==="number"?"text-align: right;":""}
${ge.bgColor?`background-color:${ge.bgColor};`:""}
${ge.color?`color:${ge.color};`:""}">${yn(ge.value,ve)}</div>`,H===Mt&&(D+="</div>")}),D+="<div></div></div>"});let we="",G;T.data.views.forEach(R=>{we+=`<div data-position="north" data-id="${R.id}" data-page="${R.pageSize}" data-desc="${ul(R.desc||"")}" class="ariaLabel item${R.id===T.data.viewID?" item--focus":""}">
    ${R.icon?Le(R.icon,"item__graphic",!0):'<svg class="item__graphic"><use xlink:href="#iconTable"></use></svg>'}
    <span class="item__text">${pn(R.name)}</span>
</div>`,R.id===T.data.viewID&&(G=R)});const qe=`<div class="av__body">
    ${D}
    <div class="av__row--util${I.rowCount>I.rows.length?" av__readonly--show":""}">
        <div class="av__colsticky">
            <button class="b3-button" data-type="av-add-bottom">
                <svg><use xlink:href="#iconAdd"></use></svg>
                <span>${window.siyuan.languages.newRow}</span>
            </button>
            <span class="fn__space"></span>
            <button class="b3-button${I.rowCount>I.rows.length?"":" fn__none"}" data-type="av-load-more">
                <svg><use xlink:href="#iconArrowDown"></use></svg>
                <span>${window.siyuan.languages.loadMore}</span>
                <svg data-type="set-page-size" data-size="${I.pageSize}"><use xlink:href="#iconMore"></use></svg>
            </button>
        </div>
    </div>
    <div class="av__row--footer${be?" av__readonly--show":""}">${N}</div>
</div>`;o?s.firstElementChild.outerHTML=`<div class="av__container">
    <div class="av__header">
        <div class="fn__flex av__views${L||x?" av__views--show":""}">
            <div class="layout-tab-bar fn__flex">
                ${we}
            </div>
            <div class="fn__space"></div>
            <span data-type="av-add" class="block__icon ariaLabel" data-position="8south" aria-label="${window.siyuan.languages.newView}">
                <svg><use xlink:href="#iconAdd"></use></svg>
            </span>
            <div class="fn__flex-1"></div>
            <div class="fn__space"></div>
            <span data-type="av-switcher" class="block__icon${T.data.views.length>0?"":" fn__none"}">
                <svg><use xlink:href="#iconDown"></use></svg>
                <span class="fn__space"></span>
                <small>${T.data.views.length}</small>
            </span>
            <div class="fn__space"></div>
            <span data-type="av-filter" class="block__icon${V?" block__icon--active":""}">
                <svg><use xlink:href="#iconFilter"></use></svg>
            </span>
            <div class="fn__space"></div>
            <span data-type="av-sort" class="block__icon${I.sorts.length>0?" block__icon--active":""}">
                <svg><use xlink:href="#iconSort"></use></svg>
            </span>
            <div class="fn__space"></div>
            <span data-type="av-search-icon" class="block__icon">
                <svg><use xlink:href="#iconSearch"></use></svg>
            </span>
            <div style="position: relative" class="fn__flex">
                <input style="${L||x?"width:128px":"width:0;padding-left: 0;padding-right: 0;"}" data-type="av-search" class="b3-text-field b3-text-field--text" placeholder="${window.siyuan.languages.search}">
            </div>
            <div class="fn__space"></div>
            <span data-type="av-more" class="block__icon">
                <svg><use xlink:href="#iconMore"></use></svg>
            </span>
            <div class="fn__space"></div>
            <span data-type="av-add-more" class="block__icon ariaLabel" data-position="8south" aria-label="${window.siyuan.languages.newRow}">
                <svg><use xlink:href="#iconAdd"></use></svg>
            </span>
            <div class="fn__space"></div>
            ${T.data.isMirror?` <span data-av-id="${T.data.id}" data-popover-url="/api/av/getMirrorDatabaseBlocks" class="popover__block block__icon block__icon--show ariaLabel" data-position="8south" aria-label="${window.siyuan.languages.mirrorTip}">
    <svg><use xlink:href="#iconSplitLR"></use></svg></span><div class="fn__space"></div>`:""}
        </div>
        <div contenteditable="${t.disabled||j(s,"data-type","NodeBlockQueryEmbed")?"false":"true"}" spellcheck="${window.siyuan.config.editor.spellcheck.toString()}" class="av__title${G.hideAttrViewName?" fn__none":""}" data-title="${T.data.name||""}" data-tip="${window.siyuan.languages.title}">${T.data.name||""}</div>
        <div class="av__counter fn__none"></div>
    </div>
    <div class="av__scroll">
        ${qe}
    </div>
    <div class="av__cursor" contenteditable="true">${S.ZWSP}</div>
</div>`:s.firstElementChild.querySelector(".av__scroll").innerHTML=qe,s.setAttribute("data-render","true"),s.style.margin="",f&&(s.querySelector(".av__scroll").scrollLeft=f),g&&(s.style.alignSelf=g);const ae=t.contentElement.getBoundingClientRect();if(p?s.querySelector(".av__row--header").style.transform=p:setTimeout(()=>{ka(s,ae,"top")},S.TIMEOUT_LOAD),m?s.querySelector(".av__row--footer").style.transform=m:setTimeout(()=>{ka(s,ae,"bottom")},S.TIMEOUT_LOAD),w){const R=s.querySelector(`.av__row[data-id="${w.split(S.ZWSP)[0]}"] .av__cell[data-col-id="${w.split(S.ZWSP)[1]}"]`);R&&R.classList.add("av__cell--select");const ve=document.querySelector(".av__mask");ve?(M=ve.querySelector("textarea, input"))==null||M.focus():!document.querySelector(".av__panel")&&!L&&Re(s),Ds(s,R)}if(b.forEach((R,ve)=>{const ge=s.querySelector(`.av__row[data-id="${R}"]`);ge&&(ge.classList.add("av__row--select"),ge.querySelector(".av__firstcol use").setAttribute("xlink:href","#iconCheck")),ve===b.length-1&&ge&&kn(ge)}),_&&_a(s.querySelector(`.av__row[data-id="${_.split(S.ZWSP)[0]}"] .av__cell[data-col-id="${_.split(S.ZWSP)[1]}"]`)),E.forEach(R=>{var ve;(ve=s.querySelector(`.av__row[data-id="${R.split(S.ZWSP)[0]}"] .av__cell[data-col-id="${R.split(S.ZWSP)[1]}"]`))==null||ve.classList.add("av__cell--active")}),getSelection().rangeCount>0){const R=getSelection().getRangeAt(0);if(!J(R.startContainer,"av__title")){const ve=oe(R.startContainer);ve&&s.isSameNode(ve)&&!L&&Re(s)}}if(s.querySelector(".layout-tab-bar").scrollLeft=s.querySelector(".layout-tab-bar .item--focus").offsetLeft,a&&a(),!o)return;const xe=s.querySelector(".av__views");A=s.querySelector('[data-type="av-search"]'),A.value=x||"",L&&A.focus(),A.addEventListener("compositionstart",R=>{R.stopPropagation()}),A.addEventListener("keydown",R=>{R.isComposing||sa(R)}),A.addEventListener("input",R=>{R.stopPropagation(),!R.isComposing&&(A.value||document.activeElement.isSameNode(A)?xe.classList.add("av__views--show"):xe.classList.remove("av__views--show"),vn(s,t))}),A.addEventListener("compositionend",()=>{vn(s,t)}),A.addEventListener("blur",R=>{R.isComposing||A.value||(xe.classList.remove("av__views--show"),A.style.width="0",A.style.paddingLeft="0",A.style.paddingRight="0")}),kl({inputElement:A,right:0,width:"1em",height:A.clientHeight,clearCB(){xe.classList.remove("av__views--show"),A.style.width="0",A.style.paddingLeft="0",A.style.paddingRight="0",Re(s),vn(s,t)}})})})};let Rs;const vn=(e,t)=>{clearTimeout(Rs),Rs=window.setTimeout(()=>{e.removeAttribute("data-render"),Je(e,t,void 0,void 0,!1)},S.TIMEOUT_INPUT)},Os={},xf=(e,t)=>{t.action==="setAttrViewName"&&Array.from(e.wysiwyg.element.querySelectorAll(`[data-av-id="${t.id}"]`)).forEach(a=>{const n=a.querySelector(".av__title");n&&(n.textContent=t.data,n.dataset.title=t.data)}),clearTimeout(Os[e.id]),Os[e.id]=window.setTimeout(()=>{if(t.action==="setAttrViewColWidth")Array.from(e.wysiwyg.element.querySelectorAll(`[data-av-id="${t.avID}"]`)).forEach(a=>{const n=a.querySelector(`.av__cell[data-col-id="${t.id}"]`);!n||n.style.width===t.data||a.getAttribute("custom-sy-av-view")!==t.keyID||a.querySelectorAll(".av__row").forEach(o=>{o.querySelector(`[data-col-id="${t.id}"]`).style.width=t.data})});else{const a=t.action==="setAttrViewName"?t.id:t.avID;Array.from(e.wysiwyg.element.querySelectorAll(`[data-av-id="${a}"]`)).forEach(n=>{n.removeAttribute("data-render");const o=n.querySelector('.av__row[data-need-update="true"]');(t.action==="sortAttrViewCol"||t.action==="sortAttrViewRow")&&(n.querySelectorAll(".av__cell--active").forEach(i=>{var s;i.classList.remove("av__cell--active"),(s=i.querySelector(".av__drag-fill"))==null||s.remove()}),addDragFill(n.querySelector(".av__cell--select"))),Je(n,e,()=>{var i;const s=document.querySelector(`.b3-dialog--open[data-key="${Constants.DIALOG_ATTR}"] div[data-av-id="${a}"]`);s?renderAVAttribute(s.parentElement,s.dataset.nodeId,e):t.action==="insertAttrViewBlock"&&o&&!n.querySelector(`.av__row[data-id="${o.getAttribute("data-id")}"]`)&&(showMessage(window.siyuan.languages.insertRowTip),(i=document.querySelector(".av__mask"))==null||i.remove()),n.removeAttribute("data-loading")})})}},["insertAttrViewBlock"].includes(t.action)?2:100)},Wt=e=>{if(e.action||(e.action=[]),e.protyle.wysiwyg.element.removeAttribute("data-top"),e.data.code===1){e.action.includes(S.CB_GET_APPEND)||(e.protyle.model?e.protyle.model.parent.parent.removeTab(e.protyle.model.parent.id,!1):e.protyle.element.innerHTML=`<div class="ft__smaller ft__secondary b3-form__space--small" contenteditable="false">${window.siyuan.languages.refExpired}</div>`);return}if(e.data.code!==3&&(e.protyle.notebookId=e.data.data.box,e.protyle.path=e.data.data.path,!(e.data.data.eof&&!e.scrollAttr&&(e.action.includes(S.CB_GET_BEFORE)?e.protyle.wysiwyg.element.firstElementChild.setAttribute("data-eof","1"):e.protyle.wysiwyg.element.lastElementChild.setAttribute("data-eof","2"),e.data.data.mode!==4)))){if(St(["gutterOnly"],e.protyle),e.protyle.block.parentID=e.data.data.parentID,e.protyle.block.parent2ID=e.data.data.parent2ID,e.protyle.block.rootID=e.data.data.rootID,e.protyle.block.showAll=!1,e.protyle.block.mode=e.data.data.mode,e.protyle.block.blockCount=e.data.data.blockCount,e.protyle.block.scroll=e.data.data.scroll,e.protyle.block.action=e.action,e.action.includes(S.CB_GET_UNCHANGEID)||(e.protyle.block.id=e.data.data.id,e.protyle.scroll.lastScrollTop=0,e.protyle.contentElement.scrollTop=0,e.protyle.wysiwyg.element.setAttribute("data-doc-type",e.data.data.type)),e.action.includes(S.CB_GET_APPEND)||e.action.includes(S.CB_GET_BEFORE)||e.action.includes(S.CB_GET_HTML)){qs({content:e.data.data.content,expand:e.data.data.isBacklinkExpand,action:e.action,scrollAttr:e.scrollAttr,updateReadonly:e.updateReadonly,isSyncing:e.data.data.isSyncing,afterCB:e.afterCB},e.protyle),ti(e.protyle);return}he("/api/block/getDocInfo",{id:e.protyle.block.rootID},t=>{e.protyle.options.render.title?e.protyle.title.render(e.protyle,t):(e.protyle.options.render.background&&e.protyle.background.render(t.data.ial,e.protyle.block.rootID),e.protyle.wysiwyg.renderCustom(t.data.ial)),qs({content:e.data.data.content,expand:e.data.data.isBacklinkExpand,action:e.action,scrollAttr:e.scrollAttr,updateReadonly:e.updateReadonly,isSyncing:e.data.data.isSyncing,afterCB:e.afterCB},e.protyle),ti(e.protyle)})}},qs=(e,t)=>{var a;if(t.contentElement.classList.contains("fn__none")&&t.wysiwyg.element.innerHTML!=="")return;t.block.showAll=e.action.includes(S.CB_GET_ALL);const n=t.contentElement.clientHeight*8,o=typeof e.updateReadonly=="undefined"?t.wysiwyg.element.innerHTML==="":e.updateReadonly;if(e.action.includes(S.CB_GET_APPEND)){if(!t.wysiwyg.element.querySelector(".protyle-wysiwyg--select")&&!t.scroll.keepLazyLoad&&t.contentElement.scrollHeight>n){let i=t.wysiwyg.element.firstElementChild;const s=[];for(;t.wysiwyg.element.childElementCount>2&&s&&!t.wysiwyg.element.lastElementChild.isSameNode(i)&&t.contentElement.scrollHeight-i.offsetTop>n;){s.push(i);i=i.nextElementSibling}const l=i.getBoundingClientRect().top;s.forEach(r=>{r.remove()}),t.contentElement.scrollTop=t.contentElement.scrollTop+(i.getBoundingClientRect().top-l),t.scroll.lastScrollTop=t.contentElement.scrollTop,St(["toolbar"],t)}t.wysiwyg.element.insertAdjacentHTML("beforeend",e.content)}else if(e.action.includes(S.CB_GET_BEFORE)){const i=t.wysiwyg.element.firstElementChild,s=i.getBoundingClientRect().top;if(t.wysiwyg.element.insertAdjacentHTML("afterbegin",e.content),t.contentElement.scrollTop=t.contentElement.scrollTop+(i.getBoundingClientRect().top-s),t.scroll.lastScrollTop=t.contentElement.scrollTop,!t.wysiwyg.element.querySelector(".protyle-wysiwyg--select")&&!t.scroll.keepLazyLoad){const l=[];let r=t.wysiwyg.element.childElementCount,c=t.contentElement.scrollHeight,d=t.wysiwyg.element.lastElementChild;for(;r>2&&c>n&&d.getBoundingClientRect().top>window.innerHeight;)l.push(d),d=d.previousElementSibling,r--,c-=d.clientHeight+8;l.forEach(u=>{u.remove()}),St(["toolbar"],t)}}else t.wysiwyg.element.innerHTML=e.content;if(!t.block.showAll&&t.wysiwyg.element.childElementCount===1&&t.wysiwyg.element.firstElementChild.classList.contains("p")){const i=me(t.wysiwyg.element.firstElementChild);i&&i.textContent===""&&(i.classList.add("protyle-wysiwyg--empty"),i.setAttribute("placeholder",window.siyuan.languages.emptyMobilePlaceholder))}if(e.action.includes(S.CB_GET_BACKLINK)&&Fs(e.expand,t.wysiwyg.element),Lt(t.wysiwyg.element),_t(t.wysiwyg.element),Je(t.wysiwyg.element,t),Ge(t,t.wysiwyg.element),!e.action.includes(S.CB_GET_HISTORY)){if(t.options.render.scroll&&t.scroll.update(t),e.action.includes(S.CB_GET_FOCUSFIRST)){const i=t.wysiwyg.element.offsetTop-16;Xa(t,i,S.TIMEOUT_INPUT),t.contentElement.scrollTop=i}if(e.isSyncing?Cl(t):(t.breadcrumb&&(t.breadcrumb.element.nextElementSibling.textContent=""),t.element.removeAttribute("disabled-forever"),Ll(t,o),e.action.includes(S.CB_GET_OPENNEW)&&window.siyuan.config.editor.readOnly&&oo(t.breadcrumb.element.parentElement.querySelector('.block__icon[data-type="readonly"]'),t)),Al(t,e.action,e.scrollAttr),e.action.includes(S.CB_GET_SETID)&&(t.block.id=t.block.rootID,t.wysiwyg.element.setAttribute("data-doc-type","NodeDocument")),(a=t.options.defIds)==null||a.forEach(i=>{t.wysiwyg.element.querySelectorAll(`[data-id="${i}"]`).forEach(s=>{s.classList.add("def--mark")})}),t.options.defIds=[],e.action.includes(S.CB_GET_APPEND)||e.action.includes(S.CB_GET_BEFORE)){t.app.plugins.forEach(i=>{i.eventBus.emit("loaded-protyle-dynamic",{protyle:t,position:e.action.includes(S.CB_GET_APPEND)?"afterend":"beforebegin"})});return}!t.disabled&&!e.action.includes(S.CB_GET_ALL)&&t.background&&t.background.element.classList.add("protyle-background--mobileshow"),t.options.render.breadcrumb&&(t.breadcrumb.toggleExit(!e.action.includes(S.CB_GET_ALL)),t.breadcrumb.render(t)),e.afterCB&&e.afterCB(),e.scrollAttr&&!t.scroll.element.classList.contains("fn__none")&&!t.element.classList.contains("block__edit")&&t.wysiwyg.element.lastElementChild.getAttribute("data-eof")!=="2"&&t.contentElement.scrollHeight>0&&!e.action.includes(S.CB_GET_FOCUSFIRST)&&t.contentElement.scrollHeight<=t.contentElement.clientHeight&&he("/api/filetree/getDoc",{id:t.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),mode:2,size:window.siyuan.config.editor.dynamicLoadBlocks},i=>{Wt({data:i,protyle:t,action:[S.CB_GET_APPEND,S.CB_GET_UNCHANGEID]})}),e.scrollAttr&&!t.scroll.element.classList.contains("fn__none")&&!t.element.classList.contains("fn__none")&&t.scroll.updateIndex(t,e.scrollAttr.startId,i=>{i>1&&t.block.blockCount>1&&t.contentElement.scrollHeight<=t.contentElement.clientHeight&&tt(window.siyuan.languages.scrollGetMore)}),t.app.plugins.forEach(i=>{i.eventBus.emit("loaded-protyle-static",{protyle:t})})}},Cl=e=>{Ea(e),e.breadcrumb&&!$()?e.breadcrumb.element.nextElementSibling.textContent=window.siyuan.languages._kernel[81]:tt(window.siyuan.languages._kernel[81]),e.element.setAttribute("disabled-forever","true")},Ea=e=>{if(window.siyuan.menus.menu.remove(),St(["gutter","toolbar","select","hint","util"],e),e.disabled=!0,e.title&&e.title.editElement&&(e.title.editElement.setAttribute("contenteditable","false"),e.title.editElement.style.userSelect="text"),document.getElementById("toolbarName").setAttribute("readonly","readonly"),e.background&&(e.background.element.classList.remove("protyle-background--enable"),e.background.element.classList.remove("protyle-background--mobileshow")),e.wysiwyg.element.querySelectorAll(".protyle-icons--show").forEach(t=>{t.classList.remove("protyle-icons--show")}),e.wysiwyg.element.querySelectorAll(".render-node .protyle-action__edit").forEach(t=>{var a;t.classList.add("fn__none"),t.classList.contains("protyle-icon--first")&&((a=t.nextElementSibling)==null||a.classList.add("protyle-icon--first"))}),e.wysiwyg.element.style.userSelect="text",e.wysiwyg.element.setAttribute("contenteditable","false"),e.wysiwyg.element.setAttribute("data-readonly","true"),e.wysiwyg.element.querySelectorAll('[contenteditable="true"][spellcheck]').forEach(t=>{t.setAttribute("contenteditable","false")}),e.wysiwyg.element.querySelectorAll('.protyle-action[draggable="true"]').forEach(t=>{t.setAttribute("draggable","false")}),e.breadcrumb){e.breadcrumb.element.parentElement.querySelector('[data-type="readonly"] use').setAttribute("xlink:href","#iconLock"),e.breadcrumb.element.parentElement.querySelector('[data-type="readonly"]').setAttribute("aria-label",window.siyuan.config.editor.readOnly?window.siyuan.languages.tempUnlock:window.siyuan.languages.unlockEdit);const t=e.breadcrumb.element.parentElement.querySelector('[data-type="undo"]');t&&!t.classList.contains("fn__none")&&(t.classList.add("fn__none"),e.breadcrumb.element.parentElement.querySelector('[data-type="redo"]').classList.add("fn__none"),e.breadcrumb.element.parentElement.querySelector('[data-type="indent"]').classList.add("fn__none"),e.breadcrumb.element.parentElement.querySelector('[data-type="outdent"]').classList.add("fn__none"))}na()},Us=e=>{if(e.element.getAttribute("disabled-forever")==="true")return;e.disabled=!1,$()?document.getElementById("toolbarName").removeAttribute("readonly"):(e.wysiwyg.element.setAttribute("contenteditable","true"),e.wysiwyg.element.style.userSelect=""),e.wysiwyg.element.setAttribute("data-readonly","false"),e.title&&e.title.editElement&&(e.title.editElement.setAttribute("contenteditable","true"),e.title.editElement.style.userSelect=""),e.background&&e.background.element.classList.add("protyle-background--enable"),e.wysiwyg.element.querySelectorAll(".render-node .protyle-action__edit").forEach(a=>{var n;a.classList.remove("fn__none"),a.classList.contains("protyle-icon--first")&&((n=a.nextElementSibling)==null||n.classList.remove("protyle-icon--first"))}),e.wysiwyg.element.querySelectorAll('[contenteditable="false"][spellcheck]').forEach(a=>{J(a,"protyle-wysiwyg__embed")||a.setAttribute("contenteditable","true")}),e.wysiwyg.element.querySelectorAll('.protyle-action[draggable="false"]').forEach(a=>{a.setAttribute("draggable","true")});const t=e.contentElement.getBoundingClientRect();if(e.wysiwyg.element.querySelectorAll(".av").forEach(a=>{a.querySelector(".av__title")&&ka(a,t,"all")}),e.breadcrumb){e.breadcrumb.element.parentElement.querySelector('[data-type="readonly"] use').setAttribute("xlink:href","#iconUnlock"),e.breadcrumb.element.parentElement.querySelector('[data-type="readonly"]').setAttribute("aria-label",window.siyuan.config.editor.readOnly?window.siyuan.languages.cancelTempUnlock:window.siyuan.languages.lockEdit);const a=e.breadcrumb.element.parentElement.querySelector('[data-type="undo"]');a&&a.classList.contains("fn__none")&&(a.classList.remove("fn__none"),e.breadcrumb.element.parentElement.querySelector('[data-type="redo"]').classList.remove("fn__none"),e.breadcrumb.element.parentElement.querySelector('[data-type="indent"]').classList.remove("fn__none"),e.breadcrumb.element.parentElement.querySelector('[data-type="outdent"]').classList.remove("fn__none"))}na()},Al=(e,t,a)=>{var n;let o;if(a&&a.focusId?o=e.wysiwyg.element.querySelector(`[data-node-id="${a.focusId}"]`):Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${e.block.id}"]`)).find(s=>{if(!j(s,"data-type","block-render",!0))return o=s,!0}),e.block.mode===4?(Xa(e),o=e.wysiwyg.element.lastElementChild):(!o||t.includes(S.CB_GET_FOCUSFIRST))&&(o=e.wysiwyg.element.firstElementChild),t.includes(S.CB_GET_HL)&&(Xa(e),aa(o)),t.includes(S.CB_GET_FOCUS)||t.includes(S.CB_GET_FOCUSFIRST)){let s;a&&a.focusId?s=xa(o,a.focusStart,a.focusEnd):Re(o)}const i=a&&typeof a.scrollTop=="number";if(i&&(e.contentElement.scrollTop=a.scrollTop),(n=e.observerLoad)==null||n.disconnect(),t.includes(S.CB_GET_FOCUS)||t.includes(S.CB_GET_SCROLL)||t.includes(S.CB_GET_HL)||t.includes(S.CB_GET_FOCUSFIRST)){const s=e.contentElement.getBoundingClientRect(),l=o.getBoundingClientRect();!i&&(s.top>l.top||s.bottom<l.bottom)&&Za(e,o,!0)}else return;e.observerLoad=new ResizeObserver(()=>{if(i&&(e.contentElement.scrollTop=a.scrollTop),t.includes(S.CB_GET_FOCUS)||t.includes(S.CB_GET_HL)||t.includes(S.CB_GET_FOCUSFIRST)){const s=e.contentElement.getBoundingClientRect(),l=o.getBoundingClientRect();!i&&(s.top>l.top||s.bottom<l.bottom)&&Za(e,o,!0)}}),e.observerLoad.observe(e.wysiwyg.element),e.observer.unobserve(e.wysiwyg.element),setTimeout(()=>{e.observerLoad.disconnect(),e.observer.observe(e.wysiwyg.element)},1e3*3),o.isSameNode(e.wysiwyg.element.firstElementChild)&&!i&&e.observerLoad.disconnect()},Ll=(e,t)=>{let a=window.siyuan.config.readonly?"true":"false";t?a==="false"&&(a=window.siyuan.config.editor.readOnly?"true":"false",a==="false"&&(a=e.wysiwyg.element.getAttribute(S.CUSTOM_SY_READONLY))):a=e.disabled?"true":"false",a==="true"?Ea(e):Us(e)},Tf=(e,t)=>{e.block.showAll=!0;let a="";t.forEach((n,o)=>{a+=Ws(n.blockPaths,!1,o)+Ys(n.dom,n.expand)}),e.wysiwyg.element.innerHTML=a,js(e.wysiwyg.element),processRender(e.wysiwyg.element),highlightRender(e.wysiwyg.element),avRender(e.wysiwyg.element,e),blockRender(e,e.wysiwyg.element),removeLoading(e),(window.siyuan.config.readonly||window.siyuan.config.editor.readOnly)&&disabledProtyle(e)},Fs=(e,t)=>{t.firstElementChild.classList.contains("li")?e?t.querySelectorAll(".li .li").forEach(a=>{a.childElementCount>3&&a.setAttribute("fold","1")}):t.firstElementChild.setAttribute("fold","1"):t.firstElementChild.getAttribute("data-type")==="NodeHeading"&&Array.from(t.children).forEach((a,n)=>{(e&&n>2||!e&&n>1)&&((e&&n===3||!e&&n===2)&&a.insertAdjacentHTML("beforebegin",'<div style="max-width: 100%;justify-content: center;" contenteditable="false" class="protyle-breadcrumb__item"><svg style="transform: rotate(90deg);"><use xlink:href="#iconMore"></use></svg></div>'),a.classList.add("fn__none"))})},Ys=(e,t)=>{const a=document.createElement("template");return a.innerHTML=e,Fs(t,a.content),a.innerHTML},If=(e,t)=>{fetchPost("/api/filetree/getDoc",{id:t.getAttribute("data-id"),size:Constants.SIZE_GET_MAX},a=>{t.parentElement.querySelector(".protyle-breadcrumb__item--active").classList.remove("protyle-breadcrumb__item--active"),t.classList.add("protyle-breadcrumb__item--active");let n=t.parentElement.nextElementSibling;for(;n&&!n.classList.contains("protyle-breadcrumb__bar");){const o=n;n=n.nextElementSibling,o.remove()}t.parentElement.insertAdjacentHTML("afterend",Ys(a.data.content,!0)),processRender(t.parentElement.parentElement),avRender(t.parentElement.parentElement,e),blockRender(e,t.parentElement.parentElement),a.data.isSyncing?disabledForeverProtyle(e):window.siyuan.config.readonly||window.siyuan.config.editor.readOnly?disabledProtyle(e):t.parentElement.parentElement.classList.contains("protyle-wysiwyg__embed")&&t.parentElement.parentElement.querySelectorAll('[contenteditable="true"][spellcheck]').forEach(o=>{o.setAttribute("contenteditable","false")})})},Mf=e=>{let t=e.nextElementSibling;for(;t&&!t.classList.contains("protyle-breadcrumb__bar");)t.classList.remove("fn__none"),t=t.nextElementSibling;e.remove()},Ws=(e,t,a)=>{if(1>e.length)return`<div contenteditable="false" style="border-top: ${a===0?0:1}px solid var(--b3-border-color);min-height: 0;width: 100%;" class="protyle-breadcrumb__bar"><span></span></div>`;let n="";return e.forEach((o,i)=>{i===0&&!t||(n+=`<span class="protyle-breadcrumb__item${i===e.length-1?" protyle-breadcrumb__item--active":""}" data-id="${o.id}">
    <svg class="popover__block" data-id="${o.id}"><use xlink:href="#${Bn(o.type,o.subType)}"></use></svg>
    <span class="protyle-breadcrumb__text" title="${o.name}">${o.name}</span>
</span>`,i!==e.length-1&&(n+='<svg class="protyle-breadcrumb__arrow"><use xlink:href="#iconRight"></use></svg>'))}),`<div contenteditable="false" class="protyle-breadcrumb__bar protyle-breadcrumb__bar--nowrap">${n}</div>`},js=e=>{e.querySelectorAll(".protyle-breadcrumb__bar").forEach(t=>{t.classList.remove("protyle-breadcrumb__bar--nowrap");const a=Array.from(t.querySelectorAll(".protyle-breadcrumb__text"));if(a.length===0)return;let n=!1;for(;t.scrollHeight>30&&!n&&a.length>1;)a.find((o,i)=>{if(i>0){if(!o.classList.contains("protyle-breadcrumb__text--ellipsis"))return o.classList.add("protyle-breadcrumb__text--ellipsis"),!0;i===a.length-1&&o.classList.contains("protyle-breadcrumb__text--ellipsis")&&(n=!0)}});t.classList.add("protyle-breadcrumb__bar--nowrap"),t.lastElementChild&&(t.scrollLeft=t.lastElementChild.offsetLeft-t.clientWidth+14)})},Ge=(e,t,a)=>{let n=[];t.getAttribute("data-type")==="NodeBlockQueryEmbed"?n=[t]:n=Array.from(t.querySelectorAll('[data-type="NodeBlockQueryEmbed"]')),n.length!==0&&n.forEach(o=>{if(o.getAttribute("data-render")==="true")return;o.setAttribute("data-render","true"),o.style.height=o.clientHeight-8+"px",o.innerHTML=`<div class="protyle-icons${le(o)?" fn__none":""}">
    <span aria-label="${window.siyuan.languages.refresh}" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-action__reload protyle-icon--first"><svg class="fn__rotate"><use xlink:href="#iconRefresh"></use></svg></span>
    <span aria-label="${window.siyuan.languages.update} SQL" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-action__edit"><svg><use xlink:href="#iconEdit"></use></svg></span>
    <span aria-label="${window.siyuan.languages.more}" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-action__menu protyle-icon--last"><svg><use xlink:href="#iconMore"></use></svg></span>
</div>${o.lastElementChild.outerHTML}`;const i=Lute.UnEscapeHTMLStr(o.getAttribute("data-content"));let s=o.getAttribute("breadcrumb");if(s?s=s==="true":s=window.siyuan.config.editor.embedBlockBreadcrumb,O(o,"sb")&&(s=!1),i.startsWith("//!js"))try{const r=new Function("fetchSyncPost","item","protyle","top",i)(ai,o,e,a);if(r instanceof Promise)r.then(c=>{if(Array.isArray(c))he("/api/search/getEmbedBlock",{embedBlockID:o.getAttribute("data-node-id"),includeIDs:c,headingMode:o.getAttribute("custom-heading-mode")==="1"?1:0,breadcrumb:s},d=>{jt(d.data.blocks||[],e,o,a)});else return}).catch(()=>{jt([],e,o,a)});else if(Array.isArray(r))he("/api/search/getEmbedBlock",{embedBlockID:o.getAttribute("data-node-id"),includeIDs:r,headingMode:o.getAttribute("custom-heading-mode")==="1"?1:0,breadcrumb:s},c=>{jt(c.data.blocks||[],e,o,a)});else return}catch(r){jt([],e,o,a)}else he("/api/search/searchEmbedBlock",{embedBlockID:o.getAttribute("data-node-id"),stmt:i,headingMode:o.getAttribute("custom-heading-mode")==="1"?1:0,excludeIDs:[o.getAttribute("data-node-id"),e.block.rootID],breadcrumb:s},r=>{jt(r.data.blocks,e,o,a)})})},jt=(e,t,a,n)=>{const o=a.querySelector(".fn__rotate");o&&o.classList.remove("fn__rotate");let i="";e.forEach(r=>{let c="";r.blockPaths.length!==0&&(c=Ws(r.blockPaths,!0)),i+=`<div class="protyle-wysiwyg__embed" data-id="${r.block.id}">${c}${r.block.content}</div>`}),e.length>0?(a.lastElementChild.insertAdjacentHTML("beforebegin",i+`<div style="position: absolute;">${S.ZWSP}</div>`),js(a.querySelector(".protyle-wysiwyg__embed"))):a.lastElementChild.insertAdjacentHTML("beforebegin",`<div class="ft__smaller ft__secondary b3-form__space--small" contenteditable="false">${window.siyuan.languages.refExpired}</div>
<div style="position: absolute;">${S.ZWSP}</div>`),Lt(a),_t(a),Je(a,t),n&&(t.contentElement.scrollTop=n);let s=0,l=a;for(;s<4&&l;)l=j(l.parentElement,"data-type","NodeBlockQueryEmbed"),s++;s<4&&a.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(r=>{Ge(t,r)}),a.style.height=""},Df=(e=!1)=>{};let Sl,xl;const $f=(e,t)=>{},Tl=(e,t,a=!1)=>{},Hf=()=>{Sl="",document.querySelector("#status .status__counter").innerHTML="",clearTimeout(xl)},Nf=e=>{if(!e)return;let t=`<span class="ft__on-surface">${window.siyuan.languages.runeCount}</span>&nbsp;${e.runeCount}<span class="fn__space"></span>
<span class="ft__on-surface">${window.siyuan.languages.wordCount}</span>&nbsp;${e.wordCount}<span class="fn__space"></span>`;0<e.linkCount&&(t+=`<span class="ft__on-surface">${window.siyuan.languages.linkCount}</span>&nbsp;${e.linkCount}<span class="fn__space"></span>`),0<e.imageCount&&(t+=`<span class="ft__on-surface">${window.siyuan.languages.imgCount}</span>&nbsp;${e.imageCount}<span class="fn__space"></span>`),0<e.refCount&&(t+=`<span class="ft__on-surface">${window.siyuan.languages.refCount}</span>&nbsp;${e.refCount}<span class="fn__space"></span>`),0<e.blockCount&&(t+=`<span class="ft__on-surface">${window.siyuan.languages.blockCount}</span>&nbsp;${e.blockCount}<span class="fn__space"></span>`),document.querySelector("#status .status__counter").innerHTML=t};var Il=(e,t,a)=>new Promise((n,o)=>{var i=r=>{try{l(a.next(r))}catch(c){o(c)}},s=r=>{try{l(a.throw(r))}catch(c){o(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(i,s);l((a=a.apply(e,t)).next())}),Ml=(e,t,a)=>(t=e[Symbol.asyncIterator],a=(n,o)=>(o=e[n])&&(t[n]=i=>new Promise((s,l,r)=>(i=o.call(e,i),r=i.done,Promise.resolve(i.value).then(c=>s({value:c,done:r}),l)))),t?t.call(e):(e=e[Symbol.iterator](),t={},a("next"),a("return"),t));const Vs=(e,t)=>{const a=We(e),n=[];if(a.isSameNode(e)||(e.remove(),n.push({action:"delete",id:a.getAttribute("data-node-id")})),a.remove(),t.wysiwyg.element.childElementCount===0)if(t.block.rootID===t.block.id){const o=Lute.NewNodeID(),i=fn(!1,!1,o);n.push({action:"insert",data:i.outerHTML,id:o,parentID:t.block.parentID}),t.wysiwyg.element.innerHTML=i.outerHTML}else Cs({protyle:t,id:t.block.rootID,isPushBack:!1,focusId:t.block.id});n.length>0&&wt(t,n,[])},Gs=()=>{if(window.siyuan.transactions.length===0)return;const e=window.siyuan.transactions[0].protyle,t=window.siyuan.transactions[0].doOperations,a=window.siyuan.transactions[0].undoOperations;window.siyuan.transactions.splice(0,1),he("/api/transactions",{session:e.id,app:S.SIYUAN_APPID,transactions:[{doOperations:t,undoOperations:a}]},n=>{window.siyuan.transactions.length===0?Tl([],e.block.rootID,!0):Gs(),(window.siyuan.config.sync.provider!==0&&Si()||window.siyuan.config.sync.provider===0&&!Li(""))&&window.siyuan.config.repo.key&&window.siyuan.config.sync.enabled&&document.getElementById("toolbarSync").classList.remove("fn__none");let o;if(getSelection().rangeCount>0&&(o=getSelection().getRangeAt(0)),n.data[0].doOperations.forEach(i=>{if(i.action==="unfoldHeading"||i.action==="foldHeading"){Js(i,e);return}if(i.action==="update"){e.options.backlinkData&&(Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${i.id}"]`)).forEach(s=>{le(s)||o&&(s.isSameNode(o.startContainer)||s.contains(o.startContainer))||(s.outerHTML=i.data.replace("<wbr>",""))}),Lt(e.wysiwyg.element),_t(e.wysiwyg.element),Je(e.wysiwyg.element,e),Ge(e,e.wysiwyg.element)),En(e,i);return}if(i.action==="delete"||i.action==="append"){e.options.backlinkData&&Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${i.id}"]`)).forEach(s=>{le(s)||s.remove()}),e.wysiwyg.element.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(s=>{s.querySelector(`[data-node-id="${i.id}"]`)&&(s.removeAttribute("data-render"),Ge(e,s))}),St(["gutter"],e);return}if(i.action==="move"){if(e.options.backlinkData){const s=[];Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${i.id}"]`)).forEach(r=>{if(!le(r)&&!r.contains(o.startContainer)){s.push(r);return}});let l=!1;i.previousID&&s.length>0?Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${i.previousID}"]`)).forEach(r=>{!le(r)&&!r.nextElementSibling.contains(o.startContainer)&&(r.after(F(s[0].cloneNode(!0))),l=!0)}):s.length>0&&Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${i.parentID}"]`)).forEach(r=>{var c;!le(r)&&!et(r).contains(o.startContainer)&&((c=r.firstElementChild)!=null&&c.classList.contains("protyle-action")?r.firstElementChild.after(F(s[0].cloneNode(!0))):r.prepend(F(s[0].cloneNode(!0))),l=!0)}),s.forEach(r=>{l?r.remove():!l&&r.parentElement&&Vs(r,e)})}e.wysiwyg.element.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(s=>{s.querySelector(`[data-node-id="${i.id}"]`)&&(s.removeAttribute("data-render"),Ge(e,s))});return}if(i.action==="insert"&&e.options.backlinkData){const s=[];i.previousID?Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${i.previousID}"]`)).forEach(l=>{var r;((r=l.nextElementSibling)==null?void 0:r.getAttribute("data-node-id"))!==i.id&&!j(l,"data-node-id",i.id)&&!le(l)&&(l.insertAdjacentHTML("afterend",i.data),s.push(l.nextElementSibling))}):Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${i.parentID}"]`)).forEach(l=>{le(l)||(l.firstElementChild&&l.firstElementChild.classList.contains("protyle-action")&&l.firstElementChild.nextElementSibling.getAttribute("data-node-id")!==i.id?(l.firstElementChild.insertAdjacentHTML("afterend",i.data),s.push(l.firstElementChild.nextElementSibling)):l.firstElementChild&&l.firstElementChild.getAttribute("data-node-id")!==i.id&&(l.insertAdjacentHTML("afterbegin",i.data),s.push(l.firstElementChild)))}),e.wysiwyg.element.querySelectorAll('[data-type="NodeHeading"]').forEach(l=>{l.lastElementChild.getAttribute("spin")==="1"&&l.lastElementChild.remove()}),s.forEach(l=>{Lt(l),_t(l),Je(l,e),Ge(e,l);const r=l.querySelector("wbr");r&&r.remove()})}}),e.wysiwyg.element.childElementCount===0&&!e.block.showAll){const i=Lute.NewNodeID(),s=fn(!1,!0,i);e.wysiwyg.element.insertAdjacentElement("afterbegin",s),wt(e,[{action:"insert",data:s.outerHTML,id:i,parentID:e.block.parentID}]),Ta(s,o)}})},En=(e,t)=>{let a=!1;e.wysiwyg.element.querySelectorAll(`[data-type="NodeBlockQueryEmbed"] [data-node-id="${t.id}"]`).forEach(n=>{const o=document.createElement("div");o.innerHTML=t.data,o.querySelectorAll('[contenteditable="true"]').forEach(s=>{s.setAttribute("contenteditable","false")});const i=o.querySelector("wbr");i&&i.remove(),n.outerHTML=o.innerHTML,a=!0}),a&&(Lt(e.wysiwyg.element),_t(e.wysiwyg.element),Je(e.wysiwyg.element,e))},Ks=(e,t,a,n)=>{n&&focusSideBlock(e[0]),e.forEach(o=>{if(n)o.remove();else{const i=getTopAloneElement(o);i&&i.remove()}}),a.wysiwyg.element.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(o=>{o.querySelector(`[data-node-id="${t}"]`)&&(o.removeAttribute("data-render"),blockRender(a,o))})},zs=(e,t,a,n)=>{e.forEach(i=>{i.getAttribute("data-subtype")==="echarts"?i.outerHTML=t.lute.SpinBlockDOM(a.data):i.outerHTML=a.data}),Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${a.id}"]`)).find(i=>{if(!isInEmbedBlock(i))return e[0]=i,!0});const o=e[0].querySelector("wbr");if(n){const i=getEditorRange(e[0]);o?focusByWbr(e[0],i):focusBlock(e[0])}else o&&o.remove();processRender(e.length===1?e[0]:t.wysiwyg.element),highlightRender(e.length===1?e[0]:t.wysiwyg.element),avRender(e.length===1?e[0]:t.wysiwyg.element,t),blockRender(t,e.length===1?e[0]:t.wysiwyg.element),En(t,a)},Bf=(e,t,a)=>{var n,o;const i=[];if(Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.id}"]`)).forEach(s=>{isInEmbedBlock(s)||i.push(s)}),t.action==="setAttrs"){e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.id}"]`).forEach(s=>{JSON.parse(t.data).fold==="1"?s.setAttribute("fold","1"):s.removeAttribute("fold")});return}if(t.action==="unfoldHeading"){const s=e.contentElement.scrollTop;e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.id}"]`).forEach(l=>{if(l.removeAttribute("fold"),a)return;const r=isInEmbedBlock(l);if(r){r.removeAttribute("data-render"),blockRender(e,r);return}t.retData&&(Zs(t.retData,e),l.insertAdjacentHTML("afterend",t.retData)),t.data==="remove"&&l.remove()}),t.retData&&(e.disabled&&disabledProtyle(e),processRender(e.wysiwyg.element),highlightRender(e.wysiwyg.element),avRender(e.wysiwyg.element,e),blockRender(e,e.wysiwyg.element),e.contentElement.scrollTop=s,e.scroll.lastScrollTop=s);return}if(t.action==="foldHeading"){if(e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.id}"]`).forEach(s=>{s.setAttribute("fold","1"),t.retData||removeFoldHeading(s)}),a)return;t.retData&&(t.retData.forEach(s=>{let l;Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${s}"]`)).find(r=>{if(l=isInEmbedBlock(r),l)return!0;r.remove()}),l&&(l.removeAttribute("data-render"),blockRender(e,l))}),e.wysiwyg.element.childElementCount===0&&zoomOut({protyle:e,id:e.block.rootID,isPushBack:!1,focusId:t.id}));return}if(t.action==="delete"){i.length>0||!a?Ks(i,t.id,e,a):a&&zoomOut({protyle:e,id:e.block.rootID,isPushBack:!1,focusId:t.id,callback(){Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.id}"]`)).forEach(s=>{isInEmbedBlock(s)||i.push(s)}),Ks(i,t.id,e,a)}});return}if(t.action==="update"){i.length>0?zs(i,e,t,a):a?zoomOut({protyle:e,id:e.block.rootID,isPushBack:!1,focusId:t.id,callback(){Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.id}"]`)).forEach(s=>{isInEmbedBlock(s)||i.push(s)}),zs(i,e,t,a)}}):En(e,t);return}if(t.action==="updateAttrs"){const s=t.data,l={};let r="",c="",d="",u="",g="";Object.keys(s.new).forEach(p=>{l[p]=s.new[p];const m=Lute.EscapeHTMLStr(s.new[p]);p==="bookmark"?r=`<div class="protyle-attr--bookmark">${m}</div>`:p==="name"?c=`<div class="protyle-attr--name"><svg><use xlink:href="#iconN"></use></svg>${m}</div>`:p==="alias"?d=`<div class="protyle-attr--alias"><svg><use xlink:href="#iconA"></use></svg>${m}</div>`:p==="memo"?u=`<div class="protyle-attr--memo b3-tooltips b3-tooltips__sw" aria-label="${m}"><svg><use xlink:href="#iconM"></use></svg></div>`:p==="custom-avs"&&s.new["av-names"]&&(g=`<div class="protyle-attr--av"><svg><use xlink:href="#iconDatabase"></use></svg>${s.new["av-names"]}</div>`)});let f=r+c+d+u+g;if(e.block.rootID===t.id){if(e.title){s.new["custom-avs"]&&!s.new["av-names"]&&(f+=((n=e.title.element.querySelector(".protyle-attr--av"))==null?void 0:n.outerHTML)||"");const p=e.title.element.querySelector(".protyle-attr--refcount");p&&(f+=p.outerHTML),s.new[Constants.CUSTOM_RIFF_DECKS]&&s.new[Constants.CUSTOM_RIFF_DECKS]!==s.old[Constants.CUSTOM_RIFF_DECKS]?(e.title.element.style.animation="addCard 450ms linear",e.title.element.setAttribute(Constants.CUSTOM_RIFF_DECKS,s.new[Constants.CUSTOM_RIFF_DECKS]),setTimeout(()=>{e.title.element.style.animation=""},450)):s.new[Constants.CUSTOM_RIFF_DECKS]||e.title.element.removeAttribute(Constants.CUSTOM_RIFF_DECKS),e.title.element.querySelector(".protyle-attr").innerHTML=f}if(e.wysiwyg.renderCustom(l),s.new[Constants.CUSTOM_SY_FULLWIDTH]!==s.old[Constants.CUSTOM_SY_FULLWIDTH]&&resize(e),s.new[Constants.CUSTOM_SY_READONLY]!==s.old[Constants.CUSTOM_SY_READONLY]){let p=s.new[Constants.CUSTOM_SY_READONLY];p||(p=window.siyuan.config.editor.readOnly?"true":"false"),p==="true"?disabledProtyle(e):enableProtyle(e)}s.new.icon!==s.old.icon&&window.siyuan.mobile.editor.protyle.background.ial.icon!==s.new.icon&&(window.siyuan.mobile.editor.protyle.background.ial.icon=s.new.icon,window.siyuan.mobile.editor.protyle.background.render(window.siyuan.mobile.editor.protyle.background.ial,window.siyuan.mobile.editor.protyle.block.rootID));return}e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.id}"]`).forEach(p=>{var m;if(p.getAttribute("data-type")==="NodeThematicBreak")return;Object.keys(s.old).forEach(w=>{p.removeAttribute(w)}),s.new.style&&s.new[Constants.CUSTOM_RIFF_DECKS]&&s.new[Constants.CUSTOM_RIFF_DECKS]!==s.old[Constants.CUSTOM_RIFF_DECKS]&&(s.new.style+=";animation:addCard 450ms linear"),Object.keys(s.new).forEach(w=>{p.setAttribute(w,s.new[w]),w===Constants.CUSTOM_RIFF_DECKS&&s.new[Constants.CUSTOM_RIFF_DECKS]!==s.old[Constants.CUSTOM_RIFF_DECKS]&&(p.style.animation="addCard 450ms linear",setTimeout(()=>{p.parentElement?p.style.animation="":e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.id}"]`).forEach(y=>{y.style.animation=""})},450))}),s.new["custom-avs"]&&!s.new["av-names"]&&(f+=((m=p.lastElementChild.querySelector(".protyle-attr--av"))==null?void 0:m.outerHTML)||"");const b=p.lastElementChild.querySelector(".protyle-attr--refcount");b&&(f+=b.outerHTML),p.lastElementChild.innerHTML=f+Constants.ZWSP});return}if(t.action==="move"){let s;a&&getSelection().rangeCount>0&&(s=getSelection().getRangeAt(0),s.insertNode(document.createElement("wbr")));let l=!1;t.previousID&&i.length>0?Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.previousID}"]`)).forEach(r=>{isInEmbedBlock(r)||(r.after(processClonePHElement(i[0].cloneNode(!0))),l=!0)}):i.length>0&&(!e.options.backlinkData&&t.parentID===e.block.parentID?(e.wysiwyg.element.prepend(processClonePHElement(i[0].cloneNode(!0))),l=!0):Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.parentID}"]`)).forEach(r=>{var c;isInEmbedBlock(r)||((c=r.firstElementChild)!=null&&c.classList.contains("protyle-action")?r.firstElementChild.after(processClonePHElement(i[0].cloneNode(!0))):r.prepend(processClonePHElement(i[0].cloneNode(!0))),l=!0)})),i.forEach(r=>{l?r.remove():!l&&r.parentElement&&Vs(r,e)}),a&&s&&(t.data==="focus"?(Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.id}"]`)).find(r=>{if(!isInEmbedBlock(r))return focusBlock(r),!0}),(o=document.querySelector("wbr"))==null||o.remove()):focusByWbr(e.wysiwyg.element,s)),e.wysiwyg.element.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(r=>{r.querySelector(`[data-node-id="${t.id}"],[data-node-id="${t.parentID}"],[data-node-id="${t.previousID}"]`)&&(r.removeAttribute("data-render"),blockRender(e,r))});return}if(t.action==="insert"){const s=[];if(t.previousID?Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.previousID}"]`)).forEach(l=>{const r=isInEmbedBlock(l);r?(r.removeAttribute("data-render"),blockRender(e,r)):(l.insertAdjacentHTML("afterend",t.data),s.push(l.nextElementSibling))}):t.nextID?Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.nextID}"]`)).forEach(l=>{const r=isInEmbedBlock(l);r?(r.removeAttribute("data-render"),blockRender(e,r)):(l.insertAdjacentHTML("beforebegin",t.data),s.push(l.previousElementSibling))}):!e.options.backlinkData&&t.parentID===e.block.parentID?(e.wysiwyg.element.insertAdjacentHTML("afterbegin",t.data),s.push(e.wysiwyg.element.firstElementChild)):Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.parentID}"]`)).forEach(l=>{var r;isInEmbedBlock(l)||((r=l.firstElementChild)!=null&&r.classList.contains("protyle-action")?(l.firstElementChild.insertAdjacentHTML("afterend",t.data),s.push(l.firstElementChild.nextElementSibling)):(l.insertAdjacentHTML("afterbegin",t.data),s.push(l.firstElementChild)))}),e.wysiwyg.element.querySelectorAll('[data-type="NodeHeading"]').forEach(l=>{l.lastElementChild.getAttribute("spin")==="1"&&l.lastElementChild.remove()}),s.length===0)return;s.forEach(l=>{processRender(l),highlightRender(l),avRender(l,e),blockRender(e,l);const r=l.querySelector("wbr");if(a){const c=getEditorRange(l);r?focusByWbr(l,c):focusBlock(l)}else r&&r.remove()});return}if(t.action==="append"){e.options.backlinkData||reloadProtyle(e,!1);return}if(["addAttrViewCol","insertAttrViewBlock","updateAttrViewCol","updateAttrViewColOptions","updateAttrViewColOption","updateAttrViewCell","sortAttrViewRow","sortAttrViewCol","setAttrViewColHidden","setAttrViewColWrap","setAttrViewColWidth","removeAttrViewColOption","setAttrViewName","setAttrViewFilters","setAttrViewSorts","setAttrViewColCalc","removeAttrViewCol","updateAttrViewColNumberFormat","removeAttrViewBlock","replaceAttrViewBlock","updateAttrViewColTemplate","setAttrViewColPin","addAttrViewView","setAttrViewColIcon","removeAttrViewView","setAttrViewViewName","setAttrViewViewIcon","duplicateAttrViewView","sortAttrViewView","updateAttrViewColRelation","setAttrViewPageSize","updateAttrViewColRollup","sortAttrViewKey","duplicateAttrViewKey","setAttrViewViewDesc","setAttrViewColDesc"].includes(t.action)){a?t.action==="setAttrViewName"&&Array.from(e.wysiwyg.element.querySelectorAll(`[data-av-id="${t.id}"]`)).forEach(s=>{const l=s.querySelector(".av__title");l&&(l.textContent=t.data,l.dataset.title=t.data)}):refreshAV(e,t);return}if(t.action==="doUpdateUpdated"){i.forEach(s=>{s.setAttribute("updated",t.data)});return}},Pf=e=>{let t;const a=Lute.NewNodeID();if(e.type==="BlocksMergeSuperBlock")t=genSBElement(e.level,a);else if(e.type==="Blocks2Blockquote")t=document.createElement("div"),t.classList.add("bq"),t.setAttribute("data-node-id",a),t.setAttribute("data-type","NodeBlockquote"),t.innerHTML='<div class="protyle-attr" contenteditable="false"></div>';else if(e.type.endsWith("Ls")){t=document.createElement("div"),t.classList.add("list"),t.setAttribute("data-node-id",a),t.setAttribute("data-type","NodeList"),e.type==="Blocks2ULs"?t.setAttribute("data-subtype","u"):e.type==="Blocks2OLs"?t.setAttribute("data-subtype","o"):t.setAttribute("data-subtype","t");let r="";e.selectsElement.forEach((c,d)=>{e.type==="Blocks2ULs"?r+=`<div data-marker="*" data-subtype="u" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div class="protyle-action" draggable="true"><svg><use xlink:href="#iconDot"></use></svg></div><div class="protyle-attr" contenteditable="false"></div></div>`:e.type==="Blocks2OLs"?r+=`<div data-marker="${d+1}." data-subtype="o" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div class="protyle-action protyle-action--order" contenteditable="false" draggable="true">${d+1}.</div><div class="protyle-attr" contenteditable="false"></div></div>`:r+=`<div data-marker="*" data-subtype="t" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#iconUncheck"></use></svg></div><div class="protyle-attr" contenteditable="false"></div></div>`}),t.innerHTML=r+'<div class="protyle-attr" contenteditable="false"></div>'}const n=e.selectsElement[0].getAttribute("data-node-id"),o=e.selectsElement[0].parentElement.getAttribute("data-node-id")||e.protyle.block.parentID,i=[{action:"insert",id:a,data:t.outerHTML,nextID:n,parentID:o}],s=[];e.selectsElement[0].previousElementSibling?e.selectsElement[0].before(t):e.selectsElement[0].parentElement.prepend(t);let l;e.selectsElement.forEach((r,c)=>{r.classList.remove("protyle-wysiwyg--select"),r.removeAttribute("select-start"),r.removeAttribute("select-end");const d=r.getAttribute("data-node-id");s.push({action:"move",id:d,previousID:l||a,parentID:o}),e.type.endsWith("Ls")?(i.push({action:"move",id:d,parentID:t.children[c].getAttribute("data-node-id")}),t.children[c].firstElementChild.after(r)):(i.push({action:"move",id:d,previousID:l,parentID:a}),t.lastElementChild.before(r)),l=r.getAttribute("data-node-id"),c===e.selectsElement.length-1&&s.push({action:"delete",id:a}),r.getAttribute("data-type")==="NodeBlockQueryEmbed"&&(r.removeAttribute("data-render"),blockRender(e.protyle,r))}),wt(e.protyle,i,s),focusBlock(e.protyle.wysiwyg.element.querySelector(`[data-node-id="${e.selectsElement[0].getAttribute("data-node-id")}"]`)),hideElements(["gutter"],e.protyle)},Zs=(e,t)=>{const a=document.createElement("template");a.innerHTML=e,Array.from(a.content.children).forEach(n=>{var o;(o=t.wysiwyg.element.querySelector(`:scope > [data-node-id="${n.getAttribute("data-node-id")}"]`))==null||o.remove()})},Rf=e=>{let t=e.selectsElement,a;if(e.nodeElement){a=getSelection().getRangeAt(0),a.insertNode(document.createElement("wbr")),t=Array.from(e.protyle.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select")),t.length===0&&(t=[e.nodeElement]);let l=!1,r=!1,c=!1;if(t.find((d,u)=>{if(d.classList.contains("li"))return c=!0,!0;if((d.classList.contains("bq")||d.classList.contains("sb")||d.classList.contains("p"))&&(r=!0),d.nextElementSibling&&t[u+1]&&d.nextElementSibling.isSameNode(t[u+1]))l=!0;else if(u!==t.length-1)return l=!1,!0}),c||r&&e.type==="Blocks2Ps")return;t.length===1&&e.type==="Blocks2Hs"&&t[0].getAttribute("data-type")==="NodeHeading"&&e.level===parseInt(t[0].getAttribute("data-subtype").substr(1))&&(e.type="Blocks2Ps"),e.isContinue=l}let n="";const o=[],i=[],s=document.createElement("div");t.forEach((l,r)=>{var c,d,u;(e.type==="Blocks2Ps"||e.type==="Blocks2Hs")&&l.getAttribute("data-type")==="NodeHeading"&&l.getAttribute("fold")==="1"&&setFold(e.protyle,l,void 0,void 0,!1),l.classList.remove("protyle-wysiwyg--select"),l.removeAttribute("select-start"),l.removeAttribute("select-end"),n+=l.outerHTML;const g=l.getAttribute("data-node-id");i.push({action:"update",id:g,data:l.outerHTML,parentID:((c=l.parentElement)==null?void 0:c.getAttribute("data-node-id"))||e.protyle.block.parentID||e.protyle.block.rootID,previousID:((d=i[i.length-1])==null?void 0:d.id)||((u=l.previousElementSibling)==null?void 0:u.getAttribute("data-node-id"))}),e.isContinue?r===t.length-1?(s.innerHTML=e.protyle.lute[e.type](n,e.level),l.outerHTML=s.innerHTML):l.remove():l.outerHTML=e.protyle.lute[e.type](l.outerHTML,e.level)}),i.forEach(l=>{const r=e.protyle.wysiwyg.element.querySelector(`[data-node-id="${l.id}"]`);r?o.push({action:"update",id:l.id,data:r.outerHTML}):(l.action="insert",o.push({action:"delete",id:l.id}))}),Array.from(s.children).forEach(l=>{var r,c;const d=l.getAttribute("data-node-id");let u=!1;i.find(g=>{if(d===g.id)return u=!0,!0}),u||(o.push({action:"insert",id:d,previousID:((r=l.previousElementSibling)==null?void 0:r.getAttribute("data-node-id"))||i[0].previousID,data:l.outerHTML,parentID:((c=l.parentElement)==null?void 0:c.getAttribute("data-node-id"))||e.protyle.block.parentID||e.protyle.block.rootID}),i.splice(0,0,{action:"delete",id:d}))}),wt(e.protyle,o,i),processRender(e.protyle.wysiwyg.element),highlightRender(e.protyle.wysiwyg.element),avRender(e.protyle.wysiwyg.element,e.protyle),blockRender(e.protyle,e.protyle.wysiwyg.element),a||e.range?focusByWbr(e.protyle.wysiwyg.element,a||e.range):focusBlock(e.protyle.wysiwyg.element.querySelector(`[data-node-id="${t[0].getAttribute("data-node-id")}"]`)),hideElements(["gutter"],e.protyle)},Of=e=>Il(void 0,null,function*(){var t,a;if(e.nodeElement.querySelector("wbr")||(t=getContenteditableElement(e.nodeElement))==null||t.insertAdjacentHTML("afterbegin","<wbr>"),e.type==="CancelList"||e.type==="CancelBlockquote")try{for(var n=Ml(e.nodeElement.querySelectorAll('[data-type="NodeHeading"][fold="1"]')),o,i,s;o=!(i=yield n.next()).done;o=!1){const u=i.value,g=u.getAttribute("data-node-id");u.removeAttribute("fold");const f=yield fetchSyncPost("/api/transactions",{session:e.protyle.id,app:Constants.SIYUAN_APPID,transactions:[{doOperations:[{action:"unfoldHeading",id:g}],undoOperations:[{action:"foldHeading",id:g}]}]});e.protyle.undo.add([{action:"unfoldHeading",id:g}],[{action:"foldHeading",id:g}],e.protyle),u.insertAdjacentHTML("afterend",f.data[0].doOperations[0].retData)}}catch(u){s=[u]}finally{try{o&&(i=n.return)&&(yield i.call(n))}finally{if(s)throw s[0]}}const l=e.nodeElement.outerHTML,r=(a=e.nodeElement.previousElementSibling)==null?void 0:a.getAttribute("data-node-id"),c=e.nodeElement.parentElement.getAttribute("data-node-id")||e.protyle.block.parentID,d=e.protyle.lute[e.type](e.nodeElement.outerHTML,e.level);if(e.nodeElement.outerHTML=d,e.type==="CancelList"||e.type==="CancelBlockquote"){const u=document.createElement("template");u.innerHTML=d;const g=[{action:"delete",id:e.id}],f=[];let p=r;Array.from(u.content.children).forEach(m=>{const b=m.getAttribute("data-node-id");g.push({action:"insert",data:m.outerHTML,id:b,previousID:p,parentID:c}),f.push({action:"delete",id:b}),p=b}),f.push({action:"insert",data:l,id:e.id,previousID:r,parentID:c}),wt(e.protyle,g,f)}else Vt(e.protyle,e.id,d,l);focusByWbr(e.protyle.wysiwyg.element,getEditorRange(e.protyle.wysiwyg.element)),e.protyle.wysiwyg.element.querySelectorAll('[data-type~="block-ref"]').forEach(u=>{u.textContent===""&&fetchPost("/api/block/getRefText",{id:u.getAttribute("data-id")},g=>{u.innerHTML=g.data})}),blockRender(e.protyle,e.protyle.wysiwyg.element),processRender(e.protyle.wysiwyg.element),highlightRender(e.protyle.wysiwyg.element),avRender(e.protyle.wysiwyg.element,e.protyle)});let Xs;const wt=(e,t,a)=>{if(t.length===0)return;if(!e){he("/api/transactions",{session:S.SIYUAN_APPID,app:S.SIYUAN_APPID,transactions:[{doOperations:t}]});return}const n=window.siyuan.transactions[window.siyuan.transactions.length-1];let o=!1;const i=new Date().getTime();if(n&&n.doOperations.length===1&&n.doOperations[0].action==="update"&&t.length===1&&t[0].action==="update"&&n.doOperations[0].id===t[0].id&&e.transactionTime-i<S.TIMEOUT_INPUT&&(o=!0),a&&(window.siyuan.config.fileTree.openFilesUseCurrentTab&&e.model&&e.model.headElement.classList.remove("item--unupdate"),e.updated=!0,o?e.undo.replace(t,e):e.undo.add(t,a,e)),window.clearTimeout(Xs),t.length===1&&(t[0].action==="unfoldHeading"||t[0].action==="setAttrs"&&t[0].data.startsWith('{"fold":'))){e.transactionTime=i+S.TIMEOUT_INPUT*2,he("/api/transactions",{session:e.id,app:S.SIYUAN_APPID,transactions:[{doOperations:t,undoOperations:a}]},s=>{s.data[0].doOperations.forEach(l=>{if(l.action==="unfoldHeading"||l.action==="foldHeading")Js(l,e);else if(l.action==="setAttrs"){const r=e.gutter.element.querySelector('[data-type="fold"]');r&&r.removeAttribute("disabled"),e.wysiwyg.element.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(c=>{c.querySelector(`[data-node-id="${l.id}"]`)&&(c.removeAttribute("data-render"),Ge(e,c))})}})});return}o?(window.siyuan.transactions[window.siyuan.transactions.length-1].protyle=e,window.siyuan.transactions[window.siyuan.transactions.length-1].doOperations=t):window.siyuan.transactions.push({protyle:e,doOperations:t,undoOperations:a}),e.transactionTime=i,Xs=window.setTimeout(()=>{Gs()},S.TIMEOUT_INPUT*2),t.find(s=>{var l;if(s.action==="insert")return(l=e.observerLoad)==null||l.disconnect(),!0})},Js=(e,t)=>{if(e.action==="unfoldHeading"||e.action==="foldHeading"){const a=t.gutter.element.querySelector('[data-type="fold"]');if(a&&a.removeAttribute("disabled"),e.action==="unfoldHeading"){const n=t.contentElement.scrollTop;t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`).forEach(o=>{const i=le(o);if(i){i.removeAttribute("data-render"),Ge(t,i);return}if(o.lastElementChild.classList.contains("protyle-attr")||o.lastElementChild.remove(),Zs(e.retData,t),o.insertAdjacentHTML("afterend",e.retData),e.data==="remove"){const s=getSelection();s.rangeCount>0&&o.contains(s.getRangeAt(0).startContainer)&&Re(o.nextElementSibling,void 0,!0),o.remove()}}),t.disabled&&Ea(t),Lt(t.wysiwyg.element),_t(t.wysiwyg.element),Je(t.wysiwyg.element,t),Ge(t,t.wysiwyg.element),t.contentElement.scrollTop=n,t.scroll.lastScrollTop=n;return}t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`).forEach(n=>{const o=le(n);o&&(o.removeAttribute("data-render"),Ge(t,o))}),t.wysiwyg.element.lastElementChild.getAttribute("data-eof")!=="2"&&!t.scroll.element.classList.contains("fn__none")&&t.contentElement.scrollHeight-t.contentElement.scrollTop<t.contentElement.clientHeight*2&&he("/api/filetree/getDoc",{id:t.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),mode:2,size:window.siyuan.config.editor.dynamicLoadBlocks},n=>{Wt({data:n,protyle:t,action:[S.CB_GET_APPEND,S.CB_GET_UNCHANGEID]})});return}},Vt=(e,t,a,n)=>{a!==n&&wt(e,[{id:t,data:a,action:"update"}],[{id:t,data:n,action:"update"}])},Dl=(e,t,a)=>{const n=[],o=[];e.forEach(i=>{const s=i.getAttribute("data-node-id");i.classList.remove("protyle-wysiwyg--select"),i.removeAttribute("select-start"),i.removeAttribute("select-end"),o.push({action:"update",id:s,data:i.outerHTML}),a(i),n.push({action:"update",id:s,data:i.outerHTML})}),wt(t,n,o)},qf=(e,t)=>{const a=hasClosestByClassName(e,"av__row");if(!a)return;const n=e.querySelector("use");a.classList.contains("av__row--header")||t==="unselectAll"?n.getAttribute("xlink:href")==="#iconCheck"||t==="unselectAll"?a.parentElement.querySelectorAll(".av__firstcol").forEach(o=>{o.querySelector("use").setAttribute("xlink:href","#iconUncheck");const i=hasClosestByClassName(o,"av__row");i&&i.classList.remove("av__row--select")}):a.parentElement.querySelectorAll(".av__firstcol").forEach(o=>{o.querySelector("use").setAttribute("xlink:href","#iconCheck");const i=hasClosestByClassName(o,"av__row");i&&i.classList.add("av__row--select")}):t==="select"||n.getAttribute("xlink:href")==="#iconUncheck"&&t==="toggle"?(a.classList.add("av__row--select"),n.setAttribute("xlink:href","#iconCheck")):(t==="unselect"||n.getAttribute("xlink:href")==="#iconCheck"&&t==="toggle")&&(a.classList.remove("av__row--select"),n.setAttribute("xlink:href","#iconUncheck")),focusBlock(hasClosestBlock(a)),kn(a)},kn=e=>{const t=oe(e);if(!t)return;const a=e.parentElement.querySelectorAll(".av__row--select:not(.av__row--header)").length,n=e.parentElement.childElementCount-3-a,o=e.parentElement.firstElementChild,i=o.querySelector("use"),s=t.querySelector(".av__counter"),l=t.querySelector(".av__header");if(n===0&&e.parentElement.childElementCount-3!==0)o.classList.add("av__row--select"),i.setAttribute("xlink:href","#iconCheck");else if(n===e.parentElement.childElementCount-3){o.classList.remove("av__row--select"),i.setAttribute("xlink:href","#iconUncheck"),s.classList.add("fn__none"),l.style.position="";return}else n>0&&(o.classList.add("av__row--select"),i.setAttribute("xlink:href","#iconIndeterminateCheck"));s.classList.remove("fn__none"),s.innerHTML=`${a} ${window.siyuan.languages.selected}`,l.style.position="sticky"},Qs=e=>{const t=parseInt(e.getAttribute("data-page-size"));if(t){const a=e.querySelectorAll(".av__row:not(.av__row--header)").length;t<a&&e.setAttribute("data-page-size",a.toString())}},$l=(e,t,a,n,o)=>{if(t.querySelector('[data-type="av-search"]').value!==""){showMessage(window.siyuan.languages.insertRowTip);return}let i=t.querySelector(`.av__row[data-id="${n}"]`)||t.querySelector(".av__row--header");t.querySelector('.av__views [data-type="av-sort"]').classList.contains("block__icon--active")&&(i=t.querySelector(".av__row--util").previousElementSibling);let s='<div class="av__colsticky"><div class="av__firstcol"><svg><use xlink:href="#iconUncheck"></use></svg></div></div>';const l=i.querySelectorAll(".av__colsticky .av__cell").length-1;l>-1&&(s='<div class="av__colsticky"><div class="av__firstcol"><svg><use xlink:href="#iconUncheck"></use></svg></div>'),i.querySelectorAll(".av__cell").forEach((c,d)=>{var u;let g="";if(getTypeByCellElement(c)==="lineNumber"){const f=(u=c.querySelector(".av__celltext"))==null?void 0:u.getAttribute("data-value");f&&(g=(parseInt(f)+1).toString())}s+=`<div class="av__cell" data-col-id="${c.dataset.colId}" 
style="width: ${c.style.width};${c.dataset.dtype==="number"?"text-align: right;":""}" 
${getTypeByCellElement(c)==="block"?' data-detached="true"':""}><span class="${o?"av__celltext":"av__pulse"}">${g}</span></div>`,l===d&&(s+="</div>")});let r="";if(a.forEach(c=>{const d=t.querySelector(`[data-block-id="${c}"]`);d?(t.querySelectorAll(".av__cell--select, .av__cell--active").forEach(u=>{var g;u.classList.remove("av__cell--select","av__cell--active"),(g=u.querySelector(".av__drag-fill"))==null||g.remove()}),addDragFill(d),d.classList.add("av__cell--select")):r+=`<div class="av__row" data-type="ghost" data-id="${c}" data-avid="${o}" data-previous-id="${n}">
    ${s}
</div>`}),i.insertAdjacentHTML("afterend",r),o){const c=i.nextElementSibling;t.querySelector('.av__views [data-type="av-sort"]').classList.contains("block__icon--active")&&!t.querySelector('[data-type="av-load-more"]').classList.contains("fn__none")&&c.setAttribute("data-need-update","true");const d=i.classList.contains("av__row--header")?c.nextElementSibling:i;fetchPost("/api/av/getAttributeViewFilterSort",{id:o,blockID:t.getAttribute("data-node-id")},u=>{let g=!1;u.data.filters.find(f=>{const p=t.querySelector(`.av__cell--header[data-col-id="${f.column}"]`);if(!p)return;const m=p.getAttribute("data-dtype");if(f.value&&m!==f.value.type)return;if(["relation","rollup","template"].includes(m))return g=!0,!0;["created","updated"].includes(m)?c.setAttribute("data-need-update","true"):u.data.sorts.find(w=>{if(w.column===f.column)return c.setAttribute("data-need-update","true"),!0});let b=!0;if(f.operator!=="Is empty"&&f.operator!=="Is not empty")switch(f.value.type){case"select":case"mSelect":(!f.value.mSelect||f.value.mSelect.length===0)&&(b=!1);break;case"block":(!f.value.block||!f.value.block.content)&&(b=!1);break;case"number":(!f.value.number||!f.value.number.isNotEmpty)&&(b=!1);break;case"date":case"created":case"updated":(!f.value[f.value.type]||!f.value[f.value.type].isNotEmpty)&&(b=!1);break;case"mAsset":(!f.value.mAsset||f.value.mAsset.length===0)&&(b=!1);break;case"checkbox":f.value.checkbox||(b=!1);break;case"text":case"url":case"phone":case"email":(!f.value[f.value.type]||!f.value[f.value.type].content)&&(b=!1);break}if(d.classList.contains("av__row")&&b){const w=d.querySelector(`.av__cell[data-col-id="${f.column}"]`),y=c.querySelector(`.av__cell[data-col-id="${f.column}"]`),_=genCellValueByElement(getTypeByCellElement(w),w);y.innerHTML=renderCell(_),renderCellAttr(y,_)}}),g?(c.remove(),showMessage(window.siyuan.languages.insertRowTip)):a.length===1&&popTextCell(e,[c.querySelector('.av__cell[data-detached="true"]')],"block"),Qs(t)})}Qs(t)},ka=(e,t,a)=>{const n=e.querySelector(".av__scroll").getBoundingClientRect(),o=e.querySelector(".av__row--header");if(o&&(a==="top"||a==="all")){const s=Math.floor(t.top-n.top);s>0&&s<n.height?o.style.transform=`translateY(${s}px)`:o.style.transform=""}const i=e.querySelector(".av__row--footer");if(i&&(a==="bottom"||a==="all"))if(i.querySelector(".av__calc--ashow")){const s=Math.ceil(t.bottom-i.parentElement.getBoundingClientRect().bottom);s<0&&-s<n.height?i.style.transform=`translateY(${s}px)`:i.style.transform=""}else i.style.transform=""},Gt=e=>{var t;if(e.currentPageSize===e.newPageSize)return;e.nodeElement.setAttribute("data-page-size",e.newPageSize);const a=e.nodeElement.getAttribute("data-node-id");transaction(e.protyle,[{action:"setAttrViewPageSize",avID:e.avID,data:parseInt(e.newPageSize),blockID:a}],[{action:"setAttrViewPageSize",data:parseInt(e.currentPageSize),avID:e.avID,blockID:a}]),(t=document.querySelector(".av__panel"))==null||t.remove()},Uf=e=>{const t=new Menu("av-page-size");if(t.isOpen)return;const a=e.target.dataset.size;t.addItem({iconHTML:"",label:"10",checked:a==="10",click(){Gt({currentPageSize:a,newPageSize:"10",protyle:e.protyle,avID:e.avID,nodeElement:e.nodeElement})}}),t.addItem({iconHTML:"",checked:a==="25",label:"25",click(){Gt({currentPageSize:a,newPageSize:"25",protyle:e.protyle,avID:e.avID,nodeElement:e.nodeElement})}}),t.addItem({iconHTML:"",checked:a==="50",label:"50",click(){Gt({currentPageSize:a,newPageSize:"50",protyle:e.protyle,avID:e.avID,nodeElement:e.nodeElement})}}),t.addItem({iconHTML:"",checked:a==="100",label:"100",click(){Gt({currentPageSize:a,newPageSize:"100",protyle:e.protyle,avID:e.avID,nodeElement:e.nodeElement})}}),t.addItem({iconHTML:"",checked:a===Constants.SIZE_DATABASE_MAZ_SIZE.toString(),label:window.siyuan.languages.all,click(){Gt({currentPageSize:a,newPageSize:Constants.SIZE_DATABASE_MAZ_SIZE.toString(),protyle:e.protyle,avID:e.avID,nodeElement:e.nodeElement})}});const n=e.target.getBoundingClientRect();t.open({x:n.left,y:n.bottom})},Ff=(e,t)=>{const a=e.querySelectorAll(".av__row--select:not(.av__row--header)");if(a.length===0)return;const n=e.getAttribute("data-av-id"),o=[],i=[];a.forEach(l=>{i.push(l.querySelector(".av__cell[data-block-id]").getAttribute("data-block-id"))}),a.forEach(l=>{var r;const c=genCellValueByElement("block",l.querySelector(".av__cell[data-block-id]"));o.push({action:"insertAttrViewBlock",avID:n,previousID:((r=l.previousElementSibling)==null?void 0:r.getAttribute("data-id"))||"",srcs:[{id:l.getAttribute("data-id"),isDetached:c.isDetached,content:c.block.content}],blockID:e.dataset.nodeId})});const s=dayjs().format("YYYYMMDDHHmmss");o.push({action:"doUpdateUpdated",id:e.dataset.nodeId,data:e.getAttribute("updated")}),transaction(t,[{action:"removeAttrViewBlock",srcIDs:i,avID:n},{action:"doUpdateUpdated",id:e.dataset.nodeId,data:s}],o),a.forEach(l=>{l.remove()}),ka(e,t.contentElement.getBoundingClientRect(),"all"),kn(e.querySelector(".av__row")),e.setAttribute("updated",s)},Yf=(e,t,a,n)=>{const o=e.getAttribute("data-av-id"),i=[],s=[];new Array(a).fill(0).forEach(()=>{const r=Lute.NewNodeID();i.push(r),s.push({id:r,isDetached:!0,content:""})});const l=dayjs().format("YYYYMMDDHHmmss");transaction(t,[{action:"insertAttrViewBlock",avID:o,previousID:n,srcs:s,blockID:e.dataset.nodeId},{action:"doUpdateUpdated",id:e.dataset.nodeId,data:l}],[{action:"removeAttrViewBlock",srcIDs:i,avID:o},{action:"doUpdateUpdated",id:e.dataset.nodeId,data:e.getAttribute("updated")}]),$l(t,e,i,n,o),e.setAttribute("updated",l)},Wf=()=>{getAllModels().editor.forEach(e=>{var t;if(e.editor&&e.editor.protyle&&e.element.parentElement&&!e.element.classList.contains("fn__none")){(t=e.editor.protyle.wysiwyg.element.querySelector("[data-resize-top]"))==null||t.removeAttribute("data-resize-top");const a=e.editor.protyle.contentElement.getBoundingClientRect();let n=document.elementFromPoint(a.left+a.width/2,a.top);if(n||(n=document.elementFromPoint(a.left+a.width/2,a.top+17)),!n||(n=hasClosestBlock(n),!n))return;n.setAttribute("data-resize-top",n.getBoundingClientRect().top.toString())}})},jf=e=>{hideElements(["gutterOnly"],e);const t=setPadding(e),a=4;setTimeout(()=>{if(e.scroll&&e.scroll.element.parentElement.getAttribute("style")&&e.scroll.element.parentElement.setAttribute("style",`--b3-dynamicscroll-width:${Math.min(e.contentElement.clientHeight-49,200)}px`),!e.disabled){const o=e.contentElement.getBoundingClientRect();e.wysiwyg.element.querySelectorAll(".av").forEach(i=>{i.querySelector(".av__title")&&stickyRow(i,o,"all")})}(t.width>a||isNaN(t.width))&&typeof window.echarts!="undefined"&&e.wysiwyg.element.querySelectorAll('[data-subtype="echarts"], [data-subtype="mindmap"]').forEach(o=>{const i=window.echarts.getInstanceById(o.firstElementChild.nextElementSibling.getAttribute("_echarts_instance_"));i&&i.resize()}),e.wysiwyg.element.querySelectorAll(".code-block .protyle-linenumber__rows").forEach(o=>{o.nextElementSibling.style.wordBreak==="break-word"&&lineNumberRender(o.parentElement)});const n=e.wysiwyg.element.querySelector("[data-resize-top]");n&&(n.scrollIntoView(),e.contentElement.scrollTop+=n.getBoundingClientRect().top-parseInt(n.getAttribute("data-resize-top")),n.removeAttribute("data-resize-top"))},Constants.TIMEOUT_TRANSITION+100)},Vf=(e,t)=>{var a,n,o,i;if(t==="preview"){if(!e.preview.element.classList.contains("fn__none"))return;e.preview.element.classList.remove("fn__none"),e.contentElement.classList.add("fn__none"),(a=e.scroll)==null||a.element.classList.add("fn__none"),e.options.render.breadcrumb&&((n=e.breadcrumb)==null||n.element.classList.add("fn__none"),e.breadcrumb.toggleExit(!0)),e.preview.render(e)}else if(t==="wysiwyg"){if(!e.contentElement.classList.contains("fn__none"))return;e.preview.element.classList.add("fn__none"),e.contentElement.classList.remove("fn__none"),e.options.render.scroll&&((o=e.scroll)==null||o.element.classList.remove("fn__none")),e.options.render.breadcrumb&&((i=e.breadcrumb)==null||i.element.classList.remove("fn__none"),e.breadcrumb.toggleExit(!e.block.showAll)),resize(e)}hideElements(["gutterOnly","toolbar","select","hint","util"],e)};let ei;const Gf=(e,t)=>{t.addEventListener("scroll",()=>{const a=t.getBoundingClientRect();if(!e.toolbar.element.classList.contains("fn__none")){const n=e.toolbar.element.getAttribute("data-inity").split(Constants.ZWSP),o=parseInt(n[0])+(parseInt(n[1])-t.scrollTop);o<a.top-e.toolbar.toolbarHeight||o>a.bottom-e.toolbar.toolbarHeight?e.toolbar.element.style.display="none":(e.toolbar.element.style.top=o+"px",e.toolbar.element.style.display="")}e.wysiwyg.element.querySelectorAll(".av").forEach(n=>{n.dataset.render==="true"&&stickyRow(n,a,"all")}),!e.element.classList.contains("block__edit")&&!isMobile()&&e.contentElement.setAttribute("data-scrolltop",t.scrollTop.toString()),window.siyuan.dragElement||hideElements(["gutterOnly"],e),e.scroll&&!e.scroll.element.classList.contains("fn__none")&&(clearTimeout(ei),ei=window.setTimeout(()=>{let n=document.elementFromPoint(a.left+a.width/2,a.top+10);n.classList.contains("protyle-wysiwyg")&&(n=document.elementFromPoint(a.left+a.width/2,a.top+20));const o=hasClosestBlock(n);if(!o){if((e.wysiwyg.element.firstElementChild.getAttribute("data-eof")==="1"||e.wysiwyg.element.firstElementChild.getAttribute("data-node-index")==="0")&&(hasClosestByClassName(n,"protyle-background")||hasClosestByClassName(n,"protyle-title"))){const i=e.scroll.element.querySelector(".b3-slider");i.value="1",e.scroll.element.setAttribute("aria-label",`Blocks 1/${e.block.blockCount}`)}return}e.scroll.updateIndex(e,o.getAttribute("data-node-id"))},Constants.TIMEOUT_LOAD)),!(e.wysiwyg.element.getAttribute("data-top")||e.block.showAll||e.scroll&&e.scroll.element.classList.contains("fn__none")||!e.scroll||e.scroll.lastScrollTop===t.scrollTop||e.scroll.lastScrollTop===-1||!e.wysiwyg.element.firstElementChild)&&(e.scroll.lastScrollTop-t.scrollTop>0?t.scrollTop<t.clientHeight&&e.wysiwyg.element.firstElementChild.getAttribute("data-eof")!=="1"&&(e.contentElement.style.width=e.contentElement.offsetWidth+"px",e.contentElement.style.overflow="hidden",e.wysiwyg.element.setAttribute("data-top",t.scrollTop.toString()),fetchPost("/api/filetree/getDoc",{id:e.wysiwyg.element.firstElementChild.getAttribute("data-node-id"),mode:1,size:window.siyuan.config.editor.dynamicLoadBlocks},n=>{e.contentElement.style.overflow="",e.contentElement.style.width="",onGet({data:n,protyle:e,action:[Constants.CB_GET_BEFORE,Constants.CB_GET_UNCHANGEID]})})):t.scrollTop>t.scrollHeight-t.clientHeight*1.8&&e.wysiwyg.element.lastElementChild&&e.wysiwyg.element.lastElementChild.getAttribute("data-eof")!=="2"&&(e.wysiwyg.element.setAttribute("data-top",t.scrollTop.toString()),fetchPost("/api/filetree/getDoc",{id:e.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),mode:2,size:window.siyuan.config.editor.dynamicLoadBlocks},n=>{onGet({data:n,protyle:e,action:[Constants.CB_GET_APPEND,Constants.CB_GET_UNCHANGEID]})})),e.scroll.lastScrollTop=Math.max(t.scrollTop,0))},{capture:!1,passive:!0,once:!1})},Kf=e=>{e.contentElement=document.createElement("div"),e.contentElement.className="protyle-content",(e.options.render.background||e.options.render.title)&&(e.contentElement.innerHTML='<div class="protyle-top"></div>',e.options.render.background&&e.contentElement.firstElementChild.appendChild(e.background.element),e.options.render.title&&e.contentElement.firstElementChild.appendChild(e.title.element)),e.contentElement.appendChild(e.wysiwyg.element),e.options.action.includes(Constants.CB_GET_HISTORY)||scrollEvent(e,e.contentElement),e.element.append(e.contentElement),e.element.appendChild(e.preview.element),e.upload&&e.element.appendChild(e.upload.element),e.options.render.scroll&&e.element.appendChild(e.scroll.element.parentElement),e.gutter&&e.element.appendChild(e.gutter.element),e.element.appendChild(e.hint.element),e.selectElement=document.createElement("div"),e.selectElement.className="protyle-select fn__none",e.element.appendChild(e.selectElement),e.element.appendChild(e.toolbar.element),e.element.appendChild(e.toolbar.subElement),e.element.append(e.highlight.styleElement),Hl(e),setEditMode(e,e.options.mode),document.execCommand("DefaultParagraphSeparator",!1,"p");let t;const a=genUUID(),n=isMac();e.contentElement.addEventListener("mousewheel",i=>{if(!(!window.siyuan.config.editor.fontSizeScrollZoom||n&&!i.metaKey||!n&&!i.ctrlKey||i.deltaX!==0)){if(i.stopPropagation(),i.deltaY<0)if(window.siyuan.config.editor.fontSize<72)window.siyuan.config.editor.fontSize++;else return;else if(i.deltaY>0)if(window.siyuan.config.editor.fontSize>9)window.siyuan.config.editor.fontSize--;else return;setInlineStyle(),clearTimeout(t),showMessage(`${window.siyuan.languages.fontSize} ${window.siyuan.config.editor.fontSize}px<span class="fn__space"></span>
<button class="b3-button b3-button--white">${window.siyuan.languages.reset} 16px</button>`,void 0,void 0,a),t=window.setTimeout(()=>{var s;fetchPost("/api/setting/setEditor",window.siyuan.config.editor),e.wysiwyg.element.querySelectorAll(".code-block .protyle-linenumber__rows").forEach(l=>{lineNumberRender(l.parentElement)}),(s=document.querySelector(`#message [data-id="${a}"] button`))==null||s.addEventListener("click",()=>{window.siyuan.config.editor.fontSize=16,setInlineStyle(),fetchPost("/api/setting/setEditor",window.siyuan.config.editor),hideMessage(a),e.wysiwyg.element.querySelectorAll(".code-block .protyle-linenumber__rows").forEach(l=>{lineNumberRender(l.parentElement)})})},Constants.TIMEOUT_LOAD)}},{passive:!0}),e.contentElement.addEventListener("click",i=>{if(e.disabled||e.contentElement.querySelector(".protyle-wysiwyg--select")||!i.target.classList.contains("protyle-content")&&!i.target.classList.contains("protyle-wysiwyg"))return;if(window.getSelection().rangeCount>0){const r=window.getSelection().getRangeAt(0);if(r.toString()!==""&&e.wysiwyg.element.contains(r.startContainer))return}const s=e.wysiwyg.element.lastElementChild.getBoundingClientRect(),l=document.createRange();if(i.y>s.bottom){const r=getContenteditableElement(getLastBlock(e.wysiwyg.element.lastElementChild));if(!r||e.wysiwyg.element.lastElementChild.getAttribute("data-type")!=="NodeParagraph"&&e.wysiwyg.element.getAttribute("data-doc-type")!=="NodeListItem"&&!e.options.backlinkData||e.wysiwyg.element.lastElementChild.getAttribute("data-type")==="NodeParagraph"&&getContenteditableElement(r).innerHTML!==""){const c=genEmptyElement(!1,!1);e.wysiwyg.element.insertAdjacentElement("beforeend",c),transaction(e,[{action:"insert",data:c.outerHTML,id:c.getAttribute("data-node-id"),previousID:c.previousElementSibling.getAttribute("data-node-id"),parentID:e.block.parentID}],[{action:"delete",id:c.getAttribute("data-node-id")}]);const d=getContenteditableElement(c);l.selectNodeContents(d),l.collapse(!0),focusByRange(l),e.options.render.breadcrumb&&setTimeout(()=>{e.breadcrumb.render(e)},Constants.TIMEOUT_TRANSITION)}else r&&(l.selectNodeContents(r),l.collapse(!1),focusByRange(l))}});let o=!1;e.element.addEventListener("mouseover",i=>{const s=hasClosestByClassName(i.target,"protyle-attr");if(s&&!s.parentElement.classList.contains("protyle-title")){const c=e.wysiwyg.element.querySelector(".protyle-wysiwyg--hl");c&&c.classList.remove("protyle-wysiwyg--hl"),o=!0,s.parentElement.classList.add("protyle-wysiwyg--hl");return}else if(o){const c=e.wysiwyg.element.querySelector(".protyle-wysiwyg--hl");c&&c.classList.remove("protyle-wysiwyg--hl"),o=!1}const l=hasClosestBlock(i.target);if(e.options.render.gutter&&l){if(l&&(l.classList.contains("list")||l.classList.contains("li")))return;const c=isInEmbedBlock(l);c?e.gutter.render(e,c,e.wysiwyg.element):e.gutter.render(e,l,e.wysiwyg.element,i.target);return}const r=hasClosestByTag(i.target,"BUTTON");if(r&&r.parentElement.classList.contains("protyle-gutters")){const c=r.getAttribute("data-type");if(c==="fold"||c==="NodeAttributeViewRow"){Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl, .av__row--hl")).forEach(d=>{d.classList.remove("protyle-wysiwyg--hl","av__row--hl")});return}Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${r.getAttribute("data-node-id")}"]`)).find(d=>{if(!isInEmbedBlock(d)&&e.gutter.isMatchNode(d)){const u=d.querySelector(`.av__row[data-id="${r.dataset.rowId}"]`);return Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl, .av__row--hl")).forEach(g=>{d.isSameNode(g)||g.classList.remove("protyle-wysiwyg--hl"),u&&!u.isSameNode(g)&&u.classList.remove("av__row--hl")}),c==="NodeAttributeViewRowMenu"?u.classList.add("av__row--hl"):d.classList.add("protyle-wysiwyg--hl"),!0}}),i.preventDefault();return}})},Hl=(e,t)=>{e.element.removeAttribute("data-loading"),setTimeout(()=>{e.element.getAttribute("data-loading")!=="finished"&&e.element.insertAdjacentHTML("beforeend",`<div style="background-color: var(--b3-theme-background);flex-direction: column;" class="fn__loading wysiwygLoading">
    <img width="48px" src="/stage/loading-pure.svg">
    <div style="color: var(--b3-theme-on-surface);margin-top: 8px;">${t||""}</div>
</div>`)},Constants.TIMEOUT_LOAD)},ti=e=>{e.element.setAttribute("data-loading","finished"),e.element.querySelectorAll(".wysiwygLoading").forEach(t=>{t.remove()})},zf=e=>{if(e.options.action.includes(Constants.CB_GET_HISTORY))return{width:0,padding:0};const t=parseInt(e.wysiwyg.element.style.paddingLeft),a=Nl(e),n=a.left,o=a.right;if(e.options.backlinkData?e.wysiwyg.element.style.padding=`4px ${o}px 4px ${n}px`:e.wysiwyg.element.style.padding=`${a.top}px ${o}px ${a.bottom}px ${n}px`,e.options.render.background&&e.background.element.querySelector(".protyle-background__ia").setAttribute("style",`margin-left:${n}px;margin-right:${o}px`),e.options.render.title&&(e.title.element.style.margin=`16px ${o}px 0 ${n}px`),window.siyuan.config.editor.displayBookmarkIcon){const l=document.getElementById("editorAttr");l&&(l.innerHTML=`.protyle-wysiwyg--attr .b3-tooltips::after { max-width: ${e.wysiwyg.element.clientWidth-n-o}px; }`)}const i=e.wysiwyg.element.getAttribute("data-realwidth"),s=e.wysiwyg.element.clientWidth-parseInt(e.wysiwyg.element.style.paddingLeft)-parseInt(e.wysiwyg.element.style.paddingRight);return e.wysiwyg.element.setAttribute("data-realwidth",s.toString()),{width:Math.abs(parseInt(i)-s),padding:Math.abs(t-parseInt(e.wysiwyg.element.style.paddingLeft))}},Nl=e=>{let t=16,a=24,n=16;if(e.options.typewriterMode&&(isMobile()?n=window.innerHeight/5:n=e.element.clientHeight/2),!isMobile()){let o=e.wysiwyg.element.getAttribute(Constants.CUSTOM_SY_FULLWIDTH);o||(o=window.siyuan.config.editor.fullWidth?"true":"false");let i=(e.element.clientWidth-Constants.SIZE_EDITOR_WIDTH)/2;o==="false"&&i>96?(i>Constants.SIZE_EDITOR_WIDTH&&(i=e.element.clientWidth*.382/1.382),i=Math.ceil(i),a=i,t=i):e.element.clientWidth>Constants.SIZE_EDITOR_WIDTH&&(a=96,t=96)}return{left:a,right:t,bottom:n,top:16}},Zf=(e,t,a)=>{if(!e.preview.element.classList.contains("fn__none")){e.preview.render(e),removeLoading(e);return}if(window.siyuan.config.editor.displayBookmarkIcon?e.wysiwyg.element.classList.add("protyle-wysiwyg--attr"):e.wysiwyg.element.classList.remove("protyle-wysiwyg--attr"),e.title&&(e.title.element.removeAttribute("data-render"),e.title.element.setAttribute("spellcheck",window.siyuan.config.editor.spellcheck.toString()),window.siyuan.config.editor.displayBookmarkIcon?e.title.element.classList.add("protyle-wysiwyg--attr"):e.title.element.classList.remove("protyle-wysiwyg--attr")),e.lute.SetProtyleMarkNetImg(window.siyuan.config.editor.displayNetImgMark),e.lute.SetSpellcheck(window.siyuan.config.editor.spellcheck),restoreLuteMarkdownSyntax(e),e.lute.SetGFMStrikethrough1(!1),addLoading(e),e.options.backlinkData){const n=e.element.getAttribute("data-ismention")==="true",o=hasClosestByClassName(e.element,"sy__backlink");if(o){const i=o.querySelectorAll(".b3-text-field"),s=n?i[1].value:i[0].value;fetchPost(n?"/api/ref/getBackmentionDoc":"/api/ref/getBacklinkDoc",{defID:e.element.getAttribute("data-defid"),refTreeID:e.block.rootID,highlight:!isSupportCSSHL(),keyword:s},l=>{e.options.backlinkData=n?l.data.backmentions:l.data.backlinks,renderBacklink(e,e.options.backlinkData),searchMarkRender(e,l.data.keywords)})}}else preventScroll(e),getDocByScroll({protyle:e,focus:t,scrollAttr:saveScroll(e,!0),updateReadonly:a,cb(n){var o;(o=e.query)!=null&&o.key&&searchMarkRender(e,n,e.highlight.rangeIndex)}})};var Bl=(e,t,a)=>new Promise((n,o)=>{var i=r=>{try{l(a.next(r))}catch(c){o(c)}},s=r=>{try{l(a.throw(r))}catch(c){o(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(i,s);l((a=a.apply(e,t)).next())});const Xf=(e,t,a)=>{fetchPost("/api/block/getDocInfo",{id:e},n=>{t.updateTitle(n.data.name),a&&a.title&&a.title.setTitle(n.data.name)})},Jf=(e,t,a=!0,n=!0,o=!1)=>{a&&hideMessage(),window.siyuan.mobile.popEditor&&(t.removeRootIDs.includes(window.siyuan.mobile.popEditor.protyle.block.rootID)?hideElements(["dialog"]):reloadProtyle(window.siyuan.mobile.popEditor.protyle,!1,n)),window.siyuan.mobile.editor&&(t.removeRootIDs.includes(window.siyuan.mobile.editor.protyle.block.rootID)?setEmpty(e):(reloadProtyle(window.siyuan.mobile.editor.protyle,!1,n),fetchPost("/api/block/getDocInfo",{id:window.siyuan.mobile.editor.protyle.block.rootID},i=>{ql(i.data.name),window.siyuan.mobile.editor.protyle.title.setTitle(i.data.name)}))),setNoteBook(()=>{window.siyuan.mobile.docks.file.init(!1)})},Qf=e=>{getAllEditor().forEach(t=>{t.protyle.wysiwyg.element.querySelectorAll(`[data-node-id="${e.blockID}"] span[data-type="block-ref"][data-subtype="d"][data-id="${e.defBlockID}"]`).forEach(a=>{a.innerHTML=e.refText})})},eg=e=>{getAllEditor().forEach(a=>{if(a.protyle.block.rootID===e.rootID&&a.protyle.title){const n=a.protyle.title.element.querySelector(".protyle-attr"),o=n.querySelector(".protyle-attr--refcount");o?e.rootRefCount===0?o.remove():o.textContent=e.rootRefCount.toString():e.rootRefCount>0&&n.insertAdjacentHTML("beforeend",`<div class="protyle-attr--refcount popover__block">${e.rootRefCount}</div>`)}e.rootID!==e.blockID&&a.protyle.wysiwyg.element.querySelectorAll(`[data-node-id="${e.blockID}"]`).forEach(n=>{const o=n.lastElementChild.querySelector(".protyle-attr--refcount");if(o)e.refCount===0?o.remove():o.textContent=e.refCount.toString();else if(e.refCount>0){const i=n.lastElementChild;i.childElementCount>0?i.lastElementChild.insertAdjacentHTML("afterend",`<div class="protyle-attr--refcount popover__block">${e.refCount}</div>`):i.innerHTML=`<div class="protyle-attr--refcount popover__block">${e.refCount}</div>${Constants.ZWSP}`}e.refCount===0?n.removeAttribute("refcount"):n.setAttribute("refcount",e.refCount.toString())})});let t;if(t=window.siyuan.mobile.docks.file.element.querySelector(`li[data-node-id="${e.rootID}"]`),t){const a=t.querySelector(".counter");a?e.rootRefCount===0?a.remove():a.textContent=e.rootRefCount.toString():e.rootRefCount>0&&t.insertAdjacentHTML("beforeend",`<span class="popover__block counter b3-tooltips b3-tooltips__nw" aria-label="${window.siyuan.languages.ref}">${e.rootRefCount}</span>`)}},tg=e=>{window.siyuan.config.readonly||(e.plugins.forEach(t=>{t.eventBus.emit("lock-screen")}),fetchPost("/api/system/logoutAuth",{},()=>{redirectToCheckAuth()}))},Pl=()=>{if(document.querySelector("#errorLog"))return;let e="";Qt()&&(e=`<div class="fn__hr"></div><div class="fn__flex"><div class="fn__flex-1"></div><button class="b3-button">${window.siyuan.languages.retry}</button></div>`);const t=new Tn({disableClose:!0,title:`\u{1F494} ${window.siyuan.languages.kernelFault0} <small>v${S.SIYUAN_VERSION}</small>`,width:$()?"92vw":"520px",content:`<div class="b3-dialog__content">
<div class="ft__breakword">
    <div>${window.siyuan.languages.kernelFault1}</div>
    <div class="fn__hr"></div>
    <div>${window.siyuan.languages.kernelFault2}</div>
    ${e}
</div>
</div>`});t.element.id="errorLog",t.element.setAttribute("data-key",S.DIALOG_KERNELFAULT);const a=t.element.querySelector(".b3-button");a&&a.addEventListener("click",()=>{t.destroy(),window.webkit.messageHandlers.startKernelFast.postMessage("startKernelFast")})},Rl=()=>Bl(void 0,null,function*(){hideAllElements(["util"]),window.siyuan.mobile.editor&&(yield saveScroll(window.siyuan.mobile.editor.protyle)),fetchPost("/api/system/exit",{force:!1},e=>{if(e.code===1){const t=showMessage(e.msg,e.data.closeTimeout,"error"),a=document.querySelector(`#message [data-id="${t}"] button`);a&&a.addEventListener("click",()=>{fetchPost("/api/system/exit",{force:!0},()=>{(isInIOS()||isInAndroid()||isInHarmony())&&(window.location.href="siyuan://api/system/exit")})})}else e.code===2?(hideMessage(),window.siyuan.config.system.container==="std"&&ipcRenderer.send(Constants.SIYUAN_SHOW_WINDOW),confirmDialog(window.siyuan.languages.tip,e.msg,()=>{fetchPost("/api/system/exit",{force:!0,execInstallPkg:2},()=>{})},()=>{fetchPost("/api/system/exit",{force:!0,execInstallPkg:1},()=>{})})):(isInIOS()||isInAndroid()||isInHarmony())&&(window.location.href="siyuan://api/system/exit")})}),ag=()=>{if(document.getElementById("transactionError"))return;const e=new Dialog({disableClose:!0,title:`${window.siyuan.languages.stateExcepted} v${Constants.SIYUAN_VERSION}`,content:`<div class="b3-dialog__content" id="transactionError">${window.siyuan.languages.rebuildIndexTip}</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--text">${window.siyuan.languages._kernel[97]}</button>
    <div class="fn__space"></div>
    <button class="b3-button">${window.siyuan.languages.rebuildIndex}</button>
</div>`,width:isMobile()?"92vw":"520px"});e.element.setAttribute("data-key",Constants.DIALOG_STATEEXCEPTED);const t=e.element.querySelectorAll(".b3-button");t[0].addEventListener("click",()=>{Rl()}),t[1].addEventListener("click",()=>{Ol(),e.destroy()})},Ol=e=>{window.siyuan.storage[Constants.LOCAL_FILEPOSITION]={},setStorageVal(Constants.LOCAL_FILEPOSITION,window.siyuan.storage[Constants.LOCAL_FILEPOSITION]),fetchPost("/api/filetree/refreshFiletree",{},()=>{e&&e()})};let Ca;const ng=e=>{const t=document.querySelector("#status");if(t)if(isMobile()){if(!document.querySelector("#keyboardToolbar").classList.contains("fn__none"))return;clearTimeout(Ca),t.innerHTML=e.msg,t.style.bottom="0",Ca=window.setTimeout(()=>{t.style.bottom=""},12e3)}else{const a=t.querySelector(".status__msg");a&&(clearTimeout(Ca),a.innerHTML=e.msg,Ca=window.setTimeout(()=>{a.innerHTML=""},12e3))}},sg=e=>{let t=document.getElementById("progress");if(t||(document.body.insertAdjacentHTML("beforeend",`<div id="progress" style="z-index: ${++window.siyuan.zIndex}"></div>`),t=document.getElementById("progress")),e.code===2){t.remove();return}e.code===0?t.innerHTML=`<div class="b3-dialog__scrim" style="opacity: 1"></div>
<div class="b3-dialog__loading">
    <div style="text-align: right">${e.data.current}/${e.data.total}</div>
    <div style="margin: 8px 0;height: 8px;border-radius: var(--b3-border-radius);overflow: hidden;background-color:#fff;"><div style="width: ${e.data.current/e.data.total*100}%;transition: var(--b3-transition);background-color: var(--b3-theme-primary);height: 8px;"></div></div>
    <div class="ft__breakword">${e.msg}</div>
</div>`:e.code===1&&(t.lastElementChild?t.lastElementChild.lastElementChild.innerHTML=e.msg:t.innerHTML=`<div class="b3-dialog__scrim" style="opacity: 1"></div>
<div class="b3-dialog__loading">
    <div style="margin: 8px 0;height: 8px;border-radius: var(--b3-border-radius);overflow: hidden;background-color:#fff;"><div style="background-color: var(--b3-theme-primary);height: 8px;background-image: linear-gradient(-45deg, rgba(255, 255, 255, 0.2) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, 0.2) 50%, rgba(255, 255, 255, 0.2) 75%, transparent 75%, transparent);animation: stripMove 450ms linear infinite;background-size: 50px 50px;"></div></div>
    <div class="ft__breakword">${e.msg}</div>
</div>`)},ig=e=>{const t=document.querySelector(".status__backgroundtask");t&&(e.length===0?(t.classList.add("fn__none"),!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="statusBackgroundTask"&&window.siyuan.menus.menu.remove()):(t.classList.remove("fn__none"),t.setAttribute("data-tasks",JSON.stringify(e)),t.innerHTML=e[0].action+"<div><div></div></div>"))},og=()=>{fetchPost("/api/sync/getBootSync",{},e=>{if(e.code===1){const t=new Dialog({width:isMobile()?"92vw":"50vw",title:"\u{1F329}\uFE0F "+window.siyuan.languages.bootSyncFailed,content:`<div class="b3-dialog__content">${e.msg}</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.syncNow}</button>
</div>`});t.element.setAttribute("data-key",Constants.DIALOG_BOOTSYNCFAILED);const a=t.element.querySelectorAll(".b3-button");a[0].addEventListener("click",()=>{t.destroy()}),a[1].addEventListener("click",()=>{a[1].getAttribute("disabled")||(a[1].setAttribute("disabled","disabled"),fetchPost("/api/sync/performBootSync",{},n=>{n.code===0&&t.destroy(),a[1].removeAttribute("disabled")}))})}})},ql=e=>{const t=document.getElementById("drag"),a=getWorkspaceName();if(e===window.siyuan.languages.siyuanNote){const n=`${a} - ${window.siyuan.languages.siyuanNote} v${Constants.SIYUAN_VERSION}`;document.title=n,t&&(t.textContent=n,t.setAttribute("title",n))}else{if(e=e||window.siyuan.languages.untitled,document.title=`${e} - ${a} - ${window.siyuan.languages.siyuanNote} v${Constants.SIYUAN_VERSION}`,!t)return;t.setAttribute("title",e),t.innerHTML=escapeHtml(e)}},lg=e=>{const t=document.querySelector("#configBazaarReadme .item__side");if(!t||e.id!==JSON.parse(t.getAttribute("data-obj")).repoURL)return;const a=t.querySelector('[data-type="install"]');a&&(e.percent>=1?(a.parentElement.classList.add("fn__none"),a.parentElement.nextElementSibling.classList.add("fn__none")):(a.classList.add("b3-button--progress"),a.parentElement.nextElementSibling.firstElementChild.classList.add("b3-button--progress"),a.innerHTML=`<span style="width: ${e.percent*100}%"></span>`,a.parentElement.nextElementSibling.firstElementChild.innerHTML=`<span style="width: ${e.percent*100}%"></span>`))},rg=(e,t)=>{const a=document.querySelector("#menuSyncNow use"),n=document.querySelector("#toolbarSync use");if(!e){!window.siyuan.config.sync.enabled||window.siyuan.config.sync.provider===0&&needSubscribe("")?(a==null||a.setAttribute("xlink:href","#iconCloudOff"),n.setAttribute("xlink:href","#iconCloudOff")):(a==null||a.setAttribute("xlink:href","#iconCloudSucc"),n.setAttribute("xlink:href","#iconCloudSucc"));return}a==null||a.parentElement.classList.remove("fn__rotate"),n.parentElement.classList.remove("fn__rotate"),e.code===0?(a==null||a.parentElement.classList.add("fn__rotate"),n.parentElement.classList.add("fn__rotate"),a==null||a.setAttribute("xlink:href","#iconRefresh"),n.setAttribute("xlink:href","#iconRefresh")):e.code===2?(a==null||a.setAttribute("xlink:href","#iconCloudError"),n.setAttribute("xlink:href","#iconCloudError")):e.code===1&&(a==null||a.setAttribute("xlink:href","#iconCloudSucc"),n.setAttribute("xlink:href","#iconCloudSucc")),t.forEach(o=>{e.code===0?o.eventBus.emit("sync-start",e):e.code===1?o.eventBus.emit("sync-end",e):e.code===2&&o.eventBus.emit("sync-fail",e)})};var Ul=(e,t,a)=>new Promise((n,o)=>{var i=r=>{try{l(a.next(r))}catch(c){o(c)}},s=r=>{try{l(a.throw(r))}catch(c){o(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(i,s);l((a=a.apply(e,t)).next())});const he=(e,t,a,n)=>{const o={method:"POST"};t&&(["/api/search/searchRefBlock","/api/graph/getGraph","/api/graph/getLocalGraph","/api/block/getRecentUpdatedBlocks","/api/search/fullTextSearchBlock"].includes(e)&&(window.siyuan.reqIds[e]=new Date().getTime(),t.type==="local"&&e==="/api/graph/getLocalGraph"||(t.reqId=window.siyuan.reqIds[e])),e==="/api/transactions"&&(t.reqId=new Date().getTime()),t instanceof FormData?o.body=t:o.body=JSON.stringify(t)),n&&(o.headers=n),fetch(e,o).then(i=>{var s;switch(i.status){case 403:case 404:return{data:null,msg:i.statusText,code:-i.status};default:return((s=i.headers.get("content-type"))==null?void 0:s.indexOf("application/json"))>-1?i.json():i.text()}}).then(i=>{if(typeof i=="string"){a&&a(i);return}["/api/search/searchRefBlock","/api/graph/getGraph","/api/graph/getLocalGraph","/api/block/getRecentUpdatedBlocks","/api/search/fullTextSearchBlock"].includes(e)&&i.data.reqId&&window.siyuan.reqIds[e]&&window.siyuan.reqIds[e]>i.data.reqId||(typeof i=="object"&&typeof i.msg=="string"&&typeof i.code=="number"?xn(i)&&a&&a(i):a&&a(i))}).catch(i=>{if(console.warn("fetch post failed ["+i+"], url ["+e+"]"),e==="/api/transactions"&&(i.message==="Failed to fetch"||i.message==="Unexpected end of JSON input")){Pl();return}})},ai=(e,t)=>Ul(void 0,null,function*(){const a={method:"POST"};t&&(t instanceof FormData?a.body=t:a.body=JSON.stringify(t));const o=yield(yield fetch(e,a)).json();return xn(o),o}),cg=(e,t)=>{fetch(e).then(a=>{var n;return((n=a.headers.get("content-type"))==null?void 0:n.indexOf("application/json"))>-1?a.json():a.text()}).then(a=>{t(a)})};var ni=(e,t,a)=>new Promise((n,o)=>{var i=r=>{try{l(a.next(r))}catch(c){o(c)}},s=r=>{try{l(a.throw(r))}catch(c){o(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(i,s);l((a=a.apply(e,t)).next())});const si=(e,t)=>{addScript(e,"iconDefaultScript").then(()=>{if(!["ant","material"].includes(t.icon)){const a=document.getElementById("iconScript");a&&a.remove(),addScript(`/appearance/icons/${t.icon}/icon.js?v=${t.iconVer}`,"iconScript")}})},Fl=e=>{var t;const a=document.getElementsByTagName("html")[0];a.setAttribute("lang",window.siyuan.config.appearance.lang),a.setAttribute("data-theme-mode",Wl()),a.setAttribute("data-light-theme",window.siyuan.config.appearance.themeLight),a.setAttribute("data-dark-theme",window.siyuan.config.appearance.themeDark);const n=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light";window.siyuan.config.appearance.modeOS&&(window.siyuan.config.appearance.mode===1&&n==="light"||window.siyuan.config.appearance.mode===0&&n==="dark")&&(fetchPost("/api/system/setAppearanceMode",{mode:n==="light"?0:1}),window.siyuan.config.appearance.mode=n==="light"?0:1);const o=document.getElementById("themeDefaultStyle"),i=`/appearance/themes/${e.mode===1?"midnight":"daylight"}/theme.css?v=${Constants.SIYUAN_VERSION}`;o?o.getAttribute("href").startsWith(i)||o.setAttribute("href",i):addStyle(i,"themeDefaultStyle");const s=document.getElementById("themeStyle");if(e.mode===1&&e.themeDark!=="midnight"||e.mode===0&&e.themeLight!=="daylight"){const u=`/appearance/themes/${e.mode===1?e.themeDark:e.themeLight}/theme.css?v=${e.themeVer}`;s?s.getAttribute("href").startsWith(u)||s.setAttribute("href",u):addStyle(u,"themeStyle")}else s&&s.remove();!((t=window.webkit)!=null&&t.messageHandlers)&&!window.JSAndroid&&!window.JSHarmony&&"serviceWorker"in window.navigator&&"caches"in window&&"fetch"in window&&navigator.serviceWorker&&document.head.insertAdjacentHTML("afterbegin",`<meta name="theme-color" content="${getComputedStyle(document.body).getPropertyValue("--b3-toolbar-background").trim()}">`),ii();const l=document.getElementById("themeScript"),r=`/appearance/themes/${e.mode===1?e.themeDark:e.themeLight}/theme.js?v=${e.themeVer}`;l?l.getAttribute("src").startsWith(r)||(l.remove(),addScript(r,"themeScript")):addScript(r,"themeScript");const c=document.getElementById("iconDefaultScript"),d=`/appearance/icons/${["ant","material"].includes(e.icon)?e.icon:"material"}/icon.js?v=${Constants.SIYUAN_VERSION}`;if(c){if(!c.getAttribute("src").startsWith(d)){c.remove();let u=document.body.firstElementChild;for(;u.tagName==="svg";){const g=u;u=u.nextElementSibling,g.getAttribute("data-name")||g.remove()}si(d,e)}}else si(d,e)},dg=()=>{const e=document.getElementById("loading");e&&setTimeout(()=>{e.remove()},160),oi(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",t=>{const a=t.matches?"dark":"light";oi(a),window.siyuan.config.appearance.modeOS&&(window.siyuan.config.appearance.mode===0&&a==="light"||window.siyuan.config.appearance.mode===1&&a==="dark"||fetchPost("/api/system/setAppearanceMode",{mode:a==="light"?0:1},n=>ni(void 0,null,function*(){if(window.siyuan.config.appearance.themeJS)if(window.destroyTheme)try{yield window.destroyTheme(),window.destroyTheme=void 0,document.getElementById("themeScript").remove()}catch(o){console.error("destroyTheme error: "+o)}else{window.location.reload();return}window.siyuan.config.appearance=n.data.appearance,Fl(n.data.appearance)})))})},ug=()=>{if(!window.siyuan.config.system.disableGoogleAnalytics){addScript("https://www.googletagmanager.com/gtag/js?id=G-L7WEXVQCR9","gaScript"),window.dataLayer=window.dataLayer||[];const e=function(...a){window.dataLayer.push(arguments)};e("js",new Date),e("config","G-L7WEXVQCR9",{send_page_view:!1});const t={version:Constants.SIYUAN_VERSION,container:window.siyuan.config.system.container,os:window.siyuan.config.system.os,osPlatform:window.siyuan.config.system.osPlatform,isLoggedIn:!1,subscriptionStatus:-1,subscriptionPlan:-1,subscriptionType:-1,oneTimePayStatus:-1,syncEnabled:!1,syncProvider:-1,cTreeCount:window.siyuan.config.stat.cTreeCount,cBlockCount:window.siyuan.config.stat.cBlockCount,cDataSize:window.siyuan.config.stat.cDataSize,cAssetsSize:window.siyuan.config.stat.cAssetsSize};window.siyuan.user&&(t.isLoggedIn=!0,t.subscriptionStatus=window.siyuan.user.userSiYuanSubscriptionStatus,t.subscriptionPlan=window.siyuan.user.userSiYuanSubscriptionPlan,t.subscriptionType=window.siyuan.user.userSiYuanSubscriptionType,t.oneTimePayStatus=window.siyuan.user.userSiYuanOneTimePayStatus),window.siyuan.config.sync&&(t.syncEnabled=window.siyuan.config.sync.enabled,t.syncProvider=window.siyuan.config.sync.provider),e("event",Constants.ANALYTICS_EVT_ON_GET_CONFIG,t)}},fg=(e=!0)=>ni(void 0,null,function*(){const t=Math.floor(window.siyuan.config.editor.fontSize*1.625);let a;isMac()||isIPad()||isIPhone()?a=`@font-face {
  font-family: "Emojis Additional";
  src: url(../../../appearance/fonts/Noto-COLRv1-2.047/Noto-COLRv1.woff2) format("woff2");
  unicode-range: U+1fae9, U+1fac6, U+1fabe, U+1fadc, U+e50a, U+1fa89, U+1fadf, U+1f1e6-1f1ff, U+1fa8f;
}
@font-face {
  font-family: "Emojis Reset";
  src: local("Apple Color Emoji"),
  local("Segoe UI Emoji"),
  local("Segoe UI Symbol");
  unicode-range: U+21a9, U+21aa, U+2122, U+2194-2199, U+23cf, U+25b6, U+25c0, U+25fb, U+25fc, U+25aa, U+25ab, U+2600-2603,
  U+260e, U+2611, U+261d, U+2639, U+263a, U+2640, U+2642, U+2660, U+2663, U+2665, U+2666, U+2668, U+267b, U+26aa, U+26ab, 
  U+2702, U+2708, U+2934, U+2935, U+1f170, U+1f171, U+1f17e, U+1f17f, U+1f202, U+1f21a, U+1f22f, U+1f232-1f23a, U+1f250, 
  U+1f251, U+1fae4, U+2049, U+203c, U+3030, U+303d, U+24c2, U+26a0, U+26a1, U+26be, U+27a1, U+2b05-2b07, U+3297, U+3299, U+a9, U+ae;
  size-adjust: 115%;
}
@font-face {
  font-family: "Emojis";
  src: local("Apple Color Emoji"),
  local("Segoe UI Emoji"),
  local("Segoe UI Symbol");
  size-adjust: 115%;
}`:(yield isWin11())?a=`@font-face {
  font-family: "Emojis Additional";
  src: url(../../../appearance/fonts/Noto-COLRv1-2.047/Noto-COLRv1.woff2) format("woff2");
  unicode-range: U+1fae9, U+1fac6, U+1fabe, U+1fadc, U+e50a, U+1fa89, U+1fadf, U+1f1e6-1f1ff, U+1f3f4, U+e0067, U+e0062,
  U+e0065, U+e006e, U+e007f, U+e0073, U+e0063, U+e0074, U+e0077, U+e006c;
  size-adjust: 85%;
}
@font-face {
  font-family: "Emojis Reset";
  src: local("Segoe UI Emoji"),
  local("Segoe UI Symbol");
  unicode-range: U+263a, U+21a9, U+2642, U+303d, U+2197, U+2198, U+2199, U+2196, U+2195, U+2194, U+2660, U+2665, U+2666, 
  U+2663, U+3030, U+21aa, U+25b6, U+25c0, U+2640, U+203c, U+a9, U+ae, U+2122;
  size-adjust: 85%;
}
@font-face {
  font-family: "Emojis";
  src: local("Segoe UI Emoji"),
  local("Segoe UI Symbol");
  size-adjust: 85%;
}`:a=`@font-face {
  font-family: "Emojis Reset";
  src: url(../../../appearance/fonts/Noto-COLRv1-2.047/Noto-COLRv1.woff2) format("woff2");
  unicode-range: U+1f170-1f171, U+1f17e, U+1f17f, U+1f21a, U+1f22f, U+1f232-1f23a, U+1f250, U+1f251, U+1f32b, U+1f3bc,
  U+1f411, U+1f42d, U+1f42e, U+1f431, U+1f435, U+1f441, U+1f4a8, U+1f4ab, U+1f525, U+1f600-1f60d, U+1f60f-1f623,
  U+1f625-1f62b, U+1f62d-1f63f, U+1F643, U+1F640, U+1f79, U+1f8f, U+1fa79, U+1fae4, U+1fae9, U+1fac6, U+1fabe, U+1fadf,
  U+200d, U+203c, U+2049, U+2122, U+2139, U+2194-2199, U+21a9, U+21aa, U+23cf, U+25aa, U+25ab, U+25b6, U+25c0, U+25fb-25fe,
  U+2611, U+2615, U+2618, U+261d, U+2620, U+2622, U+2623, U+2626, U+262a, U+262e, U+2638-263a, U+2640, U+2642, U+2648-2653,
  U+265f, U+2660, U+2663, U+2665, U+2666, U+267b, U+267e, U+267f, U+2692-2697, U+2699, U+269b, U+269c, U+26a0, U+26a1,
  U+26a7, U+26aa, U+26ab, U+26b0, U+26b1, U+2702, U+2708, U+2709, U+270c, U+270d, U+2712, U+2714, U+2716, U+271d, U+2733,
  U+2734, U+2744, U+2747, U+2763, U+2764, U+2934-2935, U+3030, U+303d, U+3297, U+3299, U+fe0f, U+e50a, U+a9, U+ae;
  size-adjust: 92%;
}
@font-face {
  font-family: "Emojis";
  src: url(../../../appearance/fonts/Noto-COLRv1-2.047/Noto-COLRv1.woff2) format("woff2"),
  local("Segoe UI Emoji"),
  local("Segoe UI Symbol"),
  local("Apple Color Emoji"),
  local("Twemoji Mozilla"),
  local("Noto Color Emoji"),
  local("Android Emoji"),
  local("EmojiSymbols");
  size-adjust: 92%;
}`;let n="";if(window.siyuan.config.editor.rtl&&(n=`.protyle-title__input,
.protyle-wysiwyg .p,
.protyle-wysiwyg .code-block .hljs,
.protyle-wysiwyg .table,
.protyle-wysiwyg .render-node protyle-html,
.protyle-wysiwyg .render-node > div[spin="1"],
.protyle-wysiwyg [data-type="NodeHeading"] {direction: rtl}
.protyle-wysiwyg [data-node-id].li > .protyle-action {
    right: 0;
    left: auto;
    direction: rtl;
}
.protyle-wysiwyg [data-node-id].li > [data-node-id] {
    margin-right: 34px;
    margin-left: 0;
}
.protyle-wysiwyg [data-node-id].li::before {
    right: 17px;
    left: auto;
}`),a+=`
:root{--b3-font-size-editor:${window.siyuan.config.editor.fontSize}px}
.b3-typography code:not(.hljs), .protyle-wysiwyg span[data-type~=code] { font-variant-ligatures: ${window.siyuan.config.editor.codeLigatures?"normal":"none"} }
.li > .protyle-action {height:${t+8}px;line-height: ${t+8}px}
/* \u5217\u8868\u9879\u540E\u7684\u5185\u5BB9\u548C\u5217\u8868\u9879\u5BF9\u9F50 https://github.com/siyuan-note/siyuan/issues/2803 */
.protyle-wysiwyg [data-node-id].li > .protyle-action ~ div {line-height:${t}px}
.protyle-wysiwyg [data-node-id].li > .protyle-action ~ div > [spellcheck] {min-height:${t}px}
.protyle-wysiwyg [data-node-id].li::before {height: calc(100% - ${t+12}px);top:${t+12}px}
${n}
.protyle-wysiwyg [data-node-id] {${window.siyuan.config.editor.justify?" text-align: justify;":""}}
.protyle-wysiwyg .li {min-height:${t+8}px}
.protyle-gutters button svg {height:${t}px}`,window.siyuan.config.editor.fontFamily&&(a+=`
.b3-typography:not(.b3-typography--default), .protyle-wysiwyg, .protyle-title {font-family: "Emojis Additional", "Emojis Reset", "${window.siyuan.config.editor.fontFamily}", var(--b3-font-family)}`),"ontouchend"in document&&(a+=`
.b3-menu .b3-menu__action {opacity: 0.68;}`),e){const o=document.getElementById("siyuanStyle");o?o.innerHTML=a:document.querySelector("#pluginsStyle").insertAdjacentHTML("beforebegin",`<style id="siyuanStyle">${a}</style>`)}return a}),ii=(e=S.PROTYLE_CDN)=>{const t=document.getElementById("protyleHljsStyle");let a;window.siyuan.config.appearance.mode===0?(a=window.siyuan.config.appearance.codeBlockThemeLight,S.SIYUAN_CONFIG_APPEARANCE_LIGHT_CODE.includes(a)||(a="default")):(a=window.siyuan.config.appearance.codeBlockThemeDark,S.SIYUAN_CONFIG_APPEARANCE_DARK_CODE.includes(a)||(a="github-dark"));const n=`${e}/js/highlight.js/styles/${a}.min.css?v=11.11.1`;t?t.href.includes(n)||(t.remove(),Ia(n,"protyleHljsStyle")):Ia(n,"protyleHljsStyle")},gg=e=>{},Yl=e=>{if(e.startsWith("#"))return e;let t;const a=e.replace(/\s/g,"").match(/^rgba?\((\d+),(\d+),(\d+),?([^,\s)]+)?/i),n=(a&&a[4]||"").trim();let o=a?(a[1]|1<<8).toString(16).slice(1)+(a[2]|1<<8).toString(16).slice(1)+(a[3]|1<<8).toString(16).slice(1):e;return n!==""?t=n:t=1,t=(t*255|1<<8).toString(16).slice(1),o=o+t,o},oi=e=>{(isInIOS()||isInAndroid()||isInHarmony())&&setTimeout(()=>{const t=Yl(getComputedStyle(document.body).getPropertyValue("--b3-theme-background").trim());let a=window.siyuan.config.appearance.mode;window.siyuan.config.appearance.modeOS&&(e==="dark"?a=1:a=0),isInIOS()?window.webkit.messageHandlers.changeStatusBar.postMessage((t||(a===0?"#fff":"#1e1e1e"))+" "+a):isInAndroid()?window.JSAndroid.changeStatusBarColor(t,a):isInHarmony()&&window.JSHarmony.changeStatusBarColor(t,a)},500)},Wl=()=>{const e=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light";return window.siyuan.config.appearance.modeOS?e:window.siyuan.config.appearance.mode===0?"light":"dark"},_t=(e,t=S.PROTYLE_CDN)=>{let a,n=!1;e.classList.contains("code-block")?a=e.querySelectorAll(".hljs"):e.classList.contains("item__readme")?(a=e.querySelectorAll("pre code"),a.forEach(o=>{o.parentElement.setAttribute("linenumber","false")})):e.classList.contains("b3-typography")?(a=e.querySelectorAll(".code-block code"),n=!0):a=e.querySelectorAll(".code-block .hljs"),a.length!==0&&(ii(t),re(`${t}/js/highlight.js/highlight.min.js?v=11.11.1`,"protyleHljsScript").then(()=>{re(`${t}/js/highlight.js/third-languages.js?v=1.0.1`,"protyleHljsThirdScript").then(()=>{a.forEach(o=>{const i=o.parentElement.querySelectorAll(".protyle-icon");if(i.length===2&&(i[0].setAttribute("aria-label",window.siyuan.languages.copy),i[1].setAttribute("aria-label",window.siyuan.languages.more)),o.getAttribute("data-render")==="true")return;const s=o.querySelector("wbr");let l=0;if(s){let p=s.previousSibling;for(;p;){for(l+=p.textContent.length;!p.previousSibling&&p.parentElement.tagName!=="DIV";)p=p.parentElement;p=p.previousSibling}s.remove()}let r;n?r=o.parentElement.getAttribute("data-language"):o.previousElementSibling?r=o.previousElementSibling.firstElementChild.textContent:r=o.className.replace("language-",""),window.hljs.getLanguage(r)||(r="plaintext"),o.classList.add("hljs"),o.setAttribute("data-render","true");const c=o.parentElement.getAttribute("linewrap"),d=o.parentElement.getAttribute("ligatures"),u=o.parentElement.getAttribute("linenumber"),g=o.lastElementChild?o.lastElementChild:o;c==="true"||c!=="false"&&window.siyuan.config.editor.codeLineWrap?(g.style.setProperty("white-space","pre-wrap"),g.style.setProperty("word-break","break-word")):(g.style.setProperty("white-space","pre"),g.style.setProperty("word-break","initial")),d==="true"||d!=="false"&&window.siyuan.config.editor.codeLigatures?g.style.fontVariantLigatures="normal":g.style.fontVariantLigatures="none";const f=g.textContent;o.firstElementChild&&(!n&&(u==="true"||u!=="false"&&window.siyuan.config.editor.codeSyntaxHighlightLineNum)?(o.firstElementChild.className="protyle-linenumber__rows",o.firstElementChild.setAttribute("contenteditable","false"),li(o),o.style.display=""):(o.firstElementChild.className="fn__none",o.firstElementChild.innerHTML="",g.style.paddingLeft="",o.style.display="block")),g.innerHTML=window.hljs.highlight(f+(f.endsWith(`
`)?"":`
`),{language:r,ignoreIllegals:!0}).value,s&&getSelection().rangeCount>0&&xa(o,l,l)})})}))},li=e=>{const t=e.parentElement.getAttribute("lineNumber");if(t==="false"||!window.siyuan.config.editor.codeSyntaxHighlightLineNum&&t!=="true")return;e.parentElement.style.lineHeight=`${((parseInt(e.parentElement.style.fontSize)||window.siyuan.config.editor.fontSize)*1.625*.85).toFixed(0)}px`;const a=e.lastElementChild;let n="";const o=a.textContent.split(/\r\n|\r|\n|\u2028|\u2029/g);o[o.length-1]===""&&o.length>1&&o.pop(),e.firstElementChild.innerHTML=`<span>${o.length}</span>`,a.style.paddingLeft=`${e.firstElementChild.clientWidth+16}px`;const i=document.createElement("div");i.className="hljs",i.setAttribute("style",`padding-left:${a.style.paddingLeft};
width: ${a.getBoundingClientRect().width}px;
white-space:${a.style.whiteSpace};
word-break:${a.style.wordBreak};
font-variant-ligatures:${a.style.fontVariantLigatures};
padding-right:0;max-height: none;box-sizing: border-box;position: absolute;padding-top:0 !important;padding-bottom:0 !important;min-height:auto !important;`),i.setAttribute("contenteditable","true"),e.insertAdjacentElement("afterend",i);const s=a.style.wordBreak==="break-word";if(o.map(l=>{let r="";s&&(i.textContent=l.trim()?l:"<br>",r=` style="height:${i.clientHeight}px;"`),n+=`<span${r}></span>`}),i.remove(),e.firstElementChild.innerHTML=n,e.scrollHeight>e.clientHeight&&getSelection().rangeCount>0){const l=getSelection().getRangeAt(0);if(e.contains(l.startContainer)){const r=document.createElement("br");l.insertNode(r),r.scrollIntoView({block:"nearest"}),r.remove()}}};class $e{}$e.graphvizRender=ye,$e.highlightRender=_t,$e.mathRender=Wa,$e.mermaidRender=ja,$e.flowchartRender=Ga,$e.chartRender=Ya,$e.abcRender=Fa,$e.mindmapRender=Va,$e.plantumlRender=Ka,$e.avRender=Je,$e.htmlRender=za,window.Protyle=$e;const jl=$e})(),zt=zt.default,zt})())});Gl();})();
