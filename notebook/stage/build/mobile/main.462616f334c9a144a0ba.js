(()=>{(()=>{var tu={43:function(Ge,Oe,ot){var Re;(function(nn){"use strict";function Te(Y,Z){var j=(Y&65535)+(Z&65535),Ie=(Y>>16)+(Z>>16)+(j>>16);return Ie<<16|j&65535}function z(Y,Z){return Y<<Z|Y>>>32-Z}function G(Y,Z,j,Ie,f,Q){return Te(z(Te(Te(Z,Y),Te(Ie,Q)),f),j)}function H(Y,Z,j,Ie,f,Q,ee){return G(Z&j|~Z&Ie,Y,Z,f,Q,ee)}function ce(Y,Z,j,Ie,f,Q,ee){return G(Z&Ie|j&~Ie,Y,Z,f,Q,ee)}function de(Y,Z,j,Ie,f,Q,ee){return G(Z^j^Ie,Y,Z,f,Q,ee)}function ie(Y,Z,j,Ie,f,Q,ee){return G(j^(Z|~Ie),Y,Z,f,Q,ee)}function _e(Y,Z){Y[Z>>5]|=128<<Z%32,Y[(Z+64>>>9<<4)+14]=Z;var j,Ie,f,Q,ee,F=1732584193,D=-271733879,O=-1732584194,$=271733878;for(j=0;j<Y.length;j+=16)Ie=F,f=D,Q=O,ee=$,F=H(F,D,O,$,Y[j],7,-680876936),$=H($,F,D,O,Y[j+1],12,-389564586),O=H(O,$,F,D,Y[j+2],17,606105819),D=H(D,O,$,F,Y[j+3],22,-1044525330),F=H(F,D,O,$,Y[j+4],7,-176418897),$=H($,F,D,O,Y[j+5],12,1200080426),O=H(O,$,F,D,Y[j+6],17,-1473231341),D=H(D,O,$,F,Y[j+7],22,-45705983),F=H(F,D,O,$,Y[j+8],7,1770035416),$=H($,F,D,O,Y[j+9],12,-1958414417),O=H(O,$,F,D,Y[j+10],17,-42063),D=H(D,O,$,F,Y[j+11],22,-1990404162),F=H(F,D,O,$,Y[j+12],7,1804603682),$=H($,F,D,O,Y[j+13],12,-40341101),O=H(O,$,F,D,Y[j+14],17,-1502002290),D=H(D,O,$,F,Y[j+15],22,1236535329),F=ce(F,D,O,$,Y[j+1],5,-165796510),$=ce($,F,D,O,Y[j+6],9,-1069501632),O=ce(O,$,F,D,Y[j+11],14,643717713),D=ce(D,O,$,F,Y[j],20,-373897302),F=ce(F,D,O,$,Y[j+5],5,-701558691),$=ce($,F,D,O,Y[j+10],9,38016083),O=ce(O,$,F,D,Y[j+15],14,-660478335),D=ce(D,O,$,F,Y[j+4],20,-405537848),F=ce(F,D,O,$,Y[j+9],5,568446438),$=ce($,F,D,O,Y[j+14],9,-1019803690),O=ce(O,$,F,D,Y[j+3],14,-187363961),D=ce(D,O,$,F,Y[j+8],20,1163531501),F=ce(F,D,O,$,Y[j+13],5,-1444681467),$=ce($,F,D,O,Y[j+2],9,-51403784),O=ce(O,$,F,D,Y[j+7],14,1735328473),D=ce(D,O,$,F,Y[j+12],20,-1926607734),F=de(F,D,O,$,Y[j+5],4,-378558),$=de($,F,D,O,Y[j+8],11,-2022574463),O=de(O,$,F,D,Y[j+11],16,1839030562),D=de(D,O,$,F,Y[j+14],23,-35309556),F=de(F,D,O,$,Y[j+1],4,-1530992060),$=de($,F,D,O,Y[j+4],11,1272893353),O=de(O,$,F,D,Y[j+7],16,-155497632),D=de(D,O,$,F,Y[j+10],23,-1094730640),F=de(F,D,O,$,Y[j+13],4,681279174),$=de($,F,D,O,Y[j],11,-358537222),O=de(O,$,F,D,Y[j+3],16,-722521979),D=de(D,O,$,F,Y[j+6],23,76029189),F=de(F,D,O,$,Y[j+9],4,-640364487),$=de($,F,D,O,Y[j+12],11,-421815835),O=de(O,$,F,D,Y[j+15],16,530742520),D=de(D,O,$,F,Y[j+2],23,-995338651),F=ie(F,D,O,$,Y[j],6,-198630844),$=ie($,F,D,O,Y[j+7],10,1126891415),O=ie(O,$,F,D,Y[j+14],15,-1416354905),D=ie(D,O,$,F,Y[j+5],21,-57434055),F=ie(F,D,O,$,Y[j+12],6,1700485571),$=ie($,F,D,O,Y[j+3],10,-1894986606),O=ie(O,$,F,D,Y[j+10],15,-1051523),D=ie(D,O,$,F,Y[j+1],21,-2054922799),F=ie(F,D,O,$,Y[j+8],6,1873313359),$=ie($,F,D,O,Y[j+15],10,-30611744),O=ie(O,$,F,D,Y[j+6],15,-1560198380),D=ie(D,O,$,F,Y[j+13],21,1309151649),F=ie(F,D,O,$,Y[j+4],6,-145523070),$=ie($,F,D,O,Y[j+11],10,-1120210379),O=ie(O,$,F,D,Y[j+2],15,718787259),D=ie(D,O,$,F,Y[j+9],21,-343485551),F=Te(F,Ie),D=Te(D,f),O=Te(O,Q),$=Te($,ee);return[F,D,O,$]}function Le(Y){var Z,j="",Ie=Y.length*32;for(Z=0;Z<Ie;Z+=8)j+=String.fromCharCode(Y[Z>>5]>>>Z%32&255);return j}function rt(Y){var Z,j=[];for(j[(Y.length>>2)-1]=void 0,Z=0;Z<j.length;Z+=1)j[Z]=0;var Ie=Y.length*8;for(Z=0;Z<Ie;Z+=8)j[Z>>5]|=(Y.charCodeAt(Z/8)&255)<<Z%32;return j}function st(Y){return Le(_e(rt(Y),Y.length*8))}function qe(Y,Z){var j,Ie=rt(Y),f=[],Q=[],ee;for(f[15]=Q[15]=void 0,Ie.length>16&&(Ie=_e(Ie,Y.length*8)),j=0;j<16;j+=1)f[j]=Ie[j]^909522486,Q[j]=Ie[j]^1549556828;return ee=_e(f.concat(rt(Z)),512+Z.length*8),Le(_e(Q.concat(ee),640))}function In(Y){var Z="0123456789abcdef",j="",Ie,f;for(f=0;f<Y.length;f+=1)Ie=Y.charCodeAt(f),j+=Z.charAt(Ie>>>4&15)+Z.charAt(Ie&15);return j}function yn(Y){return unescape(encodeURIComponent(Y))}function cn(Y){return st(yn(Y))}function wn(Y){return In(cn(Y))}function kt(Y,Z){return qe(yn(Y),yn(Z))}function pa(Y,Z){return In(kt(Y,Z))}function ea(Y,Z,j){return Z?j?kt(Z,Y):pa(Z,Y):j?cn(Y):wn(Y)}Re=function(){return ea}.call(Oe,ot,Oe,Ge),Re!==void 0&&(Ge.exports=Re)})(this)},752:function(Ge){(function(Oe,ot){Ge.exports=ot()})(this,function(){"use strict";var Oe=1e3,ot=6e4,Re=36e5,nn="millisecond",Te="second",z="minute",G="hour",H="day",ce="week",de="month",ie="quarter",_e="year",Le="date",rt="Invalid Date",st=/^(\d{4})[-/]?(\d{1,2})?[-/]?(\d{0,2})[Tt\s]*(\d{1,2})?:?(\d{1,2})?:?(\d{1,2})?[.:]?(\d+)?$/,qe=/\[([^\]]+)]|Y{1,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,In={name:"en",weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_")},yn=function(f,Q,ee){var F=String(f);return!F||F.length>=Q?f:""+Array(Q+1-F.length).join(ee)+f},cn={s:yn,z:function(f){var Q=-f.utcOffset(),ee=Math.abs(Q),F=Math.floor(ee/60),D=ee%60;return(Q<=0?"+":"-")+yn(F,2,"0")+":"+yn(D,2,"0")},m:function f(Q,ee){if(Q.date()<ee.date())return-f(ee,Q);var F=12*(ee.year()-Q.year())+(ee.month()-Q.month()),D=Q.clone().add(F,de),O=ee-D<0,$=Q.clone().add(F+(O?-1:1),de);return+(-(F+(ee-D)/(O?D-$:$-D))||0)},a:function(f){return f<0?Math.ceil(f)||0:Math.floor(f)},p:function(f){return{M:de,y:_e,w:ce,d:H,D:Le,h:G,m:z,s:Te,ms:nn,Q:ie}[f]||String(f||"").toLowerCase().replace(/s$/,"")},u:function(f){return f===void 0}},wn="en",kt={};kt[wn]=In;var pa=function(f){return f instanceof j},ea=function f(Q,ee,F){var D;if(!Q)return wn;if(typeof Q=="string"){var O=Q.toLowerCase();kt[O]&&(D=O),ee&&(kt[O]=ee,D=O);var $=Q.split("-");if(!D&&$.length>1)return f($[0])}else{var B=Q.name;kt[B]=Q,D=B}return!F&&D&&(wn=D),D||!F&&wn},Y=function(f,Q){if(pa(f))return f.clone();var ee=typeof Q=="object"?Q:{};return ee.date=f,ee.args=arguments,new j(ee)},Z=cn;Z.l=ea,Z.i=pa,Z.w=function(f,Q){return Y(f,{locale:Q.$L,utc:Q.$u,x:Q.$x,$offset:Q.$offset})};var j=function(){function f(ee){this.$L=ea(ee.locale,null,!0),this.parse(ee)}var Q=f.prototype;return Q.parse=function(ee){this.$d=function(F){var D=F.date,O=F.utc;if(D===null)return new Date(NaN);if(Z.u(D))return new Date;if(D instanceof Date)return new Date(D);if(typeof D=="string"&&!/Z$/i.test(D)){var $=D.match(st);if($){var B=$[2]-1||0,re=($[7]||"0").substring(0,3);return O?new Date(Date.UTC($[1],B,$[3]||1,$[4]||0,$[5]||0,$[6]||0,re)):new Date($[1],B,$[3]||1,$[4]||0,$[5]||0,$[6]||0,re)}}return new Date(D)}(ee),this.$x=ee.x||{},this.init()},Q.init=function(){var ee=this.$d;this.$y=ee.getFullYear(),this.$M=ee.getMonth(),this.$D=ee.getDate(),this.$W=ee.getDay(),this.$H=ee.getHours(),this.$m=ee.getMinutes(),this.$s=ee.getSeconds(),this.$ms=ee.getMilliseconds()},Q.$utils=function(){return Z},Q.isValid=function(){return this.$d.toString()!==rt},Q.isSame=function(ee,F){var D=Y(ee);return this.startOf(F)<=D&&D<=this.endOf(F)},Q.isAfter=function(ee,F){return Y(ee)<this.startOf(F)},Q.isBefore=function(ee,F){return this.endOf(F)<Y(ee)},Q.$g=function(ee,F,D){return Z.u(ee)?this[F]:this.set(D,ee)},Q.unix=function(){return Math.floor(this.valueOf()/1e3)},Q.valueOf=function(){return this.$d.getTime()},Q.startOf=function(ee,F){var D=this,O=!!Z.u(F)||F,$=Z.p(ee),B=function(At,Ct){var Ne=Z.w(D.$u?Date.UTC(D.$y,Ct,At):new Date(D.$y,Ct,At),D);return O?Ne:Ne.endOf(H)},re=function(At,Ct){return Z.w(D.toDate()[At].apply(D.toDate("s"),(O?[0,0,0,0]:[23,59,59,999]).slice(Ct)),D)},De=this.$W,lt=this.$M,Mt=this.$D,et="set"+(this.$u?"UTC":"");switch($){case _e:return O?B(1,0):B(31,11);case de:return O?B(1,lt):B(0,lt+1);case ce:var ta=this.$locale().weekStart||0,oe=(De<ta?De+7:De)-ta;return B(O?Mt-oe:Mt+(6-oe),lt);case H:case Le:return re(et+"Hours",0);case G:return re(et+"Minutes",1);case z:return re(et+"Seconds",2);case Te:return re(et+"Milliseconds",3);default:return this.clone()}},Q.endOf=function(ee){return this.startOf(ee,!1)},Q.$set=function(ee,F){var D,O=Z.p(ee),$="set"+(this.$u?"UTC":""),B=(D={},D[H]=$+"Date",D[Le]=$+"Date",D[de]=$+"Month",D[_e]=$+"FullYear",D[G]=$+"Hours",D[z]=$+"Minutes",D[Te]=$+"Seconds",D[nn]=$+"Milliseconds",D)[O],re=O===H?this.$D+(F-this.$W):F;if(O===de||O===_e){var De=this.clone().set(Le,1);De.$d[B](re),De.init(),this.$d=De.set(Le,Math.min(this.$D,De.daysInMonth())).$d}else B&&this.$d[B](re);return this.init(),this},Q.set=function(ee,F){return this.clone().$set(ee,F)},Q.get=function(ee){return this[Z.p(ee)]()},Q.add=function(ee,F){var D,O=this;ee=Number(ee);var $=Z.p(F),B=function(lt){var Mt=Y(O);return Z.w(Mt.date(Mt.date()+Math.round(lt*ee)),O)};if($===de)return this.set(de,this.$M+ee);if($===_e)return this.set(_e,this.$y+ee);if($===H)return B(1);if($===ce)return B(7);var re=(D={},D[z]=ot,D[G]=Re,D[Te]=Oe,D)[$]||1,De=this.$d.getTime()+ee*re;return Z.w(De,this)},Q.subtract=function(ee,F){return this.add(-1*ee,F)},Q.format=function(ee){var F=this,D=this.$locale();if(!this.isValid())return D.invalidDate||rt;var O=ee||"YYYY-MM-DDTHH:mm:ssZ",$=Z.z(this),B=this.$H,re=this.$m,De=this.$M,lt=D.weekdays,Mt=D.months,et=function(Ct,Ne,Fe,ma){return Ct&&(Ct[Ne]||Ct(F,O))||Fe[Ne].slice(0,ma)},ta=function(Ct){return Z.s(B%12||12,Ct,"0")},oe=D.meridiem||function(Ct,Ne,Fe){var ma=Ct<12?"AM":"PM";return Fe?ma.toLowerCase():ma},At={YY:String(this.$y).slice(-2),YYYY:this.$y,M:De+1,MM:Z.s(De+1,2,"0"),MMM:et(D.monthsShort,De,Mt,3),MMMM:et(Mt,De),D:this.$D,DD:Z.s(this.$D,2,"0"),d:String(this.$W),dd:et(D.weekdaysMin,this.$W,lt,2),ddd:et(D.weekdaysShort,this.$W,lt,3),dddd:lt[this.$W],H:String(B),HH:Z.s(B,2,"0"),h:ta(1),hh:ta(2),a:oe(B,re,!0),A:oe(B,re,!1),m:String(re),mm:Z.s(re,2,"0"),s:String(this.$s),ss:Z.s(this.$s,2,"0"),SSS:Z.s(this.$ms,3,"0"),Z:$};return O.replace(qe,function(Ct,Ne){return Ne||At[Ct]||$.replace(":","")})},Q.utcOffset=function(){return 15*-Math.round(this.$d.getTimezoneOffset()/15)},Q.diff=function(ee,F,D){var O,$=Z.p(F),B=Y(ee),re=(B.utcOffset()-this.utcOffset())*ot,De=this-B,lt=Z.m(this,B);return lt=(O={},O[_e]=lt/12,O[de]=lt,O[ie]=lt/3,O[ce]=(De-re)/6048e5,O[H]=(De-re)/864e5,O[G]=De/Re,O[z]=De/ot,O[Te]=De/Oe,O)[$]||De,D?lt:Z.a(lt)},Q.daysInMonth=function(){return this.endOf(de).$D},Q.$locale=function(){return kt[this.$L]},Q.locale=function(ee,F){if(!ee)return this.$L;var D=this.clone(),O=ea(ee,F,!0);return O&&(D.$L=O),D},Q.clone=function(){return Z.w(this.$d,this)},Q.toDate=function(){return new Date(this.valueOf())},Q.toJSON=function(){return this.isValid()?this.toISOString():null},Q.toISOString=function(){return this.$d.toISOString()},Q.toString=function(){return this.$d.toUTCString()},f}(),Ie=j.prototype;return Y.prototype=Ie,[["$ms",nn],["$s",Te],["$m",z],["$H",G],["$W",H],["$M",de],["$y",_e],["$D",Le]].forEach(function(f){Ie[f[1]]=function(Q){return this.$g(Q,f[0],f[1])}}),Y.extend=function(f,Q){return f.$i||(f(Q,j,Y),f.$i=!0),Y},Y.locale=ea,Y.isDayjs=pa,Y.unix=function(f){return Y(1e3*f)},Y.en=kt[wn],Y.Ls=kt,Y.p={},Y})},101:Ge=>{"use strict";function Oe(Te){if(typeof Te!="string")throw new TypeError("Path must be a string. Received "+JSON.stringify(Te))}function ot(Te,z){for(var G="",H=0,ce=-1,de=0,ie,_e=0;_e<=Te.length;++_e){if(_e<Te.length)ie=Te.charCodeAt(_e);else{if(ie===47)break;ie=47}if(ie===47){if(!(ce===_e-1||de===1))if(ce!==_e-1&&de===2){if(G.length<2||H!==2||G.charCodeAt(G.length-1)!==46||G.charCodeAt(G.length-2)!==46){if(G.length>2){var Le=G.lastIndexOf("/");if(Le!==G.length-1){Le===-1?(G="",H=0):(G=G.slice(0,Le),H=G.length-1-G.lastIndexOf("/")),ce=_e,de=0;continue}}else if(G.length===2||G.length===1){G="",H=0,ce=_e,de=0;continue}}z&&(G.length>0?G+="/..":G="..",H=2)}else G.length>0?G+="/"+Te.slice(ce+1,_e):G=Te.slice(ce+1,_e),H=_e-ce-1;ce=_e,de=0}else ie===46&&de!==-1?++de:de=-1}return G}function Re(Te,z){var G=z.dir||z.root,H=z.base||(z.name||"")+(z.ext||"");return G?G===z.root?G+H:G+Te+H:H}var nn={resolve:function(){for(var z="",G=!1,H,ce=arguments.length-1;ce>=-1&&!G;ce--){var de;ce>=0?de=arguments[ce]:(H===void 0&&(H=process.cwd()),de=H),Oe(de),de.length!==0&&(z=de+"/"+z,G=de.charCodeAt(0)===47)}return z=ot(z,!G),G?z.length>0?"/"+z:"/":z.length>0?z:"."},normalize:function(z){if(Oe(z),z.length===0)return".";var G=z.charCodeAt(0)===47,H=z.charCodeAt(z.length-1)===47;return z=ot(z,!G),z.length===0&&!G&&(z="."),z.length>0&&H&&(z+="/"),G?"/"+z:z},isAbsolute:function(z){return Oe(z),z.length>0&&z.charCodeAt(0)===47},join:function(){if(arguments.length===0)return".";for(var z,G=0;G<arguments.length;++G){var H=arguments[G];Oe(H),H.length>0&&(z===void 0?z=H:z+="/"+H)}return z===void 0?".":nn.normalize(z)},relative:function(z,G){if(Oe(z),Oe(G),z===G||(z=nn.resolve(z),G=nn.resolve(G),z===G))return"";for(var H=1;H<z.length&&z.charCodeAt(H)===47;++H);for(var ce=z.length,de=ce-H,ie=1;ie<G.length&&G.charCodeAt(ie)===47;++ie);for(var _e=G.length,Le=_e-ie,rt=de<Le?de:Le,st=-1,qe=0;qe<=rt;++qe){if(qe===rt){if(Le>rt){if(G.charCodeAt(ie+qe)===47)return G.slice(ie+qe+1);if(qe===0)return G.slice(ie+qe)}else de>rt&&(z.charCodeAt(H+qe)===47?st=qe:qe===0&&(st=0));break}var In=z.charCodeAt(H+qe),yn=G.charCodeAt(ie+qe);if(In!==yn)break;In===47&&(st=qe)}var cn="";for(qe=H+st+1;qe<=ce;++qe)(qe===ce||z.charCodeAt(qe)===47)&&(cn.length===0?cn+="..":cn+="/..");return cn.length>0?cn+G.slice(ie+st):(ie+=st,G.charCodeAt(ie)===47&&++ie,G.slice(ie))},_makeLong:function(z){return z},dirname:function(z){if(Oe(z),z.length===0)return".";for(var G=z.charCodeAt(0),H=G===47,ce=-1,de=!0,ie=z.length-1;ie>=1;--ie)if(G=z.charCodeAt(ie),G===47){if(!de){ce=ie;break}}else de=!1;return ce===-1?H?"/":".":H&&ce===1?"//":z.slice(0,ce)},basename:function(z,G){if(G!==void 0&&typeof G!="string")throw new TypeError('"ext" argument must be a string');Oe(z);var H=0,ce=-1,de=!0,ie;if(G!==void 0&&G.length>0&&G.length<=z.length){if(G.length===z.length&&G===z)return"";var _e=G.length-1,Le=-1;for(ie=z.length-1;ie>=0;--ie){var rt=z.charCodeAt(ie);if(rt===47){if(!de){H=ie+1;break}}else Le===-1&&(de=!1,Le=ie+1),_e>=0&&(rt===G.charCodeAt(_e)?--_e===-1&&(ce=ie):(_e=-1,ce=Le))}return H===ce?ce=Le:ce===-1&&(ce=z.length),z.slice(H,ce)}else{for(ie=z.length-1;ie>=0;--ie)if(z.charCodeAt(ie)===47){if(!de){H=ie+1;break}}else ce===-1&&(de=!1,ce=ie+1);return ce===-1?"":z.slice(H,ce)}},extname:function(z){Oe(z);for(var G=-1,H=0,ce=-1,de=!0,ie=0,_e=z.length-1;_e>=0;--_e){var Le=z.charCodeAt(_e);if(Le===47){if(!de){H=_e+1;break}continue}ce===-1&&(de=!1,ce=_e+1),Le===46?G===-1?G=_e:ie!==1&&(ie=1):G!==-1&&(ie=-1)}return G===-1||ce===-1||ie===0||ie===1&&G===ce-1&&G===H+1?"":z.slice(G,ce)},format:function(z){if(z===null||typeof z!="object")throw new TypeError('The "pathObject" argument must be of type Object. Received type '+typeof z);return Re("/",z)},parse:function(z){Oe(z);var G={root:"",dir:"",base:"",ext:"",name:""};if(z.length===0)return G;var H=z.charCodeAt(0),ce=H===47,de;ce?(G.root="/",de=1):de=0;for(var ie=-1,_e=0,Le=-1,rt=!0,st=z.length-1,qe=0;st>=de;--st){if(H=z.charCodeAt(st),H===47){if(!rt){_e=st+1;break}continue}Le===-1&&(rt=!1,Le=st+1),H===46?ie===-1?ie=st:qe!==1&&(qe=1):ie!==-1&&(qe=-1)}return ie===-1||Le===-1||qe===0||qe===1&&ie===Le-1&&ie===_e+1?Le!==-1&&(_e===0&&ce?G.base=G.name=z.slice(1,Le):G.base=G.name=z.slice(_e,Le)):(_e===0&&ce?(G.name=z.slice(1,ie),G.base=z.slice(1,Le)):(G.name=z.slice(_e,ie),G.base=z.slice(_e,Le)),G.ext=z.slice(ie,Le)),_e>0?G.dir=z.slice(0,_e-1):ce&&(G.dir="/"),G},sep:"/",delimiter:":",win32:null,posix:null};nn.posix=nn,Ge.exports=nn}},Co={};function Jt(Ge){var Oe=Co[Ge];if(Oe!==void 0)return Oe.exports;var ot=Co[Ge]={exports:{}};return tu[Ge].call(ot.exports,ot,ot.exports,Jt),ot.exports}Jt.n=Ge=>{var Oe=Ge&&Ge.__esModule?()=>Ge.default:()=>Ge;return Jt.d(Oe,{a:Oe}),Oe},Jt.d=(Ge,Oe)=>{for(var ot in Oe)Jt.o(Oe,ot)&&!Jt.o(Ge,ot)&&Object.defineProperty(Ge,ot,{enumerable:!0,get:Oe[ot]})},Jt.o=(Ge,Oe)=>Object.prototype.hasOwnProperty.call(Ge,Oe),Jt.r=Ge=>{typeof Symbol!="undefined"&&Symbol.toStringTag&&Object.defineProperty(Ge,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(Ge,"__esModule",{value:!0})};var nm={};(()=>{"use strict";var Ge={};Jt.r(Ge),Jt.d(Ge,{copyPlainText:()=>Xi,getEventName:()=>wa,getLocalStorage:()=>Ho,isDisabledFeature:()=>Io,isHuawei:()=>$o,isIPad:()=>gi,isIPhone:()=>Dn,isInAndroid:()=>ft,isInHarmony:()=>yt,isInIOS:()=>Qt,isMac:()=>Lt,isNotCtrl:()=>Ue,isOnlyMeta:()=>bt,isWin11:()=>Do,isWindows:()=>Mo,openByMobile:()=>Et,readClipboard:()=>al,readText:()=>nl,setStorageVal:()=>Ae,updateHotkeyTip:()=>Me,writeText:()=>Be});var Oe=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{o(n.next(r))}catch(c){s(c)}},l=r=>{try{o(n.throw(r))}catch(c){s(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,l);o((n=n.apply(e,t)).next())});const ot=(e,t)=>Oe(void 0,null,function*(){if(document.getElementById(t))return!1;const n=new XMLHttpRequest;n.open("GET",e,!1),n.setRequestHeader("Accept","text/javascript, application/javascript, application/ecmascript, application/x-ecmascript, */*; q=0.01"),n.send("");const a=document.createElement("script");a.type="text/javascript",a.text=n.responseText,a.id=t,document.head.appendChild(a),typeof Lute=="undefined"&&window.location.reload()}),Re=(e,t)=>new Promise(n=>{if(document.getElementById(t))return n(!1),!1;const a=document.createElement("script");a.src=e,a.async=!0,document.head.appendChild(a),a.onload=()=>{if(document.getElementById(t))return a.remove(),n(!1),!1;a.id=t,n(!0)}}),nn=new Set(["docker","ios","android","harmony"]),Te=new Set(["ios","android","harmony"]),z=()=>nn.has(window.siyuan.config.system.container),G=()=>Te.has(window.siyuan.config.system.container),H=()=>!!document.getElementById("sidebar"),ce=()=>z()?window.siyuan.config.system.container:window.siyuan.config.system.os,de=()=>window.navigator.userAgent.startsWith("SiYuan/")?"mobile":"browser-mobile",ie=()=>!document.getElementById("toolbar"),_e=()=>"ontouchstart"in window&&navigator.maxTouchPoints>1,Le=(e,t)=>e.length===t.length&&e.every(n=>t.includes(n)),rt=(e,t)=>Math.floor(Math.random()*(t-e+1))+e,st=(e,t=window.location.search)=>{const n=t.substring(t.indexOf("?")),a=n.indexOf("#");return new URLSearchParams(n.substring(0,a>=0?a:void 0)).get(e)},qe=()=>!0,In=e=>/^\(\(\d{14}-\w{7} '.*'\)\)$/.test(e),yn=e=>/^<<assets\/.+\/\d{14}-\w{7} ".+">>$/.test(e),cn=e=>/^[_a-zA-Z][_.\-0-9a-zA-Z]*$/.test(e),wn=e=>Function(`"use strict";return (${e})`)(),kt=(e,t)=>{if(e===t||typeof e=="number"&&isNaN(e)&&typeof t=="number"&&isNaN(t))return!0;if(e instanceof Date&&t instanceof Date)return e.getTime()===t.getTime();if(!e||!t||typeof e!="object"&&typeof t!="object")return e===t;if(e.prototype!==t.prototype)return!1;const n=Object.keys(e);return n.length!==Object.keys(t).length?!1:n.every(a=>kt(e[a],t[a]))},pa=e=>{const t=e.match(/^(.*) \((\d+)\)$/);return t?e=`${t[1]} (${parseInt(t[2])+1})`:e=`${e} (1)`,e},ea="3.1.24",Y="production",Z=navigator.platform.toUpperCase().indexOf("MAC")>-1?"\u2303":"\u2325",j=()=>{const e={};for(let t=1;t<=32;t++)e[t+111]="F"+t;return e},Ie=class{};let f=Ie;f.SIYUAN_VERSION=ea,f.NODE_ENV=Y,f.SIYUAN_APPID=Math.random().toString(36).substring(8),f.ASSETS_ADDRESS="https://assets.b3logfile.com/siyuan/",f.PROTYLE_CDN="/stage/protyle",f.UPLOAD_ADDRESS="/upload",f.SERVICE_WORKER_PATH="/service-worker.js",f.SIYUAN_DROP_FILE="application/siyuan-file",f.SIYUAN_DROP_GUTTER="application/siyuan-gutter",f.SIYUAN_DROP_TAB="application/siyuan-tab",f.SIYUAN_DROP_EDITOR="application/siyuan-editor",f.SIYUAN_CMD="siyuan-cmd",f.SIYUAN_GET="siyuan-get",f.SIYUAN_EVENT="siyuan-event",f.SIYUAN_CONFIG_TRAY="siyuan-config-tray",f.SIYUAN_QUIT="siyuan-quit",f.SIYUAN_HOTKEY="siyuan-hotkey",f.SIYUAN_INIT="siyuan-init",f.SIYUAN_SEND_WINDOWS="siyuan-send-windows",f.SIYUAN_SAVE_CLOSE="siyuan-save-close",f.SIYUAN_AUTO_LAUNCH="siyuan-auto-launch",f.SIYUAN_OPEN_WORKSPACE="siyuan-open-workspace",f.SIYUAN_OPEN_URL="siyuan-open-url",f.SIYUAN_OPEN_WINDOW="siyuan-open-window",f.SIYUAN_OPEN_FOLDER="siyuan-open-folder",f.SIYUAN_OPEN_FILE="siyuan-open-file",f.SIYUAN_EXPORT_PDF="siyuan-export-pdf",f.SIYUAN_EXPORT_NEWWINDOW="siyuan-export-newwindow",f.SIYUAN_CONTEXT_MENU="siyuan-context-menu",f.SIYUAN_SHOW_WINDOW="siyuan-show-window",f.CUSTOM_SY_READONLY="custom-sy-readonly",f.CUSTOM_SY_FULLWIDTH="custom-sy-fullwidth",f.CUSTOM_SY_AV_VIEW="custom-sy-av-view",f.CUSTOM_REMINDER_WECHAT="custom-reminder-wechat",f.CUSTOM_RIFF_DECKS="custom-riff-decks",f.SIZE_DATABASE_MAZ_SIZE=102400,f.SIZE_SCROLL_TB=24,f.SIZE_SCROLL_STEP=256,f.SIZE_LINK_TEXT_MAX=64,f.SIZE_TOOLBAR_HEIGHT=H()?0:32,f.SIZE_GET_MAX=102400,f.SIZE_UNDO=64,f.SIZE_TITLE=512,f.SIZE_EDITOR_WIDTH=760,f.SIZE_ZOOM=[{zoom:.67,position:{x:0,y:2}},{zoom:.75,position:{x:1,y:4}},{zoom:.8,position:{x:2,y:4}},{zoom:.9,position:{x:5,y:6}},{zoom:1,position:{x:8,y:8}},{zoom:1.1,position:{x:12,y:9}},{zoom:1.25,position:{x:18,y:12}},{zoom:1.5,position:{x:27,y:16}},{zoom:1.75,position:{x:36,y:20}},{zoom:2,position:{x:45,y:23}},{zoom:2.5,position:{x:63,y:31}},{zoom:3,position:{x:80,y:39}}],f.CB_MOVE_NOLIST="cb-move-nolist",f.CB_MOUNT_REMOVE="cb-mount-remove",f.CB_GET_APPEND="cb-get-append",f.CB_GET_BEFORE="cb-get-before",f.CB_GET_UNCHANGEID="cb-get-unchangeid",f.CB_GET_HL="cb-get-hl",f.CB_GET_FOCUS="cb-get-focus",f.CB_GET_FOCUSFIRST="cb-get-focusfirst",f.CB_GET_SETID="cb-get-setid",f.CB_GET_ALL="cb-get-all",f.CB_GET_BACKLINK="cb-get-backlink",f.CB_GET_UNUNDO="cb-get-unundo",f.CB_GET_SCROLL="cb-get-scroll",f.CB_GET_CONTEXT="cb-get-context",f.CB_GET_ROOTSCROLL="cb-get-rootscroll",f.CB_GET_HTML="cb-get-html",f.CB_GET_HISTORY="cb-get-history",f.CB_GET_OPENNEW="cb-get-opennew",f.LOCAL_ZOOM="local-zoom",f.LOCAL_SEARCHDATA="local-searchdata",f.LOCAL_SEARCHKEYS="local-searchkeys",f.LOCAL_SEARCHASSET="local-searchasset",f.LOCAL_SEARCHUNREF="local-searchunref",f.LOCAL_DOCINFO="local-docinfo",f.LOCAL_DAILYNOTEID="local-dailynoteid",f.LOCAL_HISTORY="local-history",f.LOCAL_CODELANG="local-codelang",f.LOCAL_FONTSTYLES="local-fontstyles",f.LOCAL_EXPORTPDF="local-exportpdf",f.LOCAL_EXPORTWORD="local-exportword",f.LOCAL_EXPORTIMG="local-exportimg",f.LOCAL_BAZAAR="local-bazaar",f.LOCAL_PDFTHEME="local-pdftheme",f.LOCAL_LAYOUTS="local-layouts",f.LOCAL_AI="local-ai",f.LOCAL_PLUGINTOPUNPIN="local-plugintopunpin",f.LOCAL_FLASHCARD="local-flashcard",f.LOCAL_FILEPOSITION="local-fileposition",f.LOCAL_FILESPATHS="local-filespaths",f.LOCAL_DIALOGPOSITION="local-dialogposition",f.LOCAL_SESSION_FIRSTLOAD="local-session-firstload",f.LOCAL_OUTLINE="local-outline",f.LOCAL_PLUGIN_DOCKS="local-plugin-docks",f.LOCAL_IMAGES="local-images",f.LOCAL_EMOJIS="local-emojis",f.LOCAL_MOVE_PATH="local-move-path",f.DIALOG_CONFIRM="dialog-confirm",f.DIALOG_OPENCARD="dialog-opencard",f.DIALOG_MAKECARD="dialog-makecard",f.DIALOG_VIEWCARDS="dialog-viewcards",f.DIALOG_DIALYNOTE="dialog-dialynote",f.DIALOG_RECENTDOCS="dialog-recentdocs",f.DIALOG_SWITCHTAB="dialog-switchtab",f.DIALOG_SEARCH="dialog-search",f.DIALOG_REPLACE="dialog-replace",f.DIALOG_GLOBALSEARCH="dialog-globalsearch",f.DIALOG_HISTORYCOMPARE="dialog-historycompare",f.DIALOG_ACCESSAUTHCODE="dialog-accessauthcode",f.DIALOG_AICUSTOMACTION="dialog-aicustomaction",f.DIALOG_AIUPDATECUSTOMACTION="dialog-aiupdatecustomaction",f.DIALOG_BACKGROUNDLINK="dialog-backgroundlink",f.DIALOG_BACKGROUNDRANDOM="dialog-backgroundrandom",f.DIALOG_CHANGELOG="dialog-changelog",f.DIALOG_COMMANDPANEL="dialog-commandpanel",f.DIALOG_DEACTIVATEUSER="dialog-deactivateuser",f.DIALOG_EMOJIS="dialog-emojis",f.DIALOG_EXPORTIMAGE="dialog-exportimage",f.DIALOG_EXPORTTEMPLATE="dialog-exporttemplate",f.DIALOG_EXPORTWORD="dialog-exportword",f.DIALOG_HISTORY="dialog-history",f.DIALOG_HISTORYDOC="dialog-historydoc",f.DIALOG_MOVEPATHTO="dialog-movepathto",f.DIALOG_RENAME="dialog-rename",f.DIALOG_RENAMEASSETS="dialog-renameassets",f.DIALOG_RENAMEBOOKMARK="dialog-renamebookmark",f.DIALOG_RENAMETAG="dialog-renametag",f.DIALOG_REPLACETYPE="dialog-replacetype",f.DIALOG_SAVECRITERION="dialog-savecriterion",f.DIALOG_SEARCHTYPE="dialog-searchtype",f.DIALOG_SEARCHASSETSTYPE="dialog-searchassetstype",f.DIALOG_SETTING="dialog-setting",f.DIALOG_SNAPSHOTTAG="dialog-snapshottag",f.DIALOG_SNAPSHOTMEMO="dialog-snapshotmemo",f.DIALOG_SNIPPETS="dialog-snippets",f.DIALOG_SYNCADDCLOUDDIR="dialog-syncaddclouddir",f.DIALOG_SYNCCHOOSEDIR="dialog-syncchoosedir",f.DIALOG_SYNCCHOOSEDIRECTION="dialog-syncchoosedirection",f.DIALOG_TRANSFERBLOCKREF="dialog-transferblockref",f.DIALOG_WECHATREMINDER="dialog-wechatreminder",f.DIALOG_PASSWORD="dialog-password",f.DIALOG_SETPASSWORD="dialog-setpassword",f.DIALOG_BOOTSYNCFAILED="dialog-bootsyncfailed",f.DIALOG_KERNELFAULT="dialog-kernelfault",f.DIALOG_STATEEXCEPTED="dialog-stateexcepted",f.DIALOG_ATTR="dialog-attr",f.DIALOG_SETCUSTOMATTR="dialog-setcustomattr",f.DIALOG_CREATENOTEBOOK="dialog-createnotebook",f.DIALOG_NOTEBOOKCONF="dialog-notebookconf",f.DIALOG_CREATEWORKSPACE="dialog-createworkspace",f.DIALOG_OPENWORKSPACE="dialog-openworkspace",f.DIALOG_SAVEWORKSPACE="dialog-saveworkspace",f.TIMEOUT_DBLCLICK=190,f.TIMEOUT_INPUT=256,f.TIMEOUT_LOAD=300,f.TIMEOUT_TRANSITION=300,f.TIMEOUT_COUNT=1e3,f.HELP_PATH={zh_CN:"20210808180117-czj9bvb",zh_CHT:"20211226090932-5lcq56f",ja_JP:"20240530133126-axarxgx",en_US:"20210808180117-6v0mkxr",fr_FR:"20210808180117-6v0mkxr",es_ES:"20210808180117-6v0mkxr",it_IT:"20210808180117-6v0mkxr",de_DE:"20210808180117-6v0mkxr",he_IL:"20210808180117-6v0mkxr",ru_RU:"20210808180117-6v0mkxr",pl_PL:"20210808180117-6v0mkxr",ar_SA:"20210808180117-6v0mkxr"},f.QUICK_DECK_ID="20230218211946-2kw8jgx",f.KEYCODELIST=Object.assign(j(),{8:"\u232B",9:"\u21E5",13:"\u21A9",16:"\u21E7",17:"\u2303",18:"\u2325",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"\u2190",38:"\u2191",39:"\u2192",40:"\u2193",44:"PrintScreen",45:"Insert",46:"\u2326",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",65:"A",66:"B",67:"C",68:"D",69:"E",70:"F",71:"G",72:"H",73:"I",74:"J",75:"K",76:"L",77:"M",78:"N",79:"O",80:"P",81:"Q",82:"R",83:"S",84:"T",85:"U",86:"V",87:"W",88:"X",89:"Y",90:"Z",91:"\u2318",92:"\u2318",93:"ContextMenu",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"*",107:"+",109:"-",110:".",111:"/",144:"NumLock",145:"ScrollLock",182:"MyComputer",183:"MyCalculator",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"}),f.SIYUAN_KEYMAP={general:{mainMenu:{default:"\u2325\\",custom:"\u2325\\"},commandPanel:{default:"\u2325\u21E7P",custom:"\u2325\u21E7P"},editReadonly:{default:"\u21E7\u2318G",custom:"\u21E7\u2318G"},syncNow:{default:"F9",custom:"F9"},enterBack:{default:"\u2325\u2190",custom:"\u2325\u2190"},enter:{default:"\u2325\u2192",custom:"\u2325\u2192"},goForward:{default:"\u2318]",custom:"\u2318]"},goBack:{default:"\u2318[",custom:"\u2318["},newFile:{default:"\u2318N",custom:"\u2318N"},search:{default:"\u2318F",custom:"\u2318F"},globalSearch:{default:"\u2318P",custom:"\u2318P"},stickSearch:{default:"\u21E7\u2318F",custom:"\u21E7\u2318F"},replace:{default:"\u2318R",custom:"\u2318R"},closeTab:{default:"\u2318W",custom:"\u2318W"},fileTree:{default:Z+"1",custom:Z+"1"},outline:{default:Z+"2",custom:Z+"2"},bookmark:{default:Z+"3",custom:Z+"3"},tag:{default:Z+"4",custom:Z+"4"},dailyNote:{default:Z+"5",custom:Z+"5"},inbox:{default:Z+"6",custom:Z+"6"},backlinks:{default:Z+"7",custom:Z+"7"},graphView:{default:Z+"8",custom:Z+"8"},globalGraph:{default:Z+"9",custom:Z+"9"},riffCard:{default:Z+"0",custom:Z+"0"},config:{default:"\u2325P",custom:"\u2325P"},dataHistory:{default:"\u2325H",custom:"\u2325H"},toggleWin:{default:"\u2325M",custom:"\u2325M"},lockScreen:{default:"\u2325N",custom:"\u2325N"},recentDocs:{default:"\u2318E",custom:"\u2318E"},goToTab1:{default:"\u23181",custom:"\u23181"},goToTab2:{default:"\u23182",custom:"\u23182"},goToTab3:{default:"\u23183",custom:"\u23183"},goToTab4:{default:"\u23184",custom:"\u23184"},goToTab5:{default:"\u23185",custom:"\u23185"},goToTab6:{default:"\u23186",custom:"\u23186"},goToTab7:{default:"\u23187",custom:"\u23187"},goToTab8:{default:"\u23188",custom:"\u23188"},goToTab9:{default:"\u23189",custom:"\u23189"},goToTabNext:{default:"\u21E7\u2318]",custom:"\u21E7\u2318]"},goToTabPrev:{default:"\u21E7\u2318[",custom:"\u21E7\u2318["},goToEditTabNext:{default:"\u2303\u21E5",custom:"\u2303\u21E5"},goToEditTabPrev:{default:"\u2303\u21E7\u21E5",custom:"\u2303\u21E7\u21E5"},move:{default:"",custom:""},selectOpen1:{default:"",custom:""},toggleDock:{default:"",custom:""},splitLR:{default:"",custom:""},splitMoveR:{default:"",custom:""},splitTB:{default:"",custom:""},splitMoveB:{default:"",custom:""},closeOthers:{default:"",custom:""},closeAll:{default:"",custom:""},closeUnmodified:{default:"",custom:""},closeLeft:{default:"",custom:""},closeRight:{default:"",custom:""},tabToWindow:{default:"",custom:""},addToDatabase:{default:"",custom:""},unsplit:{default:"",custom:""},unsplitAll:{default:"",custom:""}},editor:{general:{duplicate:{default:"\u2318D",custom:"\u2318D"},expandDown:{default:"\u2325\u21E7\u2193",custom:"\u2325\u21E7\u2193"},expandUp:{default:"\u2325\u21E7\u2191",custom:"\u2325\u21E7\u2191"},expand:{default:"\u2318\u2193",custom:"\u2318\u2193"},collapse:{default:"\u2318\u2191",custom:"\u2318\u2191"},insertBottom:{default:"\u2325\u2318.",custom:"\u2325\u2318."},refTab:{default:"\u21E7\u2318.",custom:"\u21E7\u2318."},openBy:{default:"\u2325,",custom:"\u2325,"},insertRight:{default:"\u2325.",custom:"\u2325."},attr:{default:"\u2325\u2318A",custom:"\u2325\u2318A"},quickMakeCard:{default:"\u2325\u2318F",custom:"\u2325\u2318F"},refresh:{default:"F5",custom:"F5"},copyBlockRef:{default:"\u21E7\u2318C",custom:"\u21E7\u2318C"},copyProtocol:{default:"\u21E7\u2318H",custom:"\u21E7\u2318H"},copyBlockEmbed:{default:"\u21E7\u2318E",custom:"\u21E7\u2318E"},copyHPath:{default:"\u21E7\u2318P",custom:"\u21E7\u2318P"},undo:{default:"\u2318Z",custom:"\u2318Z"},redo:{default:"\u2318Y",custom:"\u2318Y"},rename:{default:"F2",custom:"F2"},newNameFile:{default:"F3",custom:"F3"},newContentFile:{default:"F4",custom:"F4"},newNameSettingFile:{default:"\u2318F3",custom:"\u2318F3"},showInFolder:{default:"\u2325A",custom:"\u2325A"},outline:{default:"\u2325O",custom:"\u2325O"},backlinks:{default:"\u2325B",custom:"\u2325B"},graphView:{default:"\u2325G",custom:"\u2325G"},spaceRepetition:{default:"\u2325F",custom:"\u2325F"},fullscreen:{default:"\u2325Y",custom:"\u2325Y"},alignLeft:{default:"\u2325L",custom:"\u2325L"},alignCenter:{default:"\u2325C",custom:"\u2325C"},alignRight:{default:"\u2325R",custom:"\u2325R"},wysiwyg:{default:"\u2325\u23187",custom:"\u2325\u23187"},preview:{default:"\u2325\u23189",custom:"\u2325\u23189"},insertBefore:{default:"\u21E7\u2318B",custom:"\u21E7\u2318B"},insertAfter:{default:"\u21E7\u2318A",custom:"\u21E7\u2318A"},jumpToParentNext:{default:"\u21E7\u2318N",custom:"\u21E7\u2318N"},jumpToParentPrev:{default:"\u21E7\u2318M",custom:"\u21E7\u2318M"},jumpToParent:{default:"\u21E7\u2318J",custom:"\u21E7\u2318J"},moveToUp:{default:"\u21E7\u2318\u2191",custom:"\u21E7\u2318\u2191"},moveToDown:{default:"\u21E7\u2318\u2193",custom:"\u21E7\u2318\u2193"},duplicateCompletely:{default:"",custom:""},copyPlainText:{default:"",custom:""},copyID:{default:"",custom:""},copyProtocolInMd:{default:"",custom:""},netImg2LocalAsset:{default:"",custom:""},netAssets2LocalAssets:{default:"",custom:""},optimizeTypography:{default:"",custom:""},hLayout:{default:"",custom:""},vLayout:{default:"",custom:""},refPopover:{default:"",custom:""},copyText:{default:"",custom:""},exitFocus:{default:"",custom:""},ai:{default:"",custom:""},switchReadonly:{default:"",custom:""},switchAdjust:{default:"",custom:""},rtl:{default:"",custom:""},ltr:{default:"",custom:""},aiWriting:{default:"",custom:""},openInNewTab:{default:"",custom:""}},insert:{appearance:{default:"\u2325\u2318X",custom:"\u2325\u2318X"},lastUsed:{default:"\u2325X",custom:"\u2325X"},ref:{default:"\u2325[",custom:"\u2325["},kbd:{default:"\u2318'",custom:"\u2318'"},sup:{default:"\u2318H",custom:"\u2318H"},sub:{default:"\u2318J",custom:"\u2318J"},bold:{default:"\u2318B",custom:"\u2318B"},"inline-math":{default:"\u2318M",custom:"\u2318M"},memo:{default:"\u2325\u2318M",custom:"\u2325\u2318M"},underline:{default:"\u2318U",custom:"\u2318U"},italic:{default:"\u2318I",custom:"\u2318I"},mark:{default:"\u2325D",custom:"\u2325D"},tag:{default:"\u2318T",custom:"\u2318T"},strike:{default:"\u21E7\u2318S",custom:"\u21E7\u2318S"},"inline-code":{default:"\u2318G",custom:"\u2318G"},link:{default:"\u2318K",custom:"\u2318K"},check:{default:"\u2318L",custom:"\u2318L"},"ordered-list":{default:"",custom:""},list:{default:"",custom:""},table:{default:"\u2318O",custom:"\u2318O"},code:{default:"\u21E7\u2318K",custom:"\u21E7\u2318K"},quote:{default:"",custom:""},clearInline:{default:"\u2318\\",custom:"\u2318\\"}},heading:{paragraph:{default:"\u2325\u23180",custom:"\u2325\u23180"},heading1:{default:"\u2325\u23181",custom:"\u2325\u23181"},heading2:{default:"\u2325\u23182",custom:"\u2325\u23182"},heading3:{default:"\u2325\u23183",custom:"\u2325\u23183"},heading4:{default:"\u2325\u23184",custom:"\u2325\u23184"},heading5:{default:"\u2325\u23185",custom:"\u2325\u23185"},heading6:{default:"\u2325\u23186",custom:"\u2325\u23186"}},list:{indent:{default:"\u21E5",custom:"\u21E5"},outdent:{default:"\u21E7\u21E5",custom:"\u21E7\u21E5"},checkToggle:{default:"\u2318\u21A9",custom:"\u2318\u21A9"}},table:{insertRowAbove:{default:"\u21E7\u2318T",custom:"\u21E7\u2318T"},insertRowBelow:{default:"\u21E7\u2318D",custom:"\u21E7\u2318D"},insertColumnLeft:{default:"\u21E7\u2318L",custom:"\u21E7\u2318L"},insertColumnRight:{default:"\u21E7\u2318R",custom:"\u21E7\u2318R"},moveToUp:{default:"\u2325\u2318T",custom:"\u2325\u2318T"},moveToDown:{default:"\u2325\u2318B",custom:"\u2325\u2318B"},moveToLeft:{default:"\u2325\u2318L",custom:"\u2325\u2318L"},moveToRight:{default:"\u2325\u2318R",custom:"\u2325\u2318R"},"delete-row":{default:"\u2318-",custom:"\u2318-"},"delete-column":{default:"\u21E7\u2318-",custom:"\u21E7\u2318-"}}},plugin:{}},f.SIYUAN_EMPTY_LAYOUT={hideDock:!1,layout:{direction:"tb",size:"0px",type:"normal",instance:"Layout",children:[{direction:"lr",size:"auto",type:"normal",instance:"Layout",children:[{direction:"tb",size:"0px",type:"left",instance:"Layout",children:[{instance:"Wnd",children:[]},{instance:"Wnd",resize:"tb",children:[]}]},{direction:"lr",resize:"lr",size:"auto",type:"center",instance:"Layout",children:[{instance:"Wnd",children:[{instance:"Tab",children:[]}]}]},{direction:"tb",size:"0px",resize:"lr",type:"right",instance:"Layout",children:[{instance:"Wnd",children:[]},{instance:"Wnd",resize:"tb",children:[]}]}]},{direction:"lr",size:"0px",resize:"tb",type:"bottom",instance:"Layout",children:[{instance:"Wnd",children:[]},{instance:"Wnd",resize:"lr",children:[]}]}]},bottom:{pin:!0,data:[]},left:{pin:!0,data:[[{type:"file",size:{width:232,height:0},show:!0,icon:"iconFiles",hotkeyLangId:"fileTree"},{type:"outline",size:{width:232,height:0},show:!1,icon:"iconAlignCenter",hotkeyLangId:"outline"},{type:"inbox",size:{width:320,height:0},show:!1,icon:"iconInbox",hotkeyLangId:"inbox"}],[{type:"bookmark",size:{width:232,height:0},show:!1,icon:"iconBookmark",hotkeyLangId:"bookmark"},{type:"tag",size:{width:232,height:0},show:!1,icon:"iconTags",hotkeyLangId:"tag"}]]},right:{pin:!0,data:[[{type:"graph",size:{width:320,height:0},show:!1,icon:"iconGraph",hotkeyLangId:"graphView"},{type:"globalGraph",size:{width:320,height:0},show:!1,icon:"iconGlobalGraph",hotkeyLangId:"globalGraph"}],[{type:"backlink",size:{width:320,height:0},show:!1,icon:"iconLink",hotkeyLangId:"backlinks"}]]}},f.SIYUAN_DEFAULT_REPLACETYPES={text:!0,imgText:!0,imgTitle:!0,imgSrc:!0,aText:!0,aTitle:!0,aHref:!0,code:!0,em:!0,strong:!0,inlineMath:!0,inlineMemo:!0,blockRef:!0,fileAnnotationRef:!0,kbd:!0,mark:!0,s:!0,sub:!0,sup:!0,tag:!0,u:!0,docTitle:!0,codeBlock:!0,mathBlock:!0,htmlBlock:!0},f.SIYUAN_IMAGE_VIP=`<svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32">
<path fill="#ffd00f" d="M2.288 12.643l23.487 12.853c0.286 0.153 0.477 0.45 0.477 0.791 0 0.082-0.011 0.161-0.032 0.237l0.001-0.006c-0.119 0.395-0.479 0.678-0.905 0.678-0.004 0-0.009-0-0.013-0h-19.439c-0.958 0-1.766-0.684-1.885-1.595l-1.691-12.956z"></path>
<path fill="#ffd00f" d="M29.676 12.643l-1.691 12.957c-0.119 0.911-0.927 1.594-1.884 1.594h-19.442c-0.004 0-0.009 0-0.013 0-0.425 0-0.785-0.281-0.903-0.668l-0.002-0.007c-0.019-0.070-0.031-0.15-0.031-0.232 0-0.341 0.191-0.638 0.472-0.788l0.005-0.002 23.487-12.853z"></path>
<path fill="#ffe668" d="M15.413 8.369l10.394 15.921c0.378 0.579 0.407 1.317 0.076 1.924-0.328 0.591-0.948 0.985-1.66 0.985-0 0-0.001 0-0.001 0h-17.617c-0.694 0-1.331-0.378-1.661-0.985-0.144-0.26-0.229-0.569-0.229-0.899 0-0.382 0.114-0.736 0.31-1.033l-0.004 0.007 10.394-15.921z"></path>
<path fill="#ffdd4e" d="M15.396 8.403l11.659 15.921c0.401 0.579 0.432 1.317 0.081 1.924-0.361 0.594-1.005 0.985-1.741 0.985-0.008 0-0.017-0-0.025-0h-9.344l-0.63-18.83z"></path>
<path fill="#ffd00f" d="M13.868 6.478c0 0.946 0.767 1.712 1.712 1.712s1.712-0.767 1.712-1.712v0c0-0.945-0.766-1.712-1.712-1.712s-1.712 0.766-1.712 1.712v0zM28.577 10.818c0 0.945 0.766 1.712 1.712 1.712s1.712-0.766 1.712-1.712v0c0-0.945-0.766-1.712-1.712-1.712s-1.712 0.766-1.712 1.712v0zM0 10.822c0 0.945 0.766 1.712 1.712 1.712s1.712-0.766 1.712-1.712v0c0-0.945-0.766-1.712-1.712-1.712s-1.712 0.766-1.712 1.712v0z"></path>
</svg>`,f.SIYUAN_ASSETS_IMAGE=[".apng",".ico",".cur",".jpg",".jpe",".jpeg",".jfif",".pjp",".pjpeg",".png",".gif",".webp",".bmp",".svg",".avif"],f.SIYUAN_ASSETS_AUDIO=[".mp3",".wav",".ogg",".m4a",".aac",".flac"],f.SIYUAN_ASSETS_VIDEO=[".mov",".weba",".mkv",".mp4",".webm"],f.SIYUAN_ASSETS_EXTS=[".pdf"].concat(Ie.SIYUAN_ASSETS_IMAGE).concat(Ie.SIYUAN_ASSETS_AUDIO).concat(Ie.SIYUAN_ASSETS_VIDEO),f.SIYUAN_ASSETS_SEARCH=[".txt",".md",".markdown",".docx",".xlsx",".pptx",".pdf",".json",".log",".sql",".html",".xml",".java",".h",".c",".cpp",".go",".rs",".swift",".kt",".py",".php",".js",".css",".ts",".sh",".bat",".cmd",".ini",".yaml",".rst",".adoc",".textile",".opml",".org",".wiki",".epub"],f.SIYUAN_CONFIG_APPEARANCE_DARK_CODE=["a11y-dark","agate","an-old-hope","androidstudio","arta","atom-one-dark","atom-one-dark-reasonable","base16/3024","base16/apathy","base16/apprentice","base16/ashes","base16/atelier-cave","base16/atelier-dune","base16/atelier-estuary","base16/atelier-forest","base16/atelier-heath","base16/atelier-lakeside","base16/atelier-plateau","base16/atelier-savanna","base16/atelier-seaside","base16/atelier-sulphurpool","base16/atlas","base16/bespin","base16/black-metal","base16/black-metal-bathory","base16/black-metal-burzum","base16/black-metal-dark-funeral","base16/black-metal-gorgoroth","base16/black-metal-immortal","base16/black-metal-khold","base16/black-metal-marduk","base16/black-metal-mayhem","base16/black-metal-nile","base16/black-metal-venom","base16/brewer","base16/bright","base16/brogrammer","base16/brush-trees-dark","base16/chalk","base16/circus","base16/classic-dark","base16/codeschool","base16/colors","base16/danqing","base16/darcula","base16/dark-violet","base16/darkmoss","base16/darktooth","base16/decaf","base16/default-dark","base16/dracula","base16/edge-dark","base16/eighties","base16/embers","base16/equilibrium-dark","base16/equilibrium-gray-dark","base16/espresso","base16/eva","base16/eva-dim","base16/flat","base16/framer","base16/gigavolt","base16/google-dark","base16/grayscale-dark","base16/green-screen","base16/gruvbox-dark-hard","base16/gruvbox-dark-medium","base16/gruvbox-dark-pale","base16/gruvbox-dark-soft","base16/hardcore","base16/harmonic16-dark","base16/heetch-dark","base16/helios","base16/hopscotch","base16/horizon-dark","base16/humanoid-dark","base16/ia-dark","base16/icy-dark","base16/ir-black","base16/isotope","base16/kimber","base16/london-tube","base16/macintosh","base16/marrakesh","base16/materia","base16/material","base16/material-darker","base16/material-palenight","base16/material-vivid","base16/mellow-purple","base16/mocha","base16/monokai","base16/nebula","base16/nord","base16/nova","base16/ocean","base16/oceanicnext","base16/onedark","base16/outrun-dark","base16/papercolor-dark","base16/paraiso","base16/pasque","base16/phd","base16/pico","base16/pop","base16/porple","base16/qualia","base16/railscasts","base16/rebecca","base16/ros-pine","base16/ros-pine-moon","base16/sandcastle","base16/seti-ui","base16/silk-dark","base16/snazzy","base16/solar-flare","base16/solarized-dark","base16/spacemacs","base16/summercamp","base16/summerfruit-dark","base16/synth-midnight-terminal-dark","base16/tango","base16/tender","base16/tomorrow-night","base16/twilight","base16/unikitty-dark","base16/vulcan","base16/windows-10","base16/windows-95","base16/windows-high-contrast","base16/windows-nt","base16/woodland","base16/xcode-dusk","base16/zenburn","codepen-embed","cybertopia-cherry","cybertopia-dimmer","cybertopia-icecap","cybertopia-saturated","dark","devibeans","far","felipec","github-dark","github-dark-dimmed","gml","gradient-dark","hybrid","ir-black","isbl-editor-dark","kimbie-dark","lioshi","monokai","monokai-sublime","night-owl","nnfx-dark","nord","obsidian","panda-syntax-dark","paraiso-dark","pojoaque","qtcreator-dark","rainbow","rose-pine","rose-pine-moon","shades-of-purple","srcery","stackoverflow-dark","sunburst","tomorrow-night-blue","tomorrow-night-bright","tokyo-night-dark","vs2015","xt256"],f.SIYUAN_CONFIG_APPEARANCE_LIGHT_CODE=["ant-design","1c-light","a11y-light","arduino-light","ascetic","atom-one-light","base16/atelier-cave-light","base16/atelier-dune-light","base16/atelier-estuary-light","base16/atelier-forest-light","base16/atelier-heath-light","base16/atelier-lakeside-light","base16/atelier-plateau-light","base16/atelier-savanna-light","base16/atelier-seaside-light","base16/atelier-sulphurpool-light","base16/brush-trees","base16/classic-light","base16/cupcake","base16/cupertino","base16/default-light","base16/dirtysea","base16/edge-light","base16/equilibrium-gray-light","base16/equilibrium-light","base16/fruit-soda","base16/github","base16/google-light","base16/grayscale-light","base16/gruvbox-light-hard","base16/gruvbox-light-medium","base16/gruvbox-light-soft","base16/harmonic16-light","base16/heetch-light","base16/humanoid-light","base16/horizon-light","base16/ia-light","base16/material-lighter","base16/mexico-light","base16/one-light","base16/papercolor-light","base16/ros-pine-dawn","base16/sagelight","base16/shapeshifter","base16/silk-light","base16/solar-flare-light","base16/solarized-light","base16/summerfruit-light","base16/synth-midnight-terminal-light","base16/tomorrow","base16/unikitty-light","base16/windows-10-light","base16/windows-95-light","base16/windows-high-contrast-light","brown-paper","base16/windows-nt-light","color-brewer","docco","foundation","github","googlecode","gradient-light","grayscale","idea","intellij-light","isbl-editor-light","kimbie-light","lightfair","magula","mono-blue","nnfx-light","panda-syntax-light","paraiso-light","purebasic","qtcreator-light","rose-pine-dawn","routeros","school-book","stackoverflow-light","tokyo-night-light","vs","xcode","default"],f.ZWSP="\u200B",f.INLINE_TYPE=["block-ref","kbd","text","file-annotation-ref","a","strong","em","u","s","mark","sup","sub","tag","code","inline-math","inline-memo","clear"],f.BLOCK_HINT_KEYS=["((","[[","\uFF08\uFF08","\u3010\u3010"],f.BLOCK_HINT_CLOSE_KEYS={"((":"))","[[":"]]","\uFF08\uFF08":"\uFF09\uFF09","\u3010\u3010":"\u3011\u3011"},f.ALIAS_CODE_LANGUAGES=["js","ts","html","toml","c#","bat"],f.SIYUAN_RENDER_CODE_LANGUAGES=["abc","plantuml","mermaid","flowchart","echarts","mindmap","graphviz","math"],f.PROTYLE_TOOLBAR=H()?["block-ref","a","|","text","strong","em","u","clear","|","code","tag","inline-math","inline-memo"]:["block-ref","a","|","text","strong","em","u","s","mark","sup","sub","clear","|","code","kbd","tag","inline-math","inline-memo"],f.ANALYTICS_EVT_ON_GET_CONFIG="siyuan.onGetConfig";const Q=(e,t,n=!1)=>{let a=$(e,t,n),s=!1,i=!1;for(;a&&(n?a.tagName!=="BODY":!a.classList.contains("protyle-wysiwyg"))&&!i;)s=$(a.parentElement,t,n),s?a=s:i=!0;return a||!1},ee=(e,t)=>{let n=O(e,t),a=!1,s=!1;for(;n&&!n.classList.contains("protyle-wysiwyg")&&!s;)a=O(n.parentElement,t),a?n=a:s=!0;return n||!1},F=(e,t,n,a=!1)=>{let s=D(e,t,n,a),i=!1,l=!1;for(;s&&!s.classList.contains("protyle-wysiwyg")&&!l;)i=D(s.parentElement,t,n,a),i?s=i:l=!0;return s||!1},D=(e,t,n,a=!1)=>{var s;if(!e||e.nodeType===9)return!1;e.nodeType===3&&(e=e.parentElement);let i=e,l=!1;for(;i&&!l&&(a?i.tagName!=="BODY":!i.classList.contains("protyle-wysiwyg"));)typeof n=="string"&&((s=i.getAttribute(t))!=null&&s.split(" ").includes(n))||typeof n!="string"&&i.hasAttribute(t)?l=!0:i=i.parentElement;return l&&i},O=(e,t)=>{if(!e||e.nodeType===9)return!1;e.nodeType===3&&(e=e.parentElement);let n=e,a=!1;for(;n&&!a&&!n.classList.contains("protyle-wysiwyg");)n.nodeName===t?a=!0:n=n.parentElement;return a&&n},$=(e,t,n=!1)=>{var a;if(!e||e.nodeType===9)return!1;e.nodeType===3&&(e=e.parentElement);let s=e,i=!1;for(;s&&!i&&(n?s.tagName!=="BODY":!s.classList.contains("protyle-wysiwyg"));)(a=s.classList)!=null&&a.contains(t)?i=!0:s=s.parentElement;return i&&s},B=e=>{var t;const n=D(e,"data-node-id",null);return n&&n.tagName!=="BUTTON"&&((t=n.getAttribute("data-type"))!=null&&t.startsWith("Node"))?n:!1},re=e=>{const t=F(e,"data-type","NodeBlockQueryEmbed");return t?t.isSameNode(e)?!1:t:!1},De=e=>{let t=e;for(;t;){if(t.previousElementSibling&&t.previousElementSibling.getAttribute("data-node-id"))return t.previousElementSibling;const n=B(t.parentElement);if(n)t=n;else return!1}},lt=e=>{let t;return Array.from(e.querySelectorAll("[data-node-id]")).reverse().find(n=>{if(!re(n))return t=n,!0}),t||e},Mt=e=>{let t;return Array.from(e.querySelectorAll("[data-node-id]")).find(n=>{if(!re(n)&&!n.classList.contains("li")&&!n.classList.contains("sb"))return t=n,!0}),t||e},et=e=>{let t=e;for(;t;){if(t.nextElementSibling&&!t.nextElementSibling.classList.contains("protyle-attr"))return t.nextElementSibling;const n=B(t.parentElement);if(n)t=n;else return!1}return!1},ta=e=>{let t=e;for(;t;)if(t.classList.contains("list")||t.classList.contains("li")||t.classList.contains("bq")||t.classList.contains("sb"))t=t.querySelector("[data-node-id]");else return t;return!1},oe=e=>{if(!e||e.getAttribute("contenteditable")==="true"&&!e.classList.contains("protyle-wysiwyg"))return e;const t=e.querySelector('[contenteditable="true"]');if(t&&!D(t,"data-type","NodeBlockQueryEmbed"))return t},At=e=>["NodeBlockQueryEmbed","NodeThematicBreak","NodeMathBlock","NodeHTMLBlock","NodeIFrame","NodeWidget","NodeVideo","NodeAudio"].includes(e.getAttribute("data-type"))||e.getAttribute("data-type")==="NodeCodeBlock"&&e.classList.contains("render-node"),Ct=e=>{var t,n;let a=e;for(;a.parentElement&&!a.parentElement.classList.contains("protyle-wysiwyg");)if(!a.parentElement.getAttribute("data-node-id"))a=a.parentElement;else{let s=!1;if(Array.from(a.parentElement.querySelectorAll('[contenteditable="true"]')).find(i=>{if(i.textContent.replace(f.ZWSP,"").replace(`
`,"")!=="")return s=!0,!0}),s||(t=a.previousElementSibling)!=null&&t.getAttribute("data-node-id")||(n=a.nextElementSibling)!=null&&n.getAttribute("data-node-id"))break;a=a.parentElement}return a},Ne=e=>{if(e.parentElement.getAttribute("data-type")==="NodeBlockquote"&&e.parentElement.childElementCount===2)for(;!e.parentElement.classList.contains("protyle-wysiwyg");)if(e.parentElement.getAttribute("data-type")==="NodeBlockquote"&&e.parentElement.childElementCount===2)e=e.parentElement;else{e=Ne(e);break}else if(e.parentElement.getAttribute("data-type")==="NodeSuperBlock"&&e.parentElement.childElementCount===2)for(;!e.parentElement.classList.contains("protyle-wysiwyg");)if(e.parentElement.getAttribute("data-type")==="NodeSuperBlock"&&e.parentElement.childElementCount===2)e=e.parentElement;else{e=Ne(e);break}else if(e.parentElement.getAttribute("data-type")==="NodeListItem"&&e.parentElement.childElementCount===3)for(;!e.parentElement.classList.contains("protyle-wysiwyg");)if(e.parentElement.getAttribute("data-type")==="NodeListItem"&&e.parentElement.childElementCount===3)e=e.parentElement;else if(e.parentElement.getAttribute("data-type")==="NodeList"&&e.parentElement.childElementCount===2)e=e.parentElement;else{e=Ne(e);break}else if(e.parentElement.getAttribute("data-type")==="NodeList"&&e.parentElement.childElementCount===2)for(;!e.parentElement.classList.contains("protyle-wysiwyg");)if(e.parentElement.getAttribute("data-type")==="NodeList"&&e.parentElement.childElementCount===2)e=e.parentElement;else if(e.parentElement.getAttribute("data-type")==="NodeListItem"&&e.parentElement.childElementCount===3)e=e.parentElement;else{e=Ne(e);break}return e},Fe=e=>{let t=e.nextSibling;for(;t;)if(t.textContent===""&&t.nodeType===3)t=t.nextSibling;else return t;return!1},ma=e=>{if(e.endContainer.textContent.length!==e.endOffset)return!1;let t=e.endContainer;for(;t;){if(Fe(t))return!1;if(t.parentElement.getAttribute("spellcheck"))return!0;t=t.parentElement}return!0},ut=e=>{let t=e.previousSibling;for(;t;)if(t.textContent===""&&t.nodeType===3)t=t.previousSibling;else return t;return!1},am=e=>{let t=e.nextElementSibling;if(t)return t.tagName==="LI"?t:t.tagName==="UL"?t.firstElementChild:!1;for(t=e.parentElement;t.tagName==="UL";)if(!t.nextElementSibling)t=t.parentElement;else{if(t.nextElementSibling.tagName==="LI")return t.nextElementSibling;if(t.nextElementSibling.tagName==="UL")return t.nextElementSibling.firstElementChild}return!1},im=e=>{let t=e.previousElementSibling;if(t)return t.tagName==="LI"?t:t.tagName==="UL"?t.lastElementChild:!1;for(t=e.parentElement;t.tagName==="UL";)if(!t.previousElementSibling)t=t.parentElement;else{if(t.previousElementSibling.tagName==="LI")return t.previousElementSibling;if(t.previousElementSibling.tagName==="UL"){const n=t.previousElementSibling.querySelectorAll(".b3-list-item");return n[n.length-1]}}return!1},sm=(e=!1)=>{};let nu,au;const ui=(e,t)=>{},Ht=(e,t,n=!1)=>{},lm=()=>{nu="",document.querySelector("#status .status__counter").innerHTML="",clearTimeout(au)},om=e=>{if(!e)return;let t=`<span class="ft__on-surface">${window.siyuan.languages.runeCount}</span>&nbsp;${e.runeCount}<span class="fn__space"></span>
<span class="ft__on-surface">${window.siyuan.languages.wordCount}</span>&nbsp;${e.wordCount}<span class="fn__space"></span>`;0<e.linkCount&&(t+=`<span class="ft__on-surface">${window.siyuan.languages.linkCount}</span>&nbsp;${e.linkCount}<span class="fn__space"></span>`),0<e.imageCount&&(t+=`<span class="ft__on-surface">${window.siyuan.languages.imgCount}</span>&nbsp;${e.imageCount}<span class="fn__space"></span>`),0<e.refCount&&(t+=`<span class="ft__on-surface">${window.siyuan.languages.refCount}</span>&nbsp;${e.refCount}<span class="fn__space"></span>`),0<e.blockCount&&(t+=`<span class="ft__on-surface">${window.siyuan.languages.blockCount}</span>&nbsp;${e.blockCount}<span class="fn__space"></span>`),document.querySelector("#status .status__counter").innerHTML=t},ba=()=>{const e=[];return window.siyuan.mobile.editor&&e.push(window.siyuan.mobile.editor),window.siyuan.mobile.popEditor&&e.push(window.siyuan.mobile.popEditor),e},Zs=()=>{},iu=(e,t)=>{for(let n=0;n<e.children.length;n++){const a=e.children[n];a instanceof Wnd?t.push(a):a instanceof Layout&&iu(a,t)}},rm=()=>{const e=[],t=n=>{for(let a=0;a<n.children.length;a++){const s=n.children[a];s instanceof Tab?e.push(s):t(s)}};return window.siyuan.layout.centerLayout&&t(window.siyuan.layout.centerLayout),e},cm=()=>{const e=[];return window.siyuan.config.uiLayout.left.data.forEach(t=>{t.forEach(n=>{e.push(n)})}),window.siyuan.config.uiLayout.right.data.forEach(t=>{t.forEach(n=>{e.push(n)})}),window.siyuan.config.uiLayout.bottom.data.forEach(t=>{t.forEach(n=>{e.push(n)})}),e},J=(e,t,n=!1)=>{if(!t){if(e.includes("dialog"))for(let a=0;a<window.siyuan.dialogs.length;a++)window.siyuan.dialogs[a].destroy(),a--;return}if(e.includes("hint")&&(clearTimeout(t.hint.timeId),t.hint.element.classList.add("fn__none")),t.gutter&&e.includes("gutter")&&(t.gutter.element.classList.add("fn__none"),t.gutter.element.innerHTML="",t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl").forEach(a=>{a.classList.remove("protyle-wysiwyg--hl")})),t.gutter&&e.includes("gutterOnly")&&(t.gutter.element.classList.add("fn__none"),t.gutter.element.innerHTML=""),t.toolbar&&e.includes("toolbar")&&(t.toolbar.element.classList.add("fn__none"),t.toolbar.element.style.display=""),t.toolbar&&e.includes("util")){const a=t.toolbar.subElement.querySelector('[data-type="pin"]');(n||!a||a&&a.getAttribute("aria-label")===window.siyuan.languages.pin)&&(t.toolbar.subElement.classList.add("fn__none"),t.toolbar.subElementCloseCB&&(t.toolbar.subElementCloseCB(),t.toolbar.subElementCloseCB=void 0))}e.includes("select")&&t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").forEach(a=>{a.classList.remove("protyle-wysiwyg--select"),a.removeAttribute("select-start"),a.removeAttribute("select-end")})},To=e=>{e.includes("toolbar")&&document.querySelectorAll(".protyle-toolbar").forEach(t=>{t.classList.add("fn__none"),t.style.display=""}),e.includes("util")&&ba().forEach(t=>{t.protyle.toolbar&&(t.protyle.toolbar.subElement.classList.add("fn__none"),t.protyle.toolbar.subElementCloseCB&&(t.protyle.toolbar.subElementCloseCB(),t.protyle.toolbar.subElementCloseCB=void 0))}),e.includes("pdfutil")&&document.querySelectorAll(".pdf__util").forEach(t=>{t.classList.add("fn__none")}),e.includes("gutter")&&document.querySelectorAll(".protyle-gutters").forEach(t=>{t.classList.add("fn__none"),t.innerHTML=""})},su=(e,t)=>{if(!t){if(getSelection().rangeCount===0)return!1;t=getSelection().getRangeAt(0)}const n=t.commonAncestorContainer;return e.isEqualNode(n)||e.contains(n)},Xs=e=>{const t=D(e.startContainer,"data-type","NodeTable");if(e.toString()!==""&&t&&e.commonAncestorContainer.nodeType!==3){const n=e.commonAncestorContainer.tagName;if(n!=="TH"&&n!=="TD"){const a=O(e.startContainer,"TD")||O(e.startContainer,"TH"),s=O(e.endContainer,"TD")||O(e.endContainer,"TH");if(!a&&!s){const i=t.querySelector("th")||t.querySelector("td");e.setStart(i.firstChild,0),e.setEnd(i.lastChild,i.lastChild.textContent.length)}else a&&!a.contains(e.endContainer)&&nt(a,e,!1)}}},Js=(e,t,n)=>{const a=oe(t);if(a){let l;if(a.tagName==="TABLE"){const o=O(n.startContainer,"TD")||O(n.startContainer,"TH");if(o&&(l=Je(o,t,n),l.start!==0||l.end!==o.textContent.length))return n.setStart(o.firstChild,0),n.setEndAfter(o.lastChild),e.toolbar.render(e,n),ui(n,e.block.rootID),!0}else if(l=Je(a,t,n),l.start!==0||l.end!==a.textContent.length){let o=a.firstChild;for(;o;)if(o.nodeType===3){if(o.textContent!==""){n.setStart(o,0);break}o=o.nextSibling}else{if(o.classList.contains("render-node")||o.classList.contains("img")){n.setStartBefore(o);break}o=o.firstChild}let r=a.lastChild;for(;r;)if(r.nodeType===3){if(r.textContent!==""){n.setEnd(r,r.textContent.length);break}r=r.previousSibling}else{if(r.classList.contains("render-node")||r.classList.contains("img")||r.tagName==="BR"){n.setEndAfter(r);break}r=r.lastChild}return X(n),e.toolbar.render(e,n),ui(n,e.block.rootID),!0}}n.collapse(!0);const s=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(e.wysiwyg.element.childElementCount===s.length&&s[0].parentElement.isSameNode(e.wysiwyg.element))return!0;J(["select"],e);const i=[];Array.from(e.wysiwyg.element.children).forEach(l=>{const o=l.getAttribute("data-node-id");o&&(l.classList.add("protyle-wysiwyg--select"),i.push(o))}),Ht(i,e.block.rootID)},Qs=(e,t)=>{const n=document.caretRangeFromPoint(e,t),a=D(n.startContainer,"data-type","img");return a&&(n.setStart(a.nextSibling,0),n.collapse()),n},ye=e=>{let t;if(getSelection().rangeCount>0&&(t=getSelection().getRangeAt(0),e.isSameNode(t.startContainer)||e.contains(t.startContainer))){if(t.toString()===""&&t.startContainer.nodeType===1&&t.startOffset===0&&t.startContainer.classList.contains("protyle-wysiwyg")){const a=ne(t.startContainer.firstChild);if(a)return a}return t}e.focus({preventScroll:!0});let n;return e.classList.contains("table")?n=e.querySelector("th")||e.querySelector("td"):(n=oe(e),n?n.tagName==="TABLE"&&(n=n.querySelector("th")||e.querySelector("td")):n=e),t=n.ownerDocument.createRange(),t.setStart(n||e,0),t.collapse(!0),t},hn=(e,t)=>{var n,a;if(t||(t=ye(e)),!e.contains(t.startContainer))return{left:0,top:0};let s;if(t.getClientRects().length===0)if(t.startContainer.nodeType===3){const i=(n=t.startContainer.parentElement)==null?void 0:n.getClientRects(),l=(a=t.startContainer.previousElementSibling)==null?void 0:a.getClientRects();if(i.length>0||l.length>0)i.length===0||l&&l.length>0&&i[0].top<l[l.length-1].bottom?s={left:l[l.length-1].left,top:l[l.length-1].bottom}:s=i[0];else return{left:0,top:0}}else{const i=t.startContainer.children;if(i[t.startOffset]&&i[t.startOffset].getClientRects().length>0)s=i[t.startOffset].getClientRects()[0];else if(t.startContainer.childNodes.length>0){const l=t.cloneRange();t.selectNode(t.startContainer.childNodes[Math.max(0,t.startOffset-1)]),s=t.getClientRects()[0],t.setEnd(l.endContainer,l.endOffset),t.setStart(l.startContainer,l.startOffset)}else s=t.startContainer.getClientRects()[0];if(!s){let l=t.startContainer.childNodes[t.startOffset];if(l||(l=t.startContainer.childNodes[t.startOffset-1]),!l)s=t.getBoundingClientRect();else{for(;!l.getClientRects||l.getClientRects&&l.getClientRects().length===0;)l=l.parentElement;s=l.getClientRects()[0]}}}else{const i=t.getClientRects();return t.toString()?{left:i[i.length-1].left,top:i[0].top}:{left:i[i.length-1].left,top:i[i.length-1].top}}return{left:s.left,top:s.top}},Je=(e,t,n)=>{const a={end:0,start:0};if(!n){if(getSelection().rangeCount===0)return a;n=window.getSelection().getRangeAt(0)}if(t&&!su(t,n))return a;const s=n.cloneRange();return e.childNodes[0]&&e.childNodes[0].childNodes[0]?s.setStart(e.childNodes[0].childNodes[0],0):s.selectNodeContents(e),s.setEnd(n.startContainer,n.startOffset),a.start=s.toString().length+s.cloneContents().querySelectorAll("br").length,a.end=a.start+n.toString().length+n.cloneContents().querySelectorAll("br").length,a};function Ki(e,t,n,a){if(!t)return!1;if(n(t))return!0;for(let s=0,i=t.childNodes.length;s<i;s++)if(Ki(t,t.childNodes[s],n,!0))return!0;if(!a){let s=t;for(;s&&s!==e;){let i=s.nextSibling;for(;i;){if(Ki(e,i,n,!0))return!0;i=i.nextSibling}s=s.parentNode}}return!1}const nt=(e,t,n=!0)=>{if(!e)return t;let a=e.lastChild;for(;a&&a.nodeType!==3;){if(a.nodeType!==3&&a.tagName==="BR")return t;if(!a.lastChild)break;a=a.lastChild}return a||(a=e),n?a.nodeType!==3&&a.classList.contains("render-node")&&a.innerHTML===""?t.setStartAfter(a):t.setStart(a,a.textContent.length):a.nodeType!==3&&a.classList.contains("render-node")&&a.innerHTML===""?t.setStartAfter(a):t.setEnd(a,a.textContent.length),t},ya=(e,t)=>{if(!e)return t;let n=e.firstChild;for(;n&&n.nodeType!==3&&!n.classList.contains("render-node");){if(n.classList.contains("img"))return t.setStartBefore(n),t;n=n.firstChild}return n?(n.nodeType!==3&&n.classList.contains("render-node")?t.setStartBefore(n):t.setStart(n,0),t):(t.selectNodeContents(e),t)},Zi=(e,t,n,a=!0)=>{if(!e)return!1;const s=oe(e);if(s)e=s;else if(At(e)||e.classList.contains("av"))return ne(e);let i;Ki(e,e.firstChild,r=>{if(r.nodeType===Node.TEXT_NODE){const c=r.data.length;return t<=c?(i=r,!0):(t-=c,n-=c,!1)}});let l;i&&Ki(e,i,r=>{if(r.nodeType===Node.TEXT_NODE){const c=r.data.length;return n<=c?(l=r,!0):(n-=c,!1)}});const o=document.createRange();return i?t<i.data.length?o.setStart(i,t):o.setStartAfter(i):t===0?o.setStart(e,0):nt(oe(e),o),l?n<l.data.length?o.setEnd(l,n):o.setEndAfter(l):n===0?o.setEnd(e,0):nt(oe(e),o,!1),a&&X(o),o},fi=(e,t,n)=>{const a=Je(e,e,t),s=e.cloneNode(!0),i=Zi(s,a.end,a.end,!1);i&&i.insertNode(document.createElement("wbr")),n.wysiwyg.lastHTMLs[e.getAttribute("data-node-id")]=s.outerHTML},ue=(e,t)=>{var n;const a=e.querySelectorAll("wbr");if(a.length===0)return;a.forEach((i,l)=>{l!==0&&i.remove()});const s=a[0];if(!s.previousElementSibling)s.previousSibling?t.setStart(s.previousSibling,s.previousSibling.textContent.length):s.nextSibling?s.nextSibling.nodeType===3?t.setStart(s.nextSibling,0):t.setStartAfter(s):t.setStart(s.parentElement,0);else{const i=ut(s);i&&s.previousElementSibling.isSameNode(i)?((n=s.previousElementSibling.lastChild)==null?void 0:n.nodeType)===3?t.setStart(s.previousElementSibling.lastChild,s.previousElementSibling.lastChild.textContent.length):i.nodeType!==3&&i.classList.contains("img")?t.setStartAfter(i):t.setStartBefore(s):t.setStart(s.previousSibling,s.previousSibling.textContent.length)}t.collapse(!0),s.remove(),X(t)},X=e=>{if(!e)return;const t=e.startContainer.childNodes[e.startOffset];if(t&&t.nodeType!==3&&["INPUT","TEXTAREA"].includes(t.tagName)){t.focus();return}const n=window.getSelection();n.removeAllRanges(),n.addRange(e)},ne=(e,t,n=!0)=>{var a,s,i;if(!e)return!1;if(e.classList.contains("render-node")||e.classList.contains("iframe")||e.classList.contains("hr")||e.classList.contains("av")){const o=document.createRange(),r=e.getAttribute("data-type");let c=!1;if(r==="NodeThematicBreak")o.selectNodeContents(e.firstElementChild),c=!0;else if(r==="NodeBlockQueryEmbed")(a=e.lastElementChild.previousElementSibling)!=null&&a.firstChild?(o.selectNodeContents(e.lastElementChild.previousElementSibling.firstChild),o.collapse(!0)):(o.selectNodeContents(e),o.collapse(!0)),c=!0;else if(["NodeMathBlock","NodeHTMLBlock"].includes(r))(i=(s=e.lastElementChild.previousElementSibling)==null?void 0:s.lastElementChild)!=null&&i.firstChild?(o.selectNodeContents(e.lastElementChild.previousElementSibling.lastElementChild.firstChild),o.collapse(!0)):e.lastElementChild.previousElementSibling&&(o.selectNodeContents(e.lastElementChild.previousElementSibling),o.collapse(!0)),c=!0;else if(r==="NodeIFrame"||r==="NodeWidget")o.setStart(e,0),c=!0;else if(r==="NodeVideo")o.setStart(e.firstElementChild,0),c=!0;else if(r==="NodeAudio")o.setStart(e.firstElementChild.lastChild,0),c=!0;else if(r==="NodeCodeBlock")o.selectNodeContents(e),o.collapse(!0),c=!0;else if(r==="NodeAttributeView")return!1;return c?(X(o),o):(el(e),!1)}let l;if(n?l=oe(e):Array.from(e.querySelectorAll('[contenteditable="true"]')).reverse().find(o=>{if(o.getBoundingClientRect().width>0)return l=o,!0}),l){if(l.tagName==="TABLE")if(n)l=l.querySelector("th, td");else{const r=l.querySelectorAll("th, td");l=r[r.length-1]}let o;if(n)o=ya(l,ye(l)),o.collapse(!0);else{let r=!1;if(l.classList.contains("hljs")){let c=l.lastChild;if(c||(l.innerHTML=`
`,c=l.lastChild),c.textContent===""&&c.nodeType===3&&(c=ut(l.lastChild)),c&&c.textContent.endsWith(`
`)){if(c.nodeType===1)for(c=c.lastChild;c&&c.textContent.indexOf(`
`)===-1;)c=c.previousSibling;o=ye(l),o.setStart(c,c.textContent.length-1),r=!0}}r||(o=nt(l,ye(l))),o.collapse(!1)}return X(o),o}else if(t)t.focus();else if(e.classList.contains("li"))return ne(e.querySelector("[data-node-id]"),t,n);return!1},el=e=>{if(e.getAttribute("data-node-id")){let n,a;e.nextElementSibling&&!e.nextElementSibling.classList.contains("protyle-attr")?(a=!0,n=et(e)):e.previousElementSibling&&(a=!1,n=De(e)),n||(n=e),ne(n,void 0,a);return}const t=ye(e);e.nextSibling?(t.selectNodeContents(e.nextSibling),t.collapse(!0)):e.previousSibling&&(t.selectNodeContents(e.previousSibling),t.collapse(!1)),X(t)},na=()=>([1e7].toString()+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,e=>(parseInt(e,10)^window.crypto.getRandomValues(new Uint32Array(1))[0]&15>>parseInt(e,10)/4).toString(16)),lu=()=>{const e=document.getElementById("message");e.innerHTML=`<div class="fn__flex-1"></div>
<button class="b3-button ft__smaller fn__none">${window.siyuan.languages.clearMessage}</button>`,e.addEventListener("click",n=>{let a=n.target;for(;a&&!a.isEqualNode(e);){if(a.classList.contains("b3-snackbar__close")){tt(a.parentElement.getAttribute("data-id")),n.preventDefault();break}else if(a.isSameNode(e.lastElementChild)){a.parentElement.classList.remove("b3-snackbars--show"),setTimeout(()=>{a.parentElement.firstElementChild.innerHTML=""},f.TIMEOUT_INPUT),n.preventDefault();break}else{if(a.tagName==="A"||a.tagName==="BUTTON")break;if(a.classList.contains("b3-snackbar")){(getSelection().rangeCount===0||!getSelection().getRangeAt(0).toString())&&tt(a.getAttribute("data-id")),n.preventDefault(),n.stopPropagation();break}}a=a.parentElement}});const t=document.getElementById("tempMessage");t&&(ae(t.innerHTML),t.remove())},ae=(e,t=6e3,n="info",a)=>{const s=document.getElementById("message").firstElementChild;if(!s){document.body.insertAdjacentHTML("beforeend",`<div style="top: 10px;
    position: fixed;
    z-index: 100;
    background: white;
    padding: 10px;
    border-radius: 5px;
    right: 10px;
    border: 1px solid #e0e0e0;" id='tempMessage'>${e}</div>`);return}const i=a||na(),l=s.querySelector(`.b3-snackbar[data-id="${i}"]`),o=e+(n==="error"?" v"+f.SIYUAN_VERSION:"");if(l){if(window.clearTimeout(parseInt(l.getAttribute("data-timeoutid"))),l.innerHTML=`<div data-type="textMenu" class="b3-snackbar__content${t===0?" b3-snackbar__content--close":""}">${o}</div>${t===0?'<svg class="b3-snackbar__close"><use xlink:href="#iconCloseRound"></use></svg>':""}`,n==="error"?l.classList.add("b3-snackbar--error"):l.classList.remove("b3-snackbar--error"),t>0){const c=window.setTimeout(()=>{tt(i)},t);l.setAttribute("data-timeoutid",c.toString())}return}let r=`<div data-id="${i}" class="b3-snackbar--hide b3-snackbar${n==="error"?" b3-snackbar--error":""}"><div data-type="textMenu" class="b3-snackbar__content${t===0?" b3-snackbar__content--close":""}">${o}</div>`;if(t===0)r+='<svg class="b3-snackbar__close"><use xlink:href="#iconCloseRound"></use></svg>';else if(t!==-1){const c=window.setTimeout(()=>{tt(i)},t);r=r.replace("<div data-id",`<div data-timeoutid="${c}" data-id`)}return s.parentElement.classList.add("b3-snackbars--show"),s.parentElement.style.zIndex=(++window.siyuan.zIndex).toString(),s.insertAdjacentHTML("afterbegin",r+"</div>"),setTimeout(()=>{s.querySelectorAll(".b3-snackbar--hide").forEach(c=>{c.classList.remove("b3-snackbar--hide")})}),s.firstElementChild.nextElementSibling&&s.firstElementChild.nextElementSibling.innerHTML===s.firstElementChild.innerHTML&&s.firstElementChild.nextElementSibling.remove(),s.scrollTo({top:0,behavior:"smooth"}),i},tt=e=>{const t=document.getElementById("message").firstElementChild;if(t)if(e){const n=t.querySelector(`[data-id="${e}"]`);n&&(n.classList.add("b3-snackbar--hide"),window.clearTimeout(parseInt(n.getAttribute("data-timeoutid"))),setTimeout(()=>{n.remove(),t.childElementCount===0&&(t.parentElement.classList.remove("b3-snackbars--show"),t.innerHTML="")},f.TIMEOUT_INPUT));let a=!1;Array.from(t.children).find(s=>{if(!s.classList.contains("b3-snackbar--hide"))return a=!0,!0}),a?t.parentElement.classList.add("b3-snackbars--show"):t.parentElement.classList.remove("b3-snackbars--show")}else t.parentElement.classList.remove("b3-snackbars--show"),setTimeout(()=>{t.innerHTML=""},f.TIMEOUT_INPUT)};var tl=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{o(n.next(r))}catch(c){s(c)}},l=r=>{try{o(n.throw(r))}catch(c){s(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,l);o((n=n.apply(e,t)).next())});const Et=e=>{if(e)if(Qt())if(e.startsWith("assets/"))window.webkit.messageHandlers.openLink.postMessage(location.origin+"/assets/"+encodeURIComponent(e.replace("assets/","")));else if(e.startsWith("/"))window.webkit.messageHandlers.openLink.postMessage(location.origin+e);else try{new URL(e),window.webkit.messageHandlers.openLink.postMessage(e)}catch(t){window.webkit.messageHandlers.openLink.postMessage("https://"+e)}else ft()?window.JSAndroid.openExternal(e):yt()?window.JSHarmony.openExternal(e):window.open(e)},nl=()=>ft()?window.JSAndroid.readClipboard():yt()?window.JSHarmony.readClipboard():navigator.clipboard.readText(),al=()=>tl(void 0,null,function*(){const e={textPlain:"",textHTML:""};try{const t=yield navigator.clipboard.read();for(const n of t){if(n.types.includes("text/html")){const a=yield n.getType("text/html");e.textHTML=yield a.text()}if(n.types.includes("text/plain")){const a=yield n.getType("text/plain");e.textPlain=yield a.text()}if(n.types.includes("image/png")){const a=yield n.getType("image/png");e.files=[new File([a],"image.png",{type:"image/png",lastModified:Date.now()})]}}return e}catch(t){return ft()?(e.textPlain=window.JSAndroid.readClipboard(),e.textHTML=window.JSAndroid.readHTMLClipboard()):yt()&&(e.textPlain=window.JSHarmony.readClipboard(),e.textHTML=window.JSHarmony.readHTMLClipboard()),e}}),Be=e=>{let t;getSelection().rangeCount>0&&(t=getSelection().getRangeAt(0).cloneRange());try{if(ft()){window.JSAndroid.writeClipboard(e);return}if(yt()){window.JSHarmony.writeClipboard(e);return}if(Qt()){window.webkit.messageHandlers.setClipboard.postMessage(e);return}navigator.clipboard.writeText(e)}catch(n){if(Qt())window.webkit.messageHandlers.setClipboard.postMessage(e);else if(ft())window.JSAndroid.writeClipboard(e);else if(yt())window.JSHarmony.writeClipboard(e);else{const a=document.createElement("textarea");a.value=e,a.style.position="fixed",document.body.appendChild(a),a.focus(),a.select(),document.execCommand("copy"),document.body.removeChild(a),t&&X(t)}}},Xi=e=>tl(void 0,null,function*(){e=e.replace(new RegExp(f.ZWSP,"g"),""),yield Be(e)}),wa=()=>Dn()?"touchstart":"click",bt=e=>Lt()?!!(e.metaKey&&!e.ctrlKey):!!(!e.metaKey&&e.ctrlKey),Ue=e=>!e.metaKey&&!e.ctrlKey,$o=()=>window.siyuan.config.system.osPlatform.toLowerCase().indexOf("huawei")>-1,Io=e=>{var t;return((t=window.siyuan.config.system.disabledFeatures)==null?void 0:t.indexOf(e))>-1},Dn=()=>navigator.userAgent.indexOf("iPhone")>-1,gi=()=>navigator.userAgent.indexOf("iPad")>-1,Lt=()=>navigator.platform.toUpperCase().indexOf("MAC")>-1,Do=()=>tl(void 0,null,function*(){if(!navigator.userAgentData||!navigator.userAgentData.getHighEntropyValues)return!1;const e=yield navigator.userAgentData.getHighEntropyValues(["platformVersion"]);return navigator.userAgentData.platform==="Windows"&&parseInt(e.platformVersion.split(".")[0])>=13}),Mo=()=>navigator.platform.toUpperCase().indexOf("WIN")>-1,ft=()=>window.siyuan.config.system.container==="android"&&window.JSAndroid,Qt=()=>{var e;return window.siyuan.config.system.container==="ios"&&((e=window.webkit)==null?void 0:e.messageHandlers)},yt=()=>window.siyuan.config.system.container==="harmony"&&window.JSHarmony,Me=e=>{if(Lt())return e;const t=new Map(Object.entries({"\u2318":"Ctrl","\u2303":"Ctrl","\u21E7":"Shift","\u2325":"Alt","\u21E5":"Tab","\u232B":"Backspace","\u2326":"Delete","\u21A9":"Enter"})),n=[];(e.indexOf("\u2318")>-1||e.indexOf("\u2303")>-1)&&n.push(t.get("\u2318")),e.indexOf("\u21E7")>-1&&n.push(t.get("\u21E7")),e.indexOf("\u2325")>-1&&n.push(t.get("\u2325"));const a=e.replace(/⌘|⇧|⌥|⌃/g,"");return a&&n.push(t.get(a)||a),n.join("+")},Ho=e=>{A("/api/storage/getLocalStorage",void 0,t=>{window.siyuan.storage=t.data;const n={};n[f.LOCAL_SEARCHASSET]={keys:[],col:"",row:"",layout:0,method:0,types:{},sort:0,k:""},n[f.LOCAL_SEARCHUNREF]={col:"",row:"",layout:0},f.SIYUAN_ASSETS_SEARCH.forEach(a=>{n[f.LOCAL_SEARCHASSET].types[a]=!0}),n[f.LOCAL_SEARCHKEYS]={keys:[],replaceKeys:[],col:"",row:"",layout:0,colTab:"",rowTab:"",layoutTab:0},n[f.LOCAL_PDFTHEME]={light:"light",dark:"dark",annoColor:"var(--b3-pdf-background1)"},n[f.LOCAL_LAYOUTS]=[],n[f.LOCAL_AI]=[],n[f.LOCAL_PLUGIN_DOCKS]={},n[f.LOCAL_PLUGINTOPUNPIN]=[],n[f.LOCAL_OUTLINE]={keepExpand:!0},n[f.LOCAL_FILEPOSITION]={},n[f.LOCAL_DIALOGPOSITION]={},n[f.LOCAL_HISTORY]={notebookId:"%",type:0,operation:"all",sideWidth:"256px",sideDocWidth:"256px",sideDiffWidth:"256px"},n[f.LOCAL_FLASHCARD]={fullscreen:!1},n[f.LOCAL_BAZAAR]={theme:"0",template:"0",icon:"0",widget:"0"},n[f.LOCAL_EXPORTWORD]={removeAssets:!1,mergeSubdocs:!1},n[f.LOCAL_EXPORTPDF]={landscape:!1,marginType:"0",scale:1,pageSize:"A4",removeAssets:!0,keepFold:!1,mergeSubdocs:!1,watermark:!1},n[f.LOCAL_EXPORTIMG]={keepFold:!1,watermark:!1},n[f.LOCAL_DOCINFO]={id:""},n[f.LOCAL_IMAGES]={file:"1f4c4",note:"1f5c3",folder:"1f4d1"},n[f.LOCAL_EMOJIS]={currentTab:"emoji"},n[f.LOCAL_FONTSTYLES]=[],n[f.LOCAL_FILESPATHS]=[],n[f.LOCAL_SEARCHDATA]={page:1,sort:0,group:0,hasReplace:!1,method:0,hPath:"",idPath:[],k:"",r:"",types:{document:window.siyuan.config.search.document,heading:window.siyuan.config.search.heading,list:window.siyuan.config.search.list,listItem:window.siyuan.config.search.listItem,codeBlock:window.siyuan.config.search.codeBlock,htmlBlock:window.siyuan.config.search.htmlBlock,mathBlock:window.siyuan.config.search.mathBlock,table:window.siyuan.config.search.table,blockquote:window.siyuan.config.search.blockquote,superBlock:window.siyuan.config.search.superBlock,paragraph:window.siyuan.config.search.paragraph,embedBlock:window.siyuan.config.search.embedBlock,databaseBlock:window.siyuan.config.search.databaseBlock},replaceTypes:Object.assign({},f.SIYUAN_DEFAULT_REPLACETYPES)},n[f.LOCAL_ZOOM]=1,n[f.LOCAL_MOVE_PATH]={keys:[],k:""},[f.LOCAL_EXPORTIMG,f.LOCAL_SEARCHKEYS,f.LOCAL_PDFTHEME,f.LOCAL_BAZAAR,f.LOCAL_EXPORTWORD,f.LOCAL_EXPORTPDF,f.LOCAL_DOCINFO,f.LOCAL_FONTSTYLES,f.LOCAL_SEARCHDATA,f.LOCAL_ZOOM,f.LOCAL_LAYOUTS,f.LOCAL_AI,f.LOCAL_PLUGINTOPUNPIN,f.LOCAL_SEARCHASSET,f.LOCAL_FLASHCARD,f.LOCAL_DIALOGPOSITION,f.LOCAL_SEARCHUNREF,f.LOCAL_HISTORY,f.LOCAL_OUTLINE,f.LOCAL_FILEPOSITION,f.LOCAL_FILESPATHS,f.LOCAL_IMAGES,f.LOCAL_PLUGIN_DOCKS,f.LOCAL_EMOJIS,f.LOCAL_MOVE_PATH].forEach(a=>{if(typeof t.data[a]=="string")try{const s=JSON.parse(t.data[a]);typeof s=="number"?window.siyuan.storage[a]=s:window.siyuan.storage[a]=Object.assign(n[a],s)}catch(s){window.siyuan.storage[a]=n[a]}else typeof t.data[a]=="undefined"&&(window.siyuan.storage[a]=n[a])}),(!window.siyuan.storage[f.LOCAL_SEARCHDATA].replaceTypes||Object.keys(window.siyuan.storage[f.LOCAL_SEARCHDATA].replaceTypes).length===0)&&(window.siyuan.storage[f.LOCAL_SEARCHDATA].replaceTypes=Object.assign({},f.SIYUAN_DEFAULT_REPLACETYPES)),e()})},Ae=(e,t,n)=>{window.siyuan.config.readonly||A("/api/storage/setLocalStorageVal",{app:f.SIYUAN_APPID,key:e,val:t},()=>{n&&n()})},il=e=>{var t,n,a;if(e.cmd==="msg"){const s=ae(e.msg,e.data.closeTimeout,e.code===0?"info":"error",e.data.id);return(t=document.querySelector("#message #addMicrosoftDefenderExclusion"))==null||t.addEventListener("click",i=>{i.target.innerHTML='<svg class="fn__rotate" style="margin-right: 0;"><use xlink:href="#iconRefresh"></use></svg>',A("/api/system/addMicrosoftDefenderExclusion",{},()=>{tt(s)})},{once:!0}),(n=document.querySelector("#message #ignoreAddMicrosoftDefenderExclusion"))==null||n.addEventListener("click",()=>{tt(s),A("/api/system/ignoreAddMicrosoftDefenderExclusion")},{once:!0}),!1}if(e.cmd==="cmsg")return tt(e.data.id),!1;if(e.cmd==="cprogress"){const s=document.getElementById("progress");return s&&s.remove(),!1}return e.cmd==="reloadui"?((a=e.data)!=null&&a.resetScroll?(window.siyuan.storage[f.LOCAL_FILEPOSITION]={},Ae(f.LOCAL_FILEPOSITION,window.siyuan.storage[f.LOCAL_FILEPOSITION],()=>{window.location.reload()})):window.location.reload(),!1):e.code<0?(ae(e.msg,e.data&&e.data.closeTimeout||0,e.code===-1?"error":"info"),!1):e};class we{constructor(t){this.disableClose=t.disableClose,this.id=na(),window.siyuan.dialogs.push(this),this.destroyCallback=t.destroyCallback,this.element=document.createElement("div");let n,a;if(!H()&&t.positionId){const s=window.siyuan.storage[f.LOCAL_DIALOGPOSITION][t.positionId];s&&s.left+s.width+34<=window.innerWidth&&s.top+s.height<=window.innerHeight&&(n=s.left+"px",a=s.top+"px",t.width=s.width+"px",t.height=s.height+"px")}this.element.innerHTML=`<div class="b3-dialog" style="z-index: ${++window.siyuan.zIndex};${typeof n=="string"?"display:block":""}">
<div class="b3-dialog__scrim"${t.transparent?'style="background-color:transparent"':""}></div>
<div class="b3-dialog__container ${t.containerClassName||""}" style="width:${t.width||"auto"};height:${t.height||"auto"};
left:${n||"auto"};top:${a||"auto"}">
  <svg ${H()&&t.title?'style="top:0;right:0;"':""} class="b3-dialog__close${this.disableClose||t.hideCloseIcon?" fn__none":""}"><use xlink:href="#iconCloseRound"></use></svg>
  <div class="resize__move b3-dialog__header${t.title?"":" fn__none"}" onselectstart="return false;">${t.title||""}</div>
  <div class="b3-dialog__body">${t.content}</div>
  <div class="resize__rd"></div><div class="resize__ld"></div><div class="resize__lt"></div><div class="resize__rt"></div><div class="resize__r"></div><div class="resize__d"></div><div class="resize__t"></div><div class="resize__l"></div>
</div></div>`,this.element.querySelector(".b3-dialog__scrim").addEventListener("click",s=>{this.disableClose||this.destroy(),s.preventDefault(),s.stopPropagation()}),this.disableClose||this.element.querySelector(".b3-dialog__close").addEventListener("click",s=>{this.destroy(),s.preventDefault(),s.stopPropagation()}),document.body.append(this.element),t.disableAnimation?this.element.classList.add("b3-dialog--open"):setTimeout(()=>{this.element.classList.add("b3-dialog--open")})}destroy(t){var n;this.element.querySelector(".b3-dialog").style.zIndex<window.siyuan.menus.menu.element.style.zIndex&&window.siyuan.menus.menu.remove(),this.element.remove(),this.destroyCallback&&this.destroyCallback(t),window.siyuan.dialogs.find((a,s)=>{if(a.id===this.id)return window.siyuan.dialogs.splice(s,1),!0}),(n=document.getElementById("drag"))==null||n.classList.remove("fn__hidden")}bindInput(t,n,a=!0){t.focus(),t.addEventListener("keydown",s=>{if(s.isComposing){s.preventDefault();return}if(s.key==="Escape"){this.destroy(),s.preventDefault(),s.stopPropagation();return}!s.shiftKey&&Ue(s)&&s.key==="Enter"&&n&&a&&(n(),s.preventDefault(),s.stopPropagation())})}}const $e=(e,t,n,a,s=!1)=>{if(!t&&!e){n();return}const i=new we({title:e,content:`<div class="b3-dialog__content">
    <div class="ft__breakword">${t}</div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel" id="cancelDialogConfirmBtn">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button ${s?"b3-button--remove":"b3-button--text"}" id="confirmDialogConfirmBtn">${window.siyuan.languages[s?"delete":"confirm"]}</button>
</div>`,width:H()?"92vw":"520px"});i.element.addEventListener("click",l=>{let o=l.target;const r=typeof l.detail=="string";for(;o&&!o.isSameNode(i.element)||r;){if(o.id==="cancelDialogConfirmBtn"||r&&l.detail==="Escape"){a&&a(i),i.destroy();break}else if(o.id==="confirmDialogConfirmBtn"||r&&l.detail==="Enter"){n&&n(i),i.destroy();break}o=o.parentElement}}),i.element.setAttribute("data-key",f.DIALOG_CONFIRM)},pe=e=>e&&e.replace(/&/g,"&amp;").replace(/</g,"&lt;"),Ji=e=>e.replace(/</g,"&lt;"),We=e=>e&&e.replace(/"/g,"&quot;").replace(/'/g,"&apos;"),Nt=e=>e&&e.replace(/"/g,"&quot;").replace(/'/g,"&apos;").replace(/</g,"&amp;lt;").replace(/&lt;/g,"&amp;lt;");var sl=Jt(101);const ke=(e,t,n,a=0,s=0)=>{e.style.top=n+"px",e.style.left=t+"px";const i=e.getBoundingClientRect();if(i.bottom>window.innerHeight||i.top<f.SIZE_TOOLBAR_HEIGHT){const l=n-i.height-a;l>f.SIZE_TOOLBAR_HEIGHT&&l+i.height<window.innerHeight?e.style.top=l+"px":l<=f.SIZE_TOOLBAR_HEIGHT?e.style.top=f.SIZE_TOOLBAR_HEIGHT+"px":e.style.top=Math.max(f.SIZE_TOOLBAR_HEIGHT,window.innerHeight-i.height)+"px"}i.right>window.innerWidth?e.style.left=`${window.innerWidth-i.width-s}px`:i.left<0&&(e.style.left="0")};var U=Jt(752);const No=()=>{const e=window.siyuan.emojis[rt(0,window.siyuan.emojis.length-1)];return typeof e.items[rt(0,e.items.length-1)]=="undefined"?"1f600":e.items[rt(0,e.items.length-1)].unicode},ge=(e,t="",n=!1,a=!1)=>{if(!e)return"";let s="";if(e.startsWith("api/icon/getDynamicIcon"))s=`<img class="${t}" ${a?"data-":""}src="${e}"/>`;else if(e.indexOf(".")>-1)s=`<img class="${t}" ${a?"data-":""}src="/emojis/${e}"/>`;else try{e.split("-").forEach(i=>{i.length<5?s+=String.fromCodePoint(parseInt("0"+i,16)):s+=String.fromCodePoint(parseInt(i,16))}),n&&(s=`<span class="${t}">${s}</span>`)}catch(i){}return s},Qi=e=>{const t=new IntersectionObserver(n=>{n.forEach(a=>{const s=a.target.getAttribute("data-index");if((typeof a.isIntersecting=="undefined"?a.intersectionRatio!==0:a.isIntersecting)&&s){let i="";window.siyuan.emojis[parseInt(s)].items.forEach(l=>{i+=`<button data-unicode="${l.unicode}" class="emojis__item ariaLabel" aria-label="${ka(l)}">
${ge(l.unicode)}</button>`}),a.target.innerHTML=i,a.target.removeAttribute("data-index"),a.target.style.minHeight=""}})});e.querySelectorAll(".emojis__content").forEach(n=>{t.observe(n)})},pi=e=>{const t=new IntersectionObserver(n=>{n.forEach(a=>{const s=a.target.getAttribute("data-src");(typeof a.isIntersecting=="undefined"?a.intersectionRatio!==0:a.isIntersecting)&&s&&(a.target.src=s,a.target.removeAttribute("data-src"))})});e.querySelectorAll("img").forEach(n=>{t.observe(n)})},mi=(e="",t)=>{let n="";const a=[];e&&(n=`<div class="emojis__title">${window.siyuan.languages.emoji}</div><div class="emojis__content">`);let s=0,i="";const l=[];window.siyuan.emojis.forEach((r,c)=>{e||(n+=`<div class="emojis__title" data-type="${c+1}">${wt(c)}</div><div style="min-height:${c===0?"30px":"300px"}" class="emojis__content"${c>1?' data-index="'+c+'"':""}>`),r.items.length===0&&c===0&&!e&&(n+=`<div style="margin-left: 4px">${window.siyuan.languages.setEmojiTip}</div>`),r.items.forEach(d=>{if(e){if(window.siyuan.config.editor.emoji.includes(d.unicode)&&(ge(d.unicode)===e||d.keywords.toLowerCase().indexOf(e.toLowerCase())>-1||d.description.toLowerCase().indexOf(e.toLowerCase())>-1||d.description_zh_cn.toLowerCase().indexOf(e.toLowerCase())>-1||d.description_ja_jp.toLowerCase().indexOf(e.toLowerCase())>-1)&&a.push(d),t&&s>t)return;(ge(d.unicode)===e||d.keywords.toLowerCase().indexOf(e.toLowerCase())>-1||d.description.toLowerCase().indexOf(e.toLowerCase())>-1||d.description_zh_cn.toLowerCase().indexOf(e.toLowerCase())>-1||d.description_ja_jp.toLowerCase().indexOf(e.toLowerCase())>-1)&&(r.id==="custom"?l.push(d):i+=`<button data-unicode="${d.unicode}" class="emojis__item ariaLabel" aria-label="${ka(d)}">
${ge(d.unicode,void 0,!1,!0)}</button>`,s++)}else window.siyuan.config.editor.emoji.includes(d.unicode)&&a.push(d),c<2&&(n+=`<button data-unicode="${d.unicode}" class="emojis__item ariaLabel" aria-label="${ka(d)}">
${ge(d.unicode,void 0,!1,!0)}</button>`)}),e||(n+="</div>")}),e&&(l.sort((r,c)=>{const d=r.keywords.split("/"),u=c.keywords.split("/");return d[d.length-1].toLowerCase().indexOf(e.toLowerCase())<u[u.length-1].toLowerCase().indexOf(e.toLowerCase())?-1:0}).sort((r,c)=>{const d=r.keywords.split("/"),u=c.keywords.split("/");return d[d.length-1].toLowerCase().indexOf(e.toLowerCase())===u[u.length-1].toLowerCase().indexOf(e.toLowerCase())&&d[d.length-1].length<u[u.length-1].length?-1:0}).forEach(r=>{n+=`<button data-unicode="${r.unicode}" class="emojis__item ariaLabel" aria-label="${ka(r)}">
${ge(r.unicode,void 0,!1,!0)}</button>`}),n=n+i+"</div>");let o="";return a.length>0&&(o=`<div class="emojis__title" data-type="0">${window.siyuan.languages.recentEmoji}</div><div class="emojis__content">`,window.siyuan.config.editor.emoji.forEach(r=>{const c=a.filter(d=>d.unicode===r);c[0]&&(o+=`<button data-unicode="${c[0].unicode}" class="emojis__item ariaLabel" aria-label="${ka(c[0])}">
${ge(c[0].unicode,void 0,!1,!0)}
</button>`)}),o+="</div>"),o+n===""?`<div class="emojis__title">${window.siyuan.languages.emptyContent}</div>`:o+n},ha=e=>{window.siyuan.config.editor.emoji.unshift(e),window.siyuan.config.editor.emoji.length>f.SIZE_UNDO&&window.siyuan.config.editor.emoji.pop(),window.siyuan.config.editor.emoji=Array.from(new Set(window.siyuan.config.editor.emoji)),A("/api/setting/setEmoji",{emoji:window.siyuan.config.editor.emoji})},Po=(e,t)=>{const n={1:["Sun","\u5468\u65E5","\u9031\u65E5"],2:["SUN","\u5468\u5929","\u9031\u5929"],3:["Sunday","\u661F\u671F\u65E5","\u661F\u671F\u65E5"],4:["SUNDAY","\u661F\u671F\u5929","\u661F\u671F\u5929"]};let a=0;return e===""&&(e=window.siyuan.config.lang),e==="zh_CN"?a=1:e==="zh_CHT"&&(a=2),`<option value="1" ${t==="1"?" selected":""}>${n[1][a]}</option>
<option value="2" ${t==="2"?" selected":""}>${n[2][a]}</option>
<option value="3" ${t==="3"?" selected":""}>${n[3][a]}</option>
<option value="4" ${t==="4"?" selected":""}>${n[4][a]}</option>`},qo=(e,t)=>{if(!e)return;let n="";window.siyuan.emojis[parseInt(e)].items.forEach(a=>{n+=`<button data-unicode="${a.unicode}" class="emojis__item ariaLabel" aria-label="${ka(a)}">${ge(a.unicode)}</button>`}),t.innerHTML=n,t.removeAttribute("data-index"),t.removeAttribute("style")},_a=(e,t,n,a,s)=>{t!=="av"?window.siyuan.menus.menu.remove():window.siyuan.menus.menu.removeScrollEvent();const i="api/icon/getDynamicIcon?",l={color:"#d23f31",lang:"",date:"",weekdayType:"1",type:"1",content:"SiYuan"};if(s&&s.getAttribute("src").startsWith(i)){const y=new URLSearchParams(s.getAttribute("src").replace(i,""));l.color=y.get("color")||"#d23f31",l.color.startsWith("#")||(l.color="#"+l.color),l.lang=y.get("lang")||"",l.date=y.get("date")||"",l.weekdayType=y.get("weekdayType")||"1",l.type=y.get("type")||"1",l.content=y.get("content")||"SiYuan"}const o=new we({disableAnimation:!0,transparent:!0,hideCloseIcon:!0,width:H()?"80vw":"368px",height:"50vh",content:`<div class="emojis">
    <div class="emojis__tabheader">
        <div data-type="tab-emoji" class="ariaLabel block__icon block__icon--show" aria-label="${window.siyuan.languages.emoji}"><svg><use xlink:href="#iconEmoji"></use></svg></div>
        <div class="fn__space"></div>
        <div data-type="tab-dynamic" class="ariaLabel block__icon block__icon--show" aria-label="${window.siyuan.languages.dynamicEmoji}"><svg><use xlink:href="#iconCalendar"></use></svg></div>
        <div class="fn__flex-1"></div>
        <span class="block__icon block__icon--show fn__flex-center ariaLabel" data-action="remove" aria-label="${window.siyuan.languages.remove}"><svg><use xlink:href="#iconTrashcan"></use></svg></span>
    </div>
    <div class="emojis__tabbody">
        <div class="fn__none" data-type="tab-emoji">
            <div class="fn__hr"></div>
            <div class="fn__flex">
                <span class="fn__space"></span>
                <label class="b3-form__icon fn__flex-1" style="overflow:initial;">
                    <svg class="b3-form__icon-icon"><use xlink:href="#iconSearch"></use></svg>
                    <input class="b3-form__icon-input b3-text-field fn__block" placeholder="${window.siyuan.languages.search}">
                </label>
                <span class="fn__space"></span>
                <span class="block__icon block__icon--show fn__flex-center ariaLabel" data-action="random" aria-label="${window.siyuan.languages.random}"><svg><use xlink:href="#iconRefresh"></use></svg></span>
                <span class="fn__space"></span>
            </div>
            <div class="emojis__panel">${mi()}</div>
            <div class="fn__flex">
                ${[["2b50",window.siyuan.languages.recentEmoji],["1f527",wt(0)],["1f60d",wt(1)],["1f433",wt(2)],["1f96a",wt(3)],["1f3a8",wt(4)],["1f3dd-fe0f",wt(5)],["1f52e",wt(6)],["267e-fe0f",wt(7)],["1f6a9",wt(8)]].map(([y,_],w)=>`<div data-type="${w}" class="emojis__type ariaLabel" aria-label="${_}">${ge(y)}</div>`).join("")}
            </div>
        </div>
        <div class="fn__none" data-type="tab-dynamic">
            <div class="fn__flex emoji__dynamic-color">
                <div class="color__square fn__pointer${l.color==="#d23f31"?" color__square--current":""}" style="background-color:#d23f31"></div>
                <div class="color__square fn__pointer${l.color==="#3575f0"?" color__square--current":""}" style="background-color:#3575f0"></div>
                <div class="color__square fn__pointer${l.color==="#f3a92f"?" color__square--current":""}" style="background-color:#f3a92f"></div>
                <div class="color__square fn__pointer${l.color==="#65b84d"?" color__square--current":""}" style="background-color:#65b84d"></div>
                <div class="color__square fn__pointer${l.color==="#e099ff"?" color__square--current":""}" style="background-color:#e099ff"></div>
                <div class="color__square fn__pointer${l.color==="#ea5d97"?" color__square--current":""}" style="background-color:#ea5d97"></div>
                <div class="color__square fn__pointer${l.color==="#93627f"?" color__square--current":""}" style="background-color:#93627f"></div>
                <div class="color__square fn__pointer${l.color==="#5f6368"?" color__square--current":""}" style="background-color:#5f6368"></div>
                <div class="fn__space--small"></div>
                <input type="text" class="b3-text-field fn__flex-1 fn__flex-center" value="${l.color}">
            </div>
            <div class="fn__flex">
                <span class="fn__space"></span>
                <span class="fn__flex-center ft__on-surface" style="width: 89px">${window.siyuan.languages.language}</span>
                <span class="fn__space--small"></span>
                <select class="b3-select fn__flex-1">
                    <option value="" ${l.lang===""?" selected":""}>${window.siyuan.languages.themeOS}</option>
                    <option value="en_US" ${l.lang==="en_US"?" selected":""}>English (en_US)</option>
                    <option value="zh_CHT" ${l.lang==="zh_CHT"?" selected":""}>\u7E41\u9AD4\u4E2D\u6587 (zh_CHT)</option>
                    <option value="zh_CN" ${l.lang==="zh_CN"?" selected":""}>\u7B80\u4F53\u4E2D\u6587 (zh_CN)</option>
                </select>
                <span class="fn__space"></span>
            </div>
            <div class="fn__hr"></div>
            <div class="fn__flex">
                <span class="fn__space"></span>
                <span class="fn__flex-center ft__on-surface" style="width: 89px">${window.siyuan.languages.date}</span>
                <span class="fn__space--small"></span>
                <input type="date" max="9999-12-31" class="b3-text-field fn__flex-1" value="${l.date}"/>
                <span class="fn__space"></span>
            </div>
            <div class="fn__hr"></div>
            <div class="fn__flex">
                <span class="fn__space"></span>
                <span class="fn__flex-center ft__on-surface" style="width: 89px">${window.siyuan.languages.format}</span>
                <span class="fn__space--small"></span>
                <select class="b3-select fn__flex-1">
                    ${Po(l.lang,l.weekdayType)}
                </select>
                <span class="fn__space"></span>
            </div>
            <div class="fn__flex fn__flex-wrap">
                <img class="emoji__dynamic-item${l.type==="1"?" emoji__dynamic-item--current":""}" src="${i}type=1&color=${encodeURIComponent(l.color)}&date=${l.date}&weekdayType=${l.weekdayType}&lang=${l.lang}">
                <img class="emoji__dynamic-item${l.type==="2"?" emoji__dynamic-item--current":""}" src="${i}type=2&color=${encodeURIComponent(l.color)}&date=${l.date}&weekdayType=${l.weekdayType}&lang=${l.lang}">
                <img class="emoji__dynamic-item${l.type==="3"?" emoji__dynamic-item--current":""}" src="${i}type=3&color=${encodeURIComponent(l.color)}&date=${l.date}&weekdayType=${l.weekdayType}&lang=${l.lang}">
                <img class="emoji__dynamic-item${l.type==="4"?" emoji__dynamic-item--current":""}" src="${i}type=4&color=${encodeURIComponent(l.color)}&date=${l.date}&weekdayType=${l.weekdayType}&lang=${l.lang}">
                <img class="emoji__dynamic-item${l.type==="5"?" emoji__dynamic-item--current":""}" src="${i}type=5&color=${encodeURIComponent(l.color)}&date=${l.date}&weekdayType=${l.weekdayType}&lang=${l.lang}">
                <img class="emoji__dynamic-item${l.type==="6"?" emoji__dynamic-item--current":""}" src="${i}type=6&color=${encodeURIComponent(l.color)}&date=${l.date}&weekdayType=${l.weekdayType}&lang=${l.lang}">
                <img class="emoji__dynamic-item${l.type==="7"?" emoji__dynamic-item--current":""}" src="${i}type=7&color=${encodeURIComponent(l.color)}&date=${l.date}&weekdayType=${l.weekdayType}&lang=${l.lang}">
            </div>
            <div class="fn__hr"></div>
            <div class="fn__flex">
                <span class="fn__space"></span>
                <span class="fn__flex-center ft__on-surface" style="width: 89px">${window.siyuan.languages.custom}</span>
                <span class="fn__space--small"></span>
                <input type="text" class="b3-text-field fn__flex-1" value="${l.content}">
                <span class="fn__space"></span>
            </div>
            <div>
                <img data-type="text" class="emoji__dynamic-item${l.type==="8"?" emoji__dynamic-item--current":""}" src="${i}type=8&color=${encodeURIComponent(l.color)}&content=${l.content}&id=${e}">
            </div>
        </div>
    </div>
</div>`});o.element.setAttribute("data-key",f.DIALOG_EMOJIS),o.element.querySelector(".b3-dialog__container").setAttribute("data-menu","true");const r=o.element.querySelector(".b3-dialog");r.style.justifyContent="inherit",r.style.alignItems="inherit";const c=window.siyuan.storage[f.LOCAL_EMOJIS].currentTab;o.element.querySelector(`.emojis__tabheader [data-type="tab-${c}"]`).classList.add("block__icon--active"),o.element.querySelector(`.emojis__tabbody [data-type="tab-${c}"]`).classList.remove("fn__none"),ke(o.element.querySelector(".b3-dialog__container"),n.x,n.y,n.h,n.w),o.element.querySelector(".emojis__item").classList.add("emojis__item--current");const d=o.element.querySelector('[data-type="tab-emoji"] .b3-text-field'),u=o.element.querySelector(".emojis__panel");d.addEventListener("compositionend",()=>{var y;u.innerHTML=mi(d.value),d.value?u.nextElementSibling.classList.add("fn__none"):u.nextElementSibling.classList.remove("fn__none"),u.scrollTop=0,(y=o.element.querySelector(".emojis__item"))==null||y.classList.add("emojis__item--current"),d.value===""&&Qi(o.element),pi(o.element)}),d.addEventListener("input",y=>{var _;y.isComposing||(u.innerHTML=mi(d.value),d.value?u.nextElementSibling.classList.add("fn__none"):u.nextElementSibling.classList.remove("fn__none"),u.scrollTop=0,(_=o.element.querySelector(".emojis__item"))==null||_.classList.add("emojis__item--current"),d.value===""&&Qi(o.element),pi(o.element))}),d.addEventListener("keydown",y=>{var _,w,v,h;if(y.isComposing||y.key.indexOf("Arrow")===-1&&y.key!=="Enter")return;const E=o.element.querySelector(".emojis__item--current");if(!E)return;if(y.key==="Enter"){const L=E.getAttribute("data-unicode");t==="notebook"?A("/api/notebook/setNotebookIcon",{notebook:e,icon:L},()=>{o.destroy(),ha(L),va(L,e,"iconFilesRoot")}):t==="doc"&&A("/api/attr/setBlockAttrs",{id:e,attrs:{icon:L}},()=>{o.destroy(),ha(L),va(L,e),es(L,e)}),a&&a(L),y.preventDefault(),y.stopPropagation();return}let S;if(y.key==="ArrowLeft")E.previousElementSibling?(E.classList.remove("emojis__item--current"),S=E.previousElementSibling,y.preventDefault(),y.stopPropagation()):(_=E.parentElement.previousElementSibling)!=null&&_.previousElementSibling&&(E.classList.remove("emojis__item--current"),S=E.parentElement.previousElementSibling.previousElementSibling.lastElementChild,y.preventDefault(),y.stopPropagation());else if(y.key==="ArrowRight")E.nextElementSibling?(E.classList.remove("emojis__item--current"),S=E.nextElementSibling,y.preventDefault(),y.stopPropagation()):(w=E.parentElement.nextElementSibling)!=null&&w.nextElementSibling&&(E.classList.remove("emojis__item--current"),S=E.parentElement.nextElementSibling.nextElementSibling.firstElementChild,y.preventDefault(),y.stopPropagation());else if(y.key==="ArrowDown"){if(E.nextElementSibling){E.classList.remove("emojis__item--current");let L=Math.floor(E.parentElement.clientWidth/(E.clientWidth+2));for(S=E;S.nextElementSibling&&L>0;)S=S.nextElementSibling,L--}else{const L=(v=E.parentElement.nextElementSibling)==null?void 0:v.nextElementSibling;L&&(S=L.firstElementChild,E.classList.remove("emojis__item--current"))}y.preventDefault(),y.stopPropagation()}else if(y.key==="ArrowUp"){if(E.previousElementSibling){E.classList.remove("emojis__item--current");let L=Math.floor(E.parentElement.clientWidth/(E.clientWidth+2));for(S=E;S.previousElementSibling&&L>0;)S=S.previousElementSibling,L--}else{const L=(h=E.parentElement.previousElementSibling)==null?void 0:h.previousElementSibling;L&&(S=L.lastElementChild,E.classList.remove("emojis__item--current"))}y.preventDefault(),y.stopPropagation()}if(S){S.classList.add("emojis__item--current");const L=d.clientHeight+6;S.offsetTop-L<u.scrollTop?u.scrollTop=S.offsetTop-L-6:S.offsetTop-L-u.clientHeight+S.clientHeight>u.scrollTop&&(u.scrollTop=S.offsetTop-L-u.clientHeight+S.clientHeight)}}),!H()&&c==="emoji"&&d.focus(),Qi(o.element),pi(o.element),o.element.addEventListener("click",y=>{var _,w;let v=y.target;for(;v&&v!==o.element;){if(v.classList.contains("emojis__type")){const h=u.querySelector(`[data-type="${v.getAttribute("data-type")}"]`);if(h){const E=h.nextElementSibling.getAttribute("data-index");E&&(qo((_=h.previousElementSibling)==null?void 0:_.getAttribute("data-index"),h.previousElementSibling),qo(E,h.nextElementSibling)),u.scrollTo({top:h.offsetTop-77})}break}else if(v.getAttribute("data-action")==="remove"){t==="notebook"?A("/api/notebook/setNotebookIcon",{notebook:e,icon:""},()=>{o.destroy(),va("",e,"iconFilesRoot")}):t==="doc"&&A("/api/attr/setBlockAttrs",{id:e,attrs:{icon:""}},()=>{o.destroy(),va("",e),es("",e)}),a&&a("");break}else if(v.classList.contains("emojis__item")||v.getAttribute("data-action")==="random"||v.classList.contains("emoji__dynamic-item")){let h="";v.classList.contains("emojis__item")?(h=v.getAttribute("data-unicode"),o.destroy()):v.classList.contains("emoji__dynamic-item")?(h=v.getAttribute("src"),o.destroy()):h=No(),t==="notebook"?A("/api/notebook/setNotebookIcon",{notebook:e,icon:h},()=>{ha(h),va(h,e,"iconFilesRoot")}):t==="doc"&&A("/api/attr/setBlockAttrs",{id:e,attrs:{icon:h}},()=>{ha(h),va(h,e),es(h,e)}),a&&a(h);break}else if((w=v.getAttribute("data-type"))!=null&&w.startsWith("tab-")){r.querySelectorAll('.emojis__tabheader [data-type|="tab"]').forEach(h=>{h.dataset.type===v.dataset.type?h.classList.add("block__icon--active"):h.classList.remove("block__icon--active")}),r.querySelectorAll(".emojis__tabbody > div").forEach(h=>{h.dataset.type===v.dataset.type?h.classList.remove("fn__none"):h.classList.add("fn__none")}),window.siyuan.storage[f.LOCAL_EMOJIS].currentTab=v.dataset.type.replace("tab-",""),Ae(f.LOCAL_EMOJIS,window.siyuan.storage[f.LOCAL_EMOJIS]);break}else if(v.classList.contains("color__square")){m[0].value=v.getAttribute("style").replace("background-color:",""),m[0].dispatchEvent(new CustomEvent("input"));break}v=v.parentElement}});const p=o.element.querySelectorAll('[data-type="tab-dynamic"] .b3-select');p[0].addEventListener("change",()=>{o.element.querySelectorAll(".fn__flex-wrap .emoji__dynamic-item").forEach(y=>{const _=new URLSearchParams(y.getAttribute("src").replace(i,""));p[0].value?_.set("lang",p[0].value):_.delete("lang"),y.setAttribute("src",i+_.toString()),p[1].innerHTML=Po(p[0].value,p[1].value)})}),p[1].addEventListener("change",()=>{o.element.querySelectorAll(".fn__flex-wrap .emoji__dynamic-item").forEach(y=>{const _=new URLSearchParams(y.getAttribute("src").replace(i,""));_.set("weekdayType",p[1].value),y.setAttribute("src",i+_.toString())})});const g=o.element.querySelector('[data-type="tab-dynamic"] [type="date"]');g.addEventListener("change",()=>{o.element.querySelectorAll(".fn__flex-wrap .emoji__dynamic-item").forEach(y=>{const _=new URLSearchParams(y.getAttribute("src").replace(i,""));_.set("date",g.value?U(g.value).format("YYYY-MM-DD"):""),y.setAttribute("src",i+_.toString())})});const m=o.element.querySelectorAll('[data-type="tab-dynamic"] [type="text"]'),b=o.element.querySelector('.emoji__dynamic-item[data-type="text"]');m[0].addEventListener("input",()=>{m[0].value.startsWith("#")&&(o.element.querySelectorAll(".emoji__dynamic-item").forEach(y=>{const _=new URLSearchParams(y.getAttribute("src").replace(i,""));_.set("color",m[0].value),y.setAttribute("src",i+_.toString())}),o.element.querySelectorAll(".color__square").forEach(y=>{y.style.backgroundColor===m[0].value?y.classList.add("color__square--current"):y.classList.remove("color__square--current")}))}),m[1].addEventListener("input",()=>{const y=new URLSearchParams(b.getAttribute("src").replace(i,""));y.set("content",m[1].value),b.setAttribute("src",i+y.toString())})},es=(e,t)=>{},va=(e,t,n="iconFile")=>{let a;a=document.querySelector(`#sidebar [data-type="sidebar-file"] [data-node-id="${t}"] .b3-list-item__icon`),a&&(a.innerHTML=ge(e||(n==="iconFile"?a.previousElementSibling.classList.contains("fn__hidden")?window.siyuan.storage[f.LOCAL_IMAGES].file:window.siyuan.storage[f.LOCAL_IMAGES].folder:window.siyuan.storage[f.LOCAL_IMAGES].note))),n!=="iconFile"&&jn()},ka=e=>window.siyuan.config.lang==="zh_CN"?e.description_zh_cn:window.siyuan.config.lang==="ja_JP"?e.description_ja_jp:e.description,wt=e=>window.siyuan.config.lang==="zh_CN"?window.siyuan.emojis[e].title_zh_cn:window.siyuan.config.lang==="ja_JP"?window.siyuan.emojis[e].title_ja_jp:window.siyuan.emojis[e].title,ou=e=>{if(window.siyuan.emojis[0].items.length>0){const t={};window.siyuan.emojis[0].items.forEach(n=>{t[n.keywords]=e.options.hint.emojiPath+"/"+n.unicode}),e.lute.PutEmojis(t)}},ru=()=>{A("/api/system/getEmojiConf",{},e=>{window.siyuan.emojis=e.data,ba().forEach(t=>{ou(t.protyle)})})},dm=(e,t)=>{if(e.includes("\u2303")){if(!t.ctrlKey)return!1}else if(isMac()?t.ctrlKey:e.includes("\u2318")?!t.ctrlKey:t.ctrlKey)return!1;if(e.includes("\u2325")){if(!t.altKey)return!1}else if(t.altKey)return!1;if(e.includes("\u21E7")){if(!t.shiftKey)return!1}else if(t.shiftKey)return!1;if(e.includes("\u2318")){if(isMac()?!t.metaKey:!t.ctrlKey)return!1}else if(isMac()?t.metaKey:e.includes("\u2303")?!t.ctrlKey:t.ctrlKey)return!1;return!0},ts=(e,t)=>{const n=e.replace(t,f.ZWSP).split("");return n.forEach((a,s)=>{a===f.ZWSP&&(n[s]=t)}),n},te=(e,t)=>{if(!e)return!1;if(e.startsWith("\u2303")&&!Lt()){if(e==="\u2303D")return!1;e=e.replace("\u2318","").replace("\u2303","\u2318").replace("\u2318\u21E7","\u21E7\u2318").replace("\u2318\u2325\u21E7","\u2325\u21E7\u2318").replace("\u2318\u2325","\u2325\u2318")}if(e.indexOf("\u21E7")===-1&&e.indexOf("\u2318")===-1&&e.indexOf("\u2325")===-1&&e.indexOf("\u2303")===-1)return!!(Ue(t)&&!t.altKey&&!t.shiftKey&&e===f.KEYCODELIST[t.keyCode]);let n=e.split("");if(e.indexOf("F")>-1?n.forEach((s,i)=>{s==="F"&&(n[i]="F"+n.splice(i+1,1),n[i+1]&&(n[i+1]+=n.splice(i+1,1)))}):e.indexOf("PageUp")>-1?n=ts(e,"PageUp"):e.indexOf("PageDown")>-1?n=ts(e,"PageDown"):e.indexOf("Home")>-1?n=ts(e,"Home"):e.indexOf("End")>-1&&(n=ts(e,"End")),e.startsWith("\u21E7")&&n.length===2)return!!(Ue(t)&&!t.altKey&&t.shiftKey&&n[1]===f.KEYCODELIST[t.keyCode]);if(e.startsWith("\u2325")){let s=n.length===3?n[2]:n[1];n.length===4&&(s=n[3]);const i=s===f.KEYCODELIST[t.keyCode];return!!(i&&t.altKey&&!t.shiftKey&&n.length<4&&(n.length===3?bt(t)&&e.startsWith("\u2325\u2318"):Ue(t))||i&&e.startsWith("\u2325\u21E7\u2318")&&n.length===4&&t.altKey&&t.shiftKey&&bt(t)||i&&e.startsWith("\u2325\u21E7")&&n.length===3&&t.altKey&&t.shiftKey&&Ue(t))}if(e.startsWith("\u2303")){if(!Lt())return!1;let s=n.length===3?n[2]:n[1];n.length===4?s=n[3]:n.length===5&&(s=n[4]);const i=s===f.KEYCODELIST[t.keyCode];return!!(i&&t.ctrlKey&&!t.altKey&&!t.shiftKey&&n.length<4&&(n.length===3?t.metaKey&&e.startsWith("\u2303\u2318"):!t.metaKey)||i&&e.startsWith("\u2303\u21E7")&&n.length===3&&t.ctrlKey&&!t.altKey&&t.shiftKey&&!t.metaKey||i&&e.startsWith("\u2303\u2325")&&n.length===3&&t.ctrlKey&&t.altKey&&!t.shiftKey&&!t.metaKey||i&&n.length===4&&t.ctrlKey&&(e.startsWith("\u2303\u2325\u21E7")&&t.shiftKey&&!t.metaKey&&t.altKey||e.startsWith("\u2303\u2325\u2318")&&!t.shiftKey&&t.metaKey&&t.altKey||e.startsWith("\u2303\u21E7\u2318")&&t.shiftKey&&t.metaKey&&!t.altKey)||i&&n.length===5&&t.ctrlKey&&t.shiftKey&&t.metaKey&&t.altKey)}const a=n.length>2&&n[0]==="\u21E7";return bt(t)&&!t.altKey&&(!a&&!t.shiftKey||a&&t.shiftKey)?(a?n[2]:n[1])===f.KEYCODELIST[t.keyCode]:!1};class Ke{constructor(t,n){if(this.menu=window.siyuan.menus.menu,this.isOpen=!1,this.element=this.menu.element,t){const a=this.menu.element.getAttribute("data-name");a&&a===t&&(this.isOpen=!0)}this.menu.remove(),this.isOpen||(this.menu.element.setAttribute("data-name",t||""),this.menu.removeCB=n)}showSubMenu(t){this.menu.showSubMenu(t)}addItem(t){if(!this.isOpen)return this.menu.addItem(t)}addSeparator(t,n=!1){let a,s,i=!1;if(typeof t=="object"?(i=t.ignore||!1,s=t.index,a=t.id):typeof t=="number"&&(s=t,i=n),!(i||this.isOpen))return this.menu.addItem({id:a,type:"separator",index:s})}open(t){this.isOpen||this.menu.popup(t)}fullscreen(t="all"){this.isOpen||this.menu.fullscreen(t)}close(){this.menu.remove()}}const um=e=>{},cu=()=>{const e=new URLSearchParams(window.location.search),t=e.get("url");let n="",a=!1;if(/^web\+siyuan:\/\/blocks\/\d{14}-\w{7}/.test(t))n=t.substring(20,20+22),a=st("focus",t)==="1";else if(window.JSAndroid){const s=window.JSAndroid.getBlockURL();n=ns(s),a=st("focus",s)==="1"}else n=e.get("id"),a=e.get("focus")==="1";return{id:n,isZoomIn:a}},du=e=>/^siyuan:\/\/blocks\/\d{14}-\w{7}/.test(e),ns=e=>e.substring(16,16+22),uu=(e=window.location.href)=>{const t=new URL(window.location.origin);t.pathname="/check-auth",t.searchParams.set("to",e),window.location.href=t.href},fu=()=>{let e=document.getElementById("baseURL");e||(e=document.createElement("base"),e.id="baseURL"),e.setAttribute("href",location.origin),document.getElementsByTagName("head")[0].appendChild(e)},ct=(e,t=!0,n=!1)=>{let a=e;return t&&(a=me().basename(e)),n&&a.endsWith(".sy")&&(a=a.substr(0,a.length-3)),a},ll=e=>me().basename(e,me().extname(e)).replace(/-\d{14}-\w{7}/,""),Oo=e=>!e||(e=e.trim(),1>e.length)?!1:(e=e.toLowerCase(),e.startsWith("assets/")||e.startsWith("file://")||e.startsWith("\\\\")?!0:Mo()?e.indexOf(":")===1:e.startsWith("/")),me=()=>sl.posix?sl.posix:sl,fm=()=>path,ol=e=>{const t=[];return e.forEach(n=>{if(n.getAttribute("data-type")!=="navigation-root"){const a=n.getAttribute("data-path");t.find(i=>{if(a.startsWith(i.replace(".sy","")))return!0})||t.push(a)}}),t},rl=(e,t,n)=>{A("/api/filetree/moveDocs",{toNotebook:t,fromPaths:e,toPath:n})},Wn=(e,t,n,a,s=!1)=>{if(window.siyuan.dialogs.find(g=>{if(g.element.querySelector("#foldList"))return g.destroy(),!0}))return;const l=new we({title:`<div style="padding: 8px;">
    ${a||window.siyuan.languages.move}
    <div style="max-height: 16px;overflow: auto;line-height: 14px;-webkit-mask-image: linear-gradient(to top, rgba(0, 0, 0, 0) 0, #000 6px);padding-bottom: 4px;margin-bottom: -4px" class="ft__smaller ft__on-surface fn__hidescrollbar"></div>
</div>`,content:`<div class="b3-form__icon" style="margin: 8px">
    <span data-menu="true" class="b3-form__icon-list fn__a b3-tooltips b3-tooltips__s" aria-label="${Me("\u2325\u2193")}">
        <svg class="svg--mid"><use xlink:href="#iconSearch"></use></svg>
        <svg class="svg--smaller"><use xlink:href="#iconDown"></use></svg>
    </span>
    <input class="b3-text-field fn__block" style="padding-left: 42px;" value="" placeholder="${window.siyuan.languages.search}">
</div>
<ul id="foldList" class="fn__flex-1 fn__none b3-list b3-list--background${H()?" b3-list--mobile":""}" style="overflow: auto;position: relative"></ul>
<div id="foldTree" class="fn__flex-1${H()?" b3-list--mobile":""}" style="overflow: auto;position: relative"></div>
<div class="fn__hr"></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:H()?"92vw":"50vw",height:H()?"80vh":"70vh",destroyCallback(){n&&X(n)}});l.element.querySelector(".b3-dialog__header").setAttribute("style","padding:0"),l.element.setAttribute("data-key",f.DIALOG_MOVEPATHTO),t&&t.length>0&&A("/api/filetree/getHPathsByPaths",{paths:t},g=>{l.element.querySelector(".b3-dialog__header .ft__smaller").innerHTML=pe(g.data.join(" "))});const o=l.element.querySelector("#foldList"),r=l.element.querySelector("#foldTree");jn(g=>{let m="";g.forEach(b=>{if(!b.closed){let y="";s&&(y=`<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardNewCard}">${b.newFlashcardCount}</span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardDueCard}">${b.dueFlashcardCount}</span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardCard}">${b.flashcardCount}</span>`),m+=`<ul class="b3-list b3-list--background">
<li class="b3-list-item${m===""?" b3-list-item--focus":""}" data-path="/" data-box="${b.id}">
    <span class="b3-list-item__toggle b3-list-item__toggle--hl">
        <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
    </span>
    ${ge(b.icon||window.siyuan.storage[f.LOCAL_IMAGES].note,"b3-list-item__graphic",!0)}
    <span class="b3-list-item__text">${pe(b.name)}</span>
    ${y}
</li></ul>`}}),r.innerHTML=m},s);const c=l.element.querySelector(".b3-text-field");c.value=window.siyuan.storage[f.LOCAL_MOVE_PATH].k;const d=g=>{if(!(g&&g.isComposing)){if(c.value.trim()===""){o.classList.add("fn__none"),r.classList.remove("fn__none");return}r.classList.add("fn__none"),o.classList.remove("fn__none"),o.scrollTo(0,0),A("/api/filetree/searchDocs",{k:c.value,flashcard:s},m=>{let b="";m.data.forEach(y=>{let _="";s&&(_=`<span class="fn__flex-1"></span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardNewCard}">${y.newFlashcardCount}</span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardDueCard}">${y.dueFlashcardCount}</span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardCard}">${y.flashcardCount}</span>`),b+=`<li class="b3-list-item${b===""?" b3-list-item--focus":""}" data-path="${y.path}" data-box="${y.box}">
    ${ge(y.boxIcon||window.siyuan.storage[f.LOCAL_IMAGES].note,"b3-list-item__graphic",!0)}
    <span class="b3-list-item__showall" style="padding: 4px 0">${pe(y.hPath)}</span>
    ${_}
</li>`}),o.innerHTML=b})}},u=()=>{const g=window.siyuan.storage[f.LOCAL_MOVE_PATH].keys;if(!g||g.length===0||g.length===1&&g[0]===c.value)return;const m=new Ke("move-path-history");if(m.isOpen)return;m.element.classList.add("b3-menu--list"),m.addItem({iconHTML:"",label:window.siyuan.languages.clearHistory,click(){window.siyuan.storage[f.LOCAL_MOVE_PATH].keys=[],Ae(f.LOCAL_MOVE_PATH,window.siyuan.storage[f.LOCAL_MOVE_PATH])}});const b=m.addSeparator(1);let y=!0;g.forEach(w=>{if(w!==c.value&&w){const v=m.addItem({iconHTML:"",label:pe(w),action:"iconCloseRound",bind(h){h.addEventListener("click",E=>{var S;$(E.target,"b3-menu__action")?(g.find((L,k)=>{if(L===w)return g.splice(k,1),!0}),window.siyuan.storage[f.LOCAL_MOVE_PATH].keys=g,Ae(f.LOCAL_MOVE_PATH,window.siyuan.storage[f.LOCAL_MOVE_PATH]),(S=h.previousElementSibling)!=null&&S.classList.contains("b3-menu__separator")&&!h.nextElementSibling?window.siyuan.menus.menu.remove():h.remove()):(c.value=h.textContent,d(),window.siyuan.menus.menu.remove()),E.preventDefault(),E.stopPropagation()})}});y&&v.classList.add("b3-menu__item--current"),y=!1}}),y&&b.remove();const _=c.getBoundingClientRect();m.open({x:_.left,y:_.bottom})};d(),c.addEventListener("compositionend",g=>{d(g)}),c.addEventListener("input",g=>{d(g)}),c.addEventListener("blur",()=>{if(!c.value)return;let g=window.siyuan.storage[f.LOCAL_MOVE_PATH].keys;g.splice(0,0,c.value),g=Array.from(new Set(g)),g.length>window.siyuan.config.search.limit&&g.splice(window.siyuan.config.search.limit,g.length-window.siyuan.config.search.limit),window.siyuan.storage[f.LOCAL_MOVE_PATH].k=c.value,window.siyuan.storage[f.LOCAL_MOVE_PATH].keys=g,Ae(f.LOCAL_MOVE_PATH,window.siyuan.storage[f.LOCAL_MOVE_PATH])});const p=28;c.addEventListener("keydown",g=>{if(g.isComposing)return;if(te("\u2325\u2193",g)){g.stopPropagation(),u();return}if(window.siyuan.menus.menu.element.getAttribute("data-name")==="move-path-history")return;const m=o.classList.contains("fn__none")?r:o,b=m.querySelectorAll(".b3-list-item--focus");if(b.length===0)return;let y=b[0];if(g.key.startsWith("Arrow")&&b.forEach((_,w)=>{w!==0&&_.classList.remove("b3-list-item--focus")}),o.classList.contains("fn__none")){if(g.key==="ArrowRight"&&!y.querySelector(".b3-list-item__arrow--open")&&!y.querySelector(".b3-list-item__toggle").classList.contains("fn__hidden")||g.key==="ArrowLeft"&&y.querySelector(".b3-list-item__arrow--open")){cl(y,s),g.preventDefault();return}if(g.key==="ArrowLeft"){let _=y.parentElement.previousElementSibling;if(_){_.tagName!=="LI"&&(_=m.querySelector(".b3-list-item")),y.classList.remove("b3-list-item--focus"),_.classList.add("b3-list-item--focus");const w=_.getBoundingClientRect(),v=m.getBoundingClientRect();(w.top<v.top||w.bottom>v.bottom)&&_.scrollIntoView(w.top<v.top)}return g.preventDefault(),!0}if(g.key==="ArrowDown"||g.key==="ArrowRight"){let _=y;for(;_;)if(_.nextElementSibling)if(_.nextElementSibling.classList.contains("fn__none"))_=_.nextElementSibling;else{_.nextElementSibling.tagName==="UL"?_=_.nextElementSibling.firstElementChild:_=_.nextElementSibling;break}else{if(_.parentElement.id==="foldTree")break;_=_.parentElement}if(_.classList.contains("b3-list-item")){y.classList.remove("b3-list-item--focus"),_.classList.add("b3-list-item--focus");const w=_.getBoundingClientRect(),v=r.getBoundingClientRect();(w.top<v.top||w.bottom>v.bottom)&&_.scrollIntoView(w.top<v.top)}return g.preventDefault(),!0}if(g.key==="ArrowUp"){let _=y;for(;_;)if(_.previousElementSibling)if(_.previousElementSibling.classList.contains("fn__none"))_=_.previousElementSibling;else{if(_.previousElementSibling.tagName==="LI")_=_.previousElementSibling;else{const w=_.previousElementSibling.querySelectorAll(".b3-list-item");_=w[w.length-1]}break}else{if(_.parentElement.id==="foldTree")break;_=_.parentElement}if(_.classList.contains("b3-list-item")){y.classList.remove("b3-list-item--focus"),_.classList.add("b3-list-item--focus");const w=_.getBoundingClientRect(),v=r.getBoundingClientRect();(w.top<v.top||w.bottom>v.bottom)&&_.scrollIntoView(w.top<v.top)}g.preventDefault()}}else{if(g.key==="ArrowDown"){y.classList.remove("b3-list-item--focus"),y.nextElementSibling?y.nextElementSibling.classList.add("b3-list-item--focus"):m.children[0].classList.add("b3-list-item--focus"),y=m.querySelector(".b3-list-item--focus"),(m.scrollTop<y.offsetTop-m.clientHeight+p||m.scrollTop>y.offsetTop)&&(m.scrollTop=y.offsetTop-m.clientHeight+p),g.preventDefault();return}if(g.key==="ArrowUp"){if(y.classList.remove("b3-list-item--focus"),y.previousElementSibling)y.previousElementSibling.classList.add("b3-list-item--focus");else{const _=m.children.length;m.children[_-1].classList.add("b3-list-item--focus")}y=m.querySelector(".b3-list-item--focus"),(m.scrollTop<y.offsetTop-m.clientHeight+p||m.scrollTop>y.offsetTop-p*2)&&(m.scrollTop=y.offsetTop-p*2),g.preventDefault();return}}if(g.key==="Enter"){const _=m.querySelectorAll(".b3-list-item--focus");if(_.length===0)return;const w=[],v=[];_.forEach(h=>{w.push(h.getAttribute("data-path")),v.push(h.getAttribute("data-box"))}),e(w,v),l.destroy(),g.preventDefault()}}),l.element.addEventListener("click",g=>{let m=g.target;for(;m&&!m.isEqualNode(l.element);){if(m.classList.contains("b3-list-item__toggle")){cl(m.parentElement,s),g.preventDefault(),g.stopPropagation();break}else if(m.classList.contains("b3-form__icon-list")){u(),g.preventDefault(),g.stopPropagation();break}else if(m.classList.contains("b3-button--text")){const y=(o.classList.contains("fn__none")?r:o).querySelectorAll(".b3-list-item--focus");if(y.length===0)return;const _=[],w=[];y.forEach(v=>{_.push(v.getAttribute("data-path")),w.push(v.getAttribute("data-box"))}),e(_,w),l.destroy(),g.preventDefault(),g.stopPropagation();break}else if(m.classList.contains("b3-button--cancel")){l.destroy(),g.preventDefault(),g.stopPropagation();break}else if(m.classList.contains("b3-list-item")){const y=(o.classList.contains("fn__none")?r:o).querySelectorAll(".b3-list-item--focus");if(y.length===0)return;a===window.siyuan.languages.specifyPath&&bt(g)?y.length===1&&y[0].isSameNode(m)||m.classList.toggle("b3-list-item--focus"):(y[0].classList.remove("b3-list-item--focus"),m.classList.add("b3-list-item--focus")),m.getAttribute("data-path")==="/"&&cl(m,s),g.preventDefault(),g.stopPropagation();break}m=m.parentElement}})},cl=(e,t)=>{const n=e.querySelector(".b3-list-item__arrow");if(n.classList.contains("b3-list-item__arrow--open")){n.classList.remove("b3-list-item__arrow--open"),e.nextElementSibling&&e.nextElementSibling.tagName==="UL"&&e.nextElementSibling.classList.add("fn__none");return}if(e.nextElementSibling&&e.nextElementSibling.tagName==="UL"){n.classList.add("b3-list-item__arrow--open"),e.nextElementSibling.classList.remove("fn__none");return}const a=e.getAttribute("data-box");A("/api/filetree/listDocsByPath",{notebook:a,path:e.getAttribute("data-path"),flashcard:t},s=>{if(s.data.files.length===0){ae(window.siyuan.languages.emptyContent);return}let i="";if(s.data.files.forEach(o=>{let r="";t?r=`<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardNewCard}">${o.newFlashcardCount}</span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardDueCard}">${o.dueFlashcardCount}</span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardCard}">${o.flashcardCount}</span>`:o.count&&o.count>0&&(r=`<span class="popover__block counter b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.ref}">${o.count}</span>`),i+=`<li data-box="${a}" class="b3-list-item" data-path="${o.path}">
    <span style="padding-left: ${o.path.split("/").length*8}px" class="b3-list-item__toggle b3-list-item__toggle--hl${o.subFileCount===0?" fn__hidden":""}">
        <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
    </span>
    ${ge(o.icon||(o.subFileCount===0?window.siyuan.storage[f.LOCAL_IMAGES].file:window.siyuan.storage[f.LOCAL_IMAGES].folder),"b3-list-item__graphic",!0)}
    <span class="b3-list-item__text ariaLabel" data-position="parentE" aria-label="${ct(o.name,!0,!0)} <small class='ft__on-surface'>${o.hSize}</small>${o.bookmark?"<br>"+window.siyuan.languages.bookmark+" "+o.bookmark:""}${o.name1?"<br>"+window.siyuan.languages.name+" "+o.name1:""}${o.alias?"<br>"+window.siyuan.languages.alias+" "+o.alias:""}${o.memo?"<br>"+window.siyuan.languages.memo+" "+o.memo:""}${o.subFileCount!==0?window.siyuan.languages.includeSubFile.replace("x",o.subFileCount):""}<br>${window.siyuan.languages.modifiedAt} ${o.hMtime}<br>${window.siyuan.languages.createdAt} ${o.hCtime}">${ct(o.name,!0,!0)}</span>
    ${r}
</li>`}),i==="")return;n.classList.add("b3-list-item__arrow--open"),e.insertAdjacentHTML("afterend",`<ul class="file-tree__sliderDown">${i}</ul>`);const l=e.nextElementSibling;setTimeout(()=>{l.setAttribute("style",`height:${l.childElementCount*e.clientHeight}px;`),setTimeout(()=>{l.classList.remove("file-tree__sliderDown"),l.removeAttribute("style")},120)},2)})},Ft=e=>{let t="";return window.siyuan.notebooks.find(n=>{if(n.id===e)return t=n.name,!0}),t},gu=e=>{let t="";return window.siyuan.notebooks.find(n=>{if(n.id===e)return t=n.icon,!0}),t},pu=(e,t)=>{window.siyuan.notebooks.find(n=>{if(n.id===e)return n.name=t,!0})},as=()=>{let e=0;return window.siyuan.notebooks.forEach(t=>{t.closed||e++}),e},jn=(e,t=!1)=>{A("/api/notebook/lsNotebooks",{flashcard:t},n=>{t||(window.siyuan.notebooks=n.data.notebooks),e&&e(n.data.notebooks)})},Ro=e=>{const t=new we({title:window.siyuan.languages.rename,content:`<div class="b3-dialog__content"><input class="b3-text-field fn__block" value="${e}"></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:H()?"92vw":"520px"});t.element.setAttribute("data-key",f.DIALOG_RENAMETAG);const n=t.element.querySelectorAll(".b3-button");n[0].addEventListener("click",()=>{t.destroy()});const a=t.element.querySelector("input");t.bindInput(a,()=>{n[1].click()}),a.focus(),a.select(),n[1].addEventListener("click",()=>{A("/api/tag/renameTag",{oldLabel:e,newLabel:a.value})})},mu=()=>me().basename(window.siyuan.config.system.workspaceDir.replace(/\\/g,"/")),Mn=(e,t)=>{e&&A("/api/block/checkBlockFold",{id:e},n=>{t(n.data.isFolded,n.data.isFolded?[f.CB_GET_FOCUS,f.CB_GET_ALL]:[f.CB_GET_FOCUS,f.CB_GET_CONTEXT,f.CB_GET_ROOTSCROLL],n.data.isRoot)})},bu=()=>{const e=new we({title:window.siyuan.languages.about5,content:`<div class="b3-dialog__content">
    <input class="b3-text-field fn__block" placeholder="${window.siyuan.languages.about5}" value="${window.siyuan.config.accessAuthCode}">
    <div class="b3-label__text">${window.siyuan.languages.about6}</div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:H()?"92vw":"520px"}),t=e.element.querySelector("input"),n=e.element.querySelectorAll(".b3-button");e.element.setAttribute("data-key",f.DIALOG_ACCESSAUTHCODE),e.bindInput(t,()=>{n[1].click()}),t.select(),n[0].addEventListener("click",()=>{e.destroy()}),n[1].addEventListener("click",()=>{A("/api/system/setAccessAuthCode",{accessAuthCode:t.value})})},Pt=e=>`${window.siyuan.config.cloudRegion===0?"https://ld246.com":"https://liuyun.io"}/${e}`,yu=e=>`https://b3log.org/siyuan${window.siyuan.config.lang==="zh_CN"?"":"/en"}/${e}`,Vn=(e=window.siyuan.languages._kernel[29])=>window.siyuan.user&&(window.siyuan.user.userSiYuanProExpireTime===-1||window.siyuan.user.userSiYuanProExpireTime>0)?!1:(e&&(e===window.siyuan.languages._kernel[29]&&window.siyuan.config.system.container==="ios"?ae(window.siyuan.languages._kernel[122]):(e===window.siyuan.languages._kernel[29]&&(e=window.siyuan.languages._kernel[29].replace("${url}",Pt("subscribe/siyuan"))),ae(e))),!0),zn=()=>window.siyuan.user&&(window.siyuan.user.userSiYuanSubscriptionStatus===0||window.siyuan.user.userSiYuanOneTimePayStatus===1),bi=(e,t)=>{if(!document.getElementById(t)){const n=document.createElement("link");n.id=t,n.rel="stylesheet",n.type="text/css",n.href=e;const a=document.querySelector("#pluginsStyle");a?a.before(n):document.getElementsByTagName("head")[0].appendChild(n)}};var Bo=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{o(n.next(r))}catch(c){s(c)}},l=r=>{try{o(n.throw(r))}catch(c){s(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,l);o((n=n.apply(e,t)).next())});const Uo=(e,t)=>{Re(e,"iconDefaultScript").then(()=>{if(!["ant","material"].includes(t.icon)){const n=document.getElementById("iconScript");n&&n.remove(),Re(`/appearance/icons/${t.icon}/icon.js?v=${t.iconVer}`,"iconScript")}})},Yo=e=>{var t;const n=document.getElementsByTagName("html")[0];n.setAttribute("lang",window.siyuan.config.appearance.lang),n.setAttribute("data-theme-mode",vu()),n.setAttribute("data-light-theme",window.siyuan.config.appearance.themeLight),n.setAttribute("data-dark-theme",window.siyuan.config.appearance.themeDark);const a=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light";window.siyuan.config.appearance.modeOS&&(window.siyuan.config.appearance.mode===1&&a==="light"||window.siyuan.config.appearance.mode===0&&a==="dark")&&(A("/api/system/setAppearanceMode",{mode:a==="light"?0:1}),window.siyuan.config.appearance.mode=a==="light"?0:1);const s=document.getElementById("themeDefaultStyle"),i=`/appearance/themes/${e.mode===1?"midnight":"daylight"}/theme.css?v=${f.SIYUAN_VERSION}`;s?s.getAttribute("href").startsWith(i)||s.setAttribute("href",i):bi(i,"themeDefaultStyle");const l=document.getElementById("themeStyle");if(e.mode===1&&e.themeDark!=="midnight"||e.mode===0&&e.themeLight!=="daylight"){const u=`/appearance/themes/${e.mode===1?e.themeDark:e.themeLight}/theme.css?v=${e.themeVer}`;l?l.getAttribute("href").startsWith(u)||l.setAttribute("href",u):bi(u,"themeStyle")}else l&&l.remove();!((t=window.webkit)!=null&&t.messageHandlers)&&!window.JSAndroid&&!window.JSHarmony&&"serviceWorker"in window.navigator&&"caches"in window&&"fetch"in window&&navigator.serviceWorker&&document.head.insertAdjacentHTML("afterbegin",`<meta name="theme-color" content="${getComputedStyle(document.body).getPropertyValue("--b3-toolbar-background").trim()}">`),Fo();const o=document.getElementById("themeScript"),r=`/appearance/themes/${e.mode===1?e.themeDark:e.themeLight}/theme.js?v=${e.themeVer}`;o?o.getAttribute("src").startsWith(r)||(o.remove(),Re(r,"themeScript")):Re(r,"themeScript");const c=document.getElementById("iconDefaultScript"),d=`/appearance/icons/${["ant","material"].includes(e.icon)?e.icon:"material"}/icon.js?v=${f.SIYUAN_VERSION}`;if(c){if(!c.getAttribute("src").startsWith(d)){c.remove();let u=document.body.firstElementChild;for(;u.tagName==="svg";){const p=u;u=u.nextElementSibling,p.getAttribute("data-name")||p.remove()}Uo(d,e)}}else Uo(d,e)},wu=()=>{const e=document.getElementById("loading");e&&setTimeout(()=>{e.remove()},160),Wo(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",t=>{const n=t.matches?"dark":"light";Wo(n),window.siyuan.config.appearance.modeOS&&(window.siyuan.config.appearance.mode===0&&n==="light"||window.siyuan.config.appearance.mode===1&&n==="dark"||A("/api/system/setAppearanceMode",{mode:n==="light"?0:1},a=>Bo(void 0,null,function*(){if(window.siyuan.config.appearance.themeJS)if(window.destroyTheme)try{yield window.destroyTheme(),window.destroyTheme=void 0,document.getElementById("themeScript").remove()}catch(s){console.error("destroyTheme error: "+s)}else{window.location.reload();return}window.siyuan.config.appearance=a.data.appearance,Yo(a.data.appearance)})))})},hu=()=>{if(!window.siyuan.config.system.disableGoogleAnalytics){Re("https://www.googletagmanager.com/gtag/js?id=G-L7WEXVQCR9","gaScript"),window.dataLayer=window.dataLayer||[];const e=function(...n){window.dataLayer.push(arguments)};e("js",new Date),e("config","G-L7WEXVQCR9",{send_page_view:!1});const t={version:f.SIYUAN_VERSION,container:window.siyuan.config.system.container,os:window.siyuan.config.system.os,osPlatform:window.siyuan.config.system.osPlatform,isLoggedIn:!1,subscriptionStatus:-1,subscriptionPlan:-1,subscriptionType:-1,oneTimePayStatus:-1,syncEnabled:!1,syncProvider:-1,cTreeCount:window.siyuan.config.stat.cTreeCount,cBlockCount:window.siyuan.config.stat.cBlockCount,cDataSize:window.siyuan.config.stat.cDataSize,cAssetsSize:window.siyuan.config.stat.cAssetsSize};window.siyuan.user&&(t.isLoggedIn=!0,t.subscriptionStatus=window.siyuan.user.userSiYuanSubscriptionStatus,t.subscriptionPlan=window.siyuan.user.userSiYuanSubscriptionPlan,t.subscriptionType=window.siyuan.user.userSiYuanSubscriptionType,t.oneTimePayStatus=window.siyuan.user.userSiYuanOneTimePayStatus),window.siyuan.config.sync&&(t.syncEnabled=window.siyuan.config.sync.enabled,t.syncProvider=window.siyuan.config.sync.provider),e("event",f.ANALYTICS_EVT_ON_GET_CONFIG,t)}},is=(e=!0)=>Bo(void 0,null,function*(){const t=Math.floor(window.siyuan.config.editor.fontSize*1.625);let n;Lt()||gi()||Dn()?n=`@font-face {
  font-family: "Emojis Additional";
  src: url(../../../appearance/fonts/Noto-COLRv1-2.047/Noto-COLRv1.woff2) format("woff2");
  unicode-range: U+1fae9, U+1fac6, U+1fabe, U+1fadc, U+e50a, U+1fa89, U+1fadf, U+1f1e6-1f1ff, U+1fa8f;
}
@font-face {
  font-family: "Emojis Reset";
  src: local("Apple Color Emoji"),
  local("Segoe UI Emoji"),
  local("Segoe UI Symbol");
  unicode-range: U+21a9, U+21aa, U+2122, U+2194-2199, U+23cf, U+25b6, U+25c0, U+25fb, U+25fc, U+25aa, U+25ab, U+2600-2603,
  U+260e, U+2611, U+261d, U+2639, U+263a, U+2640, U+2642, U+2660, U+2663, U+2665, U+2666, U+2668, U+267b, U+26aa, U+26ab, 
  U+2702, U+2708, U+2934, U+2935, U+1f170, U+1f171, U+1f17e, U+1f17f, U+1f202, U+1f21a, U+1f22f, U+1f232-1f23a, U+1f250, 
  U+1f251, U+1fae4, U+2049, U+203c, U+3030, U+303d, U+24c2, U+26a0, U+26a1, U+26be, U+27a1, U+2b05-2b07, U+3297, U+3299, U+a9, U+ae;
  size-adjust: 115%;
}
@font-face {
  font-family: "Emojis";
  src: local("Apple Color Emoji"),
  local("Segoe UI Emoji"),
  local("Segoe UI Symbol");
  size-adjust: 115%;
}`:(yield Do())?n=`@font-face {
  font-family: "Emojis Additional";
  src: url(../../../appearance/fonts/Noto-COLRv1-2.047/Noto-COLRv1.woff2) format("woff2");
  unicode-range: U+1fae9, U+1fac6, U+1fabe, U+1fadc, U+e50a, U+1fa89, U+1fadf, U+1f1e6-1f1ff, U+1f3f4, U+e0067, U+e0062,
  U+e0065, U+e006e, U+e007f, U+e0073, U+e0063, U+e0074, U+e0077, U+e006c;
  size-adjust: 85%;
}
@font-face {
  font-family: "Emojis Reset";
  src: local("Segoe UI Emoji"),
  local("Segoe UI Symbol");
  unicode-range: U+263a, U+21a9, U+2642, U+303d, U+2197, U+2198, U+2199, U+2196, U+2195, U+2194, U+2660, U+2665, U+2666, 
  U+2663, U+3030, U+21aa, U+25b6, U+25c0, U+2640, U+203c, U+a9, U+ae, U+2122;
  size-adjust: 85%;
}
@font-face {
  font-family: "Emojis";
  src: local("Segoe UI Emoji"),
  local("Segoe UI Symbol");
  size-adjust: 85%;
}`:n=`@font-face {
  font-family: "Emojis Reset";
  src: url(../../../appearance/fonts/Noto-COLRv1-2.047/Noto-COLRv1.woff2) format("woff2");
  unicode-range: U+1f170-1f171, U+1f17e, U+1f17f, U+1f21a, U+1f22f, U+1f232-1f23a, U+1f250, U+1f251, U+1f32b, U+1f3bc,
  U+1f411, U+1f42d, U+1f42e, U+1f431, U+1f435, U+1f441, U+1f4a8, U+1f4ab, U+1f525, U+1f600-1f60d, U+1f60f-1f623,
  U+1f625-1f62b, U+1f62d-1f63f, U+1F643, U+1F640, U+1f79, U+1f8f, U+1fa79, U+1fae4, U+1fae9, U+1fac6, U+1fabe, U+1fadf,
  U+200d, U+203c, U+2049, U+2122, U+2139, U+2194-2199, U+21a9, U+21aa, U+23cf, U+25aa, U+25ab, U+25b6, U+25c0, U+25fb-25fe,
  U+2611, U+2615, U+2618, U+261d, U+2620, U+2622, U+2623, U+2626, U+262a, U+262e, U+2638-263a, U+2640, U+2642, U+2648-2653,
  U+265f, U+2660, U+2663, U+2665, U+2666, U+267b, U+267e, U+267f, U+2692-2697, U+2699, U+269b, U+269c, U+26a0, U+26a1,
  U+26a7, U+26aa, U+26ab, U+26b0, U+26b1, U+2702, U+2708, U+2709, U+270c, U+270d, U+2712, U+2714, U+2716, U+271d, U+2733,
  U+2734, U+2744, U+2747, U+2763, U+2764, U+2934-2935, U+3030, U+303d, U+3297, U+3299, U+fe0f, U+e50a, U+a9, U+ae;
  size-adjust: 92%;
}
@font-face {
  font-family: "Emojis";
  src: url(../../../appearance/fonts/Noto-COLRv1-2.047/Noto-COLRv1.woff2) format("woff2"),
  local("Segoe UI Emoji"),
  local("Segoe UI Symbol"),
  local("Apple Color Emoji"),
  local("Twemoji Mozilla"),
  local("Noto Color Emoji"),
  local("Android Emoji"),
  local("EmojiSymbols");
  size-adjust: 92%;
}`;let a="";if(window.siyuan.config.editor.rtl&&(a=`.protyle-title__input,
.protyle-wysiwyg .p,
.protyle-wysiwyg .code-block .hljs,
.protyle-wysiwyg .table,
.protyle-wysiwyg .render-node protyle-html,
.protyle-wysiwyg .render-node > div[spin="1"],
.protyle-wysiwyg [data-type="NodeHeading"] {direction: rtl}
.protyle-wysiwyg [data-node-id].li > .protyle-action {
    right: 0;
    left: auto;
    direction: rtl;
}
.protyle-wysiwyg [data-node-id].li > [data-node-id] {
    margin-right: 34px;
    margin-left: 0;
}
.protyle-wysiwyg [data-node-id].li::before {
    right: 17px;
    left: auto;
}`),n+=`
:root{--b3-font-size-editor:${window.siyuan.config.editor.fontSize}px}
.b3-typography code:not(.hljs), .protyle-wysiwyg span[data-type~=code] { font-variant-ligatures: ${window.siyuan.config.editor.codeLigatures?"normal":"none"} }
.li > .protyle-action {height:${t+8}px;line-height: ${t+8}px}
/* \u5217\u8868\u9879\u540E\u7684\u5185\u5BB9\u548C\u5217\u8868\u9879\u5BF9\u9F50 https://github.com/siyuan-note/siyuan/issues/2803 */
.protyle-wysiwyg [data-node-id].li > .protyle-action ~ div {line-height:${t}px}
.protyle-wysiwyg [data-node-id].li > .protyle-action ~ div > [spellcheck] {min-height:${t}px}
.protyle-wysiwyg [data-node-id].li::before {height: calc(100% - ${t+12}px);top:${t+12}px}
${a}
.protyle-wysiwyg [data-node-id] {${window.siyuan.config.editor.justify?" text-align: justify;":""}}
.protyle-wysiwyg .li {min-height:${t+8}px}
.protyle-gutters button svg {height:${t}px}`,window.siyuan.config.editor.fontFamily&&(n+=`
.b3-typography:not(.b3-typography--default), .protyle-wysiwyg, .protyle-title {font-family: "Emojis Additional", "Emojis Reset", "${window.siyuan.config.editor.fontFamily}", var(--b3-font-family)}`),"ontouchend"in document&&(n+=`
.b3-menu .b3-menu__action {opacity: 0.68;}`),e){const s=document.getElementById("siyuanStyle");s?s.innerHTML=n:document.querySelector("#pluginsStyle").insertAdjacentHTML("beforebegin",`<style id="siyuanStyle">${n}</style>`)}return n}),Fo=(e=f.PROTYLE_CDN)=>{const t=document.getElementById("protyleHljsStyle");let n;window.siyuan.config.appearance.mode===0?(n=window.siyuan.config.appearance.codeBlockThemeLight,f.SIYUAN_CONFIG_APPEARANCE_LIGHT_CODE.includes(n)||(n="default")):(n=window.siyuan.config.appearance.codeBlockThemeDark,f.SIYUAN_CONFIG_APPEARANCE_DARK_CODE.includes(n)||(n="github-dark"));const a=`${e}/js/highlight.js/styles/${n}.min.css?v=11.11.1`;t?t.href.includes(a)||(t.remove(),bi(a,"protyleHljsStyle")):bi(a,"protyleHljsStyle")},gm=e=>{},_u=e=>{if(e.startsWith("#"))return e;let t;const n=e.replace(/\s/g,"").match(/^rgba?\((\d+),(\d+),(\d+),?([^,\s)]+)?/i),a=(n&&n[4]||"").trim();let s=n?(n[1]|1<<8).toString(16).slice(1)+(n[2]|1<<8).toString(16).slice(1)+(n[3]|1<<8).toString(16).slice(1):e;return a!==""?t=a:t=1,t=(t*255|1<<8).toString(16).slice(1),s=s+t,s},Wo=e=>{(Qt()||ft()||yt())&&setTimeout(()=>{const t=_u(getComputedStyle(document.body).getPropertyValue("--b3-theme-background").trim());let n=window.siyuan.config.appearance.mode;window.siyuan.config.appearance.modeOS&&(e==="dark"?n=1:n=0),Qt()?window.webkit.messageHandlers.changeStatusBar.postMessage((t||(n===0?"#fff":"#1e1e1e"))+" "+n):ft()?window.JSAndroid.changeStatusBarColor(t,n):yt()&&window.JSHarmony.changeStatusBarColor(t,n)},500)},vu=()=>{const e=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light";return window.siyuan.config.appearance.modeOS?e:window.siyuan.config.appearance.mode===0?"light":"dark"},Pe=(e,t=f.PROTYLE_CDN)=>{let n,a=!1;e.classList.contains("code-block")?n=e.querySelectorAll(".hljs"):e.classList.contains("item__readme")?(n=e.querySelectorAll("pre code"),n.forEach(s=>{s.parentElement.setAttribute("linenumber","false")})):e.classList.contains("b3-typography")?(n=e.querySelectorAll(".code-block code"),a=!0):n=e.querySelectorAll(".code-block .hljs"),n.length!==0&&(Fo(t),Re(`${t}/js/highlight.js/highlight.min.js?v=11.11.1`,"protyleHljsScript").then(()=>{Re(`${t}/js/highlight.js/third-languages.js?v=1.0.1`,"protyleHljsThirdScript").then(()=>{n.forEach(s=>{const i=s.parentElement.querySelectorAll(".protyle-icon");if(i.length===2&&(i[0].setAttribute("aria-label",window.siyuan.languages.copy),i[1].setAttribute("aria-label",window.siyuan.languages.more)),s.getAttribute("data-render")==="true")return;const l=s.querySelector("wbr");let o=0;if(l){let m=l.previousSibling;for(;m;){for(o+=m.textContent.length;!m.previousSibling&&m.parentElement.tagName!=="DIV";)m=m.parentElement;m=m.previousSibling}l.remove()}let r;a?r=s.parentElement.getAttribute("data-language"):s.previousElementSibling?r=s.previousElementSibling.firstElementChild.textContent:r=s.className.replace("language-",""),window.hljs.getLanguage(r)||(r="plaintext"),s.classList.add("hljs"),s.setAttribute("data-render","true");const c=s.parentElement.getAttribute("linewrap"),d=s.parentElement.getAttribute("ligatures"),u=s.parentElement.getAttribute("linenumber"),p=s.lastElementChild?s.lastElementChild:s;c==="true"||c!=="false"&&window.siyuan.config.editor.codeLineWrap?(p.style.setProperty("white-space","pre-wrap"),p.style.setProperty("word-break","break-word")):(p.style.setProperty("white-space","pre"),p.style.setProperty("word-break","initial")),d==="true"||d!=="false"&&window.siyuan.config.editor.codeLigatures?p.style.fontVariantLigatures="normal":p.style.fontVariantLigatures="none";const g=p.textContent;s.firstElementChild&&(!a&&(u==="true"||u!=="false"&&window.siyuan.config.editor.codeSyntaxHighlightLineNum)?(s.firstElementChild.className="protyle-linenumber__rows",s.firstElementChild.setAttribute("contenteditable","false"),Oa(s),s.style.display=""):(s.firstElementChild.className="fn__none",s.firstElementChild.innerHTML="",p.style.paddingLeft="",s.style.display="block")),p.innerHTML=window.hljs.highlight(g+(g.endsWith(`
`)?"":`
`),{language:r,ignoreIllegals:!0}).value,l&&getSelection().rangeCount>0&&Zi(s,o,o)})})}))},Oa=e=>{const t=e.parentElement.getAttribute("lineNumber");if(t==="false"||!window.siyuan.config.editor.codeSyntaxHighlightLineNum&&t!=="true")return;e.parentElement.style.lineHeight=`${((parseInt(e.parentElement.style.fontSize)||window.siyuan.config.editor.fontSize)*1.625*.85).toFixed(0)}px`;const n=e.lastElementChild;let a="";const s=n.textContent.split(/\r\n|\r|\n|\u2028|\u2029/g);s[s.length-1]===""&&s.length>1&&s.pop(),e.firstElementChild.innerHTML=`<span>${s.length}</span>`,n.style.paddingLeft=`${e.firstElementChild.clientWidth+16}px`;const i=document.createElement("div");i.className="hljs",i.setAttribute("style",`padding-left:${n.style.paddingLeft};
width: ${n.getBoundingClientRect().width}px;
white-space:${n.style.whiteSpace};
word-break:${n.style.wordBreak};
font-variant-ligatures:${n.style.fontVariantLigatures};
padding-right:0;max-height: none;box-sizing: border-box;position: absolute;padding-top:0 !important;padding-bottom:0 !important;min-height:auto !important;`),i.setAttribute("contenteditable","true"),e.insertAdjacentElement("afterend",i);const l=n.style.wordBreak==="break-word";if(s.map(o=>{let r="";l&&(i.textContent=o.trim()?o:"<br>",r=` style="height:${i.clientHeight}px;"`),a+=`<span${r}></span>`}),i.remove(),e.firstElementChild.innerHTML=a,e.scrollHeight>e.clientHeight&&getSelection().rangeCount>0){const o=getSelection().getRangeAt(0);if(e.contains(o.startContainer)){const r=document.createElement("br");o.insertNode(r),r.scrollIntoView({block:"nearest"}),r.remove()}}},Gn=e=>{let t=!0;if(e){const n=e.getAttribute("data-readonly");if(typeof n=="string")t=n==="false";else return'<div class="protyle-icons"></div>'}return`<div class="protyle-icons">
    <span aria-label="${window.siyuan.languages.edit}" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-icon--first protyle-action__edit${t?"":" fn__none"}"><svg><use xlink:href="#iconEdit"></use></svg></span>
    <span aria-label="${window.siyuan.languages.more}" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-action__menu protyle-icon--last${t?"":" protyle-icon--first"}"><svg><use xlink:href="#iconMore"></use></svg></span>
</div>`},Hn=e=>{if(e.getAttribute("data-type")==="NodeHTMLBlock"){const t=e.querySelector("protyle-html");t.setAttribute("data-content",Lute.UnEscapeHTMLStr(t.getAttribute("data-content")))}return e},jo="%%params",ku=e=>{let t={responsive:"resize"};const n=e.substring(0,e.indexOf(`
`));if(n.startsWith(jo))try{t=wn(n.substring(jo.length))}catch(a){console.error(`Failed to parse ABCJS params: ${a}`)}return t},Vo=(e,t=f.PROTYLE_CDN)=>{let n=[];e.getAttribute("data-subtype")==="abc"?n=[e]:n=Array.from(e.querySelectorAll('[data-subtype="abc"]')),n.length!==0&&n.length>0&&Re(`${t}/js/abcjs/abcjs-basic-min.js?v=6.2.2`,"protyleAbcjsScript").then(()=>{const a=$(e,"protyle-wysiwyg",!0);n.forEach(s=>{if(s.getAttribute("data-render")==="true")return;s.firstElementChild.classList.contains("protyle-icons")||s.insertAdjacentHTML("afterbegin",Gn(a));const i=s.firstElementChild.nextElementSibling;i.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${f.ZWSP}</span><div contenteditable="false"></div>`;const l=Lute.UnEscapeHTMLStr(s.getAttribute("data-content"));window.ABCJS.renderAbc(i.lastElementChild,l,ku(l)),s.setAttribute("data-render","true")})})};var Eu=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{o(n.next(r))}catch(c){s(c)}},l=r=>{try{o(n.throw(r))}catch(c){s(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,l);o((n=n.apply(e,t)).next())});const zo=(e,t=f.PROTYLE_CDN)=>{let n=[];e.getAttribute("data-subtype")==="echarts"?n=[e]:n=Array.from(e.querySelectorAll('[data-subtype="echarts"]')),n.length!==0&&n.length>0&&Re(`${t}/js/echarts/echarts.min.js?v=5.3.2`,"protyleEchartsScript").then(()=>{Re(`${t}/js/echarts/echarts-gl.min.js?v=2.0.9`,"protyleEchartsGLScript").then(()=>{const a=$(e,"protyle-wysiwyg",!0);let s;a&&a.clientWidth>0&&n[0].firstElementChild.clientWidth===0&&a.firstElementChild&&(s=a.firstElementChild.clientWidth),n.forEach(i=>Eu(void 0,null,function*(){if(i.getAttribute("data-render")==="true")return;i.firstElementChild.classList.contains("protyle-icons")||i.insertAdjacentHTML("afterbegin",Gn(a));const l=i.firstElementChild.nextElementSibling;try{l.style.height=i.style.height;const o=yield wn(Lute.UnEscapeHTMLStr(i.getAttribute("data-content")));window.echarts.init(l,window.siyuan.config.appearance.mode===1?"dark":void 0,{width:s}).setOption(o),i.setAttribute("data-render","true"),l.classList.remove("ft__error"),l.textContent.endsWith(f.ZWSP)||l.firstElementChild.insertAdjacentText("beforeend",f.ZWSP)}catch(o){window.echarts.dispose(l),l.classList.add("ft__error"),l.innerHTML=`echarts render error: <br>${o}`}}))})})},Go=(e,t=f.PROTYLE_CDN)=>{let n=[];e.getAttribute("data-subtype")==="graphviz"?n=[e]:n=Array.from(e.querySelectorAll('[data-subtype="graphviz"]')),n.length!==0&&Re(`${t}/js/graphviz/viz.js?v=3.11.0`,"protyleGraphVizScript").then(()=>{const a=$(e,"protyle-wysiwyg",!0);n.forEach(s=>{if(s.getAttribute("data-render")==="true")return;s.firstElementChild.classList.contains("protyle-icons")||s.insertAdjacentHTML("afterbegin",Gn(a));const i=s.firstElementChild.nextElementSibling;try{Viz.instance().then(l=>{const o=l.renderSVGElement(Lute.UnEscapeHTMLStr(s.getAttribute("data-content")));i.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${f.ZWSP}</span><div contenteditable="false">${o.outerHTML}</div>`}).catch(l=>{i.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${f.ZWSP}</span><div class="ft__error" contenteditable="false">graphviz render error: <br>${l}</div>`})}catch(l){console.error("Graphviz error",l)}s.setAttribute("data-render","true")})})},_n=(e,t=f.PROTYLE_CDN,n=!1)=>{let a=[];e.getAttribute("data-subtype")==="math"?a=[e]:a=Array.from(e.querySelectorAll('[data-subtype="math"]')),a.length!==0&&(bi(`${t}/js/katex/katex.min.css?v=0.16.9`,"protyleKatexStyle"),Re(`${t}/js/katex/katex.min.js?v=0.16.9`,"protyleKatexScript").then(()=>{Re(`${t}/js/katex/mhchem.min.js?v=0.16.9`,"protyleKatexMhchemScript").then(()=>{a.forEach(s=>{var i,l;if(s.getAttribute("data-render")==="true")return;s.setAttribute("data-render","true");let o=s;s.tagName==="DIV"&&(o=s.firstElementChild);let r={};try{r=wn(window.siyuan.config.editor.katexMacros||"{}")}catch(c){console.warn("KaTex macros is not JSON",c)}try{o.innerHTML=window.katex.renderToString(Lute.UnEscapeHTMLStr(s.getAttribute("data-content")),{displayMode:s.tagName==="DIV",output:"html",macros:r,trust:!0,strict:d=>d==="unicodeTextInMathMode"?"ignore":"warn"}),o.classList.remove("ft__error");const c=B(s);if(s.tagName==="DIV"){o.firstElementChild.setAttribute("contenteditable","false"),o.childElementCount<2&&o.insertAdjacentHTML("beforeend",`<span style="position: absolute;right: 0;top: 0;">${f.ZWSP}</span>`);const d=o.querySelectorAll(".base");d.length>0&&d[d.length-1].insertAdjacentHTML("afterend","<span class='fn__flex-1'></span>");const u=o.querySelector(".katex-html > .newline");u&&(u.parentElement.style.display="block")}else{c&&s.getBoundingClientRect().width>c.clientWidth?(s.style.maxWidth="100%",s.style.overflowX="auto",s.style.overflowY="hidden",s.style.display="inline-block"):(s.style.maxWidth="",s.style.overflowX="",s.style.overflowY="",s.style.display="");const d=Fe(s);d?d&&d.nodeType!==3&&(((i=d.getAttribute("data-type"))==null?void 0:i.indexOf("inline-math"))>-1||d.classList.contains("img"))?s.after(document.createTextNode(f.ZWSP)):d&&!d.textContent.startsWith(`
`)&&d.textContent!==f.ZWSP&&s.insertAdjacentHTML("beforeend","&#xFEFF;"):s.parentElement.tagName!=="TH"&&s.parentElement.tagName!=="TD"?s.insertAdjacentText("afterend",`
`):s.insertAdjacentText("afterend",f.ZWSP),(l=s.previousSibling)!=null&&l.textContent.endsWith(`
`)?s.insertAdjacentText("beforebegin",f.ZWSP):!ut(s)&&["TH","TD"].includes(s.parentElement.tagName)&&s.insertAdjacentText("afterbegin",f.ZWSP)}n&&setTimeout(()=>{if(s.tagName==="DIV"){const d=s.querySelector(".katex-display");d.clientWidth<d.scrollWidth&&d.firstElementChild.setAttribute("style",`font-size:${d.clientWidth*100/d.scrollWidth}%`)}else c&&s.offsetWidth>c.clientWidth&&s.firstElementChild.setAttribute("style",`font-size:${c.clientWidth*100/s.offsetWidth}%`)})}catch(c){o.innerHTML=c.message,o.classList.add("ft__error")}})})}))};var Lu=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{o(n.next(r))}catch(c){s(c)}},l=r=>{try{o(n.throw(r))}catch(c){s(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,l);o((n=n.apply(e,t)).next())});const Ko=(e,t=f.PROTYLE_CDN)=>{let n=[];e.getAttribute("data-subtype")==="mermaid"?n=[e]:n=Array.from(e.querySelectorAll('[data-subtype="mermaid"]')),n.length!==0&&Re(`${t}/js/mermaid/mermaid.min.js?v=11.4.0`,"protyleMermaidScript").then(()=>{const a={securityLevel:"loose",altFontFamily:"sans-serif",fontFamily:"sans-serif",startOnLoad:!1,flowchart:{htmlLabels:!0,useMaxWidth:!0},sequence:{useMaxWidth:!0,diagramMarginX:8,diagramMarginY:8,boxMargin:8,showSequenceNumbers:!0},gantt:{leftPadding:75,rightPadding:20}};if(window.siyuan.config.appearance.mode===1&&(a.theme="dark"),window.mermaid.initialize(a),n[0].firstElementChild.clientWidth===0){const s=new MutationObserver(()=>{Zo(n),s.disconnect()}),i=D(n[0],"fold","1");if(i)s.observe(i,{attributeFilter:["fold"]});else{const l=$(n[0],"card__block",!0);l&&s.observe(l,{attributeFilter:["class"]})}}else Zo(n)})},Zo=e=>{const t=$(e[0],"protyle-wysiwyg",!0);e.forEach(n=>Lu(void 0,null,function*(){if(n.getAttribute("data-render")==="true")return;n.firstElementChild.classList.contains("protyle-icons")||n.insertAdjacentHTML("afterbegin",Gn(t));const a=n.firstElementChild.nextElementSibling,s="mermaid"+Lute.NewNodeID();a.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${f.ZWSP}</span><div contenteditable="false"><span id="${s}"></span></div>`;try{const i=yield window.mermaid.render(s,Lute.UnEscapeHTMLStr(n.getAttribute("data-content")));a.lastElementChild.innerHTML=i.svg}catch(i){const l=document.querySelector("#"+s);a.lastElementChild.innerHTML=`${l.outerHTML}<div class="fn__hr"></div><div class="ft__error">${i.message.replace(/\n/,"<br>")}</div>`,l.parentElement.remove()}n.setAttribute("data-render","true")}))},Xo=(e,t=f.PROTYLE_CDN)=>{let n=[];e.getAttribute("data-subtype")==="mindmap"?n=[e]:n=Array.from(e.querySelectorAll('[data-subtype="mindmap"]')),n.length!==0&&Re(`${t}/js/echarts/echarts.min.js?v=0.0.0`,"protyleEchartsScript").then(()=>{const a=$(e,"protyle-wysiwyg",!0);let s;a&&a.clientWidth>0&&n[0].firstElementChild.clientWidth===0&&a.firstElementChild&&(s=a.firstElementChild.clientWidth),n.forEach(i=>{if(i.getAttribute("data-render")==="true")return;i.firstElementChild.classList.contains("protyle-icons")||i.insertAdjacentHTML("afterbegin",Gn(a));const l=i.firstElementChild.nextElementSibling;try{l.style.height=i.style.height,window.echarts.init(l,window.siyuan.config.appearance.mode===1?"dark":void 0,{width:s}).setOption({series:[{data:[JSON.parse(Lute.EChartsMindmapStr(Lute.UnEscapeHTMLStr(i.getAttribute("data-content"))))],initialTreeDepth:-1,itemStyle:{borderWidth:0,color:"#4285f4"},label:{backgroundColor:"#f6f8fa",borderColor:"#d1d5da",borderRadius:6,borderWidth:.5,color:"#586069",lineHeight:20,offset:[-5,0],padding:[0,5],position:"insideRight"},lineStyle:{color:"#d1d5da",width:1},roam:!0,symbol:(o,r)=>{var c;return(c=r==null?void 0:r.data)!=null&&c.children?"circle":"path://"},type:"tree"}],tooltip:{trigger:"item",triggerOn:"mousemove"},backgroundColor:"transparent"}),i.setAttribute("data-render","true"),l.textContent.endsWith(f.ZWSP)||l.firstElementChild.insertAdjacentText("beforeend",f.ZWSP),l.classList.remove("ft__error")}catch(o){l.classList.add("ft__error"),l.innerHTML=`Mindmap render error: <br>${o}`}})})},Jo=(e,t=f.PROTYLE_CDN)=>{let n=[];e.getAttribute("data-subtype")==="flowchart"?n=[e]:n=Array.from(e.querySelectorAll('[data-subtype="flowchart"]')),n.length!==0&&Re(`${t}/js/flowchart.js/flowchart.min.js?v=1.18.0`,"protyleFlowchartScript").then(()=>{if(n[0].firstElementChild.clientWidth===0){const a=new MutationObserver(()=>{Qo(n),a.disconnect()}),s=D(n[0],"fold","1");if(s)a.observe(s,{attributeFilter:["fold"]});else{const i=$(n[0],"card__block",!0);i&&a.observe(i,{attributeFilter:["class"]})}}else Qo(n)})},Qo=e=>{const t=$(e[0],"protyle-wysiwyg",!0);e.forEach(n=>{if(n.getAttribute("data-render")==="true")return;n.firstElementChild.classList.contains("protyle-icons")||n.insertAdjacentHTML("afterbegin",Gn(t));const a=n.firstElementChild.nextElementSibling;a.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${f.ZWSP}</span><div class="ft__error" contenteditable="false"></div>`;try{flowchart.parse(Lute.UnEscapeHTMLStr(n.getAttribute("data-content"))).drawSVG(a.lastElementChild)}catch(s){a.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${f.ZWSP}</span><div class="ft__error" contenteditable="false">Flow Chart render error: <br>${s}</div>`}n.setAttribute("data-render","true")})},er=(e,t=f.PROTYLE_CDN)=>{let n=[];e.getAttribute("data-subtype")==="plantuml"?n=[e]:n=Array.from(e.querySelectorAll('[data-subtype="plantuml"]')),n.length!==0&&Re(`${t}/js/plantuml/plantuml-encoder.min.js?v=0.0.0`,"protylePlantumlScript").then(()=>{const a=$(e,"protyle-wysiwyg",!0);n.forEach(s=>{if(s.getAttribute("data-render")==="true")return;s.firstElementChild.classList.contains("protyle-icons")||s.insertAdjacentHTML("afterbegin",Gn(a));const i=s.firstElementChild.nextElementSibling;try{i.innerHTML=`<object type="image/svg+xml" data="${window.siyuan.config.editor.plantUMLServePath}${window.plantumlEncoder.encode(Lute.UnEscapeHTMLStr(s.getAttribute("data-content")))}"/>`,i.classList.remove("ft__error"),s.setAttribute("data-render","true")}catch(l){i.classList.add("ft__error"),i.innerHTML=`plantuml render error: <br>${l}`}})})},tr=e=>{let t=[];e.getAttribute("data-type")==="NodeHTMLBlock"?t=[e]:t=Array.from(e.querySelectorAll('[data-type="NodeHTMLBlock"]')),t.length!==0&&t.length>0&&t.forEach(n=>{n.firstElementChild.firstElementChild.setAttribute("aria-label",window.siyuan.languages.edit),n.firstElementChild.lastElementChild.setAttribute("aria-label",window.siyuan.languages.more)})},Su=(e,t)=>{const n=document.createElement("div");n.innerHTML=e;let a=!1;if((n.childElementCount===1&&n.lastElementChild.style.fontFamily.indexOf("monospace")>-1||n.childElementCount===1&&n.querySelectorAll("pre").length===1||e.indexOf(`
<p class="p1">`)===0||n.childElementCount===1&&n.firstElementChild.tagName==="TABLE"&&n.querySelector(".line-number")&&n.querySelector(".line-content"))&&(a=!0),a){let s=t||e;return/\n/.test(s)?`<div data-type="NodeCodeBlock" class="code-block" data-node-id="${Lute.NewNodeID()}"><div class="protyle-action"><span class="protyle-action--first protyle-action__language" contenteditable="false">${window.siyuan.storage[f.LOCAL_CODELANG]}</span><span class="fn__flex-1"></span><span aria-label="${window.siyuan.languages.copy}" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-icon--first protyle-action__copy"><svg><use xlink:href="#iconCopy"></use></svg></span><span aria-label="${window.siyuan.languages.more}" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-icon--last protyle-action__menu"><svg><use xlink:href="#iconMore"></use></svg></span></div><div contenteditable="true" spellcheck="${window.siyuan.config.editor.spellcheck}">${s.replace(/&/g,"&amp;").replace(/</g,"&lt;")}<wbr></div><div class="protyle-attr" contenteditable="false">${f.ZWSP}</div></div>`:(s=s.replace("<","&lt;").replace(">","&gt;"),"`"+s+"`")}return!1},Ze=e=>{const t=e.getAttribute("data-subtype");if(!f.SIYUAN_RENDER_CODE_LANGUAGES.includes(t)||e.getAttribute("data-type")!=="NodeHTMLBlock"){Vo(e),tr(e),er(e),Ko(e),Jo(e),zo(e),Xo(e),Go(e),_n(e);return}t==="abc"?Vo(e):t==="plantuml"?er(e):t==="mermaid"?Ko(e):t==="flowchart"?Jo(e):t==="echarts"?zo(e):t==="mindmap"?Xo(e):t==="graphviz"?Go(e):t==="math"?_n(e):e.getAttribute("data-type")==="NodeHTMLBlock"&&tr(e)},dn=(e,t)=>{let n="";switch(e){case"NodeDocument":n="iconFile";break;case"NodeThematicBreak":n="iconLine";break;case"NodeParagraph":n="iconParagraph";break;case"NodeHeading":t?n="icon"+t.toUpperCase():n="iconHeadings";break;case"NodeBlockquote":n="iconQuote";break;case"NodeList":t==="t"?n="iconCheck":t==="o"?n="iconOrderedList":n="iconList";break;case"NodeListItem":n="iconListItem";break;case"NodeCodeBlock":case"NodeYamlFrontMatter":n="iconCode";break;case"NodeTable":n="iconTable";break;case"NodeBlockQueryEmbed":n="iconSQL";break;case"NodeSuperBlock":n="iconSuper";break;case"NodeMathBlock":n="iconMath";break;case"NodeHTMLBlock":n="iconHTML5";break;case"NodeWidget":n="iconBoth";break;case"NodeIFrame":n="iconLanguage";break;case"NodeVideo":n="iconVideo";break;case"NodeAudio":n="iconRecord";break;case"NodeAttributeView":n="iconDatabase";break}return n},ss=e=>{e.classList.add("protyle-wysiwyg--hl"),setTimeout(function(){e.classList.remove("protyle-wysiwyg--hl")},1024)},pm=(e,t,n=!1)=>{let a;const s=e.wysiwyg.element;if(!e.preview.element.classList.contains("fn__none")){a=document.getElementById(t),a&&(e.preview.element.scrollTop=a.offsetTop,ss(a));return}if(Array.from(s.querySelectorAll(`[data-node-id="${t}"]`)).find(i=>{if(!hasClosestByAttribute(i,"data-type","block-render",!0))return a=i,!0}),a)return He(e,a,n),ss(a),a;if(t===e.block.rootID&&e.options.render.title&&e.title.editElement)return ss(e.title.editElement),e.title.editElement},He=(e,t,n=!1,a="auto")=>{var s,i,l,o;if(!e.disabled&&!n&&getSelection().rangeCount>0){const p=getSelection().getRangeAt(0),g=B(p.startContainer);if(g){if(g.classList.contains("code-block")){const v=document.createElement("br");p.insertNode(v),v.scrollIntoView({block:"nearest",behavior:a}),v.remove();return}if(g.classList.contains("av")&&g.dataset.render==="true"&&(((s=g.querySelector(".av__row--header").getAttribute("style"))==null?void 0:s.indexOf("transform"))>-1||((i=g.querySelector(".av__row--footer").getAttribute("style"))==null?void 0:i.indexOf("transform"))>-1))return;const m=p.cloneRange(),b=document.createElement("br");p.insertNode(b);const y=e.contentElement,_=b.getBoundingClientRect().top-y.getBoundingClientRect().top;let w=0;_<0?w=y.scrollTop+_:_>y.clientHeight-74&&(w=y.scrollTop+(_+74-y.clientHeight)),w!==0&&y.scroll({top:w,behavior:a}),b.remove(),X(m);return}}if(!t&&((l=document.activeElement)==null?void 0:l.tagName)!=="TEXTAREA"&&((o=document.activeElement)==null?void 0:o.tagName)!=="INPUT"&&(t=B(ye(e.wysiwyg.element).startContainer)),!t)return;let r=0,c=t;for(;c&&!c.classList.contains("protyle-wysiwyg");)r+=c.offsetTop,c=c.parentElement;let d=0,u=e.element.firstElementChild;for(;u&&!u.classList.contains("protyle-content");)d+=u.clientHeight,u=u.nextElementSibling;if(n){e.contentElement.scroll({top:r-d,behavior:a});return}e.contentElement.scrollTop>r-32?e.contentElement.scroll({top:r-d,behavior:a}):e.contentElement.scrollTop+e.contentElement.clientHeight<r+t.clientHeight-d&&e.contentElement.scroll({top:r+t.clientHeight-d-e.contentElement.clientHeight,behavior:a})},en=(e,t=0,n=1e3)=>{e.scroll.lastScrollTop=-1,setTimeout(()=>{e.scroll.lastScrollTop=t},n)},yi=(e,t)=>!e.classList.contains(t)||e.getBoundingClientRect().height===0,Wt=(e,t,n="b3-list-item--focus",a)=>{var s;let i=e.querySelector("."+n);if(!i&&a){a.classList.add(n),a.scrollIntoView(!0);return}if(!i)return;const l=n.split("--")[0];if(t.key==="ArrowDown"){for(t.preventDefault(),t.stopPropagation(),i.classList.remove(n),i=i.nextElementSibling;i&&yi(i,l);)i=i.nextElementSibling;if(!i)for(i=e.children[0];i&&yi(i,l);)i=i.nextElementSibling;return i?(i.classList.add(n),(e.scrollTop<i.offsetTop-e.clientHeight+i.clientHeight||e.scrollTop>i.offsetTop)&&i.scrollIntoView(e.scrollTop>i.offsetTop),i):void 0}else if(t.key==="ArrowUp"){for(t.preventDefault(),t.stopPropagation(),i.classList.remove(n),i=i.previousElementSibling;i&&yi(i,l);)i=i.previousElementSibling;if(!i)for(i=e.children[e.children.length-1];i&&(i.classList.contains("fn__none")||!i.classList.contains(l));)i=i.previousElementSibling;if(!i)return;i.classList.add(n);const o=e.scrollTop>i.offsetTop-(((s=i.previousElementSibling)==null?void 0:s.clientHeight)||0);return(e.scrollTop<i.offsetTop-e.clientHeight+i.clientHeight||o)&&i.scrollIntoView(o),i}else if(t.key==="Home"){for(t.preventDefault(),t.stopPropagation(),i.classList.remove(n),i=e.children[0];i&&yi(i,l);)i=i.nextElementSibling;return i?(i.classList.add(n),i.scrollIntoView(),i):void 0}else if(t.key==="End"){for(t.preventDefault(),t.stopPropagation(),i.classList.remove(n),i=e.children[e.children.length-1];i&&yi(i,l);)i=i.previousElementSibling;return i?(i.classList.add(n),i.scrollIntoView(!1),i):void 0}};class xu{constructor(){this.wheelEvent="onwheel"in document.createElement("div")?"wheel":"mousewheel",this.element=document.getElementById("commonMenu"),this.element.querySelector(".b3-menu__title .b3-menu__label").innerHTML=window.siyuan.languages.back,this.element.addEventListener(H()?"click":"mouseover",t=>{const n=t.target;if(H()&&($(n,"b3-menu__title")||typeof t.detail=="string"&&t.detail==="back")){const l=this.element.querySelectorAll(".b3-menu__item--show");l.length>0?l[l.length-1].classList.remove("b3-menu__item--show"):(this.element.style.transform="",setTimeout(()=>{this.remove()},f.TIMEOUT_DBLCLICK));return}const a=$(n,"b3-menu__item");if(!a||a.classList.contains("b3-menu__item--readonly"))return;const s=a.querySelector(".b3-menu__submenu");this.element.querySelectorAll(".b3-menu__item--show").forEach(i=>{!i.contains(a)&&!i.isSameNode(a)&&!a.contains(i)&&i.classList.remove("b3-menu__item--show")}),this.element.querySelectorAll(".b3-menu__item--current").forEach(i=>{i.classList.remove("b3-menu__item--current")}),a.classList.add("b3-menu__item--current"),s&&(a.classList.add("b3-menu__item--show"),this.element.classList.contains("b3-menu--fullscreen")||this.showSubMenu(s))})}showSubMenu(t){const n=t.parentElement.getBoundingClientRect();t.style.top=n.top-8+"px",t.style.left=n.right+8+"px",t.style.bottom="auto";const a=t.getBoundingClientRect();a.right>window.innerWidth&&(n.left-8>a.width?t.style.left=n.left-8-a.width+"px":t.style.left=window.innerWidth-a.width+"px"),a.bottom>window.innerHeight&&(t.style.top="auto",t.style.bottom="8px")}preventDefault(t){!$(t.target,"b3-menu")&&!$(t.target,"keyboard__bar")&&t.preventDefault()}addItem(t){const n=new M(t);return this.append(n.element,t.index),n.element}removeScrollEvent(){window.removeEventListener(H()?"touchmove":this.wheelEvent,this.preventDefault,!1)}remove(){window.siyuan.menus.menu.removeCB&&(window.siyuan.menus.menu.removeCB(),window.siyuan.menus.menu.removeCB=void 0),this.removeScrollEvent(),this.element.firstElementChild.classList.add("fn__none"),this.element.lastElementChild.innerHTML="",this.element.lastElementChild.removeAttribute("style"),this.element.classList.add("fn__none"),this.element.classList.remove("b3-menu--list","b3-menu--fullscreen"),this.element.removeAttribute("style"),this.element.removeAttribute("data-name"),this.element.removeAttribute("data-from"),this.data=void 0}append(t,n){if(t){if(typeof n=="number"){const a=this.element.querySelectorAll(".b3-menu__items > .b3-menu__separator")[n];if(a){a.before(t);return}}this.element.lastElementChild.append(t)}}popup(t){this.element.lastElementChild.innerHTML!==""&&(window.addEventListener(H()?"touchmove":this.wheelEvent,this.preventDefault,{passive:!1}),this.element.style.zIndex=(++window.siyuan.zIndex).toString(),this.element.classList.remove("fn__none"),ke(this.element,t.x-(t.isLeft?this.element.clientWidth:0),t.y,t.h,t.w))}fullscreen(t="all"){this.element.lastElementChild.innerHTML!==""&&(this.element.classList.add("b3-menu--fullscreen"),this.element.style.zIndex=(++window.siyuan.zIndex).toString(),this.element.firstElementChild.classList.remove("fn__none"),this.element.classList.remove("fn__none"),window.addEventListener("touchmove",this.preventDefault,{passive:!1}),setTimeout(()=>{t==="bottom"?(this.element.style.transform="translateY(-50vh)",this.element.style.height="50vh"):this.element.style.transform="translateY(-100vh)"}),this.element.lastElementChild.scrollTop=0)}}class M{constructor(t){if(!t.ignore){if(t.type==="empty"){this.element=document.createElement("div"),this.element.innerHTML=t.label,t.bind&&t.bind(this.element);return}if(this.element=document.createElement("button"),t.disabled&&this.element.setAttribute("disabled","disabled"),t.id&&this.element.setAttribute("data-id",t.id),t.type==="separator"){this.element.classList.add("b3-menu__separator");return}if(this.element.classList.add("b3-menu__item"),t.current&&this.element.classList.add("b3-menu__item--selected"),t.click&&this.element.addEventListener("click",n=>{if(this.element.getAttribute("disabled"))return;let a=t.click(this.element,n);a instanceof Promise&&(a=!1),n.preventDefault(),n.stopImmediatePropagation(),n.stopPropagation(),this.element.parentElement&&!a&&window.siyuan.menus.menu.remove()}),t.type==="readonly"&&this.element.classList.add("b3-menu__item--readonly"),(t.icon==="iconTrashcan"||t.warning)&&this.element.classList.add("b3-menu__item--warning"),t.element)this.element.append(t.element);else{let n=`<span class="b3-menu__label">${t.label||"&nbsp;"}</span>`;typeof t.iconHTML=="string"?n=t.iconHTML+n:n=`<svg class="b3-menu__icon ${t.iconClass||""}" style="${t.icon==="iconClose"?"height:10px;":""}"><use xlink:href="#${t.icon||""}"></use></svg>${n}`,t.accelerator&&(n+=`<span class="b3-menu__accelerator">${Me(t.accelerator)}</span>`),t.action&&(n+=`<svg class="b3-menu__action${t.action==="iconCloseRound"?" b3-menu__action--close":""}"><use xlink:href="#${t.action}"></use></svg>`),t.checked&&(n+='<svg class="b3-menu__checked"><use xlink:href="#iconSelect"></use></svg></span>'),this.element.innerHTML=n}if(t.bind&&(this.element.classList.add("b3-menu__item--custom"),t.bind(this.element)),t.submenu){const n=document.createElement("div");n.classList.add("b3-menu__submenu"),n.innerHTML='<div class="b3-menu__items"></div>',t.submenu.forEach(a=>{n.firstElementChild.append(new M(a).element)}),this.element.insertAdjacentHTML("beforeend",'<svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>'),this.element.append(n)}}}}const Ea=(e,t)=>{let n=e;for(;n&&(n.classList.contains("b3-menu__separator")||n.classList.contains("b3-menu__item--readonly")||n.getBoundingClientRect().height===0)&&!n.querySelector(".b3-text-field");)t?n=n.nextElementSibling:n=n.previousElementSibling;return n},mm=e=>{if(window.siyuan.menus.menu.element.classList.contains("fn__none")||e.altKey||e.shiftKey||e.ctrlKey||e.metaKey)return!1;const t=e.target;if(window.siyuan.menus.menu.element.contains(t)&&["INPUT","TEXTAREA"].includes(t.tagName))return!1;const n=Constants.KEYCODELIST[e.keyCode];if(n==="\u2193"||n==="\u2191"){const a=window.siyuan.menus.menu.element.querySelector(".b3-menu__item--current");let s;if(a?(a.classList.remove("b3-menu__item--current","b3-menu__item--show"),n==="\u2191"?(s=Ea(a.previousElementSibling,!1),s||(s=Ea(a.parentElement.lastElementChild,!1))):(s=Ea(a.nextElementSibling,!0),s||(s=Ea(a.parentElement.firstElementChild,!0)))):n==="\u2191"?s=Ea(window.siyuan.menus.menu.element.lastElementChild.lastElementChild,!1):s=Ea(window.siyuan.menus.menu.element.lastElementChild.firstElementChild,!0),s){s.classList.add("b3-menu__item--current"),s.classList.remove("b3-menu__item--show");const i=s.parentElement.getBoundingClientRect(),l=s.getBoundingClientRect();(i.top>l.top||i.bottom<l.bottom)&&s.scrollIntoView(i.top>l.top)}return!0}else if(n==="\u2192"){const a=window.siyuan.menus.menu.element.querySelector(".b3-menu__item--current");if(!a)return!0;const s=a.querySelector(".b3-menu__submenu");if(!s)return!0;a.classList.remove("b3-menu__item--current"),a.classList.add("b3-menu__item--show");const i=Ea(s.firstElementChild.firstElementChild,!0);return i&&i.classList.add("b3-menu__item--current"),window.siyuan.menus.menu.showSubMenu(s),!0}else if(n==="\u2190"){const a=window.siyuan.menus.menu.element.querySelector(".b3-menu__submenu .b3-menu__item--current");if(!a)return!0;const s=hasClosestByClassName(a,"b3-menu__item--show");return s&&(s.classList.remove("b3-menu__item--show"),s.classList.add("b3-menu__item--current"),a.classList.remove("b3-menu__item--current")),!0}else if(n==="\u21A9"){const a=window.siyuan.menus.menu.element.querySelector(".b3-menu__item--current");if(a){const s=a.querySelector(".b3-text-field"),i=a.querySelector(".b3-switch");if(s)return s.focus(),!0;i?i.click():a.dispatchEvent(new CustomEvent(getEventName())),window.siyuan.menus.menu.element.contains(a)&&window.siyuan.menus.menu.remove()}else return!1;return!0}};class Au{constructor(){this.menus=[]}addSeparator(t,n){typeof t=="number"?this.menus.splice(t,0,{type:"separator",id:n}):this.menus.push({type:"separator",id:n})}addItem(t){typeof t.index=="number"?this.menus.splice(t.index,0,t):this.menus.push(t)}}class Cu{constructor(t=""){this.eventTarget=document.appendChild(document.createComment(t))}on(t,n){this.eventTarget.addEventListener(t,n)}once(t,n){this.eventTarget.addEventListener(t,n,{once:!0})}off(t,n){this.eventTarget.removeEventListener(t,n)}emit(t,n){return this.eventTarget.dispatchEvent(new CustomEvent(t,{detail:n,cancelable:!0}))}}const jt=e=>{const t=new Au;e.detail.menu=t,e.plugins.forEach(n=>{n.eventBus.emit(e.type,e.detail)}),t.menus.length>0&&(e.separatorPosition==="top"&&window.siyuan.menus.menu.append(new M({id:"separator_pluginTop",type:"separator"}).element),window.siyuan.menus.menu.append(new M({id:"plugin",label:window.siyuan.languages.plugin,icon:"iconPlugin",type:"submenu",submenu:t.menus}).element),e.separatorPosition==="bottom"&&window.siyuan.menus.menu.append(new M({id:"separator_pluginBottom",type:"separator"}).element))},wi=e=>{Re(`${f.PROTYLE_CDN}/js/viewerjs/viewer.js?v=1.11.7`,"protyleViewerScript").then(()=>{const t=document.createElement("ul");t.innerHTML=`<li><img src="${e}"></li>`,window.siyuan.viewer=new Viewer(t,{title:[1,(n,a)=>{let s=n.alt;return s||(s=n.src.substring(n.src.lastIndexOf("/")+1)),s=s.substring(0,s.lastIndexOf(".")).replace(/-\d{14}-\w{7}$/,""),`${s} [${a.naturalWidth} \xD7 ${a.naturalHeight}]`}],button:!1,transition:!1,hidden:function(){window.siyuan.viewer.destroy()},toolbar:{zoomIn:!0,zoomOut:!0,oneToOne:!0,reset:!0,prev:!0,play:!0,next:!0,rotateLeft:!0,rotateRight:!0,flipHorizontal:!0,flipVertical:!0,close:function(){window.siyuan.viewer.destroy()}}}),window.siyuan.viewer.show()})},nr=(e,t)=>{Re(`${f.PROTYLE_CDN}/js/viewerjs/viewer.js?v=1.11.7`,"protyleViewerScript").then(()=>{A("/api/asset/getDocImageAssets",{id:t},n=>{const a=document.createElement("ul");let s="",i=-1;n.data.forEach((l,o)=>{l&&(s+=`<li><img src="${l}"></li>`,i===-1&&(e.endsWith(encodeURI(l))||e.endsWith(l))&&(i=o))}),a.innerHTML=s,window.siyuan.viewer=new Viewer(a,{title:[1,(l,o)=>{let r=l.alt;return r||(r=l.src.substring(l.src.lastIndexOf("/")+1)),r=r.substring(0,r.lastIndexOf(".")).replace(/-\d{14}-\w{7}$/,""),`${r} [${o.naturalWidth} \xD7 ${o.naturalHeight}]`}],button:!1,initialViewIndex:i,transition:!1,hidden:function(){window.siyuan.viewer.destroy()},toolbar:{zoomIn:!0,zoomOut:!0,oneToOne:!0,reset:!0,prev:!0,play:!0,next:!0,rotateLeft:!0,rotateRight:!0,flipHorizontal:!0,flipVertical:!0,close:function(){window.siyuan.viewer.destroy()}}}),window.siyuan.viewer.show()})})};var Tu=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{o(n.next(r))}catch(c){s(c)}},l=r=>{try{o(n.throw(r))}catch(c){s(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,l);o((n=n.apply(e,t)).next())});const dt=e=>{e.menu.addItem({iconHTML:"",label:dl(e.operator,!!e.data),click(){if(!e.data)q(e.protyle,[{action:"setAttrViewColCalc",avID:e.avId,id:e.colId,data:{operator:e.operator},blockID:e.blockID}],[{action:"setAttrViewColCalc",avID:e.avId,id:e.colId,data:{operator:e.oldOperator},blockID:e.blockID}]);else{e.target.querySelector(".b3-menu__accelerator").textContent=dl(e.operator,!0);const t=e.data.view.columns.find(n=>{if(n.id===e.colId)return n.rollup||(n.rollup={}),!0});t.rollup.calc={operator:e.operator},q(e.protyle,[{action:"updateAttrViewColRollup",id:e.colId,avID:e.avId,parentID:t.rollup.relationKeyID,keyID:t.rollup.keyID,data:{calc:t.rollup.calc}}],[{action:"updateAttrViewColRollup",id:e.colId,avID:e.avId,parentID:t.rollup.relationKeyID,keyID:t.rollup.keyID,data:{calc:{operator:e.oldOperator}}}])}}})},ar=(e,t,n,a)=>Tu(void 0,null,function*(){let s,i,l,o,r,c;if(n)o=n.data.id,i=t.dataset.colType,r=t.dataset.calc,l=n.colId,c=n.blockID;else{const g=B(t);if(!g||(s=$(t,"av__row--footer"),!s))return;s.classList.add("av__row--show"),i=t.dataset.dtype,l=t.dataset.colId,o=g.dataset.avId,r=t.dataset.operator,c=g.dataset.nodeId}if(i==="lineNumber")return;const d=new Ke("av-calc",()=>{s&&s.classList.remove("av__row--show")});if(d.isOpen)return;dt({menu:d,protyle:e,colId:l,avId:o,oldOperator:r,operator:"",data:n==null?void 0:n.data,blockID:c,target:t}),dt({menu:d,protyle:e,colId:l,avId:o,oldOperator:r,operator:"Count all",data:n==null?void 0:n.data,blockID:c,target:t}),i!=="checkbox"?(dt({menu:d,protyle:e,colId:l,avId:o,oldOperator:r,operator:"Count empty",data:n==null?void 0:n.data,blockID:c,target:t}),dt({menu:d,protyle:e,colId:l,avId:o,oldOperator:r,operator:"Count not empty",data:n==null?void 0:n.data,blockID:c,target:t}),dt({menu:d,protyle:e,colId:l,avId:o,oldOperator:r,operator:"Count values",data:n==null?void 0:n.data,blockID:c,target:t}),dt({menu:d,protyle:e,colId:l,avId:o,oldOperator:r,operator:"Count unique values",data:n==null?void 0:n.data,blockID:c,target:t}),dt({menu:d,protyle:e,colId:l,avId:o,oldOperator:r,operator:"Percent empty",data:n==null?void 0:n.data,blockID:c,target:t}),dt({menu:d,protyle:e,colId:l,avId:o,oldOperator:r,operator:"Percent not empty",data:n==null?void 0:n.data,blockID:c,target:t}),dt({menu:d,protyle:e,colId:l,avId:o,oldOperator:r,operator:"Percent unique values",data:n==null?void 0:n.data,blockID:c,target:t})):(dt({menu:d,protyle:e,colId:l,avId:o,oldOperator:r,operator:"Checked",data:n==null?void 0:n.data,blockID:c,target:t}),dt({menu:d,protyle:e,colId:l,avId:o,oldOperator:r,operator:"Unchecked",data:n==null?void 0:n.data,blockID:c,target:t}),dt({menu:d,protyle:e,colId:l,avId:o,oldOperator:r,operator:"Percent checked",data:n==null?void 0:n.data,blockID:c,target:t}),dt({menu:d,protyle:e,colId:l,avId:o,oldOperator:r,operator:"Percent unchecked",data:n==null?void 0:n.data,blockID:c,target:t}));let u=!1;if(i==="rollup"){let g,m,b=n==null?void 0:n.data;if(b||(b=(yield Ye("api/av/renderAttributeView",{id:o})).data),b.view.columns.find(y=>{var _,w;if(y.id===l)return g=(_=y.rollup)==null?void 0:_.relationKeyID,m=(w=y.rollup)==null?void 0:w.keyID,!0}),g&&m){let y;b.view.columns.find(_=>{var w;if(_.id===g)return y=(w=_.relation)==null?void 0:w.avID,!0}),y&&(yield Ye("api/av/getAttributeView",{id:y})).data.av.keyValues.find(w=>{if(w.key.id===m)return u=w.key.type==="number",!0})}}["number","template"].includes(i)||u?(dt({menu:d,protyle:e,colId:l,avId:o,oldOperator:r,operator:"Sum",data:n==null?void 0:n.data,blockID:c,target:t}),dt({menu:d,protyle:e,colId:l,avId:o,oldOperator:r,operator:"Average",data:n==null?void 0:n.data,blockID:c,target:t}),dt({menu:d,protyle:e,colId:l,avId:o,oldOperator:r,operator:"Median",data:n==null?void 0:n.data,blockID:c,target:t}),dt({menu:d,protyle:e,colId:l,avId:o,oldOperator:r,operator:"Min",data:n==null?void 0:n.data,blockID:c,target:t}),dt({menu:d,protyle:e,colId:l,avId:o,oldOperator:r,operator:"Max",data:n==null?void 0:n.data,blockID:c,target:t}),dt({menu:d,protyle:e,colId:l,avId:o,oldOperator:r,operator:"Range",data:n==null?void 0:n.data,blockID:c,target:t})):["date","created","updated"].includes(i)&&(dt({menu:d,protyle:e,colId:l,avId:o,oldOperator:r,operator:"Earliest",data:n==null?void 0:n.data,blockID:c,target:t}),dt({menu:d,protyle:e,colId:l,avId:o,oldOperator:r,operator:"Latest",data:n==null?void 0:n.data,blockID:c,target:t}),dt({menu:d,protyle:e,colId:l,avId:o,oldOperator:r,operator:"Range",data:n==null?void 0:n.data,blockID:c,target:t}));const p=t.getBoundingClientRect();d.open({x:Math.max(a||0,p.left),y:p.bottom,h:p.height})}),$u=e=>{if(!e.calc||!e.calc.result)return"";let t=e.calc.result.number;(e.calc.operator==="Earliest"||e.calc.operator==="Latest"||e.calc.operator==="Range"&&["date","created","updated"].includes(e.type))&&(t=e.calc.result[e.type]);let n="";switch(e.calc.operator){case"Count all":n=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.calcResultCountAll}</small>`;break;case"Count values":n=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.calcResultCountValues}</small>`;break;case"Count unique values":n=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.calcResultCountUniqueValues}</small>`;break;case"Count empty":n=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.calcResultCountEmpty}</small>`;break;case"Count not empty":n=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.calcResultCountNotEmpty}</small>`;break;case"Percent empty":n=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.calcResultPercentEmpty}</small>`;break;case"Percent not empty":n=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.calcResultPercentNotEmpty}</small>`;break;case"Percent unique values":n=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.calcResultPercentUniqueValues}</small>`;break;case"Sum":n=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.calcResultSum}</small>`;break;case"Average":n=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.calcResultAverage}</small>`;break;case"Median":n=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.calcResultMedian}</small>`;break;case"Min":n=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.calcResultMin}</small>`;break;case"Max":n=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.calcResultMax}</small>`;break;case"Range":n=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.calcResultRange}</small>`;break;case"Earliest":n=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.calcOperatorEarliest}</small>`;break;case"Latest":n=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.calcOperatorLatest}</small>`;break;case"Checked":n=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.checked}</small>`;break;case"Unchecked":n=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.unchecked}</small>`;break;case"Percent checked":n=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.percentChecked}</small>`;break;case"Percent unchecked":n=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.percentUnchecked}</small>`;break}return n},dl=(e,t)=>{switch(e){case void 0:case"":return t?window.siyuan.languages.original:window.siyuan.languages.calcOperatorNone;case"Count all":return window.siyuan.languages.calcOperatorCountAll;case"Count values":return window.siyuan.languages.calcOperatorCountValues;case"Count unique values":return window.siyuan.languages.calcOperatorCountUniqueValues;case"Count empty":return window.siyuan.languages.calcOperatorCountEmpty;case"Count not empty":return window.siyuan.languages.calcOperatorCountNotEmpty;case"Percent empty":return window.siyuan.languages.calcOperatorPercentEmpty;case"Percent not empty":return window.siyuan.languages.calcOperatorPercentNotEmpty;case"Percent unique values":return window.siyuan.languages.calcOperatorPercentUniqueValues;case"Checked":return window.siyuan.languages.checked;case"Unchecked":return window.siyuan.languages.unchecked;case"Percent checked":return window.siyuan.languages.percentChecked;case"Percent unchecked":return window.siyuan.languages.percentUnchecked;case"Sum":return window.siyuan.languages.calcOperatorSum;case"Average":return window.siyuan.languages.calcOperatorAverage;case"Median":return window.siyuan.languages.calcOperatorMedian;case"Min":return window.siyuan.languages.calcOperatorMin;case"Max":return window.siyuan.languages.calcOperatorMax;case"Range":return window.siyuan.languages.calcOperatorRange;case"Earliest":return window.siyuan.languages.calcOperatorEarliest;case"Latest":return window.siyuan.languages.calcOperatorLatest;default:return""}},hi=e=>{if(e.protyle.disabled)return;const t=new Ke("av-view");if(t.isOpen)return;t.addItem({id:"rename",icon:"iconEdit",label:window.siyuan.languages.rename,click(){var a;(a=document.querySelector(".av__panel"))==null||a.remove(),$t({protyle:e.protyle,blockElement:e.blockElement,type:"config",cb:s=>{s.querySelector('.b3-text-field[data-type="name"]').focus()}})}}),t.addItem({id:"config",icon:"iconSettings",label:window.siyuan.languages.config,click(){var a;(a=document.querySelector(".av__panel"))==null||a.remove(),$t({protyle:e.protyle,blockElement:e.blockElement,type:"config"})}}),t.addSeparator(),t.addItem({id:"duplicate",icon:"iconCopy",label:window.siyuan.languages.duplicate,click(){var a;(a=document.querySelector(".av__panel"))==null||a.remove();const s=Lute.NewNodeID();q(e.protyle,[{action:"duplicateAttrViewView",avID:e.blockElement.dataset.avId,previousID:e.element.dataset.id,id:s,blockID:e.blockElement.dataset.nodeId}],[{action:"removeAttrViewView",avID:e.blockElement.dataset.avId,id:s,blockID:e.blockElement.dataset.nodeId}]),e.blockElement.setAttribute(f.CUSTOM_SY_AV_VIEW,s)}}),e.blockElement.querySelectorAll(".layout-tab-bar .item").length>1&&t.addItem({id:"delete",icon:"iconTrashcan",label:window.siyuan.languages.delete,click(){var a;(a=document.querySelector(".av__panel"))==null||a.remove(),q(e.protyle,[{action:"removeAttrViewView",avID:e.blockElement.dataset.avId,id:e.element.dataset.id,blockID:e.blockElement.dataset.nodeId}])}});const n=e.element.getBoundingClientRect();t.open({x:n.left,y:n.bottom})},ir=e=>{const t=e.menuElement.querySelector('.b3-text-field[data-type="name"]');t.addEventListener("blur",()=>{t.value!==t.dataset.value&&(q(e.protyle,[{action:"setAttrViewViewName",avID:e.data.id,id:e.data.viewID,data:t.value}],[{action:"setAttrViewViewName",avID:e.data.id,id:e.data.viewID,data:t.dataset.value}]),t.dataset.value=t.value)}),t.addEventListener("keydown",s=>{s.isComposing||s.key==="Enter"&&(s.preventDefault(),t.blur(),e.menuElement.parentElement.remove())}),t.select(),t.value=t.dataset.value;const n=e.menuElement.querySelector('.b3-text-field[data-type="desc"]');t.nextElementSibling.addEventListener("click",()=>{const s=n.parentElement;s.classList.toggle("fn__none"),s.classList.contains("fn__none")||n.focus()}),n.addEventListener("blur",()=>{n.value!==n.dataset.value&&(q(e.protyle,[{action:"setAttrViewViewDesc",avID:e.data.id,id:e.data.viewID,data:n.value}],[{action:"setAttrViewViewDesc",avID:e.data.id,id:e.data.viewID,data:n.dataset.value}]),n.dataset.value=n.value)}),n.addEventListener("keydown",s=>{s.isComposing||s.key==="Enter"&&(s.preventDefault(),n.blur(),e.menuElement.parentElement.remove())}),n.addEventListener("input",()=>{t.nextElementSibling.setAttribute("aria-label",n.value?pe(n.value):window.siyuan.languages.addDesc)});const a=e.menuElement.querySelector('.b3-switch[data-type="toggle-view-title"]');a.addEventListener("change",()=>{const s=e.blockElement.getAttribute("data-av-id"),i=e.blockElement.getAttribute("data-node-id");a.checked?(q(e.protyle,[{action:"hideAttrViewName",avID:s,blockID:i,data:!1}],[{action:"hideAttrViewName",avID:s,blockID:i,data:!0}]),e.blockElement.querySelector(".av__title").classList.remove("fn__none")):(q(e.protyle,[{action:"hideAttrViewName",avID:s,blockID:i,data:!0}],[{action:"hideAttrViewName",avID:s,blockID:i,data:!1}]),e.blockElement.querySelector(".av__title").classList.add("fn__none"))})},sr=e=>{const t=e.view;return`<div class="b3-menu__items">
<button class="b3-menu__item" data-type="nobg">
    <span class="b3-menu__label ft__center">${window.siyuan.languages.config}</span>
</button>
<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="nobg">
    <div class="fn__block">
        <div class="fn__flex">
            <span class="b3-menu__avemoji" data-type="update-view-icon">${t.icon?ge(t.icon):'<svg style="height: 14px;width: 14px"><use xlink:href="#iconTable"></use></svg>'}</span>
            <div class="b3-form__icona fn__block">
                <input data-type="name" class="b3-text-field b3-form__icona-input" type="text" data-value="${We(t.name)}">
                <svg data-position="north" class="b3-form__icona-icon ariaLabel" aria-label="${t.desc?Nt(t.desc):window.siyuan.languages.addDesc}"><use xlink:href="#iconInfo"></use></svg>
            </div>
        </div>
        <div class="fn__none">
            <div class="fn__hr"></div>
            <textarea style="margin-left: 22px;width: calc(100% - 22px);" placeholder="${window.siyuan.languages.addDesc}" rows="1" data-type="desc" class="b3-text-field fn__size200" type="text" data-value="${We(t.desc)}">${t.desc}</textarea>
        </div>
    </div>
</button>
<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="go-properties">
    <svg class="b3-menu__icon"></svg>
    <span class="b3-menu__label">${window.siyuan.languages.fields}</span>
    <span class="b3-menu__accelerator">${t.columns.filter(n=>!n.hidden).length}/${t.columns.length}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<button class="b3-menu__item" data-type="goFilters">
    <svg class="b3-menu__icon"><use xlink:href="#iconFilter"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.filter}</span>
    <span class="b3-menu__accelerator">${t.filters.length}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<button class="b3-menu__item" data-type="goSorts">
    <svg class="b3-menu__icon"><use xlink:href="#iconSort"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.sort}</span>
    <span class="b3-menu__accelerator">${t.sorts.length}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<button class="b3-menu__item" data-type="set-page-size" data-size="${t.pageSize}">
    <svg class="b3-menu__icon"></svg>
    <span class="b3-menu__label">${window.siyuan.languages.entryNum}</span>
    <span class="b3-menu__accelerator">${t.pageSize===f.SIZE_DATABASE_MAZ_SIZE?window.siyuan.languages.all:t.pageSize}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<label class="b3-menu__item">
    <svg class="b3-menu__icon"></svg>
    <span class="fn__flex-center">${window.siyuan.languages.showTitle}</span>
    <span class="fn__space fn__flex-1"></span>
    <input data-type="toggle-view-title" type="checkbox" class="b3-switch b3-switch--menu" ${t.hideAttrViewName?"":"checked"}>
</label>
<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="duplicate-view">
    <svg class="b3-menu__icon">
        <use xlink:href="#iconCopy"></use>
    </svg>
    <span class="b3-menu__label">${window.siyuan.languages.duplicate}</span>
</button>
<button class="b3-menu__item${e.views.length>1?"":" fn__none"}" data-type="delete-view">
    <svg class="b3-menu__icon"><use xlink:href="#iconTrashcan"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.delete}</span>
</button>
</div>`},Iu=e=>{const t=e.menuElement.querySelector(".b3-text-field");t.focus(),t.addEventListener("keydown",n=>{if(n.stopPropagation(),!n.isComposing)if(Wt(e.menuElement.querySelector(".fn__flex-1"),n,"b3-menu__item--current"),n.key==="Enter"){const a=e.menuElement.querySelector(".b3-menu__item--current");a&&(e.blockElement.removeAttribute("data-render"),ze(e.blockElement,e.protyle,void 0,a.dataset.id),e.menuElement.remove(),ne(e.blockElement))}else n.key==="Escape"&&(e.menuElement.remove(),ne(e.blockElement))}),t.addEventListener("input",n=>{n.isComposing||lr(e.menuElement)}),t.addEventListener("compositionend",()=>{lr(e.menuElement)})},lr=e=>{var t;const a=e.querySelector(".b3-text-field").value;e.querySelectorAll('.b3-menu__item[draggable="true"]').forEach(s=>{!a||a.toLowerCase().indexOf(s.textContent.trim().toLowerCase())>-1||s.textContent.trim().toLowerCase().indexOf(a.toLowerCase())>-1?s.classList.remove("fn__none"):(s.classList.add("fn__none"),s.classList.remove("b3-menu__item--current"))}),e.querySelector(".b3-menu__item--current")||(t=e.querySelector(".fn__flex-1 .b3-menu__item:not(.fn__none)"))==null||t.classList.add("b3-menu__item--current")},Du=(e,t)=>{let n="";return e.forEach(a=>{n+=`<button draggable="true" class="b3-menu__item${a.id===t?" b3-menu__item--current":""}" data-id="${a.id}">
    <svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>
    <div class="b3-menu__label fn__flex" data-type="av-view-switch">
        ${a.icon?ge(a.icon,"b3-menu__icon",!0):'<svg class="b3-menu__icon"><use xlink:href="#iconTable"></use></svg>'}
        <span class="fn__ellipsis">${a.name}</span>
    </div>
    <svg class="b3-menu__action" data-type="av-view-edit"><use xlink:href="#iconEdit"></use></svg>
</button>`}),`<div class="b3-menu__items fn__flex-column">
<button class="b3-menu__item" data-type="av-add">
    <svg class="b3-menu__icon"><use xlink:href="#iconAdd"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.newView}</span>
</button>
<button class="b3-menu__separator"></button>
<div class="b3-menu__item fn__flex-shrink" data-type="nobg">
    <input class="b3-text-field fn__block" type="text" style="margin: 4px 0" placeholder="${window.siyuan.languages.search}">
</div>
<div class="fn__flex-1" style="overflow: auto">
    ${n}
</div>
</div>`},or=(e,t)=>{const n=Lute.NewNodeID(),a=t.getAttribute("data-av-id");q(e,[{action:"addAttrViewView",avID:a,id:n,blockID:t.getAttribute("data-node-id")}],[{action:"removeAttrViewView",avID:a,id:n,blockID:t.getAttribute("data-node-id")}]),t.setAttribute(f.CUSTOM_SY_AV_VIEW,n)},ul=(e,t,n,a=!0,s)=>{A("/api/av/searchAttributeView",{keyword:t,excludes:a&&n?[n]:void 0},i=>{let l="";i.data.results.forEach((o,r)=>{l+=`<div class="b3-list-item b3-list-item--narrow${r===0?" b3-list-item--focus":""}" data-av-id="${o.avID}" data-block-id="${o.blockID}">
    <div class="b3-list-item--two fn__flex-1">
        <div class="b3-list-item__first">
            <span class="b3-list-item__text">${pe(o.avName||window.siyuan.languages.title)}</span>
        </div>
        <div class="b3-list-item__meta b3-list-item__showall">${Ji(o.hPath)}</div>
    </div>
    <svg aria-label="${window.siyuan.languages.thisDatabase}" style="margin: 0 0 0 4px" class="b3-list-item__hinticon ariaLabel${o.avID===n?"":" fn__none"}"><use xlink:href="#iconInfo"></use></svg>
</div>`}),e.innerHTML=l,s&&s()})},rr=(e,t,n)=>{t.dataset.avId=n.dataset.avId,t.dataset.blockId=n.dataset.blockId,t.querySelector(".b3-menu__accelerator").textContent=n.querySelector(".b3-list-item__hinticon").classList.contains("fn__none")?n.querySelector(".b3-list-item__text").textContent:window.siyuan.languages.thisDatabase;const a=$(t,"b3-menu__items");a&&vi(a,e,!0)},_i=(e,t,n,a=!0)=>{window.siyuan.menus.menu.remove();const s=new Ke;s.addItem({iconHTML:"",type:"empty",label:`<div class="fn__flex-column b3-menu__filter">
    <input class="b3-text-field fn__flex-shrink"/>
    <div class="fn__hr"></div>
    <div class="b3-list fn__flex-1 b3-list--background">
        <img style="margin: 0 auto;display: block;width: 64px;height: 64px" src="/stage/loading-pure.svg">
    </div>
</div>`,bind(l){const o=l.querySelector(".b3-list"),r=l.querySelector("input");r.addEventListener("keydown",c=>{if(c.isComposing)return;if(Wt(o,c)&&c.stopPropagation(),c.key==="Enter"){c.preventDefault(),c.stopPropagation();const u=o.querySelector(".b3-list-item--focus");n?n(u):rr(e,t,u),window.siyuan.menus.menu.remove()}}),r.addEventListener("input",c=>{c.stopPropagation(),!c.isComposing&&ul(o,r.value,e,a)}),r.addEventListener("compositionend",()=>{ul(o,r.value,e,a)}),l.lastElementChild.addEventListener("click",c=>{const d=$(c.target,"b3-list-item");d&&(c.stopPropagation(),n?n(d):rr(e,t,d),window.siyuan.menus.menu.remove())}),ul(o,"",e,a,()=>{const c=t.getBoundingClientRect();s.open({x:c.left,y:c.bottom,h:c.height}),l.querySelector("input").focus()})}}),s.element.querySelector(".b3-menu__items").setAttribute("style","overflow: initial");const i=Q(t,"block__popover",!0);s.element.setAttribute("data-from",i?i.dataset.level+"popover":"app")},Mu=e=>{const t=e.avElement.querySelector('input[data-type="colName"]'),a=e.avElement.querySelector('.b3-menu__item[data-type="goSearchAV"]').getAttribute("data-av-id"),s=e.avElement.querySelector(".b3-menu__item").getAttribute("data-col-id");let i;e.colsData.find(o=>{if(o.id===s)return o.relation||(o.relation={}),i=o,!0});const l=e.avElement.querySelector('[data-type="name"]').value;q(e.protyle,[{action:"updateAttrViewColRelation",avID:e.avID,keyID:s,id:a||i.relation.avID,backRelationKeyID:i.relation.avID===a&&i.relation.backKeyID||Lute.NewNodeID(),isTwoWay:e.avElement.querySelector(".b3-switch").checked,name:t.value,format:l}],[{action:"updateAttrViewColRelation",avID:e.avID,keyID:s,id:i.relation.avID||a,backRelationKeyID:i.relation.backKeyID,isTwoWay:i.relation.isTwoWay,name:t.dataset.oldValue,format:i.name}]),e.avElement.remove(),Tt(e.blockElement.querySelector(`.av__row--header .av__cell[data-col-id="${s}"]`),void 0,{name:l}),ne(e.blockElement)},vi=(e,t,n=!1)=>{const a=e.querySelector('.b3-menu__item[data-type="goSearchAV"]'),s=a.nextElementSibling,i=s.querySelector(".b3-switch"),l=s.nextElementSibling,o=l.nextElementSibling,r=JSON.parse(a.dataset.oldValue);if(r.avID){const c=l.querySelector("input");n&&(a.dataset.avId!==r.avID?(c.value="",i.checked=!1):(c.value=c.dataset.oldValue,i.checked=r.isTwoWay)),i.checked?l.classList.remove("fn__none"):l.classList.add("fn__none"),a.dataset.avId&&r.avID!==a.dataset.avId||r.isTwoWay!==i.checked||c.dataset.oldValue!==c.value?o.classList.remove("fn__none"):o.classList.add("fn__none")}else a.dataset.avId&&(i.checked?l.classList.remove("fn__none"):l.classList.add("fn__none"),o.classList.remove("fn__none"))},vn=(e,t,n,a)=>{if(e==="selected")return`<svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>
<span class="b3-menu__label fn__ellipsis ${n?"":" popover__block"}" ${n?"":'style="color:var(--b3-protyle-inline-blockref-color)"'} data-id="${t}">${a}</span>
<svg class="b3-menu__action"><use xlink:href="#iconMin"></use></svg>`;if(e==="empty")return t?`<button class="b3-menu__item" data-type="setRelationCell">
    <span class="b3-menu__label fn__ellipsis">${window.siyuan.languages.newRowInRelation.replace("${x}",a).replace("${y}",t)}</span>
</button>`:`<button class="b3-menu__item">
    <span class="b3-menu__label">${window.siyuan.languages.emptyContent}</span>
</button>`;if(e=="unselect")return`<button data-id="${t}" class="b3-menu__item ariaLabel" data-position="west" data-type="setRelationCell">
    <span class="b3-menu__label fn__ellipsis${n?"":" popover__block"}" ${n?"":'style="color:var(--b3-protyle-inline-blockref-color)"'} data-id="${t}">${a}</span>
    <svg class="b3-menu__action"><use xlink:href="#iconAdd"></use></svg>
</button>`},cr=(e,t,n)=>{A("/api/av/getAttributeViewPrimaryKeyValues",{id:e.firstElementChild.getAttribute("data-av-id"),keyword:n},a=>{const s=a.data.rows.values||[];let i="",l="";const o=[];t.querySelectorAll(".av__cell--relation").forEach(r=>{const c=r.querySelector(".av__celltext");o.push(c.dataset.id),l+=`<button data-id="${c.dataset.id}" data-position="west" data-type="setRelationCell" 
class="b3-menu__item ariaLabel${c.textContent.indexOf(n)>-1?"":" fn__none"}" 
draggable="true">${vn("selected",c.dataset.id,!c.classList.contains("av__celltext--ref"),Lute.EscapeHTMLStr(c.textContent||window.siyuan.languages.untitled))}</button>`}),s.forEach(r=>{o.includes(r.block.id)||(i+=vn("unselect",r.block.id,r.isDetached,Lute.EscapeHTMLStr(r.block.content||window.siyuan.languages.untitled)))}),e.querySelector(".b3-menu__items").innerHTML=`${l}
<button class="b3-menu__separator"></button>
${i}
${n?vn("empty",Lute.EscapeHTMLStr(n),void 0,e.querySelector(".popover__block").outerHTML):i?"":vn("empty")}`,e.querySelector(".b3-menu__items .b3-menu__item:not(.fn__none)").classList.add("b3-menu__item--current")})},Hu=e=>{A("/api/av/getAttributeViewPrimaryKeyValues",{id:e.menuElement.firstElementChild.getAttribute("data-av-id"),keyword:""},t=>{const n=t.data.rows.values||[];let a="",s="";const i=[];e.cellElements[0].querySelectorAll(".av__cell--relation").forEach(d=>{const u=d.querySelector(".av__celltext");i.push(u.dataset.id),s+=`<button data-id="${u.dataset.id}" data-position="west" data-type="setRelationCell" class="b3-menu__item ariaLabel" 
draggable="true">${vn("selected",u.dataset.id,!u.classList.contains("av__celltext--ref"),Lute.EscapeHTMLStr(u.textContent||window.siyuan.languages.untitled))}</button>`}),n.forEach(d=>{i.includes(d.block.id)||(a+=vn("unselect",d.block.id,d.isDetached,Lute.EscapeHTMLStr(d.block.content||window.siyuan.languages.untitled)))}),e.menuElement.querySelector(".b3-menu__items").innerHTML=`${s}
<button class="b3-menu__separator"></button>
${a||vn("empty")}`;const l=e.cellElements[e.cellElements.length-1].getBoundingClientRect();ke(e.menuElement,l.left,l.bottom,l.height),e.menuElement.querySelector(".b3-menu__items .b3-menu__item:not(.fn__none)").classList.add("b3-menu__item--current");const o=e.menuElement.querySelector("input");o.focus();const r=o.parentElement.querySelector(".popover__block");r.innerHTML=Lute.EscapeHTMLStr(t.data.name),r.setAttribute("data-id",t.data.blockIDs[0]);const c=e.menuElement.querySelector(".b3-menu__items");o.addEventListener("keydown",d=>{if(d.isComposing)return;Wt(c,d,"b3-menu__item--current");const u=e.menuElement.querySelector(".b3-menu__item--current");d.key==="Enter"&&u&&u.getAttribute("data-type")==="setRelationCell"?(dr(e.protyle,e.blockElement,u,e.cellElements),d.preventDefault(),d.stopPropagation()):d.key==="Escape"&&(e.menuElement.parentElement.remove(),d.preventDefault(),d.stopPropagation())}),o.addEventListener("input",d=>{d.isComposing||(cr(e.menuElement,e.cellElements[0],o.value),d.stopPropagation())}),o.addEventListener("compositionend",d=>{d.stopPropagation(),cr(e.menuElement,e.cellElements[0],o.value)})})},Nu=(e,t)=>{let n;return e.view.columns.find(a=>{if(a.id===t[0].dataset.colId)return n=a.relation,!0}),n&&n.avID?`<div data-av-id="${n.avID}" class="fn__flex-column">
<div class="b3-menu__item" data-type="nobg">
    <input class="b3-text-field fn__flex-1"/>
    <span class="fn__space"></span>
    <span style="color: var(--b3-protyle-inline-blockref-color);" data-id="" class="popover__block fn__pointer"></span>
</div>
<div class="fn__hr"></div>
<div class="b3-menu__items">
    <img style="margin: 0 auto;display: block;width: 64px;height: 64px" src="/stage/loading-pure.svg">
</div>`:""},dr=(e,t,n,a)=>{var s;const i=$(n,"b3-menu");if(!i||i.querySelector(".dragover__bottom, .dragover__top"))return;const l=$(a[0],"av__row");if(!l)return;t.contains(a[0])||(a[0]=t.querySelector(`.av__row[data-id="${l.dataset.id}"] .av__cell[data-col-id="${a[0].dataset.colId}"]`)||t.querySelector(`.fn__flex-1[data-col-id="${a[0].dataset.colId}"]`));const o={blockIDs:[],contents:[]};if(i.querySelectorAll('[draggable="true"]').forEach(r=>{const c=r.getAttribute("data-id");o.blockIDs.push(c),o.contents.push({type:"block",block:{id:c,content:r.querySelector(".b3-menu__label").textContent},isDetached:!r.querySelector(".popover__block")})}),n.classList.contains("b3-menu__item")){const r=n.getAttribute("data-id"),c=i.querySelector(".b3-menu__separator"),d=i.querySelector("input").value;if(n.getAttribute("draggable")){!c.nextElementSibling.getAttribute("data-id")&&!d&&c.nextElementSibling.remove();const u=o.blockIDs.indexOf(r);o.blockIDs.splice(u,1),o.contents.splice(u,1),c.after(n),n.outerHTML=vn("unselect",r,!n.querySelector(".popover__block"),Lute.EscapeHTMLStr(n.querySelector(".b3-menu__label").textContent))}else if(r)o.blockIDs.push(r),o.contents.push({type:"block",block:{id:r,content:n.firstElementChild.textContent},isDetached:!n.firstElementChild.getAttribute("style")}),c.before(n),n.outerHTML=`<button data-id="${r}" data-position="west" data-type="setRelationCell" class="b3-menu__item ariaLabel" 
draggable="true">${vn("selected",r,!n.querySelector(".popover__block"),Lute.EscapeHTMLStr(n.querySelector(".b3-menu__label").textContent))}</button>`,c.nextElementSibling||c.insertAdjacentHTML("afterend",vn("empty"));else{const u=n.querySelector(".popover__block").getAttribute("data-id"),p=n.querySelector("b").textContent,g=Lute.NewNodeID();q(e,[{action:"insertAttrViewBlock",ignoreFillFilter:!0,avID:i.firstElementChild.getAttribute("data-av-id"),srcs:[{id:g,isDetached:!0,content:p}],blockID:u},{action:"doUpdateUpdated",id:u,data:U().format("YYYYMMDDHHmmss")}]),o.blockIDs.push(g),o.contents.push({type:"block",block:{id:g,content:p},isDetached:!0}),c.insertAdjacentHTML("beforebegin",`<button data-id="${g}" data-position="west" data-type="setRelationCell" 
class="b3-menu__item ariaLabel" draggable="true">${vn("selected",g,!0,Lute.EscapeHTMLStr(p))}</button>`)}(s=i.querySelector(".b3-menu__item--current"))==null||s.classList.remove("b3-menu__item--current"),i.querySelector(".b3-menu__items .b3-menu__item:not(.fn__none)").classList.add("b3-menu__item--current")}zt(e,t,o,a)};var Pu=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{o(n.next(r))}catch(c){s(c)}},l=r=>{try{o(n.throw(r))}catch(c){s(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,l);o((n=n.apply(e,t)).next())});const qu=(e,t)=>{if(bt(t))return!1;const n=B(t.target);if(!n)return!1;if(D(t.target,"data-type","av-load-more")&&!D(t.target,"data-type","set-page-size"))return n.querySelector(".av__row--footer").style.transform="",n.removeAttribute("data-render"),n.dataset.pageSize=(parseInt(n.dataset.pageSize)+parseInt(n.querySelector('[data-type="set-page-size"]').getAttribute("data-size"))).toString(),ze(n,e),t.preventDefault(),t.stopPropagation(),!0;const s=$(t.target,"av__firstcol");if(s)return window.siyuan.menus.menu.remove(),An(s,"toggle"),t.preventDefault(),t.stopPropagation(),!0;const i=$(t.target,"av__cellassetimg");if(i)return wi(i.src),t.preventDefault(),t.stopPropagation(),!0;if(t.shiftKey){const d=$(t.target,"av__row");if(d&&!d.classList.contains("av__row--header"))return An(d.querySelector(".av__firstcol"),"toggle"),t.preventDefault(),t.stopPropagation(),!0}const l=D(t.target,"data-type","copy");if(l)return Be(Es($(l,"av__cell"))),ae(window.siyuan.languages.copied),t.preventDefault(),t.stopPropagation(),!0;if(D(t.target,"data-type","av-search-icon")){const d=n.querySelector('input[data-type="av-search"]');d.style.width="128px",d.style.paddingLeft="",d.style.paddingRight="";const u=$(d,"av__views");return u&&u.classList.add("av__views--show"),setTimeout(()=>{d.focus()},f.TIMEOUT_TRANSITION),t.preventDefault(),t.stopPropagation(),!0}const r=$(t.target,"item");if(r&&r.parentElement.classList.contains("layout-tab-bar"))return r.classList.contains("item--focus")?hi({protyle:e,blockElement:n,element:r}):(n.removeAttribute("data-render"),ze(n,e,void 0,r.dataset.id)),t.preventDefault(),t.stopPropagation(),!0;if(e.disabled)return!1;let c=t.target;for(;c&&!c.isEqualNode(n);){const d=c.getAttribute("data-type");if(d==="av-header-add"){const u=Ii(e,n),p=c.getBoundingClientRect();return u.open({x:p.left,y:p.bottom,h:p.height}),t.preventDefault(),t.stopPropagation(),!0}else{if(d==="av-header-more")return $t({protyle:e,blockElement:n,type:"properties"}),t.preventDefault(),t.stopPropagation(),!0;if(d==="av-add-more")return Ja(n,e,1,void 0),t.preventDefault(),t.stopPropagation(),!0;if(d==="av-more")return $t({protyle:e,blockElement:n,type:"config"}),t.preventDefault(),t.stopPropagation(),!0;if(d==="av-switcher")return $t({protyle:e,blockElement:n,type:"switcher"}),t.preventDefault(),t.stopPropagation(),!0;if(d==="av-sort")return $t({protyle:e,blockElement:n,type:"sorts"}),t.preventDefault(),t.stopPropagation(),!0;if(d==="av-filter")return $t({protyle:e,blockElement:n,type:"filters"}),t.preventDefault(),t.stopPropagation(),!0;if(d==="av-add")return or(e,n),t.preventDefault(),t.stopPropagation(),!0;if(d==="block-more")return window.siyuan.menus.menu.remove(),e.toolbar.range=document.createRange(),e.toolbar.range.selectNodeContents(c),X(e.toolbar.range),c.parentElement.classList.add("av__cell--select"),Gt(c.parentElement),fa(c.previousElementSibling.textContent.trim(),e,"av"),t.preventDefault(),t.stopPropagation(),!0;if(d==="set-page-size")return Bc({target:c,protyle:e,avID:n.getAttribute("data-av-id"),nodeElement:n}),t.preventDefault(),t.stopPropagation(),!0;if(d==="av-add-bottom")return Ja(n,e,1,n.querySelector(".av__row--util").previousElementSibling.getAttribute("data-id")||""),t.preventDefault(),t.stopPropagation(),!0;if(c.classList.contains("av__cell--header"))return kc(e,n,c),t.preventDefault(),t.stopPropagation(),!0;if(c.classList.contains("av__cell")){if(!$(c,"av__row--header")){const u=$(c,"av__scroll");if(!u||c.querySelector(".av__pulse"))return;const p=$(c,"av__row");if(!p)return;const g=Bt(c);g==="updated"||g==="created"||g==="lineNumber"?An(p.querySelector(".av__firstcol"),"toggle"):(u.querySelectorAll(".av__row--select").forEach(m=>{m.querySelector(".av__firstcol use").setAttribute("xlink:href","#iconUncheck"),m.classList.remove("av__row--select")}),ca(p),rn(e,[c]))}return t.preventDefault(),t.stopPropagation(),!0}else{if(c.classList.contains("av__calc"))return ar(e,c,void 0,t.clientX-64),t.preventDefault(),t.stopPropagation(),!0;if(c.classList.contains("b3-menu__avemoji")){const u=c.getBoundingClientRect();return _a(c.parentElement.getAttribute("data-block-id"),"doc",{x:u.left,y:u.bottom,h:u.height,w:u.width},p=>{c.innerHTML=ge(p||window.siyuan.storage[f.LOCAL_IMAGES].file)},c.querySelector("img")),t.preventDefault(),t.stopPropagation(),!0}}}c=c.parentElement}return!1},ls=(e,t,n)=>{var a;if(J(["hint"],e),t.classList.contains("av__row--header"))return!1;const s=B(t);if(!s)return!1;s.querySelectorAll(".av__cell--select, .av__cell--active").forEach(u=>{var p;u.classList.remove("av__cell--select","av__cell--active"),(p=u.querySelector(".av__drag-fill"))==null||p.remove()}),t.classList.contains("av__row--select")||(s.querySelectorAll(".av__row--select").forEach(u=>{u.classList.remove("av__row--select")}),s.querySelectorAll(".av__firstcol use").forEach(u=>{u.setAttribute("xlink:href","#iconUncheck")}));const i=new Ke;t.classList.add("av__row--select"),t.querySelector(".av__firstcol use").setAttribute("xlink:href","#iconCheck");const l=s.querySelectorAll(".av__row--select:not(.av__row--header)");ca(t);const o=l[0].querySelector(".av__cell[data-block-id]"),r=Array.from(l).map(u=>u.getAttribute("data-id"));l.length===1&&o.getAttribute("data-detached");let c=!1;l.forEach(u=>{u.querySelector('.av__cell[data-dtype="block"]').getAttribute("data-detached")!=="true"&&(c=!0)});const d=[{id:"copyKeyContent",iconHTML:"",label:window.siyuan.languages.copyKeyContent,click(){let u="";l.forEach((p,g)=>{l.length>1&&(u+="* "),u+=p.querySelector('.av__cell[data-dtype="block"] .av__celltext').textContent.trim(),r.length>1&&g!==r.length-1&&(u+=`
`)}),Be(u)}}];if(c&&d.splice(1,0,{id:"copyBlockRef",iconHTML:"",label:window.siyuan.languages.copyBlockRef,click:()=>{let u="";for(let p=0;p<r.length;p++){const g=r[p];let m="";const b=l[p].querySelector(".av__cell[data-dtype='block']");b.getAttribute("data-detached")==="true"?m=b.querySelector(".av__celltext").textContent:m=`((${g} '${b.querySelector(".av__celltext").textContent.replace(/[\n]+/g," ")}'))`,r.length>1&&(u+="* "),u+=m,r.length>1&&p!==r.length-1&&(u+=`
`)}Be(u)}},{id:"copyBlockEmbed",iconHTML:"",label:window.siyuan.languages.copyBlockEmbed,click:()=>{let u="";r.forEach((p,g)=>{r.length>1&&(u+="* ");const m=l[g].querySelector(".av__cell[data-dtype='block']");m.getAttribute("data-detached")==="true"?u+=m.querySelector(".av__celltext").textContent:u+=`{{select * from blocks where id='${p}'}}`,r.length>1&&g!==r.length-1&&(u+=`
`)}),Be(u)}},{id:"copyProtocol",iconHTML:"",label:window.siyuan.languages.copyProtocol,click:()=>{let u="";r.forEach((p,g)=>{r.length>1&&(u+="* ");const m=l[g].querySelector(".av__cell[data-dtype='block']");m.getAttribute("data-detached")==="true"?u+=m.querySelector(".av__celltext").textContent:u+=`siyuan://blocks/${p}`,r.length>1&&g!==r.length-1&&(u+=`
`)}),Be(u)}},{id:"copyProtocolInMd",iconHTML:"",label:window.siyuan.languages.copyProtocolInMd,click:()=>{let u="";for(let p=0;p<r.length;p++){const g=r[p];let m="";const b=l[p].querySelector(".av__cell[data-dtype='block']");b.getAttribute("data-detached")==="true"?m=b.querySelector(".av__celltext").textContent:m=`[${b.querySelector(".av__celltext").textContent.replace(/[\n]+/g," ")}](siyuan://blocks/${g})`,r.length>1&&(u+="* "),u+=m,r.length>1&&p!==r.length-1&&(u+=`
`)}Be(u)}},{id:"copyHPath",iconHTML:"",label:window.siyuan.languages.copyHPath,click:()=>Pu(void 0,null,function*(){let u="";for(let p=0;p<r.length;p++){const g=r[p];let m="";const b=l[p].querySelector(".av__cell[data-dtype='block']");b.getAttribute("data-detached")==="true"?m=b.querySelector(".av__celltext").textContent:m=(yield Ye("/api/filetree/getHPathByID",{id:g})).data,r.length>1&&(u+="* "),u+=m,r.length>1&&p!==r.length-1&&(u+=`
`)}Be(u)})},{id:"copyID",iconHTML:"",label:window.siyuan.languages.copyID,click:()=>{let u="";r.forEach((p,g)=>{r.length>1&&(u+="* ");const m=l[g].querySelector(".av__cell[data-dtype='block']");m.getAttribute("data-detached")==="true"?u+=m.querySelector(".av__celltext").textContent:u+=p,r.length>1&&g!==r.length-1&&(u+=`
`)}),Be(u)}}),i.addItem({id:"copy",label:window.siyuan.languages.copy,icon:"iconCopy",type:"submenu",submenu:d}),!e.disabled){i.addItem({id:"addToDatabase",label:window.siyuan.languages.addToDatabase,icon:"iconDatabase",click(){_i(s.getAttribute("data-av-id"),l[0],p=>{const g=[],m=[];l.forEach(y=>{const _=y.getAttribute("data-id"),w=gn("block",y.querySelector(".av__cell[data-block-id]"));g.push({content:w.block.content,id:_,isDetached:w.isDetached}),m.push(_)});const b=p.dataset.avId;q(e,[{action:"insertAttrViewBlock",avID:b,ignoreFillFilter:!0,srcs:g,blockID:p.dataset.blockId},{action:"doUpdateUpdated",id:p.dataset.blockId,data:U().format("YYYYMMDDHHmmss")}],[{action:"removeAttrViewBlock",srcIDs:m,avID:b}])})}}),l.length===1&&(o.getAttribute("data-detached")!=="true"&&i.addSeparator({id:"separator_1"}),i.addItem({id:"insertRowBefore",icon:"iconBefore",label:`<div class="fn__flex" style="align-items: center;">
${window.siyuan.languages.insertRowBefore.replace("${x}",`<span class="fn__space"></span><input style="width:64px" type="number" step="1" min="1" value="1" placeholder="${window.siyuan.languages.enterKey}" class="b3-text-field"><span class="fn__space"></span>`)}
</div>`,bind(p){const g=p.querySelector("input");p.addEventListener("click",()=>{document.activeElement.isSameNode(g)||(Ja(s,e,parseInt(g.value),l[0].previousElementSibling.getAttribute("data-id")),i.close())}),g.addEventListener("keydown",m=>{!m.isComposing&&m.key==="Enter"&&(Ja(s,e,parseInt(g.value),l[0].previousElementSibling.getAttribute("data-id")),i.close())})}}),i.addItem({id:"insertRowAfter",icon:"iconAfter",label:`<div class="fn__flex" style="align-items: center;">
${window.siyuan.languages.insertRowAfter.replace("${x}",`<span class="fn__space"></span><input style="width:64px" type="number" step="1" min="1" placeholder="${window.siyuan.languages.enterKey}" class="b3-text-field" value="1"><span class="fn__space"></span>`)}
</div>`,bind(p){const g=p.querySelector("input");p.addEventListener("click",()=>{document.activeElement.isSameNode(g)||(Ja(s,e,parseInt(g.value),l[0].getAttribute("data-id")),i.close())}),g.addEventListener("keydown",m=>{!m.isComposing&&m.key==="Enter"&&(Ja(s,e,parseInt(g.value),l[0].getAttribute("data-id")),i.close())})}}),i.addSeparator({id:"separator_2"}),o.getAttribute("data-detached")!=="true"&&i.addItem({id:"unbindBlock",label:window.siyuan.languages.unbindBlock,icon:"iconLinkOff",click(){zt(e,s,{content:o.querySelector(".av__celltext").textContent},[o])}})),i.addItem({id:"delete",icon:"iconTrashcan",label:window.siyuan.languages.delete,click(){Uc(s,e)}});const u=[];t.parentElement.querySelectorAll(".av__row--header .av__cell").forEach(p=>{const g=Array.from(s.querySelectorAll(`.av__row--select:not(.av__row--header) .av__cell[data-col-id="${p.dataset.colId}"]`)),m=p.getAttribute("data-dtype");if(!["updated","created"].includes(m)){const b=p.dataset.icon;u.push({iconHTML:b?ge(b,"b3-menu__icon",!0):`<svg class="b3-menu__icon"><use xlink:href="#${_t(m)}"></use></svg>`,label:pe(p.querySelector(".av__celltext").textContent.trim()),click(){rn(e,g)}})}}),i.addItem({id:"fields",icon:"iconAttr",label:window.siyuan.languages.fields,type:"submenu",submenu:u})}return(a=e==null?void 0:e.app)!=null&&a.plugins&&jt({plugins:e.app.plugins,type:"open-menu-av",detail:{protyle:e,element:s,selectRowElements:l},separatorPosition:"top"}),i.open(n),!0},fl=(e,t)=>{const n=t.getAttribute("data-av-id"),a=t.getAttribute("data-node-id"),s=t.querySelector(".av__title"),i=s.textContent.trim();if(i===s.dataset.title.trim())return;const l=U().format("YYYYMMDDHHmmss");q(e,[{action:"setAttrViewName",id:n,data:i},{action:"doUpdateUpdated",id:a,data:l}],[{action:"setAttrViewName",id:n,data:s.dataset.title},{action:"doUpdateUpdated",id:a,data:t.getAttribute("updated")}]),t.setAttribute("updated",l),s.dataset.title=i,Array.from(e.wysiwyg.element.querySelectorAll(`[data-av-id="${n}"]`)).forEach(o=>{if(t.isSameNode(o))return;const r=o.querySelector(".av__title");r&&(r.textContent=i,r.dataset.title=i)})},Tt=(e,t,n)=>{if(e)if(n)Jf(e,n);else{const a=e.querySelector(".av__drag-fill");e.innerHTML=Ti(t),a&&Gt(e),Bl(e,t)}},ur=(e,t)=>{e.querySelectorAll(`.av__cell[data-col-id="${t}"]`).forEach(n=>{n.remove()})},Ou=(e,t)=>{A("/api/av/duplicateAttributeViewBlock",{avID:t.getAttribute("data-av-id")},n=>{t.classList.remove("protyle-wysiwyg--select");const a=document.createElement("template");a.innerHTML=e.lute.SpinBlockDOM(`<div data-node-id="${n.data.blockID}" data-av-id="${n.data.avID}" data-type="NodeAttributeView" data-av-type="table"></div>`);const s=a.content.firstElementChild;t.after(s),ze(s,e,()=>{ne(s),He(e)}),q(e,[{action:"insert",data:s.outerHTML,id:n.data.blockID,previousID:t.dataset.nodeId}],[{action:"delete",id:n.data.blockID}])})},gl=(e,t,n)=>{if(e.getAttribute("custom-pinthead")==="true"){const a=e.querySelector("table");a.clientHeight+a.scrollTop<t.offsetTop+t.clientHeight?a.scrollTop=t.offsetTop-a.clientHeight+t.clientHeight+1:a.scrollTop>t.offsetTop-t.clientHeight&&(a.scrollTop=t.offsetTop-t.clientHeight+1)}else He(n,t)},Nn=e=>{let t=e.previousElementSibling,n=0;for(;t;)n++,t=t.previousElementSibling;return n},fr=(e,t,n=!0)=>{let a=e.previousElementSibling;return a||(e.parentElement.previousElementSibling?a=e.parentElement.previousElementSibling.lastElementChild:e.parentElement.parentElement.tagName==="TBODY"&&e.parentElement.parentElement.previousElementSibling?a=e.parentElement.parentElement.previousElementSibling.lastElementChild.lastElementChild:a=null),a&&(t.selectNodeContents(a),n||t.collapse(!1),X(t)),a},kn=(e,t,n,a,s)=>{s.insertNode(document.createElement("wbr"));const i=n.outerHTML,l=n.querySelector("table"),o=l.rows[0].cells.length,r=l.rows.length,c=[];for(let d=0;d<r;d++){for(let u=0;u<o;u++)l.rows[d].cells[u].isSameNode(t[c.length])&&c.push(u);if(c.length>0)break}for(let d=0;d<r;d++)c.forEach(u=>{l.rows[d].cells[u].setAttribute("align",a)});K(e,n.getAttribute("data-node-id"),n.outerHTML,i),ue(l,s)},pl=(e,t,n,a)=>{const s=document.createElement("wbr");t.insertNode(s);const i=a.outerHTML;s.remove();let l="";for(let r=0;r<n.parentElement.childElementCount;r++)l+=`<td align="${n.parentElement.children[r].getAttribute("align")||""}"></td>`;let o;if(n.tagName==="TH"){const r=a.querySelector("tbody");r?(r.insertAdjacentHTML("afterbegin",`<tr>${l}</tr>`),o=r.firstElementChild):(n.parentElement.parentElement.insertAdjacentHTML("afterend",`<tbody><tr>${l}</tr></tbody>`),o=n.parentElement.parentElement.nextElementSibling.firstElementChild)}else n.parentElement.insertAdjacentHTML("afterend",`<tr>${l}</tr>`),o=n.parentElement.nextElementSibling;t.selectNodeContents(o.cells[Nn(n)]),t.collapse(!0),X(t),K(e,a.getAttribute("data-node-id"),a.outerHTML,i),gl(a,o,e)},gr=(e,t,n,a)=>{const s=document.createElement("wbr");t.insertNode(s);const i=a.outerHTML;s.remove();let l="",o=!1;for(let c=0;c<n.parentElement.childElementCount;c++){const d=n.parentElement.children[c];d.className==="fn__none"&&(o=!0),n.tagName==="TH"?l+=`<th class="${d.className}" colspan="${d.colSpan}" align="${d.getAttribute("align")}"></th>`:l+=`<td class="${d.className}" colspan="${d.colSpan}" align="${d.getAttribute("align")}"></td>`}if(o){let c=n.parentElement.previousElementSibling,d=1;for(;c;)d++,Array.from(c.children).forEach(u=>{u.rowSpan>=d&&u.rowSpan>1&&(u.rowSpan=u.rowSpan+1)}),c=c.previousElementSibling}let r;n.parentElement.parentElement.tagName==="THEAD"&&!n.parentElement.previousElementSibling?(n.parentElement.parentElement.insertAdjacentHTML("beforebegin",`<thead><tr>${l}</tr></thead>`),r=a.querySelector("thead tr"),n.parentElement.parentElement.nextElementSibling.insertAdjacentHTML("afterbegin",n.parentElement.parentElement.innerHTML),n.parentElement.parentElement.remove()):(n.parentElement.insertAdjacentHTML("beforebegin",`<tr>${l}</tr>`),r=n.parentElement.previousElementSibling),t.selectNodeContents(r.cells[Nn(n)]),t.collapse(!0),X(t),K(e,a.getAttribute("data-node-id"),a.outerHTML,i),gl(a,r,e)},os=(e,t,n,a,s)=>{const i=document.createElement("wbr");s.insertNode(i);const l=t.outerHTML;i.remove();const o=Nn(n),r=t.querySelector("table");for(let c=0;c<r.rows.length;c++){const d=r.rows[c].cells[o],u=document.createElement(d.tagName);d.insertAdjacentElement(a,u),d.isSameNode(n)?(u.innerHTML="<wbr> ",u.offsetLeft+u.clientWidth>t.firstElementChild.scrollLeft+t.firstElementChild.clientWidth&&(t.firstElementChild.scrollLeft=u.offsetLeft+u.clientWidth-t.firstElementChild.clientWidth)):u.textContent=" "}r.querySelectorAll("col")[o].insertAdjacentHTML(a,"<col>"),ue(t,s),K(e,t.getAttribute("data-node-id"),t.outerHTML,l)},pr=(e,t,n,a)=>{if(n.parentElement.parentElement.tagName!=="THEAD"){const s=document.createElement("wbr");t.insertNode(s);const i=a.outerHTML;s.remove();const l=Nn(n),o=n.parentElement.parentElement;let r=o.previousElementSibling.lastElementChild;n.parentElement.previousElementSibling&&(r=n.parentElement.previousElementSibling),o.childElementCount===1?o.remove():n.parentElement.remove(),t.selectNodeContents(r.cells[l]),t.collapse(!0),X(t),gl(a,r,e),K(e,a.getAttribute("data-node-id"),a.outerHTML,i)}},mr=(e,t,n,a)=>{var s;const i=document.createElement("wbr");t.insertNode(i);const l=n.outerHTML;i.remove();const o=Nn(a),r=a.previousElementSibling||a.nextElementSibling;if(r)t.selectNodeContents(r),t.collapse(!0),r.offsetLeft+r.clientWidth>n.firstElementChild.scrollLeft+n.firstElementChild.clientWidth&&(n.firstElementChild.scrollLeft=r.offsetLeft+r.clientWidth-n.firstElementChild.clientWidth);else{n.classList.add("protyle-wysiwyg--select"),ln(e,n,t,"remove");return}const c=n.querySelector("table");for(let d=0;d<c.rows.length;d++){const u=c.rows[d].cells;if(u.length===1){c.remove();break}u[o].remove()}(s=n.querySelectorAll("col")[o])==null||s.remove(),K(e,n.getAttribute("data-node-id"),n.outerHTML,l),X(t)},br=(e,t,n,a)=>{const s=n.parentElement;if(s.parentElement.tagName==="THEAD")return;t.insertNode(document.createElement("wbr"));const i=a.outerHTML;if(s.previousElementSibling)s.after(s.previousElementSibling);else{const l=s.parentElement.previousElementSibling.firstElementChild;l.querySelectorAll("th").forEach(o=>{const r=document.createElement("td");r.innerHTML=o.innerHTML,o.parentNode.replaceChild(r,o)}),s.querySelectorAll("td").forEach(o=>{const r=document.createElement("th");r.innerHTML=o.innerHTML,o.parentNode.replaceChild(r,o)}),s.after(l),s.parentElement.previousElementSibling.append(s)}K(e,a.getAttribute("data-node-id"),a.outerHTML,i),ue(a,t),He(e,s)},yr=(e,t,n,a)=>{const s=n.parentElement;if(s.parentElement.tagName==="TBODY"&&!s.nextElementSibling||s.parentElement.tagName==="THEAD"&&!s.parentElement.nextElementSibling)return;t.insertNode(document.createElement("wbr"));const i=a.outerHTML;if(s.nextElementSibling)s.before(s.nextElementSibling);else{const l=s.parentElement.nextElementSibling.firstElementChild;l.querySelectorAll("td").forEach(o=>{const r=document.createElement("th");r.innerHTML=o.innerHTML,o.parentNode.replaceChild(r,o)}),s.querySelectorAll("th").forEach(o=>{const r=document.createElement("td");r.innerHTML=o.innerHTML,o.parentNode.replaceChild(r,o)}),s.after(l),s.parentElement.nextElementSibling.insertAdjacentElement("afterbegin",s)}K(e,a.getAttribute("data-node-id"),a.outerHTML,i),ue(a,t),He(e,s)},wr=(e,t,n,a)=>{if(!n.previousElementSibling)return;t.insertNode(document.createElement("wbr"));const s=a.outerHTML;let i=0;Array.from(n.parentElement.children).find((o,r)=>{if(n.isSameNode(o))return i=r,!0}),a.querySelectorAll("tr").forEach(o=>{o.cells[i].after(o.cells[i-1])}),n.offsetLeft<a.firstElementChild.scrollLeft&&(a.firstElementChild.scrollLeft=n.offsetLeft);const l=a.querySelectorAll("col");l[i].after(l[i-1]),K(e,a.getAttribute("data-node-id"),a.outerHTML,s),ue(a,t)},hr=(e,t,n,a)=>{if(!n.nextElementSibling)return;t.insertNode(document.createElement("wbr"));const s=a.outerHTML;let i=0;Array.from(n.parentElement.children).find((o,r)=>{if(n.isSameNode(o))return i=r,!0}),a.querySelectorAll("tr").forEach(o=>{o.cells[i].before(o.cells[i+1])}),n.offsetLeft+n.clientWidth>a.firstElementChild.scrollLeft+a.firstElementChild.clientWidth&&(a.firstElementChild.scrollLeft=n.offsetLeft+n.clientWidth-a.firstElementChild.clientWidth);const l=a.querySelectorAll("col");l[i].before(l[i+1]),K(e,a.getAttribute("data-node-id"),a.outerHTML,s),ue(a,t)},Ru=(e,t,n)=>{var a,s;const i=O(n.startContainer,"TD")||O(n.startContainer,"TH"),l=B(n.startContainer);if(!i||!l)return!1;if(t.key==="Enter"&&t.shiftKey&&Ue(t)&&!t.altKey){const L=document.createElement("wbr");n.insertNode(L);const k=l.outerHTML;if(L.remove(),i&&!i.innerHTML.endsWith("<br>")&&i.insertAdjacentHTML("beforeend","<br>"),n.extractContents(),e.toolbar.getCurrentType(n).includes("code")&&n.startContainer.nodeType!==3){const C=document.createElement("br");n.startContainer.after(C),n.setStartAfter(C)}else n.insertNode(document.createElement("br"));return n.collapse(!1),He(e),K(e,l.getAttribute("data-node-id"),l.outerHTML,k),t.preventDefault(),!0}if(!l.classList.contains("protyle-wysiwyg--select")&&!$(l,"protyle-wysiwyg--select")){if(Ue(t)&&!t.shiftKey&&!t.altKey&&t.key==="Enter"){t.preventDefault();const L=i.parentElement;if(!L.nextElementSibling&&L.parentElement.tagName==="TBODY"||L.parentElement.tagName==="THEAD"&&!L.parentElement.nextElementSibling)return Rt(e,"afterend",l.getAttribute("data-node-id")),!0;let k=L.nextElementSibling;return k||(k=L.parentElement.nextElementSibling.firstChild),k&&(n.selectNodeContents(k.cells[Nn(i)]),n.collapse(!0),He(e)),!0}if(t.key==="ArrowRight"&&n.toString()===""&&!l.nextElementSibling&&i.isSameNode(l.querySelector("table").lastElementChild.lastElementChild.lastElementChild)&&Je(i,e.wysiwyg.element,n).start===i.textContent.length)return t.preventDefault(),Rt(e,"afterend",l.getAttribute("data-node-id")),!0;if(t.key==="Tab"&&Ue(t)){if(t.shiftKey)return fr(i,n),t.preventDefault(),!0;let L=i.nextElementSibling;return L||(i.parentElement.nextElementSibling?L=i.parentElement.nextElementSibling.firstElementChild:i.parentElement.parentElement.tagName==="THEAD"&&i.parentElement.parentElement.nextElementSibling?L=i.parentElement.parentElement.nextElementSibling.firstElementChild.firstElementChild:L=null),L?n.selectNodeContents(L):(pl(e,n,i,l),n.selectNodeContents(l.querySelector("tbody").lastElementChild.firstElementChild)),t.preventDefault(),!0}if(t.key==="ArrowUp"&&Ue(t)&&!t.shiftKey&&!t.altKey){const L=n.startContainer;let k;for(L.nodeType!==3&&(L.tagName==="TH"||L.tagName==="TD")?k=L.childNodes[Math.min(n.startOffset,L.childNodes.length-1)]:L.parentElement.tagName==="SPAN"?k=L.parentElement.previousElementSibling:k=L.previousElementSibling;k;){if(k.tagName==="BR"&&ut(k))return!1;k=k.previousElementSibling}const x=i.parentElement;let C=x.previousElementSibling;return C||(C=x.parentElement.previousElementSibling.lastElementChild),!C||(C==null?void 0:C.tagName)==="COL"?!1:(n.selectNodeContents(C.cells[Nn(i)]),n.collapse(!1),He(e),t.preventDefault(),!0)}if(t.key==="ArrowDown"&&Ue(t)&&!t.shiftKey&&!t.altKey){const L=n.endContainer;let k;for(L.nodeType!==3&&(L.tagName==="TH"||L.tagName==="TD")?k=(a=L.childNodes[Math.max(0,n.endOffset-1)])==null?void 0:a.nextElementSibling:L.parentElement.tagName==="SPAN"?k=L.parentElement.nextElementSibling:k=L.nextElementSibling;k;){if(k.tagName==="BR"&&k.nextSibling)return!1;k=k.nextElementSibling}const x=i.parentElement;if(!x.nextElementSibling&&x.parentElement.tagName==="TBODY"||x.parentElement.tagName==="THEAD"&&!x.parentElement.nextElementSibling)return!1;let C=x.nextElementSibling;return C||(C=x.parentElement.nextElementSibling.firstChild),C?(n.selectNodeContents(C.cells[Nn(i)]),n.collapse(!0),He(e),t.preventDefault(),!0):!1}if(Ue(t)&&!t.shiftKey&&!t.altKey&&t.key==="Backspace"&&Je(i,e.wysiwyg.element,n).start===0&&n.toString()===""&&(n.startOffset===0||n.startOffset===1&&i.querySelectorAll("br").length===1))return!fr(i,n,!1)&&l.previousElementSibling&&ne(l.previousElementSibling,void 0,!1),He(e),t.preventDefault(),!0;if(te(window.siyuan.config.keymap.editor.general.alignLeft.custom,t))return kn(e,[i],l,"left",n),t.preventDefault(),!0;if(te(window.siyuan.config.keymap.editor.general.alignCenter.custom,t))return kn(e,[i],l,"center",n),t.preventDefault(),!0;if(te(window.siyuan.config.keymap.editor.general.alignRight.custom,t))return kn(e,[i],l,"right",n),t.preventDefault(),!0}const o=l.querySelector("table"),r=i.parentElement.querySelector(".fn__none");let c=!1,d=!1;Array.from(i.parentElement.children).forEach(L=>{L.colSpan>1&&(c=!0),L.rowSpan>1&&(d=!0)});let u=!1,p=!1,g=!1,m=i.parentElement.previousElementSibling;!m&&i.parentElement.parentElement.tagName==="TBODY"&&(m=o.querySelector("thead").lastElementChild),m&&(u=m.querySelector(".fn__none"),Array.from(m.children).forEach(L=>{L.colSpan>1&&(p=!0),L.rowSpan>1&&(g=!0)}));let b=!1,y=!1,_=!1,w=i.parentElement.nextElementSibling;!w&&i.parentElement.parentElement.tagName==="THEAD"&&(w=(s=o.querySelector("tbody"))==null?void 0:s.firstElementChild),w&&(b=w.querySelector(".fn__none"),Array.from(w.children).forEach(L=>{L.colSpan>1&&(y=!0),L.rowSpan>1&&(_=!0)}));const v=Nn(i);let h=!0;Array.from(o.rows).find(L=>{const k=L.cells[v];if(k.classList.contains("fn__none")||k.colSpan>1||k.rowSpan>1)return h=!1,!0});let E=!0;Array.from(o.rows).find(L=>{const k=L.cells[v+1];if(k&&(k.classList.contains("fn__none")||k.colSpan>1||k.rowSpan>1))return E=!1,!0});let S=!0;if(Array.from(o.rows).find(L=>{const k=L.cells[v-1];if(k&&(k.classList.contains("fn__none")||k.colSpan>1||k.rowSpan>1))return S=!1,!0}),te(window.siyuan.config.keymap.editor.table.moveToUp.custom,t))return(!r||r&&!d&&c)&&(!u||u&&!g&&p)&&br(e,n,i,l),t.preventDefault(),!0;if(te(window.siyuan.config.keymap.editor.table.moveToDown.custom,t))return(!r||r&&!d&&c)&&(!b||b&&!_&&y)&&yr(e,n,i,l),t.preventDefault(),!0;if(te(window.siyuan.config.keymap.editor.table.moveToLeft.custom,t))return h&&S&&wr(e,n,i,l),t.preventDefault(),!0;if(te(window.siyuan.config.keymap.editor.table.moveToRight.custom,t))return h&&E&&hr(e,n,i,l),t.preventDefault(),!0;if(te(window.siyuan.config.keymap.editor.table.insertRowAbove.custom,t))return gr(e,n,i,l),t.preventDefault(),t.stopPropagation(),!0;if(te(window.siyuan.config.keymap.editor.table.insertRowBelow.custom,t))return(!b||b&&!_&&y)&&pl(e,n,i,l),t.preventDefault(),!0;if(te(window.siyuan.config.keymap.editor.table.insertColumnLeft.custom,t))return(h||S)&&os(e,l,i,"beforebegin",n),t.preventDefault(),!0;if(te(window.siyuan.config.keymap.editor.table.insertColumnRight.custom,t))return(h||E)&&os(e,l,i,"afterend",n),t.preventDefault(),!0;if(te(window.siyuan.config.keymap.editor.table["delete-row"].custom,t))return(!r&&!d||r&&!d&&c)&&pr(e,n,i,l),t.preventDefault(),t.stopPropagation(),!0;if(te(window.siyuan.config.keymap.editor.table["delete-column"].custom,t))return h&&mr(e,n,l,i),t.preventDefault(),!0},_r=(e,t)=>{var n;if(!t)return;const a=t.querySelector(".table__select"),s=[],i=t.firstElementChild.scrollLeft;if(t.querySelectorAll("th, td").forEach(o=>{!o.classList.contains("fn__none")&&o.offsetLeft+6>a.offsetLeft+i&&o.offsetLeft+o.clientWidth-6<a.offsetLeft+i+a.clientWidth&&o.offsetTop+6>a.offsetTop&&o.offsetTop+o.clientHeight-6<a.offsetTop+a.clientHeight&&s.push(o)}),a.removeAttribute("style"),getSelection().rangeCount>0){const o=getSelection().getRangeAt(0);t.contains(o.startContainer)&&o.insertNode(document.createElement("wbr"))}const l=t.outerHTML;(n=t.querySelector("wbr"))==null||n.remove(),t.setAttribute("updated",U().format("YYYYMMDDHHmmss")),s.forEach(o=>{o.innerHTML=""}),K(e,t.getAttribute("data-node-id"),t.outerHTML,l)},rs=(e,t="outerHTML")=>{if(!e.querySelector("[data-type='block-render']"))return e[t];const n=e.cloneNode(!0);return n.querySelectorAll("span[data-render='1'][data-type='block-render']").forEach(a=>{a.innerHTML="",a.setAttribute("data-render","2")}),n[t]},Bu=e=>{const t=document.createElement("template");return t.innerHTML=e,t.content.querySelectorAll('[contenteditable="false"][spellcheck]').forEach(n=>{$(n,"protyle-wysiwyg__embed")||n.setAttribute("contenteditable","true")}),t.innerHTML},cs=(e,t,n)=>{if(H())return;const a=t.getBoundingClientRect();if(a.height===0||!e){un();return}const s=document.getElementById("tooltip");s.className=n?`tooltip tooltip--${n}`:"tooltip",s.innerHTML=e,s.removeAttribute("style");const i=t.getAttribute("data-position"),l=t.parentElement.getBoundingClientRect();let o,r;if(i==="parentE")r=Math.max(0,l.top-(s.clientHeight-l.height)/2),r>window.innerHeight-s.clientHeight&&(r=window.innerHeight-s.clientHeight),o=l.right+8,o+s.clientWidth>window.innerWidth&&(o=l.left-s.clientWidth-8);else if(i==="parentW")r=Math.max(0,l.top-(s.clientHeight-l.height)/2),r>window.innerHeight-s.clientHeight&&(r=window.innerHeight-s.clientHeight),o=l.left-s.clientWidth,o<0&&(o=l.right);else if(i!=null&&i.endsWith("west")){const c=parseInt(i)||.5;r=Math.max(0,a.top-(s.clientHeight-a.height)/2),r>window.innerHeight-s.clientHeight&&(r=window.innerHeight-s.clientHeight),o=a.left-s.clientWidth-c,o<0&&(o=a.right)}else if(i==="north")o=Math.max(0,a.left-(s.clientWidth-a.width)/2),r=a.top-s.clientHeight-.5,r<0&&(a.top<window.innerHeight-a.bottom?(r=a.bottom+.5,s.style.maxHeight=window.innerHeight-r+"px"):(r=0,s.style.maxHeight=a.top-.5+"px")),o+s.clientWidth>window.innerWidth&&(o=window.innerWidth-s.clientWidth);else{const c=parseInt(i)||.5;o=Math.max(0,a.left-(s.clientWidth-a.width)/2),r=a.bottom+c,r+s.clientHeight>window.innerHeight&&(a.top-c>window.innerHeight-r?(r=a.top-c-s.clientHeight,s.style.maxHeight=a.top-c+"px"):s.style.maxHeight=window.innerHeight-r+"px"),o+s.clientWidth>window.innerWidth&&(o=window.innerWidth-s.clientWidth)}s.style.top=r+"px",s.style.left=o+"px"},un=()=>{document.getElementById("tooltip").classList.add("fn__none")},ki=(e,t)=>/\r\n|\r|\n|\u2028|\u2029|\t|\//.test(e)?(t?cs(window.siyuan.languages.fileNameRule,t,"error"):ae(window.siyuan.languages.fileNameRule),!1):e.length>f.SIZE_TITLE?(t?cs(window.siyuan.languages._kernel[106],t,"error"):ae(window.siyuan.languages._kernel[106]),!1):!0,Pn=e=>e.replace(/\r\n|\r|\n|\u2028|\u2029|\t|\//g,"").substring(0,f.SIZE_TITLE),bm=e=>e.replace(/\\\\|\/|"|:|\*|\?|\\|'|<|>|\|/g,""),vr=e=>{if(window.siyuan.config.readonly)return;const t=new we({title:window.siyuan.languages.rename,content:`<div class="b3-dialog__content"><input class="b3-text-field fn__block" value=""></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:H()?"92vw":"520px",destroyCallback(){e.range&&X(e.range)}});t.element.setAttribute("data-key",f.DIALOG_RENAME);const n=t.element.querySelector("input"),a=t.element.querySelectorAll(".b3-button");t.bindInput(n,()=>{a[1].click()}),n.value=Lute.UnEscapeHTMLStr(e.name),n.focus(),n.select(),a[0].addEventListener("click",()=>{t.destroy()}),a[1].addEventListener("click",()=>{if(!ki(n.value))return!1;if(n.value===e.name)return t.destroy(),!1;n.value.trim()===""?n.value=window.siyuan.languages.untitled:n.value=Pn(n.value),e.type==="notebook"?A("/api/notebook/renameNotebook",{notebook:e.notebookId,name:n.value},()=>{pu(e.notebookId,n.value)}):A("/api/filetree/renameDoc",{notebook:e.notebookId,path:e.path,title:n.value}),t.destroy()})},ds=e=>{const t=new we({title:window.siyuan.languages.rename,content:`<div class="b3-dialog__content"><input class="b3-text-field fn__block" value=""></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:H()?"92vw":"520px"});t.element.setAttribute("data-key",f.DIALOG_RENAMEASSETS);const n=t.element.querySelector("input"),a=t.element.querySelectorAll(".b3-button");t.bindInput(n,()=>{a[1].click()});const s=ll(e);n.value=s,n.focus(),n.select(),a[0].addEventListener("click",()=>{t.destroy()}),a[1].addEventListener("click",()=>{if(n.value===s||!n.value)return t.destroy(),!1;A("/api/asset/renameAsset",{oldPath:e,newName:n.value},i=>{ba().forEach(l=>{l.reload(!1)}),t.destroy()})})},Uu=e=>{if(getSelection().rangeCount===0)return;const t=getSelection().getRangeAt(0),n=B(t.startContainer);if(!n)return;let a=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));a.length===0&&(a=[n]);let s="",i=t.toString();if(i===""){if(i=a[0].textContent,a.forEach(l=>{s+=rs(l)}),!i)return}else{const l=document.createElement("div");l.appendChild(t.cloneContents()),s=l.innerHTML}i.length>10&&(i=i.substr(0,10)+"..."),i=Pn(i),A("/api/filetree/createDoc",{notebook:e.notebookId,path:me().join(ct(e.path,!1,!0),Lute.NewNodeID()+".sy"),title:i,md:e.lute.BlockDOM2StdMd(s)})},ym=(e,t)=>{},Yu=e=>{const t=new we({title:window.siyuan.languages.exportAsImage,content:`<div class="b3-dialog__content" style="${H()?"padding:8px;":""};background-color: var(--b3-theme-background)">
    <div style="${H()?"padding: 16px;margin: 8px 0":"padding: 48px;margin: 8px 0"};" class="export-img">
        <div class="protyle-wysiwyg${window.siyuan.config.editor.displayBookmarkIcon?" protyle-wysiwyg--attr":""}"></div>
        <div class="export-img__watermark"></div>
    </div>
</div>
<div class="b3-dialog__action">
    <label class="fn__flex">
        ${window.siyuan.languages.exportPDF5}
        <span class="fn__space"></span>
        <input id="keepFold" class="b3-switch fn__flex-center" type="checkbox" ${window.siyuan.storage[f.LOCAL_EXPORTIMG].keepFold?"checked":""}>
    </label>
    <label class="fn__flex" style="margin-left: 24px">
        ${window.siyuan.languages.export30}
        <span class="fn__space"></span>
        <input id="watermark" class="b3-switch fn__flex-center" type="checkbox" ${window.siyuan.storage[f.LOCAL_EXPORTIMG].watermark?"checked":""}>
    </label>
    <span class="fn__flex-1 export-img__space"></span>
    <button disabled class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button disabled class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>
 <div class="fn__loading"><img height="128px" width="128px" src="stage/loading-pure.svg"></div>`,width:H()?"92vw":"990px",height:"70vh"});t.element.setAttribute("data-key",f.DIALOG_EXPORTIMAGE);const n=t.element.querySelectorAll(".b3-button");n[0].addEventListener("click",()=>{t.destroy()}),n[1].addEventListener("click",()=>{const r=ae(window.siyuan.languages.exporting,0);t.element.querySelector(".b3-dialog__container").style.height="",Ae(f.LOCAL_EXPORTIMG,window.siyuan.storage[f.LOCAL_EXPORTIMG]),setTimeout(()=>{Re("/stage/protyle/js/html2canvas.min.js?v=1.4.1","protyleHtml2canvas").then(()=>{window.html2canvas(t.element.querySelector(".b3-dialog__content"),{useCORS:!0}).then(c=>{c.toBlob(d=>{const u=new FormData;u.append("file",d,n[1].getAttribute("data-title")),u.append("type","image/png"),A("/api/export/exportAsFile",u,p=>{Et(p.data.file)}),tt(r),t.destroy()})})})},f.TIMEOUT_LOAD)});const a=t.element.querySelector(".protyle-wysiwyg"),s=t.element.querySelector("#keepFold");s.addEventListener("change",()=>{n[0].setAttribute("disabled","disabled"),n[1].setAttribute("disabled","disabled"),n[1].parentElement.insertAdjacentHTML("afterend",'<div class="fn__loading"><img height="128px" width="128px" src="stage/loading-pure.svg"></div>'),window.siyuan.storage[f.LOCAL_EXPORTIMG].keepFold=s.checked,A("/api/export/exportPreviewHTML",{id:e,keepFold:s.checked,image:!0},r=>{o(r)})});const i=t.element.querySelector("#watermark");i.addEventListener("change",()=>{window.siyuan.storage[f.LOCAL_EXPORTIMG].watermark=i.checked,i.checked&&!zn()&&(i.checked=!1,ae(window.siyuan.languages._kernel[214])),l()});const l=()=>{if(!zn())return;const r=t.element.querySelector(".export-img__watermark");r.innerHTML="",i.checked?window.siyuan.config.export.imageWatermarkDesc?r.innerHTML=window.siyuan.config.export.imageWatermarkDesc:window.siyuan.config.export.imageWatermarkStr&&(window.siyuan.config.export.imageWatermarkStr.startsWith("http")?r.setAttribute("style",`background-image: url(${window.siyuan.config.export.imageWatermarkStr});background-repeat: repeat;position: absolute;top: 0;left: 0;width: 100%;height: 100%;border-radius: var(--b3-border-radius-b);`):Re("/stage/protyle/js/html2canvas.min.js?v=1.4.1","protyleHtml2canvas").then(()=>{const c=Math.max(t.element.querySelector(".export-img").clientWidth/3,150);r.setAttribute("style",`width: ${c}px;height: ${c}px;display: flex;justify-content: center;align-items: center;color: var(--b3-border-color);font-size: 14px;`),r.innerHTML=`<div style="transform: rotate(-45deg)">${window.siyuan.config.export.imageWatermarkStr}</div>`,window.html2canvas(r,{useCORS:!0,scale:1}).then(d=>{r.innerHTML="",r.setAttribute("style",`background-image: url(${d.toDataURL("image/png")});background-repeat: repeat;position: absolute;top: 0;left: 0;width: 100%;height: 100%;border-radius: var(--b3-border-radius-b);`)})})):r.removeAttribute("style")},o=r=>{a.innerHTML=r.data.content,a.querySelectorAll('[data-type~="mark"], [data-type~="u"], [data-type~="text"], [data-type~="code"], [data-type~="tag"], [data-type~="kbd"]').forEach(c=>{c.childNodes.forEach(d=>{let u="";Array.from(d.textContent).forEach(g=>{u+=`<span style="${c.getAttribute("style")||""};border-radius: 0;padding-left: 0;padding-right: 0;box-shadow: none;border-left:0;border-right:0;border-top:0" data-type="${c.getAttribute("data-type")}">${g}</span>`});const p=document.createElement("template");p.innerHTML=u,d.after(p.content),d.remove()}),c.childNodes.length>0&&(c.setAttribute("style",""),c.setAttribute("data-type",c.getAttribute("data-type").replace(/mark|u|text|code|tag|kbd/g,"")))}),a.setAttribute("data-doc-type",r.data.type||"NodeDocument"),r.data.attrs.memo&&a.setAttribute("memo",r.data.attrs.memo),r.data.attrs.name&&a.setAttribute("name",r.data.attrs.name),r.data.attrs.bookmark&&a.setAttribute("bookmark",r.data.attrs.bookmark),r.data.attrs.alias&&a.setAttribute("alias",r.data.attrs.alias),a.querySelectorAll(".code-block").forEach(c=>{c.setAttribute("linewrap","true")}),Ze(a),Pe(a),a.querySelectorAll("table").forEach(c=>{c.clientWidth>c.parentElement.clientWidth&&(c.setAttribute("style",`margin-bottom:${c.parentElement.clientWidth*c.clientHeight/c.clientWidth-c.parentElement.clientHeight+1}px;transform: scale(${c.parentElement.clientWidth/c.clientWidth});transform-origin: top left;`),c.parentElement.style.overflow="hidden")}),a.querySelectorAll(".li > .protyle-action > svg").forEach(c=>{const d=c.firstElementChild.getAttribute("xlink:href"),u=document.querySelectorAll(d);let p="0 0 32 32";d==="#iconDot"&&(p="0 0 20 20"),c.setAttribute("viewBox",p),c.innerHTML=u[u.length-1].innerHTML}),a.querySelectorAll(".img img").forEach(c=>{const d=c.getAttribute("src");d.endsWith(".svg")?so(c.src,u=>{c.src=`data:image/svg+xml;base64,${btoa(unescape(encodeURIComponent(u)))}`}):d.startsWith("assets/")&&(c.src=location.origin+"/"+d)}),l(),n[0].removeAttribute("disabled"),n[1].removeAttribute("disabled"),t.element.querySelector(".fn__loading").remove()};A("/api/export/exportPreviewHTML",{id:e,keepFold:s.checked,image:!0},r=>{o(r),n[1].setAttribute("data-title",r.data.name+".png")})};var Fu=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{o(n.next(r))}catch(c){s(c)}},l=r=>{try{o(n.throw(r))}catch(c){s(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,l);o((n=n.apply(e,t)).next())});const Ra=(e,t,n)=>{if(!e){t.innerHTML="";return}A("/api/template/render",{id:n,path:e,preview:!0},a=>{t.innerHTML=`<div class="protyle-wysiwyg" style="padding: 8px">${a.data.content.replace(/contenteditable="true"/g,"")}</div>`})},kr=(e,t,n=!0)=>{if(!e.getAttribute("data-type")||!t.getAttribute("data-type"))return!1;e.setAttribute("data-type",e.getAttribute("data-type").replace("search-mark","").trim()),t.setAttribute("data-type",t.getAttribute("data-type").replace("search-mark","").trim());const a=e.attributes;let s=!0;for(let i=0;i<a.length;i++)t.getAttribute(a[i].name)!==a[i].value&&(s=!1);return s&&(n?e.innerHTML=e.innerHTML+t.innerHTML:e.innerHTML=t.innerHTML+e.innerHTML,t.remove()),s},Er=e=>{let t=e.previousSibling;for(;t&&t.nodeType!==3&&kr(e,t,!1);)t=e.previousSibling;let n=e.nextSibling;for(;n&&n.nodeType!==3&&kr(e,n);)n=e.nextSibling;(e.getAttribute("data-type")||"").includes("search-mark")&&e.setAttribute("data-type",e.getAttribute("data-type").replace("search-mark","").trim())},ml=(e,t,n)=>{const a=e.getAttribute("data-type").split(" ");if(a.length===1){const s=e.parentElement;e.outerHTML=e.innerHTML.replace(f.ZWSP,"")+"<wbr>",n&&ue(s,n)}else a.find((s,i)=>{if(t===s)return a.splice(i,1),!0}),e.setAttribute("data-type",a.join(" ")),t==="a"?e.removeAttribute("data-href"):t==="file-annotation-ref"?e.removeAttribute("data-id"):t==="block-ref"&&(e.removeAttribute("data-id"),e.removeAttribute("data-subtype")),n&&(n.selectNodeContents(e),n.collapse(!1),X(n))},us=e=>{const t=[{name:"block-ref",hotkey:window.siyuan.config.keymap.editor.insert.ref.custom,lang:"ref",icon:"iconRef",tipPosition:"ne"},{name:"a",hotkey:window.siyuan.config.keymap.editor.insert.link.custom,lang:"link",icon:"iconLink",tipPosition:"n"},{name:"strong",lang:"bold",hotkey:window.siyuan.config.keymap.editor.insert.bold.custom,icon:"iconBold",tipPosition:"n"},{name:"em",lang:"italic",hotkey:window.siyuan.config.keymap.editor.insert.italic.custom,icon:"iconItalic",tipPosition:"n"},{name:"u",lang:"underline",hotkey:window.siyuan.config.keymap.editor.insert.underline.custom,icon:"iconUnderline",tipPosition:"n"},{name:"s",lang:"strike",hotkey:window.siyuan.config.keymap.editor.insert.strike.custom,icon:"iconStrike",tipPosition:"n"},{name:"mark",lang:"mark",hotkey:window.siyuan.config.keymap.editor.insert.mark.custom,icon:"iconMark",tipPosition:"n"},{name:"sup",lang:"sup",hotkey:window.siyuan.config.keymap.editor.insert.sup.custom,icon:"iconSup",tipPosition:"n"},{name:"sub",lang:"sub",hotkey:window.siyuan.config.keymap.editor.insert.sub.custom,icon:"iconSub",tipPosition:"n"},{name:"kbd",lang:"kbd",hotkey:window.siyuan.config.keymap.editor.insert.kbd.custom,icon:"iconKeymap",tipPosition:"n"},{name:"tag",lang:"tag",hotkey:window.siyuan.config.keymap.editor.insert.tag.custom,icon:"iconTags",tipPosition:"n"},{name:"code",lang:"inline-code",hotkey:window.siyuan.config.keymap.editor.insert["inline-code"].custom,icon:"iconInlineCode",tipPosition:"n"},{name:"inline-math",lang:"inline-math",hotkey:window.siyuan.config.keymap.editor.insert["inline-math"].custom,icon:"iconMath",tipPosition:"n"},{name:"inline-memo",lang:"memo",hotkey:window.siyuan.config.keymap.editor.insert.memo.custom,icon:"iconM",tipPosition:"n"},{name:"text",lang:"appearance",hotkey:window.siyuan.config.keymap.editor.insert.appearance.custom,icon:"iconFont",tipPosition:"n"},{name:"clear",lang:"clearInline",hotkey:window.siyuan.config.keymap.editor.insert.clearInline.custom,icon:"iconClear",tipPosition:"n"},{name:"|"}],n=[];return e.forEach(a=>{let s=a;t.find(i=>{if(typeof a=="string"&&i.name===a)return s=i,!0;if(typeof a=="object"&&i.name===a.name)return s=Object.assign({},i,a),!0}),n.push(s)}),n},La=(e,t)=>Fu(void 0,null,function*(){let n="";for(let a=0;a<e.length;a++){const s=e[a];if(e.length>1&&(n+="* "),t==="ref"){const i=yield Ye("/api/block/getRefText",{id:s});n+=`((${s} '${i.data}'))`}else if(t==="blockEmbed")n+=`{{select * from blocks where id='${s}'}}`;else if(t==="protocol")n+=`siyuan://blocks/${s}`;else if(t==="protocolMd"){const i=yield Ye("/api/block/getRefText",{id:s});n+=`[${i.data}](siyuan://blocks/${s})`}else if(t==="hPath"){const i=yield Ye("/api/filetree/getHPathByID",{id:s});n+=i.data}else t==="id"&&(n+=s);e.length>1&&a!==e.length-1&&(n+=`
`)}Be(n)});var Wu=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{o(n.next(r))}catch(c){s(c)}},l=r=>{try{o(n.throw(r))}catch(c){s(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,l);o((n=n.apply(e,t)).next())});const Lr=(e,t)=>{e.addEventListener("change",()=>{A("/api/attr/setBlockAttrs",{id:t,attrs:{[e.dataset.name]:e.value}})})},ju=e=>{const t=e.getAttribute("data-node-id"),n=ye(e),a=e.getAttribute(f.CUSTOM_REMINDER_WECHAT);let s="";a&&(s=U(a).format("YYYY-MM-DD HH:mm"));const i=new we({width:H()?"92vw":"50vw",title:window.siyuan.languages.wechatReminder,content:`<div class="b3-dialog__content custom-attr">
    <div class="fn__flex">
        <span class="ft__on-surface fn__flex-center" style="text-align: right;white-space: nowrap;width: 100px">${window.siyuan.languages.notifyTime}</span>
        <div class="fn__space"></div>
        <input class="b3-text-field fn__flex-1" type="datetime-local" max="9999-12-31 23:59" value="${s}">
    </div>
    <div class="b3-label__text" style="text-align: center">${window.siyuan.languages.wechatTip}</div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.remove}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,destroyCallback(){X(n)}});i.element.setAttribute("data-key",f.DIALOG_WECHATREMINDER);const l=i.element.querySelectorAll(".b3-button");l[0].addEventListener("click",()=>{i.destroy()}),l[1].addEventListener("click",()=>{l[1].getAttribute("disabled")||(l[1].setAttribute("disabled","disabled"),A("/api/block/setBlockReminder",{id:t,timed:"0"},()=>{e.removeAttribute(f.CUSTOM_REMINDER_WECHAT),i.destroy()}))}),l[2].addEventListener("click",()=>{const o=i.element.querySelector("input").value;if(o){if(new Date(o)<=new Date){ae(window.siyuan.languages.reminderTip);return}if(l[2].getAttribute("disabled"))return;l[2].setAttribute("disabled","disabled");const r=U(o).format("YYYYMMDDHHmmss");A("/api/block/setBlockReminder",{id:t,timed:r},()=>{e.setAttribute(f.CUSTOM_REMINDER_WECHAT,r),i.destroy()})}else ae(window.siyuan.languages.notEmpty)})},Vu=e=>{A("/api/block/getDocInfo",{id:e.block.rootID},t=>{const n=t.data.ial[f.CUSTOM_REMINDER_WECHAT];let a="";n&&(a=U(n).format("YYYY-MM-DD HH:mm"));const s=new we({width:H()?"92vw":"50vw",title:window.siyuan.languages.wechatReminder,content:`<div class="b3-dialog__content custom-attr">
    <div class="fn__flex">
        <span class="ft__on-surface fn__flex-center" style="text-align: right;white-space: nowrap;width: 100px">${window.siyuan.languages.notifyTime}</span>
        <div class="fn__space"></div>
        <input class="b3-text-field fn__flex-1" type="datetime-local" max="9999-12-31 23:59" value="${a}">
    </div>
    <div class="b3-label__text" style="text-align: center">${window.siyuan.languages.wechatTip}</div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.remove}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`});s.element.setAttribute("data-key",f.DIALOG_WECHATREMINDER);const i=s.element.querySelectorAll(".b3-button");i[0].addEventListener("click",()=>{s.destroy()}),i[1].addEventListener("click",()=>{A("/api/block/setBlockReminder",{id:e.block.rootID,timed:"0"},()=>{s.destroy()})}),i[2].addEventListener("click",()=>{const l=s.element.querySelector("input").value;if(l){if(new Date(l)<=new Date){ae(window.siyuan.languages.reminderTip);return}A("/api/block/setBlockReminder",{id:e.block.rootID,timed:U(l).format("YYYYMMDDHHmmss")},()=>{s.destroy()})}else ae(window.siyuan.languages.notEmpty)})})},qn=(e,t="bookmark",n)=>{let a="",s="",i=!1;const l=getSelection().rangeCount>0?getSelection().getRangeAt(0):null;Object.keys(e).forEach(r=>{f.CUSTOM_RIFF_DECKS===r||r.startsWith("custom-sy-")||(r===f.CUSTOM_REMINDER_WECHAT?s=`<label class="b3-label b3-label--noborder">
    ${window.siyuan.languages.wechatReminder}
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__block" type="datetime-local" max="9999-12-31 23:59" readonly data-name="${r}" value="${U(e[r]).format("YYYY-MM-DD HH:mm")}">
</label>`:r.indexOf("custom-av")>-1?i=!0:r.indexOf("custom")>-1&&(a+=`<label class="b3-label b3-label--noborder">
     <div class="fn__flex">
        <span class="fn__flex-1">${r.replace("custom-","")}</span>
        <span data-action="remove" class="block__icon block__icon--show"><svg><use xlink:href="#iconMin"></use></svg></span>
    </div>
    <div class="fn__hr"></div>
    <textarea style="resize: vertical;" spellcheck="false" class="b3-text-field fn__block" rows="1" data-name="${r}">${e[r]}</textarea>
</label>`))});const o=new we({width:H()?"92vw":"50vw",containerClassName:"b3-dialog__container--theme",height:"80vh",content:`<div class="fn__flex-column">
    <div class="layout-tab-bar fn__flex" style="flex-shrink:0;border-radius: var(--b3-border-radius-b) var(--b3-border-radius-b) 0 0">
        <div class="item item--full item--focus" data-type="attr">
            <span class="fn__flex-1"></span>
            <span class="item__text">${window.siyuan.languages.builtIn}</span>
            <span class="fn__flex-1"></span>
        </div>
        <div class="item item--full${i?"":" fn__none"}" data-type="NodeAttributeView">
            <span class="fn__flex-1"></span>
            <span class="item__text">${window.siyuan.languages.database}</span>
            <span class="fn__flex-1"></span>
        </div>
        <div class="item item--full" data-type="custom">
            <span class="fn__flex-1"></span>
            <span class="item__text">${window.siyuan.languages.custom}</span>
            <span class="fn__flex-1"></span>
        </div>
    </div>
    <div class="fn__flex-1">
        <div class="custom-attr" data-type="attr">
            <label class="b3-label b3-label--noborder">
                <div class="fn__flex">
                    <span class="fn__flex-1">${window.siyuan.languages.bookmark}</span>
                    <span data-action="bookmark" class="block__icon block__icon--show"><svg><use xlink:href="#iconDown"></use></svg></span>
                </div>
                <div class="fn__hr"></div>
                <input spellcheck="${window.siyuan.config.editor.spellcheck}" class="b3-text-field fn__block" placeholder="${window.siyuan.languages.attrBookmarkTip}" data-name="bookmark">
            </label>
            <label class="b3-label b3-label--noborder">
                ${window.siyuan.languages.name}
                <div class="fn__hr"></div>
                <input spellcheck="${window.siyuan.config.editor.spellcheck}" class="b3-text-field fn__block" placeholder="${window.siyuan.languages.attrNameTip}" data-name="name">
            </label>
            <label class="b3-label b3-label--noborder">
                ${window.siyuan.languages.alias}
                <div class="fn__hr"></div>
                <input spellcheck="${window.siyuan.config.editor.spellcheck}" class="b3-text-field fn__block" placeholder="${window.siyuan.languages.attrAliasTip}" data-name="alias">
            </label>
            <label class="b3-label b3-label--noborder">
                ${window.siyuan.languages.memo}
                <div class="fn__hr"></div>
                <textarea style="resize: vertical" spellcheck="${window.siyuan.config.editor.spellcheck}" class="b3-text-field fn__block" placeholder="${window.siyuan.languages.attrMemoTip}" rows="2" data-name="memo">${e.memo||""}</textarea>
            </label>
            ${s}
        </div>
        <div data-type="NodeAttributeView" class="fn__none custom-attr"></div>
        <div data-type="custom" class="fn__none custom-attr">
           ${a}
           <div class="b3-label">
               <button data-action="addCustom" class="b3-button b3-button--cancel">
                   <svg><use xlink:href="#iconAdd"></use></svg>${window.siyuan.languages.addAttr}
               </button>
           </div>
        </div>
    </div>
</div>`,destroyCallback(){X(l),J(["select"],n)}});o.element.setAttribute("data-key",f.DIALOG_ATTR),o.element.querySelector('.b3-text-field[data-name="bookmark"]').value=e.bookmark||"",o.element.querySelector('.b3-text-field[data-name="name"]').value=e.name||"",o.element.querySelector('.b3-text-field[data-name="alias"]').value=e.alias||"",o.element.addEventListener("click",r=>{let c=r.target;for(typeof r.detail=="string"&&(c=o.element.querySelector('.item--full[data-type="NodeAttributeView"]'));!c.isSameNode(o.element);){const d=c.dataset.action;if(c.classList.contains("item--full"))c.parentElement.querySelector(".item--focus").classList.remove("item--focus"),c.classList.add("item--focus"),o.element.querySelectorAll(".custom-attr").forEach(u=>{u.dataset.type===c.dataset.type?(u.dataset.type==="NodeAttributeView"&&u.innerHTML===""&&ql(u,e.id,n),u.classList.remove("fn__none")):u.classList.add("fn__none")});else if(d==="remove"){A("/api/attr/setBlockAttrs",{id:e.id,attrs:{["custom-"+c.previousElementSibling.textContent]:""}}),c.parentElement.parentElement.remove(),r.stopPropagation(),r.preventDefault();break}else if(d==="bookmark"){A("/api/attr/getBookmarkLabels",{},u=>{window.siyuan.menus.menu.remove(),u.data.length===0?window.siyuan.menus.menu.append(new M({id:"emptyContent",iconHTML:"",label:window.siyuan.languages.emptyContent,type:"readonly"}).element):u.data.forEach(p=>{window.siyuan.menus.menu.append(new M({label:p,click(){const g=c.parentElement.parentElement.querySelector("input");g.value=p,g.dispatchEvent(new CustomEvent("change"))}}).element)}),window.siyuan.menus.menu.element.classList.add("b3-menu--list"),window.siyuan.menus.menu.popup({x:r.clientX,y:r.clientY+16,w:16})}),r.stopPropagation(),r.preventDefault();break}else if(d==="addCustom"){const u=new we({title:window.siyuan.languages.attrName,content:`<div class="b3-dialog__content"><input spellcheck="false" class="b3-text-field fn__block" value=""></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:H()?"92vw":"520px"});u.element.setAttribute("data-key",f.DIALOG_SETCUSTOMATTR);const p=u.element.querySelector("input"),g=u.element.querySelectorAll(".b3-button");u.bindInput(p,()=>{g[1].click()}),p.focus(),p.select(),g[0].addEventListener("click",()=>{u.destroy()}),g[1].addEventListener("click",()=>{if(!cn(p.value))return ae(window.siyuan.languages.attrName+" <b>"+pe(p.value)+"</b> "+window.siyuan.languages.invalid),!1;c.parentElement.insertAdjacentHTML("beforebegin",`<div class="b3-label b3-label--noborder">
    <div class="fn__flex">
        <span class="fn__flex-1">${p.value}</span>
        <span data-action="remove" class="block__icon block__icon--show"><svg><use xlink:href="#iconMin"></use></svg></span>
    </div>
    <div class="fn__hr"></div>
    <textarea style="resize: vertical" spellcheck="false" data-name="custom-${p.value}" class="b3-text-field fn__block" rows="1" placeholder="${window.siyuan.languages.attrValue1}"></textarea>
</div>`);const m=c.parentElement.previousElementSibling.querySelector(".b3-text-field");m.focus(),Lr(m,e.id),u.destroy()}),r.stopPropagation(),r.preventDefault();break}c=c.parentElement}}),o.element.querySelectorAll(".b3-text-field").forEach(r=>{t!=="av"&&t===r.getAttribute("data-name")&&r.focus(),Lr(r,e.id)}),t==="av"&&o.element.dispatchEvent(new CustomEvent("click",{detail:"av"}))},Kn=(e,t="bookmark",n)=>{if(e.getAttribute("data-type")==="NodeThematicBreak")return;const a=e.getAttribute("data-node-id");A("/api/attr/getBlockAttrs",{id:a},s=>{qn(s.data,t,n)})},Ba=(e,t=!0,n)=>[{id:"copyBlockRef",iconHTML:"",accelerator:t?window.siyuan.config.keymap.editor.general.copyBlockRef.custom:void 0,label:window.siyuan.languages.copyBlockRef,click:()=>{La(e,"ref"),n&&ne(n)}},{id:"copyBlockEmbed",iconHTML:"",label:window.siyuan.languages.copyBlockEmbed,accelerator:t?window.siyuan.config.keymap.editor.general.copyBlockEmbed.custom:void 0,click:()=>{La(e,"blockEmbed"),n&&ne(n)}},{id:"copyProtocol",iconHTML:"",label:window.siyuan.languages.copyProtocol,accelerator:t?window.siyuan.config.keymap.editor.general.copyProtocol.custom:void 0,click:()=>{La(e,"protocol"),n&&ne(n)}},{id:"copyProtocolInMd",iconHTML:"",label:window.siyuan.languages.copyProtocolInMd,accelerator:t?window.siyuan.config.keymap.editor.general.copyProtocolInMd.custom:void 0,click:()=>{La(e,"protocolMd"),n&&ne(n)}},{id:"copyHPath",iconHTML:"",label:window.siyuan.languages.copyHPath,accelerator:t?window.siyuan.config.keymap.editor.general.copyHPath.custom:void 0,click:()=>{La(e,"hPath"),n&&ne(n)}},{id:"copyID",iconHTML:"",label:window.siyuan.languages.copyID,accelerator:t?window.siyuan.config.keymap.editor.general.copyID.custom:void 0,click:()=>{La(e,"id"),n&&ne(n)}}],Sr=e=>{if(!window.siyuan.isPublish)return new M({id:"export",label:window.siyuan.languages.export,type:"submenu",icon:"iconUpload",submenu:[{id:"exportTemplate",label:window.siyuan.languages.template,iconClass:"ft__error",icon:"iconMarkdown",click:()=>Wu(void 0,null,function*(){const t=yield Ye("/api/block/getRefText",{id:e}),n=new we({title:window.siyuan.languages.fileName,content:`<div class="b3-dialog__content"><input class="b3-text-field fn__block" value=""></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:H()?"92vw":"520px"});n.element.setAttribute("data-key",f.DIALOG_EXPORTTEMPLATE);const a=n.element.querySelector("input"),s=n.element.querySelectorAll(".b3-button");n.bindInput(a,()=>{s[1].click()});let i=Pn(t.data);const l=32;i.length>l&&(i=i.substring(0,l)),a.value=i,a.focus(),a.select(),s[0].addEventListener("click",()=>{n.destroy()}),s[1].addEventListener("click",()=>{a.value.trim()===""?a.value=window.siyuan.languages.untitled:a.value=Pn(a.value),i.length>l&&(i=i.substring(0,l)),A("/api/template/docSaveAsTemplate",{id:e,name:a.value,overwrite:!1},o=>{if(o.code===1){$e(window.siyuan.languages.export,window.siyuan.languages.exportTplTip,()=>{A("/api/template/docSaveAsTemplate",{id:e,name:a.value,overwrite:!0},r=>{r.code===0&&ae(window.siyuan.languages.exportTplSucc)})});return}ae(window.siyuan.languages.exportTplSucc)}),n.destroy()})})},{id:"exportMarkdown",label:"Markdown",icon:"iconMarkdown",click:()=>{const t=ae(window.siyuan.languages.exporting,-1);A("/api/export/exportMd",{id:e},n=>{tt(t),Et(n.data.zip)})}},{id:"exportSiYuanZip",label:"SiYuan .sy.zip",icon:"iconSiYuan",click:()=>{const t=ae(window.siyuan.languages.exporting,-1);A("/api/export/exportSY",{id:e},n=>{tt(t),Et(n.data.zip)})}},{id:"exportImage",label:window.siyuan.languages.image,icon:"iconImage",click:()=>{Yu(e)}}]}).element},Ei=(e,t,n,a)=>{const s=[];if(s.push({id:ft()||yt()?"useDefault":"useBrowserView",label:ft()||yt()?window.siyuan.languages.useDefault:window.siyuan.languages.useBrowserView,accelerator:a?window.siyuan.languages.click:"",click:()=>{Et(t)}}),n)return s;window.siyuan.menus.menu.append(new M({id:"openBy",label:window.siyuan.languages.openBy,icon:"iconOpen",submenu:s}).element)},xr=e=>new M({id:"rename",accelerator:window.siyuan.config.keymap.editor.general.rename.custom,icon:"iconEdit",label:window.siyuan.languages.rename,click:()=>{vr(e)}}).element,bl=e=>new M({id:"move",label:window.siyuan.languages.move,icon:"iconMove",accelerator:window.siyuan.config.keymap.general.move.custom,click(){Wn((t,n)=>{rl(e,n[0],t[0])},e)}}).element,Ar=e=>{var t;const n=parseInt(e.getAttribute("data-subtype").substr(1));let a=e.nextElementSibling;for(;a;){const s=parseInt((t=a.getAttribute("data-subtype"))==null?void 0:t.substr(1));if(!a.classList.contains("protyle-attr")&&(isNaN(s)||s>n)){const i=a;a=a.nextElementSibling,i.remove()}else break}};class zu{constructor(){this.hasUndo=!1,this.redoStack=[],this.undoStack=[]}undo(t){if(t.disabled||this.undoStack.length===0)return;const n=this.undoStack.pop();if(this.render(t,n,!1),this.hasUndo=!0,this.redoStack.push(n),t.breadcrumb){const a=t.breadcrumb.element.parentElement.querySelector('[data-type="undo"]');a&&(this.undoStack.length===0&&a.setAttribute("disabled","true"),t.breadcrumb.element.parentElement.querySelector('[data-type="redo"]').removeAttribute("disabled"))}}redo(t){if(t.disabled||this.redoStack.length===0)return;const n=this.redoStack.pop();if(this.render(t,n,!0),this.undoStack.push(n),t.breadcrumb){const a=t.breadcrumb.element.parentElement.querySelector('[data-type="redo"]');a&&(t.breadcrumb.element.parentElement.querySelector('[data-type="undo"]').removeAttribute("disabled"),this.redoStack.length===0&&a.setAttribute("disabled","true"))}}render(t,n,a){J(["hint","gutter"],t),t.wysiwyg.lastHTMLs={},a?(n.doOperations.forEach(s=>{zl(t,s,!0)}),q(t,n.doOperations)):(n.undoOperations.forEach(s=>{zl(t,s,!0)}),q(t,n.undoOperations)),en(t),He(t)}replace(t,n){if(this.hasUndo&&this.redoStack.length>0&&(this.undoStack.push(this.redoStack.pop()),this.redoStack=[],this.hasUndo=!1,n.breadcrumb)){const a=n.breadcrumb.element.parentElement.querySelector('[data-type="redo"]');a&&a.setAttribute("disabled","true")}this.undoStack.length>0&&(this.undoStack[this.undoStack.length-1].doOperations=t)}add(t,n,a){if(this.undoStack.push({undoOperations:n,doOperations:t}),this.undoStack.length>f.SIZE_UNDO&&this.undoStack.shift(),this.hasUndo&&(this.redoStack=[],this.hasUndo=!1),a.breadcrumb){const s=a.breadcrumb.element.parentElement.querySelector('[data-type="undo"]');s&&s.removeAttribute("disabled")}}clear(){this.undoStack=[],this.redoStack=[]}}const Zn=e=>!1,Cr=(e,t,n)=>{var a,s,i,l,o,r,c,d,u;let p,g="",m=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(m.length===0){let y=Ne(t);const _=D(y,"fold","1");_&&(y=_),(a=y.previousElementSibling)!=null&&a.classList.contains("protyle-action")&&(y=Ne(y.parentElement)),m=[y]}const b=m[0].getAttribute("data-type");if(b==="NodeListItem"&&!m[0].previousElementSibling&&((i=(s=m[0].parentElement.previousElementSibling)==null?void 0:s.previousElementSibling)!=null&&i.classList.contains("protyle-action")))if((l=m[0].parentElement.parentElement.previousElementSibling)!=null&&l.classList.contains("li")){if(p=m[0].parentElement.parentElement.previousElementSibling.querySelector(".list"),n.insertNode(document.createElement("wbr")),g=m[0].parentElement.parentElement.parentElement.outerHTML,!p){const y=Lute.NewNodeID();m[0].parentElement.parentElement.previousElementSibling.lastElementChild.insertAdjacentHTML("beforebegin",`<div data-subtype="${m[0].getAttribute("data-subtype")}" data-node-id="${y}" data-type="NodeList" class="list" updated="${y.split("-")[0]}"><div id="moveTempLi"></div><div class="protyle-attr" contenteditable="false">&ZeroWidthSpace;</div></div>`),p=m[0].parentElement.parentElement.previousElementSibling.querySelector(".list")}}else return;if(b==="NodeList"&&((r=(o=m[0].previousElementSibling)==null?void 0:o.previousElementSibling)!=null&&r.classList.contains("protyle-action")))if((c=m[0].parentElement.previousElementSibling)!=null&&c.classList.contains("li")){if(p=m[0].parentElement.previousElementSibling.querySelector(".list"),n.insertNode(document.createElement("wbr")),g=m[0].parentElement.parentElement.outerHTML,!p){const y=Lute.NewNodeID();m[0].parentElement.previousElementSibling.lastElementChild.insertAdjacentHTML("beforebegin",`<div data-subtype="${m[0].getAttribute("data-subtype")}" data-node-id="${y}" data-type="NodeList" class="list" updated="${y.split("-")[0]}"><div id="moveTempLi"></div><div class="protyle-attr" contenteditable="false">&ZeroWidthSpace;</div></div>`),p=m[0].parentElement.previousElementSibling.querySelector(".list")}}else return;if(p){p=p.lastElementChild.previousElementSibling;const y=m[0].classList.contains("list")?m[0]:m[0].parentElement;m.reverse().forEach(_=>{_.classList.contains("list")?p.after(_.firstElementChild):p.after(_)}),p.id==="moveTempLi"&&(p=p.nextElementSibling,p.previousElementSibling.remove()),y.childElementCount===1?y.remove():y.getAttribute("data-subtype")==="o"&&y.classList.contains("list")&&je(y,1),p.getAttribute("data-subtype")==="o"&&je(p.parentElement),K(e,p.parentElement.parentElement.parentElement.getAttribute("data-node-id"),p.parentElement.parentElement.parentElement.outerHTML,g),en(e),He(e),ue(p.parentElement,n);return}if(!(!m[0].previousElementSibling||(d=m[0].previousElementSibling)!=null&&d.classList.contains("protyle-action"))){if(p=m[0].previousElementSibling,m[0].getAttribute("data-subtype")==="o"&&b==="NodeListItem"){const y=m[0].parentElement.outerHTML;m[m.length-1].after(p),je(m[0].parentElement,1),K(e,m[0].parentElement.getAttribute("data-node-id"),m[0].parentElement.outerHTML,y)}else{const y=p.getAttribute("data-node-id");q(e,[{action:"move",id:y,previousID:m[m.length-1].getAttribute("data-node-id")}],[{action:"move",id:y,previousID:(u=p.previousElementSibling)==null?void 0:u.getAttribute("data-node-id"),parentID:p.parentElement.getAttribute("data-node-id")||e.block.parentID}]),m[m.length-1].after(p)}en(e),He(e)}},Tr=(e,t,n)=>{var a,s,i,l,o,r,c;let d,u="",p=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(p.length===0){let m=Ne(t);const b=D(m,"fold","1");b&&(m=b),(a=m.previousElementSibling)!=null&&a.classList.contains("protyle-action")&&(m=Ne(m.parentElement)),p=[m]}const g=p[0].getAttribute("data-type");if(g==="NodeListItem"&&p[p.length-1].nextElementSibling.classList.contains("protyle-attr")&&((s=p[0].parentElement.parentElement)!=null&&s.classList.contains("li")))if((i=p[0].parentElement.parentElement.nextElementSibling)!=null&&i.classList.contains("li")){if(d=p[0].parentElement.parentElement.nextElementSibling.querySelector(".list > .li"),n.insertNode(document.createElement("wbr")),u=p[0].parentElement.parentElement.parentElement.outerHTML,!d){const m=Lute.NewNodeID();p[0].parentElement.parentElement.nextElementSibling.lastElementChild.insertAdjacentHTML("beforebegin",`<div data-subtype="${p[0].getAttribute("data-subtype")}" data-node-id="${m}" data-type="NodeList" class="list" updated="${m.split("-")[0]}"><div class="protyle-attr" contenteditable="false">&ZeroWidthSpace;</div></div>`),d=p[0].parentElement.parentElement.nextElementSibling.querySelector(".list > div")}}else return;if(g==="NodeList"&&p[p.length-1].nextElementSibling.classList.contains("protyle-attr")&&((l=p[0].parentElement)!=null&&l.classList.contains("li")))if((o=p[0].parentElement.nextElementSibling)!=null&&o.classList.contains("li")){if(d=p[0].parentElement.nextElementSibling.querySelector(".list > .li"),n.insertNode(document.createElement("wbr")),u=p[0].parentElement.parentElement.outerHTML,!d){const m=Lute.NewNodeID();p[0].parentElement.nextElementSibling.lastElementChild.insertAdjacentHTML("beforebegin",`<div data-subtype="${p[0].getAttribute("data-subtype")}" data-node-id="${m}" data-type="NodeList" class="list" updated="${m.split("-")[0]}"><div class="protyle-attr" contenteditable="false">&ZeroWidthSpace;</div></div>`),d=p[0].parentElement.nextElementSibling.querySelector(".list > div")}}else return;if(d){const m=p[0].classList.contains("list")?p[0]:p[0].parentElement;p.forEach(b=>{b.classList.contains("list")?d.before(b.firstElementChild):d.before(b)}),m.childElementCount===1?m.remove():m.getAttribute("data-subtype")==="o"&&m.classList.contains("list")&&je(m,1),d.getAttribute("data-subtype")==="o"&&je(d.parentElement,1),K(e,d.parentElement.parentElement.parentElement.getAttribute("data-node-id"),d.parentElement.parentElement.parentElement.outerHTML,u),en(e),He(e),ue(d.parentElement,n);return}if(!(!p[p.length-1].nextElementSibling||(r=p[p.length-1].nextElementSibling)!=null&&r.classList.contains("protyle-attr"))){if(d=p[p.length-1].nextElementSibling,d.getAttribute("data-subtype")==="o"&&d.getAttribute("data-type")==="NodeListItem"){const m=d.parentElement.outerHTML;p[0].before(d),je(d.parentElement,1),K(e,d.parentElement.getAttribute("data-node-id"),d.parentElement.outerHTML,m)}else{const m=d.getAttribute("data-node-id");q(e,[{action:"move",id:m,previousID:(c=p[0].previousElementSibling)==null?void 0:c.getAttribute("data-node-id"),parentID:d.parentElement.getAttribute("data-node-id")||e.block.parentID}],[{action:"move",id:m,previousID:p[p.length-1].getAttribute("data-node-id")}]),p[0].before(d)}en(e),He(e)}};class Sa{constructor(t,n){this.element=document.createElement("button");const a=n.hotkey?` ${Me(n.hotkey)}`:"",s=n.tip||window.siyuan.languages[n.lang];this.element.classList.add("protyle-toolbar__item","b3-tooltips",`b3-tooltips__${n.tipPosition}`),this.element.setAttribute("data-type",n.name),this.element.setAttribute("aria-label",s+a),this.element.innerHTML=`<svg><use xlink:href="#${n.icon}"></use></svg>`,!["text","a","block-ref","inline-math","inline-memo"].includes(n.name)&&this.element.addEventListener(wa(),i=>{i.preventDefault(),f.INLINE_TYPE.includes(n.name)?t.toolbar.setInlineMark(t,n.name,"toolbar"):n.click&&n.click(t.getInstance())})}}class Gu extends Sa{constructor(t,n){super(t,n),this.element.addEventListener("click",()=>{t.toolbar.element.classList.add("fn__none"),t.toolbar.subElement.innerHTML="",t.toolbar.subElement.style.width="",t.toolbar.subElement.style.padding="",t.toolbar.subElement.append(Ku(t,wl(t))),t.toolbar.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),t.toolbar.subElement.classList.remove("fn__none"),t.toolbar.subElementCloseCB=void 0,X(t.toolbar.range)})}}const Ku=(e,t)=>{let n="";["","var(--b3-font-color1)","var(--b3-font-color2)","var(--b3-font-color3)","var(--b3-font-color4)","var(--b3-font-color5)","var(--b3-font-color6)","var(--b3-font-color7)","var(--b3-font-color8)","var(--b3-font-color9)","var(--b3-font-color10)","var(--b3-font-color11)","var(--b3-font-color12)","var(--b3-font-color13)"].forEach(d=>{n+=`<button ${d?`class="color__square" style="color:${d}"`:`class="color__square ariaLabel" data-position="3south" aria-label="${window.siyuan.languages.default}"`} data-type="color">A</button>`});let a="";["","var(--b3-font-background1)","var(--b3-font-background2)","var(--b3-font-background3)","var(--b3-font-background4)","var(--b3-font-background5)","var(--b3-font-background6)","var(--b3-font-background7)","var(--b3-font-background8)","var(--b3-font-background9)","var(--b3-font-background10)","var(--b3-font-background11)","var(--b3-font-background12)","var(--b3-font-background13)"].forEach(d=>{a+=`<button ${d?`class="color__square" style="background-color:${d}"`:`class="color__square ariaLabel" data-position="3south" aria-label="${window.siyuan.languages.default}"`} data-type="backgroundColor"></button>`});const s=document.createElement("div");s.classList.add("protyle-font");let i=!1;t==null||t.find(d=>{if(d.classList.contains("list")||d.classList.contains("li"))return i=!0,!0});let l="";const o=window.siyuan.storage[f.LOCAL_FONTSTYLES];o.length>0&&(l=`<div class="fn__flex">
    ${window.siyuan.languages.lastUsed}
    <span class="fn__space"></span>
    <kbd class="fn__kbd fn__flex-center">${Me(window.siyuan.config.keymap.editor.insert.lastUsed.custom)}</kbd>
</div>
<div class="fn__hr--small"></div>
<div class="fn__flex fn__flex-wrap" style="align-items: center">`,o.forEach(d=>{const u=d.split(f.ZWSP);switch(u[0]){case"color":l+=`<button class="color__square ariaLabel" data-position="3south" aria-label="${window.siyuan.languages.colorFont}${u[1]?"":" "+window.siyuan.languages.default}" ${u[1]?`style="color:${u[1]}"`:""} data-type="${u[0]}">A</button>`;break;case"backgroundColor":l+=`<button class="color__square ariaLabel" data-position="3south" aria-label="${window.siyuan.languages.colorPrimary}${u[1]?"":" "+window.siyuan.languages.default}" ${u[1]?`style="background-color:${u[1]}"`:""} data-type="${u[0]}"></button>`;break;case"style2":l+=`<button data-type="${u[0]}" class="protyle-font__style" style="-webkit-text-stroke: 0.2px var(--b3-theme-on-background);-webkit-text-fill-color : transparent;">${window.siyuan.languages.hollow}</button>`;break;case"style4":l+=`<button data-type="${u[0]}" class="protyle-font__style" style="text-shadow: 1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)">${window.siyuan.languages.shadow}</button>`;break;case"fontSize":i||(l+=`<button data-type="${u[0]}" class="protyle-font__style">${u[1]}</button>`);break;case"style1":l+=`<button class="color__square ariaLabel" data-position="3south" aria-label="${window.siyuan.languages.color}${u[1]?"":" "+window.siyuan.languages.default}" ${u[1]?`style="background-color:${u[1]};color:${u[2]}"`:""} data-type="${u[0]}">A</button>`;break;case"clear":l+=`<button style="height: 26px;display: flex;align-items: center;padding: 0 5px;" data-type="${u[0]}" class="protyle-font__style ariaLabel" aria-label="${window.siyuan.languages.clearFontStyle}"><svg class="svg--mid"><use xlink:href="#iconTrashcan"></use></svg></button>`;break}}),l+="</div>");let r,c="16px";return t&&t.length>0?r=t[0]:(r=e.toolbar.range.cloneContents().querySelector('[data-type~="text"]'),r||(r=D(e.toolbar.range.startContainer,"data-type","text"))),r&&(c=r.style.fontSize||"16px"),s.innerHTML=`${l}
<div class="fn__hr"></div>
<div>${window.siyuan.languages.color}</div>
<div class="fn__hr--small"></div>
<div class="fn__flex fn__flex-wrap">
    <button class="color__square ariaLabel" data-position="3south" data-type="style1" aria-label="${window.siyuan.languages.default}">A</button>
    <button class="color__square" data-type="style1" style="color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);">A</button>
    <button class="color__square" data-type="style1" style="color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);">A</button>
    <button class="color__square" data-type="style1" style="color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);">A</button>
    <button class="color__square" data-type="style1" style="color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);">A</button>
</div>
<div class="fn__hr"></div>
<div>${window.siyuan.languages.colorFont}</div>
<div class="fn__hr--small"></div>
<div class="fn__flex fn__flex-wrap">
    ${n}
</div>
<div class="fn__hr"></div>
<div>${window.siyuan.languages.colorPrimary}</div>
<div class="fn__hr--small"></div>
<div class="fn__flex fn__flex-wrap">
    ${a}
</div>
<div class="fn__hr"></div>
<div>${window.siyuan.languages.fontStyle}</div>
<div class="fn__hr--small"></div>
<div class="fn__flex">
    <button data-type="style2" class="protyle-font__style" style="-webkit-text-stroke: 0.2px var(--b3-theme-on-background);-webkit-text-fill-color : transparent;">${window.siyuan.languages.hollow}</button>
    <button data-type="style4" class="protyle-font__style" style="text-shadow: 1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)">${window.siyuan.languages.shadow}</button>
</div>
<div class="fn__hr${i?" fn__none":""}"></div>
<div class="${i?" fn__none":""}">${window.siyuan.languages.fontSize}</div>
<div class="fn__hr--small${i?" fn__none":""}"></div>
<div class="fn__flex${i?" fn__none":""}">
    <div class="fn__space--small"></div>
    <select class="b3-select fn__block">
        <option ${c==="12px"?"selected":""} value="12px">12px</option>
        <option ${c==="13px"?"selected":""} value="13px">13px</option>
        <option ${c==="14px"?"selected":""} value="14px">14px</option>
        <option ${c==="15px"?"selected":""} value="15px">15px</option>
        <option ${c==="16px"?"selected":""} value="16px">16px</option>
        <option ${c==="19px"?"selected":""} value="19px">19px</option>
        <option ${c==="22px"?"selected":""} value="22px">22px</option>
        <option ${c==="24px"?"selected":""} value="24px">24px</option>
        <option ${c==="29px"?"selected":""} value="29px">29px</option>
        <option ${c==="32px"?"selected":""} value="32px">32px</option>
        <option ${c==="40px"?"selected":""} value="40px">40px</option>
        <option ${c==="48px"?"selected":""} value="48px">48px</option>
    </select>
    <div class="fn__space--small"></div>
</div>
<div class="fn__hr--b"></div>
<div class="fn__flex">
    <div class="fn__space--small"></div>
    <button class="b3-button b3-button--remove fn__block" data-type="clear">
        <svg><use xlink:href="#iconTrashcan"></use></svg>${window.siyuan.languages.clearFontStyle}
    </button>
    <div class="fn__space--small"></div>
</div>`,s.addEventListener("click",function(d){let u=d.target;for(;u&&!u.isEqualNode(s);){const p=u.getAttribute("data-type");if(u.tagName==="BUTTON"){p==="style1"?an(e,t,p,u.style.backgroundColor+f.ZWSP+u.style.color):p==="fontSize"?an(e,t,p,u.textContent.trim()):p==="backgroundColor"?an(e,t,p,u.style.backgroundColor):p==="color"?an(e,t,p,u.style.color):an(e,t,p);break}u=u.parentElement}}),s.querySelector("select").addEventListener("change",function(d){an(e,t,"fontSize",d.target.value)}),s},an=(e,t,n,a)=>{let s=window.siyuan.storage[f.LOCAL_FONTSTYLES];if(n)s.splice(0,0,`${n}${f.ZWSP}${a}`),s=[...new Set(s)],s.length>8&&s.splice(8,1),window.siyuan.storage[f.LOCAL_FONTSTYLES]=s,Ae(f.LOCAL_FONTSTYLES,window.siyuan.storage[f.LOCAL_FONTSTYLES]);else if(s.length===0)n="style1",a="var(--b3-card-error-color)"+f.ZWSP+"var(--b3-card-error-background)";else{const i=s[0].split(f.ZWSP);n=i.splice(0,1)[0],a=i.join(f.ZWSP)}t&&t.length>0?(ra(t,e,i=>{if(n==="clear")i.style.color="",i.style.webkitTextFillColor="",i.style.webkitTextStroke="",i.style.textShadow="",i.style.backgroundColor="",i.style.fontSize="",i.style.removeProperty("--b3-parent-background");else if(n==="style1"){const l=a.split(f.ZWSP);i.style.backgroundColor=l[0],i.style.color=l[1],i.style.setProperty("--b3-parent-background",l[0])}else n==="style2"?(i.style.webkitTextStroke="0.2px var(--b3-theme-on-background)",i.style.webkitTextFillColor="transparent"):n==="style4"?i.style.textShadow="1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)":n==="color"?i.style.color=a:n==="backgroundColor"?(i.style.backgroundColor=a,i.style.setProperty("--b3-parent-background",a)):n==="fontSize"&&(i.style.fontSize=a);(n==="fontSize"||n==="clear")&&i.getAttribute("data-type")==="NodeCodeBlock"&&Oa(i.querySelector(".hljs"))}),X(e.toolbar.range)):n==="clear"?e.toolbar.setInlineMark(e,"clear","range",{type:"text"}):e.toolbar.setInlineMark(e,"text","range",{type:n,color:a})},yl=(e,t)=>{const n=i=>{const l=i.split(f.ZWSP);e.setAttribute("data-id",l.splice(0,1)[0]),e.setAttribute("data-subtype",l.splice(0,1)[0]),e.removeAttribute("data-href"),e.innerText=l.join("")},a=i=>{const l=i.split(f.ZWSP);e.setAttribute("data-href",l[0]),e.removeAttribute("data-subtype"),e.removeAttribute("data-id"),l[1]&&(e.textContent=l[1])},s=i=>{const l=i.split(f.ZWSP);e.setAttribute("data-id",l[0]),e.removeAttribute("data-href"),e.removeAttribute("data-subtype"),l[1]&&(e.textContent=l[1])};if(t){switch(t.type){case"color":e.style.color=t.color;break;case"fontSize":e.style.fontSize=t.color;break;case"backgroundColor":e.style.backgroundColor=t.color;break;case"style1":e.style.backgroundColor=t.color.split(f.ZWSP)[0],e.style.color=t.color.split(f.ZWSP)[1];break;case"style2":e.style.webkitTextStroke="0.2px var(--b3-theme-on-background)",e.style.webkitTextFillColor="transparent";break;case"style4":e.style.textShadow="1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)";break;case"id":n(t.color);break;case"inline-math":e.className="render-node",e.setAttribute("contenteditable","false"),e.setAttribute("data-subtype","math"),e.setAttribute("data-content",e.textContent.replace(f.ZWSP,"")),e.removeAttribute("data-render"),e.textContent="";break;case"a":a(t.color);break;case"file-annotation-ref":s(t.color);break;case"inline-memo":e.removeAttribute("contenteditable"),e.removeAttribute("data-subtype"),e.removeAttribute("data-content");break}e.getAttribute("style")||e.removeAttribute("style")}},Ua=(e,t,n)=>{if(!n)return e.nodeType!==3&&t.nodeType!==3&&t.style.color===e.style.color&&t.style.webkitTextFillColor===e.style.webkitTextFillColor&&t.style.webkitTextStroke===e.style.webkitTextStroke&&t.style.textShadow===e.style.textShadow&&t.style.backgroundColor===e.style.backgroundColor&&t.style.fontSize===e.style.fontSize;if(n.type==="inline-math"||n.type==="inline-memo"||n.type==="a")return!1;if(n.type==="id"){if(e.nodeType!==3)return e.getAttribute("data-id")===t.getAttribute("data-id")&&e.getAttribute("data-subtype")===t.getAttribute("data-subtype")&&e.textContent===t.textContent;const c=n.color.split(f.ZWSP);return c[0]===t.getAttribute("data-id")&&c[1]===t.getAttribute("data-subtype")&&c[2]===t.textContent}if(n.type==="file-annotation-ref")return e.nodeType!==3?e.getAttribute("data-id")===t.getAttribute("data-id")&&e.textContent===t.textContent:n.color===t.getAttribute("data-id");let a="",s="",i="",l="",o="",r="";return e.nodeType!==3&&(a=e.style.color,s=e.style.webkitTextFillColor,i=e.style.webkitTextStroke,l=e.style.textShadow,o=e.style.backgroundColor,r=e.style.fontSize),n.type==="text"?a===t.style.color&&s===t.style.webkitTextFillColor&&i===t.style.webkitTextStroke&&l===t.style.textShadow&&r===t.style.fontSize&&o===t.style.backgroundColor:n.type==="color"?n.color===t.style.color&&s===t.style.webkitTextFillColor&&i===t.style.webkitTextStroke&&l===t.style.textShadow&&r===t.style.fontSize&&o===t.style.backgroundColor:n.type==="backgroundColor"?a===t.style.color&&s===t.style.webkitTextFillColor&&i===t.style.webkitTextStroke&&l===t.style.textShadow&&r===t.style.fontSize&&n.color===t.style.backgroundColor:n.type==="style1"?n.color.split(f.ZWSP)[0]===t.style.color&&s===t.style.webkitTextFillColor&&i===t.style.webkitTextStroke&&l===t.style.textShadow&&r===t.style.fontSize&&n.color.split(f.ZWSP)[1]===t.style.backgroundColor:n.type==="style2"?a===t.style.color&&t.style.webkitTextFillColor==="transparent"&&t.style.webkitTextStroke==="0.2px var(--b3-theme-on-background)"&&l===t.style.textShadow&&r===t.style.fontSize&&o===t.style.backgroundColor:n.type==="style4"?a===t.style.color&&s===t.style.webkitTextFillColor&&i===t.style.webkitTextStroke&&r===t.style.fontSize&&t.style.textShadow==="1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)"&&o===t.style.backgroundColor:n.type==="fontSize"?a===t.style.color&&s===t.style.webkitTextFillColor&&i===t.style.webkitTextStroke&&l===t.style.textShadow&&n.color===t.style.fontSize&&o===t.style.backgroundColor:!0},wl=e=>{let t;if(e.toolbar.range.toString()===""&&(t=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select")),t.length===0)){const n=B(e.toolbar.range.startContainer);n&&(t=[n])}return t},Zu=(e,t,n)=>{var a;if($(e,"protyle-wysiwyg__embed"))return;const s=At(e);if(!s&&e.classList.contains("protyle-wysiwyg--select")){nt(oe(e),t,!1),t.collapse(!1),J(["select"],n);return}if(s||e.classList.contains("table")){if(e.parentElement.classList.contains("li")){const h=e.parentElement.parentElement.outerHTML,E=ia(e.parentElement,0,!0);e.parentElement.insertAdjacentElement("afterend",E),K(n,e.parentElement.parentElement.getAttribute("data-node-id"),e.parentElement.parentElement.outerHTML,h),ue(E,t),Li(E),He(n);return}if(e.classList.contains("hr")){Rt(n,"afterend");return}e.classList.contains("protyle-wysiwyg--select")&&e.classList.contains("render-node")?n.toolbar.showRender(n,e):Rt(n,"afterend");return}const i=oe(e);if(i.querySelectorAll(".img--select").forEach(h=>{h.classList.remove("img--select")}),e.getAttribute("data-type")==="NodeAttributeView")return!0;const l=i.innerHTML.trimStart();if((l.startsWith("```")||l.startsWith("\xB7\xB7\xB7")||l.startsWith("~~~")||l.indexOf("\n```")>-1||l.indexOf(`
~~~`)>-1||l.indexOf(`
\xB7\xB7\xB7`)>-1)&&!(l.indexOf(`
`)===-1&&l.replace(/·|~/g,"`").replace(/^`{3,}/g,"").indexOf("`")>-1)){if(e.classList.contains("p")){const h=e.outerHTML;let E=i.innerHTML.replace(/\n(~|·|`){3,}/g,"\n```").trim().replace(/^(~|·|`){3,}/g,"```");E.endsWith("\n```")||(E+="<wbr>\n```"),i.innerHTML=E,e.outerHTML=n.lute.SpinBlockDOM(e.outerHTML),e=n.wysiwyg.element.querySelector(`[data-node-id="${e.getAttribute("data-node-id")}"]`);const S=e.querySelector(".protyle-action__language");return S?(window.siyuan.storage[f.LOCAL_CODELANG]&&S.textContent===""?S.textContent=window.siyuan.storage[f.LOCAL_CODELANG]:f.SIYUAN_RENDER_CODE_LANGUAGES.includes(S.textContent)||(window.siyuan.storage[f.LOCAL_CODELANG]=S.textContent,Ae(f.LOCAL_CODELANG,window.siyuan.storage[f.LOCAL_CODELANG])),f.SIYUAN_RENDER_CODE_LANGUAGES.includes(S.textContent)?(e.dataset.content="",e.dataset.subtype=S.textContent,e.className="render-node",e.innerHTML=`<div spin="1"></div><div class="protyle-attr" contenteditable="false">${f.ZWSP}</div>`,n.toolbar.showRender(n,e),Ze(e)):Pe(e)):(n.toolbar.showRender(n,e),Ze(e)),K(n,e.getAttribute("data-node-id"),e.outerHTML,h),!0}}if(e.getAttribute("data-type")==="NodeCodeBlock"){const h=document.createElement("wbr");t.insertNode(h);const E=e.outerHTML;return h.remove(),t.extractContents(),i.textContent.endsWith(`
`)||i.insertAdjacentText("beforeend",`
`),t.insertNode(document.createTextNode(`
`)),t.collapse(!1),t.insertNode(h),i.parentElement.removeAttribute("data-render"),Pe(e),K(n,e.getAttribute("data-node-id"),e.outerHTML,E),He(n),!0}if(i.textContent.replace(f.ZWSP,"").replace(`
`,"")===""&&e.nextElementSibling&&e.nextElementSibling.classList.contains("protyle-attr")&&e.parentElement.getAttribute("data-type")==="NodeBlockquote"){t.insertNode(document.createElement("wbr"));const h=Ct(e),E=e.getAttribute("data-node-id"),S=h.getAttribute("data-node-id"),L={action:"insert",id:E,data:e.outerHTML},k={action:"insert",id:S,data:h.outerHTML};return S===E?(L.previousID=e.parentElement.getAttribute("data-node-id"),k.previousID=e.previousElementSibling.getAttribute("data-node-id"),e.parentElement.after(e)):(L.previousID=h.previousElementSibling?h.previousElementSibling.getAttribute("data-node-id"):void 0,L.parentID=h.parentElement.getAttribute("data-node-id")||n.block.parentID,k.previousID=L.previousID,k.parentID=L.parentID,h.after(e),h.remove()),q(n,[{action:"delete",id:S},L],[{action:"delete",id:E},k]),S===E&&e.parentElement.classList.contains("sb")&&e.parentElement.getAttribute("data-sb-layout")==="col"&&Kt({protyle:n,selectsElement:[e.previousElementSibling,e],type:"BlocksMergeSuperBlock",level:"row"}),ue(e,t),!0}const o=Je(i,n.wysiwyg.element,t);if(e.parentElement.getAttribute("data-type")==="NodeListItem"&&(e.nextElementSibling.classList.contains("protyle-attr")||e.nextElementSibling.classList.contains("list")&&((a=e.previousElementSibling)!=null&&a.classList.contains("protyle-action"))||o.start===0&&e.previousElementSibling.classList.contains("protyle-action")||e.parentElement.getAttribute("fold")==="1")&&Xu(n,e,t))return!0;if(i.textContent!==""&&t.toString()===""&&o.start===0){const h=Xn(!1,!0),E=h.getAttribute("data-node-id");return q(n,[{action:"insert",data:h.outerHTML,id:E,previousID:e.previousElementSibling?e.previousElementSibling.getAttribute("data-node-id"):"",parentID:e.parentElement.getAttribute("data-node-id")||n.block.parentID}],[{action:"delete",id:E}]),h.querySelector("wbr").remove(),e.insertAdjacentElement("beforebegin",h),Li(h),!0}const r=document.createElement("wbr");t.insertNode(r);const c=e.outerHTML;if(r.remove(),t.toString()!==""){const h=D(t.startContainer,"data-type","inline-math");if(h){const E=Fe(h);return E&&(t=getSelection().getRangeAt(0),t.setEnd(E,E.textContent.startsWith(f.ZWSP)?1:0),t.collapse(!1)),!0}t.extractContents()}i.lastChild&&t.setEndAfter(i.lastChild);const d=e.getAttribute("data-node-id"),u=document.createElement("div");u.appendChild(Xn(!1,!1));const p=u.querySelector('[contenteditable="true"]');p.appendChild(t.extractContents());const g=p.innerHTML.trimStart();if((g.startsWith("```")||g.startsWith("\xB7\xB7\xB7")||g.startsWith("~~~")||g.indexOf("\n```")>-1||g.indexOf(`
~~~`)>-1||g.indexOf(`
\xB7\xB7\xB7`)>-1)&&!(g.indexOf(`
`)===-1&&g.replace(/·|~/g,"`").replace(/^`{3,}/g,"").indexOf("`")>-1)){let h=p.innerHTML.replace(/\n(~|·|`){3,}/g,"\n```").trim().replace(/^(~|·|`){3,}/g,"```");h.endsWith("\n```")||(h+="\n```"),p.innerHTML=h}u.innerHTML=n.lute.SpinBlockDOM(u.innerHTML);const m=document.createElement("div");m.innerHTML=n.lute.SpinBlockDOM(i.parentElement.outerHTML);const b=[],y=[];let _=e;const w=[];Array.from(m.children).forEach(h=>{h.dataset.nodeId===d?(e.before(h),e.remove(),b.push({action:"update",data:h.outerHTML,id:d}),y.push({action:"update",data:c,id:d})):(b.push({action:"insert",data:h.outerHTML,id:h.dataset.nodeId,nextID:d}),_.insertAdjacentElement("afterend",h),y.push({action:"delete",id:h.dataset.nodeId})),_n(h),_=h,w.push(h)}),Array.from(u.children).forEach(h=>{const E=h.getAttribute("data-node-id");b.push({action:"insert",data:h.outerHTML,id:E,previousID:_.getAttribute("data-node-id")}),y.push({action:"delete",id:E}),_.insertAdjacentElement("afterend",h),h.classList.contains("code-block")?Pe(h):_n(_.nextElementSibling),_=h,w.push(h)});const v=_.parentElement;return q(n,b,y),v.classList.contains("sb")&&v.getAttribute("data-sb-layout")==="col"&&Kt({protyle:n,selectsElement:w,type:"BlocksMergeSuperBlock",level:"row"}),ne(_),He(n),!0},Xu=(e,t,n)=>{var a,s,i;const l=t.parentElement,o=oe(t);if(["",`
`].includes(o.textContent)&&t.previousElementSibling.classList.contains("protyle-action")&&!t.querySelector("img")){if((a=l.nextElementSibling)!=null&&a.classList.contains("protyle-attr"))return Wa(e,[t.parentElement],n),!0;if(!l.parentElement.classList.contains("protyle-wysiwyg"))return Hf(e,t,n),!0}const r=Je(o,e.wysiwyg.element,n);if(n.toString()===""&&r.start===0&&!ut(n.startContainer)){if(l.parentElement.classList.contains("protyle-wysiwyg"))return!0;const m=document.createElement("wbr");n.insertNode(m);const b=l.parentElement.outerHTML;m.remove();let y=ia(l,-1,!0);if(t.previousElementSibling.classList.contains("protyle-action"))oe(t).textContent===""?l.insertAdjacentElement("afterend",y):l.insertAdjacentElement("beforebegin",y);else{if(oe(t).textContent!=="")return!1;t.remove(),y=ia(l,-1,!0),l.insertAdjacentElement("afterend",y)}return l.getAttribute("data-subtype")==="o"&&je(l.parentElement),K(e,l.parentElement.getAttribute("data-node-id"),l.parentElement.outerHTML,b),ue(y,n),He(e),Li(y),!0}const c=l.querySelector(".list");let d;if(c&&l.getAttribute("fold")!=="1"&&t.nextElementSibling.isSameNode(c)){if(r.end>=o.textContent.length-(o.textContent.endsWith(f.ZWSP)?1:0)){n.insertNode(document.createElement("wbr"));const m=c.outerHTML;t.querySelector("wbr").remove(),d=ia(c.firstElementChild,-1,!0),c.firstElementChild.before(d),c.getAttribute("data-subtype")==="o"&&je(c),K(e,c.getAttribute("data-node-id"),c.outerHTML,m),ue(l,n),He(e)}else{n.insertNode(document.createElement("wbr"));const m=l.outerHTML,b=l.parentElement.outerHTML;n.toString()!==""&&(n.extractContents(),n.insertNode(document.createElement("wbr"))),n.setEndAfter(o.lastChild),d=ia(l,0,!1),oe(d).appendChild(n.extractContents());let _=c.nextElementSibling;for(d.lastElementChild.before(c);!_.classList.contains("protyle-attr");)_=_.nextElementSibling,d.lastElementChild.before(_.previousElementSibling);l.insertAdjacentElement("afterend",d),l.getAttribute("data-subtype")==="o"&&je(l.parentElement),l.parentElement.classList.contains("protyle-wysiwyg")?q(e,[{action:"update",data:l.outerHTML,id:l.getAttribute("data-node-id")},{action:"insert",id:d.getAttribute("data-node-id"),data:d.outerHTML,previousID:l.getAttribute("data-node-id")}],[{action:"delete",id:d.getAttribute("data-node-id")},{action:"update",data:m,id:l.getAttribute("data-node-id")}]):K(e,l.parentElement.getAttribute("data-node-id"),l.parentElement.outerHTML,b),ue(d,n),He(e)}return Li(d),!0}if((n.toString()===""||n.toString()===f.ZWSP)&&n.startContainer.nodeType===3&&n.startOffset===0){let m=n.startContainer;for(;m;)if(m.textContent===f.ZWSP){n.setStart(m,1),n.collapse(!1);break}else m=m.nextSibling}n.insertNode(document.createElement("wbr"));const u=l.outerHTML,p=l.parentElement.outerHTML;if(n.toString()!==""){const m=D(n.startContainer,"data-type","inline-math");if(m){const b=Fe(m);return b&&(n=getSelection().getRangeAt(0),n.setEnd(b,b.textContent.startsWith(f.ZWSP)?1:0),n.collapse(!1)),!0}n.extractContents(),n.insertNode(document.createElement("wbr"))}n.setEndAfter(o.lastChild),d=ia(l,0,!1);const g=n.extractContents();return g.firstChild.nodeType!==3&&g.firstChild.textContent===""&&(g.firstChild.after(document.createElement("wbr")),g.firstChild.remove()),(((s=o==null?void 0:o.lastElementChild)==null?void 0:s.getAttribute("data-type"))||"").indexOf("inline-math")>-1&&!Fe(o==null?void 0:o.lastElementChild)&&o.insertAdjacentText("beforeend",`
`),(i=o==null?void 0:o.lastElementChild)!=null&&i.classList.contains("img")&&!Fe(o==null?void 0:o.lastElementChild)&&o.insertAdjacentText("beforeend",f.ZWSP),oe(d).appendChild(g),l.insertAdjacentElement("afterend",d),l.getAttribute("data-subtype")==="o"&&je(l.parentElement),l.parentElement.classList.contains("protyle-wysiwyg")?q(e,[{action:"update",id:l.getAttribute("data-node-id"),data:l.outerHTML},{action:"insert",id:d.getAttribute("data-node-id"),data:d.outerHTML,previousID:l.getAttribute("data-node-id")}],[{action:"delete",id:d.getAttribute("data-node-id")},{action:"update",id:l.getAttribute("data-node-id"),data:u}]):K(e,l.parentElement.getAttribute("data-node-id"),l.parentElement.outerHTML,p),ue(d,n),He(e),Li(d),!0},Li=e=>{const t=oe(e).childNodes;for(let n=0;n<t.length;n++)t[n].nodeType===3&&t[n].textContent.length===0&&(t[n].remove(),n--)},$r=(e,t,n)=>{let a=e.startContainer;const s=Fe(a);if(t.getAttribute("data-type")==="NodeAttributeView")return!0;if(s&&s.nodeType!==3&&Je(e.startContainer,n.wysiwyg.element,e).end===e.endContainer.textContent.length&&(s.classList.contains("img")||s.getAttribute("data-type")==="inline-math")){s.insertAdjacentHTML("beforebegin","<wbr>");const l=t.outerHTML;s.previousElementSibling.remove();const o=document.createTextNode(`
`);return a.after(document.createTextNode(f.ZWSP)),a.after(o),e.selectNode(o),e.collapse(!1),K(n,t.getAttribute("data-node-id"),t.outerHTML,l),!0}if(a.nodeType===3&&(a=a.parentElement),a&&n.toolbar.getCurrentType(e).length>0&&Je(a,a,e).end===a.textContent.length)return Ir(e,t,n,a),!0;if(gi()||H()){a=e.startContainer;const i=Fe(a);return i&&i.textContent.trim()!==""?(document.execCommand("insertHTML",!1,`
`),!0):(Ir(e,t,n,a),!0)}return!1},Ir=(e,t,n,a)=>{const s=document.createElement("wbr");a.nodeType===3?e.insertNode(s):a.insertAdjacentElement("afterend",s);const i=t.outerHTML;s.remove();let l;Fe(a)||(l=document.createTextNode(`
`),a.after(l));const o=document.createTextNode(`
`);a.after(o),l?e.setStart(l,0):e.setStart(o,1),e.collapse(!0),X(e),K(n,t.getAttribute("data-node-id"),t.outerHTML,i)};let Dr,Si=!1;const Ee=(e,t,n,a="false")=>{let s;return t&&t.startsWith("icon")?s=`<svg class="keyboard__slash-icon"><use xlink:href="#${t}"></use></svg>`:s=t,`<button class="keyboard__slash-item" data-focus="${a}" data-value="${encodeURIComponent(e)}">
    ${s}
    <span class="keyboard__slash-text">${n}</span>
</button>`},Mr=(e,t)=>{let n="";["","var(--b3-font-color1)","var(--b3-font-color2)","var(--b3-font-color3)","var(--b3-font-color4)","var(--b3-font-color5)","var(--b3-font-color6)","var(--b3-font-color7)","var(--b3-font-color8)","var(--b3-font-color9)","var(--b3-font-color10)","var(--b3-font-color11)","var(--b3-font-color12)","var(--b3-font-color13)"].forEach((u,p)=>{n+=`<button class="keyboard__slash-item" data-type="color">
    <span class="keyboard__slash-icon" ${u?`style="color:${u}"`:""}>A</span>
    <span class="keyboard__slash-text">${window.siyuan.languages.colorFont} ${u?p+1:window.siyuan.languages.default}</span>
</button>`});let a="";["","var(--b3-font-background1)","var(--b3-font-background2)","var(--b3-font-background3)","var(--b3-font-background4)","var(--b3-font-background5)","var(--b3-font-background6)","var(--b3-font-background7)","var(--b3-font-background8)","var(--b3-font-background9)","var(--b3-font-background10)","var(--b3-font-background11)","var(--b3-font-background12)","var(--b3-font-background13)"].forEach((u,p)=>{a+=`<button class="keyboard__slash-item" data-type="backgroundColor">
    <span class="keyboard__slash-icon" ${u?`style="background-color:${u}"`:""}>A</span>
    <span class="keyboard__slash-text">${window.siyuan.languages.colorPrimary} ${u?p+1:window.siyuan.languages.default}</span>
</button>`});const s=wl(e);let i=!1;s==null||s.find(u=>{if(u.classList.contains("list")||u.classList.contains("li"))return i=!0,!0});let l="";const o=window.siyuan.storage[f.LOCAL_FONTSTYLES];o.length>0&&(l=`<div class="keyboard__slash-title">
    ${window.siyuan.languages.lastUsed}
</div>
<div class="keyboard__slash-block">`,o.forEach(u=>{const p=u.split(f.ZWSP);switch(p[0]){case"color":l+=`<button class="keyboard__slash-item" data-type="${p[0]}">
    <span class="keyboard__slash-icon" ${p[1]?`style="color:${p[1]}"`:""} >A</span>
    <span class="keyboard__slash-text">${window.siyuan.languages.colorFont} ${p[1]?parseInt(p[1].replace("var(--b3-font-color",""))+1:window.siyuan.languages.default}</span>
</button>`;break;case"backgroundColor":l+=`<button class="keyboard__slash-item" data-type="${p[0]}">
    <span class="keyboard__slash-icon" ${p[1]?`style="background-color:${p[1]}"`:""}>A</span>
    <span class="keyboard__slash-text">${window.siyuan.languages.colorPrimary} ${p[1]?parseInt(p[1].replace("var(--b3-font-background",""))+1:window.siyuan.languages.default}</span>
</button>`;break;case"style2":l+=`<button class="keyboard__slash-item" data-type="${p[0]}">
    <span class="keyboard__slash-text" style="-webkit-text-stroke: 0.2px var(--b3-theme-on-background);-webkit-text-fill-color : transparent;">${window.siyuan.languages.hollow}</span>
</button>`;break;case"style4":l+=`<button class="keyboard__slash-item" data-type="${p[0]}">
    <span class="keyboard__slash-text" style="text-shadow: 1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)">${window.siyuan.languages.shadow}</span>
</button>`;break;case"fontSize":i||(l+=`<button class="keyboard__slash-item" data-type="${p[0]}">
    <span class="keyboard__slash-text">${p[1]}</span>
</button>`);break;case"style1":p[1]?l+=`<button class="keyboard__slash-item" data-type="${p[0]}">
    <span class="keyboard__slash-icon" style="background-color:${p[1]};color:${p[2]}">A</span>
    <span class="keyboard__slash-text">${window.siyuan.languages[p[2].replace("var(--b3-card-","").replace("-color)","")+"Style"]}</span>
</button>`:l+=`<button class="keyboard__slash-item" data-type="${p[0]}">
    <span class="keyboard__slash-icon">A</span>
    <span class="keyboard__slash-text">${window.siyuan.languages.color} ${window.siyuan.languages.default}</span>
</button>`;break;case"clear":l+=`<button class="keyboard__slash-item" data-type="${p[0]}">
    <span class="keyboard__slash-text">${window.siyuan.languages.clearFontStyle}</span>
</button>`;break}}),l+="</div>");let r,c="16px";s&&s.length>0?r=s[0]:(r=e.toolbar.range.cloneContents().querySelector('[data-type~="text"]'),r||(r=D(e.toolbar.range.startContainer,"data-type","text"))),r&&(c=r.style.fontSize||"16px");const d=t.querySelector(".keyboard__util");d.innerHTML=`${l}
<div class="keyboard__slash-title">${window.siyuan.languages.color}</div>
<div class="keyboard__slash-block">
    <button class="keyboard__slash-item" data-type="style1">
        <span class="keyboard__slash-icon">A</span>
        <span class="keyboard__slash-text">${window.siyuan.languages.color} ${window.siyuan.languages.default}</span>
    </button>
    <button class="keyboard__slash-item" data-type="style1">
        <span class="keyboard__slash-icon" style="color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);">A</span>
        <span class="keyboard__slash-text">${window.siyuan.languages.errorStyle}</span>
    </button>
    <button class="keyboard__slash-item" data-type="style1">
        <span class="keyboard__slash-icon" style="color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);">A</span>
        <span class="keyboard__slash-text">${window.siyuan.languages.warningStyle}</span>
    </button>
    <button class="keyboard__slash-item" data-type="style1">
        <span class="keyboard__slash-icon" style="color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);">A</span>
        <span class="keyboard__slash-text">${window.siyuan.languages.infoStyle}</span>
    </button>
    <button class="keyboard__slash-item" data-type="style1">
        <span class="keyboard__slash-icon" style="color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);">A</span>
        <span class="keyboard__slash-text">${window.siyuan.languages.successStyle}</span>
    </button>
</div>
<div class="keyboard__slash-title">${window.siyuan.languages.colorFont}</div>
<div class="keyboard__slash-block">
    ${n}
</div>
<div class="keyboard__slash-title">${window.siyuan.languages.colorPrimary}</div>
<div class="keyboard__slash-block">
    ${a}
</div>
<div class="keyboard__slash-title">${window.siyuan.languages.fontStyle}</div>
<div class="keyboard__slash-block">
    <button class="keyboard__slash-item" data-type="style2">
        <span class="keyboard__slash-text" style="-webkit-text-stroke: 0.2px var(--b3-theme-on-background);-webkit-text-fill-color : transparent;">${window.siyuan.languages.hollow}</span>
    </button>
    <button class="keyboard__slash-item" data-type="style4">
        <span class="keyboard__slash-text" style="text-shadow: 1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)">${window.siyuan.languages.shadow}</span>
    </button>
    <button class="keyboard__slash-item" data-type="clear">
        <svg class="keyboard__slash-icon"><use xlink:href="#iconTrashcan"></use></svg>
        <span class="keyboard__slash-text">${window.siyuan.languages.clearFontStyle}</span>
    </button>
</div>
<div class="keyboard__slash-title${i?" fn__none":""}">${window.siyuan.languages.fontSize}</div>
<div class="keyboard__slash-block${i?" fn__none":""}">
    <select class="b3-select fn__block" style="width: calc(50% - 8px);margin: 4px 0 8px 0;">
        <option ${c==="12px"?"selected":""} value="12px">12px</option>
        <option ${c==="13px"?"selected":""} value="13px">13px</option>
        <option ${c==="14px"?"selected":""} value="14px">14px</option>
        <option ${c==="15px"?"selected":""} value="15px">15px</option>
        <option ${c==="16px"?"selected":""} value="16px">16px</option>
        <option ${c==="19px"?"selected":""} value="19px">19px</option>
        <option ${c==="22px"?"selected":""} value="22px">22px</option>
        <option ${c==="24px"?"selected":""} value="24px">24px</option>
        <option ${c==="29px"?"selected":""} value="29px">29px</option>
        <option ${c==="32px"?"selected":""} value="32px">32px</option>
        <option ${c==="40px"?"selected":""} value="40px">40px</option>
        <option ${c==="48px"?"selected":""} value="48px">48px</option>
    </select>
</div>`,d.querySelector("select").addEventListener("change",function(u){an(e,s,"fontSize",u.target.value)})},Ju=(e,t)=>{e.hint.splitChar="/",e.hint.lastIndex=-1;let n="";e.app.plugins.forEach(s=>{s.protyleSlash.forEach(i=>{n+=Ee(`plugin${f.ZWSP}${s.name}${f.ZWSP}${i.id}`,"",i.html,"true")})}),n&&(n=`<div class="keyboard__slash-title"></div><div class="keyboard__slash-block">${n}</div>`);const a=t.querySelector(".keyboard__util");a.innerHTML=`<div class="keyboard__slash-title"></div>
<div class="keyboard__slash-block">
    ${Ee(f.ZWSP,"iconMarkdown",window.siyuan.languages.template)}
    ${Ee(f.ZWSP+1,"iconBoth",window.siyuan.languages.widget)}
    ${Ee(f.ZWSP+2,"iconImage",window.siyuan.languages.assets)}
    ${Ee("((","iconRef",window.siyuan.languages.ref,"true")}
    ${Ee("{{","iconSQL",window.siyuan.languages.blockEmbed,"true")}
    ${Ee(f.ZWSP+5,"iconSparkles",window.siyuan.languages.aiWriting)}
    ${Ee('<div data-type="NodeAttributeView" data-av-type="table"></div>',"iconDatabase",window.siyuan.languages.database,"true")}
    ${Ee(f.ZWSP+4,"iconFile",window.siyuan.languages.newSubDocRef)}
</div>
<div class="keyboard__slash-title"></div>
<div class="keyboard__slash-block">
    ${Ee(f.ZWSP+3,"iconDownload",window.siyuan.languages.insertAsset+'<input class="b3-form__upload" type="file"'+(e.options.upload.accept?' multiple="'+e.options.upload.accept+'"':"")+"/>","true")}
    ${ft()?Ee(f.ZWSP+3,"iconCamera",window.siyuan.languages.insertPhoto+'<input class="b3-form__upload" capture="user" type="file"'+(e.options.upload.accept?' multiple="'+e.options.upload.accept+'"':"")+"/>","true"):""}
    ${Ee('<iframe sandbox="allow-forms allow-presentation allow-same-origin allow-scripts allow-modals allow-popups" src="" border="0" frameborder="no" framespacing="0" allowfullscreen="true"></iframe>',"iconLanguage",window.siyuan.languages.insertIframeURL,"true")}
    ${Ee("![]()","iconImage",window.siyuan.languages.insertImgURL,"true")}
    ${Ee('<video controls="controls" src=""></video>',"iconVideo",window.siyuan.languages.insertVideoURL,"true")}
    ${Ee('<audio controls="controls" src=""></audio>',"iconRecord",window.siyuan.languages.insertAudioURL,"true")}
    ${Ee("emoji","iconEmoji",window.siyuan.languages.emoji,"true")}
</div>
<div class="keyboard__slash-title"></div>
<div class="keyboard__slash-block">
    ${Ee("# "+Lute.Caret,"iconH1",window.siyuan.languages.heading1,"true")}
    ${Ee("## "+Lute.Caret,"iconH2",window.siyuan.languages.heading2,"true")}
    ${Ee("### "+Lute.Caret,"iconH3",window.siyuan.languages.heading3,"true")}
    ${Ee("#### "+Lute.Caret,"iconH4",window.siyuan.languages.heading4,"true")}
    ${Ee("##### "+Lute.Caret,"iconH5",window.siyuan.languages.heading5,"true")}
    ${Ee("###### "+Lute.Caret,"iconH6",window.siyuan.languages.heading6,"true")}
    ${Ee("* "+Lute.Caret,"iconList",window.siyuan.languages.list,"true")}
    ${Ee("1. "+Lute.Caret,"iconOrderedList",window.siyuan.languages["ordered-list"],"true")}
    ${Ee("* [ ] "+Lute.Caret,"iconCheck",window.siyuan.languages.check,"true")}
    ${Ee("> "+Lute.Caret,"iconQuote",window.siyuan.languages.quote,"true")}
    ${Ee("```","iconCode",window.siyuan.languages.code,"true")}
    ${Ee(`| ${Lute.Caret} |  |  |
| --- | --- | --- |
|  |  |  |
|  |  |  |`,"iconTable",window.siyuan.languages.table,"true")}
    ${Ee("---","iconLine",window.siyuan.languages.line,"true")}
    ${Ee("$$","iconMath",window.siyuan.languages.math)}
    ${Ee("<div>","iconHTML5","HTML")}
</div>
<div class="keyboard__slash-title"></div>
<div class="keyboard__slash-block">
    ${Ee("```abc\n```","",window.siyuan.languages.staff,"true")}
    ${Ee("```echarts\n```","",window.siyuan.languages.chart,"true")}
    ${Ee("```flowchart\n```","","Flow Chart","true")}
    ${Ee("```graphviz\n```","","Graph","true")}
    ${Ee("```mermaid\n```","","Mermaid","true")}
    ${Ee("```mindmap\n```","",window.siyuan.languages.mindmap,"true")}
    ${Ee("```plantuml\n```","","UML","true")}
</div>
<div class="keyboard__slash-title"></div>
<div class="keyboard__slash-block">
    ${Ee(`style${f.ZWSP}color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);`,'<div style="color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);" class="keyboard__slash-icon">A</div>',window.siyuan.languages.infoStyle,"true")}
    ${Ee(`style${f.ZWSP}color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);`,'<div style="color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);" class="keyboard__slash-icon">A</div>',window.siyuan.languages.successStyle,"true")}
    ${Ee(`style${f.ZWSP}color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);`,'<div style="color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);" class="keyboard__slash-icon">A</div>',window.siyuan.languages.warningStyle,"true")}
    ${Ee(`style${f.ZWSP}color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);`,'<div style="color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);" class="keyboard__slash-icon">A</div>',window.siyuan.languages.errorStyle,"true")}
    ${Ee(`style${f.ZWSP}`,'<div class="keyboard__slash-icon">A</div>',window.siyuan.languages.clearFontStyle,"true")}
</div>${n}`,e.hint.bindUploadEvent(e,a)},hl=e=>{window.siyuan.menus.menu.remove(),Si=!0;const t=document.getElementById("keyboardToolbar");let n=t.getAttribute("data-keyboardheight");n=(n?parseInt(n)+42:window.outerHeight/2)+"px";const a=Dt();a&&(a.protyle.element.parentElement.style.paddingBottom=n,a.protyle.contentElement.scrollTop=e),setTimeout(()=>{t.style.height=n},f.TIMEOUT_TRANSITION),setTimeout(()=>{Si=!1},1e3)},xi=()=>{const e=document.getElementById("keyboardToolbar");e.style.height="";const t=Dt();t&&(t.protyle.element.parentElement.style.paddingBottom="42px"),e.querySelector('.keyboard__action[data-type="add"]').classList.remove("protyle-toolbar__item--current"),e.querySelector('.keyboard__action[data-type="text"]').classList.remove("protyle-toolbar__item--current"),e.querySelector('.keyboard__action[data-type="done"] use').setAttribute("xlink:href","#iconKeyboardHide")},Qu=()=>{clearTimeout(Dr),Dr=window.setTimeout(()=>{if(getSelection().rangeCount===0||window.siyuan.config.readonly||document.getElementById("toolbarName").getAttribute("readonly")==="readonly"||window.screen.height-window.innerHeight<160||!document.activeElement||document.activeElement&&!["INPUT","TEXTAREA"].includes(document.activeElement.tagName)&&!document.activeElement.classList.contains("protyle-wysiwyg")&&document.activeElement.getAttribute("contenteditable")!=="true"){tn();return}if(document.activeElement&&!["INPUT","TEXTAREA"].includes(document.activeElement.tagName)&&(document.getElementById("menu").style.transform==="translateX(0px)"||document.getElementById("model").style.transform==="translateY(0px)")){tn();return}Si||xi(),Hr();const e=document.querySelectorAll("#keyboardToolbar .keyboard__dynamic"),t=getSelection().getRangeAt(0);if(!$(t.startContainer,"protyle-wysiwyg",!0)){e[0].classList.add("fn__none"),e[1].classList.add("fn__none");return}t.toString()||e[0].querySelector('[data-type="goinline"]').classList.contains("protyle-toolbar__item--current")?(e[0].classList.add("fn__none"),e[1].classList.remove("fn__none")):(e[0].classList.remove("fn__none"),e[1].classList.add("fn__none"));const s=Dt().protyle;if(!e[0].classList.contains("fn__none")){s.undo.undoStack.length===0?e[0].querySelector('[data-type="undo"]').setAttribute("disabled","disabled"):e[0].querySelector('[data-type="undo"]').removeAttribute("disabled"),s.undo.redoStack.length===0?e[0].querySelector('[data-type="redo"]').setAttribute("disabled","disabled"):e[0].querySelector('[data-type="redo"]').removeAttribute("disabled");const i=B(t.startContainer);if(i){const l=e[0].querySelector('[data-type="outdent"]');i.parentElement.classList.contains("li")?(l.classList.remove("fn__none"),l.nextElementSibling.classList.remove("fn__none")):(l.classList.add("fn__none"),l.nextElementSibling.classList.add("fn__none"))}}e[1].classList.contains("fn__none")||(e[1].querySelectorAll(".protyle-toolbar__item--current").forEach(l=>{l.classList.remove("protyle-toolbar__item--current")}),s.toolbar.getCurrentType(t).forEach(l=>{if(["search-mark","a","block-ref","virtual-block-ref","text","file-annotation-ref","inline-math","inline-memo","","backslash"].includes(l))return;const o=e[1].querySelector(`[data-type="${l}"]`);o&&o.classList.add("protyle-toolbar__item--current")}))},620)},Hr=()=>{Si||xi();const e=document.getElementById("keyboardToolbar");if(!e.classList.contains("fn__none"))return;e.classList.remove("fn__none"),e.style.zIndex=(++window.siyuan.zIndex).toString();const t=document.getElementById("model");t.style.transform==="translateY(0px)"&&(t.style.paddingBottom="42px");const n=getSelection().getRangeAt(0),a=Dt();a&&a.protyle.wysiwyg.element.contains(n.startContainer)&&(a.protyle.element.parentElement.style.paddingBottom="42px"),Dt().protyle.app.plugins.forEach(s=>{s.eventBus.emit("mobile-keyboard-show")}),setTimeout(()=>{const s=$(n.startContainer,"protyle-content",!0);if(s){const i=s.getBoundingClientRect().top,l=hn(s).top;if(l<window.innerHeight-42&&l>i)return;s.scroll({top:s.scrollTop+l-window.innerHeight+42+26,left:s.scrollLeft,behavior:"smooth"})}},f.TIMEOUT_TRANSITION)},tn=()=>{if(Si)return;const e=document.getElementById("keyboardToolbar");if(e.classList.contains("fn__none"))return;e.classList.add("fn__none"),e.style.height="";const t=Dt();t&&(t.protyle.element.parentElement.style.paddingBottom="");const n=document.getElementById("model");n.style.transform==="translateY(0px)"&&(n.style.paddingBottom=""),Dt().protyle.app.plugins.forEach(a=>{a.eventBus.emit("mobile-keyboard-hide")})},fn=()=>{document.activeElement.blur()},ef=()=>{let e=!1;document.addEventListener("selectionchange",()=>{e||Qu()},!1);const t=document.getElementById("keyboardToolbar");t.innerHTML=`<div class="fn__flex keyboard__bar">
    <div class="fn__flex-1">
        <div class="fn__none keyboard__dynamic">
            <button class="keyboard__action" data-type="outdent"><svg><use xlink:href="#iconOutdent"></use></svg></button>
            <button class="keyboard__action" data-type="indent"><svg><use xlink:href="#iconIndent"></use></svg></button>
            <button class="keyboard__action" data-type="add"><svg><use xlink:href="#iconAdd"></use></svg></button>
            <button class="keyboard__action" data-type="block"><svg><use xlink:href="#iconParagraph"></use></svg></button>
            <button class="keyboard__action" data-type="goinline"><svg class="keyboard__svg--big"><use xlink:href="#iconBIU"></use></svg></button>
            <button class="keyboard__action" data-type="softLine"><svg><use xlink:href="#iconSoftWrap"></use></svg></button>
            <span class="keyboard__split"></span>
            <button class="keyboard__action" data-type="undo"><svg><use xlink:href="#iconUndo"></use></svg></button>
            <button class="keyboard__action" data-type="redo"><svg><use xlink:href="#iconRedo"></use></svg></button>
            <span class="keyboard__split"></span>
            <button class="keyboard__action" data-type="moveup"><svg><use xlink:href="#iconUp"></use></svg></button>
            <button class="keyboard__action" data-type="movedown"><svg><use xlink:href="#iconDown"></use></svg></button>
        </div>
        <div class="fn__none keyboard__dynamic">
            <button class="keyboard__action" data-type="goback"><svg><use xlink:href="#iconBack"></use></svg></button>
            <button class="keyboard__action" data-type="block-ref"><svg><use xlink:href="#iconRef"></use></svg></button>
            <button class="keyboard__action" data-type="a"><svg><use xlink:href="#iconLink"></use></svg></button>
            <button class="keyboard__action" data-type="text"><svg><use xlink:href="#iconFont"></use></svg></button>
            <button class="keyboard__action" data-type="strong"><svg><use xlink:href="#iconBold"></use></svg></button>
            <button class="keyboard__action" data-type="em"><svg><use xlink:href="#iconItalic"></use></svg></button>
            <button class="keyboard__action" data-type="u"><svg><use xlink:href="#iconUnderline"></use></svg></button>
            <button class="keyboard__action" data-type="s"><svg><use xlink:href="#iconStrike"></use></svg></button>
            <button class="keyboard__action" data-type="mark"><svg><use xlink:href="#iconMark"></use></svg></button>
            <button class="keyboard__action" data-type="sup"><svg><use xlink:href="#iconSup"></use></svg></button>
            <button class="keyboard__action" data-type="sub"><svg><use xlink:href="#iconSub"></use></svg></button>
            <button class="keyboard__action" data-type="clear"><svg><use xlink:href="#iconClear"></use></svg></button>
            <button class="keyboard__action" data-type="code"><svg><use xlink:href="#iconInlineCode"></use></svg></button>
            <button class="keyboard__action" data-type="kbd"<use xlink:href="#iconKeymap"></use></svg></button>
            <button class="keyboard__action" data-type="tag"><svg><use xlink:href="#iconTags"></use></svg></button>
            <button class="keyboard__action" data-type="inline-math"><svg><use xlink:href="#iconMath"></use></svg></button>
            <button class="keyboard__action" data-type="inline-memo"><svg><use xlink:href="#iconM"></use></svg></button>
            <button class="keyboard__action" data-type="goback"><svg><use xlink:href="#iconCloseRound"></use></svg></button>
        </div>
    </div>
    <span class="keyboard__split"></span>
    <button class="keyboard__action" data-type="done"><svg style="width: 36px"><use xlink:href="#iconKeyboardHide"></use></svg></button>
</div>
<div class="keyboard__util"></div>`,t.addEventListener("click",n=>{var a;const s=(a=Dt())==null?void 0:a.protyle,i=n.target,l=$(n.target,"keyboard__slash-item");if(l&&!l.getAttribute("data-type")){const u=decodeURIComponent(l.getAttribute("data-value"));s.hint.fill(u,s,!1),u!==f.ZWSP+3&&(n.preventDefault(),n.stopPropagation()),l.getAttribute("data-focus")==="true"&&X(s.toolbar.range);return}const o=O(i,"BUTTON");if(!o||o.getAttribute("disabled"))return;const r=o.getAttribute("data-type");if(["clear","style2","style4","color","backgroundColor","fontSize","style1"].includes(r)){const u=wl(s),p=o.firstElementChild;r==="style1"?an(s,u,r,p.style.backgroundColor+f.ZWSP+p.style.color):r==="fontSize"?an(s,u,r,p.textContent.trim()):r==="backgroundColor"?an(s,u,r,p.style.backgroundColor):r==="color"?an(s,u,r,p.style.color):an(s,u,r)}if(n.preventDefault(),n.stopPropagation(),getSelection().rangeCount===0)return;const c=getSelection().getRangeAt(0);if(r==="done"){t.clientHeight>100?(xi(),X(c)):(fn(),tn());return}if(window.siyuan.config.readonly||!s||s.disabled)return;if(r==="undo"){s.undo.undo(s);return}else if(r==="redo"){s.undo.redo(s);return}if(getSelection().rangeCount===0)return;const d=B(c.startContainer);if(d){if(r==="goback"){t.querySelector('.keyboard__action[data-type="goinline"]').classList.remove("protyle-toolbar__item--current");const u=document.querySelectorAll("#keyboardToolbar .keyboard__dynamic");u[0].classList.remove("fn__none"),u[1].classList.add("fn__none"),X(c),e=!0,setTimeout(()=>{e=!1},1e3);return}else if(r==="goinline"){o.classList.add("protyle-toolbar__item--current");const u=document.querySelectorAll("#keyboardToolbar .keyboard__dynamic");u[1].classList.remove("fn__none"),u[0].classList.add("fn__none"),X(c);return}else if(["a","block-ref","inline-math","inline-memo"].includes(r)){D(c.startContainer,"data-type","NodeCodeBlock")||(J(["util"],s),s.toolbar.element.querySelector(`[data-type="${r}"]`).dispatchEvent(new CustomEvent("click")));return}else if(o.classList.contains("keyboard__action")&&["strong","em","s","code","mark","tag","u","sup","clear","sub","kbd"].includes(r)){D(c.startContainer,"data-type","NodeCodeBlock")||s.toolbar.setInlineMark(s,r,"toolbar");return}else if(r==="text"){if(o.classList.contains("protyle-toolbar__item--current"))xi(),X(c);else{o.classList.add("protyle-toolbar__item--current"),t.querySelector('.keyboard__action[data-type="done"] use').setAttribute("xlink:href","#iconCloseRound");const u=s.contentElement.scrollTop;Mr(s,t),hl(u)}return}else if(r==="moveup"){Cr(s,d,c),X(c);return}else if(r==="movedown"){Tr(s,d,c),X(c);return}else if(r==="softLine"){c.extractContents(),$r(c,d,s),X(c);return}else if(r==="add"){if(o.classList.contains("protyle-toolbar__item--current"))xi(),X(c);else{o.classList.add("protyle-toolbar__item--current"),t.querySelector('.keyboard__action[data-type="done"] use').setAttribute("xlink:href","#iconCloseRound");const u=s.contentElement.scrollTop;Ju(s,t),hl(u)}return}else if(r==="block"){s.gutter.renderMenu(s,d),window.siyuan.menus.menu.fullscreen(),fn(),tn();return}else if(r==="outdent"){Wa(s,[d.parentElement],c),X(c);return}else if(r==="indent"){ys(s,[d.parentElement],c),X(c);return}}})},Ve=()=>{document.getElementById("menu").style.transform="",document.getElementById("sidebar").style.transform="",document.getElementById("model").style.transform="";const e=document.querySelector(".side-mask");e.classList.add("fn__none"),e.style.opacity="",window.siyuan.menus.menu.remove()},_l=()=>{document.getElementById("model").style.transform="",fn(),tn()},vl=[],tf=e=>{const t=Dt().protyle;if(t.observerLoad.disconnect(),window.siyuan.storage[f.LOCAL_DOCINFO]={id:e.id},Ae(f.LOCAL_DOCINFO,window.siyuan.storage[f.LOCAL_DOCINFO]),J(["toolbar","hint","util"],t),t.contentElement.classList.contains("fn__none")&&Hi(t,"wysiwyg"),t.notebookId=e.data.notebookId,t.path=e.data.path,e.data.startId===t.wysiwyg.element.firstElementChild.getAttribute("data-node-id")&&e.data.endId===t.wysiwyg.element.lastElementChild.getAttribute("data-node-id")){t.contentElement.scrollTo({top:e.scrollTop,behavior:"smooth"});return}if(e.id!==t.block.rootID&&A("/api/block/getDocInfo",{id:e.id},n=>{si(n.data.name),t.title.setTitle(n.data.name),t.background.render(n.data.ial,t.block.rootID),t.wysiwyg.renderCustom(n.data.ial)}),e.zoomId){e.zoomId!==t.block.id?A("/api/block/checkBlockExist",{id:e.id},n=>{n.data&&Ot({protyle:t,id:e.id,isPushBack:!1,callback:()=>{t.contentElement.scrollTop=e.scrollTop}})}):t.contentElement.scrollTop=e.scrollTop;return}A("/api/filetree/getDoc",{id:e.id,startID:e.data.startId,endID:e.data.endId},n=>{t.block.parentID=n.data.parentID,t.block.parent2ID=n.data.parent2ID,t.block.rootID=n.data.rootID,t.block.showAll=!1,t.block.mode=n.data.mode,t.block.blockCount=n.data.blockCount,t.block.id=n.data.id,t.block.action=e.callback,t.wysiwyg.element.setAttribute("data-doc-type",n.data.type),t.wysiwyg.element.innerHTML=n.data.content,Ze(t.wysiwyg.element),Pe(t.wysiwyg.element),ze(t.wysiwyg.element,t),Se(t,t.wysiwyg.element,e.scrollTop),n.data.isSyncing?xc(t):jl(t,!0),t.contentElement.scrollTop=e.scrollTop,setTimeout(()=>{t.contentElement.scrollTop=e.scrollTop},f.TIMEOUT_LOAD)})},kl=()=>{const e=Dt().protyle;e.wysiwyg.element.firstElementChild&&window.siyuan.backStack.push({id:e.block.showAll?e.block.id:e.block.rootID,data:{startId:e.wysiwyg.element.firstElementChild.getAttribute("data-node-id"),endId:e.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),notebookId:e.notebookId,path:e.path},scrollTop:e.contentElement.scrollTop,callback:e.block.action,zoomId:e.block.showAll?e.block.id:void 0})},nf=()=>{const e=Dt();if(window.siyuan.menus.menu.element.classList.contains("b3-menu--fullscreen")&&!window.siyuan.menus.menu.element.classList.contains("fn__none")){window.siyuan.menus.menu.element.dispatchEvent(new CustomEvent("click",{detail:"back"}));return}else if(document.getElementById("model").style.transform==="translateY(0px)"){const n=document.getElementById("searchAssetsPanel");!n||n.classList.contains("fn__none")?document.getElementById("model").style.transform="":n.classList.add("fn__none");return}else if(window.siyuan.viewer&&!window.siyuan.viewer.destroyed){window.siyuan.viewer.destroy();return}else if(document.getElementById("menu").style.transform==="translateX(0px)"||document.getElementById("sidebar").style.transform==="translateX(0px)"){Ve();return}else if(e&&!e.protyle.toolbar.subElement.classList.contains("fn__none")){J(["util"],e.protyle),Ve();return}else if(window.siyuan.dialogs.length!==0){J(["dialog"]),Ve();return}if((window.JSAndroid||window.JSHarmony)&&window.siyuan.backStack.length<1){document.querySelector('#message [data-id="exitTip"]')?window.JSAndroid?window.JSAndroid.returnDesktop():window.JSHarmony&&window.JSHarmony.returnDesktop():ae(window.siyuan.languages.returnDesktop,3e3,"info","exitTip");return}if(window.siyuan.backStack.length<1)return;if(vl.length===0&&e){const n=e.protyle;vl.push({id:n.block.showAll?n.block.id:n.block.rootID,data:{startId:n.wysiwyg.element.firstElementChild.getAttribute("data-node-id"),endId:n.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),notebookId:n.notebookId,path:n.path},scrollTop:n.contentElement.scrollTop,callback:n.block.action,zoomId:n.block.showAll?n.block.id:void 0})}const t=window.siyuan.backStack.pop();vl.push(t),tf(t)};var af=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{o(n.next(r))}catch(c){s(c)}},l=r=>{try{o(n.throw(r))}catch(c){s(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,l);o((n=n.apply(e,t)).next())});const fs=e=>({id:"export",label:window.siyuan.languages.export,icon:"iconUpload",click(){return af(this,null,function*(){Et(e)})}}),Nr=(e,t,n,a,s=!1)=>{},Pr=e=>{if(ft()){window.JSAndroid.writeImageClipboard(e);return}else{const t=document.createElement("canvas"),n=document.createElement("img");n.onload=a=>{t.width=a.target.width,t.height=a.target.height,t.getContext("2d").drawImage(a.target,0,0,a.target.width,a.target.height),t.toBlob(s=>{navigator.clipboard.write([new ClipboardItem({["image/png"]:s})])},"image/png",1)},n.src=e}},qr=(e,t)=>{e.element.querySelector(".wysiwygLoading")||(ei(e),J(["toolbar"],e),A(`/api/format/net${t}2LocalAssets`,{id:e.block.rootID},()=>{Un(e,!1)}))},El=(e,t)=>{var n,a;setTimeout(()=>{To(["gutter"])},f.TIMEOUT_TRANSITION);const s=e.className.includes("fullscreen");if(s?(e.classList.remove("fullscreen"),(n=document.getElementById("drag"))==null||n.classList.remove("fn__hidden")):(e.classList.add("fullscreen"),(a=document.getElementById("drag"))==null||a.classList.add("fn__hidden")),ie(),t){s?t.querySelector("use").setAttribute("xlink:href","#iconFullscreen"):t.querySelector("use").setAttribute("xlink:href","#iconFullscreenExit");const i=$(e,"layout--float");i&&(s?(i.setAttribute("data-temp",i.style.transform),i.style.transform="none"):(i.style.transform=i.getAttribute("data-temp"),i.removeAttribute("data-temp")));return}},Ll=(e,t)=>{if(!window.siyuan.config.readonly){const n=e.querySelector("use").getAttribute("xlink:href")!=="#iconUnlock";window.siyuan.config.editor.readOnly?n?Ls(t):pn(t):A("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{[f.CUSTOM_SY_READONLY]:n?"false":"true"}})}},wm=(e,t,n)=>{if(matchHotKey(window.siyuan.config.keymap.editor.general.netImg2LocalAsset.custom,t))return net2LocalAssets(e,"Img"),t.preventDefault(),t.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.general.netAssets2LocalAssets.custom,t))return net2LocalAssets(e,"Assets"),t.preventDefault(),t.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.general.optimizeTypography.custom,t))return fetchPost("/api/format/autoSpace",{id:e.block.rootID}),t.preventDefault(),t.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.general.copyHPath.custom,t))return fetchPost("/api/filetree/getHPathByID",{id:e.block.rootID},a=>{writeText(a.data)}),t.preventDefault(),t.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.general.copyProtocolInMd.custom,t)){if(n){const a=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));a.length===0&&a.push(n),copyTextByType(a.map(s=>s.getAttribute("data-node-id")),"protocolMd")}else copyTextByType([e.block.rootID],"protocolMd");return t.preventDefault(),t.stopPropagation(),!0}if(matchHotKey(window.siyuan.config.keymap.editor.general.copyID.custom,t)){if(n){const a=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));a.length===0&&a.push(n),copyTextByType(a.map(s=>s.getAttribute("data-node-id")),"id")}else copyTextByType([e.block.rootID],"id");return t.preventDefault(),t.stopPropagation(),!0}if(matchHotKey(window.siyuan.config.keymap.editor.general.copyProtocol.custom,t)){if(n){const a=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));a.length===0&&a.push(n),copyTextByType(a.map(s=>s.getAttribute("data-node-id")),"protocol")}else copyTextByType([e.block.rootID],"protocol");return t.preventDefault(),t.stopPropagation(),!0}if(matchHotKey(window.siyuan.config.keymap.editor.general.copyBlockEmbed.custom,t)){if(n){const a=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));a.length===0&&a.push(n),copyTextByType(a.map(s=>s.getAttribute("data-node-id")),"blockEmbed")}else copyTextByType([e.block.rootID],"blockEmbed");return t.preventDefault(),t.stopPropagation(),!0}},Or=e=>{const t=e.protyle.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(t.length>0)e.event.stopPropagation(),e.event.preventDefault();else{const s=O(e.range.startContainer,"TD")||O(e.range.startContainer,"TH")||oe(e.nodeElement)||e.nodeElement,i=Je(s,e.editorElement,e.range).start,l=s.innerText,o=te(window.siyuan.config.keymap.editor.general.expandUp.custom,e.event);if(!(!Lt()&&o)){if(i>0){l.substr(0,i).indexOf(`
`)===-1&&e.range.getBoundingClientRect().top-s.getBoundingClientRect().top-parseInt(getComputedStyle(s).paddingTop)<14&&(ya(s,e.range),e.event.preventDefault());return}}}e.range.collapse(!0),J(["toolbar"],e.protyle),t.length===0?e.nodeElement.classList.add("protyle-wysiwyg--select"):e.cb(t);const n=[];e.protyle.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").forEach(a=>{n.push(a.getAttribute("data-node-id"))}),Ht(n,e.protyle.block.rootID),e.event.stopPropagation(),e.event.preventDefault()},Rr=e=>{const t=e.protyle.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(t.length>0)e.event.stopPropagation(),e.event.preventDefault();else{const s=O(e.range.startContainer,"TD")||O(e.range.startContainer,"TH")||oe(e.nodeElement)||e.nodeElement,i=Je(s,e.editorElement,e.range).end,l=s.innerText,o=te(window.siyuan.config.keymap.editor.general.expandDown.custom,e.event);if(!(!Lt()&&o)){if(i<l.length){!et(e.nodeElement)&&l.trimRight().substr(i).indexOf(`
`)===-1&&s.getBoundingClientRect().bottom-e.range.getBoundingClientRect().bottom-parseInt(getComputedStyle(s).paddingBottom)<14&&(nt(s,e.range,!1),e.nodeElement.classList.contains("code-block")&&o&&e.event.preventDefault());return}}}e.range.collapse(!1),J(["toolbar"],e.protyle),t.length===0?e.nodeElement.classList.add("protyle-wysiwyg--select"):e.cb(t);const n=[];e.protyle.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").forEach(a=>{n.push(a.getAttribute("data-node-id"))}),Ht(n,e.protyle.block.rootID),e.event.stopPropagation(),e.event.preventDefault()},Br=e=>{let t,n;return e.forEach(a=>{a.getAttribute("select-start")&&(t=a),a.getAttribute("select-end")&&(n=a)}),t||(t=e[0],t.setAttribute("select-start","true")),n||(n=e[e.length-1],n.setAttribute("select-end","true")),{startElement:t,endElement:n}},Ur=(e,t)=>{let n;const a=[],s=[];let i;if(e[e.length-1].classList.contains("li")&&e[e.length-1].getAttribute("data-subtype")==="o"&&(i=parseInt(e[e.length-1].getAttribute("data-marker"),10)),e.reverse().forEach((l,o)=>{var r;const c=l.cloneNode(!0);o===0&&(n=c);const d=Lute.NewNodeID();if(c.setAttribute("data-node-id",d),c.setAttribute("data-node-id",d),c.removeAttribute(f.CUSTOM_RIFF_DECKS),c.classList.remove("protyle-wysiwyg--select","protyle-wysiwyg--hl"),c.setAttribute("updated",d.split("-")[0]),c.removeAttribute("refcount"),(r=c.lastElementChild.querySelector(".protyle-attr--refcount"))==null||r.remove(),c.querySelectorAll("[data-node-id]").forEach(u=>{var p;u.setAttribute("data-node-id",d),u.removeAttribute(f.CUSTOM_RIFF_DECKS),u.classList.remove("protyle-wysiwyg--select","protyle-wysiwyg--hl"),u.setAttribute("updated",d.split("-")[0]),u.removeAttribute("refcount"),(p=u.lastElementChild.querySelector(".protyle-attr--refcount"))==null||p.remove()}),l.classList.remove("protyle-wysiwyg--select"),typeof i=="number"){const u=i+(e.length-o);c.setAttribute("data-marker",u+"."),c.querySelector(".protyle-action--order").textContent=u+"."}e[0].after(Hn(c)),a.push({action:"insert",data:c.outerHTML,id:d,previousID:e[0].getAttribute("data-node-id")}),s.push({action:"delete",id:d})}),typeof i=="number"){let l=n.nextElementSibling;for(i=i+e.length;l&&l.getAttribute("data-subtype")==="o";){i++;const o=l.getAttribute("data-node-id");s.push({action:"update",id:o,data:l.outerHTML}),l.setAttribute("data-marker",i+"."),l.querySelector(".protyle-action--order").textContent=i+".",a.push({action:"update",data:l.outerHTML,id:o}),l=l.nextElementSibling}}q(t,a,s),ne(n),He(t)},sf=e=>{e.wysiwyg.element.firstElementChild.getAttribute("data-node-index")==="0"||e.wysiwyg.element.firstElementChild.getAttribute("data-eof")==="1"||e.options.backlinkData?(ne(e.wysiwyg.element.firstElementChild),e.contentElement.scrollTop=0,e.scroll.lastScrollTop=1):A("/api/filetree/getDoc",{id:e.block.rootID,mode:0,size:window.siyuan.config.editor.dynamicLoadBlocks},t=>{Qe({data:t,protyle:e,action:[f.CB_GET_FOCUS]})})},lf=e=>{!e.scroll.element.classList.contains("fn__none")&&e.wysiwyg.element.lastElementChild.getAttribute("data-eof")!=="2"?A("/api/filetree/getDoc",{id:e.block.rootID,mode:4,size:window.siyuan.config.editor.dynamicLoadBlocks},t=>{Qe({data:t,protyle:e,action:[f.CB_GET_FOCUS],afterCB(){ne(e.wysiwyg.element.lastElementChild,void 0,!1)}})}):(e.contentElement.scrollTop=e.contentElement.scrollHeight,e.scroll.lastScrollTop=e.contentElement.scrollTop,ne(e.wysiwyg.element.lastElementChild,void 0,!1))},Yr=(e,t,n,a,s)=>{t.setAttribute("updated",U().format("YYYYMMDDHHmmss")),n.forEach(i=>{i.style.minWidth="calc(100% - 0.1em)"}),K(e,a,t.outerHTML,s)},Fr=(e,t,n,a,s)=>{t.setAttribute("updated",U().format("YYYYMMDDHHmmss")),n.forEach(i=>{i.removeAttribute("style")}),K(e,a,t.outerHTML,s)},Ya=e=>{if(!e)return"";const t=me().extname(e).toLowerCase();return f.SIYUAN_ASSETS_IMAGE.includes(t)?`<img style="max-height: 100%" src="${e}">`:f.SIYUAN_ASSETS_AUDIO.includes(t)?`<audio style="max-width: 100%" controls="controls" src="${e}"></audio>`:f.SIYUAN_ASSETS_VIDEO.includes(t)?`<video style="max-width: 100%" controls="controls" src="${e}"></video>`:e},hm=()=>{},Wr=(e,t,n,a)=>{let s="";if(f.SIYUAN_ASSETS_AUDIO.includes(e))s=`<div data-node-id="${Lute.NewNodeID()}" data-type="NodeAudio" class="iframe" updated="${U().format("YYYYMMDDHHmmss")}"><div class="iframe-content"><audio controls="controls" src="${t}" data-src="${t}"></audio>${f.ZWSP}</div><div class="protyle-attr" contenteditable="false">${f.ZWSP}</div></div>`;else if(f.SIYUAN_ASSETS_IMAGE.includes(e)){let i="";t.startsWith("assets/")||(i='<span class="img__net"><svg><use xlink:href="#iconLanguage"></use></svg></span>'),s=`<span contenteditable="false" data-type="img" class="img"><span> </span><span><span class="protyle-action protyle-icons"><span class="protyle-icon protyle-icon--only"><svg><use xlink:href="#iconMore"></use></svg></span></span><img src="${t}" data-src="${t}" alt="${n}" /><span class="protyle-action__drag"></span>${i}<span class="protyle-action__title"></span></span><span> </span></span>`}else f.SIYUAN_ASSETS_VIDEO.includes(e)?s=`<div data-node-id="${Lute.NewNodeID()}" data-type="NodeVideo" class="iframe" updated="${U().format("YYYYMMDDHHmmss")}"><div class="iframe-content">${f.ZWSP}<video controls="controls" src="${t}" data-src="${t}"></video><span class="protyle-action__drag" contenteditable="false"></span></div><div class="protyle-attr" contenteditable="false">${f.ZWSP}</div></div>`:s=`<span data-type="a" data-href="${t}">${a}</span>`;return s},sn=e=>{const t=document.getElementById("model");t.style.transform="translateY(0px)",t.style.zIndex=(++window.siyuan.zIndex).toString();const n=t.querySelector(".toolbar__icon");e.icon?(n.classList.remove("fn__none"),n.querySelector("use").setAttribute("xlink:href","#"+e.icon)):n.classList.add("fn__none"),t.querySelector(".toolbar__text").innerHTML=e.title;const a=t.querySelector("#modelMain");a.innerHTML=e.html,e.bindEvent(a)};var of=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{o(n.next(r))}catch(c){s(c)}},l=r=>{try{o(n.throw(r))}catch(c){s(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,l);o((n=n.apply(e,t)).next())});const rf=(e,t)=>{const n=new we({title:window.siyuan.languages.searchType,content:`<div class="b3-dialog__content">
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconMath"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.math}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="mathBlock" type="checkbox"${e.types.mathBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconTable"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.table}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="table" type="checkbox"${e.types.table?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconParagraph"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.paragraph}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="paragraph" type="checkbox"${e.types.paragraph?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconHeadings"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.headings}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="heading" type="checkbox"${e.types.heading?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconCode"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.code}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="codeBlock" type="checkbox"${e.types.codeBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconHTML5"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            HTML
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="htmlBlock" type="checkbox"${e.types.htmlBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconDatabase"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.database}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="databaseBlock" type="checkbox"${e.types.databaseBlock?" checked":""}>
    </label>    
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconSQL"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.embedBlock}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="embedBlock" type="checkbox"${e.types.embedBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconVideo"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.video}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="videoBlock" type="checkbox"${e.types.videoBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconRecord"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.audio}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="audioBlock" type="checkbox"${e.types.audioBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconLanguage"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            IFrame
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="iframeBlock" type="checkbox"${e.types.iframeBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconBoth"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.widget}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="widgetBlock" type="checkbox"${e.types.widgetBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconQuote"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.quote} <sup>[1]</sup>
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="blockquote" type="checkbox"${e.types.blockquote?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconSuper"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.superBlock} <sup>[1]</sup>
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="superBlock" type="checkbox"${e.types.superBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconList"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.list1} <sup>[1]</sup>
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="list" type="checkbox"${e.types.list?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconListItem"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.listItem} <sup>[1]</sup>
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="listItem" type="checkbox"${e.types.listItem?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconFile"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.doc}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="document" type="checkbox"${e.types.document?" checked":""}>
    </label>
    <span class="fn__space"></span>
    <div class="fn__flex-1">
        <div class="b3-label__text">[1] ${window.siyuan.languages.containerBlockTip1}</div>
    </div>    
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:H()?"92vw":"520px",height:"70vh"});n.element.setAttribute("data-key",f.DIALOG_SEARCHTYPE);const a=n.element.querySelectorAll(".b3-button");a[0].addEventListener("click",()=>{n.destroy()}),a[1].addEventListener("click",()=>{n.element.querySelectorAll(".b3-switch").forEach(s=>{e.types[s.getAttribute("data-type")]=s.checked}),t(),n.destroy()})},cf=e=>{let t="";Object.keys(f.SIYUAN_DEFAULT_REPLACETYPES).forEach(s=>{t+=`<label class="fn__flex b3-label">
    <span class="fn__space"></span>
    <div class="fn__flex-1 fn__flex-center">
        ${window.siyuan.languages.replaceTypes[s]}
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" data-type="${s}" type="checkbox"${e.replaceTypes[s]?" checked":""}>
</label>`});const n=new we({title:window.siyuan.languages.replaceType,content:`<div class="b3-dialog__content">${t}</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:H()?"92vw":"520px",height:"70vh"});n.element.setAttribute("data-key",f.DIALOG_REPLACETYPE);const a=n.element.querySelectorAll(".b3-button");a[0].addEventListener("click",()=>{n.destroy()}),a[1].addEventListener("click",()=>{n.element.querySelectorAll(".b3-switch").forEach(s=>{e.replaceTypes[s.getAttribute("data-type")]=s.checked}),n.destroy()})},_m=(e,t)=>{if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="searchMethod"){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name","searchMethod"),window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",label:window.siyuan.languages.keyword,current:e.method===0,click(){e.method=0,t()}}).element),window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",label:window.siyuan.languages.querySyntax,current:e.method===1,click(){e.method=1,t()}}).element),window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",label:"SQL",current:e.method===2,click(){e.method=2,t()}}).element),window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",label:window.siyuan.languages.regex,current:e.method===3,click(){e.method=3,t()}}).element)},gs=(e,t,n,a,s)=>{e.removed=!1;const i=e;i.name=a,t.push(Object.assign({},i)),window.siyuan.storage[f.LOCAL_SEARCHDATA]=Object.assign({},e),Ae(f.LOCAL_SEARCHDATA,window.siyuan.storage[f.LOCAL_SEARCHDATA]),A("/api/storage/setCriterion",{criterion:i},()=>{var l;s.destroy();const o=n.querySelector("#criteria").firstElementChild;o.classList.remove("fn__none"),(l=o.querySelector(".b3-chip--current"))==null||l.classList.remove("b3-chip--current"),o.insertAdjacentHTML("beforeend",`<div data-type="set-criteria" class="b3-chip b3-chip--current b3-chip--middle b3-chip--pointer">${i.name}<svg class="b3-chip__close" data-type="remove-criteria"><use xlink:href="#iconCloseRound"></use></svg></div>`)})},df=(e,t,n)=>{const a=new we({title:window.siyuan.languages.saveCriterion,content:`<div class="b3-dialog__content">
        <input class="b3-text-field fn__block" placeholder="${window.siyuan.languages.memo}">
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:H()?"92vw":"520px"});a.element.setAttribute("data-key",f.DIALOG_SAVECRITERION);const s=a.element.querySelectorAll(".b3-button");a.bindInput(a.element.querySelector("input"),()=>{s[1].dispatchEvent(new CustomEvent("click"))}),s[0].addEventListener("click",()=>{a.destroy()}),s[1].addEventListener("click",()=>{const i=a.element.querySelector("input"),l=i.value.trim();if(!l){ae(window.siyuan.languages._kernel[142]);return}H()?(e.k=document.querySelector("#toolbarSearch").value,e.r=n.querySelector("#toolbarReplace").value):(e.k=n.querySelector("#searchInput").value,e.r=n.querySelector("#replaceInput").value);const o=n.querySelector("#criteria").firstElementChild;let r="",c="";if(t.forEach(d=>{d.name===l&&(r=d.name),jr(d,e)&&(c=d.name)}),i.blur(),r&&!c)$e(window.siyuan.languages.confirm,window.siyuan.languages.searchOverwrite,()=>{Array.from(o.children).forEach(d=>{d.textContent===l&&d.remove()}),t.find((d,u)=>{if(d.name===l)return t.splice(u,1),!0}),gs(e,t,n,l,a)});else if(r&&c)if(r===c)a.destroy();else{const d=r===l?c:r;$e(window.siyuan.languages.confirm,window.siyuan.languages.searchRemoveName.replace("${x}",d).replace("${y}",l),()=>{Array.from(o.children).forEach(u=>{(u.textContent===c||u.textContent===r)&&u.remove()}),t.find((u,p)=>{if(u.name===d||u.name===r)return A("/api/storage/removeCriterion",{name:d}),t.splice(p,1),!0}),gs(e,t,n,l,a)})}else!r&&c?$e(window.siyuan.languages.confirm,window.siyuan.languages.searchUpdateName.replace("${x}",c).replace("${y}",l),()=>{Array.from(o.children).forEach(d=>{d.textContent===c&&d.remove()}),t.find((d,u)=>{if(d.name===c)return A("/api/storage/removeCriterion",{name:c}),t.splice(u,1),!0}),gs(e,t,n,l,a)}):gs(e,t,n,l,a)})},uf=(e,t,n,a,s,i)=>of(void 0,null,function*(){if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="searchMore"){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name","searchMore"),window.siyuan.menus.menu.append(new M({iconHTML:"",label:window.siyuan.languages.listInvalidRefBlocks,click(){xf()}}).element),window.siyuan.menus.menu.append(new M({type:"separator"}).element),window.siyuan.menus.menu.append(new M({iconHTML:"",label:window.siyuan.languages.searchType,click(){rf(e,()=>{St(e,n,!0)})}}).element),window.siyuan.menus.menu.append(new M({iconHTML:"",label:window.siyuan.languages.replaceType,click(){cf(e)}}).element),window.siyuan.menus.menu.append(new M({iconHTML:"",label:window.siyuan.languages.searchMethod,type:"submenu",submenu:[{iconHTML:"",label:window.siyuan.languages.keyword,current:e.method===0,click(){e.method=0,e.page=1,St(e,n,!0)}},{iconHTML:"",label:window.siyuan.languages.querySyntax,current:e.method===1,click(){e.method=1,e.page=1,St(e,n,!0)}},{iconHTML:"",label:"SQL",current:e.method===2,click(){e.method=2,e.page=1,St(e,n,!0)}},{iconHTML:"",label:window.siyuan.languages.regex,current:e.method===3,click(){e.method=3,e.page=1,St(e,n,!0)}}]}).element);const l=[{iconHTML:"",label:window.siyuan.languages.type,current:e.sort===0,click(){e.sort=0,a()}},{iconHTML:"",label:window.siyuan.languages.createdASC,current:e.sort===1,click(){e.sort=1,a()}},{iconHTML:"",label:window.siyuan.languages.createdDESC,current:e.sort===2,click(){e.sort=2,a()}},{iconHTML:"",label:window.siyuan.languages.modifiedASC,current:e.sort===3,click(){e.sort=3,a()}},{iconHTML:"",label:window.siyuan.languages.modifiedDESC,current:e.sort===4,click(){e.sort=4,a()}},{iconHTML:"",label:window.siyuan.languages.sortByRankAsc,current:e.sort===6,click(){e.sort=6,a()}},{iconHTML:"",label:window.siyuan.languages.sortByRankDesc,current:e.sort===7,click(){e.sort=7,a()}}];e.group===1&&l.push({iconHTML:"",label:window.siyuan.languages.sortByContent,current:e.sort===5,click(){e.sort=5,a()}}),window.siyuan.menus.menu.append(new M({iconHTML:"",label:window.siyuan.languages.sort,type:"submenu",submenu:l}).element),window.siyuan.menus.menu.append(new M({iconHTML:"",label:window.siyuan.languages.group,type:"submenu",submenu:[{iconHTML:"",label:window.siyuan.languages.noGroupBy,current:e.group===0,click(){H()?(n.querySelector('[data-type="expand"]').classList.add("fn__none"),n.querySelector('[data-type="contract"]').classList.add("fn__none")):n.querySelector("#searchCollapse").parentElement.classList.add("fn__none"),e.group=0,e.sort===5&&(e.sort=0),a()}},{iconHTML:"",label:window.siyuan.languages.groupByDoc,current:e.group===1,click(){H()?(n.querySelector('[data-type="expand"]').classList.remove("fn__none"),n.querySelector('[data-type="contract"]').classList.remove("fn__none")):n.querySelector("#searchCollapse").parentElement.classList.remove("fn__none"),e.group=1,a()}}]}).element),i&&i(),window.siyuan.menus.menu.append(new M({type:"separator"}).element),window.siyuan.menus.menu.append(new M({label:window.siyuan.languages.saveCriterion,iconHTML:"",click(){df(e,t,n)}}).element),window.siyuan.menus.menu.append(new M({iconHTML:"",label:window.siyuan.languages.removeCriterion,click(){s()}}).element)}),jr=(e,t)=>!!(t.group===e.group&&t.hPath===e.hPath&&t.hasReplace===e.hasReplace&&t.k===e.k&&t.method===e.method&&t.r===e.r&&t.sort===e.sort&&kt(t.types,e.types)&&kt(t.replaceTypes,e.replaceTypes)&&kt(t.idPath,e.idPath)),ff=(e,t,n)=>{A("/api/storage/getCriteria",{},a=>{let s="";a.data.forEach(i=>{t.push(i);let l=!1;jr(i,n)&&(l=!0),s+=`<div data-type="set-criteria" class="${l?"b3-chip--current ":""}b3-chip b3-chip--middle b3-chip--pointer">${pe(i.name)}<svg class="b3-chip__close" data-type="remove-criteria"><use xlink:href="#iconCloseRound"></use></svg></div>`}),e.innerHTML=`<div class="b3-chips${s?"":" fn__none"}">
    ${s}
</div>`})},gf=e=>{const t=[];return e.querySelectorAll("mark").forEach(n=>{t.push(n.textContent)}),[...new Set(t)].join(" ")},pf=e=>{let t="",n="";return window.siyuan.mobile.editor&&document.getElementById("empty").classList.contains("fn__none")&&(t=window.siyuan.mobile.editor.protyle.notebookId,e?n=window.siyuan.mobile.editor.protyle.path:n=me().dirname(window.siyuan.mobile.editor.protyle.path)),t||window.siyuan.notebooks.find(a=>{if(!a.closed)return t=a.id,n="/",!0}),{notebookId:t,currentPath:n}},aa=e=>{if(as()===0){ae(window.siyuan.languages.newFileTip);return}if(!e.notebookId){const t=pf(e.useSavePath);e.notebookId=t.notebookId,e.currentPath=t.currentPath}A("/api/filetree/getDocCreateSavePath",{notebook:e.notebookId},t=>{if(e.useSavePath||(t.data.box=e.notebookId),t.data.path.indexOf("/")>-1&&e.useSavePath||e.name)if(t.data.path.startsWith("/")||e.currentPath==="/"){const n=me().join(t.data.path,e.name||(t.data.path.endsWith("/")?window.siyuan.languages.untitled:""));A("/api/filetree/createDocWithMd",{notebook:t.data.box,path:n,markdown:"",listDocTree:e.listDocTree},a=>{e.afterCB&&e.afterCB(a.data,me().basename(n)),at(e.app,a.data,[f.CB_GET_CONTEXT,f.CB_GET_OPENNEW])})}else A("/api/filetree/getHPathByPath",{notebook:t.data.box,path:e.notebookId===t.data.box?e.currentPath.endsWith(".sy")?e.currentPath:e.currentPath+".sy":t.data.path||"/"},n=>{const a=me().join(n.data,t.data.path,e.name||(t.data.path.endsWith("/")?window.siyuan.languages.untitled:""));A("/api/filetree/createDocWithMd",{notebook:t.data.box,path:a,parentID:ct(e.currentPath,!0,!0),markdown:"",listDocTree:e.listDocTree},s=>{e.afterCB&&e.afterCB(s.data,me().basename(a)),at(e.app,s.data,[f.CB_GET_CONTEXT,f.CB_GET_OPENNEW])})});else{const n=me().basename(t.data.path||window.siyuan.languages.untitled);if(!ki(n))return;if(e.notebookId!==t.data.box){const i=me().join(t.data.path||"/",e.name||(t.data.path.endsWith("/")?window.siyuan.languages.untitled:""));A("/api/filetree/createDocWithMd",{notebook:t.data.box,path:i,markdown:"",listDocTree:e.listDocTree},l=>{e.afterCB&&e.afterCB(l.data,me().basename(i)),at(e.app,l.data,[f.CB_GET_CONTEXT,f.CB_GET_OPENNEW])});return}const a=Lute.NewNodeID(),s=me().join(ct(e.currentPath,!1,!0),a+".sy");e.paths&&(e.paths[e.paths.indexOf(void 0)]=s),A("/api/filetree/createDoc",{notebook:t.data.box,path:s,title:n,md:"",sorts:e.paths,listDocTree:e.listDocTree},()=>{e.afterCB&&e.afterCB(a,n),at(e.app,a,[f.CB_GET_CONTEXT,f.CB_GET_OPENNEW])})}})},Sl=(e,t,n)=>{A("/api/filetree/getRefCreateSavePath",{notebook:t},a=>{let s=e;t!==a.data.box&&(s=a.data.path||"/"),a.data.path?a.data.path.startsWith("/")?n(ct(a.data.path,!1,!0),a.data.box):A("/api/filetree/getHPathByPath",{notebook:a.data.box,path:s},i=>{n(ct(me().join(i.data,a.data.path),!1,!0),a.data.box)}):A("/api/filetree/getHPathByPath",{notebook:a.data.box,path:s},i=>{n(ct(i.data,!1,!0),a.data.box)})})},Vr=(e,t)=>{J(["dialog"]),aa({app:e,useSavePath:!0,name:Pn(t.trim())||window.siyuan.languages.untitled})},zr=(e,t,n,a,s)=>{const i=Pn(t.trim()?t.trim():e.lute.BlockDOM2Content(n.outerHTML).replace(/\n/g,"").trim())||window.siyuan.languages.untitled,l=me().join(a,i);A("/api/filetree/getIDsByHPath",{path:l,notebook:s},o=>{const r=pe(i.substring(0,window.siyuan.config.editor.blockRefDynamicAnchorTextMaxLen));o.data&&o.data.length>0?e.toolbar.setInlineMark(e,"block-ref","range",{type:"id",color:`${o.data[0]}${f.ZWSP}d${f.ZWSP}${r}`}):A("/api/filetree/createDocWithMd",{notebook:s,path:l,parentID:e.notebookId===s?e.block.rootID:"",markdown:""},c=>{e.toolbar.setInlineMark(e,"block-ref","range",{type:"id",color:`${c.data}${f.ZWSP}d${f.ZWSP}${r}`})}),J(["toolbar"],e)})},vm=(e,t)=>{};let Gr;const En=(e,t,n=1)=>{var a;const s=e.parentElement.querySelector(".fn__loading--top");if(!zn()){s.classList.add("fn__none"),(a=e.querySelector(".search__drag"))==null||a.classList.add("fn__none"),e.querySelector("#searchAssetPreview").classList.add("fn__none"),e.querySelector("#searchAssetList").innerHTML=`<div class="search__empty">
    ${window.siyuan.languages._kernel[214]}
</div>`;return}s.classList.remove("fn__none"),clearTimeout(Gr),Gr=window.setTimeout(()=>{t||(t=window.siyuan.storage[f.LOCAL_SEARCHASSET]);const i=e.querySelector('[data-type="assetPrevious"]');n>1?i.removeAttribute("disabled"):i.setAttribute("disabled","disabled");const l=e.querySelector("#searchAssetInput");A("/api/search/fullTextSearchAssetContent",{page:n,query:l.value,types:t.types,method:t.method,orderBy:t.sort},o=>{var r,c;s.classList.add("fn__none");const d=e.querySelector('[data-type="assetNext"]');n<o.data.pageCount?d.removeAttribute("disabled"):d.setAttribute("disabled","disabled");let u="";o.data.assetContents.forEach((g,m)=>{u+=`<div data-type="search-item" class="b3-list-item${m===0?" b3-list-item--focus":""}" data-id="${g.id}">
<span class="ft__on-surface">${g.ext}</span>
<span class="fn__space"></span>
<span class="b3-list-item__text">${g.content}</span>
<span class="b3-list-item__meta">${g.hSize}</span>
<span class="b3-list-item__meta b3-list-item__meta--ellipsis ariaLabel" aria-label="${Nt(g.path)}">${g.name}</span>
</div>`});const p=e.querySelector("#searchAssetPreview");o.data.assetContents.length>0?(p.classList.remove("fn__none"),(r=e.querySelector(".search__drag"))==null||r.classList.remove("fn__none"),Kr(p,o.data.assetContents[0].id,l.value,t.method)):(p.classList.add("fn__none"),(c=e.querySelector(".search__drag"))==null||c.classList.add("fn__none")),e.querySelector("#searchAssetResult").innerHTML=`<span class="fn__flex-center">${n}/${o.data.pageCount||1}</span><span class="fn__space"></span>
<span class="ft__on-surface">${window.siyuan.languages.total} ${o.data.matchedAssetCount}</span>`,e.querySelector("#searchAssetList").innerHTML=u||`<div class="search__empty">
    ${window.siyuan.languages.emptyContent}
</div>`})},f.TIMEOUT_INPUT)},Kr=(e,t,n,a)=>{A("/api/search/getAssetContent",{id:t,query:n,queryMethod:a},s=>{e.innerHTML=`<p style="white-space: pre-wrap;">${s.data.assetContent.content}</p>`;const i=e.querySelector("mark");if(i){i.classList.add("mark--hl");const l=e.getBoundingClientRect();e.scrollTop=e.scrollTop+i.getBoundingClientRect().top-l.top-l.height/2}})},mf=e=>{let t;const n=Array.from(e.querySelectorAll("mark"));if(n.find((a,s)=>{if(a.classList.contains("mark--hl")){a.classList.remove("mark--hl"),t=n[s+1];return}}),t||(t=n[0]),t){t.classList.add("mark--hl");const a=e.getBoundingClientRect();e.scrollTop=e.scrollTop+t.getBoundingClientRect().top-a.top-a.height/2}},bf=(e,t)=>{const n=window.siyuan.storage[f.LOCAL_SEARCHASSET].method;if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="searchAssetMethod"){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name","searchAssetMethod"),window.siyuan.menus.menu.append(new M({iconHTML:"",label:window.siyuan.languages.keyword,current:n===0,click(){window.siyuan.storage[f.LOCAL_SEARCHASSET].method=0,t()}}).element),window.siyuan.menus.menu.append(new M({iconHTML:"",label:window.siyuan.languages.querySyntax,current:n===1,click(){window.siyuan.storage[f.LOCAL_SEARCHASSET].method=1,t()}}).element),window.siyuan.menus.menu.append(new M({iconHTML:"",label:window.siyuan.languages.regex,current:n===3,click(){window.siyuan.storage[f.LOCAL_SEARCHASSET].method=3,t()}}).element),window.siyuan.menus.menu.fullscreen()},yf=e=>{let t="";return f.SIYUAN_ASSETS_SEARCH.sort((n,a)=>n.localeCompare(a)).forEach(n=>{t+=`<label class="fn__flex b3-label">
        <div class="fn__flex-1 fn__flex-center">
            ${n}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="${n}" type="checkbox" ${e[n]?" checked":""}>
    </label>`}),t},wf=e=>{const t=window.siyuan.storage[f.LOCAL_SEARCHASSET].types,n=new we({title:window.siyuan.languages.type,content:`<div class="b3-dialog__content">${yf(t)}</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:"520px",height:"70vh"});n.element.setAttribute("data-key",f.DIALOG_SEARCHASSETSTYPE);const a=n.element.querySelectorAll(".b3-button");a[0].addEventListener("click",()=>{n.destroy()}),a[1].addEventListener("click",()=>{n.element.querySelectorAll(".b3-switch").forEach(s=>{t[s.getAttribute("data-type")]=s.checked}),En(e),Ae(f.LOCAL_SEARCHASSET,window.siyuan.storage[f.LOCAL_SEARCHASSET]),n.destroy()})},hf=(e,t,n)=>{if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="searchAssetMore"){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name","searchAssetMore");const a=window.siyuan.storage[f.LOCAL_SEARCHASSET],s=[{iconHTML:"",label:window.siyuan.languages.sortByRankAsc,current:a.sort===1,click(){a.sort=1,n()}},{iconHTML:"",label:window.siyuan.languages.sortByRankDesc,current:a.sort===0,click(){a.sort=0,n()}},{iconHTML:"",label:window.siyuan.languages.modifiedASC,current:a.sort===3,click(){a.sort=3,n()}},{iconHTML:"",label:window.siyuan.languages.modifiedDESC,current:a.sort===2,click(){a.sort=2,n()}}];window.siyuan.menus.menu.append(new M({iconHTML:"",label:window.siyuan.languages.sort,type:"submenu",submenu:s}).element),window.siyuan.menus.menu.append(new M({iconHTML:"",label:window.siyuan.languages.rebuildIndex,click(){if(!zn()){ae(window.siyuan.languages._kernel[214]);return}t.parentElement.querySelector(".fn__loading--top").classList.remove("fn__none"),A("/api/asset/fullReindexAssetContent",{},()=>{En(t,a)})}}).element),window.siyuan.menus.menu.fullscreen()},xl=(e,t,n)=>{e.value===""?(t.classList.add("fn__none"),typeof n=="number"&&(e.style.paddingRight=e.dataset.oldPaddingRight)):(t.classList.remove("fn__none"),typeof n=="number"&&e.style.setProperty("padding-right",`${n*2+t.clientWidth}px`,"important"))},ps=e=>{e.inputElement.dataset.oldPaddingRight=e.inputElement.style.paddingRight,e.inputElement.insertAdjacentHTML("afterend",`<svg class="${e.className||"b3-form__icon-clear"} ariaLabel" aria-label="${window.siyuan.languages.clear}" style="${e.right?"right: "+e.right+"px;":""}${e.height?"height:"+e.height+"px;":""}${e.width?"width:"+e.width:""}">
<use xlink:href="#iconCloseRound"></use></svg>`);const t=e.inputElement.nextElementSibling;t.addEventListener("click",()=>{e.inputElement.value="",e.inputElement.focus(),xl(e.inputElement,t,e.right),e.clearCB&&e.clearCB()}),e.inputElement.addEventListener("input",()=>{xl(e.inputElement,t,e.right)}),xl(e.inputElement,t,e.right)},Zr=()=>({audioBlock:window.siyuan.config.search.audioBlock,videoBlock:window.siyuan.config.search.videoBlock,iframeBlock:window.siyuan.config.search.iframeBlock,widgetBlock:window.siyuan.config.search.widgetBlock,document:window.siyuan.config.search.document,heading:window.siyuan.config.search.heading,list:window.siyuan.config.search.list,listItem:window.siyuan.config.search.listItem,codeBlock:window.siyuan.config.search.codeBlock,htmlBlock:window.siyuan.config.search.htmlBlock,mathBlock:window.siyuan.config.search.mathBlock,table:window.siyuan.config.search.table,blockquote:window.siyuan.config.search.blockquote,superBlock:window.siyuan.config.search.superBlock,paragraph:window.siyuan.config.search.paragraph,embedBlock:window.siyuan.config.search.embedBlock,databaseBlock:window.siyuan.config.search.databaseBlock}),_f=e=>{const t=window.siyuan.storage[f.LOCAL_SEARCHKEYS];if(!t.replaceKeys||t.replaceKeys.length===0||t.length===1&&t[0]===e.value)return;const n=new Ke("search-replace-history");if(n.isOpen)return;n.element.classList.add("b3-menu--list"),n.addItem({iconHTML:"",label:window.siyuan.languages.clearHistory,click(){window.siyuan.storage[f.LOCAL_SEARCHKEYS].replaceKeys=[],Ae(f.LOCAL_SEARCHKEYS,window.siyuan.storage[f.LOCAL_SEARCHKEYS])}});const a=n.addSeparator(1);let s=!0;t.replaceKeys.forEach(l=>{if(l!==e.value&&l){const o=n.addItem({iconHTML:"",label:pe(l),action:"iconCloseRound",bind(r){r.addEventListener("click",c=>{var d;$(c.target,"b3-menu__action")?(t.replaceKeys.find((u,p)=>{if(u===l)return t.replaceKeys.splice(p,1),!0}),window.siyuan.storage[f.LOCAL_SEARCHKEYS].replaceKeys=t.replaceKeys,Ae(f.LOCAL_SEARCHKEYS,window.siyuan.storage[f.LOCAL_SEARCHKEYS]),(d=r.previousElementSibling)!=null&&d.classList.contains("b3-menu__separator")&&!r.nextElementSibling?window.siyuan.menus.menu.remove():r.remove()):(e.value=r.textContent,window.siyuan.menus.menu.remove()),c.preventDefault(),c.stopPropagation()})}});s&&o.classList.add("b3-menu__item--current"),s=!1}}),s&&a.remove();const i=e.previousElementSibling.getBoundingClientRect();n.open({x:i.left,y:i.bottom})},vf=(e,t,n)=>{const a=e.querySelector("#searchInput, #toolbarSearch"),s=window.siyuan.storage[f.LOCAL_SEARCHKEYS];if(!s.keys||s.keys.length===0||s.length===1&&s[0]===a.value)return;const i=new Ke("search-history");if(i.isOpen)return;i.element.classList.add("b3-menu--list"),i.addItem({iconHTML:"",label:window.siyuan.languages.clearHistory,click(){window.siyuan.storage[f.LOCAL_SEARCHKEYS].keys=[],Ae(f.LOCAL_SEARCHKEYS,window.siyuan.storage[f.LOCAL_SEARCHKEYS])}});const l=i.addSeparator(1);let o=!0;s.keys.forEach(c=>{if(c!==a.value&&c){const d=i.addItem({iconHTML:"",label:pe(c),action:"iconCloseRound",bind(u){u.addEventListener("click",p=>{var g;$(p.target,"b3-menu__action")?(s.keys.find((m,b)=>{if(m===c)return s.keys.splice(b,1),!0}),window.siyuan.storage[f.LOCAL_SEARCHKEYS].keys=s.keys,Ae(f.LOCAL_SEARCHKEYS,window.siyuan.storage[f.LOCAL_SEARCHKEYS]),(g=u.previousElementSibling)!=null&&g.classList.contains("b3-menu__separator")&&!u.nextElementSibling?window.siyuan.menus.menu.remove():u.remove()):(a.value=u.textContent,t.page=1,St(t,e,!0),window.siyuan.menus.menu.remove()),p.preventDefault(),p.stopPropagation()})}});o&&d.classList.add("b3-menu__item--current"),o=!1}}),o&&l.remove();const r=a.previousElementSibling.getBoundingClientRect();i.open({x:r.left,y:r.bottom})},kf=e=>{const t=e.querySelector("#searchAssetInput"),n=window.siyuan.storage[f.LOCAL_SEARCHASSET].keys;if(!n||n.length===0||n.length===1&&n[0]===t.value)return;const a=new Ke("search-asset-history");if(a.isOpen)return;a.element.classList.add("b3-menu--list"),a.addItem({iconHTML:"",label:window.siyuan.languages.clearHistory,click(){window.siyuan.storage[f.LOCAL_SEARCHASSET].keys=[],Ae(f.LOCAL_SEARCHASSET,window.siyuan.storage[f.LOCAL_SEARCHASSET])}});const s=a.addSeparator(1);let i=!0;n.forEach(o=>{if(o!==t.value&&o){const r=a.addItem({iconHTML:"",label:pe(o),action:"iconCloseRound",bind(c){c.addEventListener("click",d=>{var u;$(d.target,"b3-menu__action")?(n.find((p,g)=>{if(p===o)return n.splice(g,1),!0}),window.siyuan.storage[f.LOCAL_SEARCHASSET].keys=n,Ae(f.LOCAL_SEARCHASSET,window.siyuan.storage[f.LOCAL_SEARCHASSET]),(u=c.previousElementSibling)!=null&&u.classList.contains("b3-menu__separator")&&!c.nextElementSibling?window.siyuan.menus.menu.remove():c.remove()):(t.value=c.textContent,En(e),window.siyuan.menus.menu.remove()),d.preventDefault(),d.stopPropagation()})}});i&&r.classList.add("b3-menu__item--current"),i=!1}}),i&&s.remove();const l=t.previousElementSibling.getBoundingClientRect();a.open({x:l.left,y:l.bottom})},Xr=(e,t)=>{let n=window.siyuan.storage[f.LOCAL_SEARCHKEYS][e];n.splice(0,0,t),n=Array.from(new Set(n)),n.length>window.siyuan.config.search.limit&&n.splice(window.siyuan.config.search.limit,n.length-window.siyuan.config.search.limit),window.siyuan.storage[f.LOCAL_SEARCHKEYS][e]=n,Ae(f.LOCAL_SEARCHKEYS,window.siyuan.storage[f.LOCAL_SEARCHKEYS])},Ef=e=>{if(!e.value)return;let t=window.siyuan.storage[f.LOCAL_SEARCHASSET].keys;t.splice(0,0,e.value),t=Array.from(new Set(t)),t.length>window.siyuan.config.search.limit&&t.splice(window.siyuan.config.search.limit,t.length-window.siyuan.config.search.limit),window.siyuan.storage[f.LOCAL_SEARCHASSET].k=e.value,window.siyuan.storage[f.LOCAL_SEARCHASSET].keys=t,Ae(f.LOCAL_SEARCHASSET,window.siyuan.storage[f.LOCAL_SEARCHASSET])},Jr=(e,t,n)=>{if(t.method===1||t.method===2){ae(window.siyuan.languages._kernel[132]);return}const a=e.querySelector("#searchList"),s=e.querySelector("#toolbarReplace"),i=s.parentElement.querySelector(".fn__rotate");if(!i.classList.contains("fn__none"))return;Xr("replaceKeys",s.value);let l=a.querySelector(".b3-list-item--focus");if(!l)return;i.classList.remove("fn__none"),i.nextElementSibling.classList.add("fn__none");let o=[];n?a.querySelectorAll('.b3-list-item[data-type="search-item"]').forEach(r=>{o.push(r.getAttribute("data-node-id"))}):o=[l.getAttribute("data-node-id")],A("/api/search/findReplace",{k:t.method===0?gf(l):document.querySelector("#toolbarSearch").value,r:s.value,ids:o,types:t.types,method:t.method,replaceTypes:t.replaceTypes},r=>{var c;if(i.classList.add("fn__none"),i.nextElementSibling.classList.remove("fn__none"),r.code===1){ae(r.msg);return}if(!(o.length>1)){if(Un(window.siyuan.mobile.editor.protyle,!1),l.nextElementSibling?l.nextElementSibling.classList.add("b3-list-item--focus"):l.previousElementSibling&&l.previousElementSibling.classList.add("b3-list-item--focus"),t.group===1)if(l.nextElementSibling||l.previousElementSibling)l.remove();else{const d=l.parentElement.nextElementSibling||((c=l.parentElement.previousElementSibling.previousElementSibling)==null?void 0:c.previousElementSibling);d&&(d.nextElementSibling.firstElementChild.classList.add("b3-list-item--focus"),d.nextElementSibling.classList.remove("fn__none"),d.firstElementChild.firstElementChild.classList.add("b3-list-item__arrow--open")),l.parentElement.previousElementSibling.remove(),l.parentElement.remove()}else l.remove();if(l=a.querySelector(".b3-list-item--focus"),!l){a.innerHTML=`<div class="b3-list--empty">${window.siyuan.languages.emptyContent}</div>`;return}(a.scrollTop<l.offsetTop-a.clientHeight+30||a.scrollTop>l.offsetTop)&&(a.scrollTop=l.offsetTop-a.clientHeight+30)}})},Al=(e,t,n)=>{n.hasReplace!==t.hasReplace&&(t.hasReplace?(e.querySelector('[data-type="toggle-replace"]').classList.add("toolbar__icon--active"),e.querySelector(".toolbar").classList.remove("fn__none")):(e.querySelector('[data-type="toggle-replace"]').classList.remove("toolbar__icon--active"),e.querySelector(".toolbar").classList.add("fn__none")));const a=e.querySelector("#searchPath");t.hPath?(a.classList.remove("fn__none"),a.innerHTML=`<div class="b3-chip b3-chip--middle">${pe(t.hPath)}<svg data-type="remove-path" class="b3-chip__close"><use xlink:href="#iconCloseRound"></use></svg></div>`):a.classList.add("fn__none"),n.group!==t.group&&(t.group===0?(e.querySelector('[data-type="expand"]').classList.add("fn__none"),e.querySelector('[data-type="contract"]').classList.add("fn__none")):(e.querySelector('[data-type="expand"]').classList.remove("fn__none"),e.querySelector('[data-type="contract"]').classList.remove("fn__none")));let s=!0,i=!1;t.idPath.forEach(o=>{o.endsWith(".sy")&&(s=!1),o.split("/").length>1&&(i=!0)});const l=e.querySelector('[data-type="include"]');s?l.classList.add("toolbar__icon--active"):l.classList.remove("toolbar__icon--active"),i?l.removeAttribute("disabled"):l.setAttribute("disabled","disabled"),document.querySelector("#toolbarSearch").value=t.k,e.querySelector("#toolbarReplace").value=t.r,Object.assign(n,t),window.siyuan.storage[f.LOCAL_SEARCHDATA]=Object.assign({},n),Ae(f.LOCAL_SEARCHDATA,window.siyuan.storage[f.LOCAL_SEARCHDATA]),St(n,e),window.siyuan.menus.menu.remove()},Qr=(e,t,n)=>{const a=document.querySelector("#searchList");let s="";e.forEach((l,o)=>{const r=Ft(l.box)+ct(l.hPath,!1);l.children?(s+=`<div class="b3-list-item">
<span class="b3-list-item__toggle b3-list-item__toggle--hl">
    <svg class="b3-list-item__arrow b3-list-item__arrow--open"><use xlink:href="#iconRight"></use></svg>
</span>
${ge(gu(l.box)||window.siyuan.storage[f.LOCAL_IMAGES].note,"b3-list-item__graphic",!0)}
<span class="b3-list-item__text" style="color: var(--b3-theme-on-surface)">${Ji(r)}</span>
</div><div>`,l.children.forEach((c,d)=>{s+=`<div style="padding-left: 36px" data-type="search-item" class="b3-list-item${d===0&&o===0?" b3-list-item--focus":""}" data-node-id="${c.id}">
<svg class="b3-list-item__graphic"><use xlink:href="#${dn(c.type)}"></use></svg>
${ge(c.ial.icon,"b3-list-item__graphic",!0)}
<span class="b3-list-item__text">${c.content}</span>
</div>`}),s+="</div>"):s+=`<div class="b3-list-item b3-list-item--two${o===0?" b3-list-item--focus":""}" data-type="search-item" data-node-id="${l.id}">
<div class="b3-list-item__first">
    <svg class="b3-list-item__graphic"><use xlink:href="#${dn(l.type)}"></use></svg>
    ${ge(l.ial.icon,"b3-list-item__graphic",!0)}
    <span class="b3-list-item__text">${l.content}</span>
</div>
<span class="b3-list-item__text b3-list-item__meta">${Ji(r)}</span>
</div>`}),a.innerHTML=s||`<div class="b3-list-item b3-list-item--focus" data-type="search-new">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg>
    <span class="b3-list-item__text">
        ${window.siyuan.languages.newFile} <mark>${document.querySelector("#toolbarSearch").value}</mark>
    </span>
</div>`,a.scrollTop=0;let i="";if(n){let l=window.siyuan.languages.findInDoc.replace("${x}",n.data.matchedRootCount).replace("${y}",n.data.matchedBlockCount);n.data.docMode&&(l=window.siyuan.languages.matchDoc.replace("${x}",n.data.matchedRootCount)),i=`<span class="fn__flex-center">${l}</span>
<span class="fn__flex-1"></span>
<span class="fn__flex-center">${t.page}/${n.data.pageCount||1}</span>`}a.previousElementSibling.querySelector('[data-type="result"]').innerHTML=i};let ec=0;const St=(e,t,n=!1)=>{clearTimeout(ec),ec=window.setTimeout(()=>{var a;n&&((a=t.querySelector("#criteria .b3-chip--current"))==null||a.classList.remove("b3-chip--current"));const s=t.querySelector(".fn__loading--top");s.classList.remove("fn__none");const i=t.querySelector('[data-type="previous"]'),l=t.querySelector('[data-type="next"]'),o=document.getElementById("toolbarSearch");o.value===""&&(!e.idPath||e.idPath.length===0)?A("/api/block/getRecentUpdatedBlocks",{},r=>{Qr(r.data,e),s.classList.add("fn__none"),i.setAttribute("disabled","true"),l.setAttribute("disabled","true")}):(e.page||(e.page=1),e.page>1?i.removeAttribute("disabled"):i.setAttribute("disabled","disabled"),A("/api/search/fullTextSearchBlock",{query:o.value,method:e.method,types:e.types,paths:e.idPath||[],groupBy:e.group,orderBy:e.sort,page:e.page},r=>{Qr(r.data.blocks,e,r),s.classList.add("fn__none"),e.page<r.data.pageCount?l.removeAttribute("disabled"):l.setAttribute("disabled","disabled")}))},f.TIMEOUT_INPUT)},Lf=(e,t,n)=>{const a=document.getElementById("toolbarSearch");a.value=n.k||"",a.addEventListener("compositionend",d=>{d&&d.isComposing||(n.page=1,St(n,t,!0))}),a.addEventListener("input",d=>{d&&d.isComposing||(n.page=1,St(n,t,!0))}),a.addEventListener("blur",()=>{n.removed&&(n.k=a.value,window.siyuan.storage[f.LOCAL_SEARCHDATA]=Object.assign({},n),Ae(f.LOCAL_SEARCHDATA,window.siyuan.storage[f.LOCAL_SEARCHDATA])),Xr("keys",a.value)}),ps({inputElement:a,className:"toolbar__icon",clearCB(){n.page=1,St(n,t)}});const s=t.querySelector(".toolbar .toolbar__title");s.value=n.r||"",ps({inputElement:s,className:"toolbar__icon"});const i=[];ff(t.querySelector("#criteria"),i,n);const l=document.querySelector("#searchAssetsPanel"),o=document.querySelector("#searchUnRefPanel"),r=t.querySelector("#searchList"),c=window.siyuan.storage[f.LOCAL_SEARCHASSET];t.addEventListener("click",d=>{var u,p;let g=d.target;for(;g&&!g.isSameNode(t);){const m=g.getAttribute("data-type");if(m==="replaceHistory"){_f(g.nextElementSibling),d.stopPropagation(),d.preventDefault();break}else if(m==="assetHistory"){kf(l),d.stopPropagation(),d.preventDefault();break}else if(m==="previous"){g.getAttribute("disabled")||(n.page--,St(n,t)),d.stopPropagation(),d.preventDefault();break}else if(m==="next"){g.getAttribute("disabled")||(n.page++,St(n,t)),d.stopPropagation(),d.preventDefault();break}else if(m==="set-criteria"){n.removed=!1,(u=g.parentElement.querySelector(".b3-chip--current"))==null||u.classList.remove("b3-chip--current"),g.classList.add("b3-chip--current"),i.find(b=>{if(b.name===g.innerText.trim())return Al(t,b,n),!0}),d.stopPropagation(),d.preventDefault();break}else if(m==="remove-criteria"){const b=g.parentElement.innerText.trim();A("/api/storage/removeCriterion",{name:b}),i.find((y,_)=>{if(y.name===b)return i.splice(_,1),!0}),g.parentElement.classList.contains("b3-chip--current")&&Al(t,{removed:!0,sort:0,group:0,hasReplace:!1,method:0,hPath:"",idPath:[],k:"",r:"",page:1,types:Zr(),replaceTypes:Object.assign({},f.SIYUAN_DEFAULT_REPLACETYPES)},n),g.parentElement.parentElement.childElementCount===1&&g.parentElement.parentElement.classList.add("fn__none"),g.parentElement.remove(),d.stopPropagation(),d.preventDefault();break}else if(m==="remove-path"){n.idPath=[],n.hPath="",t.querySelector("#searchPath").classList.add("fn__none"),n.page=1,St(n,t,!0);const b=t.querySelector('[data-type="include"]');b.classList.remove("toolbar__icon--active"),b.setAttribute("disabled","disabled"),d.stopPropagation(),d.preventDefault();break}else if(m==="expand"){Array.from(r.children).forEach(b=>{b.classList.contains("b3-list-item")&&(b.querySelector(".b3-list-item__arrow").classList.add("b3-list-item__arrow--open"),b.nextElementSibling.classList.remove("fn__none"))}),d.stopPropagation(),d.preventDefault();break}else if(m==="contract"){Array.from(r.children).forEach(b=>{b.classList.contains("b3-list-item")&&(b.querySelector(".b3-list-item__arrow").classList.remove("b3-list-item__arrow--open"),b.nextElementSibling.classList.add("fn__none"))}),d.stopPropagation(),d.preventDefault();break}else if(m==="currentPath"&&!g.hasAttribute("disabled")){const b=Dt().protyle;A("/api/filetree/getHPathsByPaths",{paths:[b.path]},y=>{n.idPath=[me().join(b.notebookId,b.path)],n.hPath=y.data[0];const _=t.querySelector("#searchPath");_.classList.remove("fn__none"),_.innerHTML=`<div class="b3-chip b3-chip--middle">${pe(n.hPath)}<svg data-type="remove-path" class="b3-chip__close"><use xlink:href="#iconCloseRound"></use></svg></div>`;const w=t.querySelector('[data-type="include"]');w.classList.remove("toolbar__icon--active"),w.removeAttribute("disabled"),n.page=1,St(n,t,!0)}),d.stopPropagation(),d.preventDefault();break}else if(m==="path"){Wn((b,y)=>{A("/api/filetree/getHPathsByPaths",{paths:b},_=>{n.idPath=[];const w=[];let v=!1;b.forEach((S,L)=>{S==="/"?(n.idPath.push(y[L]),w.push(Ft(y[L]))):(v=!0,n.idPath.push(me().join(y[L],S.replace(".sy",""))))}),_.data&&w.push(..._.data),n.hPath=w.join(" ");const h=t.querySelector("#searchPath");h.classList.remove("fn__none"),h.innerHTML=`<div class="b3-chip b3-chip--middle">${pe(n.hPath)}<svg data-type="remove-path" class="b3-chip__close"><use xlink:href="#iconCloseRound"></use></svg></div>`;const E=t.querySelector('[data-type="include"]');E.classList.add("toolbar__icon--active"),v?E.removeAttribute("disabled"):E.setAttribute("disabled","disabled"),n.page=1,St(n,t,!0)})},[],void 0,window.siyuan.languages.specifyPath),d.stopPropagation(),d.preventDefault();break}else if(m==="include"&&!g.hasAttribute("disabled")){g.classList.toggle("toolbar__icon--active"),g.classList.contains("toolbar__icon--active")?n.idPath.forEach((b,y)=>{b.endsWith(".sy")&&(n.idPath[y]=b.replace(".sy",""))}):n.idPath.forEach((b,y)=>{!b.endsWith(".sy")&&b.split("/").length>1&&(n.idPath[y]=b+".sy")}),n.page=1,St(n,t,!0),d.stopPropagation(),d.preventDefault();break}else if(m==="toggle-replace"){n.hasReplace=!n.hasReplace,s.parentElement.classList.toggle("fn__none"),g.classList.toggle("toolbar__icon--active"),d.stopPropagation(),d.preventDefault();break}else if(m==="more"){uf(n,i,t,()=>{n.page=1,St(n,t,!0)},()=>{Al(t,{removed:!0,sort:0,group:0,hasReplace:!1,method:0,hPath:"",idPath:[],k:"",r:"",page:1,types:Zr(),replaceTypes:Object.assign({},f.SIYUAN_DEFAULT_REPLACETYPES)},n)}),window.siyuan.menus.menu.fullscreen(),d.stopPropagation(),d.preventDefault();break}else if(m==="replace-all"){Jr(t,n,!0),d.stopPropagation(),d.preventDefault();break}else if(m==="refreshUnRef"){ms(o),d.stopPropagation(),d.preventDefault();break}else if(m==="unRefPrevious"){if(!g.getAttribute("disabled")){let b=parseInt(o.querySelector("#searchUnRefResult").lastElementChild.textContent);b>1&&(b--,ms(o,b))}d.stopPropagation(),d.preventDefault();break}else if(m==="unRefNext"){const b=o.querySelector("#searchUnRefResult").lastElementChild;let y=parseInt(b.textContent);y<parseInt(b.textContent.split("/")[1])&&(y++,ms(o,y)),d.stopPropagation(),d.preventDefault();break}else if(m==="queryAsset"){bf(g,()=>{En(l,c),Ae(f.LOCAL_SEARCHASSET,c)}),d.stopPropagation(),d.preventDefault();break}else if(m==="filterAsset"){wf(l),d.stopPropagation(),d.preventDefault();break}else if(m==="moreAsset"){hf(g,l,()=>{En(l),Ae(f.LOCAL_SEARCHASSET,c)}),d.stopPropagation(),d.preventDefault();break}else if(m==="goAsset"){Sf(),d.stopPropagation(),d.preventDefault();break}else if(m==="goSearch"){l.classList.add("fn__none"),o.classList.add("fn__none"),d.stopPropagation(),d.preventDefault();break}else if(m==="assetPrevious"){g.getAttribute("disabled")||En(l,c,parseInt(l.querySelector("#searchAssetResult .fn__flex-center").textContent.split("/")[1])-1),d.stopPropagation(),d.preventDefault();break}else if(m==="assetNext"){g.getAttribute("disabled")||En(l,c,parseInt(l.querySelector("#searchAssetResult .fn__flex-center").textContent.split("/")[1])+1),d.stopPropagation(),d.preventDefault();break}else if(m==="replace"){Jr(t,n,!1),d.stopPropagation(),d.preventDefault();break}else if(g.classList.contains("b3-list-item__toggle")){g.parentElement.nextElementSibling.classList.toggle("fn__none"),g.firstElementChild.classList.toggle("b3-list-item__arrow--open"),d.stopPropagation(),d.preventDefault();break}else if(g.classList.contains("b3-list-item")){if(g.getAttribute("data-type")==="search-new")Vr(e,a.value);else if(g.getAttribute("data-type")==="search-item"){const b=g.getAttribute("data-node-id");b?((p=window.siyuan.mobile.editor)!=null&&p.protyle&&en(window.siyuan.mobile.editor.protyle),Mn(b,y=>{at(e,b,y?[f.CB_GET_ALL]:[f.CB_GET_HL,f.CB_GET_CONTEXT,f.CB_GET_ROOTSCROLL])}),Ve()):g.classList.contains("b3-list-item--focus")?g.classList.contains("b3-list-item--focus")&&mf(t.querySelector("#searchAssetPreview")):(t.querySelector("#searchAssetList .b3-list-item--focus").classList.remove("b3-list-item--focus"),g.classList.add("b3-list-item--focus"),Kr(t.querySelector("#searchAssetPreview"),g.dataset.id,t.querySelector("#searchAssetInput").value,window.siyuan.storage[f.LOCAL_SEARCHASSET].method))}else g.querySelector(".b3-list-item__toggle")&&(g.nextElementSibling.classList.toggle("fn__none"),g.firstElementChild.firstElementChild.classList.toggle("b3-list-item__arrow--open"));d.stopPropagation(),d.preventDefault();break}g=g.parentElement}},!1)},qt=(e,t)=>{var n;const a=JSON.parse(JSON.stringify(window.siyuan.storage[f.LOCAL_SEARCHDATA])),s=(((n=Dt())==null?void 0:n.protyle.toolbar.range)||(getSelection().rangeCount>0?getSelection().getRangeAt(0):document.createRange())).toString();s&&(a.k=s),t&&Object.keys(t).forEach(o=>{a[o]=t[o]}),fn(),tn();let i=!0,l=!1;a.idPath.forEach(o=>{o.endsWith(".sy")&&(i=!1),o.split("/").length>1&&(l=!0)}),sn({title:`<div class="fn__flex">
    <span data-menu="true" class="toolbar__icon toolbar__icon--history" data-type="history">
        <svg class="svg--mid"><use xlink:href="#iconSearch"></use></svg>
        <svg class="svg--smaller"><use xlink:href="#iconDown"></use></svg>
    </span>
    <input id="toolbarSearch" placeholder="${window.siyuan.languages.showRecentUpdatedBlocks}" class="toolbar__title fn__block">
    <svg id="toolbarSearchNew" class="toolbar__icon"><use xlink:href="#iconFile"></use></svg>
</div>`,html:`<div class="fn__flex-column" style="height: 100%">
    <div class="toolbar toolbar--border${a.hasReplace?"":" fn__none"}">
        <span data-menu="true" class="toolbar__icon toolbar__icon--history" data-type="replaceHistory">
            <svg class="svg--mid"><use xlink:href="#iconReplace"></use></svg>
            <svg class="svg--smaller"><use xlink:href="#iconDown"></use></svg>
        </span>
        <input id="toolbarReplace" class="toolbar__title">
        <svg class="fn__rotate fn__none toolbar__icon"><use xlink:href="#iconRefresh"></use></svg>
        <div class="fn__space"></div>
        <button data-type="replace-all" class="b3-button b3-button--outline fn__flex-center">${window.siyuan.languages.replaceAll}</button>
        <div class="fn__space"></div>
        <button data-type="replace" class="b3-button b3-button--outline fn__flex-center">${window.siyuan.languages.replace}</button>
        <div class="fn__space"></div>
    </div>
    <div id="criteria" style="background-color: var(--b3-theme-background);"></div>
    <div class="toolbar">
        <span class="fn__space"></span>
        <span data-type="result" class="fn__flex-1 fn__flex"></span>
        <span class="fn__space"></span>
        <svg data-type="previous" disabled="disabled" class="toolbar__icon"><use xlink:href="#iconLeft"></use></svg>
        <svg data-type="next" disabled="disabled" class="toolbar__icon"><use xlink:href="#iconRight"></use></svg>
    </div>
    <div id="searchList" style="overflow:auto;" class="fn__flex-1 b3-list b3-list--background"></div>
    <div id="searchPath" class="b3-chips${a.hPath?"":" fn__none"}" style="background-color: var(--b3-theme-background);">
        <div class="b3-chip b3-chip--middle">
            ${pe(a.hPath)}
            <svg data-type="remove-path" class="b3-chip__close"><use xlink:href="#iconCloseRound"></use></svg>
        </div>
    </div>
    <div class="toolbar">
        <span class="fn__flex-1"></span>
        <svg data-type="toggle-replace" class="toolbar__icon${a.hasReplace?" toolbar__icon--active":""}"><use xlink:href="#iconReplace"></use></svg>
        <svg ${l?"":"disabled"} data-type="include" class="toolbar__icon${i?" toolbar__icon--active":""}"><use xlink:href="#iconCopy"></use></svg>
        <svg data-type="path" class="toolbar__icon"><use xlink:href="#iconFolder"></use></svg>
        <svg ${document.querySelector("#empty").classList.contains("fn__none")?"":"disabled"} data-type="currentPath" class="toolbar__icon"><use xlink:href="#iconFocus"></use></svg>
        <svg data-type="expand" class="toolbar__icon${a.group===0?" fn__none":""}"><use xlink:href="#iconExpand"></use></svg>
        <svg data-type="contract" class="toolbar__icon${a.group===0?" fn__none":""}"><use xlink:href="#iconContract"></use></svg>
        <svg data-type="more" class="toolbar__icon"><use xlink:href="#iconMore"></use></svg>
        <svg data-type="goAsset" class="toolbar__icon"><use xlink:href="#iconExact"></use></svg>
        <span class="fn__flex-1"></span>
     </div>
     <div class="fn__none fn__flex-column" style="position: fixed;top: 0;width: 100%;background: var(--b3-theme-surface);height: 100%;" id="searchAssetsPanel">
        <div class="toolbar toolbar--border">
           <span data-menu="true" class="toolbar__icon toolbar__icon--history" data-type="assetHistory">
                <svg class="svg--mid"><use xlink:href="#iconSearch"></use></svg>
                <svg class="svg--smaller"><use xlink:href="#iconDown"></use></svg>
            </span>
            <input id="searchAssetInput" placeholder="${window.siyuan.languages.keyword}" class="toolbar__title fn__block">
        </div>
        <div class="toolbar">
            <span class="fn__space"></span>
            <span id="searchAssetResult" class="fn__flex-1 fn__flex"><span class="fn__flex-1"></span></span>
            <span class="fn__space"></span>
            <svg data-type="assetPrevious" disabled="disabled" class="toolbar__icon"><use xlink:href="#iconLeft"></use></svg>
            <svg data-type="assetNext" disabled="disabled" class="toolbar__icon"><use xlink:href="#iconRight"></use></svg>
        </div>
        <div id="searchAssetList" style="overflow:auto;" class="fn__flex-1 b3-list b3-list--background"></div>
        <div id="searchAssetPreview" class="fn__flex-1 search__preview b3-typography" style="padding: 8px;border-bottom: 1px solid var(--b3-border-color);"></div>
        <div class="toolbar">
            <span class="fn__flex-1"></span>
            <svg data-type="queryAsset" class="toolbar__icon"><use xlink:href="#iconRegex"></use></svg>
            <svg data-type="filterAsset" class="toolbar__icon"><use xlink:href="#iconFilter"></use></svg>
            <svg data-type="moreAsset" class="toolbar__icon"><use xlink:href="#iconMore"></use></svg>
            <svg data-type="goSearch" class="toolbar__icon"><use xlink:href="#iconBack"></use></svg>
            <span class="fn__flex-1"></span>
         </div>
    </div>
     <div class="fn__none fn__flex-column" style="position: fixed;top: 0;width: 100%;background: var(--b3-theme-surface);height: 100%;" id="searchUnRefPanel">
        <div class="toolbar">
            <span class="fn__space"></span>
            <span id="searchUnRefResult" class="fn__flex-1 fn__flex"></span>
            <span class="fn__space"></span>
            <svg data-type="unRefPrevious" disabled="disabled" class="toolbar__icon"><use xlink:href="#iconLeft"></use></svg>
            <svg data-type="unRefNext" disabled="disabled" class="toolbar__icon"><use xlink:href="#iconRight"></use></svg>
        </div>
        <div id="searchUnRefList" style="overflow:auto;" class="fn__flex-1 b3-list b3-list--background"></div>
        <div class="toolbar">
            <span class="fn__flex-1"></span>
            <svg data-type="refreshUnRef" class="toolbar__icon"><use xlink:href="#iconRefresh"></use></svg>
            <svg data-type="goSearch" class="toolbar__icon"><use xlink:href="#iconBack"></use></svg>
            <span class="fn__flex-1"></span>
         </div>
    </div>
     <div class="fn__loading fn__loading--top"><img width="120px" src="/stage/loading-pure.svg"></div>
</div>`,bindEvent(o){document.querySelector("#toolbarSearchNew").addEventListener("click",()=>{Vr(e,document.querySelector("#toolbarSearch").value)}),document.querySelector('.toolbar [data-type="history"]').addEventListener("click",()=>{vf(document.querySelector("#model"),a,void 0)}),Lf(e,o.firstElementChild,a),St(a,o)}})},Sf=()=>{const e=document.querySelector("#searchAssetsPanel");if(e.classList.remove("fn__none"),e.querySelector("#searchAssetList").innerHTML)return;const n=window.siyuan.storage[f.LOCAL_SEARCHASSET],a=e.querySelector("input");a.value=n.k,a.addEventListener("compositionend",s=>{s.isComposing||En(e,n)}),a.addEventListener("input",s=>{s.isComposing||En(e,n)}),a.addEventListener("blur",()=>{Ef(a)}),En(e,n),ps({inputElement:a,className:"toolbar__icon",clearCB(){En(e,n)}})},xf=()=>{window.siyuan.menus.menu.remove();const e=document.querySelector("#searchUnRefPanel");e.classList.remove("fn__none"),!e.querySelector("#searchUnRefList").innerHTML&&ms(e)},ms=(e,t=1)=>{const n=e.querySelector('[data-type="unRefPrevious"]');t>1?n.removeAttribute("disabled"):n.setAttribute("disabled","disabled"),A("/api/search/listInvalidBlockRefs",{page:t},a=>{e.parentElement.querySelector(".fn__loading--top").classList.add("fn__none");const s=e.querySelector('[data-type="unRefNext"]');t<a.data.pageCount?s.removeAttribute("disabled"):s.setAttribute("disabled","disabled");let i="";a.data.blocks.forEach((l,o)=>{const r=Ft(l.box)+ct(l.hPath,!1);i+=`<div class="b3-list-item b3-list-item--two${o===0?" b3-list-item--focus":""}" data-type="search-item" data-node-id="${l.id}">
<div class="b3-list-item__first">
    <svg class="b3-list-item__graphic"><use xlink:href="#${dn(l.type)}"></use></svg>
    ${ge(l.ial.icon,"b3-list-item__graphic",!0)}
    <span class="b3-list-item__text">${l.content}</span>
</div>
<span class="b3-list-item__text b3-list-item__meta">${Ji(r)}</span>
</div>`}),e.querySelector("#searchUnRefResult").innerHTML=`<span class="fn__flex-center">${window.siyuan.languages.findInDoc.replace("${x}",a.data.matchedRootCount).replace("${y}",a.data.matchedBlockCount)}</span>
<span class="fn__flex-1"></span>
<span class="fn__flex-center">${t}/${a.data.pageCount||1}</span>`,e.querySelector("#searchUnRefList").innerHTML=i||`<div class="search__empty">
    ${window.siyuan.languages.emptyContent}
</div>`})},xa=e=>{e.style.minWidth?e.style.width="":e.removeAttribute("style")};var Af=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{o(n.next(r))}catch(c){s(c)}},l=r=>{try{o(n.throw(r))}catch(c){s(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,l);o((n=n.apply(e,t)).next())});const Cl=(e,t,n,a=[])=>{A("/api/search/searchAsset",{k:t,exts:a},s=>{let i="";s.data.forEach((c,d)=>{i+=`<div data-value="${c.path}" class="b3-list-item${d===0?" b3-list-item--focus":""}"><div class="b3-list-item__text">${c.hName}</div></div>`});const l=e.querySelector(".b3-list"),o=e.querySelector("#preview"),r=e.querySelector("input");l.innerHTML=i||`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`,s.data.length>0?o.innerHTML=Ya(s.data[0].path):o.innerHTML=window.siyuan.languages.emptyContent,window.siyuan.menus.menu.fullscreen(),t||r.select()})},Tl=(e,t,n,a)=>{const s=new Ke("background-asset");s.isOpen||s.addItem({iconHTML:"",type:"readonly",label:`<div class="fn__flex" style="max-height: 50vh">
<div class="fn__flex-column" style="${H()?"width:100%":"min-width: 260px;max-width:420px"}">
    <div class="fn__flex" style="margin: 0 8px 4px 8px">
        <input class="b3-text-field fn__flex-1"/>
        <span class="fn__space"></span>
        <span data-type="previous" class="block__icon block__icon--show"><svg><use xlink:href="#iconLeft"></use></svg></span>
        <span class="fn__space"></span>
        <span data-type="next" class="block__icon block__icon--show"><svg><use xlink:href="#iconRight"></use></svg></span>
    </div>
    <div class="b3-list fn__flex-1 b3-list--background" style="position: relative"><img style="margin: 0 auto;display: block;width: 64px;height: 64px" src="/stage/loading-pure.svg"></div>
</div>
<div id="preview" style="width: 360px;display: ${H()||window.outerWidth<window.outerWidth/2+260?"none":"flex"};padding: 8px;overflow: auto;justify-content: center;align-items: center;word-break: break-all;"></div>
</div>`,bind(i){i.style.maxWidth="none";const l=i.querySelector(".b3-list"),o=i.querySelector("#preview");l.addEventListener("mouseover",c=>{const d=c.target,u=$(d,"b3-list-item");u&&(o.innerHTML=Ya(u.getAttribute("data-value")))});const r=i.querySelector("input");r.addEventListener("keydown",c=>{if(c.isComposing)return;const d=i.querySelector(".b3-list--empty");if(!d){const u=Wt(l,c);u&&(o.innerHTML=Ya(u.getAttribute("data-value")),c.stopPropagation())}if(c.key==="Enter"){if(d)n||(window.siyuan.menus.menu.remove(),X(e.toolbar.range));else{const u=i.querySelector(".b3-list-item--focus");n?n(u.getAttribute("data-value"),u.textContent):(td(u.getAttribute("data-value"),e),window.siyuan.menus.menu.remove())}c.preventDefault(),c.stopPropagation()}else c.key==="Escape"&&(n||X(e.toolbar.range))}),r.addEventListener("input",c=>{c.isComposing||(c.stopPropagation(),Cl(i,r.value,t,a))}),r.addEventListener("compositionend",c=>{c.stopPropagation(),Cl(i,r.value,t,a)}),i.lastElementChild.addEventListener("click",c=>{const d=c.target;if(D(d,"data-type","previous")){r.dispatchEvent(new KeyboardEvent("keydown",{key:"ArrowUp"})),c.stopPropagation();return}if(D(d,"data-type","next")){r.dispatchEvent(new KeyboardEvent("keydown",{key:"ArrowDown"})),c.stopPropagation();return}const g=$(d,"b3-list-item");if(g){c.stopPropagation();const m=g.getAttribute("data-value");n?n(m,g.textContent):(td(m,e),window.siyuan.menus.menu.remove())}}),Cl(i,"",t,a)}})},$l=(e,t)=>{var n;const a=B(t);if(!a)return;J(["util","toolbar","hint"],e);const s=a.getAttribute("data-node-id");let i=a.outerHTML;window.siyuan.menus.menu.remove();let l;window.siyuan.menus.menu.append(new M({id:"idAndAnchor",iconHTML:"",type:"readonly",label:`<div>ID</div>
<textarea spellcheck="false" rows="1" style="margin:4px 0;width: ${H()?"200":"360"}px" class="b3-text-field" readonly>${t.getAttribute("data-id")||""}</textarea>
<div class="fn__hr"></div>
<div>${window.siyuan.languages.anchor}</div>
<textarea rows="1" style="margin:4px 0;width: ${H()?"200":"360"}px" class="b3-text-field"></textarea>`,bind(c){c.style.maxWidth="none",l=c.querySelectorAll(".b3-text-field")[1],l.value=t.textContent;const d=()=>{l.value?t.innerHTML=Lute.EscapeHTMLStr(l.value):t.innerHTML="*"};l.addEventListener("input",u=>{u.isComposing||(d(),u.stopPropagation())}),l.addEventListener("compositionend",u=>{u.isComposing||(d(),u.stopPropagation())}),l.addEventListener("keydown",u=>{if(!u.isComposing){if(u.key==="Enter"&&!u.isComposing)window.siyuan.menus.menu.remove();else if(Zn(u))return}})}}).element),window.siyuan.menus.menu.append(new M({type:"separator"}).element),window.siyuan.menus.menu.append(new M({id:"turnInto",label:window.siyuan.languages.turnInto,icon:"iconRefresh",submenu:[{id:"text",iconHTML:"",label:window.siyuan.languages.text,click(){a.setAttribute("updated",U().format("YYYYMMDDHHmmss")),ml(t,"file-annotation-ref",e.toolbar.range),K(e,s,a.outerHTML,i),i=a.outerHTML}},{id:"text*",iconHTML:"",label:window.siyuan.languages.text+" *",click(){t.insertAdjacentHTML("beforebegin",t.innerHTML+" "),t.textContent="*",a.setAttribute("updated",U().format("YYYYMMDDHHmmss")),K(e,s,a.outerHTML,i),i=a.outerHTML}}]}).element),window.siyuan.menus.menu.append(new M({id:"remove",icon:"iconTrashcan",label:window.siyuan.languages.remove,click(){t.insertAdjacentHTML("afterend","<wbr>"),t.remove(),a.setAttribute("updated",U().format("YYYYMMDDHHmmss")),K(e,s,a.outerHTML,i),ue(a,e.toolbar.range),i=a.outerHTML}}).element),(n=e==null?void 0:e.app)!=null&&n.plugins&&jt({plugins:e.app.plugins,type:"open-menu-fileannotationref",detail:{protyle:e,element:t},separatorPosition:"top"});const o=t.getBoundingClientRect();window.siyuan.menus.menu.popup({x:o.left,y:o.top+26,h:26});const r=Q(e.element,"block__popover",!0);window.siyuan.menus.menu.element.setAttribute("data-from",r?r.dataset.level+"popover":"app"),l.select(),window.siyuan.menus.menu.removeCB=()=>{a.outerHTML!==i&&(a.setAttribute("updated",U().format("YYYYMMDDHHmmss")),K(e,s,a.outerHTML,i));const c=getSelection().rangeCount===0?void 0:getSelection().getRangeAt(0);c&&!e.element.contains(c.startContainer)&&(e.toolbar.range.selectNodeContents(t),e.toolbar.range.collapse(!1),X(e.toolbar.range))}},Il=(e,t)=>{var n;const a=B(t);if(!a)return;J(["util","toolbar","hint"],e);const s=t.getAttribute("data-id"),i=a.getAttribute("data-node-id");let l=a.outerHTML;if(window.siyuan.menus.menu.remove(),e.disabled||(window.siyuan.menus.menu.append(new M({id:"anchor",iconHTML:"",type:"readonly",label:`<input style="margin: 4px 0" class="b3-text-field fn__block" placeholder="${window.siyuan.languages.anchor}">`,bind(c){const d=c.querySelector("input");d.value=t.getAttribute("data-subtype")==="d"?"":t.textContent,d.addEventListener("input",()=>{d.value?t.innerHTML=Lute.EscapeHTMLStr(d.value):A("/api/block/getRefText",{id:s},u=>{t.innerHTML=u.data}),t.setAttribute("data-subtype",d.value?"s":"d")}),d.addEventListener("keydown",u=>{if(!u.isComposing){if(u.key==="Enter"&&!u.isComposing)window.siyuan.menus.menu.remove();else if(Zn(u))return}})}}).element),window.siyuan.menus.menu.append(new M({id:"separator_1",type:"separator"}).element)),!e.disabled){let c=[];t.getAttribute("data-subtype")==="s"?c.push({id:"turnToDynamic",iconHTML:"",label:window.siyuan.languages.turnToDynamic,click(){t.setAttribute("data-subtype","d"),A("/api/block/getRefText",{id:s},d=>{t.innerHTML=d.data,a.setAttribute("updated",U().format("YYYYMMDDHHmmss")),K(e,i,a.outerHTML,l),l=a.outerHTML}),X(e.toolbar.range)}}):c.push({id:"turnToStatic",iconHTML:"",label:window.siyuan.languages.turnToStatic,click(){t.setAttribute("data-subtype","s"),a.setAttribute("updated",U().format("YYYYMMDDHHmmss")),K(e,i,a.outerHTML,l),X(e.toolbar.range),l=a.outerHTML}}),c=c.concat([{id:"text",iconHTML:"",label:window.siyuan.languages.text,click(){a.setAttribute("updated",U().format("YYYYMMDDHHmmss")),ml(t,"block-ref",e.toolbar.range),K(e,i,a.outerHTML,l),l=a.outerHTML}},{id:"*",iconHTML:"",label:"*",click(){t.setAttribute("data-subtype","s"),t.textContent="*",a.setAttribute("updated",U().format("YYYYMMDDHHmmss")),K(e,i,a.outerHTML,l),X(e.toolbar.range),l=a.outerHTML}},{id:"text*",iconHTML:"",label:window.siyuan.languages.text+" *",click(){t.insertAdjacentHTML("beforebegin",t.innerHTML+" "),t.setAttribute("data-subtype","s"),t.textContent="*",a.setAttribute("updated",U().format("YYYYMMDDHHmmss")),K(e,i,a.outerHTML,l),X(e.toolbar.range),l=a.outerHTML}},{id:"link",label:window.siyuan.languages.link,iconHTML:"",click(){t.outerHTML=`<span data-type="a" data-href="siyuan://blocks/${t.getAttribute("data-id")}">${t.innerHTML}</span><wbr>`,a.setAttribute("updated",U().format("YYYYMMDDHHmmss")),K(e,i,a.outerHTML,l),ue(a,e.toolbar.range),l=a.outerHTML}}]),t.parentElement.textContent.trim()===t.textContent.trim()&&t.parentElement.tagName==="DIV"&&c.push({id:"blockEmbed",iconHTML:"",label:window.siyuan.languages.blockEmbed,click(){const d=`<div data-content="select * from blocks where id='${s}'" data-node-id="${i}" data-type="NodeBlockQueryEmbed" class="render-node" updated="${U().format("YYYYMMDDHHmmss")}">${a.querySelector(".protyle-attr").outerHTML}</div>`;a.outerHTML=d,K(e,i,d,l),Se(e,e.wysiwyg.element),l=a.outerHTML}}),c.push({id:"defBlock",iconHTML:"",label:window.siyuan.languages.defBlock,click(){A("/api/block/swapBlockRef",{refID:i,defID:s,includeChildren:!1})}}),c.push({id:"defBlockChildren",iconHTML:"",label:window.siyuan.languages.defBlockChildren,click(){A("/api/block/swapBlockRef",{refID:i,defID:s,includeChildren:!0})}}),window.siyuan.menus.menu.append(new M({id:"iconRefresh",label:window.siyuan.languages.turnInto,icon:"iconRefresh",submenu:c}).element)}window.siyuan.menus.menu.append(new M({id:"copy",label:window.siyuan.languages.copy,icon:"iconCopy",click(){Be(e.lute.BlockDOM2StdMd(t.outerHTML))}}).element),e.disabled||(window.siyuan.menus.menu.append(new M({id:"cut",label:window.siyuan.languages.cut,icon:"iconCut",click(){Be(e.lute.BlockDOM2StdMd(t.outerHTML)),t.insertAdjacentHTML("afterend","<wbr>"),t.remove(),a.setAttribute("updated",U().format("YYYYMMDDHHmmss")),K(e,i,a.outerHTML,l),ue(a,e.toolbar.range),l=a.outerHTML}}).element),window.siyuan.menus.menu.append(new M({id:"remove",label:window.siyuan.languages.remove,icon:"iconTrashcan",click(){t.insertAdjacentHTML("afterend","<wbr>"),t.remove(),a.setAttribute("updated",U().format("YYYYMMDDHHmmss")),K(e,i,a.outerHTML,l),ue(a,e.toolbar.range),l=a.outerHTML}}).element)),(n=e==null?void 0:e.app)!=null&&n.plugins&&jt({plugins:e.app.plugins,type:"open-menu-blockref",detail:{protyle:e,element:t},separatorPosition:"top"});const o=t.getBoundingClientRect();window.siyuan.menus.menu.popup({x:o.left,y:o.top+26,h:26});const r=Q(e.element,"block__popover",!0);window.siyuan.menus.menu.data=t,window.siyuan.menus.menu.element.setAttribute("data-from",r?r.dataset.level+"popover":"app"),e.disabled||(window.siyuan.menus.menu.element.querySelector("input").select(),window.siyuan.menus.menu.removeCB=()=>{a.outerHTML!==l&&(a.setAttribute("updated",U().format("YYYYMMDDHHmmss")),K(e,i,a.outerHTML,l));const c=getSelection().rangeCount===0?void 0:getSelection().getRangeAt(0);c&&!e.element.contains(c.startContainer)&&(e.toolbar.range.selectNodeContents(t),e.toolbar.range.collapse(!1),X(e.toolbar.range))})},Cf=(e,t)=>{var n;const a=ye(t);window.siyuan.menus.menu.remove(),e.toolbar.showContent(e,a,t),(n=e==null?void 0:e.app)!=null&&n.plugins&&jt({plugins:e.app.plugins,type:"open-menu-content",detail:{protyle:e,range:a,element:t},separatorPosition:"top"})},Dl=(e,t)=>{if(e.block.showAll)Ot({protyle:e,id:e.block.parent2ID,focusId:t});else{const n=e.path.split("/");n.length>2&&at(e.app,n[n.length-2],[f.CB_GET_FOCUS,f.CB_GET_SCROLL])}},Ot=e=>{var t,n;if(e.protyle.options.backlinkData)return;typeof e.isPushBack=="undefined"&&(e.isPushBack=!0),typeof e.reload=="undefined"&&(e.reload=!1);const a=(t=e.protyle.breadcrumb)==null?void 0:t.element.querySelector(".protyle-breadcrumb__item--active");if(!e.reload&&a&&a.getAttribute("data-node-id")===e.id){if(e.id===e.protyle.block.rootID)return;const s=e.protyle.wysiwyg.element.querySelector(`[data-node-id="${e.focusId||e.id}"]`);if(s){ne(s),s.scrollIntoView();return}}(n=window.siyuan.mobile)!=null&&n.editor&&(window.siyuan.storage[f.LOCAL_DOCINFO]={id:e.id},Ae(f.LOCAL_DOCINFO,window.siyuan.storage[f.LOCAL_DOCINFO]),e.isPushBack&&kl()),A("/api/filetree/getDoc",{id:e.id,size:e.id===e.protyle.block.rootID?window.siyuan.config.editor.dynamicLoadBlocks:f.SIZE_GET_MAX},s=>Af(void 0,null,function*(){if(e.isPushBack?Qe({data:s,protyle:e.protyle,action:e.id===e.protyle.block.rootID?[f.CB_GET_FOCUS,f.CB_GET_HTML]:[f.CB_GET_ALL,f.CB_GET_FOCUS,f.CB_GET_HTML],afterCB:e.callback}):Qe({data:s,protyle:e.protyle,action:e.id===e.protyle.block.rootID?[f.CB_GET_FOCUS,f.CB_GET_HTML,f.CB_GET_UNUNDO]:[f.CB_GET_ALL,f.CB_GET_FOCUS,f.CB_GET_UNUNDO,f.CB_GET_HTML],afterCB:e.callback}),e.focusId){let i=e.protyle.wysiwyg.element.querySelector(`[data-node-id="${e.focusId}"]`);if(!i){const l=yield Ye("/api/block/getUnfoldedParentID",{id:e.focusId});e.focusId=l.data.parentID,i=e.protyle.wysiwyg.element.querySelector(`[data-node-id="${l.data.parentID}"]`)}if(i){let l=i;for(;l.getBoundingClientRect().height===0;)l=l.parentElement;l.classList.contains("protyle-wysiwyg")?l=i.previousElementSibling||i.nextElementSibling:l=Mt(l),ne(l);const o=new ResizeObserver(()=>{l.scrollIntoView()});o.observe(e.protyle.wysiwyg.element),setTimeout(()=>{o.disconnect()},1e3*3)}else if(e.id===e.protyle.block.rootID){A("/api/filetree/getDoc",{id:e.focusId,mode:3,size:window.siyuan.config.editor.dynamicLoadBlocks},l=>{Qe({data:l,protyle:e.protyle,action:e.isPushBack?[f.CB_GET_FOCUS]:[f.CB_GET_FOCUS,f.CB_GET_UNUNDO]})});return}}else e.id!==e.protyle.block.rootID&&(e.protyle.wysiwyg.element.classList.add("protyle-wysiwyg--animate"),setTimeout(()=>{e.protyle.wysiwyg.element.classList.remove("protyle-wysiwyg--animate")},365))}))},Ml=(e,t,n,a)=>{var s;window.siyuan.menus.menu.remove();const i=B(n);if(!i)return;J(["util","toolbar","hint"],e);const l=i.getAttribute("data-node-id"),o=n.querySelector("img"),r=n.querySelector(".protyle-action__title span"),c=i.outerHTML;if(e.disabled||(window.siyuan.menus.menu.append(new M({id:"imageUrlAndTitleAndTooltipText",iconHTML:"",type:"readonly",label:`<div class="fn__flex">
    <span class="fn__flex-center">${window.siyuan.languages.imageURL}</span>
    <span class="fn__space"></span>
    <span data-action="copy" class="block__icon block__icon--show b3-tooltips b3-tooltips__e fn__flex-center" aria-label="${window.siyuan.languages.copy}">
        <svg><use xlink:href="#iconCopy"></use></svg>
    </span>   
</div>
<textarea spellcheck="false" style="margin:4px 0;width: ${H()?"200":"360"}px" rows="1" class="b3-text-field">${o.getAttribute("src")}</textarea>
<div class="fn__hr"></div>
<div class="fn__flex">
    <span class="fn__flex-center">${window.siyuan.languages.title}</span>
    <span class="fn__space"></span>
    <span data-action="copy" class="block__icon block__icon--show b3-tooltips b3-tooltips__e fn__flex-center" aria-label="${window.siyuan.languages.copy}">
        <svg><use xlink:href="#iconCopy"></use></svg>
    </span>   
</div>
<textarea style="margin:4px 0;width: ${H()?"200":"360"}px" rows="1" class="b3-text-field"></textarea>
<div class="fn__hr"></div>
<div class="fn__flex">
    <span class="fn__flex-center">${window.siyuan.languages.tooltipText}</span>
    <span class="fn__space"></span>
    <span data-action="copy" class="block__icon block__icon--show b3-tooltips b3-tooltips__e fn__flex-center" aria-label="${window.siyuan.languages.copy}">
        <svg><use xlink:href="#iconCopy"></use></svg>
    </span>   
</div>
<textarea style="margin:4px 0;width: ${H()?"200":"360"}px" rows="1" class="b3-text-field"></textarea>`,bind(g){g.style.maxWidth="none";const m=g.querySelectorAll("textarea");m[0].addEventListener("input",b=>{const y=b.target.value.replace(/\n|\r\n|\r|\u2028|\u2029/g,"").trim();if(o.setAttribute("src",y),o.setAttribute("data-src",y),y.startsWith("assets/")){const _=n.querySelector(".img__net");_&&_.remove()}else window.siyuan.config.editor.displayNetImgMark&&n.querySelector(".protyle-action__drag").insertAdjacentHTML("afterend",'<span class="img__net"><svg><use xlink:href="#iconLanguage"></use></svg></span>')}),m[1].value=r.innerText,m[1].addEventListener("input",b=>{const y=b.target.value;o.setAttribute("title",y),r.innerText=y,_n(r)}),m[2].value=o.getAttribute("alt")||"",g.addEventListener("click",b=>{let y=b.target;for(;y;){if(y.dataset.action==="copy"){Be(y.parentElement.nextElementSibling.value),ae(window.siyuan.languages.copied);break}y=y.parentElement}})}}).element),window.siyuan.menus.menu.append(new M({id:"separator_1",type:"separator"}).element)),window.siyuan.menus.menu.append(new M({id:"copy",label:window.siyuan.languages.copy,accelerator:"\u2318C",icon:"iconCopy",click(){let g=e.lute.BlockDOM2StdMd(n.outerHTML);g=g.replace(/%20/g," "),Be(g)}}).element),e.disabled&&window.siyuan.menus.menu.append(new M({id:"copyImageURL",label:window.siyuan.languages.copy+" "+window.siyuan.languages.imageURL,icon:"iconLink",click(){Be(o.getAttribute("src"))}}).element),window.siyuan.menus.menu.append(new M({id:"copyAsPNG",label:window.siyuan.languages.copyAsPNG,accelerator:window.siyuan.config.keymap.editor.general.copyBlockRef.custom,icon:"iconImage",click(){Pr(o.getAttribute("src"))}}).element),!e.disabled){window.siyuan.menus.menu.append(new M({id:"cut",icon:"iconCut",accelerator:"\u2318X",label:window.siyuan.languages.cut,click(){let y=e.lute.BlockDOM2StdMd(n.outerHTML);y=y.replace(/%20/g," "),Be(y),n.outerHTML="<wbr>",i.setAttribute("updated",U().format("YYYYMMDDHHmmss")),K(e,l,i.outerHTML,c),ue(e.wysiwyg.element,t)}}).element),window.siyuan.menus.menu.append(new M({id:"delete",icon:"iconTrashcan",accelerator:"\u232B",label:window.siyuan.languages.delete,click:function(){n.outerHTML="<wbr>",i.setAttribute("updated",U().format("YYYYMMDDHHmmss")),K(e,l,i.outerHTML,c),ue(e.wysiwyg.element,t)}}).element),window.siyuan.menus.menu.append(new M({id:"separator_2",type:"separator"}).element);const g=o.getAttribute("data-src");g.startsWith("assets/")&&window.siyuan.menus.menu.append(new M({id:"rename",label:window.siyuan.languages.rename,icon:"iconEdit",click(){ds(g)}}).element),window.siyuan.menus.menu.append(new M({id:"ocr",label:"OCR",submenu:[{id:"ocrResult",iconHTML:"",type:"readonly",label:`<textarea spellcheck="false" data-type="ocr" style="margin: 4px 0" rows="1" class="b3-text-field fn__size200" placeholder="${window.siyuan.languages.ocrResult}"></textarea>`,bind(y){y.style.maxWidth="none",A("/api/asset/getImageOCRText",{path:o.getAttribute("src")},_=>{const w=y.querySelector("textarea");w.value=_.data.text,w.dataset.ocrText=_.data.text})}},{type:"separator"},{id:"reOCR",iconHTML:"",label:window.siyuan.languages.reOCR,click(){A("/api/asset/ocr",{path:o.getAttribute("src"),force:!0})}}]}).element),window.siyuan.menus.menu.append(new M({id:"alignCenter",icon:"iconAlignCenter",label:window.siyuan.languages.alignCenter,accelerator:window.siyuan.config.keymap.editor.general.alignCenter.custom,click(){Yr(e,i,[n],l,c)}}).element),window.siyuan.menus.menu.append(new M({id:"alignLeft",icon:"iconAlignLeft",label:window.siyuan.languages.alignLeft,accelerator:window.siyuan.config.keymap.editor.general.alignLeft.custom,click(){Fr(e,i,[n],l,c)}}).element);let m;window.siyuan.menus.menu.append(new M({id:"width",label:window.siyuan.languages.width,submenu:[{id:"widthInput",iconHTML:"",type:"readonly",label:`<div class="fn__flex-center">
<input class="b3-text-field" style="margin: 4px 8px 4px 0" value="${o.parentElement.style.width.endsWith("px")?parseInt(o.parentElement.style.width):""}" type="number" placeholder="${window.siyuan.languages.width}">px
</div>`,bind(y){const _=y.querySelector("input");_.addEventListener("input",()=>{m.value="0",m.parentElement.setAttribute("aria-label",_.value?_.value+"px":window.siyuan.languages.default),xa(n),o.parentElement.style.width=_.value?_.value+"px":"",o.style.height=""}),_.addEventListener("blur",()=>{_.value!==o.parentElement.style.width.replace("px","")&&(i.setAttribute("updated",U().format("YYYYMMDDHHmmss")),K(e,l,i.outerHTML,c),window.siyuan.menus.menu.remove(),ne(i))})}},Aa("25%",o,e,l,i,c),Aa("33%",o,e,l,i,c),Aa("50%",o,e,l,i,c),Aa("67%",o,e,l,i,c),Aa("75%",o,e,l,i,c),Aa("100%",o,e,l,i,c),{id:"separator_1",type:"separator"},{id:"widthDrag",iconHTML:"",type:"readonly",label:`<div style="margin: 4px 0;" aria-label="${o.parentElement.style.width?o.parentElement.style.width.replace("vw","%").replace("calc(","").replace(" - 8px)",""):window.siyuan.languages.default}" class="b3-tooltips b3-tooltips__n${H()?"":" fn__size200"}">
    <input style="box-sizing: border-box" value="${o.parentElement.style.width.indexOf("%")>-1||o.parentElement.style.width.endsWith("vw")?parseInt(o.parentElement.style.width.replace("calc(","")):0}" class="b3-slider fn__block" max="100" min="1" step="1" type="range">
</div>`,bind(y){m=y.querySelector("input"),m.addEventListener("input",()=>{xa(n),o.parentElement.style.width=`calc(${m.value}% - 8px)`,o.style.height="",m.parentElement.setAttribute("aria-label",`${m.value}%`)}),m.addEventListener("change",()=>{i.setAttribute("updated",U().format("YYYYMMDDHHmmss")),K(e,l,i.outerHTML,c),window.siyuan.menus.menu.remove(),ne(i)})}},{id:"separator_2",type:"separator"},Aa(window.siyuan.languages.default,o,e,l,i,c)]}).element);let b;window.siyuan.menus.menu.append(new M({id:"height",label:window.siyuan.languages.height,submenu:[{id:"heightInput",iconHTML:"",type:"readonly",label:`<div class="fn__flex-center">
<input class="b3-text-field" value="${o.style.height.endsWith("px")?parseInt(o.style.height):""}" type="number" style="margin: 4px 8px 4px 0" placeholder="${window.siyuan.languages.height}">px
</div>`,bind(y){const _=y.querySelector("input");_.addEventListener("input",()=>{b.value="0",b.parentElement.setAttribute("aria-label",_.value?_.value+"px":window.siyuan.languages.default),o.style.height=_.value?_.value+"px":"",xa(n),o.parentElement.style.width=""}),_.addEventListener("blur",()=>{_.value!==o.style.height.replace("px","")&&(i.setAttribute("updated",U().format("YYYYMMDDHHmmss")),K(e,l,i.outerHTML,c),window.siyuan.menus.menu.remove(),ne(i))})}},Ca("25%",o,e,l,i,c),Ca("33%",o,e,l,i,c),Ca("50%",o,e,l,i,c),Ca("67%",o,e,l,i,c),Ca("75%",o,e,l,i,c),Ca("100%",o,e,l,i,c),{id:"separator_1",type:"separator"},{id:"heightDrag",iconHTML:"",type:"readonly",label:`<div style="margin: 4px 0;" aria-label="${o.style.height?o.style.height.replace("vh","%"):window.siyuan.languages.default}" class="b3-tooltips b3-tooltips__n${H()?"":" fn__size200"}">
    <input style="box-sizing: border-box" value="${o.style.height.endsWith("vh")?parseInt(o.style.height):0}" class="b3-slider fn__block" max="100" min="1" step="1" type="range">
</div>`,bind(y){b=y.querySelector("input"),b.addEventListener("input",()=>{xa(n),o.parentElement.style.width="",o.style.height=b.value+"vh",b.parentElement.setAttribute("aria-label",`${b.value}%`)}),b.addEventListener("change",()=>{i.setAttribute("updated",U().format("YYYYMMDDHHmmss")),K(e,l,i.outerHTML,c),window.siyuan.menus.menu.remove(),ne(i)})}},{id:"separator_2",type:"separator"},Ca(window.siyuan.languages.default,o,e,l,i,c)]}).element)}const d=o.getAttribute("src");d&&(window.siyuan.menus.menu.append(new M({id:"separator_3",type:"separator"}).element),Ei(e.app,d,!1,!1));const u=o.getAttribute("data-src");u&&u.startsWith("assets/")&&window.siyuan.menus.menu.append(new M(fs(u)).element),(s=e==null?void 0:e.app)!=null&&s.plugins&&jt({plugins:e.app.plugins,type:"open-menu-image",detail:{protyle:e,element:n},separatorPosition:"top"}),window.siyuan.menus.menu.popup({x:a.clientX,y:a.clientY});const p=Q(e.element,"block__popover",!0);if(window.siyuan.menus.menu.element.setAttribute("data-from",p?p.dataset.level+"popover":"app"),!e.disabled){const g=window.siyuan.menus.menu.element.querySelectorAll("textarea");g[0].value?g[1].select():g[0].select(),window.siyuan.menus.menu.removeCB=()=>{const m=window.siyuan.menus.menu.element.querySelector('[data-type="ocr"]');m&&m.dataset.ocrText!==m.value&&A("/api/asset/setImageOCRText",{path:o.getAttribute("src"),text:m.value}),o.setAttribute("alt",g[2].value.replace(/\n|\r\n|\r|\u2028|\u2029/g,"")),i.setAttribute("updated",U().format("YYYYMMDDHHmmss")),K(e,l,i.outerHTML,c)}}},Ai=(e,t,n=!1)=>{var a;window.siyuan.menus.menu.remove();const s=B(t);if(!s)return;un(),J(["util","toolbar","hint"],e);const i=s.getAttribute("data-node-id");let l=s.outerHTML;const o=t.getAttribute("data-href");let r;e.disabled||(window.siyuan.menus.menu.append(new M({id:"linkAndAnchorAndTitle",iconHTML:"",type:"readonly",label:`<div class="fn__flex">
    <span class="fn__flex-center">${window.siyuan.languages.link}</span>
    <span class="fn__space"></span>
    <span data-action="copy" class="block__icon block__icon--show b3-tooltips b3-tooltips__e fn__flex-center" aria-label="${window.siyuan.languages.copy}">
        <svg><use xlink:href="#iconCopy"></use></svg>
    </span>   
</div>
<textarea spellcheck="false" rows="1" style="margin:4px 0;width: ${H()?"200":"360"}px" class="b3-text-field"></textarea>
<div class="fn__hr"></div>
<div class="fn__flex">
    <span class="fn__flex-center">${window.siyuan.languages.anchor}</span>
    <span class="fn__space"></span>
    <span data-action="copy" class="block__icon block__icon--show b3-tooltips b3-tooltips__e fn__flex-center" aria-label="${window.siyuan.languages.copy}">
        <svg><use xlink:href="#iconCopy"></use></svg>
    </span>   
</div>
<textarea style="width: ${H()?"200":"360"}px;margin: 4px 0;" rows="1" class="b3-text-field"></textarea>
<div class="fn__hr"></div>
<div class="fn__flex">
    <span class="fn__flex-center">${window.siyuan.languages.title}</span>
    <span class="fn__space"></span>
    <span data-action="copy" class="block__icon block__icon--show b3-tooltips b3-tooltips__e fn__flex-center" aria-label="${window.siyuan.languages.copy}">
        <svg><use xlink:href="#iconCopy"></use></svg>
    </span>   
</div>
<textarea style="width: ${H()?"200":"360"}px;margin: 4px 0;" rows="1" class="b3-text-field"></textarea>`,bind(u){u.style.maxWidth="none",r=u.querySelectorAll("textarea"),r[0].value=Lute.UnEscapeHTMLStr(o)||"",r[0].addEventListener("keydown",g=>{if((g.key==="Enter"||g.key==="Escape")&&!g.isComposing)g.preventDefault(),g.stopPropagation(),window.siyuan.menus.menu.remove();else if(g.key==="Tab"&&!g.isComposing)g.preventDefault(),g.stopPropagation(),r[1].focus();else if(Zn(g))return});let p=t.textContent.replace(f.ZWSP,"");!p&&o&&(p=decodeURIComponent(o.replace("https://","").replace("http://","")),p.length>f.SIZE_LINK_TEXT_MAX&&(p=p.substring(0,f.SIZE_LINK_TEXT_MAX)+"..."),t.innerHTML=Lute.EscapeHTMLStr(p)),r[1].value=p,r[1].addEventListener("compositionend",()=>{t.innerHTML=Lute.EscapeHTMLStr(r[1].value.replace(/\n|\r\n|\r|\u2028|\u2029/g,"")||"*")}),r[1].addEventListener("input",g=>{g.isComposing||(t.innerHTML=Lute.EscapeHTMLStr(r[1].value.replace(/\n|\r\n|\r|\u2028|\u2029/g,""))||"*")}),r[1].addEventListener("keydown",g=>{if((g.key==="Enter"||g.key==="Escape")&&!g.isComposing)g.preventDefault(),g.stopPropagation(),window.siyuan.menus.menu.remove();else if(g.key==="Tab"&&!g.isComposing)g.preventDefault(),g.stopPropagation(),g.shiftKey?r[0].focus():r[2].focus();else if(Zn(g))return}),r[2].value=Lute.UnEscapeHTMLStr(t.getAttribute("data-title")||""),r[2].addEventListener("keydown",g=>{if((g.key==="Enter"||g.key==="Escape")&&!g.isComposing)g.preventDefault(),g.stopPropagation(),window.siyuan.menus.menu.remove();else if(g.key==="Tab"&&g.shiftKey&&!g.isComposing)g.preventDefault(),g.stopPropagation(),r[1].focus();else if(Zn(g))return}),u.addEventListener("click",g=>{let m=g.target;for(;m;){if(m.dataset.action==="copy"){Be(m.parentElement.nextElementSibling.value),ae(window.siyuan.languages.copied);break}m=m.parentElement}})}}).element),window.siyuan.menus.menu.append(new M({id:"separator_1",type:"separator"}).element)),window.siyuan.menus.menu.append(new M({id:"copy",label:window.siyuan.languages.copy,icon:"iconCopy",click(){const u=document.createRange();u.selectNode(t),X(u),document.execCommand("copy")}}).element),e.disabled&&window.siyuan.menus.menu.append(new M({id:"copyAHref",label:window.siyuan.languages.copy+" "+window.siyuan.languages.replaceTypes.aHref,icon:"iconLink",click(){Be(o)}}).element),e.disabled||(window.siyuan.menus.menu.append(new M({id:"cut",icon:"iconCut",label:window.siyuan.languages.cut,click(){const u=document.createRange();u.selectNode(t),X(u),document.execCommand("cut")}}).element),window.siyuan.menus.menu.append(new M({id:"remove",icon:"iconTrashcan",label:window.siyuan.languages.remove,click(){t.insertAdjacentHTML("afterend","<wbr>"),t.remove(),s.setAttribute("updated",U().format("YYYYMMDDHHmmss")),K(e,i,s.outerHTML,l),ue(s,e.toolbar.range),l=s.outerHTML}}).element),o!=null&&o.startsWith("assets/")&&window.siyuan.menus.menu.append(new M({id:"rename",label:window.siyuan.languages.rename,icon:"iconEdit",click(){ds(o)}}).element),o!=null&&o.startsWith("siyuan://blocks/")&&window.siyuan.menus.menu.append(new M({id:"turnIntoRef",label:`${window.siyuan.languages.turnInto} <b>${window.siyuan.languages.ref}</b>`,icon:"iconRef",click(){t.setAttribute("data-subtype","s");const u=t.getAttribute("data-type").split(" ");u.push("block-ref"),u.splice(u.indexOf("a"),1),t.setAttribute("data-type",u.join(" ")),t.setAttribute("data-id",r[0].value.replace("siyuan://blocks/","")),r[0].value="",r[2].value="",t.removeAttribute("data-href"),t.removeAttribute("data-title"),s.setAttribute("updated",U().format("YYYYMMDDHHmmss")),K(e,i,s.outerHTML,l),e.toolbar.range.selectNode(t),e.toolbar.range.collapse(!1),X(e.toolbar.range),l=s.outerHTML}}).element),window.siyuan.menus.menu.append(new M({id:"turnIntoText",label:`${window.siyuan.languages.turnInto} <b>${window.siyuan.languages.text}</b>`,icon:"iconRefresh",click(){r[0].value="",r[2].value="",s.setAttribute("updated",U().format("YYYYMMDDHHmmss")),ml(t,"a",e.toolbar.range),K(e,i,s.outerHTML,l),l=s.outerHTML}}).element)),o&&(window.siyuan.menus.menu.append(new M({id:"separator_2",type:"separator"}).element),Ei(e.app,o,!1,!0),o!=null&&o.startsWith("assets/")&&window.siyuan.menus.menu.append(new M(fs(o)).element)),!e.disabled&&((a=e==null?void 0:e.app)!=null&&a.plugins)&&jt({plugins:e.app.plugins,type:"open-menu-link",detail:{protyle:e,element:t},separatorPosition:"top"});const c=t.getBoundingClientRect();window.siyuan.menus.menu.popup({x:c.left,y:c.top+26,h:26});const d=Q(e.element,"block__popover",!0);window.siyuan.menus.menu.element.setAttribute("data-from",d?d.dataset.level+"popover":"app"),!e.disabled&&(n||e.lute.GetLinkDest(o)||o!=null&&o.startsWith("assets/")?r[1].select():r[0].select(),window.siyuan.menus.menu.removeCB=()=>{r[2].value?t.setAttribute("data-title",Lute.EscapeHTMLStr(r[2].value.replace(/\n|\r\n|\r|\u2028|\u2029/g,""))):t.removeAttribute("data-title"),t.getAttribute("data-type").indexOf("a")>-1?t.setAttribute("data-href",Lute.EscapeHTMLStr(r[0].value.replace(/\n|\r\n|\r|\u2028|\u2029/g,""))):t.removeAttribute("data-href");const u=getSelection().rangeCount===0?void 0:getSelection().getRangeAt(0);u&&!e.element.contains(u.startContainer)&&(e.toolbar.range.selectNodeContents(t),e.toolbar.range.collapse(!1),X(e.toolbar.range)),l!==s.outerHTML&&(s.setAttribute("updated",U().format("YYYYMMDDHHmmss")),K(e,i,s.outerHTML,l))})},Hl=(e,t)=>{var n;window.siyuan.menus.menu.remove();const a=B(t);if(!a)return;J(["util","toolbar","hint"],e);const s=a.getAttribute("data-node-id");let i=a.outerHTML;window.siyuan.menus.menu.append(new M({id:"tag",iconHTML:"",type:"readonly",label:`<input class="b3-text-field fn__size200" style="margin: 4px 0" placeholder="${window.siyuan.languages.tag}">`,bind(r){const c=r.querySelector("input");c.value=t.textContent.replace(f.ZWSP,""),c.addEventListener("change",()=>{K(e,s,a.outerHTML,i),i=a.outerHTML}),c.addEventListener("compositionend",()=>{t.innerHTML=f.ZWSP+Lute.EscapeHTMLStr(c.value||"")}),c.addEventListener("input",d=>{d.isComposing||(t.innerHTML=f.ZWSP+Lute.EscapeHTMLStr(c.value||""))}),c.addEventListener("keydown",d=>{if((d.key==="Enter"||d.key==="Escape")&&!d.isComposing){if(d.preventDefault(),d.stopPropagation(),c.value)e.toolbar.range.selectNodeContents(t),e.toolbar.range.collapse(!1),X(e.toolbar.range);else{const u=a.outerHTML;t.insertAdjacentHTML("afterend","<wbr>"),t.remove(),a.setAttribute("updated",U().format("YYYYMMDDHHmmss")),K(e,s,a.outerHTML,u),ue(a,e.toolbar.range)}window.siyuan.menus.menu.remove()}else if(Zn(d))return})}}).element),window.siyuan.menus.menu.append(new M({id:"separator_1",type:"separator"}).element),window.siyuan.menus.menu.append(new M({id:"search",label:window.siyuan.languages.search,accelerator:window.siyuan.languages.click,icon:"iconSearch",click(){qt(e.app,{hasReplace:!1,method:0,hPath:"",idPath:[],k:`#${t.textContent}#`,r:"",page:1})}}).element),window.siyuan.menus.menu.append(new M({id:"rename",label:window.siyuan.languages.rename,icon:"iconEdit",click(){Ro(t.textContent.replace(f.ZWSP,""))}}).element),window.siyuan.menus.menu.append(new M({id:"separator_2",type:"separator"}).element),window.siyuan.menus.menu.append(new M({id:"turnIntoText",label:`${window.siyuan.languages.turnInto} <b>${window.siyuan.languages.text}</b>`,icon:"iconRefresh",click(){e.toolbar.range.setStart(t.firstChild,0),e.toolbar.range.setEnd(t.lastChild,t.lastChild.textContent.length),e.toolbar.setInlineMark(e,"tag","range")}}).element),window.siyuan.menus.menu.append(new M({id:"copy",label:window.siyuan.languages.copy,icon:"iconCopy",click(){const r=document.createRange();r.selectNode(t),X(r),document.execCommand("copy")}}).element),window.siyuan.menus.menu.append(new M({id:"cut",label:window.siyuan.languages.cut,icon:"iconCut",click(){const r=document.createRange();r.selectNode(t),X(r),document.execCommand("cut")}}).element),window.siyuan.menus.menu.append(new M({id:"remove",icon:"iconTrashcan",label:window.siyuan.languages.remove,click(){const r=a.outerHTML;t.insertAdjacentHTML("afterend","<wbr>"),t.remove(),a.setAttribute("updated",U().format("YYYYMMDDHHmmss")),K(e,s,a.outerHTML,r),ue(a,e.toolbar.range)}}).element),(n=e==null?void 0:e.app)!=null&&n.plugins&&jt({plugins:e.app.plugins,type:"open-menu-tag",detail:{protyle:e,element:t},separatorPosition:"top"});const l=t.getBoundingClientRect();window.siyuan.menus.menu.popup({x:l.left,y:l.top+26,h:26});const o=Q(e.element,"block__popover",!0);window.siyuan.menus.menu.element.setAttribute("data-from",o?o.dataset.level+"popover":"app"),window.siyuan.menus.menu.element.querySelector("input").select()},bs=(e,t)=>{window.siyuan.menus.menu.remove();const n=B(t);if(!n)return;const a=n.getAttribute("data-node-id"),s=n.outerHTML;window.siyuan.menus.menu.append(new M({id:"copy",label:window.siyuan.languages.copy,icon:"iconCopy",click(){const l=document.createRange();l.selectNode(t),X(l),document.execCommand("copy")}}).element),e.disabled||(window.siyuan.menus.menu.append(new M({id:"cut",icon:"iconCut",label:window.siyuan.languages.cut,click(){const l=document.createRange();l.selectNode(t),X(l),document.execCommand("cut")}}).element),window.siyuan.menus.menu.append(new M({id:"remove",icon:"iconTrashcan",label:window.siyuan.languages.remove,click(){t.insertAdjacentHTML("afterend","<wbr>"),t.remove(),n.setAttribute("updated",U().format("YYYYMMDDHHmmss")),K(e,a,n.outerHTML,s),ue(n,e.toolbar.range)}}).element));const i=t.getBoundingClientRect();window.siyuan.menus.menu.popup({x:i.left,y:i.top+26,h:26})},Aa=(e,t,n,a,s,i)=>({id:e===window.siyuan.languages.default?"default":"width_"+e,iconHTML:"",label:e,click(){s.setAttribute("updated",U().format("YYYYMMDDHHmmss")),xa(t.parentElement.parentElement),t.parentElement.style.width=e===window.siyuan.languages.default?"":`calc(${e} - 8px)`,t.style.height="",K(n,a,s.outerHTML,i),ne(s)}}),Ca=(e,t,n,a,s,i)=>({id:e===window.siyuan.languages.default?"default":"width_"+e,iconHTML:"",label:e,click(){s.setAttribute("updated",U().format("YYYYMMDDHHmmss")),t.style.height=e===window.siyuan.languages.default?"":parseInt(e)+"vh",xa(t.parentElement.parentElement),t.parentElement.style.width="",K(n,a,s.outerHTML,i),ne(s)}}),Tf=(e,t)=>{const n=t.getAttribute("data-node-id"),a=t.querySelector("iframe");let s=t.outerHTML;const i=[{id:"asset",iconHTML:"",type:"readonly",label:`<textarea spellcheck="false" rows="1" class="b3-text-field fn__size200" placeholder="${window.siyuan.languages.link}" style="margin: 4px 0">${a.getAttribute("src")||""}</textarea>`,bind(o){o.style.maxWidth="none",o.querySelector("textarea").addEventListener("change",r=>{const c=r.target.value.replace(/\n|\r\n|\r|\u2028|\u2029/g,"").trim(),d=c.match(/(?:www\.|\/\/)bilibili\.com\/video\/(\w+)/);if(c.indexOf("bilibili.com")>-1&&(c.indexOf("bvid=")>-1||d&&d[1])){const u={bvid:st("bvid",c)||d&&d[1],page:"1",high_quality:"1",as_wide:"1",allowfullscreen:"true",autoplay:"0"};new URL(c.startsWith("http")?c:"https:"+c).search.split("&").forEach((m,b)=>{if(!m)return;b===0&&(m=m.substr(1));const y=m.split("=");u[y[0]]=y[1]});let p="https://player.bilibili.com/player.html?";const g=Object.keys(u);g.forEach((m,b)=>{p+=`${m}=${u[m]}`,b<g.length-1&&(p+="&")}),a.setAttribute("src",p),a.setAttribute("sandbox","allow-top-navigation-by-user-activation allow-same-origin allow-forms allow-scripts allow-popups"),a.style.height||(a.style.height="360px"),a.style.width||(a.style.width="640px")}else a.setAttribute("src",c);K(e,n,t.outerHTML,s),s=t.outerHTML,r.stopPropagation()})}}],l=a.getAttribute("src");return l?(i.push({type:"separator"}),i.concat(Ei(e.app,l,!0,!1))):i},$f=(e,t,n)=>{const a=t.getAttribute("data-node-id"),s=t.querySelector(n==="NodeVideo"?"video":"audio");let i=t.outerHTML;const l=[{id:"asset",iconHTML:"",type:"readonly",label:`<textarea spellcheck="false" rows="1" style="margin: 4px 0" class="b3-text-field" placeholder="${window.siyuan.languages.link}">${s.getAttribute("src")}</textarea>`,bind(r){r.style.maxWidth="none",r.querySelector("textarea").addEventListener("change",c=>{s.setAttribute("src",c.target.value.replace(/\n|\r\n|\r|\u2028|\u2029/g,"").trim()),K(e,a,t.outerHTML,i),i=t.outerHTML,c.stopPropagation()})}}],o=s.getAttribute("src");return o&&o.startsWith("assets/")&&(l.push({type:"separator"}),l.push({id:"rename",label:window.siyuan.languages.rename,icon:"iconEdit",click(){ds(o)}})),o&&l.push({id:"openBy",label:window.siyuan.languages.openBy,icon:"iconOpen",submenu:Ei(e.app,o,!0,!1)}),o&&o.startsWith("assets/")&&l.push(fs(o)),l},If=(e,t,n,a)=>{var s;const i=[],l=Nn(n);(n.rowSpan>1||n.colSpan>1)&&i.push({id:"cancelMerged",label:window.siyuan.languages.cancelMerged,click:()=>{const I=t.outerHTML;let P=n.rowSpan,N=n.parentElement;const R=n.colSpan;for(;P>0&&N;){let V=N.children[l],W=R;for(;W>0&&V;)V.classList.remove("fn__none"),V.colSpan=1,V.rowSpan=1,V=V.nextElementSibling,W--;N=N.nextElementSibling,P--}if(n.rowSpan=1,n.colSpan=1,n.tagName==="TH"){let V;if(Array.from(t.querySelectorAll("thead tr")).find(W=>{if(V=W,Array.from(W.children).forEach(se=>{(se.rowSpan!==1||se.classList.contains("fn__none"))&&(V=void 0)}),V)return!0}),V){const W=t.querySelector("tbody"),se=t.querySelector("thead");for(;!V.isSameNode(se.lastElementChild);)W.insertAdjacentElement("afterbegin",se.lastElementChild)}}X(a),K(e,t.getAttribute("data-node-id"),t.outerHTML,I)}});const o=t.querySelectorAll("col")[l];(o.style.width||o.style.minWidth)&&i.push({id:"useDefaultWidth",label:window.siyuan.languages.useDefaultWidth,click:()=>{const I=t.outerHTML;o.style.width="",o.style.minWidth="",K(e,t.getAttribute("data-node-id"),t.outerHTML,I)}});const r=t.getAttribute("custom-pinthead");i.push({id:r?"unpinTableHead":"pinTableHead",icon:r?"iconUnpin":"iconPin",label:r?window.siyuan.languages.unpinTableHead:window.siyuan.languages.pinTableHead,click:()=>{const I=t.outerHTML;r?t.removeAttribute("custom-pinthead"):t.setAttribute("custom-pinthead","true"),K(e,t.getAttribute("data-node-id"),t.outerHTML,I)}}),i.push({id:"separator_1",type:"separator"}),i.push({id:"alignLeft",icon:"iconAlignLeft",accelerator:window.siyuan.config.keymap.editor.general.alignLeft.custom,label:window.siyuan.languages.alignLeft,click:()=>{kn(e,[n],t,"left",a)}}),i.push({id:"alignCenter",icon:"iconAlignCenter",label:window.siyuan.languages.alignCenter,accelerator:window.siyuan.config.keymap.editor.general.alignCenter.custom,click:()=>{kn(e,[n],t,"center",a)}}),i.push({id:"alignRight",icon:"iconAlignRight",label:window.siyuan.languages.alignRight,accelerator:window.siyuan.config.keymap.editor.general.alignRight.custom,click:()=>{kn(e,[n],t,"right",a)}}),i.push({id:"useDefaultAlign",icon:"",label:window.siyuan.languages.useDefaultAlign,click:()=>{kn(e,[n],t,"",a)}});const c=[];c.push(...i),c.push({type:"separator"});const d=t.querySelector("table"),u=n.parentElement.querySelector(".fn__none");let p=!1,g=!1;Array.from(n.parentElement.children).forEach(I=>{I.colSpan>1&&(p=!0),I.rowSpan>1&&(g=!0)});let m=!1,b=!1,y=!1,_=n.parentElement.previousElementSibling;!_&&n.parentElement.parentElement.tagName==="TBODY"&&(_=d.querySelector("thead").lastElementChild),_&&(m=_.querySelector(".fn__none"),Array.from(_.children).forEach(I=>{I.colSpan>1&&(b=!0),I.rowSpan>1&&(y=!0)}));let w=!1,v=!1,h=!1,E=n.parentElement.nextElementSibling;!E&&n.parentElement.parentElement.tagName==="THEAD"&&(E=(s=d.querySelector("tbody"))==null?void 0:s.firstElementChild),E&&(w=E.querySelector(".fn__none"),Array.from(E.children).forEach(I=>{I.colSpan>1&&(v=!0),I.rowSpan>1&&(h=!0)}));let S=!0;Array.from(d.rows).find(I=>{const P=I.cells[l];if(P.classList.contains("fn__none")||P.colSpan>1||P.rowSpan>1)return S=!1,!0});let L=!0;Array.from(d.rows).find(I=>{const P=I.cells[l+1];if(P&&(P.classList.contains("fn__none")||P.colSpan>1||P.rowSpan>1))return L=!1,!0});let k=!0;Array.from(d.rows).find(I=>{const P=I.cells[l-1];if(P&&(P.classList.contains("fn__none")||P.colSpan>1||P.rowSpan>1))return k=!1,!0});const x=[];x.push({id:"insertRowAbove",icon:"iconBefore",label:window.siyuan.languages.insertRowAbove,accelerator:window.siyuan.config.keymap.editor.table.insertRowAbove.custom,click:()=>{gr(e,a,n,t)}}),(!w||w&&!h&&v)&&x.push({id:"insertRowBelow",icon:"iconAfter",label:window.siyuan.languages.insertRowBelow,accelerator:window.siyuan.config.keymap.editor.table.insertRowBelow.custom,click:()=>{pl(e,a,n,t)}}),(S||k)&&x.push({id:"insertColumnLeft",icon:"iconInsertLeft",label:window.siyuan.languages.insertColumnLeft,accelerator:window.siyuan.config.keymap.editor.table.insertColumnLeft.custom,click:()=>{os(e,t,n,"beforebegin",a)}}),(S||L)&&x.push({id:"insertColumnRight",icon:"iconInsertRight",label:window.siyuan.languages.insertColumnRight,accelerator:window.siyuan.config.keymap.editor.table.insertColumnRight.custom,click:()=>{os(e,t,n,"afterend",a)}}),c.push(...x);const C=[];((!u||u&&!g&&p)&&(!m||m&&!y&&b)||(!u||u&&!g&&p)&&(!w||w&&!h&&v)||S&&k||S&&L)&&C.push({id:"separator_2",type:"separator"}),(!u||u&&!g&&p)&&(!m||m&&!y&&b)&&C.push({id:"moveToUp",icon:"iconUp",label:window.siyuan.languages.moveToUp,accelerator:window.siyuan.config.keymap.editor.table.moveToUp.custom,click:()=>{br(e,a,n,t)}}),(!u||u&&!g&&p)&&(!w||w&&!h&&v)&&C.push({id:"moveToDown",icon:"iconDown",label:window.siyuan.languages.moveToDown,accelerator:window.siyuan.config.keymap.editor.table.moveToDown.custom,click:()=>{yr(e,a,n,t)}}),S&&k&&C.push({id:"moveToLeft",icon:"iconLeft",label:window.siyuan.languages.moveToLeft,accelerator:window.siyuan.config.keymap.editor.table.moveToLeft.custom,click:()=>{wr(e,a,n,t)}}),S&&L&&C.push({id:"moveToRight",icon:"iconRight",label:window.siyuan.languages.moveToRight,accelerator:window.siyuan.config.keymap.editor.table.moveToRight.custom,click:()=>{hr(e,a,n,t)}}),c.push(...C),(n.parentElement.parentElement.tagName!=="THEAD"&&(!u&&!g||u&&!g&&p)||S)&&c.push({type:"separator"});const T=[];return n.parentElement.parentElement.tagName!=="THEAD"&&(!u&&!g||u&&!g&&p)&&T.push({id:"deleteRow",icon:"iconDeleteRow",label:window.siyuan.languages["delete-row"],accelerator:window.siyuan.config.keymap.editor.table["delete-row"].custom,click:()=>{pr(e,a,n,t)}}),S&&T.push({id:"deleteColumn",icon:"iconDeleteColumn",label:window.siyuan.languages["delete-column"],accelerator:window.siyuan.config.keymap.editor.table["delete-column"].custom,click:()=>{mr(e,a,t,n)}}),c.push(...T),{menus:c,removeMenus:T,insertMenus:x,otherMenus:i,other2Menus:C}},ht=(e,t,n,a,s=!0)=>{if(t.getAttribute("data-type")==="NodeListItem"&&t.childElementCount<4||t.getAttribute("data-type")==="NodeThematicBreak")return-1;const i=t.getAttribute("fold")==="1";if(i){if(typeof n=="boolean"&&!n)return-1;t.removeAttribute("fold"),t.querySelectorAll(".protyle-linenumber__rows").forEach(o=>{Oa(o.parentElement)})}else{if(typeof n=="boolean"&&n)return-1;if(t.setAttribute("fold","1"),getSelection().rangeCount>0){const o=getSelection().getRangeAt(0),r=B(o.startContainer);r&&r.getBoundingClientRect().width===0&&ne(t,void 0,!1)}t.querySelectorAll(".img--select, .av__cell--select, .av__cell--active, .av__row--select").forEach(o=>{var r;o.classList.contains("av__row--select")?(o.classList.remove("av__row--select"),o.querySelector(".av__firstcol use").setAttribute("xlink:href","#iconUncheck"),ca(o)):((r=o.querySelector(".av__drag-fill"))==null||r.remove(),o.classList.remove("img--select","av__cell--select","av__cell--active"))})}const l=t.getAttribute("data-node-id");return t.getAttribute("data-type")==="NodeHeading"?i?(s&&t.insertAdjacentHTML("beforeend",'<div spin="1" style="text-align: center"><img width="24px" height="24px" src="/stage/loading-pure.svg"></div>'),q(e,[{action:"unfoldHeading",id:l,data:a?"remove":void 0}],[{action:"foldHeading",id:l}])):(q(e,[{action:"foldHeading",id:l}],[{action:"unfoldHeading",id:l}]),Ar(t)):q(e,[{action:"setAttrs",id:l,data:JSON.stringify({fold:i?"":"1"})}],[{action:"setAttrs",id:l,data:JSON.stringify({fold:i?"1":""})}]),en(e),i?0:1},ln=(e,t,n,a)=>{var s,i,l,o,r,c,d;en(e);const u=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if((u==null?void 0:u.length)>0){const L=[],k=[];let x,C=!1;a==="Backspace"?(x=u[0].previousElementSibling,x||(C=!0,x=u[u.length-1].nextElementSibling)):(x=u[u.length-1].nextElementSibling,C=!0,x||(C=!1,x=u[0].previousElementSibling));let T,I;J(["select"],e);let P;if(u.find(N=>{const R=Ne(N);I=R.parentElement;const V=R.getAttribute("data-node-id");if(L.push({action:"delete",id:V}),a==="Backspace"?(x=De(R),x||(C=!0,x=et(R))):(x=et(R),C=!0,x||(C=!1,x=De(R))),x||(x=R.parentElement||e.wysiwyg.element.firstElementChild,C=!1),R.getAttribute("data-type")==="NodeHeading"&&R.getAttribute("fold")==="1"){ht(e,R,void 0,!0);let W=R.previousElementSibling?R.previousElementSibling.getAttribute("data-node-id"):"";typeof P!="undefined"&&(W=P),k.push({action:"insert",data:R.outerHTML,id:V,previousID:W,parentID:R.parentElement.getAttribute("data-node-id")||e.block.parentID});let se=De(R);for(;se&&se.childElementCount===3;)se=De(se);se?P=se.getAttribute("data-node-id"):P="",R.firstElementChild.removeAttribute("contenteditable");const Ce=R.nextElementSibling;if(Ce){const fe=Ce.getAttribute("data-type");if(fe!=="NodeHeading"||fe==="NodeHeading"&&Ce.getAttribute("data-subtype")>R.getAttribute("data-subtype"))return!0}}else{let W=R.outerHTML;(R.classList.contains("render-node")||R.querySelector("div.render-node"))&&(W=e.lute.SpinBlockDOM(R.outerHTML));let se=R.previousElementSibling?R.previousElementSibling.getAttribute("data-node-id"):"";typeof P!="undefined"&&(se=P),k.push({action:"insert",data:W,id:V,previousID:se,parentID:R.parentElement.getAttribute("data-node-id")||e.block.parentID}),R.getAttribute("data-subtype")==="o"&&R.classList.contains("li")?T=R.parentElement:T=void 0,R.remove()}}),x)if(e.block.showAll&&x.classList.contains("protyle-wysiwyg")&&e.wysiwyg.element.childElementCount===0)setTimeout(()=>{Ot({protyle:e,id:e.block.parent2ID,focusId:e.block.parent2ID})},f.TIMEOUT_INPUT*2+100);else{if(x.classList.contains("protyle-wysiwyg")&&e.wysiwyg.element.childElementCount===0){const N=Lute.NewNodeID(),R=Xn(!1,!0,N);x.insertAdjacentElement("afterbegin",R),L.push({action:"insert",data:R.outerHTML,id:N,parentID:x.getAttribute("data-node-id")||e.block.parentID}),k.push({action:"delete",id:N}),x=void 0,ue(R,n)}a!=="Backspace"&&C?ne(x):ne(x,void 0,!1),He(e,x),T&&(k.push({action:"update",id:T.getAttribute("data-node-id"),data:T.outerHTML}),je(T,1),L.push({action:"update",id:T.getAttribute("data-node-id"),data:T.outerHTML}))}if(L.length>0)if(I&&I.getAttribute("data-type")==="NodeSuperBlock"&&I.childElementCount===2){const N=sa(e,I);q(e,L.concat(N.doOperations),N.undoOperations.concat(k.reverse()))}else q(e,L,k.reverse());J(["util"],e);return}const p=t.getAttribute("data-type");if(p==="NodeCodeBlock"&&oe(t).textContent.trim()===""){t.classList.add("protyle-wysiwyg--select"),ln(e,t,n,a);return}if(!t.previousElementSibling&&t.parentElement.getAttribute("data-type")==="NodeBlockquote"){n.insertNode(document.createElement("wbr"));const L=t.parentElement;L.insertAdjacentElement("beforebegin",t),L.childElementCount===1?(q(e,[{action:"move",id:t.getAttribute("data-node-id"),previousID:(s=t.previousElementSibling)==null?void 0:s.getAttribute("data-node-id"),parentID:L.parentElement.getAttribute("data-node-id")||e.block.parentID},{action:"delete",id:L.getAttribute("data-node-id")}],[{action:"insert",id:L.getAttribute("data-node-id"),data:L.outerHTML,previousID:(i=t.previousElementSibling)==null?void 0:i.getAttribute("data-node-id"),parentID:L.parentElement.getAttribute("data-node-id")||e.block.parentID},{action:"move",id:t.getAttribute("data-node-id"),parentID:L.getAttribute("data-node-id")}]),L.remove()):q(e,[{action:"move",id:t.getAttribute("data-node-id"),previousID:(l=t.previousElementSibling)==null?void 0:l.getAttribute("data-node-id"),parentID:L.parentElement.getAttribute("data-node-id")||e.block.parentID}],[{action:"move",id:t.getAttribute("data-node-id"),parentID:L.getAttribute("data-node-id")}]),ue(t,n);return}if(t.parentElement.classList.contains("li")&&t.getAttribute("data-type")!=="NodeHeading"&&t.previousElementSibling.classList.contains("protyle-action")){Df(e,t,n,a==="Delete");return}const g=De(t);if(["NodeCodeBlock","NodeTable","NodeAttributeView"].includes(p)){if(g)if(g.classList.contains("p")&&oe(g).textContent===""){const L=De(g);q(e,[{action:"delete",id:g.getAttribute("data-node-id")}],[{action:"insert",data:g.outerHTML,id:g.getAttribute("data-node-id"),parentID:g.parentElement.getAttribute("data-node-id")||e.block.parentID,previousID:L&&(!g.previousElementSibling||!g.previousElementSibling.classList.contains("protyle-action"))?L.getAttribute("data-node-id"):void 0}]),g.remove()}else ne(g,void 0,!1);return}if(p==="NodeHeading"){xn({protyle:e,selectsElement:[t],type:"Blocks2Ps",range:Fa(t,n,a==="Delete")});return}if(t.previousElementSibling&&t.previousElementSibling.classList.contains("protyle-breadcrumb__bar"))return;if(!g){if(e.wysiwyg.element.childElementCount>1&&oe(t).textContent===""){ne(e.wysiwyg.element.firstElementChild.nextElementSibling);const L=Ne(t);q(e,[{action:"delete",id:L.getAttribute("data-node-id")}],[{action:"insert",data:L.outerHTML,id:L.getAttribute("data-node-id"),parentID:e.block.parentID}]),L.remove()}return}const m=t.parentElement,b=oe(t),y=lt(g);if(n.toString()===""&&H()&&y&&y.classList.contains("hr")&&Je(b).start===0){q(e,[{action:"delete",id:y.getAttribute("data-node-id")}],[{action:"insert",data:y.outerHTML,id:y.getAttribute("data-node-id"),previousID:(o=y.previousElementSibling)==null?void 0:o.getAttribute("data-node-id"),parentID:y.parentElement.getAttribute("data-node-id")}]),y.remove();return}const _=y&&(y.classList.contains("table")||y.classList.contains("render-node")||y.classList.contains("iframe")||y.classList.contains("hr")||y.classList.contains("av")||y.classList.contains("code-block")),w=y.getAttribute("data-node-id");if(_){if(y.classList.contains("code-block")){if(b.textContent.trim()===""){const L=t.getAttribute("data-node-id"),k=[{action:"delete",id:L}],x=[{action:"insert",data:t.outerHTML,id:L,previousID:(r=t.previousElementSibling)==null?void 0:r.getAttribute("data-node-id"),parentID:t.parentElement.getAttribute("data-node-id")}];if(t.remove(),m.getAttribute("data-type")==="NodeSuperBlock"&&m.childElementCount===2){const C=sa(e,m);q(e,k.concat(C.doOperations),C.undoOperations.concat(x))}else q(e,k,x);ne(e.wysiwyg.element.querySelector(`[data-node-id="${w}"]`),void 0,!1)}else ne(y,void 0,!1);return}if(b.textContent!==""||t.classList.contains("av")){ne(y,void 0,!1);return}}const v=Ct(t),h=v.getAttribute("data-node-id");n.insertNode(document.createElement("wbr"));const E=[{action:"update",data:y.outerHTML,id:w},{action:"insert",data:v.outerHTML,id:h,previousID:(c=t.previousElementSibling)==null?void 0:c.getAttribute("data-node-id"),parentID:m.getAttribute("data-node-id")}],S=[{action:"delete",id:h}];if(_)v.remove(),ne(y,void 0,!1),E.splice(0,1);else{const L=oe(y);if(b&&(b.textContent!==""||b.querySelector(".emoji"))&&(n.setEndAfter(b.lastChild),(((d=L==null?void 0:L.lastElementChild)==null?void 0:d.getAttribute("data-type"))||"").indexOf("inline-math")>-1)){const C=Fe(L==null?void 0:L.lastElementChild);C&&C.textContent===`
`&&C.remove()}const k=e.contentElement.scrollTop,x=n.extractContents();n.selectNodeContents(L),n.collapse(!1),n.insertNode(x),v.remove(),e.contentElement.scrollTop=k,e.scroll.lastScrollTop=k-1,S.push({action:"update",data:y.outerHTML,id:w})}if(m.getAttribute("data-type")==="NodeSuperBlock"&&m.childElementCount===2){const L=sa(e,m);q(e,S.concat(L.doOperations),L.undoOperations.concat(E))}else q(e,S,E);ue(e.wysiwyg.element,n)},Fa=(e,t,n)=>{if(n){const a=De(e);if(a){const s=oe(lt(a));if(s)return nt(s,t,!1)}}},Nl=(e,t,n,a)=>{const s=t.outerHTML,i=ut(e);i&&i.textContent.endsWith(f.ZWSP)&&(i.textContent=i.textContent.substring(0,i.textContent.length-1));const l=Fe(e);l&&l.textContent.startsWith(f.ZWSP)&&(l.textContent=l.textContent.replace(f.ZWSP,"")),e.insertAdjacentHTML("afterend","<wbr>"),e.remove(),K(a,t.getAttribute("data-node-id"),t.outerHTML,s),ue(t,n);const o=oe(t);o.innerHTML.trim()===""&&(o.innerHTML="")},Df=(e,t,n,a=!1)=>{var s;if(!t.parentElement.previousElementSibling&&t.parentElement.nextElementSibling&&t.parentElement.nextElementSibling.classList.contains("protyle-attr")){Wa(e,[t.parentElement],n,a,t);return}if(!t.parentElement.previousElementSibling&&t.parentElement.parentElement.parentElement.classList.contains("list")){n.insertNode(document.createElement("wbr"));const p=t.parentElement.parentElement,g=p.outerHTML,m=t.parentElement.parentElement.previousElementSibling.lastElementChild,b=m.parentElement.outerHTML;t.parentElement.firstElementChild.remove(),t.parentElement.lastElementChild.remove(),m.insertAdjacentHTML("beforebegin",t.parentElement.innerHTML),t.parentElement.remove(),p.getAttribute("data-subtype")==="o"&&je(p),q(e,[{action:"update",id:p.getAttribute("data-node-id"),data:p.outerHTML},{action:"update",data:m.parentElement.outerHTML,id:m.parentElement.getAttribute("data-node-id")}],[{action:"update",data:b,id:m.parentElement.getAttribute("data-node-id")},{action:"update",data:g,id:p.getAttribute("data-node-id")}]),ue(m.parentElement,n);return}if(!t.parentElement.previousElementSibling){if(t.parentElement.parentElement.classList.contains("protyle-wysiwyg"))return;Fa(t,n,a),n.insertNode(document.createElement("wbr"));const p=t.parentElement.parentElement,g=p.outerHTML;t.parentElement.firstElementChild.remove(),t.parentElement.lastElementChild.remove();const m=document.createElement("div");m.innerHTML=t.parentElement.innerHTML;const b=[],y=[];if(Array.from(m.children).forEach((_,w)=>{var v;b.push({action:"insert",id:_.getAttribute("data-node-id"),data:_.outerHTML,previousID:w===0?(v=p.previousElementSibling)==null?void 0:v.getAttribute("data-node-id"):b[w-1].id,parentID:p.parentElement.getAttribute("data-node-id")||e.block.parentID}),y.push({action:"delete",id:_.getAttribute("data-node-id")})}),p.insertAdjacentHTML("beforebegin",t.parentElement.innerHTML),t.parentElement.remove(),p.getAttribute("data-subtype")==="o"&&je(p,parseInt(p.firstElementChild.getAttribute("data-marker"))-1),b.splice(0,0,{action:"update",id:p.getAttribute("data-node-id"),data:p.outerHTML}),y.push({action:"update",data:g,id:p.getAttribute("data-node-id")}),q(e,b,y),p.parentElement.classList.contains("sb")&&p.parentElement.getAttribute("data-sb-layout")==="col"){const _=[];let w=p;for(;w&&(_.push(w),y[0].id!==w.getAttribute("data-node-id"));)w=w.previousElementSibling;Kt({protyle:e,selectsElement:_.reverse(),type:"BlocksMergeSuperBlock",level:"row"})}ue(e.wysiwyg.element,n);return}const i=t.parentElement;if(i.previousElementSibling&&i.previousElementSibling.classList.contains("protyle-breadcrumb__bar"))return;const l=i.getAttribute("data-node-id"),o=i.parentElement;Fa(t,n,a),n.insertNode(document.createElement("wbr"));const r=o.outerHTML,c=[],d=[{action:"insert",id:l,data:"",previousID:i.previousElementSibling.getAttribute("data-node-id")}],u=i.previousElementSibling.lastElementChild;if(i.previousElementSibling.getAttribute("fold")==="1")if(oe(t).textContent.trim()===""&&t.nextElementSibling.classList.contains("protyle-attr"))c.push({action:"delete",id:l}),d[0].data=i.outerHTML,nt(oe(i.previousElementSibling),n),n.collapse(!0),i.remove();else{nt(oe(i.previousElementSibling),n),n.collapse(!0),X(n),(s=t.querySelector("wbr"))==null||s.remove();return}else{let p=u.previousElementSibling.getAttribute("data-node-id");Array.from(t.parentElement.children).forEach((g,m)=>{if(g.classList.contains("protyle-action")||g.classList.contains("protyle-attr"))return;const b=g.getAttribute("data-node-id");c.push({action:"move",id:b,previousID:p}),d.push({action:"move",id:b,previousID:m===1?void 0:p,parentID:l}),p=b,u.before(g)}),c.push({action:"delete",id:l}),d[0].data=i.outerHTML,i.remove()}o.classList.contains("protyle-wysiwyg")?q(e,c,d):(o.getAttribute("data-subtype")==="o"&&je(o),K(e,o.getAttribute("data-node-id"),o.outerHTML,r)),ue(u.parentElement,n)},je=(e,t)=>{if(e.getAttribute("data-subtype")!=="o")return;let n;Array.from(e.children).forEach((a,s)=>{s===0?t?(n=t,a.setAttribute("data-marker",n+"."),a.querySelector(".protyle-action--order").textContent=n+"."):n=parseInt(a.getAttribute("data-marker")):a.classList.contains("li")&&(n++,a.setAttribute("data-marker",n+"."),a.querySelector(".protyle-action--order").textContent=n+".")})},ia=(e,t=0,n=!1)=>{const a=document.createElement("template"),s=e.getAttribute("data-subtype");if(s==="o"){const i=parseInt(e.getAttribute("data-marker"))+t;a.innerHTML=`<div data-marker="${i+1}." data-subtype="${s}" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div contenteditable="false" class="protyle-action protyle-action--order" draggable="true">${i+1}.</div>${ws(!1,n)}<div class="protyle-attr" contenteditable="false"></div></div>`}else s==="t"?a.innerHTML=`<div data-marker="*" data-subtype="${s}" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#iconUncheck"></use></svg></div>${ws(!1,n)}<div class="protyle-attr" contenteditable="false"></div></div>`:a.innerHTML=`<div data-marker="*" data-subtype="${s}" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div class="protyle-action" draggable="true"><svg><use xlink:href="#iconDot"></use></svg></div>${ws(!1,n)}<div class="protyle-attr" contenteditable="false"></div></div>`;return a.content.firstElementChild},Mf=(e,t,n)=>{var a;const s=$(t,"li");if(!s)return;const i=(a=s.querySelector(".list"))==null?void 0:a.lastElementChild.previousElementSibling;if(!i)return;const l=ia(i,0,!0),o=l.getAttribute("data-node-id");i.after(l),i.parentElement.getAttribute("fold")==="1"&&ht(e,i.parentElement,!0),s.getAttribute("fold")==="1"&&ht(e,s,!0),q(e,[{action:"insert",id:o,data:l.outerHTML,previousID:i.getAttribute("data-node-id")}],[{action:"delete",id:o}]),ue(l,n)},ys=(e,t,n)=>{if(t.forEach(i=>{i.removeAttribute("select-start"),i.removeAttribute("select-end")}),!t[0].classList.contains("li"))if(t[0].parentElement.childElementCount===t.length+2)t=[t[0].parentElement];else return;const a=t[0].previousElementSibling;if(!a)return;n.collapse(!1),n.insertNode(document.createElement("wbr"));const s=a.parentElement.outerHTML;if(a.lastElementChild.previousElementSibling.getAttribute("data-type")==="NodeList"){const i=a.lastElementChild.previousElementSibling.outerHTML,l=[],o=[],r=a.lastElementChild.previousElementSibling.getAttribute("data-subtype");let c=a.lastElementChild.previousElementSibling.lastElementChild.previousElementSibling.getAttribute("data-node-id");t.forEach((d,u)=>{l.push({action:"move",id:d.getAttribute("data-node-id"),previousID:c}),o.push({action:"move",id:d.getAttribute("data-node-id"),previousID:u===0?a.getAttribute("data-node-id"):c}),c=d.getAttribute("data-node-id"),d.setAttribute("data-subtype",r);const p=d.querySelector(".protyle-action");r==="o"?(p.classList.add("protyle-action--order"),p.classList.remove("protyle-action--task"),a.lastElementChild.previousElementSibling.lastElementChild.before(d)):r==="t"?(d.setAttribute("data-marker","*"),p.innerHTML=`<svg><use xlink:href="#icon${d.classList.contains("protyle-task--done")?"Check":"Uncheck"}"></use></svg>`,p.classList.remove("protyle-action--order"),p.classList.add("protyle-action--task"),a.lastElementChild.previousElementSibling.lastElementChild.before(d)):(d.setAttribute("data-marker","*"),p.innerHTML='<svg><use xlink:href="#iconDot"></use></svg>',p.classList.remove("protyle-action--order","protyle-action--task"),a.lastElementChild.previousElementSibling.lastElementChild.before(d))}),r==="o"?(je(a.lastElementChild.previousElementSibling),je(a.parentElement)):a.getAttribute("data-subtype")==="o"&&je(a.parentElement),a.parentElement.classList.contains("protyle-wysiwyg")&&(l.push({action:"update",data:a.lastElementChild.previousElementSibling.outerHTML,id:a.lastElementChild.previousElementSibling.getAttribute("data-node-id")}),o.push({action:"update",data:i,id:a.lastElementChild.previousElementSibling.getAttribute("data-node-id")}),q(e,l,o))}else{const i=a.outerHTML,l=t[0].getAttribute("data-subtype"),o=document.createElement("div"),r=Lute.NewNodeID();o.setAttribute("data-node-id",r),o.setAttribute("data-type","NodeList"),o.setAttribute("class","list"),o.setAttribute("data-subtype",l),o.innerHTML='<div class="protyle-attr" contenteditable="false"></div>';const c=[{action:"insert",data:o.outerHTML,id:r,previousID:a.lastElementChild.previousElementSibling.getAttribute("data-node-id")}];a.lastElementChild.before(o);const d=[];let u;t.forEach((p,g)=>{c.push({action:"move",id:p.getAttribute("data-node-id"),parentID:r,previousID:u}),d.push({action:"move",id:p.getAttribute("data-node-id"),previousID:g===0?a.getAttribute("data-node-id"):u}),u=p.getAttribute("data-node-id"),o.lastElementChild.before(p)}),d.push({action:"delete",id:r}),l==="o"&&(je(o,1),je(a.parentElement)),a.parentElement.classList.contains("protyle-wysiwyg")&&(c.push({action:"update",data:a.outerHTML,id:a.getAttribute("data-node-id")}),d.push({action:"update",data:i,id:a.getAttribute("data-node-id")}),q(e,c,d))}a.parentElement.classList.contains("protyle-wysiwyg")||K(e,a.parentElement.getAttribute("data-node-id"),a.parentElement.outerHTML,s),ue(a,n)},Hf=(e,t,n)=>{var a,s;const i=t.parentElement,l=i.getAttribute("data-node-id"),o=[],r=[];n.insertNode(document.createElement("wbr"));const c=Lute.NewNodeID();let d="",u=0;Array.from(i.parentElement.children).forEach(g=>{!u&&g.isSameNode(i)?u=1:u&&!g.classList.contains("protyle-attr")&&(r.push({id:g.getAttribute("data-node-id"),action:"move",previousID:l}),o.push({id:g.getAttribute("data-node-id"),action:"delete"}),g.getAttribute("data-subtype")==="o"&&(r.push({id:g.getAttribute("data-node-id"),action:"update",data:g.outerHTML}),g.setAttribute("data-marker",u+"."),g.firstElementChild.innerHTML=u+"."),d+=g.outerHTML,g.remove(),u++)}),r.reverse(),d=`<div data-subtype="${i.getAttribute("data-subtype")}" data-node-id="${c}" data-type="NodeList" class="list" updated="${U().format("YYYYMMDDHHmmss")}">${d}<div class="protyle-attr" contenteditable="false">${f.ZWSP}</div></div>`,i.parentElement.insertAdjacentHTML("afterend",d),o.push({id:c,action:"insert",previousID:i.parentElement.getAttribute("data-node-id"),data:d}),r.push({id:c,action:"delete"}),Array.from(i.children).reverse().forEach(g=>{!g.classList.contains("protyle-action")&&!g.classList.contains("protyle-attr")&&(o.push({id:g.getAttribute("data-node-id"),action:"move",previousID:i.parentElement.getAttribute("data-node-id")}),r.push({id:g.getAttribute("data-node-id"),action:"move",parentID:l}),i.parentElement.after(g))});const p=i.parentElement.getAttribute("data-node-id");i.parentElement.childElementCount===2?(r.splice(0,0,{id:p,action:"insert",data:i.parentElement.outerHTML,previousID:(a=i.parentElement.previousElementSibling)==null?void 0:a.getAttribute("data-node-id"),parentID:i.parentElement.parentElement.getAttribute("data-node-id")||e.block.rootID}),i.parentElement.remove(),o.push({id:p,action:"delete"})):(r.splice(0,0,{id:l,action:"insert",data:i.outerHTML,previousID:(s=i.previousElementSibling)==null?void 0:s.getAttribute("data-node-id"),parentID:p}),i.remove(),o.push({id:l,action:"delete"})),q(e,o,r),ue(e.wysiwyg.element,n)},Wa=(e,t,n,a=!1,s)=>{var i,l,o,r,c,d,u,p;if(t.forEach(k=>{k.removeAttribute("select-start"),k.removeAttribute("select-end")}),!t[0].classList.contains("li"))if(t[0].parentElement.childElementCount===t.length+2)t=[t[0].parentElement];else return;const g=t[0].parentElement,m=g.getAttribute("data-node-id");if(!m)return;const b=g.parentElement,y=b.parentElement;if((i=g.previousElementSibling)!=null&&i.classList.contains("protyle-action")&&!y.getAttribute("data-node-id"))return;if(b.classList.contains("protyle-wysiwyg")||b.classList.contains("sb")||b.classList.contains("bq")){const k=[],x=[];n.collapse(!1),Fa(s,n,a),n.insertNode(document.createElement("wbr"));let C;!t[0].previousElementSibling&&g.getAttribute("data-subtype")==="o"&&(C=parseInt(t[0].getAttribute("data-marker")));let T=m,I=g,P=t[t.length-1].nextElementSibling,N=t[t.length-1].lastElementChild.previousElementSibling;if(t.forEach(V=>{Array.from(V.children).forEach((W,se)=>{const Ce=W.getAttribute("data-node-id");Ce&&(k.push({action:"move",id:Ce,previousID:T,parentID:b.getAttribute("data-node-id")||e.block.parentID}),x.push({action:"move",id:Ce,previousID:se===1?void 0:T,parentID:V.getAttribute("data-node-id"),data:W.contains(n.startContainer)?"focus":""}),T=Ce,I.after(W),I=W)})}),!window.siyuan.config.editor.listLogicalOutdent&&!P.classList.contains("protyle-attr")){let V;N.getAttribute("data-subtype")!==P.getAttribute("data-subtype")&&(V=Lute.NewNodeID(),N=document.createElement("div"),N.classList.add("list"),N.setAttribute("data-subtype",P.getAttribute("data-subtype")),N.setAttribute("data-node-id",V),N.setAttribute("data-type","NodeList"),N.setAttribute("updated",U().format("YYYYMMDDHHmmss")),N.innerHTML=`<div class="protyle-attr" contenteditable="false">${f.ZWSP}</div>`,I.after(N),k.push({action:"insert",id:V,data:N.outerHTML,previousID:I.getAttribute("data-node-id")}));let W;for(;P&&!P.classList.contains("protyle-attr");){k.push({action:"move",id:P.getAttribute("data-node-id"),previousID:W||((l=N.lastElementChild.previousElementSibling)==null?void 0:l.getAttribute("data-node-id")),parentID:N.getAttribute("data-node-id")}),x.push({action:"move",id:P.getAttribute("data-node-id"),parentID:N.getAttribute("data-node-id"),previousID:W||((o=P.previousElementSibling)==null?void 0:o.getAttribute("data-node-id"))}),W=P.getAttribute("data-node-id");const se=P;P=P.nextElementSibling,N.lastElementChild.before(se)}N.getAttribute("data-subtype")==="o"&&(Array.from(N.children).forEach(se=>{const Ce=se.getAttribute("data-node-id");Ce&&x.push({action:"update",id:Ce,data:se.outerHTML})}),je(N,1),Array.from(N.children).forEach(se=>{const Ce=se.getAttribute("data-node-id");Ce&&k.push({action:"update",id:Ce,data:se.outerHTML})})),V&&x.push({action:"delete",id:V})}const R=g.outerHTML;t.forEach(V=>{V.remove()}),g.childElementCount===1?(k.push({action:"delete",id:m}),m===e.block.id&&(e.block.id=e.block.parentID),x.splice(0,0,{action:"insert",data:R,id:m,previousID:(r=g.previousElementSibling)==null?void 0:r.getAttribute("data-node-id"),parentID:b.getAttribute("data-node-id")||e.block.parentID}),g.remove()):(g.getAttribute("data-subtype")==="o"&&je(g,C),k.push({action:"update",id:m,data:g.outerHTML}),x.splice(0,0,{action:"update",id:m,data:R})),q(e,k,x),g.childElementCount!==1&&b.classList.contains("sb")&&b.getAttribute("data-sb-layout")==="col"&&Kt({protyle:e,selectsElement:[g,g.nextElementSibling],type:"BlocksMergeSuperBlock",level:"row"}),ue(b,n);return}if(g.childElementCount===2&&b.childElementCount===3){n.collapse(!1),Fa(s,n,a),n.insertNode(document.createElement("wbr"));const k=b.outerHTML;t[0].firstElementChild.remove(),t[0].lastElementChild.remove(),g.outerHTML=t[0].innerHTML,K(e,b.getAttribute("data-node-id"),b.outerHTML,k),ue(b,n);return}n.collapse(!1),Fa(s,n,a),n.insertNode(document.createElement("wbr"));const _=[],w=[],v=(c=t[0].previousElementSibling)==null?void 0:c.getAttribute("data-node-id");let h;!t[0].previousElementSibling&&g.getAttribute("data-subtype")==="o"&&(h=parseInt(t[0].getAttribute("data-marker")));const E=b.parentElement.outerHTML;let S=t[t.length-1].nextElementSibling,L=t[t.length-1].lastElementChild.previousElementSibling;if(t.reverse().forEach(k=>{const x=k.getAttribute("data-node-id");_.push({action:"move",id:x,previousID:b.getAttribute("data-node-id")}),w.push({action:"move",id:x,previousID:v,parentID:g.getAttribute("data-node-id")}),b.after(k),(k.getAttribute("data-subtype")==="o"||k.getAttribute("data-subtype")==="t")&&b.getAttribute("data-subtype")==="u"?(w.push({action:"update",id:x,data:k.outerHTML}),k.querySelector(".protyle-action").outerHTML='<div class="protyle-action" draggable="true"><svg><use xlink:href="#iconDot"></use></svg></div>',k.setAttribute("data-subtype","u"),k.setAttribute("data-marker","*"),k.classList.remove("protyle-task--done"),_.push({action:"update",id:x,data:k.outerHTML})):(k.getAttribute("data-subtype")==="u"||k.getAttribute("data-subtype")==="t")&&b.getAttribute("data-subtype")==="o"?(w.push({action:"update",id:x,data:k.outerHTML}),k.querySelector(".protyle-action").outerHTML='<div contenteditable="false" draggable="true" class="protyle-action protyle-action--order">1.</div>',k.setAttribute("data-subtype","o"),k.setAttribute("data-marker","1."),_.push({action:"update",id:x,data:k.outerHTML})):(k.getAttribute("data-subtype")==="u"||k.getAttribute("data-subtype")==="o")&&b.getAttribute("data-subtype")==="t"&&(w.push({action:"update",id:x,data:k.outerHTML}),k.querySelector(".protyle-action").outerHTML='<div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#iconUncheck"></use></svg></div>',k.setAttribute("data-subtype","t"),k.setAttribute("data-marker","*"),_.push({action:"update",id:x,data:k.outerHTML}))}),!window.siyuan.config.editor.listLogicalOutdent&&!S.classList.contains("protyle-attr")){let k;L.classList.contains("list")||(k=Lute.NewNodeID(),L=document.createElement("div"),L.classList.add("list"),L.setAttribute("data-subtype",S.getAttribute("data-subtype")),L.setAttribute("data-node-id",k),L.setAttribute("data-type","NodeList"),L.setAttribute("updated",U().format("YYYYMMDDHHmmss")),L.innerHTML=`<div class="protyle-attr" contenteditable="false">${f.ZWSP}</div>`,_.push({action:"insert",id:k,data:L.outerHTML,previousID:t[0].lastElementChild.previousElementSibling.getAttribute("data-node-id")}),t[0].lastElementChild.before(L));let x;for(;S&&!S.classList.contains("protyle-attr");){const C=S.getAttribute("data-node-id");S.getAttribute("data-subtype")!==L.getAttribute("data-subtype")&&(w.push({action:"update",id:C,data:S.outerHTML}),S.querySelector(".protyle-action").outerHTML=L.querySelector(".protyle-action").outerHTML,S.setAttribute("data-subtype",L.getAttribute("data-subtype")),S.setAttribute("data-marker",L.getAttribute("data-marker")),_.push({action:"update",id:C,data:S.outerHTML})),_.push({action:"move",id:C,previousID:x||((d=L.lastElementChild.previousElementSibling)==null?void 0:d.getAttribute("data-node-id")),parentID:L.getAttribute("data-node-id")}),w.push({action:"move",id:C,previousID:x||((u=L.parentElement)==null?void 0:u.getAttribute("data-node-id"))}),x=C;const T=S;S=S.nextElementSibling,L.lastElementChild.before(T)}L.getAttribute("data-subtype")==="o"&&(Array.from(L.children).forEach(C=>{const T=C.getAttribute("data-node-id");T&&w.push({action:"update",id:T,data:C.outerHTML})}),je(L,1),Array.from(L.children).forEach(C=>{const T=C.getAttribute("data-node-id");T&&_.push({action:"update",id:T,data:C.outerHTML})})),k&&w.push({action:"delete",id:k})}if(!window.siyuan.config.editor.listLogicalOutdent&&g.nextElementSibling){S=g.nextElementSibling;let k;for(;S&&!S.classList.contains("protyle-attr");){const x=S.getAttribute("data-node-id");_.push({action:"move",id:x,previousID:k||L.getAttribute("data-node-id")}),w.push({action:"move",id:x,previousID:k||g.getAttribute("data-node-id")}),k=x;const C=S;S=S.nextElementSibling,L.after(C),L=C}}g.childElementCount===1&&b.childElementCount===3?(_.push({action:"delete",id:b.getAttribute("data-node-id")}),w.splice(0,0,{action:"insert",id:b.getAttribute("data-node-id"),data:b.outerHTML,previousID:(p=b.previousElementSibling)==null?void 0:p.getAttribute("data-node-id"),parentID:b.parentElement.getAttribute("data-node-id")}),b.remove()):g.childElementCount===1?(_.push({action:"delete",id:g.getAttribute("data-node-id")}),w.splice(0,0,{action:"insert",id:g.getAttribute("data-node-id"),data:g.outerHTML,previousID:g.previousElementSibling.getAttribute("data-node-id")}),g.remove()):g.getAttribute("data-subtype")==="o"&&(w.splice(0,0,{action:"update",data:g.outerHTML,id:g.getAttribute("data-node-id")}),je(g,h),_.push({action:"update",data:g.outerHTML,id:g.getAttribute("data-node-id")})),y.classList.contains("protyle-wysiwyg")?q(e,_,w):(b&&b.getAttribute("data-subtype")==="o"&&je(y),K(e,y.getAttribute("data-node-id"),y.outerHTML,E)),ue(y,n)},sa=(e,t)=>{const n=[],a=[];let s=t.previousElementSibling?t.previousElementSibling.getAttribute("data-node-id"):void 0;t.classList.remove("protyle-wysiwyg--select"),t.removeAttribute("select-start"),t.removeAttribute("select-end");const i=t.getAttribute("data-node-id"),l=t.cloneNode();return l.innerHTML=t.lastElementChild.outerHTML,a.push({action:"insert",id:i,data:l.outerHTML,previousID:t.previousElementSibling?t.previousElementSibling.getAttribute("data-node-id"):void 0,parentID:t.parentElement.getAttribute("data-node-id")||e.block.parentID}),Array.from(t.children).forEach((o,r)=>{if(r===t.childElementCount-1){n.push({action:"delete",id:i}),t.lastElementChild.remove(),t.querySelectorAll("protyle-html").forEach(c=>{c.setAttribute("data-content",c.getAttribute("data-content").replace(/&lt;/g,"<").replace(/&gt;/g,">"))}),t.outerHTML=t.innerHTML;return}n.push({action:"move",id:o.getAttribute("data-node-id"),previousID:s,parentID:t.parentElement.getAttribute("data-node-id")||e.block.parentID}),a.push({action:"move",id:o.getAttribute("data-node-id"),previousID:o.previousElementSibling?o.previousElementSibling.getAttribute("data-node-id"):void 0,parentID:i}),s=o.getAttribute("data-node-id")}),n.forEach(o=>{const r=e.wysiwyg.element.querySelector(`[data-node-id="${o.id}"]`);r&&r.getAttribute("data-type")==="NodeBlockQueryEmbed"&&(r.removeAttribute("data-render"),Se(e,r))}),{doOperations:n,undoOperations:a,previousId:s}},tc=(e,t,n)=>{const a=document.createElement("div");return a.setAttribute("data-node-id",t||Lute.NewNodeID()),a.setAttribute("data-type","NodeSuperBlock"),a.setAttribute("class","sb"),a.setAttribute("data-sb-layout",e),a.innerHTML=n||`<div class="protyle-attr" contenteditable="false">${f.ZWSP}</div>`,a},ja=(e,t,n)=>{A("/api/block/getBlockSiblingID",{id:t.getAttribute("data-node-id")},a=>{const s=a.data[n];s&&at(e.app,s,s!==e.block.rootID&&e.block.showAll?[f.CB_GET_ALL,f.CB_GET_FOCUS]:[f.CB_GET_FOCUS])})},Rt=(e,t,n)=>{const a=ye(e.wysiwyg.element);let s;if(n)s=e.wysiwyg.element.querySelector(`[data-node-id="${n}"]`);else{const c=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");c.length>0?(t==="beforebegin"?s=c[0]:s=c[c.length-1],J(["select"],e)):(s=B(a.startContainer),s=Ne(s))}if(!s)return;let i=Xn(!1,!0),l=1;s.getAttribute("data-type")==="NodeListItem"&&(i=ia(s,0,!0),l=parseInt(s.parentElement.firstElementChild.getAttribute("data-marker")));const o=s.parentElement.outerHTML,r=i.getAttribute("data-node-id");if(s.insertAdjacentElement(t,i),s.getAttribute("data-type")==="NodeListItem"&&s.getAttribute("data-subtype")==="o"&&!i.parentElement.classList.contains("protyle-wysiwyg"))je(i.parentElement,l),K(e,i.parentElement.getAttribute("data-node-id"),i.parentElement.outerHTML,o);else{let c;t==="beforebegin"?c=[{action:"insert",data:i.outerHTML,id:r,nextID:s.getAttribute("data-node-id")}]:c=[{action:"insert",data:i.outerHTML,id:r,previousID:s.getAttribute("data-node-id")}],q(e,c,[{action:"delete",id:r}])}s.parentElement.classList.contains("sb")&&s.parentElement.getAttribute("data-sb-layout")==="col"&&Kt({protyle:e,selectsElement:t==="afterend"?[s,s.nextElementSibling]:[s.previousElementSibling,s],type:"BlocksMergeSuperBlock",level:"row"}),ue(e.wysiwyg.element,a),He(e)},ws=(e=!0,t=!0,n)=>{let a="";return e&&(a=f.ZWSP),t&&(a+="<wbr>"),n&&(a+=n),`<div data-node-id="${Lute.NewNodeID()}" data-type="NodeParagraph" class="p"><div contenteditable="true" spellcheck="${window.siyuan.config.editor.spellcheck}">${a}</div><div contenteditable="false" class="protyle-attr">${f.ZWSP}</div></div>`},Xn=(e=!0,t=!0,n)=>{const a=document.createElement("div");return a.setAttribute("data-node-id",n||Lute.NewNodeID()),a.setAttribute("data-type","NodeParagraph"),a.classList.add("p"),a.innerHTML=`<div contenteditable="true" spellcheck="${window.siyuan.config.editor.spellcheck}">${e?f.ZWSP:""}${t?"<wbr>":""}</div><div class="protyle-attr" contenteditable="false">${f.ZWSP}</div>`,a},Nf=e=>{let t=e;switch(e){case"NodeIFrame":t="IFrame";break;case"NodeAttributeView":t=window.siyuan.languages.database;break;case"NodeThematicBreak":t=window.siyuan.languages.line;break;case"NodeWidget":t=window.siyuan.languages.widget;break;case"NodeVideo":t=window.siyuan.languages.video;break;case"NodeAudio":t=window.siyuan.languages.audio;break;case"NodeBlockQueryEmbed":t=window.siyuan.languages.blockEmbed;break}return t},Pf=(e,t,n,a,s)=>{var i;if(t!=="NodeCodeBlock"&&!((i=n.previousElementSibling)!=null&&i.classList.contains("protyle-action--task"))&&(["[ ]","[x]","[X]","\u3010 \u3011","\u3010x\u3011","\u3010X\u3011"].includes(a.innerHTML.substring(0,3))||["[]","\u3010\u3011"].includes(a.innerHTML.substring(0,2)))){const l=a.innerHTML.indexOf("]")+1||a.innerHTML.indexOf("\u3011")+1,o=a.innerHTML.substring(1,2).toLowerCase()==="x";if(n.parentElement.classList.contains("li")&&n.parentElement.childElementCount===3){if(!n.parentElement.parentElement.classList.contains("protyle-wysiwyg")&&n.parentElement.parentElement.childElementCount===2){const r=n.parentElement.parentElement,c=r.outerHTML;return r.setAttribute("data-subtype","t"),r.setAttribute("updated",U().format("YYYYMMDDHHmmss")),n.parentElement.setAttribute("data-subtype","t"),o&&n.parentElement.classList.add("protyle-task--done"),n.previousElementSibling.outerHTML=`<div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#icon${o?"C":"Unc"}heck"></use></svg></div>`,a.innerHTML=a.innerHTML.substring(l),K(e,r.getAttribute("data-node-id"),r.outerHTML,c),ue(e.wysiwyg.element,s),!0}return!1}else{const r=n.getAttribute("data-node-id"),c=Lute.NewNodeID(),d=Lute.NewNodeID(),u=Lute.NewNodeID(),p=n.outerHTML;return a.innerHTML=a.innerHTML.substring(l),q(e,[{action:"update",id:r,data:n.outerHTML},{action:"insert",id:c,data:`<div data-subtype="t" data-node-id="${c}" updated="${c.split("-")[0]}" data-type="NodeList" class="list"><div data-marker="*" data-subtype="t" data-node-id="${u}" data-type="NodeListItem" class="li${o?" protyle-task--done":""}" updated="${u.split("-")[0]}"><div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#icon${o?"C":"Unc"}heck"></use></svg></div><div data-node-id="${d}" data-type="NodeParagraph" class="p"><div contenteditable="true" spellcheck="${window.siyuan.config.editor.spellcheck}"></div><div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div>`,previousID:r},{action:"move",id:r,previousID:d},{action:"delete",id:d}],[{action:"move",id:r,previousID:c},{action:"delete",id:c},{action:"update",id:r,data:p}]),n.outerHTML=`<div data-subtype="t" data-node-id="${c}" data-type="NodeList" class="list" updated="${c.split("-")[0]}"><div data-marker="*" data-subtype="t" data-node-id="${u}" data-type="NodeListItem" class="li${o?" protyle-task--done":""}" updated="${u.split("-")[0]}"><div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#icon${o?"C":"Unc"}heck"></use></svg></div>${n.outerHTML}<div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div>`,ue(e.wysiwyg.element,s),!0}}return!1},qf=(e,t,n,a,s)=>{if(t==="NodeHeading"&&["* ","- "].includes(a.innerHTML.substring(0,2))&&n.parentElement.getAttribute("data-type")!=="NodeListItem"){const i=n.getAttribute("data-node-id"),l=Lute.NewNodeID(),o=Lute.NewNodeID(),r=Lute.NewNodeID(),c=n.outerHTML,d=a.innerHTML.substring(0,1);return a.innerHTML=a.innerHTML.substring(2),q(e,[{action:"update",id:i,data:n.outerHTML},{action:"insert",id:l,data:`<div data-subtype="u" data-node-id="${l}" data-type="NodeList" class="list" updated="${l.split("-")[0]}"><div data-marker="${d}" data-subtype="u" data-node-id="${r}" data-type="NodeListItem" class="li" updated="${r.split("-")[0]}"><div class="protyle-action" draggable="true"><svg><use xlink:href="#iconDot"></use></svg></div><div data-node-id="${o}" data-type="NodeParagraph" class="p"><div contenteditable="true" spellcheck="${window.siyuan.config.editor.spellcheck}"></div><div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div>`,previousID:i},{action:"move",id:i,previousID:o},{action:"delete",id:o}],[{action:"update",id:i,data:c},{action:"move",id:i,previousID:l},{action:"delete",id:l}]),n.outerHTML=`<div data-subtype="u" data-node-id="${l}" data-type="NodeList" class="list" updated="${l.split("-")[0]}"><div data-marker="${d}" data-subtype="u" data-node-id="${r}" data-type="NodeListItem" class="li" updated="${r.split("-")[0]}"><div class="protyle-action" draggable="true"><svg><use xlink:href="#iconDot"></use></svg></div>${n.outerHTML}<div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div>`,ue(e.wysiwyg.element,s),!0}return!1};var Of=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{o(n.next(r))}catch(c){s(c)}},l=r=>{try{o(n.throw(r))}catch(c){s(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,l);o((n=n.apply(e,t)).next())});const hs=(e,t,n,a=!0,s)=>Of(void 0,null,function*(){var i,l,o,r,c;if(!t.parentElement)return;if(t.classList.contains("av")){$(n.startContainer,"av__cursor")?n.startContainer.textContent=f.ZWSP:fl(e,t);return}const d=oe(t),u=t.getAttribute("data-type");if(!d){u==="NodeThematicBreak"?t.innerHTML="<div><wbr></div>":u==="NodeBlockQueryEmbed"?t.lastElementChild.previousElementSibling.innerHTML="<wbr>"+f.ZWSP:u==="NodeMathBlock"||u==="NodeHTMLBlock"?t.lastElementChild.previousElementSibling.lastElementChild.innerHTML="<wbr>"+f.ZWSP:u==="NodeIFrame"||u==="NodeWidget"?t.innerHTML="<wbr>"+t.firstElementChild.outerHTML+t.lastElementChild.outerHTML:u==="NodeVideo"?t.firstElementChild.innerHTML="<wbr>"+f.ZWSP+t.firstElementChild.firstElementChild.outerHTML+t.firstElementChild.lastElementChild.outerHTML:u==="NodeAudio"?t.firstElementChild.innerHTML=t.firstElementChild.firstElementChild.outerHTML+"<wbr>"+f.ZWSP:u==="NodeCodeBlock"&&(n.startContainer.textContent=f.ZWSP),ue(t,n);return}t.setAttribute("updated",U().format("YYYYMMDDHHmmss"));const p=document.createElement("wbr");if(n.insertNode(p),s){const h=Fe(p);if(s.inputType==="deleteContentForward"&&h&&h.nodeType===1&&!h.textContent.startsWith(f.ZWSP)){const E=(h.getAttribute("data-type")||"").split(" ");(E.includes("code")||E.includes("kbd")||E.includes("tag"))&&h.insertAdjacentElement("afterbegin",p)}if((s.inputType==="deleteContentBackward"||s.inputType==="deleteContentForward")&&h&&h.nodeType===1&&h.tagName==="BR"){const E=Fe(h);E&&E.nodeType===1&&((i=E.getAttribute("data-type"))==null?void 0:i.indexOf("inline-math"))>-1&&h.remove()}}const g=t.getAttribute("data-node-id");if(u!=="NodeCodeBlock"&&u!=="NodeHeading"&&(d.innerHTML.endsWith(`
<wbr>`)||d.innerHTML.endsWith(`
<wbr>
`))){K(e,g,t.outerHTML,e.wysiwyg.lastHTMLs[g]||t.outerHTML.replace(`
<wbr>`,"<wbr>")),p.remove();return}if(Pf(e,u,t,d,n)||qf(e,u,t,d,n))return;const m=t.querySelector("br");m&&m.parentElement.tagName!=="TD"&&m.parentElement.tagName!=="TH"&&(m.parentElement.textContent.trim()===""||((o=(l=m.previousSibling)==null?void 0:l.previousSibling)==null?void 0:o.textContent)===`
`)&&m.remove(),u!=="NodeHeading"&&(d.innerHTML.startsWith("\u300B<wbr>")||d.innerHTML.indexOf(`
\u300B<wbr>`)>-1)&&(d.innerHTML=d.innerHTML.replace("\u300B<wbr>","><wbr>"));const b=d.innerHTML.trimStart();if(!((b.startsWith("````")||b.startsWith("\xB7\xB7\xB7\xB7")||b.startsWith("~~~~"))&&b.indexOf(`
`)===-1)){if((b.startsWith("```")||b.startsWith("\xB7\xB7\xB7")||b.startsWith("~~~"))&&b.indexOf(`
`)===-1&&b.replace(/·|~/g,"`").replace(/^`{3,}/g,"").indexOf("`")===-1){K(e,g,t.outerHTML,e.wysiwyg.lastHTMLs[g]),p.remove();return}}u==="NodeParagraph"&&(d.innerHTML.startsWith("\xA5\xA5<wbr>")||d.innerHTML.startsWith("\uFFE5\uFFE5<wbr>")||b.indexOf(`
\xA5\xA5<wbr>`)>-1||b.indexOf(`
\uFFE5\uFFE5<wbr>`)>-1)&&(d.innerHTML=d.innerHTML.replace("\xA5\xA5<wbr>","$$$$<wbr>").replace("\uFFE5\uFFE5<wbr>","$$$$<wbr>"));const y=D(n.startContainer,"data-type","block-ref");y&&y.getAttribute("data-subtype")==="d"&&(yield Ye("/api/block/getRefText",{id:y.getAttribute("data-id")})).data!==y.innerHTML.replace("<wbr>","")&&y.setAttribute("data-subtype","s");let _=t.outerHTML,w=!1;if(["---","___","***"].includes(d.textContent)&&u!=="NodeCodeBlock"){_=`<div data-node-id="${g}" data-type="NodeThematicBreak" class="hr"><div></div></div>`;const h=t.nextElementSibling;h&&h.getAttribute("data-node-id")?At(h)?w=!0:ne(h):_+=ws(!1,!0)}else{if(u!=="NodeCodeBlock"&&(b.startsWith("```")||b.startsWith("~~~")||b.startsWith("\xB7\xB7\xB7")||b.indexOf("\n```")>-1||b.indexOf(`
~~~`)>-1||b.indexOf(`
\xB7\xB7\xB7`)>-1)&&!(b.indexOf(`
`)===-1&&b.replace(/·|~/g,"`").replace(/^`{3,}/g,"").indexOf("`")>-1)){let h=d.innerHTML.trim().replace(/^(~|·|`){3,}/g,"```").replace(/\n(~|·|`){3,}/g,"\n```").trim();h.endsWith("\n```")||(h=h.replace("<wbr>","")+"<wbr>\n```"),d.innerHTML=h,_=t.outerHTML}_=e.lute.SpinBlockDOM(_)}J(["util"],e,!0),u==="NodeTable"&&t.querySelector(".table__select").removeAttribute("style");const v=document.createElement("template");if(v.innerHTML=_,a&&(((r=oe(v.content.firstElementChild))==null?void 0:r.innerHTML)!==oe(t).innerHTML||v.content.childElementCount===1&&((c=oe(v.content.firstElementChild))==null?void 0:c.innerHTML)==="<wbr>")&&!(v.content.childElementCount===1&&v.content.firstElementChild.classList.contains("code-block")&&u==="NodeCodeBlock")){t.getAttribute("data-type")==="NodeHeading"&&t.getAttribute("fold")==="1"&&v.content.firstElementChild.getAttribute("data-subtype")!==t.dataset.subtype&&(ht(e,t,void 0,void 0,!1),_=_.replace(' fold="1"',""),e.wysiwyg.lastHTMLs[g]=t.outerHTML);let h;t.classList.contains("table")&&(h=t.firstElementChild.scrollLeft),/<span data-type="backslash">.+<\/span><wbr>/.test(_)?t.outerHTML=_:t.outerHTML=_.replace("</span><wbr>","</span>"+f.ZWSP+"<wbr>"),e.wysiwyg.element.querySelectorAll(`[data-node-id="${g}"]`).forEach(E=>{re(E)||(t=E)}),_.split('<span data-type="inline-math" data-subtype="math"').length>1&&Array.from(t.querySelectorAll('[data-type="inline-math"]')).find(E=>{if(E.dataset.content.indexOf("<wbr>")>-1)return E.setAttribute("data-content",E.dataset.content.replace("<wbr>","")),e.toolbar.showRender(e,E),!0}),Array.from(v.content.children).forEach((E,S)=>{const L=E.getAttribute("data-node-id");let k;L===g?k=t:k=e.wysiwyg.element.querySelector(`[data-node-id="${L}"]`);const x=k.getAttribute("data-type");if(x==="NodeCodeBlock"){const C=k.querySelector(".protyle-action__language");C?(window.siyuan.storage[f.LOCAL_CODELANG]&&C.textContent===""&&(C.textContent=window.siyuan.storage[f.LOCAL_CODELANG]),Pe(k)):v.content.childElementCount===1&&e.toolbar.showRender(e,k)}else if(["NodeMathBlock","NodeHTMLBlock"].includes(x))x==="NodeMathBlock"&&_n(k),e.toolbar.showRender(e,k);else if(x==="NodeBlockQueryEmbed")Se(e,k),e.toolbar.showRender(e,k),J(["hint"],e);else if(x==="NodeThematicBreak"&&w)ne(t);else if(k.querySelectorAll('[data-type="block-ref"][data-subtype="d"]').forEach(C=>{C.textContent===""&&A("/api/block/getRefText",{id:C.getAttribute("data-id")},T=>{C.innerHTML=T.data})}),_n(k),S===v.content.childElementCount-1){const C=t.querySelector("wbr");if(C&&C.parentElement.tagName==="SPAN"&&C.parentElement.innerHTML==="<wbr>"){const T=C.parentElement.getAttribute("data-type")||"";(T.includes("sup")||T.includes("u")||T.includes("sub"))&&C.insertAdjacentText("beforebegin",f.ZWSP)}ue(e.wysiwyg.element,n),e.hint.render(e),h>0&&(t.firstElementChild.scrollLeft=h)}})}else t.getAttribute("data-type")==="NodeCodeBlock"?(d.parentElement.removeAttribute("data-render"),Pe(t)):(ue(e.wysiwyg.element,n),e.hint.render(e));J(["gutter"],e),Rf(_,e,g)}),Rf=(e,t,n)=>{const a=document.createElement("template");a.innerHTML=e;const s=[],i=[];Array.from(a.content.children).forEach((l,o)=>{var r;l.getAttribute("spellcheck")==="false"&&l.getAttribute("contenteditable")==="false"&&l.setAttribute("contenteditable","true");const c=l.getAttribute("data-node-id");if(c===n)s.push({id:n,data:l.outerHTML,action:"update"}),i.push({id:n,data:t.wysiwyg.lastHTMLs[n],action:"update"}),t.wysiwyg.lastHTMLs[n]=l.outerHTML;else{let d;o===0&&(d=t.wysiwyg.element.querySelector(`[data-node-id="${c}"]`)),s.push({action:"insert",data:l.outerHTML,id:c,previousID:o===0?(r=d==null?void 0:d.previousElementSibling)==null?void 0:r.getAttribute("data-node-id"):l.previousElementSibling.getAttribute("data-node-id"),parentID:(d==null?void 0:d.parentElement.getAttribute("data-node-id"))||t.block.parentID}),i.push({id:c,action:"delete"})}}),q(t,s,i)},Bf=(e,t,n,a)=>{const s=document.createElement("template");s.innerHTML=t;let i=[];if(t.endsWith("]")&&t.startsWith("["))try{i=JSON.parse(t)}catch(o){console.warn("insert cell: JSON.parse error")}else s.content.querySelector("table")&&s.content.querySelectorAll("tr").forEach(o=>{i.push([]),Array.from(o.children).forEach(r=>{i[i.length-1].push({text:{content:r.textContent},type:"text"})})});const l=a.dataset.avId;A("/api/av/getAttributeViewKeysByAvID",{avID:l},o=>{var r,c;const d=o.data;if(i&&Array.isArray(i)&&i.length>0){const y=Array.from(a.querySelectorAll(".av__cell--active, .av__cell--select"))||[];y.length===0&&a.querySelectorAll(".av__row--select:not(.av__row--header)").forEach(L=>{L.querySelectorAll(".av__cell").forEach(k=>{y.push(k)})}),y.length===0&&y.push(a.querySelector(".av__row:not(.av__row--header) .av__cell"));const _=[],w=[],v=a.dataset.avId,h=a.dataset.nodeId;let E;const S=y[0].getAttribute("data-col-id");i.find(L=>{if(E?E=E.nextElementSibling:E=y[0].parentElement,!E.classList.contains("av__row"))return!0;let k;L.find(x=>{var C;if(k?k=k.nextElementSibling:k=E.querySelector(`.av__cell[data-col-id="${S}"]`),!k.classList.contains("av__cell"))return!0;const T=Bt(k)||k.dataset.type;if(["created","updated","template","rollup"].includes(T)||T==="block"&&!k.dataset.detached)return;const I=E.getAttribute("data-id"),P=k.getAttribute("data-id"),N=k.getAttribute("data-col-id"),R=gn(T,k);if(x.type!==T&&!(["select","mSelect"].includes(T)&&["select","mSelect"].includes(x.type))){if(T==="date"||!((C=x[x.type])==null?void 0:C.content))return;x=Bn(T,x[x.type].content.toString())}if(x.type==="block")x.isDetached=!0,delete x.block.id;else if(T==="select"||T==="mSelect"){T==="select"&&x.type==="mSelect"&&x.mSelect.length>0&&x.mSelect.splice(1,x.mSelect.length-1);const V=dc(d.find(W=>W.id===k.dataset.colId),x,v);_.push(...V.doOperations),w.push(...V.undoOperations)}x.id=P,!(x.type==="date"&&typeof x.date=="string"||x.type==="relation"&&typeof x.relation=="string")&&(kt(x,R)||(_.push({action:"updateAttrViewCell",id:P,avID:v,keyID:N,rowID:I,data:x}),w.push({action:"updateAttrViewCell",id:P,avID:v,keyID:N,rowID:I,data:R}),Tt(k,x)))})}),_.length>0&&(_.push({action:"doUpdateUpdated",id:h,data:U().format("YYYYMMDDHHmmss")}),w.push({action:"doUpdateUpdated",id:h,data:a.getAttribute("updated")}),q(n,_,w));return}const u=oe(s.content.firstElementChild);if(u&&u.childNodes.length===1&&((r=u.firstElementChild)==null?void 0:r.getAttribute("data-type"))==="block-ref"){const y=a.querySelector(".av__cell--select");if(y){const _=u.firstElementChild.getAttribute("data-id"),w=y.dataset.blockId;q(n,[{action:"replaceAttrViewBlock",avID:l,previousID:w,nextID:_,isDetached:!1}],[{action:"replaceAttrViewBlock",avID:l,previousID:_,nextID:w,isDetached:y.dataset.detached==="true"}]),Tt(y,{type:"block",isDetached:!1,block:{content:u.firstElementChild.textContent,id:_}});return}}const p=n.lute.BlockDOM2Content(t),g=Array.from(a.querySelectorAll(".av__cell--active, .av__cell--select")),m=a.querySelectorAll(".av__row--select"),b=[];if(p.split(`
`).forEach(y=>{b.push(y.split("	"))}),m.length>0&&b.length===1&&b[0].length===1){zt(n,a,p,void 0,d,t);return}if(m.length>0&&m.forEach(y=>{y.querySelectorAll(".av__cell").forEach(_=>{g.push(_)})}),g.length>0){if(b.length===1&&b[0].length===1)zt(n,a,p,g,d,t);else{let y;const _=g[0].getAttribute("data-col-id");b.forEach(w=>{if(y?y=y.nextElementSibling:y=g[0].parentElement,!y.classList.contains("av__row"))return!0;let v;w.forEach(h=>{if(v?v=v.nextElementSibling:v=y.querySelector(`.av__cell[data-col-id="${_}"]`),!v.classList.contains("av__cell"))return!0;zt(n,a,h,[v],d,t)})})}(c=document.querySelector(".av__panel"))==null||c.remove()}else if($(e.startContainer,"av__title")){const y=document.createTextNode(p);e.insertNode(y),e.setEnd(y,p.length),e.collapse(!1),X(e),fl(n,a)}})},Uf=(e,t,n,a)=>{const s=document.createElement("template");s.innerHTML=t;const i=s.content.querySelectorAll("th, td");if(i.length===0)return!1;const l=a.firstElementChild.scrollLeft,o=a.querySelector(".table__select");let r=0;const c=[];a.querySelectorAll("th, td").forEach(u=>{!u.classList.contains("fn__none")&&u.offsetLeft+6>o.offsetLeft+l&&u.offsetLeft+u.clientWidth-6<o.offsetLeft+l+o.clientWidth&&u.offsetTop+6>o.offsetTop&&u.offsetTop+u.clientHeight-6<o.offsetTop+o.clientHeight&&i.length>r&&(c.push(u),r++)}),o.removeAttribute("style");const d=a.outerHTML;return a.setAttribute("updated",U().format("YYYYMMDDHHmmss")),c.forEach((u,p)=>{u.innerHTML=i[p].innerHTML,p===c.length-1&&nt(u,e,!1)}),e.collapse(!1),K(n,a.getAttribute("data-node-id"),a.outerHTML,d),!0},Xe=(e,t,n=!1,a=!1,s=!1)=>{var i,l,o,r;if(e==="")return;const c=a?t.toolbar.range:ye(t.wysiwyg.element);Xs(c);let d;D(c.startContainer,"data-type","NodeTable")&&!n&&(O(c.startContainer,"TABLE")?d=t.lute.BlockDOM2InlineBlockDOM(e):n=!0);let u=B(c.startContainer);if(u||(t.toolbar.range?u=B(t.toolbar.range.startContainer):u=t.wysiwyg.element.firstElementChild),!u)return;if(u.classList.contains("av")){c.deleteContents(),Bf(c,e,t,u);return}if(u.classList.contains("table")&&u.querySelector(".table__select").clientWidth>0&&Uf(c,e,t,u))return;let p=u.getAttribute("data-node-id");c.insertNode(document.createElement("wbr"));let g=u.outerHTML;const m=u.getAttribute("data-type")==="NodeCodeBlock",b=oe(u);if(!n&&(m||t.toolbar.getCurrentType(c).includes("code"))){c.deleteContents(),m&&b.textContent===""&&(e+=`
`),c.insertNode(document.createTextNode(e.replace(/\r\n|\r|\u2028|\u2029/g,`
`))),c.collapse(!1),c.insertNode(document.createElement("wbr")),m?((i=u.querySelector('[data-render="true"]'))==null||i.removeAttribute("data-render"),Pe(u)):ue(u,c),u.setAttribute("updated",U().format("YYYYMMDDHHmmss")),K(t,p,u.outerHTML,g),setTimeout(()=>{He(t,u,!1,"smooth")},f.TIMEOUT_LOAD);return}const y=[],_=[];if(c.toString()!==""){const x=D(c.commonAncestorContainer,"data-type","inline-math");x?x.remove():c.startContainer.nodeType===3&&((l=c.startContainer.parentElement.getAttribute("data-type"))==null?void 0:l.indexOf("block-ref"))>-1?(c.deleteContents(),c.startContainer.nodeType!==3&&c.startContainer.textContent===""&&c.startContainer.remove()):c.deleteContents(),c.insertNode(document.createElement("wbr")),y.push({action:"update",id:p,data:g}),_.push({action:"update",id:p,data:u.outerHTML})}const w=document.createElement("template");e.startsWith("&gt;")&&b.textContent.replace(f.ZWSP,"")!==""&&(d=e);let v=d||t.lute.SpinBlockDOM(e)||e;v=v.replace(/;;;lt;;;/g,"&lt;").replace(/;;;gt;;;/g,"&gt;"),w.innerHTML=v;let h=!1;if((b.textContent.replace(f.ZWSP,"")!==""||u.getAttribute("data-type")==="NodeHeading")&&w.content.childElementCount===1&&w.content.firstChild.nodeType!==3&&w.content.firstElementChild.getAttribute("data-type")==="NodeHeading"&&(n=!1,h=!0),!n&&(w.content.firstChild.nodeType===3||h||w.content.firstChild.nodeType!==3&&(w.content.firstElementChild.classList.contains("p")&&w.content.childElementCount===1||w.content.firstElementChild.tagName!=="DIV"))){w.content.firstChild.nodeType!==3&&w.content.firstElementChild.classList.contains("p")&&(w.innerHTML=w.content.firstElementChild.firstElementChild.innerHTML.trim());const x=c.startContainer.nodeType===3?c.startContainer.parentElement:c.startContainer;if(x.tagName==="SPAN"&&x.isSameNode(c.endContainer.nodeType===3?c.endContainer.parentElement:c.endContainer)&&w.content.querySelector("span, img")){const C=document.createElement("span"),T=x.attributes;for(let I=0;I<T.length;I++)C.setAttribute(T[I].name,T[I].value);c.setEnd(x.lastChild,x.lastChild.textContent.length),C.append(c.extractContents()),x.after(C),c.setStartBefore(C),c.collapse(!0)}c.insertNode(w.content.cloneNode(!0)),c.collapse(!1),(o=u.querySelector("wbr"))==null||o.remove(),t.wysiwyg.lastHTMLs[p]=g,hs(t,u,c);return}const E=$(u,"li");if(((r=w.content.children[0])==null?void 0:r.getAttribute("data-type"))==="NodeListItem")if(E)u=E,p=u.getAttribute("data-node-id"),g=u.outerHTML;else{const C=w.content.children[0].getAttribute("data-subtype");w.innerHTML=`<div${C==="o"?' data-marker="1."':""} data-subtype="${C}" data-node-id="${Lute.NewNodeID()}" data-type="NodeList" class="list">${e}<div class="protyle-attr" contenteditable="false">${f.ZWSP}</div></div>`}let S,L=!1;!c.toString()&&s&&Je(u,t.wysiwyg.element,c).start===0&&b.textContent!==""&&(L=!0),(L?Array.from(w.content.children):Array.from(w.content.children).reverse()).forEach(x=>{x.getAttribute("data-type")==="NodeHeading"&&x.getAttribute("fold")==="1"&&x.removeAttribute("fold");let C=x.getAttribute("data-node-id");if(C===p)_.push({action:"update",data:x.outerHTML,id:C}),y.push({action:"update",id:C,data:g});else{if(x.classList.contains("li")&&!u.parentElement.classList.contains("list")){C=Lute.NewNodeID();const T=document.createElement("div");T.setAttribute("data-subtype",x.getAttribute("data-subtype")),T.setAttribute("data-node-id",C),T.setAttribute("data-type","NodeList"),T.setAttribute("updated",U().format("YYYYMMDDHHmmss")),T.classList.add("list"),T.append(x),x=T}_.push({action:"insert",data:x.outerHTML,id:C,nextID:L?p:void 0,previousID:L?void 0:p}),y.push({action:"delete",id:C})}L?u.before(x):u.after(x),S||(S=x)}),b&&b.textContent===""&&u.classList.contains("p")&&(_.find((x,C)=>{if(x.id===p)return _.splice(C,1),!0}),_.push({action:"delete",id:p}),y.find((x,C)=>{if(x.id===p&&x.action==="update")return y.splice(C,1),!0}),y.push({action:"insert",data:g,id:p,previousID:u.previousElementSibling?u.previousElementSibling.getAttribute("data-node-id"):"",parentID:u.parentElement.getAttribute("data-node-id")||t.block.parentID}),u.remove()),S&&ne(S,void 0,!1);const k=t.wysiwyg.element.querySelector("wbr");k&&k.remove(),q(t,_,y)},Pl=(e,t,n,a)=>{!On()||(!t||t.length===0)&&!n||setTimeout(()=>{e.highlight.markHL.clear(),e.highlight.mark.clear(),e.highlight.ranges=[];let s=!1,i;typeof n=="string"&&Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id='${n}']`)).find(g=>{if(!re(g))return i=g,!0});const l=[],o=[];let r=0;const c=document.createTreeWalker(e.wysiwyg.element,NodeFilter.SHOW_TEXT);let d=c.nextNode();for(;d;)l.push(d),r+=d.textContent.length,o.push(r),d=c.nextNode();const u=e.wysiwyg.element.textContent,p=[];if(t&&t.length>0&&t.forEach(g=>{if(!g)return;let m=0,b=0,y=0;for(;(m=u.indexOf(g,m))!==-1;){const _=new Range;b=m+g.length;try{for(;y<l.length&&o[y]<=m;)y++;let w=l[y];for(_.setStart(w,m-(y?o[y-1]:0));y<l.length&&o[y]<b;)y++;w=l[y],_.setEnd(w,b-(y?o[y-1]:0));let v=!1;!s&&i&&i.contains(w)&&(s=!0,v=!0),p.push({range:_,startIndex:m,isCurrent:v})}catch(w){console.error("searchMarkRender error:",w)}m=b}}),!s&&i){const g=u.indexOf(i.textContent);if(g>-1){const m=new Range;let b=0;for(;l.length&&o[b]<=g;)b++;m.setStart(l[b],0),p.push({range:m,startIndex:g,isCurrent:!0})}}p.sort((g,m)=>m.startIndex>g.startIndex?-1:0).forEach((g,m)=>{typeof n=="string"&&g.isCurrent||typeof n=="number"&&n===m?(e.highlight.rangeIndex=m,e.highlight.markHL.add(g.range)):e.highlight.mark.add(g.range),e.highlight.ranges.push(g.range)}),CSS.highlights.set("search-mark-"+e.highlight.styleElement.dataset.uuid,e.highlight.mark),typeof n!="undefined"&&CSS.highlights.set("search-mark-hl-"+e.highlight.styleElement.dataset.uuid,e.highlight.markHL),a&&a()},e.wysiwyg.element.querySelector(".hljs")?f.TIMEOUT_TRANSITION:0)},On=()=>!!(CSS&&CSS.highlights),nc=e=>{var t,n;if(e){J(["util"],e),On()&&(e.highlight.markHL.clear(),e.highlight.mark.clear(),e.highlight.ranges=[],e.highlight.rangeIndex=0),(t=e.observer)==null||t.disconnect(),(n=e.observerLoad)==null||n.disconnect(),e.element.classList.remove("protyle"),e.element.removeAttribute("style"),e.wysiwyg&&(e.wysiwyg.lastHTMLs={}),e.undo&&e.undo.clear();try{e.ws.send("closews",{})}catch(a){setTimeout(()=>{e.ws.send("closews",{})},10240)}e.app.plugins.forEach(a=>{a.eventBus.emit("destroy-protyle",{protyle:e})})}};class Yf{constructor(){this.isUploading=!1,this.element=document.createElement("div"),this.element.className="protyle-upload"}}const Ff=(e,t)=>{const n=[];let a="",s="";for(let l=t.length,o=0;o<l;o++){const r=t[o];let c=!0;r.name||(a+=`<li>${window.siyuan.languages.nameEmpty}</li>`,c=!1),r.size>e.options.upload.max&&(a+=`<li>${r.name} ${window.siyuan.languages.over} ${e.options.upload.max/1024/1024}M</li>`,c=!1);const d=r.name.lastIndexOf("."),u=d===-1?"":r.name.substr(d),p=d===-1?r.name:e.options.upload.filename(r.name.substr(0,d))+u;e.options.upload.accept&&(e.options.upload.accept.split(",").some(m=>{const b=m.trim();if(b.indexOf(".")===0){if(u.toLowerCase()===b.toLowerCase())return!0}else if(r.type.split("/")[0]===b.split("/")[0])return!0;return!1})||(a+=`<li>${r.name} ${window.siyuan.languages.fileTypeError}</li>`,c=!1)),c&&(n.push(r),s+=`<li>${p} ${window.siyuan.languages.uploading}</li>`)}let i;return(a!==""||s!=="")&&(i=ae(`<ul>${a}${s}</ul>`,-1)),{files:n,msgId:i}},ac=(e,t)=>{var n,a;const s=JSON.parse(e);let i="";s.code===1&&(i=`${s.msg}`),s.data.errFiles&&s.data.errFiles.length>0&&(i=`<ul><li>${i}</li>`,s.data.errFiles.forEach(g=>{const m=g.lastIndexOf("."),b=m===-1?g:t.options.upload.filename(g.substr(0,m))+g.substr(m);i+=`<li>${b} ${window.siyuan.languages.uploadError}</li>`}),i+="</ul>"),i&&ae(i);let l=!0;const o=ye(t.wysiwyg.element);o.toString()===""&&o.startContainer.nodeType===3&&t.toolbar.getCurrentType(o).length>0&&(o.setEndAfter(o.startContainer.parentElement),o.collapse(!1));const r=B(o.startContainer);if(r)if(r.classList.contains("table"))l=!1;else{const g=oe(r);g&&g.textContent!==""&&r.classList.contains("p")&&(l=!1)}let c="";const d=Object.keys(s.data.succMap),u=[];let p=!1;if(d.forEach((g,m)=>{const b=s.data.succMap[g],y=me().extname(g).toLowerCase(),_=t.options.upload.filename(g),w=_.substring(0,_.length-y.length);p=f.SIYUAN_ASSETS_IMAGE.includes(y),u.push({type:f.SIYUAN_ASSETS_IMAGE.includes(y)?"image":"file",content:b,name:w}),c+=Wr(y,b,w,_),!f.SIYUAN_ASSETS_AUDIO.includes(y)&&!f.SIYUAN_ASSETS_VIDEO.includes(y)&&d.length-1!==m&&(r&&r.classList.contains("table")?c+="<br>":l?c+=`

`:c+=`
`)}),r&&r.classList.contains("av")){const g=[];if(r.querySelectorAll(".av__row--select:not(.av__row--header)").forEach(m=>{m.querySelectorAll(".av__cell").forEach(b=>{Bt(b)==="mAsset"&&g.push(b)})}),g.length===0&&t.wysiwyg.element.querySelectorAll(".av__cell--active").forEach(m=>{Bt(m)==="mAsset"&&g.push(m)}),g.length>0){zt(t,r,u,g),(n=document.querySelector(".av__panel"))==null||n.remove();return}else return}if(document.querySelector(".av__panel")){const g=[document.querySelector('.custom-attr__avvalue[data-type="mAsset"][data-active="true"]')];if(g[0]||(g.splice(0,1),t.wysiwyg.element.querySelectorAll(".av__cell--active").forEach(m=>{Bt(m)==="mAsset"&&g.push(m)})),g.length>0){const m=B(g[0]);if(m){zt(t,m,u,g),(a=document.querySelector(".av__panel"))==null||a.remove();return}}else return}Xe(c,t,l),setTimeout(()=>{He(t,void 0,!1,"smooth")},p?0:f.TIMEOUT_LOAD)},ic=(e,t,n)=>{const a=ae(window.siyuan.languages.uploading,0);A("/api/asset/insertLocalAssets",{assetPaths:e,isUpload:n,id:t.block.rootID},s=>{tt(a);let i="";Object.keys(s.data.succMap).forEach(l=>{s.data.succMap[l].startsWith("file:")&&(i+=l+", ")}),i&&ae(window.siyuan.languages.dndFolderTip.replace("${x}",`<b>${i.substring(0,i.length-2)}</b>`)),ac(JSON.stringify(s),t)})},Rn=(e,t,n,a)=>{if(!e){const d=new FormData;for(let p=0,g=t.length;p<g;p++)d.append("file[]",t[p]);const u=new XMLHttpRequest;u.open("POST",f.UPLOAD_ADDRESS),u.onreadystatechange=()=>{u.readyState===XMLHttpRequest.DONE&&(u.status===200?a(u.responseText):u.status===0?ae(window.siyuan.languages.fileTypeError):ae(u.responseText),n&&(n.value=""))},u.send(d);return}let s=[];for(let d=0;d<t.length;d++){let u=t[d];u instanceof DataTransferItem&&(u=u.getAsFile()),u.size===0&&u.type===""&&u.name.indexOf(".")===-1?ic([u.path],e,!1):s.push(u)}if(e.options.upload.handler){const d=e.options.upload.handler(s);if(typeof d=="string"){ae(d);return}return}if(!e.options.upload.url||!e.upload){n&&(n.value=""),ae("please config: options.upload.url");return}if(e.options.upload.file&&(s=e.options.upload.file(s)),e.options.upload.validate){const d=e.options.upload.validate(s);if(typeof d=="string"){ae(d);return}}const i=e.wysiwyg.element,l=Ff(e,s);if(l.files.length===0){n&&(n.value="");return}const o=new FormData,r=e.options.upload.extraData;for(const d of Object.keys(r))o.append(d,r[d]);for(let d=0,u=l.files.length;d<u;d++)o.append(e.options.upload.fieldName,l.files[d]);o.append("id",e.block.rootID);const c=new XMLHttpRequest;c.open("POST",e.options.upload.url),e.options.upload.token&&c.setRequestHeader("X-Upload-Token",e.options.upload.token),e.options.upload.withCredentials&&(c.withCredentials=!0),e.upload.isUploading=!0,c.onreadystatechange=()=>{if(c.readyState===XMLHttpRequest.DONE){if(e.upload.isUploading=!1,!document.body.contains(e.element)){nc(e);return}if(c.status===200)if(tt(l.msgId),e.options.upload.success)e.options.upload.success(i,c.responseText);else if(a)a(c.responseText);else{let d=c.responseText;e.options.upload.format&&(d=e.options.upload.format(t,c.responseText)),ac(d,e)}else c.status===0?ae(window.siyuan.languages.fileTypeError):e.options.upload.error?e.options.upload.error(c.responseText):ae(c.responseText);n&&(n.value=""),e.upload.element.style.display="none"}},c.upload.onprogress=d=>{if(!d.lengthComputable)return;const u=d.loaded/d.total*100;e.upload.element.style.display="block";const p=e.upload.element;p.style.width=u+"%"},c.send(o)},Ci=(e,t,n,a=!1)=>{let s=Lute.UnEscapeHTMLStr(t),i;if(Oo(s)&&!s.startsWith("file://")&&s.indexOf(".pdf")>-1){const l=s.split("/");l.length===3&&l[0]==="assets"&&l[1].endsWith(".pdf")&&/\d{14}-\w{7}/.test(l[2])?(s=`assets/${l[1]}`,i=l[2]):(i=parseInt(st("page",s)),s=s.split("?page")[0])}Et(s)},sc=e=>{e.menuElement.querySelector("input").addEventListener("change",t=>{t.target.files.length!==0&&Rn(e.protyle,t.target.files,t.target,n=>{const a=JSON.parse(n),s=[];Object.keys(a.data.succMap).forEach(i=>{s.push({name:i,content:a.data.succMap[i],type:f.SIYUAN_ASSETS_IMAGE.includes(me().extname(a.data.succMap[i]).toLowerCase())?"image":"file"})}),Ta({protyle:e.protyle,cellElements:e.cellElements,addValue:s,blockElement:e.blockElement})})})},lc=e=>{let t="";return gn("mAsset",e[0]).mAsset.forEach((n,a)=>{let s;n.type==="image"?s=`<span data-type="openAssetItem" class="fn__flex-1 ariaLabel" aria-label="${n.content}">
    <img style="max-height: 180px;max-width: 360px;border-radius: var(--b3-border-radius);margin: 4px 0;" src="${n.content}"/>
</span>`:s=`<span data-type="openAssetItem" class="fn__ellipsis b3-menu__label ariaLabel" aria-label="${We(n.content)}" style="max-width: 360px">${n.name||n.content}</span>`,t+=`<button class="b3-menu__item" draggable="true" data-index="${a}" data-name="${We(n.name)}" data-type="${n.type}" data-content="${We(n.content)}">
<svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>
${s}
<svg class="b3-menu__action" data-type="editAssetItem"><use xlink:href="#iconEdit"></use></svg>
</button>`}),`<div class="b3-menu__items">
    ${t}
    <button data-type="addAssetExist" class="b3-menu__item">
        <svg class="b3-menu__icon"><use xlink:href="#iconImage"></use></svg>
        <span class="b3-menu__label">${window.siyuan.languages.assets}</span>
    </button>
    <button class="b3-menu__item">
        <svg class="b3-menu__icon"><use xlink:href="#iconDownload"></use></svg>
        <span class="b3-menu__label">${window.siyuan.languages.insertAsset}</span> 
        <input multiple class="b3-form__upload" type="file">
    </button>
    <button data-type="addAssetLink" class="b3-menu__item">
        <svg class="b3-menu__icon"><use xlink:href="#iconLink"></use></svg>
        <span class="b3-menu__label">${window.siyuan.languages.link}</span>
    </button>
</div>`},Ta=e=>{const t=e.cellElements[0].dataset.colId,n=[],a=[];let s;e.cellElements.forEach((l,o)=>{var r,c;if(!e.blockElement.contains(l)){const m=$(l,"av__row");m&&(l=e.cellElements[o]=e.blockElement.querySelector(`.av__row[data-id="${m.dataset.id}"] .av__cell[data-col-id="${l.dataset.colId}"]`)||e.blockElement.querySelector(`.fn__flex-1[data-col-id="${l.dataset.colId}"]`))}const d=gn(Bt(l)||l.dataset.type,l),u=$(l,"av__row").dataset.id,p=JSON.parse(JSON.stringify(d));o===0?(typeof e.removeIndex=="number"?d.mAsset.splice(e.removeIndex,1):((r=e.addValue)==null?void 0:r.length)>0?d.mAsset=d.mAsset.concat(e.addValue):e.updateValue?d.mAsset.find((m,b)=>{if(b===e.updateValue.index)return m.content=e.updateValue.value.content,m.type=e.updateValue.value.type,m.name=e.updateValue.value.name,!0}):((c=e.replaceValue)==null?void 0:c.length)>0&&(d.mAsset=e.replaceValue),s=d.mAsset):d.mAsset=s;const g=e.blockElement.getAttribute("data-av-id");n.push({action:"updateAttrViewCell",id:d.id,keyID:t,rowID:u,avID:g,data:d}),a.push({action:"updateAttrViewCell",id:d.id,keyID:t,rowID:u,avID:g,data:p}),l.classList.contains("custom-attr__avvalue")?l.innerHTML=Jn(d):Tt(l,d)}),q(e.protyle,n,a);const i=document.querySelector(".av__panel > .b3-menu");if(i){i.innerHTML=lc(e.cellElements),sc({protyle:e.protyle,menuElement:i,cellElements:e.cellElements,blockElement:e.blockElement});const l=(e.cellElements[0].classList.contains("custom-attr__avvalue")?e.cellElements[0]:e.protyle.wysiwyg.element.querySelector(`.av__cell[data-id="${e.cellElements[0].dataset.id}"]`)).getBoundingClientRect();setTimeout(()=>{ke(i,l.left,l.bottom,l.height)},f.TIMEOUT_LOAD)}},_s=e=>{const t=e.content,n=e.type,a=new Ke("av-asset-edit",()=>{!l[1]&&l[0].value===t||l[1]&&l[0].value===t&&l[1].value===e.name||Ta({protyle:e.protyle,cellElements:e.cellElements,blockElement:e.blockElement,updateValue:{index:e.index,value:{content:l[0].value,name:l[1]?l[1].value:"",type:n}}})});if(a.isOpen)return;n==="file"?(a.addItem({id:"linkAndTitle",iconHTML:"",type:"readonly",label:`<div class="fn__flex">
    <span class="fn__flex-center">${window.siyuan.languages.link}</span>
    <span class="fn__space"></span>
    <span data-action="copy" class="block__icon block__icon--show b3-tooltips b3-tooltips__e fn__flex-center" aria-label="${window.siyuan.languages.copy}">
        <svg><use xlink:href="#iconCopy"></use></svg>
    </span>   
</div>
<textarea rows="1" style="margin:4px 0;width: ${H()?"200":"360"}px;resize: vertical;" class="b3-text-field"></textarea>
<div class="fn__hr"></div>
<div class="fn__flex">
    <span class="fn__flex-center">${window.siyuan.languages.title}</span>
    <span class="fn__space"></span>
    <span data-action="copy" class="block__icon block__icon--show b3-tooltips b3-tooltips__e fn__flex-center" aria-label="${window.siyuan.languages.copy}">
        <svg><use xlink:href="#iconCopy"></use></svg>
    </span>   
</div>
<textarea style="width: ${H()?"200":"360"}px;margin: 4px 0;resize: vertical;" rows="1" class="b3-text-field"></textarea>`,bind(o){o.addEventListener("click",r=>{let c=r.target;for(;c;){if(c.dataset.action==="copy"){Be(c.parentElement.nextElementSibling.value),ae(window.siyuan.languages.copied);break}c=c.parentElement}})}}),a.addSeparator({id:"separator_1"}),a.addItem({id:"copy",label:window.siyuan.languages.copy,icon:"iconCopy",click(){Be(`[${l[1].value||l[0].value}](${l[0].value})`)}})):(a.addItem({id:"link",iconHTML:"",type:"readonly",label:`<div class="fn__flex">
    <span class="fn__flex-center">${window.siyuan.languages.link}</span>
    <span class="fn__space"></span>
    <span data-action="copy" class="block__icon block__icon--show b3-tooltips b3-tooltips__e fn__flex-center" aria-label="${window.siyuan.languages.copy}">
        <svg><use xlink:href="#iconCopy"></use></svg>
    </span>   
</div>
<textarea rows="1" style="margin:4px 0;width: ${H()?"200":"360"}px;resize: vertical;" class="b3-text-field"></textarea>`,bind(o){o.addEventListener("click",r=>{let c=r.target;for(;c;){if(c.dataset.action==="copy"){Be(c.parentElement.nextElementSibling.value),ae(window.siyuan.languages.copied);break}c=c.parentElement}})}}),a.addSeparator({id:"separator_1"}),a.addItem({id:"copy",label:window.siyuan.languages.copy,icon:"iconCopy",click(){Be(`![](${t.replace(/%20/g," ")})`)}}),a.addItem({id:"copyAsPNG",label:window.siyuan.languages.copyAsPNG,icon:"iconImage",click(){Pr(t)}})),a.addItem({id:"delete",icon:"iconTrashcan",label:window.siyuan.languages.delete,click(){Ta({protyle:e.protyle,cellElements:e.cellElements,blockElement:e.blockElement,removeIndex:e.index})}}),t!=null&&t.startsWith("assets/")&&a.addItem({id:"rename",label:window.siyuan.languages.rename,icon:"iconEdit",click(){var o;ds(t),(o=document.querySelector(".av__panel"))==null||o.remove()}});const s=Ei(e.protyle?e.protyle.app:window.siyuan.ws.app,t,!0,!1);(n!=="file"||s.length>0)&&a.addSeparator({id:"separator_2"}),n!=="file"&&a.addItem({id:"cardPreview",icon:"iconPreview",label:window.siyuan.languages.cardPreview,click(){wi(t)}}),s.length>0&&window.siyuan.menus.menu.append(new M({id:"openBy",label:window.siyuan.languages.openBy,icon:"iconOpen",submenu:s}).element),t!=null&&t.startsWith("assets/")&&window.siyuan.menus.menu.append(new M(fs(t)).element);const i=e.rect;a.open({x:i.right,y:i.top,w:i.width,h:i.height});const l=a.element.querySelectorAll("textarea");l[0].value=t,l[0].focus(),l[0].select(),l.length>1&&(l[1].value=e.name)},Wf=(e,t,n,a)=>{const s=new Ke("av-asset-link",()=>{const l=s.element.querySelectorAll("textarea");!l[0].value&&!l[1].value||Ta({protyle:e,cellElements:t,blockElement:a,addValue:[{type:"file",name:l[1].value,content:l[0].value}]})});if(s.isOpen)return;s.addItem({iconHTML:"",type:"readonly",label:`${window.siyuan.languages.link}
<textarea rows="1" style="margin:4px 0;width: ${H()?"200":"360"}px;resize: vertical;" class="b3-text-field"></textarea>
<div class="fn__hr"></div>
${window.siyuan.languages.title}
<textarea style="width: ${H()?"200":"360"}px;margin: 4px 0;resize: vertical;" rows="1" class="b3-text-field"></textarea>`});const i=n.getBoundingClientRect();s.open({x:i.right,y:i.bottom,w:n.parentElement.clientWidth+8,h:i.height}),s.element.querySelector("textarea").focus()},oc=(e,t,n)=>{const a=ae(window.siyuan.languages.uploading,0);A("/api/asset/insertLocalAssets",{assetPaths:e,isUpload:!0,id:t.block.rootID},s=>{const i=B(n);if(i){tt(a);const l=[];Object.keys(s.data.succMap).forEach(o=>{const r=me().extname(o).toLowerCase(),c=o.substring(0,o.length-r.length);f.SIYUAN_ASSETS_IMAGE.includes(r)?l.push({type:"image",name:c,content:s.data.succMap[o]}):l.push({type:"file",name:c,content:s.data.succMap[o]})}),Ta({protyle:t,blockElement:i,cellElements:[n],addValue:l})}})},jf=e=>{var t,n,a,s;let i="";switch(e.type){case"block":e!=null&&e.isDetached?i=`<span data-id="${(t=e.block)==null?void 0:t.id}">${((n=e.block)==null?void 0:n.content)||window.siyuan.languages.untitled}</span>`:i=`<span data-type="block-ref" data-id="${(a=e.block)==null?void 0:a.id}" data-subtype="s" class="av__celltext--ref">${((s=e.block)==null?void 0:s.content)||window.siyuan.languages.untitled}</span>`;break;case"text":i=e.text.content;break;case"number":i=e.number.formattedContent||e.number.content.toString();break;case"date":e[e.type]&&e[e.type].isNotEmpty&&(i=U(e[e.type].content).format(e[e.type].isNotTime?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")),e[e.type]&&e[e.type].hasEndDate&&e[e.type].isNotEmpty&&e[e.type].isNotEmpty2&&(i+=`<svg class="av__cellicon"><use xlink:href="#iconForward"></use></svg>${U(e[e.type].content2).format(e[e.type].isNotTime?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")}`),i&&(i=`<span class="av__celltext">${i}</span>`);break;case"url":i=e.url.content?`<a class="fn__a" href="${e.url.content}" target="_blank">${e.url.content}</a>`:"";break;case"phone":i=e.phone.content?`<a class="fn__a" href="tel:${e.phone.content}" target="_blank">${e.phone.content}</a>`:"";break;case"email":i=e.email.content?`<a class="fn__a" href="mailto:${e.email.content}" target="_blank">${e.email.content}</a>`:"";break}return i},Jn=e=>{var t,n,a,s,i,l;let o="";switch(e.type){case"block":o=`<input value="${We(e.block.content)}" type="text" class="b3-text-field b3-text-field--text fn__flex-1" placeholder="${window.siyuan.languages.empty}">`;break;case"text":o=`<textarea style="resize: vertical" rows="${e.text.content.split(`
`).length}" class="b3-text-field b3-text-field--text fn__flex-1" placeholder="${window.siyuan.languages.empty}">${e.text.content}</textarea>`;break;case"number":o=`<input value="${e.number.isNotEmpty?e.number.content:""}" type="number" class="b3-text-field b3-text-field--text fn__flex-1" placeholder="${window.siyuan.languages.empty}">
<span class="fn__space"></span><span class="fn__flex-center ft__on-surface b3-tooltips__w b3-tooltips" aria-label="${window.siyuan.languages.format}">${e.number.formattedContent}</span><span class="fn__space"></span>`;break;case"mSelect":case"select":(t=e.mSelect)==null||t.forEach((r,c)=>{e.type==="select"&&c>0||(o+=`<span class="b3-chip b3-chip--middle" style="background-color:var(--b3-font-background${r.color});color:var(--b3-font-color${r.color})">${pe(r.content)}</span>`)});break;case"mAsset":(n=e.mAsset)==null||n.forEach(r=>{r.type==="image"?o+=`<img class="av__cellassetimg ariaLabel" aria-label="${r.content}" src="${r.content}">`:o+=`<span class="b3-chip b3-chip--middle av__celltext--url ariaLabel" aria-label="${We(r.content)}" data-name="${We(r.name)}" data-url="${We(r.content)}">${r.name||r.content}</span>`});break;case"date":o=`<span class="av__celltext" data-value='${JSON.stringify(e[e.type])}' placeholder="${window.siyuan.languages.empty}">`,e[e.type]&&e[e.type].isNotEmpty&&(o+=U(e[e.type].content).format(e[e.type].isNotTime?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")),e[e.type]&&e[e.type].hasEndDate&&e[e.type].isNotEmpty&&e[e.type].isNotEmpty2&&(o+=`<svg class="av__cellicon"><use xlink:href="#iconForward"></use></svg>${U(e[e.type].content2).format(e[e.type].isNotTime?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")}`),o+="</span>";break;case"created":case"updated":e[e.type].isNotEmpty&&(o=`<span data-content="${e[e.type].content}">${U(e[e.type].content).format("YYYY-MM-DD HH:mm")}</span>`);break;case"url":o=`<input value="${e.url.content}" class="b3-text-field b3-text-field--text fn__flex-1" placeholder="${window.siyuan.languages.empty}">
<span class="fn__space"></span>
<a ${e.url.content?`href="${e.url.content}"`:""} target="_blank" aria-label="${window.siyuan.languages.openBy}" class="block__icon block__icon--show fn__flex-center b3-tooltips__w b3-tooltips"><svg><use xlink:href="#iconLink"></use></svg></a>`;break;case"phone":o=`<input value="${e.phone.content}" class="b3-text-field b3-text-field--text fn__flex-1" placeholder="${window.siyuan.languages.empty}">
<span class="fn__space"></span>
<a ${e.phone.content?`href="tel:${e.phone.content}"`:""} target="_blank" aria-label="${window.siyuan.languages.openBy}" class="block__icon block__icon--show fn__flex-center b3-tooltips__w b3-tooltips"><svg><use xlink:href="#iconPhone"></use></svg></a>`;break;case"checkbox":o=`<svg class="av__checkbox"><use xlink:href="#icon${e.checkbox.checked?"Check":"Uncheck"}"></use></svg>`;break;case"template":o=`<div class="fn__flex-1" placeholder="${window.siyuan.languages.empty}">${e.template.content}</div>`;break;case"email":o=`<input value="${e.email.content}" class="b3-text-field b3-text-field--text fn__flex-1" placeholder="${window.siyuan.languages.empty}">
<span class="fn__space"></span>
<a ${e.email.content?`href="mailto:${e.email.content}"`:""} target="_blank" aria-label="${window.siyuan.languages.openBy}" class="block__icon block__icon--show fn__flex-center b3-tooltips__w b3-tooltips"><svg><use xlink:href="#iconEmail"></use></svg></a>`;break;case"relation":(s=(a=e==null?void 0:e.relation)==null?void 0:a.contents)==null||s.forEach(r=>{var c;r&&r.block&&(r!=null&&r.isDetached?o+=`<span class="av__cell--relation"><span>\u2796 </span><span class="av__celltext" data-id="${(c=r.block)==null?void 0:c.id}">${Lute.EscapeHTMLStr(r.block.content||window.siyuan.languages.untitled)}</span></span>`:o+=`<span class="av__cell--relation" data-block-id="${r.block.id}"><span class="b3-menu__avemoji" data-unicode="${r.block.icon||""}">${ge(r.block.icon||window.siyuan.storage[f.LOCAL_IMAGES].file)}</span><span data-type="block-ref" data-id="${r.block.id}" data-subtype="s" class="av__celltext av__celltext--ref">${Lute.EscapeHTMLStr(r.block.content||window.siyuan.languages.untitled)}</span></span>`)}),o&&o.endsWith(", ")&&(o=o.substring(0,o.length-2));break;case"rollup":(l=(i=e==null?void 0:e.rollup)==null?void 0:i.contents)==null||l.forEach(r=>{const c=["select","mSelect","mAsset","checkbox","relation"].includes(r.type)?Jn(r):jf(r);c&&(o+=c+",&nbsp;")}),o&&o.endsWith(",&nbsp;")&&(o=o.substring(0,o.length-7));break}return o},ql=(e,t,n,a)=>{A("/api/av/getAttributeViewKeys",{id:t},s=>{let i="";if(s.data.forEach(l=>{var o;let r=`<div class="custom-attr__avheader">
    <div class="block__logo popover__block" style="max-width:calc(100% - 40px)" data-id='${JSON.stringify(l.blockIDs)}'>
        <svg class="block__logoicon"><use xlink:href="#iconDatabase"></use></svg>
        <span class="fn__ellipsis">${l.avName||window.siyuan.languages.database}</span>
    </div>
    <div class="fn__flex-1"></div>
    <span data-type="remove" class="block__icon block__icon--warning block__icon--show b3-tooltips__w b3-tooltips" aria-label="${window.siyuan.languages.removeAV}"><svg><use xlink:href="#iconTrashcan"></use></svg></span>
</div>`;(o=l.keyValues)==null||o.forEach(c=>{var d;r+=`<div class="block__icons av__row" data-id="${t}" data-col-id="${c.key.id}">
    <div class="block__icon" draggable="true"><svg><use xlink:href="#iconDrag"></use></svg></div>
    <div class="block__logo ariaLabel fn__pointer" data-type="editCol" data-position="parentW" aria-label="${Nt(c.key.name)}<div class='ft__on-surface'>${Nt(c.key.desc)}</div>">
        ${c.key.icon?ge(c.key.icon,"block__logoicon",!0):`<svg class="block__logoicon"><use xlink:href="#${_t(c.key.type)}"></use></svg>`}
        <span>${pe(c.key.name)}</span>
    </div>
    <div data-av-id="${l.avID}" data-col-id="${c.values[0].keyID}" data-block-id="${c.values[0].blockID}" data-id="${c.values[0].id}" data-type="${c.values[0].type}" 
data-options="${(d=c.key)!=null&&d.options?We(JSON.stringify(c.key.options)):"[]"}" 
${["text","number","date","url","phone","template","email"].includes(c.values[0].type)?"":`placeholder="${window.siyuan.languages.empty}"`}  
class="fn__flex-1 fn__flex${["url","text","number","email","phone","block"].includes(c.values[0].type)?"":" custom-attr__avvalue"}${["created","updated"].includes(c.values[0].type)?" custom-attr__avvalue--readonly":""}">${Jn(c.values[0])}</div>
</div>`}),r+=`<div class="fn__hr"></div>
<button data-type="addColumn" class="b3-button b3-button--cancel"><svg><use xlink:href="#iconAdd"></use></svg>${window.siyuan.languages.newCol}</button>
<div class="fn__hr--b"></div><div class="fn__hr--b"></div>`,i+=`<div data-av-id="${l.avID}" data-node-id="${t}" data-type="NodeAttributeView">${r}</div>`,e.innerHTML&&(e.querySelector(`div[data-node-id="${t}"][data-av-id="${l.avID}"]`).innerHTML=r)}),e.innerHTML===""){let l;e.addEventListener("dragstart",r=>{const c=r.target;window.siyuan.dragElement=c.parentElement,window.siyuan.dragElement.style.opacity=".1",l=B(window.siyuan.dragElement);const d=document.createElement("div");d.className="block__icons",d.innerHTML=c.nextElementSibling.outerHTML,d.setAttribute("style","width: 160px;position:fixed;opacity:.1;"),document.body.append(d),r.dataTransfer.setDragImage(d,0,0),setTimeout(()=>{d.remove()})}),e.addEventListener("drop",r=>{var c,d;if(o=0,n.disabled){r.preventDefault(),r.stopPropagation();return}const u=e.querySelector(".dragover__bottom, .dragover__top");if(u&&l){const p=u.classList.contains("dragover__bottom"),g=p?u.dataset.colId:(c=u.previousElementSibling)==null?void 0:c.getAttribute("data-col-id"),m=(d=window.siyuan.dragElement.previousElementSibling)==null?void 0:d.getAttribute("data-col-id");g!==m&&g!==window.siyuan.dragElement.dataset.colId&&(q(n,[{action:"sortAttrViewKey",avID:l.dataset.avId,previousID:g,id:window.siyuan.dragElement.dataset.colId}],[{action:"sortAttrViewKey",avID:l.dataset.avId,previousID:m,id:t}]),p?u.after(window.siyuan.dragElement):u.before(window.siyuan.dragElement)),u.classList.remove("dragover__bottom","dragover__top")}else if(!window.siyuan.dragElement&&r.dataTransfer.types[0]==="Files"){const p=e.querySelector(".custom-attr__avvalue--active");if(p&&r.dataTransfer.types[0]==="Files"&&!qe()){const g=[];for(let m=0;m<r.dataTransfer.files.length;m++)g.push(webUtils.getPathForFile(r.dataTransfer.files[m]));oc(g,n,p)}}window.siyuan.dragElement&&(window.siyuan.dragElement.style.opacity="",window.siyuan.dragElement=void 0)}),e.addEventListener("dragover",r=>{const c=r.target;let d;if(r.dataTransfer.types.includes("Files")){e.querySelectorAll(".custom-attr__avvalue--active").forEach(g=>{g.classList.remove("custom-attr__avvalue--active")}),d=$(c,"custom-attr__avvalue"),d&&d.getAttribute("data-type")==="mAsset"&&(d.classList.add("custom-attr__avvalue--active"),r.preventDefault());return}if(d=$(c,"av__row"),d||(d=$(document.elementFromPoint(r.clientX,r.clientY-1),"av__row")),!d||d.isSameNode(window.siyuan.dragElement)||!l)return;const u=B(d);if(!u||!u.isSameNode(l))return;r.preventDefault();const p=d.getBoundingClientRect();e.querySelectorAll(".dragover__bottom, .dragover__top").forEach(g=>{g.classList.remove("dragover__bottom","dragover__top")}),r.clientY>p.top+p.height/2?d.classList.add("dragover__bottom"):d.classList.add("dragover__top")});let o=0;e.addEventListener("dragleave",()=>{o--,o===0&&e.querySelectorAll(".dragover__bottom, .dragover__top").forEach(r=>{r.classList.remove("dragover__bottom","dragover__top")})}),e.addEventListener("dragenter",r=>{r.preventDefault(),o++}),e.addEventListener("dragend",()=>{window.siyuan.dragElement&&(window.siyuan.dragElement.style.opacity="",window.siyuan.dragElement=void 0)}),e.addEventListener("paste",r=>{var c;const d=r.clipboardData.files;if(document.querySelector(".av__panel .b3-form__upload"))if(d&&d.length>0)Rn(n,d);else{const u=r.clipboardData.getData("text/plain"),p=r.target,g=B(p),m=D(p,"data-type","mAsset");g&&m&&u&&(zt(n,g,u,[m],void 0,n.lute.Md2BlockDOM(u)),(c=document.querySelector(".av__panel"))==null||c.remove())}}),e.addEventListener("click",r=>{const c=D(r.target,"data-type","remove");if(c){const d=B(c);d&&(q(n,[{action:"removeAttrViewBlock",srcIDs:[t],avID:d.dataset.avId},{action:"doUpdateUpdated",id:t,data:U().format("YYYYMMDDHHmmss")}]),d.remove(),e.innerHTML||window.siyuan.dialogs.find(u=>{if(u.element.getAttribute("data-key")===f.DIALOG_ATTR)return u.destroy(),!0})),r.stopPropagation();return}rc(n,e,r)}),e.addEventListener("contextmenu",r=>{rc(n,e,r)}),e.innerHTML=i}e.querySelectorAll(".b3-text-field--text").forEach(l=>{l.addEventListener("change",()=>{let o;const r=l.parentElement.dataset.type;if(["url","text","email","phone"].includes(r)){if(o={[r]:{content:l.value}},r!=="text"){const c=l.parentElement.querySelector("a");l.value?c.setAttribute("href",(r==="url"?"":r==="email"?"mailto:":"tel:")+l.value):c.removeAttribute("href")}}else r==="number"?l.value==="undefined"||!l.value?o={number:{content:null,isNotEmpty:!1}}:o={number:{content:parseFloat(l.value)||0,isNotEmpty:!0}}:r==="block"&&(o={block:{content:l.value,id:l.parentElement.dataset.blockId},isDetached:!1});A("/api/av/setAttributeViewBlockAttr",{avID:l.parentElement.dataset.avId,keyID:l.parentElement.dataset.colId,rowID:l.parentElement.dataset.blockId,value:o},c=>{r==="number"?l.parentElement.querySelector(".fn__flex-center").textContent=c.data.value.number.formattedContent:r==="block"&&!l.value&&(l.value=c.data.value.block.content)})})}),a&&a(e)})},rc=(e,t,n)=>{let a=n.target;const s=B(a);if(s)for(;a&&!t.isSameNode(a);){const i=a.getAttribute("data-type");if(a.classList.contains("av__celltext--url")||a.classList.contains("av__cellassetimg")){if(n.type==="contextmenu"||!a.dataset.url&&a.tagName!=="IMG"){let l=0;Array.from(a.parentElement.children).find((o,r)=>{if(o.isSameNode(a))return l=r,!0}),_s({protyle:e,cellElements:[a.parentElement],blockElement:B(a),content:a.tagName==="IMG"?a.getAttribute("src"):a.getAttribute("data-url"),type:a.tagName==="IMG"?"image":"file",name:a.tagName==="IMG"?"":a.getAttribute("data-name"),index:l,rect:a.getBoundingClientRect()})}else a.tagName==="IMG"?wi(a.getAttribute("src")):Ci(e,a.dataset.url,n,n.ctrlKey||n.metaKey);n.stopPropagation(),n.preventDefault();break}else if(i==="date"){rn(e,[a],"date"),n.stopPropagation(),n.preventDefault();break}else if(i==="select"||i==="mSelect"){rn(e,[a],a.getAttribute("data-type")),n.stopPropagation(),n.preventDefault();break}else if(i==="mAsset"){t.querySelectorAll('.custom-attr__avvalue[data-type="mAsset"]').forEach(l=>{l.removeAttribute("data-active")}),a.setAttribute("data-active","true"),a.focus(),rn(e,[a],"mAsset"),n.stopPropagation(),n.preventDefault();break}else if(i==="checkbox"){rn(e,[a],"checkbox"),n.stopPropagation(),n.preventDefault();break}else if(i==="relation"){rn(e,[a],"relation"),n.stopPropagation(),n.preventDefault();break}else if(i==="template"){rn(e,[a],"template"),n.stopPropagation(),n.preventDefault();break}else if(i==="rollup"){rn(e,[a],"rollup"),n.stopPropagation(),n.preventDefault();break}else if(i==="addColumn"){const l=s.querySelectorAll(".av__row"),o=Ii(e,s,l[l.length-1].getAttribute("data-col-id")),r=a.getBoundingClientRect();o.open({x:r.left,y:r.bottom,h:r.height}),n.stopPropagation(),n.preventDefault();break}else if(i==="editCol"){$t({protyle:e,blockElement:s,type:"edit",colId:a.parentElement.dataset.colId}),n.stopPropagation(),n.preventDefault();break}a=a.parentElement}};let Vt;const Ol=(e,t,n=[])=>{let a="",s=!1;if(n.length===0&&document.querySelectorAll(".av__panel .b3-chips .b3-chip").forEach(i=>{n.push(i.dataset.content)}),t&&t.forEach(i=>{if(!e||e.toLowerCase().indexOf(i.name.toLowerCase())>-1||i.name.toLowerCase().indexOf(e.toLowerCase())>-1){const l=i.desc?`${Nt(i.name)}<div class='ft__on-surface'>${Nt(i.desc||"")}</div>`:"";a+=`<button data-type="addColOptionOrCell" class="b3-menu__item" data-name="${We(i.name)}" data-desc="${We(i.desc||"")}" draggable="true" data-color="${i.color}">
    <svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>
    <div class="fn__flex-1 ariaLabel" data-position="parentW" aria-label="${l}">
        <span class="b3-chip" style="background-color:var(--b3-font-background${i.color});color:var(--b3-font-color${i.color})">
            <span class="fn__ellipsis">${pe(i.name)}</span>
        </span>
    </div>
    <svg class="b3-menu__action" data-type="setColOption"><use xlink:href="#iconEdit"></use></svg>
    ${n.includes(i.name)?'<svg class="b3-menu__checked"><use xlink:href="#iconSelect"></use></svg></span>':""}
</button>`}e===i.name&&(s=!0)}),!s&&e){const i=((t==null?void 0:t.length)||0)%14+1;a=`<button data-type="addColOptionOrCell" class="b3-menu__item b3-menu__item--current" data-name="${e}" data-color="${i}">
<svg class="b3-menu__icon"><use xlink:href="#iconAdd"></use></svg>
<div class="fn__flex-1">
    <span class="b3-chip" style="background-color:var(--b3-font-background${i});color:var(--b3-font-color${i})">
        <span class="fn__ellipsis">${pe(e)}</span>
    </span>
</div>
<span class="b3-menu__accelerator">${window.siyuan.languages.enterKey}</span>
</button>${a}`}return a},vs=(e,t,n,a)=>{if(!n)return;const s=t[0].dataset.colId,i=[],l=[];let o;const r=a.getAttribute("data-av-id");t.forEach((c,d)=>{var u;if(!a.contains(c)){const b=$(c,"av__row");b&&(c=t[d]=a.querySelector(`.av__row[data-id="${b.dataset.id}"] .av__cell[data-col-id="${c.dataset.colId}"]`)||a.querySelector(`.fn__flex-1[data-col-id="${c.dataset.colId}"]`))}const p=$(c,"av__row").dataset.id,g=Vt[d],m=JSON.parse(JSON.stringify(g));d===0?((u=g.mSelect)==null||u.find((b,y)=>{if(b.content===n.dataset.content)return g.mSelect.splice(y,1),!0}),o=g.mSelect):g.mSelect=o,i.push({action:"updateAttrViewCell",id:g.id,keyID:s,rowID:p,avID:r,data:g}),l.push({action:"updateAttrViewCell",id:g.id,keyID:s,rowID:p,avID:r,data:m}),c.classList.contains("custom-attr__avvalue")?c.innerHTML=Jn(g):Tt(c,g)}),q(e,i,l),Array.from(document.querySelectorAll(".av__panel .b3-menu__item")).find(c=>{var d;if(c.dataset.name===n.dataset.content)return(d=c.querySelector(".b3-menu__checked"))==null||d.remove(),!0}),n.remove()},Vf=(e,t,n,a,s,i)=>{const l=$(n,"b3-menu");if(!l)return;const o=a.getAttribute("data-node-id"),r=i?i[0].dataset.colId:l.querySelector(".b3-menu__item").getAttribute("data-col-id");let c=n.parentElement.dataset.name,d=n.parentElement.dataset.desc,u=n.parentElement.dataset.color;const p=new Ke("av-col-option",()=>{if(c===b.value&&d===y.value||!b.value)return;q(e,[{action:"updateAttrViewColOption",id:r,avID:t.id,data:{newColor:u,oldName:c,newName:b.value,newDesc:y.value}}],[{action:"updateAttrViewColOption",id:r,avID:t.id,data:{newColor:u,oldName:b.value,newName:c,newDesc:d}}]),t.view.columns.find(h=>{if(h.id===r){let E=!1;return h.options.find(S=>{if(S.name===b.value)return E=!0,!0}),E||h.options.find(S=>{if(S.name===c)return S.name=b.value,S.desc=y.value,!0}),!0}});const _=l.querySelector(".b3-menu__items").scrollTop,w=l.querySelector(".b3-chips"),v=w?w.clientHeight:0;i?(i.forEach((h,E)=>{const S=$(h,"av__row");S&&(h=i[E]=a.querySelector(`.av__row[data-id="${S.dataset.id}"] .av__cell[data-col-id="${h.dataset.colId}"]`)||a.querySelector(`.fn__flex-1[data-col-id="${h.dataset.colId}"]`)),Vt[E].mSelect.find(L=>{if(L.content===c)return L.content=b.value,!0}),h.classList.contains("custom-attr__avvalue")?h.innerHTML=Jn(Vt[E]):Tt(h,Vt[E])}),l.innerHTML=za(t.view,i),Va(e,t,l,i,a)):(l.innerHTML=Ln({protyle:e,data:t,colId:r,isCustomAttr:s}),Sn({protyle:e,data:t,menuElement:l,isCustomAttr:s,blockID:o})),w&&(l.querySelector(".b3-menu__items").scrollTop=_+(l.querySelector(".b3-chips").clientHeight-v))});if(p.isOpen)return;p.addItem({iconHTML:"",type:"empty",label:`<div class="fn__hr"></div>
<div class="b3-form__icona fn__block">
    <input class="b3-text-field b3-form__icona-input" type="text">
    <svg data-position="north" class="b3-form__icona-icon ariaLabel" aria-label="${d?Nt(d):window.siyuan.languages.addDesc}"><use xlink:href="#iconInfo"></use></svg>
</div>
<div class="fn__none">
    <div class="fn__hr"></div>
    <textarea rows="1" placeholder="${window.siyuan.languages.addDesc}" class="b3-text-field fn__block" type="text" data-value="${We(d)}">${d}</textarea>
</div>
<div class="fn__hr--small"></div>`,bind(_){const w=_.querySelector("input");w.addEventListener("keydown",h=>{h.isComposing||h.key==="Enter"&&p.close()}),w.value=c;const v=_.querySelector("textarea");w.nextElementSibling.addEventListener("click",()=>{const h=v.parentElement;h.classList.toggle("fn__none"),h.classList.contains("fn__none")||v.focus()}),v.addEventListener("keydown",h=>{h.isComposing||h.key==="Enter"&&p.close()}),v.addEventListener("input",()=>{w.nextElementSibling.setAttribute("aria-label",v.value?pe(v.value):window.siyuan.languages.addDesc)})}}),p.addItem({id:"delete",label:window.siyuan.languages.delete,icon:"iconTrashcan",click(){$e(window.siyuan.languages.deleteOpConfirm,window.siyuan.languages.confirmDelete,()=>{let _=[];t.view.columns.find(S=>{if(S.id===r)return _=S.options,!0});const w=n.parentElement.dataset.name;q(e,[{action:"removeAttrViewColOption",id:r,avID:t.id,data:w}],[{action:"updateAttrViewColOptions",id:r,avID:t.id,data:_}]),_.find((S,L)=>{if(S.name===w)return _.splice(L,1),!0});const v=l.querySelector(".b3-menu__items").scrollTop,h=l.querySelector(".b3-chips"),E=h?h.clientHeight:0;i?(i.forEach((S,L)=>{const k=$(S,"av__row");k&&(S=i[L]=a.querySelector(`.av__row[data-id="${k.dataset.id}"] .av__cell[data-col-id="${S.dataset.colId}"]`)||a.querySelector(`.fn__flex-1[data-col-id="${S.dataset.colId}"]`)),Vt[L].mSelect.find((x,C)=>{if(x.content===w)return Vt[L].mSelect.splice(C,1),!0}),S.classList.contains("custom-attr__avvalue")?S.innerHTML=Jn(Vt[L]):Tt(S,Vt[L])}),l.innerHTML=za(t.view,i),Va(e,t,l,i,a)):(l.innerHTML=Ln({protyle:e,data:t,colId:r,isCustomAttr:s}),Sn({protyle:e,data:t,menuElement:l,isCustomAttr:s,blockID:o})),h&&(l.querySelector(".b3-menu__items").scrollTop=v+(l.querySelector(".b3-chips").clientHeight-E))},void 0,!0)}}),p.addSeparator();let g='<div class="fn__flex fn__flex-wrap" style="width: 238px">';Array.from(Array(14).keys()).forEach(_=>{g+=`<button data-color="${_+1}" class="color__square${parseInt(u)===_+1?" color__square--current":""}" style="color: var(--b3-font-color${_+1});background-color: var(--b3-font-background${_+1});">A</button>`}),p.addItem({type:"empty",iconHTML:"",label:g+"</div>",bind(_){_.addEventListener("click",w=>{var v;const h=w.target;if(h.classList.contains("color__square")&&!h.classList.contains("color__square--current")){(v=_.querySelector(".color__square--current"))==null||v.classList.remove("color__square--current"),h.classList.add("color__square--current");const E=h.getAttribute("data-color");q(e,[{action:"updateAttrViewColOption",id:r,avID:t.id,data:{oldName:c,newName:b.value,oldColor:u,newColor:E,newDesc:y.value}}],[{action:"updateAttrViewColOption",id:r,avID:t.id,data:{oldName:b.value,newName:c,oldColor:E,newColor:u,newDesc:y.value}}]),t.view.columns.find(L=>{if(L.id===r)return L.options.find(k=>{if(k.name===c)return k.name=b.value,k.color=E,!0}),!0});const S=l.querySelector(".b3-menu__items").scrollTop;i?(i.forEach((L,k)=>{const x=$(L,"av__row");x&&(L=i[k]=a.querySelector(`.av__row[data-id="${x.dataset.id}"] .av__cell[data-col-id="${L.dataset.colId}"]`)||a.querySelector(`.fn__flex-1[data-col-id="${L.dataset.colId}"]`)),Vt[k].mSelect.find(C=>{if(C.content===c)return C.content=b.value,C.color=E,!0}),L.classList.contains("custom-attr__avvalue")?L.innerHTML=Jn(Vt[k]):Tt(L,Vt[k])}),l.innerHTML=za(t.view,i),Va(e,t,l,i,a)):(l.innerHTML=Ln({protyle:e,data:t,colId:r,isCustomAttr:s}),Sn({protyle:e,data:t,menuElement:l,isCustomAttr:s,blockID:o})),l.querySelector(".b3-menu__items").scrollTop=S,c=b.value,d=y.value,u=E}})}});const m=n.getBoundingClientRect();p.open({x:m.right,y:m.bottom,w:m.width,h:m.height});const b=window.siyuan.menus.menu.element.querySelector("input");b.select();const y=window.siyuan.menus.menu.element.querySelector("textarea")},Va=(e,t,n,a,s)=>{const i=n.querySelector("input"),l=a[0].dataset.colId;let o;t.view.columns.find(c=>{if(c.id===l){o=c;return}}),o.options||(o.options=[]);const r=n.lastElementChild.lastElementChild;i.addEventListener("input",c=>{c.isComposing||(r.innerHTML=Ol(i.value,o.options))}),i.addEventListener("compositionend",()=>{r.innerHTML=Ol(i.value,o.options)}),i.addEventListener("keydown",c=>{if(c.isComposing)return;let d=Wt(r,c,"b3-menu__item--current",r.firstElementChild);c.key==="Enter"?(d||(d=n.querySelector(".b3-menu__item--current")),d.querySelector(".b3-menu__checked")?vs(e,a,n.querySelector(`.b3-chips .b3-chip[data-content="${We(d.dataset.name)}"]`),s):cc(e,t,a,d,n,s)):c.key==="Backspace"&&i.value===""&&vs(e,a,i.previousElementSibling,s)})},cc=(e,t,n,a,s,i)=>{let l=!1;if(Array.from(s.querySelectorAll(".b3-chips .b3-chip")).find(g=>{if(g.dataset.content===a.dataset.name)return l=!0,!0}),l){s.querySelector("input").focus();return}B(n[0])||n.forEach((g,m)=>{const b=$(g,"av__row");b&&(n[m]=i.querySelector(`.av__row[data-id="${b.dataset.id}"] .av__cell[data-col-id="${g.dataset.colId}"]`)||i.querySelector(`.fn__flex-1[data-col-id="${g.dataset.colId}"]`))});const r=n[0].dataset.colId;let c;t.view.columns.find(g=>{if(g.id===r){c=g,c.options||(c.options=[]);return}});const d=[],u=[];let p;if(n.forEach((g,m)=>{const b=$(g,"av__row");if(!b)return;const y=b.dataset.id,_=Vt[m],w=JSON.parse(JSON.stringify(_));if(m===0){if(c.type==="mSelect"){let v=!1;_.mSelect.find(h=>{if(h.content===a.dataset.name)return v=!0,!0}),v||_.mSelect.push({color:a.dataset.color,content:a.dataset.name})}else _.mSelect=[{color:a.dataset.color,content:a.dataset.name}];p=_.mSelect}else _.mSelect=p;d.push({action:"updateAttrViewCell",id:_.id,keyID:r,rowID:y,avID:t.id,data:_}),u.push({action:"updateAttrViewCell",id:_.id,keyID:r,rowID:y,avID:t.id,data:w}),g.classList.contains("custom-attr__avvalue")?g.innerHTML=Jn(_):Tt(g,_)}),a.querySelector(".b3-menu__accelerator")?(c.options.push({color:a.dataset.color,name:a.dataset.name}),d.splice(0,0,{action:"updateAttrViewColOptions",id:r,avID:t.id,data:c.options}),q(e,d,[{action:"removeAttrViewColOption",id:r,avID:t.id,data:a.dataset.name}])):q(e,d,u),c.type==="select")s.parentElement.remove();else{const g=s.querySelector(".b3-menu__items").scrollTop,m=s.querySelector(".b3-chips").clientHeight;s.innerHTML=za(t.view,n),Va(e,t,s,n,i),s.querySelector("input").focus(),s.querySelector(".b3-menu__items").scrollTop=g+(s.querySelector(".b3-chips").clientHeight-m)}},za=(e,t,n=!1)=>{var a;if(n){Vt=[];const r=t[0].classList.contains("custom-attr__avvalue");t.forEach(c=>{Vt.push(gn(r?c.dataset.type:Bt(c),c))})}const s=t[0].dataset.colId,i=e.columns.find(r=>{if(r.id===s)return r});let l="";const o=[];return(a=Vt[0].mSelect)==null||a.forEach(r=>{o.push(r.content),l+=`<div class="b3-chip b3-chip--middle" data-content="${We(r.content)}" style="white-space: nowrap;max-width:100%;background-color:var(--b3-font-background${r.color});color:var(--b3-font-color${r.color})"><span class="fn__ellipsis">${pe(r.content)}</span><svg class="b3-chip__close" data-type="removeCellOption"><use xlink:href="#iconCloseRound"></use></svg></div>`}),`<div class="b3-menu__items">
<div class="b3-chips" style="max-width: 50vw">
    ${l}
    <input>
</div>
<div>${Ol("",i.options,o)}</div>
</div>`},dc=(e,t,n)=>{const a=[],s=[];return t.mSelect.forEach(i=>{var l;if(e.options||(e.options=[]),!e.options.find(r=>{if(r.name===i.content)return i.color=r.color,!0})){const r=((((l=e.options)==null?void 0:l.length)||0)%14+1).toString();e.options.push({name:i.content,color:r}),i.color=r,a.push({action:"updateAttrViewColOptions",id:e.id,avID:n,data:e.options}),s.push({action:"removeAttrViewColOption",id:e.id,avID:n,data:i.content})}}),{doOperations:a,undoOperations:s}},zf=e=>{const t=new Ke("av-add-sort");e.data.view.columns.forEach(n=>{let a=!1;n.type==="lineNumber"?a=!0:e.data.view.sorts.find(s=>{if(s.column===n.id)return a=!0,!0}),a||t.addItem({label:n.name,iconHTML:n.icon?ge(n.icon,"b3-menu__icon",!0):`<svg class="b3-menu__icon"><use xlink:href="#${_t(n.type)}"></use></svg>`,click:()=>{const s=Object.assign([],e.data.view.sorts);e.data.view.sorts.push({column:n.id,order:"ASC"}),q(e.protyle,[{action:"setAttrViewSorts",avID:e.data.id,data:e.data.view.sorts,blockID:e.blockID}],[{action:"setAttrViewSorts",avID:e.data.id,data:s,blockID:e.blockID}]),e.menuElement.innerHTML=Ka(e.data.view.columns,e.data.view.sorts),Ga(e.protyle,e.menuElement,e.data,e.blockID),ke(e.menuElement,e.tabRect.right-e.menuElement.clientWidth,e.tabRect.bottom,e.tabRect.height)}})}),t.open({x:e.rect.left,y:e.rect.bottom,h:e.rect.height})},Ga=(e,t,n,a)=>{t.querySelectorAll("select").forEach(s=>{s.addEventListener("change",()=>{const i=s.parentElement.getAttribute("data-id"),l=JSON.parse(JSON.stringify(n.view.sorts));s.previousElementSibling.classList.contains("b3-menu__icon")?n.view.sorts.find(o=>{if(o.column===i)return o.column=s.value,s.parentElement.setAttribute("data-id",s.value),!0}):n.view.sorts.find(o=>o.column===i).order=s.value,q(e,[{action:"setAttrViewSorts",avID:n.id,data:n.view.sorts,blockID:a}],[{action:"setAttrViewSorts",avID:n.id,data:l,blockID:a}])})})},Ka=(e,t)=>{let n="";const a=s=>{let i="";return e.forEach(l=>{i+=`<option value="${l.id}" ${l.id===s?"selected":""}>${l.icon&&ge(l.icon)}${l.name}</option>`}),i};return t.forEach(s=>{n+=`<button draggable="true" class="b3-menu__item" data-id="${s.column}">
    <svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>
    <select class="b3-select" style="margin: 4px 0">
        ${a(s.column)}
    </select>
    <span class="fn__space"></span>
    <select class="b3-select" style="margin: 4px 0">
        <option value="ASC" ${s.order==="ASC"?"selected":""}>${window.siyuan.languages.asc}</option>
        <option value="DESC" ${s.order==="DESC"?"selected":""}>${window.siyuan.languages.desc}</option>
    </select>
    <svg class="b3-menu__action" data-type="removeSort"><use xlink:href="#iconTrashcan"></use></svg>
</button>`}),`<div class="b3-menu__items">
<button class="b3-menu__item" data-type="nobg">
    <span class="block__icon" style="padding: 8px;margin-left: -4px;" data-type="go-config">
        <svg><use xlink:href="#iconLeft"></use></svg>
    </span>
    <span class="b3-menu__label ft__center">${window.siyuan.languages.sort}</span>
</button>
<button class="b3-menu__separator"></button>
${n}
<button class="b3-menu__item${t.length===e.length?" fn__none":""}" data-type="addSort">
    <svg class="b3-menu__icon"><use xlink:href="#iconAdd"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.new}</span>
</button>
<button class="b3-menu__item${n?"":" fn__none"}" data-type="removeSorts">
    <svg class="b3-menu__icon"><use xlink:href="#iconTrashcan"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.delete}</span>
</button>
</div>`},Gf=e=>{const t=gn("date",e[0]).date,n=t.isNotTime;let a="";const s=new Date().getTime();if(t.isNotEmpty){a=U(t.content).format(n?"YYYY-MM-DD":"YYYY-MM-DD HH:mm");const l=a.split("-")[0];l.length!==4&&(a=new Array(4-l.length).fill(0).join("")+a)}else a=U(s).format(n?"YYYY-MM-DD":"YYYY-MM-DD HH:mm");let i="";if(t.isNotEmpty2){i=U(t.content2).format(n?"YYYY-MM-DD":"YYYY-MM-DD HH:mm");const l=a.split("-")[0];l.length!==4&&(a=new Array(4-l.length).fill(0).join("")+a)}else t.hasEndDate&&(i=U(s).format(n?"YYYY-MM-DD":"YYYY-MM-DD HH:mm"));return`<div class="b3-menu__items">
<div>
    <input type="${n?"date":"datetime-local"}" max="${n?"9999-12-31":"9999-12-31 23:59"}" value="${a}" data-value="${U(t.content||s).format("YYYY-MM-DD HH:mm")}" class="b3-text-field fn__size200" style="margin-top: 4px;"><br>
    <input type="${n?"date":"datetime-local"}" max="${n?"9999-12-31":"9999-12-31 23:59"}" value="${i}" data-value="${t.isNotEmpty2?U(t.content2).format("YYYY-MM-DD HH:mm"):""}" style="margin-top: 8px;margin-bottom: 4px" class="b3-text-field fn__size200${t.hasEndDate?"":" fn__none"}">
    <button class="b3-menu__separator"></button>
    <label class="b3-menu__item">
        <span class="fn__flex-center">${window.siyuan.languages.endDate}</span>
        <span class="fn__space fn__flex-1"></span>
        <input type="checkbox" class="b3-switch b3-switch--menu"${t.hasEndDate?" checked":""}>
    </label>
    <label class="b3-menu__item">
        <span class="fn__flex-center">${window.siyuan.languages.includeTime}</span>
        <span class="fn__space fn__flex-1"></span>
        <input type="checkbox" class="b3-switch b3-switch--menu"${n?"":" checked"}>
    </label>
    <button class="b3-menu__separator"></button>
    <button class="b3-menu__item" data-type="clearDate">
        <svg class="b3-menu__icon"><use xlink:href="#iconTrashcan"></use></svg>
        <span class="b3-menu__label">${window.siyuan.languages.clear}</span>
    </button>
</div>
</div>`},Kf=e=>{const t=e.menuElement.querySelectorAll("input");return t.forEach(n=>{n.addEventListener("keydown",a=>{var s;a.isComposing||a.key==="Enter"&&(zt(e.protyle,e.blockElement,{content:ks(t[0].dataset.value),isNotEmpty:t[0].value!=="",content2:ks(t[1].dataset.value),isNotEmpty2:t[1].value!=="",hasEndDate:t[2].checked,isNotTime:!t[3].checked},e.cellElements),(s=document.querySelector(".av__panel"))==null||s.remove())})}),t[0].addEventListener("change",()=>{t[0].dataset.value=t[0].value.length>10?t[0].value:t[0].value+" 00:00"}),t[1].addEventListener("change",()=>{t[1].dataset.value=t[1].value.length>10?t[1].value:t[1].value+" 00:00"}),t[2].addEventListener("change",()=>{if(t[2].checked){if(!t[1].dataset.value){const n=new Date().getTime();t[1].dataset.value=U(n).format("YYYY-MM-DD HH:mm"),t[1].value=U(n).format(t[3].checked?"YYYY-MM-DD HH:mm":"YYYY-MM-DD")}t[1].classList.remove("fn__none")}else t[1].classList.add("fn__none")}),t[3].addEventListener("change",()=>{t[3].checked?(t[0].setAttribute("type","datetime-local"),t[1].setAttribute("type","datetime-local"),t[0].setAttribute("max","9999-12-31 23:59"),t[1].setAttribute("max","9999-12-31 23:59"),t[0].value=t[0].dataset.value,t[1].value=t[1].dataset.value):(t[0].setAttribute("type","date"),t[1].setAttribute("type","date"),t[0].setAttribute("max","9999-12-31"),t[1].setAttribute("max","9999-12-31"),t[0].value=t[0].dataset.value.substring(0,10),t[1].value=t[1].dataset.value.substring(0,10))}),()=>{zt(e.protyle,e.blockElement,{content:ks(t[0].dataset.value),isNotEmpty:t[0].value!=="",content2:ks(t[1].dataset.value),isNotEmpty2:t[1].value!=="",hasEndDate:t[2].checked,isNotTime:!t[3].checked},e.cellElements)}},ks=e=>{const t=e.split("-")[0],n=new Date(e);return(t.startsWith("00")||t.startsWith("000")||t.length<3)&&n.setFullYear(parseInt(t)),n.getTime()},on=e=>{e.menu.addItem({iconHTML:"",label:uc(e.format),click(){q(e.protyle,[{action:"updateAttrViewColNumberFormat",id:e.colId,avID:e.avID,format:e.format,type:"number"}],[{action:"updateAttrViewColNumberFormat",id:e.colId,avID:e.avID,format:e.oldFormat,type:"number"}]),e.avPanelElement.remove()}})},Zf=e=>{const t=new Ke("av-col-format-number");on({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),on({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"commas",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),on({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"percent",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),on({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"usDollar",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),on({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"yuan",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),on({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"euro",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),on({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"pound",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),on({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"yen",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),on({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"ruble",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),on({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"rupee",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),on({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"won",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),on({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"canadianDollar",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),on({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"franc",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement});const n=e.element.getBoundingClientRect();t.open({x:n.left,y:n.bottom,h:n.height,w:n.width,isLeft:!0})},uc=e=>{switch(e){case"":return window.siyuan.languages.numberFormatNone;case"commas":return window.siyuan.languages.numberFormatCommas;case"percent":return window.siyuan.languages.numberFormatPercent;case"usDollar":return window.siyuan.languages.numberFormatUSDollar;case"yuan":return window.siyuan.languages.numberFormatYuan;case"euro":return window.siyuan.languages.numberFormatEuro;case"pound":return window.siyuan.languages.numberFormatPound;case"yen":return window.siyuan.languages.numberFormatYen;case"ruble":return window.siyuan.languages.numberFormatRuble;case"rupee":return window.siyuan.languages.numberFormatRupee;case"won":return window.siyuan.languages.numberFormatWon;case"canadianDollar":return window.siyuan.languages.numberFormatCanadianDollar;case"franc":return window.siyuan.languages.numberFormatFranc}},fc=(e,t)=>{var n,a;if(t.classList.contains("b3-list--empty"))return;e.target.querySelector(".b3-menu__accelerator").textContent=t.querySelector(".b3-list-item__text").textContent;const s=e.data.view.columns.find(l=>{if(l.id===e.colId)return l.rollup||(l.rollup={}),!0});if(e.isRelation){if(t.dataset.colId===((n=s.rollup)==null?void 0:n.relationKeyID))return;s.rollup={relationKeyID:t.dataset.colId};const l=e.target.nextElementSibling;l.querySelector(".b3-menu__accelerator").textContent="",l.setAttribute("data-av-id",t.dataset.targetAvId);const o=l.nextElementSibling;o.removeAttribute("data-col-type"),o.removeAttribute("data-calc"),o.querySelector(".b3-menu__accelerator").textContent=window.siyuan.languages.original}else{if(t.dataset.colId===((a=s.rollup)==null?void 0:a.keyID))return;s.rollup.keyID=t.dataset.colId,delete s.rollup.calc;const l=e.target.nextElementSibling;l.removeAttribute("data-calc"),l.setAttribute("data-col-type",t.dataset.colType),l.querySelector(".b3-menu__accelerator").textContent=window.siyuan.languages.original}const i=JSON.parse(JSON.stringify(s.rollup));q(e.protyle,[{action:"updateAttrViewColRollup",id:e.colId,avID:e.data.id,parentID:s.rollup.relationKeyID,keyID:s.rollup.keyID,data:{calc:s.rollup.calc}}],[{action:"updateAttrViewColRollup",id:e.colId,avID:e.data.id,parentID:i.relationKeyID,keyID:i.keyID,data:{calc:i.calc}}])},gc=(e,t,n,a,s)=>{if(!a&&!n){ae(window.siyuan.languages.selectRelation);return}A(a?"/api/av/searchAttributeViewRelationKey":"/api/av/searchAttributeViewNonRelationKey",{avID:n,keyword:t},i=>{let l="";i.data.keys.forEach((o,r)=>{l+=`<div class="b3-list-item b3-list-item--narrow${r===0?" b3-list-item--focus":""}" data-col-id="${o.id}" ${a?`data-target-av-id="${o.relation.avID}"`:`data-col-type="${o.type}"`}>
        ${o.icon?ge(o.icon,"b3-list-item__graphic",!0):`<svg class="b3-list-item__graphic"><use xlink:href="#${_t(o.type)}"></use></svg>`}
        <span class="b3-list-item__text">${pe(o.name||window.siyuan.languages.title)}</span>
</div>`}),e.innerHTML=l||`<div class="b3-list--empty">${window.siyuan.languages.emptyContent}</div>`,s&&s()})},pc=e=>{window.siyuan.menus.menu.remove();const t=new Ke;t.addItem({iconHTML:"",type:"empty",label:`<div class="fn__flex-column b3-menu__filter">
    <input class="b3-text-field fn__flex-shrink" placeholder="${window.siyuan.languages[e.isRelation?"searchRelation":"searchRollupProperty"]}"/>
    <div class="fn__hr"></div>
    <div class="b3-list fn__flex-1 b3-list--background">
        <img style="margin: 0 auto;display: block;width: 64px;height: 64px" src="/stage/loading-pure.svg">
    </div>
</div>`,bind(n){const a=n.querySelector(".b3-list"),s=n.querySelector("input");s.addEventListener("keydown",i=>{if(i.isComposing)return;Wt(a,i)&&i.stopPropagation(),i.key==="Enter"&&(i.preventDefault(),i.stopPropagation(),fc(e,a.querySelector(".b3-list-item--focus")),window.siyuan.menus.menu.remove())}),s.addEventListener("input",i=>{i.stopPropagation(),gc(a,s.value,e.isRelation?e.data.id:e.target.dataset.avId,e.isRelation)}),n.lastElementChild.addEventListener("click",i=>{const l=$(i.target,"b3-list-item");l&&(i.stopPropagation(),fc(e,l),window.siyuan.menus.menu.remove())}),gc(a,"",e.isRelation?e.data.id:e.target.dataset.avId,e.isRelation,()=>{const i=e.target.getBoundingClientRect();t.open({x:i.left,y:i.bottom,h:i.height}),n.querySelector("input").focus()})}}),t.element.querySelector(".b3-menu__items").setAttribute("style","overflow: initial")},mc=e=>{var t,n;let a;return e.colData?a=e.colData:e.data.view.columns.find(s=>{if(s.id===e.cellElements[0].dataset.colId)return a=s,!0}),`<button class="b3-menu__item" data-type="goSearchRollupCol" data-old-value='${JSON.stringify(a.rollup||{})}'>
    <span class="b3-menu__label">${window.siyuan.languages.relation}</span>
    <span class="b3-menu__accelerator"></span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<button class="b3-menu__item" data-type="goSearchRollupTarget">
    <span class="b3-menu__label">${window.siyuan.languages.rollupProperty}</span>
    <span class="b3-menu__accelerator"></span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<button class="b3-menu__item" data-type="goSearchRollupCalc">
    <span class="b3-menu__label">${window.siyuan.languages.rollupCalc}</span>
    <span class="b3-menu__accelerator">${dl((n=(t=a.rollup)==null?void 0:t.calc)==null?void 0:n.operator,!0)}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>`},bc=e=>{const t=e.menuElement.querySelector('[data-type="goSearchRollupCol"]');if(t){const n=JSON.parse(t.dataset.oldValue),a=e.menuElement.querySelector('[data-type="goSearchRollupTarget"]');let s="";n.relationKeyID&&e.data.view.columns.find(i=>{if(i.id===n.relationKeyID)return t.querySelector(".b3-menu__accelerator").textContent=i.name,s=i.relation.avID,a.dataset.avId=s,!0}),n.keyID&&s&&A("/api/av/getAttributeView",{id:s},i=>{i.data.av.keyValues.find(l=>{if(l.key.id===n.keyID){a.querySelector(".b3-menu__accelerator").textContent=l.key.name;const o=e.menuElement.querySelector('[data-type="goSearchRollupCalc"]');return o.dataset.colType=l.key.type,n.calc&&(o.dataset.calc=n.calc.operator),!0}})})}},$t=e=>{var t;let n=document.querySelector(".av__panel");if(n){n.remove();return}const a=e.blockElement.getAttribute("data-av-id");A("/api/av/renderAttributeView",{id:a,query:((t=e.blockElement.querySelector('[data-type="av-search"]'))==null?void 0:t.value.trim())||"",pageSize:parseInt(e.blockElement.getAttribute("data-page-size"))||void 0,viewID:e.blockElement.getAttribute(f.CUSTOM_SY_AV_VIEW)},s=>{var i;if(n=document.querySelector(".av__panel"),n){n.remove();return}window.siyuan.menus.menu.remove();const l=e.blockElement.getAttribute("data-node-id"),o=!e.blockElement.classList.contains("av"),r=s.data;let c;if(e.type==="config")c=sr(r);else if(e.type==="properties")c=la(r.view);else if(e.type==="sorts")c=Ka(r.view.columns,r.view.sorts);else if(e.type==="switcher")c=Du(r.views,r.viewID);else if(e.type==="filters")c=oa(r.view);else if(e.type==="select")c=za(r.view,e.cellElements,!0);else if(e.type==="asset")c=lc(e.cellElements);else if(e.type==="edit")e.editData&&(e.editData.previousID?r.view.columns.find((b,y)=>{if(b.id===e.editData.previousID)return r.view.columns.splice(y+1,0,e.editData.colData),!0}):r.view.columns.splice(0,0,e.editData.colData)),c=Ln({protyle:e.protyle,data:r,colId:e.colId,isCustomAttr:o});else if(e.type==="date")c=Gf(e.cellElements);else if(e.type==="rollup")c=`<div class="b3-menu__items">${mc({data:r,cellElements:e.cellElements})}</div>`;else if(e.type==="relation"&&(c=Nu(r,e.cellElements),!c)){$t({protyle:e.protyle,blockElement:e.blockElement,type:"edit",colId:e.cellElements[0].dataset.colId});return}document.body.insertAdjacentHTML("beforeend",`<div class="av__panel" style="z-index: ${++window.siyuan.zIndex}">
    <div class="b3-dialog__scrim" data-type="close"></div>
    <div class="b3-menu">${c}</div>
</div>`),n=document.querySelector(".av__panel");let d;const u=n.lastElementChild;let p=(i=e.blockElement.querySelector(`.av__views, .av__row[data-col-id="${e.colId}"] > .block__logo`))==null?void 0:i.getBoundingClientRect();if(["select","date","asset","relation","rollup"].includes(e.type)){const b=e.cellElements[e.cellElements.length-1].getBoundingClientRect();if(e.type==="select"?Va(e.protyle,r,u,e.cellElements,e.blockElement):e.type==="date"?d=Kf({protyle:e.protyle,data:r,menuElement:u,cellElements:e.cellElements,blockElement:e.blockElement}):e.type==="asset"?(sc({protyle:e.protyle,menuElement:u,cellElements:e.cellElements,blockElement:e.blockElement}),setTimeout(()=>{ke(u,b.left,b.bottom,b.height)},f.TIMEOUT_LOAD)):e.type==="relation"?Hu({menuElement:u,cellElements:e.cellElements,protyle:e.protyle,blockElement:e.blockElement}):e.type==="rollup"&&bc({protyle:e.protyle,data:r,menuElement:u}),["select","date","relation","rollup"].includes(e.type)){const y=u.querySelector("input");y&&(y.select(),y.focus()),ke(u,b.left,b.bottom,b.height)}}else ke(u,p.right-u.clientWidth,p.bottom,p.height),e.type==="sorts"?Ga(e.protyle,u,r,l):e.type==="edit"?Sn({protyle:e.protyle,data:r,menuElement:u,isCustomAttr:o,blockID:l}):e.type==="config"?ir({protyle:e.protyle,data:r,menuElement:u,blockElement:e.blockElement}):e.type==="switcher"&&Iu({protyle:e.protyle,menuElement:u,blockElement:e.blockElement});e.cb&&e.cb(n),n.addEventListener("dragstart",b=>{window.siyuan.dragElement=b.target,window.siyuan.dragElement.style.opacity=".1"}),n.addEventListener("drop",b=>{var y,_,w,v;if(m=0,!window.siyuan.dragElement){b.preventDefault(),b.stopPropagation();return}window.siyuan.dragElement.style.opacity="";const h=window.siyuan.dragElement;if(window.siyuan.dragElement=void 0,e.protyle&&e.protyle.disabled){b.preventDefault(),b.stopPropagation();return}if(!e.protyle&&window.siyuan.config.readonly){b.preventDefault(),b.stopPropagation();return}const E=n.querySelector(".dragover__bottom, .dragover__top");if(!E)return;const S=E.classList.contains("dragover__top"),L=h.dataset.id,k=E.dataset.id;if(E.querySelector('[data-type="removeSort"]')){const x=r.view.sorts,C=Object.assign([],x);let T;x.find((I,P)=>{if(I.column===L)return T=x.splice(P,1)[0],!0}),x.find((I,P)=>{if(I.column===k)return S?x.splice(P,0,T):x.splice(P+1,0,T),!0}),q(e.protyle,[{action:"setAttrViewSorts",avID:a,data:x,blockID:l}],[{action:"setAttrViewSorts",avID:a,data:C,blockID:l}]),u.innerHTML=Ka(r.view.columns,r.view.sorts),Ga(e.protyle,u,r,l);return}if(E.querySelector('[data-type="removeFilter"]')){const x=r.view.filters,C=Object.assign([],x);let T;x.find((I,P)=>{if(I.column===L)return T=x.splice(P,1)[0],!0}),x.find((I,P)=>{if(I.column===k)return S?x.splice(P,0,T):x.splice(P+1,0,T),!0}),q(e.protyle,[{action:"setAttrViewFilters",avID:a,data:x,blockID:l}],[{action:"setAttrViewFilters",avID:a,data:C,blockID:l}]),u.innerHTML=oa(r.view);return}if(E.querySelector('[data-type="av-view-edit"]')){q(e.protyle,[{action:"sortAttrViewView",avID:a,blockID:l,id:L,previousID:S?(y=E.previousElementSibling)==null?void 0:y.getAttribute("data-id"):E.getAttribute("data-id")}],[{action:"sortAttrViewView",avID:a,blockID:l,id:L,previousID:(_=h.previousElementSibling)==null?void 0:_.getAttribute("data-id")}]),S?(E.before(h),E.classList.remove("dragover__top")):(E.after(h),E.classList.remove("dragover__bottom"));return}if(E.querySelector('[data-type="editAssetItem"]')){S?E.before(h):E.after(h);const x=[];Array.from(E.parentElement.children).forEach(C=>{C.dataset.content&&x.push({content:C.dataset.content,name:C.dataset.name,type:C.dataset.type})}),Ta({protyle:e.protyle,cellElements:e.cellElements,replaceValue:x,blockElement:e.blockElement});return}if(E.querySelector('[data-type="setColOption"]')){const x=e.cellElements?e.cellElements[0].dataset.colId:u.querySelector(".b3-menu__item").getAttribute("data-col-id"),C=r.view.columns.find(N=>N.id===x).options,T=Object.assign([],C);let I;C.find((N,R)=>{if(N.name===h.dataset.name)return I=C.splice(R,1)[0],!0}),C.find((N,R)=>{if(N.name===E.dataset.name)return S?C.splice(R,0,I):C.splice(R+1,0,I),!0}),q(e.protyle,[{action:"updateAttrViewColOptions",id:x,avID:a,data:C}],[{action:"updateAttrViewColOptions",id:x,avID:a,data:T}]);const P=u.querySelector(".b3-menu__items").scrollTop;e.cellElements?(u.innerHTML=za(r.view,e.cellElements),Va(e.protyle,r,u,e.cellElements,e.blockElement)):(u.innerHTML=Ln({protyle:e.protyle,data:r,colId:x,isCustomAttr:o}),Sn({protyle:e.protyle,data:r,menuElement:u,isCustomAttr:o,blockID:l})),u.querySelector(".b3-menu__items").scrollTop=P;return}if(E.getAttribute("data-type")==="setRelationCell"){S?E.before(h):E.after(h),E.classList.remove("dragover__bottom","dragover__top");const x=[],C=[];E.parentElement.querySelectorAll(".fn__grab").forEach(T=>{const I=T.nextElementSibling;x.push(I.dataset.id),C.push({isDetached:!I.style.color,type:"block",block:{content:I.textContent,id:I.dataset.id}})}),zt(e.protyle,e.blockElement,{blockIDs:x,contents:C},e.cellElements);return}if(E.getAttribute("data-type")==="editCol"){const x=(E.classList.contains("dragover__top")?(w=E.previousElementSibling)==null?void 0:w.getAttribute("data-id"):E.getAttribute("data-id"))||"",C=((v=h.previousElementSibling)==null?void 0:v.getAttribute("data-id"))||"";if(x!==C&&x!==L){q(e.protyle,[{action:"sortAttrViewCol",avID:a,previousID:x,id:L,blockID:l}],[{action:"sortAttrViewCol",avID:a,previousID:C,id:L,blockID:l}]);let T;r.view.columns.find((I,P)=>{if(I.id===L)return T=r.view.columns.splice(P,1)[0],!0}),r.view.columns.find((I,P)=>{if(I.id===k)return S?r.view.columns.splice(P,0,T):r.view.columns.splice(P+1,0,T),!0})}u.innerHTML=la(r.view);return}});let g;n.addEventListener("dragover",b=>{if(b.dataTransfer.types.includes("Files")){b.preventDefault();return}const y=b.target;let _=D(y,"draggable","true");if(_||(_=D(document.elementFromPoint(b.clientX,b.clientY-1),"draggable","true")),!(!_||_.isSameNode(window.siyuan.dragElement))){if(b.preventDefault(),g&&_.isSameNode(g)){const w=_.getBoundingClientRect();n.querySelectorAll(".dragover__bottom, .dragover__top").forEach(v=>{v.classList.remove("dragover__bottom","dragover__top")}),b.clientY>w.top+w.height/2?_.classList.add("dragover__bottom"):_.classList.add("dragover__top");return}g=_}});let m=0;n.addEventListener("dragleave",()=>{m--,m===0&&n.querySelectorAll(".dragover__bottom, .dragover__top").forEach(b=>{b.classList.remove("dragover__bottom","dragover__top")})}),n.addEventListener("dragenter",b=>{b.preventDefault(),m++}),n.addEventListener("dragend",()=>{window.siyuan.dragElement&&(window.siyuan.dragElement.style.opacity="",window.siyuan.dragElement=void 0)}),n.addEventListener("mousedown",b=>{b.button===1&&!$(b.target,"b3-menu")&&document.querySelector(".av__panel").dispatchEvent(new CustomEvent("click",{detail:"close"}))}),n.addEventListener("click",b=>{var y,_,w;let v;typeof b.detail=="string"&&(v=b.detail);let h=b.target;for(;h&&!h.isSameNode(n)||v;){if(v=(h==null?void 0:h.dataset.type)||v,v==="close"){e.protyle.toolbar.subElement.classList.contains("fn__none")?window.siyuan.menus.menu.element.classList.contains("fn__none")?(d==null||d(),n.remove(),ne(e.blockElement)):window.siyuan.menus.menu.remove():J(["util"],e.protyle),window.siyuan.menus.menu.remove(),b.preventDefault(),b.stopPropagation();break}else if(v==="go-config"){u.innerHTML=sr(r),ke(u,p.right-u.clientWidth,p.bottom,p.height),ir({protyle:e.protyle,data:r,menuElement:u,blockElement:e.blockElement}),window.siyuan.menus.menu.remove(),b.preventDefault(),b.stopPropagation();break}else if(v==="go-properties"){p=e.blockElement.querySelector(".av__views").getBoundingClientRect(),u.innerHTML=la(r.view),ke(u,p.right-u.clientWidth,p.bottom,p.height),window.siyuan.menus.menu.remove(),b.preventDefault(),b.stopPropagation();break}else if(v==="goSorts"){u.innerHTML=Ka(r.view.columns,r.view.sorts),Ga(e.protyle,u,r,l),ke(u,p.right-u.clientWidth,p.bottom,p.height),window.siyuan.menus.menu.remove(),b.preventDefault(),b.stopPropagation();break}else if(v==="removeSorts"){q(e.protyle,[{action:"setAttrViewSorts",avID:a,data:[],blockID:l}],[{action:"setAttrViewSorts",avID:a,data:r.view.sorts,blockID:l}]),r.view.sorts=[],u.innerHTML=Ka(r.view.columns,r.view.sorts),Ga(e.protyle,u,r,l),ke(u,p.right-u.clientWidth,p.bottom,p.height),b.preventDefault(),b.stopPropagation();break}else if(v==="addSort"){zf({data:r,rect:h.getBoundingClientRect(),menuElement:u,tabRect:p,avId:a,protyle:e.protyle,blockID:l}),b.preventDefault(),b.stopPropagation();break}else if(v==="removeSort"){const E=Object.assign([],r.view.sorts);r.view.sorts.find((S,L)=>{if(S.column===h.parentElement.dataset.id)return r.view.sorts.splice(L,1),!0}),q(e.protyle,[{action:"setAttrViewSorts",avID:a,data:r.view.sorts,blockID:l}],[{action:"setAttrViewSorts",avID:a,data:E,blockID:l}]),u.innerHTML=Ka(r.view.columns,r.view.sorts),Ga(e.protyle,u,r,l),ke(u,p.right-u.clientWidth,p.bottom,p.height),b.preventDefault(),b.stopPropagation();break}else if(v==="goFilters"){u.innerHTML=oa(r.view),ke(u,p.right-u.clientWidth,p.bottom,p.height),window.siyuan.menus.menu.remove(),b.preventDefault(),b.stopPropagation();break}else if(v==="removeFilters"){q(e.protyle,[{action:"setAttrViewFilters",avID:a,data:[],blockID:l}],[{action:"setAttrViewFilters",avID:a,data:r.view.filters,blockID:l}]),r.view.filters=[],u.innerHTML=oa(r.view),ke(u,p.right-u.clientWidth,p.bottom,p.height),window.siyuan.menus.menu.remove(),b.preventDefault(),b.stopPropagation();break}else if(v==="addFilter"){tg({data:r,rect:h.getBoundingClientRect(),menuElement:u,tabRect:p,avId:a,protyle:e.protyle,blockElement:e.blockElement}),b.preventDefault(),b.stopPropagation();break}else if(v==="removeFilter"){window.siyuan.menus.menu.remove();const E=Object.assign([],r.view.filters);r.view.filters.find((S,L)=>{if(S.column===h.parentElement.dataset.id&&S.value.type===h.parentElement.dataset.filterType)return r.view.filters.splice(L,1),!0}),q(e.protyle,[{action:"setAttrViewFilters",avID:a,data:r.view.filters,blockID:l}],[{action:"setAttrViewFilters",avID:a,data:E,blockID:l}]),u.innerHTML=oa(r.view),ke(u,p.right-u.clientWidth,p.bottom,p.height),b.preventDefault(),b.stopPropagation();break}else if(v==="setFilter"){r.view.filters.find(E=>{if(E.column===h.parentElement.parentElement.dataset.id&&E.value.type===h.parentElement.parentElement.dataset.filterType)return Ul({filter:E,protyle:e.protyle,data:r,target:h,blockElement:e.blockElement}),!0}),b.preventDefault(),b.stopPropagation();break}else if(v==="numberFormat"){Zf({avPanelElement:n,element:h,protyle:e.protyle,oldFormat:h.dataset.format,colId:u.querySelector(".b3-menu__item").getAttribute("data-col-id"),avID:a}),b.preventDefault(),b.stopPropagation();break}else if(v==="newCol"){n.remove(),Ii(e.protyle,e.blockElement).open({x:p.right,y:p.bottom,h:p.height,isLeft:!0}),b.preventDefault(),b.stopPropagation();break}else if(v==="update-view-icon"){const E=h.getBoundingClientRect();_a("","av",{x:E.left,y:E.bottom+4,h:E.height,w:E.width},S=>{q(e.protyle,[{action:"setAttrViewViewIcon",avID:a,id:r.viewID,data:S}],[{action:"setAttrViewViewIcon",id:r.viewID,avID:a,data:h.dataset.icon}]),h.innerHTML=S?ge(S):'<svg style="width: 14px;height: 14px;"><use xlink:href="#iconTable"></use></svg>',h.dataset.icon=S},h.querySelector("img")),b.preventDefault(),b.stopPropagation();break}else if(v==="set-page-size"){Bc({target:h,protyle:e.protyle,avID:a,nodeElement:e.blockElement}),b.preventDefault(),b.stopPropagation();break}else if(v==="duplicate-view"){const E=Lute.NewNodeID();q(e.protyle,[{action:"duplicateAttrViewView",avID:a,previousID:r.viewID,id:E,blockID:l}],[{action:"removeAttrViewView",avID:a,id:E,blockID:l}]),e.blockElement.setAttribute(f.CUSTOM_SY_AV_VIEW,E),n.remove(),b.preventDefault(),b.stopPropagation();break}else if(v==="delete-view"){q(e.protyle,[{action:"removeAttrViewView",avID:a,id:r.viewID,blockID:l}]),n.remove(),b.preventDefault(),b.stopPropagation();break}else if(v==="update-icon"){const E=h.getBoundingClientRect();_a("","av",{x:E.left,y:E.bottom+4,h:E.height,w:E.width},S=>{const L=u.querySelector(".b3-menu__item").getAttribute("data-col-id");if(q(e.protyle,[{action:"setAttrViewColIcon",id:L,avID:a,data:S}],[{action:"setAttrViewColIcon",id:L,avID:a,data:h.dataset.icon}]),h.innerHTML=S?ge(S):`<svg style="height: 14px;width: 14px"><use xlink:href="#${_t(h.dataset.colType)}"></use></svg>`,o){const k=e.blockElement.querySelector(`.av__row[data-col-id="${L}"] .block__logoicon`);k.outerHTML=S?ge(S,"block__logoicon",!0):`<svg class="block__logoicon"><use xlink:href="#${_t(k.nextElementSibling.getAttribute("data-type"))}"></use></svg>`}else Tt(e.blockElement.querySelector(`.av__row--header .av__cell[data-col-id="${L}"]`),void 0,{icon:S});h.dataset.icon=S},h.querySelector("img")),b.preventDefault(),b.stopPropagation();break}else if(v==="showAllCol"){const E=[],S=[];r.view.columns.forEach(L=>{L.hidden&&(E.push({action:"setAttrViewColHidden",id:L.id,avID:a,data:!1,blockID:l}),S.push({action:"setAttrViewColHidden",id:L.id,avID:a,data:!0,blockID:l}),L.hidden=!1)}),E.length>0&&(q(e.protyle,E,S),u.innerHTML=la(r.view),ke(u,p.right-u.clientWidth,p.bottom,p.height)),b.preventDefault(),b.stopPropagation();break}else if(v==="hideAllCol"){const E=[],S=[];r.view.columns.forEach(L=>{!L.hidden&&L.type!=="block"&&(E.push({action:"setAttrViewColHidden",id:L.id,avID:a,data:!0,blockID:l}),S.push({action:"setAttrViewColHidden",id:L.id,avID:a,data:!1,blockID:l}),L.hidden=!0)}),E.length>0&&(q(e.protyle,E,S),u.innerHTML=la(r.view),ke(u,p.right-u.clientWidth,p.bottom,p.height)),b.preventDefault(),b.stopPropagation();break}else if(v==="editCol"){u.innerHTML=Ln({protyle:e.protyle,data:r,colId:h.dataset.id,isCustomAttr:o}),Sn({protyle:e.protyle,data:r,menuElement:u,isCustomAttr:o,blockID:l}),ke(u,p.right-u.clientWidth,p.bottom,p.height),b.preventDefault(),b.stopPropagation();break}else if(v==="updateColType"){if(h.dataset.newType!==h.dataset.oldType){const S=n.querySelector('.b3-text-field[data-type="name"]').value;let L=S;if(r.view.columns.find(k=>{if(k.id===e.colId)return k.type=h.dataset.newType,Za(h.dataset.oldType)===S&&(L=Za(h.dataset.newType),k.name=L),!0}),q(e.protyle,[{action:"updateAttrViewCol",id:e.colId,avID:a,name:L,type:h.dataset.newType}],[{action:"updateAttrViewCol",id:e.colId,avID:a,name:S,type:h.dataset.oldType}]),h.dataset.newType==="lineNumber"){if(r.view.sorts.find(C=>C.column===e.colId)){const C=Object.assign([],r.view.sorts),T=r.view.sorts.filter(I=>I.column!==e.colId);q(e.protyle,[{action:"setAttrViewSorts",avID:r.id,data:T,blockID:l}],[{action:"setAttrViewSorts",avID:r.id,data:C,blockID:l}])}if(r.view.filters.find(C=>C.column===e.colId)){const C=JSON.parse(JSON.stringify(r.view.filters)),T=r.view.filters.filter(I=>I.column!==e.colId);q(e.protyle,[{action:"setAttrViewFilters",avID:r.id,data:T,blockID:l}],[{action:"setAttrViewFilters",avID:r.id,data:C,blockID:l}])}}}u.innerHTML=Ln({protyle:e.protyle,data:r,colId:e.colId,isCustomAttr:o}),Sn({protyle:e.protyle,data:r,menuElement:u,isCustomAttr:o,blockID:l}),ke(u,p.right-u.clientWidth,p.bottom,p.height),b.preventDefault(),b.stopPropagation();break}else if(v==="goUpdateColType"){const E=$(h,"b3-menu");E&&(E.firstElementChild.classList.add("fn__none"),E.lastElementChild.classList.remove("fn__none")),ke(u,p.right-u.clientWidth,p.bottom,p.height),b.preventDefault(),b.stopPropagation();break}else if(v==="goSearchAV"){_i(a,h,void 0,!1),b.preventDefault(),b.stopPropagation();break}else if(v==="goSearchRollupCol"){pc({target:h,data:r,isRelation:!0,protyle:e.protyle,colId:e.colId||u.querySelector(".b3-menu__item").getAttribute("data-col-id")}),b.preventDefault(),b.stopPropagation();break}else if(v==="goSearchRollupTarget"){pc({target:h,data:r,isRelation:!1,protyle:e.protyle,colId:e.colId||u.querySelector(".b3-menu__item").getAttribute("data-col-id")}),b.preventDefault(),b.stopPropagation();break}else if(v==="goSearchRollupCalc"){ar(e.protyle,h,{data:r,colId:e.colId||u.querySelector(".b3-menu__item").getAttribute("data-col-id"),blockID:l}),b.preventDefault(),b.stopPropagation();break}else if(v==="updateRelation"){Mu({protyle:e.protyle,avElement:n,avID:a,colsData:r.view.columns,blockElement:e.blockElement}),b.preventDefault(),b.stopPropagation();break}else if(v==="goEditCol"){const E=$(h,"b3-menu");E&&(E.firstElementChild.classList.remove("fn__none"),E.lastElementChild.classList.add("fn__none")),ke(u,p.right-u.clientWidth,p.bottom,p.height),b.preventDefault(),b.stopPropagation();break}else if(v==="hideCol"){const E=u.querySelector('[data-type="go-properties"]'),S=E?u.querySelector(".b3-menu__item").getAttribute("data-col-id"):h.parentElement.getAttribute("data-id");q(e.protyle,[{action:"setAttrViewColHidden",id:S,avID:a,data:!0,blockID:l}],[{action:"setAttrViewColHidden",id:S,avID:a,data:!1,blockID:l}]),r.view.columns.find(L=>L.id===S).hidden=!0,E?(u.innerHTML=Ln({protyle:e.protyle,data:r,colId:S,isCustomAttr:o}),Sn({protyle:e.protyle,data:r,menuElement:u,isCustomAttr:o,blockID:l})):u.innerHTML=la(r.view),ke(u,p.right-u.clientWidth,p.bottom,p.height),b.preventDefault(),b.stopPropagation();break}else if(v==="showCol"){const E=u.querySelector('[data-type="go-properties"]'),S=E?u.querySelector(".b3-menu__item").getAttribute("data-col-id"):h.parentElement.getAttribute("data-id");q(e.protyle,[{action:"setAttrViewColHidden",id:S,avID:a,data:!1,blockID:l}],[{action:"setAttrViewColHidden",id:S,avID:a,data:!0,blockID:l}]),r.view.columns.find(L=>L.id===S).hidden=!1,E?(u.innerHTML=Ln({protyle:e.protyle,data:r,colId:S,isCustomAttr:o}),Sn({protyle:e.protyle,data:r,menuElement:u,isCustomAttr:o,blockID:l})):u.innerHTML=la(r.view),ke(u,p.right-u.clientWidth,p.bottom,p.height),b.preventDefault(),b.stopPropagation();break}else if(v==="duplicateCol"){vc({blockElement:e.blockElement,protyle:e.protyle,colId:u.querySelector(".b3-menu__item").getAttribute("data-col-id"),data:r,viewID:r.viewID}),b.preventDefault(),b.stopPropagation();break}else if(v==="removeCol"){o||(p=e.blockElement.querySelector(".av__views").getBoundingClientRect());const E=u.querySelector(".b3-menu__item").getAttribute("data-col-id"),S=r.view.columns.find(k=>{if(k.id===E)return!0}),L=S.type==="relation"&&((y=S.relation)==null?void 0:y.isTwoWay);if(o||L){const k=new we({title:L?window.siyuan.languages.removeCol.replace("${x}",u.querySelector("input").value):window.siyuan.languages.deleteOpConfirm,content:`<div class="b3-dialog__content">
    ${L?window.siyuan.languages.confirmRemoveRelationField.replace("${x}",u.querySelector('.b3-menu__item[data-type="goSearchAV"] .b3-menu__accelerator').textContent):window.siyuan.languages.removeCol.replace("${x}",u.querySelector("input").value)}
    <div class="fn__hr--b"></div>
    <button class="fn__block b3-button b3-button--remove" data-action="delete">${window.siyuan.languages.delete}</button>
    <div class="fn__hr"></div>
    <button class="fn__block b3-button b3-button--remove${L?"":" fn__none"}" data-action="keep-relation">${window.siyuan.languages.removeButKeepRelationField}</button>
    <div class="fn__hr"></div>
    <button class="fn__block b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button>
</div>`});k.element.addEventListener("click",x=>{let C=x.target;const T=typeof x.detail=="string";for(;C&&!C.isSameNode(k.element)||T;){const I=C.getAttribute("data-action");if(I==="delete"||T&&x.detail==="Enter"){Fl({protyle:e.protyle,data:r,avID:a,blockID:l,menuElement:u,isCustomAttr:o,blockElement:e.blockElement,avPanelElement:n,tabRect:p,isTwoWay:!0}),k.destroy();break}else if(I==="keep-relation"){Fl({protyle:e.protyle,data:r,avID:a,blockID:l,menuElement:u,isCustomAttr:o,blockElement:e.blockElement,avPanelElement:n,tabRect:p,isTwoWay:!1}),k.destroy();break}else if(C.classList.contains("b3-button--cancel")||T&&x.detail==="Escape"){k.destroy();break}C=C.parentElement}}),k.element.setAttribute("data-key",f.DIALOG_CONFIRM)}else Fl({protyle:e.protyle,data:r,avID:a,blockID:l,menuElement:u,isCustomAttr:o,blockElement:e.blockElement,avPanelElement:n,tabRect:p,isTwoWay:!1});b.preventDefault(),b.stopPropagation();break}else if(v==="setColOption"){Vf(e.protyle,r,h,e.blockElement,o,e.cellElements),b.preventDefault(),b.stopPropagation();break}else if(v==="setRelationCell"){dr(e.protyle,e.blockElement,h,e.cellElements),b.preventDefault(),b.stopPropagation();break}else if(v==="addColOptionOrCell"){h.querySelector(".b3-menu__checked")?vs(e.protyle,e.cellElements,u.querySelector(`.b3-chips .b3-chip[data-content="${We(h.dataset.name)}"]`),e.blockElement):cc(e.protyle,r,e.cellElements,h,u,e.blockElement),window.siyuan.menus.menu.remove(),b.preventDefault(),b.stopPropagation();break}else if(v==="removeCellOption"){vs(e.protyle,e.cellElements,h.parentElement,e.blockElement),b.preventDefault(),b.stopPropagation();break}else if(v==="addAssetLink"){Wf(e.protyle,e.cellElements,h,e.blockElement),b.preventDefault(),b.stopPropagation();break}else if(v==="addAssetExist"){const E=h.getBoundingClientRect();Tl(e.protyle,{x:E.right,y:E.bottom,w:h.parentElement.clientWidth+8,h:E.height},(S,L)=>{let k;f.SIYUAN_ASSETS_IMAGE.includes(me().extname(S).toLowerCase())?k={type:"image",content:S,name:""}:k={type:"file",content:S,name:L},Ta({protyle:e.protyle,cellElements:e.cellElements,addValue:[k],blockElement:e.blockElement}),window.siyuan.menus.menu.remove()}),b.preventDefault(),b.stopPropagation();break}else if(v==="openAssetItem"){const E=h.parentElement.dataset.content,S=me().extname(E);f.SIYUAN_ASSETS_IMAGE.includes(S)?wi(E):window.open(E),b.preventDefault(),b.stopPropagation();break}else if(v==="editAssetItem"){_s({protyle:e.protyle,cellElements:e.cellElements,blockElement:e.blockElement,content:h.parentElement.dataset.content,type:h.parentElement.dataset.type,name:h.parentElement.dataset.name,index:parseInt(h.parentElement.dataset.index),rect:h.parentElement.getBoundingClientRect()}),b.preventDefault(),b.stopPropagation();break}else if(v==="clearDate"){zt(e.protyle,e.blockElement,{isNotEmpty2:!1,isNotEmpty:!1,content:null,content2:null,hasEndDate:!1,isNotTime:!0},e.cellElements),n.remove(),b.preventDefault(),b.stopPropagation();break}else if(v==="av-add"){window.siyuan.menus.menu.remove(),or(e.protyle,e.blockElement),n.remove(),b.preventDefault(),b.stopPropagation();break}else if(v==="av-view-switch"){h.parentElement.classList.contains("b3-menu__item--current")||((_=n.querySelector(".b3-menu__item--current"))==null||_.classList.remove("b3-menu__item--current"),h.parentElement.classList.add("b3-menu__item--current"),e.blockElement.removeAttribute("data-render"),ze(e.blockElement,e.protyle,void 0,h.parentElement.dataset.id)),b.preventDefault(),b.stopPropagation();break}else if(v==="av-view-edit"){h.parentElement.classList.contains("b3-menu__item--current")?hi({protyle:e.protyle,blockElement:e.blockElement,element:h.parentElement}):((w=n.querySelector(".b3-menu__item--current"))==null||w.classList.remove("b3-menu__item--current"),h.parentElement.classList.add("b3-menu__item--current"),e.blockElement.removeAttribute("data-render"),ze(e.blockElement,e.protyle,()=>{hi({protyle:e.protyle,blockElement:e.blockElement,element:h.parentElement}),n.querySelector(".b3-chip--primary").classList.remove("b3-chip--primary"),h.parentElement.querySelector(".b3-chip").classList.add("b3-chip--primary")},h.parentElement.dataset.id)),b.preventDefault(),b.stopPropagation();break}if(!h||!h.parentElement)break;h=h.parentElement}})})},la=e=>{let t="",n="";return e.columns.forEach(a=>{a.hidden?n+=`<button class="b3-menu__item" data-type="editCol" draggable="true" data-id="${a.id}">
    <svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>
    <div class="b3-menu__label fn__flex">
        ${a.icon?ge(a.icon,"b3-menu__icon",!0):`<svg class="b3-menu__icon"><use xlink:href="#${_t(a.type)}"></use></svg>`}
        ${pe(a.name)||"&nbsp;"}
    </div>
    <svg class="b3-menu__action" data-type="showCol"><use xlink:href="#iconEye"></use></svg>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>`:t+=`<button class="b3-menu__item" data-type="editCol" draggable="true" data-id="${a.id}">
    <svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>
    <div class="b3-menu__label fn__flex">
        ${a.icon?ge(a.icon,"b3-menu__icon",!0):`<svg class="b3-menu__icon"><use xlink:href="#${_t(a.type)}"></use></svg>`}
        ${pe(a.name)||"&nbsp;"}
    </div>
    <svg class="b3-menu__action${a.type==="block"?" fn__none":""}" data-type="hideCol"><use xlink:href="#iconEyeoff"></use></svg>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>`}),n&&(n=`<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="nobg">
    <span class="b3-menu__label">
        ${window.siyuan.languages.hideCol} 
    </span>
    <span class="block__icon" data-type="showAllCol">
        ${window.siyuan.languages.showAll}
        <span class="fn__space"></span>
        <svg><use xlink:href="#iconEye"></use></svg>
    </span>
</button>
${n}`),`<div class="b3-menu__items">
<button class="b3-menu__item" data-type="nobg">
    <span class="block__icon" style="padding: 8px;margin-left: -4px;" data-type="go-config">
        <svg><use xlink:href="#iconLeft"></use></svg>
    </span>
    <span class="b3-menu__label ft__center">${window.siyuan.languages.fields}</span>
</button>
<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="nobg">
    <span class="b3-menu__label">
        ${window.siyuan.languages.showCol} 
    </span>
    <span class="block__icon" data-type="hideAllCol">
        ${window.siyuan.languages.hideAll}
        <span class="fn__space"></span>
        <svg><use xlink:href="#iconEyeoff"></use></svg>
    </span>
</button>
${t}
${n}
<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="newCol">
    <svg class="b3-menu__icon"><use xlink:href="#iconAdd"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.new}</span>
</button>
</div>`},yc=e=>{let t=e,n="";try{const a=new URL(e);a.protocol.startsWith("http")&&(t=a.host,n=a.href.replace(a.origin,""),n.length>12&&(n=n.substring(0,4)+"..."+n.substring(n.length-6)))}catch(a){t=Lute.EscapeHTMLStr(e)}return`<span class="av__celltext av__celltext--url" data-type="url" data-href="${We(e)}"><span>${t}</span><span class="ft__on-surface">${n}</span></span>`},Es=e=>{if(!e)return"";let t="";const n=e.querySelectorAll(".b3-chip, .av__celltext--ref, .av__celltext");return n.length>0?(n.forEach(a=>{a.querySelector(".av__cellicon")?t+=`${a.firstChild.textContent} \u2192 ${a.lastChild.textContent}, `:a.getAttribute("data-type")==="url"?t=a.getAttribute("data-href")+", ":a.getAttribute("data-type")!=="block-more"&&(t+=a.textContent+", ")}),t=t.substring(0,t.length-2)):t=e.textContent,t},gn=(e,t)=>{var n;const a={type:e,id:t.dataset.id};if(e==="number"){const s=t.querySelector(".av__celltext").getAttribute("data-content");a.number={content:parseFloat(s)||0,isNotEmpty:!!s}}else if(["text","block","url","phone","email","template"].includes(e)){const s=t.querySelector(".av__celltext");a[e]={content:e==="url"?s.dataset.href:s.textContent},e==="block"&&s.dataset.id&&(a.block.id=s.dataset.id,(n=s.previousElementSibling)!=null&&n.classList.contains("b3-menu__avemoji")&&(a.block.icon=s.previousElementSibling.getAttribute("data-unicode")))}else if(e==="mSelect"||e==="select"){const s=[];t.querySelectorAll(".b3-chip").forEach(i=>{s.push({content:i.textContent.trim(),color:i.style.color.replace("var(--b3-font-color","").replace(")","")})}),a.mSelect=s}else if(["date","created","updated"].includes(e))a[e]=JSON.parse(t.querySelector(".av__celltext").getAttribute("data-value"));else if(e==="checkbox")a.checkbox={checked:t.querySelector("use").getAttribute("xlink:href")==="#iconCheck"};else if(e==="relation"){const s=[],i=[];Array.from(t.querySelectorAll(".av__cell--relation")).forEach(l=>{const o=l.querySelector(".av__celltext");s.push(o.dataset.id),i.push({isDetached:!o.classList.contains("av__celltext--ref"),block:{content:o.textContent,id:o.dataset.id},type:"block"})}),a.relation={blockIDs:s,contents:i}}else if(e==="mAsset"){const s=[];Array.from(t.children).forEach(i=>{if(i.classList.contains("av__drag-fill"))return;const l=i.classList.contains("av__cellassetimg");s.push({type:l?"image":"file",content:l?i.getAttribute("src"):i.getAttribute("data-url"),name:l?"":i.getAttribute("data-name")})}),a.mAsset=s}return e==="block"&&(a.isDetached=t.dataset.detached==="true"),a},Bn=(e,t)=>{let n={type:e,[e==="select"?"mSelect":e]:t};if(typeof t=="string"&&t){if(e==="number")n={type:e,number:{content:parseFloat(t)||0,isNotEmpty:!0}};else if(["text","block","url","phone","email","template"].includes(e))n={type:e,[e]:{content:t}};else if(e==="mSelect"||e==="select")n={type:e,mSelect:[{content:t,color:"1"}]};else if(e==="checkbox")n={type:e,checkbox:{checked:!0}};else if(e==="date"){let a=t.split("\u2192");a.length!==2&&(a=t.split("-"),a.length!==2&&(a=t.split("~")));const s=U(a[0]),i=U(a[1]||"");isNaN(s.valueOf())?n={type:e,date:{content:null,isNotEmpty:!1,content2:null,isNotEmpty2:!1,formattedContent:"",hasEndDate:!1,isNotTime:!0}}:n={type:e,date:{content:s.valueOf(),isNotEmpty:!0,content2:i.valueOf()||0,isNotEmpty2:!isNaN(i.valueOf()),hasEndDate:!isNaN(i.valueOf()),isNotTime:s.hour()===0,formattedContent:""}}}else if(e==="relation")n={type:e,relation:{blockIDs:[t],contents:[]}};else if(e==="mAsset"){const a=me().extname(t).toLowerCase();n={type:e,mAsset:[{type:f.SIYUAN_ASSETS_IMAGE.includes(a)?"image":"file",content:t,name:""}]}}}else(typeof t=="undefined"||!t)&&(e==="number"?n={type:e,number:{content:null,isNotEmpty:!1}}:["text","block","url","phone","email","template"].includes(e)?n={type:e,[e]:{content:""}}:e==="mSelect"||e==="select"||e==="mAsset"?n={type:e,[e==="select"?"mSelect":e]:[]}:["date","created","updated"].includes(e)?n={type:e,[e]:{content:null,isNotEmpty:!1,content2:null,isNotEmpty2:!1,hasEndDate:!1,isNotTime:!0}}:e==="checkbox"?n={type:e,checkbox:{checked:!1}}:e==="relation"?n={type:e,relation:{blockIDs:[],contents:[]}}:e==="rollup"&&(n={type:e,rollup:{contents:[]}}));return e==="block"&&(typeof t=="object"&&t.id?n.isDetached=!1:n.isDetached=!0),n},Qn=(e,t,n=!0)=>{const a=t.getBoundingClientRect();if(!n){const i=e.querySelector(".av__scroll"),l=$(t,"av__row");if(i&&l){const o=l.querySelector(".av__colsticky");if(!o.contains(t)){const r=o.getBoundingClientRect().right,c=i.getBoundingClientRect();r>a.left||c.right<a.left?i.scrollLeft=i.scrollLeft+a.left-r:r<a.left&&c.right<a.right&&(a.width+r>c.right?i.scrollLeft=i.scrollLeft+a.left-r:i.scrollLeft=i.scrollLeft+a.right-c.right)}}}const s=$(e,"protyle-content",!0);if(s&&t.getAttribute("data-dtype")!=="checkbox"){const i=document.getElementById("keyboardToolbar"),l=parseInt(i.getAttribute("data-keyboardheight"))||window.outerHeight/2-42;a.bottom>window.innerHeight-l-42?s.scrollTop+=a.bottom-window.innerHeight+42+l:a.top<110&&(s.scrollTop-=110-a.top)}},Bt=e=>{const t=$(e,"av__scroll");if(t)return t.querySelector(".av__row--header").querySelector(`[data-col-id="${e.getAttribute("data-col-id")}"]`).getAttribute("data-dtype")},rn=(e,t,n)=>{var a;if(t.length===0||t.length===1&&!t[0]||(n||(n=Bt(t[0])),n==="updated"||n==="created"||document.querySelector(".av__mask")))return;const s=B(t[0]);if(!s)return;let i=t[0].getBoundingClientRect();const l=$(s,"protyle-content",!0);Qn(s,t[0],!1),i=t[0].getBoundingClientRect();let o="",r=i.height,c;if(l){const g=l.getBoundingClientRect();i.bottom>g.bottom&&(r=g.bottom-i.top);const m=Math.min(Math.max(i.width,25),g.width);c=`style="padding-top: 6.5px;position:absolute;left: ${i.left<g.left||i.left+m>g.right?g.left:i.left}px;top: ${i.top}px;width:${m}px;height: ${r}px"`}else c=`style="padding-top: 6.5px;position:absolute;left: ${i.left}px;top: ${i.top}px;width:${Math.max(i.width,25)}px;height: ${r}px"`;if(["text","email","phone","block","template"].includes(n))o=`<textarea ${c} spellcheck="false" class="b3-text-field"></textarea>`;else if(n==="url")o=`<textarea ${c} spellcheck="false" class="b3-text-field">${t[0].firstElementChild.getAttribute("data-href")}</textarea>`;else if(n==="number")o=`<input type="number" spellcheck="false" value="${t[0].firstElementChild.getAttribute("data-content")}" ${c} class="b3-text-field">`;else{["select","mSelect"].includes(n)?$t({protyle:e,blockElement:s,type:"select",cellElements:t}):n==="mAsset"?($t({protyle:e,blockElement:s,type:"asset",cellElements:t}),ne(s)):n==="date"?$t({protyle:e,blockElement:s,type:"date",cellElements:t}):n==="checkbox"?Rl(e,n,s,t):n==="relation"?$t({protyle:e,blockElement:s,type:"relation",cellElements:t}):n==="rollup"&&$t({protyle:e,blockElement:s,type:"rollup",cellElements:t,colId:t[0].dataset.colId}),$(t[0],"custom-attr")||(t[0].classList.add("av__cell--select"),Gt(t[0]));return}window.siyuan.menus.menu.remove(),document.body.insertAdjacentHTML("beforeend",`<div class="av__mask" style="z-index: ${++window.siyuan.zIndex}">
    ${o}
</div>`);const d=document.querySelector(".av__mask"),u=d.querySelector(".b3-text-field");u&&(["text","email","phone","block","template"].includes(n)&&(u.value=((a=t[0].querySelector(".av__celltext"))==null?void 0:a.textContent)||""),u.select(),u.focus(),n==="template"&&A("/api/av/renderAttributeView",{id:s.dataset.avId,viewID:s.getAttribute(f.CUSTOM_SY_AV_VIEW)},g=>{g.data.view.columns.find(m=>{if(m.id===t[0].dataset.colId)return u.value=m.template,u.dataset.template=m.template,!0})}),n==="block"&&u.addEventListener("input",g=>{if(f.BLOCK_HINT_KEYS.includes(u.value.substring(0,2))){if(e.toolbar.range=document.createRange(),!s.contains(t[0])){const b=$(t[0],"av__row");t[0]&&(t[0]=s.querySelector(`.av__row[data-id="${b.dataset.id}"] .av__cell[data-col-id="${t[0].dataset.colId}"]`))}e.toolbar.range.selectNodeContents(t[0].lastChild),X(e.toolbar.range),t[0].classList.add("av__cell--select"),Gt(t[0]);let m=u.value;In(m)?m=m.substring(2,22+2):m=m.substring(2),fa(m,e,"av"),d==null||d.remove(),g.preventDefault(),g.stopPropagation()}}),u.addEventListener("keydown",g=>{g.isComposing||Zn(g)||(g.key==="Escape"||g.key==="Tab"||g.key==="Enter"&&!g.shiftKey&&Ue(g))&&(Rl(e,n,s,t),g.key==="Tab"&&e.wysiwyg.element.dispatchEvent(new KeyboardEvent("keydown",{shiftKey:g.shiftKey,ctrlKey:g.ctrlKey,altKey:g.altKey,metaKey:g.metaKey,key:"Tab",keyCode:9})),g.preventDefault(),g.stopPropagation())}));const p=g=>{g.target.classList.contains("av__mask")&&document.activeElement.tagName!=="TEXTAREA"&&document.activeElement.tagName!=="INPUT"&&(Rl(e,n,s,t),d==null||d.remove())};d.addEventListener("click",g=>{p(g)}),d.addEventListener("contextmenu",g=>{p(g)}),d.addEventListener("mousedown",g=>{g.button===1&&(g.target.classList.contains("av__mask")&&document.activeElement&&document.activeElement.nodeType===1&&document.activeElement.blur(),p(g))})},Rl=(e,t,n,a)=>{const s=$(a[0],"av__row");if(!s||a.length===1&&a[0].dataset.detached==="true"&&!s.dataset.id)return;const i=document.querySelector(".av__mask"),l=n.getAttribute("data-av-id");if(t==="template"){const o=a[0].getAttribute("data-col-id"),r=i.querySelector(".b3-text-field");r.value!==r.dataset.template&&!n.getAttribute("data-loading")&&(q(e,[{action:"updateAttrViewColTemplate",id:o,avID:l,data:r.value,type:"template"}],[{action:"updateAttrViewColTemplate",id:o,avID:l,data:r.dataset.template,type:"template"}]),n.setAttribute("data-loading","true"))}else zt(e,n,t==="checkbox"?{checked:a[0].querySelector("use").getAttribute("xlink:href")==="#iconUncheck"}:i.querySelector(".b3-text-field").value,a);a[0]&&!$(a[0],"custom-attr")&&(a[0].classList.add("av__cell--select"),Gt(a[0])),document.querySelector(".b3-dialog")||ne(n),document.querySelectorAll(".av__mask").forEach(o=>{o.remove()})},zt=(e,t,n,a,s,i)=>{const l=[],o=[],r=t.dataset.avId,c=t.dataset.nodeId;let d="";const u=[];let p;(a==null?void 0:a.length)>0?p=a:(p=Array.from(t.querySelectorAll(".av__cell--active, .av__cell--select")),p.length===0&&t.querySelectorAll(".av__row--select:not(.av__row--header)").forEach(m=>{m.querySelectorAll(".av__cell").forEach(b=>{p.push(b)})}));const g=$(p[0],"custom-attr");return p.forEach((m,b)=>{const y=$(m,"av__row");if(!y||(t.contains(m)||(m=p[b]=t.querySelector(`.av__row[data-id="${y.dataset.id}"] .av__cell[data-col-id="${m.dataset.colId}"]`)||t.querySelector(`.fn__flex-1[data-col-id="${m.dataset.colId}"]`)),!m))return;const _=Bt(m)||m.dataset.type;if(["created","updated","template","rollup"].includes(_))return;const w=y.getAttribute("data-id"),v=m.dataset.id,h=m.dataset.colId;d+=Es(m)+(p[b+1]&&m.nextElementSibling&&m.nextElementSibling.isSameNode(p[b+1])?"	":`

`);const E=gn(_,m);(b===0||!p[b-1].isSameNode(m.previousElementSibling))&&u.push([]),u[u.length-1].push(E);let S=n;if(_==="mAsset"){if(Array.isArray(n))S=E.mAsset.concat(n);else if(typeof n!="undefined"){let k=e.lute.GetLinkDest(n),x="",C="";if(!k&&n.startsWith("assets/")&&(k=n,x=ll(n)+me().extname(n)),i){const T=document.createElement("template");T.innerHTML=i;const I=T.content.querySelector('[data-type~="a"]');if(I)k=I.getAttribute("data-href"),x=I.textContent;else{const P=T.content.querySelector(".img img");P&&(C=P.getAttribute("data-src"))}}if(k||(x=n),!k&&!x&&!C)return;C?S=E.mAsset.concat({type:"image",content:C,name:""}):S=E.mAsset.concat({type:"file",content:k,name:x})}}else if(_==="mSelect"){if(typeof n=="string"){const k=[];let x=E.mSelect.length;[...new Set(n.split(",").map(C=>C.trim().replace(/\n|\r\n|\r|\u2028|\u2029/g,"")))].forEach(C=>{if(!C)return;let T=!1;E.mSelect.find(I=>{if(I.content===C)return T=!0,!0}),!T&&(x++,k.push({content:C,color:x.toString()}))}),S=E.mSelect.concat(k)}}else _==="block"&&typeof n=="string"&&E.block.id&&(S={content:n,id:E.block.id},E.block.icon&&(S.icon=E.block.icon));const L=Bn(_,S);if(L.id=v,!(L.type==="date"&&typeof L.date=="string"||L.type==="relation"&&typeof L.relation=="string")){if(s&&(_==="select"||_==="mSelect")){const k=dc(s.find(x=>x.id===h),L,r);l.push(...k.doOperations),o.push(...k.undoOperations)}kt(L,E)||(l.push({action:"updateAttrViewCell",id:v,avID:r,keyID:h,rowID:w,data:L}),o.push({action:"updateAttrViewCell",id:v,avID:r,keyID:h,rowID:w,data:E}),g?m.innerHTML=Jn(L):Tt(m,L))}}),l.length>0&&(l.push({action:"doUpdateUpdated",id:c,data:U().format("YYYYMMDDHHmmss")}),o.push({action:"doUpdateUpdated",id:c,data:t.getAttribute("updated")}),q(e,l,o)),{text:d.substring(0,d.length-2),json:u}},Bl=(e,t)=>{t.type==="checkbox"?t.checkbox.checked?(e.classList.add("av__cell-check"),e.classList.remove("av__cell-uncheck")):(e.classList.remove("av__cell-check"),e.classList.add("av__cell-uncheck")):t.type==="block"&&(t.block.id&&e.setAttribute("data-block-id",t.block.id),t.isDetached?e.setAttribute("data-detached","true"):e.removeAttribute("data-detached"))},Ti=(e,t=0)=>{var n,a,s,i,l,o,r,c,d,u;let p="";if(e.type==="template")p=`<span class="av__celltext">${e&&e.template.content||""}</span>`;else if(e.type==="text")p=`<span class="av__celltext">${e?Lute.EscapeHTMLStr(e.text.content||""):""}</span>`;else if(["email","phone"].includes(e.type))p=`<span class="av__celltext av__celltext--url" data-type="${e.type}">${e?Lute.EscapeHTMLStr(e[e.type].content||""):""}</span>`;else if(e.type==="url")p=yc(((n=e==null?void 0:e.url)==null?void 0:n.content)||"");else if(e.type==="block")e!=null&&e.isDetached?p=`<span class="av__celltext">${Lute.EscapeHTMLStr(e.block.content||"")}</span><span class="b3-chip b3-chip--info b3-chip--small" data-type="block-more">${window.siyuan.languages.more}</span>`:p=`<span class="b3-menu__avemoji" data-unicode="${e.block.icon||""}">${ge(e.block.icon||window.siyuan.storage[f.LOCAL_IMAGES].file)}</span><span data-type="block-ref" data-id="${e.block.id}" data-subtype="s" class="av__celltext av__celltext--ref">${Lute.EscapeHTMLStr(e.block.content)}</span><span class="b3-chip b3-chip--info b3-chip--small" data-type="block-more">${window.siyuan.languages.update}</span>`;else if(e.type==="number")p=`<span class="av__celltext" data-content="${e!=null&&e.number.isNotEmpty?e==null?void 0:e.number.content:""}">${(e==null?void 0:e.number.formattedContent)||(e==null?void 0:e.number.content)||""}</span>`;else if(e.type==="mSelect"||e.type==="select")(a=e==null?void 0:e.mSelect)==null||a.forEach((g,m)=>{e.type==="select"&&m>0||(p+=`<span class="b3-chip" style="background-color:var(--b3-font-background${g.color});color:var(--b3-font-color${g.color})">${pe(g.content)}</span>`)});else if(e.type==="date"){const g=e?e.date:null;p=`<span class="av__celltext" data-value='${JSON.stringify(g)}'>`,g&&g.isNotEmpty&&(p+=U(g.content).format(g.isNotTime?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")),g&&g.hasEndDate&&g.isNotEmpty&&g.isNotEmpty2&&(p+=`<svg class="av__cellicon"><use xlink:href="#iconForward"></use></svg>${U(g.content2).format(g.isNotTime?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")}`),p+="</span>"}else if(["created","updated"].includes(e.type)){const g=e?e[e.type]:null;p=`<span class="av__celltext" data-value='${JSON.stringify(g)}'>`,g&&g.isNotEmpty&&(p+=U(g.content).format("YYYY-MM-DD HH:mm")),p+="</span>"}else["lineNumber"].includes(e.type)?p=`<span class="av__celltext" data-value='${t+1}'>${t+1}</span>`:e.type==="mAsset"?(s=e==null?void 0:e.mAsset)==null||s.forEach(g=>{g.type==="image"?p+=`<img class="av__cellassetimg ariaLabel" aria-label="${g.content}" src="${g.content}">`:p+=`<span class="b3-chip av__celltext--url ariaLabel" aria-label="${We(g.content)}" data-name="${We(g.name)}" data-url="${We(g.content)}">${g.name||g.content}</span>`}):e.type==="checkbox"?p+=`<svg class="av__checkbox"><use xlink:href="#icon${(i=e==null?void 0:e.checkbox)!=null&&i.checked?"Check":"Uncheck"}"></use></svg>`:e.type==="rollup"?((o=(l=e==null?void 0:e.rollup)==null?void 0:l.contents)==null||o.forEach(g=>{const m=["select","mSelect","mAsset","checkbox","relation"].includes(g.type)?Ti(g):Xf(g);m&&(p+=m+", ")}),p&&p.endsWith(", ")&&(p=p.substring(0,p.length-2))):e.type==="relation"&&((c=(r=e==null?void 0:e.relation)==null?void 0:r.contents)==null||c.forEach(g=>{var m;g&&g.block&&(g!=null&&g.isDetached?p+=`<span class="av__cell--relation"><span>\u2796 </span><span class="av__celltext" data-id="${(m=g.block)==null?void 0:m.id}">${Lute.EscapeHTMLStr(g.block.content||window.siyuan.languages.untitled)}</span></span>`:p+=`<span class="av__cell--relation" data-block-id="${g.block.id}"><span class="b3-menu__avemoji" data-unicode="${g.block.icon||""}">${ge(g.block.icon||window.siyuan.storage[f.LOCAL_IMAGES].file)}</span><span data-type="block-ref" data-id="${g.block.id}" data-subtype="s" class="av__celltext av__celltext--ref">${Lute.EscapeHTMLStr(g.block.content||window.siyuan.languages.untitled)}</span></span>`)}),p&&p.endsWith(", ")&&(p=p.substring(0,p.length-2)));return(["text","template","url","email","phone","number","date","created","updated"].includes(e.type)&&((d=e[e.type])!=null&&d.content)||e.type==="lineNumber"||e.type==="block"&&((u=e.block)!=null&&u.content))&&(p+=`<span ${e.type!=="number"?"":'style="right:auto;left:5px"'} data-type="copy" class="block__icon"><svg><use xlink:href="#iconCopy"></use></svg></span>`),p},Xf=e=>{var t,n,a,s,i;let l="";if(["text"].includes(e.type))l=e&&e[e.type].content||"";else if(["email","phone"].includes(e.type)){const o=e?e[e.type].content:"";o&&(l=`<span class="av__celltext av__celltext--url" data-type="${e.type}">${o}</span>`)}else if(e.type==="url"){const o=((t=e==null?void 0:e.url)==null?void 0:t.content)||"";o&&(l=yc(o))}else if(e.type==="block")e!=null&&e.isDetached?l=`<span class="av__celltext" data-id="${(n=e.block)==null?void 0:n.id}">${Lute.EscapeHTMLStr(((a=e.block)==null?void 0:a.content)||window.siyuan.languages.untitled)}</span>`:l=`<span data-type="block-ref" data-id="${(s=e.block)==null?void 0:s.id}" data-subtype="s" class="av__celltext av__celltext--ref">${Lute.EscapeHTMLStr(((i=e.block)==null?void 0:i.content)||window.siyuan.languages.untitled)}</span>`;else if(e.type==="number")l=(e==null?void 0:e.number.formattedContent)||(e==null?void 0:e.number.content.toString())||"";else if(e.type==="date"){const o=e?e.date:null;o.formattedContent?l=o.formattedContent:(o&&o.isNotEmpty&&(l=U(o.content).format(o.isNotTime?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")),o&&o.hasEndDate&&o.isNotEmpty&&o.isNotEmpty2&&(l=`<svg class="av__cellicon"><use xlink:href="#iconForward"></use></svg>${U(o.content2).format(o.isNotTime?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")}`)),l&&(l=`<span class="av__celltext">${l}</span>`)}return l},Jf=(e,t)=>{var n;if(typeof t.icon!="undefined"&&(e.dataset.icon=t.icon,e.querySelector(".av__cellheadericon").outerHTML=t.icon?ge(t.icon,"av__cellheadericon",!0):`<svg class="av__cellheadericon"><use xlink:href="#${_t(e.dataset.dtype)}"></use></svg>`),typeof t.name!="undefined"&&(e.querySelector(".av__celltext").textContent=t.name),typeof t.pin!="undefined"){const a=e.querySelector(".av__celltext");t.pin?e.querySelector(".av__cellheadericon--pin")||a.insertAdjacentHTML("afterend",'<svg class="av__cellheadericon av__cellheadericon--pin"><use xlink:href="#iconPin"></use></svg>'):(n=e.querySelector(".av__cellheadericon--pin"))==null||n.remove()}},$i=e=>{let t=$(e,"av__row");if(!t)return;let n=-1;for(;t;)t=t.previousElementSibling,n++;let a=-2;for(;e;)e=e.previousElementSibling,e&&e.classList.contains("av__colsticky")&&(e=e.lastElementChild),a++;return{rowIndex:n,celIndex:a}},Qf=(e,t,n,a)=>{var s;(s=t.querySelector(".av__drag-fill"))==null||s.remove();const i={};t.querySelectorAll(".av__cell--active").forEach(d=>{if(a.includes(d.dataset.id))return;const u=$(d,"av__row");if(!u)return;i[u.dataset.id]||(i[u.dataset.id]=[]);const p=gn(Bt(d),d);p.colId=d.dataset.colId,p.element=d,i[u.dataset.id].push(p)});const l=[],o=[],r=t.dataset.avId,c=Object.keys(n);Object.keys(i).forEach((d,u)=>{i[d].forEach((p,g)=>{if(["rollup","template","created","updated"].includes(p.type)||p.type==="block"&&p.element.getAttribute("data-detached")!=="true")return;const m=JSON.parse(JSON.stringify(n[c[u%c.length]][g]));m.id=p.id;const b=p.colId;m.type==="block"&&(m.isDetached=!0,delete m.block.id),l.push({action:"updateAttrViewCell",id:p.id,avID:r,keyID:b,rowID:d,data:m}),p.element.innerHTML=Ti(m),Bl(p.element,m),delete p.colId,delete p.element,o.push({action:"updateAttrViewCell",id:p.id,avID:r,keyID:b,rowID:d,data:p})})}),ne(t),l.length>0&&q(e,l,o)},Gt=e=>{e&&(e.classList.add("av__cell--active"),e.querySelector(".av__drag-fill")||e.insertAdjacentHTML("beforeend",`<div aria-label="${window.siyuan.languages.dragFill}" class="av__drag-fill ariaLabel"></div>`))};var eg=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{o(n.next(r))}catch(c){s(c)}},l=r=>{try{o(n.throw(r))}catch(c){s(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,l);o((n=n.apply(e,t)).next())});const wc=e=>{if(["select","number","date","created","updated"].includes(e))return"=";if(["checkbox"].includes(e))return"Is false";if(["rollup","relation","rollup","text","mSelect","url","block","email","phone","template"].includes(e))return"Contains"},hc=(e,t,n)=>{const a=$(e,"b3-menu");if(a){if(["date","updated","created"].includes(n)){const s=a.querySelector('.b3-menu__item div[data-type="filter1"]'),i=s.nextElementSibling;t==="Is between"?(i.classList.remove("fn__none"),s.classList.remove("fn__none")):t==="Is empty"||t==="Is not empty"?(i.classList.add("fn__none"),s.classList.add("fn__none")):(s.classList.remove("fn__none"),i.classList.add("fn__none"));return}a.querySelectorAll("input, .b3-chip").forEach(s=>{const i=$(s,"b3-menu__item");i&&(t!=="Is empty"&&t!=="Is not empty"?i.classList.remove("fn__none"):i.classList.add("fn__none"))})}},_c=e=>{window.siyuan.menus.menu.element.querySelectorAll(".b3-menu__item").forEach(t=>{const n=t.querySelector(".b3-chip.b3-chip--middle");if(n){const a=n.dataset.name.toLowerCase();!e||e.indexOf(a)>-1||a.indexOf(e)>-1?t.classList.remove("fn__none"):t.classList.add("fn__none")}})},Ul=e=>eg(void 0,null,function*(){var t,n,a,s,i,l,o,r,c,d,u,p,g,m,b,y,_,w;let v=e.target.getBoundingClientRect();v.height===0&&(v=e.protyle.wysiwyg.element.querySelector(`[data-col-id="${e.target.dataset.colId}"]`).getBoundingClientRect());const h=e.blockElement.getAttribute("data-node-id"),E=new Ke("set-filter-"+e.filter.column,()=>{const P=JSON.parse(JSON.stringify(e.data.view.filters)),N=E.element.querySelector(".b3-select");if(!N||!N.value)return;const R={column:e.filter.column,value:{type:e.filter.value.type},operator:N.value};let V=!1,W;if(k.type==="select"||k.type==="mSelect"){const fe=[];window.siyuan.menus.menu.element.querySelectorAll("svg").forEach(be=>{if(be.firstElementChild.getAttribute("xlink:href")==="#iconCheck"){const pt=be.nextElementSibling.firstElementChild;fe.push({color:pt.dataset.color,content:pt.dataset.name})}}),W=Bn(k.type,fe)}else if(["date","updated","created"].includes(k.type)){const fe=E.element.querySelector('.b3-select[data-type="dateType"]'),be=E.element.querySelectorAll('.b3-select[data-type="dataDirection"]');fe.value==="custom"?(R.relativeDate={count:parseInt(be[0].parentElement.querySelector(".b3-text-field").value||"1"),unit:parseInt(be[0].parentElement.lastElementChild.value),direction:parseInt(be[0].value)},R.relativeDate2={count:parseInt(be[1].parentElement.querySelector(".b3-text-field").value||"1"),unit:parseInt(be[1].parentElement.lastElementChild.value),direction:parseInt(be[1].value)},W={type:k.type}):(W=Bn(k.type,{isNotEmpty2:I[2].value!=="",isNotEmpty:I[0].value!=="",content:I[0].value?new Date(I[0].value+" 00:00").getTime():null,content2:I[2].value?new Date(I[2].value+" 00:00").getTime():null,hasEndDate:R.operator==="Is between",isNotTime:!0}),R.relativeDate=null,R.relativeDate2=null)}else["text","url","block","email","phone","template","relation","number"].includes(k.type)?W=Bn(k.type,I[0].value):k.type==="checkbox"?W=Bn(k.type,{checked:R.operator==="Is true"}):W=Bn(k.type,void 0);e.filter.value.type==="rollup"?R.value={rollup:{contents:[W]},type:"rollup"}:R.value=W;let se=!1;if(e.data.view.filters.find((fe,be)=>{if(fe.column===e.filter.column&&fe.value.type===e.filter.value.type)return fe.value.type==="checkbox"?(V=!0,e.data.view.filters[be]=R,!0):kt(fe,R)?(se=!0,!0):(e.data.view.filters[be]=R,V=!0,!0)}),se||!V)return;q(e.protyle,[{action:"setAttrViewFilters",avID:e.data.id,data:e.data.view.filters,blockID:h}],[{action:"setAttrViewFilters",avID:e.data.id,data:P,blockID:h}]);const Ce=$(e.target,"b3-menu");Ce&&(Ce.innerHTML=oa(e.data.view))});if(E.isOpen)return;let S="",L;e.data.view.columns.find(P=>{if(P.id===e.filter.column)return L=P,!0});let k=JSON.parse(JSON.stringify(e.filter.value));if(L.type==="rollup"){if(!L.rollup||!L.rollup.relationKeyID||!L.rollup.keyID){ae(window.siyuan.languages.plsChoose),$t({protyle:e.protyle,blockElement:e.blockElement,type:"edit",colId:L.id});return}let P="";e.data.view.columns.find(R=>{if(R.id===L.rollup.relationKeyID)return P=R.relation.avID,!0}),(yield Ye("/api/av/getAttributeView",{id:P})).data.av.keyValues.find(R=>{if(R.key.id===L.rollup.keyID)return k.type=R.key.type,!0}),e.data.view.filters.find(R=>{if(R.column===L.id&&R.value.type==="rollup")return!R.value.rollup||!R.value.rollup.contents||R.value.rollup.contents.length===0?k={[k.type]:Bn(k.type,k.type==="checkbox"?{checked:void 0}:""),type:k.type}:k=R.value.rollup.contents[0],!0})}let x=!1;switch(k.type==="checkbox"&&(x=typeof k.checkbox=="undefined"||typeof k.checkbox.checked=="undefined"),k.type){case"checkbox":S=`<option ${e.filter.operator==="Is true"&&!x?"selected":""} value="Is true">${window.siyuan.languages.checked}</option>
<option ${e.filter.operator==="Is false"&&!x?"selected":""} value="Is false">${window.siyuan.languages.unchecked}</option>`,x&&(S=`<option selected></option>${S}`);break;case"block":case"text":case"url":case"phone":case"email":S=`<option ${e.filter.operator==="="?"selected":""} value="=">${window.siyuan.languages.filterOperatorIs}</option>
<option ${e.filter.operator==="!="?"selected":""} value="!=">${window.siyuan.languages.filterOperatorIsNot}</option>
<option ${e.filter.operator==="Contains"?"selected":""} value="Contains">${window.siyuan.languages.filterOperatorContains}</option>
<option ${e.filter.operator==="Does not contains"?"selected":""} value="Does not contains">${window.siyuan.languages.filterOperatorDoesNotContain}</option>
<option ${e.filter.operator==="Starts with"?"selected":""} value="Starts with">${window.siyuan.languages.filterOperatorStartsWith}</option>
<option ${e.filter.operator==="Ends with"?"selected":""} value="Ends with">${window.siyuan.languages.filterOperatorEndsWith}</option>
<option ${e.filter.operator==="Is empty"?"selected":""} value="Is empty">${window.siyuan.languages.filterOperatorIsEmpty}</option>
<option ${e.filter.operator==="Is not empty"?"selected":""} value="Is not empty">${window.siyuan.languages.filterOperatorIsNotEmpty}</option>`;break;case"template":S=`<option ${e.filter.operator==="="?"selected":""} value="=">${window.siyuan.languages.filterOperatorIs}</option>
<option ${e.filter.operator==="!="?"selected":""} value="!=">${window.siyuan.languages.filterOperatorIsNot}</option>
<option ${e.filter.operator==="Contains"?"selected":""} value="Contains">${window.siyuan.languages.filterOperatorContains}</option>
<option ${e.filter.operator==="Does not contains"?"selected":""} value="Does not contains">${window.siyuan.languages.filterOperatorDoesNotContain}</option>
<option ${e.filter.operator==="Starts with"?"selected":""} value="Starts with">${window.siyuan.languages.filterOperatorStartsWith}</option>
<option ${e.filter.operator==="Ends with"?"selected":""} value="Ends with">${window.siyuan.languages.filterOperatorEndsWith}</option>
<option ${e.filter.operator==="Is empty"?"selected":""} value="Is empty">${window.siyuan.languages.filterOperatorIsEmpty}</option>
<option ${e.filter.operator==="Is not empty"?"selected":""} value="Is not empty">${window.siyuan.languages.filterOperatorIsNotEmpty}</option>
<option ${e.filter.operator===">"?"selected":""} value=">">&gt;</option>
<option ${e.filter.operator==="<"?"selected":""} value="<">&lt;</option>
<option ${e.filter.operator===">="?"selected":""} value=">=">&GreaterEqual;</option>
<option ${e.filter.operator==="<="?"selected":""} value="<=">&le;</option>`;break;case"date":case"created":case"updated":S=`<option ${e.filter.operator==="="?"selected":""} value="=">${window.siyuan.languages.filterOperatorIs}</option>
<option ${e.filter.operator===">"?"selected":""} value=">">${window.siyuan.languages.filterOperatorIsAfter}</option>
<option ${e.filter.operator==="<"?"selected":""} value="<">${window.siyuan.languages.filterOperatorIsBefore}</option>
<option ${e.filter.operator===">="?"selected":""} value=">=">${window.siyuan.languages.filterOperatorIsOnOrAfter}</option>
<option ${e.filter.operator==="<="?"selected":""} value="<=">${window.siyuan.languages.filterOperatorIsOnOrBefore}</option>
<option ${e.filter.operator==="Is between"?"selected":""} value="Is between">${window.siyuan.languages.filterOperatorIsBetween}</option>
<option ${e.filter.operator==="Is empty"?"selected":""} value="Is empty">${window.siyuan.languages.filterOperatorIsEmpty}</option>
<option ${e.filter.operator==="Is not empty"?"selected":""} value="Is not empty">${window.siyuan.languages.filterOperatorIsNotEmpty}</option>`;break;case"number":S=`<option ${e.filter.operator==="="?"selected":""} value="=">=</option>
<option ${e.filter.operator==="!="?"selected":""} value="!=">!=</option>
<option ${e.filter.operator===">"?"selected":""} value=">">&gt;</option>
<option ${e.filter.operator==="<"?"selected":""} value="<">&lt;</option>
<option ${e.filter.operator===">="?"selected":""} value=">=">&GreaterEqual;</option>
<option ${e.filter.operator==="<="?"selected":""} value="<=">&le;</option>
<option ${e.filter.operator==="Is empty"?"selected":""} value="Is empty">${window.siyuan.languages.filterOperatorIsEmpty}</option>
<option ${e.filter.operator==="Is not empty"?"selected":""} value="Is not empty">${window.siyuan.languages.filterOperatorIsNotEmpty}</option>`;break;case"mSelect":case"relation":S=`<option ${e.filter.operator==="Contains"?"selected":""} value="Contains">${window.siyuan.languages.filterOperatorContains}</option>
<option ${e.filter.operator==="Does not contains"?"selected":""} value="Does not contains">${window.siyuan.languages.filterOperatorDoesNotContain}</option>
<option ${e.filter.operator==="Is empty"?"selected":""} value="Is empty">${window.siyuan.languages.filterOperatorIsEmpty}</option>
<option ${e.filter.operator==="Is not empty"?"selected":""} value="Is not empty">${window.siyuan.languages.filterOperatorIsNotEmpty}</option>`;break;case"select":S=`<option ${e.filter.operator==="="?"selected":""} value="=">${window.siyuan.languages.filterOperatorIs}</option>
<option ${e.filter.operator==="!="?"selected":""} value="!=">${window.siyuan.languages.filterOperatorIsNot}</option>
<option ${e.filter.operator==="Is empty"?"selected":""} value="Is empty">${window.siyuan.languages.filterOperatorIsEmpty}</option>
<option ${e.filter.operator==="Is not empty"?"selected":""} value="Is not empty">${window.siyuan.languages.filterOperatorIsNotEmpty}</option>`;break}if(E.addItem({iconHTML:"",type:"readonly",label:`<select style="margin: 4px 0" class="b3-select fn__size200">${S}</select>`}),k.type==="select"||k.type==="mSelect")((t=L.options)==null?void 0:t.length)>0&&E.addItem({iconHTML:"",type:"readonly",label:`<input class="b3-text-field fn__size200" style="margin: 4px 0" placeholder="${window.siyuan.languages.search}">`,bind(P){const N=P.querySelector("input");N.addEventListener("keydown",R=>{if(R.isComposing)return;let V=Wt(E.element.querySelector(".b3-menu__items"),R,"b3-menu__item--current",P.nextElementSibling);R.key==="Enter"&&(V||(V=E.element.querySelector(".b3-menu__item--current")),V.dispatchEvent(new CustomEvent("click")))}),N.addEventListener("input",R=>{R.isComposing||_c(N.value.toLowerCase())}),N.addEventListener("compositionend",()=>{_c(N.value.toLowerCase())})}}),(n=L.options)==null||n.forEach(P=>{var N;let R="iconUncheck";(N=k==null?void 0:k.mSelect)==null||N.find(V=>{V.content===P.name&&(R="iconCheck")}),E.addItem({icon:R,label:`<span class="b3-chip b3-chip--middle" data-name="${P.name}" data-color="${P.color}" style="max-width: 178px;margin:3px 0;background-color:var(--b3-font-background${P.color});color:var(--b3-font-color${P.color})">
    <span class="fn__ellipsis">${P.name}</span>
</span>`,bind(V){V.addEventListener("click",()=>{const W=V.querySelector("use");W.getAttribute("xlink:href")==="#iconUncheck"?W.setAttribute("xlink:href","#iconCheck"):W.setAttribute("xlink:href","#iconUncheck")})}})});else if(["text","url","block","email","phone","template","relation"].includes(k.type)){let P="";k&&(k.type==="relation"?P=k.relation.blockIDs[0]||"":P=k[k.type].content||""),E.addItem({iconHTML:"",type:"readonly",label:`<input style="margin: 4px 0" value="${P}" class="b3-text-field fn__size200">`})}else if(k.type==="number")E.addItem({iconHTML:"",type:"readonly",label:`<input style="margin: 4px 0" value="${k!=null&&k.number.isNotEmpty?k.number.content:""}" class="b3-text-field fn__size200">`});else if(["date","updated","created"].includes(k.type)){const P=k?k[k.type]:null,N=!((a=e.filter.relativeDate)!=null&&a.direction),R=!((s=e.filter.relativeDate2)!=null&&s.direction);E.addItem({iconHTML:"",type:"readonly",label:`<div data-type="filter1">
    <div class="fn__size200">
        <select class="b3-select fn__block" data-type="dateType">
            <option value="time"${e.filter.relativeDate?"":" selected"}>${window.siyuan.languages.includeTime}</option>
            <option value="custom"${e.filter.relativeDate?" selected":""}>${window.siyuan.languages.relativeToToday}</option>
        </select>
    </div>
    <div class="fn__hr"></div>
    <div class="fn__size200 ${e.filter.relativeDate?"fn__none":""}">
        <input value="${P&&(P.isNotEmpty||k.type!=="date")?U(P.content).format("YYYY-MM-DD"):""}" type="date" max="9999-12-31" class="b3-text-field fn__block">
    </div>
    <div class="fn__flex fn__size200 ${e.filter.relativeDate?"":"fn__none"}">
        <select class="b3-select" data-type="dataDirection">
            <option value="-1"${((i=e.filter.relativeDate)==null?void 0:i.direction)===-1?" selected":""}>${window.siyuan.languages.pastDate}</option>
            <option value="1"${((l=e.filter.relativeDate)==null?void 0:l.direction)===1?" selected":""}>${window.siyuan.languages.nextDate}</option>
            <option value="0"${N?" selected":""}>${window.siyuan.languages.current}</option>
        </select>
        <span class="fn__space"></span>
        <input type="number" min="1" oninput="this.value = Math.max(this.value, 1)" step="1" value="${((o=e.filter.relativeDate)==null?void 0:o.count)||1}" class="b3-text-field fn__flex-1${N?" fn__none":""}"/>
        <span class="fn__space${N?" fn__none":""}"></span>
        <select class="b3-select fn__flex-1">
            <option value="0"${((r=e.filter.relativeDate)==null?void 0:r.unit)===0?" selected":""}>${window.siyuan.languages.day}</option>
            <option value="1"${!e.filter.relativeDate||((c=e.filter.relativeDate)==null?void 0:c.unit)===1?" selected":""}>${window.siyuan.languages.week}</option>
            <option value="2"${((d=e.filter.relativeDate)==null?void 0:d.unit)===2?" selected":""}>${window.siyuan.languages.month}</option>
            <option value="3"${((u=e.filter.relativeDate)==null?void 0:u.unit)===3?" selected":""}>${window.siyuan.languages.year}</option>
        </select>
    </div>
    <div class="fn__hr--small"></div>
</div>
<div data-type="filter2 fn__none">
    <div class="fn__hr--small"></div>
    <div class="fn__size200 ${e.filter.relativeDate2?"fn__none":""}">
        <input value="${P&&P.isNotEmpty2?U(P.content2).format("YYYY-MM-DD"):""}" type="date" max="9999-12-31" class="b3-text-field fn__block">
    </div>
    <div class="fn__flex fn__size200 ${e.filter.relativeDate2?"":"fn__none"}">
        <select class="b3-select" data-type="dataDirection">
            <option value="-1"${((p=e.filter.relativeDate2)==null?void 0:p.direction)===-1?" selected":""}>${window.siyuan.languages.pastDate}</option>
            <option value="1"${((g=e.filter.relativeDate2)==null?void 0:g.direction)===1?" selected":""}>${window.siyuan.languages.nextDate}</option>
            <option value="0"${R?" selected":""}>${window.siyuan.languages.current}</option>
        </select>
        <span class="fn__space"></span>
        <input type="number" min="1" step="1" oninput="this.value = Math.max(this.value, 1)" value="${((m=e.filter.relativeDate2)==null?void 0:m.count)||1}" class="b3-text-field fn__flex-1${R?" fn__none":""}"/>
        <span class="fn__space${R?" fn__none":""}"></span>
        <select class="b3-select fn__flex-1">
            <option value="0"${((b=e.filter.relativeDate2)==null?void 0:b.unit)===0?" selected":""}>${window.siyuan.languages.day}</option>
            <option value="1"${!e.filter.relativeDate2||((y=e.filter.relativeDate2)==null?void 0:y.unit)===1?" selected":""}>${window.siyuan.languages.week}</option>
            <option value="2"${((_=e.filter.relativeDate2)==null?void 0:_.unit)===2?" selected":""}>${window.siyuan.languages.month}</option>
            <option value="3"${((w=e.filter.relativeDate2)==null?void 0:w.unit)===3?" selected":""}>${window.siyuan.languages.year}</option>
        </select>
    </div>
    <div class="fn__hr--small"></div>
</div>`})}E.addItem({icon:"iconTrashcan",label:window.siyuan.languages.removeFilters,click(){const P=Object.assign([],e.data.view.filters);e.data.view.filters.find((R,V)=>{if(R.column===e.filter.column&&e.filter.value.type===R.value.type)return e.data.view.filters.splice(V,1),!0}),q(e.protyle,[{action:"setAttrViewFilters",avID:e.data.id,data:e.data.view.filters,blockID:h}],[{action:"setAttrViewFilters",avID:e.data.id,data:P,blockID:h}]);const N=$(e.target,"b3-menu");N&&(N.innerHTML=oa(e.data.view))}});const C=E.element.querySelector(".b3-select");C.addEventListener("change",()=>{hc(C,C.value,k.type)});const T=E.element.querySelector('.b3-select[data-type="dateType"]');T==null||T.addEventListener("change",()=>{const P=E.element.querySelectorAll('[data-type="dataDirection"]'),N=P[0].parentElement,R=P[1].parentElement,V=N.previousElementSibling,W=R.previousElementSibling;T.value==="custom"?(N.classList.remove("fn__none"),R.classList.remove("fn__none"),V.classList.add("fn__none"),W.classList.add("fn__none")):(N.classList.add("fn__none"),R.classList.add("fn__none"),V.classList.remove("fn__none"),W.classList.remove("fn__none"))}),E.element.querySelectorAll('.b3-select[data-type="dataDirection"]').forEach(P=>{P.addEventListener("change",()=>{const N=P.nextElementSibling.nextElementSibling;P.value==="0"?(N.classList.add("fn__none"),N.nextElementSibling.classList.add("fn__none")):(N.classList.remove("fn__none"),N.nextElementSibling.classList.remove("fn__none"))})});const I=E.element.querySelectorAll(".b3-text-field");k.type!=="select"&&k.type!=="mSelect"&&I.forEach(P=>{P.addEventListener("keydown",N=>{if(N.isComposing){N.preventDefault();return}N.key==="Enter"&&(E.close(),N.preventDefault())})}),hc(C,C.value,k.type),E.open({x:v.left,y:v.bottom}),I.length>0&&I[0].select()}),tg=e=>{const t=new Ke("av-add-filter");e.data.view.columns.forEach(n=>{let a;e.data.view.filters.find(s=>{if(s.column===n.id&&s.value.type===n.type)return a=s,!0}),!a&&n.type!=="mAsset"&&n.type!=="lineNumber"&&t.addItem({label:n.name,iconHTML:n.icon?ge(n.icon,"b3-menu__icon",!0):`<svg class="b3-menu__icon"><use xlink:href="#${_t(n.type)}"></use></svg>`,click:()=>{const s=Bn(n.type,n.type==="checkbox"?{checked:void 0}:"");a={column:n.id,operator:wc(n.type),value:s},e.data.view.filters.push(a),e.menuElement.innerHTML=oa(e.data.view),ke(e.menuElement,e.tabRect.right-e.menuElement.clientWidth,e.tabRect.bottom,e.tabRect.height);const i=e.menuElement.querySelector(`[data-id="${n.id}"] .b3-chip`);Ul({filter:a,protyle:e.protyle,data:e.data,target:i,blockElement:e.blockElement})}})}),t.open({x:e.rect.left,y:e.rect.bottom,h:e.rect.height})},oa=e=>{let t="";const n=a=>{let s="";return e.columns.find(i=>{var l,o,r,c,d;if(i.id===a.column&&i.type===a.value.type){let u="";const p=i.type==="rollup"?((o=(l=a.value.rollup)==null?void 0:l.contents)==null?void 0:o.length)>0?a.value.rollup.contents[0]:{type:"rollup"}:a.value;if(a.operator==="Is empty")u=": "+window.siyuan.languages.filterOperatorIsEmpty;else if(a.operator==="Is not empty")u=": "+window.siyuan.languages.filterOperatorIsNotEmpty;else if(a.operator==="Is false")(p.type!=="checkbox"||typeof p.checkbox.checked=="boolean")&&(u=": "+window.siyuan.languages.unchecked);else if(a.operator==="Is true")(p.type!=="checkbox"||typeof p.checkbox.checked=="boolean")&&(u=": "+window.siyuan.languages.checked);else if(["created","updated","date"].includes(p.type)){let g="",m="";a.relativeDate?(g=`${window.siyuan.languages[["pastDate","current","nextDate"][a.relativeDate.direction+1]]}
 ${a.relativeDate.direction?a.relativeDate.count:""}
 ${window.siyuan.languages[["day","week","month","year"][a.relativeDate.unit]]}`,a.relativeDate2&&(m=`${window.siyuan.languages[["pastDate","current","nextDate"][a.relativeDate2.direction+1]]}
 ${a.relativeDate2.direction?a.relativeDate2.count:""}
 ${window.siyuan.languages[["day","week","month","year"][a.relativeDate2.unit]]}`)):p&&((r=p[p.type])!=null&&r.content)&&(g=U(p[p.type].content).format("YYYY-MM-DD"),m=U(p[p.type].content2).format("YYYY-MM-DD")),g&&(a.operator==="Is between"?u=` ${window.siyuan.languages.filterOperatorIsBetween} ${g} ${m}`:a.operator==="="?u=`: ${g}`:[">","<"].includes(a.operator)?u=` ${a.operator} ${g}`:a.operator===">="?u=` \u2265 ${g}`:a.operator==="<="&&(u=` \u2264 ${g}`))}else if(["mSelect","select"].includes(p.type)&&((c=p.mSelect)==null?void 0:c.length)>0){let g="";p.mSelect.forEach((m,b)=>{g+=m.content,b!==p.mSelect.length-1&&(g+=", ")}),a.operator==="Contains"?u=`: ${g}`:a.operator==="Does not contains"?u=` ${window.siyuan.languages.filterOperatorDoesNotContain} ${g}`:a.operator==="="?u=`: ${g}`:a.operator==="!="&&(u=` ${window.siyuan.languages.filterOperatorIsNot} ${g}`)}else if(p.type==="number"&&p.number&&p.number.isNotEmpty)["=","!=",">","<"].includes(a.operator)?u=` ${a.operator} ${p.number.content}`:a.operator===">="?u=` \u2265 ${p.number.content}`:a.operator==="<="&&(u=` \u2264 ${p.number.content}`);else if(["text","block","url","phone","email","relation","template"].includes(p.type)&&p[p.type]){const g=p[p.type].content||((d=p.relation)==null?void 0:d.blockIDs[0])||"";["=","Contains"].includes(a.operator)?u=`: ${g}`:a.operator==="Does not contains"?u=` ${window.siyuan.languages.filterOperatorDoesNotContain} ${g}`:a.operator==="!="?u=` ${window.siyuan.languages.filterOperatorIsNot} ${g}`:a.operator==="Starts with"?u=` ${window.siyuan.languages.filterOperatorStartsWith} ${g}`:a.operator==="Ends with"?u=` ${window.siyuan.languages.filterOperatorEndsWith} ${g}`:[">","<"].includes(a.operator)?u=` ${a.operator} ${g}`:a.operator===">="?u=` \u2265 ${g}`:a.operator==="<="&&(u=` \u2264 ${g}`)}return s+=`<span data-type="setFilter" class="b3-chip${u?" b3-chip--primary":""}">
    ${i.icon?ge(i.icon,"icon",!0):`<svg class="icon"><use xlink:href="#${_t(i.type)}"></use></svg>`}
    <span class="fn__ellipsis">${i.name}${u}</span>
</span>`,!0}}),s};return e.filters.forEach(a=>{const s=n(a);s&&(t+=`<button class="b3-menu__item" draggable="true" data-id="${a.column}" data-filter-type="${a.value.type}">
    <svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>
    <div class="fn__flex-1">${s}</div>
    <svg class="b3-menu__action" data-type="removeFilter"><use xlink:href="#iconTrashcan"></use></svg>
</button>`)}),`<div class="b3-menu__items">
<button class="b3-menu__item" data-type="nobg">
    <span class="block__icon" style="padding: 8px;margin-left: -4px;" data-type="go-config">
        <svg><use xlink:href="#iconLeft"></use></svg>
    </span>
    <span class="b3-menu__label ft__center">${window.siyuan.languages.filter}</span>
</button>
<button class="b3-menu__separator"></button>
${t}
<button class="b3-menu__item${e.filters.length===e.columns.length?" fn__none":""}" data-type="addFilter">
    <svg class="b3-menu__icon"><use xlink:href="#iconAdd"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.addFilter}</span>
</button>
<button class="b3-menu__item${t?"":" fn__none"}" data-type="removeFilters">
    <svg class="b3-menu__icon"><use xlink:href="#iconTrashcan"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.removeFilters}</span>
</button>
</div>`};var ng=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{o(n.next(r))}catch(c){s(c)}},l=r=>{try{o(n.throw(r))}catch(c){s(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,l);o((n=n.apply(e,t)).next())});const vc=e=>{let t;e.data.view.columns.find((s,i)=>{if(s.id===e.colId)return t=JSON.parse(JSON.stringify(s)),e.data.view.columns.splice(i+1,0,t),!0}),t.name=pa(t.name),t.id=Lute.NewNodeID();const n=U().format("YYYYMMDDHHmmss"),a=e.blockElement.getAttribute("data-node-id");q(e.protyle,[{action:"duplicateAttrViewKey",keyID:e.colId,nextID:t.id,avID:e.data.id},{action:"doUpdateUpdated",id:a,data:n}],[{action:"removeAttrViewCol",id:t.id,avID:e.data.id},{action:"doUpdateUpdated",id:a,data:e.blockElement.getAttribute("updated")}]),It({blockElement:e.blockElement,protyle:e.protyle,type:t.type,name:t.name,icon:t.icon,previousID:e.colId,data:e.data,id:t.id}),e.blockElement.setAttribute("updated",n)},Ln=e=>{var t,n,a,s;let i;e.data.view.columns.find(o=>{if(o.id===e.colId)return i=o,!0});let l=`<button class="b3-menu__item" data-type="nobg" data-col-id="${e.colId}">
    <span class="block__icon${e.isCustomAttr?" fn__none":""}" style="padding: 8px;margin-left: -4px;" data-type="go-properties">
        <svg><use xlink:href="#iconLeft"></use></svg>
    </span>
    <span class="b3-menu__label ft__center">${window.siyuan.languages.edit}</span>
</button>
<button class="b3-menu__separator" data-id="separator_1"></button>
<button class="b3-menu__item" data-type="nobg">
    <div class="fn__block">
        <div class="fn__flex">
            <span class="b3-menu__avemoji" data-col-type="${i.type}" data-icon="${i.icon}" data-type="update-icon">${i.icon?ge(i.icon):`<svg style="width: 14px;height: 14px"><use xlink:href="#${_t(i.type)}"></use></svg>`}</span>
            <div class="b3-form__icona fn__block">
                <input data-type="name" class="b3-text-field b3-form__icona-input" type="text">
                <svg data-position="north" class="b3-form__icona-icon ariaLabel" aria-label="${i.desc?Nt(i.desc):window.siyuan.languages.addDesc}"><use xlink:href="#iconInfo"></use></svg>
            </div>
        </div>
        <div class="fn__none">
            <div class="fn__hr"></div>
            <textarea style="margin-left: 22px;width: calc(100% - 22px);" placeholder="${window.siyuan.languages.addDesc}" rows="1" data-type="desc" class="b3-text-field fn__size200" type="text" data-value="${We(i.desc)}">${i.desc}</textarea>
        </div>
        <div class="fn__hr--small"></div>
    </div>
</button>
<button class="b3-menu__item" data-type="goUpdateColType" ${i.type==="block"?"disabled":""}>
    <span class="b3-menu__label">${window.siyuan.languages.type}</span>
    <span class="fn__space"></span>
    <svg class="b3-menu__icon"><use xlink:href="#${_t(i.type)}"></use></svg>
    <span class="b3-menu__accelerator" style="margin-left: 0">${Za(i.type)}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>`;if(["mSelect","select"].includes(i.type))l+=`<button class="b3-menu__separator" data-id="separator_2"></button>
<button class="b3-menu__item" data-type="nobg">
    <svg class="b3-menu__icon"><use xlink:href="#iconAdd"></use></svg>
    <input data-type="addOption" class="b3-text-field fn__block" type="text" placeholder="${window.siyuan.languages.enterKey} ${window.siyuan.languages.addAttr}" style="margin: 4px 0">
</button>`,i.options||(i.options=[]),i.options.forEach(o=>{const r=o.desc?`${Nt(o.name)}<div class='ft__on-surface'>${Nt(o.desc||"")}</div>`:"";l+=`<button class="b3-menu__item${l?"":" b3-menu__item--current"}" draggable="true" data-name="${We(o.name)}" data-desc="${We(o.desc||"")}" data-color="${o.color}">
    <svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>
    <div class="fn__flex-1 ariaLabel" data-position="parentW" aria-label="${r}">
        <span class="b3-chip" style="background-color:var(--b3-font-background${o.color});color:var(--b3-font-color${o.color})">
            <span class="fn__ellipsis">${pe(o.name)}</span>
        </span>
    </div>
    <svg class="b3-menu__action" data-type="setColOption"><use xlink:href="#iconEdit"></use></svg>
</button>`});else if(i.type==="number")l+=`<button class="b3-menu__separator" data-id="separator_2"></button>
<button class="b3-menu__item" data-type="numberFormat" data-format="${i.numberFormat}">
    <svg class="b3-menu__icon"><use xlink:href="#iconFormat"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.format}</span>
    <span class="b3-menu__accelerator">${uc(i.numberFormat)}</span>
</button>`;else if(i.type==="template")l+=`<button class="b3-menu__separator" data-id="separator_2"></button>
<button class="b3-menu__item" data-type="nobg">
    <textarea spellcheck="false" rows="${Math.min(i.template.split(`
`).length,8)}" placeholder="${window.siyuan.languages.template}" data-type="updateTemplate" style="margin: 4px 0" rows="1" class="fn__block b3-text-field">${i.template}</textarea>
</button>`;else if(i.type==="relation"){const o=((t=i.relation)==null?void 0:t.avID)===e.data.id;l+=`<button class="b3-menu__separator" data-id="separator_2"></button>
<button class="b3-menu__item" data-type="goSearchAV" data-av-id="${((n=i.relation)==null?void 0:n.avID)||""}" data-old-value='${JSON.stringify(i.relation||{})}'>
    <span class="b3-menu__label">${window.siyuan.languages.relatedTo}</span>
    <span class="b3-menu__accelerator">${o?window.siyuan.languages.thisDatabase:""}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<label class="b3-menu__item">
    <span class="fn__flex-center">${window.siyuan.languages.backRelation}</span>
    <svg class="b3-menu__icon b3-menu__icon--small fn__none"><use xlink:href="#iconHelp"></use></svg>
    <span class="fn__space fn__flex-1"></span>
    <input data-type="backRelation" type="checkbox" class="b3-switch b3-switch--menu" ${(a=i.relation)!=null&&a.isTwoWay?"checked":""}>
</label>
<div class="b3-menu__item fn__flex-column fn__none" data-type="nobg">
    <input data-old-value="" data-type="colName" style="margin: 8px 0 4px" class="b3-text-field fn__block" placeholder="${e.data.name} ${i.name}">
</div>
<div class="b3-menu__item fn__flex-column fn__none" data-type="nobg">
    <button style="margin: 4px 0 8px;" class="b3-button fn__block" data-type="updateRelation">${window.siyuan.languages.confirm}</button>
</div>`}else i.type==="rollup"?l+='<button class="b3-menu__separator" data-id="separator_2"></button>'+mc({colData:i}):i.type==="date"&&(l+=`<button class="b3-menu__separator" data-id="separator_2"></button>
<label class="b3-menu__item">
    <span class="fn__flex-center">${window.siyuan.languages.fillCreated}</span>
    <span class="fn__space fn__flex-1"></span>
    <input data-type="fillCreated" type="checkbox" class="b3-switch b3-switch--menu" ${(s=i.date)!=null&&s.autoFillNow?"checked":""}>
</label>`);return i.type!=="block"&&(l+=`<button class="b3-menu__separator" data-id="separator_3"></button>
<button class="b3-menu__item" data-type="${i.hidden?"showCol":"hideCol"}">
    <svg class="b3-menu__icon" style=""><use xlink:href="#icon${i.hidden?"Eye":"Eyeoff"}"></use></svg>
    <span class="b3-menu__label">${i.hidden?window.siyuan.languages.showCol:window.siyuan.languages.hideCol}</span>
</button>
<button class="b3-menu__item${i.type==="relation"?" fn__none":""}" data-type="duplicateCol">
    <svg class="b3-menu__icon" style=""><use xlink:href="#iconCopy"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.duplicate}</span>
</button>
<button class="b3-menu__item" data-type="removeCol">
    <svg class="b3-menu__icon" style=""><use xlink:href="#iconTrashcan"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.delete}</span>
</button>`),`<div class="b3-menu__items">
    ${l}
    <button class="b3-menu__separator" data-id="separator_4"></button>
    <label class="b3-menu__item" data-type="wrap">
        <span class="fn__flex-center">${window.siyuan.languages.wrap}</span>
        <span class="fn__space fn__flex-1"></span>
        <input data-type="wrap" type="checkbox" class="b3-switch b3-switch--menu" ${i.wrap?" checked":""}>
    </label>
</div>
<div class="b3-menu__items fn__none">
    <button class="b3-menu__item" data-type="nobg" data-col-id="${i.id}">
        <span class="block__icon" style="padding: 8px;margin-left: -4px;" data-type="goEditCol">
            <svg><use xlink:href="#iconLeft"></use></svg>
        </span>
        <span class="b3-menu__label ft__center">${window.siyuan.languages.edit}</span>
    </button>
    <button class="b3-menu__separator"></button>
    ${Ut("text",i.type)}
    ${Ut("number",i.type)}
    ${Ut("select",i.type)}
    ${Ut("mSelect",i.type)}
    ${Ut("date",i.type)}
    ${Ut("mAsset",i.type)}
    ${Ut("checkbox",i.type)}
    ${Ut("url",i.type)}
    ${Ut("email",i.type)}
    ${Ut("phone",i.type)}
    ${Ut("template",i.type)}
    ${Ut("relation",i.type)}
    ${Ut("rollup",i.type)}
    ${Ut("lineNumber",i.type)}
    ${Ut("created",i.type)}
    ${Ut("updated",i.type)}
</div>`},Sn=e=>{const t=e.data.id,n=e.menuElement.querySelector(".b3-menu__item").getAttribute("data-col-id"),a=e.data.view.columns.find(u=>u.id===n),s=e.menuElement.querySelector('[data-type="name"]');s.addEventListener("blur",()=>{const u=s.value;u!==a.name&&(q(e.protyle,[{action:"updateAttrViewCol",id:n,avID:t,name:u,type:a.type}],[{action:"updateAttrViewCol",id:n,avID:t,name:a.name,type:a.type}]),a.name=u,Tt(e.protyle.wysiwyg.element.querySelector(`.av__row--header .av__cell[data-col-id="${n}"]`),void 0,{name:u}))}),s.addEventListener("keydown",u=>{u.isComposing||(u.key==="Escape"?e.menuElement.parentElement.remove():u.key==="Enter"&&(s.dispatchEvent(new CustomEvent("blur")),e.menuElement.parentElement.remove()))}),s.addEventListener("keyup",u=>{if(u.isComposing)return;const p=e.menuElement.querySelector('[data-type="colName"]');p&&p.setAttribute("placeholder",`${e.data.name} ${s.value}`)}),s.select(),s.value=a.name;const i=e.menuElement.querySelector('.b3-text-field[data-type="desc"]');s.nextElementSibling.addEventListener("click",()=>{const u=i.parentElement;u.classList.toggle("fn__none"),u.classList.contains("fn__none")||i.focus()}),i.addEventListener("blur",()=>{const u=i.value;u!==a.desc&&(q(e.protyle,[{action:"setAttrViewColDesc",id:n,avID:t,data:u}],[{action:"setAttrViewColDesc",id:n,avID:t,data:a.desc}]),a.desc=u)}),i.addEventListener("keydown",u=>{u.isComposing||(u.key==="Escape"?e.menuElement.parentElement.remove():u.key==="Enter"&&(i.dispatchEvent(new CustomEvent("blur")),e.menuElement.parentElement.remove()))}),i.addEventListener("input",()=>{s.nextElementSibling.setAttribute("aria-label",i.value?pe(i.value):window.siyuan.languages.addDesc)});const l=e.menuElement.querySelector('[data-type="updateTemplate"]');l&&(l.addEventListener("blur",()=>{const u=l.value;u!==a.template&&(q(e.protyle,[{action:"updateAttrViewColTemplate",id:n,avID:t,data:u,type:a.type}],[{action:"updateAttrViewColTemplate",id:n,avID:t,data:a.template,type:a.type}]),a.template=u)}),l.addEventListener("keydown",u=>{u.isComposing||(u.key==="Escape"?e.menuElement.parentElement.remove():u.key==="Enter"&&!u.shiftKey&&(l.dispatchEvent(new CustomEvent("blur")),e.menuElement.parentElement.remove()))}));const o=e.menuElement.querySelector('.b3-switch[data-type="wrap"]');o&&o.addEventListener("change",()=>{q(e.protyle,[{action:"setAttrViewColWrap",id:n,avID:t,data:o.checked,blockID:e.blockID}],[{action:"setAttrViewColWrap",id:n,avID:t,data:!o.checked,blockID:e.blockID}])});const r=e.menuElement.querySelector('[data-type="addOption"]');r&&r.addEventListener("keydown",u=>{if(!u.isComposing&&(u.key==="Escape"&&e.menuElement.parentElement.remove(),u.key==="Enter")){let p=!1;if(a.options.find(g=>{if(r.value===g.name)return p=!0,!0}),p||!r.value)return;a.options.push({color:((a.options.length||0)%14+1).toString(),name:r.value}),q(e.protyle,[{action:"updateAttrViewColOptions",id:n,avID:t,data:a.options}],[{action:"removeAttrViewColOption",id:n,avID:t,data:r.value}]),e.menuElement.innerHTML=Ln({protyle:e.protyle,colId:n,data:e.data,isCustomAttr:e.isCustomAttr}),Sn({protyle:e.protyle,menuElement:e.menuElement,data:e.data,isCustomAttr:e.isCustomAttr,blockID:e.blockID}),e.menuElement.querySelector('[data-type="addOption"]').focus()}});const c=e.menuElement.querySelector('[data-type="fillCreated"]');c&&c.addEventListener("change",()=>{q(e.protyle,[{avID:t,action:"setAttrViewColDate",id:n,data:c.checked}],[{avID:t,action:"setAttrViewColDate",id:n,data:!c.checked}])});const d=e.menuElement.querySelector('[data-type="backRelation"]');if(d){d.addEventListener("change",()=>{vi(e.menuElement,t)});const u=e.menuElement.querySelector('[data-type="goSearchAV"]'),p=JSON.parse(u.getAttribute("data-old-value")),g=e.menuElement.querySelector('[data-type="colName"]');g.addEventListener("input",()=>{vi(e.menuElement,t)}),p.avID?A("/api/av/getAttributeView",{id:p.avID},m=>{u.querySelector(".b3-menu__accelerator").textContent=p.avID===t?window.siyuan.languages.thisDatabase:m.data.av.name||window.siyuan.languages.title,m.data.av.keyValues.find(b=>{if(b.key.id===p.backKeyID)return g.setAttribute("data-old-value",b.key.name||window.siyuan.languages.title),g.value=b.key.name||window.siyuan.languages.title,!0}),vi(e.menuElement,t)}):vi(e.menuElement,t)}bc(e)},Za=e=>{switch(e){case"text":case"number":case"select":case"date":case"phone":case"email":case"template":return window.siyuan.languages[e];case"mSelect":return window.siyuan.languages.multiSelect;case"relation":return window.siyuan.languages.relation;case"rollup":return window.siyuan.languages.rollup;case"updated":return window.siyuan.languages.updatedTime;case"created":return window.siyuan.languages.createdTime;case"url":return window.siyuan.languages.link;case"mAsset":return window.siyuan.languages.assets;case"checkbox":return window.siyuan.languages.checkbox;case"block":return window.siyuan.languages._attrView.key;case"lineNumber":return window.siyuan.languages.lineNumber}},_t=e=>{switch(e){case"text":return"iconAlignLeft";case"block":return"iconKey";case"number":return"iconNumber";case"select":return"iconListItem";case"mSelect":return"iconList";case"relation":return"iconOpen";case"rollup":return"iconSearch";case"date":return"iconCalendar";case"updated":case"created":return"iconClock";case"url":return"iconLink";case"mAsset":return"iconImage";case"email":return"iconEmail";case"phone":return"iconPhone";case"template":return"iconMath";case"checkbox":return"iconCheck";case"lineNumber":return"iconOrderedList"}},It=e=>{if(!e.blockElement)return;const t=e.blockElement.getAttribute("data-node-id");e.blockElement.classList.contains("av")?e.blockElement.querySelectorAll(".av__row").forEach((a,s)=>{let i;e.previousID?i=a.querySelector(`[data-col-id="${e.previousID}"]`):i=a.lastElementChild.previousElementSibling;let l="";s===0?l=`<div class="av__cell av__cell--header" draggable="true" data-icon="${e.icon||""}" data-col-id="${e.id}" data-dtype="${e.type}" data-wrap="false" style="width: 200px;">
    ${e.icon?ge(e.icon,"av__cellheadericon",!0):`<svg class="av__cellheadericon"><use xlink:href="#${_t(e.type)}"></use></svg>`}
    <span class="av__celltext fn__flex-1">${e.name}</span>
    <div class="av__widthdrag av__pulse"></div>
</div>`:l='<div class="av__cell" style="width: 200px"><span class="av__pulse"></span></div>',i.insertAdjacentHTML("afterend",l)}):e.blockElement.querySelector(".fn__hr").insertAdjacentHTML("beforebegin",`<div class="block__icons av__row" data-id="${t}" data-col-id="${e.id}">
    <div class="block__icon" draggable="true"><svg><use xlink:href="#iconDrag"></use></svg></div>
    <div class="block__logo ariaLabel fn__pointer" data-type="editCol" data-position="parentW" aria-label="${Za(e.type)}">
        <svg class="block__logoicon"><use xlink:href="#${_t(e.type)}"></use></svg>
        <span>${Za(e.type)}</span>
    </div>
    <div data-col-id="${e.id}" data-block-id="${t}" data-type="${e.type}" data-options="[]" class="fn__flex-1 fn__flex">
        <div class="fn__flex-1"></div>
    </div>
</div>`);const n=document.querySelector(".av__panel .b3-menu");if(n&&e.data&&e.blockElement.classList.contains("av")){n.innerHTML=Ln({protyle:e.protyle,data:e.data,colId:e.id,isCustomAttr:!1}),Sn({protyle:e.protyle,data:e.data,menuElement:n,isCustomAttr:!1,blockID:t});const a=e.blockElement.querySelector(".av__views").getBoundingClientRect();a&&ke(n,a.right-n.clientWidth,a.bottom,a.height);return}$t({protyle:e.protyle,blockElement:e.blockElement,type:"edit",colId:e.id,editData:{previousID:e.previousID,colData:ag(e.type,e.id,e.name)}}),window.siyuan.menus.menu.remove()},kc=(e,t,n)=>{const a=n.getAttribute("data-dtype"),s=n.getAttribute("data-col-id"),i=t.getAttribute("data-av-id"),l=t.getAttribute("data-node-id"),o=n.querySelector(".av__celltext").textContent.trim(),r=n.dataset.desc,c=new Ke("av-header-cell",()=>{const g=c.element.querySelector(".b3-text-field").value;g!==o&&(q(e,[{action:"updateAttrViewCol",id:s,avID:i,name:g,type:a}],[{action:"updateAttrViewCol",id:s,avID:i,name:o,type:a}]),Tt(t.querySelector(`.av__row--header .av__cell[data-col-id="${s}"]`),void 0,{name:g}));const m=c.element.querySelector("textarea").value;m!==r&&q(e,[{action:"setAttrViewColDesc",id:s,avID:i,data:m}],[{action:"setAttrViewColDesc",id:s,avID:i,data:r}]),ne(t)});c.addItem({iconHTML:"",type:"empty",label:`<div class="fn__hr"></div><div class="fn__flex">
    <span class="b3-menu__avemoji">${n.dataset.icon?ge(n.dataset.icon):`<svg style="height: 14px;width: 14px;"><use xlink:href="#${_t(a)}"></use></svg>`}</span>
    <div class="b3-form__icona fn__block">
        <input class="b3-text-field b3-form__icona-input" type="text">
        <svg data-position="north" class="b3-form__icona-icon ariaLabel" aria-label="${r?Nt(r):window.siyuan.languages.addDesc}"><use xlink:href="#iconInfo"></use></svg>
    </div>
</div>
<div class="fn__none">
    <div class="fn__hr"></div>
    <textarea style="margin-left: 22px;width: calc(100% - 22px);" placeholder="${window.siyuan.languages.addDesc}" rows="1" class="b3-text-field fn__size200" type="text" data-value="${We(r)}">${r}</textarea>
</div>
<div class="fn__hr--small"></div>`,bind(g){const m=g.querySelector(".b3-menu__avemoji");m.addEventListener("click",_=>{const w=m.getBoundingClientRect();_a("","av",{x:w.left,y:w.bottom+4,h:w.height,w:w.width},v=>{q(e,[{action:"setAttrViewColIcon",id:s,avID:i,data:v}],[{action:"setAttrViewColIcon",id:s,avID:i,data:n.dataset.icon}]),m.innerHTML=v?ge(v):`<svg style="height: 14px;width: 14px"><use xlink:href="#${_t(a)}"></use></svg>`,Tt(t.querySelector(`.av__row--header .av__cell[data-col-id="${s}"]`),void 0,{icon:v})},m.querySelector("img")),_.preventDefault(),_.stopPropagation()});const b=g.querySelector("input");b.value=o,b.addEventListener("keydown",_=>{_.isComposing||_.key==="Enter"&&(c.close(),_.preventDefault())});const y=g.querySelector("textarea");b.nextElementSibling.addEventListener("click",()=>{const _=y.parentElement;_.classList.toggle("fn__none"),_.classList.contains("fn__none")||y.focus()}),y.addEventListener("keydown",_=>{_.isComposing||_.key==="Enter"&&(c.close(),_.preventDefault())}),y.addEventListener("input",()=>{b.nextElementSibling.setAttribute("aria-label",y.value?pe(y.value):window.siyuan.languages.addDesc)})}}),c.addItem({id:"edit",icon:"iconEdit",label:window.siyuan.languages.edit,click(){const g=c.element.querySelector(".b3-text-field").value;$t({protyle:e,blockElement:t,type:"edit",colId:s,cb(m){const b=m.querySelector('.b3-text-field[data-type="name"]');b.value=g,b.select()}})}}),c.addSeparator({id:"separator_1"}),a!=="lineNumber"&&(c.addItem({id:"asc",icon:"iconUp",label:window.siyuan.languages.asc,click(){A("/api/av/renderAttributeView",{id:i},g=>{q(e,[{action:"setAttrViewSorts",avID:g.data.id,data:[{column:s,order:"ASC"}],blockID:l}],[{action:"setAttrViewSorts",avID:g.data.id,data:g.data.view.sorts,blockID:l}])})}}),c.addItem({id:"desc",icon:"iconDown",label:window.siyuan.languages.desc,click(){A("/api/av/renderAttributeView",{id:i},g=>{q(e,[{action:"setAttrViewSorts",avID:g.data.id,data:[{column:s,order:"DESC"}],blockID:l}],[{action:"setAttrViewSorts",avID:g.data.id,data:g.data.view.sorts,blockID:l}])})}}),a!=="mAsset"&&c.addItem({id:"filter",icon:"iconFilter",label:window.siyuan.languages.filter,click(){A("/api/av/renderAttributeView",{id:i},g=>{const m=g.data;let b;m.view.filters.find(y=>{if(y.column===s&&y.value.type===a)return b=y,!0}),b||(b={column:s,operator:wc(a),value:Bn(a,"")},m.view.filters.push(b)),Ul({filter:b,protyle:e,data:m,blockElement:t,target:t.querySelector(`.av__row--header .av__cell[data-col-id="${s}"]`)})})}}),c.addSeparator({id:"separator_2"})),c.addItem({id:"insertColumnLeft",icon:"iconInsertLeft",label:window.siyuan.languages.insertColumnLeft,click(){var g;const m=Ii(e,t,((g=n.previousElementSibling)==null?void 0:g.getAttribute("data-col-id"))||"");t.contains(n)||(n=t.querySelector(`.av__row--header .av__cell--header[data-col-id="${s}"]`));const b=n.getBoundingClientRect();m.open({x:b.left,y:b.bottom,h:b.height})}}),c.addItem({id:"insertColumnRight",icon:"iconInsertRight",label:window.siyuan.languages.insertColumnRight,click(){const g=Ii(e,t,s);t.contains(n)||(n=t.querySelector(`.av__row--header .av__cell--header[data-col-id="${s}"]`));const m=n.getBoundingClientRect();g.open({x:m.left,y:m.bottom,h:m.height})}}),a!=="block"&&c.addItem({id:"hide",icon:"iconEyeoff",label:window.siyuan.languages.hide,click(){q(e,[{action:"setAttrViewColHidden",id:s,avID:i,data:!0,blockID:l}],[{action:"setAttrViewColHidden",id:s,avID:i,data:!1,blockID:l}])}});const d=n.dataset.pin==="true";if(c.addItem({id:d?"unfreezeCol":"freezeCol",icon:d?"iconUnpin":"iconPin",label:d?window.siyuan.languages.unfreezeCol:window.siyuan.languages.freezeCol,click(){q(e,[{action:"setAttrViewColPin",id:s,avID:i,data:!d,blockID:l}],[{action:"setAttrViewColPin",id:s,avID:i,data:d,blockID:l}]),Tt(t.querySelector(`.av__row--header .av__cell[data-col-id="${s}"]`),void 0,{pin:!d})}}),a!=="block"){let g;a!=="relation"&&c.addItem({id:"duplicate",icon:"iconCopy",label:window.siyuan.languages.duplicate,click(){A("/api/av/renderAttributeView",{id:i},m=>{vc({blockElement:t,viewID:t.getAttribute(f.CUSTOM_SY_AV_VIEW),protyle:e,colId:s,data:m.data})})}}),c.addItem({id:"delete",icon:"iconTrashcan",label:window.siyuan.languages.delete,click(){return ng(this,null,function*(){var m;if(a==="relation"){const y=(yield Ye("/api/av/getAttributeView",{id:i})).data.av.keyValues.find(_=>_.key.id===s);if((m=y.key.relation)!=null&&m.isTwoWay){const _=yield Ye("/api/av/getAttributeView",{id:y.key.relation.avID}),w=new we({title:window.siyuan.languages.removeCol.replace("${x}",y.key.name),content:`<div class="b3-dialog__content">
    ${window.siyuan.languages.confirmRemoveRelationField.replace("${x}",_.data.av.name)}
    <div class="fn__hr--b"></div>
    <button class="fn__block b3-button b3-button--remove" data-action="delete">${window.siyuan.languages.delete}</button>
    <div class="fn__hr"></div>
    <button class="fn__block b3-button b3-button--remove" data-action="keep-relation">${window.siyuan.languages.removeButKeepRelationField}</button>
    <div class="fn__hr"></div>
    <button class="fn__block b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button>
</div>`});w.element.addEventListener("click",v=>{let h=v.target;const E=typeof v.detail=="string";for(;h&&!h.isSameNode(w.element)||E;){const S=h.getAttribute("data-action");if(S==="delete"||E&&v.detail==="Enter"){Yl({protyle:e,colId:s,avID:i,blockID:l,oldValue:o,type:a,cellElement:n,blockElement:t,removeDest:!0}),w.destroy();break}else if(S==="keep-relation"){Yl({protyle:e,colId:s,avID:i,blockID:l,oldValue:o,type:a,cellElement:n,blockElement:t,removeDest:!1}),w.destroy();break}else if(h.classList.contains("b3-button--cancel")||E&&v.detail==="Escape"){w.destroy();break}h=h.parentElement}}),w.element.querySelector("button").focus(),w.element.setAttribute("data-key",f.DIALOG_CONFIRM);return}}Yl({protyle:e,colId:s,avID:i,blockID:l,oldValue:o,type:a,cellElement:n,blockElement:t,removeDest:!1})})}}),c.addSeparator({id:"separator_3"})}c.addItem({id:"wrap",label:`<label class="fn__flex"><span class="fn__flex-center">${window.siyuan.languages.wrap}</span><span class="fn__space fn__flex-1"></span>
<input type="checkbox" class="b3-switch b3-switch--menu"${n.dataset.wrap==="true"?" checked":""}></label>`,bind(g){const m=g.querySelector("input");m.addEventListener("change",()=>{q(e,[{action:"setAttrViewColWrap",id:s,avID:i,data:m.checked,blockID:l}],[{action:"setAttrViewColWrap",id:s,avID:i,data:!m.checked,blockID:l}])})}});const u=n.getBoundingClientRect();c.open({x:u.left,y:u.bottom,h:u.height});const p=window.siyuan.menus.menu.element.querySelector(".b3-text-field");p&&(p.select(),p.focus())},Yl=e=>{var t;const n=U().format("YYYYMMDDHHmmss");q(e.protyle,[{action:"removeAttrViewCol",id:e.colId,avID:e.avID,removeDest:e.removeDest},{action:"doUpdateUpdated",id:e.blockID,data:n}],[{action:"addAttrViewCol",name:e.oldValue,avID:e.avID,type:e.type,id:e.colId,previousID:((t=e.cellElement.previousElementSibling)==null?void 0:t.getAttribute("data-col-id"))||""},{action:"doUpdateUpdated",id:e.blockID,data:e.blockElement.getAttribute("updated")}]),ur(e.blockElement,e.colId),e.blockElement.setAttribute("updated",n)},Fl=e=>{const t=e.menuElement.querySelector(".b3-menu__item").getAttribute("data-col-id");let n="";const a=e.data.view.columns.find((i,l)=>{var o;if(i.id===t)return n=(o=e.data.view.columns[l-1])==null?void 0:o.id,e.data.view.columns.splice(l,1),!0}),s=U().format("YYYYMMDDHHmmss");q(e.protyle,[{action:"removeAttrViewCol",id:t,avID:e.avID,removeDest:e.isTwoWay},{action:"doUpdateUpdated",id:e.blockID,data:s}],[{action:"addAttrViewCol",name:a.name,avID:e.avID,type:a.type,id:t,previousID:n},{action:"doUpdateUpdated",id:e.blockID,data:e.blockElement.getAttribute("updated")}]),ur(e.blockElement,t),e.blockElement.setAttribute("updated",s),e.isCustomAttr?e.avPanelElement.remove():(e.menuElement.innerHTML=la(e.data.view),ke(e.menuElement,e.tabRect.right-e.menuElement.clientWidth,e.tabRect.bottom,e.tabRect.height))},Ut=(e,t)=>`<button class="b3-menu__item" data-type="updateColType" data-old-type="${t}" data-new-type="${e}">
    <svg class="b3-menu__icon"><use xlink:href="#${_t(e)}"></use></svg>
    <span class="b3-menu__label">${Za(e)}</span>
    ${e===t?'<svg class="b3-menu__checked"><use xlink:href="#iconSelect"></use></svg></span>':""}
</button>`,Ii=(e,t,n)=>{const a=new Ke("av-header-add"),s=t.getAttribute("data-av-id");typeof n=="undefined"&&(n=Array.from(t.querySelectorAll(".av__row--header .av__cell")).pop().getAttribute("data-col-id"));const i=t.getAttribute("data-node-id");return a.addItem({id:"text",icon:"iconAlignLeft",label:window.siyuan.languages.text,click(){const l=Lute.NewNodeID(),o=U().format("YYYYMMDDHHmmss");q(e,[{action:"addAttrViewCol",name:window.siyuan.languages.text,avID:s,type:"text",id:l,previousID:n},{action:"doUpdateUpdated",id:i,data:o}],[{action:"removeAttrViewCol",id:l,avID:s},{action:"doUpdateUpdated",id:i,data:t.getAttribute("updated")}]),It({blockElement:t,protyle:e,type:"text",name:window.siyuan.languages.text,id:l,previousID:n}),t.setAttribute("updated",o)}}),a.addItem({id:"number",icon:"iconNumber",label:window.siyuan.languages.number,click(){const l=Lute.NewNodeID(),o=U().format("YYYYMMDDHHmmss");q(e,[{action:"addAttrViewCol",name:window.siyuan.languages.number,avID:s,type:"number",id:l,previousID:n},{action:"doUpdateUpdated",id:i,data:o}],[{action:"removeAttrViewCol",id:l,avID:s},{action:"doUpdateUpdated",id:i,data:t.getAttribute("updated")}]),It({blockElement:t,protyle:e,type:"number",name:window.siyuan.languages.number,id:l,previousID:n}),t.setAttribute("updated",o)}}),a.addItem({id:"select",icon:"iconListItem",label:window.siyuan.languages.select,click(){const l=Lute.NewNodeID(),o=U().format("YYYYMMDDHHmmss");q(e,[{action:"addAttrViewCol",name:window.siyuan.languages.select,avID:s,type:"select",id:l,previousID:n},{action:"doUpdateUpdated",id:i,data:o}],[{action:"removeAttrViewCol",id:l,avID:s},{action:"doUpdateUpdated",id:i,data:t.getAttribute("updated")}]),It({blockElement:t,protyle:e,type:"select",name:window.siyuan.languages.select,id:l,previousID:n}),t.setAttribute("updated",o)}}),a.addItem({id:"multiSelect",icon:"iconList",label:window.siyuan.languages.multiSelect,click(){const l=Lute.NewNodeID(),o=U().format("YYYYMMDDHHmmss");q(e,[{action:"addAttrViewCol",name:window.siyuan.languages.multiSelect,avID:s,type:"mSelect",id:l,previousID:n},{action:"doUpdateUpdated",id:i,data:o}],[{action:"removeAttrViewCol",id:l,avID:s},{action:"doUpdateUpdated",id:i,data:t.getAttribute("updated")}]),It({blockElement:t,protyle:e,type:"mSelect",name:window.siyuan.languages.multiSelect,id:l,previousID:n}),t.setAttribute("updated",o)}}),a.addItem({id:"date",icon:"iconCalendar",label:window.siyuan.languages.date,click(){const l=Lute.NewNodeID(),o=U().format("YYYYMMDDHHmmss");q(e,[{action:"addAttrViewCol",name:window.siyuan.languages.date,avID:s,type:"date",id:l,previousID:n},{action:"doUpdateUpdated",id:i,data:o}],[{action:"removeAttrViewCol",id:l,avID:s},{action:"doUpdateUpdated",id:i,data:t.getAttribute("updated")}]),It({blockElement:t,protyle:e,type:"date",name:window.siyuan.languages.date,id:l,previousID:n}),t.setAttribute("updated",o)}}),a.addItem({id:"assets",icon:"iconImage",label:window.siyuan.languages.assets,click(){const l=Lute.NewNodeID(),o=U().format("YYYYMMDDHHmmss");q(e,[{action:"addAttrViewCol",name:window.siyuan.languages.assets,avID:s,type:"mAsset",id:l,previousID:n},{action:"doUpdateUpdated",id:i,data:o}],[{action:"removeAttrViewCol",id:l,avID:s},{action:"doUpdateUpdated",id:i,data:t.getAttribute("updated")}]),It({blockElement:t,protyle:e,type:"mAsset",name:window.siyuan.languages.assets,id:l,previousID:n}),t.setAttribute("updated",o)}}),a.addItem({id:"checkbox",icon:"iconCheck",label:window.siyuan.languages.checkbox,click(){const l=Lute.NewNodeID(),o=U().format("YYYYMMDDHHmmss");q(e,[{action:"addAttrViewCol",name:window.siyuan.languages.checkbox,avID:s,type:"checkbox",id:l,previousID:n},{action:"doUpdateUpdated",id:i,data:o}],[{action:"removeAttrViewCol",id:l,avID:s},{action:"doUpdateUpdated",id:i,data:t.getAttribute("updated")}]),It({blockElement:t,protyle:e,type:"checkbox",name:window.siyuan.languages.checkbox,id:l,previousID:n}),t.setAttribute("updated",o)}}),a.addItem({id:"link",icon:"iconLink",label:window.siyuan.languages.link,click(){const l=Lute.NewNodeID(),o=U().format("YYYYMMDDHHmmss");q(e,[{action:"addAttrViewCol",name:window.siyuan.languages.link,avID:s,type:"url",id:l,previousID:n},{action:"doUpdateUpdated",id:i,data:o}],[{action:"removeAttrViewCol",id:l,avID:s},{action:"doUpdateUpdated",id:i,data:t.getAttribute("updated")}]),It({blockElement:t,protyle:e,type:"url",name:window.siyuan.languages.link,id:l,previousID:n}),t.setAttribute("updated",o)}}),a.addItem({id:"email",icon:"iconEmail",label:window.siyuan.languages.email,click(){const l=Lute.NewNodeID(),o=U().format("YYYYMMDDHHmmss");q(e,[{action:"addAttrViewCol",name:window.siyuan.languages.email,avID:s,type:"email",id:l,previousID:n},{action:"doUpdateUpdated",id:i,data:o}],[{action:"removeAttrViewCol",id:l,avID:s},{action:"doUpdateUpdated",id:i,data:t.getAttribute("updated")}]),It({blockElement:t,protyle:e,type:"email",name:window.siyuan.languages.email,id:l,previousID:n}),t.setAttribute("updated",o)}}),a.addItem({id:"phone",icon:"iconPhone",label:window.siyuan.languages.phone,click(){const l=Lute.NewNodeID(),o=U().format("YYYYMMDDHHmmss");q(e,[{action:"addAttrViewCol",name:window.siyuan.languages.phone,avID:s,type:"phone",id:l,previousID:n},{action:"doUpdateUpdated",id:i,data:o}],[{action:"removeAttrViewCol",id:l,avID:s},{action:"doUpdateUpdated",id:i,data:t.getAttribute("updated")}]),It({blockElement:t,protyle:e,type:"phone",name:window.siyuan.languages.phone,id:l,previousID:n}),t.setAttribute("updated",o)}}),a.addItem({id:"template",icon:"iconMath",label:window.siyuan.languages.template,click(){const l=Lute.NewNodeID(),o=U().format("YYYYMMDDHHmmss");q(e,[{action:"addAttrViewCol",name:window.siyuan.languages.template,avID:s,type:"template",id:l,previousID:n},{action:"doUpdateUpdated",id:i,data:o}],[{action:"removeAttrViewCol",id:l,avID:s},{action:"doUpdateUpdated",id:i,data:t.getAttribute("updated")}]),It({blockElement:t,protyle:e,type:"template",name:window.siyuan.languages.template,id:l,previousID:n}),t.setAttribute("updated",o)}}),a.addItem({id:"relation",icon:"iconOpen",label:window.siyuan.languages.relation,click(){const l=Lute.NewNodeID(),o=U().format("YYYYMMDDHHmmss");q(e,[{action:"addAttrViewCol",name:window.siyuan.languages.relation,avID:s,type:"relation",id:l,previousID:n},{action:"doUpdateUpdated",id:i,data:o}],[{action:"removeAttrViewCol",id:l,avID:s},{action:"doUpdateUpdated",id:i,data:t.getAttribute("updated")}]),It({blockElement:t,protyle:e,type:"relation",name:window.siyuan.languages.relation,id:l,previousID:n}),t.setAttribute("updated",o)}}),a.addItem({id:"rollup",icon:"iconSearch",label:window.siyuan.languages.rollup,click(){const l=Lute.NewNodeID(),o=U().format("YYYYMMDDHHmmss");q(e,[{action:"addAttrViewCol",name:window.siyuan.languages.rollup,avID:s,type:"rollup",id:l,previousID:n},{action:"doUpdateUpdated",id:i,data:o}],[{action:"removeAttrViewCol",id:l,avID:s},{action:"doUpdateUpdated",id:i,data:t.getAttribute("updated")}]),It({blockElement:t,protyle:e,type:"rollup",name:window.siyuan.languages.rollup,id:l,previousID:n}),t.setAttribute("updated",o)}}),a.addItem({id:"lineNumber",icon:"iconOrderedList",label:window.siyuan.languages.lineNumber,click(){const l=Lute.NewNodeID(),o=U().format("YYYYMMDDHHmmss");q(e,[{action:"addAttrViewCol",name:window.siyuan.languages.lineNumber,avID:s,type:"lineNumber",id:l,previousID:n},{action:"doUpdateUpdated",id:i,data:o}],[{action:"removeAttrViewCol",id:l,avID:s},{action:"doUpdateUpdated",id:i,data:t.getAttribute("updated")}]),It({blockElement:t,protyle:e,type:"lineNumber",name:window.siyuan.languages.lineNumber,id:l,previousID:n}),t.setAttribute("updated",o)}}),a.addItem({id:"createdTime",icon:"iconClock",label:window.siyuan.languages.createdTime,click(){const l=Lute.NewNodeID(),o=U().format("YYYYMMDDHHmmss");q(e,[{action:"addAttrViewCol",name:window.siyuan.languages.createdTime,avID:s,type:"created",id:l,previousID:n},{action:"doUpdateUpdated",id:i,data:o}],[{action:"removeAttrViewCol",id:l,avID:s},{action:"doUpdateUpdated",id:i,data:t.getAttribute("updated")}]),It({blockElement:t,protyle:e,type:"created",name:window.siyuan.languages.createdTime,id:l,previousID:n}),t.setAttribute("updated",o)}}),a.addItem({id:"updatedTime",icon:"iconClock",label:window.siyuan.languages.updatedTime,click(){const l=Lute.NewNodeID(),o=U().format("YYYYMMDDHHmmss");q(e,[{action:"addAttrViewCol",name:window.siyuan.languages.updatedTime,avID:s,type:"updated",id:l,previousID:n},{action:"doUpdateUpdated",id:i,data:o}],[{action:"removeAttrViewCol",id:l,avID:s},{action:"doUpdateUpdated",id:i,data:t.getAttribute("updated")}]),It({blockElement:t,protyle:e,type:"updated",name:window.siyuan.languages.updatedTime,id:l,previousID:n}),t.setAttribute("updated",o)}}),a},ag=(e,t,n)=>({hidden:!1,icon:"",id:t,name:n,desc:"",numberFormat:"",pin:!1,template:"",type:e,width:"",wrap:!1,calc:null}),ze=(e,t,n,a,s=!0)=>{let i=[];e.getAttribute("data-type")==="NodeAttributeView"?i=[e]:i=Array.from(e.querySelectorAll('[data-type="NodeAttributeView"]')),i.length!==0&&i.length>0&&i.forEach(l=>{var o,r,c,d,u;if(l.getAttribute("data-render")==="true")return;const p=l.style.alignSelf;if(l.firstElementChild.innerHTML===""){l.style.alignSelf="";let I="";[1,2,3].forEach(()=>{I+=`<div class="av__row">
    <div style="width: 24px;flex-shrink: 0"></div>
    <div class="av__cell" style="width: 200px"><span class="av__pulse"></span></div>
    <div class="av__cell" style="width: 200px"><span class="av__pulse"></span></div>
    <div class="av__cell" style="width: 200px"><span class="av__pulse"></span></div>
    <div class="av__cell" style="width: 200px"><span class="av__pulse"></span></div>
</div>`}),l.firstElementChild.innerHTML=I}const g=((o=l.querySelector(".av__scroll"))==null?void 0:o.scrollLeft)||0,m=(r=l.querySelector(".av__row--header"))==null?void 0:r.style.transform,b=(c=l.querySelector(".av__row--footer"))==null?void 0:c.style.transform,y=[];l.querySelectorAll(".av__row--select").forEach(I=>{const P=I.getAttribute("data-id");P&&y.push(P)});let _="";const w=l.querySelector(".av__cell--select");w&&(_=$(w,"av__row").dataset.id+f.ZWSP+w.getAttribute("data-col-id"));let v="";const h=l.querySelector(".av__drag-fill");h&&(v=$(h,"av__row").dataset.id+f.ZWSP+h.parentElement.getAttribute("data-col-id"));const E=[];l.querySelectorAll(".av__cell--active").forEach(I=>{E.push($(I,"av__row").dataset.id+f.ZWSP+I.getAttribute("data-col-id"))});const S=(d=t.options.history)==null?void 0:d.created,L=(u=t.options.history)==null?void 0:u.snapshot;let k=l.getAttribute(f.CUSTOM_SY_AV_VIEW)||"";if(typeof a=="string"){const I=l.querySelector(`.av__views > .layout-tab-bar > .item[data-id="${a}"]`);I&&(l.dataset.pageSize=I.dataset.page),k=a,A("/api/av/setDatabaseBlockView",{id:l.dataset.nodeId,viewID:a}),l.setAttribute(f.CUSTOM_SY_AV_VIEW,k)}let x=l.querySelector('[data-type="av-search"]');const C=x&&document.activeElement.isSameNode(x),T=(x==null?void 0:x.value)||"";A(S?"/api/av/renderHistoryAttributeView":L?"/api/av/renderSnapshotAttributeView":"/api/av/renderAttributeView",{id:l.getAttribute("data-av-id"),created:S,snapshot:L,pageSize:parseInt(l.dataset.pageSize)||void 0,viewID:k,query:T.trim()},I=>{var P;const N=I.data.view;l.dataset.pageSize||(l.dataset.pageSize=N.pageSize.toString());let R='<div class="av__row av__row--header"><div class="av__colsticky"><div class="av__firstcol"><svg><use xlink:href="#iconUncheck"></use></svg></div></div>',V="",W=-1,se=-1,Ce=0;const fe=l.clientWidth;let be=!1;N.columns.forEach((le,xt)=>{be||N.filters.find(it=>{if(it.value.type===le.type&&le.id===it.column)return be=!0,!0}),le.hidden||(le.pin&&(W=xt),Ce<fe-200&&(Ce+=parseInt(le.width)||200,se=xt))}),W=Math.min(W,se),W>-1&&(R='<div class="av__row av__row--header"><div class="av__colsticky"><div class="av__firstcol"><svg><use xlink:href="#iconUncheck"></use></svg></div>',V='<div class="av__colsticky">');let pt=!1;N.columns.forEach((le,xt)=>{var it;le.hidden||(R+=`<div class="av__cell av__cell--header" data-col-id="${le.id}"  draggable="true" 
data-icon="${le.icon}" data-dtype="${le.type}" data-wrap="${le.wrap}" data-pin="${le.pin}" 
data-desc="${We(le.desc)}" data-position="north" 
style="width: ${le.width||"200px"};">
    ${le.icon?ge(le.icon,"av__cellheadericon",!0):`<svg class="av__cellheadericon"><use xlink:href="#${_t(le.type)}"></use></svg>`}
    <span class="av__celltext fn__flex-1">${pe(le.name)}</span>
    ${le.pin?'<svg class="av__cellheadericon av__cellheadericon--pin"><use xlink:href="#iconPin"></use></svg>':""}
    <div class="av__widthdrag"></div>
</div>`,W===xt&&(R+="</div>"),le.type==="lineNumber"?V+=`<div data-col-id="${le.id}" data-dtype="${le.type}" class="av__calc" style="width: ${le.width||"200px"}">&nbsp;</div>`:V+=`<div class="av__calc${le.calc&&le.calc.operator!==""?" av__calc--ashow":""}" data-col-id="${le.id}" data-dtype="${le.type}" data-operator="${((it=le.calc)==null?void 0:it.operator)||""}" 
style="width: ${le.width||"200px"}">${$u(le)||`<svg><use xlink:href="#iconDown"></use></svg><small>${window.siyuan.languages.calc}</small>`}</div>`,le.calc&&le.calc.operator!==""&&(pt=!0),W===xt&&(V+="</div>"))}),R+=`<div class="block__icons" style="min-height: auto">
    <div class="block__icon block__icon--show" data-type="av-header-more"><svg><use xlink:href="#iconMore"></use></svg></div>
    <div class="fn__space"></div>
    <div class="block__icon block__icon--show ariaLabel" aria-label="${window.siyuan.languages.newCol}" data-type="av-header-add" data-position="4south"><svg><use xlink:href="#iconAdd"></use></svg></div>
</div>
</div>`,N.rows.forEach((le,xt)=>{R+=`<div class="av__row" data-id="${le.id}">`,W>-1?R+='<div class="av__colsticky"><div class="av__firstcol"><svg><use xlink:href="#iconUncheck"></use></svg></div>':R+='<div class="av__colsticky"><div class="av__firstcol"><svg><use xlink:href="#iconUncheck"></use></svg></div></div>',le.cells.forEach((it,di)=>{var Xd,Jd,Qd;if(N.columns[di].hidden)return;let eu="";it.valueType==="checkbox"&&(eu=(Jd=(Xd=it.value)==null?void 0:Xd.checkbox)!=null&&Jd.checked?" av__cell-check":" av__cell-uncheck"),R+=`<div class="av__cell${eu}" data-id="${it.id}" data-col-id="${N.columns[di].id}"
${it.valueType==="block"?'data-block-id="'+(it.value.block.id||"")+'"':""} data-wrap="${N.columns[di].wrap}" 
data-dtype="${N.columns[di].type}" 
${(Qd=it.value)!=null&&Qd.isDetached?' data-detached="true"':""} 
style="width: ${N.columns[di].width||"200px"};
${it.valueType==="number"?"text-align: right;":""}
${it.bgColor?`background-color:${it.bgColor};`:""}
${it.color?`color:${it.color};`:""}">${Ti(it.value,xt)}</div>`,W===di&&(R+="</div>")}),R+="<div></div></div>"});let vt="",he;I.data.views.forEach(le=>{vt+=`<div data-position="north" data-id="${le.id}" data-page="${le.pageSize}" data-desc="${Nt(le.desc||"")}" class="ariaLabel item${le.id===I.data.viewID?" item--focus":""}">
    ${le.icon?ge(le.icon,"item__graphic",!0):'<svg class="item__graphic"><use xlink:href="#iconTable"></use></svg>'}
    <span class="item__text">${pe(le.name)}</span>
</div>`,le.id===I.data.viewID&&(he=le)});const $n=`<div class="av__body">
    ${R}
    <div class="av__row--util${N.rowCount>N.rows.length?" av__readonly--show":""}">
        <div class="av__colsticky">
            <button class="b3-button" data-type="av-add-bottom">
                <svg><use xlink:href="#iconAdd"></use></svg>
                <span>${window.siyuan.languages.newRow}</span>
            </button>
            <span class="fn__space"></span>
            <button class="b3-button${N.rowCount>N.rows.length?"":" fn__none"}" data-type="av-load-more">
                <svg><use xlink:href="#iconArrowDown"></use></svg>
                <span>${window.siyuan.languages.loadMore}</span>
                <svg data-type="set-page-size" data-size="${N.pageSize}"><use xlink:href="#iconMore"></use></svg>
            </button>
        </div>
    </div>
    <div class="av__row--footer${pt?" av__readonly--show":""}">${V}</div>
</div>`;s?l.firstElementChild.outerHTML=`<div class="av__container">
    <div class="av__header">
        <div class="fn__flex av__views${C||T?" av__views--show":""}">
            <div class="layout-tab-bar fn__flex">
                ${vt}
            </div>
            <div class="fn__space"></div>
            <span data-type="av-add" class="block__icon ariaLabel" data-position="8south" aria-label="${window.siyuan.languages.newView}">
                <svg><use xlink:href="#iconAdd"></use></svg>
            </span>
            <div class="fn__flex-1"></div>
            <div class="fn__space"></div>
            <span data-type="av-switcher" class="block__icon${I.data.views.length>0?"":" fn__none"}">
                <svg><use xlink:href="#iconDown"></use></svg>
                <span class="fn__space"></span>
                <small>${I.data.views.length}</small>
            </span>
            <div class="fn__space"></div>
            <span data-type="av-filter" class="block__icon${be?" block__icon--active":""}">
                <svg><use xlink:href="#iconFilter"></use></svg>
            </span>
            <div class="fn__space"></div>
            <span data-type="av-sort" class="block__icon${N.sorts.length>0?" block__icon--active":""}">
                <svg><use xlink:href="#iconSort"></use></svg>
            </span>
            <div class="fn__space"></div>
            <span data-type="av-search-icon" class="block__icon">
                <svg><use xlink:href="#iconSearch"></use></svg>
            </span>
            <div style="position: relative" class="fn__flex">
                <input style="${C||T?"width:128px":"width:0;padding-left: 0;padding-right: 0;"}" data-type="av-search" class="b3-text-field b3-text-field--text" placeholder="${window.siyuan.languages.search}">
            </div>
            <div class="fn__space"></div>
            <span data-type="av-more" class="block__icon">
                <svg><use xlink:href="#iconMore"></use></svg>
            </span>
            <div class="fn__space"></div>
            <span data-type="av-add-more" class="block__icon ariaLabel" data-position="8south" aria-label="${window.siyuan.languages.newRow}">
                <svg><use xlink:href="#iconAdd"></use></svg>
            </span>
            <div class="fn__space"></div>
            ${I.data.isMirror?` <span data-av-id="${I.data.id}" data-popover-url="/api/av/getMirrorDatabaseBlocks" class="popover__block block__icon block__icon--show ariaLabel" data-position="8south" aria-label="${window.siyuan.languages.mirrorTip}">
    <svg><use xlink:href="#iconSplitLR"></use></svg></span><div class="fn__space"></div>`:""}
        </div>
        <div contenteditable="${t.disabled||D(l,"data-type","NodeBlockQueryEmbed")?"false":"true"}" spellcheck="${window.siyuan.config.editor.spellcheck.toString()}" class="av__title${he.hideAttrViewName?" fn__none":""}" data-title="${I.data.name||""}" data-tip="${window.siyuan.languages.title}">${I.data.name||""}</div>
        <div class="av__counter fn__none"></div>
    </div>
    <div class="av__scroll">
        ${$n}
    </div>
    <div class="av__cursor" contenteditable="true">${f.ZWSP}</div>
</div>`:l.firstElementChild.querySelector(".av__scroll").innerHTML=$n,l.setAttribute("data-render","true"),l.style.margin="",g&&(l.querySelector(".av__scroll").scrollLeft=g),p&&(l.style.alignSelf=p);const xe=t.contentElement.getBoundingClientRect();if(m?l.querySelector(".av__row--header").style.transform=m:setTimeout(()=>{da(l,xe,"top")},f.TIMEOUT_LOAD),b?l.querySelector(".av__row--footer").style.transform=b:setTimeout(()=>{da(l,xe,"bottom")},f.TIMEOUT_LOAD),_){const le=l.querySelector(`.av__row[data-id="${_.split(f.ZWSP)[0]}"] .av__cell[data-col-id="${_.split(f.ZWSP)[1]}"]`);le&&le.classList.add("av__cell--select");const xt=document.querySelector(".av__mask");xt?(P=xt.querySelector("textarea, input"))==null||P.focus():!document.querySelector(".av__panel")&&!C&&ne(l),Qn(l,le)}if(y.forEach((le,xt)=>{const it=l.querySelector(`.av__row[data-id="${le}"]`);it&&(it.classList.add("av__row--select"),it.querySelector(".av__firstcol use").setAttribute("xlink:href","#iconCheck")),xt===y.length-1&&it&&ca(it)}),v&&Gt(l.querySelector(`.av__row[data-id="${v.split(f.ZWSP)[0]}"] .av__cell[data-col-id="${v.split(f.ZWSP)[1]}"]`)),E.forEach(le=>{var xt;(xt=l.querySelector(`.av__row[data-id="${le.split(f.ZWSP)[0]}"] .av__cell[data-col-id="${le.split(f.ZWSP)[1]}"]`))==null||xt.classList.add("av__cell--active")}),getSelection().rangeCount>0){const le=getSelection().getRangeAt(0);if(!$(le.startContainer,"av__title")){const xt=B(le.startContainer);xt&&l.isSameNode(xt)&&!C&&ne(l)}}if(l.querySelector(".layout-tab-bar").scrollLeft=l.querySelector(".layout-tab-bar .item--focus").offsetLeft,n&&n(),!s)return;const Xt=l.querySelector(".av__views");x=l.querySelector('[data-type="av-search"]'),x.value=T||"",C&&x.focus(),x.addEventListener("compositionstart",le=>{le.stopPropagation()}),x.addEventListener("keydown",le=>{le.isComposing||Zn(le)}),x.addEventListener("input",le=>{le.stopPropagation(),!le.isComposing&&(x.value||document.activeElement.isSameNode(x)?Xt.classList.add("av__views--show"):Xt.classList.remove("av__views--show"),Wl(l,t))}),x.addEventListener("compositionend",()=>{Wl(l,t)}),x.addEventListener("blur",le=>{le.isComposing||x.value||(Xt.classList.remove("av__views--show"),x.style.width="0",x.style.paddingLeft="0",x.style.paddingRight="0")}),ps({inputElement:x,right:0,width:"1em",height:x.clientHeight,clearCB(){Xt.classList.remove("av__views--show"),x.style.width="0",x.style.paddingLeft="0",x.style.paddingRight="0",ne(l),Wl(l,t)}})})})};let Ec;const Wl=(e,t)=>{clearTimeout(Ec),Ec=window.setTimeout(()=>{e.removeAttribute("data-render"),ze(e,t,void 0,void 0,!1)},f.TIMEOUT_INPUT)},Lc={},ig=(e,t)=>{t.action==="setAttrViewName"&&Array.from(e.wysiwyg.element.querySelectorAll(`[data-av-id="${t.id}"]`)).forEach(n=>{const a=n.querySelector(".av__title");a&&(a.textContent=t.data,a.dataset.title=t.data)}),clearTimeout(Lc[e.id]),Lc[e.id]=window.setTimeout(()=>{if(t.action==="setAttrViewColWidth")Array.from(e.wysiwyg.element.querySelectorAll(`[data-av-id="${t.avID}"]`)).forEach(n=>{const a=n.querySelector(`.av__cell[data-col-id="${t.id}"]`);!a||a.style.width===t.data||n.getAttribute("custom-sy-av-view")!==t.keyID||n.querySelectorAll(".av__row").forEach(s=>{s.querySelector(`[data-col-id="${t.id}"]`).style.width=t.data})});else{const n=t.action==="setAttrViewName"?t.id:t.avID;Array.from(e.wysiwyg.element.querySelectorAll(`[data-av-id="${n}"]`)).forEach(a=>{a.removeAttribute("data-render");const s=a.querySelector('.av__row[data-need-update="true"]');(t.action==="sortAttrViewCol"||t.action==="sortAttrViewRow")&&(a.querySelectorAll(".av__cell--active").forEach(i=>{var l;i.classList.remove("av__cell--active"),(l=i.querySelector(".av__drag-fill"))==null||l.remove()}),Gt(a.querySelector(".av__cell--select"))),ze(a,e,()=>{var i;const l=document.querySelector(`.b3-dialog--open[data-key="${f.DIALOG_ATTR}"] div[data-av-id="${n}"]`);l?ql(l.parentElement,l.dataset.nodeId,e):t.action==="insertAttrViewBlock"&&s&&!a.querySelector(`.av__row[data-id="${s.getAttribute("data-id")}"]`)&&(ae(window.siyuan.languages.insertRowTip),(i=document.querySelector(".av__mask"))==null||i.remove()),a.removeAttribute("data-loading")})})}},["insertAttrViewBlock"].includes(t.action)?2:100)},Qe=e=>{if(e.action||(e.action=[]),e.protyle.wysiwyg.element.removeAttribute("data-top"),e.data.code===1){e.action.includes(f.CB_GET_APPEND)||(e.protyle.model?e.protyle.model.parent.parent.removeTab(e.protyle.model.parent.id,!1):e.protyle.element.innerHTML=`<div class="ft__smaller ft__secondary b3-form__space--small" contenteditable="false">${window.siyuan.languages.refExpired}</div>`);return}if(e.data.code!==3&&(e.protyle.notebookId=e.data.data.box,e.protyle.path=e.data.data.path,!(e.data.data.eof&&!e.scrollAttr&&(e.action.includes(f.CB_GET_BEFORE)?e.protyle.wysiwyg.element.firstElementChild.setAttribute("data-eof","1"):e.protyle.wysiwyg.element.lastElementChild.setAttribute("data-eof","2"),e.data.data.mode!==4)))){if(J(["gutterOnly"],e.protyle),e.protyle.block.parentID=e.data.data.parentID,e.protyle.block.parent2ID=e.data.data.parent2ID,e.protyle.block.rootID=e.data.data.rootID,e.protyle.block.showAll=!1,e.protyle.block.mode=e.data.data.mode,e.protyle.block.blockCount=e.data.data.blockCount,e.protyle.block.scroll=e.data.data.scroll,e.protyle.block.action=e.action,e.action.includes(f.CB_GET_UNCHANGEID)||(e.protyle.block.id=e.data.data.id,e.protyle.scroll.lastScrollTop=0,e.protyle.contentElement.scrollTop=0,e.protyle.wysiwyg.element.setAttribute("data-doc-type",e.data.data.type)),e.action.includes(f.CB_GET_APPEND)||e.action.includes(f.CB_GET_BEFORE)||e.action.includes(f.CB_GET_HTML)){Sc({content:e.data.data.content,expand:e.data.data.isBacklinkExpand,action:e.action,scrollAttr:e.scrollAttr,updateReadonly:e.updateReadonly,isSyncing:e.data.data.isSyncing,afterCB:e.afterCB},e.protyle),Ni(e.protyle);return}A("/api/block/getDocInfo",{id:e.protyle.block.rootID},t=>{e.protyle.options.render.title?e.protyle.title.render(e.protyle,t):(e.protyle.options.render.background&&e.protyle.background.render(t.data.ial,e.protyle.block.rootID),e.protyle.wysiwyg.renderCustom(t.data.ial)),Sc({content:e.data.data.content,expand:e.data.data.isBacklinkExpand,action:e.action,scrollAttr:e.scrollAttr,updateReadonly:e.updateReadonly,isSyncing:e.data.data.isSyncing,afterCB:e.afterCB},e.protyle),Ni(e.protyle)})}},Sc=(e,t)=>{var n;if(t.contentElement.classList.contains("fn__none")&&t.wysiwyg.element.innerHTML!=="")return;t.block.showAll=e.action.includes(f.CB_GET_ALL);const a=t.contentElement.clientHeight*8,s=typeof e.updateReadonly=="undefined"?t.wysiwyg.element.innerHTML==="":e.updateReadonly;if(e.action.includes(f.CB_GET_APPEND)){if(!t.wysiwyg.element.querySelector(".protyle-wysiwyg--select")&&!t.scroll.keepLazyLoad&&t.contentElement.scrollHeight>a){let i=t.wysiwyg.element.firstElementChild;const l=[];for(;t.wysiwyg.element.childElementCount>2&&l&&!t.wysiwyg.element.lastElementChild.isSameNode(i)&&t.contentElement.scrollHeight-i.offsetTop>a;){l.push(i);i=i.nextElementSibling}const o=i.getBoundingClientRect().top;l.forEach(r=>{r.remove()}),t.contentElement.scrollTop=t.contentElement.scrollTop+(i.getBoundingClientRect().top-o),t.scroll.lastScrollTop=t.contentElement.scrollTop,J(["toolbar"],t)}t.wysiwyg.element.insertAdjacentHTML("beforeend",e.content)}else if(e.action.includes(f.CB_GET_BEFORE)){const i=t.wysiwyg.element.firstElementChild,l=i.getBoundingClientRect().top;if(t.wysiwyg.element.insertAdjacentHTML("afterbegin",e.content),t.contentElement.scrollTop=t.contentElement.scrollTop+(i.getBoundingClientRect().top-l),t.scroll.lastScrollTop=t.contentElement.scrollTop,!t.wysiwyg.element.querySelector(".protyle-wysiwyg--select")&&!t.scroll.keepLazyLoad){const o=[];let r=t.wysiwyg.element.childElementCount,c=t.contentElement.scrollHeight,d=t.wysiwyg.element.lastElementChild;for(;r>2&&c>a&&d.getBoundingClientRect().top>window.innerHeight;)o.push(d),d=d.previousElementSibling,r--,c-=d.clientHeight+8;o.forEach(u=>{u.remove()}),J(["toolbar"],t)}}else t.wysiwyg.element.innerHTML=e.content;if(!t.block.showAll&&t.wysiwyg.element.childElementCount===1&&t.wysiwyg.element.firstElementChild.classList.contains("p")){const i=oe(t.wysiwyg.element.firstElementChild);i&&i.textContent===""&&(i.classList.add("protyle-wysiwyg--empty"),i.setAttribute("placeholder",window.siyuan.languages.emptyMobilePlaceholder))}if(e.action.includes(f.CB_GET_BACKLINK)&&Cc(e.expand,t.wysiwyg.element),Ze(t.wysiwyg.element),Pe(t.wysiwyg.element),ze(t.wysiwyg.element,t),Se(t,t.wysiwyg.element),!e.action.includes(f.CB_GET_HISTORY)){if(t.options.render.scroll&&t.scroll.update(t),e.action.includes(f.CB_GET_FOCUSFIRST)){const i=t.wysiwyg.element.offsetTop-16;en(t,i,f.TIMEOUT_INPUT),t.contentElement.scrollTop=i}if(e.isSyncing?xc(t):(t.breadcrumb&&(t.breadcrumb.element.nextElementSibling.textContent=""),t.element.removeAttribute("disabled-forever"),jl(t,s),e.action.includes(f.CB_GET_OPENNEW)&&window.siyuan.config.editor.readOnly&&Ll(t.breadcrumb.element.parentElement.querySelector('.block__icon[data-type="readonly"]'),t)),sg(t,e.action,e.scrollAttr),e.action.includes(f.CB_GET_SETID)&&(t.block.id=t.block.rootID,t.wysiwyg.element.setAttribute("data-doc-type","NodeDocument")),(n=t.options.defIds)==null||n.forEach(i=>{t.wysiwyg.element.querySelectorAll(`[data-id="${i}"]`).forEach(l=>{l.classList.add("def--mark")})}),t.options.defIds=[],e.action.includes(f.CB_GET_APPEND)||e.action.includes(f.CB_GET_BEFORE)){t.app.plugins.forEach(i=>{i.eventBus.emit("loaded-protyle-dynamic",{protyle:t,position:e.action.includes(f.CB_GET_APPEND)?"afterend":"beforebegin"})});return}!t.disabled&&!e.action.includes(f.CB_GET_ALL)&&t.background&&t.background.element.classList.add("protyle-background--mobileshow"),t.options.render.breadcrumb&&(t.breadcrumb.toggleExit(!e.action.includes(f.CB_GET_ALL)),t.breadcrumb.render(t)),e.afterCB&&e.afterCB(),e.scrollAttr&&!t.scroll.element.classList.contains("fn__none")&&!t.element.classList.contains("block__edit")&&t.wysiwyg.element.lastElementChild.getAttribute("data-eof")!=="2"&&t.contentElement.scrollHeight>0&&!e.action.includes(f.CB_GET_FOCUSFIRST)&&t.contentElement.scrollHeight<=t.contentElement.clientHeight&&A("/api/filetree/getDoc",{id:t.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),mode:2,size:window.siyuan.config.editor.dynamicLoadBlocks},i=>{Qe({data:i,protyle:t,action:[f.CB_GET_APPEND,f.CB_GET_UNCHANGEID]})}),e.scrollAttr&&!t.scroll.element.classList.contains("fn__none")&&!t.element.classList.contains("fn__none")&&t.scroll.updateIndex(t,e.scrollAttr.startId,i=>{i>1&&t.block.blockCount>1&&t.contentElement.scrollHeight<=t.contentElement.clientHeight&&ae(window.siyuan.languages.scrollGetMore)}),t.app.plugins.forEach(i=>{i.eventBus.emit("loaded-protyle-static",{protyle:t})})}},xc=e=>{pn(e),e.breadcrumb&&!H()?e.breadcrumb.element.nextElementSibling.textContent=window.siyuan.languages._kernel[81]:ae(window.siyuan.languages._kernel[81]),e.element.setAttribute("disabled-forever","true")},pn=e=>{if(window.siyuan.menus.menu.remove(),J(["gutter","toolbar","select","hint","util"],e),e.disabled=!0,e.title&&e.title.editElement&&(e.title.editElement.setAttribute("contenteditable","false"),e.title.editElement.style.userSelect="text"),document.getElementById("toolbarName").setAttribute("readonly","readonly"),e.background&&(e.background.element.classList.remove("protyle-background--enable"),e.background.element.classList.remove("protyle-background--mobileshow")),e.wysiwyg.element.querySelectorAll(".protyle-icons--show").forEach(t=>{t.classList.remove("protyle-icons--show")}),e.wysiwyg.element.querySelectorAll(".render-node .protyle-action__edit").forEach(t=>{var n;t.classList.add("fn__none"),t.classList.contains("protyle-icon--first")&&((n=t.nextElementSibling)==null||n.classList.add("protyle-icon--first"))}),e.wysiwyg.element.style.userSelect="text",e.wysiwyg.element.setAttribute("contenteditable","false"),e.wysiwyg.element.setAttribute("data-readonly","true"),e.wysiwyg.element.querySelectorAll('[contenteditable="true"][spellcheck]').forEach(t=>{t.setAttribute("contenteditable","false")}),e.wysiwyg.element.querySelectorAll('.protyle-action[draggable="true"]').forEach(t=>{t.setAttribute("draggable","false")}),e.breadcrumb){e.breadcrumb.element.parentElement.querySelector('[data-type="readonly"] use').setAttribute("xlink:href","#iconLock"),e.breadcrumb.element.parentElement.querySelector('[data-type="readonly"]').setAttribute("aria-label",window.siyuan.config.editor.readOnly?window.siyuan.languages.tempUnlock:window.siyuan.languages.unlockEdit);const t=e.breadcrumb.element.parentElement.querySelector('[data-type="undo"]');t&&!t.classList.contains("fn__none")&&(t.classList.add("fn__none"),e.breadcrumb.element.parentElement.querySelector('[data-type="redo"]').classList.add("fn__none"),e.breadcrumb.element.parentElement.querySelector('[data-type="indent"]').classList.add("fn__none"),e.breadcrumb.element.parentElement.querySelector('[data-type="outdent"]').classList.add("fn__none"))}un()},Ls=e=>{if(e.element.getAttribute("disabled-forever")==="true")return;e.disabled=!1,H()?document.getElementById("toolbarName").removeAttribute("readonly"):(e.wysiwyg.element.setAttribute("contenteditable","true"),e.wysiwyg.element.style.userSelect=""),e.wysiwyg.element.setAttribute("data-readonly","false"),e.title&&e.title.editElement&&(e.title.editElement.setAttribute("contenteditable","true"),e.title.editElement.style.userSelect=""),e.background&&e.background.element.classList.add("protyle-background--enable"),e.wysiwyg.element.querySelectorAll(".render-node .protyle-action__edit").forEach(n=>{var a;n.classList.remove("fn__none"),n.classList.contains("protyle-icon--first")&&((a=n.nextElementSibling)==null||a.classList.remove("protyle-icon--first"))}),e.wysiwyg.element.querySelectorAll('[contenteditable="false"][spellcheck]').forEach(n=>{$(n,"protyle-wysiwyg__embed")||n.setAttribute("contenteditable","true")}),e.wysiwyg.element.querySelectorAll('.protyle-action[draggable="false"]').forEach(n=>{n.setAttribute("draggable","true")});const t=e.contentElement.getBoundingClientRect();if(e.wysiwyg.element.querySelectorAll(".av").forEach(n=>{n.querySelector(".av__title")&&da(n,t,"all")}),e.breadcrumb){e.breadcrumb.element.parentElement.querySelector('[data-type="readonly"] use').setAttribute("xlink:href","#iconUnlock"),e.breadcrumb.element.parentElement.querySelector('[data-type="readonly"]').setAttribute("aria-label",window.siyuan.config.editor.readOnly?window.siyuan.languages.cancelTempUnlock:window.siyuan.languages.lockEdit);const n=e.breadcrumb.element.parentElement.querySelector('[data-type="undo"]');n&&n.classList.contains("fn__none")&&(n.classList.remove("fn__none"),e.breadcrumb.element.parentElement.querySelector('[data-type="redo"]').classList.remove("fn__none"),e.breadcrumb.element.parentElement.querySelector('[data-type="indent"]').classList.remove("fn__none"),e.breadcrumb.element.parentElement.querySelector('[data-type="outdent"]').classList.remove("fn__none"))}un()},sg=(e,t,n)=>{var a;let s;if(n&&n.focusId?s=e.wysiwyg.element.querySelector(`[data-node-id="${n.focusId}"]`):Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${e.block.id}"]`)).find(l=>{if(!D(l,"data-type","block-render",!0))return s=l,!0}),e.block.mode===4?(en(e),s=e.wysiwyg.element.lastElementChild):(!s||t.includes(f.CB_GET_FOCUSFIRST))&&(s=e.wysiwyg.element.firstElementChild),t.includes(f.CB_GET_HL)&&(en(e),ss(s)),t.includes(f.CB_GET_FOCUS)||t.includes(f.CB_GET_FOCUSFIRST)){let l;n&&n.focusId?l=Zi(s,n.focusStart,n.focusEnd):ne(s)}const i=n&&typeof n.scrollTop=="number";if(i&&(e.contentElement.scrollTop=n.scrollTop),(a=e.observerLoad)==null||a.disconnect(),t.includes(f.CB_GET_FOCUS)||t.includes(f.CB_GET_SCROLL)||t.includes(f.CB_GET_HL)||t.includes(f.CB_GET_FOCUSFIRST)){const l=e.contentElement.getBoundingClientRect(),o=s.getBoundingClientRect();!i&&(l.top>o.top||l.bottom<o.bottom)&&He(e,s,!0)}else return;e.observerLoad=new ResizeObserver(()=>{if(i&&(e.contentElement.scrollTop=n.scrollTop),t.includes(f.CB_GET_FOCUS)||t.includes(f.CB_GET_HL)||t.includes(f.CB_GET_FOCUSFIRST)){const l=e.contentElement.getBoundingClientRect(),o=s.getBoundingClientRect();!i&&(l.top>o.top||l.bottom<o.bottom)&&He(e,s,!0)}}),e.observerLoad.observe(e.wysiwyg.element),e.observer.unobserve(e.wysiwyg.element),setTimeout(()=>{e.observerLoad.disconnect(),e.observer.observe(e.wysiwyg.element)},1e3*3),s.isSameNode(e.wysiwyg.element.firstElementChild)&&!i&&e.observerLoad.disconnect()},jl=(e,t)=>{let n=window.siyuan.config.readonly?"true":"false";t?n==="false"&&(n=window.siyuan.config.editor.readOnly?"true":"false",n==="false"&&(n=e.wysiwyg.element.getAttribute(f.CUSTOM_SY_READONLY))):n=e.disabled?"true":"false",n==="true"?pn(e):Ls(e)},Ac=(e,t)=>{e.block.showAll=!0;let n="";t.forEach((a,s)=>{n+=$c(a.blockPaths,!1,s)+Tc(a.dom,a.expand)}),e.wysiwyg.element.innerHTML=n,Ic(e.wysiwyg.element),Ze(e.wysiwyg.element),Pe(e.wysiwyg.element),ze(e.wysiwyg.element,e),Se(e,e.wysiwyg.element),Ni(e),(window.siyuan.config.readonly||window.siyuan.config.editor.readOnly)&&pn(e)},Cc=(e,t)=>{t.firstElementChild.classList.contains("li")?e?t.querySelectorAll(".li .li").forEach(n=>{n.childElementCount>3&&n.setAttribute("fold","1")}):t.firstElementChild.setAttribute("fold","1"):t.firstElementChild.getAttribute("data-type")==="NodeHeading"&&Array.from(t.children).forEach((n,a)=>{(e&&a>2||!e&&a>1)&&((e&&a===3||!e&&a===2)&&n.insertAdjacentHTML("beforebegin",'<div style="max-width: 100%;justify-content: center;" contenteditable="false" class="protyle-breadcrumb__item"><svg style="transform: rotate(90deg);"><use xlink:href="#iconMore"></use></svg></div>'),n.classList.add("fn__none"))})},Tc=(e,t)=>{const n=document.createElement("template");return n.innerHTML=e,Cc(t,n.content),n.innerHTML},km=(e,t)=>{fetchPost("/api/filetree/getDoc",{id:t.getAttribute("data-id"),size:Constants.SIZE_GET_MAX},n=>{t.parentElement.querySelector(".protyle-breadcrumb__item--active").classList.remove("protyle-breadcrumb__item--active"),t.classList.add("protyle-breadcrumb__item--active");let a=t.parentElement.nextElementSibling;for(;a&&!a.classList.contains("protyle-breadcrumb__bar");){const s=a;a=a.nextElementSibling,s.remove()}t.parentElement.insertAdjacentHTML("afterend",Tc(n.data.content,!0)),processRender(t.parentElement.parentElement),avRender(t.parentElement.parentElement,e),blockRender(e,t.parentElement.parentElement),n.data.isSyncing?disabledForeverProtyle(e):window.siyuan.config.readonly||window.siyuan.config.editor.readOnly?disabledProtyle(e):t.parentElement.parentElement.classList.contains("protyle-wysiwyg__embed")&&t.parentElement.parentElement.querySelectorAll('[contenteditable="true"][spellcheck]').forEach(s=>{s.setAttribute("contenteditable","false")})})},Em=e=>{let t=e.nextElementSibling;for(;t&&!t.classList.contains("protyle-breadcrumb__bar");)t.classList.remove("fn__none"),t=t.nextElementSibling;e.remove()},$c=(e,t,n)=>{if(1>e.length)return`<div contenteditable="false" style="border-top: ${n===0?0:1}px solid var(--b3-border-color);min-height: 0;width: 100%;" class="protyle-breadcrumb__bar"><span></span></div>`;let a="";return e.forEach((s,i)=>{i===0&&!t||(a+=`<span class="protyle-breadcrumb__item${i===e.length-1?" protyle-breadcrumb__item--active":""}" data-id="${s.id}">
    <svg class="popover__block" data-id="${s.id}"><use xlink:href="#${dn(s.type,s.subType)}"></use></svg>
    <span class="protyle-breadcrumb__text" title="${s.name}">${s.name}</span>
</span>`,i!==e.length-1&&(a+='<svg class="protyle-breadcrumb__arrow"><use xlink:href="#iconRight"></use></svg>'))}),`<div contenteditable="false" class="protyle-breadcrumb__bar protyle-breadcrumb__bar--nowrap">${a}</div>`},Ic=e=>{e.querySelectorAll(".protyle-breadcrumb__bar").forEach(t=>{t.classList.remove("protyle-breadcrumb__bar--nowrap");const n=Array.from(t.querySelectorAll(".protyle-breadcrumb__text"));if(n.length===0)return;let a=!1;for(;t.scrollHeight>30&&!a&&n.length>1;)n.find((s,i)=>{if(i>0){if(!s.classList.contains("protyle-breadcrumb__text--ellipsis"))return s.classList.add("protyle-breadcrumb__text--ellipsis"),!0;i===n.length-1&&s.classList.contains("protyle-breadcrumb__text--ellipsis")&&(a=!0)}});t.classList.add("protyle-breadcrumb__bar--nowrap"),t.lastElementChild&&(t.scrollLeft=t.lastElementChild.offsetLeft-t.clientWidth+14)})},Se=(e,t,n)=>{let a=[];t.getAttribute("data-type")==="NodeBlockQueryEmbed"?a=[t]:a=Array.from(t.querySelectorAll('[data-type="NodeBlockQueryEmbed"]')),a.length!==0&&a.forEach(s=>{if(s.getAttribute("data-render")==="true")return;s.setAttribute("data-render","true"),s.style.height=s.clientHeight-8+"px",s.innerHTML=`<div class="protyle-icons${re(s)?" fn__none":""}">
    <span aria-label="${window.siyuan.languages.refresh}" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-action__reload protyle-icon--first"><svg class="fn__rotate"><use xlink:href="#iconRefresh"></use></svg></span>
    <span aria-label="${window.siyuan.languages.update} SQL" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-action__edit"><svg><use xlink:href="#iconEdit"></use></svg></span>
    <span aria-label="${window.siyuan.languages.more}" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-action__menu protyle-icon--last"><svg><use xlink:href="#iconMore"></use></svg></span>
</div>${s.lastElementChild.outerHTML}`;const i=Lute.UnEscapeHTMLStr(s.getAttribute("data-content"));let l=s.getAttribute("breadcrumb");if(l?l=l==="true":l=window.siyuan.config.editor.embedBlockBreadcrumb,Q(s,"sb")&&(l=!1),i.startsWith("//!js"))try{const r=new Function("fetchSyncPost","item","protyle","top",i)(Ye,s,e,n);if(r instanceof Promise)r.then(c=>{if(Array.isArray(c))A("/api/search/getEmbedBlock",{embedBlockID:s.getAttribute("data-node-id"),includeIDs:c,headingMode:s.getAttribute("custom-heading-mode")==="1"?1:0,breadcrumb:l},d=>{Di(d.data.blocks||[],e,s,n)});else return}).catch(()=>{Di([],e,s,n)});else if(Array.isArray(r))A("/api/search/getEmbedBlock",{embedBlockID:s.getAttribute("data-node-id"),includeIDs:r,headingMode:s.getAttribute("custom-heading-mode")==="1"?1:0,breadcrumb:l},c=>{Di(c.data.blocks||[],e,s,n)});else return}catch(r){Di([],e,s,n)}else A("/api/search/searchEmbedBlock",{embedBlockID:s.getAttribute("data-node-id"),stmt:i,headingMode:s.getAttribute("custom-heading-mode")==="1"?1:0,excludeIDs:[s.getAttribute("data-node-id"),e.block.rootID],breadcrumb:l},r=>{Di(r.data.blocks,e,s,n)})})},Di=(e,t,n,a)=>{const s=n.querySelector(".fn__rotate");s&&s.classList.remove("fn__rotate");let i="";e.forEach(r=>{let c="";r.blockPaths.length!==0&&(c=$c(r.blockPaths,!0)),i+=`<div class="protyle-wysiwyg__embed" data-id="${r.block.id}">${c}${r.block.content}</div>`}),e.length>0?(n.lastElementChild.insertAdjacentHTML("beforebegin",i+`<div style="position: absolute;">${f.ZWSP}</div>`),Ic(n.querySelector(".protyle-wysiwyg__embed"))):n.lastElementChild.insertAdjacentHTML("beforebegin",`<div class="ft__smaller ft__secondary b3-form__space--small" contenteditable="false">${window.siyuan.languages.refExpired}</div>
<div style="position: absolute;">${f.ZWSP}</div>`),Ze(n),Pe(n),ze(n,t),a&&(t.contentElement.scrollTop=a);let l=0,o=n;for(;l<4&&o;)o=D(o.parentElement,"data-type","NodeBlockQueryEmbed"),l++;l<4&&n.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(r=>{Se(t,r)}),n.style.height=""};var lg=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{o(n.next(r))}catch(c){s(c)}},l=r=>{try{o(n.throw(r))}catch(c){s(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,l);o((n=n.apply(e,t)).next())}),og=(e,t,n)=>(t=e[Symbol.asyncIterator],n=(a,s)=>(s=e[a])&&(t[a]=i=>new Promise((l,o,r)=>(i=s.call(e,i),r=i.done,Promise.resolve(i.value).then(c=>l({value:c,done:r}),o)))),t?t.call(e):(e=e[Symbol.iterator](),t={},n("next"),n("return"),t));const Dc=(e,t)=>{const n=Ne(e),a=[];if(n.isSameNode(e)||(e.remove(),a.push({action:"delete",id:n.getAttribute("data-node-id")})),n.remove(),t.wysiwyg.element.childElementCount===0)if(t.block.rootID===t.block.id){const s=Lute.NewNodeID(),i=Xn(!1,!1,s);a.push({action:"insert",data:i.outerHTML,id:s,parentID:t.block.parentID}),t.wysiwyg.element.innerHTML=i.outerHTML}else Ot({protyle:t,id:t.block.rootID,isPushBack:!1,focusId:t.block.id});a.length>0&&q(t,a,[])},Mc=()=>{if(window.siyuan.transactions.length===0)return;const e=window.siyuan.transactions[0].protyle,t=window.siyuan.transactions[0].doOperations,n=window.siyuan.transactions[0].undoOperations;window.siyuan.transactions.splice(0,1),A("/api/transactions",{session:e.id,app:f.SIYUAN_APPID,transactions:[{doOperations:t,undoOperations:n}]},a=>{window.siyuan.transactions.length===0?Ht([],e.block.rootID,!0):Mc(),(window.siyuan.config.sync.provider!==0&&zn()||window.siyuan.config.sync.provider===0&&!Vn(""))&&window.siyuan.config.repo.key&&window.siyuan.config.sync.enabled&&document.getElementById("toolbarSync").classList.remove("fn__none");let s;if(getSelection().rangeCount>0&&(s=getSelection().getRangeAt(0)),a.data[0].doOperations.forEach(i=>{if(i.action==="unfoldHeading"||i.action==="foldHeading"){Oc(i,e);return}if(i.action==="update"){e.options.backlinkData&&(Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${i.id}"]`)).forEach(l=>{re(l)||s&&(l.isSameNode(s.startContainer)||l.contains(s.startContainer))||(l.outerHTML=i.data.replace("<wbr>",""))}),Ze(e.wysiwyg.element),Pe(e.wysiwyg.element),ze(e.wysiwyg.element,e),Se(e,e.wysiwyg.element)),Vl(e,i);return}if(i.action==="delete"||i.action==="append"){e.options.backlinkData&&Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${i.id}"]`)).forEach(l=>{re(l)||l.remove()}),e.wysiwyg.element.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(l=>{l.querySelector(`[data-node-id="${i.id}"]`)&&(l.removeAttribute("data-render"),Se(e,l))}),J(["gutter"],e);return}if(i.action==="move"){if(e.options.backlinkData){const l=[];Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${i.id}"]`)).forEach(r=>{if(!re(r)&&!r.contains(s.startContainer)){l.push(r);return}});let o=!1;i.previousID&&l.length>0?Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${i.previousID}"]`)).forEach(r=>{!re(r)&&!r.nextElementSibling.contains(s.startContainer)&&(r.after(Hn(l[0].cloneNode(!0))),o=!0)}):l.length>0&&Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${i.parentID}"]`)).forEach(r=>{var c;!re(r)&&!Mt(r).contains(s.startContainer)&&((c=r.firstElementChild)!=null&&c.classList.contains("protyle-action")?r.firstElementChild.after(Hn(l[0].cloneNode(!0))):r.prepend(Hn(l[0].cloneNode(!0))),o=!0)}),l.forEach(r=>{o?r.remove():!o&&r.parentElement&&Dc(r,e)})}e.wysiwyg.element.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(l=>{l.querySelector(`[data-node-id="${i.id}"]`)&&(l.removeAttribute("data-render"),Se(e,l))});return}if(i.action==="insert"&&e.options.backlinkData){const l=[];i.previousID?Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${i.previousID}"]`)).forEach(o=>{var r;((r=o.nextElementSibling)==null?void 0:r.getAttribute("data-node-id"))!==i.id&&!D(o,"data-node-id",i.id)&&!re(o)&&(o.insertAdjacentHTML("afterend",i.data),l.push(o.nextElementSibling))}):Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${i.parentID}"]`)).forEach(o=>{re(o)||(o.firstElementChild&&o.firstElementChild.classList.contains("protyle-action")&&o.firstElementChild.nextElementSibling.getAttribute("data-node-id")!==i.id?(o.firstElementChild.insertAdjacentHTML("afterend",i.data),l.push(o.firstElementChild.nextElementSibling)):o.firstElementChild&&o.firstElementChild.getAttribute("data-node-id")!==i.id&&(o.insertAdjacentHTML("afterbegin",i.data),l.push(o.firstElementChild)))}),e.wysiwyg.element.querySelectorAll('[data-type="NodeHeading"]').forEach(o=>{o.lastElementChild.getAttribute("spin")==="1"&&o.lastElementChild.remove()}),l.forEach(o=>{Ze(o),Pe(o),ze(o,e),Se(e,o);const r=o.querySelector("wbr");r&&r.remove()})}}),e.wysiwyg.element.childElementCount===0&&!e.block.showAll){const i=Lute.NewNodeID(),l=Xn(!1,!0,i);e.wysiwyg.element.insertAdjacentElement("afterbegin",l),q(e,[{action:"insert",data:l.outerHTML,id:i,parentID:e.block.parentID}]),ue(l,s)}})},Vl=(e,t)=>{let n=!1;e.wysiwyg.element.querySelectorAll(`[data-type="NodeBlockQueryEmbed"] [data-node-id="${t.id}"]`).forEach(a=>{const s=document.createElement("div");s.innerHTML=t.data,s.querySelectorAll('[contenteditable="true"]').forEach(l=>{l.setAttribute("contenteditable","false")});const i=s.querySelector("wbr");i&&i.remove(),a.outerHTML=s.innerHTML,n=!0}),n&&(Ze(e.wysiwyg.element),Pe(e.wysiwyg.element),ze(e.wysiwyg.element,e))},Hc=(e,t,n,a)=>{a&&el(e[0]),e.forEach(s=>{if(a)s.remove();else{const i=Ne(s);i&&i.remove()}}),n.wysiwyg.element.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(s=>{s.querySelector(`[data-node-id="${t}"]`)&&(s.removeAttribute("data-render"),Se(n,s))})},Nc=(e,t,n,a)=>{e.forEach(i=>{i.getAttribute("data-subtype")==="echarts"?i.outerHTML=t.lute.SpinBlockDOM(n.data):i.outerHTML=n.data}),Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${n.id}"]`)).find(i=>{if(!re(i))return e[0]=i,!0});const s=e[0].querySelector("wbr");if(a){const i=ye(e[0]);s?ue(e[0],i):ne(e[0])}else s&&s.remove();Ze(e.length===1?e[0]:t.wysiwyg.element),Pe(e.length===1?e[0]:t.wysiwyg.element),ze(e.length===1?e[0]:t.wysiwyg.element,t),Se(t,e.length===1?e[0]:t.wysiwyg.element),Vl(t,n)},zl=(e,t,n)=>{var a,s;const i=[];if(Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.id}"]`)).forEach(l=>{re(l)||i.push(l)}),t.action==="setAttrs"){e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.id}"]`).forEach(l=>{JSON.parse(t.data).fold==="1"?l.setAttribute("fold","1"):l.removeAttribute("fold")});return}if(t.action==="unfoldHeading"){const l=e.contentElement.scrollTop;e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.id}"]`).forEach(o=>{if(o.removeAttribute("fold"),n)return;const r=re(o);if(r){r.removeAttribute("data-render"),Se(e,r);return}t.retData&&(Pc(t.retData,e),o.insertAdjacentHTML("afterend",t.retData)),t.data==="remove"&&o.remove()}),t.retData&&(e.disabled&&pn(e),Ze(e.wysiwyg.element),Pe(e.wysiwyg.element),ze(e.wysiwyg.element,e),Se(e,e.wysiwyg.element),e.contentElement.scrollTop=l,e.scroll.lastScrollTop=l);return}if(t.action==="foldHeading"){if(e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.id}"]`).forEach(l=>{l.setAttribute("fold","1"),t.retData||Ar(l)}),n)return;t.retData&&(t.retData.forEach(l=>{let o;Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${l}"]`)).find(r=>{if(o=re(r),o)return!0;r.remove()}),o&&(o.removeAttribute("data-render"),Se(e,o))}),e.wysiwyg.element.childElementCount===0&&Ot({protyle:e,id:e.block.rootID,isPushBack:!1,focusId:t.id}));return}if(t.action==="delete"){i.length>0||!n?Hc(i,t.id,e,n):n&&Ot({protyle:e,id:e.block.rootID,isPushBack:!1,focusId:t.id,callback(){Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.id}"]`)).forEach(l=>{re(l)||i.push(l)}),Hc(i,t.id,e,n)}});return}if(t.action==="update"){i.length>0?Nc(i,e,t,n):n?Ot({protyle:e,id:e.block.rootID,isPushBack:!1,focusId:t.id,callback(){Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.id}"]`)).forEach(l=>{re(l)||i.push(l)}),Nc(i,e,t,n)}}):Vl(e,t);return}if(t.action==="updateAttrs"){const l=t.data,o={};let r="",c="",d="",u="",p="";Object.keys(l.new).forEach(m=>{o[m]=l.new[m];const b=Lute.EscapeHTMLStr(l.new[m]);m==="bookmark"?r=`<div class="protyle-attr--bookmark">${b}</div>`:m==="name"?c=`<div class="protyle-attr--name"><svg><use xlink:href="#iconN"></use></svg>${b}</div>`:m==="alias"?d=`<div class="protyle-attr--alias"><svg><use xlink:href="#iconA"></use></svg>${b}</div>`:m==="memo"?u=`<div class="protyle-attr--memo b3-tooltips b3-tooltips__sw" aria-label="${b}"><svg><use xlink:href="#iconM"></use></svg></div>`:m==="custom-avs"&&l.new["av-names"]&&(p=`<div class="protyle-attr--av"><svg><use xlink:href="#iconDatabase"></use></svg>${l.new["av-names"]}</div>`)});let g=r+c+d+u+p;if(e.block.rootID===t.id){if(e.title){l.new["custom-avs"]&&!l.new["av-names"]&&(g+=((a=e.title.element.querySelector(".protyle-attr--av"))==null?void 0:a.outerHTML)||"");const m=e.title.element.querySelector(".protyle-attr--refcount");m&&(g+=m.outerHTML),l.new[f.CUSTOM_RIFF_DECKS]&&l.new[f.CUSTOM_RIFF_DECKS]!==l.old[f.CUSTOM_RIFF_DECKS]?(e.title.element.style.animation="addCard 450ms linear",e.title.element.setAttribute(f.CUSTOM_RIFF_DECKS,l.new[f.CUSTOM_RIFF_DECKS]),setTimeout(()=>{e.title.element.style.animation=""},450)):l.new[f.CUSTOM_RIFF_DECKS]||e.title.element.removeAttribute(f.CUSTOM_RIFF_DECKS),e.title.element.querySelector(".protyle-attr").innerHTML=g}if(e.wysiwyg.renderCustom(o),l.new[f.CUSTOM_SY_FULLWIDTH]!==l.old[f.CUSTOM_SY_FULLWIDTH]&&Qa(e),l.new[f.CUSTOM_SY_READONLY]!==l.old[f.CUSTOM_SY_READONLY]){let m=l.new[f.CUSTOM_SY_READONLY];m||(m=window.siyuan.config.editor.readOnly?"true":"false"),m==="true"?pn(e):Ls(e)}l.new.icon!==l.old.icon&&window.siyuan.mobile.editor.protyle.background.ial.icon!==l.new.icon&&(window.siyuan.mobile.editor.protyle.background.ial.icon=l.new.icon,window.siyuan.mobile.editor.protyle.background.render(window.siyuan.mobile.editor.protyle.background.ial,window.siyuan.mobile.editor.protyle.block.rootID));return}e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.id}"]`).forEach(m=>{var b;if(m.getAttribute("data-type")==="NodeThematicBreak")return;Object.keys(l.old).forEach(_=>{m.removeAttribute(_)}),l.new.style&&l.new[f.CUSTOM_RIFF_DECKS]&&l.new[f.CUSTOM_RIFF_DECKS]!==l.old[f.CUSTOM_RIFF_DECKS]&&(l.new.style+=";animation:addCard 450ms linear"),Object.keys(l.new).forEach(_=>{m.setAttribute(_,l.new[_]),_===f.CUSTOM_RIFF_DECKS&&l.new[f.CUSTOM_RIFF_DECKS]!==l.old[f.CUSTOM_RIFF_DECKS]&&(m.style.animation="addCard 450ms linear",setTimeout(()=>{m.parentElement?m.style.animation="":e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.id}"]`).forEach(w=>{w.style.animation=""})},450))}),l.new["custom-avs"]&&!l.new["av-names"]&&(g+=((b=m.lastElementChild.querySelector(".protyle-attr--av"))==null?void 0:b.outerHTML)||"");const y=m.lastElementChild.querySelector(".protyle-attr--refcount");y&&(g+=y.outerHTML),m.lastElementChild.innerHTML=g+f.ZWSP});return}if(t.action==="move"){let l;n&&getSelection().rangeCount>0&&(l=getSelection().getRangeAt(0),l.insertNode(document.createElement("wbr")));let o=!1;t.previousID&&i.length>0?Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.previousID}"]`)).forEach(r=>{re(r)||(r.after(Hn(i[0].cloneNode(!0))),o=!0)}):i.length>0&&(!e.options.backlinkData&&t.parentID===e.block.parentID?(e.wysiwyg.element.prepend(Hn(i[0].cloneNode(!0))),o=!0):Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.parentID}"]`)).forEach(r=>{var c;re(r)||((c=r.firstElementChild)!=null&&c.classList.contains("protyle-action")?r.firstElementChild.after(Hn(i[0].cloneNode(!0))):r.prepend(Hn(i[0].cloneNode(!0))),o=!0)})),i.forEach(r=>{o?r.remove():!o&&r.parentElement&&Dc(r,e)}),n&&l&&(t.data==="focus"?(Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.id}"]`)).find(r=>{if(!re(r))return ne(r),!0}),(s=document.querySelector("wbr"))==null||s.remove()):ue(e.wysiwyg.element,l)),e.wysiwyg.element.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(r=>{r.querySelector(`[data-node-id="${t.id}"],[data-node-id="${t.parentID}"],[data-node-id="${t.previousID}"]`)&&(r.removeAttribute("data-render"),Se(e,r))});return}if(t.action==="insert"){const l=[];if(t.previousID?Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.previousID}"]`)).forEach(o=>{const r=re(o);r?(r.removeAttribute("data-render"),Se(e,r)):(o.insertAdjacentHTML("afterend",t.data),l.push(o.nextElementSibling))}):t.nextID?Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.nextID}"]`)).forEach(o=>{const r=re(o);r?(r.removeAttribute("data-render"),Se(e,r)):(o.insertAdjacentHTML("beforebegin",t.data),l.push(o.previousElementSibling))}):!e.options.backlinkData&&t.parentID===e.block.parentID?(e.wysiwyg.element.insertAdjacentHTML("afterbegin",t.data),l.push(e.wysiwyg.element.firstElementChild)):Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.parentID}"]`)).forEach(o=>{var r;re(o)||((r=o.firstElementChild)!=null&&r.classList.contains("protyle-action")?(o.firstElementChild.insertAdjacentHTML("afterend",t.data),l.push(o.firstElementChild.nextElementSibling)):(o.insertAdjacentHTML("afterbegin",t.data),l.push(o.firstElementChild)))}),e.wysiwyg.element.querySelectorAll('[data-type="NodeHeading"]').forEach(o=>{o.lastElementChild.getAttribute("spin")==="1"&&o.lastElementChild.remove()}),l.length===0)return;l.forEach(o=>{Ze(o),Pe(o),ze(o,e),Se(e,o);const r=o.querySelector("wbr");if(n){const c=ye(o);r?ue(o,c):ne(o)}else r&&r.remove()});return}if(t.action==="append"){e.options.backlinkData||Un(e,!1);return}if(["addAttrViewCol","insertAttrViewBlock","updateAttrViewCol","updateAttrViewColOptions","updateAttrViewColOption","updateAttrViewCell","sortAttrViewRow","sortAttrViewCol","setAttrViewColHidden","setAttrViewColWrap","setAttrViewColWidth","removeAttrViewColOption","setAttrViewName","setAttrViewFilters","setAttrViewSorts","setAttrViewColCalc","removeAttrViewCol","updateAttrViewColNumberFormat","removeAttrViewBlock","replaceAttrViewBlock","updateAttrViewColTemplate","setAttrViewColPin","addAttrViewView","setAttrViewColIcon","removeAttrViewView","setAttrViewViewName","setAttrViewViewIcon","duplicateAttrViewView","sortAttrViewView","updateAttrViewColRelation","setAttrViewPageSize","updateAttrViewColRollup","sortAttrViewKey","duplicateAttrViewKey","setAttrViewViewDesc","setAttrViewColDesc"].includes(t.action)){n?t.action==="setAttrViewName"&&Array.from(e.wysiwyg.element.querySelectorAll(`[data-av-id="${t.id}"]`)).forEach(l=>{const o=l.querySelector(".av__title");o&&(o.textContent=t.data,o.dataset.title=t.data)}):ig(e,t);return}if(t.action==="doUpdateUpdated"){i.forEach(l=>{l.setAttribute("updated",t.data)});return}},Kt=e=>{let t;const n=Lute.NewNodeID();if(e.type==="BlocksMergeSuperBlock")t=tc(e.level,n);else if(e.type==="Blocks2Blockquote")t=document.createElement("div"),t.classList.add("bq"),t.setAttribute("data-node-id",n),t.setAttribute("data-type","NodeBlockquote"),t.innerHTML='<div class="protyle-attr" contenteditable="false"></div>';else if(e.type.endsWith("Ls")){t=document.createElement("div"),t.classList.add("list"),t.setAttribute("data-node-id",n),t.setAttribute("data-type","NodeList"),e.type==="Blocks2ULs"?t.setAttribute("data-subtype","u"):e.type==="Blocks2OLs"?t.setAttribute("data-subtype","o"):t.setAttribute("data-subtype","t");let r="";e.selectsElement.forEach((c,d)=>{e.type==="Blocks2ULs"?r+=`<div data-marker="*" data-subtype="u" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div class="protyle-action" draggable="true"><svg><use xlink:href="#iconDot"></use></svg></div><div class="protyle-attr" contenteditable="false"></div></div>`:e.type==="Blocks2OLs"?r+=`<div data-marker="${d+1}." data-subtype="o" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div class="protyle-action protyle-action--order" contenteditable="false" draggable="true">${d+1}.</div><div class="protyle-attr" contenteditable="false"></div></div>`:r+=`<div data-marker="*" data-subtype="t" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#iconUncheck"></use></svg></div><div class="protyle-attr" contenteditable="false"></div></div>`}),t.innerHTML=r+'<div class="protyle-attr" contenteditable="false"></div>'}const a=e.selectsElement[0].getAttribute("data-node-id"),s=e.selectsElement[0].parentElement.getAttribute("data-node-id")||e.protyle.block.parentID,i=[{action:"insert",id:n,data:t.outerHTML,nextID:a,parentID:s}],l=[];e.selectsElement[0].previousElementSibling?e.selectsElement[0].before(t):e.selectsElement[0].parentElement.prepend(t);let o;e.selectsElement.forEach((r,c)=>{r.classList.remove("protyle-wysiwyg--select"),r.removeAttribute("select-start"),r.removeAttribute("select-end");const d=r.getAttribute("data-node-id");l.push({action:"move",id:d,previousID:o||n,parentID:s}),e.type.endsWith("Ls")?(i.push({action:"move",id:d,parentID:t.children[c].getAttribute("data-node-id")}),t.children[c].firstElementChild.after(r)):(i.push({action:"move",id:d,previousID:o,parentID:n}),t.lastElementChild.before(r)),o=r.getAttribute("data-node-id"),c===e.selectsElement.length-1&&l.push({action:"delete",id:n}),r.getAttribute("data-type")==="NodeBlockQueryEmbed"&&(r.removeAttribute("data-render"),Se(e.protyle,r))}),q(e.protyle,i,l),ne(e.protyle.wysiwyg.element.querySelector(`[data-node-id="${e.selectsElement[0].getAttribute("data-node-id")}"]`)),J(["gutter"],e.protyle)},Pc=(e,t)=>{const n=document.createElement("template");n.innerHTML=e,Array.from(n.content.children).forEach(a=>{var s;(s=t.wysiwyg.element.querySelector(`:scope > [data-node-id="${a.getAttribute("data-node-id")}"]`))==null||s.remove()})},xn=e=>{let t=e.selectsElement,n;if(e.nodeElement){n=getSelection().getRangeAt(0),n.insertNode(document.createElement("wbr")),t=Array.from(e.protyle.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select")),t.length===0&&(t=[e.nodeElement]);let o=!1,r=!1,c=!1;if(t.find((d,u)=>{if(d.classList.contains("li"))return c=!0,!0;if((d.classList.contains("bq")||d.classList.contains("sb")||d.classList.contains("p"))&&(r=!0),d.nextElementSibling&&t[u+1]&&d.nextElementSibling.isSameNode(t[u+1]))o=!0;else if(u!==t.length-1)return o=!1,!0}),c||r&&e.type==="Blocks2Ps")return;t.length===1&&e.type==="Blocks2Hs"&&t[0].getAttribute("data-type")==="NodeHeading"&&e.level===parseInt(t[0].getAttribute("data-subtype").substr(1))&&(e.type="Blocks2Ps"),e.isContinue=o}let a="";const s=[],i=[],l=document.createElement("div");t.forEach((o,r)=>{var c,d,u;(e.type==="Blocks2Ps"||e.type==="Blocks2Hs")&&o.getAttribute("data-type")==="NodeHeading"&&o.getAttribute("fold")==="1"&&ht(e.protyle,o,void 0,void 0,!1),o.classList.remove("protyle-wysiwyg--select"),o.removeAttribute("select-start"),o.removeAttribute("select-end"),a+=o.outerHTML;const p=o.getAttribute("data-node-id");i.push({action:"update",id:p,data:o.outerHTML,parentID:((c=o.parentElement)==null?void 0:c.getAttribute("data-node-id"))||e.protyle.block.parentID||e.protyle.block.rootID,previousID:((d=i[i.length-1])==null?void 0:d.id)||((u=o.previousElementSibling)==null?void 0:u.getAttribute("data-node-id"))}),e.isContinue?r===t.length-1?(l.innerHTML=e.protyle.lute[e.type](a,e.level),o.outerHTML=l.innerHTML):o.remove():o.outerHTML=e.protyle.lute[e.type](o.outerHTML,e.level)}),i.forEach(o=>{const r=e.protyle.wysiwyg.element.querySelector(`[data-node-id="${o.id}"]`);r?s.push({action:"update",id:o.id,data:r.outerHTML}):(o.action="insert",s.push({action:"delete",id:o.id}))}),Array.from(l.children).forEach(o=>{var r,c;const d=o.getAttribute("data-node-id");let u=!1;i.find(p=>{if(d===p.id)return u=!0,!0}),u||(s.push({action:"insert",id:d,previousID:((r=o.previousElementSibling)==null?void 0:r.getAttribute("data-node-id"))||i[0].previousID,data:o.outerHTML,parentID:((c=o.parentElement)==null?void 0:c.getAttribute("data-node-id"))||e.protyle.block.parentID||e.protyle.block.rootID}),i.splice(0,0,{action:"delete",id:d}))}),q(e.protyle,s,i),Ze(e.protyle.wysiwyg.element),Pe(e.protyle.wysiwyg.element),ze(e.protyle.wysiwyg.element,e.protyle),Se(e.protyle,e.protyle.wysiwyg.element),n||e.range?ue(e.protyle.wysiwyg.element,n||e.range):ne(e.protyle.wysiwyg.element.querySelector(`[data-node-id="${t[0].getAttribute("data-node-id")}"]`)),J(["gutter"],e.protyle)},Xa=e=>lg(void 0,null,function*(){var t,n;if(e.nodeElement.querySelector("wbr")||(t=oe(e.nodeElement))==null||t.insertAdjacentHTML("afterbegin","<wbr>"),e.type==="CancelList"||e.type==="CancelBlockquote")try{for(var a=og(e.nodeElement.querySelectorAll('[data-type="NodeHeading"][fold="1"]')),s,i,l;s=!(i=yield a.next()).done;s=!1){const u=i.value,p=u.getAttribute("data-node-id");u.removeAttribute("fold");const g=yield Ye("/api/transactions",{session:e.protyle.id,app:f.SIYUAN_APPID,transactions:[{doOperations:[{action:"unfoldHeading",id:p}],undoOperations:[{action:"foldHeading",id:p}]}]});e.protyle.undo.add([{action:"unfoldHeading",id:p}],[{action:"foldHeading",id:p}],e.protyle),u.insertAdjacentHTML("afterend",g.data[0].doOperations[0].retData)}}catch(u){l=[u]}finally{try{s&&(i=a.return)&&(yield i.call(a))}finally{if(l)throw l[0]}}const o=e.nodeElement.outerHTML,r=(n=e.nodeElement.previousElementSibling)==null?void 0:n.getAttribute("data-node-id"),c=e.nodeElement.parentElement.getAttribute("data-node-id")||e.protyle.block.parentID,d=e.protyle.lute[e.type](e.nodeElement.outerHTML,e.level);if(e.nodeElement.outerHTML=d,e.type==="CancelList"||e.type==="CancelBlockquote"){const u=document.createElement("template");u.innerHTML=d;const p=[{action:"delete",id:e.id}],g=[];let m=r;Array.from(u.content.children).forEach(b=>{const y=b.getAttribute("data-node-id");p.push({action:"insert",data:b.outerHTML,id:y,previousID:m,parentID:c}),g.push({action:"delete",id:y}),m=y}),g.push({action:"insert",data:o,id:e.id,previousID:r,parentID:c}),q(e.protyle,p,g)}else K(e.protyle,e.id,d,o);ue(e.protyle.wysiwyg.element,ye(e.protyle.wysiwyg.element)),e.protyle.wysiwyg.element.querySelectorAll('[data-type~="block-ref"]').forEach(u=>{u.textContent===""&&A("/api/block/getRefText",{id:u.getAttribute("data-id")},p=>{u.innerHTML=p.data})}),Se(e.protyle,e.protyle.wysiwyg.element),Ze(e.protyle.wysiwyg.element),Pe(e.protyle.wysiwyg.element),ze(e.protyle.wysiwyg.element,e.protyle)});let qc;const q=(e,t,n)=>{if(t.length===0)return;if(!e){A("/api/transactions",{session:f.SIYUAN_APPID,app:f.SIYUAN_APPID,transactions:[{doOperations:t}]});return}const a=window.siyuan.transactions[window.siyuan.transactions.length-1];let s=!1;const i=new Date().getTime();if(a&&a.doOperations.length===1&&a.doOperations[0].action==="update"&&t.length===1&&t[0].action==="update"&&a.doOperations[0].id===t[0].id&&e.transactionTime-i<f.TIMEOUT_INPUT&&(s=!0),n&&(window.siyuan.config.fileTree.openFilesUseCurrentTab&&e.model&&e.model.headElement.classList.remove("item--unupdate"),e.updated=!0,s?e.undo.replace(t,e):e.undo.add(t,n,e)),window.clearTimeout(qc),t.length===1&&(t[0].action==="unfoldHeading"||t[0].action==="setAttrs"&&t[0].data.startsWith('{"fold":'))){e.transactionTime=i+f.TIMEOUT_INPUT*2,A("/api/transactions",{session:e.id,app:f.SIYUAN_APPID,transactions:[{doOperations:t,undoOperations:n}]},l=>{l.data[0].doOperations.forEach(o=>{if(o.action==="unfoldHeading"||o.action==="foldHeading")Oc(o,e);else if(o.action==="setAttrs"){const r=e.gutter.element.querySelector('[data-type="fold"]');r&&r.removeAttribute("disabled"),e.wysiwyg.element.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(c=>{c.querySelector(`[data-node-id="${o.id}"]`)&&(c.removeAttribute("data-render"),Se(e,c))})}})});return}s?(window.siyuan.transactions[window.siyuan.transactions.length-1].protyle=e,window.siyuan.transactions[window.siyuan.transactions.length-1].doOperations=t):window.siyuan.transactions.push({protyle:e,doOperations:t,undoOperations:n}),e.transactionTime=i,qc=window.setTimeout(()=>{Mc()},f.TIMEOUT_INPUT*2),t.find(l=>{var o;if(l.action==="insert")return(o=e.observerLoad)==null||o.disconnect(),!0})},Oc=(e,t)=>{if(e.action==="unfoldHeading"||e.action==="foldHeading"){const n=t.gutter.element.querySelector('[data-type="fold"]');if(n&&n.removeAttribute("disabled"),e.action==="unfoldHeading"){const a=t.contentElement.scrollTop;t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`).forEach(s=>{const i=re(s);if(i){i.removeAttribute("data-render"),Se(t,i);return}if(s.lastElementChild.classList.contains("protyle-attr")||s.lastElementChild.remove(),Pc(e.retData,t),s.insertAdjacentHTML("afterend",e.retData),e.data==="remove"){const l=getSelection();l.rangeCount>0&&s.contains(l.getRangeAt(0).startContainer)&&ne(s.nextElementSibling,void 0,!0),s.remove()}}),t.disabled&&pn(t),Ze(t.wysiwyg.element),Pe(t.wysiwyg.element),ze(t.wysiwyg.element,t),Se(t,t.wysiwyg.element),t.contentElement.scrollTop=a,t.scroll.lastScrollTop=a;return}t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`).forEach(a=>{const s=re(a);s&&(s.removeAttribute("data-render"),Se(t,s))}),t.wysiwyg.element.lastElementChild.getAttribute("data-eof")!=="2"&&!t.scroll.element.classList.contains("fn__none")&&t.contentElement.scrollHeight-t.contentElement.scrollTop<t.contentElement.clientHeight*2&&A("/api/filetree/getDoc",{id:t.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),mode:2,size:window.siyuan.config.editor.dynamicLoadBlocks},a=>{Qe({data:a,protyle:t,action:[f.CB_GET_APPEND,f.CB_GET_UNCHANGEID]})});return}},K=(e,t,n,a)=>{n!==a&&q(e,[{id:t,data:n,action:"update"}],[{id:t,data:a,action:"update"}])},ra=(e,t,n)=>{const a=[],s=[];e.forEach(i=>{const l=i.getAttribute("data-node-id");i.classList.remove("protyle-wysiwyg--select"),i.removeAttribute("select-start"),i.removeAttribute("select-end"),s.push({action:"update",id:l,data:i.outerHTML}),n(i),a.push({action:"update",id:l,data:i.outerHTML})}),q(t,a,s)},An=(e,t)=>{const n=$(e,"av__row");if(!n)return;const a=e.querySelector("use");n.classList.contains("av__row--header")||t==="unselectAll"?a.getAttribute("xlink:href")==="#iconCheck"||t==="unselectAll"?n.parentElement.querySelectorAll(".av__firstcol").forEach(s=>{s.querySelector("use").setAttribute("xlink:href","#iconUncheck");const i=$(s,"av__row");i&&i.classList.remove("av__row--select")}):n.parentElement.querySelectorAll(".av__firstcol").forEach(s=>{s.querySelector("use").setAttribute("xlink:href","#iconCheck");const i=$(s,"av__row");i&&i.classList.add("av__row--select")}):t==="select"||a.getAttribute("xlink:href")==="#iconUncheck"&&t==="toggle"?(n.classList.add("av__row--select"),a.setAttribute("xlink:href","#iconCheck")):(t==="unselect"||a.getAttribute("xlink:href")==="#iconCheck"&&t==="toggle")&&(n.classList.remove("av__row--select"),a.setAttribute("xlink:href","#iconUncheck")),ne(B(n)),ca(n)},ca=e=>{const t=B(e);if(!t)return;const n=e.parentElement.querySelectorAll(".av__row--select:not(.av__row--header)").length,a=e.parentElement.childElementCount-3-n,s=e.parentElement.firstElementChild,i=s.querySelector("use"),l=t.querySelector(".av__counter"),o=t.querySelector(".av__header");if(a===0&&e.parentElement.childElementCount-3!==0)s.classList.add("av__row--select"),i.setAttribute("xlink:href","#iconCheck");else if(a===e.parentElement.childElementCount-3){s.classList.remove("av__row--select"),i.setAttribute("xlink:href","#iconUncheck"),l.classList.add("fn__none"),o.style.position="";return}else a>0&&(s.classList.add("av__row--select"),i.setAttribute("xlink:href","#iconIndeterminateCheck"));l.classList.remove("fn__none"),l.innerHTML=`${n} ${window.siyuan.languages.selected}`,o.style.position="sticky"},Rc=e=>{const t=parseInt(e.getAttribute("data-page-size"));if(t){const n=e.querySelectorAll(".av__row:not(.av__row--header)").length;t<n&&e.setAttribute("data-page-size",n.toString())}},Ss=(e,t,n,a,s)=>{if(t.querySelector('[data-type="av-search"]').value!==""){ae(window.siyuan.languages.insertRowTip);return}let i=t.querySelector(`.av__row[data-id="${a}"]`)||t.querySelector(".av__row--header");t.querySelector('.av__views [data-type="av-sort"]').classList.contains("block__icon--active")&&(i=t.querySelector(".av__row--util").previousElementSibling);let l='<div class="av__colsticky"><div class="av__firstcol"><svg><use xlink:href="#iconUncheck"></use></svg></div></div>';const o=i.querySelectorAll(".av__colsticky .av__cell").length-1;o>-1&&(l='<div class="av__colsticky"><div class="av__firstcol"><svg><use xlink:href="#iconUncheck"></use></svg></div>'),i.querySelectorAll(".av__cell").forEach((c,d)=>{var u;let p="";if(Bt(c)==="lineNumber"){const g=(u=c.querySelector(".av__celltext"))==null?void 0:u.getAttribute("data-value");g&&(p=(parseInt(g)+1).toString())}l+=`<div class="av__cell" data-col-id="${c.dataset.colId}" 
style="width: ${c.style.width};${c.dataset.dtype==="number"?"text-align: right;":""}" 
${Bt(c)==="block"?' data-detached="true"':""}><span class="${s?"av__celltext":"av__pulse"}">${p}</span></div>`,o===d&&(l+="</div>")});let r="";if(n.forEach(c=>{const d=t.querySelector(`[data-block-id="${c}"]`);d?(t.querySelectorAll(".av__cell--select, .av__cell--active").forEach(u=>{var p;u.classList.remove("av__cell--select","av__cell--active"),(p=u.querySelector(".av__drag-fill"))==null||p.remove()}),Gt(d),d.classList.add("av__cell--select")):r+=`<div class="av__row" data-type="ghost" data-id="${c}" data-avid="${s}" data-previous-id="${a}">
    ${l}
</div>`}),i.insertAdjacentHTML("afterend",r),s){const c=i.nextElementSibling;t.querySelector('.av__views [data-type="av-sort"]').classList.contains("block__icon--active")&&!t.querySelector('[data-type="av-load-more"]').classList.contains("fn__none")&&c.setAttribute("data-need-update","true");const d=i.classList.contains("av__row--header")?c.nextElementSibling:i;A("/api/av/getAttributeViewFilterSort",{id:s,blockID:t.getAttribute("data-node-id")},u=>{let p=!1;u.data.filters.find(g=>{const m=t.querySelector(`.av__cell--header[data-col-id="${g.column}"]`);if(!m)return;const b=m.getAttribute("data-dtype");if(g.value&&b!==g.value.type)return;if(["relation","rollup","template"].includes(b))return p=!0,!0;["created","updated"].includes(b)?c.setAttribute("data-need-update","true"):u.data.sorts.find(_=>{if(_.column===g.column)return c.setAttribute("data-need-update","true"),!0});let y=!0;if(g.operator!=="Is empty"&&g.operator!=="Is not empty")switch(g.value.type){case"select":case"mSelect":(!g.value.mSelect||g.value.mSelect.length===0)&&(y=!1);break;case"block":(!g.value.block||!g.value.block.content)&&(y=!1);break;case"number":(!g.value.number||!g.value.number.isNotEmpty)&&(y=!1);break;case"date":case"created":case"updated":(!g.value[g.value.type]||!g.value[g.value.type].isNotEmpty)&&(y=!1);break;case"mAsset":(!g.value.mAsset||g.value.mAsset.length===0)&&(y=!1);break;case"checkbox":g.value.checkbox||(y=!1);break;case"text":case"url":case"phone":case"email":(!g.value[g.value.type]||!g.value[g.value.type].content)&&(y=!1);break}if(d.classList.contains("av__row")&&y){const _=d.querySelector(`.av__cell[data-col-id="${g.column}"]`),w=c.querySelector(`.av__cell[data-col-id="${g.column}"]`),v=gn(Bt(_),_);w.innerHTML=Ti(v),Bl(w,v)}}),p?(c.remove(),ae(window.siyuan.languages.insertRowTip)):n.length===1&&rn(e,[c.querySelector('.av__cell[data-detached="true"]')],"block"),Rc(t)})}Rc(t)},da=(e,t,n)=>{const a=e.querySelector(".av__scroll").getBoundingClientRect(),s=e.querySelector(".av__row--header");if(s&&(n==="top"||n==="all")){const l=Math.floor(t.top-a.top);l>0&&l<a.height?s.style.transform=`translateY(${l}px)`:s.style.transform=""}const i=e.querySelector(".av__row--footer");if(i&&(n==="bottom"||n==="all"))if(i.querySelector(".av__calc--ashow")){const l=Math.ceil(t.bottom-i.parentElement.getBoundingClientRect().bottom);l<0&&-l<a.height?i.style.transform=`translateY(${l}px)`:i.style.transform=""}else i.style.transform=""},Mi=e=>{var t;if(e.currentPageSize===e.newPageSize)return;e.nodeElement.setAttribute("data-page-size",e.newPageSize);const n=e.nodeElement.getAttribute("data-node-id");q(e.protyle,[{action:"setAttrViewPageSize",avID:e.avID,data:parseInt(e.newPageSize),blockID:n}],[{action:"setAttrViewPageSize",data:parseInt(e.currentPageSize),avID:e.avID,blockID:n}]),(t=document.querySelector(".av__panel"))==null||t.remove()},Bc=e=>{const t=new Ke("av-page-size");if(t.isOpen)return;const n=e.target.dataset.size;t.addItem({iconHTML:"",label:"10",checked:n==="10",click(){Mi({currentPageSize:n,newPageSize:"10",protyle:e.protyle,avID:e.avID,nodeElement:e.nodeElement})}}),t.addItem({iconHTML:"",checked:n==="25",label:"25",click(){Mi({currentPageSize:n,newPageSize:"25",protyle:e.protyle,avID:e.avID,nodeElement:e.nodeElement})}}),t.addItem({iconHTML:"",checked:n==="50",label:"50",click(){Mi({currentPageSize:n,newPageSize:"50",protyle:e.protyle,avID:e.avID,nodeElement:e.nodeElement})}}),t.addItem({iconHTML:"",checked:n==="100",label:"100",click(){Mi({currentPageSize:n,newPageSize:"100",protyle:e.protyle,avID:e.avID,nodeElement:e.nodeElement})}}),t.addItem({iconHTML:"",checked:n===f.SIZE_DATABASE_MAZ_SIZE.toString(),label:window.siyuan.languages.all,click(){Mi({currentPageSize:n,newPageSize:f.SIZE_DATABASE_MAZ_SIZE.toString(),protyle:e.protyle,avID:e.avID,nodeElement:e.nodeElement})}});const a=e.target.getBoundingClientRect();t.open({x:a.left,y:a.bottom})},Uc=(e,t)=>{const n=e.querySelectorAll(".av__row--select:not(.av__row--header)");if(n.length===0)return;const a=e.getAttribute("data-av-id"),s=[],i=[];n.forEach(o=>{i.push(o.querySelector(".av__cell[data-block-id]").getAttribute("data-block-id"))}),n.forEach(o=>{var r;const c=gn("block",o.querySelector(".av__cell[data-block-id]"));s.push({action:"insertAttrViewBlock",avID:a,previousID:((r=o.previousElementSibling)==null?void 0:r.getAttribute("data-id"))||"",srcs:[{id:o.getAttribute("data-id"),isDetached:c.isDetached,content:c.block.content}],blockID:e.dataset.nodeId})});const l=U().format("YYYYMMDDHHmmss");s.push({action:"doUpdateUpdated",id:e.dataset.nodeId,data:e.getAttribute("updated")}),q(t,[{action:"removeAttrViewBlock",srcIDs:i,avID:a},{action:"doUpdateUpdated",id:e.dataset.nodeId,data:l}],s),n.forEach(o=>{o.remove()}),da(e,t.contentElement.getBoundingClientRect(),"all"),ca(e.querySelector(".av__row")),e.setAttribute("updated",l)},Ja=(e,t,n,a)=>{const s=e.getAttribute("data-av-id"),i=[],l=[];new Array(n).fill(0).forEach(()=>{const r=Lute.NewNodeID();i.push(r),l.push({id:r,isDetached:!0,content:""})});const o=U().format("YYYYMMDDHHmmss");q(t,[{action:"insertAttrViewBlock",avID:s,previousID:a,srcs:l,blockID:e.dataset.nodeId},{action:"doUpdateUpdated",id:e.dataset.nodeId,data:o}],[{action:"removeAttrViewBlock",srcIDs:i,avID:s},{action:"doUpdateUpdated",id:e.dataset.nodeId,data:e.getAttribute("updated")}]),Ss(t,e,i,a,s),e.setAttribute("updated",o)},Lm=()=>{getAllModels().editor.forEach(e=>{var t;if(e.editor&&e.editor.protyle&&e.element.parentElement&&!e.element.classList.contains("fn__none")){(t=e.editor.protyle.wysiwyg.element.querySelector("[data-resize-top]"))==null||t.removeAttribute("data-resize-top");const n=e.editor.protyle.contentElement.getBoundingClientRect();let a=document.elementFromPoint(n.left+n.width/2,n.top);if(a||(a=document.elementFromPoint(n.left+n.width/2,n.top+17)),!a||(a=hasClosestBlock(a),!a))return;a.setAttribute("data-resize-top",a.getBoundingClientRect().top.toString())}})},Qa=e=>{J(["gutterOnly"],e);const t=Fc(e),n=4;setTimeout(()=>{if(e.scroll&&e.scroll.element.parentElement.getAttribute("style")&&e.scroll.element.parentElement.setAttribute("style",`--b3-dynamicscroll-width:${Math.min(e.contentElement.clientHeight-49,200)}px`),!e.disabled){const s=e.contentElement.getBoundingClientRect();e.wysiwyg.element.querySelectorAll(".av").forEach(i=>{i.querySelector(".av__title")&&da(i,s,"all")})}(t.width>n||isNaN(t.width))&&typeof window.echarts!="undefined"&&e.wysiwyg.element.querySelectorAll('[data-subtype="echarts"], [data-subtype="mindmap"]').forEach(s=>{const i=window.echarts.getInstanceById(s.firstElementChild.nextElementSibling.getAttribute("_echarts_instance_"));i&&i.resize()}),e.wysiwyg.element.querySelectorAll(".code-block .protyle-linenumber__rows").forEach(s=>{s.nextElementSibling.style.wordBreak==="break-word"&&Oa(s.parentElement)});const a=e.wysiwyg.element.querySelector("[data-resize-top]");a&&(a.scrollIntoView(),e.contentElement.scrollTop+=a.getBoundingClientRect().top-parseInt(a.getAttribute("data-resize-top")),a.removeAttribute("data-resize-top"))},f.TIMEOUT_TRANSITION+100)},Hi=(e,t)=>{var n,a,s,i;if(t==="preview"){if(!e.preview.element.classList.contains("fn__none"))return;e.preview.element.classList.remove("fn__none"),e.contentElement.classList.add("fn__none"),(n=e.scroll)==null||n.element.classList.add("fn__none"),e.options.render.breadcrumb&&((a=e.breadcrumb)==null||a.element.classList.add("fn__none"),e.breadcrumb.toggleExit(!0)),e.preview.render(e)}else if(t==="wysiwyg"){if(!e.contentElement.classList.contains("fn__none"))return;e.preview.element.classList.add("fn__none"),e.contentElement.classList.remove("fn__none"),e.options.render.scroll&&((s=e.scroll)==null||s.element.classList.remove("fn__none")),e.options.render.breadcrumb&&((i=e.breadcrumb)==null||i.element.classList.remove("fn__none"),e.breadcrumb.toggleExit(!e.block.showAll)),Qa(e)}J(["gutterOnly","toolbar","select","hint","util"],e)};let Yc;const rg=(e,t)=>{t.addEventListener("scroll",()=>{const n=t.getBoundingClientRect();if(!e.toolbar.element.classList.contains("fn__none")){const a=e.toolbar.element.getAttribute("data-inity").split(f.ZWSP),s=parseInt(a[0])+(parseInt(a[1])-t.scrollTop);s<n.top-e.toolbar.toolbarHeight||s>n.bottom-e.toolbar.toolbarHeight?e.toolbar.element.style.display="none":(e.toolbar.element.style.top=s+"px",e.toolbar.element.style.display="")}e.wysiwyg.element.querySelectorAll(".av").forEach(a=>{a.dataset.render==="true"&&da(a,n,"all")}),!e.element.classList.contains("block__edit")&&!H()&&e.contentElement.setAttribute("data-scrolltop",t.scrollTop.toString()),window.siyuan.dragElement||J(["gutterOnly"],e),e.scroll&&!e.scroll.element.classList.contains("fn__none")&&(clearTimeout(Yc),Yc=window.setTimeout(()=>{let a=document.elementFromPoint(n.left+n.width/2,n.top+10);a.classList.contains("protyle-wysiwyg")&&(a=document.elementFromPoint(n.left+n.width/2,n.top+20));const s=B(a);if(!s){if((e.wysiwyg.element.firstElementChild.getAttribute("data-eof")==="1"||e.wysiwyg.element.firstElementChild.getAttribute("data-node-index")==="0")&&($(a,"protyle-background")||$(a,"protyle-title"))){const i=e.scroll.element.querySelector(".b3-slider");i.value="1",e.scroll.element.setAttribute("aria-label",`Blocks 1/${e.block.blockCount}`)}return}e.scroll.updateIndex(e,s.getAttribute("data-node-id"))},f.TIMEOUT_LOAD)),!(e.wysiwyg.element.getAttribute("data-top")||e.block.showAll||e.scroll&&e.scroll.element.classList.contains("fn__none")||!e.scroll||e.scroll.lastScrollTop===t.scrollTop||e.scroll.lastScrollTop===-1||!e.wysiwyg.element.firstElementChild)&&(e.scroll.lastScrollTop-t.scrollTop>0?t.scrollTop<t.clientHeight&&e.wysiwyg.element.firstElementChild.getAttribute("data-eof")!=="1"&&(e.contentElement.style.width=e.contentElement.offsetWidth+"px",e.contentElement.style.overflow="hidden",e.wysiwyg.element.setAttribute("data-top",t.scrollTop.toString()),A("/api/filetree/getDoc",{id:e.wysiwyg.element.firstElementChild.getAttribute("data-node-id"),mode:1,size:window.siyuan.config.editor.dynamicLoadBlocks},a=>{e.contentElement.style.overflow="",e.contentElement.style.width="",Qe({data:a,protyle:e,action:[f.CB_GET_BEFORE,f.CB_GET_UNCHANGEID]})})):t.scrollTop>t.scrollHeight-t.clientHeight*1.8&&e.wysiwyg.element.lastElementChild&&e.wysiwyg.element.lastElementChild.getAttribute("data-eof")!=="2"&&(e.wysiwyg.element.setAttribute("data-top",t.scrollTop.toString()),A("/api/filetree/getDoc",{id:e.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),mode:2,size:window.siyuan.config.editor.dynamicLoadBlocks},a=>{Qe({data:a,protyle:e,action:[f.CB_GET_APPEND,f.CB_GET_UNCHANGEID]})})),e.scroll.lastScrollTop=Math.max(t.scrollTop,0))},{capture:!1,passive:!0,once:!1})},cg=e=>{e.contentElement=document.createElement("div"),e.contentElement.className="protyle-content",(e.options.render.background||e.options.render.title)&&(e.contentElement.innerHTML='<div class="protyle-top"></div>',e.options.render.background&&e.contentElement.firstElementChild.appendChild(e.background.element),e.options.render.title&&e.contentElement.firstElementChild.appendChild(e.title.element)),e.contentElement.appendChild(e.wysiwyg.element),e.options.action.includes(f.CB_GET_HISTORY)||rg(e,e.contentElement),e.element.append(e.contentElement),e.element.appendChild(e.preview.element),e.upload&&e.element.appendChild(e.upload.element),e.options.render.scroll&&e.element.appendChild(e.scroll.element.parentElement),e.gutter&&e.element.appendChild(e.gutter.element),e.element.appendChild(e.hint.element),e.selectElement=document.createElement("div"),e.selectElement.className="protyle-select fn__none",e.element.appendChild(e.selectElement),e.element.appendChild(e.toolbar.element),e.element.appendChild(e.toolbar.subElement),e.element.append(e.highlight.styleElement),ei(e),Hi(e,e.options.mode),document.execCommand("DefaultParagraphSeparator",!1,"p");let t;const n=na(),a=Lt();e.contentElement.addEventListener("mousewheel",i=>{if(!(!window.siyuan.config.editor.fontSizeScrollZoom||a&&!i.metaKey||!a&&!i.ctrlKey||i.deltaX!==0)){if(i.stopPropagation(),i.deltaY<0)if(window.siyuan.config.editor.fontSize<72)window.siyuan.config.editor.fontSize++;else return;else if(i.deltaY>0)if(window.siyuan.config.editor.fontSize>9)window.siyuan.config.editor.fontSize--;else return;is(),clearTimeout(t),ae(`${window.siyuan.languages.fontSize} ${window.siyuan.config.editor.fontSize}px<span class="fn__space"></span>
<button class="b3-button b3-button--white">${window.siyuan.languages.reset} 16px</button>`,void 0,void 0,n),t=window.setTimeout(()=>{var l;A("/api/setting/setEditor",window.siyuan.config.editor),e.wysiwyg.element.querySelectorAll(".code-block .protyle-linenumber__rows").forEach(o=>{Oa(o.parentElement)}),(l=document.querySelector(`#message [data-id="${n}"] button`))==null||l.addEventListener("click",()=>{window.siyuan.config.editor.fontSize=16,is(),A("/api/setting/setEditor",window.siyuan.config.editor),tt(n),e.wysiwyg.element.querySelectorAll(".code-block .protyle-linenumber__rows").forEach(o=>{Oa(o.parentElement)})})},f.TIMEOUT_LOAD)}},{passive:!0}),e.contentElement.addEventListener("click",i=>{if(e.disabled||e.contentElement.querySelector(".protyle-wysiwyg--select")||!i.target.classList.contains("protyle-content")&&!i.target.classList.contains("protyle-wysiwyg"))return;if(window.getSelection().rangeCount>0){const r=window.getSelection().getRangeAt(0);if(r.toString()!==""&&e.wysiwyg.element.contains(r.startContainer))return}const l=e.wysiwyg.element.lastElementChild.getBoundingClientRect(),o=document.createRange();if(i.y>l.bottom){const r=oe(lt(e.wysiwyg.element.lastElementChild));if(!r||e.wysiwyg.element.lastElementChild.getAttribute("data-type")!=="NodeParagraph"&&e.wysiwyg.element.getAttribute("data-doc-type")!=="NodeListItem"&&!e.options.backlinkData||e.wysiwyg.element.lastElementChild.getAttribute("data-type")==="NodeParagraph"&&oe(r).innerHTML!==""){const c=Xn(!1,!1);e.wysiwyg.element.insertAdjacentElement("beforeend",c),q(e,[{action:"insert",data:c.outerHTML,id:c.getAttribute("data-node-id"),previousID:c.previousElementSibling.getAttribute("data-node-id"),parentID:e.block.parentID}],[{action:"delete",id:c.getAttribute("data-node-id")}]);const d=oe(c);o.selectNodeContents(d),o.collapse(!0),X(o),e.options.render.breadcrumb&&setTimeout(()=>{e.breadcrumb.render(e)},f.TIMEOUT_TRANSITION)}else r&&(o.selectNodeContents(r),o.collapse(!1),X(o))}});let s=!1;e.element.addEventListener("mouseover",i=>{const l=$(i.target,"protyle-attr");if(l&&!l.parentElement.classList.contains("protyle-title")){const c=e.wysiwyg.element.querySelector(".protyle-wysiwyg--hl");c&&c.classList.remove("protyle-wysiwyg--hl"),s=!0,l.parentElement.classList.add("protyle-wysiwyg--hl");return}else if(s){const c=e.wysiwyg.element.querySelector(".protyle-wysiwyg--hl");c&&c.classList.remove("protyle-wysiwyg--hl"),s=!1}const o=B(i.target);if(e.options.render.gutter&&o){if(o&&(o.classList.contains("list")||o.classList.contains("li")))return;const c=re(o);c?e.gutter.render(e,c,e.wysiwyg.element):e.gutter.render(e,o,e.wysiwyg.element,i.target);return}const r=O(i.target,"BUTTON");if(r&&r.parentElement.classList.contains("protyle-gutters")){const c=r.getAttribute("data-type");if(c==="fold"||c==="NodeAttributeViewRow"){Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl, .av__row--hl")).forEach(d=>{d.classList.remove("protyle-wysiwyg--hl","av__row--hl")});return}Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${r.getAttribute("data-node-id")}"]`)).find(d=>{if(!re(d)&&e.gutter.isMatchNode(d)){const u=d.querySelector(`.av__row[data-id="${r.dataset.rowId}"]`);return Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl, .av__row--hl")).forEach(p=>{d.isSameNode(p)||p.classList.remove("protyle-wysiwyg--hl"),u&&!u.isSameNode(p)&&u.classList.remove("av__row--hl")}),c==="NodeAttributeViewRowMenu"?u.classList.add("av__row--hl"):d.classList.add("protyle-wysiwyg--hl"),!0}}),i.preventDefault();return}})},ei=(e,t)=>{e.element.removeAttribute("data-loading"),setTimeout(()=>{e.element.getAttribute("data-loading")!=="finished"&&e.element.insertAdjacentHTML("beforeend",`<div style="background-color: var(--b3-theme-background);flex-direction: column;" class="fn__loading wysiwygLoading">
    <img width="48px" src="/stage/loading-pure.svg">
    <div style="color: var(--b3-theme-on-surface);margin-top: 8px;">${t||""}</div>
</div>`)},f.TIMEOUT_LOAD)},Ni=e=>{e.element.setAttribute("data-loading","finished"),e.element.querySelectorAll(".wysiwygLoading").forEach(t=>{t.remove()})},Fc=e=>{if(e.options.action.includes(f.CB_GET_HISTORY))return{width:0,padding:0};const t=parseInt(e.wysiwyg.element.style.paddingLeft),n=Wc(e),a=n.left,s=n.right;if(e.options.backlinkData?e.wysiwyg.element.style.padding=`4px ${s}px 4px ${a}px`:e.wysiwyg.element.style.padding=`${n.top}px ${s}px ${n.bottom}px ${a}px`,e.options.render.background&&e.background.element.querySelector(".protyle-background__ia").setAttribute("style",`margin-left:${a}px;margin-right:${s}px`),e.options.render.title&&(e.title.element.style.margin=`16px ${s}px 0 ${a}px`),window.siyuan.config.editor.displayBookmarkIcon){const o=document.getElementById("editorAttr");o&&(o.innerHTML=`.protyle-wysiwyg--attr .b3-tooltips::after { max-width: ${e.wysiwyg.element.clientWidth-a-s}px; }`)}const i=e.wysiwyg.element.getAttribute("data-realwidth"),l=e.wysiwyg.element.clientWidth-parseInt(e.wysiwyg.element.style.paddingLeft)-parseInt(e.wysiwyg.element.style.paddingRight);return e.wysiwyg.element.setAttribute("data-realwidth",l.toString()),{width:Math.abs(parseInt(i)-l),padding:Math.abs(t-parseInt(e.wysiwyg.element.style.paddingLeft))}},Wc=e=>{let t=16,n=24,a=16;if(e.options.typewriterMode&&(H()?a=window.innerHeight/5:a=e.element.clientHeight/2),!H()){let s=e.wysiwyg.element.getAttribute(f.CUSTOM_SY_FULLWIDTH);s||(s=window.siyuan.config.editor.fullWidth?"true":"false");let i=(e.element.clientWidth-f.SIZE_EDITOR_WIDTH)/2;s==="false"&&i>96?(i>f.SIZE_EDITOR_WIDTH&&(i=e.element.clientWidth*.382/1.382),i=Math.ceil(i),n=i,t=i):e.element.clientWidth>f.SIZE_EDITOR_WIDTH&&(n=96,t=96)}return{left:n,right:t,bottom:a,top:16}},Pi=(e,t=!1)=>{if(!e.wysiwyg.element.firstElementChild||window.siyuan.config.readonly)return;const n={rootId:e.block.rootID,startId:e.wysiwyg.element.firstElementChild.getAttribute("data-node-id"),endId:e.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),scrollTop:e.contentElement.scrollTop||parseInt(e.contentElement.getAttribute("data-scrolltop"))||0};let a;if(getSelection().rangeCount>0&&(a=getSelection().getRangeAt(0)),(!a||!e.wysiwyg.element.contains(a.startContainer))&&(a=e.toolbar.range),a&&e.wysiwyg.element.contains(a.startContainer)){const s=B(a.startContainer);if(s){const i=Je(s,void 0,a);n.focusId=s.getAttribute("data-node-id"),n.focusStart=i.start,n.focusEnd=i.end}}return e.block.showAll&&(n.zoomInId=e.block.id),t?n:(window.siyuan.storage[f.LOCAL_FILEPOSITION][e.block.rootID]=n,new Promise(s=>{Ae(f.LOCAL_FILEPOSITION,window.siyuan.storage[f.LOCAL_FILEPOSITION],()=>{s(!0)})}))},Gl=e=>{var t,n,a,s,i,l,o,r,c,d,u,p,g;let m=[];if(e.mergedOptions?m=e.mergedOptions.action:e.focus?m=[f.CB_GET_UNUNDO,f.CB_GET_FOCUS]:m=[f.CB_GET_UNUNDO],(t=e.scrollAttr)!=null&&t.zoomInId){A("/api/filetree/getDoc",{id:e.scrollAttr.zoomInId,size:f.SIZE_GET_MAX,query:(n=e.protyle.query)==null?void 0:n.key,queryMethod:(a=e.protyle.query)==null?void 0:a.method,queryTypes:(s=e.protyle.query)==null?void 0:s.types,highlight:!On()},b=>{var y,_,w,v,h;b.code===1?A("/api/filetree/getDoc",{id:e.scrollAttr.rootId||((y=e.mergedOptions)==null?void 0:y.blockId)||((_=e.protyle.block)==null?void 0:_.rootID)||e.scrollAttr.startId,query:(w=e.protyle.query)==null?void 0:w.key,queryMethod:(v=e.protyle.query)==null?void 0:v.method,queryTypes:(h=e.protyle.query)==null?void 0:h.types,highlight:!On()},E=>{Qe({data:E,protyle:e.protyle,action:m,scrollAttr:e.scrollAttr,afterCB:e.cb?()=>{e.cb(E.data.keywords)}:void 0,updateReadonly:e.updateReadonly})}):(m.push(f.CB_GET_ALL),Qe({data:b,protyle:e.protyle,action:m,scrollAttr:e.scrollAttr,afterCB:e.cb?()=>{e.cb(b.data.keywords)}:void 0,updateReadonly:e.updateReadonly}))});return}A("/api/filetree/getDoc",{id:((i=e.scrollAttr)==null?void 0:i.rootId)||((l=e.mergedOptions)==null?void 0:l.blockId)||((o=e.protyle.block)==null?void 0:o.rootID)||((r=e.scrollAttr)==null?void 0:r.startId),startID:(c=e.scrollAttr)==null?void 0:c.startId,endID:(d=e.scrollAttr)==null?void 0:d.endId,query:(u=e.protyle.query)==null?void 0:u.key,queryMethod:(p=e.protyle.query)==null?void 0:p.method,queryTypes:(g=e.protyle.query)==null?void 0:g.types,highlight:!On()},b=>{Qe({data:b,protyle:e.protyle,action:m,scrollAttr:e.scrollAttr,afterCB:e.cb?()=>{e.cb(b.data.keywords)}:void 0,updateReadonly:e.updateReadonly})})};var xs=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{o(n.next(r))}catch(c){s(c)}},l=r=>{try{o(n.throw(r))}catch(c){s(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,l);o((n=n.apply(e,t)).next())});const Kl=e=>{const t=e.dataset.type;let n="";if(["NodeHeading","NodeParagraph"].includes(t))n=oe(e).innerHTML;else if(t==="NodeHTMLBlock")n="HTML";else if(t==="NodeAttributeView")n=e.querySelector(".av__title").textContent||window.siyuan.languages.database;else if(t==="NodeThematicBreak")n=window.siyuan.languages.line;else if(t==="NodeIFrame")n="IFrame";else if(t==="NodeWidget")n=window.siyuan.languages.widget;else if(t==="NodeVideo")n=window.siyuan.languages.video;else if(t==="NodeAudio")n=window.siyuan.languages.audio;else if(["NodeCodeBlock","NodeTable"].includes(t))n=As(e);else if(e.classList.contains("render-node"))n+=e.dataset.subtype||Lute.UnEscapeHTMLStr(e.getAttribute("data-content"));else if(["NodeBlockquote","NodeList","NodeSuperBlock","NodeListItem"].includes(t)&&(Array.from(e.querySelectorAll("[data-node-id]")).find(a=>{if(!["NodeBlockquote","NodeList","NodeSuperBlock","NodeListItem"].includes(a.getAttribute("data-type")))return n=Kl(e.querySelector("[data-node-id]")),!0}),n))return n;return n+` <span data-type="block-ref" data-subtype="s" data-id="${e.getAttribute("data-node-id")}">*</span>`},As=(e,t=!1)=>{let n="";const a=e.dataset.type;return a==="NodeHTMLBlock"?n+=Lute.UnEscapeHTMLStr(e.querySelector("protyle-html").getAttribute("data-content")):a==="NodeAttributeView"?(e.querySelectorAll(".av__row").forEach(s=>{s.querySelectorAll(".av__cell").forEach(i=>{n+=Es(i)+" "}),n+=`
`}),n=n.trimEnd()):a==="NodeThematicBreak"?n+="---":a==="NodeIFrame"||a==="NodeWidget"?n+=e.querySelector("iframe").getAttribute("src"):a==="NodeVideo"?n+=e.querySelector("video").getAttribute("src"):a==="NodeAudio"?n+=e.querySelector("audio").getAttribute("src"):e.classList.contains("render-node")?n+=Lute.UnEscapeHTMLStr(e.getAttribute("data-content")):["NodeHeading","NodeParagraph","NodeCodeBlock","NodeTable"].includes(a)?n+=e.querySelector("[spellcheck]").textContent:!t&&["NodeBlockquote","NodeList","NodeSuperBlock","NodeListItem"].includes(a)&&e.querySelectorAll("[data-node-id]").forEach(s=>{const i=As(s,!0);n+=i?i+`
`:""}),n},dg=(e,t)=>xs(void 0,null,function*(){try{let n=yield nl();n=n.replace(/<span data-type="text".*?>(.*?)<\/span>/g,"$1"),n=n.replace(/\\/g,"\\\\").replace(/\*/g,"\\*").replace(/_/g,"\\_").replace(/\[/g,"\\[").replace(/]/g,"\\]").replace(/!/g,"\\!").replace(/`/g,"\\`").replace(/</g,"\\<").replace(/>/g,"\\>").replace(/&/g,"\\&").replace(/~/g,"\\~").replace(/\{/g,"\\{").replace(/}/g,"\\}").replace(/\(/g,"\\(").replace(/\)/g,"\\)").replace(/=/g,"\\=").replace(/#/g,"\\#").replace(/\$/g,"\\$").replace(/\^/g,"\\^").replace(/\|/g,"\\|").replace(/\./g,"\\."),qi(e,{textPlain:n,textHTML:"",target:t})}catch(n){console.log(n)}}),Cs=(e,t)=>{let n=!0;e.options.hint.extend.find(a=>{if(a.key===t)return n=!1,!0}),n&&e.hint.render(e)},jc=e=>xs(void 0,null,function*(){[].length===0&&navigator.clipboard.readText().then(n=>{if(getSelection().rangeCount>0){const s=getSelection().getRangeAt(0);if(D(s.startContainer,"data-type","code")||$(s.startContainer,"hljs")){Xe(n.replace(/\u200D```/g,"```").replace(/```/g,"\u200D```"),e);return}}n=n.replace(/<sub>/g,"__@sub@__").replace(/<\/sub>/g,"__@/sub@__"),n=n.replace(/<sup>/g,"__@sup@__").replace(/<\/sup>/g,"__@/sup@__"),n=n.replace(/<kbd>/g,"__@kbd@__").replace(/<\/kbd>/g,"__@/kbd@__"),n=n.replace(/<u>/g,"__@u@__").replace(/<\/u>/g,"__@/u@__"),n=n.replace(/<span data-type="text".*?>(.*?)<\/span>/g,"$1"),n=n.replace(/</g,";;;lt;;;").replace(/>/g,";;;gt;;;"),n=n.replace(/__@sub@__/g,"<sub>").replace(/__@\/sub@__/g,"</sub>"),n=n.replace(/__@sup@__/g,"<sup>").replace(/__@\/sup@__/g,"</sup>"),n=n.replace(/__@kbd@__/g,"<kbd>").replace(/__@\/kbd@__/g,"</kbd>"),n=n.replace(/__@u@__/g,"<u>").replace(/__@\/u@__/g,"</u>"),ug(e);const a=e.lute.BlockDOM2EscapeMarkerContent(e.lute.Md2BlockDOM(n));Vc(e),Xe(a,e,!1,!1,!0),Cs(e,n)})}),ug=e=>{e.lute.SetInlineAsterisk(!0),e.lute.SetGFMStrikethrough(!0),e.lute.SetInlineMath(!0),e.lute.SetSub(!0),e.lute.SetSup(!0),e.lute.SetTag(!0),e.lute.SetInlineUnderscore(!0)},Vc=e=>{e.lute.SetInlineAsterisk(window.siyuan.config.editor.markdown.inlineAsterisk),e.lute.SetGFMStrikethrough(window.siyuan.config.editor.markdown.inlineStrikethrough),e.lute.SetInlineMath(window.siyuan.config.editor.markdown.inlineMath),e.lute.SetSub(window.siyuan.config.editor.markdown.inlineSub),e.lute.SetSup(window.siyuan.config.editor.markdown.inlineSup),e.lute.SetTag(window.siyuan.config.editor.markdown.inlineTag),e.lute.SetInlineUnderscore(window.siyuan.config.editor.markdown.inlineUnderscore),e.lute.SetMark(window.siyuan.config.editor.markdown.inlineMark)},Sm=(e,t)=>xs(void 0,null,function*(){if(e&&e.app&&e.app.plugins)for(let n=0;n<e.app.plugins.length;n++){const a=yield new Promise(s=>{e.app.plugins[n].eventBus.emit("paste",{protyle:e,resolve:s,textHTML:"",textPlain:"",siyuanHTML:"",files:t})&&s(void 0)});a!=null&&a.files&&(t=a.files)}uploadLocalFiles(t,e,!0)}),qi=(e,t)=>xs(void 0,null,function*(){("clipboardData"in t||"dataTransfer"in t)&&(t.stopPropagation(),t.preventDefault());let n,a,s,i;if("clipboardData"in t?(n=t.clipboardData.getData("text/html"),a=t.clipboardData.getData("text/plain"),s=t.clipboardData.getData("text/siyuan"),i=t.clipboardData.files):"dataTransfer"in t?(n=t.dataTransfer.getData("text/html"),a=t.dataTransfer.getData("text/plain"),s=t.dataTransfer.getData("text/siyuan"),t.dataTransfer.types[0]==="Files"&&(i=t.dataTransfer.items)):(n=t.textHTML,a=t.textPlain,i=t.files),a=a.replace(/\r\n|\r|\u2028|\u2029/g,`
`),(n.replace(/&amp;/g,"&").replace(/<(|\/)(html|body|meta)[^>]*?>/ig,"").trim()===`<a href="${a}">${a}</a>`||n.replace(/&amp;/g,"&").replace(/<(|\/)(html|body|meta)[^>]*?>/ig,"").trim()===`<!--StartFragment--><a href="${a}">${a}</a><!--EndFragment-->`)&&(n=""),a.endsWith(f.ZWSP)&&!n&&!s&&(s=a.substr(0,a.length-1)),!s){const d=new DOMParser().parseFromString(n,"text/html");d.body&&d.body.innerHTML&&(n=d.body.innerHTML),n.startsWith(`
<!--StartFragment-->`)&&n.endsWith(`<!--EndFragment-->

`)&&(n=d.body.innerHTML.trim().replace("<!--StartFragment-->","").replace("<!--EndFragment-->","")),n=Lute.Sanitize(n)}if(e&&e.app&&e.app.plugins)for(let d=0;d<e.app.plugins.length;d++){const u=yield new Promise(p=>{e.app.plugins[d].eventBus.emit("paste",{protyle:e,resolve:p,textHTML:n,textPlain:a,siyuanHTML:s,files:i})&&p(void 0)});u!=null&&u.textHTML&&(n=u.textHTML),u!=null&&u.textPlain&&(a=u.textPlain),u!=null&&u.siyuanHTML&&(s=u.siyuanHTML),u!=null&&u.files&&(i=u.files)}const l=B(t.target);if(!l){i&&i.length>0&&Rn(e,i);return}J(["select"],e),e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl").forEach(d=>{d.classList.remove("protyle-wysiwyg--hl")});const o=Su(n,a),r=ye(e.wysiwyg.element);if(l.getAttribute("data-type")==="NodeCodeBlock"||e.toolbar.getCurrentType(r).includes("code")){Xe(a.replace(/\u200D```/g,"```").replace(/```/g,"\u200D```"),e);return}else if(s){const d=document.createElement("div");d.innerHTML=s;let u=!1;d.querySelectorAll("[data-node-id]").forEach(g=>{const m=Lute.NewNodeID();g.setAttribute("data-node-id",m),g.removeAttribute(f.CUSTOM_RIFF_DECKS),g.classList.remove("protyle-wysiwyg--select","protyle-wysiwyg--hl"),g.setAttribute("updated",m.split("-")[0]),g.removeAttribute("refcount"),u=!0}),l.classList.contains("table")&&(u=!1),d.querySelectorAll('[contenteditable="false"][spellcheck]').forEach(g=>{g.setAttribute("contenteditable","true")});let p=d.innerHTML;if(!l.classList.contains("av")&&p.startsWith("[[{")&&p.endsWith("}]]"))try{const g=JSON.parse(p);g.length>0&&g[0].length>0&&g[0][0].id&&g[0][0].type?Xe(a,e,u):Xe(p,e,u)}catch(g){Xe(p,e,u)}else-1<p.indexOf("NodeHTMLBlock")&&(p=Lute.UnEscapeHTMLStr(p)),p=p.replace(/\u200D```/g,"```"),Xe(p,e,u,!1,!0);Cs(e,e.lute.BlockDOM2StdMd(p)),Se(e,e.wysiwyg.element),Ze(e.wysiwyg.element),Pe(e.wysiwyg.element),ze(e.wysiwyg.element,e)}else if(o)o.startsWith('<div data-type="NodeCodeBlock" class="code-block" data-node-id="')?(Xe(o,e,!0,!1,!0),Pe(e.wysiwyg.element)):Xe(o,e),J(["hint"],e);else{let d=!1;if(n.replace("<!--StartFragment--><!--EndFragment-->","").trim()!==""&&(n=n.replace("<!--StartFragment-->","").replace("<!--EndFragment-->","").trim(),i&&i.length===1&&(n.startsWith("<img")||n.startsWith("<table")&&n.indexOf("<img")>-1)?d=!1:d=!0,a&&a.trim()!==""&&n.startsWith("<span")&&-1<n.indexOf("white-space: pre;")&&(d=!1)),d){const u=document.createElement("div");u.innerHTML=n,u.querySelectorAll("[style]").forEach(p=>{p.removeAttribute("style")}),u.querySelectorAll("a").forEach(p=>{p.innerHTML.trim()===""&&p.remove()}),A("/api/lute/html2BlockDOM",{dom:u.innerHTML},p=>{Xe(p.data,e,!1,!1,!0),e.wysiwyg.element.querySelectorAll('[data-type~="block-ref"]').forEach(g=>{g.textContent===""&&A("/api/block/getRefText",{id:g.getAttribute("data-id")},m=>{g.innerHTML=m.data})}),Se(e,e.wysiwyg.element),Ze(e.wysiwyg.element),Pe(e.wysiwyg.element),ze(e.wysiwyg.element,e),Cs(e,p.data),He(e,void 0,!1,"smooth")});return}else if(i&&i.length>0){Rn(e,i);return}else if(a.trim()!==""&&(i&&i.length===0||!i)){if(r.toString()!==""){const p=a.split(`
`)[0];if(In(a)){e.toolbar.setInlineMark(e,"block-ref","range",{type:"id",color:`${a.substring(2,22+2)}${f.ZWSP}s${f.ZWSP}${r.toString()}`});return}else if(yn(p)){e.toolbar.setInlineMark(e,"file-annotation-ref","range",{type:"file-annotation-ref",color:p.substring(2).replace(/ ".+">>$/,"")});return}else{const g=a.startsWith("assets/")?a:e.lute.GetLinkDest(a);if(g){e.toolbar.setInlineMark(e,"a","range",{type:"a",color:g});return}}}a=a.replace(/\u200D```/g,"```");const u=e.lute.Md2BlockDOM(a);Xe(u,e,!1,!1,!0),Cs(e,a)}Se(e,e.wysiwyg.element),Ze(e.wysiwyg.element),Pe(e.wysiwyg.element),ze(e.wysiwyg.element,e)}const c=l.querySelector(".av__cell--select");l.classList.contains("av")&&c?Qn(l,c):He(e,void 0,!1,"smooth")}),Un=(e,t,n)=>{if(!e.preview.element.classList.contains("fn__none")){e.preview.render(e),Ni(e);return}if(window.siyuan.config.editor.displayBookmarkIcon?e.wysiwyg.element.classList.add("protyle-wysiwyg--attr"):e.wysiwyg.element.classList.remove("protyle-wysiwyg--attr"),e.title&&(e.title.element.removeAttribute("data-render"),e.title.element.setAttribute("spellcheck",window.siyuan.config.editor.spellcheck.toString()),window.siyuan.config.editor.displayBookmarkIcon?e.title.element.classList.add("protyle-wysiwyg--attr"):e.title.element.classList.remove("protyle-wysiwyg--attr")),e.lute.SetProtyleMarkNetImg(window.siyuan.config.editor.displayNetImgMark),e.lute.SetSpellcheck(window.siyuan.config.editor.spellcheck),Vc(e),e.lute.SetGFMStrikethrough1(!1),ei(e),e.options.backlinkData){const a=e.element.getAttribute("data-ismention")==="true",s=$(e.element,"sy__backlink");if(s){const i=s.querySelectorAll(".b3-text-field"),l=a?i[1].value:i[0].value;A(a?"/api/ref/getBackmentionDoc":"/api/ref/getBacklinkDoc",{defID:e.element.getAttribute("data-defid"),refTreeID:e.block.rootID,highlight:!On(),keyword:l},o=>{e.options.backlinkData=a?o.data.backmentions:o.data.backlinks,Ac(e,e.options.backlinkData),Pl(e,o.data.keywords)})}}else en(e),Gl({protyle:e,focus:t,scrollAttr:Pi(e,!0),updateReadonly:n,cb(a){var s;(s=e.query)!=null&&s.key&&Pl(e,a,e.highlight.rangeIndex)}})},Zl=(e,t)=>{A("/api/filetree/createDailyNote",{notebook:t,app:f.SIYUAN_APPID},n=>{at(e,n.data.id)})},zc=e=>{if(window.siyuan.dialogs.find(i=>{if(i.element.getAttribute("data-key")===f.DIALOG_DIALYNOTE)return i.destroy(),!0}))return;const n=as();if(n===0){ae(window.siyuan.languages.newFileTip);return}if(n===1){let i="";window.siyuan.notebooks.find(l=>{l.closed||(i=l.id)}),Zl(e,i);return}const a=window.siyuan.storage[f.LOCAL_DAILYNOTEID],s=window.siyuan.notebooks.find(i=>{if(i.id===a&&!i.closed)return!0});if(a&&s&&!H())Zl(e,a);else{let i="";window.siyuan.notebooks.forEach(c=>{c.closed||(i+=`<option value="${c.id}">${c.name}</option>`)});const l=new we({positionId:f.DIALOG_DIALYNOTE,title:window.siyuan.languages.plsChoose,content:`<div class="b3-dialog__content">
    <select class="b3-select fn__block">${i}</select>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:H()?"92vw":"520px"});l.element.setAttribute("data-key",f.DIALOG_DIALYNOTE);const o=l.element.querySelectorAll(".b3-button"),r=l.element.querySelector(".b3-select");r.value=a,o[0].addEventListener("click",()=>{l.destroy()}),o[1].addEventListener("click",()=>{const c=r.value;window.siyuan.storage[f.LOCAL_DAILYNOTEID]=c,Ae(f.LOCAL_DAILYNOTEID,window.siyuan.storage[f.LOCAL_DAILYNOTEID]),Zl(e,c),l.destroy()})}},Xl=()=>{const e=f.HELP_PATH[window.siyuan.config.appearance.lang];A("/api/notebook/removeNotebook",{notebook:e,callback:f.CB_MOUNT_REMOVE},()=>{A("/api/notebook/openNotebook",{notebook:e,app:f.SIYUAN_APPID})})},Jl=()=>{const e=new we({title:window.siyuan.languages.newNotebook,content:`<div class="b3-dialog__content">
    <input placeholder="${window.siyuan.languages.notebookName}" class="b3-text-field fn__block">
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:H()?"92vw":"520px"});e.element.setAttribute("data-key",f.DIALOG_CREATENOTEBOOK);const t=e.element.querySelectorAll(".b3-button");e.bindInput(e.element.querySelector("input"),()=>{t[1].dispatchEvent(new CustomEvent("click"))}),t[0].addEventListener("click",()=>{e.destroy()}),t[1].addEventListener("click",()=>{const n=e.element.querySelector("input").value;if(!ki(n))return!1;A("/api/notebook/createNotebook",{name:n}),e.destroy()})},Ql=e=>{A("/api/storage/getRecentDocs",{},t=>{let n="";t.data.forEach((a,s)=>{n+=`<li data-index="${s}" data-node-id="${a.rootID}" class="b3-list-item${s===0?" b3-list-item--focus":""}">
${ge(a.icon||window.siyuan.storage[f.LOCAL_IMAGES].file,"b3-list-item__graphic",!0)}
<span class="b3-list-item__text">${pe(a.title)}</span>
</li>`}),sn({title:window.siyuan.languages.recentDocs,icon:"iconList",html:`<ul class="b3-list b3-list--mobile">${n}</ul>`,bindEvent(a){a.firstElementChild.addEventListener("click",s=>{const i=$(s.target,"b3-list-item");i&&at(e,i.dataset.nodeId,[f.CB_GET_SCROLL])})}})})},Ts=(e,t,n)=>{e.addEventListener("mousedown",a=>{const s=$(t,"b3-dialog__body")||$(t,"protyle-util");if(!s)return;s.style.userSelect="none",s.style.pointerEvents="none";const i=document;i.ondragstart=()=>!1;const l=a.clientX,o=t.clientWidth,r=s.clientWidth-256;i.onmousemove=c=>{const d=o+(c.clientX-l);d<256||d>r||(t.style.width=d+"px")},i.onmouseup=()=>{s.style.userSelect="auto",s.style.pointerEvents="",i.onmousemove=null,i.onmouseup=null,i.ondragstart=null,i.onselectstart=null,i.onselect=null,n&&(window.siyuan.storage[f.LOCAL_HISTORY][n]=t.clientWidth+"px",Ae(f.LOCAL_HISTORY,window.siyuan.storage[f.LOCAL_HISTORY]))}})},eo=(e,t)=>{if(!e||e.length===0)return`<li style="padding-left: 40px;" class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;let n="";return e.forEach((a,s)=>{let i="";t&&(i=`data-id2="${t[s].fileID}"`),n+=`<li style="padding-left: 40px;" class="b3-list-item" ${i} data-id="${a.fileID}">
    <span class="b3-list-item__text" title="${We(a.path)} ${a.hSize}">${pe(a.title)}</span>
</li>`}),n};let $a,ti;const Gc=(e,t)=>{if(!$(t,"history__side"))return;const a=$(t,"b3-dialog__container");if(!a)return;const s=a.querySelector('[data-type="editors"]'),i=s.firstElementChild,l=s.lastElementChild;$a||($a=new Yn(e,i.lastElementChild,{blockId:"",history:{snapshot:""},action:[f.CB_GET_HISTORY],render:{background:!1,gutter:!1,breadcrumb:!1,breadcrumbDocName:!1},typewriterMode:!1}),pn($a.protyle),ti=new Yn(e,l.lastElementChild,{blockId:"",action:[f.CB_GET_HISTORY],history:{snapshot:""},render:{background:!1,gutter:!1,breadcrumb:!1,breadcrumbDocName:!1},typewriterMode:!1}),pn(ti.protyle)),A("/api/repo/openRepoSnapshotDoc",{id:t.getAttribute("data-id")},r=>{i.classList.remove("fn__none");const c=i.querySelector("textarea"),d=me().extname(r.data.content).toLowerCase(),u=i.querySelector(".protyle-title__input");f.SIYUAN_ASSETS_IMAGE.concat(f.SIYUAN_ASSETS_AUDIO).concat(f.SIYUAN_ASSETS_VIDEO).includes(d)?(c.previousElementSibling.innerHTML=Ya(r.data.content),c.previousElementSibling.classList.remove("fn__none"),c.classList.add("fn__none"),i.lastElementChild.classList.add("fn__none")):r.data.displayInText?(c.value=r.data.content,c.classList.remove("fn__none"),i.lastElementChild.classList.add("fn__none"),c.previousElementSibling.classList.add("fn__none")):(c.classList.add("fn__none"),i.lastElementChild.classList.remove("fn__none"),c.previousElementSibling.classList.add("fn__none"),$a.protyle.options.history.snapshot=a.querySelector(".b3-dialog__header code").getAttribute("data-snapshot"),Qe({data:r,protyle:$a.protyle,action:[f.CB_GET_HISTORY,f.CB_GET_HTML]})),u.textContent=r.data.title,i.querySelector(".history__date").textContent=U(r.data.updated).format("YYYY-MM-DD HH:mm")});const o=t.getAttribute("data-id2");o?(l.classList.remove("fn__none"),A("/api/repo/openRepoSnapshotDoc",{id:o},r=>{const c=l.querySelector("textarea"),d=me().extname(r.data.content).toLowerCase(),u=l.querySelector(".protyle-title__input");f.SIYUAN_ASSETS_IMAGE.concat(f.SIYUAN_ASSETS_AUDIO).concat(f.SIYUAN_ASSETS_VIDEO).includes(d)?(c.previousElementSibling.innerHTML=Ya(r.data.content),c.previousElementSibling.classList.remove("fn__none"),c.classList.add("fn__none"),l.lastElementChild.classList.add("fn__none")):r.data.displayInText?(c.value=r.data.content,c.classList.remove("fn__none"),l.lastElementChild.classList.add("fn__none"),c.previousElementSibling.classList.add("fn__none")):(c.classList.add("fn__none"),l.lastElementChild.classList.remove("fn__none"),c.previousElementSibling.classList.add("fn__none"),ti.protyle.options.history.snapshot=a.querySelectorAll(".b3-dialog__header code")[1].getAttribute("data-snapshot"),Qe({data:r,protyle:ti.protyle,action:[f.CB_GET_HISTORY,f.CB_GET_HTML]})),u.textContent=r.data.title,l.querySelector(".history__date").textContent=U(r.data.updated).format("YYYY-MM-DD HH:mm")})):l.classList.add("fn__none")},fg=(e,t)=>{if(t.length!==2)return;let n,a;t[0].time>t[1].time?(n=t[1].id,a=t[0].id):(n=t[0].id,a=t[1].id);const s=new we({title:window.siyuan.languages.compare,content:"",width:H()?"92vw":"90vw",height:"80vh",containerClassName:"b3-dialog__container--theme",destroyCallback(){$a=void 0,ti=void 0}});s.element.setAttribute("data-key",f.DIALOG_HISTORYCOMPARE),s.element.addEventListener("click",i=>{var l;if(typeof i.detail=="string"){Gc(e,s.element.querySelector(".history__side .b3-list-item--focus")),i.stopPropagation(),i.preventDefault();return}let o=i.target;for(;o&&o!==s.element;){if(o.classList.contains("b3-list-item")&&!o.dataset.id){o.nextElementSibling.classList.toggle("fn__none"),o.querySelector("svg").classList.toggle("b3-list-item__arrow--open"),i.preventDefault(),i.stopPropagation();break}else if(o.classList.contains("b3-list-item")&&o.dataset.id){if(o.classList.contains("b3-list-item--focus"))return;(l=s.element.querySelector(".history__side .b3-list-item--focus"))==null||l.classList.remove("b3-list-item--focus"),o.classList.add("b3-list-item--focus"),Gc(e,o),i.preventDefault(),i.stopPropagation();break}else if(o.classList.contains("block__icon")){o.getAttribute("data-direct")==="left"?(o.setAttribute("data-direct","right"),to(a,n,s,"right")):(o.setAttribute("data-direct","left"),to(n,a,s,"left")),i.preventDefault(),i.stopPropagation();break}o=o.parentElement}}),to(n,a,s,"left")},to=(e,t,n,a)=>{$a=void 0,ti=void 0;const s=H();A("/api/repo/diffRepoSnapshots",{left:e,right:t},i=>{const l=n.element.querySelector(".b3-dialog__header");l.innerHTML=`<div style="padding: 0;min-height: auto;" class="block__icons">
    <span class="fn__flex-1"></span>
    <code class="fn__code${s?" fn__none":""}" data-snapshot="${e}">${e.substring(0,7)}</code>
    ${s?"":'<span class="fn__space"></span>'}
    ${U(i.data.left.created).format("YYYY-MM-DD HH:mm")}
    <span class="fn__space"></span>
    <span class="block__icon block__icon--show b3-tooltips b3-tooltips__s" aria-label="${window.siyuan.languages.switchDirect}" data-direct="${a}"><svg><use xlink:href="#iconScrollHoriz"></use></svg></span>
    <span class="fn__space"></span>
    <code class="fn__code${s?" fn__none":""}" data-snapshot="${t}">${t.substring(0,7)}</code>
    ${s?"":'<span class="fn__space"></span>'}
    ${U(i.data.right.created).format("YYYY-MM-DD HH:mm")}
    <span class="fn__flex-1"></span>
</div>`,l.nextElementSibling.innerHTML=`<div class="fn__flex history__panel" style="height: 100%">
    <div class="history__side" ${H()?"":`style="width: ${window.siyuan.storage[f.LOCAL_HISTORY].sideDiffWidth}"`}>
        <ul class="b3-list b3-list--background">
            <li class="b3-list-item">
                <span class="b3-list-item__toggle b3-list-item__toggle--hl">
                    <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
                </span>
                <span style="padding-left: 4px" class="b3-list-item__text">${window.siyuan.languages.update}</span>
                <span class="counter${i.data.updatesLeft.length===0?" fn__none":""}">${i.data.updatesLeft.length}</span>
            </li>
            <ul class="fn__none">${eo(i.data.updatesLeft,i.data.updatesRight)}</ul>
        </ul>
        <ul class="b3-list b3-list--background">
            <li class="b3-list-item">
                <span class="b3-list-item__toggle b3-list-item__toggle--hl">
                    <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
                </span>
                <span style="padding-left: 4px" class="b3-list-item__text">${window.siyuan.languages.addAttr}</span>
                <span class="counter${i.data.addsLeft.length===0?" fn__none":""}">${i.data.addsLeft.length}</span>
            </li>
            <ul class="fn__none">${eo(i.data.addsLeft)}</ul>
        </ul>
        <ul class="b3-list b3-list--background">
            <li class="b3-list-item">
                <span class="b3-list-item__toggle b3-list-item__toggle--hl">
                    <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
                </span>
                <span style="padding-left: 4px" class="b3-list-item__text">${window.siyuan.languages.remove}</span>
                <span class="counter${i.data.removesRight.length===0?" fn__none":""}">${i.data.removesRight.length}</span>
            </li>
            <ul class="fn__none">${eo(i.data.removesRight)}</ul>
        </ul>
    </div>
    <div class="history__resize"></div>
    <div class="fn__flex-1 fn__flex" data-type="editors">
        <div class="fn__none fn__flex-1 fn__flex-column">
            <div class="history__date">${U(i.data.left.created).format("YYYY-MM-DD HH:mm")}</div>
            <div class="protyle-title__input ft__center ft__breakword">${i.data.left.title}</div>
            <div class="ft__center"></div>
            <textarea class="history__text fn__none fn__flex-1" readonly></textarea>
            <div class="fn__flex-1"></div>
        </div>
        <div class="fn__none fn__flex-1 fn__flex-column" style="border-left: 1px solid var(--b3-border-color);">
            <div class="history__date">${i.data.right.title} ${U(i.data.right.created).format("YYYY-MM-DD HH:mm")}</div>
            <div class="protyle-title__input ft__center ft__breakword">${i.data.right.title}</div>
            <div class="ft__center"></div>
            <textarea class="history__text fn__none fn__flex-1" readonly></textarea>
            <div class="fn__flex-1"></div>
        </div>
    </div>
</div>`,Ts(n.element.querySelector(".history__resize"),n.element.querySelector(".history__side"),"sideDiffWidth")})};let Ia;const ni=(e,t)=>{const n=e.querySelector('[data-type="docprevious"]'),a=e.querySelector('[data-type="docnext"]');e.setAttribute("data-page",t.toString()),t>1?n.removeAttribute("disabled"):n.setAttribute("disabled","disabled");const s=e.querySelector('button[data-type="jumpHistoryPage"]');s.textContent=`${t}`;const i=e.querySelector(".b3-text-field"),l=e.querySelector('.b3-select[data-type="opselect"]'),o=e.querySelector('.b3-select[data-type="typeselect"]'),r=e.querySelector('.b3-select[data-type="notebookselect"]'),c=e.querySelector('.history__text[data-type="docPanel"]'),d=e.querySelector('.history__text[data-type="assetPanel"]'),u=e.querySelector('.history__text[data-type="mdPanel"]'),p=e.querySelector(".b3-list");e.querySelector(".protyle-title__input").classList.add("fn__none"),d.classList.add("fn__none"),u.classList.add("fn__none"),c.classList.add("fn__none"),o.value==="2"?(r.setAttribute("disabled","disabled"),window.siyuan.storage[f.LOCAL_HISTORY].type!==2&&(l.value="all"),l.querySelector('option[value="clean"]').classList.remove("fn__none"),l.querySelector('option[value="update"]').classList.remove("fn__none"),l.querySelector('option[value="delete"]').classList.add("fn__none"),l.querySelector('option[value="format"]').classList.add("fn__none"),l.querySelector('option[value="sync"]').classList.remove("fn__none"),l.querySelector('option[value="replace"]').classList.add("fn__none"),l.querySelector('option[value="outline"]').classList.add("fn__none")):(r.removeAttribute("disabled"),window.siyuan.storage[f.LOCAL_HISTORY].type===2&&(l.value="all"),l.querySelector('option[value="clean"]').classList.add("fn__none"),l.querySelector('option[value="update"]').classList.remove("fn__none"),l.querySelector('option[value="delete"]').classList.remove("fn__none"),l.querySelector('option[value="format"]').classList.remove("fn__none"),l.querySelector('option[value="sync"]').classList.remove("fn__none"),l.querySelector('option[value="replace"]').classList.remove("fn__none"),l.querySelector('option[value="outline"]').classList.remove("fn__none")),window.siyuan.storage[f.LOCAL_HISTORY].notebookId=r.value,window.siyuan.storage[f.LOCAL_HISTORY].type=parseInt(o.value),window.siyuan.storage[f.LOCAL_HISTORY].operation=l.value,Ae(f.LOCAL_HISTORY,window.siyuan.storage[f.LOCAL_HISTORY]),A("/api/history/searchHistory",{notebook:r.value,query:i.value,page:t,op:l.value,type:parseInt(o.value)},g=>{t<g.data.pageCount?a.removeAttribute("disabled"):a.setAttribute("disabled","disabled"),s.setAttribute("data-totalpage",(g.data.pageCount||1).toString());const m=a.nextElementSibling.nextElementSibling;if(m.textContent=`${window.siyuan.languages.pageCountAndHistoryCount.replace("${x}",g.data.pageCount).replace("${y}",g.data.totalCount||1)}`,m.classList.remove("fn__none"),g.data.histories.length===0){p.innerHTML=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;return}let b="";g.data.histories.forEach(y=>{b+=`<li class="b3-list-item" data-type="toggle" data-created="${y}">
    <span class="b3-list-item__toggle b3-list-item__toggle--hl"><svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg></span>
    <span style="padding-left: 4px" class="b3-list-item__text">${U(parseInt(y)*1e3).format("YYYY-MM-DD HH:mm:ss")}</span>
</li>`}),p.innerHTML=b})},Kc=(e,t,n)=>{if(e.data.snapshots.length===0){t.lastElementChild.innerHTML=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;return}let a="";n==="getCloudRepoTagSnapshots"?a=`<span class="fn__flex-1"></span>
<span class="b3-list-item__action" data-type="downloadSnapshot">
    <svg><use xlink:href="#iconDownload"></use></svg>
    <span class="fn__space"></span>
    ${window.siyuan.languages.download}
</span>
<span class="fn__flex-1"></span>
<span class="b3-list-item__action" data-type="removeCloudRepoTagSnapshot">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
    <span class="fn__space"></span>
    ${window.siyuan.languages.remove}
</span>
<span class="fn__flex-1"></span>`:n==="getCloudRepoSnapshots"?a=`<span class="fn__flex-1"></span>
<span class="b3-list-item__action" data-type="downloadSnapshot">
    <svg><use xlink:href="#iconDownload"></use></svg>
    <span class="fn__space"></span>
    ${window.siyuan.languages.download}
</span>
<span class="fn__flex-1"></span>`:n==="getRepoTagSnapshots"?a=`<span class="fn__flex-1"></span>
<span class="b3-list-item__action" data-type="uploadSnapshot">
    <svg><use xlink:href="#iconUpload"></use></svg>
    <span class="fn__space"></span>
    ${window.siyuan.languages.upload}
</span>
<span class="fn__flex-1"></span>
<span class="b3-list-item__action" data-type="rollback">
    <svg><use xlink:href="#iconUndo"></use></svg>
    <span class="fn__space"></span>
    ${window.siyuan.languages.rollback}
</span>
<span class="fn__flex-1"></span>
<span class="b3-list-item__action" data-type="removeRepoTagSnapshot">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
    <span class="fn__space"></span>
    ${window.siyuan.languages.remove}
</span>
<span class="fn__flex-1"></span>`:n==="getRepoSnapshots"&&(a=`<span class="fn__flex-1"></span>
<span class="b3-list-item__action" data-type="genTag">
    <svg><use xlink:href="#iconTags"></use></svg>
    <span class="fn__space"></span>
    ${window.siyuan.languages.tagSnapshot}
</span>
<span class="fn__flex-1"></span>
<span class="b3-list-item__action" data-type="rollback">
    <svg><use xlink:href="#iconUndo"></use></svg>
    <span class="fn__space"></span>
    ${window.siyuan.languages.rollback}
</span>
<span class="fn__flex-1"></span>`);let s="";const i=H();e.data.snapshots.forEach(l=>{let o="";l.typesCount&&(o=`<div class="b3-list-item__meta${i?" fn__none":""}">
${window.siyuan.languages.fileCount} ${l.count}<span class="fn__space"></span>`,l.typesCount.forEach(c=>{o+=`${c.type} ${c.count}<span class="fn__space"></span>`}),o+="</div>");const r=`<div${i?' style="padding-top:8px"':""}>
    <span data-type="hCreated">${l.hCreated}</span>
    <span class="fn__space"></span>
    ${l.hSize}
    <span class="fn__space"></span>
    ${l.systemOS}${l.systemName&&l.systemOS?"/":""}${l.systemName}
    <span class="fn__space"></span>
    <span class="b3-chip b3-chip--secondary b3-chip--small${l.tag?"":" fn__none"}">${l.tag}</span>
</div>
<div class="b3-list-item__meta${i?" fn__none":""}">
    ${pe(l.memo)}
    <span class="fn__space"></span>
    <code class="fn__code">${l.id.substring(0,7)}</code>
</div>
${o}`;s+=`<li class="b3-list-item" data-type="repoitem" data-id="${l.id}" data-tag="${l.tag}">
<div class="fn__flex-1">
    ${r}
    <div class="fn__flex" style="height: 26px" data-id="${l.id}" data-tag="${l.tag}">
        ${a}
        <span class="b3-list-item__action" data-type="more">
            <svg><use xlink:href="#iconMore"></use></svg>
            <span class="fn__space"></span>
            ${window.siyuan.languages.more}
        </span>
        <span class="fn__flex-1"></span>
    </div>
</div>
</li>`}),t.lastElementChild.innerHTML=`${s}`},ua=(e,t)=>{const n=e.querySelector(".b3-select");n.disabled=!0;const a=n.value;e.lastElementChild.innerHTML='<li style="position: relative;height: 100%;"><div class="fn__loading"><img width="64px" src="/stage/loading-pure.svg"></div></li>';const s=e.querySelector('button[data-type="jumpRepoPage"]');s.textContent=`${t}`;const i=e.querySelector('[data-type="previous"]'),l=e.querySelector('[data-type="next"]'),o=l.nextElementSibling.nextElementSibling;e.setAttribute("data-init","true"),a==="getRepoTagSnapshots"||a==="getCloudRepoTagSnapshots"?(A(`/api/repo/${a}`,{},r=>{Kc(r,e,a),n.disabled=!1}),i.classList.add("fn__none"),l.classList.add("fn__none"),o.classList.add("fn__none"),s.classList.add("fn__none")):(i.classList.remove("fn__none"),l.classList.remove("fn__none"),s.classList.remove("fn__none"),e.setAttribute("data-page",t.toString()),t>1?i.removeAttribute("disabled"):i.setAttribute("disabled","disabled"),l.setAttribute("disabled","disabled"),A(`/api/repo/${a}`,{page:t},r=>{n.disabled=!1,t<r.data.pageCount?l.removeAttribute("disabled"):l.setAttribute("disabled","disabled"),s.setAttribute("data-totalpage",(r.data.pageCount||1).toString()),o.textContent=`${window.siyuan.languages.pageCountAndSnapshotCount.replace("${x}",r.data.pageCount).replace("${y}",r.data.totalCount||1)}`,o.classList.remove("fn__none"),Kc(r,e,a)}))},gg=e=>{e.setAttribute("data-init","true"),A("/api/history/getNotebookHistory",{},t=>{if(t.data.histories.length===0){e.innerHTML=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;return}let n="";t.data.histories.forEach((a,s)=>{n+=`<li class="b3-list-item" style="padding-left: 0" data-type="rmtoggle">
    <span style="padding-left: 8px" class="b3-list-item__toggle"><svg class="b3-list-item__arrow${s===0?" b3-list-item__arrow--open":""}${a.items.length>0?"":" fn__hidden"}"><use xlink:href="#iconRight"></use></svg></span>
    <span class="b3-list-item__text">${a.hCreated}</span>
</li>`,a.items.length>0&&(n+=`<ul class="${s===0?"":"fn__none"}">`,a.items.forEach(i=>{n+=`<li data-type="notebook" data-path="${i.path}" class="b3-list-item b3-list-item--hide-action" style="padding-left: 32px">
    <span class="b3-list-item__text">${pe(i.title)}</span>
    <span class="fn__space"></span>
    <span class="b3-list-item__action b3-tooltips b3-tooltips__w" data-type="rollback" aria-label="${window.siyuan.languages.rollback}">
        <svg><use xlink:href="#iconUndo"></use></svg>
    </span>
</li>`}),n+="</ul>")}),e.innerHTML=n})},no=e=>{if(window.siyuan.config.readonly||window.siyuan.dialogs.find(i=>{if(i.element.querySelector("#historyContainer"))return i.destroy(),!0}))return;const n=window.siyuan.storage[f.LOCAL_HISTORY];let a=`<option value='%' ${n.notebookId==="%"?"selected":""}>${window.siyuan.languages.allNotebooks}</option>`;window.siyuan.notebooks.forEach(i=>{i.closed||(a+=` <option value="${i.id}"${i.id===n.notebookId?" selected":""}>${pe(i.name)}</option>`)});const s=`<div class="fn__flex-column" style="height: 100%;">
    <div class="layout-tab-bar fn__flex" ${H()?"":'style="border-radius: var(--b3-border-radius-b) var(--b3-border-radius-b) 0 0"'}>
        <div data-type="doc" class="item item--full item--focus"><span class="fn__flex-1"></span><span class="item__text">${window.siyuan.languages.fileHistory}</span><span class="fn__flex-1"></span></div>
        <div data-type="notebook" style="min-width: 160px" class="item item--full"><span class="fn__flex-1"></span><span class="item__text">${window.siyuan.languages.removedNotebook}</span><span class="fn__flex-1"></span></div>
        <div data-type="repo" class="item item--full"><span class="fn__flex-1"></span><span class="item__text">${window.siyuan.languages.dataSnapshot}</span><span class="fn__flex-1"></span></div>
    </div>
    <div class="fn__flex-1 fn__flex" id="historyContainer">
        <div data-type="doc" class="history__repo fn__block" data-init="true">
            <div class="history__action">
                <div class="block__icons">
                    <span data-type="docprevious" class="block__icon block__icon--show b3-tooltips b3-tooltips__e" disabled="disabled" aria-label="${window.siyuan.languages.previousLabel}"><svg><use xlink:href='#iconLeft'></use></svg></span>
                    <button class="b3-button b3-button--text ft__selectnone" data-type="jumpHistoryPage" data-totalpage="1">1</button>
                    <span data-type="docnext" class="block__icon block__icon--show b3-tooltips b3-tooltips__e" disabled="disabled" aria-label="${window.siyuan.languages.nextLabel}"><svg><use xlink:href='#iconRight'></use></svg></span>
                    <span class="fn__space"></span>
                    <span class="ft__on-surface fn__flex-shrink ft__selectnone fn__none">${window.siyuan.languages.pageCountAndHistoryCount}</span>
                    <span class="fn__space"></span>
                    <div class="fn__flex-1"></div>
                    <div style="position: relative">
                        <svg class="b3-form__icon-icon ft__on-surface"><use xlink:href="#iconSearch"></use></svg>
                        <input class="b3-text-field b3-form__icon-input ${H()?"fn__size96":"fn__size200"}">
                    </div>
                    <span class="fn__space"></span>
                    <select data-type="typeselect" class="b3-select ${H()?"fn__size96":"fn__size200"}">
                        <option value="0" ${n.type===0?"selected":""}>${window.siyuan.languages.docName}</option>
                        <option value="1" ${n.type===1?"selected":""}>${window.siyuan.languages.docNameAndContent}</option>
                        <option value="2" ${n.type===2?"selected":""}>${window.siyuan.languages.assets}</option>
                    </select>
                    <span class="fn__space"></span>
                    <select data-type="opselect" class="b3-select${H()?" fn__size96":""}">
                        <option value="all" ${n.operation==="all"?"selected":""}>${window.siyuan.languages.allOp}</option>
                        <option value="clean" ${n.operation==="clean"?"selected":""}>${window.siyuan.languages.historyClean}</option>
                        <option value="update" ${n.operation==="update"?"selected":""}>${window.siyuan.languages.historyUpdate}</option>
                        <option value="delete" ${n.operation==="delete"?"selected":""}>${window.siyuan.languages.historyDelete}</option>
                        <option value="format" ${n.operation==="format"?"selected":""}>${window.siyuan.languages.historyFormat}</option>
                        <option value="sync" ${n.operation==="sync"?"selected":""}>${window.siyuan.languages.historySync}</option>
                        <option value="replace" ${n.operation==="replace"?"selected":""}>${window.siyuan.languages.historyReplace}</option>
                        <option value="outline" ${n.operation==="outline"?"selected":""}>${window.siyuan.languages.historyOutline}</option>
                    </select>
                    <span class="fn__space"></span>
                    <select data-type="notebookselect" class="b3-select ${H()?"fn__size96":"fn__size200"}">
                        ${a}
                    </select>
                    <span class="fn__space"></span>
                    <button data-type="rebuildIndex" class="b3-button b3-button--outline">${window.siyuan.languages.rebuildIndex}</button>
                </div>
            </div>
            <div class="fn__flex fn__flex-1 history__panel">
                <ul class="b3-list b3-list--background history__side" ${H()?"":`style="width: ${n.sideWidth}"`}>
                    <li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>
                </ul>
                <div class="history__resize"></div>
                <div class="fn__flex-column fn__flex-1">
                    <div class="protyle-title__input ft__center ft__breakword fn__none"></div>
                    <div class="fn__flex-1 history__text fn__none" data-type="assetPanel"></div>
                    <textarea class="fn__flex-1 history__text fn__none" data-type="mdPanel"></textarea>
                    <div class="fn__flex-1 history__text fn__none" style="padding: 0" data-type="docPanel"></div>
                </div>
            </div>
        </div>
        <ul data-type="notebook" style="padding: 8px 0;" class="fn__none b3-list b3-list--background">
            <li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>
        </ul>
        <div data-type="repo" class="fn__none history__repo">
            <div class="history__action">
                <div class="block__icons">
                    <span data-type="previous" class="block__icon block__icon--show b3-tooltips b3-tooltips__e" disabled="disabled" aria-label="${window.siyuan.languages.previousLabel}"><svg><use xlink:href='#iconLeft'></use></svg></span>
                    <button class="b3-button b3-button--text ft__selectnone" data-type="jumpRepoPage" data-totalpage="1">1</button>
                    <span data-type="next" class="block__icon block__icon--show b3-tooltips b3-tooltips__e" disabled="disabled" aria-label="${window.siyuan.languages.nextLabel}"><svg><use xlink:href='#iconRight'></use></svg></span>
                    <span class="fn__space"></span>
                    <span class="ft__on-surface fn__flex-shrink ft__selectnone fn__none">${window.siyuan.languages.pageCountAndSnapshotCount}</span>
                    <span class="fn__space"></span>
                    <div class="fn__flex-1"></div>
                    <select class="b3-select ${H()?"fn__size96":"fn__size200"}">
                        <option value="getRepoSnapshots">${window.siyuan.languages.localSnapshot}</option>
                        <option value="getRepoTagSnapshots">${window.siyuan.languages.localTagSnapshot}</option>
                        <option value="getCloudRepoSnapshots">${window.siyuan.languages.cloudSnapshot}</option>
                        <option value="getCloudRepoTagSnapshots">${window.siyuan.languages.cloudTagSnapshot}</option>
                    </select>
                    <span class="fn__space"></span>
                    <button class="b3-button b3-button--outline" disabled data-type="compare">${window.siyuan.languages.compare}</button>
                    <span class="fn__space"></span>
                    <button class="b3-button b3-button--outline" data-type="genRepo">
                        <svg><use xlink:href="#iconAdd"></use></svg>${window.siyuan.languages.createSnapshot}
                    </button>
                </div>    
            </div>
            <ul class="b3-list b3-list--background fn__flex-1" style="padding-bottom: 8px">
                <li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>
            </ul>
        </div>
    </div>
</div>`;if(H())sn({html:s,icon:"iconHistory",title:window.siyuan.languages.dataHistory,bindEvent(i){i.firstElementChild.setAttribute("style","background-color:var(--b3-theme-background);height:100%"),Zc(e,i.firstElementChild)}});else{const i=new we({content:s,width:"90vw",height:"80vh",containerClassName:"b3-dialog__container--theme",destroyCallback(){Ia=void 0}});i.element.setAttribute("data-key",f.DIALOG_HISTORY),i.element.querySelector("input").focus(),Zc(e,i.element,i),Ts(i.element.querySelector(".history__resize"),i.element.querySelector(".history__side"),"sideWidth")}},Zc=(e,t,n)=>{const a=t.querySelector("#historyContainer [data-type=doc]");a.querySelectorAll(".b3-select").forEach(u=>{u.addEventListener("change",()=>{ni(a,1)})}),a.querySelector(".b3-text-field").addEventListener("input",u=>{u.isComposing||ni(a,1)}),a.querySelector(".b3-text-field").addEventListener("compositionend",()=>{ni(a,1)});const s=a.querySelector('.history__text[data-type="docPanel"]'),i=a.querySelector('.history__text[data-type="assetPanel"]'),l=a.querySelector('.history__text[data-type="mdPanel"]'),o=a.querySelector(".protyle-title__input");ni(a,1),Ia=new Yn(e,s,{blockId:"",history:{created:""},action:[f.CB_GET_HISTORY],render:{background:!1,gutter:!1,breadcrumb:!1,breadcrumbDocName:!1},typewriterMode:!1}),pn(Ia.protyle);const r=t.querySelector('#historyContainer [data-type="repo"]'),c=t.querySelector('#historyContainer [data-type="doc"]'),d=r.querySelector(".b3-select");d.addEventListener("change",()=>{ua(r,1);const u=t.querySelector(".b3-button[data-type='compare']");u.setAttribute("disabled","disabled"),u.removeAttribute("data-ids")}),t.addEventListener("click",u=>{var p;let g=u.target;for(;g&&!g.isEqualNode(t);){const m=g.getAttribute("data-type");if(g.classList.contains("item")){g.parentElement.querySelector(".item--focus").classList.remove("item--focus"),Array.from(t.querySelector("#historyContainer").children).forEach(b=>{b.getAttribute("data-type")===m?(b.classList.remove("fn__none"),b.classList.add("fn__block"),g.classList.add("item--focus"),b.getAttribute("data-init")!=="true"&&(m==="notebook"?gg(b):m==="repo"&&ua(b,1))):(b.classList.add("fn__none"),b.classList.remove("fn__block"))}),u.stopPropagation(),u.preventDefault();break}else if(g.classList.contains("b3-list-item__action")&&m==="rollback"&&!window.siyuan.config.readonly){const b=g.parentElement.getAttribute("data-type");let y=g.previousElementSibling.previousElementSibling.textContent.trim(),_=U(parseInt(g.parentElement.getAttribute("data-created"))*1e3).format("YYYY-MM-DD HH:mm:ss");b==="notebook"?_=g.parentElement.parentElement.previousElementSibling.textContent.trim():b==="repoitem"&&(y=window.siyuan.languages.workspaceData,_=g.parentElement.querySelector("span[data-type='hCreated']").textContent.trim());const w=window.siyuan.languages.rollbackConfirm.replace("${name}",y).replace("${time}",_);$e("\u26A0\uFE0F "+window.siyuan.languages.rollback,w,()=>{b==="assets"?A("/api/history/rollbackAssetsHistory",{historyPath:g.parentElement.getAttribute("data-path")}):b==="doc"?A("/api/history/rollbackDocHistory",{notebook:g.parentElement.getAttribute("data-notebook-id"),historyPath:g.parentElement.getAttribute("data-path")}):b==="notebook"?A("/api/history/rollbackNotebookHistory",{historyPath:g.parentElement.getAttribute("data-path")}):A("/api/repo/checkoutRepo",{id:g.parentElement.getAttribute("data-id")})}),u.stopPropagation(),u.preventDefault();break}else if(m==="more"){g.parentElement.parentElement.querySelectorAll(".b3-list-item__meta").forEach(b=>{b.classList.toggle("fn__none")}),u.stopPropagation(),u.preventDefault();break}else if(m==="toggle"){const b=g.firstElementChild.firstElementChild;if(b.classList.contains("b3-list-item__arrow--open"))g.nextElementSibling.classList.add("fn__none"),b.classList.remove("b3-list-item__arrow--open");else if(g.nextElementSibling&&g.nextElementSibling.tagName==="UL")g.nextElementSibling.classList.remove("fn__none"),b.classList.add("b3-list-item__arrow--open");else{const y=a.querySelector(".b3-text-field"),_=a.querySelector('.b3-select[data-type="opselect"]'),w=a.querySelector('.b3-select[data-type="typeselect"]'),v=a.querySelector('.b3-select[data-type="notebookselect"]'),h=g.getAttribute("data-created");A("/api/history/getHistoryItems",{notebook:v.value,query:y.value,op:_.value,type:parseInt(w.value),created:h},E=>{b.classList.add("b3-list-item__arrow--open");let S="",L="";E.data.items.forEach(k=>{let x=" b3-chip b3-chip--list ";k.op==="clean"?(x+="b3-chip--primary ",L=window.siyuan.languages.historyClean):k.op==="update"?(x+="b3-chip--info ",L=window.siyuan.languages.historyUpdate):k.op==="delete"?(x+="b3-chip--error ",L=window.siyuan.languages.historyDelete):k.op==="format"?(x+="b3-chip--pink ",L=window.siyuan.languages.historyFormat):k.op==="sync"?(x+="b3-chip--success ",L=window.siyuan.languages.historySync):k.op==="replace"?(x+="b3-chip--secondary ",L=window.siyuan.languages.historyReplace):k.op==="outline"&&(x+="b3-chip--warning ",L=window.siyuan.languages.historyOutline),S+=`<li data-notebook-id="${k.notebook}" data-created="${h}" data-type="${w.value==="2"?"assets":"doc"}" data-path="${k.path}" class="b3-list-item b3-list-item--hide-action" style="padding-left: 22px">
    <span class="${_.value==="all"?"":"fn__none"}${x}ariaLabel" data-position="6south" aria-label="${L}">${k.op.substring(0,1).toUpperCase()}</span>
    <span class="b3-list-item__text" title="${We(k.title)}">${pe(k.title)}</span>
    <span class="fn__space"></span>
    <span class="b3-list-item__action ariaLabel" data-type="rollback" data-position="6south" aria-label="${window.siyuan.languages.rollback}">
        <svg><use xlink:href="#iconUndo"></use></svg>
    </span>
</li>`}),g.insertAdjacentHTML("afterend",`<ul>${S}</ul>`)})}u.stopPropagation(),u.preventDefault();break}else if(m==="rmtoggle"){g.nextElementSibling.classList.toggle("fn__none"),g.firstElementChild.firstElementChild.classList.toggle("b3-list-item__arrow--open"),u.stopPropagation(),u.preventDefault();break}else if(g.classList.contains("b3-list-item")&&m==="repoitem"&&["getRepoSnapshots","getRepoTagSnapshots"].includes(d.value)){const b=t.querySelector(".b3-button[data-type='compare']"),y=JSON.parse(b.getAttribute("data-ids")||"[]"),_=g.getAttribute("data-id");if(g.classList.contains("b3-list-item--focus"))g.classList.remove("b3-list-item--focus"),y.forEach((w,v)=>{_===w.id&&y.splice(v,1)});else{for(g.classList.add("b3-list-item--focus");y.length>1;)y[0].id!==_&&((p=g.parentElement.querySelector(`.b3-list-item[data-id="${y.splice(0,1)[0].id}"]`))==null||p.classList.remove("b3-list-item--focus"));y.push({id:_,time:g.querySelector('[data-type="hCreated"]').textContent})}y.length===2?b.removeAttribute("disabled"):b.setAttribute("disabled","disabled"),b.setAttribute("data-ids",JSON.stringify(y)),u.stopPropagation(),u.preventDefault();break}else if(g.classList.contains("b3-list-item")&&(m==="assets"||m==="doc")){const b=g.getAttribute("data-path");if(m==="assets")i.classList.remove("fn__none"),i.innerHTML=Ya(b);else if(m==="doc"){const _=a.querySelector(".b3-text-field").value;A("/api/history/getDocHistoryContent",{historyPath:b,highlight:!On(),k:_},w=>{w.data.isLargeDoc?(l.value=w.data.content,l.classList.remove("fn__none"),s.classList.add("fn__none")):(l.classList.add("fn__none"),s.classList.remove("fn__none"),Ia.protyle.options.history.created=g.dataset.created,Qe({data:w,protyle:Ia.protyle,action:[f.CB_GET_HISTORY,f.CB_GET_HTML]}),Pl(Ia.protyle,_.split(" ")))})}o.classList.remove("fn__none"),o.textContent=g.querySelector(".b3-list-item__text").textContent;let y=$(g,"b3-list");y&&(y=y.querySelector(".b3-list-item--focus"),y&&y.classList.remove("b3-list-item--focus")),g.classList.add("b3-list-item--focus"),u.stopPropagation(),u.preventDefault();break}else if(m==="genRepo"){const b=new we({title:window.siyuan.languages.snapshotMemo,content:`<div class="b3-dialog__content">
    <textarea class="b3-text-field fn__block" placeholder="${window.siyuan.languages.snapshotMemoTip}"></textarea>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:H()?"92vw":"520px"});b.element.setAttribute("data-key",f.DIALOG_SNAPSHOTMEMO);const y=b.element.querySelector("textarea");y.focus();const _=b.element.querySelectorAll(".b3-button");b.bindInput(y,()=>{_[1].click()}),_[0].addEventListener("click",()=>{b.destroy()}),_[1].addEventListener("click",()=>{A("/api/repo/createSnapshot",{memo:y.value},()=>{ua(r,1)}),b.destroy()}),u.stopPropagation(),u.preventDefault();break}else if(m==="removeRepoTagSnapshot"||m==="removeCloudRepoTagSnapshot"){const b=g.parentElement.getAttribute("data-tag");$e(window.siyuan.languages.deleteOpConfirm,`${window.siyuan.languages.confirmDelete} <i>${b}</i>?`,()=>{A("/api/repo/"+m,{tag:b},()=>{ua(r,1)})},void 0,!0),u.stopPropagation(),u.preventDefault();break}else if(m==="uploadSnapshot"){A("/api/repo/uploadCloudSnapshot",{tag:g.parentElement.getAttribute("data-tag"),id:g.parentElement.getAttribute("data-id")}),u.stopPropagation(),u.preventDefault();break}else if(m==="downloadSnapshot"){A("/api/repo/downloadCloudSnapshot",{tag:g.parentElement.getAttribute("data-tag"),id:g.parentElement.getAttribute("data-id")}),u.stopPropagation(),u.preventDefault();break}else if(m==="genTag"){const b=new we({title:window.siyuan.languages.tagSnapshot,content:`<div class="b3-dialog__content">
    <input class="b3-text-field fn__block" value="${U().format("YYYYMMDDHHmmss")}" placeholder="${window.siyuan.languages.tagSnapshotTip}">
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.tagSnapshot}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.tagSnapshotUpload}</button>
</div>`,width:H()?"92vw":"520px"});b.element.setAttribute("data-key",f.DIALOG_SNAPSHOTTAG);const y=b.element.querySelector(".b3-text-field");y.select();const _=b.element.querySelectorAll(".b3-button");_[0].addEventListener("click",()=>{b.destroy()}),_[2].addEventListener("click",()=>{A("/api/repo/tagSnapshot",{id:g.parentElement.getAttribute("data-id"),name:y.value},()=>{A("/api/repo/uploadCloudSnapshot",{tag:y.value,id:g.parentElement.getAttribute("data-id")},()=>{ua(r,1)})}),b.destroy()}),_[1].addEventListener("click",()=>{A("/api/repo/tagSnapshot",{id:g.parentElement.getAttribute("data-id"),name:y.value},()=>{ua(r,1)}),b.destroy()}),u.stopPropagation(),u.preventDefault();break}else if((m==="previous"||m==="next")&&g.getAttribute("disabled")!=="disabled"){const b=parseInt(r.getAttribute("data-page"));ua(r,m==="previous"?b-1:b+1),u.stopPropagation(),u.preventDefault();break}else if(m==="jumpRepoPage"){const b=parseInt(r.getAttribute("data-page")),y=parseInt(g.getAttribute("data-totalpage")||"1");y>1&&$e(window.siyuan.languages.jumpToPage.replace("${x}",y),`<input class="b3-text-field fn__block" type="number" min="1" max="${y}" value="${b}">`,_=>{const w=_.element.querySelector(".b3-text-field");if(w.value==="")return;let v=parseInt(w.value);v=Math.max(1,Math.min(v,y)),ua(r,v)})}else if(m==="jumpHistoryPage"){const b=parseInt(c.getAttribute("data-page")),y=parseInt(g.getAttribute("data-totalpage")||"1");y>1&&$e(window.siyuan.languages.jumpToPage.replace("${x}",y),`<input class="b3-text-field fn__block" type="number" min="1" max="${y}" value="${b}">`,_=>{const w=_.element.querySelector(".b3-text-field");if(w.value==="")return;let v=parseInt(w.value);v=Math.max(1,Math.min(v,y)),ni(a,v)})}else if((m==="docprevious"||m==="docnext")&&g.getAttribute("disabled")!=="disabled"){const b=parseInt(a.getAttribute("data-page"));ni(a,m==="docprevious"?b-1:b+1),u.stopPropagation(),u.preventDefault();break}else if(m==="rebuildIndex"){A("/api/history/reindexHistory"),n?n.destroy():(_l(),Ia=void 0),u.stopPropagation(),u.preventDefault();break}else if(m==="compare"&&!g.getAttribute("disabled")){fg(e,JSON.parse(g.getAttribute("data-ids")||"[]")),u.stopPropagation(),u.preventDefault();break}g=g.parentElement}})},ii=e=>{si(window.siyuan.languages.siyuanNote),document.getElementById("toolbarName").classList.add("fn__hidden"),document.getElementById("editor").classList.add("fn__none");const t=document.getElementById("empty");t.classList.remove("fn__none"),t.innerHTML===""&&(t.innerHTML=`<div id="emptySearch" class="b3-list-item">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconSearch"></use></svg><span class="fn__space"></span><span class="b3-list-item__text">${window.siyuan.languages.search}</span>
</div>
<div id="emptyRecent" class="b3-list-item">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconList"></use></svg><span class="fn__space"></span><span class="b3-list-item__text">${window.siyuan.languages.recentDocs}</span>
</div>
<div id="emptyHistory" class="b3-list-item${window.siyuan.config.readonly?" fn__none":""}">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconHistory"></use></svg><span class="fn__space"></span><span class="b3-list-item__text">${window.siyuan.languages.dataHistory}</span>
</div>
<div id="emptyNewFile" class="b3-list-item${as()>0||!window.siyuan.config.readonly?"":" fn__none"}">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg><span class="fn__space"></span><span class="b3-list-item__text">${window.siyuan.languages.newFile}</span>
</div>
<div class="b3-list-item" id="emptyNewNotebook${window.siyuan.config.readonly?" fn__none":""}">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconFilesRoot"></use></svg><span class="fn__space"></span><span class="b3-list-item__text">${window.siyuan.languages.newNotebook}</span>
</div>
<div class="b3-list-item${Dn()||window.siyuan.config.readonly?" fn__none":""}" id="emptyHelp">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconHelp"></use></svg><span class="fn__space"></span><span class="b3-list-item__text">${window.siyuan.languages.userGuide}</span>
</div>`,t.addEventListener("click",n=>{let a=n.target;for(;a&&!a.isEqualNode(t);){if(a.id==="emptySearch"){qt(e),n.stopPropagation(),n.preventDefault();break}else if(a.id==="emptyRecent"){Ql(e),n.stopPropagation(),n.preventDefault();break}else if(a.id==="emptyHistory"){no(e),n.stopPropagation(),n.preventDefault();break}else if(a.id==="emptyNewFile"){aa({app:e,useSavePath:!0}),n.stopPropagation(),n.preventDefault();break}else if(a.id==="emptyNewNotebook"){Jl(),n.stopPropagation(),n.preventDefault();break}else if(a.id==="emptyHelp"){Xl(),n.stopPropagation(),n.preventDefault();break}a=a.parentElement}}))},pg=()=>{const e=document.getElementById("toolbarName");si(e.value),e.classList.remove("fn__hidden"),document.getElementById("editor").classList.remove("fn__none"),document.getElementById("empty").classList.add("fn__none")};var mg=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{o(n.next(r))}catch(c){s(c)}},l=r=>{try{o(n.throw(r))}catch(c){s(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,l);o((n=n.apply(e,t)).next())});const xm=(e,t,n)=>{fetchPost("/api/block/getDocInfo",{id:e},a=>{t.updateTitle(a.data.name),n&&n.title&&n.title.setTitle(a.data.name)})},ao=(e,t,n=!0,a=!0,s=!1)=>{n&&tt(),window.siyuan.mobile.popEditor&&(t.removeRootIDs.includes(window.siyuan.mobile.popEditor.protyle.block.rootID)?J(["dialog"]):Un(window.siyuan.mobile.popEditor.protyle,!1,a)),window.siyuan.mobile.editor&&(t.removeRootIDs.includes(window.siyuan.mobile.editor.protyle.block.rootID)?ii(e):(Un(window.siyuan.mobile.editor.protyle,!1,a),A("/api/block/getDocInfo",{id:window.siyuan.mobile.editor.protyle.block.rootID},i=>{si(i.data.name),window.siyuan.mobile.editor.protyle.title.setTitle(i.data.name)}))),jn(()=>{window.siyuan.mobile.docks.file.init(!1)})},bg=e=>{ba().forEach(t=>{t.protyle.wysiwyg.element.querySelectorAll(`[data-node-id="${e.blockID}"] span[data-type="block-ref"][data-subtype="d"][data-id="${e.defBlockID}"]`).forEach(n=>{n.innerHTML=e.refText})})},yg=e=>{ba().forEach(n=>{if(n.protyle.block.rootID===e.rootID&&n.protyle.title){const a=n.protyle.title.element.querySelector(".protyle-attr"),s=a.querySelector(".protyle-attr--refcount");s?e.rootRefCount===0?s.remove():s.textContent=e.rootRefCount.toString():e.rootRefCount>0&&a.insertAdjacentHTML("beforeend",`<div class="protyle-attr--refcount popover__block">${e.rootRefCount}</div>`)}e.rootID!==e.blockID&&n.protyle.wysiwyg.element.querySelectorAll(`[data-node-id="${e.blockID}"]`).forEach(a=>{const s=a.lastElementChild.querySelector(".protyle-attr--refcount");if(s)e.refCount===0?s.remove():s.textContent=e.refCount.toString();else if(e.refCount>0){const i=a.lastElementChild;i.childElementCount>0?i.lastElementChild.insertAdjacentHTML("afterend",`<div class="protyle-attr--refcount popover__block">${e.refCount}</div>`):i.innerHTML=`<div class="protyle-attr--refcount popover__block">${e.refCount}</div>${f.ZWSP}`}e.refCount===0?a.removeAttribute("refcount"):a.setAttribute("refcount",e.refCount.toString())})});let t;if(t=window.siyuan.mobile.docks.file.element.querySelector(`li[data-node-id="${e.rootID}"]`),t){const n=t.querySelector(".counter");n?e.rootRefCount===0?n.remove():n.textContent=e.rootRefCount.toString():e.rootRefCount>0&&t.insertAdjacentHTML("beforeend",`<span class="popover__block counter b3-tooltips b3-tooltips__nw" aria-label="${window.siyuan.languages.ref}">${e.rootRefCount}</span>`)}},io=e=>{window.siyuan.config.readonly||(e.plugins.forEach(t=>{t.eventBus.emit("lock-screen")}),A("/api/system/logoutAuth",{},()=>{uu()}))},Xc=()=>{if(document.querySelector("#errorLog"))return;let e="";Qt()&&(e=`<div class="fn__hr"></div><div class="fn__flex"><div class="fn__flex-1"></div><button class="b3-button">${window.siyuan.languages.retry}</button></div>`);const t=new we({disableClose:!0,title:`\u{1F494} ${window.siyuan.languages.kernelFault0} <small>v${f.SIYUAN_VERSION}</small>`,width:H()?"92vw":"520px",content:`<div class="b3-dialog__content">
<div class="ft__breakword">
    <div>${window.siyuan.languages.kernelFault1}</div>
    <div class="fn__hr"></div>
    <div>${window.siyuan.languages.kernelFault2}</div>
    ${e}
</div>
</div>`});t.element.id="errorLog",t.element.setAttribute("data-key",f.DIALOG_KERNELFAULT);const n=t.element.querySelector(".b3-button");n&&n.addEventListener("click",()=>{t.destroy(),window.webkit.messageHandlers.startKernelFast.postMessage("startKernelFast")})},Da=()=>mg(void 0,null,function*(){To(["util"]),window.siyuan.mobile.editor&&(yield Pi(window.siyuan.mobile.editor.protyle)),A("/api/system/exit",{force:!1},e=>{if(e.code===1){const t=ae(e.msg,e.data.closeTimeout,"error"),n=document.querySelector(`#message [data-id="${t}"] button`);n&&n.addEventListener("click",()=>{A("/api/system/exit",{force:!0},()=>{(Qt()||ft()||yt())&&(window.location.href="siyuan://api/system/exit")})})}else e.code===2?(tt(),window.siyuan.config.system.container==="std"&&ipcRenderer.send(f.SIYUAN_SHOW_WINDOW),$e(window.siyuan.languages.tip,e.msg,()=>{A("/api/system/exit",{force:!0,execInstallPkg:2},()=>{})},()=>{A("/api/system/exit",{force:!0,execInstallPkg:1},()=>{})})):(Qt()||ft()||yt())&&(window.location.href="siyuan://api/system/exit")})}),wg=()=>{if(document.getElementById("transactionError"))return;const e=new we({disableClose:!0,title:`${window.siyuan.languages.stateExcepted} v${f.SIYUAN_VERSION}`,content:`<div class="b3-dialog__content" id="transactionError">${window.siyuan.languages.rebuildIndexTip}</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--text">${window.siyuan.languages._kernel[97]}</button>
    <div class="fn__space"></div>
    <button class="b3-button">${window.siyuan.languages.rebuildIndex}</button>
</div>`,width:H()?"92vw":"520px"});e.element.setAttribute("data-key",f.DIALOG_STATEEXCEPTED);const t=e.element.querySelectorAll(".b3-button");t[0].addEventListener("click",()=>{Da()}),t[1].addEventListener("click",()=>{Jc(),e.destroy()})},Jc=e=>{window.siyuan.storage[f.LOCAL_FILEPOSITION]={},Ae(f.LOCAL_FILEPOSITION,window.siyuan.storage[f.LOCAL_FILEPOSITION]),A("/api/filetree/refreshFiletree",{},()=>{e&&e()})};let $s;const hg=e=>{const t=document.querySelector("#status");if(t)if(H()){if(!document.querySelector("#keyboardToolbar").classList.contains("fn__none"))return;clearTimeout($s),t.innerHTML=e.msg,t.style.bottom="0",$s=window.setTimeout(()=>{t.style.bottom=""},12e3)}else{const n=t.querySelector(".status__msg");n&&(clearTimeout($s),n.innerHTML=e.msg,$s=window.setTimeout(()=>{n.innerHTML=""},12e3))}},_g=e=>{let t=document.getElementById("progress");if(t||(document.body.insertAdjacentHTML("beforeend",`<div id="progress" style="z-index: ${++window.siyuan.zIndex}"></div>`),t=document.getElementById("progress")),e.code===2){t.remove();return}e.code===0?t.innerHTML=`<div class="b3-dialog__scrim" style="opacity: 1"></div>
<div class="b3-dialog__loading">
    <div style="text-align: right">${e.data.current}/${e.data.total}</div>
    <div style="margin: 8px 0;height: 8px;border-radius: var(--b3-border-radius);overflow: hidden;background-color:#fff;"><div style="width: ${e.data.current/e.data.total*100}%;transition: var(--b3-transition);background-color: var(--b3-theme-primary);height: 8px;"></div></div>
    <div class="ft__breakword">${e.msg}</div>
</div>`:e.code===1&&(t.lastElementChild?t.lastElementChild.lastElementChild.innerHTML=e.msg:t.innerHTML=`<div class="b3-dialog__scrim" style="opacity: 1"></div>
<div class="b3-dialog__loading">
    <div style="margin: 8px 0;height: 8px;border-radius: var(--b3-border-radius);overflow: hidden;background-color:#fff;"><div style="background-color: var(--b3-theme-primary);height: 8px;background-image: linear-gradient(-45deg, rgba(255, 255, 255, 0.2) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, 0.2) 50%, rgba(255, 255, 255, 0.2) 75%, transparent 75%, transparent);animation: stripMove 450ms linear infinite;background-size: 50px 50px;"></div></div>
    <div class="ft__breakword">${e.msg}</div>
</div>`)},Am=e=>{const t=document.querySelector(".status__backgroundtask");t&&(e.length===0?(t.classList.add("fn__none"),!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="statusBackgroundTask"&&window.siyuan.menus.menu.remove()):(t.classList.remove("fn__none"),t.setAttribute("data-tasks",JSON.stringify(e)),t.innerHTML=e[0].action+"<div><div></div></div>"))},vg=()=>{A("/api/sync/getBootSync",{},e=>{if(e.code===1){const t=new we({width:H()?"92vw":"50vw",title:"\u{1F329}\uFE0F "+window.siyuan.languages.bootSyncFailed,content:`<div class="b3-dialog__content">${e.msg}</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.syncNow}</button>
</div>`});t.element.setAttribute("data-key",f.DIALOG_BOOTSYNCFAILED);const n=t.element.querySelectorAll(".b3-button");n[0].addEventListener("click",()=>{t.destroy()}),n[1].addEventListener("click",()=>{n[1].getAttribute("disabled")||(n[1].setAttribute("disabled","disabled"),A("/api/sync/performBootSync",{},a=>{a.code===0&&t.destroy(),n[1].removeAttribute("disabled")}))})}})},si=e=>{const t=document.getElementById("drag"),n=mu();if(e===window.siyuan.languages.siyuanNote){const a=`${n} - ${window.siyuan.languages.siyuanNote} v${f.SIYUAN_VERSION}`;document.title=a,t&&(t.textContent=a,t.setAttribute("title",a))}else{if(e=e||window.siyuan.languages.untitled,document.title=`${e} - ${n} - ${window.siyuan.languages.siyuanNote} v${f.SIYUAN_VERSION}`,!t)return;t.setAttribute("title",e),t.innerHTML=pe(e)}},Cm=e=>{const t=document.querySelector("#configBazaarReadme .item__side");if(!t||e.id!==JSON.parse(t.getAttribute("data-obj")).repoURL)return;const n=t.querySelector('[data-type="install"]');n&&(e.percent>=1?(n.parentElement.classList.add("fn__none"),n.parentElement.nextElementSibling.classList.add("fn__none")):(n.classList.add("b3-button--progress"),n.parentElement.nextElementSibling.firstElementChild.classList.add("b3-button--progress"),n.innerHTML=`<span style="width: ${e.percent*100}%"></span>`,n.parentElement.nextElementSibling.firstElementChild.innerHTML=`<span style="width: ${e.percent*100}%"></span>`))},Cn=(e,t)=>{const n=document.querySelector("#menuSyncNow use"),a=document.querySelector("#toolbarSync use");if(!e){!window.siyuan.config.sync.enabled||window.siyuan.config.sync.provider===0&&Vn("")?(n==null||n.setAttribute("xlink:href","#iconCloudOff"),a.setAttribute("xlink:href","#iconCloudOff")):(n==null||n.setAttribute("xlink:href","#iconCloudSucc"),a.setAttribute("xlink:href","#iconCloudSucc"));return}n==null||n.parentElement.classList.remove("fn__rotate"),a.parentElement.classList.remove("fn__rotate"),e.code===0?(n==null||n.parentElement.classList.add("fn__rotate"),a.parentElement.classList.add("fn__rotate"),n==null||n.setAttribute("xlink:href","#iconRefresh"),a.setAttribute("xlink:href","#iconRefresh")):e.code===2?(n==null||n.setAttribute("xlink:href","#iconCloudError"),a.setAttribute("xlink:href","#iconCloudError")):e.code===1&&(n==null||n.setAttribute("xlink:href","#iconCloudSucc"),a.setAttribute("xlink:href","#iconCloudSucc")),t.forEach(s=>{e.code===0?s.eventBus.emit("sync-start",e):e.code===1?s.eventBus.emit("sync-end",e):e.code===2&&s.eventBus.emit("sync-fail",e)})};var kg=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{o(n.next(r))}catch(c){s(c)}},l=r=>{try{o(n.throw(r))}catch(c){s(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,l);o((n=n.apply(e,t)).next())});const A=(e,t,n,a)=>{const s={method:"POST"};t&&(["/api/search/searchRefBlock","/api/graph/getGraph","/api/graph/getLocalGraph","/api/block/getRecentUpdatedBlocks","/api/search/fullTextSearchBlock"].includes(e)&&(window.siyuan.reqIds[e]=new Date().getTime(),t.type==="local"&&e==="/api/graph/getLocalGraph"||(t.reqId=window.siyuan.reqIds[e])),e==="/api/transactions"&&(t.reqId=new Date().getTime()),t instanceof FormData?s.body=t:s.body=JSON.stringify(t)),a&&(s.headers=a),fetch(e,s).then(i=>{var l;switch(i.status){case 403:case 404:return{data:null,msg:i.statusText,code:-i.status};default:return((l=i.headers.get("content-type"))==null?void 0:l.indexOf("application/json"))>-1?i.json():i.text()}}).then(i=>{if(typeof i=="string"){n&&n(i);return}["/api/search/searchRefBlock","/api/graph/getGraph","/api/graph/getLocalGraph","/api/block/getRecentUpdatedBlocks","/api/search/fullTextSearchBlock"].includes(e)&&i.data.reqId&&window.siyuan.reqIds[e]&&window.siyuan.reqIds[e]>i.data.reqId||(typeof i=="object"&&typeof i.msg=="string"&&typeof i.code=="number"?il(i)&&n&&n(i):n&&n(i))}).catch(i=>{if(console.warn("fetch post failed ["+i+"], url ["+e+"]"),e==="/api/transactions"&&(i.message==="Failed to fetch"||i.message==="Unexpected end of JSON input")){Xc();return}})},Ye=(e,t)=>kg(void 0,null,function*(){const n={method:"POST"};t&&(t instanceof FormData?n.body=t:n.body=JSON.stringify(t));const s=yield(yield fetch(e,n)).json();return il(s),s}),so=(e,t)=>{fetch(e).then(n=>{var a;return((a=n.headers.get("content-type"))==null?void 0:a.indexOf("application/json"))>-1?n.json():n.text()}).then(n=>{t(n)})},mn=(e,t)=>e?`<span class="b3-menu__accelerator">${Me(e)}</span>`:t?`<span class="b3-list-item__meta">${t}</span>`:"",lo=(e,t)=>{const n=[{filter:[window.siyuan.languages.template,"template","\u6A21\u677F","moban","muban","mb"],id:"template",value:f.ZWSP,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconMarkdown"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.template}</span></div>`},{filter:[window.siyuan.languages.widget,"widget","\u6302\u4EF6","guajian","gj"],id:"widget",value:f.ZWSP+1,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconBoth"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.widget}</span></div>`},{filter:[window.siyuan.languages.assets,"assets","\u8D44\u6E90","ziyuan","zy"],id:"assets",value:f.ZWSP+2,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconImage"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.assets}</span></div>`},{filter:[window.siyuan.languages.ref,"block reference","\u5757\u5F15\u7528","kuaiyinyong","kyy"],id:"ref",value:"((",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconRef"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.ref}</span><span class="b3-list-item__meta">((</span></div>`},{filter:[window.siyuan.languages.blockEmbed,"embed block","\u5D4C\u5165\u5757","qianrukuai","qrk"],id:"blockEmbed",value:"{{",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconSQL"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.blockEmbed}</span><span class="b3-list-item__meta">{{</span></div>`},{filter:[window.siyuan.languages.aiWriting,"ai writing","ai\u7F16\u5199","aibianxie","aibx","\u4EBA\u5DE5\u667A\u80FD","rengongzhineng","rgzn"],id:"aiWriting",value:f.ZWSP+5,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconSparkles"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.aiWriting}</span>${mn(window.siyuan.config.keymap.editor.general.aiWriting.custom,"")}</div>`},{filter:[window.siyuan.languages.database,"database","db","\u6570\u636E\u5E93","shujuku","sjk","\u89C6\u56FE","view"],id:"database",value:'<div data-type="NodeAttributeView" data-av-type="table"></div>',html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconDatabase"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.database}</span></div>`},{filter:[window.siyuan.languages.newFileRef,"create new doc with reference","\u65B0\u5EFA\u6587\u6863\u5E76\u5F15\u7528","xinjianwendangbingyinyong","xjwdbyy"],id:"newFileRef",value:f.ZWSP+4,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.newFileRef}</span></div>`},{filter:[window.siyuan.languages.newSubDocRef,"create sub doc with reference","\u65B0\u5EFA\u5B50\u6587\u6863\u5E76\u5F15\u7528","xinjianziwendangbingyinyong","xjzwdbyy"],id:"newSubDocRef",value:f.ZWSP+6,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.newSubDocRef}</span></div>`},{value:"",id:"separator_1",html:"separator"},{filter:[window.siyuan.languages.heading1,"heading1","h1","\u4E00\u7EA7\u6807\u9898","yijibiaoti","yjbt"],id:"heading1",value:"# "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH1"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading1}</span>${mn(window.siyuan.config.keymap.editor.heading.heading1.custom,"# ")}</div>`},{filter:[window.siyuan.languages.heading2,"heading2","h2","\u4E8C\u7EA7\u6807\u9898","erjibiaoti","ejbt"],id:"heading2",value:"## "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH2"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading2}</span>${mn(window.siyuan.config.keymap.editor.heading.heading2.custom,"## ")}</div>`},{filter:[window.siyuan.languages.heading3,"heading3","h3","\u4E09\u7EA7\u6807\u9898","sanjibiaoti","sjbt"],id:"heading3",value:"### "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH3"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading3}</span>${mn(window.siyuan.config.keymap.editor.heading.heading3.custom,"### ")}</div>`},{filter:[window.siyuan.languages.heading4,"heading4","h4","\u56DB\u7EA7\u6807\u9898","sijibiaoti","sjbt"],id:"heading4",value:"#### "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH4"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading4}</span>${mn(window.siyuan.config.keymap.editor.heading.heading4.custom,"#### ")}</div>`},{filter:[window.siyuan.languages.heading5,"heading5","h5","\u4E94\u7EA7\u6807\u9898","wujibiaoti","wjbt"],id:"heading5",value:"##### "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH5"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading5}</span>${mn(window.siyuan.config.keymap.editor.heading.heading5.custom,"##### ")}</div>`},{filter:[window.siyuan.languages.heading6,"heading6","h6","\u516D\u7EA7\u6807\u9898","liujibiaoti","ljbt"],id:"heading6",value:"###### "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH6"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading6}</span>${mn(window.siyuan.config.keymap.editor.heading.heading6.custom,"###### ")}</div>`},{filter:[window.siyuan.languages.list,"unordered list","\u65E0\u5E8F\u5217\u8868","wuxvliebiao","wuxuliebiao","wxlb"],id:"list",value:"* "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconList"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.list}</span>${mn(window.siyuan.config.keymap.editor.insert.list.custom,"* ")}</div>`},{filter:[window.siyuan.languages["ordered-list"],"order list","ordered list","\u6709\u5E8F\u5217\u8868","youxvliebiao","youxuliebiao","yxlb"],id:"orderedList",value:"1. "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconOrderedList"></use></svg><span class="b3-list-item__text">${window.siyuan.languages["ordered-list"]}</span>${mn(window.siyuan.config.keymap.editor.insert["ordered-list"].custom,"1. ")}</div>`},{filter:[window.siyuan.languages.check,"task list","todo list","\u4EFB\u52A1\u5217\u8868","renwuliebiao","rwlb"],id:"check",value:"* [ ] "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconCheck"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.check}</span>${mn(window.siyuan.config.keymap.editor.insert.check.custom,"[]")}</div>`},{filter:[window.siyuan.languages.quote,"blockquote","bq","\u5F15\u8FF0","yinshu","ys"],id:"quote",value:"> "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconQuote"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.quote}</span>${mn(window.siyuan.config.keymap.editor.insert.quote.custom,">")}</div>`},{filter:[window.siyuan.languages.code,"code block","\u4EE3\u7801\u5757","daimakuai","dmk"],id:"code",value:"```",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconCode"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.code}</span>${mn(window.siyuan.config.keymap.editor.insert.code.custom,"```"+window.siyuan.languages.enterKey)}</div>`},{filter:[window.siyuan.languages.table,"table","\u8868\u683C","biaoge","bg"],id:"table",value:`| ${Lute.Caret} |  |  |
| --- | --- | --- |
|  |  |  |
|  |  |  |`,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconTable"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.table}</span><span class="b3-menu__accelerator">${Me(window.siyuan.config.keymap.editor.insert.table.custom)}</span></div>`},{filter:[window.siyuan.languages.line,"thematic break","divider","\u5206\u9694\u7EBF","\u5206\u5272\u7EBF","fengexian","fgx"],id:"line",value:"---",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconLine"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.line}</span><span class="b3-list-item__meta">---</span></div>`},{filter:[window.siyuan.languages.math,"formulas block","math block","\u6570\u5B66\u516C\u5F0F\u5757","shuxuegongshikuai","sxgsk"],id:"math",value:"$$",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconMath"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.math}</span><span class="b3-list-item__meta">$$</span></div>`},{filter:["html"],id:"html",value:"<div>",html:'<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconHTML5"></use></svg><span class="b3-list-item__text">HTML</span></div>'},{value:"",id:"separator_2",html:"separator"},{filter:[window.siyuan.languages.emoji,"emoji","\u8868\u60C5","biaoqing","bq"],id:"emoji",value:"emoji",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconEmoji"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.emoji}</span><span class="b3-list-item__meta">:</span></div>`},{filter:[window.siyuan.languages.link,"link","a","\u94FE\u63A5","lianjie","lj"],id:"link",value:"a",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconLink"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.link}</span><span class="b3-menu__accelerator">${Me(window.siyuan.config.keymap.editor.insert.link.custom)}</span></div>`},{filter:[window.siyuan.languages.bold,"bold","strong","\u7C97\u4F53","cuti","ct","\u52A0\u7C97","jiacu","jc"],id:"bold",value:"strong",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconBold"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.bold}</span><span class="b3-menu__accelerator">${Me(window.siyuan.config.keymap.editor.insert.bold.custom)}</span></div>`},{filter:[window.siyuan.languages.italic,"italic","em","\u659C\u4F53","xieti","xt"],id:"italic",value:"em",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconItalic"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.italic}</span><span class="b3-menu__accelerator">${Me(window.siyuan.config.keymap.editor.insert.italic.custom)}</span></div>`},{filter:[window.siyuan.languages.underline,"underline","\u4E0B\u5212\u7EBF","xiahuaxian","xhx"],id:"underline",value:"u",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconUnderline"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.underline}</span><span class="b3-menu__accelerator">${Me(window.siyuan.config.keymap.editor.insert.underline.custom)}</span></div>`},{filter:[window.siyuan.languages.strike,"strike","delete","\u5220\u9664\u7EBF","shanchuxian","scx"],id:"strike",value:"s",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconStrike"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.strike}</span><span class="b3-menu__accelerator">${Me(window.siyuan.config.keymap.editor.insert.strike.custom)}</span></div>`},{filter:[window.siyuan.languages.mark,"mark","\u6807\u8BB0","biaoji","bj","\u9AD8\u4EAE","gaoliang","gl"],id:"mark",value:"mark",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconMark"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.mark}</span><span class="b3-menu__accelerator">${Me(window.siyuan.config.keymap.editor.insert.mark.custom)}</span></div>`},{filter:[window.siyuan.languages.sup,"superscript","\u4E0A\u6807","shangbiao","sb"],id:"sup",value:"sup",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconSup"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.sup}</span><span class="b3-menu__accelerator">${Me(window.siyuan.config.keymap.editor.insert.sup.custom)}</span></div>`},{filter:[window.siyuan.languages.sub,"subscript","\u4E0B\u6807","xiaobiao","xb"],id:"sub",value:"sub",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconSub"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.sub}</span><span class="b3-menu__accelerator">${Me(window.siyuan.config.keymap.editor.insert.sub.custom)}</span></div>`},{filter:[window.siyuan.languages["inline-code"],"inline code","\u884C\u7EA7\u4EE3\u7801","hangjidaima","hjdm"],id:"inlineCode",value:"code",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconInlineCode"></use></svg><span class="b3-list-item__text">${window.siyuan.languages["inline-code"]}</span><span class="b3-menu__accelerator">${Me(window.siyuan.config.keymap.editor.insert["inline-code"].custom)}</span></div>`},{filter:[window.siyuan.languages.kbd,"kbd","\u952E\u76D8","jianpan","jp"],id:"kbd",value:"kbd",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconKeymap"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.kbd}</span><span class="b3-menu__accelerator">${Me(window.siyuan.config.keymap.editor.insert.kbd.custom)}</span></div>`},{filter:[window.siyuan.languages.tag,"tags","\u6807\u7B7E","biaoqian","bq"],id:"tag",value:"tag",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconTags"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.tag}</span><span class="b3-menu__accelerator">${Me(window.siyuan.config.keymap.editor.insert.tag.custom)}</span></div>`},{filter:[window.siyuan.languages["inline-math"],"inline formulas","inline math","\u884C\u7EA7\u516C\u5F0F","hangjigongshi","hjgs","\u884C\u7EA7\u6570\u5B66\u516C\u5F0F","hangjishuxvegongshi","hangjishuxuegongshi","hjsxgs"],id:"inlineMath",value:"inline-math",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconMath"></use></svg><span class="b3-list-item__text">${window.siyuan.languages["inline-math"]}</span><span class="b3-menu__accelerator">${Me(window.siyuan.config.keymap.editor.insert["inline-math"].custom)}</span></div>`},{value:"",id:"separator_3",html:"separator"},{filter:[window.siyuan.languages.insertAsset,"insert image or file","upload","\u63D2\u5165\u56FE\u7247\u6216\u6587\u4EF6","charutupianhuowenjian","crtphwj","\u4E0A\u4F20","sc"],id:"insertAsset",value:f.ZWSP+3,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconDownload"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.insertAsset}</span>
<input class="b3-form__upload" type="file" ${t.options.upload.accept?'multiple="'+t.options.upload.accept+'"':""}></div>`},{filter:[window.siyuan.languages.insertIframeURL,"insert iframe link","\u63D2\u5165 iframe \u94FE\u63A5","charuiframelianjie","criframelj"],id:"insertIframeURL",value:'<iframe sandbox="allow-forms allow-presentation allow-same-origin allow-scripts allow-modals allow-popups" src="" border="0" frameborder="no" framespacing="0" allowfullscreen="true"></iframe>',html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconLanguage"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.insertIframeURL}</span></div>`},{filter:[window.siyuan.languages.insertImgURL,"insert image link","image","img","\u63D2\u5165\u56FE\u7247\u94FE\u63A5","charutupianlianjie","crtplj"],id:"insertImgURL",value:"![]()",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconImage"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.insertImgURL}</span></div>`},{filter:[window.siyuan.languages.insertVideoURL,"insert video link","\u63D2\u5165\u89C6\u9891\u94FE\u63A5","charushipinlianjie","crsplj"],id:"insertVideoURL",value:'<video controls="controls" src=""></video>',html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconVideo"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.insertVideoURL}</span></div>`},{filter:[window.siyuan.languages.insertAudioURL,"insert audio link","\u63D2\u5165\u97F3\u9891\u94FE\u63A5","charuyinpinlianjie","cryplj"],id:"insertAudioURL",value:'<audio controls="controls" src=""></audio>',html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconRecord"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.insertAudioURL}</span></div>`},{value:"",id:"separator_4",html:"separator"},{filter:[window.siyuan.languages.staff,"staff","\u4E94\u7EBF\u8C31","wuxianpu","wxp"],id:"staff",value:"```abc\n```",html:`<div class="b3-list-item__first"><span class="b3-list-item__text">ABC</span><span class="b3-list-item__meta">${window.siyuan.languages.staff}</span></div>`},{filter:[window.siyuan.languages.chart,"chart","\u56FE\u8868","tubiao","tb"],id:"chart",value:"```echarts\n```",html:`<div class="b3-list-item__first"><span class="b3-list-item__text">Chart</span><span class="b3-list-item__meta">${window.siyuan.languages.chart}</span></div>`},{filter:["flowchart","flow chart","\u6D41\u7A0B\u56FE","liuchengtu","lct"],id:"flowChart",value:"```flowchart\n```",html:'<div class="b3-list-item__first"><span class="b3-list-item__text">FlowChart</span><span class="b3-list-item__meta">Flow Chart</span></div>'},{filter:["graphviz","\u72B6\u6001\u56FE","zhuangtaitu","ztt"],id:"graph",value:"```graphviz\n```",html:'<div class="b3-list-item__first"><span class="b3-list-item__text">Graphviz</span><span class="b3-list-item__meta">Graph</span></div>'},{filter:["mermaid","diagram","\u56FE\u8868","tubiao","tb"],id:"mermaid",value:"```mermaid\n```",html:'<div class="b3-list-item__first"><span class="b3-list-item__text">Mermaid</span><span class="b3-list-item__meta">Mermaid</span></div>'},{filter:[window.siyuan.languages.mindmap,"mindmap","\u8111\u56FE","naotu","nt"],id:"mindmap",value:"```mindmap\n```",html:`<div class="b3-list-item__first"><span class="b3-list-item__text">Mind map</span><span class="b3-list-item__meta">${window.siyuan.languages.mindmap}</span></div>`},{filter:["plantuml","\u5EFA\u6A21\u8BED\u8A00","jianmoyuyan","jmyy"],id:"UML",value:"```plantuml\n```",html:'<div class="b3-list-item__first"><span class="b3-list-item__text">PlantUML</span><span class="b3-list-item__meta">UML</span></div>'},{value:"",id:"separator_5",html:"separator"},{filter:[window.siyuan.languages.infoStyle,"info style","\u4FE1\u606F\u6837\u5F0F","xinxiyangshi","xxys"],id:"infoStyle",value:`style${f.ZWSP}color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);`,html:`<div class="b3-list-item__first"><div style="color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);" class="color__square color__square--list">A</div><span class="b3-list-item__text">${window.siyuan.languages.infoStyle}</span></div>`},{filter:[window.siyuan.languages.successStyle,"success style","\u6210\u529F\u6837\u5F0F","chenggongyangshi","cgys"],id:"successStyle",value:`style${f.ZWSP}color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);`,html:`<div class="b3-list-item__first"><div style="color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);" class="color__square color__square--list">A</div><span class="b3-list-item__text">${window.siyuan.languages.successStyle}</span></div>`},{filter:[window.siyuan.languages.warningStyle,"warning style","\u8B66\u544A\u6837\u5F0F","jinggaoyangshi","jgys"],id:"warningStyle",value:`style${f.ZWSP}color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);`,html:`<div class="b3-list-item__first"><div style="color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);" class="color__square color__square--list">A</div><span class="b3-list-item__text">${window.siyuan.languages.warningStyle}</span></div>`},{filter:[window.siyuan.languages.errorStyle,"error style","\u9519\u8BEF\u6837\u5F0F","cuowuyangshi","cwys"],id:"errorStyle",value:`style${f.ZWSP}color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);`,html:`<div class="b3-list-item__first"><div style="color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);" class="color__square color__square--list">A</div><span class="b3-list-item__text">${window.siyuan.languages.errorStyle}</span></div>`},{filter:[window.siyuan.languages.clearFontStyle,"clear style","\u6E05\u9664\u6837\u5F0F","qingchuyangshi","qcys"],id:"clearFontStyle",value:`style${f.ZWSP}`,html:`<div class="b3-list-item__first"><div class="color__square color__square--list">A</div><span class="b3-list-item__text">${window.siyuan.languages.clearFontStyle}</span></div>`},{value:"",id:"separator_6",html:"separator"}];let a=!1;return t.app.plugins.forEach(s=>{s.protyleSlash.forEach(i=>{n.push({filter:i.filter,value:`plugin${f.ZWSP}${s.name}${f.ZWSP}${i.id}`,html:i.html}),a=!0})}),a||n.pop(),e===""?n:n.filter(s=>s.filter?!!s.filter.find(l=>{if(l.toLowerCase().indexOf(e.toLowerCase())>-1)return!0}):!1)},Eg=(e,t)=>(t.hint.genLoading(t),A("/api/search/searchTag",{k:e},n=>{const a=[];let s=!1;n.data.tags.forEach(i=>{const l=i.replace(/<mark>/g,"").replace(/<\/mark>/g,"");a.push({value:`<span data-type="tag">${l}</span>`,html:`<div class="b3-list-item__text">${i}</div>`}),l===n.data.k&&(s=!0)}),n.data.k&&!s&&(a.splice(0,0,{value:`<span data-type="tag">${n.data.k}</span>`,html:`<div class="b3-list-item__text">${window.siyuan.languages.new} <mark>${pe(n.data.k)}</mark></div>`}),a.length>1&&(a[1].focus=!0)),t.hint.genHTML(a,t,!0,"hint")}),[]),oo=e=>{let t;e.type==="NodeDocument"&&e.ial.icon?(t=ge(e.ial.icon,"b3-list-item__graphic popover__block",!0),t=t.replace('popover__block"',`popover__block" data-id="${e.id}"`)):t=`<svg class="b3-list-item__graphic popover__block" data-id="${e.id}"><use xlink:href="#${dn(e.type)}"></use></svg>`;let n="";return e.name&&(n+=`<span class="fn__flex"><svg class="b3-list-item__hinticon"><use xlink:href="#iconN"></use></svg><span>${e.name}</span></span><span class="fn__space"></span>`),e.alias&&(n+=`<span class="fn__flex"><svg class="b3-list-item__hinticon"><use xlink:href="#iconA"></use></svg><span>${e.alias}</span></span><span class="fn__space"></span>`),e.memo&&(n+=`<span class="fn__flex"><svg class="b3-list-item__hinticon"><use xlink:href="#iconM"></use></svg><span>${e.memo}</span></span>`),n&&(n=`<div class="fn__flex b3-list-item__meta b3-list-item__showall">${n}</div>`),`${n}<div class="b3-list-item__first">
    ${t}
    <span class="b3-list-item__text">${e.content}</span>
</div>
<div class="b3-list-item__meta b3-list-item__showall">${e.hPath}</div>`},fa=(e,t,n)=>{const a=B(ye(t.wysiwyg.element).startContainer);return t.hint.genLoading(t),A("/api/search/searchRefBlock",{k:e,id:a?a.getAttribute("data-node-id"):t.block.parentID,beforeLen:Math.floor((Math.max(t.element.clientWidth/2,320)-58)/28.8),rootID:n==="av"?"":t.block.rootID,isDatabase:n==="av",isSquareBrackets:["[[","\u3010\u3010"].includes(t.hint.splitChar)},s=>{const i=[];if(s.data.newDoc){const l=Lute.UnEscapeHTMLStr(Pn(s.data.k));i.push({value:`((newFile "${l}"${f.ZWSP}'${l}${Lute.Caret}'))`,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg>
<span class="b3-list-item__text">${window.siyuan.languages.newFile} <mark>${s.data.k}</mark></span></div>`})}s.data.blocks.forEach(l=>{let o=`<span data-type="block-ref" data-id="${l.id}" data-subtype="d">${l.name||l.refText.replace(new RegExp(f.ZWSP,"g"),"")}</span>`;if(n==="search")o=`<span data-type="block-ref" data-id="${l.id}" data-subtype="s">${e}${f.ZWSP}${l.name||l.refText.replace(new RegExp(f.ZWSP,"g"),"")}</span>`;else if(n==="av"){let r=l.name||l.refText.replace(new RegExp(f.ZWSP,"g"),"");a&&(r=l.ial["custom-sy-av-s-text-"+a.getAttribute("data-av-id")]||r),o=`<span data-type="block-ref" data-id="${l.id}" data-subtype="s">${r}</span>`}i.push({value:o,html:oo(l)})}),n==="search"&&(t.hint.splitChar="((",t.hint.lastIndex=-1),i.length===0?i.push({value:"",html:window.siyuan.languages.emptyContent}):s.data.newDoc&&i.length>1&&(i[1].focus=!0),t.hint.genHTML(i,t,!0,n)}),[]},li=(e,t)=>{if(e.endsWith("}}")||e.endsWith("\u300D\u300D"))return[];t.hint.genLoading(t);const n=B(ye(t.wysiwyg.element).startContainer);return A("/api/search/searchRefBlock",{k:e,isDatabase:!1,beforeLen:Math.floor((Math.max(t.element.clientWidth/2,320)-58)/28.8),id:n?n.getAttribute("data-node-id"):t.block.parentID,rootID:t.block.rootID},a=>{const s=[];a.data.blocks.forEach(i=>{s.push({value:`{{select * from blocks where id='${i.id}'}}`,html:oo(i)})}),s.length===0&&s.push({value:"",html:window.siyuan.languages.emptyContent}),t.hint.genHTML(s,t,!0,"hint")}),[]},Qc=(e,t,n)=>{A("/api/template/render",{id:t.block.parentID,path:e},a=>{X(t.toolbar.range);const s=oe(n);s&&s.textContent.trim()===""?Xe(a.data.content,t,!0):Xe(a.data.content,t),t.wysiwyg.element.querySelectorAll('[status="temp"]').forEach(i=>{i.remove()}),Se(t,t.wysiwyg.element),Ze(t.wysiwyg.element),Pe(t.wysiwyg.element),ze(t.wysiwyg.element,t),J(["util"],t)})},ed=(e,t)=>{X(t.toolbar.range),Xe(t.lute.SpinBlockDOM(`<iframe src="/widgets/${e}/" data-subtype="widget" border="0" frameborder="no" framespacing="0" allowfullscreen="true"></iframe>`),t,!0),J(["util"],t)},td=(e,t)=>{X(t.toolbar.range);const n=me().extname(e).toLowerCase(),a=e.startsWith("assets/")?ll(e):e;Xe(Wr(n,e,a,e.startsWith("assets/")?a+n:e),t),J(["util"],t)},ro=(e,t,n)=>{if(e==="/")return;const a=ct(e,!0,!0);if(n.block.rootID===a)return;const s=[];let i;const l=t[0].parentElement;let o;if(t.forEach((r,c)=>{c===t.length-1&&r.parentElement&&(i=Ne(r),o=i.nextElementSibling||i.previousElementSibling,i.isSameNode(r)&&(i=void 0)),s.push({action:"append",id:r.getAttribute("data-node-id"),parentID:a}),r.remove()}),i)s.push({action:"delete",id:i.getAttribute("data-node-id")}),i.remove();else if(l.classList.contains("list")&&l.getAttribute("data-subtype")==="o"&&l.childElementCount>1)je(l,1),Array.from(l.children).forEach(r=>{r.classList.contains("protyle-attr")||s.push({action:"update",id:r.getAttribute("data-node-id"),data:r.outerHTML})});else if(n.block.showAll&&l.classList.contains("protyle-wysiwyg")&&l.childElementCount===0)setTimeout(()=>{Ot({protyle:n,id:n.block.parent2ID,focusId:n.block.parent2ID})},f.TIMEOUT_INPUT*2+100);else if(l.classList.contains("protyle-wysiwyg")&&l.innerHTML===""&&!$(l,"block__edit",!0)&&n.block.id===n.block.rootID){const r=Lute.NewNodeID(),c=Xn(!1,!1,r);s.splice(0,0,{action:"insert",id:r,data:c.outerHTML,parentID:n.block.parentID}),l.innerHTML=c.outerHTML,ne(c)}else o&&ne(o);q(n,s)},Is=(e,t,n)=>{t&&(nt(oe(n[n.length-1]),e.toolbar.range),e.toolbar.range.collapse(!0),Xe(t,e,!0,!0),Se(e,e.wysiwyg.element),Ze(e.wysiwyg.element),Pe(e.wysiwyg.element))},Lg=(e,t)=>{const n=new we({title:window.siyuan.languages.update,content:`<div class="b3-dialog__content">
    <input class="b3-text-field fn__block" placeholder="${window.siyuan.languages.memo}">
    <div class="fn__hr"></div>
    <textarea class="b3-text-field fn__block" placeholder="${window.siyuan.languages.aiCustomAction}"></textarea>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--remove">${window.siyuan.languages.delete}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:H()?"92vw":"520px"});n.element.setAttribute("data-key",f.DIALOG_AIUPDATECUSTOMACTION);const a=n.element.querySelector("input");a.value=e;const s=n.element.querySelector("textarea"),i=n.element.querySelectorAll(".b3-button");n.bindInput(s,()=>{i[2].click()}),s.value=t,i[1].addEventListener("click",()=>{n.destroy()}),i[2].addEventListener("click",()=>{window.siyuan.storage[f.LOCAL_AI].find(l=>{if(e===l.name&&t===l.memo)return l.name=a.value,l.memo=s.value,Ae(f.LOCAL_AI,window.siyuan.storage[f.LOCAL_AI]),!0}),n.destroy()}),i[0].addEventListener("click",()=>{window.siyuan.storage[f.LOCAL_AI].find((l,o)=>{if(e===l.name&&t===l.memo)return window.siyuan.storage[f.LOCAL_AI].splice(o,1),Ae(f.LOCAL_AI,window.siyuan.storage[f.LOCAL_AI]),!0}),n.destroy()}),a.focus()},nd=(e,t,n)=>{const a=new we({title:window.siyuan.languages.aiCustomAction,content:`<div class="b3-dialog__content">
    <input class="b3-text-field fn__block" value="" placeholder="${window.siyuan.languages.memo}">
    <div class="fn__hr"></div>
    <textarea class="b3-text-field fn__block" placeholder="${window.siyuan.languages.aiCustomAction}"></textarea>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.use}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.save}</button>
</div>`,width:H()?"92vw":"520px"});a.element.setAttribute("data-key",f.DIALOG_AICUSTOMACTION);const s=a.element.querySelector("input"),i=a.element.querySelector("textarea"),l=a.element.querySelectorAll(".b3-button");a.bindInput(i,()=>{l[1].click()}),l[0].addEventListener("click",()=>{a.destroy()}),l[1].addEventListener("click",()=>{if(!i.value){ae(window.siyuan.languages._kernel[142]);return}A("/api/ai/chatGPTWithAction",{ids:t,action:i.value},o=>{a.destroy(),Is(e,o.data,n)})}),l[2].addEventListener("click",()=>{if(!s.value&&!i.value){ae(window.siyuan.languages._kernel[142]);return}window.siyuan.storage[f.LOCAL_AI].push({name:s.value,memo:i.value}),Ae(f.LOCAL_AI,window.siyuan.storage[f.LOCAL_AI]),a.destroy()}),s.focus()},ad=(e,t)=>{e.querySelectorAll(".b3-list-item").forEach(n=>{n.textContent.indexOf(t.value)>-1?n.classList.remove("fn__none"):n.classList.add("fn__none")}),e.querySelectorAll(".b3-menu__separator").forEach(n=>{t.value?n.classList.add("fn__none"):n.classList.remove("fn__none")}),e.querySelector(".b3-list-item--focus").classList.remove("b3-list-item--focus"),e.querySelector(".b3-list-item:not(.fn__none)").classList.add("b3-list-item--focus")},co=(e,t)=>{window.siyuan.menus.menu.remove();const n=[];e.forEach(l=>{n.push(l.getAttribute("data-node-id"))});const a=new Ke("ai",()=>{X(t.toolbar.range)});let s="";window.siyuan.storage[f.LOCAL_AI].forEach((l,o)=>{s+=`<div data-action="${We(l.memo||l.name)}" data-index="${o}" class="b3-list-item b3-list-item--narrow ariaLabel" aria-label="${Nt(l.memo)}">
    <span class="b3-list-item__text">${pe(l.name)}</span>
    <span data-type="edit" class="b3-list-item__action"><svg><use xlink:href="#iconEdit"></use></svg></span>
</div>`}),s&&(s=`<div class="b3-menu__separator"></div>${s}`);const i="Clear context";a.addItem({iconHTML:"",type:"empty",label:`<div class="fn__flex-column b3-menu__filter">
    <input class="b3-text-field fn__flex-shrink" placeholder="${window.siyuan.languages.ai}"/>
    <div class="fn__hr"></div>
    <div class="b3-list fn__flex-1 b3-list--background">
       <div class="b3-list-item b3-list-item--narrow b3-list-item--focus" data-action="Continue writing">
            ${window.siyuan.languages.aiContinueWrite}
        </div>
        <div class="b3-menu__separator"></div>
        <div class="b3-list-item b3-list-item--narrow" data-action="${window.siyuan.languages.aiExtractSummary}">
            ${window.siyuan.languages.aiExtractSummary}
        </div>
        <div class="b3-list-item b3-list-item--narrow" data-action="${window.siyuan.languages.aiBrainStorm}">
            ${window.siyuan.languages.aiBrainStorm}
        </div>
        <div class="b3-list-item b3-list-item--narrow" data-action="${window.siyuan.languages.aiFixGrammarSpell}">
            ${window.siyuan.languages.aiFixGrammarSpell}
        </div>
        <div class="b3-list-item b3-list-item--narrow" data-action="${i}">
            ${window.siyuan.languages.clearContext}
        </div>
        <div class="b3-menu__separator"></div>
        <div class="b3-list-item b3-list-item--narrow" data-type="custom">
            ${window.siyuan.languages.aiCustomAction}
        </div>
        ${s}
    </div>
</div>`,bind(l){l.setAttribute("style","height: 100%;padding: 0 16px;"),l.querySelectorAll(".b3-menu__separator").forEach(c=>{c.remove()});const o=l.querySelector(".b3-list"),r=l.querySelector("input");r.addEventListener("keydown",c=>{if(c.isComposing)return;if(Wt(o,c)&&c.stopPropagation(),c.key==="Enter"){c.preventDefault(),c.stopPropagation();const u=o.querySelector(".b3-list-item--focus");u.dataset.type==="custom"?(nd(t,n,e),a.close()):(A("/api/ai/chatGPTWithAction",{ids:n,action:u.dataset.action},p=>{Is(t,p.data,e)}),u.dataset.action===i?ae(window.siyuan.languages.clearContextSucc):a.close())}}),r.addEventListener("compositionend",()=>{ad(l,r)}),r.addEventListener("input",c=>{c.isComposing||ad(l,r)}),l.addEventListener("click",c=>{let d=c.target;for(;d&&!d.isSameNode(l);){if(d.classList.contains("b3-list-item__action")){const u=window.siyuan.storage[f.LOCAL_AI][d.parentElement.dataset.index];Lg(u.name,u.memo),a.close(),c.stopPropagation(),c.preventDefault();break}else if(d.classList.contains("b3-list-item")){d.dataset.type==="custom"?(nd(t,n,e),a.close()):(A("/api/ai/chatGPTWithAction",{ids:n,action:d.dataset.action},u=>{Is(t,u.data,e)}),d.dataset.action===i?ae(window.siyuan.languages.clearContextSucc):a.close()),c.stopPropagation(),c.preventDefault();break}d=d.parentElement}})}}),a.element.querySelector(".b3-menu__items").setAttribute("style","overflow: initial"),a.fullscreen()},id=(e,t)=>{const n=new we({title:"\u2728 "+window.siyuan.languages.aiWriting,content:`<div class="b3-dialog__content"><textarea class="b3-text-field fn__block"></textarea></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:H()?"92vw":"520px"}),a=n.element.querySelector("textarea"),s=n.element.querySelectorAll(".b3-button");n.bindInput(a,()=>{s[1].click()}),a.focus(),s[0].addEventListener("click",()=>{n.destroy()}),s[1].addEventListener("click",()=>{let i=a.value;A("/api/ai/chatGPT",{msg:i},l=>{n.destroy();let o="";l.data&&l.data!==""&&(o=`

`+l.data),i==="Clear context"&&(i=""),Is(e,`${i}${o}`,[t])})})};class Sg{constructor(t){this.enableSlash=!0,this.enableEmoji=!0,this.enableExtend=!1,this.splitChar="",this.lastIndex=-1,this.element=document.createElement("div"),this.element.setAttribute("data-close","false"),this.element.className="protyle-hint b3-list b3-list--background fn__none",this.element.addEventListener("click",n=>{var a;const s=n.target;if(s.tagName==="INPUT"){n.stopPropagation();return}const i=O(s,"BUTTON");if(i&&!i.classList.contains("emojis__item")&&!i.classList.contains("emojis__type")){this.fill(decodeURIComponent(i.getAttribute("data-value")),t,!1,this.source==="search"?Ue(n):bt(n)),n.preventDefault(),n.stopPropagation();return}const l=this.element.querySelector(".emojis__panel"),o=$(s,"emojis__type");if(o){const c=l.querySelector(`[data-type="${o.getAttribute("data-type")}"]`);if(c){const d=c.nextElementSibling.getAttribute("data-index");if(d){let u="";window.siyuan.emojis[parseInt(d)].items.forEach(p=>{u+=`<button data-unicode="${p.unicode}" class="emojis__item ariaLabel" aria-label="${ka(p)}">
${ge(p.unicode)}</button>`}),c.nextElementSibling.innerHTML=u,c.nextElementSibling.removeAttribute("data-index")}l.scrollTo({top:c.offsetTop})}return}const r=$(s,"emojis__item");if(r){const c=r.getAttribute("data-unicode");if(this.element.querySelectorAll(".emojis__title").length>2){const d=getSelection().getRangeAt(0);d.endContainer.nodeType!==3?(a=d.endContainer.childNodes[d.endOffset-1])==null||a.remove():d.endContainer.textContent===":"&&(d.endContainer.textContent=""),ha(c);let u;c.indexOf(".")>-1?u=`:${c.split(".")[0]}: `:u=ge(c)+" ",Xe(t.lute.SpinBlockDOM(u),t,!1,!0),this.element.classList.add("fn__none")}else this.fill(c,t)}})}render(t){if(!window.getSelection().focusNode){this.element.classList.add("fn__none"),clearTimeout(this.timeId);return}if(!this.enableExtend){clearTimeout(this.timeId);return}if(t.toolbar.range=getSelection().getRangeAt(0),t.toolbar.range.startContainer.nodeType===3&&t.toolbar.range.startContainer.textContent===""){const i=ut(t.toolbar.range.startContainer);if(i&&i.nodeType===3){if(i.wholeText!==i.textContent){let l=i.previousSibling;for(;l&&l.nodeType===3;)if(l.textContent==="")l=l.previousSibling,l.nextSibling.remove();else{i.textContent=l.textContent+i.textContent,l.remove();break}}t.toolbar.range.setStart(i,i.textContent.length),t.toolbar.range.collapse(!0)}}const n=Je(t.toolbar.range.startContainer,t.wysiwyg.element).start,a=t.toolbar.range.startContainer.textContent.substring(0,n)||"",s=this.getKey(a,t.options.hint.extend);if(typeof s=="undefined"||D(t.toolbar.range.startContainer,"data-type","code")||D(t.toolbar.range.startContainer,"data-type","NodeCodeBlock")){this.element.classList.add("fn__none"),clearTimeout(this.timeId);return}if(this.splitChar==="#"){const i=B(t.toolbar.range.startContainer);if(i&&i.getAttribute("data-type")==="NodeHeading"){const l=Je(t.toolbar.range.startContainer,i).start;if(i.textContent.startsWith("#".repeat(l))){this.element.classList.add("fn__none"),clearTimeout(this.timeId);return}}}if(this.splitChar===":"){clearTimeout(this.timeId),s?this.genEmojiHTML(t,s):this.element.classList.add("fn__none");return}if(this.splitChar==="/"||this.splitChar==="\u3001"){clearTimeout(this.timeId),this.enableSlash&&!H()&&this.genHTML(lo(s,t),t,!1,"hint");return}t.options.hint.extend.forEach(i=>{i.key===this.splitChar&&(clearTimeout(this.timeId),this.timeId=window.setTimeout(()=>{this.genHTML(i.hint(s,t,"hint"),t,!1,"hint")},t.options.hint.delay))})}genLoading(t){if(this.element.classList.contains("fn__none")){this.element.innerHTML='<div class="fn__loading" style="height: 128px;position: initial"><img width="64px" src="/stage/loading-pure.svg"></div>',this.element.classList.remove("fn__none");const n=hn(t.wysiwyg.element);ke(this.element,n.left,n.top+26,30)}else this.element.insertAdjacentHTML("beforeend",'<div class="fn__loading"><img width="64px" src="/stage/loading-pure.svg"></div>')}bindUploadEvent(t,n){n.querySelectorAll('input[type="file"]').forEach(a=>{a.addEventListener("change",s=>{if(s.target.files.length===0)return;const i=ye(t.wysiwyg.element);this.lastIndex>-1&&i.setStart(i.startContainer,this.lastIndex),i.deleteContents(),Rn(t,s.target.files,s.target),J(["hint","toolbar"],t)})})}getHTMLByData(t){let n='<div style="flex: 1;overflow:auto;">';return this.source!=="hint"&&(n='<input style="margin:0 8px 4px 8px" class="b3-text-field"><div style="flex: 1;overflow:auto;">'),t.forEach((a,s)=>{let i="";(s===1&&t[s].focus||s===0&&(t.length===1||!t[1].focus))&&(i=" b3-list-item--focus"),a.html==="separator"?n+=`<button data-id="${a.id||""}" class="b3-menu__separator"></button>`:n+=`<button data-id="${a.id||""}" style="width: calc(100% - 16px)" class="b3-list-item b3-list-item--two${i}" data-value="${encodeURIComponent(a.value)}">${a.html}</button>`}),`${n}</div>`}genHTML(t,n,a=!1,s){var i;if(this.source=s,t.length===0){(!this.element.querySelector(".fn__loading")||a)&&this.element.classList.add("fn__none");return}if(this.element.innerHTML=this.getHTMLByData(t),this.element.classList.remove("fn__none"),t[0].filter?this.element.classList.add("hint--menu"):this.element.classList.remove("hint--menu"),this.source==="av"){const l=$(n.toolbar.range.startContainer,"av__cell");if(l){const o=l.getBoundingClientRect();ke(this.element,o.left,o.bottom,o.height)}}else{const l=hn(n.wysiwyg.element);ke(this.element,l.left,l.top+26,30)}if(this.element.scrollTop=0,this.bindUploadEvent(n,this.element),this.source!=="hint"){const l=this.element.querySelector("input.b3-text-field"),o=((i=this.element.querySelector("mark"))==null?void 0:i.textContent)||"";l.value=o,l.select(),l.addEventListener("keydown",c=>{c.key!=="Meta"&&c.key!=="Control"&&c.stopPropagation(),!c.isComposing&&(Wt(this.element.lastElementChild,c),c.key==="Enter"?(this.fill(decodeURIComponent(this.element.querySelector(".b3-list-item--focus").getAttribute("data-value")),n,!1,Ue(c)),c.preventDefault()):c.key==="Escape"&&(this.element.classList.add("fn__none"),X(n.toolbar.range)))});const r=n.toolbar.range?B(n.toolbar.range.startContainer):!1;l.addEventListener("input",c=>{c.isComposing||(c.stopPropagation(),this.genSearchHTML(n,l,r,o,s))}),l.addEventListener("compositionend",c=>{c.stopPropagation(),this.genSearchHTML(n,l,r,o,s)})}}genSearchHTML(t,n,a,s,i){this.element.lastElementChild.innerHTML='<div class="ft__center"><img style="height:32px;width:32px;" src="/stage/loading-pure.svg"></div>',A("/api/search/searchRefBlock",{k:n.value,id:a?a.getAttribute("data-node-id"):t.block.parentID,beforeLen:Math.floor((Math.max(t.element.clientWidth/2,320)-58)/28.8),rootID:i==="av"?"":t.block.rootID,isDatabase:i==="av"},l=>{let o="";if(l.data.newDoc){const r=`((newFile "${s}"${f.ZWSP}'${l.data.k}${Lute.Caret}'))`;o+=`<button style="width: calc(100% - 16px)" class="b3-list-item b3-list-item--two${l.data.blocks.length===0?" b3-list-item--focus":""}" data-value="${encodeURIComponent(r)}"><div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg>
<span class="b3-list-item__text">${window.siyuan.languages.newFile} <mark>${l.data.k}</mark></span></div></button>`}l.data.blocks.forEach((r,c)=>{let d;if(i==="av"){let u=r.name||r.refText.replace(new RegExp(f.ZWSP,"g"),"");a&&(u=r.ial["custom-sy-av-s-text-"+a.getAttribute("data-av-id")]||u),d=`<span data-type="block-ref" data-id="${r.id}" data-subtype="s">${u}</span>`}else d=`<span data-type="block-ref" data-id="${r.id}" data-subtype="s">${s}</span>`;o+=`<button style="width: calc(100% - 16px)" class="b3-list-item b3-list-item--two${c===0?" b3-list-item--focus":""}" data-value="${encodeURIComponent(d)}">
${oo(r)}
</button>`}),o===""&&(o=`<button style="width: calc(100% - 16px)" class="b3-list-item b3-list-item--two" data-value="">${window.siyuan.languages.emptyContent}</button>`),this.element.lastElementChild.innerHTML=o,ke(this.element,parseInt(this.element.style.left),parseInt(this.element.style.right))})}genEmojiHTML(t,n=""){if(n&&!this.enableEmoji)return;const a=this.element.querySelector(".emojis__panel");a?(a.innerHTML=mi(n,256),n?a.nextElementSibling.classList.add("fn__none"):a.nextElementSibling.classList.remove("fn__none"),pi(a)):(this.element.innerHTML=`<div style="padding:0;max-height:min(402px,40vh);width:366px" class="emojis">
<div class="emojis__panel">${mi(n,256)}</div>
<div class="fn__flex${n?" fn__none":""}">
    ${[["2b50",window.siyuan.languages.recentEmoji],["1f527",wt(0)],["1f60d",wt(1)],["1f433",wt(2)],["1f96a",wt(3)],["1f3a8",wt(4)],["1f3dd-fe0f",wt(5)],["1f52e",wt(6)],["267e-fe0f",wt(7)],["1f6a9",wt(8)]].map(([i,l],o)=>`<button data-type="${o}" class="emojis__type ariaLabel" aria-label="${l}">${ge(i)}</button>`).join("")}
</div>
</div>`,Qi(this.element),pi(this.element));const s=this.element.querySelector(".emojis__item");if(s){s.classList.add("emojis__item--current"),this.element.classList.remove("fn__none");const i=hn(t.wysiwyg.element);ke(this.element,i.left,i.top+26,30),this.element.querySelector(".emojis__panel").scrollTop=0}else this.element.classList.add("fn__none")}fill(t,n,a=!0,s=!1){var i;J(["hint","toolbar"],n),a&&this.source!=="av"&&(n.toolbar.range=ye(n.wysiwyg.element));const l=n.toolbar.range;let o=B(n.toolbar.range.startContainer);if(!o)return;if(this.source==="av"){let u=$(n.toolbar.range.startContainer,"av__cell");if(u||(u=o.querySelector(".av__cell--select")),!u)return;const p=$(u,"av__row");if(!p)return;const g=u.dataset.blockId,m=o.getAttribute("data-av-id");let b=document.createElement("div");if(b.innerHTML=t.replace(/<mark>/g,"").replace(/<\/mark>/g,""),b=b.firstElementChild,t.startsWith("((newFile ")&&t.endsWith(`${Lute.Caret}'))`)){const y=t.substring(11,t.length-4).split(`"${f.ZWSP}'`),_=y.length===1?y[0]:y[1],w=Lute.NewNodeID();p.dataset.id=w,Sl(n.path,n.notebookId,(v,h)=>{A("/api/filetree/createDocWithMd",{notebook:h,path:me().join(v,_),parentID:n.notebookId===h?n.block.rootID:"",markdown:"",id:w},()=>{q(n,[{action:"replaceAttrViewBlock",avID:m,previousID:g,nextID:w,isDetached:!1}],[{action:"replaceAttrViewBlock",avID:m,previousID:w,nextID:g,isDetached:!0}])})}),Tt(u,{type:"block",isDetached:!1,block:{content:_,id:w}})}else{const y=b.getAttribute("data-id");p.dataset.id=y,q(n,[{action:"replaceAttrViewBlock",avID:m,previousID:g,nextID:y,isDetached:!1}],[{action:"replaceAttrViewBlock",avID:m,previousID:y,nextID:g,isDetached:!0}]),Tt(u,{type:"block",isDetached:!1,block:{content:b.textContent,id:y}})}return}this.enableExtend=!1;let r="";o&&(r=o.getAttribute("data-node-id"));const c=o.outerHTML,d=f.BLOCK_HINT_CLOSE_KEYS[this.splitChar];if(f.BLOCK_HINT_KEYS.includes(this.splitChar)&&d&&l.startContainer.nodeType===3&&l.startContainer.wholeText.indexOf(d)>-1&&l.startContainer.wholeText.indexOf(this.splitChar)>-1){let u=0,p=l.startContainer;for(;p&&u<2;){const g=p.textContent.indexOf(d),m=p.textContent.indexOf(this.splitChar);if(g>-1&&(g<m||m<0)){u=2,l.setEnd(p,g+2);break}const b=p.textContent.indexOf(d.substr(1));if(b>-1&&(u+=1),u===2){l.setEnd(p,b+1);break}p=p.nextSibling}}if(this.lastIndex>-1&&(l.setStart(l.startContainer,this.lastIndex),Dn()&&X(l)),f.BLOCK_HINT_KEYS.includes(this.splitChar)&&t.startsWith("((newFile ")&&t.endsWith(`${Lute.Caret}'))`)){const u=t.substring(11,t.length-4).split(`"${f.ZWSP}'`),p=u.length===1?u[0]:u[1];Sl(n.path,n.notebookId,(g,m)=>{A("/api/filetree/createDocWithMd",{notebook:m,path:me().join(g,p),parentID:n.notebookId===m?n.block.rootID:"",markdown:""},b=>{n.toolbar.range=l,n.toolbar.setInlineMark(n,"block-ref","range",{type:"id",color:`${b.data}${f.ZWSP}${s?"s":"d"}${f.ZWSP}${(s?u[0]:p).substring(0,window.siyuan.config.editor.blockRefDynamicAnchorTextMaxLen)}`})})});return}if(f.BLOCK_HINT_KEYS.includes(this.splitChar)){if(t===""){const p=oe(o);p.textContent===""&&(p.innerHTML="<wbr>",ue(p,l));return}let u=document.createElement("div");if(u.innerHTML=t.replace(/<mark>/g,"").replace(/<\/mark>/g,""),u=u.firstElementChild,s){const p=l.toString().replace(this.splitChar,"");p&&(u.setAttribute("data-subtype","s"),u.innerText=p)}else{u.setAttribute("data-subtype","d");const p=u.innerText.split(f.ZWSP);p.length===2&&(u.innerText=p[1])}n.toolbar.setInlineMark(n,"block-ref","range",{type:"id",color:`${u.getAttribute("data-id")}${f.ZWSP}${u.getAttribute("data-subtype")}${f.ZWSP}${u.textContent}`});return}else if(this.splitChar===":"){ha(t);let u;t.indexOf(".")>-1?u=`:${t.split(".")[0]}: `:u=ge(t)+" ",Xe(n.lute.SpinBlockDOM(u),n)}else if(["\u300C\u300C","\u300C\u300E","\u300E\u300C","\u300E\u300E","{{"].includes(this.splitChar)||this.splitChar==="#"||this.splitChar===":"){if(t===""){const u=oe(o);u.textContent===""&&(u.innerHTML="<wbr>",ue(u,l));return}Xe(n.lute.SpinBlockDOM(t),n,!1,H()),Se(n,n.wysiwyg.element);return}else if(this.splitChar==="/"||this.splitChar==="\u3001")if(this.enableExtend=!0,t==="(("||t==="{{"){t==="(("?fa("",n,"hint"):li("",n),this.splitChar=t,this.lastIndex=0,l.deleteContents();const u=document.createTextNode(t);l.insertNode(u),l.setEnd(u,t.length),l.collapse(!1),X(l);return}else if(t===f.ZWSP){l.deleteContents(),this.fixImageCursor(l),n.toolbar.showTpl(n,o,l),K(n,r,o.outerHTML,c);return}else if(t===f.ZWSP+1){l.deleteContents(),this.fixImageCursor(l),n.toolbar.showWidget(n,o,l),K(n,r,o.outerHTML,c);return}else if(t===f.ZWSP+2){l.deleteContents(),this.fixImageCursor(l),n.toolbar.range=l;const u=hn(o,l);Tl(n,{x:u.left,y:u.top+26,w:0,h:26}),K(n,r,o.outerHTML,c);return}else if(t===f.ZWSP+3){l.deleteContents();return}else if(t===f.ZWSP+4){aa({app:n.app,notebookId:n.notebookId,useSavePath:!0,currentPath:n.path,afterCB:(u,p)=>{Xe(`<span data-type="block-ref" data-id="${u}" data-subtype="d">${p}</span>`,n)}});return}else if(t===f.ZWSP+6){const u=Lute.NewNodeID();A("/api/filetree/createDoc",{notebook:n.notebookId,path:me().join(ct(n.path,!1,!0),u+".sy"),title:window.siyuan.languages.untitled,md:""},()=>{Xe(`<span data-type="block-ref" data-id="${u}" data-subtype="d">${window.siyuan.languages.untitled}</span>`,n),at(n.app,u,[f.CB_GET_CONTEXT,f.CB_GET_OPENNEW])});return}else if(t===f.ZWSP+5){l.deleteContents(),id(n,o);return}else if(f.INLINE_TYPE.includes(t)){if(l.deleteContents(),X(l),["a","block-ref","inline-math","inline-memo","text"].includes(t)){n.toolbar.element.querySelector(`[data-type="${t}"]`).dispatchEvent(new CustomEvent("click"));return}n.toolbar.setInlineMark(n,t,"range");return}else if(t==="emoji"){l.deleteContents(),l.insertNode(document.createTextNode(":")),l.collapse(!1),X(l),this.genEmojiHTML(n);return}else if(t.indexOf("style")>-1){l.deleteContents(),this.fixImageCursor(l),o.setAttribute("style",t.split(f.ZWSP)[1]||""),K(n,r,o.outerHTML,c);return}else if(t.startsWith("plugin")){n.app.plugins.find(u=>{const p=t.split(f.ZWSP);if(p[1]===u.name)return u.protyleSlash.find(g=>{if(g.id===p[2])return g.callback(n.getInstance(),o),!0}),!0});return}else{l.deleteContents(),t!=="![]()"&&this.fixImageCursor(l);let u=t;t==="```"&&(u=t+(f.SIYUAN_RENDER_CODE_LANGUAGES.includes(window.siyuan.storage[f.LOCAL_CODELANG])?"":window.siyuan.storage[f.LOCAL_CODELANG])+Lute.Caret+"\n```");const p=oe(o);if(t==="![]()"){let g="";l.insertNode(document.createElement("wbr")),l.insertNode(document.createTextNode(t)),g=n.lute.SpinBlockDOM(o.outerHTML),o.outerHTML=g,o=n.wysiwyg.element.querySelector(`[data-node-id="${r}"]`),ue(o,l),K(n,r,o.outerHTML,c);let m=l.startContainer.childNodes[l.startOffset-1]||l.startContainer;m&&m.nodeType!==3&&m.classList.contains("img")||(((i=m.previousSibling)==null?void 0:i.nodeType)!==3&&m.previousSibling.classList.contains("img")?m=m.previousSibling:Array.from(o.querySelectorAll(".img")).find(y=>{if(y.querySelector("img").getAttribute("data-src")==="")return m=y,!0}));const b=m.getBoundingClientRect();Ml(n,l,m,{clientX:b.left,clientY:b.top});return}else if(p.textContent===""&&o.getAttribute("data-type")==="NodeParagraph"){let g="";t==="<div>"?g=`<div data-node-id="${r}" data-type="NodeHTMLBlock" class="render-node" data-subtype="block">${Gn()}<div><protyle-html data-content=""></protyle-html><span style="position: absolute">${f.ZWSP}</span></div><div class="protyle-attr" contenteditable="false"></div></div>`:(p.textContent=u,g=n.lute.SpinBlockDOM(o.outerHTML)),o.outerHTML=g,o=n.wysiwyg.element.querySelector(`[data-node-id="${r}"]`),o.getAttribute("data-type")==="NodeTable"&&(o.querySelectorAll("colgroup col").forEach(m=>{m.style.minWidth="60px"}),g=o.outerHTML),K(n,r,g,c)}else{let g=n.lute.SpinBlockDOM(u);t==="<div>"&&(g=`<div data-node-id="${Lute.NewNodeID()}" data-type="NodeHTMLBlock" class="render-node" data-subtype="block">${Gn()}<div><protyle-html data-content=""></protyle-html><span style="position: absolute">${f.ZWSP}</span></div><div class="protyle-attr" contenteditable="false"></div></div>`),o.insertAdjacentHTML("afterend",g);const m=o.outerHTML,b=g.substr(g.indexOf('data-node-id="')+14,22);o=n.wysiwyg.element.querySelector(`[data-node-id="${b}"]`),o.getAttribute("data-type")==="NodeTable"&&o.querySelectorAll("colgroup col").forEach(y=>{y.style.minWidth="60px"}),q(n,[{data:m,id:r,action:"update"},{data:o.outerHTML,id:b,previousID:r,action:"insert"}],[{id:b,action:"delete"},{data:c,id:r,action:"update"}])}if(t==="<div>"||t==="$$"||t.indexOf("```")>-1&&(t.length>3||o.classList.contains("render-node")))n.toolbar.showRender(n,o),Ze(o);else if(t.startsWith("```"))Pe(o);else if(t.startsWith("<iframe")||t.startsWith("<video")||t.startsWith("<audio")){n.gutter.renderMenu(n,o);const g=o.getBoundingClientRect();window.siyuan.menus.menu.popup({x:g.left,y:g.top,isLeft:!0});const m=window.siyuan.menus.menu.element.querySelector('[data-id="assetVideo"], [data-id="assetAudio"], [data-id="assetIFrame"]');m.classList.add("b3-menu__item--show"),window.siyuan.menus.menu.showSubMenu(m.querySelector(".b3-menu__submenu")),window.siyuan.menus.menu.element.querySelector("textarea").focus()}else t==="---"?ne(o):o.classList.contains("av")?ze(o,n,()=>{o.querySelector(".av__title").focus()}):ue(o,l)}}select(t,n){var a,s,i,l,o;const r=this.element.firstElementChild.classList.contains("emojis");if(this.element.querySelectorAll("button").length===0&&!r)return!1;if(t.key==="Enter"){if(r){const c=this.element.querySelector(".emojis__item--current");if(!c)return!1;const d=c.getAttribute("data-unicode");if(this.element.querySelectorAll(".emojis__title").length>2){const u=getSelection().getRangeAt(0);u.endContainer.nodeType!==3&&((a=u.endContainer.childNodes[u.endOffset-1])==null||a.remove()),ha(d);let p;d.indexOf(".")>-1?p=`:${d.split(".")[0]}: `:p=ge(d)+" ",Xe(n.lute.SpinBlockDOM(p),n),this.element.classList.add("fn__none")}else this.fill(d,n)}else{const c=decodeURIComponent(this.element.querySelector(".b3-list-item--focus").getAttribute("data-value"));c===f.ZWSP+3?this.element.querySelector(".b3-list-item--focus input").click():this.fill(c,n,!0,bt(t))}return t.preventDefault(),t.stopPropagation(),!0}if(r){const c=this.element.querySelector(".emojis__item--current");if(!c)return!1;let d;if(t.key==="ArrowLeft")c.previousElementSibling?(c.classList.remove("emojis__item--current"),d=c.previousElementSibling):(s=c.parentElement.previousElementSibling)!=null&&s.previousElementSibling&&(c.classList.remove("emojis__item--current"),d=c.parentElement.previousElementSibling.previousElementSibling.lastElementChild);else if(t.key==="ArrowRight")c.nextElementSibling?(c.classList.remove("emojis__item--current"),d=c.nextElementSibling):(i=c.parentElement.nextElementSibling)!=null&&i.nextElementSibling&&(c.classList.remove("emojis__item--current"),d=c.parentElement.nextElementSibling.nextElementSibling.firstElementChild);else if(t.key==="ArrowDown"){if(c.nextElementSibling){c.classList.remove("emojis__item--current");let u=Math.floor(c.parentElement.clientWidth/(c.clientWidth+2));for(d=c;d.nextElementSibling&&u>0;)d=d.nextElementSibling,u--}else{const u=(l=c.parentElement.nextElementSibling)==null?void 0:l.nextElementSibling;u&&(d=u.firstElementChild,c.classList.remove("emojis__item--current"))}t.preventDefault(),t.stopPropagation()}else if(t.key==="ArrowUp"){if(c.previousElementSibling){c.classList.remove("emojis__item--current");let u=Math.floor(c.parentElement.clientWidth/(c.clientWidth+2));for(d=c;d.previousElementSibling&&u>0;)d=d.previousElementSibling,u--}else{const u=(o=c.parentElement.previousElementSibling)==null?void 0:o.previousElementSibling;u&&(d=u.lastElementChild,c.classList.remove("emojis__item--current"))}t.preventDefault(),t.stopPropagation()}if(d){d.classList.add("emojis__item--current");const u=this.element.querySelector(".emojis__panel");if(d.offsetTop-8<u.scrollTop)u.scrollTop=d.offsetTop-8;else{const p=u.nextElementSibling.classList.contains("fn__none")?8:36;d.offsetTop+p-this.element.clientHeight+d.clientHeight>u.scrollTop&&(u.scrollTop=d.offsetTop+p-this.element.clientHeight+d.clientHeight)}}return t.preventDefault(),t.stopPropagation(),!0}else if(t.key==="ArrowDown"||t.key==="ArrowUp")return Wt(this.element.firstElementChild,t),t.preventDefault(),t.stopPropagation(),!0;return t.key==="ArrowLeft"||t.key==="ArrowRight"?(J(["hint"],n),!0):!1}fixImageCursor(t){const n=ut(t.startContainer);n&&n.nodeType!==3&&n.classList.contains("img")&&(Fe(n)||(t.insertNode(document.createTextNode(f.ZWSP)),t.collapse(!1)))}getKey(t,n){if(this.lastIndex=-1,this.splitChar="",n.forEach(i=>{let l=t.lastIndexOf(i.key);f.BLOCK_HINT_KEYS.includes(i.key)&&l>-1&&t.lastIndexOf(i.key+i.key.substring(0,1))>-1&&(l=Math.min(l,t.lastIndexOf(i.key+i.key.substring(0,1)))),this.lastIndex<l&&(f.BLOCK_HINT_KEYS.includes(this.splitChar)&&(i.key===":"||i.key==="#"||i.key==="/"||i.key==="\u3001")||this.splitChar==="#"&&(i.key==="/"||i.key==="\u3001")||(this.splitChar=i.key,this.lastIndex=l))}),this.lastIndex===-1)return;this.splitChar===":"&&(this.enableEmoji=!(/\d/.test(t.substr(this.lastIndex-1,1))||t.substr(this.lastIndex-1,2)==="::"));const a=t.split(this.splitChar),s=a[a.length-1];if(a.length>1&&s.trimStart()===s&&s.length<f.SIZE_TITLE)return this.splitChar==="\u3010\u3010"&&t.endsWith("\u3010\u3010\u3011")?"":s}}const xg=e=>{const t=Lute.New();if(t.SetSpellcheck(window.siyuan.config.editor.spellcheck),t.SetProtyleMarkNetImg(window.siyuan.config.editor.displayNetImgMark),t.SetFileAnnotationRef(!0),t.SetHTMLTag2TextMark(!0),t.SetTextMark(!0),t.SetHeadingID(!1),t.SetYamlFrontMatter(!1),t.PutEmojis(e.emojis),t.SetEmojiSite(e.emojiSite),t.SetHeadingAnchor(e.headingAnchor),t.SetInlineMathAllowDigitAfterOpenMarker(!0),t.SetToC(!1),t.SetIndentCodeBlock(!1),t.SetParagraphBeginningSpace(!0),t.SetSetext(!1),t.SetFootnotes(!1),t.SetLinkRef(!1),t.SetSanitize(e.sanitize),t.SetChineseParagraphBeginningSpace(e.paragraphBeginningSpace),t.SetRenderListStyle(e.listStyle),t.SetImgPathAllowSpace(!0),t.SetKramdownIAL(!0),t.SetTag(!0),t.SetSuperBlock(!0),t.SetMark(!0),t.SetInlineAsterisk(window.siyuan.config.editor.markdown.inlineAsterisk),t.SetInlineUnderscore(window.siyuan.config.editor.markdown.inlineUnderscore),t.SetSup(window.siyuan.config.editor.markdown.inlineSup),t.SetSub(window.siyuan.config.editor.markdown.inlineSub),t.SetTag(window.siyuan.config.editor.markdown.inlineTag),t.SetInlineMath(window.siyuan.config.editor.markdown.inlineMath),t.SetGFMStrikethrough1(!1),t.SetGFMStrikethrough(window.siyuan.config.editor.markdown.inlineStrikethrough),t.SetMark(window.siyuan.config.editor.markdown.inlineMark),t.SetSpin(!0),t.SetProtyleWYSIWYG(!0),e.lazyLoadImage&&t.SetImageLazyLoading(e.lazyLoadImage),t.SetBlockRef(!0),window.siyuan.emojis[0].items.length>0){const n={};window.siyuan.emojis[0].items.forEach(a=>{n[a.keywords]=e.emojiSite+"/"+a.unicode}),t.PutEmojis(n)}return t},Ag=(e,t)=>{if(typeof speechSynthesis=="undefined"||typeof SpeechSynthesisUtterance=="undefined")return;const n='<svg><use xlink:href="#iconPlay"></use></svg>',a='<svg><use xlink:href="#iconPause"></use></svg>';let s=document.querySelector(".protyle-speech");if(!s){s=document.createElement("div"),s.className="protyle-speech",document.body.insertAdjacentElement("beforeend",s);const i=()=>{const o=speechSynthesis.getVoices();let r,c;return o.forEach(d=>{d.lang===t.replace("_","-")&&(r=d),d.default&&(c=d)}),r||(r=c),r};speechSynthesis.onvoiceschanged!==void 0&&(speechSynthesis.onvoiceschanged=i);const l=i();s.onclick=()=>{if(s.className==="protyle-speech"){const o=new SpeechSynthesisUtterance(s.getAttribute("data-text"));o.voice=l,o.onend=()=>{s.className="protyle-speech",speechSynthesis.cancel(),s.innerHTML=n},speechSynthesis.speak(o),s.className="protyle-speech protyle-speech--current",s.innerHTML=a}else speechSynthesis.speaking&&(speechSynthesis.paused?(speechSynthesis.resume(),s.innerHTML=a):(speechSynthesis.pause(),s.innerHTML=n));X(window.protyleSpeechRange)},document.body.addEventListener("click",()=>{getSelection().toString().trim()===""&&s.style.display==="block"&&(s.className="protyle-speech",speechSynthesis.cancel(),s.style.display="none")})}e.addEventListener("mouseup",i=>{const l=getSelection().toString().trim();if(speechSynthesis.cancel(),getSelection().toString().trim()===""){s.style.display==="block"&&(s.className="protyle-speech",s.style.display="none");return}window.protyleSpeechRange=getSelection().getRangeAt(0).cloneRange();const o=getSelection().getRangeAt(0).getBoundingClientRect();s.innerHTML=n,s.style.display="block",s.style.top=o.top+o.height+document.querySelector("html").scrollTop-20+"px",s.style.left=i.screenX+2+"px",s.setAttribute("data-text",l)})};class Cg{constructor(t){this.element=document.createElement("div"),this.element.className="protyle-preview fn__none";const n=document.createElement("div");n.className="b3-typography",t.options.classes.preview&&n.classList.add(t.options.classes.preview);const a=t.options.preview.actions,s=document.createElement("div");s.className="protyle-preview__action";const i=[];for(let l=0;l<a.length;l++){const o=a[l];if(typeof o=="object"){i.push(`<button type="button" data-type="${o.key}" class="${o.className}">${o.text}</button>`);continue}switch(o){case"desktop":i.push(`<button type="button" class="protyle-preview__action--current" data-type="desktop">${window.siyuan.languages.desktop}</button>`);break;case"tablet":i.push(`<button type="button" data-type="tablet">${window.siyuan.languages.tablet}</button>`);break;case"mobile":i.push(`<button type="button" data-type="mobile">${window.siyuan.languages.mobile}</button>`);break;case"mp-wechat":i.push(`<button type="button" data-type="mp-wechat" class="b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.copyToWechatMP}"><svg><use xlink:href="#iconMp"></use></svg></button>`);break;case"zhihu":i.push(`<button type="button" data-type="zhihu" class="b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.copyToZhihu}"><svg><use xlink:href="#iconZhihu"></use></svg></button>`);break;case"yuque":i.push(`<button type="button" data-type="yuque" class="b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.copyToYuque}"><svg><use xlink:href="#iconYuque"></use></svg></button>`);break}}s.innerHTML=i.join(""),this.element.appendChild(s),this.element.appendChild(n),this.element.addEventListener("click",l=>{let o=l.target;for(;o&&!o.isEqualNode(this.element);){if(o.tagName==="A"){const c=o.getAttribute("href");if(c.startsWith("#")){const d=c.substring(1);n.querySelector('[data-node-id="'+d+'"], [id="'+d+'"]').scrollIntoView(),l.stopPropagation(),l.preventDefault();break}if(H()){Et(c),l.stopPropagation(),l.preventDefault();break}l.stopPropagation(),l.preventDefault(),Oo(c)||window.open(c);break}else if(o.tagName==="IMG"){nr(l.target.getAttribute("src"),t.block.rootID),l.stopPropagation(),l.preventDefault();break}else if(o.tagName==="BUTTON"){const c=o.getAttribute("data-type"),d=a.find(u=>(u==null?void 0:u.key)===c);d?d.click(c):c==="mp-wechat"||c==="zhihu"||c==="yuque"?this.copyToX(this.element.lastElementChild.cloneNode(!0),t,c):c==="desktop"?(n.style.width="",n.style.padding=t.wysiwyg.element.style.padding):c==="tablet"?(n.style.width="1024px",n.style.padding="8px 16px"):(n.style.width="360px",n.style.padding="8px"),c!=="mp-wechat"&&c!=="zhihu"&&c!=="yuque"&&(s.querySelectorAll("button").forEach(u=>{u.classList.remove("protyle-preview__action--current")}),o.classList.add("protyle-preview__action--current"))}o=o.parentElement}const r=D(l.target,"id",void 0);r&&(this.element.querySelectorAll(".protyle-wysiwyg--select").forEach(c=>{c.classList.remove("selected")}),r.classList.add("selected"))}),this.previewElement=n}render(t){var n;if(this.element.style.display==="none")return;if((n=this.element.querySelector('.protyle-preview__action [data-type="desktop"]'))!=null&&n.classList.contains("protyle-preview__action--current")){const s=Wc(t);this.previewElement.style.padding=`${s.top}px ${s.left}px ${s.bottom}px ${s.right}px`}let a=this.element.querySelector(".fn__loading");a||(this.element.insertAdjacentHTML("beforeend",`<div style="flex-direction: column;" class="fn__loading">
    <img width="48px" src="/stage/loading-pure.svg">
</div>`),a=this.element.querySelector(".fn__loading")),this.mdTimeoutId=window.setTimeout(()=>{A("/api/export/preview",{id:t.block.parentID||t.options.blockId},s=>{const i=t.preview.previewElement.scrollTop;t.preview.previewElement.innerHTML=s.data.html,Ze(t.preview.previewElement),Pe(t.preview.previewElement),ze(t.preview.previewElement,t),Ag(t.preview.previewElement,t.options.lang),t.preview.previewElement.scrollTop=i,a.remove()})},t.options.preview.delay)}link2online(t){Vn("")||t.querySelectorAll("[href],[src]").forEach(n=>{const a=n.getAttribute("href")||n.getAttribute("src");if(a&&a.startsWith("assets/")){const s=f.ASSETS_ADDRESS+window.siyuan.user.userId+"/"+a;n.getAttribute("href")?n.setAttribute("href",s):n.setAttribute("src",s)}})}copyToX(t,n,a){if(a==="mp-wechat")this.link2online(t),t.querySelectorAll(".katex-html .base").forEach(l=>{l.style.display="initial"}),t.querySelectorAll("mjx-container > svg").forEach(l=>{l.setAttribute("width",parseInt(l.getAttribute("width"))*8+"px")});else if(a==="zhihu")this.link2online(t),t.querySelectorAll('[data-subtype="math"]').forEach(l=>{l.outerHTML=`<img class="Formula-image" data-eeimg="true" src="//www.zhihu.com/equation?tex=" alt="${l.getAttribute("data-content")}" style="${l.tagName==="DIV"?"display: block; max-width: 100%;":""}margin: 0 auto;">`}),t.querySelectorAll("blockquote").forEach(l=>{const o=[];this.processZHBlockquote(l,o),o.reverse().forEach(r=>{l.insertAdjacentElement("afterend",r)}),l.remove()}),this.processZHTable(t);else if(a==="yuque"){A("/api/lute/copyStdMarkdown",{id:n.block.rootID},l=>{Be(l.data),ae(`${window.siyuan.languages.pasteToYuque}`)});return}t.style.backgroundColor="#fff",t.querySelectorAll("code").forEach(l=>{l.style.backgroundImage="none"}),this.element.append(t);let s;getSelection().rangeCount>0&&(s=getSelection().getRangeAt(0).cloneRange());const i=t.ownerDocument.createRange();i.selectNodeContents(t),X(i),document.execCommand("copy"),this.element.lastElementChild.remove(),X(s),a&&ae(`${a==="zhihu"?window.siyuan.languages.pasteToZhihu:window.siyuan.languages.pasteToWechatMP}`)}processZHBlockquote(t,n){Array.from(t.children).forEach(a=>{if(a.tagName==="BLOCKQUOTE")this.processZHBlockquote(a,n);else if(a.tagName!=="P"||a.querySelector("img"))n.push(a);else{const s=n[n.length-1];(!s||s&&s.tagName!=="BLOCKQUOTE")&&n.push(document.createElement("blockquote")),n[n.length-1].append(a)}})}processZHTable(t){t.querySelectorAll("table").forEach(n=>{const a=n.querySelector("thead");if(!a)return;const s=n.querySelector("tbody");s?s.insertAdjacentElement("afterbegin",a.firstElementChild):n.innerHTML=`<tbody>${a.innerHTML}</tbody>`,a.remove()})}}const uo=(...e)=>{const t={},n=a=>{for(const s in a)a.hasOwnProperty(s)&&(Object.prototype.toString.call(a[s])==="[object Object]"?t[s]=uo(t[s],a[s]):t[s]=a[s])};for(let a=0;a<e.length;a++)n(e[a]);return t};class Tg{constructor(t){this.defaultOptions={mode:"wysiwyg",blockId:"",render:{background:!1,title:!1,gutter:!0,scroll:!1,breadcrumb:!0,breadcrumbDocName:!1},action:[],after:void 0,classes:{preview:""},hint:{delay:200,emoji:{"+1":"\u{1F44D}","-1":"\u{1F44E}",confused:"\u{1F615}",eyes:"\u{1F440}\uFE0F",heart:"\u2764\uFE0F",rocket:"\u{1F680}\uFE0F",smile:"\u{1F604}",tada:"\u{1F389}\uFE0F"},emojiPath:"/emojis",extend:[{key:"((",hint:fa},{key:"\u3010\u3010",hint:fa},{key:"\uFF08\uFF08",hint:fa},{key:"[[",hint:fa},{key:"{{",hint:li},{key:"\u300C\u300C",hint:li},{key:"\u300C\u300E",hint:li},{key:"\u300E\u300C",hint:li},{key:"\u300E\u300E",hint:li},{key:"#",hint:Eg},{key:"/",hint:lo},{key:"\u3001",hint:lo},{key:":"}]},lang:window.siyuan.config.appearance.lang,preview:{actions:["desktop","tablet","mobile","mp-wechat","zhihu","yuque"],delay:0,markdown:{paragraphBeginningSpace:window.siyuan.config.export.paragraphBeginningSpace,listStyle:!1,sanitize:!0},mode:"both"},toolbar:f.PROTYLE_TOOLBAR,typewriterMode:!1,upload:{max:1024*1024*1024*8,url:f.UPLOAD_ADDRESS,extraData:{},fieldName:"file[]",filename:n=>n.replace(/[\\/:*?"'<>|\[\]\(\)~!`&{}=#%$]/g,""),linkToImgUrl:"",withCredentials:!1}},this.options=t}merge(){var t;return this.options&&(this.options.toolbar?this.options.toolbar=this.mergeToolbar(this.options.toolbar):this.options.toolbar=this.mergeToolbar(this.defaultOptions.toolbar),(t=this.options.hint)!=null&&t.emoji&&(this.defaultOptions.hint.emoji=this.options.hint.emoji)),uo(this.defaultOptions,this.options)}mergeToolbar(t){return us(t)}}class $g{constructor(t){this.parentElement=document.createElement("div"),this.parentElement.classList.add("protyle-scroll"),this.parentElement.innerHTML=`<div class="protyle-scroll__up ariaLabel" data-position="north" aria-label="${Me("\u2318Home")}">
    <svg><use xlink:href="#iconUp"></use></svg>
</div>
<div class="fn__none protyle-scroll__bar ariaLabel" data-position="2west" aria-label="Blocks 1/1">
    <input class="b3-slider" type="range" max="1" min="1" step="1" value="1" />
</div>
<div class="protyle-scroll__down ariaLabel" aria-label="${Me("\u2318End")}">
    <svg><use xlink:href="#iconDown"></use></svg>
</div>`,this.element=this.parentElement.querySelector(".protyle-scroll__bar"),this.keepLazyLoad=!1,t.options.render.scroll||this.parentElement.classList.add("fn__none"),this.lastScrollTop=0,this.inputElement=this.element.firstElementChild,this.inputElement.addEventListener("input",()=>{this.element.setAttribute("aria-label",`Blocks ${this.inputElement.value}/${t.block.blockCount}`),cs(this.element.getAttribute("aria-label"),this.element)}),this.inputElement.addEventListener("change",()=>{this.setIndex(t)}),this.inputElement.addEventListener("touchend",()=>{this.setIndex(t)}),this.parentElement.addEventListener("click",n=>{const a=n.target;$(a,"protyle-scroll__up")?sf(t):$(a,"protyle-scroll__down")?lf(t):a.classList.contains("b3-slider")&&this.setIndex(t)}),this.parentElement.addEventListener("mousewheel",n=>{n.deltaY!==0&&t.scroll.lastScrollTop!==-1&&(t.contentElement.scrollTop+=n.deltaY)},{passive:!0})}setIndex(t){t.wysiwyg.element.getAttribute("data-top")||(t.wysiwyg.element.setAttribute("data-top",t.wysiwyg.element.scrollTop.toString()),t.contentElement.style.overflow="hidden",A("/api/filetree/getDoc",{index:parseInt(this.inputElement.value),id:t.block.parentID,mode:0,size:window.siyuan.config.editor.dynamicLoadBlocks},n=>{Qe({data:n,protyle:t,action:[f.CB_GET_FOCUSFIRST,f.CB_GET_UNCHANGEID],afterCB:()=>{setTimeout(()=>{t.contentElement.style.overflow=""},f.TIMEOUT_INPUT),cs(this.element.getAttribute("aria-label"),this.element)}})}))}updateIndex(t,n,a){A("/api/block/getBlockIndex",{id:n},s=>{if(!s.data)return;const i=t.scroll.element.querySelector(".b3-slider");i.value=s.data,t.scroll.element.setAttribute("aria-label",`Blocks ${s.data}/${t.block.blockCount}`),a&&a(s.data)})}update(t){typeof t.block.blockCount=="number"&&(this.inputElement.setAttribute("max",t.block.blockCount.toString()),this.element.setAttribute("aria-label",`Blocks ${this.inputElement.value}/${t.block.blockCount}`)),t.block.showAll?this.element.classList.add("fn__none"):t.block.scroll&&!t.contentElement.classList.contains("fn__none")?this.element.classList.remove("fn__none"):this.element.classList.add("fn__none")}}class Oi{constructor(t){this.app=t.app,t.msgCallback&&this.connect(t)}connect(t){const n=`${window.location.protocol==="https:"?"wss":"ws"}://${window.location.host}/ws`,a=new WebSocket(`${n}?app=${f.SIYUAN_APPID}&id=${t.id}${t.type?"&type="+t.type:""}`);a.onopen=()=>{t.callback&&t.callback.call(this),document.getElementById("errorLog")&&(ao(this.app,{upsertRootIDs:[],removeRootIDs:[]}),window.siyuan.dialogs.find(i=>{if(i.element.id==="errorLog")return i.destroy(),!0}))},a.onmessage=s=>{if(t.msgCallback){const i=il(JSON.parse(s.data));t.msgCallback.call(this,i)}},a.onclose=s=>{0<=s.reason.indexOf("unauthenticated")||0>s.reason.indexOf("close websocket")&&(console.warn("WebSocket is closed. Reconnect will be attempted in 3 second.",s),setTimeout(()=>{this.connect({id:t.id,type:t.type,msgCallback:t.msgCallback})},3e3))},a.onerror=s=>{s.target.url.endsWith("&type=main")&&s.target.readyState===3&&Xc()},this.ws=a}send(t,n,a=!1){this.ws&&(this.reqId=a?0:new Date().getTime(),this.ws.send(JSON.stringify({cmd:t,reqId:this.reqId,param:n})))}}var Ds=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{o(n.next(r))}catch(c){s(c)}},l=r=>{try{o(n.throw(r))}catch(c){s(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,l);o((n=n.apply(e,t)).next())});const sd=(e,t,n,a,s,i,l)=>{let o;const r=n.getAttribute("data-node-id"),c=a.getAttribute("data-node-id"),d=[],u=[];return n.insertAdjacentElement(i?"afterend":"beforebegin",a),i?d.push({action:"insert",data:a.outerHTML,id:c,previousID:r}):d.push({action:"insert",data:a.outerHTML,id:c,nextID:r}),t.reverse().forEach((p,g)=>{var m;const b=p.getAttribute("data-node-id");g===t.length-1&&(o=Ne(p),o.isSameNode(p)&&(o=void 0,Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${p.getAttribute("data-node-id")}"]`)).find(_=>{if(!re(_)&&_.parentElement.querySelectorAll(".li").length===1)return o=_.parentElement,!0})));const y=Lute.NewNodeID();if(l?u.push({action:"delete",id:y}):u.push({action:"move",id:b,previousID:(m=p.previousElementSibling)==null?void 0:m.getAttribute("data-node-id"),parentID:p.parentElement.getAttribute("data-node-id")||e.block.rootID}),!s&&!l){const _=e.wysiwyg.element.querySelector(`[data-node-id="${b}"]`);_&&_.remove()}if(l){const _=p.cloneNode(!0);_.setAttribute("data-node-id",y),_.querySelectorAll("[data-node-id]").forEach(w=>{const v=Lute.NewNodeID();w.setAttribute("data-node-id",v),w.setAttribute("updated",v.split("-")[0])}),a.insertAdjacentElement("afterbegin",_),d.push({action:"insert",id:y,data:_.outerHTML,parentID:c})}else a.insertAdjacentElement("afterbegin",p),d.push({action:"move",id:b,parentID:c})}),u.reverse(),a.getAttribute("data-subtype")==="o"&&(u.splice(0,0,{action:"update",id:c,data:a.outerHTML}),je(a,1),d.push({action:"update",id:c,data:a.outerHTML})),u.push({action:"delete",id:c}),{doOperations:d,undoOperations:u,topSourceElement:o}},ld=(e,t,n,a,s,i)=>Ds(void 0,null,function*(){let l;const o=[],r=[],c=[],d=n.getAttribute("data-node-id");let u=n;t.reverse().forEach((p,g)=>{var m,b,y,_,w;const v=p.getAttribute("data-node-id"),h=p.parentElement.getAttribute("data-node-id")||e.block.rootID;g===t.length-1&&(l=Ne(p),l.isSameNode(p)?l=void 0:l.contains(p)&&l.contains(n)&&(l=n)),i&&p.getAttribute("data-type")==="NodeHeading"&&p.getAttribute("fold")==="1"&&(p.removeAttribute("fold"),c.push({id:v,parentID:h}));let E,S;if(i?(E=Lute.NewNodeID(),r.push({action:"delete",id:E})):r.push({action:"move",id:v,previousID:(m=p.previousElementSibling)==null?void 0:m.getAttribute("data-node-id"),parentID:h}),!a&&!i){const L=e.wysiwyg.element.querySelector(`[data-node-id="${v}"]`);L&&L.remove()}i?(S=p.cloneNode(!0),S.setAttribute("data-node-id",E),S.querySelectorAll("[data-node-id]").forEach(L=>{const k=Lute.NewNodeID();L.setAttribute("data-node-id",k),L.setAttribute("updated",k.split("-")[0])}),u.insertAdjacentElement(s,S),o.push({action:"insert",id:E,data:S.outerHTML,previousID:s==="afterend"?d:(b=S.previousElementSibling)==null?void 0:b.getAttribute("data-node-id"),parentID:((y=S.parentElement)==null?void 0:y.getAttribute("data-node-id"))||e.block.parentID||e.block.rootID})):(u.insertAdjacentElement(s,p),o.push({action:"move",id:v,previousID:s==="afterend"?d:(_=p.previousElementSibling)==null?void 0:_.getAttribute("data-node-id"),parentID:((w=p.parentElement)==null?void 0:w.getAttribute("data-node-id"))||e.block.parentID||e.block.rootID})),s!=="afterend"&&(u=i?S:p)}),r.reverse();for(let p=0;p<c.length;p++){const g=c[p];(yield Ye("/api/block/getHeadingChildrenIDs",{id:g.id})).data.reverse().forEach(b=>{r.push({action:"move",id:b,previousID:g.id,parentID:g.parentID})}),r.push({action:"foldHeading",id:g.id,data:"remove"}),o.push({action:"unfoldHeading",id:g.id})}return{doOperations:o,undoOperations:r,topSourceElement:l}}),od=(e,t,n,a,s,i)=>Ds(void 0,null,function*(){var l,o,r,c,d,u;const p=e.element.contains(t[0]);let g;t[0].getAttribute("data-type")==="NodeListItem"&&n.getAttribute("data-type")!=="NodeListItem"&&(g=document.createElement("div"),g.setAttribute("data-node-id",Lute.NewNodeID()),g.setAttribute("data-type","NodeList"),g.setAttribute("data-subtype",t[0].getAttribute("data-subtype")),g.className="list",g.insertAdjacentHTML("beforeend",`<div class="protyle-attr" contenteditable="false">${f.ZWSP}</div>`));const m=[{action:"move",id:n.getAttribute("data-node-id"),previousID:(l=n.previousElementSibling)==null?void 0:l.getAttribute("data-node-id"),parentID:((o=n.parentElement)==null?void 0:o.getAttribute("data-node-id"))||e.block.parentID||e.block.rootID}];let b,y=t[0].parentElement;const _=tc(s);n.parentElement.replaceChild(_,n);const w=[{action:"insert",data:_.outerHTML,id:_.getAttribute("data-node-id"),nextID:(r=_.nextElementSibling)==null?void 0:r.getAttribute("data-node-id"),previousID:(c=_.previousElementSibling)==null?void 0:c.getAttribute("data-node-id"),parentID:_.parentElement.getAttribute("data-node-id")||e.block.parentID||e.block.rootID}];let v=!1;if(g){const h=g.getAttribute("data-node-id");_.insertAdjacentElement("afterbegin",n),w.push({action:"move",id:n.getAttribute("data-node-id"),parentID:_.getAttribute("data-node-id")}),a?(n.insertAdjacentElement("afterend",g),w.push({action:"insert",data:g.outerHTML,id:h,previousID:n.getAttribute("data-node-id")})):(n.insertAdjacentElement("beforebegin",g),w.push({action:"insert",data:g.outerHTML,id:h,nextID:n.getAttribute("data-node-id")})),t.reverse().forEach((E,S)=>{var L;S===t.length-1&&(b=Ne(E),b.isSameNode(E)&&(b=void 0));const k=Lute.NewNodeID();if(i?m.push({action:"delete",id:k}):m.push({action:"move",id:E.getAttribute("data-node-id"),previousID:(L=E.previousElementSibling)==null?void 0:L.getAttribute("data-node-id"),parentID:E.parentElement.getAttribute("data-node-id")||e.block.rootID}),!p&&!i){const x=e.wysiwyg.element.querySelector(`[data-node-id="${E.getAttribute("data-node-id")}"]`);x&&x.remove()}if(i){const x=E.cloneNode(!0);x.setAttribute("data-node-id",k),x.querySelectorAll("[data-node-id]").forEach(C=>{const T=Lute.NewNodeID();C.setAttribute("data-node-id",T),C.setAttribute("updated",T.split("-")[0])}),g.insertAdjacentElement("afterbegin",x),w.push({action:"insert",id:k,data:x.outerHTML,parentID:h})}else g.insertAdjacentElement("afterbegin",E),w.push({action:"move",id:E.getAttribute("data-node-id"),parentID:h})}),m.reverse(),m.push({action:"delete",id:h})}else{const h=[];let E;t.reverse().forEach((S,L)=>{var k;const x=S.getAttribute("data-node-id"),C=S.parentElement.getAttribute("data-node-id")||e.block.rootID;L===t.length-1&&(b=Ne(S),b.isSameNode(S)&&(b=void 0));const T=Lute.NewNodeID();if(L===0&&(E=i?T:x),S.getAttribute("data-type")==="NodeHeading"&&S.getAttribute("fold")==="1"&&(i&&(S.removeAttribute("fold"),h.push({id:x,parentID:C})),v=!0),i?m.push({action:"delete",id:T}):m.push({action:"move",id:x,previousID:(k=S.previousElementSibling)==null?void 0:k.getAttribute("data-node-id"),parentID:C}),!p&&!i){const I=e.wysiwyg.element.querySelector(`[data-node-id="${x}"]`);I&&I.remove()}if(i){const I=S.cloneNode(!0);I.setAttribute("data-node-id",T),I.querySelectorAll("[data-node-id]").forEach(P=>{const N=Lute.NewNodeID();P.setAttribute("data-node-id",N),P.setAttribute("updated",N.split("-")[0])}),_.insertAdjacentElement("afterbegin",I),w.push({action:"insert",id:T,data:I.outerHTML,parentID:_.getAttribute("data-node-id")})}else _.insertAdjacentElement("afterbegin",S),w.push({action:"move",id:x,parentID:_.getAttribute("data-node-id")})}),m.reverse();for(let S=0;S<h.length;S++){const L=h[S],k=yield Ye("/api/block/getHeadingChildrenIDs",{id:L.id});k.data.reverse().forEach(x=>{m.push({action:"move",id:x,previousID:L.id,parentID:L.parentID})}),S===0&&(E=k.data[0]),m.push({action:"foldHeading",id:L.id,data:"remove"}),w.push({action:"unfoldHeading",id:L.id})}a?(_.insertAdjacentElement("afterbegin",n),w.push({action:"move",id:n.getAttribute("data-node-id"),parentID:_.getAttribute("data-node-id")})):(_.lastElementChild.insertAdjacentElement("beforebegin",n),w.push({action:"move",id:n.getAttribute("data-node-id"),previousID:E}))}if(m.push({action:"delete",id:_.getAttribute("data-node-id")}),!i&&y&&y.classList.contains("list")&&y.getAttribute("data-subtype")==="o"&&!y.isSameNode(t[0].parentElement)&&y.childElementCount>1&&(Array.from(y.children).forEach(h=>{h.classList.contains("protyle-attr")||m.splice(0,0,{action:"update",id:h.getAttribute("data-node-id"),data:h.outerHTML})}),je(y,1),Array.from(y.children).forEach(h=>{h.classList.contains("protyle-attr")||w.push({action:"update",id:h.getAttribute("data-node-id"),data:h.outerHTML})})),!i&&b){if(w.push({action:"delete",id:b.getAttribute("data-node-id")}),m.splice(0,0,{action:"insert",data:b.outerHTML,id:b.getAttribute("data-node-id"),previousID:(d=b.previousElementSibling)==null?void 0:d.getAttribute("data-node-id"),parentID:((u=b.parentElement)==null?void 0:u.getAttribute("data-node-id"))||e.block.parentID||e.block.rootID}),!p){const h=e.wysiwyg.element.querySelector(`[data-node-id="${b.getAttribute("data-node-id")}"]`);h&&h.remove()}y=b.parentElement,b.remove()}if(!i&&y&&y.classList.contains("sb")&&y.childElementCount===2){if(p){const h=sa(e,y);w.push(h.doOperations[0],h.doOperations[1]),m.splice(0,0,h.undoOperations[0],h.undoOperations[1])}}else!i&&y&&y.classList.contains("protyle-wysiwyg")&&y.innerHTML;p||i?q(e,w,m):q(e,w),!i&&s==="col"&&(n.getAttribute("data-type")==="NodeHeading"&&n.getAttribute("fold")==="1"&&Kt({protyle:e,selectsElement:[n],type:"BlocksMergeSuperBlock",level:"row"}),(t.length>1||v)&&Kt({protyle:e,selectsElement:t.reverse(),type:"BlocksMergeSuperBlock",level:"row"})),ne(t[0])}),rd=(e,t,n,a,s)=>Ds(void 0,null,function*(){var i,l;const o=e.element.contains(t[0]),r=[],c=[];let d;t[0].getAttribute("data-type")==="NodeListItem"&&n.getAttribute("data-type")!=="NodeListItem"&&(d=document.createElement("div"),d.setAttribute("data-node-id",Lute.NewNodeID()),d.setAttribute("data-type","NodeList"),d.setAttribute("data-subtype",t[0].getAttribute("data-subtype")),d.className="list",d.insertAdjacentHTML("beforeend",`<div class="protyle-attr" contenteditable="false">${f.ZWSP}</div>`));let u,p=t[0].parentElement;if(a)if(d){const m=sd(e,t,n,d,o,a,s);r.push(...m.doOperations),c.push(...m.undoOperations),u=m.topSourceElement}else{const m=yield ld(e,t,n,o,"afterend",s);r.push(...m.doOperations),c.push(...m.undoOperations),u=m.topSourceElement}else if(d){const m=sd(e,t,n,d,o,a,s);r.push(...m.doOperations),c.push(...m.undoOperations),u=m.topSourceElement}else{const m=yield ld(e,t,n,o,"beforebegin",s);r.push(...m.doOperations),c.push(...m.undoOperations),u=m.topSourceElement}if(n.getAttribute("data-type")==="NodeListItem"&&n.getAttribute("data-subtype")==="o"&&(Array.from(n.parentElement.children).forEach(m=>{m.classList.contains("protyle-attr")||c.splice(0,0,{action:"update",id:m.getAttribute("data-node-id"),data:m.outerHTML})}),je(n.parentElement,1),Array.from(n.parentElement.children).forEach(m=>{m.classList.contains("protyle-attr")||r.push({action:"update",id:m.getAttribute("data-node-id"),data:m.outerHTML})})),!s&&o&&p&&p.classList.contains("list")&&p.getAttribute("data-subtype")==="o"&&!p.isSameNode(t[0].parentElement)&&p.childElementCount>1&&(Array.from(p.children).forEach(m=>{m.classList.contains("protyle-attr")||(p.contains(n)?c.splice(0,0,{action:"update",id:m.getAttribute("data-node-id"),data:m.outerHTML}):c.splice(n.parentElement.childElementCount-1,0,{action:"update",id:m.getAttribute("data-node-id"),data:m.outerHTML}))}),je(p,1),Array.from(p.children).forEach(m=>{m.classList.contains("protyle-attr")||r.push({action:"update",id:m.getAttribute("data-node-id"),data:m.outerHTML})})),!s&&u&&(r.push({action:"delete",id:u.getAttribute("data-node-id")}),c.splice(0,0,{action:"insert",data:u.outerHTML,id:u.getAttribute("data-node-id"),previousID:(i=u.previousElementSibling)==null?void 0:i.getAttribute("data-node-id"),parentID:((l=u.parentElement)==null?void 0:l.getAttribute("data-node-id"))||e.block.parentID||e.block.rootID}),p=u.parentElement,u.remove(),!o)){const m=e.wysiwyg.element.querySelector(`[data-node-id="${u.getAttribute("data-node-id")}"]`);m&&m.remove()}if(!s&&p&&p.classList.contains("sb")&&p.childElementCount===2){if(o){const m=sa(e,p);r.push(m.doOperations[0],m.doOperations[1]),c.splice(0,0,m.undoOperations[0],m.undoOperations[1])}}else!s&&p&&p.classList.contains("protyle-wysiwyg")&&p.childElementCount;o||s?q(e,r,c):q(e,r);let g=!1;t.find(m=>{if(m.getAttribute("data-type")==="NodeHeading"&&m.getAttribute("fold")==="1")return g=!0,!0}),!s&&(t.length>1||g)&&t[0].parentElement.classList.contains("sb")&&t[0].parentElement.getAttribute("data-sb-layout")==="col"&&Kt({protyle:e,selectsElement:t.reverse(),type:"BlocksMergeSuperBlock",level:"row"}),ne(t[0])}),Ig=(e,t)=>{t.addEventListener("dragstart",i=>{const l=i.target;if(l.tagName==="IMG"){window.siyuan.dragElement=void 0,i.preventDefault();return}if(l.classList){if($(l,"protyle-wysiwyg__embed"))window.siyuan.dragElement=void 0,i.preventDefault();else if(l.classList.contains("protyle-action")){l.parentElement.classList.add("protyle-wysiwyg--select");const o=document.createElement("div");o.className=e.wysiwyg.element.className,o.append(Hn(l.parentElement.cloneNode(!0))),o.setAttribute("style",`position:fixed;opacity:.1;width:${l.parentElement.clientWidth}px;padding:0;`),document.body.append(o),i.dataTransfer.setDragImage(o,0,0),setTimeout(()=>{o.remove()}),window.siyuan.dragElement=e.wysiwyg.element,i.dataTransfer.setData(`${f.SIYUAN_DROP_GUTTER}NodeListItem${f.ZWSP}${l.parentElement.getAttribute("data-subtype")}${f.ZWSP}${[l.parentElement.getAttribute("data-node-id")]}`,e.wysiwyg.element.innerHTML);return}else if(l.classList.contains("av__cell--header")){window.siyuan.dragElement=l,i.dataTransfer.setData(`${f.SIYUAN_DROP_GUTTER}NodeAttributeView${f.ZWSP}Col${f.ZWSP}${[l.getAttribute("data-col-id")]}`,l.outerHTML);return}}i.dataTransfer.setData(f.SIYUAN_DROP_EDITOR,f.SIYUAN_DROP_EDITOR),e.element.style.userSelect="auto",document.onmousemove=null,document.onmouseup=null}),t.addEventListener("drop",i=>Ds(void 0,null,function*(){var l,o,r,c,d;if(s=0,e.disabled||i.dataTransfer.getData(f.SIYUAN_DROP_EDITOR)){i.preventDefault(),i.stopPropagation();return}let u="";for(const g of i.dataTransfer.items)g.type.startsWith(f.SIYUAN_DROP_GUTTER)&&(u=g.type);const p=t.querySelector(".dragover__left, .dragover__right, .dragover__bottom, .dragover__top");if(p&&(p.classList.remove("dragover"),p.removeAttribute("select-start"),p.removeAttribute("select-end")),u){const g=[],m=u.replace(f.SIYUAN_DROP_GUTTER,"").split(f.ZWSP),b=m[2].split(",");if(i.altKey||i.shiftKey)if(i.y>e.wysiwyg.element.lastElementChild.getBoundingClientRect().bottom)Rt(e,"afterend",e.wysiwyg.element.lastElementChild.getAttribute("data-node-id"));else{const y=Qs(i.clientX,i.clientY);if(D(y.startContainer,"data-type","NodeBlockQueryEmbed"))return;X(y)}if(i.altKey){let y="";for(let _=0;_<b.length;_++){const w=yield Ye("/api/block/getRefText",{id:b[_]});y+=e.lute.Md2BlockDOM(`((${b[_]} '${w.data}'))`)}Xe(y,e)}else if(i.shiftKey){let y="";b.forEach(_=>{y+=`{{select * from blocks where id='${_}'}}
`}),Xe(e.lute.SpinBlockDOM(y),e,!0),Se(e,e.wysiwyg.element)}else if(p&&p.className.indexOf("dragover__")>-1){let y="";if(b.forEach(h=>{y+=`[data-node-id="${h}"],`}),window.siyuan.dragElement)window.siyuan.dragElement.querySelectorAll(y.substring(0,y.length-1)).forEach(h=>{re(h)||g.push(h)});else if(window.siyuan.config.system.workspaceDir.toLowerCase()===m[3]){const h=document.createElement("template");h.innerHTML=`<div>${i.dataTransfer.getData(u)}</div>`,h.content.querySelectorAll(y.substring(0,y.length-1)).forEach(E=>{re(E)||g.push(E)})}const _=[],w=[];g.forEach(h=>{h.classList.remove("protyle-wysiwyg--hl"),h.removeAttribute("select-start"),h.removeAttribute("select-end"),h.querySelectorAll('[data-type="search-mark"]').forEach(S=>{S.outerHTML=S.innerHTML});const E=h.getAttribute("data-node-id");_.push(E),w.push({id:E,isDetached:!1})}),J(["gutter"],e);const v=p.className.split(" ");if(p.classList.remove("dragover__bottom","dragover__top","dragover__left","dragover__right"),p.classList.contains("av__cell")){const h=B(p);if(h){const E=h.getAttribute("data-av-id");let S="";v.includes("dragover__left")?p.previousElementSibling&&(p.previousElementSibling.classList.contains("av__colsticky")?S=p.previousElementSibling.lastElementChild.getAttribute("data-col-id"):S=p.previousElementSibling.getAttribute("data-col-id")):S=p.getAttribute("data-col-id");let L="";const k=$(p,"av__row");if(k){const x=(l=k.querySelector(`[data-col-id="${m[2]}"`))==null?void 0:l.previousElementSibling;x&&(x.classList.contains("av__colsticky")?L=x.lastElementChild.getAttribute("data-col-id"):L=x.getAttribute("data-col-id"))}S!==L&&S!==m[2]&&q(e,[{action:"sortAttrViewCol",avID:E,previousID:S,id:m[2],blockID:h.dataset.nodeId}],[{action:"sortAttrViewCol",avID:E,previousID:L,id:m[2],blockID:h.dataset.nodeId}])}}else if(p.classList.contains("av__row")){const h=B(p);if(h){let E="";v.includes("dragover__bottom")?E=p.getAttribute("data-id")||"":E=((o=p.previousElementSibling)==null?void 0:o.getAttribute("data-id"))||"";const S=h.getAttribute("data-av-id");if(m[0]==="nodeattributeviewrowmenu"){const L=[],k=[],x=h.querySelector(`.av__row[data-id="${b[0]}"]`).previousElementSibling.getAttribute("data-id")||"";b.reverse().forEach(C=>{E!==C&&x!==E&&(L.push({action:"sortAttrViewRow",avID:S,previousID:E,id:C,blockID:h.dataset.nodeId}),k.push({action:"sortAttrViewRow",avID:S,previousID:x,id:C,blockID:h.dataset.nodeId}))}),q(e,L,k)}else{const L=U().format("YYYYMMDDHHmmss");q(e,[{action:"insertAttrViewBlock",avID:S,previousID:E,srcs:w,blockID:h.dataset.nodeId},{action:"doUpdateUpdated",id:h.dataset.nodeId,data:L}],[{action:"removeAttrViewBlock",srcIDs:_,avID:S},{action:"doUpdateUpdated",id:h.dataset.nodeId,data:h.getAttribute("updated")}]),h.setAttribute("updated",L),Ss(e,h,_,E)}}}else g.length>0&&(p.parentElement.getAttribute("data-type")==="NodeSuperBlock"&&p.parentElement.getAttribute("data-sb-layout")==="col"?v.includes("dragover__left")||v.includes("dragover__right")?rd(e,g,p,v.includes("dragover__right"),i.ctrlKey):od(e,g,p,v.includes("dragover__bottom"),"row",i.ctrlKey):v.includes("dragover__left")||v.includes("dragover__right")?od(e,g,p,v.includes("dragover__right"),"col",i.ctrlKey):rd(e,g,p,v.includes("dragover__bottom"),i.ctrlKey),t.querySelectorAll(".protyle-wysiwyg--empty").forEach(h=>{h.classList.remove("protyle-wysiwyg--empty")}),g.forEach(h=>{h.getAttribute("data-type")==="NodeBlockQueryEmbed"&&(h.removeAttribute("data-render"),Se(e,h))}),p.getAttribute("data-type")==="NodeBlockQueryEmbed"&&(p.removeAttribute("data-render"),Se(e,p)));n=void 0}}else if(((r=i.dataTransfer.getData(f.SIYUAN_DROP_FILE))==null?void 0:r.split("-").length)>1){const g=i.dataTransfer.getData(f.SIYUAN_DROP_FILE).split(",");if(!i.altKey&&(!p||!p.classList.contains("av__row"))){if(i.y>e.wysiwyg.element.lastElementChild.getBoundingClientRect().bottom)Rt(e,"afterend",e.wysiwyg.element.lastElementChild.getAttribute("data-node-id"));else{const b=Qs(i.clientX,i.clientY);if(D(b.startContainer,"data-type","NodeBlockQueryEmbed"))return;X(b)}let m="";for(let b=0;b<g.length;b++){g.length>1&&(m+="* ");const y=yield Ye("/api/block/getRefText",{id:g[b]});m+=`((${g[b]} '${y.data}'))`,g.length>1&&b!==g.length-1&&(m+=`
`)}Xe(e.lute.Md2BlockDOM(m),e)}else if(p&&!e.options.backlinkData&&p.className.indexOf("dragover__")>-1){const m=e.contentElement.scrollTop;if(p.classList.contains("av__row")){const b=B(p);if(b){let y="";p.classList.contains("dragover__bottom")?y=p.getAttribute("data-id")||"":y=((c=p.previousElementSibling)==null?void 0:c.getAttribute("data-id"))||"";const _=b.getAttribute("data-av-id"),w=U().format("YYYYMMDDHHmmss"),v=[];g.forEach(h=>{v.push({id:h,isDetached:!1})}),q(e,[{action:"insertAttrViewBlock",avID:_,previousID:y,srcs:v,blockID:b.dataset.nodeId},{action:"doUpdateUpdated",id:b.dataset.nodeId,data:w}],[{action:"removeAttrViewBlock",srcIDs:g,avID:_},{action:"doUpdateUpdated",id:b.dataset.nodeId,data:b.getAttribute("updated")}]),Ss(e,b,g,y),b.setAttribute("updated",w)}}else{if(p.classList.contains("dragover__bottom"))for(let b=g.length-1;b>-1;b--)g[b]&&(yield Ye("/api/filetree/doc2Heading",{srcID:g[b],after:!0,targetID:p.getAttribute("data-node-id")}));else for(let b=0;b<g.length;b++)g[b]&&(yield Ye("/api/filetree/doc2Heading",{srcID:g[b],after:!1,targetID:p.getAttribute("data-node-id")}));A("/api/filetree/getDoc",{id:e.block.id,size:window.siyuan.config.editor.dynamicLoadBlocks},b=>{Qe({data:b,protyle:e}),setTimeout(()=>{e.contentElement.scrollTop=m,e.scroll.lastScrollTop=m-1},f.TIMEOUT_LOAD)})}p.classList.remove("dragover__bottom","dragover__top","dragover__left","dragover__right")}}else if(!window.siyuan.dragElement&&(i.dataTransfer.types[0]==="Files"||i.dataTransfer.types.includes("text/html"))){const g=$(i.target,"av");if(g){const m=$(i.target,"av__cell");if(m&&((d=g.querySelector(`.av__row--header [data-col-id="${m.dataset.colId}"]`))==null?void 0:d.getAttribute("data-dtype"))==="mAsset"&&i.dataTransfer.types[0]==="Files"&&!qe()){const y=[];for(let _=0;_<i.dataTransfer.files.length;_++)y.push(webUtils.getPathForFile(i.dataTransfer.files[_]));oc(y,e,m)}}else{if(X(Qs(i.clientX,i.clientY)),i.dataTransfer.types[0]==="Files"&&!qe()){const m=[];for(let b=0;b<i.dataTransfer.files.length;b++)m.push(webUtils.getPathForFile(i.dataTransfer.files[b]));ic(m,e,!i.altKey)}else qi(e,i);e.wysiwyg.element.querySelectorAll(".av__cell--select, .av__cell--active").forEach(m=>{var b;m.classList.remove("av__cell--select","av__cell--active"),(b=m.querySelector(".av__drag-fill"))==null||b.remove()})}}window.siyuan.dragElement&&(window.siyuan.dragElement.style.opacity="",window.siyuan.dragElement=void 0)}));let n,a;t.addEventListener("dragover",i=>{var l,o,r;if(e.disabled||i.dataTransfer.types.includes(f.SIYUAN_DROP_EDITOR)){i.preventDefault(),i.stopPropagation(),i.dataTransfer.dropEffect="none";return}const c=e.contentElement.getBoundingClientRect();!$(i.target,"av__cell")&&(i.clientY<c.top+f.SIZE_SCROLL_TB||i.clientY>c.bottom-f.SIZE_SCROLL_TB)&&e.contentElement.scroll({top:e.contentElement.scrollTop+(i.clientY<c.top+f.SIZE_SCROLL_TB?-f.SIZE_SCROLL_STEP:f.SIZE_SCROLL_STEP),behavior:"smooth"});let d;if(i.dataTransfer.types.includes("Files")){if(d=$(i.target,"av__cell"),d&&d.getAttribute("data-dtype")==="mAsset"&&!d.classList.contains("av__cell--header")){if(i.preventDefault(),n&&d.isSameNode(n))return;B(d)&&(e.wysiwyg.element.querySelectorAll(".av__cell--select, .av__cell--active").forEach(b=>{var y;b.classList.remove("av__cell--select","av__cell--active"),(y=b.querySelector(".av__drag-fill"))==null||y.remove()}),d.classList.add("av__cell--select"),Gt(d),n=d)}return}let u="";for(const m of i.dataTransfer.items)m.type.startsWith(f.SIYUAN_DROP_GUTTER)&&(u=m.type);if(!u&&!window.siyuan.dragElement){i.preventDefault();return}const p=i.dataTransfer.types.includes(f.SIYUAN_DROP_FILE)&&window.siyuan.dragElement?window.siyuan.dragElement.innerText:"";if(i.shiftKey||i.altKey&&p.indexOf("-")===-1){const m=B(i.target);m?(m.classList.remove("dragover__top","protyle-wysiwyg--select","dragover__bottom","dragover__left","dragover__right"),m.removeAttribute("select-start"),m.removeAttribute("select-end")):t.querySelectorAll(".dragover__top, .protyle-wysiwyg--select, .dragover__bottom, .dragover__left, .dragover__right").forEach(b=>{b.classList.remove("dragover__top","protyle-wysiwyg--select","dragover__bottom","dragover__left","dragover__right"),b.removeAttribute("select-start"),b.removeAttribute("select-end")}),i.preventDefault();return}i.preventDefault(),d=$(i.target,"av__row")||$(i.target,"av__row--util")||B(i.target);const g={x:i.clientX,y:i.clientY,className:""};if(d&&(d.classList.contains("bq")||d.classList.contains("sb")||d.classList.contains("list")||d.classList.contains("li"))){let m=B(document.elementFromPoint(g.x,g.y-6));for(;m&&d.contains(m);)(l=m.nextElementSibling)!=null&&l.getAttribute("data-node-id")&&(d=m),m=m.parentElement}if(d)d&&d.classList.contains("list")&&(u&&u.replace(f.SIYUAN_DROP_GUTTER,"").split(f.ZWSP)[0]!=="nodelistitem"?d=B(document.elementFromPoint(i.clientX,i.clientY-6)):d=$(document.elementFromPoint(i.clientX,i.clientY-6),"li"));else if(i.clientY>t.lastElementChild.getBoundingClientRect().bottom)d=t.lastElementChild,g.className="dragover__bottom";else if(i.clientY<t.firstElementChild.getBoundingClientRect().top)d=t.firstElementChild,g.className="dragover__top";else if(c){const m={left:c.left+parseInt(t.style.paddingLeft),right:c.left+e.contentElement.clientWidth-parseInt(t.style.paddingRight)};i.clientX<m.left?(g.x=m.left,g.className="dragover__left"):i.clientX>=m.right&&(g.x=m.right-6,g.className="dragover__right"),d=document.elementFromPoint(g.x,g.y),d.classList.contains("protyle-wysiwyg")&&(d=document.elementFromPoint(g.x,g.y-6)),d=F(d,"data-node-id",null)}if(u&&u.startsWith(`${f.SIYUAN_DROP_GUTTER}NodeAttributeView${f.ZWSP}Col${f.ZWSP}`.toLowerCase())){if(d=$(i.target,"av__cell"),d){const m=$(d,"av__row--header"),b=$(window.siyuan.dragElement,"av__row--header");(d.isSameNode(window.siyuan.dragElement)||!m||!b||m&&b&&!m.isSameNode(b))&&(d=!1)}}else d&&u&&u.startsWith(`${f.SIYUAN_DROP_GUTTER}NodeAttributeViewRowMenu${f.ZWSP}`.toLowerCase())&&(!d.classList.contains("av__row")&&!d.classList.contains("av__row--util")||window.siyuan.dragElement&&!window.siyuan.dragElement.contains(d))&&(d=!1);if(d){if(d&&n&&d.isSameNode(n)){const m=d.getBoundingClientRect();if(t.querySelectorAll(".dragover__left, .dragover__right, .dragover__bottom, .dragover__top, .dragover").forEach(b=>{b.classList.remove("dragover__top","dragover__bottom","dragover__left","dragover__right","dragover"),b.removeAttribute("select-start"),b.removeAttribute("select-end")}),p.indexOf("-")>-1&&!d.classList.contains("av__row")&&!d.classList.contains("av__row--util"))if(i.altKey){if(p.split(",").includes(e.block.rootID)&&i.altKey)return}else return;if(d.getAttribute("data-type")==="NodeAttributeView"&&O(i.target,"TD"))return;if(g.className){d.classList.add(g.className),Ma(d);return}if(d.getAttribute("data-type")==="NodeListItem"){i.clientY>m.top+m.height/2?(d.classList.add("dragover__bottom"),Ma(d)):d.classList.contains("av__row--header")||(d.classList.add("dragover__top"),Ma(d));return}if(d.classList.contains("av__cell")){i.clientX<m.left+m.width/2&&i.clientX>m.left&&!d.classList.contains("av__row")&&!d.previousElementSibling.isSameNode(window.siyuan.dragElement)?d.classList.add("dragover__left"):i.clientX>m.right-m.width/2&&i.clientX<=m.right+1&&!d.classList.contains("av__row")&&!d.isSameNode(window.siyuan.dragElement.previousElementSibling)&&(window.siyuan.dragElement.previousElementSibling.classList.contains("av__colsticky")&&d.isSameNode(window.siyuan.dragElement.previousElementSibling.lastElementChild)||d.classList.add("dragover__right"));return}i.clientX<m.left+32&&i.clientX>=m.left-1&&!d.classList.contains("av__row")?(d.classList.add("dragover__left"),Ma(d)):i.clientX>m.right-32&&i.clientX<m.right&&!d.classList.contains("av__row")?(d.classList.add("dragover__right"),Ma(d)):d.classList.contains("av__row--header")?d.classList.add("dragover__bottom"):d.classList.contains("av__row--util")?d.previousElementSibling.classList.add("dragover__bottom"):i.clientY>m.top+m.height/2&&a!=="bottom"?(d.classList.add("dragover__bottom"),Ma(d)):a!=="top"&&(d.classList.add("dragover__top"),Ma(d));return}if(p.indexOf("-")>-1){p.split(",").includes(e.block.rootID)&&!d.classList.contains("av__row")&&!d.classList.contains("av__row--util")&&i.altKey?(n=void 0,t.querySelectorAll(".dragover__left, .dragover__right, .dragover__bottom, .dragover__top, .dragover").forEach(m=>{m.classList.remove("dragover__top","dragover__bottom","dragover__left","dragover__right","dragover"),m.removeAttribute("select-start"),m.removeAttribute("select-end")})):n=d;return}if(u){a="",n&&(n.classList.remove("dragover__top","dragover__bottom","dragover__left","dragover__right","dragover"),n=void 0);const m=u.replace(f.SIYUAN_DROP_GUTTER,"").split(f.ZWSP);if(m[0]==="nodeattributeview"&&m[1]==="col"&&d.getAttribute("data-id")===m[2]||m[0]==="nodeattributeviewrowmenu"&&m[2]===d.getAttribute("data-id")||m[2].split(",").find(y=>{if(y&&D(d,"data-node-id",y))return!0})&&m[0]!=="nodeattributeviewrowmenu"||re(d)||m[0]==="nodelistitem"&&m[1]!==d.getAttribute("data-subtype")&&d.getAttribute("data-type")==="NodeListItem"||m[0]!=="nodelistitem"&&d.getAttribute("data-type")==="NodeListItem")return;m[0]==="nodelistitem"&&d.parentElement.classList.contains("li")&&((o=d.previousElementSibling)!=null&&o.classList.contains("protyle-action"))&&(a="top"),m[0]==="nodelistitem"&&((r=d.nextElementSibling)!=null&&r.classList.contains("list"))&&(a="bottom"),d&&d.classList.contains("av__row--header")&&(a="top"),n=d}}});let s=0;t.addEventListener("dragleave",i=>{if(e.disabled){i.preventDefault(),i.stopPropagation();return}s--,s===0&&(t.querySelectorAll(".dragover__left, .dragover__right, .dragover__bottom, .dragover__top, .dragover").forEach(l=>{l.classList.remove("dragover__top","dragover__bottom","dragover__left","dragover__right","dragover")}),n=void 0)}),t.addEventListener("dragenter",i=>{i.preventDefault(),s++})},Ma=e=>{(e.classList.contains("sb")||e.classList.contains("li")||e.classList.contains("list")||e.classList.contains("bq"))&&e.classList.add("dragover")},Dg=(e,t,n)=>{var a,s,i,l;if(!t.classList.contains("av")||!window.siyuan.menus.menu.element.classList.contains("fn__none"))return!1;if(e.isComposing)return!0;if(te("\u2318B",e)||te("\u2318I",e)||te("\u2318U",e))return e.preventDefault(),!0;const o=t.querySelector(".av__cell--select");if(o){const c=$(o,"av__row");if(!c)return!1;const d=document.querySelector(".av__panel");if(d&&(e.key==="Backspace"||e.key==="Delete"||e.key==="Escape"||e.key.startsWith("ArrowLeft")||e.key==="Enter"||te("\u21E5",e)||te("\u21E7\u21E5",e)))return d.remove(),e.preventDefault(),e.stopPropagation(),!0;if(e.key==="Backspace"||e.key==="Delete")return zt(n,t,void 0,Array.from(t.querySelectorAll(".av__cell--active, .av__cell--select"))),e.preventDefault(),!0;if(e.key==="Escape")return t.querySelectorAll(".av__cell--select, .av__cell--active").forEach(p=>{var g;p.classList.remove("av__cell--select","av__cell--active"),(g=p.querySelector(".av__drag-fill"))==null||g.remove()}),An(c.querySelector(".av__firstcol"),"select"),e.preventDefault(),!0;if(e.key==="Enter")return rn(n,[o]),e.preventDefault(),!0;let u;if(e.key==="ArrowLeft"||te("\u21E7\u21E5",e)){const p=c.previousElementSibling;if(o.previousElementSibling&&!o.previousElementSibling.classList.contains("av__firstcol"))o.previousElementSibling.classList.contains("av__cell")?u=o.previousElementSibling:u=o.previousElementSibling.lastElementChild;else if(p&&!p.classList.contains("av__row--header")){const g=p.querySelectorAll(".av__cell");u=g[g.length-1]}return u&&(o.classList.remove("av__cell--select","av__cell--active"),(a=o.querySelector(".av__drag-fill"))==null||a.remove(),u.classList.add("av__cell--select"),Gt(u),Qn(t,u,!1)),e.preventDefault(),!0}if(e.key==="ArrowRight"||te("\u21E5",e)){const p=c.nextElementSibling;return o.nextElementSibling&&o.nextElementSibling.classList.contains("av__cell")?u=o.nextElementSibling:!o.nextElementSibling&&o.parentElement.nextElementSibling?u=o.parentElement.nextElementSibling:p&&!p.classList.contains("av__row--footer")&&(u=p.querySelector(".av__cell")),u&&(o.classList.remove("av__cell--select","av__cell--active"),(s=o.querySelector(".av__drag-fill"))==null||s.remove(),u.classList.add("av__cell--select"),Gt(u),Qn(t,u,!1)),e.preventDefault(),!0}if(e.key==="ArrowUp"){const p=c.previousElementSibling;return p&&!p.classList.contains("av__row--header")&&(u=p.querySelector(`.av__cell[data-col-id="${o.dataset.colId}"]`)),u&&(o.classList.remove("av__cell--select","av__cell--active"),(i=o.querySelector(".av__drag-fill"))==null||i.remove(),u.classList.add("av__cell--select"),Gt(u),Qn(t,u)),e.preventDefault(),!0}if(e.key==="ArrowDown"){const p=c.nextElementSibling;return p&&!p.classList.contains("av__row--footer")&&(u=p.querySelector(`.av__cell[data-col-id="${o.dataset.colId}"]`)),u&&(o.classList.remove("av__cell--select","av__cell--active"),(l=o.querySelector(".av__drag-fill"))==null||l.remove(),u.classList.add("av__cell--select"),Gt(u),Qn(t,u)),e.preventDefault(),!0}if(!f.KEYCODELIST[e.keyCode]||f.KEYCODELIST[e.keyCode].length===1&&!e.metaKey&&!e.ctrlKey&&!["\u21E7","\u2303","\u2325","\u2318"].includes(f.KEYCODELIST[e.keyCode]))return o.style.backgroundColor?e.preventDefault():rn(n,[o]),!0}const r=t.querySelectorAll(".av__row--select:not(.av__row--header)");if(r.length>0){if(te("\u2318/",e))return e.stopPropagation(),e.preventDefault(),ls(n,r[0],{x:t.querySelector(".layout-tab-bar").getBoundingClientRect().left,y:r[0].getBoundingClientRect().bottom}),!0;if(e.key==="Escape")return e.preventDefault(),An(r[0].querySelector(".av__firstcol"),"unselectAll"),!0;if(e.key==="Backspace")return e.preventDefault(),Uc(t,n),!0;if(e.key==="Enter")return An(r[0].querySelector(".av__firstcol"),"unselectAll"),rn(n,[r[0].querySelector(".av__cell")]),e.preventDefault(),!0;if(e.key==="ArrowUp"){const c=r[0].previousElementSibling;return An(r[0].querySelector(".av__firstcol"),"unselectAll"),c&&!c.classList.contains("av__row--header")?(An(c.querySelector(".av__firstcol"),"select"),Qn(t,c)):t.classList.add("protyle-wysiwyg--select"),e.preventDefault(),!0}if(e.key==="ArrowDown"){const c=r[r.length-1].nextElementSibling;return An(r[0].querySelector(".av__firstcol"),"unselectAll"),c&&!c.classList.contains("av__row--util")?(An(c.querySelector(".av__firstcol"),"select"),Qn(t,c)):t.classList.add("protyle-wysiwyg--select"),e.preventDefault(),!0}}return!1},fo=e=>{var t;if(e.command==="switchReadonly")return Ll(e.protyle.breadcrumb.element.parentElement.querySelector('.block__icon[data-type="readonly"]'),e.protyle),!0;if(e.command==="switchAdjust"){let a;const s=e.protyle.wysiwyg.element.getAttribute(f.CUSTOM_SY_FULLWIDTH);return s?a=s==="true"?"false":"true":a=window.siyuan.config.editor.fullWidth?"false":"true",A("/api/attr/setBlockAttrs",{id:e.protyle.block.rootID,attrs:{[f.CUSTOM_SY_FULLWIDTH]:a}}),!0}const n=B(e.previousRange.startContainer);if(!n)return!1;if(e.command==="enter"){let a=Ne(n);a.parentElement.classList.contains("li")&&a.parentElement.parentElement.classList.contains("list")&&((t=a.nextElementSibling)!=null&&t.classList.contains("list"))&&a.previousElementSibling.classList.contains("protyle-action")&&(a=a.parentElement);const s=a.getAttribute("data-node-id");return e.protyle.options.backlinkData||Ot({protyle:e.protyle,id:s}),!0}return e.command==="enterBack"?(Dl(e.protyle,n.getAttribute("data-node-id")),!0):!1},cd=(e,t)=>{let n="";Array.from(e.cloneContents().childNodes).forEach(a=>{a.nodeType===3?n+=a.textContent:n+=a.outerHTML}),A("/api/block/getDOMText",{dom:n},a=>{t(a.data)})},Mg=(e,t)=>{t.addEventListener("keydown",n=>{var a,s,i,l,o,r;if(n.target.localName==="protyle-html"||n.target.localName==="input"){n.stopPropagation();return}if(e.disabled||!e.selectElement.classList.contains("fn__none")){n.stopPropagation(),n.preventDefault();return}e.wysiwyg.preventKeyup=!1,J(["util"],e),n.shiftKey&&n.key.indexOf("Arrow")>-1||!n.repeat&&n.code!==""&&J(["toolbar"],e);const c=ye(e.wysiwyg.element),d=B(c.startContainer);if(!d)return;const u=B(c.endContainer);if(!te("\u2318C",n)&&u&&!d.isSameNode(u)){n.stopPropagation(),n.preventDefault();return}if(Dg(n,d,e))return;if(d.classList.contains("protyle-wysiwyg--select")&&Ue(n)&&!n.shiftKey&&!n.altKey){if(n.key.toLowerCase()==="a")return n.stopPropagation(),n.preventDefault(),e.wysiwyg.element.blur(),setTimeout(()=>{Rt(e,"afterend")},100),!1;if(n.key.toLowerCase()==="b")return n.stopPropagation(),n.preventDefault(),e.wysiwyg.element.blur(),setTimeout(()=>{Rt(e,"beforebegin")},100),!1}if(n.isComposing){n.stopPropagation();return}if(["\u2318","\u21E7","\u2325","\u2303"].includes(f.KEYCODELIST[n.keyCode])||(f.KEYCODELIST[n.keyCode]==="/"||n.key==="/"||n.code==="Slash"&&n.key==="Process"&&n.keyCode===229?e.hint.enableSlash=!0:(f.KEYCODELIST[n.keyCode]==="\\"||n.key==="\\"||n.key===","&&n.keyCode===229||n.code==="Backslash"&&n.key==="Process"&&n.keyCode===229)&&(e.hint.enableSlash=!1,J(["hint"],e))),n.key!=="PageUp"&&n.key!=="PageDown"&&n.key!=="Home"&&n.key!=="End"&&n.key.indexOf("Arrow")===-1&&n.key!=="Escape"&&n.key!=="Shift"&&n.key!=="Meta"&&n.key!=="Alt"&&n.key!=="Control"&&n.key!=="CapsLock"&&!At(d)&&!/^F\d{1,2}$/.test(n.key)&&n.key!=="Process"&&(fi(d,c,e),e.wysiwyg.preventKeyup=!0),!window.siyuan.menus.menu.element.classList.contains("fn__none")&&(["\u2190","\u2191","\u2192","\u2193"].includes(f.KEYCODELIST[n.keyCode])||f.KEYCODELIST[n.keyCode]==="\u21A9")&&!n.altKey&&!n.shiftKey&&Ue(n)){n.preventDefault();return}else n.key!=="Escape"&&window.siyuan.menus.menu.remove();if(!["Alt","Meta","Shift","Control","CapsLock","Escape"].includes(n.key)&&e.options.render.breadcrumb&&e.breadcrumb.hide(),!n.altKey&&!n.shiftKey&&Ue(n)&&(n.key==="ArrowDown"||n.key==="ArrowUp")){const w=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(w.length>0){if(n.preventDefault(),n.stopPropagation(),J(["select"],e),n.key==="ArrowDown"){const v=w[w.length-1];let h=et(v);if(h)if(h.getBoundingClientRect().width===0){const S=F(h,"fold","1");S?(h=et(S),h?h=Mt(h):h=v):h=v}else h.getAttribute("fold")==="1"&&(h.classList.contains("sb")||h.classList.contains("bq"))||(h=Mt(h));else h=v;h.classList.add("protyle-wysiwyg--select"),Ht([h.getAttribute("data-node-id")]);const E=h.getBoundingClientRect().bottom-e.contentElement.getBoundingClientRect().bottom;E>0&&(e.contentElement.scrollTop=e.contentElement.scrollTop+E,e.scroll.lastScrollTop=e.contentElement.scrollTop-1),ne(h)}else if(n.key==="ArrowUp"){let v=De(w[0]);if(v){if(v=lt(v),v.getBoundingClientRect().width===0){const h=F(v,"fold","1");h?v=Mt(h):v=w[0]}else if(v){const h=F(v,"fold","1");h&&(h.classList.contains("sb")||h.classList.contains("bq"))&&(v=h)}}else if(e.title&&e.title.editElement&&(e.wysiwyg.element.firstElementChild.getAttribute("data-eof")==="1"||e.contentElement.scrollTop===0)){const h=nt(e.title.editElement,c,!1);h.collapse(!1),X(h),n.stopPropagation(),n.preventDefault()}else e.contentElement.scrollTop!==0?(e.contentElement.scrollTop=0,e.scroll.lastScrollTop=8):v=w[0];if(v){v.classList.add("protyle-wysiwyg--select"),Ht([v.getAttribute("data-node-id")]);const h=v.getBoundingClientRect().top-e.contentElement.getBoundingClientRect().top;h<0&&(e.contentElement.scrollTop=e.contentElement.scrollTop+h,e.scroll.lastScrollTop=e.contentElement.scrollTop+1),ne(v)}}return}}if(n.key!=="PageUp"&&n.key!=="PageDown"&&n.key!=="Home"&&n.key!=="End"&&n.key.indexOf("Arrow")===-1&&Ue(n)&&n.key!=="Escape"&&!n.shiftKey&&!n.altKey&&!/^F\d{1,2}$/.test(n.key)&&n.key!=="Enter"&&n.key!=="Tab"&&n.key!=="Backspace"&&n.key!=="Delete"&&n.key!=="ContextMenu")return n.stopPropagation(),J(["select"],e),!1;if(te(window.siyuan.config.keymap.editor.general.collapse.custom,n)&&!n.repeat){const w=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");return w.length>0?ht(e,w[0]):d.parentElement.getAttribute("data-type")==="NodeListItem"?d.parentElement.childElementCount>3?ht(e,d.parentElement):ht(e,d):d.getAttribute("data-type")==="NodeHeading"?ht(e,d):ht(e,Ne(d)),n.stopPropagation(),n.preventDefault(),!1}if(te(window.siyuan.config.keymap.editor.general.expand.custom,n)&&!n.repeat){const w=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");w.length>0?ht(e,w[0],!0):d.parentElement.getAttribute("data-type")==="NodeListItem"?d.parentElement.childElementCount>3?ht(e,d.parentElement,!0):ht(e,d,!0):d.getAttribute("data-type")==="NodeHeading"?ht(e,d,!0):ht(e,Ne(d),!0),n.stopPropagation(),n.preventDefault();return}if(n.shiftKey&&(n.key==="ArrowLeft"||n.key==="ArrowRight")){if(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").length>0){n.stopPropagation(),n.preventDefault();return}if(!c.toString()){if(n.key==="ArrowRight"&&ma(c)){n.preventDefault(),n.stopPropagation();return}const v=oe(d);if(Je(v,e.wysiwyg.element,c).start===0&&n.key==="ArrowLeft"){n.preventDefault(),n.stopPropagation();return}}}if(te(window.siyuan.config.keymap.editor.general.expandUp.custom,n)){Or({protyle:e,event:n,nodeElement:d,editorElement:t,range:c,cb(w){const v=w[0].previousElementSibling;if(v&&v.getAttribute("data-node-id")){v.classList.add("protyle-wysiwyg--select"),w.forEach(E=>{E.removeAttribute("select-end")}),v.setAttribute("select-end","true");const h=v.getBoundingClientRect().top-e.contentElement.getBoundingClientRect().top;h<0&&(e.contentElement.scrollTop=e.contentElement.scrollTop+h,e.scroll.lastScrollTop=e.contentElement.scrollTop+1)}else w[0].parentElement.classList.contains("protyle-wysiwyg")||(J(["select"],e),w[0].parentElement.classList.add("protyle-wysiwyg--select"))}});return}if(te(window.siyuan.config.keymap.editor.general.expandDown.custom,n)){Rr({protyle:e,event:n,nodeElement:d,editorElement:t,range:c,cb(w){const v=w[w.length-1],h=v.nextElementSibling;if(h&&h.getAttribute("data-node-id")){h.classList.add("protyle-wysiwyg--select"),w.forEach(S=>{S.removeAttribute("select-end")}),h.setAttribute("select-end","true");const E=h.getBoundingClientRect().bottom-e.contentElement.getBoundingClientRect().bottom;E>0&&(e.contentElement.scrollTop=e.contentElement.scrollTop+E,e.scroll.lastScrollTop=e.contentElement.scrollTop-1)}else v.parentElement.classList.contains("protyle-wysiwyg")||(J(["select"],e),v.parentElement.classList.add("protyle-wysiwyg--select"))}});return}if(te("\u21E7\u2191",n)){Or({protyle:e,event:n,nodeElement:d,editorElement:t,range:c,cb(w){const v=Br(w);if(v.startElement.getBoundingClientRect().top>=v.endElement.getBoundingClientRect().top){const h=v.endElement.previousElementSibling;if(h&&h.getAttribute("data-node-id")){h.classList.add("protyle-wysiwyg--select"),h.setAttribute("select-end","true"),v.endElement.removeAttribute("select-end");const E=h.getBoundingClientRect().top-e.contentElement.getBoundingClientRect().top;E<0&&(e.contentElement.scrollTop=e.contentElement.scrollTop+E,e.scroll.lastScrollTop=e.contentElement.scrollTop+1)}else v.endElement.parentElement.classList.contains("protyle-wysiwyg")||(J(["select"],e),v.endElement.parentElement.classList.add("protyle-wysiwyg--select"))}else{v.endElement.classList.remove("protyle-wysiwyg--select"),v.endElement.removeAttribute("select-end");const h=De(v.endElement);h&&(h.setAttribute("select-end","true"),h.getBoundingClientRect().top<=e.contentElement.getBoundingClientRect().top&&(en(e),h.scrollIntoView(!0)))}}});return}if(te("\u21E7\u2193",n)){Rr({protyle:e,event:n,nodeElement:d,editorElement:t,range:c,cb(w){const v=Br(w);if(v.startElement.getBoundingClientRect().top<=v.endElement.getBoundingClientRect().top){const h=v.endElement.nextElementSibling;if(h&&h.getAttribute("data-node-id"))if(h.getBoundingClientRect().width===0)J(["select"],e),v.endElement.parentElement.classList.add("protyle-wysiwyg--select");else{h.classList.add("protyle-wysiwyg--select"),h.setAttribute("select-end","true"),v.endElement.removeAttribute("select-end");const E=h.getBoundingClientRect().bottom-e.contentElement.getBoundingClientRect().bottom;E>0&&(e.contentElement.scrollTop=e.contentElement.scrollTop+E,e.scroll.lastScrollTop=e.contentElement.scrollTop-1)}else v.endElement.parentElement.classList.contains("protyle-wysiwyg")||(J(["select"],e),v.endElement.parentElement.classList.add("protyle-wysiwyg--select"))}else{v.endElement.classList.remove("protyle-wysiwyg--select"),v.endElement.removeAttribute("select-end");const h=et(v.endElement);h&&(h.setAttribute("select-end","true"),h.getBoundingClientRect().bottom>=e.contentElement.getBoundingClientRect().bottom&&(en(e),h.scrollIntoView(!1)))}}});return}if(te(window.siyuan.config.keymap.general.enter.custom,n)){fo({protyle:e,command:"enter",previousRange:c}),n.preventDefault(),n.stopPropagation();return}if(te(window.siyuan.config.keymap.general.enterBack.custom,n)){fo({protyle:e,command:"enterBack",previousRange:c}),n.preventDefault(),n.stopPropagation();return}if(n.shiftKey&&!n.altKey&&Ue(n)&&(n.key==="Home"||n.key==="End")&&Lt()||n.shiftKey&&!n.altKey&&bt(n)&&(n.key==="Home"||n.key==="End")&&!Lt()){const w=F(d,"data-node-id",null);if(w){w.querySelectorAll(".protyle-wysiwyg--select").forEach(h=>{h.classList.remove("protyle-wysiwyg--select")}),w.classList.add("protyle-wysiwyg--select");let v=n.key==="Home"?w.previousElementSibling:w.nextElementSibling;for(;v;)v.classList.add("protyle-wysiwyg--select"),v=n.key==="Home"?v.previousElementSibling:v.nextElementSibling;n.key==="Home"?e.wysiwyg.element.firstElementChild.scrollIntoView():e.wysiwyg.element.lastElementChild.scrollIntoView(!1)}n.stopPropagation(),n.preventDefault();return}if((n.key==="Home"||n.key==="End")&&!n.shiftKey&&!n.altKey&&Ue(n)&&J(["hint"],e),!n.altKey&&!n.shiftKey&&Ue(n)&&(n.key==="PageUp"||n.key==="PageDown")){n.key==="PageUp"?(e.contentElement.scrollTop=e.contentElement.scrollTop-e.contentElement.clientHeight+60,e.scroll.lastScrollTop=e.contentElement.scrollTop+1):(e.contentElement.scrollTop=e.contentElement.scrollTop+e.contentElement.clientHeight-60,e.scroll.lastScrollTop=e.contentElement.scrollTop-1);const w=e.contentElement.getBoundingClientRect();let v=document.elementFromPoint(w.x+w.width/2,w.y+w.height/2);v.classList.contains("protyle-wysiwyg")&&(v=document.elementFromPoint(w.x+w.width/2,w.y+w.height/2+f.SIZE_TOOLBAR_HEIGHT));const h=B(v);h&&!h.isSameNode(d)&&ne(h,void 0,!1),n.stopPropagation(),n.preventDefault();return}if(!n.altKey&&!n.shiftKey&&(n.key.indexOf("Arrow")>-1&&Ue(n)||n.key==="Enter")&&!e.hint.element.classList.contains("fn__none")&&e.hint.select(n,e))return;if(te("\u2318/",n)){n.stopPropagation(),n.preventDefault();const w=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(w.length===0){const h=D(c.startContainer,"data-type",null);if(h&&h.tagName==="SPAN"){const E=h.getAttribute("data-type").split(" ");if(E.length>0&&(e.toolbar.range=c,Er(h)),E.includes("block-ref")){Il(e,h);return}else if(E.includes("inline-memo")){e.toolbar.showRender(e,h);return}else if(E.includes("file-annotation-ref")){$l(e,h);return}else if(E.includes("a")){Ai(e,h);return}else if(E.includes("tag")){Hl(e,h);return}}if(c.startOffset===0&&c.startContainer.nodeType===3){const E=ut(c.startContainer);if(E&&E.nodeType!==3&&((a=E.getAttribute("data-type"))==null?void 0:a.indexOf("inline-math"))>-1){bs(e,E);return}else if(!E&&c.startContainer.parentElement.previousSibling&&c.startContainer.parentElement.previousSibling.isSameNode(c.startContainer.parentElement.previousElementSibling)&&((s=c.startContainer.parentElement.previousElementSibling.getAttribute("data-type"))==null?void 0:s.indexOf("inline-math"))>-1){bs(e,c.startContainer.parentElement.previousElementSibling);return}}w.push(d)}w.length===1?e.gutter.renderMenu(e,w[0]):e.gutter.renderMultipleMenu(e,w);const v=d.getBoundingClientRect();window.siyuan.menus.menu.popup({x:v.left,y:v.top,isLeft:!0});return}if(Ru(e,n,c)){n.preventDefault();return}const p=c.toString();if(!n.altKey&&!n.shiftKey&&Ue(n)&&!n.isComposing&&n.key.indexOf("Arrow")>-1){const w=O(c.startContainer,"TD")||O(c.startContainer,"TH"),v=w||oe(d)||d,h=Je(v,e.wysiwyg.element,c);if(d.classList.contains("code-block")&&h.end===v.innerText.length&&(h.end-=1),n.key==="ArrowDown"&&(v==null?void 0:v.innerText.trimRight().substr(h.start).indexOf(`
`))===-1&&(w&&!w.parentElement.nextElementSibling&&d.getAttribute("data-type")==="NodeTable"&&!et(d)||d.getAttribute("data-type")==="NodeCodeBlock"&&!et(d)||d.parentElement.getAttribute("data-type")==="NodeBlockquote"&&d.nextElementSibling.classList.contains("protyle-attr")&&!et(d.parentElement)))d.parentElement.getAttribute("data-type")==="NodeBlockquote"?Rt(e,"afterend",d.parentElement.getAttribute("data-node-id")):Rt(e,"afterend",d.getAttribute("data-node-id"));else if(n.key==="ArrowUp"){const E=oe(e.wysiwyg.element.firstElementChild);if(!De(d)&&d.contains(E)||!E&&d.isSameNode(e.wysiwyg.element.firstElementChild)){if(hn(v,c).top-v.getBoundingClientRect().top<20||d.classList.contains("av"))if(e.title&&e.title.editElement&&(e.wysiwyg.element.firstElementChild.getAttribute("data-eof")==="1"||e.contentElement.scrollTop===0)){const S=nt(e.title.editElement,c,!1);S.collapse(!1),X(S),n.stopPropagation(),n.preventDefault()}else e.contentElement.scrollTop=0,e.scroll.lastScrollTop=8}else if(((v==null?void 0:v.innerText.substr(0,h.end).indexOf(`
`))===-1||h.start===0)&&hn(v,c).top-v.getBoundingClientRect().top<20){let S=De(d);if(S&&(S=lt(S),S)){const L=D(S,"fold","1");!L&&S.classList.contains("code-block")?(ne(S,void 0,!1),He(e,S),n.stopPropagation(),n.preventDefault()):L&&L.getAttribute("data-type")!=="NodeListItem"&&(L.scrollTop=0,ne(L,void 0,!0),He(e,L),n.stopPropagation(),n.preventDefault())}}}else if(p===""&&(n.key==="ArrowDown"||n.key==="ArrowRight")&&d.isSameNode(lt(e.wysiwyg.element.lastElementChild))&&!O(c.startContainer,"TD")&&!O(c.startContainer,"TH")){const E=oe(d);E&&!E.querySelector(".emoji")&&E.textContent.replace(/\n$/,"").length<=Je(E,void 0,c).end&&(n.stopPropagation(),n.preventDefault(),X(c))}else if(p===""&&n.key==="ArrowLeft"&&d.isSameNode(Mt(e.wysiwyg.element.firstElementChild))){const E=oe(d);E&&Je(E,void 0,c).start===0&&(n.stopPropagation(),n.preventDefault(),X(c))}if(n.key==="ArrowDown"){if((v==null?void 0:v.innerText.trimRight().substr(h.start).indexOf(`
`))===-1&&d.isSameNode(e.wysiwyg.element.lastElementChild)){nt(oe(v),c,!1),c.collapse(!1),n.stopPropagation(),n.preventDefault();return}const E=D(c.startContainer,"fold","1");if(E){let S=et(E);S&&(S.getAttribute("fold")==="1"&&(S.classList.contains("sb")||S.classList.contains("bq"))||(S=Mt(S)),ne(S),He(e,S)),n.stopPropagation(),n.preventDefault()}else if((v==null?void 0:v.innerText.substr(h.end).indexOf(`
`))===-1||h.end>=v.innerText.trimEnd().length){c.collapse(!1);const S=et(d);S&&(S.getAttribute("fold")==="1"||S.classList.contains("code-block"))&&v.getBoundingClientRect().bottom-hn(d,c).top<40&&(ne(S),He(e,S),n.stopPropagation(),n.preventDefault())}}return}if(!n.altKey&&(n.key==="Backspace"||n.key==="Delete")||te("\u2303D",n)){if(e.wysiwyg.element.querySelector(".protyle-wysiwyg--select")){ln(e,d,c,n.key==="Backspace"?"Backspace":"Delete"),n.stopPropagation(),n.preventDefault();return}if(p===""&&n.key==="Backspace"&&c.startOffset===c.startContainer.textContent.length&&c.startContainer.textContent.endsWith(`
`+f.ZWSP)){c.setStart(c.startContainer,c.startOffset-1),c.collapse(!0),n.stopPropagation(),n.preventDefault();return}const w=ut(c.startContainer);if(c.startOffset===1&&c.startContainer.textContent===f.ZWSP&&w&&w.nodeType!==3&&n.key==="Backspace"){if(w.classList.contains("img"))w.classList.add("img--select");else if(((i=w.getAttribute("data-type"))==null?void 0:i.indexOf("inline-math"))>-1){w.after(document.createElement("wbr"));const h=d.outerHTML;c.startContainer.textContent="",w.remove(),K(e,d.getAttribute("data-node-id"),d.outerHTML,h),ue(d,c),n.stopPropagation(),n.preventDefault();return}}const v=e.wysiwyg.element.querySelector(".img--select");if(v){if(v.classList.remove("img--select"),d.contains(v)){Nl(v,d,c,e),n.stopPropagation(),n.preventDefault();return}}else if(p===""){if(d.classList.contains("table")&&d.querySelector(".table__select").clientHeight>0){_r(e,d),n.stopPropagation(),n.preventDefault();return}const h=oe(d);if(!h){d.classList.add("protyle-wysiwyg--select"),ln(e,d,c,n.key==="Backspace"?"Backspace":"Delete"),n.stopPropagation(),n.preventDefault();return}const E=Je(h,e.wysiwyg.element,c);if(n.key==="Delete"||te("\u2303D",n)){if(c.startOffset===0&&c.startContainer.textContent.length===1){const S=ut(c.startContainer),L=Fe(c.startContainer);if(S&&S.nodeType===1&&S.classList.contains("img")&&L&&L.nodeType===1&&L.classList.contains("img")){const k=document.createElement("wbr");c.insertNode(k);const x=d.outerHTML;k.nextSibling.textContent=f.ZWSP,K(e,d.getAttribute("data-node-id"),d.outerHTML,x),ue(d,c),n.preventDefault();return}}if(E.end===h.innerText.length||E.end===h.innerText.length-1&&h.innerText.endsWith(`
`)||E.end===h.innerText.length-1&&h.innerText.endsWith(f.ZWSP)){const S=et(Ne(d));if(S){const L=ne(S);if(L){const k=B(L.startContainer);k&&ln(e,k,L,"Delete")}n.stopPropagation(),n.preventDefault();return}}else if(E.end===h.innerText.length-1&&d.getAttribute("data-type")==="NodeCodeBlock"){n.stopPropagation(),n.preventDefault();return}else{let S=Fe(c.startContainer);if(S){if(S.nodeType===3&&S.textContent===f.ZWSP){if(!S.nextSibling){const L=et(d);L&&ln(e,L,c,"remove"),n.stopPropagation(),n.preventDefault();return}S=S.nextSibling}if(S.nodeType===1&&S.classList.contains("img")&&Je(c.startContainer,e.wysiwyg.element,c).start===c.startContainer.textContent.length){Nl(S,d,c,e),n.stopPropagation(),n.preventDefault();return}}}}else{const S=c.startContainer.childNodes[c.startOffset-1];if(E.start===0&&(c.startOffset===0||S&&S.nodeType===3&&!ut(S)&&S.textContent==="")){ln(e,d,c,"Backspace"),n.stopPropagation(),n.preventDefault();return}if(c.startContainer.nodeType!==3&&d.getAttribute("data-type")==="NodeTable"&&((l=c.startContainer.children[c.startOffset-1])==null?void 0:l.tagName)==="TABLE"){d.classList.add("protyle-wysiwyg--select"),ln(e,d,c,"Backspace"),n.stopPropagation(),n.preventDefault();return}if(S&&S.nodeType!==3&&S.classList.contains("img")){Nl(S,d,c,e),n.stopPropagation(),n.preventDefault();return}if(c.startOffset===1&&c.startContainer.textContent.length===1){const k=ut(c.startContainer),x=Fe(c.startContainer);if(k&&k.nodeType===1&&k.classList.contains("img")&&x&&x.nodeType===1&&x.classList.contains("img")){const C=document.createElement("wbr");c.insertNode(C);const T=d.outerHTML;C.previousSibling.textContent=f.ZWSP,K(e,d.getAttribute("data-node-id"),d.outerHTML,T),ue(d,c),n.preventDefault();return}}if(d.classList.contains("code-block")&&bt(n)&&c.startContainer.nodeType===3&&c.startContainer.textContent.substring(c.startOffset-1,c.startOffset)===`
`){n.stopPropagation(),n.preventDefault();return}const L=O(c.startContainer,"SPAN");if(E.start===2&&L&&Je(L,e.wysiwyg.element,c).start===1&&L.innerText.startsWith(f.ZWSP)&&h.innerText.startsWith(f.ZWSP)){ne(d),n.stopPropagation(),n.preventDefault();return}if(E.start===1&&!L&&h.innerText.startsWith(f.ZWSP)&&h.innerText.length>1){ya(h,c),ln(e,d,c,"Backspace"),n.stopPropagation(),n.preventDefault();return}}}else if(d.classList.contains("code-block")&&oe(d).textContent===`
`){c.collapse(!0),n.stopPropagation(),n.preventDefault();return}}if(te("\u21E7\u21A9",n)&&p===""&&$r(c,d,e)){n.stopPropagation(),n.preventDefault();return}if(Ue(n)&&n.key==="Enter"){if(n.altKey)Mf(e,d,c);else if(!n.shiftKey){Zu(d,c,e),n.stopPropagation(),n.preventDefault();return}}if(te("\u2318A",n))return n.preventDefault(),Js(e,d,c),!0;if(te(window.siyuan.config.keymap.editor.general.undo.custom,n)){e.undo.undo(e),n.preventDefault(),n.stopPropagation();return}if(te(window.siyuan.config.keymap.editor.general.redo.custom,n)){e.undo.redo(e),n.preventDefault(),n.stopPropagation();return}if(te(window.siyuan.config.keymap.editor.general.copyText.custom,n)){if(p!=="")cd(c,w=>{Be(`${w.trim()} ((${d.getAttribute("data-node-id")} "*"))`)});else{const w=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");w.length>0?(w[0].setAttribute("data-reftext","true"),X(ye(d)),document.execCommand("copy")):Be(`((${d.getAttribute("data-node-id")} "*"))`)}return n.preventDefault(),n.stopPropagation(),!0}if(te(window.siyuan.config.keymap.editor.general.attr.custom,n)){const w=Ne(d);if(p===""){const v=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");let h;v.length===1?h=v[0]:h=w,Kn(h,"bookmark",e)}else cd(c,v=>{const h=w.outerHTML,E=w.lastElementChild.querySelector(".protyle-attr--name");E?E.innerHTML=`<svg><use xlink:href="#iconN"></use></svg>${v.trim()}`:w.lastElementChild.insertAdjacentHTML("afterbegin",`<div class="protyle-attr--name"><svg><use xlink:href="#iconN"></use></svg>${v.trim()}</div>`),w.setAttribute("name",v.trim()),K(e,w.getAttribute("data-node-id"),w.outerHTML,h)});return n.preventDefault(),n.stopPropagation(),!0}if(te(window.siyuan.config.keymap.editor.general.rename.custom,n)&&!e.disabled){p===""?A("/api/block/getDocInfo",{id:e.block.rootID},w=>{vr({notebookId:e.notebookId,path:e.path,name:w.data.ial.title,range:c,type:"file"})}):A("/api/filetree/renameDoc",{notebook:e.notebookId,path:e.path,title:Pn(p)}),n.preventDefault(),n.stopPropagation();return}const g=te(window.siyuan.config.keymap.editor.general.newNameFile.custom,n);if(g||te(window.siyuan.config.keymap.editor.general.newNameSettingFile.custom,n)){!p.trim()&&(d.querySelector("tr")||d.querySelector("span"))||(!p.trim()&&oe(d).textContent&&Js(e,d,c),g?A("/api/filetree/getHPathByPath",{notebook:e.notebookId,path:e.path},w=>{zr(e,p,d,w.data,e.notebookId)}):Sl(e.path,e.notebookId,(w,v)=>{zr(e,p,d,w,v)})),n.preventDefault(),n.stopPropagation();return}if(te(window.siyuan.config.keymap.editor.general.newContentFile.custom,n)){Uu(e),n.preventDefault(),n.stopPropagation();return}if(te(window.siyuan.config.keymap.editor.general.alignLeft.custom,n)){const w=d.querySelectorAll(".img--select");if(w.length>0)Fr(e,d,Array.from(w),d.getAttribute("data-node-id"),d.outerHTML);else{let v=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));v.length===0&&(v=[d]),ra(v,e,h=>{h.classList.contains("av")?h.style.justifyContent="":h.style.textAlign="left"})}n.stopPropagation(),n.preventDefault();return}if(te(window.siyuan.config.keymap.editor.general.alignCenter.custom,n)){const w=d.querySelectorAll(".img--select");if(w.length>0)Yr(e,d,Array.from(w),d.getAttribute("data-node-id"),d.outerHTML);else{let v=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));v.length===0&&(v=[d]),ra(v,e,h=>{h.classList.contains("av")?h.style.justifyContent="center":h.style.textAlign="center"})}n.stopPropagation(),n.preventDefault();return}if(te(window.siyuan.config.keymap.editor.general.alignRight.custom,n)){let w=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));w.length===0&&(w=[d]),ra(w,e,v=>{v.classList.contains("av")?v.style.justifyContent="flex-end":v.style.textAlign="right"}),n.stopPropagation(),n.preventDefault();return}if(te(window.siyuan.config.keymap.editor.general.rtl.custom,n)){let w=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));w.length===0&&(w=[d]),ra(w,e,v=>{v.style.direction="rtl"}),n.stopPropagation(),n.preventDefault();return}if(te(window.siyuan.config.keymap.editor.general.ltr.custom,n)){let w=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));w.length===0&&(w=[d]),ra(w,e,v=>{v.style.direction="ltr"}),n.stopPropagation(),n.preventDefault();return}if(n.key==="Escape"){if(n.repeat){const w=$(c.startContainer,"card__main",!0);w&&document.activeElement&&document.activeElement.classList.contains("protyle-wysiwyg")&&(w.querySelector(".card__action:not(.fn__none) button:not([disabled])").focus(),J(["select"],e))}else!e.toolbar.element.classList.contains("fn__none")||!e.hint.element.classList.contains("fn__none")||!e.toolbar.subElement.classList.contains("fn__none")?(J(["toolbar","hint","util"],e),e.hint.enableExtend=!1):d.classList.contains("protyle-wysiwyg--select")?(J(["select"],e),Ht([],e.block.rootID)):window.siyuan.menus.menu.element.classList.contains("fn__none")?(J(["select"],e),c.collapse(!1),d.classList.add("protyle-wysiwyg--select"),Ht([d.getAttribute("data-node-id")],e.block.rootID)):window.siyuan.menus.menu.remove();n.stopPropagation(),n.preventDefault();return}if(te(window.siyuan.config.keymap.editor.heading.paragraph.custom,n)){const w=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(w.length===0&&w.push(d),w.length>1)xn({protyle:e,nodeElement:w[0],type:"Blocks2Ps"});else{const v=w[0].getAttribute("data-type");v==="NodeHeading"?xn({protyle:e,nodeElement:w[0],type:"Blocks2Ps"}):v==="NodeList"?Xa({protyle:e,nodeElement:w[0],id:w[0].getAttribute("data-node-id"),type:"CancelList"}):v==="NodeBlockquote"&&Xa({protyle:e,nodeElement:w[0],id:w[0].getAttribute("data-node-id"),type:"CancelBlockquote"})}return n.preventDefault(),n.stopPropagation(),!0}if(te(window.siyuan.config.keymap.editor.heading.heading1.custom,n))return xn({protyle:e,nodeElement:d,type:"Blocks2Hs",level:1}),n.preventDefault(),n.stopPropagation(),!0;if(te(window.siyuan.config.keymap.editor.heading.heading2.custom,n))return xn({protyle:e,nodeElement:d,type:"Blocks2Hs",level:2}),n.preventDefault(),n.stopPropagation(),!0;if(te(window.siyuan.config.keymap.editor.heading.heading3.custom,n))return xn({protyle:e,nodeElement:d,type:"Blocks2Hs",level:3}),n.preventDefault(),n.stopPropagation(),!0;if(te(window.siyuan.config.keymap.editor.heading.heading4.custom,n))return xn({protyle:e,nodeElement:d,type:"Blocks2Hs",level:4}),n.preventDefault(),n.stopPropagation(),!0;if(te(window.siyuan.config.keymap.editor.heading.heading5.custom,n))return xn({protyle:e,nodeElement:d,type:"Blocks2Hs",level:5}),n.preventDefault(),n.stopPropagation(),!0;if(te(window.siyuan.config.keymap.editor.heading.heading6.custom,n))return xn({protyle:e,nodeElement:d,type:"Blocks2Hs",level:6}),n.preventDefault(),n.stopPropagation(),!0;if(te(window.siyuan.config.keymap.editor.insert.code.custom,n)&&!["NodeCodeBlock","NodeHeading"].includes(d.getAttribute("data-type"))){const w=d.getAttribute("data-node-id"),v=d.outerHTML,h=oe(d);h.innerHTML="```"+window.siyuan.storage[f.LOCAL_CODELANG]+`
`+Lute.EscapeHTMLStr(h.textContent)+"<wbr>\n```";const E=e.lute.SpinBlockDOM(d.outerHTML);d.outerHTML=E;const S=e.wysiwyg.element.querySelector(`[data-node-id="${w}"]`);return K(e,w,E,v),Pe(S),n.preventDefault(),n.stopPropagation(),!0}if(te(window.siyuan.config.keymap.editor.insert.lastUsed.custom,n)){e.toolbar.range=c;const w=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));p===""&&w.length===0&&w.push(d),an(e,w),n.stopPropagation(),n.preventDefault();return}if(!d.classList.contains("code-block")&&!n.repeat&&!re(d)){let w=!1;if(e.options.toolbar.find(v=>{if(!v.hotkey)return!1;if(te(v.hotkey,n))return e.toolbar.range=c,["block-ref"].includes(v.name)&&e.toolbar.range.toString()===""||(w=!0,["a","block-ref","inline-math","inline-memo","text"].includes(v.name)?e.toolbar.element.querySelector(`[data-type="${v.name}"]`).dispatchEvent(new CustomEvent("click")):f.INLINE_TYPE.includes(v.name)?e.toolbar.setInlineMark(e,v.name,"range"):v.click&&v.click(e.getInstance())),!0}),w)return n.preventDefault(),n.stopPropagation(),e.wysiwyg.preventKeyup=!0,!0}if(te(window.siyuan.config.keymap.editor.list.outdent.custom,n)){const w=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(w.length>0){let v=!0;return w.forEach((h,E)=>{h.nextElementSibling&&w[E+1]&&(w[E+1].isSameNode(h.nextElementSibling)||(v=!1))}),v&&(w[0].classList.contains("li")||w[0].parentElement.classList.contains("li"))&&Wa(e,Array.from(w),c),n.preventDefault(),n.stopPropagation(),!0}else if(d.parentElement.classList.contains("li")&&d.getAttribute("data-type")!=="NodeCodeBlock")return Wa(e,[d.parentElement],c),n.preventDefault(),n.stopPropagation(),!0}if(te(window.siyuan.config.keymap.editor.list.indent.custom,n)){const w=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(w.length>0){let v=!0;return w.forEach((h,E)=>{h.nextElementSibling&&w[E+1]&&(w[E+1].isSameNode(h.nextElementSibling)||(v=!1))}),v&&(w[0].classList.contains("li")||w[0].parentElement.classList.contains("li"))&&ys(e,Array.from(w),c),n.preventDefault(),n.stopPropagation(),!0}else if(d.parentElement.classList.contains("li")&&d.getAttribute("data-type")!=="NodeCodeBlock")return ys(e,[d.parentElement],c),n.preventDefault(),n.stopPropagation(),!0}const m=te(window.siyuan.config.keymap.editor.insert.list.custom,n),b=te(window.siyuan.config.keymap.editor.insert.check.custom,n),y=te(window.siyuan.config.keymap.editor.insert["ordered-list"].custom,n),_=te(window.siyuan.config.keymap.editor.insert.quote.custom,n);if(m||y||b||_){const w=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(w.length===0&&w.push(d),w.length===1){const v=w[0].dataset.subtype,h=w[0].dataset.type;if(_)["NodeHeading","NodeParagraph","NodeList"].includes(h)?Kt({protyle:e,selectsElement:w,type:"Blocks2Blockquote"}):(e.hint.splitChar="/",e.hint.lastIndex=-1,e.hint.fill(">"+Lute.Caret,e));else if(h==="NodeParagraph")Kt({protyle:e,selectsElement:w,type:b?"Blocks2TLs":m?"Blocks2ULs":"Blocks2OLs"});else if(h==="NodeList"){const E=w[0].dataset.nodeId;v==="o"&&(m||b)?Xa({protyle:e,nodeElement:w[0],id:E,type:b?"UL2TL":"OL2UL"}):v==="t"&&(m||y)?Xa({protyle:e,nodeElement:w[0],id:E,type:m?"TL2UL":"TL2OL"}):v==="u"&&(b||y)&&Xa({protyle:e,nodeElement:w[0],id:E,type:b?"OL2TL":"UL2OL"})}else e.hint.splitChar="/",e.hint.lastIndex=-1,e.hint.fill((b?"* [ ] ":m?"* ":"1. ")+Lute.Caret,e)}else{let v=!1,h=!1;w.find((E,S)=>{if(E.classList.contains("li"))return v=!0,!0;if(E.nextElementSibling&&w[S+1]&&E.nextElementSibling.isSameNode(w[S+1]))h=!0;else if(S!==w.length-1)return h=!1,!0}),!v&&h&&Kt({protyle:e,selectsElement:w,type:_?"Blocks2Blockquote":b?"Blocks2TLs":m?"Blocks2ULs":"Blocks2OLs"})}n.preventDefault(),n.stopPropagation();return}if(te(window.siyuan.config.keymap.editor.insert.table.custom,n)){e.hint.splitChar="/",e.hint.lastIndex=-1,e.hint.fill(`| ${Lute.Caret} |  |  |
| --- | --- | --- |
|  |  |  |
|  |  |  |`,e),n.preventDefault(),n.stopPropagation();return}if(te(window.siyuan.config.keymap.editor.list.checkToggle.custom,n)){const w=D(c.startContainer,"data-subtype","t");if(!w)return;const v=w.outerHTML;w.classList.contains("protyle-task--done")?(w.querySelector("use").setAttribute("xlink:href","#iconUncheck"),w.classList.remove("protyle-task--done")):(w.querySelector("use").setAttribute("xlink:href","#iconCheck"),w.classList.add("protyle-task--done")),w.setAttribute("updated",U().format("YYYYMMDDHHmmss")),K(e,w.getAttribute("data-node-id"),w.outerHTML,v),n.preventDefault(),n.stopPropagation();return}if(te(window.siyuan.config.keymap.editor.general.insertBefore.custom,n))return Rt(e,"beforebegin"),n.preventDefault(),!0;if(te(window.siyuan.config.keymap.editor.general.insertAfter.custom,n))return Rt(e,"afterend"),n.preventDefault(),n.stopPropagation(),!0;if(te(window.siyuan.config.keymap.editor.general.jumpToParentNext.custom,n))return ja(e,d,"next"),n.preventDefault(),n.stopPropagation(),!0;if(te(window.siyuan.config.keymap.editor.general.jumpToParent.custom,n))return ja(e,d,"parent"),n.preventDefault(),n.stopPropagation(),!0;if(te(window.siyuan.config.keymap.editor.general.jumpToParentPrev.custom,n))return ja(e,d,"previous"),n.preventDefault(),n.stopPropagation(),!0;if(te(window.siyuan.config.keymap.editor.general.moveToUp.custom,n)){n.preventDefault(),n.stopPropagation(),Cr(e,d,c);return}if(te(window.siyuan.config.keymap.editor.general.moveToDown.custom,n)){n.preventDefault(),n.stopPropagation(),Tr(e,d,c);return}if(te(window.siyuan.config.keymap.editor.general.vLayout.custom,n)){n.preventDefault(),n.stopPropagation();const w=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(w.length===1&&w[0].getAttribute("data-type")==="NodeSuperBlock"){if(w[0].getAttribute("data-sb-layout")==="col"){const v=w[0].outerHTML;w[0].setAttribute("data-sb-layout","row"),w[0].setAttribute("updated",U().format("YYYYMMDDHHmmss")),K(e,w[0].getAttribute("data-node-id"),w[0].outerHTML,v)}else{c.insertNode(document.createElement("wbr"));const v=sa(e,w[0]);q(e,v.doOperations,v.undoOperations),ue(e.wysiwyg.element,c)}return}if(w.length<2||(o=w[0])!=null&&o.classList.contains("li"))return;Kt({protyle:e,selectsElement:w,type:"BlocksMergeSuperBlock",level:"row"});return}if(te(window.siyuan.config.keymap.editor.general.hLayout.custom,n)){n.preventDefault(),n.stopPropagation();const w=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(w.length===1&&w[0].getAttribute("data-type")==="NodeSuperBlock"){if(w[0].getAttribute("data-sb-layout")==="row"){const v=w[0].outerHTML;w[0].setAttribute("data-sb-layout","col"),w[0].setAttribute("updated",U().format("YYYYMMDDHHmmss")),K(e,w[0].getAttribute("data-node-id"),w[0].outerHTML,v)}else{c.insertNode(document.createElement("wbr"));const v=sa(e,w[0]);q(e,v.doOperations,v.undoOperations),ue(e.wysiwyg.element,c)}return}if(w.length<2||(r=w[0])!=null&&r.classList.contains("li"))return;Kt({protyle:e,selectsElement:w,type:"BlocksMergeSuperBlock",level:"col"});return}if(!n.repeat&&te(window.siyuan.config.keymap.editor.general.ai.custom,n)){n.preventDefault(),n.stopPropagation();let w=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));w.length===0&&(w=[d]),co(w,e);return}if(!n.repeat&&te(window.siyuan.config.keymap.editor.general.aiWriting.custom,n)){n.preventDefault(),n.stopPropagation(),id(e,d);return}if(!n.repeat&&te(window.siyuan.config.keymap.editor.general.openInNewTab.custom,n)){n.preventDefault(),n.stopPropagation();const w=window.siyuan.blockPanels.find(h=>{if(h.element.contains(d))return!0}),v=d.getAttribute("data-node-id");Mn(v,(h,E)=>{openFileById({app:e.app,id:v,action:E,zoomIn:h,openNewTab:!0}),w.destroy()});return}if(n.key==="Tab"&&Ue(n)&&!n.altKey){n.preventDefault();const w=window.siyuan.config.editor.codeTabSpaces===0?"	":"".padStart(window.siyuan.config.editor.codeTabSpaces," ");if(d.getAttribute("data-type")==="NodeCodeBlock"&&p!==""){!Fe(c.endContainer)&&c.endContainer.textContent.endsWith(`
`)&&c.endOffset>0&&c.setEnd(c.endContainer,c.endOffset-1);const v=document.createElement("wbr");c.insertNode(v),c.setStartAfter(v);const h=d.outerHTML;let E="";n.shiftKey?c.extractContents().textContent.split(`
`).forEach(k=>{k.startsWith(w)?E+=k.replace(w,"")+`
`:E+=k+`
`}):c.extractContents().textContent.split(`
`).forEach(k=>{E+=w+k+`
`});let S=d.querySelector(".protyle-action__language").textContent;window.hljs.getLanguage(S)||(S="plaintext"),v.insertAdjacentHTML("afterend",window.hljs.highlight(E.substr(0,E.length-1),{language:S,ignoreIllegals:!0}).value+"<br>"),c.setStart(v.nextSibling,0);const L=v.parentElement.querySelector("br");nt(L.previousSibling,c,!1),L.remove(),K(e,d.getAttribute("data-node-id"),d.outerHTML,h),v.remove();return}if(!n.shiftKey){const v=document.createElement("wbr");c.insertNode(v);const h=d.outerHTML;return c.extractContents(),c.insertNode(document.createTextNode(w)),c.collapse(!1),X(c),v.remove(),K(e,d.getAttribute("data-node-id"),d.outerHTML,h),!0}}if(n.key==="ContextMenu"){const w=hn(d,c);e.wysiwyg.element.dispatchEvent(new CustomEvent("contextmenu",{detail:{target:d,y:w.top+8,x:w.left}})),n.preventDefault(),n.stopPropagation();return}if(te("\u21E7\u2318V",n)){n.returnValue=!1,n.preventDefault(),n.stopPropagation(),jc(e);return}if(te(window.siyuan.config.keymap.editor.general.openBy.custom,n)){const w=D(c.startContainer,"data-type","a");if(w){Ci(e,w.getAttribute("data-href"),void 0,!1),n.preventDefault(),n.stopPropagation();return}const v=D(c.startContainer,"data-type","file-annotation-ref");if(v){const E=`assets/${v.getAttribute("data-id").split("/")[1]}`;Ci(e,E,void 0,!1),n.preventDefault(),n.stopPropagation();return}return}if(Ue(n)&&n.key!=="Backspace"&&n.key!=="Escape"&&n.key!=="Delete"&&!n.shiftKey&&!n.altKey&&n.key!=="Enter"&&J(["select"],e),te("\u2318B",n)||te("\u2318I",n)||te("\u2318U",n)){n.preventDefault(),n.stopPropagation();return}})},dd=(e,t,n)=>{const a=H(),s=$(e.target,"protyle-attr--bookmark");if(s)return!a&&bt(e)||(n?qn(n,"bookmark",t):Kn(s.parentElement.parentElement,"bookmark",t)),e.stopPropagation(),!0;const i=$(e.target,"protyle-attr--name");if(i)return!a&&bt(e)||(n?qn(n,"name",t):Kn(i.parentElement.parentElement,"name",t)),e.stopPropagation(),!0;const l=$(e.target,"protyle-attr--av");if(l)return n?qn(n,"av",t):Kn(l.parentElement.parentElement,"av",t),e.stopPropagation(),!0;const o=$(e.target,"protyle-attr--alias");if(o)return!a&&bt(e)||(n?qn(n,"alias",t):Kn(o.parentElement.parentElement,"alias",t)),e.stopPropagation(),!0;const r=$(e.target,"protyle-attr--memo");if(r)return!a&&bt(e)||(n?qn(n,"memo",t):Kn(r.parentElement.parentElement,"memo",t)),e.stopPropagation(),!0},ud=e=>{!window.siyuan.menus.menu.element.contains(e)&&!D(e,"data-menu","true")&&(getSelection().rangeCount>0&&window.siyuan.menus.menu.element.contains(getSelection().getRangeAt(0).startContainer)&&window.siyuan.menus.menu.element.contains(document.activeElement)||window.siyuan.menus.menu.remove())},Tm=e=>{cancelDrag(),ud(e.target),hasClosestByClassName(e.target,"pdf__outer")||hideAllElements(["pdfutil"]),!isWindow()&&window.siyuan.layout.leftDock&&!hasClosestByClassName(e.target,"b3-dialog--open",!0)&&!hasClosestByClassName(e.target,"b3-menu")&&!hasClosestByClassName(e.target,"block__popover")&&!hasClosestByClassName(e.target,"dock")&&!hasClosestByClassName(e.target,"layout--float",!0)&&(window.siyuan.layout.bottomDock.hideDock(),window.siyuan.layout.leftDock.hideDock(),window.siyuan.layout.rightDock.hideDock());const t=hasClosestByClassName(e.target,"protyle",!0);if(t){const s=t.querySelector(".protyle-wysiwyg");(s.getAttribute("data-readonly")==="true"||!s.contains(e.target))&&s.dispatchEvent(new Event("focusin"))}const n=hasTopClosestByClassName(e.target,"protyle-action__copy");if(n){let s=n.parentElement.nextElementSibling.textContent.replace(/\n$/,"");s=s.replace(/\u00A0/g," "),writeText(s),showMessage(window.siyuan.languages.copied,2e3),e.preventDefault();return}if(hasClosestByAttribute(e.target,"id","secondaryToolbarToggleButton")||hasClosestByAttribute(e.target,"id","viewFindButton")||hasClosestByAttribute(e.target,"id","findbar"))return;let a;getAllModels().asset.find(s=>{if(s.pdfObject&&!s.pdfObject.appConfig.appContainer.classList.contains("fn__none"))return a=s.pdfObject,!0}),a&&(a.secondaryToolbar.isOpen&&a.secondaryToolbar.close(),!a.supportsIntegratedFind&&a.findBar.opened&&a.findBar.close())};var Hg=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{o(n.next(r))}catch(c){s(c)}},l=r=>{try{o(n.throw(r))}catch(c){s(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,l);o((n=n.apply(e,t)).next())});class Ng{constructor(t){this.lastHTMLs={},this.element=document.createElement("div"),this.element.className="protyle-wysiwyg",this.element.setAttribute("spellcheck","false"),H()?this.element.setAttribute("contenteditable","false"):this.element.setAttribute("contenteditable","true"),window.siyuan.config.editor.displayBookmarkIcon&&this.element.classList.add("protyle-wysiwyg--attr"),this.bindCommonEvent(t),!t.options.action.includes(f.CB_GET_HISTORY)&&(this.bindEvent(t),Mg(t,this.element),Ig(t,this.element))}renderCustom(t){let n=t[f.CUSTOM_SY_FULLWIDTH];n||(n=window.siyuan.config.editor.fullWidth?"true":"false"),n==="true"?this.element.parentElement.setAttribute("data-fullwidth","true"):this.element.parentElement.removeAttribute("data-fullwidth");const a=Object.keys(t);for(let s=0;s<this.element.attributes.length;s++){const i=this.element.attributes[s].nodeName;!["type","class","spellcheck","contenteditable","data-doc-type","style","data-realwidth","data-readonly"].includes(i)&&!a.includes(i)&&(this.element.removeAttribute(i),s--)}a.forEach(s=>{["title-img","title","updated","icon","id","type","class","spellcheck","contenteditable","data-doc-type","style","data-realwidth","data-readonly"].includes(s)||this.element.setAttribute(s,t[s])})}escapeInline(t,n,a){if(!a.data&&a.inputType!=="insertLineBreak")return;const s=a.data;t.toolbar.range=n;const i=n.startContainer.parentElement,l=t.toolbar.getCurrentType();if(a.inputType==="insertLineBreak"){l.length>0&&n.toString()===""&&i.tagName==="SPAN"&&i.textContent.startsWith(`
`)&&n.startContainer.previousSibling&&n.startContainer.previousSibling.textContent===`
`&&i.before(n.startContainer.previousSibling);return}let o=s.length;if(s==="<"||s===">"?o=4:s==="&"&&(o=5),l.length>0&&n.toString()===""&&n.startOffset===s.length&&i.tagName==="SPAN"&&i.textContent.replace(f.ZWSP,"")!==s&&i.textContent.replace(f.ZWSP,"").length>=s.length&&!ut(n.startContainer)&&!ut(i)){const r=i.innerHTML.replace(f.ZWSP,"");i.innerHTML=r.substr(o);const c=document.createTextNode(s);i.before(c),n.selectNodeContents(c),n.collapse(!1);return}if(i.tagName==="SPAN"&&i.textContent!==s&&!l.includes("search-mark")&&!l.includes("code")&&!l.includes("kbd")&&!l.includes("tag")&&n.toString()===""&&n.startContainer.nodeType===3&&(l.includes("inline-memo")||l.includes("text")||l.includes("block-ref")||l.includes("file-annotation-ref")||l.includes("a"))&&!Fe(n.startContainer)&&n.startContainer.textContent.length===n.startOffset&&i.textContent.length>s.length){const r=Je(i,t.wysiwyg.element,n),c=i.innerHTML;if(r.start===i.textContent.length){i.innerHTML=c.substr(0,c.length-o);const d=document.createTextNode(s);i.after(d),n.selectNodeContents(d),n.collapse(!1)}}}setEmptyOutline(t,n){t.wysiwyg.element.querySelectorAll(".img--select, .av__cell--select, .av__cell--active, .av__row--select").forEach(s=>{var i;s.classList.contains("av__row--select")&&!$(n,"av")?(s.classList.remove("av__row--select"),s.querySelector(".av__firstcol use").setAttribute("xlink:href","#iconUncheck"),ca(s)):(s.classList.remove("img--select","av__cell--select","av__cell--active"),(i=s.querySelector(".av__drag-fill"))==null||i.remove())});let a=n;if(!n.getAttribute("data-node-id")){const s=B(n);if(!s)return;a=s}t.disabled&&(t.toolbar.range=ye(a))}emojiToMd(t){t.querySelectorAll(".emoji").forEach(n=>{n.outerHTML=`:${n.getAttribute("alt")}:`})}bindCommonEvent(t){this.element.addEventListener("copy",n=>{var a;if(window.siyuan.ctrlIsPressed=!1,n.target.tagName==="PROTYLE-HTML"||n.target.localName==="input"){n.stopPropagation();return}n.stopPropagation(),n.preventDefault();const s=ye(t.wysiwyg.element),i=B(s.startContainer);if(!i)return;const l=i.querySelector(".img--select"),o=i.querySelector(".av__row--select, .av__cell--select"),r=((a=i.querySelector(".table__select"))==null?void 0:a.clientWidth)>0;let c=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));c.length===0&&s.toString()===""&&!s.cloneContents().querySelector("img")&&!l&&!o&&!r&&(i.classList.add("protyle-wysiwyg--select"),Ht([i.getAttribute("data-node-id")]),c=[i]);let d="",u="";if(c.length>0){const p=c[0].getAttribute("data-reftext")==="true";c[0].getAttribute("data-type")==="NodeListItem"&&c[0].parentElement.classList.contains("list")&&c[0].parentElement.childElementCount-1===c.length?p?d=Kl(c[0].parentElement):d=c[0].parentElement.outerHTML:c.forEach((g,m)=>{p&&m===0?d+=Kl(g)+`

`:d+=rs(g)}),p&&c[0].removeAttribute("data-reftext")}else if(o){const p=Array.from(i.querySelectorAll(".av__cell--active, .av__cell--select"))||[];p.length===0&&i.querySelectorAll(".av__row--select:not(.av__row--header)").forEach(g=>{g.querySelectorAll(".av__cell").forEach(m=>{p.push(m)})}),p.length>0&&(d="[",p.forEach((g,m)=>{const b=Es(g);(m===0||!p[m-1].isSameNode(g.previousElementSibling))&&(d+="["),d+=JSON.stringify(gn(Bt(g),g))+",",(m===p.length-1||!p[m+1].isSameNode(g.nextElementSibling))&&(d=d.substring(0,d.length-1)+"],"),u+=b+(p[m+1]&&g.nextElementSibling&&g.nextElementSibling.isSameNode(p[m+1])?"	":`

`)}),u=u.substring(0,u.length-2),d=d.substring(0,d.length-1)+"]")}else if(r){const p=[],g=i.firstElementChild.scrollLeft,m=i.querySelector(".table__select");d="<table>",i.querySelectorAll("th, td").forEach(b=>{!b.classList.contains("fn__none")&&b.offsetLeft+6>m.offsetLeft+g&&b.offsetLeft+b.clientWidth-6<m.offsetLeft+g+m.clientWidth&&b.offsetTop+6>m.offsetTop&&b.offsetTop+b.clientHeight-6<m.offsetTop+m.clientHeight&&p.push(b)}),p.forEach((b,y)=>{(y===0||!b.previousElementSibling||!b.previousElementSibling.isSameNode(p[y-1]))&&(d+="<tr>"),d+=b.outerHTML,(!b.nextElementSibling||!p[y+1]||!b.nextElementSibling.isSameNode(p[y+1]))&&(d+="</tr>")}),d+="</table>",u=t.lute.HTML2Md(d)}else{const p=document.createElement("div"),g=t.toolbar.getCurrentType(s),m=O(s.startContainer,"SPAN"),b=D(s.startContainer,"data-type","NodeHeading");if(g.length>0&&m&&m.textContent.replace(f.ZWSP,"")===s.toString()||b&&b.textContent.replace(f.ZWSP,"")===s.toString())b?p.append(b.cloneNode(!0)):["DIV","TD","TH","TR"].includes(s.startContainer.parentElement.tagName)?(p.append(s.cloneContents()),this.emojiToMd(p)):(p.append(s.startContainer.parentElement.cloneNode(!0)),this.emojiToMd(p)),d=p.innerHTML,u=s.toString();else if(l)d=l.outerHTML,u=l.querySelector("img").getAttribute("data-src");else if(g.length>0&&s.startContainer.nodeType===3&&s.startContainer.parentElement.tagName==="SPAN"&&s.startContainer.parentElement.isSameNode(s.endContainer.parentElement)){const y=s.startContainer.parentElement.attributes,_=document.createElement("span");for(let w=0;w<y.length;w++)_.setAttribute(y[w].name,y[w].value);_.getAttribute("data-type").indexOf("block-ref")>-1&&_.getAttribute("data-subtype")==="d"&&_.setAttribute("data-subtype","s"),_.textContent=s.toString(),d=_.outerHTML,u=s.toString()}else{p.append(s.cloneContents()),this.emojiToMd(p);const y=D(s.commonAncestorContainer,"data-type","inline-math");y?d=y.outerHTML:d=p.innerHTML,u=p.textContent,D(s.startContainer,"data-type","NodeCodeBlock")?ma(s)&&(u=u.replace(/\n$/,"")):O(s.startContainer,"CODE")||(u=s.toString())}}t.disabled&&(d=Bu(d)),u=u||t.lute.BlockDOM2StdMd(d).trimEnd(),u=u.replace(/\u00A0/g," ").replace(new RegExp(f.ZWSP,"g"),""),n.clipboardData.setData("text/plain",u),n.clipboardData.setData("text/html",r?d:t.lute.BlockDOM2HTML(o?u:d)),n.clipboardData.setData("text/siyuan",r?t.lute.HTML2BlockDOM(d):d)}),this.element.addEventListener("mousedown",n=>{var a;if(t.wysiwyg.element.classList.remove("protyle-wysiwyg--hiderange"),n.button===2||window.siyuan.ctrlIsPressed)return;window.siyuan.shiftIsPressed&&getSelection().rangeCount>0&&(this.shiftStartElement=B(getSelection().getRangeAt(0).startContainer)),window.siyuan.shiftIsPressed||J(["select"],t);let s=n.target;if($(s,"protyle-action")||$(s,"av__cell--header")&&!$(s,"av__widthdrag"))return;const i=document,l=t.element.getBoundingClientRect(),o=l.left+(parseInt(t.wysiwyg.element.style.paddingLeft)||24)+1,r=o+(t.wysiwyg.element.clientWidth-(parseInt(t.wysiwyg.element.style.paddingLeft)||24)-(parseInt(t.wysiwyg.element.style.paddingRight)||16))-2,c=l.bottom,d=n.clientY,u=t.contentElement.getBoundingClientRect();if(!t.disabled&&s.classList.contains("av__widthdrag")){const L=B(s);if(!L)return;const k=L.getAttribute("data-av-id"),x=L.dataset.nodeId,C=s.parentElement,T=C.clientWidth,I=C.getAttribute("data-col-id");let P;const N=L.querySelector(".av__scroll");i.onmousemove=R=>{P=Math.max(T+(R.clientX-n.clientX),25),N.querySelectorAll(".av__row, .av__row--footer").forEach(V=>{V.querySelector(`[data-col-id="${I}"]`).style.width=P+"px"}),da(L,u,"bottom")},i.onmouseup=()=>{if(i.onmousemove=null,i.onmouseup=null,i.ondragstart=null,i.onselectstart=null,i.onselect=null,!P||P===T)return;const R=L.getAttribute("custom-sy-av-view");q(t,[{action:"setAttrViewColWidth",id:I,avID:k,data:P+"px",blockID:x,keyID:R}],[{action:"setAttrViewColWidth",id:I,avID:k,data:T+"px",blockID:x,keyID:R}])},this.preventClick=!0,n.preventDefault();return}const p=$(s,"av__drag-fill");if(!t.disabled&&p){const L=B(p);if(!L)return;const k={};let x;const C=[];L.querySelectorAll(".av__cell--active").forEach(R=>{const V=$(R,"av__row");V&&(k[V.dataset.id]||(k[V.dataset.id]=[]),k[V.dataset.id].push(gn(Bt(R),R)),x=R,C.push(R.dataset.id))});const T=$i(x),I=$i(L.querySelector(".av__cell--active"));let P,N;return i.onmousemove=R=>{const V=$(R.target,"av__cell");if(!(P&&V&&V.isSameNode(P))&&(P=V,P&&P.dataset.id)){const W=$i(P);if(L.querySelectorAll(".av__cell--active").forEach(se=>{C.includes(se.dataset.id)||se.classList.remove("av__cell--active")}),W.celIndex!==T.celIndex){N=void 0;return}L.querySelectorAll(".av__row").forEach((se,Ce)=>{(W.rowIndex<I.rowIndex&&Ce>=W.rowIndex&&Ce<I.rowIndex||W.rowIndex>T.rowIndex&&Ce<=W.rowIndex&&Ce>T.rowIndex)&&se.querySelectorAll(".av__cell").forEach((fe,be)=>{be>=I.celIndex&&be<=W.celIndex&&(fe.classList.add("av__cell--active"),N=fe)})})}},i.onmouseup=()=>{if(i.onmousemove=null,i.onmouseup=null,i.ondragstart=null,i.onselectstart=null,i.onselect=null,N){Qf(t,L,k,C);const R=L.querySelectorAll(".av__cell--active");Gt(R[R.length-1])}return!1},this.preventClick=!0,!1}const g=$(s,"av__cell");if(!t.disabled&&g&&g.dataset.id&&!re(g)){const L=B(g);if(!L)return;L.querySelectorAll(".av__cell--select").forEach(P=>{P.classList.remove("av__cell--select")}),L.querySelectorAll(".av__drag-fill").forEach(P=>{P.remove()}),g.classList.add("av__cell--select");const k=$i(g);let x,C;const T=L.getBoundingClientRect(),I=L.querySelector(".av__scroll");return i.onmousemove=P=>{const N=$(P.target,"av__cell");if(I.scrollWidth>I.clientWidth+2&&(P.clientX>T.right-10?I.scrollLeft+=10:P.clientX<T.left+34&&(I.scrollLeft-=10),P.clientY<u.top+48?t.contentElement.scrollTop-=5:P.clientY>u.bottom-48&&(t.contentElement.scrollTop+=5)),!(x&&N&&N.isSameNode(x))&&N&&N.dataset.id&&(n.clientX!==P.clientX||n.clientY!==P.clientY)){const R=$i(N);L.querySelectorAll(".av__cell--active").forEach(V=>{V.classList.remove("av__cell--active")}),L.querySelectorAll(".av__row").forEach((V,W)=>{W>=Math.min(k.rowIndex,R.rowIndex)&&W<=Math.max(k.rowIndex,R.rowIndex)&&V.querySelectorAll(".av__cell").forEach((se,Ce)=>{Ce>=Math.min(k.celIndex,R.celIndex)&&Ce<=Math.max(k.celIndex,R.celIndex)&&(se.classList.add("av__cell--active"),C=se)})}),x=N}},i.onmouseup=()=>(i.onmousemove=null,i.onmouseup=null,i.ondragstart=null,i.onselectstart=null,i.onselect=null,C&&(An(L.querySelector(".av__firstcol"),"unselectAll"),ne(L),Gt(C),this.preventClick=!0),!1),!1}if(!t.disabled&&s.classList.contains("protyle-action__drag")){const L=B(s);if(!L)return;let k=!0;["NodeIFrame","NodeWidget","NodeVideo"].includes(L.getAttribute("data-type"))?(L.classList.add("iframe--drag"),(L.style.textAlign==="left"||L.style.textAlign==="right")&&(k=!1)):s.parentElement.parentElement.getAttribute("data-type")==="img"&&s.parentElement.parentElement.classList.add("img--drag");const x=L.getAttribute("data-node-id"),C=L.outerHTML,T=n.clientX,I=s.previousElementSibling,P=I.clientWidth,N=I.clientHeight,R=I.parentElement.parentElement;I.tagName==="IMG"&&xa(R),i.onmousemove=V=>{if(I.tagName==="IMG"&&(I.style.height=""),V.clientX>T-P+8&&V.clientX<r){const W=I.tagName==="IMG"&&!R.style.minWidth&&L.style.textAlign!=="center"||!k?1:2;I.tagName==="IMG"?I.parentElement.style.width=Math.max(17,P+(V.clientX-T)*W)+"px":I.style.width=Math.max(17,P+(V.clientX-T)*W)+"px"}I.tagName!=="IMG"&&V.clientY>d-N+8&&V.clientY<c&&(I.style.height=N+(V.clientY-d)+"px")},i.onmouseup=()=>{i.onmousemove=null,i.onmouseup=null,i.ondragstart=null,i.onselectstart=null,i.onselect=null,s.classList.contains("protyle-action__drag")&&L&&K(t,x,L.outerHTML,C),L.classList.remove("iframe--drag"),s.parentElement.parentElement.classList.remove("img--drag")};return}let m;const b=O(s,"TH")||O(s,"TD");if(b&&(s=b),(s.tagName==="TH"||s.tagName==="TD"||((a=s.firstElementChild)==null?void 0:a.tagName)==="TABLE"||s.classList.contains("table__resize")||s.classList.contains("table__select"))&&(m=B(s),m&&(m.querySelector(".table__select").removeAttribute("style"),window.siyuan.menus.menu.remove(),J(["toolbar"],t),n.stopPropagation())),!t.disabled&&s.classList.contains("table__resize")){const L=B(s);if(!L)return;const k=L.outerHTML;getSelection().rangeCount>0&&getSelection().getRangeAt(0).collapse(!1),L.firstElementChild.style.webkitUserModify="read-only",L.style.cursor="col-resize",s.removeAttribute("style");const x=L.getAttribute("data-node-id"),C=n.clientX,T=parseInt(s.getAttribute("data-col-index")),I=L.querySelectorAll("table col")[T];I.style.minWidth&&(I.style.width=L.querySelectorAll("table td, table th")[T].offsetWidth+"px",I.style.minWidth=""),L.querySelectorAll("tr").forEach(R=>{R.cells[T].style.width=""});const P=I.clientWidth,N=L.firstElementChild.clientWidth<L.firstElementChild.scrollWidth;i.onmousemove=R=>{L.style.textAlign==="center"&&!N?I.style.width=P+(R.clientX-C)*2+"px":I.style.width=P+(R.clientX-C)+"px"},i.onmouseup=()=>{L.firstElementChild.style.webkitUserModify="",L.style.cursor="",i.onmousemove=null,i.onmouseup=null,i.ondragstart=null,i.onselectstart=null,i.onselect=null,L&&K(t,x,L.outerHTML,k)};return}let y=n.clientX;n.clientX>r?y=r:n.clientX<o&&(y=o);const _=l.top+(t.options.render.breadcrumb?t.breadcrumb.element.parentElement.clientHeight:0);let w,v,h,E;this.element.querySelectorAll("iframe").forEach(L=>{L.style.pointerEvents="none"});const S=["IMG","VIDEO","AUDIO"].includes(s.tagName)||s.classList.contains("img");i.onmousemove=L=>{let k=L.target;if(m&&m.contains(k)&&!$(m,"protyle-wysiwyg__embed")){if(k.classList.contains("table__select")){k.classList.add("fn__none");const fe=document.elementFromPoint(L.clientX,L.clientY);k.classList.remove("fn__none"),k=O(fe,"TH")||O(fe,"TD")}if(k&&k.isSameNode(s))return m.querySelector(".table__select").removeAttribute("style"),t.wysiwyg.element.classList.remove("protyle-wysiwyg--hiderange"),v=k,!1;if(k&&(k.tagName==="TH"||k.tagName==="TD")&&(!v||!v.isSameNode(k))){m.firstElementChild.style.webkitUserModify="read-only";let fe=s.offsetLeft+s.clientWidth-k.offsetLeft,be=k.offsetLeft;s.offsetLeft===k.offsetLeft?fe=Math.max(s.clientWidth,k.clientWidth):s.offsetLeft<k.offsetLeft&&(fe=k.offsetLeft+k.clientWidth-s.offsetLeft,be=s.offsetLeft);let pt=s.offsetTop+s.clientHeight-k.offsetTop,vt=k.offsetTop;s.offsetTop===k.offsetTop?pt=Math.max(s.clientHeight,k.clientHeight):s.offsetTop<k.offsetTop&&(pt=k.offsetTop+k.clientHeight-s.offsetTop,vt=s.offsetTop),Array.from(m.querySelectorAll("th, td")).find(he=>{const $n=he.offsetLeft<be+fe&&he.offsetLeft+he.clientWidth>be+fe,xe=he.offsetLeft<be&&he.offsetLeft+he.clientWidth>be;he.offsetTop<vt&&he.offsetTop+he.clientHeight>vt?((he.offsetLeft+6>be&&he.offsetLeft+he.clientWidth-6<be+fe||$n||xe)&&(pt=vt+pt-he.offsetTop,vt=he.offsetTop),$n&&(fe=he.offsetLeft+he.clientWidth-be),xe&&(fe=be+fe-he.offsetLeft,be=he.offsetLeft)):he.offsetTop<vt+pt&&he.offsetTop+he.clientHeight>vt+pt?((he.offsetLeft+6>be&&he.offsetLeft+he.clientWidth-6<be+fe||$n||xe)&&(pt=he.clientHeight+he.offsetTop-vt),$n&&(fe=he.offsetLeft+he.clientWidth-be),xe&&(fe=be+fe-he.offsetLeft,be=he.offsetLeft)):xe&&he.offsetTop+6>vt&&he.offsetTop+he.clientHeight-6<vt+pt?(fe=be+fe-he.offsetLeft,be=he.offsetLeft):$n&&he.offsetTop+6>vt&&he.offsetTop+he.clientHeight-6<vt+pt&&(fe=he.offsetLeft+he.clientWidth-be)}),t.wysiwyg.element.classList.add("protyle-wysiwyg--hiderange"),m.querySelector(".table__select").setAttribute("style",`left:${be-m.firstElementChild.scrollLeft}px;top:${vt}px;height:${pt}px;width:${fe+1}px;`),v=k}return}S&&(L.clientY<u.top+f.SIZE_SCROLL_TB||L.clientY>u.bottom-f.SIZE_SCROLL_TB)&&t.contentElement.scroll({top:t.contentElement.scrollTop+(L.clientY<u.top+f.SIZE_SCROLL_TB?-f.SIZE_SCROLL_STEP:f.SIZE_SCROLL_STEP),behavior:"smooth"}),t.selectElement.classList.remove("fn__none"),J(["gutter"],t);let x=0,C=0,T=0,I=0;if(L.clientX<y?(L.clientX<o?C=o:C=L.clientX,T=y-C):L.clientX>r?(C=y,T=r-C):(C=y,T=L.clientX-y),L.clientY>d?L.clientY>c?(x=d,I=c-d):(x=d,I=L.clientY-d):(L.clientY<_?x=_:x=L.clientY,I=d-x),I<4)return;t.selectElement.setAttribute("style",`background-color: ${t.selectElement.style.backgroundColor};top:${x}px;height:${I}px;left:${C+2}px;width:${T-2}px;`);const P=document.elementFromPoint(L.clientX,L.clientY);if(w&&w.isSameNode(P)&&!w.classList.contains("protyle-wysiwyg")&&!w.classList.contains("list")&&!w.classList.contains("bq")&&!w.classList.contains("sb"))return;w=P,J(["select"],t);let N;if(L.clientY>d?(N=h||document.elementFromPoint(C,x),E=void 0):(N=document.elementFromPoint(C,x),h=void 0),!N||((N.classList.contains("protyle-wysiwyg")||N.classList.contains("list")||N.classList.contains("li")||N.classList.contains("sb")||N.classList.contains("bq"))&&(N=document.elementFromPoint(C,x+16)),!N))return;let R=B(N);!R&&N.classList.contains("protyle-breadcrumb__bar")&&(R=N.nextElementSibling),L.clientY>d?h||(R||(R=t.wysiwyg.element.firstElementChild,R.classList.contains("protyle-breadcrumb__bar")&&(R=R.nextElementSibling)),h=R):!R&&L.clientY<t.wysiwyg.element.lastElementChild.getBoundingClientRect().bottom&&(R=t.wysiwyg.element.firstElementChild,R.classList.contains("protyle-breadcrumb__bar")&&(R=R.nextElementSibling));let V=[],W=R;if(W){const fe=re(W);fe&&(W=fe)}let se=!1;const Ce=E?E.getBoundingClientRect().bottom:x+I;for(;W;)if(W&&!W.classList.contains("protyle-attr")){const fe=W.getBoundingClientRect();if(fe.height>0&&fe.top<Ce&&fe.left<C+T)if(se)if(W.nextElementSibling&&!W.nextElementSibling.classList.contains("protyle-attr")){const be=W.nextElementSibling.getBoundingClientRect();if(be.top<Ce&&be.left<C+T)V=[W],W=W.nextElementSibling,se=!1;else if(W.parentElement.classList.contains("sb"))W=B(W.parentElement),se=!0;else break}else W=B(W.parentElement),se=!0;else W.classList.contains("protyle-breadcrumb__bar")||V.push(W),W=W.nextElementSibling;else if(W.parentElement.classList.contains("sb"))W=B(W.parentElement),se=!0;else if(fe.height===0&&fe.width===0&&W.parentElement.getAttribute("fold")==="1")W=W.parentElement,V=[];else break}else W=B(W.parentElement),se=!0;L.clientY<=d&&!E&&(E=V[V.length-1]),V.length===1&&!V[0].classList.contains("list")&&!V[0].classList.contains("bq")&&!V[0].classList.contains("sb")?t.selectElement.style.backgroundColor="transparent":(V.forEach(fe=>{$(fe,"protyle-wysiwyg__embed")||fe.classList.add("protyle-wysiwyg--select")}),t.selectElement.style.backgroundColor="")},i.onmouseup=L=>{var k;if(i.onmousemove=null,i.onmouseup=null,i.ondragstart=null,i.onselectstart=null,i.onselect=null,h=void 0,E=void 0,this.element.querySelectorAll("iframe").forEach(T=>{T.style.pointerEvents=""}),t.selectElement.classList.add("fn__none"),t.selectElement.removeAttribute("style"),m){m.firstElementChild.style.webkitUserModify="";const T=m.querySelector(".table__select");if(T.getAttribute("style")){if(getSelection().rangeCount>0&&getSelection().getRangeAt(0).collapse(!1),window.siyuan.menus.menu.remove(),t.disabled||(window.siyuan.menus.menu.append(new M({label:window.siyuan.languages.mergeCell,click:()=>{if(m){const I=[],P=[],N=m.querySelectorAll("th").length;let R=0;const V=m.firstElementChild.scrollLeft;let W=!1,se=!1;m.querySelectorAll("th, td").forEach((xe,Xt)=>{xe.classList.contains("fn__none")?(xe.previousElementSibling&&xe.previousElementSibling.isSameNode(I[I.length-1])||Xt<R&&P.includes((Xt+1)%N))&&(I.push(xe),!W&&xe.parentElement.parentElement.tagName==="THEAD"?W=!0:!se&&xe.parentElement.parentElement.tagName==="TBODY"&&(se=!0)):xe.offsetLeft+6>T.offsetLeft+V&&xe.offsetLeft+xe.clientWidth-6<T.offsetLeft+V+T.clientWidth&&xe.offsetTop+6>T.offsetTop&&xe.offsetTop+xe.clientHeight-6<T.offsetTop+T.clientHeight&&(I.push(xe),!W&&xe.parentElement.parentElement.tagName==="THEAD"?W=!0:!se&&xe.parentElement.parentElement.tagName==="TBODY"&&(se=!0),P.push((Xt+1)%N),R=Math.max((xe.rowSpan-1)*N+Xt+1,R))}),T.removeAttribute("style");const Ce=m.outerHTML;let fe=I[0],be=fe.colSpan,pt=1;for(;fe.nextElementSibling&&fe.nextElementSibling.isSameNode(I[pt]);)fe=fe.nextElementSibling,fe.classList.contains("fn__none")||(be+=fe.colSpan),pt++;let vt="",he=I[0].parentElement,$n=I[0].rowSpan;if(I.forEach((xe,Xt)=>{let le=xe.innerHTML.trim();le.endsWith("<br>")&&(le=le.substr(0,le.length-4)),vt+=le+(!le||Xt===I.length-1?"":"<br>"),Xt!==0&&(he.isSameNode(xe.parentElement)||(xe.classList.contains("fn__none")||($n+=xe.rowSpan),he=xe.parentElement,I[0].parentElement.parentElement.tagName==="THEAD"&&xe.parentElement.parentElement.tagName!=="THEAD"&&I[0].parentElement.parentElement.insertAdjacentElement("beforeend",xe.parentElement)),xe.classList.add("fn__none"),xe.innerHTML="")}),W&&se)for(he=he.parentElement.nextElementSibling.firstElementChild;he&&he.parentElement.tagName!=="THEAD";){let xe=0,Xt=0;if(Array.from(he.children).forEach(le=>{xe+=le.colSpan-1,le.classList.contains("fn__none")&&Xt++}),xe!==Xt)I[0].parentElement.parentElement.insertAdjacentElement("beforeend",he),he=he.parentElement.nextElementSibling.firstElementChild;else break}setTimeout(()=>{m&&(I[0].innerHTML=vt+"<wbr>",I[0].colSpan=be,I[0].rowSpan=$n,ue(I[0],document.createRange()),K(t,m.getAttribute("data-node-id"),m.outerHTML,Ce))})}}}).element),window.siyuan.menus.menu.append(new M({type:"separator"}).element),window.siyuan.menus.menu.append(new M({icon:"iconAlignLeft",accelerator:window.siyuan.config.keymap.editor.general.alignLeft.custom,label:window.siyuan.languages.alignLeft,click:()=>{if(m){const I=[],P=m.firstElementChild.scrollLeft;m.querySelectorAll("th, td").forEach(N=>{!N.classList.contains("fn__none")&&N.offsetLeft+6>T.offsetLeft+P&&N.offsetLeft+N.clientWidth-6<T.offsetLeft+P+T.clientWidth&&N.offsetTop+6>T.offsetTop&&N.offsetTop+N.clientHeight-6<T.offsetTop+T.clientHeight&&(I.length===0||I.length>0&&N.offsetTop===I[0].offsetTop)&&I.push(N)}),T.removeAttribute("style"),kn(t,I,m,"left",ye(m))}}}).element),window.siyuan.menus.menu.append(new M({icon:"iconAlignCenter",accelerator:window.siyuan.config.keymap.editor.general.alignCenter.custom,label:window.siyuan.languages.alignCenter,click:()=>{if(m){const I=[],P=m.firstElementChild.scrollLeft;m.querySelectorAll("th, td").forEach(N=>{!N.classList.contains("fn__none")&&N.offsetLeft+6>T.offsetLeft+P&&N.offsetLeft+N.clientWidth-6<T.offsetLeft+P+T.clientWidth&&N.offsetTop+6>T.offsetTop&&N.offsetTop+N.clientHeight-6<T.offsetTop+T.clientHeight&&(I.length===0||I.length>0&&N.offsetTop===I[0].offsetTop)&&I.push(N)}),T.removeAttribute("style"),kn(t,I,m,"center",ye(m))}}}).element),window.siyuan.menus.menu.append(new M({icon:"iconAlignRight",accelerator:window.siyuan.config.keymap.editor.general.alignRight.custom,label:window.siyuan.languages.alignRight,click:()=>{if(m){const I=[],P=m.firstElementChild.scrollLeft;m.querySelectorAll("th, td").forEach(N=>{!N.classList.contains("fn__none")&&N.offsetLeft+6>T.offsetLeft+P&&N.offsetLeft+N.clientWidth-6<T.offsetLeft+P+T.clientWidth&&N.offsetTop+6>T.offsetTop&&N.offsetTop+N.clientHeight-6<T.offsetTop+T.clientHeight&&(I.length===0||I.length>0&&N.offsetTop===I[0].offsetTop)&&I.push(N)}),T.removeAttribute("style"),kn(t,I,m,"right",ye(m))}}}).element),window.siyuan.menus.menu.append(new M({icon:"",label:window.siyuan.languages.useDefaultAlign,click:()=>{if(m){const I=[],P=m.firstElementChild.scrollLeft;m.querySelectorAll("th, td").forEach(N=>{!N.classList.contains("fn__none")&&N.offsetLeft+6>T.offsetLeft+P&&N.offsetLeft+N.clientWidth-6<T.offsetLeft+P+T.clientWidth&&N.offsetTop+6>T.offsetTop&&N.offsetTop+N.clientHeight-6<T.offsetTop+T.clientHeight&&(I.length===0||I.length>0&&N.offsetTop===I[0].offsetTop)&&I.push(N)}),T.removeAttribute("style"),kn(t,I,m,"",ye(m))}}}).element),window.siyuan.menus.menu.append(new M({type:"separator"}).element)),window.siyuan.menus.menu.append(new M({icon:"iconCopy",accelerator:"\u2318C",label:window.siyuan.languages.copy,click(){m&&(X(ye(m)),document.execCommand("copy"))}}).element),!t.disabled){let I;window.siyuan.menus.menu.append(new M({icon:"iconCut",accelerator:"\u2318X",label:window.siyuan.languages.cut,click(){m&&(X(ye(m)),document.execCommand("cut"))}}).element),window.siyuan.menus.menu.append(new M({label:window.siyuan.languages.clear,icon:"iconTrashcan",accelerator:"\u2326",click(){_r(t,m)}}).element),window.siyuan.menus.menu.append(new M({label:window.siyuan.languages.paste,icon:"iconPaste",accelerator:"\u2318V",click(){return Hg(this,null,function*(){if(document.queryCommandSupported("paste"))document.execCommand("paste");else if(m)try{const P=yield al();qi(t,Object.assign(P,{target:m}))}catch(P){console.log(P)}})}}).element)}window.siyuan.menus.menu.popup({x:L.clientX-8,y:L.clientY-16})}}const x=[],C=t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(C.forEach(T=>{x.push(T.getAttribute("data-node-id"))}),Ht(x),getSelection().rangeCount>0){const T=getSelection().getRangeAt(0);if((T.toString()===""||window.siyuan.shiftIsPressed)&&n.detail>2){let N=B(T.startContainer);if(N){if((k=N.nextElementSibling)!=null&&k.classList.contains("table"))nt(oe(N),T,!1);else if(N.classList.contains("table")){const R=N.querySelectorAll("th, td");N=R[R.length-1],N.contains(T.startContainer)&&nt(N,T,!1)}}return}if(C.length>0){T.collapse(!0);return}const I=B(T.startContainer);let P;L.detail>2&&T.endContainer.nodeType!==3&&T.endContainer.tagName==="DIV"&&T.endOffset===0?T.endContainer.classList.contains("protyle-attr")&&I&&nt(oe(I),T,!1):P=B(T.endContainer),I&&P&&!P.isSameNode(I)&&(T.startContainer.nodeType===1&&T.startContainer.tagName==="DIV"&&T.startContainer.classList.contains("protyle-attr")||n.clientY>L.clientY?ya(oe(P),T):T.endOffset===0&&T.endContainer.nodeType===1&&T.endContainer.tagName==="DIV"?nt(oe(I),T,!1):T.collapse(!0))}}})}bindEvent(t){t.observer=new ResizeObserver(()=>{const l=t.contentElement.getBoundingClientRect();t.wysiwyg.element.querySelectorAll(".av").forEach(o=>{o.querySelector(".av__title")&&da(o,l,"all")})}),this.element.addEventListener("focusout",()=>{if(getSelection().rangeCount===0)return;const l=getSelection().getRangeAt(0);(this.element.isSameNode(l.startContainer)||this.element.contains(l.startContainer))&&(t.toolbar.range=l)}),this.element.addEventListener("cut",l=>{var o,r,c;if(window.siyuan.ctrlIsPressed=!1,t.disabled)return;if(l.target.tagName==="PROTYLE-HTML"||l.target.localName==="input"){l.stopPropagation();return}t.options.render.breadcrumb&&t.breadcrumb.hide();const d=ye(t.wysiwyg.element);let u=B(d.startContainer);if(!u){l.stopPropagation(),l.preventDefault();return}const p=re(u);p&&(u=p),l.stopPropagation(),l.preventDefault();const g=u.querySelector(".img--select"),m=u.querySelector(".av__row--select, .av__cell--select"),b=((o=u.querySelector(".table__select"))==null?void 0:o.clientWidth)>0;let y=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));y.length===0&&d.toString()===""&&!d.cloneContents().querySelector("img")&&!g&&!m&&!b&&(u.classList.add("protyle-wysiwyg--select"),y=[u]);let _="",w="";if(y.length>0){y[0].getAttribute("data-type")==="NodeListItem"&&y[0].parentElement.classList.contains("list")&&y[0].parentElement.childElementCount-1===y.length?_=y[0].parentElement.outerHTML:(y.forEach(h=>{const E=Ne(h);h.getAttribute("data-type")==="NodeHeading"&&h.getAttribute("fold")==="1"?_+=rs(E).replace('fold="1"',""):_+=rs(E)}),y[0].getAttribute("data-type")==="NodeListItem"&&(_=`<div data-subtype="${y[0].getAttribute("data-subtype")}" data-node-id="${Lute.NewNodeID()}" data-type="NodeList" class="list">${_}<div class="protyle-attr" contenteditable="false">${f.ZWSP}</div></div>`));const v=et(y[y.length-1]);ln(t,u,d,"remove"),v&&ne(v)}else if(m){const v=zt(t,u);_=JSON.stringify(v.json),w=v.text}else if(b){const v=[],h=u.firstElementChild.scrollLeft,E=u.querySelector(".table__select");if(_="<table>",u.querySelectorAll("th, td").forEach(L=>{!L.classList.contains("fn__none")&&L.offsetLeft+6>E.offsetLeft+h&&L.offsetLeft+L.clientWidth-6<E.offsetLeft+h+E.clientWidth&&L.offsetTop+6>E.offsetTop&&L.offsetTop+L.clientHeight-6<E.offsetTop+E.clientHeight&&v.push(L)}),E.removeAttribute("style"),getSelection().rangeCount>0){const L=getSelection().getRangeAt(0);u.contains(L.startContainer)&&L.insertNode(document.createElement("wbr"))}const S=u.outerHTML;(r=u.querySelector("wbr"))==null||r.remove(),u.setAttribute("updated",U().format("YYYYMMDDHHmmss")),v.forEach((L,k)=>{(k===0||!L.previousElementSibling||!L.previousElementSibling.isSameNode(v[k-1]))&&(_+="<tr>"),_+=L.outerHTML,(!L.nextElementSibling||!v[k+1]||!L.nextElementSibling.isSameNode(v[k+1]))&&(_+="</tr>"),L.innerHTML=""}),_+="</table>",w=t.lute.HTML2Md(_),K(t,u.getAttribute("data-node-id"),u.outerHTML,S)}else{const v=u.getAttribute("data-node-id");fi(u,d,t);const h=t.wysiwyg.lastHTMLs[v]||u.outerHTML,E=document.createElement("div");let S=d.startContainer;if(S.nodeType===3&&S.textContent===""){const k=Fe(d.startContainer);k&&(S=k)}const L=D(S,"data-type","NodeHeading");if(L&&d.toString()===L.firstElementChild.textContent)E.insertAdjacentHTML("afterbegin",L.firstElementChild.innerHTML),L.firstElementChild.innerHTML="";else if(d.toString()!==""&&S.isSameNode(d.endContainer)&&d.startContainer.nodeType===3&&d.endOffset===d.endContainer.textContent.length&&d.startOffset===0&&!["DIV","TD","TH","TR"].includes(d.startContainer.parentElement.tagName))E.append(d.startContainer.parentElement);else if(g)E.append(g);else if(d.startContainer.nodeType===3&&d.startContainer.parentElement.tagName==="SPAN"&&d.startContainer.parentElement.getAttribute("data-type")&&d.startContainer.parentElement.isSameNode(d.endContainer.parentElement)){const k=d.startContainer.parentElement,x=k.attributes,C=document.createElement("span");for(let T=0;T<x.length;T++)C.setAttribute(x[T].name,x[T].value);k.getAttribute("data-type").indexOf("block-ref")>-1&&k.getAttribute("data-subtype")==="d"&&(C.setAttribute("data-subtype","s"),k.setAttribute("data-subtype","s")),C.textContent=d.toString(),d.deleteContents(),E.append(C)}else if(d.cloneContents().querySelectorAll("td, th").length>0){const k=document.createElement("wbr");d.insertNode(k),d.setStartAfter(k),E.append(d.extractContents()),u.outerHTML=t.lute.SpinBlockDOM(u.outerHTML),u=t.wysiwyg.element.querySelector(`[data-node-id="${v}"]`),_n(u),ue(u,d)}else{const k=D(d.commonAncestorContainer,"data-type","inline-math");if(k)E.append(k);else{E.append(d.extractContents());let x;u.classList.contains("av")?fl(t,u):u.classList.contains("table")?x=O(d.startContainer,"TD")||O(d.startContainer,"TH"):x=oe(u),x&&Array.from(x.children).forEach(C=>{C.textContent===""&&C.nodeType===1&&!["BR","IMG"].includes(C.tagName)&&C.remove()})}}if(this.emojiToMd(E),_=E.innerHTML,(D(d.startContainer,"data-type","NodeCodeBlock")||O(d.startContainer,"CODE"))&&(w=E.textContent.replace(f.ZWSP,"")),!u.classList.contains("table")){const k=oe(u);k&&k.textContent===""&&(k.innerHTML="")}u.setAttribute("updated",U().format("YYYYMMDDHHmmss")),u.getAttribute("data-type")==="NodeCodeBlock"&&(d.insertNode(document.createElement("wbr")),(c=u.querySelector('[data-render="true"]'))==null||c.removeAttribute("data-render"),Pe(u)),u.parentElement.parentElement&&!u.classList.contains("av")&&(fi(u,d,t),K(t,v,t.wysiwyg.lastHTMLs[v]||u.outerHTML,h))}t.hint.render(t),m||(w=w||t.lute.BlockDOM2StdMd(_).trimEnd()),w=w.replace(/\u00A0/g," "),l.clipboardData.setData("text/plain",w),l.clipboardData.setData("text/html",b?_:t.lute.BlockDOM2HTML(m?w:_)),l.clipboardData.setData("text/siyuan",b?t.lute.HTML2BlockDOM(_):_)});let n;this.element.addEventListener("contextmenu",l=>{var o,r,c,d,u;if(l.shiftKey)return;l.stopPropagation(),l.preventDefault();const p=l.clientX||l.detail.x,g=l.clientY||l.detail.y,m=t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(m.length>1){J(["util"],t),t.gutter.renderMenu(t,m[0]),window.siyuan.menus.menu.popup({x:p,y:g});return}const b=l.detail.target||l.target,y=re(b);if(y)return getSelection().rangeCount===0&&el(y),t.gutter.renderMenu(t,y),window.siyuan.menus.menu.fullscreen(),!1;const _=B(b);if(!_)return!1;const w=$(b,"av__cell");if(w){if(w.classList.contains("av__cell--header")){t.disabled||kc(t,_,w),l.stopPropagation(),l.preventDefault();return}if(Bt(w)==="mAsset"){const S=$(b,"av__cellassetimg")||$(b,"av__celltext--url");if(S){let L=0;Array.from(w.children).find((k,x)=>{if(k===S)return L=x,!0}),_s({protyle:t,cellElements:[w],blockElement:B(S),content:b.tagName==="IMG"?b.getAttribute("src"):b.getAttribute("data-url"),type:b.tagName==="IMG"?"image":"file",name:b.tagName==="IMG"?"":b.getAttribute("data-name"),index:L,rect:b.getBoundingClientRect()}),l.stopPropagation(),l.preventDefault();return}}}const v=$(b,"av__row");if(v&&ls(t,v,{x:l.clientX,y:v.getBoundingClientRect().bottom,h:v.clientHeight})){l.stopPropagation(),l.preventDefault();return}const h=$(b,"item");if(_.classList.contains("av")&&h){h.classList.contains("item--focus")?hi({protyle:t,blockElement:_,element:h}):(_.removeAttribute("data-render"),ze(_,t,()=>{hi({protyle:t,blockElement:_,element:_.querySelector(".item.item--focus")})},h.dataset.id)),l.stopPropagation(),l.preventDefault();return}if(t.toolbar.range=ye(t.element),b.tagName==="SPAN"&&!At(_)){let S=((o=b.getAttribute("data-type"))==null?void 0:o.split(" "))||[];if(S.length===0&&(S=(b.dataset.type||"").split(" ")),S.length>0&&Er(b),S.includes("block-ref"))return Il(t,b),b.setAttribute("prevent-popover","true"),setTimeout(()=>{b.removeAttribute("prevent-popover")},620),!1;if(S.includes("file-annotation-ref")&&!t.disabled)return $l(t,b),!1;if(S.includes("tag")&&!t.disabled)return Hl(t,b),!1;if(S.includes("inline-memo"))return t.toolbar.showRender(t,b),!1;if(S.includes("a"))return Ai(t,b),window.siyuan.config.editor.floatWindowMode===0&&((r=b.getAttribute("data-href"))!=null&&r.startsWith("siyuan://blocks"))&&(b.setAttribute("prevent-popover","true"),setTimeout(()=>{b.removeAttribute("prevent-popover")},620)),!1}const E=D(b,"data-type","inline-math");if(E)return bs(t,E),!1;if(b.tagName==="IMG"&&$(b,"img"))return Ml(t,t.toolbar.range,b.parentElement.parentElement,{clientX:p+4,clientY:g}),!1;!At(_)&&!_.classList.contains("protyle-wysiwyg--select")&&!$(b,"protyle-action")&&(H()||l.detail.target||n&&_.contains(n.startContainer))?(!H()||(c=t.toolbar)!=null&&c.element.classList.contains("fn__none"))&&!_.classList.contains("av")&&(Cf(t,_),window.siyuan.menus.menu.popup({x:p,y:g+13,h:26}),(d=t.toolbar)==null||d.element.classList.add("fn__none"),_.classList.contains("table")&&_.querySelector(".table__select").removeAttribute("style")):t.toolbar.range.toString()===""&&(J(["util"],t),t.gutter&&t.gutter.renderMenu(t,_),window.siyuan.menus.menu.fullscreen(),(u=t.toolbar)==null||u.element.classList.add("fn__none"))}),this.element.addEventListener("pointerdown",()=>{getSelection().rangeCount>0?n=getSelection().getRangeAt(0):n=void 0});let a=!1;this.element.addEventListener("mousewheel",l=>{if(un(),!a&&l.deltaY<0&&!t.scroll.element.classList.contains("fn__none")&&t.contentElement.clientHeight===t.contentElement.scrollHeight&&t.wysiwyg.element.firstElementChild.getAttribute("data-eof")!=="1"&&(A("/api/filetree/getDoc",{id:t.wysiwyg.element.firstElementChild.getAttribute("data-node-id"),mode:1,size:window.siyuan.config.editor.dynamicLoadBlocks},r=>{a=!1,Qe({data:r,protyle:t,action:[f.CB_GET_BEFORE,f.CB_GET_UNCHANGEID]})}),a=!0),l.deltaX===0)return;const o=$(l.target,"table");if(o){const r=o.querySelector(".table__select");r!=null&&r.style.width&&(r.removeAttribute("style"),window.siyuan.menus.menu.remove())}},{passive:!0}),this.element.addEventListener("paste",l=>{if(l.target.localName==="input"&&l.target.getAttribute("data-type")==="av-search")return;if(t.disabled){l.stopPropagation(),l.preventDefault();return}if(window.siyuan.ctrlIsPressed=!1,l.target.tagName==="PROTYLE-HTML"||l.target.localName==="input"){l.stopPropagation();return}if(!D(l.target,"contenteditable","true")){l.stopPropagation(),l.preventDefault();return}const o=B(l.target);if(o&&!oe(o)){l.stopPropagation(),l.preventDefault();return}if(!o)return;const r=getSelection().getRangeAt(0),c=r.startContainer.parentElement;if(r.toString()===""&&c.tagName==="SPAN"){const d=(c.getAttribute("data-type")||"").split(" ");if(d.includes("inline-memo")||d.includes("text")||d.includes("block-ref")||d.includes("file-annotation-ref")||d.includes("a")){const u=Je(c,o,r);u.start===0?(r.setStartBefore(c),r.collapse(!0)):u.start===c.textContent.length&&(r.setEndAfter(c),r.collapse(!1))}}qi(t,l)});let s=!1;this.element.addEventListener("compositionstart",l=>{s=!0;const o=ye(t.wysiwyg.element),r=B(o.startContainer);!Lt()&&r&&fi(r,o,t),l.stopPropagation()}),this.element.addEventListener("compositionend",l=>{l.stopPropagation(),s=!1;const o=ye(this.element),r=B(o.startContainer);if(r)if(l.data!=="")this.escapeInline(t,o,l),hs(t,r,o,!0);else{const c=r.getAttribute("data-node-id");t.wysiwyg.lastHTMLs[c]&&K(t,c,r.outerHTML,t.wysiwyg.lastHTMLs[c])}});let i;this.element.addEventListener("input",l=>{const o=l.target;if(o.tagName==="VIDEO"||o.tagName==="AUDIO"||l.inputType==="historyRedo")return;if(l.inputType==="historyUndo"){window.siyuan.menus.menu.remove();return}const r=ye(this.element),c=B(r.startContainer);c&&([":","(","\u3010","\uFF08","[","{","\u300C","\u300E","#","/","\u3001"].includes(l.data)&&(t.hint.enableExtend=!0),!(l.isComposing||s||l.inputType==="deleteByDrag"||l.inputType==="insertFromDrop")&&(this.escapeInline(t,r,l),/^\d{1}$/.test(l.data)||l.data==="\u2018"||l.data==="\u201C"||l.data==="\u201D"||l.data==="\u300C"?(clearTimeout(i),i=window.setTimeout(()=>{hs(t,c,r,!0)})):hs(t,c,r,!0,l),l.stopPropagation()))}),this.element.addEventListener("keyup",l=>{const o=ye(this.element).cloneRange(),r=B(o.startContainer);if(l.key!=="PageUp"&&l.key!=="PageDown"&&l.key!=="Home"&&l.key!=="End"&&l.key.indexOf("Arrow")===-1&&l.key!=="Escape"&&l.key!=="Shift"&&l.key!=="Meta"&&l.key!=="Alt"&&l.key!=="Control"&&l.key!=="CapsLock"&&!l.ctrlKey&&!l.shiftKey&&!l.metaKey&&!l.altKey&&!/^F\d{1,2}$/.test(l.key)){!Lt()&&r&&!s&&(typeof t.wysiwyg.lastHTMLs[r.getAttribute("data-node-id")]=="undefined"||o.toString()!==""||!this.preventKeyup)&&fi(r,o,t),this.preventKeyup=!1;return}if(this.preventKeyup){this.preventKeyup=!1;return}if((l.shiftKey||bt(l))&&!l.isComposing&&o.toString()!==""&&(t.toolbar.render(t,o,l),ui(o)),l.eventPhase!==3&&!l.shiftKey&&(l.key.indexOf("Arrow")>-1||l.key==="Home"||l.key==="End"||l.key==="PageUp"||l.key==="PageDown")&&!l.isComposing){if(r&&(this.setEmptyOutline(t,r),o.toString()===""&&!r.classList.contains("protyle-wysiwyg--select")&&ui(o,t.block.rootID),t.breadcrumb)){const c=t.breadcrumb.element.parentElement.querySelector('[data-type="indent"]');if(c){const d=t.breadcrumb.element.parentElement.querySelector('[data-type="outdent"]');r.parentElement.classList.contains("li")?(c.removeAttribute("disabled"),d.removeAttribute("disabled")):(c.setAttribute("disabled","true"),d.setAttribute("disabled","true"))}}l.stopPropagation()}if((l.key==="ArrowLeft"||l.key==="ArrowRight")&&r&&!r.classList.contains("protyle-wysiwyg--select")){const c=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));let d=!1;c.find(u=>{if(u.contains(o.startContainer))return d=!0,!0}),!d&&c.length>0&&(c.forEach(u=>{u.classList.remove("protyle-wysiwyg--select")}),r.classList.add("protyle-wysiwyg--select"))}}),this.element.addEventListener("dblclick",l=>{if(l.target.tagName==="IMG"&&!l.target.classList.contains("emoji")){nr(l.target.getAttribute("src"),t.block.rootID);return}}),this.element.addEventListener("click",l=>{if(this.preventClick){this.preventClick=!1;return}t.app.plugins.forEach(C=>{C.eventBus.emit("click-editorcontent",{protyle:t,event:l})}),J(["hint","util"],t);const o=bt(l);l.shiftKey||(this.shiftStartElement=void 0),this.setEmptyOutline(t,l.target);const r=$(l.target,"table");this.element.querySelectorAll(".table").forEach(C=>{(!r||!C.isSameNode(r))&&C.querySelector(".table__select").removeAttribute("style"),r&&r.isSameNode(C)&&C.querySelector(".table__select").getAttribute("style")&&l.stopPropagation()}),t.options.render.breadcrumb&&t.breadcrumb.render(t,!1,B(l.target));const c=ye(this.element);c.startContainer.nodeType!==3&&c.startContainer.classList.contains("protyle-action")&&c.startContainer.parentElement.classList.contains("code-block")&&ya(c.startContainer.parentElement.querySelector(".hljs").lastElementChild,c);const d=D(l.target,"data-type","a")||$(l.target,"av__celltext--url");let u=d&&d.getAttribute("data-href")||"";d&&!u&&d.classList.contains("av__celltext--url")&&(u=d.textContent.trim(),d.dataset.type==="phone"?u="tel:"+u:d.dataset.type==="email"?u="mailto:"+u:d.classList.contains("b3-chip")&&(u=d.dataset.url));const p=D(l.target,"data-type","block-ref");if((p||u.startsWith("siyuan://blocks/"))&&(l.stopPropagation(),l.preventDefault(),J(["dialog","toolbar"],t),c.toString()===""||l.shiftKey)){let C;p?C=p.getAttribute("data-id"):d&&(C=u.substring(16,38)),Mn(C,(T,I,P)=>{P||I.push(f.CB_GET_HL),at(t.app,C,T?[f.CB_GET_ALL]:[f.CB_GET_HL,f.CB_GET_CONTEXT,f.CB_GET_ROOTSCROLL]),fn(),tn()});return}const g=D(l.target,"data-type","virtual-block-ref");if(g){const C=B(g);C&&A("/api/block/getBlockDefIDsByRefText",{anchor:g.textContent,excludeIDs:[C.getAttribute("data-node-id")]},T=>{Mn(T.data[0],I=>{at(t.app,T.data[0],I?[f.CB_GET_ALL]:[f.CB_GET_HL,f.CB_GET_CONTEXT,f.CB_GET_ROOTSCROLL]),fn(),tn()})});return}const m=D(l.target,"data-type","file-annotation-ref");if(m&&c.toString()===""){l.stopPropagation(),l.preventDefault(),Ci(t,m.getAttribute("data-id"),l,o);return}if(d&&(l.shiftKey||c.toString()==="")&&u){l.stopPropagation(),l.preventDefault(),Ci(t,u,l,o);return}if(d&&d.classList.contains("av__celltext--url")&&!u){let C=0;Array.from(d.parentElement.children).find((T,I)=>{if(T===d)return C=I,!0}),_s({protyle:t,cellElements:[d.parentElement],blockElement:B(d),content:d.getAttribute("data-url"),type:"file",name:d.getAttribute("data-name"),index:C,rect:d.getBoundingClientRect()});return}const b=D(l.target,"data-type","tag");if(b&&!l.altKey&&!l.shiftKey&&c.toString()===""){qt(t.app,{hasReplace:!1,method:0,hPath:"",idPath:[],k:`#${b.textContent}#`,r:"",page:1});return}const y=$(l.target,"protyle-wysiwyg__embed");if(y){const C=y.getAttribute("data-id");if(Mn(C,(T,I)=>{at(t.app,C,T?[f.CB_GET_ALL]:[f.CB_GET_HL,f.CB_GET_CONTEXT,f.CB_GET_ROOTSCROLL]),fn(),tn()}),!o){l.stopPropagation();return}}if(dd(l,t)||Q(l.target,"protyle-action__copy"))return;const _=$(l.target,"protyle-action__edit");if(_&&!t.disabled){t.toolbar.showRender(t,_.parentElement.parentElement),l.stopPropagation(),l.preventDefault();return}const w=$(l.target,"protyle-action__menu");if(w){t.gutter.renderMenu(t,w.parentElement.parentElement),window.siyuan.menus.menu.fullscreen(),l.stopPropagation(),l.preventDefault();return}const v=$(l.target,"protyle-action__reload");if(v){const C=re(v);C&&(C.removeAttribute("data-render"),Se(t,C)),l.stopPropagation(),l.preventDefault();return}const h=$(l.target,"protyle-action__language");if(h&&!t.disabled&&!o){t.toolbar.showCodeLanguage(t,h),l.stopPropagation(),l.preventDefault();return}const E=D(l.target,"data-subtype","math");if(!l.shiftKey&&!o&&E&&!t.disabled){t.toolbar.showRender(t,E),l.stopPropagation();return}const S=$(l.target,"protyle-action");if(S){if(S.parentElement.parentElement.getAttribute("data-type")==="img"&&!t.disabled){Ml(t,c,S.parentElement.parentElement,{clientX:l.clientX+4,clientY:l.clientY}),l.stopPropagation();return}else if(S.parentElement.classList.contains("li")){const T=S.parentElement.getAttribute("data-node-id");if(l.altKey&&!t.disabled){if(S.parentElement.parentElement.classList.contains("protyle-wysiwyg"))ht(t,S.parentElement);else{let I=!0;const P=S.parentElement.parentElement.outerHTML;Array.from(S.parentElement.parentElement.children).find(N=>{if(N.classList.contains("li")&&N.getAttribute("fold")!=="1"&&N.childElementCount>3)return I=!1,!0}),Array.from(S.parentElement.parentElement.children).find(N=>{N.classList.contains("li")&&(I?N.removeAttribute("fold"):N.childElementCount>3&&N.setAttribute("fold","1"))}),K(t,S.parentElement.parentElement.getAttribute("data-node-id"),S.parentElement.parentElement.outerHTML,P)}J(["gutter"],t)}else if(l.shiftKey&&!t.disabled)Kn(S.parentElement,"bookmark",t);else if(o)Ot({protyle:t,id:T});else if(S.classList.contains("protyle-action--task")){if(!t.disabled){const I=S.parentElement.outerHTML;S.parentElement.classList.contains("protyle-task--done")?(S.querySelector("use").setAttribute("xlink:href","#iconUncheck"),S.parentElement.classList.remove("protyle-task--done")):(S.querySelector("use").setAttribute("xlink:href","#iconCheck"),S.parentElement.classList.add("protyle-task--done")),S.parentElement.setAttribute("updated",U().format("YYYYMMDDHHmmss")),K(t,T,S.parentElement.outerHTML,I)}}else window.siyuan.config.editor.listItemDotNumberClickFocus&&(t.block.showAll&&t.block.id===T?Dl(t,T):Ot({protyle:t,id:T}));l.stopPropagation();return}}const L=$(l.target,"hr")||$(l.target,"iframe");if(!l.shiftKey&&!o&&L){L.classList.add("protyle-wysiwyg--select"),ud(l.target),l.stopPropagation();return}const k=Q(l.target,"img");if(!l.shiftKey&&!o&&k){k.classList.add("img--select");const C=Fe(k);C&&(C.textContent.startsWith(f.ZWSP)?c.setStart(C,1):c.setStart(C,0),c.collapse(!0),X(c),t.options.render.breadcrumb&&t.breadcrumb.render(t));return}const x=Q(l.target,"emoji");if(!t.disabled&&!l.shiftKey&&!o&&x){const C=B(x);if(C){const T=x.getBoundingClientRect();_a("","av",{x:T.left,y:T.bottom,h:T.height,w:T.width},I=>{x.insertAdjacentHTML("afterend","<wbr>");const P=C.outerHTML;let N;if(I.startsWith("api/icon/getDynamicIcon"))N=`<img class="emoji" src="${I}"/>`;else if(I.indexOf(".")>-1){const R=I.split(".");N=`<img alt="${R[0]}" class="emoji" src="/emojis/${I}" title="${R[0]}">`}else N=ge(I);x.outerHTML=N,J(["dialog"]),K(t,C.getAttribute("data-node-id"),C.outerHTML,P),ue(C,c)},x)}return}if(!qu(t,l)){if(setTimeout(()=>{let C=ye(this.element);const T=$(C.endContainer,"protyle-attr");T&&(C=nt(T.previousElementSibling,C,!1)),t.wysiwyg.element.querySelector(".protyle-wysiwyg--select")||ui(C,t.block.rootID),getSelection().rangeCount===0&&X(C)},H()||Qt()?520:0),t.hint.enableExtend=!1,l.shiftKey){l.preventDefault(),l.stopPropagation();let C=this.shiftStartElement,T=B(l.target);if(this.shiftStartElement&&T&&!this.shiftStartElement.isSameNode(T)){let I=!0;c.collapse(!0);const P=C.getBoundingClientRect(),N=T.getBoundingClientRect();let R=P.top,V=N.top;if(R===V&&(R=P.left,V=N.left),R>V){const fe=T;T=C,C=fe;const be=V;V=R,R=be,I=!1}let W=[],se=C,Ce=!1;for(;se;)if(se&&!se.classList.contains("protyle-attr")){const fe=se.getBoundingClientRect();if(P.top===N.top?fe.left<=V:fe.top<=V)if(Ce)if(se.nextElementSibling&&!se.nextElementSibling.classList.contains("protyle-attr")){const be=se.nextElementSibling.getBoundingClientRect();if(P.top===N.top?be.left<=V&&be.bottom<=N.bottom:be.top<=V)W=[se],se=se.nextElementSibling,Ce=!1;else if(se.parentElement.classList.contains("sb"))se=B(se.parentElement),Ce=!0;else break}else se=B(se.parentElement),Ce=!0;else W.push(se),se=se.nextElementSibling;else if(se.parentElement.classList.contains("sb"))se=B(se.parentElement),Ce=!0;else break}else se=B(se.parentElement),Ce=!0;if(W.length===1&&!W[0].classList.contains("list")&&!W[0].classList.contains("bq")&&!W[0].classList.contains("sb"))this.shiftStartElement=void 0;else{const fe=[];!t.wysiwyg.element.querySelector(".protyle-wysiwyg--select")&&t.scroll&&!t.scroll.element.classList.contains("fn__none")&&!t.scroll.keepLazyLoad&&(C.getBoundingClientRect().top<-t.contentElement.clientHeight*2||T.getBoundingClientRect().bottom>t.contentElement.clientHeight*2)&&ae(window.siyuan.languages.crossKeepLazyLoad),W.forEach(be=>{be.classList.add("protyle-wysiwyg--select"),fe.push(be.getAttribute("data-node-id")),be.querySelectorAll(".protyle-wysiwyg--select").forEach(pt=>{pt.classList.remove("protyle-wysiwyg--select")})}),Ht(fe),ne(I?W[W.length-1]:W[0],t.wysiwyg.element,!1)}}}if(this.element.querySelector(".protyle-wysiwyg--select")&&c.toString()!==""&&(c.collapse(!1),X(c)),o&&c.toString()===""&&!l.shiftKey&&!l.altKey){let C=B(l.target);if(C){const T=re(C);T&&(C=T),C=Ne(C),C.classList.contains("protyle-wysiwyg--select")?(C.classList.remove("protyle-wysiwyg--select"),C.removeAttribute("select-start"),C.removeAttribute("select-end")):C.classList.add("protyle-wysiwyg--select"),C.querySelectorAll(".protyle-wysiwyg--select").forEach(N=>{N.classList.remove("protyle-wysiwyg--select"),N.removeAttribute("select-start"),N.removeAttribute("select-end")});const I=$(C.parentElement,"protyle-wysiwyg--select");I&&(I.classList.remove("protyle-wysiwyg--select"),I.removeAttribute("select-start"),I.removeAttribute("select-end"));const P=[];t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").forEach(N=>{P.push(N.getAttribute("data-node-id"))}),Ht(P)}}}})}}class Pg{constructor(){this.element=document.createElement("div"),this.element.className="protyle-toolbar__divider"}}var qg=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{o(n.next(r))}catch(c){s(c)}},l=r=>{try{o(n.throw(r))}catch(c){s(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,l);o((n=n.apply(e,t)).next())});class Og extends Sa{constructor(t,n){super(t,n),this.element.addEventListener("click",a=>qg(this,null,function*(){t.toolbar.element.classList.add("fn__none"),a.stopPropagation();const s=t.toolbar.range;if(!B(s.startContainer))return;const l=D(s.startContainer,"data-type","a");if(l){Ai(t,l);return}const o=s.toString().trim().replace(f.ZWSP,"");let r="",c="";try{const d=yield nl();if(r=t.lute.GetLinkDest(o),r||(r=t.lute.GetLinkDest(d)),!r){const u=d.lastIndexOf(" ");u>-1&&(r=t.lute.GetLinkDest(d.substring(u)),r&&(c=d.substring(0,u)))}!r&&d.startsWith("assets/")&&(r=d)}catch(d){console.log(d)}t.toolbar.setInlineMark(t,"a","range",{type:"a",color:r+(c?f.ZWSP+c:"")})}))}}class Rg extends Sa{constructor(t,n){super(t,n),this.element.addEventListener("click",a=>{t.toolbar.range.toString()!==""&&(Xs(t.toolbar.range),fa(t.toolbar.range.toString(),t,"search"),t.toolbar.element.classList.add("fn__none"),a.stopPropagation())})}}var Bg=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{o(n.next(r))}catch(c){s(c)}},l=r=>{try{o(n.throw(r))}catch(c){s(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,l);o((n=n.apply(e,t)).next())});class Ug extends Sa{constructor(t,n){super(t,n),this.element.addEventListener("click",a=>Bg(this,null,function*(){t.toolbar.element.classList.add("fn__none"),a.stopPropagation();const s=t.toolbar.range;if(!B(s.startContainer))return;let l=D(s.startContainer,"data-type","inline-math");if(!l&&s.startContainer.nodeType!==3&&s.startContainer.childNodes[s.startOffset]){const o=ut(s.startContainer.childNodes[s.startOffset]);o&&o.nodeType!==3&&o.getAttribute("data-type").indexOf("inline-math")>-1&&(l=o)}if(!l&&s.startOffset===s.startContainer.textContent.length&&s.startContainer.nodeType===3){let o=!0,r=!1;if(s.cloneContents().childNodes.forEach(c=>{c.nodeType!==3&&(c.getAttribute("data-type")||"").indexOf("inline-math")>-1||c.nodeType==3&&c.textContent===""?r=!0:o=!1}),o&&r){const c=Fe(s.startContainer);if(c&&c.nodeType!==3&&c.getAttribute("data-type").indexOf("inline-math")>-1)l=c;else{const d=ut(s.startContainer);s.startOffset===0&&d&&d.nodeType!==3&&d.getAttribute("data-type").indexOf("inline-math")>-1&&(l=d)}}}if(l){t.toolbar.showRender(t,l);return}t.toolbar.setInlineMark(t,"inline-math","range",{type:"inline-math"})}))}}var Yg=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{o(n.next(r))}catch(c){s(c)}},l=r=>{try{o(n.throw(r))}catch(c){s(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,l);o((n=n.apply(e,t)).next())});class Fg extends Sa{constructor(t,n){super(t,n),this.element.addEventListener("click",a=>Yg(this,null,function*(){t.toolbar.element.classList.add("fn__none"),a.stopPropagation();const s=t.toolbar.range;if(!B(s.startContainer))return;const l=D(s.startContainer,"data-type","inline-memo");if(l&&l.textContent===s.toString()){t.toolbar.showRender(t,l);return}s.toString()!==""&&t.toolbar.setInlineMark(t,"inline-memo","range",{type:"inline-memo"})}))}}var Wg=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{o(n.next(r))}catch(c){s(c)}},l=r=>{try{o(n.throw(r))}catch(c){s(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,l);o((n=n.apply(e,t)).next())});class jg{constructor(t){const n=t.options,a=document.createElement("div");a.className="protyle-toolbar fn__none",this.element=a,this.subElement=document.createElement("div"),this.subElement.className="protyle-util fn__none protyle-util--mobile",this.toolbarHeight=29,t.app.plugins.forEach(s=>{const i=s.updateProtyleToolbar(n.toolbar);i.forEach(l=>{typeof l=="string"||f.INLINE_TYPE.concat("|").includes(l.name)||!l.hotkey||window.siyuan.config.keymap.plugin&&window.siyuan.config.keymap.plugin[s.name]&&window.siyuan.config.keymap.plugin[s.name][l.name]&&(l.hotkey=window.siyuan.config.keymap.plugin[s.name][l.name].custom)}),n.toolbar=us(i)}),n.toolbar.forEach(s=>{const i=this.genItem(t,s);this.element.appendChild(i)})}update(t){this.element.innerHTML="",t.options.toolbar=us(f.PROTYLE_TOOLBAR),t.app.plugins.forEach(n=>{const a=n.updateProtyleToolbar(t.options.toolbar);a.forEach(s=>{typeof s=="string"||f.INLINE_TYPE.concat("|").includes(s.name)||!s.hotkey||window.siyuan.config.keymap.plugin&&window.siyuan.config.keymap.plugin[n.name]&&window.siyuan.config.keymap.plugin[n.name][s.name]&&(s.hotkey=window.siyuan.config.keymap.plugin[n.name][s.name].custom)}),t.options.toolbar=us(a)}),t.options.toolbar.forEach(n=>{const a=this.genItem(t,n);this.element.appendChild(a)})}render(t,n,a){this.range=n;let s=B(n.startContainer);if(H()||!s||t.disabled||s.classList.contains("av")){this.element.classList.add("fn__none");return}let i=!1;if(Array.from(n.cloneContents().childNodes).find(u=>{if(u.textContent.length>0&&u.textContent!==f.ZWSP&&!(u.nodeType===1&&u.classList.contains("img")))return i=!0,!0}),!i||n.commonAncestorContainer.nodeType!==3&&n.commonAncestorContainer.classList.contains("img")){this.element.classList.add("fn__none");return}const l=B(n.startContainer),o=B(n.endContainer);if(l&&o&&!l.isSameNode(o)){if(a)if(a.key==="ArrowLeft")this.range=nt(oe(l),n,!1);else if(a.key==="ArrowRight")this.range=ya(oe(o),n),this.range.collapse(!1);else if(a.key==="ArrowUp"){if(this.range=ya(oe(o),n),s=B(o),!s)return}else a.key==="ArrowDown"&&(this.range=nt(oe(l),n,!1));else this.range=nt(oe(s),n,!1);if(X(this.range),this.range.toString()===""){this.element.classList.add("fn__none");return}}if(s.getAttribute("data-type")==="NodeCodeBlock"){this.element.classList.add("fn__none");return}const r=hn(s,n);this.element.classList.remove("fn__none"),this.toolbarHeight=this.element.clientHeight;const c=r.top-this.toolbarHeight-4;this.element.setAttribute("data-inity",c+f.ZWSP+t.contentElement.scrollTop.toString()),ke(this.element,r.left-52,Math.max(c,t.element.getBoundingClientRect().top+30)),this.element.querySelectorAll(".protyle-toolbar__item--current").forEach(u=>{u.classList.remove("protyle-toolbar__item--current")}),this.getCurrentType().forEach(u=>{if(["search-mark","a","block-ref","virtual-block-ref","text","file-annotation-ref","inline-math","inline-memo","","backslash"].includes(u))return;const p=this.element.querySelector(`[data-type="${u}"]`);p&&p.classList.add("protyle-toolbar__item--current")})}getCurrentType(t=this.range){var n,a;let s=[],i=t.startContainer;if(i.nodeType===3?i=i.parentElement:i.childElementCount>0&&((n=i.childNodes[t.startOffset])==null?void 0:n.nodeType)!==3&&(i=i.childNodes[t.startOffset]),!i||i.nodeType===3)return[];["DIV","TD","TH","TR"].includes(i.tagName)||(s=(i.getAttribute("data-type")||"").split(" "));let l=t.endContainer;return l.nodeType===3?l=l.parentElement:l.childElementCount>0&&((a=l.childNodes[t.endOffset])==null?void 0:a.nodeType)!==3&&(l=l.childNodes[t.endOffset]),!l||l.nodeType===3?[]:(!["DIV","TD","TH","TR"].includes(l.tagName)&&!i.isSameNode(l)&&(s=s.concat((l.getAttribute("data-type")||"").split(" "))),t.cloneContents().childNodes.forEach(o=>{o.nodeType!==3&&(s=s.concat((o.getAttribute("data-type")||"").split(" ")))}),s=[...new Set(s)],s.find((o,r)=>{if(o==="")return s.splice(r,1),!0}),s)}setInlineMark(t,n,a,s){var i;const l=B(this.range.startContainer);if(!l||l.getAttribute("data-type")==="NodeCodeBlock")return;const o=B(this.range.endContainer);if(!o)return;l.isSameNode(o)||(this.range=nt(oe(l),this.range,!1));const r=this.getCurrentType(this.range);if(r.length===1&&["block-ref","file-annotation-ref","a","inline-memo","inline-math","tag"].includes(r[0])&&n==="clear")return;const c=this.range.toString();Xs(this.range);let d,u,p,g;const m=ut(this.range.startContainer);["DIV","TD","TH","TR"].includes(this.range.startContainer.parentElement.tagName)?m&&m.nodeType!==3&&this.range.startOffset===0&&(d=m):this.range.startOffset===0&&!m?(d=this.range.startContainer.parentElement.previousSibling,this.range.setStartBefore(this.range.startContainer.parentElement)):d=this.range.startContainer.parentElement;let b=!1;const y=Fe(this.range.endContainer);["DIV","TD","TH","TR"].includes(this.range.endContainer.parentElement.tagName)?y&&y.nodeType!==3&&this.range.endOffset===this.range.endContainer.textContent.length&&(u=y):this.range.endOffset===this.range.endContainer.textContent.length&&!y?(u=this.range.endContainer.parentElement.nextSibling,this.range.setEndAfter(this.range.endContainer.parentElement),c===""&&(b=!0,this.range.collapse(!1))):u=this.range.endContainer.parentElement,this.range.insertNode(document.createElement("wbr"));const _=l.outerHTML,w=this.range.extractContents();if(this.mergeNode(w.childNodes),d&&u&&d.isSameNode(u)&&((i=w.firstChild)==null?void 0:i.nodeType)===3){const k=d.attributes;w.childNodes.forEach(x=>{const C=document.createElement("span");for(let T=0;T<k.length;T++)C.setAttribute(k[T].name,k[T].value);C.innerHTML=x.textContent,x.replaceWith(C)})}const v=H()?document.querySelector("#keyboardToolbar .keyboard__dynamic").nextElementSibling:this.element,h=a==="toolbar"?v.querySelector(`[data-type="${n}"]`):void 0,E=[];if(n==="clear"||h!=null&&h.classList.contains("protyle-toolbar__item--current")||a==="range"&&r.length>0&&r.includes(n)&&!s){if(n==="clear"?v.querySelectorAll('[data-type="strong"],[data-type="em"],[data-type="u"],[data-type="s"],[data-type="mark"],[data-type="sup"],[data-type="sub"],[data-type="kbd"],[data-type="mark"],[data-type="code"]').forEach(k=>{k.classList.remove("protyle-toolbar__item--current")}):h&&h.classList.remove("protyle-toolbar__item--current"),w.childNodes.length===0)if(r.find((k,x)=>{if(n===k)return r.splice(x,1),!0}),r.length===0||n==="clear")E.push(document.createTextNode(f.ZWSP));else{let k=0;for(;k<r.length;)["inline-memo","text","block-ref","file-annotation-ref","a"].includes(r[k])?r.splice(k,1):++k;const x=document.createElement("span");x.setAttribute("data-type",r.join(" ")),x.textContent=f.ZWSP,E.push(x)}w.childNodes.forEach((k,x)=>{if(k.nodeType!==3&&k.tagName!=="BR"&&k.tagName!=="IMG"&&!k.classList.contains("img")){if(k.textContent==="")return;const C=(k.getAttribute("data-type")||"").split(" ");if(n==="clear")for(let T=0;T<C.length;T++)s&&s.type==="text"?C[T]==="text"&&(C.splice(T,1),T--):["kbd","text","strong","em","u","s","mark","sup","sub","code"].includes(C[T])&&(C.splice(T,1),T--);else C.find((T,I)=>{if(n===T)return C.splice(I,1),!0});if(C.length===0)k.textContent===""&&(k.textContent=f.ZWSP),E.push(document.createTextNode(k.textContent));else{if(c&&n==="clear"&&s&&s.type==="text"&&k.style.color===""&&k.style.webkitTextFillColor===""&&k.style.webkitTextStroke===""&&k.style.textShadow===""&&k.style.backgroundColor===""&&k.style.fontSize==="")return k.setAttribute("data-type",C.join(" ")),E.push(k),!0;n==="clear"&&(k.style.color="",k.style.webkitTextFillColor="",k.style.webkitTextStroke="",k.style.textShadow="",k.style.backgroundColor="",k.style.fontSize=""),x===0&&d&&d.nodeType!==3&&Le(C,(d.getAttribute("data-type")||"").split(" "))&&Ua(k,d,s)?(p=d.textContent.length,d.innerHTML=d.innerHTML+k.innerHTML):x===w.childNodes.length-1&&u&&u.nodeType!==3&&Le(C,(u.getAttribute("data-type")||"").split(" "))&&Ua(k,u,s)?(g=k.textContent.length,u.innerHTML=k.innerHTML+u.innerHTML):(k.setAttribute("data-type",C.join(" ")),E.push(k))}}else E.push(k)})}else if(!this.element.classList.contains("fn__none")&&n!=="text"&&h&&h.classList.add("protyle-toolbar__item--current"),c===""){const k=document.createElement("span");if(r.push(n),b){let x=0;for(;x<r.length;)["inline-memo","text","block-ref","file-annotation-ref","a"].includes(r[x])?r.splice(x,1):++x}k.setAttribute("data-type",[...new Set(r)].join(" ")),k.textContent=f.ZWSP,yl(k,s),E.push(k)}else{if(n==="block-ref")for(;w.childNodes.length>1;)w.childNodes[0].remove();w.childNodes.forEach((k,x)=>{let C="";if(k.nodeType===3)if(x===0&&d&&d.nodeType!==3&&n===d.getAttribute("data-type")&&Ua(k,d,s))p=d.textContent.length,d.innerHTML=d.innerHTML+k.textContent;else if(x===w.childNodes.length-1&&u&&u.nodeType!==3&&n===u.getAttribute("data-type")&&Ua(k,u,s))g=k.textContent.length,u.innerHTML=k.textContent+u.innerHTML;else if(k.textContent!==f.ZWSP||k.textContent===f.ZWSP&&!r.includes("img")){for(k.textContent.startsWith(f.ZWSP)&&(E.push(document.createTextNode(f.ZWSP)),k.textContent=k.textContent.substring(1));k.textContent.endsWith(`
`);)k.textContent=k.textContent.substring(0,k.textContent.length-1),C+=`
`;const T=document.createElement("span");T.setAttribute("data-type",n),T.textContent=k.textContent,yl(T,s),n==="text"&&!T.getAttribute("style")?E.push(k):E.push(T)}else E.push(k);else{let T=(k.getAttribute("data-type")||"").split(" ");for(let I=0;I<T.length;I++)["backslash","virtual-block-ref","search-mark"].includes(T[I])&&(T.splice(I,1),I--);if(T.includes("img")||T.push(n),(T.includes("code")||T.includes("tag")||T.includes("kbd"))&&!k.textContent.startsWith(f.ZWSP)&&k.insertAdjacentText("afterbegin",f.ZWSP),n==="sub"&&T.includes("sup")?T.find((I,P)=>{if(I==="sup")return T.splice(P,1),v.querySelector('[data-type="sup"]').classList.remove("protyle-toolbar__item--current"),!0}):n==="sup"&&T.includes("sub")?T.find((I,P)=>{if(I==="sub")return T.splice(P,1),v.querySelector('[data-type="sub"]').classList.remove("protyle-toolbar__item--current"),!0}):n==="block-ref"&&(T.includes("a")||T.includes("file-annotation-ref"))?T.find((I,P)=>{if(I==="a"||I==="file-annotation-ref")return T.splice(P,1),!0}):n==="a"&&(T.includes("block-ref")||T.includes("file-annotation-ref"))?T.find((I,P)=>{if(I==="block-ref"||I==="file-annotation-ref")return T.splice(P,1),!0}):n==="file-annotation-ref"&&(T.includes("block-ref")||T.includes("a"))?T.find((I,P)=>{if(I==="block-ref"||I==="a")return T.splice(P,1),!0}):n==="inline-memo"&&T.includes("inline-math")?(T.find((I,P)=>{if(I==="inline-math")return T.splice(P,1),!0}),k.querySelector(".katex")&&(k.textContent=k.getAttribute("data-content"))):n==="inline-math"&&T.includes("inline-memo")&&T.find((I,P)=>{if(I==="inline-memo")return T.splice(P,1),!0}),T=[...new Set(T)],x===0&&d&&d.nodeType!==3&&Le(T,(d.getAttribute("data-type")||"").split(" "))&&Ua(k,d,s))p=d.textContent.length,d.innerHTML=d.innerHTML+k.innerHTML;else if(x===w.childNodes.length-1&&u&&u.nodeType!==3&&Le(T,(u.getAttribute("data-type")||"").split(" "))&&Ua(k,u,s))g=k.textContent.length,u.innerHTML=k.innerHTML+u.innerHTML;else if(k.tagName!=="BR"&&k.tagName!=="IMG")if(k.setAttribute("data-type",T.join(" ")),yl(k,s),T.includes("text")&&!k.getAttribute("style"))if(T.length===1){const I=document.createTextNode(k.textContent);E.push(I)}else T.splice(T.indexOf("text"),1),k.setAttribute("data-type",T.join(" ")),E.push(k);else E.push(k);else E.push(k)}C&&E.push(document.createTextNode(C))})}if(this.range.startContainer.nodeType!==3&&this.range.startContainer.tagName==="SPAN"&&this.range.startContainer.isSameNode(this.range.endContainer)&&!b){const k=this.range.startContainer,x=document.createElement("span"),C=k.attributes;for(let I=0;I<C.length;I++)x.setAttribute(C[I].name,C[I].value);this.range.setEnd(k.lastChild,k.lastChild.textContent.length),x.append(this.range.extractContents()),k.after(x);const T=k.getAttribute("data-type").split(" ");T.includes("code")||T.includes("tag")||T.includes("kbd")?(x.insertAdjacentText("beforebegin",f.ZWSP+f.ZWSP),x.insertAdjacentText("afterbegin",f.ZWSP),this.range.setStart(x.previousSibling,1)):this.range.setStartBefore(x),this.range.collapse(!0)}for(let k=0;k<E.length;k++){const x=E[k],C=E[k+1],T=x.nodeType!==3&&x.getAttribute("data-type")||"";if(x.nodeType!==3&&C&&C.nodeType!==3&&C.tagName===x.tagName&&x.tagName!=="BR"&&Le((C.getAttribute("data-type")||"").split(" "),T.split(" "))&&x.getAttribute("data-id")===C.getAttribute("data-id")&&x.getAttribute("data-subtype")===C.getAttribute("data-subtype")&&x.style.color===C.style.color&&x.style.webkitTextFillColor===C.style.webkitTextFillColor&&x.style.webkitTextStroke===C.style.webkitTextStroke&&x.style.textShadow===C.style.textShadow&&x.style.fontSize===C.style.fontSize&&x.style.backgroundColor===C.style.backgroundColor)T.indexOf("inline-math")>-1?C.setAttribute("data-content",x.getAttribute("data-content")+C.getAttribute("data-content")):(C.innerHTML=x.innerHTML+C.innerHTML,T.indexOf("inline-memo")>-1&&C.setAttribute("data-inline-memo-content",(x.getAttribute("data-inline-memo-content")||"")+(C.getAttribute("data-inline-memo-content")||""))),E.splice(k,1),k--;else{if(this.range.insertNode(x),x.nodeType===1&&["code","tag","kbd"].includes(n)){const I=ut(x);(!I||I.textContent.endsWith(`
`))&&x.before(document.createTextNode(f.ZWSP)),x.textContent.startsWith(f.ZWSP)||(x.textContent=f.ZWSP+x.textContent);const P=Fe(x);(!P||P&&(P.nodeType!==3||P.nodeType===3&&!P.textContent.startsWith(f.ZWSP)))&&x.after(document.createTextNode(f.ZWSP))}else if(x.nodeType===3&&["code","tag","kbd","clear"].includes(n)){const I=ut(x);let P=!1;if(I)if(I.nodeType===1){const V=I.dataset.type.split(" ");(V.includes("code")||V.includes("tag")||V.includes("kbd"))&&(P=!0)}else I.textContent.endsWith(f.ZWSP)&&(I.textContent=I.textContent.substring(0,I.textContent.length-1));const N=Fe(x);let R=!1;if(N)if(N.nodeType===1){const V=N.dataset.type.split(" ");(V.includes("code")||V.includes("tag")||V.includes("kbd"))&&(R=!0)}else N.textContent.startsWith(f.ZWSP)&&(N.textContent=N.textContent.substring(1));x&&(P?x.textContent.startsWith(f.ZWSP)||(x.textContent=f.ZWSP+x.textContent):x.textContent.startsWith(f.ZWSP)&&(x.textContent=x.textContent.substring(1)),R?N.textContent.startsWith(f.ZWSP)||(N.textContent=f.ZWSP+N.textContent):x.textContent.endsWith(f.ZWSP)&&(x.textContent=x.textContent.substring(0,x.textContent.length-1)))}this.range.collapse(!1)}}if(d&&(d.nodeType!==3&&d.textContent===f.ZWSP?d.remove():this.mergeNode(d.childNodes)),u&&this.mergeNode(u.childNodes),p?this.range.setStart(d.firstChild,p):E.length>0?E[0].nodeType!==3&&E[0].getAttribute("data-type")==="inline-math"||(E[0].firstChild?E[0].firstChild.textContent===f.ZWSP?this.range.setStart(E[0].firstChild,1):this.range.setStart(E[0].firstChild,0):E[0].nodeType===3?this.range.setStart(E[0],0):this.range.setStartBefore(E[0])):u&&this.range.setStart(u.firstChild,0),g)this.range.setEnd(u.lastChild,g);else if(E.length>0){const k=E[E.length-1];if(k.nodeType!==3&&k.getAttribute("data-type").indexOf("inline-math")>-1){const x=ut(k);x&&x.nodeType===3?this.range.setStart(x,x.textContent.length):this.range.setStartBefore(k);const C=Fe(k);C&&C.nodeType===3?this.range.setEnd(C,0):this.range.setEndAfter(k)}else k.lastChild?k.lastChild.textContent===f.ZWSP?this.range.collapse(!0):this.range.setEnd(k.lastChild,k.lastChild.textContent.length):k.nodeType===3?(this.range.setEnd(k,k.textContent.length),k.textContent===f.ZWSP&&this.range.collapse(!1)):this.range.setEndAfter(k)}else d&&this.range.setEnd(d.firstChild,d.firstChild.textContent.length);let S=!0;if(n==="inline-math"){if(_n(l),c===""){t.toolbar.showRender(t,E[0],void 0,_);return}}else if(n==="inline-memo"){t.toolbar.showRender(t,E[0],E,_);return}else if(n==="block-ref")this.range.collapse(!1);else if(n==="a"){const k=E[0];k.textContent.replace(f.ZWSP,"")===""||!k.getAttribute("data-href")?(S=!1,Ai(t,k,!!k.getAttribute("data-href"))):this.range.collapse(!1)}l.setAttribute("updated",U().format("YYYYMMDDHHmmss")),K(t,l.getAttribute("data-node-id"),l.outerHTML,_);const L=l.querySelector("wbr");L&&L.remove(),S&&X(this.range)}showRender(t,n,a,s){var i;const l=B(n);if(!l)return;J(["hint"],t),window.siyuan.menus.menu.remove();const o=l.getAttribute("data-node-id"),r=(n.getAttribute("data-type")||"").split(" "),c=s||l.outerHTML;let d="HTML",u="";const p=r.includes("inline-memo");switch(n.getAttribute("data-subtype")){case"abc":d=window.siyuan.languages.staff;break;case"echarts":d=window.siyuan.languages.chart;break;case"flowchart":d="Flow Chart";break;case"graphviz":d="Graphviz";break;case"mermaid":d="Mermaid";break;case"mindmap":u=`- foo
  - bar
- baz`,d=window.siyuan.languages.mindmap;break;case"plantuml":d="UML";break;case"math":r.includes("NodeMathBlock")?d=window.siyuan.languages.math:d=window.siyuan.languages["inline-math"];break}r.includes("NodeBlockQueryEmbed")?d=window.siyuan.languages.blockEmbed:p&&(d=window.siyuan.languages.memo);const g=((i=this.subElement.querySelector('[data-type="pin"]'))==null?void 0:i.getAttribute("aria-label"))===window.siyuan.languages.unpin,m={};if(g){const h=this.subElement.querySelector(".b3-text-field");m.styleH=h.style.height,m.styleW=h.style.width}else this.subElement.style.width="",this.subElement.style.padding="0";this.subElement.innerHTML=`<div ${g&&this.subElement.firstElementChild.getAttribute("data-drag")==="true"?'data-drag="true"':""}><div class="block__icons block__icons--menu fn__flex" style="border-radius: var(--b3-border-radius-b) var(--b3-border-radius-b) 0 0;">
    <span class="fn__flex-1 resize__move">
        ${d}
    </span>
    <span class="fn__space"></span>
    <button data-type="refresh" class="block__icon block__icon--show b3-tooltips b3-tooltips__nw${g&&!this.subElement.querySelector('[data-type="refresh"]').classList.contains("block__icon--active")?"":" block__icon--active"}${r.includes("NodeBlockQueryEmbed")?" fn__none":""}" aria-label="${window.siyuan.languages.refresh}"><svg><use xlink:href="#iconRefresh"></use></svg></button>
    <span class="fn__space"></span>
    <button data-type="before" class="block__icon block__icon--show b3-tooltips b3-tooltips__nw${t.disabled?" fn__none":""}" aria-label="${window.siyuan.languages["insert-before"]}"><svg><use xlink:href="#iconBefore"></use></svg></button>
    <span class="fn__space${t.disabled?" fn__none":""}"></span>
    <button data-type="after" class="block__icon block__icon--show b3-tooltips b3-tooltips__nw${t.disabled?" fn__none":""}" aria-label="${window.siyuan.languages["insert-after"]}"><svg><use xlink:href="#iconAfter"></use></svg></button>
    <span class="fn__space${t.disabled?" fn__none":""}"></span>
    <button data-type="export" class="block__icon block__icon--show b3-tooltips b3-tooltips__nw" aria-label="${window.siyuan.languages.export} ${window.siyuan.languages.image}"><svg><use xlink:href="#iconImage"></use></svg></button>
    <span class="fn__space"></span>
    <button data-type="pin" class="block__icon block__icon--show b3-tooltips b3-tooltips__nw" aria-label="${g?window.siyuan.languages.unpin:window.siyuan.languages.pin}"><svg><use xlink:href="#icon${g?"Unpin":"Pin"}"></use></svg></button>
    <span class="fn__space"></span>
    <button data-type="close" class="block__icon block__icon--show b3-tooltips b3-tooltips__nw" aria-label="${window.siyuan.languages.close}"><svg style="width: 10px;margin: 0 2px;"><use xlink:href="#iconClose"></use></svg></button>
</div>
<textarea ${t.disabled?" readonly":""} spellcheck="false" class="b3-text-field b3-text-field--text fn__block" placeholder="${u}" style="${H()?"":"width:"+Math.max(480,n.clientWidth*.7)+"px"};max-height:calc(80vh - 44px);min-height: 48px;min-width: 268px;border-radius: 0 0 var(--b3-border-radius-b) var(--b3-border-radius-b);font-family: var(--b3-font-family-code);"></textarea></div>`;const b=()=>{if(w.style.height=w.scrollHeight+"px",H()){ke(this.subElement,0,0);return}if(this.subElement.firstElementChild.getAttribute("data-drag")==="true"){w.getBoundingClientRect().bottom>window.innerHeight&&(this.subElement.style.top=window.innerHeight-this.subElement.clientHeight+"px");return}const h=v.bottom===v.top?v.bottom+26:v.bottom;this.subElement.clientHeight<=window.innerHeight-h||this.subElement.clientHeight<=v.top?r.includes("inline-math")||p?ke(this.subElement,v.left,h,v.height||26):ke(this.subElement,v.left+(v.width-this.subElement.clientWidth)/2,h,v.height||26):ke(this.subElement,v.right,h)},y=this.subElement.querySelector(".block__icons");y.addEventListener("click",h=>{const E=h.target,S=$(E,"b3-tooltips");if(!S){if(h.detail===2){const L=y.querySelector('[data-type="pin"]');L.getAttribute("aria-label")===window.siyuan.languages.unpin?(L.querySelector("svg use").setAttribute("xlink:href","#iconPin"),L.setAttribute("aria-label",window.siyuan.languages.pin)):(L.querySelector("svg use").setAttribute("xlink:href","#iconUnpin"),L.setAttribute("aria-label",window.siyuan.languages.unpin)),h.preventDefault(),h.stopPropagation()}return}switch(h.stopPropagation(),S.getAttribute("data-type")){case"close":this.subElement.querySelector('[data-type="pin"]').setAttribute("aria-label",window.siyuan.languages.pin),J(["util"],t);break;case"pin":S.getAttribute("aria-label")===window.siyuan.languages.unpin?(S.querySelector("svg use").setAttribute("xlink:href","#iconPin"),S.setAttribute("aria-label",window.siyuan.languages.pin)):(S.querySelector("svg use").setAttribute("xlink:href","#iconUnpin"),S.setAttribute("aria-label",window.siyuan.languages.unpin));break;case"refresh":S.classList.toggle("block__icon--active");break;case"before":Rt(t,"beforebegin",o),J(["util"],t);break;case"after":Rt(t,"afterend",o),J(["util"],t);break;case"export":_();break}});const _=()=>{const h=ae(window.siyuan.languages.exporting,0);if(n.getAttribute("data-subtype")==="plantuml"){fetch(n.querySelector("img").getAttribute("src")).then(function(E){return E.blob()}).then(function(E){const S=new FormData;S.append("file",E),S.append("type","image/png"),A("/api/export/exportAsFile",S,L=>{Et(L.data.file),tt(h)})});return}setTimeout(()=>{Re("/stage/protyle/js/html2canvas.min.js?v=1.4.1","protyleHtml2canvas").then(()=>{window.html2canvas(n,{useCORS:!0}).then(E=>{E.toBlob(S=>{const L=new FormData;L.append("file",S),L.append("type","image/png"),A("/api/export/exportAsFile",L,k=>{Et(k.data.file),tt(h)})})})})},f.TIMEOUT_LOAD)},w=this.subElement.querySelector(".b3-text-field");r.includes("NodeHTMLBlock")?w.value=Lute.UnEscapeHTMLStr(n.querySelector("protyle-html").getAttribute("data-content")||""):p?w.value=Lute.UnEscapeHTMLStr(n.getAttribute("data-inline-memo-content")||""):w.value=Lute.UnEscapeHTMLStr(n.getAttribute("data-content")||""),w.addEventListener("input",h=>{if(n.parentElement&&(w.clientHeight!==w.scrollHeight&&b(),!!this.subElement.querySelector('[data-type="refresh"]').classList.contains("block__icon--active"))){if(r.includes("NodeHTMLBlock"))n.querySelector("protyle-html").setAttribute("data-content",Lute.EscapeHTMLStr(w.value));else if(p){let E;a?E=a:E=[n],E.forEach(S=>{S.setAttribute("data-inline-memo-content",Lute.EscapeHTMLStr(w.value))})}else n.setAttribute("data-content",Lute.EscapeHTMLStr(w.value)),n.removeAttribute("data-render");(!r.includes("NodeBlockQueryEmbed")||!r.includes("NodeHTMLBlock")||!p)&&Ze(n),h.stopPropagation()}}),w.addEventListener("keydown",h=>{if(h.stopPropagation(),te(window.siyuan.config.keymap.editor.insert["inline-math"].custom,h)){h.preventDefault();return}if(!h.isComposing){if(h.key==="Escape"||te("\u2318\u21A9",h))this.subElement.querySelector('[data-type="pin"]').setAttribute("aria-label",window.siyuan.languages.pin),J(["util"],t);else if(h.key==="Tab")document.execCommand("insertText",!1,"	"),h.preventDefault();else if(Zn(h))return}}),this.subElementCloseCB=()=>{var h;if(!n.parentElement||t.disabled)return;let E;if(r.includes("NodeHTMLBlock")){let S=w.value;S&&(S=S.trim().replace(/\n+/g,`
`),S.startsWith("<div>")&&S.endsWith("</div>")||(S=`<div>
${S}
</div>`)),n.querySelector("protyle-html").setAttribute("data-content",Lute.EscapeHTMLStr(S))}else if(p){let S;a?S=a:S=[n],S.forEach((L,k)=>{if(w.value)L.setAttribute("data-inline-memo-content",Lute.EscapeHTMLStr(w.value));else{const x=L.getAttribute("data-type").split(" ");x.length===1&&x[0]==="inline-memo"?L.outerHTML=L.innerHTML+(k===S.length-1?"<wbr>":""):(x.find((C,T)=>{if(C==="inline-memo")return x.splice(T,1),!0}),L.setAttribute("data-type",x.join(" ")),L.removeAttribute("data-inline-memo-content")),k===S.length-1&&(E=L)}})}else r.includes("inline-math")?w.value?(n.setAttribute("data-content",Lute.EscapeHTMLStr(w.value)),n.removeAttribute("data-render"),Ze(n)):(E=n,n.outerHTML="<wbr>"):(n.setAttribute("data-content",Lute.EscapeHTMLStr(w.value)),n.removeAttribute("data-render"),r.includes("NodeBlockQueryEmbed")?Se(t,n):Ze(n));if(getSelection().rangeCount===0||getSelection().rangeCount>0&&$(getSelection().getRangeAt(0).startContainer,"protyle-util")?n.tagName==="SPAN"?E?E.parentElement?(this.range.setStartAfter(E),this.range.collapse(!0),X(this.range)):ue(l,this.range):n.parentElement&&(this.range.setStartAfter(n),this.range.collapse(!0),X(this.range)):(ne(n),n.classList.add("protyle-wysiwyg--select")):(h=l.querySelector("wbr"))==null||h.remove(),l.setAttribute("updated",U().format("YYYYMMDDHHmmss")),r.includes("NodeHTMLBlock")){const S=document.createElement("template");S.innerHTML=t.lute.SpinBlockDOM(l.outerHTML),S.content.childElementCount>1&&ae(window.siyuan.languages.htmlBlockTip)}K(t,o,l.outerHTML,c)},this.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),this.subElement.classList.remove("fn__none");const v=n.getBoundingClientRect();this.element.classList.add("fn__none"),g?(w.style.width=m.styleW,w.style.height=m.styleH):b(),t.disabled||w.select(),t.app.plugins.forEach(h=>{h.eventBus.emit("open-noneditableblock",{protyle:t,toolbar:this,blockElement:l,renderElement:n})})}showCodeLanguage(t,n){var a,s;const i=B(n);if(!i)return;J(["hint"],t),window.siyuan.menus.menu.remove(),this.range=ye(i);const l=i.getAttribute("data-node-id");let o=i.outerHTML,r=`<div class="b3-list-item">${window.siyuan.languages.clear}</div>`;const c=f.ALIAS_CODE_LANGUAGES.concat((s=(a=window.hljs)==null?void 0:a.listLanguages())!=null?s:[]).sort();c.forEach((p,g)=>{r+=`<div class="b3-list-item${g===0?" b3-list-item--focus":""}">${p}</div>`}),this.subElement.style.width="",this.subElement.style.padding="",this.subElement.innerHTML=`<div class="fn__flex-column" style="max-height:50vh">
    <input placeholder="${window.siyuan.languages.search}" style="margin: 0 8px 4px 8px" class="b3-text-field"/>
    <div class="b3-list fn__flex-1 b3-list--background" style="position: relative">${r}</div>
</div>`;const d=this.subElement.lastElementChild.lastElementChild,u=this.subElement.querySelector("input");u.addEventListener("keydown",p=>{if(p.stopPropagation(),!p.isComposing){if(Wt(d,p),p.key==="Enter"){o=this.updateLanguage(n,t,l,i,o,this.subElement.querySelector(".b3-list-item--focus").textContent),p.preventDefault(),p.stopPropagation();return}p.key==="Escape"&&(this.subElement.classList.add("fn__none"),X(this.range))}}),u.addEventListener("input",p=>{const g=u.value.toLowerCase(),m=c.filter(_=>_.includes(g));let b="",y=!1;m.sort((_,w)=>_.startsWith(g)&&w.startsWith(g)?_.length<w.length?-1:_.length===w.length?0:1:_.startsWith(g)?-1:w.startsWith(g)?1:0).forEach(_=>{u.value===_&&(y=!0),b+=`<div class="b3-list-item">${_.replace(g,"<b>"+g+"</b>")}</div>`}),u.value.trim()&&!y&&(b=`<div class="b3-list-item"><b>${pe(u.value.replace(/`| /g,"_"))}</b></div>${b}`),b=`<div class="b3-list-item">${window.siyuan.languages.clear}</div>`+b,d.innerHTML=b,d.firstElementChild.nextElementSibling?d.firstElementChild.nextElementSibling.classList.add("b3-list-item--focus"):d.firstElementChild.classList.add("b3-list-item--focus"),p.stopPropagation()}),d.addEventListener("click",p=>{const g=p.target,m=$(g,"b3-list-item");m&&(o=this.updateLanguage(n,t,l,i,o,m.textContent))}),this.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),this.subElement.classList.remove("fn__none"),this.subElementCloseCB=void 0,ke(this.subElement,0,0),this.element.classList.add("fn__none"),u.select()}showTpl(t,n,a){this.range=a,J(["hint"],t),window.siyuan.menus.menu.remove(),this.subElement.style.width="",this.subElement.style.padding="",this.subElement.innerHTML=`<div style="max-height:50vh" class="fn__flex">
<div class="fn__flex-column" style="${H()?"width: 100%":"width: 256px"}">
    <div class="fn__flex" style="margin: 0 8px 4px 8px">
        <input class="b3-text-field fn__flex-1"/>
        <span class="fn__space"></span>
        <span data-type="previous" class="block__icon block__icon--show"><svg><use xlink:href="#iconLeft"></use></svg></span>
        <span class="fn__space"></span>
        <span data-type="next" class="block__icon block__icon--show"><svg><use xlink:href="#iconRight"></use></svg></span>
    </div>
    <div class="b3-list fn__flex-1 b3-list--background" style="position: relative"><img style="margin: 0 auto;display: block;width: 64px;height: 64px" src="/stage/loading-pure.svg"></div>
</div>
<div class="toolbarResize" style="    cursor: col-resize;
    box-shadow: 2px 0 0 0 var(--b3-theme-surface) inset, 3px 0 0 0 var(--b3-border-color) inset;
    width: 5px;
    margin-left: -2px;"></div>
<div style="width: 520px;${H()||window.outerWidth<window.outerWidth/2+520?"display:none;":""}overflow: auto;"></div>
</div>`;const s=this.subElement.querySelector(".b3-list");Ts(this.subElement.querySelector(".toolbarResize"),s.parentElement);const i=this.subElement.firstElementChild.lastElementChild;let l;s.addEventListener("mouseover",r=>{const c=r.target,d=$(c,"b3-list-item");if(!d)return;const u=d.getAttribute("data-value");l!==u&&(l=u,Ra(l,i,t.block.parentID),r.stopPropagation())});const o=this.subElement.querySelector("input");o.addEventListener("keydown",r=>{if(r.stopPropagation(),r.isComposing)return;const c=!this.subElement.querySelector(".b3-list-item");if(!c){const d=Wt(s,r);if(d){const u=d.getAttribute("data-value");if(l===u)return;l=u,Ra(l,i,t.block.parentID)}}r.key==="Enter"?(c?X(this.range):Qc(decodeURIComponent(this.subElement.querySelector(".b3-list-item--focus").getAttribute("data-value")),t,n),this.subElement.classList.add("fn__none"),r.preventDefault()):r.key==="Escape"&&(this.subElement.classList.add("fn__none"),X(this.range))}),o.addEventListener("input",r=>{r.stopPropagation(),A("/api/search/searchTemplate",{k:o.value},c=>{var d;let u="";c.data.blocks.forEach((g,m)=>{u+=`<div data-value="${g.path}" class="b3-list-item${m===0?" b3-list-item--focus":""}">${g.content}</div>`}),s.innerHTML=u||`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;const p=(d=c.data.blocks[0])==null?void 0:d.path;l!==p&&(l=p,Ra(l,i,t.block.parentID))})}),this.subElement.lastElementChild.addEventListener("click",r=>{const c=r.target;if(c.classList.contains("b3-list--empty")){this.subElement.classList.add("fn__none"),X(this.range),r.stopPropagation();return}const d=$(c,"b3-list-item__action");if(d&&d.getAttribute("data-type")==="remove"){$e(window.siyuan.languages.remove,window.siyuan.languages.confirmDelete+"?",()=>{A("/api/search/removeTemplate",{path:d.parentElement.getAttribute("data-value")},()=>{if(d.parentElement.parentElement.childElementCount===1)d.parentElement.parentElement.innerHTML=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`,Ra("",i,t.block.parentID);else{if(d.parentElement.classList.contains("b3-list-item--focus")){const m=d.parentElement.previousElementSibling||d.parentElement.nextElementSibling;m.classList.add("b3-list-item--focus");const b=m.getAttribute("data-value");if(l===b)return;l=b,Ra(l,i,t.block.parentID)}d.parentElement.remove()}})}),r.stopPropagation();return}if(D(c,"data-type","previous")){o.dispatchEvent(new KeyboardEvent("keydown",{key:"ArrowUp"})),r.stopPropagation();return}if(D(c,"data-type","next")){o.dispatchEvent(new KeyboardEvent("keydown",{key:"ArrowDown"})),r.stopPropagation();return}const g=$(c,"b3-list-item");g&&(Qc(decodeURIComponent(g.getAttribute("data-value")),t,n),r.stopPropagation())}),this.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),this.subElement.classList.remove("fn__none"),this.subElementCloseCB=void 0,this.element.classList.add("fn__none"),o.select(),A("/api/search/searchTemplate",{k:""},r=>{let c="";r.data.blocks.forEach((d,u)=>{c+=`<div data-value="${d.path}" class="b3-list-item--hide-action b3-list-item${u===0?" b3-list-item--focus":""}">
<span class="b3-list-item__text">${d.content}</span>`,c+=`<span data-type="remove" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.remove}">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
</span></div>`}),this.subElement.querySelector(".b3-list--background").innerHTML=c||`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`,ke(this.subElement,0,0),l=s.firstElementChild.getAttribute("data-value"),Ra(l,i,t.block.parentID)})}showWidget(t,n,a){this.range=a,J(["hint"],t),window.siyuan.menus.menu.remove(),this.subElement.style.width="",this.subElement.style.padding="",this.subElement.innerHTML=`<div class="fn__flex-column" style="max-height:50vh">
    <input style="margin: 0 8px 4px 8px" class="b3-text-field"/>
    <div class="b3-list fn__flex-1 b3-list--background" style="position: relative"><img style="margin: 0 auto;display: block;width: 64px;height:64px" src="/stage/loading-pure.svg"></div>
</div>`;const s=this.subElement.lastElementChild.lastElementChild,i=this.subElement.querySelector("input");i.addEventListener("keydown",l=>{l.stopPropagation(),!l.isComposing&&(Wt(s,l),l.key==="Enter"?(ed(this.subElement.querySelector(".b3-list-item--focus").getAttribute("data-content"),t),this.subElement.classList.add("fn__none"),l.preventDefault()):l.key==="Escape"&&(this.subElement.classList.add("fn__none"),X(this.range)))}),i.addEventListener("input",l=>{l.stopPropagation(),A("/api/search/searchWidget",{k:i.value},o=>{let r="";o.data.blocks.forEach((c,d)=>{r+=`<div data-value="${c.path}" data-content="${c.content}" class="b3-list-item${d===0?" b3-list-item--focus":""}">
    ${c.name}
    <span class="b3-list-item__meta">${c.content}</span>
</div>`}),s.innerHTML=r})}),this.subElement.lastElementChild.addEventListener("click",l=>{const o=l.target,r=$(o,"b3-list-item");r&&ed(r.dataset.content,t)}),this.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),this.subElement.classList.remove("fn__none"),this.subElementCloseCB=void 0,this.element.classList.add("fn__none"),i.select(),A("/api/search/searchWidget",{k:""},l=>{let o="";l.data.blocks.forEach((r,c)=>{o+=`<div class="b3-list-item${c===0?" b3-list-item--focus":""}" data-content="${r.content}">
${r.name}
<span class="b3-list-item__meta">${r.content}</span>
</div>`}),this.subElement.querySelector(".b3-list--background").innerHTML=o,ke(this.subElement,0,0)})}showContent(t,n,a){var s,i;this.range=n,J(["hint"],t),this.subElement.style.width="auto",this.subElement.style.padding="0 8px";let l="";const o=n.toString()!==""||((i=(s=n.cloneContents().childNodes[0])==null?void 0:s.classList)==null?void 0:i.contains("emoji"));o&&(l+='<button class="keyboard__action" data-action="copy"><svg><use xlink:href="#iconCopy"></use></svg></button>',t.disabled||(l+=`<button class="keyboard__action" data-action="cut"><svg><use xlink:href="#iconCut"></use></svg></button>
<button class="keyboard__action" data-action="delete"><svg><use xlink:href="#iconTrashcan"></use></svg></button>`)),t.disabled||(l+=`<button class="keyboard__action" data-action="paste"><svg><use xlink:href="#iconPaste"></use></svg></button>
<button class="keyboard__action" data-action="select"><svg><use xlink:href="#iconSelect"></use></svg></button>`),(o||!t.disabled)&&(l+='<button class="keyboard__action" data-action="more"><svg><use xlink:href="#iconMore"></use></svg></button>'),this.subElement.innerHTML=`<div class="fn__flex">${l}</div>`,this.subElement.lastElementChild.addEventListener("click",c=>Wg(this,null,function*(){const d=$(c.target,"keyboard__action");if(!d)return;const u=d.getAttribute("data-action");if(u==="copy")X(ye(a)),document.execCommand("copy"),this.subElement.classList.add("fn__none");else if(u==="cut")X(ye(a)),document.execCommand("cut"),this.subElement.classList.add("fn__none");else if(u==="delete"){const p=ye(a);p.insertNode(document.createElement("wbr"));const g=a.outerHTML;p.extractContents(),ue(a,p),X(p),K(t,a.getAttribute("data-node-id"),a.outerHTML,g),this.subElement.classList.add("fn__none")}else if(u==="paste"){if(document.queryCommandSupported("paste"))document.execCommand("paste");else try{const p=yield al();qi(t,Object.assign(p,{target:a}))}catch(p){console.log(p)}this.subElement.classList.add("fn__none")}else u==="select"?(Js(t,a,n),this.subElement.classList.add("fn__none")):u==="copyPlainText"?(X(ye(a)),Xi(getSelection().getRangeAt(0).toString()),this.subElement.classList.add("fn__none")):u==="pasteAsPlainText"?(X(ye(a)),jc(t),this.subElement.classList.add("fn__none")):u==="pasteEscaped"?(dg(t,a),this.subElement.classList.add("fn__none")):u==="back"?this.subElement.lastElementChild.innerHTML=l:u==="more"&&(this.subElement.lastElementChild.innerHTML=`<button class="keyboard__action${o?"":" fn__none"}" data-action="copyPlainText"><span>${window.siyuan.languages.copyPlainText}</span></button>
<div class="keyboard__split${o?"":" fn__none"}"></div>
<button class="keyboard__action${t.disabled?" fn__none":""}" data-action="pasteAsPlainText"><span>${window.siyuan.languages.pasteAsPlainText}</span></button>
<div class="keyboard__split${t.disabled?" fn__none":""}"></div>
<button class="keyboard__action${t.disabled?" fn__none":""}" data-action="pasteEscaped"><span>${window.siyuan.languages.pasteEscaped}</span></button>
<div class="keyboard__split${t.disabled?" fn__none":""}"></div>
<button class="keyboard__action" data-action="back"><svg><use xlink:href="#iconBack"></use></svg></button>`,ke(this.subElement,r.left,r.top+28,f.SIZE_TOOLBAR_HEIGHT))})),this.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),this.subElement.classList.remove("fn__none"),this.subElementCloseCB=void 0,this.element.classList.add("fn__none");const r=hn(a,n);ke(this.subElement,r.left,r.top-48,f.SIZE_TOOLBAR_HEIGHT)}genItem(t,n){let a;switch(n.name){case"strong":case"em":case"s":case"code":case"mark":case"tag":case"u":case"sup":case"clear":case"sub":case"kbd":a=new Sa(t,n);break;case"block-ref":a=new Rg(t,n);break;case"inline-math":a=new Ug(t,n);break;case"inline-memo":a=new Fg(t,n);break;case"|":a=new Pg;break;case"text":a=new Gu(t,n);break;case"a":a=new Og(t,n);break;default:a=new Sa(t,n);break}if(a)return a.element}mergeNode(t){for(let n=0;n<t.length;n++)t[n].nodeType!==3&&t[n].tagName==="WBR"&&(t[n].remove(),n--);for(let n=0;n<t.length;n++)t[n].nodeType===3&&(t[n].textContent===""?(t[n].remove(),n--):t[n+1]&&t[n+1].nodeType===3&&(t[n].textContent=t[n].textContent+t[n+1].textContent,t[n+1].remove(),n--))}updateLanguage(t,n,a,s,i,l){t.textContent=l===window.siyuan.languages.clear?"":l,f.SIYUAN_RENDER_CODE_LANGUAGES.includes(t.textContent)||(window.siyuan.storage[f.LOCAL_CODELANG]=t.textContent,Ae(f.LOCAL_CODELANG,window.siyuan.storage[f.LOCAL_CODELANG]));const o=oe(s);return f.SIYUAN_RENDER_CODE_LANGUAGES.includes(t.textContent)?(s.dataset.content=o.textContent.trim(),s.dataset.subtype=t.textContent,s.className="render-node",s.innerHTML=`<div spin="1"></div><div class="protyle-attr" contenteditable="false">${f.ZWSP}</div>`,Ze(s)):(o.textContent=o.textContent,o.parentElement.removeAttribute("data-render"),Pe(s)),s.setAttribute("updated",U().format("YYYYMMDDHHmmss")),K(n,a,s.outerHTML,i),this.subElement.classList.add("fn__none"),X(this.range),s.outerHTML}}const Ri=(e,t,n,a,s)=>{let i=1,l;A(`/api/riff/get${a}RiffCards`,{id:t,page:i},o=>{var r;const c=new we({positionId:f.DIALOG_VIEWCARDS,content:`<div class="fn__flex-column" style="height: 100%">
    <div class="block__icons">
        <span class="fn__flex-1 fn__flex-center resize__move">${pe(n)}</span>
        <span class="fn__space"></span>
        <span data-type="resetAll" class="block__icon block__icon--show b3-tooltips b3-tooltips__w${a===""&&t===""?" fn__none":""}" aria-label="${window.siyuan.languages.reset}"><svg><use xlink:href='#iconUndo'></use></svg></span>
        <span class="fn__space"></span>
        <span data-type="previous" class="block__icon block__icon--show b3-tooltips b3-tooltips__w" disabled="disabled" aria-label="${window.siyuan.languages.previousLabel}"><svg><use xlink:href='#iconLeft'></use></svg></span>
        <span class="fn__space"></span>
        <span data-type="next" class="block__icon block__icon--show b3-tooltips b3-tooltips__w" disabled="disabled" aria-label="${window.siyuan.languages.nextLabel}"><svg><use xlink:href='#iconRight'></use></svg></span>
        <span class="fn__space"></span>
        <span class="fn__flex-center ft__on-surface">${i}/${o.data.pageCount||1}</span>
        <span class="fn__space"></span>
        <span class="counter">${o.data.total}</span>
        ${H()?`<span class="fn__space"></span>
<div data-type="close" class="block__icon block__icon--show">
    <svg><use xlink:href="#iconCloseRound"></use></svg>
</div>`:""}
    </div>
    <div class="${H()?"fn__flex-column":"fn__flex"} fn__flex-1" style="min-height: auto">
        <ul class="fn__flex-1 b3-list b3-list--background" style="user-select: none">
            ${go(o.data.blocks,n,a)}
        </ul>
        <div id="cardPreview" style="border-bottom-right-radius:var(--b3-border-radius-b);" class="fn__flex-1 fn__none"></div>
        <div class="fn__flex-1 card__empty">${window.siyuan.languages.emptyContent}</div>
    </div>
</div>`,width:H()?"100vw":"80vw",height:H()?"100vh":"70vh",destroyCallback(){l&&(l.destroy(),window.siyuan.mobile&&(window.siyuan.mobile.popEditor=null))},resizeCallback(g){g!=="d"&&g!=="t"&&l&&l.resize()}});o.data.blocks.length>0&&(l=new Yn(e,c.element.querySelector("#cardPreview"),{blockId:"",render:{gutter:!0,breadcrumbDocName:!0}}),window.siyuan.mobile&&(window.siyuan.mobile.popEditor=l),c.editors={card:l},l.resize(),Ha(l,(r=c.element.querySelector(".b3-list-item--focus"))==null?void 0:r.getAttribute("data-id")));const d=c.element.querySelector('[data-type="previous"]'),u=c.element.querySelector('[data-type="next"]'),p=c.element.querySelector(".b3-list--background");o.data.pageCount>1&&u.removeAttribute("disabled"),c.element.setAttribute("data-key",f.DIALOG_VIEWCARDS),c.element.addEventListener("click",g=>{var m;if(typeof g.detail=="string"){let y=p.querySelector(".b3-list-item--focus");if(y){y.classList.remove("b3-list-item--focus"),g.detail==="arrowup"?y=y.previousElementSibling||y.parentElement.lastElementChild:g.detail==="arrowdown"?y=y.nextElementSibling||y.parentElement.firstElementChild:g.detail==="home"?y=y.parentElement.firstElementChild:g.detail==="end"&&(y=y.parentElement.lastElementChild);const _=y.getBoundingClientRect(),w=y.parentElement.getBoundingClientRect();(_.top<w.top||_.bottom>w.bottom)&&y.scrollIntoView(_.top<w.top),Ha(l,y.getAttribute("data-id")),y.classList.add("b3-list-item--focus")}g.stopPropagation(),g.preventDefault();return}let b=g.target;for(;b&&!c.element.isSameNode(b);){const y=b.getAttribute("data-type");if(y==="close"){c.destroy(),g.stopPropagation(),g.preventDefault();break}else if(y==="previous"){if(i<=1)return;i--,i<=1&&d.setAttribute("disabled","disabled"),A(`/api/riff/get${a}RiffCards`,{id:t,page:i},_=>{var w;i===_.data.pageCount?u.setAttribute("disabled","disabled"):_.data.pageCount>1&&u.removeAttribute("disabled"),u.nextElementSibling.nextElementSibling.textContent=`${i}/${_.data.pageCount||1}`,p.innerHTML=go(_.data.blocks,n,a),p.scrollTop=0,Ha(l,(w=c.element.querySelector(".b3-list-item--focus"))==null?void 0:w.getAttribute("data-id"))}),g.stopPropagation(),g.preventDefault();break}else if(y==="next"){if(i>=o.data.pageCount)return;i++,d.removeAttribute("disabled"),A(`/api/riff/get${a}RiffCards`,{id:t,page:i},_=>{var w;i===_.data.pageCount?u.setAttribute("disabled","disabled"):_.data.pageCount>1&&u.removeAttribute("disabled"),u.nextElementSibling.nextElementSibling.textContent=`${i}/${_.data.pageCount||1}`,p.innerHTML=go(_.data.blocks,n,a),p.scrollTop=0,Ha(l,(w=c.element.querySelector(".b3-list-item--focus"))==null?void 0:w.getAttribute("data-id"))}),g.stopPropagation(),g.preventDefault();break}else if(y==="reset"){A("/api/riff/resetRiffCards",{type:a===""?"deck":a.toLowerCase(),deckID:a===""?t:f.QUICK_DECK_ID,id:t,blockIDs:[b.getAttribute("data-id")]},()=>{b.parentElement.querySelector(".ariaLabel.b3-list-item__meta").textContent=U().format("YYYY-MM-DD")}),g.stopPropagation(),g.preventDefault();break}else if(y==="resetAll"){$e(window.siyuan.languages.reset,window.siyuan.languages.resetCardTip.replace("${x}",c.element.querySelector(".counter").textContent),()=>{A("/api/riff/resetRiffCards",{type:a===""?"deck":a.toLowerCase(),deckID:a===""?t:f.QUICK_DECK_ID,id:t},()=>{c.element.querySelectorAll(".ariaLabel.b3-list-item__meta").forEach(_=>{_.textContent=U().format("YYYY-MM-DD")})})}),g.stopPropagation(),g.preventDefault();break}else if(y==="card-item"){Ha(l,b.getAttribute("data-id")),(m=p.querySelector(".b3-list-item--focus"))==null||m.classList.remove("b3-list-item--focus"),b.classList.add("b3-list-item--focus"),g.stopPropagation(),g.preventDefault();break}else if(y==="remove"){A("/api/riff/removeRiffCards",{deckID:a===""?t:f.QUICK_DECK_ID,blockIDs:[b.getAttribute("data-id")]},_=>{var w;let v=b.parentElement.nextElementSibling;v||(v=b.parentElement.previousElementSibling),!v&&b.parentElement.parentElement.childElementCount>1&&(v=b.parentElement.parentElement.firstElementChild),v?(Ha(l,v.getAttribute("data-id")),(w=p.querySelector(".b3-list-item--focus"))==null||w.classList.remove("b3-list-item--focus"),v.classList.add("b3-list-item--focus"),b.parentElement.remove()):(Ha(l,""),p.innerHTML=`<div class="b3-list--empty">${window.siyuan.languages.emptyContent}</div>`),c.element.querySelector(".counter").textContent=(parseInt(c.element.querySelector(".counter").textContent)-1).toString(),s&&s(_)}),g.stopPropagation(),g.preventDefault();break}b=b.parentElement}})})},go=(e,t,n)=>{let a="",s=!0;const i=t.split("/");return i.splice(0,1),e.forEach(l=>{var o,r,c,d;if(l.type){let u;n===""?u=Ft(l.box)+ct(Lute.UnEscapeHTMLStr(l.hPath),!1):(u=ct(Lute.UnEscapeHTMLStr(l.hPath),!1).replace("/"+i.join("/"),""),u.startsWith("/")&&(u=u.substring(1))),a+=`<div data-type="card-item" class="b3-list-item${s?" b3-list-item--focus":""}${H()?"":" b3-list-item--hide-action"}" data-id="${l.id}">
<svg class="b3-list-item__graphic"><use xlink:href="#${dn(l.type)}"></use></svg>
${ge(l.ial.icon,"b3-list-item__graphic",!0)}
<span class="b3-list-item__text">${l.content||f.ZWSP}</span>
<span class="${H()||!u?"fn__none ":""}b3-list-item__meta b3-list-item__meta--ellipsis" title="${We(u)}">${pe(u)}</span>
<span data-position="parentE" aria-label="${window.siyuan.languages.revisionCount}" class="ariaLabel counter${((o=l.riffCard)==null?void 0:o.reps)===0?" fn__none":""}">${(r=l.riffCard)==null?void 0:r.reps}</span>
<span data-position="parentE" aria-label="${window.siyuan.languages.nextDue}" class="ariaLabel b3-list-item__meta${(c=l.riffCard)!=null&&c.due?"":" fn__none"}">${U((d=l.riffCard)==null?void 0:d.due).format("YYYY-MM-DD")}</span>
<span data-position="parentE" data-type="reset" data-id="${l.id}" class="b3-list-item__action ariaLabel" aria-label="${window.siyuan.languages.reset}">
    <svg><use xlink:href="#iconUndo"></use></svg>
</span>
<span data-position="parentE" data-type="remove" data-id="${l.id}" class="b3-list-item__action b3-list-item__action--warning ariaLabel" aria-label="${window.siyuan.languages.removeDeck}">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
</span>
</div>`,s=!1}else a+=`<div data-type="card-item" class="b3-list-item${H()?"":" b3-list-item--hide-action"}">
<span class="b3-list-item__text">${l.content}</span>
<span data-position="parentE" data-type="remove" data-id="${l.id}" class="b3-list-item__action b3-list-item__action--warning ariaLabel" aria-label="${window.siyuan.languages.removeDeck}">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
</span>
</div>`}),e.length===0&&(a=`<div class="b3-list--empty">${window.siyuan.languages.emptyContent}</div>`),a},Ha=(e,t)=>{if(!t){e.protyle.element.classList.add("fn__none"),e.protyle.element.nextElementSibling.classList.remove("fn__none");return}e.protyle.element.classList.remove("fn__none"),e.protyle.element.nextElementSibling.classList.add("fn__none"),e.protyle.scroll.lastScrollTop=0,ei(e.protyle),A("/api/block/getDocInfo",{id:t},n=>{e.protyle.wysiwyg.renderCustom(n.data.ial),A("/api/filetree/getDoc",{id:t,mode:0,size:f.SIZE_GET_MAX},a=>{Qe({updateReadonly:!0,data:a,protyle:e.protyle,action:a.data.rootID===a.data.id?[f.CB_GET_HTML]:[f.CB_GET_ALL,f.CB_GET_HTML]})})})},Bi=e=>`<li data-id="${e.id}" data-name="${We(e.name)}" class="b3-list-item b3-list-item--narrow${H()?"":" b3-list-item--hide-action"}">
<span class="b3-list-item__text">
    <span>${pe(e.name)}</span>
    <span class="b3-list-item__meta">${e.size}</span>
</span>
<span data-type="rename" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.rename}">
    <svg><use xlink:href="#iconEdit"></use></svg>
</span>
<span data-type="delete" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.delete}">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
</span>
<span data-type="view" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.cardPreview}">
    <svg><use xlink:href="#iconEye"></use></svg>
</span>
<span data-type="remove" class="b3-list-item__action b3-list-item__action--warning b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.removeDeck}">
    <svg><use xlink:href="#iconMin"></use></svg>
</span>
<span data-type="add" style="display: flex" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.addDeck}">
    <svg><use xlink:href="#iconAdd"></use></svg>
</span>
<span class="b3-list-item__meta${H()?" fn__none":""}">${e.updated}</span>
</li>`,Ui=(e,t)=>{window.siyuan.dialogs.find(n=>{if(n.element.getAttribute("data-key")===f.DIALOG_MAKECARD)return J(["dialog"]),!0}),A("/api/riff/getRiffDecks",{},n=>{let a="";n.data.forEach(i=>{a+=Bi(i)});const s=new we({positionId:f.DIALOG_MAKECARD,width:H()?"92vw":"50vw",height:"70vh",title:window.siyuan.languages.riffCard,content:`<div class="b3-dialog__content fn__flex-column" style="box-sizing: border-box;height: 100%">
    <div class="fn__flex">
        <input class="b3-text-field fn__flex-1">
        <span class="fn__space"></span>
        <span data-type="create" class="block__icon block__icon--show b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.createDeck}">
            <svg><use xlink:href="#iconAdd"></use></svg>
        </span>
        <span class="fn__space"></span>
        <span data-type="viewall" class="block__icon block__icon--show b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.cardPreview}">
            <svg><use xlink:href="#iconEye"></use></svg>
        </span>
    </div>
    <div class="fn__hr"></div>
    <ul class="b3-list b3-list--background fn__flex-1">${a}</ul>
</div>`});s.element.setAttribute("data-key",f.DIALOG_MAKECARD),s.element.addEventListener("click",i=>{let l=i.target;for(;l&&!l.isSameNode(s.element);){const o=l.getAttribute("data-type");if(o==="create"){let r="";const c=s.element.querySelector(".b3-text-field");c.value?(r&&tt(r),A("/api/riff/createRiffDeck",{name:c.value},d=>{s.element.querySelector(".b3-list").insertAdjacentHTML("afterbegin",Bi(d.data)),c.value=""})):(r=ae(window.siyuan.languages._kernel[142]),c.focus()),i.stopPropagation(),i.preventDefault();break}else if(o==="add"){A("/api/riff/addRiffCards",{deckID:l.parentElement.getAttribute("data-id"),blockIDs:t},r=>{l.parentElement.outerHTML=Bi(r.data)}),i.stopPropagation(),i.preventDefault();break}else if(o==="remove"){A("/api/riff/removeRiffCards",{deckID:l.parentElement.getAttribute("data-id"),blockIDs:t},r=>{l.parentElement.outerHTML=Bi(r.data)}),i.stopPropagation(),i.preventDefault();break}else if(o==="delete"){$e(window.siyuan.languages.deleteOpConfirm,`${window.siyuan.languages.confirmDelete} <b>${pe(l.parentElement.getAttribute("data-name"))}</b>?`,()=>{A("/api/riff/removeRiffDeck",{deckID:l.parentElement.getAttribute("data-id")},()=>{l.parentElement.remove()})},void 0,!0),i.stopPropagation(),i.preventDefault();break}else if(o==="view"){Ri(e,l.parentElement.getAttribute("data-id"),l.parentElement.getAttribute("data-name"),"",r=>{l.parentElement.outerHTML=Bi(r.data)}),i.stopPropagation(),i.preventDefault();break}else if(o==="viewall"){Ri(e,"",window.siyuan.languages.all,""),i.stopPropagation(),i.preventDefault();break}else if(o==="rename"){const r=new we({title:window.siyuan.languages.rename,content:`<div class="b3-dialog__content"><input class="b3-text-field fn__block" value=""></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:H()?"92vw":"520px"}),c=r.element.querySelector("input"),d=r.element.querySelectorAll(".b3-button");r.bindInput(c,()=>{d[1].click()}),c.value=l.parentElement.getAttribute("data-name"),c.focus(),c.select(),d[0].addEventListener("click",()=>{r.destroy()}),d[1].addEventListener("click",()=>{A("/api/riff/renameRiffDeck",{name:c.value,deckID:l.parentElement.getAttribute("data-id")},()=>{l.parentElement.querySelector(".b3-list-item__text span").textContent=c.value,l.parentElement.setAttribute("data-name",c.value)}),r.destroy()}),i.stopPropagation(),i.preventDefault();break}l=l.parentElement}})})},po=(e,t)=>{let n=!0;const a=[];t.forEach(s=>{s.getAttribute("data-type")!=="NodeThematicBreak"&&(s.classList.remove("protyle-wysiwyg--select"),a.push(s.getAttribute("data-node-id")),(s.getAttribute(f.CUSTOM_RIFF_DECKS)||"").indexOf(f.QUICK_DECK_ID)===-1&&(n=!1))}),n?q(e,[{action:"removeFlashcards",deckID:f.QUICK_DECK_ID,blockIDs:a}],[{action:"addFlashcards",deckID:f.QUICK_DECK_ID,blockIDs:a}]):q(e,[{action:"addFlashcards",deckID:f.QUICK_DECK_ID,blockIDs:a}],[{action:"removeFlashcards",deckID:f.QUICK_DECK_ID,blockIDs:a}])},fd=e=>{window.siyuan.menus.menu.append(new M({id:"transferBlockRef",label:window.siyuan.languages.transferBlockRef,icon:"iconScrollHoriz",click(){const t=new we({title:window.siyuan.languages.transferBlockRef,content:`<div class="b3-dialog__content">
    <input class="b3-text-field fn__block" placeholder="${window.siyuan.languages.targetBlockID}">
    <div class="b3-label__text">${window.siyuan.languages.transferBlockRefTip}</div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:H()?"92vw":"520px"});t.element.setAttribute("data-key",f.DIALOG_TRANSFERBLOCKREF);const n=t.element.querySelector("input"),a=t.element.querySelectorAll(".b3-button");t.bindInput(n,()=>{a[1].click()}),n.focus(),a[0].addEventListener("click",()=>{t.destroy()}),a[1].addEventListener("click",()=>{A("/api/block/transferBlockRef",{fromID:e,toID:n.value}),t.destroy()})}}).element)},mo=e=>{const t=[];e.forEach(n=>{const a=n.getAttribute("data-node-id");a&&t.push({id:a,isDetached:!1})}),t.length>0&&_i("",e[0],n=>{const a=n.dataset.avId;q(void 0,[{action:"insertAttrViewBlock",avID:a,ignoreFillFilter:!0,srcs:t,blockID:n.dataset.blockId},{action:"doUpdateUpdated",id:n.dataset.blockId,data:U().format("YYYYMMDDHHmmss")}])})},Ms=(e,t,n)=>{var a,s;if(t&&((s=(a=e.title)==null?void 0:a.editElement)!=null&&s.contains(t.startContainer))||n==="title")_i("",e.breadcrumb.element,i=>{const l=i.dataset.avId;q(e,[{action:"insertAttrViewBlock",avID:l,ignoreFillFilter:!0,srcs:[{id:e.block.rootID,isDetached:!1}],blockID:i.dataset.blockId},{action:"doUpdateUpdated",id:i.dataset.blockId,data:U().format("YYYYMMDDHHmmss")}],[{action:"removeAttrViewBlock",srcIDs:[e.block.rootID],avID:l}]),X(t)});else{let i;const l=[];if(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").forEach(o=>{i||(i=o),l.push(o.getAttribute("data-node-id"))}),!i){const o=B(t.startContainer);o&&(i=o,l.push(o.getAttribute("data-node-id")))}i||(i=e.wysiwyg.element,l.push(e.block.rootID)),_i("",i,o=>{const r=[],c=[];l.forEach(u=>{r.push(u),c.push({id:u,isDetached:!1})});const d=o.dataset.avId;q(e,[{action:"insertAttrViewBlock",avID:d,ignoreFillFilter:!0,srcs:c,blockID:o.dataset.blockId},{action:"doUpdateUpdated",id:o.dataset.blockId,data:U().format("YYYYMMDDHHmmss")}],[{action:"removeAttrViewBlock",srcIDs:r,avID:d}]),X(t)})}};class Vg{constructor(t){Lt()?this.gutterTip=window.siyuan.languages.gutterTip.replace("\u2325\u2192",Me(window.siyuan.config.keymap.general.enter.custom)):this.gutterTip=window.siyuan.languages.gutterTip.replace("\u2325\u2192",Me(window.siyuan.config.keymap.general.enter.custom)).replace("\u2318\u2191",Me(window.siyuan.config.keymap.editor.general.collapse.custom)).replace("\u2325\u2318A",Me(window.siyuan.config.keymap.editor.general.attr.custom)).replace(/⌘/g,"Ctrl+").replace(/⌥/g,"Alt+").replace(/⇧/g,"Shift+").replace(/⌃/g,"Ctrl+"),t.options.backlinkData&&(this.gutterTip=this.gutterTip.replace(window.siyuan.languages.enter,window.siyuan.languages.openBy)),this.element=document.createElement("div"),this.element.className="protyle-gutters",this.element.addEventListener("dragstart",n=>{un(),window.siyuan.menus.menu.remove();const a=n.target.parentElement;let s=[],i=[],l;if(a.dataset.rowId){l=Array.from(t.wysiwyg.element.querySelectorAll(`.av[data-node-id="${a.dataset.nodeId}"]`)).find(c=>{if(!re(c))return!0});const r=l.querySelector(`.av__row[data-id="${a.dataset.rowId}"]`);r.classList.add("av__row--select"),r.querySelector(".av__firstcol use").setAttribute("xlink:href","#iconCheck"),ca(r),l.querySelectorAll(".av__row--select:not(.av__row--header)").forEach(c=>{s.push(c.getAttribute("data-id")),i.push(c)})}else{const r=a.getAttribute("data-node-id");i=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));let c=!1;if(i.forEach(d=>{const u=d.getAttribute("data-node-id");u===r&&(c=!0),s.push(u)}),!c){let d;Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${r}"]`)).find(u=>{if(!re(u)&&this.isMatchNode(u))return d=u,!0}),d&&(i.forEach(u=>{u.classList.remove("protyle-wysiwyg--select")}),d.classList.add("protyle-wysiwyg--select"),i=[d],s=[r])}}const o=document.createElement("div");o.className=t.wysiwyg.element.className,i.forEach(r=>{if(r.querySelector("iframe")){const c=r.getAttribute("data-type"),d=Xn();d.classList.add("protyle-wysiwyg--select"),oe(d).innerHTML=`<svg class="svg"><use xlink:href="${a.querySelector("use").getAttribute("xlink:href")}"></use></svg> ${Nf(c)}`,o.append(d)}else o.append(Hn(r.cloneNode(!0)))}),o.setAttribute("style",`position:fixed;opacity:.1;width:${i[0].clientWidth}px;padding:0;`),document.body.append(o),n.dataTransfer.setDragImage(o,0,0),setTimeout(()=>{o.remove()}),a.style.opacity="0.1",window.siyuan.dragElement=l||t.wysiwyg.element,n.dataTransfer.setData(`${f.SIYUAN_DROP_GUTTER}${a.getAttribute("data-type")}${f.ZWSP}${a.getAttribute("data-subtype")}${f.ZWSP}${s}${f.ZWSP}${window.siyuan.config.system.workspaceDir}`,t.wysiwyg.element.innerHTML)}),this.element.addEventListener("dragend",()=>{this.element.querySelectorAll("button").forEach(n=>{n.style.opacity=""}),window.siyuan.dragElement=void 0}),this.element.addEventListener("click",n=>{var a;const s=O(n.target,"BUTTON");if(!s)return;n.preventDefault(),n.stopPropagation(),un();const i=s.getAttribute("data-node-id");if(!i){if(s.getAttribute("disabled"))return;s.setAttribute("disabled","disabled");let o;if(Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${(s.previousElementSibling||s.nextElementSibling).getAttribute("data-node-id")}"]`)).find(r=>{if(!re(r)&&this.isMatchNode(r))return o=r,!0}),!o)return;if(n.altKey){let r=!0;Array.from(o.children).find(u=>{if(u.classList.contains("list")&&Array.from(u.children).find(g=>{if(g.classList.contains("li")&&g.getAttribute("fold")!=="1"&&g.childElementCount>3)return r=!1,!0}))return!0});const c=[],d=[];Array.from(o.children).forEach(u=>{u.classList.contains("list")&&Array.from(u.children).forEach(p=>{if(p.classList.contains("li")){r?p.removeAttribute("fold"):p.childElementCount>3&&p.setAttribute("fold","1");const g=p.getAttribute("data-node-id");c.push({action:"setAttrs",id:g,data:JSON.stringify({fold:r?"":"1"})}),d.push({action:"setAttrs",id:g,data:JSON.stringify({fold:r?"1":""})})}})}),q(t,c,d),s.removeAttribute("disabled")}else{const r=ht(t,o);r===1?s.firstElementChild.style.transform="":r===0&&(s.firstElementChild.style.transform="rotate(90deg)")}J(["select"],t),window.siyuan.menus.menu.remove();return}const l=s.getBoundingClientRect();if(s.dataset.type==="NodeAttributeViewRowMenu"||s.dataset.type==="NodeAttributeViewRow"){const o=Array.from(t.wysiwyg.element.querySelectorAll(`.av[data-node-id="${s.dataset.nodeId}"] .av__row[data-id="${s.dataset.rowId}"]`)).find(c=>{if(!re(c))return!0});if(!o)return;const r=B(o);if(!r)return;if(s.dataset.type==="NodeAttributeViewRow"){r.querySelectorAll(".av__cell--select, .av__cell--active").forEach(g=>{var m;g.classList.remove("av__cell--select","av__cell--active"),(m=g.querySelector(".av__drag-fill"))==null||m.remove()});const c=r.getAttribute("data-av-id"),d=[Lute.NewNodeID()],u=n.altKey?o.previousElementSibling.getAttribute("data-id")||"":s.dataset.rowId,p=U().format("YYYYMMDDHHmmss");q(t,[{action:"insertAttrViewBlock",avID:c,previousID:u,srcs:[{id:d[0],isDetached:!0,content:""}],blockID:i},{action:"doUpdateUpdated",id:i,data:p}],[{action:"removeAttrViewBlock",srcIDs:d,avID:c},{action:"doUpdateUpdated",id:i,data:r.getAttribute("updated")}]),Ss(t,r,d,u,c),n.altKey&&this.element.querySelectorAll("button").forEach(g=>{g.dataset.rowId=d[0]}),r.setAttribute("updated",p)}else{if(!t.disabled&&n.shiftKey){const c=(a=o.querySelector('[data-dtype="block"] .av__celltext--ref'))==null?void 0:a.getAttribute("data-id");if(c){A("/api/attr/getBlockAttrs",{id:c},d=>{qn(d.data,"av",t)});return}}ls(t,o,{x:l.left,y:l.bottom,w:l.width,h:l.height,isLeft:!0})}return}if(bt(n))t.options.backlinkData?Mn(i,(o,r)=>{openFileById({app:t.app,id:i,action:r,zoomIn:o})}):Ot({protyle:t,id:i});else if(n.altKey){let o;if(Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${i}"]`)).find(r=>{if(!re(r)&&this.isMatchNode(r))return o=r,!0}),!o)return;if(s.getAttribute("data-type")==="NodeListItem"&&o.parentElement.getAttribute("data-node-id")){let r=!0;Array.from(o.parentElement.children).find(u=>{if(u.classList.contains("li")&&u.getAttribute("fold")!=="1"&&u.childElementCount>3)return r=!1,!0}),s.parentElement.querySelector("[data-type='fold'] > svg").style.transform=r?"rotate(90deg)":"";const c=[],d=[];Array.from(o.parentElement.children).find(u=>{if(u.classList.contains("li")){r?u.removeAttribute("fold"):u.childElementCount>3&&u.setAttribute("fold","1");const p=u.getAttribute("data-node-id");c.push({action:"setAttrs",id:p,data:JSON.stringify({fold:r?"":"1"})}),d.push({action:"setAttrs",id:p,data:JSON.stringify({fold:r?"1":""})})}}),q(t,c,d)}else{const r=ht(t,o),c=s.parentElement.querySelector("[data-type='fold'] > svg");r!==-1&&c&&(c.style.transform=r===0?"rotate(90deg)":"")}o.classList.remove("protyle-wysiwyg--hl")}else window.siyuan.shiftIsPressed&&!t.disabled?Kn(t.wysiwyg.element.querySelector(`[data-node-id="${i}"]`),"bookmark",t):!window.siyuan.ctrlIsPressed&&!window.siyuan.altIsPressed&&!window.siyuan.shiftIsPressed&&(this.renderMenu(t,s),t.toolbar.range||(t.toolbar.range=ye(t.wysiwyg.element.querySelector(`[data-node-id="${i}"]`)||t.wysiwyg.element.firstElementChild)),window.siyuan.menus.menu.fullscreen())}),this.element.addEventListener("contextmenu",n=>{const a=O(n.target,"BUTTON");if(!(!a||a.getAttribute("data-type")==="fold")){if(!window.siyuan.ctrlIsPressed&&!window.siyuan.altIsPressed&&!window.siyuan.shiftIsPressed){un();const s=a.getBoundingClientRect();if(a.dataset.type==="NodeAttributeViewRowMenu"){const i=Array.from(t.wysiwyg.element.querySelectorAll(`.av[data-node-id="${a.dataset.nodeId}"] .av__row[data-id="${a.dataset.rowId}"]`)).find(l=>{if(!re(l))return!0});i&&ls(t,i,{x:s.left,y:s.bottom,w:s.width,h:s.height,isLeft:!0})}else a.dataset.type!=="NodeAttributeViewRow"&&(this.renderMenu(t,a),t.toolbar.range||(t.toolbar.range=ye(t.wysiwyg.element.querySelector(`[data-node-id="${a.getAttribute("data-node-id")}"]`)||t.wysiwyg.element.firstElementChild)),window.siyuan.menus.menu.fullscreen())}n.preventDefault(),n.stopPropagation()}}),this.element.addEventListener("mouseleave",n=>{Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl, .av__row--hl")).forEach(a=>{a.classList.remove("protyle-wysiwyg--hl","av__row--hl")}),n.preventDefault(),n.stopPropagation()}),this.element.addEventListener("mousewheel",n=>{J(["gutter"],t),n.stopPropagation()},{passive:!0})}isMatchNode(t){const n=t.getBoundingClientRect();let a=this.element.getBoundingClientRect().top+6;return n.height<Math.floor(window.siyuan.config.editor.fontSize*1.625)+8&&(a=a-(n.height-this.element.clientHeight)/2),n.top<=a&&n.bottom>=a}turnsOneInto(t){return{id:t.menuId,icon:t.icon,label:t.label,accelerator:t.accelerator,click(){Xa(t)}}}turnsIntoOne(t){return{id:t.menuId,icon:t.icon,label:t.label,accelerator:t.accelerator,click(){Kt(t)}}}turnsInto(t){return{id:t.menuId,icon:t.icon,label:t.label,accelerator:t.accelerator,click(){xn(t)}}}showMobileAppearance(t){const n=document.getElementById("keyboardToolbar"),a=n.querySelectorAll("#keyboardToolbar .keyboard__dynamic");a[0].classList.add("fn__none"),a[1].classList.remove("fn__none"),n.querySelector('.keyboard__action[data-type="text"]').classList.add("protyle-toolbar__item--current"),n.querySelector('.keyboard__action[data-type="done"] use').setAttribute("xlink:href","#iconCloseRound"),n.classList.remove("fn__none");const s=t.contentElement.scrollTop+333.5;Mr(t,n),hl(s)}renderMultipleMenu(t,n){var a;let s=!1,i=!1,l=!1;if(n.find((u,p)=>{if(u.classList.contains("li"))return s=!0,!0;if((u.classList.contains("sb")||u.classList.contains("p"))&&(l=!0),u.nextElementSibling&&n[p+1]&&u.nextElementSibling.isSameNode(n[p+1]))i=!0;else if(p!==n.length-1)return i=!1,!0}),!s&&!t.disabled){const u=[];i&&(u.push(this.turnsIntoOne({menuId:"list",icon:"iconList",label:window.siyuan.languages.list,protyle:t,accelerator:window.siyuan.config.keymap.editor.insert.list.custom,selectsElement:n,type:"Blocks2ULs"})),u.push(this.turnsIntoOne({menuId:"orderedList",icon:"iconOrderedList",label:window.siyuan.languages["ordered-list"],accelerator:window.siyuan.config.keymap.editor.insert["ordered-list"].custom,protyle:t,selectsElement:n,type:"Blocks2OLs"})),u.push(this.turnsIntoOne({menuId:"check",icon:"iconCheck",label:window.siyuan.languages.check,accelerator:window.siyuan.config.keymap.editor.insert.check.custom,protyle:t,selectsElement:n,type:"Blocks2TLs"})),u.push(this.turnsIntoOne({menuId:"quote",icon:"iconQuote",label:window.siyuan.languages.quote,accelerator:window.siyuan.config.keymap.editor.insert.quote.custom,protyle:t,selectsElement:n,type:"Blocks2Blockquote"}))),l||u.push(this.turnsInto({menuId:"paragraph",icon:"iconParagraph",label:window.siyuan.languages.paragraph,accelerator:window.siyuan.config.keymap.editor.heading.paragraph.custom,protyle:t,selectsElement:n,type:"Blocks2Ps",isContinue:i})),u.push(this.turnsInto({menuId:"heading1",icon:"iconH1",label:window.siyuan.languages.heading1,accelerator:window.siyuan.config.keymap.editor.heading.heading1.custom,protyle:t,selectsElement:n,level:1,type:"Blocks2Hs",isContinue:i})),u.push(this.turnsInto({menuId:"heading2",icon:"iconH2",label:window.siyuan.languages.heading2,accelerator:window.siyuan.config.keymap.editor.heading.heading2.custom,protyle:t,selectsElement:n,level:2,type:"Blocks2Hs",isContinue:i})),u.push(this.turnsInto({menuId:"heading3",icon:"iconH3",label:window.siyuan.languages.heading3,accelerator:window.siyuan.config.keymap.editor.heading.heading3.custom,protyle:t,selectsElement:n,level:3,type:"Blocks2Hs",isContinue:i})),u.push(this.turnsInto({menuId:"heading4",icon:"iconH4",label:window.siyuan.languages.heading4,accelerator:window.siyuan.config.keymap.editor.heading.heading4.custom,protyle:t,selectsElement:n,level:4,type:"Blocks2Hs",isContinue:i})),u.push(this.turnsInto({menuId:"heading5",icon:"iconH5",label:window.siyuan.languages.heading5,accelerator:window.siyuan.config.keymap.editor.heading.heading5.custom,protyle:t,selectsElement:n,level:5,type:"Blocks2Hs",isContinue:i})),u.push(this.turnsInto({menuId:"heading6",icon:"iconH6",label:window.siyuan.languages.heading6,accelerator:window.siyuan.config.keymap.editor.heading.heading6.custom,protyle:t,selectsElement:n,level:6,type:"Blocks2Hs",isContinue:i})),window.siyuan.menus.menu.append(new M({id:"turnInto",icon:"iconRefresh",label:window.siyuan.languages.turnInto,type:"submenu",submenu:u}).element),i&&!(n[0].parentElement.classList.contains("sb")&&n.length+1===n[0].parentElement.childElementCount)&&window.siyuan.menus.menu.append(new M({id:"mergeSuperBlock",icon:"iconSuper",label:window.siyuan.languages.merge+" "+window.siyuan.languages.superBlock,type:"submenu",submenu:[this.turnsIntoOne({menuId:"hLayout",label:window.siyuan.languages.hLayout,accelerator:window.siyuan.config.keymap.editor.general.hLayout.custom,icon:"iconSplitLR",protyle:t,selectsElement:n,type:"BlocksMergeSuperBlock",level:"col"}),this.turnsIntoOne({menuId:"vLayout",label:window.siyuan.languages.vLayout,accelerator:window.siyuan.config.keymap.editor.general.vLayout.custom,icon:"iconSplitTB",protyle:t,selectsElement:n,type:"BlocksMergeSuperBlock",level:"row"})]}).element)}t.disabled||window.siyuan.menus.menu.append(new M({id:"ai",icon:"iconSparkles",label:window.siyuan.languages.ai,accelerator:window.siyuan.config.keymap.editor.general.ai.custom,click(){co(n,t)}}).element);const o=Ba(Array.from(n).map(u=>u.getAttribute("data-node-id")),!0,n[0]).concat([{id:"copyPlainText",iconHTML:"",label:window.siyuan.languages.copyPlainText,accelerator:window.siyuan.config.keymap.editor.general.copyPlainText.custom,click(){let u="";n.forEach(p=>{u+=As(p)+`
`}),Xi(u.trimEnd()),ne(n[0])}},{id:"copy",iconHTML:"",label:window.siyuan.languages.copy,accelerator:"\u2318C",click(){At(n[0])?ne(n[0]):X(ye(n[0])),document.execCommand("copy")}},{id:"duplicate",iconHTML:"",label:window.siyuan.languages.duplicate,accelerator:window.siyuan.config.keymap.editor.general.duplicate.custom,disabled:t.disabled,click(){Ur(n,t)}}]);o.splice(4,1,{id:"copyHPath",iconHTML:"",label:window.siyuan.languages.copyHPath,accelerator:window.siyuan.config.keymap.editor.general.copyHPath.custom,click:()=>{La([n[0].getAttribute("data-node-id")],"hPath"),ne(n[0])}});const r=this.genCopyTextRef(n);if(r&&o.splice(7,0,r),window.siyuan.menus.menu.append(new M({id:"copy",label:window.siyuan.languages.copy,icon:"iconCopy",type:"submenu",submenu:o}).element),t.disabled)return;window.siyuan.menus.menu.append(new M({id:"cut",label:window.siyuan.languages.cut,accelerator:"\u2318X",icon:"iconCut",click:()=>{ne(n[0]),document.execCommand("cut")}}).element),window.siyuan.menus.menu.append(new M({id:"move",label:window.siyuan.languages.move,accelerator:window.siyuan.config.keymap.general.move.custom,icon:"iconMove",click:()=>{Wn(u=>{ro(u[0],n,t)})}}).element);const c=getSelection().rangeCount>0?getSelection().getRangeAt(0):void 0;window.siyuan.menus.menu.append(new M({id:"addToDatabase",label:window.siyuan.languages.addToDatabase,accelerator:window.siyuan.config.keymap.general.addToDatabase.custom,icon:"iconDatabase",click:()=>{Ms(t,c)}}).element),window.siyuan.menus.menu.append(new M({id:"delete",label:window.siyuan.languages.delete,icon:"iconTrashcan",accelerator:"\u232B",click:()=>{var u;(u=t.breadcrumb)==null||u.hide(),ln(t,n[0],ye(n[0]),"Backspace")}}).element),window.siyuan.menus.menu.append(new M({id:"separator_appearance",type:"separator"}).element);const d=new M({id:"appearance",label:window.siyuan.languages.appearance,icon:"iconFont",accelerator:window.siyuan.config.keymap.editor.insert.appearance.custom,click:()=>{this.showMobileAppearance(t)}}).element;return window.siyuan.menus.menu.append(d),H()||d.lastElementChild.classList.add("b3-menu__submenu--row"),this.genAlign(n,t),this.genWidths(n,t),window.siyuan.config.readonly||(window.siyuan.menus.menu.append(new M({id:"separator_quickMakeCard",type:"separator"}).element),window.siyuan.menus.menu.append(new M({id:"quickMakeCard",label:window.siyuan.languages.quickMakeCard,accelerator:window.siyuan.config.keymap.editor.general.quickMakeCard.custom,iconHTML:'<svg class="b3-menu__icon" style="color:var(--b3-theme-primary)"><use xlink:href="#iconRiffCard"></use></svg>',icon:"iconRiffCard",click(){po(t,n)}}).element),window.siyuan.menus.menu.append(new M({id:"addToDeck",label:window.siyuan.languages.addToDeck,icon:"iconRiffCard",ignore:!window.siyuan.config.flashcard.deck,click(){const u=[];n.forEach(p=>{p.getAttribute("data-type")!=="NodeThematicBreak"&&u.push(p.getAttribute("data-node-id"))}),Ui(t.app,u)}}).element)),(a=t==null?void 0:t.app)!=null&&a.plugins&&jt({plugins:t.app.plugins,type:"click-blockicon",detail:{protyle:t,blockElements:n},separatorPosition:"top"}),window.siyuan.menus.menu}renderMenu(t,n){var a,s;if(!n)return;J(["util","toolbar","hint"],t),window.siyuan.menus.menu.remove(),H()&&fn();const i=n.getAttribute("data-node-id"),l=t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(l.length>1&&Array.from(l).find(b=>{if(i===b.getAttribute("data-node-id"))return!0}))return this.renderMultipleMenu(t,Array.from(l));let o;if(n.tagName==="BUTTON"?Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${i}"]`)).find(m=>{if(!re(m)&&this.isMatchNode(m))return o=m,!0}):o=n,!o)return;const r=o.getAttribute("data-type"),c=o.getAttribute("data-subtype"),d=[];J(["select"],t),o.classList.add("protyle-wysiwyg--select"),Ht([i],t.block.rootID),r==="NodeParagraph"&&!t.disabled?(d.push(this.turnsIntoOne({menuId:"list",icon:"iconList",label:window.siyuan.languages.list,accelerator:window.siyuan.config.keymap.editor.insert.list.custom,protyle:t,selectsElement:[o],type:"Blocks2ULs"})),d.push(this.turnsIntoOne({menuId:"orderedList",icon:"iconOrderedList",label:window.siyuan.languages["ordered-list"],accelerator:window.siyuan.config.keymap.editor.insert["ordered-list"].custom,protyle:t,selectsElement:[o],type:"Blocks2OLs"})),d.push(this.turnsIntoOne({menuId:"check",icon:"iconCheck",label:window.siyuan.languages.check,accelerator:window.siyuan.config.keymap.editor.insert.check.custom,protyle:t,selectsElement:[o],type:"Blocks2TLs"})),d.push(this.turnsIntoOne({menuId:"quote",icon:"iconQuote",label:window.siyuan.languages.quote,accelerator:window.siyuan.config.keymap.editor.insert.quote.custom,protyle:t,selectsElement:[o],type:"Blocks2Blockquote"})),d.push(this.turnsInto({menuId:"heading1",icon:"iconH1",label:window.siyuan.languages.heading1,accelerator:window.siyuan.config.keymap.editor.heading.heading1.custom,protyle:t,selectsElement:[o],level:1,type:"Blocks2Hs"})),d.push(this.turnsInto({menuId:"heading2",icon:"iconH2",label:window.siyuan.languages.heading2,accelerator:window.siyuan.config.keymap.editor.heading.heading2.custom,protyle:t,selectsElement:[o],level:2,type:"Blocks2Hs"})),d.push(this.turnsInto({menuId:"heading3",icon:"iconH3",label:window.siyuan.languages.heading3,accelerator:window.siyuan.config.keymap.editor.heading.heading3.custom,protyle:t,selectsElement:[o],level:3,type:"Blocks2Hs"})),d.push(this.turnsInto({menuId:"heading4",icon:"iconH4",label:window.siyuan.languages.heading4,accelerator:window.siyuan.config.keymap.editor.heading.heading4.custom,protyle:t,selectsElement:[o],level:4,type:"Blocks2Hs"})),d.push(this.turnsInto({menuId:"heading5",icon:"iconH5",label:window.siyuan.languages.heading5,accelerator:window.siyuan.config.keymap.editor.heading.heading5.custom,protyle:t,selectsElement:[o],level:5,type:"Blocks2Hs"})),d.push(this.turnsInto({menuId:"heading6",icon:"iconH6",label:window.siyuan.languages.heading6,accelerator:window.siyuan.config.keymap.editor.heading.heading6.custom,protyle:t,selectsElement:[o],level:6,type:"Blocks2Hs"}))):r==="NodeHeading"&&!t.disabled?(d.push(this.turnsInto({menuId:"paragraph",icon:"iconParagraph",label:window.siyuan.languages.paragraph,accelerator:window.siyuan.config.keymap.editor.heading.paragraph.custom,protyle:t,selectsElement:[o],type:"Blocks2Ps"})),d.push(this.turnsIntoOne({menuId:"quote",icon:"iconQuote",label:window.siyuan.languages.quote,accelerator:window.siyuan.config.keymap.editor.insert.quote.custom,protyle:t,selectsElement:[o],type:"Blocks2Blockquote"})),c!=="h1"&&d.push(this.turnsInto({menuId:"heading1",icon:"iconH1",label:window.siyuan.languages.heading1,accelerator:window.siyuan.config.keymap.editor.heading.heading1.custom,protyle:t,selectsElement:[o],level:1,type:"Blocks2Hs"})),c!=="h2"&&d.push(this.turnsInto({menuId:"heading2",icon:"iconH2",label:window.siyuan.languages.heading2,accelerator:window.siyuan.config.keymap.editor.heading.heading2.custom,protyle:t,selectsElement:[o],level:2,type:"Blocks2Hs"})),c!=="h3"&&d.push(this.turnsInto({menuId:"heading3",icon:"iconH3",label:window.siyuan.languages.heading3,accelerator:window.siyuan.config.keymap.editor.heading.heading3.custom,protyle:t,selectsElement:[o],level:3,type:"Blocks2Hs"})),c!=="h4"&&d.push(this.turnsInto({menuId:"heading4",icon:"iconH4",label:window.siyuan.languages.heading4,accelerator:window.siyuan.config.keymap.editor.heading.heading4.custom,protyle:t,selectsElement:[o],level:4,type:"Blocks2Hs"})),c!=="h5"&&d.push(this.turnsInto({menuId:"heading5",icon:"iconH5",label:window.siyuan.languages.heading5,accelerator:window.siyuan.config.keymap.editor.heading.heading5.custom,protyle:t,selectsElement:[o],level:5,type:"Blocks2Hs"})),c!=="h6"&&d.push(this.turnsInto({menuId:"heading6",icon:"iconH6",label:window.siyuan.languages.heading6,accelerator:window.siyuan.config.keymap.editor.heading.heading6.custom,protyle:t,selectsElement:[o],level:6,type:"Blocks2Hs"}))):r==="NodeList"&&!t.disabled?(d.push(this.turnsOneInto({menuId:"paragraph",id:i,icon:"iconParagraph",label:window.siyuan.languages.paragraph,accelerator:window.siyuan.config.keymap.editor.heading.paragraph.custom,protyle:t,nodeElement:o,type:"CancelList"})),d.push(this.turnsIntoOne({menuId:"quote",icon:"iconQuote",label:window.siyuan.languages.quote,accelerator:window.siyuan.config.keymap.editor.insert.quote.custom,protyle:t,selectsElement:[o],type:"Blocks2Blockquote"})),o.getAttribute("data-subtype")==="o"?(d.push(this.turnsOneInto({menuId:"list",id:i,icon:"iconList",label:window.siyuan.languages.list,accelerator:window.siyuan.config.keymap.editor.insert.list.custom,protyle:t,nodeElement:o,type:"OL2UL"})),d.push(this.turnsOneInto({menuId:"check",id:i,icon:"iconCheck",label:window.siyuan.languages.check,accelerator:window.siyuan.config.keymap.editor.insert.check.custom,protyle:t,nodeElement:o,type:"UL2TL"}))):o.getAttribute("data-subtype")==="t"?(d.push(this.turnsOneInto({menuId:"list",id:i,icon:"iconList",label:window.siyuan.languages.list,accelerator:window.siyuan.config.keymap.editor.insert.list.custom,protyle:t,nodeElement:o,type:"TL2UL"})),d.push(this.turnsOneInto({menuId:"orderedList",id:i,icon:"iconOrderedList",label:window.siyuan.languages["ordered-list"],accelerator:window.siyuan.config.keymap.editor.insert["ordered-list"].custom,protyle:t,nodeElement:o,type:"TL2OL"}))):(d.push(this.turnsOneInto({menuId:"orderedList",id:i,icon:"iconOrderedList",label:window.siyuan.languages["ordered-list"],accelerator:window.siyuan.config.keymap.editor.insert["ordered-list"].custom,protyle:t,nodeElement:o,type:"UL2OL"})),d.push(this.turnsOneInto({menuId:"check",id:i,icon:"iconCheck",label:window.siyuan.languages.check,accelerator:window.siyuan.config.keymap.editor.insert.check.custom,protyle:t,nodeElement:o,type:"OL2TL"})))):r==="NodeBlockquote"&&!t.disabled&&d.push(this.turnsOneInto({menuId:"paragraph",id:i,icon:"iconParagraph",label:window.siyuan.languages.paragraph,accelerator:window.siyuan.config.keymap.editor.heading.paragraph.custom,protyle:t,nodeElement:o,type:"CancelBlockquote"})),d.length>0&&!t.disabled&&window.siyuan.menus.menu.append(new M({id:"turnInto",icon:"iconRefresh",label:window.siyuan.languages.turnInto,type:"submenu",submenu:d}).element),!t.disabled&&!o.classList.contains("hr")&&window.siyuan.menus.menu.append(new M({id:"ai",icon:"iconSparkles",label:window.siyuan.languages.ai,accelerator:window.siyuan.config.keymap.editor.general.ai.custom,click(){co([o],t)}}).element);const u=Ba([i],!0,o).concat([{id:"copyPlainText",iconHTML:"",label:window.siyuan.languages.copyPlainText,accelerator:window.siyuan.config.keymap.editor.general.copyPlainText.custom,click(){Xi(As(o).trimEnd()),ne(o)}},{id:r==="NodeAttributeView"?"copyMirror":"copy",iconHTML:"",label:r==="NodeAttributeView"?window.siyuan.languages.copyMirror:window.siyuan.languages.copy,accelerator:"\u2318C",click(){At(o)?ne(o):X(ye(o)),document.execCommand("copy")}},{id:r==="NodeAttributeView"?"duplicateMirror":"duplicate",iconHTML:"",label:r==="NodeAttributeView"?window.siyuan.languages.duplicateMirror:window.siyuan.languages.duplicate,accelerator:window.siyuan.config.keymap.editor.general.duplicate.custom,disabled:t.disabled,click(){Ur([o],t)}}]);r==="NodeAttributeView"&&u.push({id:"duplicateCompletely",iconHTML:"",label:window.siyuan.languages.duplicateCompletely,accelerator:window.siyuan.config.keymap.editor.general.duplicateCompletely.custom,disabled:t.disabled,click(){Ou(t,o)}});const p=this.genCopyTextRef([o]);if(p&&u.splice(7,0,p),window.siyuan.menus.menu.append(new M({id:"copy",icon:"iconCopy",label:window.siyuan.languages.copy,type:"submenu",submenu:u}).element),!t.disabled){window.siyuan.menus.menu.append(new M({id:"cut",icon:"iconCut",label:window.siyuan.languages.cut,accelerator:"\u2318X",click:()=>{ne(o),document.execCommand("cut")}}).element),window.siyuan.menus.menu.append(new M({id:"move",icon:"iconMove",label:window.siyuan.languages.move,accelerator:window.siyuan.config.keymap.general.move.custom,click:()=>{Wn(b=>{ro(b[0],[o],t)})}}).element);const m=getSelection().rangeCount>0?getSelection().getRangeAt(0):void 0;window.siyuan.menus.menu.append(new M({id:"addToDatabase",icon:"iconDatabase",label:window.siyuan.languages.addToDatabase,accelerator:window.siyuan.config.keymap.general.addToDatabase.custom,click:()=>{Ms(t,m)}}).element),window.siyuan.menus.menu.append(new M({id:"delete",icon:"iconTrashcan",label:window.siyuan.languages.delete,accelerator:"\u232B",click:()=>{var b;(b=t.breadcrumb)==null||b.hide(),ln(t,o,ye(o),"Backspace")}}).element)}if(r==="NodeSuperBlock"&&!t.disabled){window.siyuan.menus.menu.append(new M({id:"separator_cancelSuperBlock",type:"separator"}).element);const m=o.getAttribute("data-sb-layout")==="col";window.siyuan.menus.menu.append(new M({id:"cancelSuperBlock",label:window.siyuan.languages.cancel+" "+window.siyuan.languages.superBlock,accelerator:window.siyuan.config.keymap.editor.general[m?"hLayout":"vLayout"].custom,click(){const b=sa(t,o);q(t,b.doOperations,b.undoOperations),ne(t.wysiwyg.element.querySelector(`[data-node-id="${b.previousId}"]`)),J(["gutter"],t)}}).element),window.siyuan.menus.menu.append(new M({id:"turnInto"+(m?"VLayout":"HLayout"),accelerator:window.siyuan.config.keymap.editor.general[m?"vLayout":"hLayout"].custom,label:window.siyuan.languages.turnInto+" "+window.siyuan.languages[m?"vLayout":"hLayout"],click(){const b=o.outerHTML;m?o.setAttribute("data-sb-layout","row"):o.setAttribute("data-sb-layout","col"),o.setAttribute("updated",U().format("YYYYMMDDHHmmss")),K(t,i,o.outerHTML,b),X(t.toolbar.range),J(["gutter"],t)}}).element)}else if(r==="NodeCodeBlock"&&!t.disabled&&!o.getAttribute("data-subtype")){window.siyuan.menus.menu.append(new M({id:"separator_code",type:"separator"}).element);const m=o.getAttribute("linewrap"),b=o.getAttribute("ligatures"),y=o.getAttribute("linenumber");window.siyuan.menus.menu.append(new M({id:"code",type:"submenu",icon:"iconCode",label:window.siyuan.languages.code,submenu:[{id:"md31",iconHTML:"",label:`<div class="fn__flex" style="margin-bottom: 4px"><span>${window.siyuan.languages.md31}</span><span class="fn__space fn__flex-1"></span>
<input type="checkbox" class="b3-switch fn__flex-center"${m==="true"||window.siyuan.config.editor.codeLineWrap&&m!=="false"?" checked":""}></div>`,bind(_){_.addEventListener("click",w=>{const v=_.querySelector("input");w.target.tagName!=="INPUT"&&(v.checked=!v.checked),o.setAttribute("linewrap",v.checked.toString()),o.querySelector(".hljs").removeAttribute("data-render"),Pe(o),A("/api/attr/setBlockAttrs",{id:i,attrs:{linewrap:v.checked.toString()}}),window.siyuan.menus.menu.remove()})}},{id:"md2",iconHTML:"",label:`<div class="fn__flex" style="margin-bottom: 4px"><span>${window.siyuan.languages.md2}</span><span class="fn__space fn__flex-1"></span>
<input type="checkbox" class="b3-switch fn__flex-center"${b==="true"||window.siyuan.config.editor.codeLigatures&&b!=="false"?" checked":""}></div>`,bind(_){_.addEventListener("click",w=>{const v=_.querySelector("input");w.target.tagName!=="INPUT"&&(v.checked=!v.checked),o.setAttribute("ligatures",v.checked.toString()),o.querySelector(".hljs").removeAttribute("data-render"),Pe(o),A("/api/attr/setBlockAttrs",{id:i,attrs:{ligatures:v.checked.toString()}}),window.siyuan.menus.menu.remove()})}},{id:"md27",iconHTML:"",label:`<div class="fn__flex" style="margin-bottom: 4px"><span>${window.siyuan.languages.md27}</span><span class="fn__space fn__flex-1"></span>
<input type="checkbox" class="b3-switch fn__flex-center"${y==="true"||window.siyuan.config.editor.codeSyntaxHighlightLineNum&&y!=="false"?" checked":""}></div>`,bind(_){_.addEventListener("click",w=>{const v=_.querySelector("input");w.target.tagName!=="INPUT"&&(v.checked=!v.checked),o.setAttribute("linenumber",v.checked.toString()),o.querySelector(".hljs").removeAttribute("data-render"),Pe(o),A("/api/attr/setBlockAttrs",{id:i,attrs:{linenumber:v.checked.toString()}}),window.siyuan.menus.menu.remove()})}}]}).element)}else if(r==="NodeCodeBlock"&&!t.disabled&&["echarts","mindmap"].includes(o.getAttribute("data-subtype"))){window.siyuan.menus.menu.append(new M({id:"separator_chart",type:"separator"}).element);const m=o.style.height;let b=o.outerHTML;window.siyuan.menus.menu.append(new M({id:"chart",label:window.siyuan.languages.chart,icon:"iconCode",submenu:[{id:"height",label:`${window.siyuan.languages.height}<span class="fn__space"></span>
<input style="margin: 4px 0;width: 84px" type="number" step="1" min="148" class="b3-text-field" value="${m?parseInt(m):"420"}">`,bind:y=>{y.querySelector("input").addEventListener("change",_=>{const w=(_.target.value||"420")+"px";o.style.height=w,o.firstElementChild.nextElementSibling.style.height=w,K(t,i,o.outerHTML,b),b=o.outerHTML,_.stopPropagation();const v=window.echarts.getInstanceById(o.firstElementChild.nextElementSibling.getAttribute("_echarts_instance_"));v&&v.resize()})}},{id:"update",label:window.siyuan.languages.update,icon:"iconEdit",click(){t.toolbar.showRender(t,o)}}]}).element)}else if(r==="NodeTable"&&!t.disabled){let m=ye(o);const b=o.querySelector("table");b.contains(m.startContainer)||(m=ye(b.querySelector("th")));const y=O(m.startContainer,"TD")||O(m.startContainer,"TH");y&&(window.siyuan.menus.menu.append(new M({id:"separator_table",type:"separator"}).element),window.siyuan.menus.menu.append(new M({id:"table",type:"submenu",icon:"iconTable",label:window.siyuan.languages.table,submenu:If(t,o,y,m).menus}).element))}else if(r==="NodeAttributeView"&&!t.disabled)window.siyuan.menus.menu.append(new M({id:"separator_exportCSV",type:"separator"}).element),window.siyuan.menus.menu.append(new M({id:"exportCSV",icon:"iconDatabase",label:window.siyuan.languages.export+" CSV",click(){A("/api/export/exportAttributeView",{id:o.getAttribute("data-av-id"),blockID:i},m=>{Et(m.data.zip)})}}).element);else if((r==="NodeVideo"||r==="NodeAudio")&&!t.disabled)window.siyuan.menus.menu.append(new M({id:"separator_VideoOrAudio",type:"separator"}).element),window.siyuan.menus.menu.append(new M({id:r==="NodeVideo"?"assetVideo":"assetAudio",type:"submenu",icon:r==="NodeVideo"?"iconVideo":"iconRecord",label:window.siyuan.languages.assets,submenu:$f(t,o,r)}).element);else if(r==="NodeIFrame"&&!t.disabled)window.siyuan.menus.menu.append(new M({id:"separator_IFrame",type:"separator"}).element),window.siyuan.menus.menu.append(new M({id:"assetIFrame",type:"submenu",icon:"iconLanguage",label:window.siyuan.languages.assets,submenu:Tf(t,o)}).element);else if(r==="NodeHTMLBlock"&&!t.disabled)window.siyuan.menus.menu.append(new M({id:"separator_html",type:"separator"}).element),window.siyuan.menus.menu.append(new M({id:"html",icon:"iconHTML5",label:"HTML",click(){t.toolbar.showRender(t,o)}}).element);else if(r==="NodeBlockQueryEmbed"&&!t.disabled){window.siyuan.menus.menu.append(new M({id:"separator_blockEmbed",type:"separator"}).element);const m=o.getAttribute("breadcrumb");window.siyuan.menus.menu.append(new M({id:"blockEmbed",type:"submenu",icon:"iconSQL",label:window.siyuan.languages.blockEmbed,submenu:[{id:"refresh",icon:"iconRefresh",label:`${window.siyuan.languages.refresh} SQL`,click(){o.removeAttribute("data-render"),Se(t,o)}},{id:"update",icon:"iconEdit",label:`${window.siyuan.languages.update} SQL`,click(){t.toolbar.showRender(t,o)}},{type:"separator"},{id:"embedBlockBreadcrumb",label:`<div class="fn__flex" style="margin-bottom: 4px"><span>${window.siyuan.languages.embedBlockBreadcrumb}</span><span class="fn__space fn__flex-1"></span>
<input type="checkbox" class="b3-switch fn__flex-center"${m==="true"||window.siyuan.config.editor.embedBlockBreadcrumb&&m!=="false"?" checked":""}></div>`,bind(b){b.addEventListener("click",y=>{const _=b.querySelector("input");y.target.tagName!=="INPUT"&&(_.checked=!_.checked),o.setAttribute("breadcrumb",_.checked.toString()),A("/api/attr/setBlockAttrs",{id:i,attrs:{breadcrumb:_.checked.toString()}}),o.removeAttribute("data-render"),Se(t,o),window.siyuan.menus.menu.remove()})}},{id:"hideHeadingBelowBlocks",label:`<div class="fn__flex" style="margin-bottom: 4px"><span>${window.siyuan.languages.hideHeadingBelowBlocks}</span><span class="fn__space fn__flex-1"></span>
<input type="checkbox" class="b3-switch fn__flex-center"${o.getAttribute("custom-heading-mode")==="1"?" checked":""}></div>`,bind(b){b.addEventListener("click",y=>{const _=b.querySelector("input");y.target.tagName!=="INPUT"&&(_.checked=!_.checked),o.setAttribute("custom-heading-mode",_.checked?"1":"0"),A("/api/attr/setBlockAttrs",{id:i,attrs:{"custom-heading-mode":_.checked?"1":"0"}}),o.removeAttribute("data-render"),Se(t,o),window.siyuan.menus.menu.remove()})}}]}).element)}else if(r==="NodeHeading"&&!t.disabled){window.siyuan.menus.menu.append(new M({id:"separator_1",type:"separator"}).element);const m=[];c!=="h1"&&m.push(this.genHeadingTransform(t,i,1)),c!=="h2"&&m.push(this.genHeadingTransform(t,i,2)),c!=="h3"&&m.push(this.genHeadingTransform(t,i,3)),c!=="h4"&&m.push(this.genHeadingTransform(t,i,4)),c!=="h5"&&m.push(this.genHeadingTransform(t,i,5)),c!=="h6"&&m.push(this.genHeadingTransform(t,i,6)),window.siyuan.menus.menu.append(new M({id:"tWithSubtitle",type:"submenu",icon:"iconRefresh",label:window.siyuan.languages.tWithSubtitle,submenu:m}).element),window.siyuan.menus.menu.append(new M({id:"copyHeadings1",icon:"iconCopy",label:`${window.siyuan.languages.copy} ${window.siyuan.languages.headings1}`,click(){A("/api/block/getHeadingChildrenDOM",{id:i},b=>{ft()?window.JSAndroid.writeHTMLClipboard(t.lute.BlockDOM2StdMd(b.data).trimEnd(),b.data+f.ZWSP):yt()?window.JSHarmony.writeHTMLClipboard(t.lute.BlockDOM2StdMd(b.data).trimEnd(),b.data+f.ZWSP):Be(b.data+f.ZWSP)})}}).element),window.siyuan.menus.menu.append(new M({id:"cutHeadings1",icon:"iconCut",label:`${window.siyuan.languages.cut} ${window.siyuan.languages.headings1}`,click(){A("/api/block/getHeadingChildrenDOM",{id:i},b=>{ft()?window.JSAndroid.writeHTMLClipboard(t.lute.BlockDOM2StdMd(b.data).trimEnd(),b.data+f.ZWSP):yt()?window.JSHarmony.writeHTMLClipboard(t.lute.BlockDOM2StdMd(b.data).trimEnd(),b.data+f.ZWSP):Be(b.data+f.ZWSP),A("/api/block/getHeadingDeleteTransaction",{id:i},y=>{y.data.doOperations.forEach(_=>{t.wysiwyg.element.querySelectorAll(`[data-node-id="${_.id}"]`).forEach(w=>{w.remove()})}),q(t,y.data.doOperations,y.data.undoOperations)})})}}).element),window.siyuan.menus.menu.append(new M({id:"deleteHeadings1",icon:"iconTrashcan",label:`${window.siyuan.languages.delete} ${window.siyuan.languages.headings1}`,click(){A("/api/block/getHeadingDeleteTransaction",{id:i},b=>{b.data.doOperations.forEach(y=>{t.wysiwyg.element.querySelectorAll(`[data-node-id="${y.id}"]`).forEach(_=>{_.remove()})}),q(t,b.data.doOperations,b.data.undoOperations)})}}).element)}if(window.siyuan.menus.menu.append(new M({id:"separator_2",type:"separator"}).element),t.options.backlinkData||(window.siyuan.menus.menu.append(new M({id:"enter",accelerator:`${Me(window.siyuan.config.keymap.general.enter.custom)}/${Me("\u2318"+window.siyuan.languages.click)}`,label:window.siyuan.languages.enter,click:()=>{Ot({protyle:t,id:i})}}).element),window.siyuan.menus.menu.append(new M({id:"enterBack",accelerator:window.siyuan.config.keymap.general.enterBack.custom,label:window.siyuan.languages.enterBack,click:()=>{Dl(t,i)}}).element)),!t.disabled){window.siyuan.menus.menu.append(new M({id:"insertBefore",icon:"iconBefore",label:window.siyuan.languages["insert-before"],accelerator:window.siyuan.config.keymap.editor.general.insertBefore.custom,click(){J(["select"],t),Ht([],t.block.rootID),Rt(t,"beforebegin",i)}}).element),window.siyuan.menus.menu.append(new M({id:"insertAfter",icon:"iconAfter",label:window.siyuan.languages["insert-after"],accelerator:window.siyuan.config.keymap.editor.general.insertAfter.custom,click(){J(["select"],t),Ht([],t.block.rootID),Rt(t,"afterend",i)}}).element);const m=o.lastElementChild.querySelector(".protyle-attr--refcount");m&&m.textContent&&fd(i)}if(window.siyuan.menus.menu.append(new M({id:"jumpToParentNext",label:window.siyuan.languages.jumpToParentNext,accelerator:window.siyuan.config.keymap.editor.general.jumpToParentNext.custom,click(){J(["select"],t),ja(t,o,"next")}}).element),window.siyuan.menus.menu.append(new M({id:"jumpToParentPrev",label:window.siyuan.languages.jumpToParentPrev,accelerator:window.siyuan.config.keymap.editor.general.jumpToParentPrev.custom,click(){J(["select"],t),ja(t,o,"previous")}}).element),window.siyuan.menus.menu.append(new M({id:"jumpToParent",label:window.siyuan.languages.jumpToParent,accelerator:window.siyuan.config.keymap.editor.general.jumpToParent.custom,click(){J(["select"],t),ja(t,o,"parent")}}).element),window.siyuan.menus.menu.append(new M({id:"separator_3",type:"separator"}).element),r!=="NodeThematicBreak"&&(window.siyuan.menus.menu.append(new M({id:"fold",label:window.siyuan.languages.fold,accelerator:`${Me(window.siyuan.config.keymap.editor.general.collapse.custom)}/${Me("\u2325"+window.siyuan.languages.click)}`,click(){ht(t,o),ne(o)}}).element),t.disabled||window.siyuan.menus.menu.append(new M({id:"attr",label:window.siyuan.languages.attr,icon:"iconAttr",accelerator:window.siyuan.config.keymap.editor.general.attr.custom+"/"+Me("\u21E7"+window.siyuan.languages.click),click(){Kn(o,"bookmark",t)}}).element)),!t.disabled){const m=new M({id:"appearance",label:window.siyuan.languages.appearance,icon:"iconFont",accelerator:window.siyuan.config.keymap.editor.insert.appearance.custom,click:()=>{this.showMobileAppearance(t)}}).element;window.siyuan.menus.menu.append(m),H()||m.lastElementChild.classList.add("b3-menu__submenu--row"),this.genAlign([o],t),this.genWidths([o],t)}window.siyuan.menus.menu.append(new M({id:"separator_4",type:"separator"}).element),window.siyuan.config.cloudRegion===0&&!["NodeThematicBreak","NodeBlockQueryEmbed","NodeIFrame","NodeHTMLBlock","NodeWidget","NodeVideo","NodeAudio"].includes(r)&&((a=oe(o))==null?void 0:a.textContent.trim())!==""&&(r!=="NodeCodeBlock"||r==="NodeCodeBlock"&&!o.getAttribute("data-subtype"))&&window.siyuan.menus.menu.append(new M({id:"wechatReminder",icon:"iconMp",label:window.siyuan.languages.wechatReminder,ignore:window.siyuan.config.readonly,click(){ju(o)}}).element),r!=="NodeThematicBreak"&&!window.siyuan.config.readonly&&(window.siyuan.menus.menu.append(new M({id:"quickMakeCard",icon:"iconRiffCard",label:window.siyuan.languages.quickMakeCard,accelerator:window.siyuan.config.keymap.editor.general.quickMakeCard.custom,iconHTML:'<svg class="b3-menu__icon" style="color:var(--b3-theme-primary)"><use xlink:href="#iconRiffCard"></use></svg>',click(){po(t,[o])}}).element),window.siyuan.menus.menu.append(new M({id:"addToDeck",label:window.siyuan.languages.addToDeck,ignore:!window.siyuan.config.flashcard.deck,icon:"iconRiffCard",click(){Ui(t.app,[i])}}).element),window.siyuan.menus.menu.append(new M({id:"separator_5",type:"separator"}).element)),(s=t==null?void 0:t.app)!=null&&s.plugins&&jt({plugins:t.app.plugins,type:"click-blockicon",detail:{protyle:t,blockElements:[o]},separatorPosition:"bottom"});let g=o.getAttribute("updated")||"";return g&&(g=`${window.siyuan.languages.modifiedAt} ${U(g).format("YYYY-MM-DD HH:mm:ss")}<br>`),window.siyuan.menus.menu.append(new M({id:"updateAndCreatedAt",iconHTML:"",type:"readonly",label:`${g}${window.siyuan.languages.createdAt} ${U(i.substr(0,14)).format("YYYY-MM-DD HH:mm:ss")}`}).element),window.siyuan.menus.menu}genHeadingTransform(t,n,a){return{id:"heading"+a,iconHTML:"",icon:"iconHeading"+a,label:window.siyuan.languages["heading"+a],click(){A("/api/block/getHeadingLevelTransaction",{id:n,level:a},s=>{s.data.doOperations.forEach((i,l)=>{t.wysiwyg.element.querySelectorAll(`[data-node-id="${i.id}"]`).forEach(o=>{o.outerHTML=i.data}),t.wysiwyg.element.querySelectorAll(`[data-node-id="${i.id}"]`).forEach(o=>{_n(o)}),l===0&&ne(t.wysiwyg.element.querySelector(`[data-node-id="${i.id}"]`),t.wysiwyg.element,!0)}),q(t,s.data.doOperations,s.data.undoOperations)})}}}genClick(t,n,a){ra(t,n,a),ne(t[0])}genAlign(t,n){window.siyuan.menus.menu.append(new M({id:"layout",label:window.siyuan.languages.layout,type:"submenu",submenu:[{id:"alignLeft",icon:"iconAlignLeft",label:window.siyuan.languages.alignLeft,accelerator:window.siyuan.config.keymap.editor.general.alignLeft.custom,click:()=>{this.genClick(t,n,a=>{a.classList.contains("av")?a.style.justifyContent="":a.style.textAlign="left"})}},{id:"alignCenter",icon:"iconAlignCenter",label:window.siyuan.languages.alignCenter,accelerator:window.siyuan.config.keymap.editor.general.alignCenter.custom,click:()=>{this.genClick(t,n,a=>{a.classList.contains("av")?a.style.justifyContent="center":a.style.textAlign="center"})}},{id:"alignRight",icon:"iconAlignRight",label:window.siyuan.languages.alignRight,accelerator:window.siyuan.config.keymap.editor.general.alignRight.custom,click:()=>{this.genClick(t,n,a=>{a.classList.contains("av")?a.style.justifyContent="flex-end":a.style.textAlign="right"})}},{id:"justify",icon:"iconMenu",label:window.siyuan.languages.justify,click:()=>{this.genClick(t,n,a=>{a.style.textAlign="justify"})}},{id:"separator_1",type:"separator"},{id:"ltr",icon:"iconLtr",label:window.siyuan.languages.ltr,accelerator:window.siyuan.config.keymap.editor.general.ltr.custom,click:()=>{this.genClick(t,n,a=>{a.style.direction="ltr"})}},{id:"rtl",icon:"iconRtl",label:window.siyuan.languages.rtl,accelerator:window.siyuan.config.keymap.editor.general.rtl.custom,click:()=>{this.genClick(t,n,a=>{a.classList.contains("av")||(a.style.direction="rtl")})}},{id:"separator_2",type:"separator"},{id:"clearFontStyle",icon:"iconTrashcan",label:window.siyuan.languages.clearFontStyle,click:()=>{this.genClick(t,n,a=>{a.classList.contains("av")?a.style.justifyContent="":(a.style.textAlign="",a.style.direction="")})}}]}).element)}updateNodeElements(t,n,a){const s=[],i=[];t.forEach(l=>{s.push({action:"update",id:l.getAttribute("data-node-id"),data:l.outerHTML})}),a.addEventListener(a.type==="number"?"blur":"change",()=>{t.forEach(l=>{i.push({action:"update",id:l.getAttribute("data-node-id"),data:l.outerHTML})}),q(n,i,s),window.siyuan.menus.menu.remove(),ne(t[0])})}genWidths(t,n){let a;const s=t[0],i=[{id:"widthInput",iconHTML:"",type:"readonly",label:`<div class="fn__flex-center">
<input class="b3-text-field" value="${s.style.width.endsWith("px")?parseInt(s.style.width):""}" type="number" style="margin: 4px" placeholder="${window.siyuan.languages.width}"> px
</div>`,bind:o=>{const r=o.querySelector("input");r.addEventListener("input",()=>{t.forEach(c=>{c.style.width=r.value+"px",c.style.flex="none"}),a.value="0",a.parentElement.setAttribute("aria-label",r.value+"px")}),this.updateNodeElements(t,n,r)}}];["25%","33%","50%","67%","75%","100%"].forEach(o=>{i.push({id:"width_"+o,iconHTML:"",label:o,click:()=>{this.genClick(t,n,r=>{r.style.width=o,r.style.flex="none"})}})}),i.push({id:"separator_1",type:"separator"});const l=s.style.width.endsWith("%")?parseInt(s.style.width):0;window.siyuan.menus.menu.append(new M({id:"width",label:window.siyuan.languages.width,submenu:i.concat([{id:"widthDrag",iconHTML:"",type:"readonly",label:`<div style="margin: 4px 0;"  aria-label="${s.style.width.endsWith("px")?s.style.width:s.style.width||window.siyuan.languages.default}" class="b3-tooltips b3-tooltips__n${H()?"":" fn__size200"}">
    <input style="box-sizing: border-box" value="${l}" class="b3-slider fn__block" max="100" min="1" step="1" type="range">
</div>`,bind:o=>{a=o.querySelector("input"),a.addEventListener("input",()=>{t.forEach(r=>{r.style.width=a.value+"%",r.style.flex="none"}),a.parentElement.setAttribute("aria-label",`${a.value}%`)}),this.updateNodeElements(t,n,a)}},{id:"separator_2",type:"separator"},{id:"default",iconHTML:"",label:window.siyuan.languages.default,click:()=>{this.genClick(t,n,o=>{o.style.width&&(o.style.width="",o.style.flex="")})}}])}).element)}genHeights(t,n){if(t.find(r=>{if(!r.classList.contains("p")&&!r.classList.contains("code-block")&&!r.classList.contains("render-node"))return!0}))return;let s;const i=t[0],l=[{id:"heightInput",iconHTML:"",type:"readonly",label:`<div class="fn__flex-center">
<input class="b3-text-field" value="${i.style.height.endsWith("px")?parseInt(i.style.height):""}" type="number" style="margin: 4px" placeholder="${window.siyuan.languages.height}"> px
</div>`,bind:r=>{const c=r.querySelector("input");c.addEventListener("input",()=>{t.forEach(d=>{d.style.height=c.value+"px",d.style.flex="none"}),s.value="0",s.parentElement.setAttribute("aria-label",c.value+"px")}),this.updateNodeElements(t,n,c)}}];["25%","33%","50%","67%","75%","100%"].forEach(r=>{l.push({id:"height_"+r,iconHTML:"",label:r,click:()=>{this.genClick(t,n,c=>{c.style.height=r,c.style.flex="none"})}})}),l.push({type:"separator"});const o=i.style.height.endsWith("%")?parseInt(i.style.height):0;window.siyuan.menus.menu.append(new M({id:"heightDrag",label:window.siyuan.languages.height,submenu:l.concat([{iconHTML:"",type:"readonly",label:`<div style="margin: 4px 0;"  aria-label="${i.style.height.endsWith("px")?i.style.height:i.style.height||window.siyuan.languages.default}" class="b3-tooltips b3-tooltips__n${H()?"":" fn__size200"}">
    <input style="box-sizing: border-box" value="${o}" class="b3-slider fn__block" max="100" min="1" step="1" type="range">
</div>`,bind:r=>{s=r.querySelector("input"),s.addEventListener("input",()=>{t.forEach(c=>{c.style.height=s.value+"%",c.style.flex="none"}),s.parentElement.setAttribute("aria-label",`${s.value}%`)}),this.updateNodeElements(t,n,s)}},{type:"separator"},{id:"default",iconHTML:"",label:window.siyuan.languages.default,click:()=>{this.genClick(t,n,r=>{r.style.height&&(r.style.height="",r.style.overflow="")})}}])}).element)}genCopyTextRef(t){return At(t[0])?!1:{id:"copyText",iconHTML:"",accelerator:window.siyuan.config.keymap.editor.general.copyText.custom,label:window.siyuan.languages.copyText,click(){t[0].setAttribute("data-reftext","true"),X(ye(t[0])),document.execCommand("copy")}}}render(t,n,a,s){var i;if(t.title&&t.title.element.getAttribute("data-render")!=="true")return;const l=a.parentElement.parentElement.querySelector(".protyle-select");if(l&&!l.classList.contains("fn__none"))return;let o="",r=n,c=0,d=0,u,p=!1;for(;r;){const v=!p||p&&r.getAttribute("fold")==="1";if(!re(r)){let E;v&&(E=r.getAttribute("data-type"));let S=r.getAttribute("data-node-id");if(E==="NodeAttributeView"&&s){const T=$(s,"av__row");if(T&&!T.classList.contains("av__row--header")){n=T;let I=Lt()?window.siyuan.languages.rowTip:window.siyuan.languages.rowTip.replace("\u21E7","Shift+");t.disabled?I=window.siyuan.languages.rowTip.substring(0,window.siyuan.languages.rowTip.indexOf("<br")):((i=T.querySelector('[data-dtype="block"]'))==null?void 0:i.getAttribute("data-detached"))==="true"&&(I=window.siyuan.languages.rowTip.substring(0,window.siyuan.languages.rowTip.lastIndexOf("<br"))),o=`<button data-type="NodeAttributeViewRowMenu" data-node-id="${S}" data-row-id="${T.dataset.id}" class="ariaLabel" data-position="west" aria-label="${I}"><svg><use xlink:href="#iconDrag"></use></svg><span ${t.disabled?"":'draggable="true" class="fn__grab"'}></span></button>`,t.disabled||(o=`<button data-type="NodeAttributeViewRow" data-node-id="${S}" data-row-id="${T.dataset.id}" class="ariaLabel" data-position="west" aria-label="${Lt()?window.siyuan.languages.addBelowAbove:window.siyuan.languages.addBelowAbove.replace("\u2325","Alt+")}"><svg><use xlink:href="#iconAdd"></use></svg></button>${o}`);break}}if(d===0){if(["NodeBlockquote","NodeList","NodeSuperBlock"].includes(E))return;const T=Ne(r);u=T.querySelector(".li")||T.querySelector(".list"),re(u)&&(u=void 0),!T.isSameNode(r)&&E!=="NodeHeading"&&(r=T,E=r.getAttribute("data-type"),S=r.getAttribute("data-node-id"))}E==="NodeListItem"&&d===1&&!v&&(o=""),d+=1;let L=this.gutterTip;t.disabled&&(L=this.gutterTip.split("<br>").splice(0,2).join("<br>"));let k="";t.options.backlinkData&&(k=`class="popover__block" data-id="${S}"`);const x=`<button class="ariaLabel" data-position="west" aria-label="${L}" 
data-type="${E}" data-subtype="${r.getAttribute("data-subtype")}" data-node-id="${S}">
    <svg><use xlink:href="#${dn(E,r.getAttribute("data-subtype"))}"></use></svg>
    <span ${k} ${t.disabled?"":'draggable="true"'}></span>
</button>`;v&&(o=x+o);let C="";if(E==="NodeListItem"&&r.childElementCount>3||E==="NodeHeading"){const T=r.getAttribute("fold");C=`<button class="ariaLabel" data-position="west" aria-label="${window.siyuan.languages.fold}" 
data-type="fold" style="cursor:inherit;"><svg style="width: 10px${T&&T==="1"?"":";transform:rotate(90deg)"}"><use xlink:href="#iconPlay"></use></svg></button>`}(E==="NodeListItem"||E==="NodeList")&&(u=r,E==="NodeListItem"&&r.childElementCount>3&&(o=x+C)),E==="NodeHeading"&&(o=o+C),E==="NodeBlockquote"&&(c+=8),r.previousElementSibling&&r.previousElementSibling.getAttribute("data-node-id")&&(p=!0)}const h=B(r.parentElement);if(h)r=h;else break}let g=!0;const m=this.element.querySelectorAll("button");if(m.length!==o.split("</button>").length-1?g=!1:Array.from(m).find(v=>{const h=v.getAttribute("data-node-id");if(h&&o.indexOf(h)===-1)return g=!1,!0;const E=v.getAttribute("data-row-id");if(E&&o.indexOf(E)===-1||!E&&o.indexOf("NodeAttributeViewRowMenu")>-1)return g=!1,!0}),g&&this.element.childElementCount>0){this.element.classList.remove("fn__none");return}this.element.innerHTML=o,this.element.classList.remove("fn__none"),this.element.style.width="";const b=a.parentElement.getBoundingClientRect().top;let y=n.getBoundingClientRect(),_=0;if(u&&!window.siyuan.config.editor.rtl){const v=u.firstElementChild.getBoundingClientRect();v.right<=y.right&&(y=v,c=0)}else r.getAttribute("data-type")==="NodeBlockQueryEmbed"?(y=r.getBoundingClientRect(),c=0):n.classList.contains("av__row")||(y.height<Math.floor(window.siyuan.config.editor.fontSize*1.625)+8||y.height>Math.floor(window.siyuan.config.editor.fontSize*1.625)+8&&y.height<Math.floor(window.siyuan.config.editor.fontSize*1.625)*2+8?_=(y.height-this.element.clientHeight)/2:(r.getAttribute("data-type")==="NodeAttributeView"||n.getAttribute("data-type")==="NodeAttributeView")&&b<y.top&&(_=8));this.element.style.top=`${Math.max(y.top,b)+_}px`;let w=y.left-this.element.clientWidth-c;r.getAttribute("data-type")==="NodeBlockQueryEmbed"&&this.element.childElementCount===1?w=r.getBoundingClientRect().left-this.element.clientWidth-c:n.classList.contains("av__row")&&(w=r.getBoundingClientRect().left-this.element.clientWidth-c+parseInt(getComputedStyle(r).paddingLeft)),this.element.style.left=`${w}px`,w<this.element.parentElement.getBoundingClientRect().left?(this.element.style.width="24px",this.element.style.left=`${y.left-this.element.clientWidth-c/2+3}px`,o="",Array.from(this.element.children).reverse().forEach((v,h)=>{h!==0&&(v.firstElementChild.style.height="14px"),o+=v.outerHTML}),this.element.innerHTML=o):this.element.querySelectorAll("svg").forEach(v=>{v.style.height=""})}}class zg{constructor(t){this.SAMPLE_RATE=44100,this.isRecording=!1,this.readyFlag=!1,this.leftChannel=[],this.rightChannel=[],this.recordingLength=0;let n;if(typeof AudioContext!="undefined")n=new AudioContext;else if(webkitAudioContext)n=new webkitAudioContext;else return;this.DEFAULT_SAMPLE_RATE=n.sampleRate;const a=n.createGain();n.createMediaStreamSource(t).connect(a),this.recorder=n.createScriptProcessor(2048,2,1),this.recorder.onaudioprocess=null,a.connect(this.recorder),this.recorder.connect(n.destination),this.readyFlag=!0}cloneChannelData(t,n){this.leftChannel.push(new Float32Array(t)),this.rightChannel.push(new Float32Array(n)),this.recordingLength+=2048}startRecordingNewWavFile(){this.readyFlag&&(this.isRecording=!0,this.leftChannel.length=this.rightChannel.length=0,this.recordingLength=0)}stopRecording(){this.isRecording=!1}buildWavFileBlob(){const t=this.mergeBuffers(this.leftChannel),n=this.mergeBuffers(this.rightChannel);let a=new Float32Array(t.length);for(let u=0;u<t.length;++u)a[u]=.5*(t[u]+n[u]);this.DEFAULT_SAMPLE_RATE>this.SAMPLE_RATE&&(a=this.downSampleBuffer(a,this.SAMPLE_RATE));const s=44+a.length*2,i=new ArrayBuffer(s),l=new DataView(i);this.writeUTFBytes(l,0,"RIFF"),l.setUint32(4,s,!0),this.writeUTFBytes(l,8,"WAVE"),this.writeUTFBytes(l,12,"fmt "),l.setUint32(16,16,!0),l.setUint16(20,1,!0),l.setUint16(22,1,!0),l.setUint32(24,this.SAMPLE_RATE,!0),l.setUint32(28,this.SAMPLE_RATE*2,!0),l.setUint16(32,2,!0),l.setUint16(34,16,!0);const o=a.length*2;this.writeUTFBytes(l,36,"data"),l.setUint32(40,o,!0);const r=a.length;let c=44;const d=1;for(let u=0;u<r;u++)l.setInt16(c,a[u]*(32767*d),!0),c+=2;return new Blob([l],{type:"audio/wav"})}downSampleBuffer(t,n){if(n===this.DEFAULT_SAMPLE_RATE||n>this.DEFAULT_SAMPLE_RATE)return t;const a=this.DEFAULT_SAMPLE_RATE/n,s=Math.round(t.length/a),i=new Float32Array(s);let l=0,o=0;for(;l<i.length;){const r=Math.round((l+1)*a);let c=0,d=0;for(let u=o;u<r&&u<t.length;u++)c+=t[u],d++;i[l]=c/d,l++,o=r}return i}mergeBuffers(t){const n=new Float32Array(this.recordingLength);let a=0;const s=t.length;for(let i=0;i<s;++i){const l=t[i];n.set(l,a),a+=l.length}return n}writeUTFBytes(t,n,a){const s=a.length;for(let i=0;i<s;i++)t.setUint8(n+i,a.charCodeAt(i))}}const gd=(e,t)=>{if(window.siyuan.config.fileTree.removeDocWithoutConfirm){A("/api/filetree/removeDoc",{notebook:e,path:t});return}A("/api/block/getDocInfo",{id:ct(t,!0,!0)},n=>{const a=pe(n.data.name);let s=`${window.siyuan.languages.confirmDeleteTip.replace("${x}",a)}
<div class="fn__hr"></div>
<div class="ft__smaller ft__on-surface">${window.siyuan.languages.rollbackTip.replace("${x}",window.siyuan.config.editor.historyRetentionDays)}</div>`;n.data.subFileCount>0&&(s=`${window.siyuan.languages.andSubFile.replace("${x}",a).replace("${y}",n.data.subFileCount)}
<div class="fn__hr"></div>
<div class="ft__smaller ft__on-surface">${window.siyuan.languages.rollbackTip.replace("${x}",window.siyuan.config.editor.historyRetentionDays)}</div>`),$e(window.siyuan.languages.deleteOpConfirm,s,()=>{A("/api/filetree/removeDoc",{notebook:e,path:t})},void 0,!0)})},bo=e=>{if(e.length===1){const t=ee(e[0],"UL");if(t){const n=t.getAttribute("data-url");e[0].getAttribute("data-type")==="navigation-file"?gd(n,e[0].getAttribute("data-path")):$e(window.siyuan.languages.deleteOpConfirm,`${window.siyuan.languages.confirmDeleteTip.replace("${x}",Lute.EscapeHTMLStr(Ft(n)))}
<div class="fn__hr"></div>
<div class="ft__smaller ft__on-surface">${window.siyuan.languages.rollbackTip.replace("${x}",window.siyuan.config.editor.historyRetentionDays)}</div>`,()=>{A("/api/notebook/removeNotebook",{notebook:n,callback:f.CB_MOUNT_REMOVE})},void 0,!0)}}else{const t=[];if(e.forEach(n=>{n.getAttribute("data-path")!=="/"&&t.push(n.getAttribute("data-path"))}),t.length===0){ae(window.siyuan.languages.notBatchRemove);return}$e(window.siyuan.languages.deleteOpConfirm,`${window.siyuan.languages.confirmRemoveAll.replace("${count}",t.length)}
<div class="fn__hr"></div>
<div class="ft__smaller ft__on-surface">${window.siyuan.languages.rollbackTip.replace("${x}",window.siyuan.config.editor.historyRetentionDays)}</div>`,()=>{A("/api/filetree/removeDocs",{paths:t})},void 0,!0)}},pd=()=>{window.matchMedia("(orientation:portrait)").matches?document.querySelectorAll(".card__action .card__icon").forEach(e=>{e.classList.remove("fn__none")}):document.querySelectorAll(".card__action .card__icon").forEach(e=>{e.classList.add("fn__none")})};var Hs=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{o(n.next(r))}catch(c){s(c)}},l=r=>{try{o(n.throw(r))}catch(c){s(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,l);o((n=n.apply(e,t)).next())});const Ns=(e,t=0)=>{let n=0,a=0;return e.cards.forEach((s,i)=>{i>t||(s.state===0?n++:a++)}),`<span class="ariaLabel" aria-label="${window.siyuan.languages.flashcardNewCard}">
    <span class="ft__error">${n}</span> /
    <span class="ariaLabel ft__primary" aria-label="${window.siyuan.languages.flashcardNewCard}">${e.unreviewedNewCardCount}</span>
</span>
<span class="fn__space"></span>+<span class="fn__space"></span>
<span class="ariaLabel" aria-label="${window.siyuan.languages.flashcardReviewCard}">
    <span class="ft__error">${a}</span> /
    <span class="ft__success">${e.unreviewedOldCardCount}</span>
</span>`},Gg=e=>{let t;return t=`<div class="toolbar toolbar--border">
    <svg class="toolbar__icon"><use xlink:href="#iconRiffCard"></use></svg>
    <span class="fn__flex-1 fn__flex-center toolbar__text">${window.siyuan.languages.riffCard}</span>
    <div data-type="count" class="${e.cardsData.cards.length===0?"fn__none":"fn__flex"}">${Ns(e.cardsData)}</span></div>
    <svg class="toolbar__icon" data-id="${e.id||""}" data-cardtype="${e.cardType}" data-type="filter"><use xlink:href="#iconFilter"></use></svg>
    <svg class="toolbar__icon" data-type="more"><use xlink:href="#iconMore"></use></svg>
    <svg class="toolbar__icon" data-type="close"><use xlink:href="#iconCloseRound"></use></svg>
</div>`,`<div class="card__main">
    ${t}
    <div class="card__block fn__flex-1 ${e.cardsData.cards.length===0?"fn__none":""}" data-type="render"></div>
    <div class="card__empty card__empty--space${e.cardsData.cards.length===0?"":" fn__none"}" data-type="empty">
        <div>\u{1F52E}</div>
        ${window.siyuan.languages.noDueCard}
    </div>
    <div class="fn__flex card__action fn__none">
        <button class="b3-button b3-button--cancel" disabled="disabled" data-type="-2" style="width: 25%;min-width: 86px;display: flex">
            <svg><use xlink:href="#iconLeft"></use></svg>
            ${H()?"":"(p / q)"}
        </button>
        <span class="fn__space"></span>
        <button data-type="-1" class="b3-button fn__flex-1">${window.siyuan.languages.cardShowAnswer}${H()?"":" ("+window.siyuan.languages.space+" / "+window.siyuan.languages.enterKey+")"}</button>
    </div>
    <div class="fn__flex card__action fn__none">
        <div>
            <button class="b3-button b3-button--cancel" disabled="disabled" style="display: flex;margin-bottom: 8px;height: 28px;padding: 0;" data-type="-2"><svg><use xlink:href="#iconLeft"></use></svg>${H()?"":"(p / q)"}</button>
            <button data-type="-3" aria-label="0 / x" class="b3-button b3-button--cancel b3-tooltips__n b3-tooltips">
                <div class="card__icon">\u{1F4A4}</div>
                ${window.siyuan.languages.skip}${H()?"":" (0)"}
            </button>
        </div>
        <div>
            <span></span>
            <button data-type="1" aria-label="1 / j / a" class="b3-button b3-button--error b3-tooltips__n b3-tooltips">
                <div class="card__icon">\u{1F648}</div>
                ${window.siyuan.languages.cardRatingAgain}${H()?"":" (1)"}
            </button>
        </div>
        <div>
            <span></span>
            <button data-type="2" aria-label="2 / k / s" class="b3-button b3-button--warning b3-tooltips__n b3-tooltips">
                <div class="card__icon">\u{1F62C}</div>
                ${window.siyuan.languages.cardRatingHard}${H()?"":" (2)"}
            </button>
        </div>
        <div>
            <span></span>
            <button data-type="3" aria-label="3 / l / d / ${window.siyuan.languages.space} / ${window.siyuan.languages.enterKey}" class="b3-button b3-button--info b3-tooltips__n b3-tooltips">
                <div class="card__icon">\u{1F60A}</div>
                ${window.siyuan.languages.cardRatingGood}${H()?"":" (3)"}
            </button>
        </div>
        <div>
            <span></span>
            <button data-type="4" aria-label="4 / ; / f" class="b3-button b3-button--success b3-tooltips__n b3-tooltips">
                <div class="card__icon">\u{1F308}</div>
                ${window.siyuan.languages.cardRatingEasy}${H()?"":" (4)"}
            </button>
        </div>
    </div>
</div>`},md=(e,t,n,a)=>{A("/api/block/getDocInfo",{id:e},s=>{t.wysiwyg.renderCustom(s.data.ial),A("/api/filetree/getDoc",{id:e,mode:0,size:f.SIZE_GET_MAX},i=>{Qe({updateReadonly:!0,data:i,protyle:t,action:i.data.rootID===i.data.id?[f.CB_GET_HTML]:[f.CB_GET_ALL,f.CB_GET_HTML],afterCB:()=>{let l=!1;!window.siyuan.config.flashcard.superBlock&&!window.siyuan.config.flashcard.heading&&!window.siyuan.config.flashcard.list&&!window.siyuan.config.flashcard.mark?l=!1:(window.siyuan.config.flashcard.superBlock&&t.wysiwyg.element.querySelector(":scope > .sb")&&(l=!0),window.siyuan.config.flashcard.heading&&t.wysiwyg.element.querySelector(':scope > [data-type="NodeHeading"]')&&(l=!0),window.siyuan.config.flashcard.list&&t.wysiwyg.element.querySelector(".list, .li")&&(l=!0),window.siyuan.config.flashcard.mark&&t.wysiwyg.element.querySelector('span[data-type~="mark"]')&&(l=!0));const o=n.querySelectorAll(".card__action");l?(window.siyuan.config.flashcard.superBlock&&t.element.classList.add("card__block--hidesb"),window.siyuan.config.flashcard.heading&&t.element.classList.add("card__block--hideh"),window.siyuan.config.flashcard.list&&t.element.classList.add("card__block--hideli"),window.siyuan.config.flashcard.mark&&t.element.classList.add("card__block--hidemark"),o[0].classList.remove("fn__none"),o[1].classList.add("fn__none")):(t.element.classList.remove("card__block--hidemark","card__block--hideli","card__block--hidesb","card__block--hideh"),o[0].classList.add("fn__none"),o[1].querySelectorAll("button.b3-button").forEach((r,c)=>{c<2||(r.previousElementSibling.textContent=a.nextDues[c-1])}),o[1].classList.remove("fn__none"))}})})})},Kg=e=>Hs(void 0,null,function*(){window.siyuan.storage[f.LOCAL_FLASHCARD].fullscreen&&El(e.element.querySelector(".card__main"),e.element.querySelector('[data-type="fullscreen"]'));let t=0;typeof e.index=="number"&&(t=e.index);const n=new Yn(e.app,e.element.querySelector("[data-type='render']"),{blockId:"",action:[f.CB_GET_ALL],render:{background:!1,gutter:!0,breadcrumbDocName:!0},typewriterMode:!1});window.siyuan.mobile&&(window.siyuan.mobile.popEditor=n),e.cardsData.cards.length>0&&md(e.cardsData.cards[t].blockID,n.protyle,e.element,e.cardsData.cards[t]),e.element.setAttribute("data-key",f.DIALOG_OPENCARD);const a=e.element.querySelectorAll(".card__action");e.index===0||typeof e.index=="undefined"?(a[0].firstElementChild.setAttribute("disabled","disabled"),a[1].querySelector(".b3-button").setAttribute("disabled","disabled")):(a[0].firstElementChild.removeAttribute("disabled"),a[1].querySelector(".b3-button").removeAttribute("disabled"));const s=e.element.querySelector('[data-type="count"]'),i=e.element.querySelector('[data-type="filter"]'),l=()=>{const o=i.getAttribute("data-cardtype"),r=i.getAttribute("data-id");A(o==="all"?"/api/riff/getRiffDueCards":o==="doc"?"/api/riff/getTreeRiffDueCards":"/api/riff/getNotebookRiffDueCards",{rootID:r,deckID:r,notebook:r},c=>Hs(void 0,null,function*(){t=0,e.cardsData=c.data;for(let d=0;d<e.app.plugins.length;d++)e.cardsData=yield e.app.plugins[d].updateCards(e.cardsData);e.cardsData.cards.length>0?Os({countElement:s,editor:n,actionElements:a,index:t,cardsData:e.cardsData}):yd(s,n,a)}))};return s.innerHTML=Ns(e.cardsData,t),e.element.addEventListener("click",o=>{const r=o.target;let c="";const d=e.cardsData.cards[t],u=i.getAttribute("data-id");if(typeof o.detail=="string")["1","j","a"].includes(o.detail)?c="1":["2","k","s"].includes(o.detail)?c="2":["3","l","d"].includes(o.detail)?c="3":["4",";","f"].includes(o.detail)?c="4":[" ","enter"].includes(o.detail)?c="-1":["p","q"].includes(o.detail)?c="-2":["0","x"].includes(o.detail)&&(c="-3");else{if(D(r,"data-type","fullscreen")){El(e.element.querySelector(".card__main"),e.element.querySelector('[data-type="fullscreen"]')),Qa(n.protyle),window.siyuan.storage[f.LOCAL_FLASHCARD].fullscreen=!window.siyuan.storage[f.LOCAL_FLASHCARD].fullscreen,Ae(f.LOCAL_FLASHCARD,window.siyuan.storage[f.LOCAL_FLASHCARD]),o.stopPropagation(),o.preventDefault();return}if(D(r,"data-type","more")){if(o.stopPropagation(),o.preventDefault(),i.getAttribute("data-cardtype")==="all"&&i.getAttribute("data-id")){ae(window.siyuan.languages.noSupportTip);return}const _=new Ke;_.addItem({id:"setDueTime",icon:"iconClock",label:window.siyuan.languages.setDueTime,click(){const w=new we({title:window.siyuan.languages.setDueTime,content:`<div class="b3-dialog__content">
    <div class="b3-label__text">${window.siyuan.languages.showCardDay}</div>
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__block" value="1" type="number" step="1" min="1">
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:H()?"92vw":"520px"}),v=w.element.querySelector("input"),h=w.element.querySelectorAll(".b3-button");w.bindInput(v,()=>{h[1].click()}),v.focus(),v.select(),h[0].addEventListener("click",()=>{w.destroy()}),h[1].addEventListener("click",()=>{A("/api/riff/batchSetRiffCardsDueTime",{cardDues:[{id:d.cardID,due:U().add(parseInt(v.value),"day").format("YYYYMMDDHHmmss")}]},()=>{a[0].classList.add("fn__none"),a[1].classList.remove("fn__none"),d.state===0?e.cardsData.unreviewedNewCardCount--:e.cardsData.unreviewedOldCardCount--,e.element.dispatchEvent(new CustomEvent("click",{detail:"0"})),e.cardsData.cards.splice(t,1),t--,w.destroy()})})}}),d.state!==0&&_.addItem({id:"reset",icon:"iconRefresh",label:window.siyuan.languages.reset,click(){A("/api/riff/resetRiffCards",{type:i.getAttribute("data-cardtype"),id:u,deckID:f.QUICK_DECK_ID,blockIDs:[d.blockID]},()=>{const w=window.siyuan.languages._time["1m"].replace("%s","");d.lapses=0,d.lastReview=-621355968e5,d.reps=0,d.state=0,d.nextDues={1:w,2:w.replace("1","5"),3:w.replace("1","10"),4:window.siyuan.languages._time["1d"].replace("%s","").replace("1","6")},a[1].querySelectorAll("button.b3-button").forEach((v,h)=>{h<2||(v.previousElementSibling.textContent=d.nextDues[h-1])}),e.cardsData.unreviewedOldCardCount--,e.cardsData.unreviewedNewCardCount++,s.innerHTML=Ns(e.cardsData,t)})}}),_.addItem({id:"removeRiffCard",icon:"iconTrashcan",label:`${window.siyuan.languages.remove} <b>${window.siyuan.languages.riffCard}</b>`,click(){a[0].classList.add("fn__none"),a[1].classList.remove("fn__none"),d.state===0?e.cardsData.unreviewedNewCardCount--:e.cardsData.unreviewedOldCardCount--,e.element.dispatchEvent(new CustomEvent("click",{detail:"0"})),q(void 0,[{action:"removeFlashcards",deckID:f.QUICK_DECK_ID,blockIDs:[d.blockID]}]),e.cardsData.cards.splice(t,1),t--}}),_.addSeparator(),_.addItem({id:"forgetCountAndRevisionCountAndCardStatusAndLastReviewTime",iconHTML:"",type:"readonly",label:`<div class="fn__flex">
    <div class="fn__flex-1 ft__breakword">${window.siyuan.languages.forgetCount}</div>
    <div class="fn__space"></div>
    <div>${d.lapses}</div>
</div><div class="fn__flex">
    <div class="fn__flex-1 ft__breakword">${window.siyuan.languages.revisionCount}</div>
    <div class="fn__space"></div>
    <div>${d.reps}</div>
</div><div class="fn__flex">
    <div class="fn__flex-1 ft__breakword">${window.siyuan.languages.cardStatus}</div>
    <div class="fn__space"></div>
    <div class="${d.state===0?"ft__primary":"ft__success"}">${d.state===0?window.siyuan.languages.flashcardNewCard:window.siyuan.languages.flashcardReviewCard}</div>
</div><div class="fn__flex${d.lastReview>0?"":" fn__none"}">
    <div class="fn__flex-1 ft__breakword" style="width: 170px;">${window.siyuan.languages.lastReviewTime}</div>
    <div class="fn__space"></div>
    <div>${U(d.lastReview).format("YYYY-MM-DD")}</div>
</div>`}),_.fullscreen();return}if(D(r,"data-type","close")){e.dialog&&e.dialog.destroy(),o.stopPropagation(),o.preventDefault();return}const b=D(r,"data-type","filter");if(b){A("/api/riff/getRiffDecks",{},_=>{window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.append(new M({id:"all",iconHTML:"",label:window.siyuan.languages.all,click(){i.setAttribute("data-id",""),i.setAttribute("data-cardtype","all"),l()}}).element),window.siyuan.menus.menu.append(new M({id:"fileTree",iconHTML:"",label:window.siyuan.languages.fileTree,click(){Wn((v,h)=>{i.setAttribute("data-id",v[0]==="/"?h[0]:ct(v[0],!0,!0)),i.setAttribute("data-cardtype",v[0]==="/"?"notebook":"doc"),l()},[],void 0,window.siyuan.languages.specifyPath,!0)}}).element),(e.title||_.data.length>0)&&window.siyuan.menus.menu.append(new M({type:"separator"}).element),e.title&&(window.siyuan.menus.menu.append(new M({iconHTML:"",label:pe(e.title),click(){i.setAttribute("data-id",e.id),i.setAttribute("data-cardtype",e.cardType),l()}}).element),_.data.length>0&&window.siyuan.menus.menu.append(new M({type:"separator"}).element)),_.data.forEach(v=>{window.siyuan.menus.menu.append(new M({iconHTML:"",label:pe(v.name),click(){i.setAttribute("data-id",v.id),i.setAttribute("data-cardtype","all"),l()}}).element)});const w=b.getBoundingClientRect();window.siyuan.menus.menu.popup({x:w.left,y:w.bottom})}),o.stopPropagation(),o.preventDefault();return}if(D(r,"data-type","newround")){l(),o.stopPropagation(),o.preventDefault();return}}if(!c){const p=$(r,"b3-button");p&&(c=p.getAttribute("data-type"))}if(!(!c||!d)){if(o.preventDefault(),o.stopPropagation(),J(["toolbar","hint","util","gutter"],n.protyle),c==="-1")if(a[0].classList.contains("fn__none"))c="3";else{n.protyle.element.classList.remove("card__block--hidemark","card__block--hideli","card__block--hidesb","card__block--hideh"),a[0].classList.add("fn__none"),a[1].querySelectorAll("button.b3-button").forEach((p,g)=>{g<2||(p.previousElementSibling.textContent=d.nextDues[g-1])}),a[1].classList.remove("fn__none"),Ps(e.app,d,c);return}else if(c==="-2"){t>0&&(t--,Os({countElement:s,editor:n,actionElements:a,index:t,cardsData:e.cardsData}),Ps(e.app,e.cardsData.cards[t+1],c));return}["1","2","3","4","-3"].includes(c)&&a[0].classList.contains("fn__none")&&A(c==="-3"?"/api/riff/skipReviewRiffCard":"/api/riff/reviewRiffCard",{deckID:d.deckID,cardID:d.cardID,rating:parseInt(c),reviewedCards:e.cardsData.cards},()=>{if(c!=="-3"&&(window.siyuan.config.sync.provider!==0&&zn()||window.siyuan.config.sync.provider===0&&!Vn(""))&&window.siyuan.config.repo.key&&window.siyuan.config.sync.enabled&&document.getElementById("toolbarSync").classList.remove("fn__none"),t++,t>e.cardsData.cards.length-1){const p=i.getAttribute("data-cardtype");A(p==="all"?"/api/riff/getRiffDueCards":p==="doc"?"/api/riff/getTreeRiffDueCards":"/api/riff/getNotebookRiffDueCards",{rootID:u,deckID:u,notebook:u,reviewedCards:e.cardsData.cards},g=>Hs(void 0,null,function*(){Ps(e.app,e.cardsData.cards[t-1],c),t=0,e.cardsData=g.data;for(let m=0;m<e.app.plugins.length;m++)e.cardsData=yield e.app.plugins[m].updateCards(e.cardsData);e.cardsData.cards.length===0?e.cardsData.unreviewedCount>0?Zg(s,n,a,g.data.unreviewedCount):yd(s,n,a):Os({countElement:s,editor:n,actionElements:a,index:t,cardsData:e.cardsData})}));return}Os({countElement:s,editor:n,actionElements:a,index:t,cardsData:e.cardsData}),Ps(e.app,e.cardsData.cards[t-1],c)})}}),n}),Ps=(e,t,n)=>{e.plugins.forEach(a=>{a.eventBus.emit("click-flashcard-action",{type:n,card:t})})},bd=e=>{window.siyuan.config.readonly||A("/api/riff/getRiffDueCards",{deckID:""},t=>{qs(e,t.data,"all")})},qs=(e,t,n,a,s)=>Hs(void 0,null,function*(){if(window.siyuan.dialogs.find(c=>{if(c.element.getAttribute("data-key")===f.DIALOG_OPENCARD)return c.destroy(),!0}))return;let l;getSelection().rangeCount>0&&(l=getSelection().getRangeAt(0));for(let c=0;c<e.plugins.length;c++)t=yield e.plugins[c].updateCards(t);const o=new we({positionId:f.DIALOG_OPENCARD,content:Gg({id:a,cardType:n,cardsData:t,isTab:!1}),width:H()?"100vw":"80vw",height:H()?"100vh":"70vh",destroyCallback(){r&&(r.destroy(),window.siyuan.mobile&&(window.siyuan.mobile.popEditor=null)),l&&X(l)},resizeCallback(c){c!=="d"&&c!=="t"&&r&&r.resize()}});o.element.querySelector(".b3-dialog__scrim").style.backgroundColor="var(--b3-theme-background)",o.element.querySelector(".b3-dialog__container").style.maxWidth="1024px";const r=yield Kg({app:e,element:o.element,cardsData:t,title:s,id:a,cardType:n,dialog:o});r.resize(),o.editors={card:r},pd()}),Os=e=>{e.editor.protyle.element.classList.remove("fn__none"),e.editor.protyle.element.nextElementSibling.classList.add("fn__none"),e.countElement.innerHTML=Ns(e.cardsData,e.index),e.countElement.classList.remove("fn__none"),e.index===0?(e.actionElements[0].firstElementChild.setAttribute("disabled","disabled"),e.actionElements[1].querySelector(".b3-button").setAttribute("disabled","disabled")):(e.actionElements[0].firstElementChild.removeAttribute("disabled"),e.actionElements[1].querySelector(".b3-button").removeAttribute("disabled")),md(e.cardsData.cards[e.index].blockID,e.editor.protyle,D(e.countElement,"data-key",f.DIALOG_OPENCARD),e.cardsData.cards[e.index])},yd=(e,t,n)=>{e.classList.add("fn__none"),t.protyle.element.classList.add("fn__none");const a=t.protyle.element.nextElementSibling;a.innerHTML=`<div>\u{1F52E}</div>${window.siyuan.languages.noDueCard}`,a.classList.remove("fn__none"),n[0].classList.add("fn__none"),n[1].classList.add("fn__none")},Zg=(e,t,n,a)=>{e.classList.add("fn__none"),t.protyle.element.classList.add("fn__none");const s=t.protyle.element.nextElementSibling;s.innerHTML=`<div>\u267B\uFE0F </div>
<span>${window.siyuan.languages.continueReview2.replace("${count}",a)}</span>
<div class="fn__hr"></div>
<button data-type="newround" class="b3-button fn__size200">${window.siyuan.languages.continueReview1}</button>`,s.classList.remove("fn__none"),n[0].classList.add("fn__none"),n[1].classList.add("fn__none")};let Yi,Fi=!1;const Rs=(e,t,n)=>{const a=e.querySelector('[data-type="docprevious"]'),s=e.querySelector('[data-type="docnext"]');t>1?a.removeAttribute("disabled"):a.setAttribute("disabled","disabled");const i=e.querySelector('.b3-select[data-type="opselect"]'),l=e.querySelector(".b3-list--background");e.querySelector(".protyle-title__input").classList.add("fn__none"),e.querySelector('.history__text[data-type="docPanel"]').classList.add("fn__none"),e.querySelector('.history__text[data-type="mdPanel"]').classList.add("fn__none"),A("/api/history/searchHistory",{query:n,page:t,op:i.value,type:3},o=>{t<o.data.pageCount?s.removeAttribute("disabled"):s.setAttribute("disabled","disabled");const r=e.querySelector('[data-type="jumpRepoPage"]');o.data.pageCount>1?r.removeAttribute("disabled"):r.setAttribute("disabled","disabled"),r.setAttribute("data-totalpage",o.data.pageCount.toString()),r.textContent=t.toString();const c=s.nextElementSibling.nextElementSibling;if(c.classList.remove("fn__none"),c.textContent=window.siyuan.languages.pageCountAndHistoryCount.replace("${x}",o.data.pageCount).replace("${y}",o.data.totalCount),o.data.histories.length===0){l.innerHTML=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;return}let d="";o.data.histories.forEach(u=>{d+=`<li class="b3-list-item b3-list-item--hide-action" data-created="${u}">
    <span class="b3-list-item__text">${U(parseInt(u)*1e3).format("YYYY-MM-DD HH:mm:ss")}</span>
    <span class="fn__space"></span>
    <span class="b3-list-item__action b3-tooltips b3-tooltips__w" data-type="rollback" aria-label="${window.siyuan.languages.rollback}">
        <svg><use xlink:href="#iconUndo"></use></svg>
    </span>
</li>`}),l.innerHTML=d})},wd=e=>{const t=`<div class="history__action">
    <div class="block__icons">
        <span data-type="docprevious" class="block__icon block__icon--show b3-tooltips b3-tooltips__e" disabled="disabled" aria-label="${window.siyuan.languages.previousLabel}"><svg><use xlink:href="#iconLeft"></use></svg></span>
        <button class="b3-button b3-button--text ft__selectnone" data-type="jumpRepoPage" disabled>1</button>
        <span data-type="docnext" class="block__icon block__icon--show b3-tooltips b3-tooltips__e" disabled="disabled" aria-label="${window.siyuan.languages.nextLabel}"><svg><use xlink:href="#iconRight"></use></svg></span>
        <span class="fn__space"></span>
        <span class="ft__on-surface fn__flex-shrink ft__selectnone fn__none">${window.siyuan.languages.pageCountAndHistoryCount}</span>
        <span class="fn__space"></span>
        <div class="fn__flex-1"></div>
        <select data-type="opselect" class="b3-select">
            <option value="all" selected>${window.siyuan.languages.allOp}</option>
            <option value="update">${window.siyuan.languages.historyUpdate}</option>
            <option value="format">${window.siyuan.languages.historyFormat}</option>
            <option value="sync">${window.siyuan.languages.historySync}</option>
            <option value="replace">${window.siyuan.languages.historyReplace}</option>
            <option value="outline">${window.siyuan.languages.historyOutline}</option>
        </select>
    </div>
</div>
<div class="fn__flex fn__flex-1 history__panel">
    <ul class="b3-list b3-list--background history__side" ${H()?"":`style="width: ${window.siyuan.storage[f.LOCAL_HISTORY].sideDocWidth}"`}>
        <li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>
    </ul>
    <div class="history__resize"></div>
    <div class="fn__flex-1 fn__flex-column">
        <div class="protyle-title__input fn__none ft__center ft__breakword"></div>
        <textarea class="fn__flex-1 history__text fn__none" readonly data-type="mdPanel"></textarea>
        <div class="fn__flex-1 history__text fn__none" style="padding: 0" data-type="docPanel"></div>
    </div>
</div>`,n=new we({title:e.pathString,content:t,width:H()?"100vw":"90vw",height:H()?"100vh":"80vh",containerClassName:"b3-dialog__container--theme",destroyCallback(){Yi=void 0}});n.element.setAttribute("data-key",f.DIALOG_HISTORYDOC);const a=n.element.querySelector(".b3-select");a.addEventListener("change",()=>{Rs(n.element,1,e.id)});const s=n.element.querySelector('.history__text[data-type="docPanel"]'),i=n.element.querySelector('.history__text[data-type="mdPanel"]');Rs(n.element,1,e.id),Yi=new Yn(e.app,s,{blockId:"",history:{created:""},action:[f.CB_GET_HISTORY],render:{background:!1,gutter:!1,breadcrumb:!1,breadcrumbDocName:!1},typewriterMode:!1}),pn(Yi.protyle);const l=n.element.querySelector('[data-type="jumpRepoPage"]'),o=n.element.querySelector(".protyle-title__input");n.element.addEventListener("click",r=>{let c=r.target;for(;c&&!c.isEqualNode(n.element);){const d=c.getAttribute("data-type");if(d==="rollback"&&!Fi){hd(c.parentElement,a.value,e.id,u=>{const p=u.path;Fi=!1;const g=window.siyuan.languages.rollbackConfirm.replace("${name}",u.title).replace("${time}",c.previousElementSibling.previousElementSibling.textContent.trim());$e("\u26A0\uFE0F "+window.siyuan.languages.rollback,g,()=>{A("/api/history/rollbackDocHistory",{notebook:e.notebookId,historyPath:p})})}),r.stopPropagation(),r.preventDefault();break}else if(c.classList.contains("b3-list-item")&&!Fi){hd(c,a.value,e.id,u=>{var p;const g=u.path;A("/api/history/getDocHistoryContent",{historyPath:g},m=>{m.data.isLargeDoc?(i.value=m.data.content,i.classList.remove("fn__none"),s.classList.add("fn__none")):(i.classList.add("fn__none"),s.classList.remove("fn__none"),Qe({data:m,protyle:Yi.protyle,action:[f.CB_GET_HISTORY,f.CB_GET_HTML]})),o.textContent=u.title,o.classList.remove("fn__none"),Fi=!1}),(p=c.parentElement.querySelector(".b3-list-item--focus"))==null||p.classList.remove("b3-list-item--focus"),c.classList.add("b3-list-item--focus")}),r.stopPropagation(),r.preventDefault();break}else if((d==="docprevious"||d==="docnext")&&c.getAttribute("disabled")!=="disabled"){const u=parseInt(l.textContent);Rs(n.element,d==="docprevious"?u-1:u+1,e.id),r.stopPropagation(),r.preventDefault();break}else if(d==="jumpRepoPage"){const u=parseInt(c.getAttribute("data-totalpage")||"1");$e(window.siyuan.languages.jumpToPage.replace("${x}",u),`<input class="b3-text-field fn__block" type="number" min="1" max="${u}" value="${l.textContent}">`,p=>{const g=p.element.querySelector(".b3-text-field");g.value!==""&&Rs(n.element,Math.max(1,Math.min(parseInt(g.value),u)),e.id)})}c=c.parentElement}}),Ts(n.element.querySelector(".history__resize"),n.element.querySelector(".history__side"),"sideDocWidth")},hd=(e,t,n,a)=>{Fi=!0;const s=e.getAttribute("data-path");s&&a(s);const i=e.getAttribute("data-created");Yi.protyle.options.history.created=i,A("/api/history/getHistoryItems",{query:n,op:t,type:3,created:i},l=>{a(l.data.items[0])})},Bs=(e,t)=>{let n=`<option value="">${window.siyuan.languages.currentNotebook}</option>`;const a=[];return Object.keys(f.HELP_PATH).forEach(s=>{a.push(f.HELP_PATH[s])}),window.siyuan.notebooks.forEach(s=>{a.includes(s.id)||s.id===t||(n+=`<option value="${s.id}" ${e===s.id?"selected":""}>${pe(s.name)}</option>`)}),n},Xg=e=>{const t=`<div class="fn__flex">${pe(e.name)}
<div class="fn__space"></div>
<button class="b3-button b3-button--small fn__flex-center">${window.siyuan.languages.copy} ID</button></div>`,n=`<div class="b3-dialog__content" style="background-color: var(--b3-theme-background);">
<div class="b3-label config__item">
    ${window.siyuan.languages.fileTree12}
    <div class="b3-label__text">${window.siyuan.languages.fileTree13}</div>
    <span class="fn__hr"></span>
    <div class="fn__flex">
        <select style="min-width: 200px" class="b3-select" id="docCreateSaveBox">${Bs(e.conf.docCreateSaveBox,e.box)}</select>
        <div class="fn__space"></div>
        <input class="b3-text-field fn__flex-1" id="docCreateSavePath" value="">
    </div>
</div>
<div class="b3-label config__item">
    ${window.siyuan.languages.fileTree5}
    <div class="b3-label__text">${window.siyuan.languages.fileTree6}</div>
    <span class="fn__hr"></span>
    <div class="fn__flex">
        <select style="min-width: 200px" class="b3-select" id="refCreateSaveBox">${Bs(e.conf.refCreateSaveBox,e.box)}</select>
        <div class="fn__space"></div>
        <input class="b3-text-field fn__flex-1" id="refCreateSavePath" value="">
    </div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.fileTree11}
    <div class="b3-label__text">${window.siyuan.languages.fileTree14}</div>
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__flex-center fn__block" id="dailyNoteSavePath" value="">
    <div class="fn__hr"></div>
    <div class="b3-label__text">${window.siyuan.languages.fileTree15}</div>
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__flex-center fn__block" id="dailyNoteTemplatePath" value="${e.conf.dailyNoteTemplatePath}">
</div></div>`;if(H())sn({title:t,icon:"iconSettings",html:`<div>${n}</div>`,bindEvent(){_d(document.querySelector("#model"),e)}});else{const a=new we({width:"80vw",title:t,content:n});a.element.setAttribute("data-key",f.DIALOG_NOTEBOOKCONF),_d(a.element,e)}},_d=(e,t)=>{e.querySelector(".b3-button--small").addEventListener("click",()=>{Be(t.box),ae(window.siyuan.languages.copied)});const n=e.querySelector("#dailyNoteSavePath");n.value=t.conf.dailyNoteSavePath;const a=e.querySelector("#docCreateSavePath");a.value=t.conf.docCreateSavePath;const s=e.querySelector("#refCreateSavePath");s.value=t.conf.refCreateSavePath;const i=e.querySelector("#dailyNoteTemplatePath");i.value=t.conf.dailyNoteTemplatePath,e.querySelectorAll("input, select").forEach(l=>{l.addEventListener("change",()=>{A("/api/notebook/setNotebookConf",{notebook:t.box,conf:{refCreateSavePath:s.value,refCreateSaveBox:e.querySelector("#refCreateSaveBox").value,docCreateSaveBox:e.querySelector("#docCreateSaveBox").value,docCreateSavePath:a.value,dailyNoteSavePath:n.value,dailyNoteTemplatePath:i.value}})})})};var vd=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{o(n.next(r))}catch(c){s(c)}},l=r=>{try{o(n.throw(r))}catch(c){s(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,l);o((n=n.apply(e,t)).next())});const kd=(e,t)=>{if(!Array.from(e).find(s=>{if(s.getAttribute("data-type")==="navigation-file")return!0}))return window.siyuan.menus.menu;const a=[];if(e.forEach(s=>{const i=s.getAttribute("data-node-id");i&&a.push(i)}),a.length>0&&window.siyuan.menus.menu.append(new M({id:"copy",label:window.siyuan.languages.copy,type:"submenu",icon:"iconCopy",submenu:Ba(a).concat([{id:"duplicate",iconHTML:"",label:window.siyuan.languages.duplicate,accelerator:window.siyuan.config.keymap.editor.general.duplicate.custom,click(){a.forEach(s=>{A("/api/filetree/duplicateDoc",{id:s})})}}])}).element),window.siyuan.menus.menu.append(bl(ol(Array.from(e)))),a.length>0&&window.siyuan.menus.menu.append(new M({id:"addToDatabase",label:window.siyuan.languages.addToDatabase,accelerator:window.siyuan.config.keymap.general.addToDatabase.custom,icon:"iconDatabase",click:()=>{mo(Array.from(e))}}).element),window.siyuan.menus.menu.append(new M({id:"delete",icon:"iconTrashcan",label:window.siyuan.languages.delete,accelerator:"\u2326",click:()=>{bo(Array.from(e))}}).element),a.length===0)return window.siyuan.menus.menu;if(window.siyuan.menus.menu.append(new M({id:"separator_1",type:"separator"}).element),!window.siyuan.config.readonly){const s=[{id:"quickMakeCard",iconHTML:"",accelerator:window.siyuan.config.keymap.editor.general.quickMakeCard.custom,label:window.siyuan.languages.quickMakeCard,click:()=>{q(void 0,[{action:"addFlashcards",deckID:f.QUICK_DECK_ID,blockIDs:a}],[{action:"removeFlashcards",deckID:f.QUICK_DECK_ID,blockIDs:a}])}},{id:"removeCard",iconHTML:"",label:window.siyuan.languages.removeCard,click:()=>{q(void 0,[{action:"removeFlashcards",deckID:f.QUICK_DECK_ID,blockIDs:a}],[{action:"addFlashcards",deckID:f.QUICK_DECK_ID,blockIDs:a}])}}];window.siyuan.config.flashcard.deck&&s.push({id:"addToDeck",iconHTML:"",label:window.siyuan.languages.addToDeck,click:()=>{Ui(t,a)}}),window.siyuan.menus.menu.append(new M({id:"riffCard",label:window.siyuan.languages.riffCard,icon:"iconRiffCard",submenu:s}).element),window.siyuan.menus.menu.append(new M({id:"separator_2",type:"separator"}).element)}return Nr(t,a),window.siyuan.menus.menu.append(new M({id:"export",label:window.siyuan.languages.export,type:"submenu",icon:"iconUpload",submenu:[{id:"exportMarkdown",label:"Markdown",icon:"iconMarkdown",click:()=>{const s=ae(window.siyuan.languages.exporting,-1);A(" /api/export/exportMds",{ids:a},i=>{tt(s),Et(i.data.zip)})}}]}).element),t.plugins&&jt({plugins:t.plugins,type:"open-menu-doctree",detail:{elements:e,type:"docs"},separatorPosition:"top"}),window.siyuan.menus.menu},Ed=(e,t)=>{window.siyuan.menus.menu.remove();const n=O(t,"DIV");if(!n)return window.siyuan.menus.menu;t.classList.contains("b3-list-item--focus")||(n.querySelectorAll(".b3-list-item--focus").forEach(l=>{l.classList.remove("b3-list-item--focus"),l.removeAttribute("select-end"),l.removeAttribute("select-start")}),t.classList.add("b3-list-item--focus"));const a=n.querySelectorAll(".b3-list-item--focus");if(a.length>1)return kd(a,e);const s=t.parentElement.getAttribute("data-url"),i=Ft(s);if(!window.siyuan.config.readonly){window.siyuan.menus.menu.append(xr({path:"/",notebookId:s,name:i,type:"notebook"})),window.siyuan.menus.menu.append(new M({id:"config",label:window.siyuan.languages.config,icon:"iconSettings",click:()=>{A("/api/notebook/getNotebookConf",{notebook:s},o=>{Xg(o.data)})}}).element);const l=Sd("notebook",parseInt(t.parentElement.getAttribute("data-sortmode")),o=>(A("/api/notebook/setNotebookConf",{notebook:s,conf:{sortMode:o}},()=>{var r;t.parentElement.setAttribute("data-sortmode",o.toString());let c;c=window.siyuan.mobile.docks.file;const d=t.querySelector(".b3-list-item__arrow--open");d&&(d.classList.remove("b3-list-item__arrow--open"),(r=t.nextElementSibling)==null||r.remove(),c.getLeaf(t,s))}),!0));window.siyuan.menus.menu.append(new M({id:"sort",icon:"iconSort",label:window.siyuan.languages.sort,type:"submenu",submenu:l}).element)}return window.siyuan.config.readonly||window.siyuan.menus.menu.append(new M({id:"riffCard",label:window.siyuan.languages.riffCard,type:"submenu",icon:"iconRiffCard",submenu:[{id:"spaceRepetition",iconHTML:"",label:window.siyuan.languages.spaceRepetition,accelerator:window.siyuan.config.keymap.editor.general.spaceRepetition.custom,click:()=>{A("/api/riff/getNotebookRiffDueCards",{notebook:s},l=>{qs(e,l.data,"notebook",s,i)}),Ve()}},{id:"manage",iconHTML:"",label:window.siyuan.languages.manage,click:()=>{Ri(e,s,i,"Notebook"),Ve()}}]}).element),window.siyuan.menus.menu.append(new M({id:"search",label:window.siyuan.languages.search,accelerator:window.siyuan.config.keymap.general.search.custom,icon:"iconSearch",click(){qt(e,{hasReplace:!1,hPath:Ft(s),idPath:[s],page:1})}}).element),window.siyuan.config.readonly||window.siyuan.menus.menu.append(new M({id:"replace",label:window.siyuan.languages.replace,accelerator:window.siyuan.config.keymap.general.replace.custom,icon:"iconReplace",click(){qt(e,{hasReplace:!0,hPath:Ft(s),idPath:[s],page:1})}}).element),window.siyuan.config.readonly||(window.siyuan.menus.menu.append(new M({id:"separator_1",type:"separator"}).element),window.siyuan.menus.menu.append(new M({id:"close",label:window.siyuan.languages.close,icon:"iconClose",click:()=>{A("/api/notebook/closeNotebook",{notebook:s})}}).element),window.siyuan.menus.menu.append(new M({id:"delete",icon:"iconTrashcan",label:window.siyuan.languages.delete,accelerator:"\u2326",click:()=>{bo(Array.from(n.querySelectorAll(".b3-list-item--focus")))}}).element)),window.siyuan.menus.menu.append(new M({id:"separator_2",type:"separator"}).element),yo(s,"/"),window.siyuan.menus.menu.append(new M({id:"export",label:window.siyuan.languages.export,type:"submenu",icon:"iconUpload",submenu:[{id:"exportMarkdown",label:"Markdown",icon:"iconMarkdown",click:()=>{const l=ae(window.siyuan.languages.exporting,-1);A("/api/export/exportNotebookMd",{notebook:s},o=>{tt(l),Et(o.data.zip)})}},{id:"exportSiYuanZip",label:"SiYuan .sy.zip",icon:"iconSiYuan",click:()=>{const l=ae(window.siyuan.languages.exporting,-1);A("/api/export/exportNotebookSY",{id:s},o=>{tt(l),Et(o.data.zip)})}}]}).element),e.plugins&&jt({plugins:e.plugins,type:"open-menu-doctree",detail:{elements:a,type:"notebook"},separatorPosition:"top"}),window.siyuan.menus.menu},Ld=(e,t,n,a)=>{window.siyuan.menus.menu.remove();const s=O(a,"DIV");if(!s)return window.siyuan.menus.menu;a.classList.contains("b3-list-item--focus")||(s.querySelectorAll(".b3-list-item--focus").forEach(r=>{r.classList.remove("b3-list-item--focus"),r.removeAttribute("select-end"),r.removeAttribute("select-start")}),a.classList.add("b3-list-item--focus"));const i=s.querySelectorAll(".b3-list-item--focus");if(i.length>1)return kd(i,e);const l=a.getAttribute("data-node-id");let o=a.getAttribute("data-name");if(o=ct(o,!1,!0),!window.siyuan.config.readonly){let r,c;const d=ee(a,"UL");if((window.siyuan.config.fileTree.sort===6||d&&d.dataset.sortmode==="6")&&(window.siyuan.menus.menu.append(new M({id:"newDocAbove",icon:"iconBefore",label:window.siyuan.languages.newDocAbove,click:()=>{const u=[];Array.from(a.parentElement.children).forEach(p=>{p.tagName==="LI"&&(p.isSameNode(a)&&u.push(void 0),u.push(p.getAttribute("data-path")))}),aa({app:e,notebookId:t,currentPath:me().dirname(n),paths:u,useSavePath:!1,listDocTree:!0})}}).element),window.siyuan.menus.menu.append(new M({id:"newDocBelow",icon:"iconAfter",label:window.siyuan.languages.newDocBelow,click:()=>{const u=[];Array.from(a.parentElement.children).forEach(p=>{p.tagName==="LI"&&(u.push(p.getAttribute("data-path")),p.isSameNode(a)&&u.push(void 0))}),aa({app:e,notebookId:t,currentPath:me().dirname(n),paths:u,useSavePath:!1,listDocTree:!0})}}).element),window.siyuan.menus.menu.append(new M({id:"separator_1",type:"separator"}).element)),window.siyuan.menus.menu.append(new M({id:"copy",label:window.siyuan.languages.copy,type:"submenu",icon:"iconCopy",submenu:Ba([l]).concat([{id:"duplicate",iconHTML:"",label:window.siyuan.languages.duplicate,accelerator:window.siyuan.config.keymap.editor.general.duplicate.custom,click(){A("/api/filetree/duplicateDoc",{id:l})}}])}).element),window.siyuan.menus.menu.append(bl(ol(Array.from(s.querySelectorAll(".b3-list-item--focus"))))),window.siyuan.menus.menu.append(new M({id:"addToDatabase",label:window.siyuan.languages.addToDatabase,accelerator:window.siyuan.config.keymap.general.addToDatabase.custom,icon:"iconDatabase",click:()=>{mo([a])}}).element),window.siyuan.menus.menu.append(new M({id:"delete",icon:"iconTrashcan",label:window.siyuan.languages.delete,accelerator:"\u2326",click:()=>{bo(Array.from(s.querySelectorAll(".b3-list-item--focus")))}}).element),window.siyuan.menus.menu.append(new M({id:"separator_2",type:"separator"}).element),window.siyuan.menus.menu.append(xr({path:n,notebookId:t,name:o,type:"file"})),window.siyuan.menus.menu.append(new M({id:"attr",label:window.siyuan.languages.attr,icon:"iconAttr",click(){A("/api/block/getDocInfo",{id:l},u=>{qn(u.data.ial)})}}).element),!window.siyuan.config.readonly){const u=[{id:"spaceRepetition",iconHTML:"",label:window.siyuan.languages.spaceRepetition,accelerator:window.siyuan.config.keymap.editor.general.spaceRepetition.custom,click:()=>{A("/api/riff/getTreeRiffDueCards",{rootID:l},p=>{qs(e,p.data,"doc",l,o)}),Ve()}},{id:"manage",iconHTML:"",label:window.siyuan.languages.manage,click:()=>{A("/api/filetree/getHPathByID",{id:l},p=>{Ri(e,l,me().join(Ft(t),p.data),"Tree")}),Ve()}},{id:"quickMakeCard",iconHTML:"",accelerator:window.siyuan.config.keymap.editor.general.quickMakeCard.custom,label:window.siyuan.languages.quickMakeCard,click:()=>{q(void 0,[{action:"addFlashcards",deckID:f.QUICK_DECK_ID,blockIDs:[l]}],[{action:"removeFlashcards",deckID:f.QUICK_DECK_ID,blockIDs:[l]}])}},{id:"removeCard",iconHTML:"",label:window.siyuan.languages.removeCard,click:()=>{q(void 0,[{action:"removeFlashcards",deckID:f.QUICK_DECK_ID,blockIDs:[l]}],[{action:"addFlashcards",deckID:f.QUICK_DECK_ID,blockIDs:[l]}])}}];window.siyuan.config.flashcard.deck&&u.push({id:"addToDeck",iconHTML:"",label:window.siyuan.languages.addToDeck,click:()=>{Ui(e,[l])}}),window.siyuan.menus.menu.append(new M({id:"riffCard",label:window.siyuan.languages.riffCard,type:"submenu",icon:"iconRiffCard",submenu:u}).element)}window.siyuan.menus.menu.append(new M({id:"search",label:window.siyuan.languages.search,icon:"iconSearch",accelerator:window.siyuan.config.keymap.general.search.custom,click(){return vd(this,null,function*(){const u=ct(n,!1,!0),p=yield Ye("/api/filetree/getHPathByPath",{notebook:t,path:u+".sy"});qt(e,{hasReplace:!1,hPath:me().join(Ft(t),p.data),idPath:[me().join(t,u)],page:1})})}}).element),window.siyuan.menus.menu.append(new M({id:"replace",label:window.siyuan.languages.replace,accelerator:window.siyuan.config.keymap.general.replace.custom,icon:"iconReplace",click(){return vd(this,null,function*(){const u=ct(n,!1,!0),p=yield Ye("/api/filetree/getHPathByPath",{notebook:t,path:u+".sy"});qt(e,{hasReplace:!0,hPath:me().join(Ft(t),p.data),idPath:[me().join(t,u)],page:1})})}}).element),window.siyuan.menus.menu.append(new M({id:"separator_3",type:"separator"}).element)}return Nr(e,[l],t,n),window.siyuan.config.readonly||window.siyuan.menus.menu.append(new M({id:"fileHistory",label:window.siyuan.languages.fileHistory,icon:"iconHistory",click(){wd({app:e,id:l,notebookId:t,pathString:o})}}).element),yo(t,n),window.siyuan.menus.menu.append(Sr(l)),e.plugins&&jt({plugins:e.plugins,type:"open-menu-doctree",detail:{elements:i,type:"doc"},separatorPosition:"top"}),window.siyuan.menus.menu.element.setAttribute("data-name","docTreeMore"),window.siyuan.menus.menu},yo=(e,t)=>{if(window.siyuan.config.readonly)return;const n=()=>{let a;a=window.siyuan.mobile.docks.file;const s=a.element.querySelector(`[data-path="${t}"]`);s.querySelector(".b3-list-item__toggle").classList.remove("fn__hidden"),a.getLeaf(s,e,!0),window.siyuan.menus.menu.remove()};window.siyuan.menus.menu.append(new M({id:"import",icon:"iconDownload",label:window.siyuan.languages.import,submenu:[{id:"importSiYuanZip",icon:"iconSiYuan",label:'SiYuan .sy.zip<input class="b3-form__upload" type="file" accept="application/zip">',bind:a=>{a.querySelector(".b3-form__upload").addEventListener("change",s=>{const i=new FormData;i.append("file",s.target.files[0]),i.append("notebook",e),i.append("toPath",t),A("/api/import/importSY",i,()=>{n()})})}}]}).element)},Sd=(e,t,n)=>{const a=[{id:"fileNameASC",icon:t===0?"iconSelect":void 0,label:window.siyuan.languages.fileNameASC,click:()=>{n(0)}},{id:"fileNameDESC",icon:t===1?"iconSelect":void 0,label:window.siyuan.languages.fileNameDESC,click:()=>{n(1)}},{id:"fileNameNatASC",icon:t===4?"iconSelect":void 0,label:window.siyuan.languages.fileNameNatASC,click:()=>{n(4)}},{id:"fileNameNatDESC",icon:t===5?"iconSelect":void 0,label:window.siyuan.languages.fileNameNatDESC,click:()=>{n(5)}},{id:"separator_1",type:"separator"},{id:"createdASC",icon:t===9?"iconSelect":void 0,label:window.siyuan.languages.createdASC,click:()=>{n(9)}},{id:"createdDESC",icon:t===10?"iconSelect":void 0,label:window.siyuan.languages.createdDESC,click:()=>{n(10)}},{id:"modifiedASC",icon:t===2?"iconSelect":void 0,label:window.siyuan.languages.modifiedASC,click:()=>{n(2)}},{id:"modifiedDESC",icon:t===3?"iconSelect":void 0,label:window.siyuan.languages.modifiedDESC,click:()=>{n(3)}},{id:"separator_2",type:"separator"},{id:"refCountASC",icon:t===7?"iconSelect":void 0,label:window.siyuan.languages.refCountASC,click:()=>{n(7)}},{id:"refCountDESC",icon:t===8?"iconSelect":void 0,label:window.siyuan.languages.refCountDESC,click:()=>{n(8)}},{id:"separator_3",type:"separator"},{id:"docSizeASC",icon:t===11?"iconSelect":void 0,label:window.siyuan.languages.docSizeASC,click:()=>{n(11)}},{id:"docSizeDESC",icon:t===12?"iconSelect":void 0,label:window.siyuan.languages.docSizeDESC,click:()=>{n(12)}},{id:"separator_4",type:"separator"},{id:"subDocCountASC",icon:t===13?"iconSelect":void 0,label:window.siyuan.languages.subDocCountASC,click:()=>{n(13)}},{id:"subDocCountDESC",icon:t===14?"iconSelect":void 0,label:window.siyuan.languages.subDocCountDESC,click:()=>{n(14)}},{id:"separator_5",type:"separator"},{id:"customSort",icon:t===6?"iconSelect":void 0,label:window.siyuan.languages.customSort,click:()=>{n(6)}}];return e==="notebook"&&a.push({id:"sortByFiletree",icon:t===15?"iconSelect":void 0,label:window.siyuan.languages.sortByFiletree,click:()=>{n(15)}}),a};var Jg=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{o(n.next(r))}catch(c){s(c)}},l=r=>{try{o(n.throw(r))}catch(c){s(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,l);o((n=n.apply(e,t)).next())});const Qg=(e,t)=>{if(un(),!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="titleMenu"){window.siyuan.menus.menu.remove();return}A("/api/block/getDocInfo",{id:e.block.rootID},n=>{var a;if(window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name","titleMenu"),window.siyuan.menus.menu.append(new M({id:"copy",label:window.siyuan.languages.copy,icon:"iconCopy",type:"submenu",submenu:Ba([e.block.rootID])}).element),!e.disabled){window.siyuan.menus.menu.append(bl([e.path]));const i=getSelection().rangeCount>0?getSelection().getRangeAt(0):void 0;window.siyuan.menus.menu.append(new M({id:"addToDatabase",label:window.siyuan.languages.addToDatabase,accelerator:window.siyuan.config.keymap.general.addToDatabase.custom,icon:"iconDatabase",click:()=>{Ms(e,i,"title")}}).element),window.siyuan.menus.menu.append(new M({id:"delete",icon:"iconTrashcan",label:window.siyuan.languages.delete,click:()=>{gd(e.notebookId,e.path)}}).element)}if(window.siyuan.menus.menu.append(new M({id:"separator_2",type:"separator"}).element),window.siyuan.menus.menu.append(new M({id:"attr",label:window.siyuan.languages.attr,icon:"iconAttr",accelerator:window.siyuan.config.keymap.editor.general.attr.custom+"/"+Me("\u21E7"+window.siyuan.languages.click),click(){qn(n.data.ial,"bookmark",e)}}).element),!window.siyuan.config.readonly){window.siyuan.config.cloudRegion===0&&window.siyuan.menus.menu.append(new M({id:"wechatReminder",label:window.siyuan.languages.wechatReminder,icon:"iconMp",click(){Vu(e)}}).element);const i=[{id:"spaceRepetition",iconHTML:"",label:window.siyuan.languages.spaceRepetition,accelerator:window.siyuan.config.keymap.editor.general.spaceRepetition.custom,click:()=>{A("/api/riff/getTreeRiffDueCards",{rootID:e.block.rootID},l=>{qs(e.app,l.data,"doc",e.block.rootID,l.data.name)})}},{id:"manage",iconHTML:"",label:window.siyuan.languages.manage,click:()=>{A("/api/filetree/getHPathByID",{id:e.block.rootID},l=>{Ri(e.app,e.block.rootID,me().join(Ft(e.notebookId),l.data),"Tree")})}},{id:"quickMakeCard",iconHTML:"",label:window.siyuan.languages.quickMakeCard,accelerator:window.siyuan.config.keymap.editor.general.quickMakeCard.custom,click:()=>{var l;let o=(l=e.title)==null?void 0:l.element;o||(o=document.createElement("div"),o.setAttribute("data-node-id",e.block.rootID),o.setAttribute(f.CUSTOM_RIFF_DECKS,n.data.ial[f.CUSTOM_RIFF_DECKS])),po(e,[o])}}];window.siyuan.config.flashcard.deck&&i.push({id:"addToDeck",iconHTML:"",label:window.siyuan.languages.addToDeck,click:()=>{Ui(e.app,[e.block.rootID])}}),window.siyuan.menus.menu.append(new M({id:"riffCard",label:window.siyuan.languages.riffCard,type:"submenu",icon:"iconRiffCard",submenu:i}).element)}window.siyuan.menus.menu.append(new M({id:"search",label:window.siyuan.languages.search,icon:"iconSearch",accelerator:window.siyuan.config.keymap.general.search.custom,click(){return Jg(this,null,function*(){const i=ct(e.path,!1,!0),l=yield Ye("/api/filetree/getHPathByPath",{notebook:e.notebookId,path:i+".sy"});qt(e.app,{hasReplace:!1,hPath:me().join(Ft(e.notebookId),l.data),idPath:[me().join(e.notebookId,i)],page:1})})}}).element),e.disabled||fd(e.block.rootID),window.siyuan.menus.menu.append(new M({id:"separator_3",type:"separator"}).element),e.disabled||window.siyuan.menus.menu.append(new M({id:"fileHistory",label:window.siyuan.languages.fileHistory,icon:"iconHistory",click(){wd({app:e.app,id:e.block.rootID,notebookId:e.notebookId,pathString:n.data.name})}}).element),yo(e.notebookId,e.path),window.siyuan.menus.menu.append(Sr(e.block.showAll?e.block.id:e.block.rootID)),window.siyuan.menus.menu.append(new M({id:"separator_4",type:"separator"}).element),(a=e==null?void 0:e.app)!=null&&a.plugins&&jt({plugins:e.app.plugins,type:"click-editortitleicon",detail:{protyle:e,data:n.data},separatorPosition:"bottom"}),window.siyuan.menus.menu.append(new M({id:"updateAndCreatedAt",iconHTML:"",type:"readonly",label:`${window.siyuan.languages.modifiedAt} ${U(n.data.ial.updated).format("YYYY-MM-DD HH:mm:ss")}<br>${window.siyuan.languages.createdAt} ${U(n.data.ial.id.substr(0,14)).format("YYYY-MM-DD HH:mm:ss")}`}).element),window.siyuan.menus.menu.fullscreen();const s=Q(e.element,"block__popover",!0);window.siyuan.menus.menu.element.setAttribute("data-from",s?s.dataset.level+"popover":"app")})};var ep=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{o(n.next(r))}catch(c){s(c)}},l=r=>{try{o(n.throw(r))}catch(c){s(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,l);o((n=n.apply(e,t)).next())});class tp{constructor(t){const n=document.createElement("div");n.className="protyle-breadcrumb";let a="";n.innerHTML=`${H()?`<button class="protyle-breadcrumb__icon" data-type="mobile-menu">${window.siyuan.languages.breadcrumb}</button>`:'<div class="protyle-breadcrumb__bar"></div>'}
<span class="protyle-breadcrumb__space"></span>
<button class="protyle-breadcrumb__icon fn__none ariaLabel" aria-label="${Me(window.siyuan.config.keymap.editor.general.exitFocus.custom)}" data-type="exit-focus">${window.siyuan.languages.exitFocus}</button>
${a}
<button class="block__icon fn__flex-center ariaLabel${window.siyuan.config.readonly?" fn__none":""}" aria-label="${window.siyuan.languages.lockEdit}" data-type="readonly"><svg><use xlink:href="#iconUnlock"></use></svg></button>
<button class="block__icon fn__flex-center ariaLabel" data-type="doc" aria-label="${Lt()?window.siyuan.languages.gutterTip2:window.siyuan.languages.gutterTip2.replace("\u21E7","Shift+")}"><svg><use xlink:href="#iconFile"></use></svg></button>
<button class="block__icon fn__flex-center ariaLabel" data-type="more" aria-label="${window.siyuan.languages.more}"><svg><use xlink:href="#iconMore"></use></svg></button>
<button class="block__icon fn__flex-center fn__none ariaLabel" data-type="context" aria-label="${window.siyuan.languages.context}"><svg><use xlink:href="#iconAlignCenter"></use></svg></button>`,this.element=n.firstElementChild,n.addEventListener("click",s=>{let i=s.target;for(;i&&!i.isEqualNode(n);){const l=i.getAttribute("data-node-id"),o=i.getAttribute("data-type");if(l){s.preventDefault();break}else if(o==="mobile-menu"){this.genMobileMenu(t),s.preventDefault(),s.stopPropagation();break}else if(o==="doc"){if(window.siyuan.shiftIsPressed)A("/api/block/getDocInfo",{id:t.block.rootID},r=>{qn(r.data.ial,"bookmark",t)});else{const r=i.getBoundingClientRect();Qg(t,{x:r.right,y:r.bottom,isLeft:!0})}s.stopPropagation(),s.preventDefault();break}else if(o==="more"){const r=i.getBoundingClientRect();this.showMenu(t,{x:r.right,y:r.bottom,isLeft:!0}),s.stopPropagation(),s.preventDefault();break}else if(o==="readonly"){Ll(i,t),s.stopPropagation(),s.preventDefault();break}else if(o==="exit-focus"){Ot({protyle:t,id:t.block.rootID,focusId:t.block.id}),s.stopPropagation(),s.preventDefault();break}else if(o==="context"){s.stopPropagation(),s.preventDefault(),i.classList.contains("block__icon--active")?(Ot({protyle:t,id:t.options.blockId}),i.classList.remove("block__icon--active")):(A("/api/filetree/getDoc",{id:t.options.blockId,mode:3,size:window.siyuan.config.editor.dynamicLoadBlocks},r=>{Qe({data:r,protyle:t,action:[f.CB_GET_HL]})}),i.classList.add("block__icon--active"));break}else if(o==="undo"){t.undo.undo(t),s.preventDefault(),s.stopPropagation();break}else if(o==="redo"){t.undo.redo(t),s.preventDefault(),s.stopPropagation();break}else if(o==="outdent"){if(t.toolbar.range){const r=B(t.toolbar.range.startContainer);r&&Wa(t,[r.parentElement],t.toolbar.range)}s.preventDefault(),s.stopPropagation();break}else if(o==="indent"){if(t.toolbar.range){const r=B(t.toolbar.range.startContainer);r&&ys(t,[r.parentElement],t.toolbar.range)}s.preventDefault(),s.stopPropagation();break}i=i.parentElement}})}startRecord(t){this.messageId=ae(`<div class="fn__flex fn__flex-wrap">
<span class="fn__flex-center">${window.siyuan.languages.recording}</span><span class="fn__space"></span>
<button class="b3-button b3-button--white">${window.siyuan.languages.endRecord}</button></div>`,-1),document.querySelector(`#message [data-id="${this.messageId}"] button`).addEventListener("click",()=>{this.mediaRecorder.stopRecording(),tt(this.messageId);const n=new File([this.mediaRecorder.buildWavFileBlob()],`record${new Date().getTime()}.wav`,{type:"video/webm"});Rn(t,[n])}),this.mediaRecorder.startRecordingNewWavFile()}genMobileMenu(t){const n=new Ke("breadcrumb-mobile-path");let a;if(getSelection().rangeCount>0){const i=getSelection().getRangeAt(0);!t.wysiwyg.element.isEqualNode(i.startContainer)&&!t.wysiwyg.element.contains(i.startContainer)?a=ta(t.wysiwyg.element.firstElementChild)||t.wysiwyg.element.firstElementChild:a=B(i.startContainer)}a||(a=ta(t.wysiwyg.element.firstElementChild)||t.wysiwyg.element.firstElementChild);const s=a.getAttribute("data-node-id");A("/api/block/getBlockBreadcrumb",{id:s,excludeTypes:[]},i=>{i.data.forEach(l=>{let o=!1;(!t.block.showAll&&l.id===t.block.parentID||t.block.showAll&&l.id===t.block.id)&&(o=!0),n.addItem({current:o,icon:dn(l.type,l.subType),label:l.name,click(){Ot({protyle:t,id:l.id,focusId:s})}})}),n.fullscreen()})}toggleExit(t){const n=this.element.parentElement.querySelector('[data-type="exit-focus"]');t?n.classList.add("fn__none"):n.classList.remove("fn__none")}showMenu(t,n){if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="breadcrumbMore"){window.siyuan.menus.menu.remove();return}let a;const s=B(ye(t.element).startContainer);s&&(a=s.getAttribute("data-node-id")),A("/api/block/getTreeStat",{id:a||(t.block.showAll?t.block.id:t.block.rootID)},i=>{var l,o,r,c;if(window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name","breadcrumbMore"),!t.contentElement.classList.contains("fn__none")&&!t.disabled){let u="";u='<input class="b3-form__upload" type="file" multiple="multiple"',t.options.upload.accept?u+=` accept="${t.options.upload.accept}">`:u+=">";const p=new M({id:"insertAsset",icon:"iconDownload",label:`${window.siyuan.languages.insertAsset}${u}`}).element;p.querySelector("input").addEventListener("change",g=>{g.target.files.length!==0&&(Rn(t,g.target.files,g.target),window.siyuan.menus.menu.remove())}),window.siyuan.menus.menu.append(p),!ft()&&!yt()&&window.siyuan.menus.menu.append(new M({id:(l=this.mediaRecorder)!=null&&l.isRecording?"endRecord":"startRecord",current:this.mediaRecorder&&this.mediaRecorder.isRecording,icon:"iconRecord",label:(o=this.mediaRecorder)!=null&&o.isRecording?window.siyuan.languages.endRecord:window.siyuan.languages.startRecord,click:()=>ep(this,null,function*(){if(!this.mediaRecorder){navigator.mediaDevices.getUserMedia({audio:!0}).then(g=>{this.mediaRecorder=new zg(g),this.mediaRecorder.recorder.onaudioprocess=m=>{if(!this.mediaRecorder.isRecording)return;const b=m.inputBuffer.getChannelData(0),y=m.inputBuffer.getChannelData(1);this.mediaRecorder.cloneChannelData(b,y)},this.startRecord(t)}).catch(()=>{ae(window.siyuan.languages["record-tip"])});return}if(this.mediaRecorder.isRecording){this.mediaRecorder.stopRecording(),tt(this.messageId);const g=new File([this.mediaRecorder.buildWavFileBlob()],`record${new Date().getTime()}.wav`,{type:"video/webm"});Rn(t,[g])}else tt(this.messageId),this.startRecord(t)})}).element)}if(t.disabled||(window.siyuan.menus.menu.append(new M({id:"netImg2LocalAsset",label:window.siyuan.languages.netImg2LocalAsset,icon:"iconImgDown",accelerator:window.siyuan.config.keymap.editor.general.netImg2LocalAsset.custom,click(){qr(t,"Img")}}).element),window.siyuan.menus.menu.append(new M({id:"netAssets2LocalAssets",label:window.siyuan.languages.netAssets2LocalAssets,icon:"iconTransform",accelerator:window.siyuan.config.keymap.editor.general.netAssets2LocalAssets.custom,click(){qr(t,"Assets")}}).element),window.siyuan.menus.menu.append(new M({id:"uploadAssets2CDN",label:window.siyuan.languages.uploadAssets2CDN,icon:"iconCloudSucc",click(){Vn()||$e("\u{1F4E6} "+window.siyuan.languages.uploadAssets2CDN,window.siyuan.languages.uploadAssets2CDNConfirmTip,()=>{A("/api/asset/uploadCloud",{id:t.block.parentID})})}}).element),window.siyuan.user&&window.siyuan.menus.menu.append(new M({id:"share2Liandi",label:window.siyuan.languages.share2Liandi,icon:"iconLiandi",click(){$e("\u{1F680} "+window.siyuan.languages.share2Liandi,window.siyuan.languages.share2LiandiConfirmTip,()=>{A("/api/export/export2Liandi",{id:t.block.parentID})})}}).element)),(r=t.scroll)!=null&&r.element.classList.contains("fn__none")||window.siyuan.menus.menu.append(new M({id:"keepLazyLoad",current:t.scroll.keepLazyLoad,label:window.siyuan.languages.keepLazyLoad,click:()=>{t.scroll.keepLazyLoad=!t.scroll.keepLazyLoad}}).element),window.siyuan.menus.menu.element.lastElementChild.childElementCount>0&&window.siyuan.menus.menu.append(new M({id:"separator_1",type:"separator"}).element),window.siyuan.menus.menu.append(new M({id:"refresh",icon:"iconRefresh",accelerator:window.siyuan.config.keymap.editor.general.refresh.custom,label:window.siyuan.languages.refresh,click:()=>{Un(t,!H())}}).element),t.disabled||window.siyuan.menus.menu.append(new M({id:"optimizeTypography",label:window.siyuan.languages.optimizeTypography,accelerator:window.siyuan.config.keymap.editor.general.optimizeTypography.custom,icon:"iconFormat",click:()=>{J(["toolbar"],t),A("/api/format/autoSpace",{id:t.block.rootID})}}).element),window.siyuan.menus.menu.append(new M({id:"editMode",icon:"iconEdit",label:window.siyuan.languages["edit-mode"],type:"submenu",submenu:[{id:"wysiwyg",current:!t.contentElement.classList.contains("fn__none"),label:window.siyuan.languages.wysiwyg,accelerator:window.siyuan.config.keymap.editor.general.wysiwyg.custom,click:()=>{Hi(t,"wysiwyg"),t.scroll.lastScrollTop=0,A("/api/filetree/getDoc",{id:t.block.parentID,size:window.siyuan.config.editor.dynamicLoadBlocks},u=>{Qe({data:u,protyle:t})})}},{id:"preview",current:!t.preview.element.classList.contains("fn__none"),icon:"iconPreview",label:window.siyuan.languages.preview,accelerator:window.siyuan.config.keymap.editor.general.preview.custom,click:()=>{Hi(t,"preview"),window.siyuan.menus.menu.remove()}}]}).element),!window.siyuan.config.editor.readOnly&&!window.siyuan.config.readonly){const u=t.wysiwyg.element.getAttribute(f.CUSTOM_SY_READONLY);window.siyuan.menus.menu.append(new M({id:"editReadonly",label:window.siyuan.languages.editReadonly,icon:"iconLock",type:"submenu",submenu:[{id:"enable",iconHTML:"",current:u==="true",label:window.siyuan.languages.enable,click(){A("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{[f.CUSTOM_SY_READONLY]:"true"}})}},{id:"disable",iconHTML:"",current:!u||u==="false",label:window.siyuan.languages.disable,click(){A("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{[f.CUSTOM_SY_READONLY]:"false"}})}}]}).element)}(c=t==null?void 0:t.app)!=null&&c.plugins&&jt({plugins:t.app.plugins,type:"open-menu-breadcrumbmore",detail:{protyle:t,data:i.data.stat},separatorPosition:"top"}),window.siyuan.menus.menu.append(new M({id:"separator_2",type:"separator"}).element),window.siyuan.menus.menu.append(new M({id:"docInfo",iconHTML:"",type:"readonly",label:`<div class="fn__flex">${window.siyuan.languages.runeCount}<span class="fn__space fn__flex-1"></span>${i.data.stat.runeCount}</div><div class="fn__flex">${window.siyuan.languages.wordCount}<span class="fn__space fn__flex-1"></span>${i.data.stat.wordCount}</div><div class="fn__flex">${window.siyuan.languages.linkCount}<span class="fn__space fn__flex-1"></span>${i.data.stat.linkCount}</div><div class="fn__flex">${window.siyuan.languages.imgCount}<span class="fn__space fn__flex-1"></span>${i.data.stat.imageCount}</div><div class="fn__flex">${window.siyuan.languages.refCount}<span class="fn__space fn__flex-1"></span>${i.data.stat.refCount}</div><div class="fn__flex">${window.siyuan.languages.blockCount}<span class="fn__space fn__flex-1"></span>${i.data.stat.blockCount}</div>`}).element),window.siyuan.menus.menu.fullscreen();const d=Q(t.element,"block__popover",!0);window.siyuan.menus.menu.element.setAttribute("data-from",d?d.dataset.level+"popover":"app")})}render(t,n=!1,a){}hide(){H()||(this.element.classList.add("protyle-breadcrumb__bar--hide"),window.siyuan.hideBreadcrumb=!0)}}const xd=e=>e.replace(/\u00a0/g," ");class np{constructor(t){this.element=document.createElement("div"),this.element.className="protyle-title",window.siyuan.config.editor.displayBookmarkIcon&&this.element.classList.add("protyle-wysiwyg--attr"),this.element.innerHTML='<div class="protyle-attr"></div>',this.element.querySelector(".protyle-attr").addEventListener("click",n=>{A("/api/block/getDocInfo",{id:t.block.rootID},a=>{dd(n,t,a.data.ial)})})}rename(t){if(clearTimeout(this.timeout),!ki(this.editElement.textContent,this.editElement)){const n=Je(this.editElement);return this.setTitle(this.editElement.textContent.substring(0,f.SIZE_TITLE)),Zi(this.editElement,n.start,n.end),!1}un(),this.timeout=window.setTimeout(()=>{const n=Pn(this.editElement.textContent);A("/api/filetree/renameDoc",{notebook:t.notebookId,path:t.path,title:n}),this.setTitle(n),si(n)},f.TIMEOUT_INPUT)}setTitle(t){const n=document.getElementById("toolbarName");xd(t)!==xd(n.value)&&(n.value=t===window.siyuan.languages.untitled?"":t)}render(t,n){var a;if(this.element.getAttribute("data-render")==="true")return!1;this.element.setAttribute("data-node-id",t.block.rootID),n.data.ial[f.CUSTOM_RIFF_DECKS]&&this.element.setAttribute(f.CUSTOM_RIFF_DECKS,n.data.ial[f.CUSTOM_RIFF_DECKS]),(a=t.background)==null||a.render(n.data.ial,t.block.rootID),t.wysiwyg.renderCustom(n.data.ial),this.element.setAttribute("data-render","true"),this.setTitle(n.data.ial.title);let s="";if(n.data.ial.bookmark&&(s+=`<div class="protyle-attr--bookmark">${Lute.EscapeHTMLStr(n.data.ial.bookmark)}</div>`),n.data.ial.name&&(s+=`<div class="protyle-attr--name"><svg><use xlink:href="#iconN"></use></svg>${Lute.EscapeHTMLStr(n.data.ial.name)}</div>`),n.data.ial.alias&&(s+=`<div class="protyle-attr--alias"><svg><use xlink:href="#iconA"></use></svg>${Lute.EscapeHTMLStr(n.data.ial.alias)}</div>`),n.data.ial.memo&&(s+=`<div class="protyle-attr--memo b3-tooltips b3-tooltips__sw" aria-label="${Lute.EscapeHTMLStr(n.data.ial.memo)}"><svg><use xlink:href="#iconM"></use></svg></div>`),n.data.ial["custom-avs"]){let i="";n.data.attrViews.forEach(l=>{i+=`<span data-av-id="${l.id}" data-popover-url="/api/av/getMirrorDatabaseBlocks" class="popover__block">${l.name}</span>&nbsp;`}),i&&(i=i.substring(0,i.length-6)),s+=`<div class="protyle-attr--av"><svg><use xlink:href="#iconDatabase"></use></svg>${i}</div>`}if(this.element.querySelector(".protyle-attr").innerHTML=s,n.data.refCount!==0&&this.element.querySelector(".protyle-attr").insertAdjacentHTML("beforeend",`<div class="protyle-attr--refcount popover__block">${n.data.refCount}</div>`),this.editElement&&new Date().getTime()-U(n.data.id.split("-")[0]).toDate().getTime()<2e3){const i=this.editElement.ownerDocument.createRange();i.selectNodeContents(this.editElement),X(i)}}}var Ad=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{o(n.next(r))}catch(c){s(c)}},l=r=>{try{o(n.throw(r))}catch(c){s(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,l);o((n=n.apply(e,t)).next())});const Us=["background:radial-gradient(black 3px, transparent 4px),radial-gradient(black 3px, transparent 4px),linear-gradient(#fff 4px, transparent 0),linear-gradient(45deg, transparent 74px, transparent 75px, #a4a4a4 75px, #a4a4a4 76px, transparent 77px, transparent 109px),linear-gradient(-45deg, transparent 75px, transparent 76px, #a4a4a4 76px, #a4a4a4 77px, transparent 78px, transparent 109px),#fff;background-size: 109px 109px, 109px 109px,100% 6px, 109px 109px, 109px 109px;background-position: 54px 55px, 0px 0px, 0px 0px, 0px 0px, 0px 0px;","background: linear-gradient(45deg, #dca 12%, transparent 0, transparent 88%, #dca 0),linear-gradient(135deg, transparent 37%, #a85 0, #a85 63%, transparent 0),linear-gradient(45deg, transparent 37%, #dca 0, #dca 63%, transparent 0) #753;background-size: 25px 25px;","background: linear-gradient(315deg, transparent 75%, #d45d55 0)-10px 0, linear-gradient(45deg, transparent 75%, #d45d55 0)-10px 0, linear-gradient(135deg, #a7332b 50%, transparent 0) 0 0, linear-gradient(45deg, #6a201b 50%, #561a16 0) 0 0 #561a16;background-size: 20px 20px;","background: linear-gradient(#ffffff 50%, rgba(255,255,255,0) 0) 0 0, radial-gradient(circle closest-side, #FFFFFF 53%, rgba(255,255,255,0) 0) 0 0, radial-gradient(circle closest-side, #FFFFFF 50%, rgba(255,255,255,0) 0) 55px 0 #48B;background-size: 110px 200px;background-repeat: repeat-x;","background:radial-gradient(circle farthest-side at 0% 50%,#fb1 23.5%,rgba(240,166,17,0) 0)21px 30px, radial-gradient(circle farthest-side at 0% 50%,#B71 24%,rgba(240,166,17,0) 0)19px 30px, linear-gradient(#fb1 14%,rgba(240,166,17,0) 0, rgba(240,166,17,0) 85%,#fb1 0)0 0, linear-gradient(150deg,#fb1 24%,#B71 0,#B71 26%,rgba(240,166,17,0) 0,rgba(240,166,17,0) 74%,#B71 0,#B71 76%,#fb1 0)0 0, linear-gradient(30deg,#fb1 24%,#B71 0,#B71 26%,rgba(240,166,17,0) 0,rgba(240,166,17,0) 74%,#B71 0,#B71 76%,#fb1 0)0 0, linear-gradient(90deg,#B71 2%,#fb1 0,#fb1 98%,#B71 0%)0 0 #fb1;background-size: 40px 60px;","background-color: gray;background-image: linear-gradient(transparent 50%, rgba(255,255,255,.5) 50%);background-size: 50px 50px;","background-color: gray;background-image: linear-gradient(90deg, transparent 50%, rgba(255,255,255,.5) 50%);background-size: 50px 50px;","background-color: #026873;background-image: linear-gradient(90deg, rgba(255,255,255,.07) 50%, transparent 50%),linear-gradient(90deg, rgba(255,255,255,.13) 50%, transparent 50%),linear-gradient(90deg, transparent 50%, rgba(255,255,255,.17) 50%),linear-gradient(90deg, transparent 50%, rgba(255,255,255,.19) 50%);background-size: 13px, 29px, 37px, 53px;","background-color: gray;background-image: repeating-linear-gradient(45deg, transparent, transparent 35px, rgba(255,255,255,.5) 35px, rgba(255,255,255,.5) 70px);","background-color:white;background-image: linear-gradient(90deg, rgba(200,0,0,.5) 50%, transparent 50%),linear-gradient(rgba(200,0,0,.5) 50%, transparent 50%);background-size:50px 50px;","background-color:#269;background-image: linear-gradient(white 2px, transparent 2px),linear-gradient(90deg, white 2px, transparent 2px),linear-gradient(rgba(255,255,255,.3) 1px, transparent 1px),linear-gradient(90deg, rgba(255,255,255,.3) 1px, transparent 1px);background-size: 100px 100px, 100px 100px, 20px 20px, 20px 20px;background-position:-2px -2px, -2px -2px, -1px -1px, -1px -1px;","background-color: #fff;background-image:linear-gradient(90deg, transparent 79px, #abced4 79px, #abced4 81px, transparent 81px),linear-gradient(#eee .1em, transparent .1em);background-size: 100% 1.2em;","background-color: hsl(34, 53%, 82%);background-image: repeating-linear-gradient(45deg, transparent 5px, hsla(197, 62%, 11%, 0.5) 5px, hsla(197, 62%, 11%, 0.5) 10px, hsla(5, 53%, 63%, 0) 10px, hsla(5, 53%, 63%, 0) 35px, hsla(5, 53%, 63%, 0.5) 35px, hsla(5, 53%, 63%, 0.5) 40px, hsla(197, 62%, 11%, 0.5) 40px, hsla(197, 62%, 11%, 0.5) 50px, hsla(197, 62%, 11%, 0) 50px, hsla(197, 62%, 11%, 0) 60px, hsla(5, 53%, 63%, 0.5) 60px, hsla(5, 53%, 63%, 0.5) 70px, hsla(35, 91%, 65%, 0.5) 70px, hsla(35, 91%, 65%, 0.5) 80px, hsla(35, 91%, 65%, 0) 80px, hsla(35, 91%, 65%, 0) 90px, hsla(5, 53%, 63%, 0.5) 90px, hsla(5, 53%, 63%, 0.5) 110px, hsla(5, 53%, 63%, 0) 110px, hsla(5, 53%, 63%, 0) 120px, hsla(197, 62%, 11%, 0.5) 120px, hsla(197, 62%, 11%, 0.5) 140px),repeating-linear-gradient(135deg, transparent 5px, hsla(197, 62%, 11%, 0.5) 5px, hsla(197, 62%, 11%, 0.5) 10px, hsla(5, 53%, 63%, 0) 10px, hsla(5, 53%, 63%, 0) 35px, hsla(5, 53%, 63%, 0.5) 35px, hsla(5, 53%, 63%, 0.5) 40px, hsla(197, 62%, 11%, 0.5) 40px, hsla(197, 62%, 11%, 0.5) 50px, hsla(197, 62%, 11%, 0) 50px, hsla(197, 62%, 11%, 0) 60px, hsla(5, 53%, 63%, 0.5) 60px, hsla(5, 53%, 63%, 0.5) 70px, hsla(35, 91%, 65%, 0.5) 70px, hsla(35, 91%, 65%, 0.5) 80px, hsla(35, 91%, 65%, 0) 80px, hsla(35, 91%, 65%, 0) 90px, hsla(5, 53%, 63%, 0.5) 90px, hsla(5, 53%, 63%, 0.5) 110px, hsla(5, 53%, 63%, 0) 110px, hsla(5, 53%, 63%, 0) 140px, hsla(197, 62%, 11%, 0.5) 140px, hsla(197, 62%, 11%, 0.5) 160px);","background-color: hsl(2, 57%, 40%);background-image: repeating-linear-gradient(transparent, transparent 50px, rgba(0,0,0,.4) 50px, rgba(0,0,0,.4) 53px, transparent 53px, transparent 63px, rgba(0,0,0,.4) 63px, rgba(0,0,0,.4) 66px, transparent 66px, transparent 116px, rgba(0,0,0,.5) 116px, rgba(0,0,0,.5) 166px, rgba(255,255,255,.2) 166px, rgba(255,255,255,.2) 169px, rgba(0,0,0,.5) 169px, rgba(0,0,0,.5) 179px, rgba(255,255,255,.2) 179px, rgba(255,255,255,.2) 182px, rgba(0,0,0,.5) 182px, rgba(0,0,0,.5) 232px, transparent 232px),repeating-linear-gradient(270deg, transparent, transparent 50px, rgba(0,0,0,.4) 50px, rgba(0,0,0,.4) 53px, transparent 53px, transparent 63px, rgba(0,0,0,.4) 63px, rgba(0,0,0,.4) 66px, transparent 66px, transparent 116px, rgba(0,0,0,.5) 116px, rgba(0,0,0,.5) 166px, rgba(255,255,255,.2) 166px, rgba(255,255,255,.2) 169px, rgba(0,0,0,.5) 169px, rgba(0,0,0,.5) 179px, rgba(255,255,255,.2) 179px, rgba(255,255,255,.2) 182px, rgba(0,0,0,.5) 182px, rgba(0,0,0,.5) 232px, transparent 232px),repeating-linear-gradient(125deg, transparent, transparent 2px, rgba(0,0,0,.2) 2px, rgba(0,0,0,.2) 3px, transparent 3px, transparent 5px, rgba(0,0,0,.2) 5px);","background-color: #eee;background-image: linear-gradient(45deg, black 25%, transparent 25%, transparent 75%, black 75%, black),linear-gradient(-45deg, black 25%, transparent 25%, transparent 75%, black 75%, black);background-size: 60px 60px;","background-color: #eee;background-image: linear-gradient(45deg, black 25%, transparent 25%, transparent 75%, black 75%, black),linear-gradient(45deg, black 25%, transparent 25%, transparent 75%, black 75%, black);background-size: 60px 60px;background-position: 0 0, 30px 30px;","background:linear-gradient(-45deg, white 25%, transparent 25%, transparent 75%, black 75%, black) 0 0, linear-gradient(-45deg, black 25%, transparent 25%, transparent 75%, white 75%, white) 1em 1em, linear-gradient(45deg, black 17%, transparent 17%, transparent 25%, black 25%, black 36%, transparent 36%, transparent 64%, black 64%, black 75%, transparent 75%, transparent 83%, black 83%) 1em 1em;background-color: white;background-size: 2em 2em;","background-color:#001;background-image: radial-gradient(white 15%, transparent 16%),radial-gradient(white 15%, transparent 16%);background-size: 60px 60px;background-position: 0 0, 30px 30px;","background-color:#556;background-image: linear-gradient(30deg, #445 12%, transparent 12.5%, transparent 87%, #445 87.5%, #445),linear-gradient(150deg, #445 12%, transparent 12.5%, transparent 87%, #445 87.5%, #445),linear-gradient(30deg, #445 12%, transparent 12.5%, transparent 87%, #445 87.5%, #445),linear-gradient(150deg, #445 12%, transparent 12.5%, transparent 87%, #445 87.5%, #445),linear-gradient(60deg, #99a 25%, transparent 25.5%, transparent 75%, #99a 75%, #99a),linear-gradient(60deg, #99a 25%, transparent 25.5%, transparent 75%, #99a 75%, #99a);background-size:80px 140px;background-position: 0 0, 0 0, 40px 70px, 40px 70px, 0 0, 40px 70px;","background-color:silver;background-image:radial-gradient(circle at 100% 150%, silver 24%, white 24%, white 28%, silver 28%, silver 36%, white 36%, white 40%, transparent 40%, transparent),radial-gradient(circle at 0    150%, silver 24%, white 24%, white 28%, silver 28%, silver 36%, white 36%, white 40%, transparent 40%, transparent),radial-gradient(circle at 50%  100%, white 10%, silver 10%, silver 23%, white 23%, white 30%, silver 30%, silver 43%, white 43%, white 50%, silver 50%, silver 63%, white 63%, white 71%, transparent 71%, transparent),radial-gradient(circle at 100% 50%, white 5%, silver 5%, silver 15%, white 15%, white 20%, silver 20%, silver 29%, white 29%, white 34%, silver 34%, silver 44%, white 44%, white 49%, transparent 49%, transparent),radial-gradient(circle at 0    50%, white 5%, silver 5%, silver 15%, white 15%, white 20%, silver 20%, silver 29%, white 29%, white 34%, silver 34%, silver 44%, white 44%, white 49%, transparent 49%, transparent);background-size: 100px 50px;","background-color: silver;background-image: linear-gradient(335deg, #b00 23px, transparent 23px),linear-gradient(155deg, #d00 23px, transparent 23px),linear-gradient(335deg, #b00 23px, transparent 23px),linear-gradient(155deg, #d00 23px, transparent 23px);background-size: 58px 58px;background-position: 0px 2px, 4px 35px, 29px 31px, 34px 6px;","background-color:#def;background-image: radial-gradient(closest-side, transparent 98%, rgba(0,0,0,.3) 99%),radial-gradient(closest-side, transparent 98%, rgba(0,0,0,.3) 99%);background-size:80px 80px;background-position:0 0, 40px 40px;","background-image:radial-gradient(closest-side, transparent 0%, transparent 75%, #B6CC66 76%, #B6CC66 85%, #EDFFDB 86%, #EDFFDB 94%, #FFFFFF 95%, #FFFFFF 103%, #D9E6A7 104%, #D9E6A7 112%, #798B3C 113%, #798B3C 121%, #FFFFFF 122%, #FFFFFF 130%, #E0EAD7 131%, #E0EAD7 140%),radial-gradient(closest-side, transparent 0%, transparent 75%, #B6CC66 76%, #B6CC66 85%, #EDFFDB 86%, #EDFFDB 94%, #FFFFFF 95%, #FFFFFF 103%, #D9E6A7 104%, #D9E6A7 112%, #798B3C 113%, #798B3C 121%, #FFFFFF 122%, #FFFFFF 130%, #E0EAD7 131%, #E0EAD7 140%);background-size: 110px 110px;background-color: #C8D3A7;background-position: 0 0, 55px 55px;","background:linear-gradient(324deg, #232927 4%,   transparent 4%) -70px 43px, linear-gradient( 36deg, #232927 4%,   transparent 4%) 30px 43px, linear-gradient( 72deg, #e3d7bf 8.5%, transparent 8.5%) 30px 43px, linear-gradient(288deg, #e3d7bf 8.5%, transparent 8.5%) -70px 43px, linear-gradient(216deg, #e3d7bf 7.5%, transparent 7.5%) -70px 23px, linear-gradient(144deg, #e3d7bf 7.5%, transparent 7.5%) 30px 23px, linear-gradient(324deg, #232927 4%,   transparent 4%) -20px 93px, linear-gradient( 36deg, #232927 4%,   transparent 4%) 80px 93px, linear-gradient( 72deg, #e3d7bf 8.5%, transparent 8.5%) 80px 93px, linear-gradient(288deg, #e3d7bf 8.5%, transparent 8.5%) -20px 93px, linear-gradient(216deg, #e3d7bf 7.5%, transparent 7.5%) -20px 73px, linear-gradient(144deg, #e3d7bf 7.5%, transparent 7.5%) 80px 73px;background-color: #232927;background-size: 100px 100px;","background:radial-gradient(circle at 50% 59%, #D2CAAB 3%, #364E27 4%, #364E27 11%, rgba(54,78,39,0) 12%, rgba(54,78,39,0)) 50px 0, radial-gradient(circle at 50% 41%, #364E27 3%, #D2CAAB 4%, #D2CAAB 11%, rgba(210,202,171,0) 12%, rgba(210,202,171,0)) 50px 0, radial-gradient(circle at 50% 59%, #D2CAAB 3%, #364E27 4%, #364E27 11%, rgba(54,78,39,0) 12%, rgba(54,78,39,0)) 0 50px, radial-gradient(circle at 50% 41%, #364E27 3%, #D2CAAB 4%, #D2CAAB 11%, rgba(210,202,171,0) 12%, rgba(210,202,171,0)) 0 50px, radial-gradient(circle at 100% 50%, #D2CAAB 16%, rgba(210,202,171,0) 17%),radial-gradient(circle at 0% 50%, #364E27 16%, rgba(54,78,39,0) 17%),radial-gradient(circle at 100% 50%, #D2CAAB 16%, rgba(210,202,171,0) 17%) 50px 50px, radial-gradient(circle at 0% 50%, #364E27 16%, rgba(54,78,39,0) 17%) 50px 50px;background-color:#63773F;background-size:100px 100px;","background:radial-gradient(circle, transparent 20%, slategray 20%, slategray 80%, transparent 80%, transparent),radial-gradient(circle, transparent 20%, slategray 20%, slategray 80%, transparent 80%, transparent) 50px 50px, linear-gradient(#A8B1BB 8px, transparent 8px) 0 -4px, linear-gradient(90deg, #A8B1BB 8px, transparent 8px) -4px 0;background-color: slategray;background-size:100px 100px, 100px 100px, 50px 50px, 50px 50px;","background:radial-gradient(circle at 100% 50%, transparent 20%, rgba(255,255,255,.3) 21%, rgba(255,255,255,.3) 34%, transparent 35%, transparent),radial-gradient(circle at 0% 50%, transparent 20%, rgba(255,255,255,.3) 21%, rgba(255,255,255,.3) 34%, transparent 35%, transparent) 0 -50px;background-color: slategray;background-size:75px 100px;","background-color: #FF7D9D;background-size: 58px 58px;background-position: 0px 2px, 4px 35px, 29px 31px, 33px 6px, 0px 36px, 4px 2px, 29px 6px, 33px 30px;background-image:linear-gradient(335deg, #C90032 23px, transparent 23px),linear-gradient(155deg, #C90032 23px, transparent 23px),linear-gradient(335deg, #C90032 23px, transparent 23px),linear-gradient(155deg, #C90032 23px, transparent 23px),linear-gradient(335deg, #C90032 10px, transparent 10px),linear-gradient(155deg, #C90032 10px, transparent 10px),linear-gradient(335deg, #C90032 10px, transparent 10px),linear-gradient(155deg, #C90032 10px, transparent 10px);","background-color: #6d695c;background-image:repeating-linear-gradient(120deg, rgba(255,255,255,.1), rgba(255,255,255,.1) 1px, transparent 1px, transparent 60px),repeating-linear-gradient(60deg, rgba(255,255,255,.1), rgba(255,255,255,.1) 1px, transparent 1px, transparent 60px),linear-gradient(60deg, rgba(0,0,0,.1) 25%, transparent 25%, transparent 75%, rgba(0,0,0,.1) 75%, rgba(0,0,0,.1)),linear-gradient(120deg, rgba(0,0,0,.1) 25%, transparent 25%, transparent 75%, rgba(0,0,0,.1) 75%, rgba(0,0,0,.1));background-size: 70px 120px;","background:radial-gradient(circle closest-side at 60% 43%, #b03 26%, rgba(187,0,51,0) 27%),radial-gradient(circle closest-side at 40% 43%, #b03 26%, rgba(187,0,51,0) 27%),radial-gradient(circle closest-side at 40% 22%, #d35 45%, rgba(221,51,85,0) 46%),radial-gradient(circle closest-side at 60% 22%, #d35 45%, rgba(221,51,85,0) 46%),radial-gradient(circle closest-side at 50% 35%, #d35 30%, rgba(221,51,85,0) 31%),radial-gradient(circle closest-side at 60% 43%, #b03 26%, rgba(187,0,51,0) 27%) 50px 50px, radial-gradient(circle closest-side at 40% 43%, #b03 26%, rgba(187,0,51,0) 27%) 50px 50px, radial-gradient(circle closest-side at 40% 22%, #d35 45%, rgba(221,51,85,0) 46%) 50px 50px, radial-gradient(circle closest-side at 60% 22%, #d35 45%, rgba(221,51,85,0) 46%) 50px 50px, radial-gradient(circle closest-side at 50% 35%, #d35 30%, rgba(221,51,85,0) 31%) 50px 50px;background-color:#b03;background-size:100px 100px;","background:radial-gradient(black 15%, transparent 16%) 0 0, radial-gradient(black 15%, transparent 16%) 8px 8px, radial-gradient(rgba(255,255,255,.1) 15%, transparent 20%) 0 1px, radial-gradient(rgba(255,255,255,.1) 15%, transparent 20%) 8px 9px;background-color:#282828;background-size:16px 16px;","background:linear-gradient(27deg, #151515 5px, transparent 5px) 0 5px, linear-gradient(207deg, #151515 5px, transparent 5px) 10px 0px, linear-gradient(27deg, #222 5px, transparent 5px) 0px 10px, linear-gradient(207deg, #222 5px, transparent 5px) 10px 5px, linear-gradient(90deg, #1b1b1b 10px, transparent 10px),linear-gradient(#1d1d1d 25%, #1a1a1a 25%, #1a1a1a 50%, transparent 50%, transparent 75%, #242424 75%, #242424);background-color: #131313;background-size: 20px 20px;","background:radial-gradient(rgba(255,255,255,0) 0, rgba(255,255,255,.15) 30%, rgba(255,255,255,.3) 32%, rgba(255,255,255,0) 33%) 0 0, radial-gradient(rgba(255,255,255,0) 0, rgba(255,255,255,.1) 11%, rgba(255,255,255,.3) 13%, rgba(255,255,255,0) 14%) 0 0, radial-gradient(rgba(255,255,255,0) 0, rgba(255,255,255,.2) 17%, rgba(255,255,255,.43) 19%, rgba(255,255,255,0) 20%) 0 110px, radial-gradient(rgba(255,255,255,0) 0, rgba(255,255,255,.2) 11%, rgba(255,255,255,.4) 13%, rgba(255,255,255,0) 14%) -130px -170px, radial-gradient(rgba(255,255,255,0) 0, rgba(255,255,255,.2) 11%, rgba(255,255,255,.4) 13%, rgba(255,255,255,0) 14%) 130px 370px, radial-gradient(rgba(255,255,255,0) 0, rgba(255,255,255,.1) 11%, rgba(255,255,255,.2) 13%, rgba(255,255,255,0) 14%) 0 0, linear-gradient(45deg, #343702 0%, #184500 20%, #187546 30%, #006782 40%, #0b1284 50%, #760ea1 60%, #83096e 70%, #840b2a 80%, #b13e12 90%, #e27412 100%);background-size: 470px 470px, 970px 970px, 410px 410px, 610px 610px, 530px 530px, 730px 730px, 100% 100%;background-color: #840b2a;","background-color:white;background-image:radial-gradient(midnightblue 9px, transparent 10px),repeating-radial-gradient(midnightblue 0, midnightblue 4px, transparent 5px, transparent 20px, midnightblue 21px, midnightblue 25px, transparent 26px, transparent 50px);background-size: 30px 30px, 90px 90px;background-position: 0 0;","background-color:black;background-image:radial-gradient(white, rgba(255,255,255,.2) 2px, transparent 40px),radial-gradient(white, rgba(255,255,255,.15) 1px, transparent 30px),radial-gradient(white, rgba(255,255,255,.1) 2px, transparent 40px),radial-gradient(rgba(255,255,255,.4), rgba(255,255,255,.1) 2px, transparent 30px);background-size: 550px 550px, 350px 350px, 250px 250px, 150px 150px;background-position: 0 0, 40px 60px, 130px 270px, 70px 100px;","background:radial-gradient(hsl(0, 100%, 27%) 4%, hsl(0, 100%, 18%) 9%, hsla(0, 100%, 20%, 0) 9%) 0 0, radial-gradient(hsl(0, 100%, 27%) 4%, hsl(0, 100%, 18%) 8%, hsla(0, 100%, 20%, 0) 10%) 50px 50px, radial-gradient(hsla(0, 100%, 30%, 0.8) 20%, hsla(0, 100%, 20%, 0)) 50px 0, radial-gradient(hsla(0, 100%, 30%, 0.8) 20%, hsla(0, 100%, 20%, 0)) 0 50px, radial-gradient(hsla(0, 100%, 20%, 1) 35%, hsla(0, 100%, 20%, 0) 60%) 50px 0, radial-gradient(hsla(0, 100%, 20%, 1) 35%, hsla(0, 100%, 20%, 0) 60%) 100px 50px, radial-gradient(hsla(0, 100%, 15%, 0.7), hsla(0, 100%, 20%, 0)) 0 0, radial-gradient(hsla(0, 100%, 15%, 0.7), hsla(0, 100%, 20%, 0)) 50px 50px, linear-gradient(45deg, hsla(0, 100%, 20%, 0) 49%, hsla(0, 100%, 0%, 1) 50%, hsla(0, 100%, 20%, 0) 70%) 0 0, linear-gradient(-45deg, hsla(0, 100%, 20%, 0) 49%, hsla(0, 100%, 0%, 1) 50%, hsla(0, 100%, 20%, 0) 70%) 0 0;background-color: #300;background-size: 100px 100px;","background:linear-gradient(135deg, #708090 21px, #d9ecff 22px, #d9ecff 24px, transparent 24px, transparent 67px, #d9ecff 67px, #d9ecff 69px, transparent 69px),linear-gradient(225deg, #708090 21px, #d9ecff 22px, #d9ecff 24px, transparent 24px, transparent 67px, #d9ecff 67px, #d9ecff 69px, transparent 69px)0 64px;background-color:#708090;background-size: 64px 128px;","background:linear-gradient(135deg, #ECEDDC 25%, transparent 25%) -50px 0, linear-gradient(225deg, #ECEDDC 25%, transparent 25%) -50px 0, linear-gradient(315deg, #ECEDDC 25%, transparent 25%),linear-gradient(45deg, #ECEDDC 25%, transparent 25%);background-size: 100px 100px;background-color: #EC173A;","background:linear-gradient(45deg, #92baac 45px, transparent 45px)64px 64px, linear-gradient(45deg, #92baac 45px, transparent 45px,transparent 91px, #e1ebbd 91px, #e1ebbd 135px, transparent 135px),linear-gradient(-45deg, #92baac 23px, transparent 23px, transparent 68px,#92baac 68px,#92baac 113px,transparent 113px,transparent 158px,#92baac 158px);background-color:#e1ebbd;background-size: 128px 128px;","background:linear-gradient(63deg, #999 23%, transparent 23%) 7px 0,linear-gradient(63deg, transparent 74%, #999 78%),linear-gradient(63deg, transparent 34%, #999 38%, #999 58%, transparent 62%),#444;background-size: 16px 48px;","background:#36c;background:linear-gradient(115deg, transparent 75%, rgba(255,255,255,.8) 75%) 0 0,linear-gradient(245deg, transparent 75%, rgba(255,255,255,.8) 75%) 0 0,linear-gradient(115deg, transparent 75%, rgba(255,255,255,.8) 75%) 7px -15px,linear-gradient(245deg, transparent 75%, rgba(255,255,255,.8) 75%) 7px -15px,#36c;background-size: 15px 30px;","background:radial-gradient(circle at 0% 50%, rgba(96, 16, 48, 0) 9px, #613 10px, rgba(96, 16, 48, 0) 11px) 0px 10px,radial-gradient(at 100% 100%,rgba(96, 16, 48, 0) 9px, #613 10px, rgba(96, 16, 48, 0) 11px),#8a3;background-size: 20px 20px;","background-image:linear-gradient(to top, #a18cd1 0%, #fbc2eb 100%)","background-image:linear-gradient(to top, #fbc2eb 0%, #a6c1ee 100%)","background-image:linear-gradient(120deg, #a6c0fe 0%, #f68084 100%)","background-image:linear-gradient(120deg, #e0c3fc 0%, #8ec5fc 100%)","background-image:linear-gradient(to right, #fa709a 0%, #fee140 100%)","background-image:linear-gradient(to top, #30cfd0 0%, #330867 100%)","background-image:linear-gradient(to top, #a8edea 0%, #fed6e3 100%)","background-image:linear-gradient(to top, #d299c2 0%, #fef9d7 100%)","background-image:linear-gradient(to top, #fddb92 0%, #d1fdff 100%)","background-image:linear-gradient(to top, #9890e3 0%, #b1f4cf 100%)","background-image:linear-gradient(to top, #96fbc4 0%, #f9f586 100%)","background-image:linear-gradient(to right, #eea2a2 0%, #bbc1bf 19%, #57c6e1 42%, #b49fda 79%, #7ac5d8 100%)","background-image:linear-gradient(to top, #9795f0 0%, #fbc8d4 100%)","background-image:linear-gradient(to top, #3f51b1 0%, #5a55ae 13%, #7b5fac 25%, #8f6aae 38%, #a86aa4 50%, #cc6b8e 62%, #f18271 75%, #f3a469 87%, #f7c978 100%)","background-image:linear-gradient(to top, #f43b47 0%, #453a94 100%)","background-image:linear-gradient(to top, #88d3ce 0%, #6e45e2 100%)","background-image:linear-gradient(to top, #d9afd9 0%, #97d9e1 100%)","background-image:linear-gradient(-20deg, #b721ff 0%, #21d4fd 100%)","background-image:linear-gradient(60deg, #abecd6 0%, #fbed96 100%)","background-image:linear-gradient(to top, #3b41c5 0%, #a981bb 49%, #ffc8a9 100%)","background-image:linear-gradient(to top, #0fd850 0%, #f9f047 100%)","background-image:linear-gradient(to top, #d5dee7 0%, #ffafbd 0%, #c9ffbf 100%)","background-image:linear-gradient(to top, #65bd60 0%, #5ac1a8 25%, #3ec6ed 50%, #b7ddb7 75%, #fef381 100%)","background-image:linear-gradient(to top, #50cc7f 0%, #f5d100 100%)","background-image:linear-gradient(to top, #df89b5 0%, #bfd9fe 100%)","background-image:linear-gradient(to top, #e14fad 0%, #f9d423 100%)","background-image:linear-gradient(to right, #ec77ab 0%, #7873f5 100%)","background-image:linear-gradient(-225deg, #2CD8D5 0%, #C5C1FF 56%, #FFBAC3 100%)","background-image:linear-gradient(-225deg, #5271C4 0%, #B19FFF 48%, #ECA1FE 100%)","background-image:linear-gradient(-225deg, #FF3CAC 0%, #562B7C 52%, #2B86C5 100%)","background-image:linear-gradient(-225deg, #69EACB 0%, #EACCF8 48%, #6654F1 100%)","background-image:linear-gradient(-225deg, #231557 0%, #44107A 29%, #FF1361 67%, #FFF800 100%)"];class ap{constructor(t){this.transparentData="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=",this.element=document.createElement("div"),this.element.className="protyle-background",this.element.innerHTML=`<div class="protyle-background__img">
    <img src="${this.transparentData}">
    <div class="protyle-icons">
        <span class="protyle-icon protyle-icon--first" style="position: relative;overflow: hidden"><input aria-label="${window.siyuan.languages.upload}" class="ariaLabel" type="file" style="position: absolute;height: 100%;top: 0;right: 0;opacity: .001;overflow: hidden;cursor: pointer;"><svg><use xlink:href="#iconUpload"></use></svg></span>
        <span class="protyle-icon ariaLabel" data-type="link" aria-label="${window.siyuan.languages.link}"><svg><use xlink:href="#iconLink"></use></svg></span>
        <span class="protyle-icon ariaLabel" data-type="asset" aria-label="${window.siyuan.languages.assets}"><svg><use xlink:href="#iconImage"></use></svg></span>
        <span class="protyle-icon ariaLabel" data-type="show-random" aria-label="${window.siyuan.languages.builtIn}"><svg><use xlink:href="#iconRefresh"></use></svg></span>
        <span class="protyle-icon ariaLabel fn__none" data-type="position" aria-label="${window.siyuan.languages.dragPosition}"><svg><use xlink:href="#iconMove"></use></svg></span>
        <span class="protyle-icon protyle-icon--last ariaLabel" data-type="remove" aria-label="${window.siyuan.languages.remove}"><svg><use xlink:href="#iconTrashcan"></use></svg></span>
    </div>
    <div class="protyle-icons fn__none"><span class="protyle-icon protyle-icon--text">${window.siyuan.languages.dragPosition}</span></div>
    <div class="protyle-icons fn__none" style="opacity: .86;">
        <span class="protyle-icon protyle-icon--first" data-type="cancel">${window.siyuan.languages.cancel}</span>
        <span class="protyle-icon protyle-icon--last" data-type="confirm">${window.siyuan.languages.confirm}</span>
    </div>
</div>
<div class="protyle-background__ia">
    <div class="protyle-background__icon" data-menu="true" data-type="open-emoji"></div>
    <div class="b3-chips b3-chips__doctag fn__none"></div>
    <div class="protyle-background__action">
        <button class="b3-button b3-button--cancel" data-menu="true" data-type="tag">
            <svg><use xlink:href="#iconTags"></use></svg>
            ${window.siyuan.languages.addTag}
        </button>
        <button class="b3-button b3-button--cancel" data-type="icon">
            <svg><use xlink:href="#iconEmoji"></use></svg>
            ${window.siyuan.languages.addIcon}
        </button>
        <button class="b3-button b3-button--cancel" data-type="random">
            <svg><use xlink:href="#iconImage"></use></svg>
            ${window.siyuan.languages.titleBg}
        </button>
    </div>
</div>`,this.tagsElement=this.element.querySelector(".b3-chips"),this.iconElement=this.element.querySelector(".protyle-background__icon"),this.imgElement=this.element.querySelector(".protyle-background__img img"),this.actionElements=this.element.querySelectorAll(".protyle-background__action:not(.fn__flex-center) .b3-button"),this.element.addEventListener("dragover",n=>Ad(this,null,function*(){n.preventDefault()})),this.element.addEventListener("drop",n=>Ad(this,null,function*(){n.dataTransfer.types[0]==="Files"&&n.dataTransfer.files[0].type.indexOf("image")!==-1&&Rn(t,[n.dataTransfer.files[0]],void 0,a=>{const s=JSON.parse(a),i=`background-image:url("${s.data.succMap[Object.keys(s.data.succMap)[0]]}")`;this.ial["title-img"]=i,this.render(this.ial,t.block.rootID),A("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{"title-img":i}})})})),this.imgElement.addEventListener("mousedown",n=>{if(n.preventDefault(),!this.element.firstElementChild.querySelector(".protyle-icons").classList.contains("fn__none"))return;const a=n.clientY,s=document,i=this.imgElement.naturalHeight*this.imgElement.clientWidth/this.imgElement.naturalWidth-this.imgElement.clientHeight;let l=parseFloat(this.imgElement.style.objectPosition.substring(7))||50;this.imgElement.style.objectPosition.endsWith("px")&&(l=-parseInt(this.imgElement.style.objectPosition.substring(7))/i*100),s.onmousemove=o=>{this.imgElement.style.objectPosition=`center ${((a-o.clientY)/i*100+l).toFixed(2)}%`,n.preventDefault()},s.onmouseup=()=>{s.onmousemove=null,s.onmouseup=null,s.ondragstart=null,s.onselectstart=null,s.onselect=null}}),this.element.querySelector("input").addEventListener("change",n=>{n.target.files.length!==0&&Rn(t,n.target.files,n.target,a=>{const s=JSON.parse(a),i=`background-image:url("${s.data.succMap[Object.keys(s.data.succMap)[0]]}")`;this.ial["title-img"]=i,this.render(this.ial,t.block.rootID),A("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{"title-img":i}})})}),this.element.addEventListener(wa(),n=>{if(t.disabled)return;let a=n.target;for(J(["gutter"],t);a&&!a.isEqualNode(this.element);){const s=a.getAttribute("data-type");if(a.tagName==="IMG"&&a.parentElement.classList.contains("protyle-background__img")){const i=a.getAttribute("src");n.detail>1&&!i.startsWith("data:image/png;base64")&&(wi(i),n.preventDefault(),n.stopPropagation()),window.siyuan.menus.menu.remove();break}else if(s==="position"){const i=this.element.firstElementChild.querySelectorAll(".protyle-icons");i[0].classList.add("fn__none"),i[1].classList.remove("fn__none"),i[2].classList.remove("fn__none"),this.imgElement.style.cursor="move",n.preventDefault(),n.stopPropagation();break}else if(s==="cancel"||s==="confirm"){this.imgElement.style.cursor="";const i=this.element.firstElementChild.querySelectorAll(".protyle-icons");if(i[0].classList.remove("fn__none"),i[1].classList.add("fn__none"),i[2].classList.add("fn__none"),s==="confirm"){const l=`background-image:url("${this.imgElement.getAttribute("src")}");object-position:${this.imgElement.style.objectPosition}`;this.ial["title-img"]=l,A("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{"title-img":l}})}else this.render(this.ial,t.block.rootID);n.preventDefault(),n.stopPropagation();break}else if(s==="open-emoji"){const i=this.iconElement.getBoundingClientRect();_a(t.block.rootID,"doc",{x:i.left,y:i.bottom,h:i.height,w:i.width},void 0,a.querySelector("img")),n.preventDefault(),n.stopPropagation();break}else if(s==="show-random"){let i="";Us.forEach((o,r)=>{i+=`<div data-index="${r}" style="height: 128px;${o}" class="b3-card b3-card--wrap"></div>`});const l=new we({title:window.siyuan.languages.builtIn,content:`<div class="b3-cards">${i}</div>`,width:H()?"92vw":"912px",height:H()?"80vh":"70vh"});l.element.setAttribute("data-key",f.DIALOG_BACKGROUNDRANDOM),l.element.addEventListener("click",o=>{const r=o.target;r.classList.contains("b3-card")&&(this.ial["title-img"]=Us[parseInt(r.getAttribute("data-index"))],this.render(this.ial,t.block.rootID),A("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{"title-img":this.ial["title-img"]}}),l.destroy())}),n.preventDefault(),n.stopPropagation();break}else if(s==="random"){this.ial["title-img"]=Us[rt(0,Us.length-1)],this.render(this.ial,t.block.rootID),A("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{"title-img":this.ial["title-img"]}}),n.preventDefault(),n.stopPropagation();break}else if(s==="asset"){const i=a.getBoundingClientRect();Tl(t,{x:a.parentElement.getBoundingClientRect().right,y:i.bottom+8,isLeft:!0},l=>{this.ial["title-img"]=`background-image:url("${l}")`,this.render(this.ial,t.block.rootID),A("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{"title-img":this.ial["title-img"]}}),window.siyuan.menus.menu.remove()},f.SIYUAN_ASSETS_IMAGE),n.preventDefault(),n.stopPropagation();break}else if(s==="remove"){delete this.ial["title-img"],this.render(this.ial,t.block.rootID),A("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{"title-img":""}}),n.preventDefault(),n.stopPropagation();break}else if(s==="icon"){const i=No();if(i){va(i,t.block.rootID),es(i,t.block.rootID),A("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{icon:i}}),t.model&&t.model.parent.setDocIcon(i),this.iconElement.classList.remove("fn__none");const l=this.iconElement.getBoundingClientRect();_a(t.block.rootID,"doc",{x:l.left,y:l.bottom,h:l.height,w:l.width})}n.preventDefault(),n.stopPropagation();break}else if(s==="tag"){this.openTag(t,a),n.preventDefault(),n.stopPropagation();break}else if(s==="link"){const i=new we({title:window.siyuan.languages.link,width:H()?"92vw":"520px",content:`<div class="b3-dialog__content">
        <input class="b3-text-field fn__block" value="${this.imgElement.src.startsWith("data:")?"":this.imgElement.getAttribute("src")}">
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`});i.element.setAttribute("data-key",f.DIALOG_BACKGROUNDLINK);const l=i.element.querySelectorAll(".b3-button");l[0].addEventListener("click",()=>{i.destroy()}),l[1].addEventListener("click",()=>{const o=`background-image:url("${i.element.querySelector("input").value}");`;this.ial["title-img"]=o,this.render(this.ial,t.block.rootID),A("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{"title-img":this.ial["title-img"]}}),i.destroy()}),i.element.querySelector("input").focus(),n.preventDefault(),n.stopPropagation();break}else if(s==="open-search"){qt(t.app,{hasReplace:!1,method:0,hPath:"",idPath:[],k:`#${a.textContent}#`,r:"",page:1}),n.preventDefault(),n.stopPropagation();break}else if(s==="remove-tag"){a.parentElement.remove(),this.removeTag(t),n.preventDefault(),n.stopPropagation();break}a=a.parentElement}})}removeTag(t){const n=this.getTags();A("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{tags:n.toString()}}),n.length===0?delete this.ial.tags:this.ial.tags=n.toString(),this.render(this.ial,t.block.rootID)}render(t,n){var a;const s=t["title-img"],i=t.icon,l=t.tags;if(this.ial=t,this.element.setAttribute("data-node-id",n),l){let o="";const r=["secondary","primary","info","success","warning","error","pink"];Array.from(new Set(l.split(",").map(c=>c.trim()))).forEach((c,d)=>{c.replace(/ /g,"")&&(o+=`<div class="b3-chip b3-chip--middle b3-chip--pointer b3-chip--${r[d%7]}" data-type="open-search">${pe(c)}<svg class="b3-chip__close" data-type="remove-tag"><use xlink:href="#iconCloseRound"></use></svg></div>`)}),this.tagsElement.innerHTML=`${o}
<div class="protyle-background__action fn__flex-center">
    <button class="b3-button b3-button--cancel" style="margin-bottom: 8px" data-menu="true" data-type="tag"><svg><use xlink:href="#iconAdd"></use></svg>${window.siyuan.languages.addTag}</button>
</div>`,this.tagsElement.classList.remove("fn__none"),this.actionElements[0].classList.add("fn__none")}else this.tagsElement.classList.add("fn__none"),this.actionElements[0].classList.remove("fn__none");if(i?(this.iconElement.classList.remove("fn__none"),this.iconElement.innerHTML=ge(i),this.actionElements[1].classList.add("fn__none")):(this.actionElements[1].classList.remove("fn__none"),this.iconElement.classList.add("fn__none")),s){if(this.imgElement.setAttribute("style",Lute.UnEscapeHTMLStr(s)),s.indexOf("url(")>-1){const o=this.imgElement.style.backgroundPosition||this.imgElement.style.objectPosition,r=(a=this.imgElement.style.backgroundImage)==null?void 0:a.replace(/^url\(["']?/,"").replace(/["']?\)$/,"");this.imgElement.removeAttribute("style"),this.imgElement.setAttribute("src",r),this.imgElement.style.objectPosition=o,this.element.querySelector('[data-type="position"]').classList.remove("fn__none")}else this.imgElement.setAttribute("src",this.transparentData),this.element.querySelector('[data-type="position"]').classList.add("fn__none");this.actionElements[2].classList.add("fn__none"),this.imgElement.parentElement.classList.remove("fn__none"),this.iconElement.style.marginTop="",this.imgElement.style.height="200px"}else this.imgElement.parentElement.classList.add("fn__none"),this.actionElements[2].classList.remove("fn__none"),this.iconElement.style.marginTop="8px";s||i?this.iconElement.parentElement.style.marginTop="":this.iconElement.parentElement.style.marginTop="8px"}openTag(t,n){window.siyuan.menus.menu.remove();const a=new Ke;a.addItem({iconHTML:"",type:"empty",label:`<div class="fn__flex-column b3-menu__filter">
    <input class="b3-text-field fn__flex-shrink" placeholder="${window.siyuan.languages.tag}"/>
    <div class="fn__hr"></div>
    <div class="b3-list fn__flex-1 b3-list--background">
        <img style="margin: 0 auto;display: block;width: 64px;height: 64px" src="/stage/loading-pure.svg">
    </div>
</div>`,bind:i=>{const l=i.querySelector(".b3-list--background");A("/api/search/searchTag",{k:""},r=>{let c="";const d=this.getTags();r.data.tags.forEach((u,p)=>{c+=`<div class="b3-list-item b3-list-item--narrow${p===0?" b3-list-item--focus":""}">
    <div class="fn__flex-1">${u}</div>
    ${d.includes(Lute.UnEscapeHTMLStr(u))?'<svg class="b3-menu__checked"><use xlink:href="#iconSelect"></use></svg>':""}
</div>`}),l.innerHTML=c});const o=i.querySelector("input");o.addEventListener("keydown",r=>{if(r.stopPropagation(),!r.isComposing)if(Wt(l,r),r.key==="Enter"){const c=l.querySelector(".b3-list-item--focus");c?this.addTags(c.textContent.trim(),t):this.addTags(o.value.trim(),t),o.value="",o.dispatchEvent(new CustomEvent("input"))}else r.key==="Escape"&&window.siyuan.menus.menu.remove()}),o.addEventListener("input",r=>{r.stopPropagation(),A("/api/search/searchTag",{k:o.value},c=>{let d="",u=!1;const p=this.getTags();c.data.tags.forEach(g=>{d+=`<div class="b3-list-item b3-list-item--narrow">
    <div class="fn__flex-1">${g}</div>
    ${p.includes(Lute.UnEscapeHTMLStr(g.replace(/<mark>/g,"").replace(/<\/mark>/g,"")))?'<svg class="b3-menu__checked"><use xlink:href="#iconSelect"></use></svg>':""}
</div>`,g===`<mark>${c.data.k}</mark>`&&(u=!0)}),!u&&c.data.k&&(d=`<div class="b3-list-item b3-list-item--narrow"><mark>${pe(c.data.k)}</mark></div>`+d),l.innerHTML=d,l.firstElementChild.classList.add("b3-list-item--focus")})}),l.addEventListener("click",r=>{const c=r.target,d=$(c,"b3-list-item");d&&(this.addTags(d.textContent.trim(),t),o.dispatchEvent(new CustomEvent("input")))})}});const s=a.element.querySelector(".b3-menu__items");s.setAttribute("style","overflow: initial"),a.fullscreen(),s.firstElementChild.setAttribute("style","padding: 0 8px;height: 100%;")}getTags(t){const n=[];return this.tagsElement.querySelectorAll(".b3-chip").forEach(a=>{const s=a.textContent.trim();t&&s===t&&a.remove(),n.push(s)}),n}addTags(t,n){const a=this.getTags(t);if(a.includes(t)){this.removeTag(n);return}a.push(t),A("/api/attr/setBlockAttrs",{id:n.block.rootID,attrs:{tags:a.toString()}}),this.ial.tags=a.toString(),this.render(this.ial,n.block.rootID)}}class Yn{constructor(t,n,a){this.version=f.SIYUAN_VERSION;let s=a;t.plugins.forEach(o=>{o.protyleOptions&&(s=uo(s,o.protyleOptions))});const l=new Tg(s).merge();if(this.protyle={getInstance:()=>this,app:t,transactionTime:new Date().getTime(),id:na(),disabled:!1,updated:!1,element:n,options:l,block:{},highlight:{mark:On()?new Highlight:void 0,markHL:On()?new Highlight:void 0,ranges:[],rangeIndex:0,styleElement:document.createElement("style")}},On()){const o=na();this.protyle.highlight.styleElement.dataset.uuid=o,this.protyle.highlight.styleElement.textContent=`.protyle-wysiwyg::highlight(search-mark-${o}) {background-color: var(--b3-highlight-background);color: var(--b3-highlight-color);}
  .protyle-wysiwyg::highlight(search-mark-hl-${o}) {color: var(--b3-highlight-color);background-color: var(--b3-highlight-current-background)}`}if(this.protyle.hint=new Sg(this.protyle),l.render.breadcrumb&&(this.protyle.breadcrumb=new tp(this.protyle)),l.render.title&&(this.protyle.title=new np(this.protyle)),l.render.background&&(this.protyle.background=new ap(this.protyle)),this.protyle.element.innerHTML="",this.protyle.element.classList.add("protyle"),l.render.breadcrumb&&this.protyle.element.appendChild(this.protyle.breadcrumb.element.parentElement),this.protyle.undo=new zu,this.protyle.wysiwyg=new Ng(this.protyle),this.protyle.toolbar=new jg(this.protyle),this.protyle.scroll=new $g(this.protyle),this.protyle.options.render.gutter&&(this.protyle.gutter=new Vg(this.protyle)),(l.upload.url||l.upload.handler)&&(this.protyle.upload=new Yf),this.init(),l.action.includes(f.CB_GET_HISTORY))this.protyle.contentElement.classList.add("protyle-content--transition");else{if(this.protyle.ws=new Oi({app:t,id:this.protyle.id,type:"protyle",msgCallback:o=>{var r;switch(o.cmd){case"reload":o.data===this.protyle.block.rootID&&(Un(this.protyle,!1),Zs().outline.forEach(c=>{c.blockId===o.data&&A("/api/outline/getDocOutline",{id:c.blockId,preview:c.isPreview},d=>{c.update(d)})}));break;case"refreshAttributeView":Array.from(this.protyle.wysiwyg.element.querySelectorAll(`[data-av-id="${o.data.id}"]`)).forEach(c=>{c.removeAttribute("data-render"),ze(c,this.protyle)});break;case"addLoading":o.data===this.protyle.block.rootID&&ei(this.protyle,o.msg);break;case"transactions":o.data[0].doOperations.find(c=>{if(!this.protyle.preview.element.classList.contains("fn__none")&&c.action!=="updateAttrs")this.protyle.preview.render(this.protyle);else{if(a.backlinkData&&["delete","move"].includes(c.action))return Zs().backlink.find(d=>{if(d.element.contains(this.protyle.element))return d.refresh(),!0}),!0;zl(this.protyle,c,!1)}});break;case"readonly":window.siyuan.config.editor.readOnly=o.data,jl(this.protyle,!0);break;case"heading2doc":case"li2doc":this.protyle.block.rootID===o.data.srcRootBlockID&&(this.protyle.block.showAll&&o.cmd==="heading2doc"&&!this.protyle.options.backlinkData?A("/api/filetree/getDoc",{id:this.protyle.block.rootID,size:window.siyuan.config.editor.dynamicLoadBlocks},c=>{Qe({data:c,protyle:this.protyle})}):Un(this.protyle,!1));break;case"rename":this.protyle.path===o.data.path&&(this.protyle.model&&this.protyle.model.parent.updateTitle(o.data.title),this.protyle.background&&(this.protyle.background.ial.title=o.data.title)),this.protyle.options.render.title&&this.protyle.block.parentID===o.data.id&&(!document.body.classList.contains("body--blur")&&getSelection().rangeCount>0&&((r=this.protyle.title.editElement)!=null&&r.contains(getSelection().getRangeAt(0).startContainer))||this.protyle.title.setTitle(o.data.title)),this.protyle.wysiwyg.element.querySelectorAll(`[data-type~="block-ref"][data-id="${o.data.id}"]`).forEach(c=>{c.getAttribute("data-subtype")==="d"&&(c.innerHTML=o.data.refText)});break;case"moveDoc":this.protyle.path===o.data.fromPath&&(this.protyle.path=o.data.newPath,this.protyle.notebookId=o.data.toNotebook);break;case"unmount":this.protyle.notebookId===o.data.box&&ii(t);break;case"removeDoc":o.data.ids.includes(this.protyle.block.rootID)&&(ii(t),delete window.siyuan.storage[f.LOCAL_FILEPOSITION][this.protyle.block.rootID],Ae(f.LOCAL_FILEPOSITION,window.siyuan.storage[f.LOCAL_FILEPOSITION]));break}}}),a.backlinkData){this.protyle.block.rootID=a.blockId,Ac(this.protyle,a.backlinkData),this.protyle.wysiwyg.element.style.paddingLeft="16px";return}if(!a.blockId){Ni(this.protyle);return}this.protyle.options.mode!=="preview"&&a.rootId&&window.siyuan.storage[f.LOCAL_FILEPOSITION][a.rootId]&&(l.action.includes(f.CB_GET_SCROLL)||l.action.includes(f.CB_GET_ROOTSCROLL)&&a.rootId===a.blockId)?Gl({protyle:this.protyle,scrollAttr:window.siyuan.storage[f.LOCAL_FILEPOSITION][a.rootId],mergedOptions:l,cb:()=>{this.afterOnGet(l)}}):this.getDoc(l)}}getDoc(t){var n;A("/api/filetree/getDoc",{id:t.blockId,isBacklink:t.action.includes(f.CB_GET_BACKLINK),originalRefBlockIDs:t.originalRefBlockIDs,mode:t.action&&t.action.includes(f.CB_GET_CONTEXT)?3:0,size:(n=t.action)!=null&&n.includes(f.CB_GET_ALL)?f.SIZE_GET_MAX:window.siyuan.config.editor.dynamicLoadBlocks},a=>{Qe({data:a,protyle:this.protyle,action:t.action,afterCB:()=>{this.afterOnGet(t)}})})}afterOnGet(t){this.protyle.model,Qa(this.protyle),this.protyle.wysiwyg.element.addEventListener("focusin",()=>{}),t.after&&t.after(this),this.protyle.contentElement.classList.add("protyle-content--transition")}init(){this.protyle.lute=xg({emojiSite:this.protyle.options.hint.emojiPath,emojis:this.protyle.options.hint.emoji,headingAnchor:!1,listStyle:this.protyle.options.preview.markdown.listStyle,paragraphBeginningSpace:this.protyle.options.preview.markdown.paragraphBeginningSpace,sanitize:this.protyle.options.preview.markdown.sanitize}),this.protyle.preview=new Cg(this.protyle),cg(this.protyle)}focus(){this.protyle.wysiwyg.element.focus()}isUploading(){return this.protyle.upload.isUploading}clearStack(){this.protyle.undo.clear()}destroy(){nc(this.protyle)}resize(){Qa(this.protyle)}reload(t){Un(this.protyle,t)}insert(t,n=!1,a=!1){Xe(t,this.protyle,n,a)}transaction(t,n){q(this.protyle,t,n)}turnIntoOneTransaction(t,n,a){Kt({protyle:this.protyle,selectsElement:t,type:n,level:a})}turnIntoTransaction(t,n,a){xn({protyle:this.protyle,nodeElement:t,type:n,level:a})}updateTransaction(t,n,a){K(this.protyle,t,n,a)}updateBatchTransaction(t,n){ra(t,this.protyle,n)}getRange(t){return ye(t)}hasClosestBlock(t){return B(t)}focusBlock(t,n=!0){return ne(t,void 0,n)}disable(){pn(this.protyle)}enable(){Ls(this.protyle)}renderAVAttribute(t,n,a){ql(t,n,this.protyle,a)}}const Dt=()=>window.siyuan.mobile.popEditor||window.siyuan.mobile.editor,at=(e,t,n=[f.CB_GET_HL])=>{window.siyuan.storage[f.LOCAL_DOCINFO]={id:t},Ae(f.LOCAL_DOCINFO,window.siyuan.storage[f.LOCAL_DOCINFO]);const a=document.querySelector(".av__panel");if(a&&!a.classList.contains("fn__none")&&a.dispatchEvent(new CustomEvent("click",{detail:"close"})),window.siyuan.mobile.editor){Pi(window.siyuan.mobile.editor.protyle),J(["toolbar","hint","util"],window.siyuan.mobile.editor.protyle),window.siyuan.mobile.editor.protyle.contentElement.classList.contains("fn__none")&&Hi(window.siyuan.mobile.editor.protyle,"wysiwyg");let s;if(Array.from(window.siyuan.mobile.editor.protyle.wysiwyg.element.querySelectorAll(`[data-node-id="${t}"]`)).find(i=>{if(!re(i))return s=i,!0}),s){kl(),He(window.siyuan.mobile.editor.protyle,s,!0),Ve();return}}A("/api/block/getBlockInfo",{id:t},s=>{if(s.code===3){ae(s.msg);return}const i={blockId:t,rootId:s.data.rootID,action:n,render:{scroll:!0,title:!0,background:!0,gutter:!0},typewriterMode:!0,preview:{actions:["mp-wechat","zhihu","yuque"]}};window.siyuan.mobile.editor?(window.siyuan.mobile.editor.protyle.title.element.removeAttribute("data-render"),kl(),ei(window.siyuan.mobile.editor.protyle),window.siyuan.mobile.editor.protyle.block.rootID!==s.data.rootID&&(window.siyuan.mobile.editor.protyle.wysiwyg.element.innerHTML=""),n.includes(f.CB_GET_SCROLL)&&window.siyuan.storage[f.LOCAL_FILEPOSITION][s.data.rootID]?Gl({protyle:window.siyuan.mobile.editor.protyle,scrollAttr:window.siyuan.storage[f.LOCAL_FILEPOSITION][s.data.rootID],mergedOptions:i,cb(){e.plugins.forEach(l=>{l.eventBus.emit("switch-protyle",{protyle:window.siyuan.mobile.editor.protyle})})}}):A("/api/filetree/getDoc",{id:t,size:n.includes(f.CB_GET_ALL)?f.SIZE_GET_MAX:window.siyuan.config.editor.dynamicLoadBlocks,mode:n.includes(f.CB_GET_CONTEXT)?3:0},l=>{Qe({data:l,protyle:window.siyuan.mobile.editor.protyle,action:n,afterCB(){e.plugins.forEach(o=>{o.eventBus.emit("switch-protyle",{protyle:window.siyuan.mobile.editor.protyle})})}})}),window.siyuan.mobile.editor.protyle.undo.clear()):window.siyuan.mobile.editor=new Yn(e,document.getElementById("editor"),i),pg(),Ve()})};class ip{constructor(t){this.element=t.element,this.data=t.data,this.type=t.type,this.init=t.init,this.destroy=t.destroy,this.update=t.update,this.init(this)}}class Cd{constructor(t){this.editors=[],this.id=na(),this.targetElement=t.targetElement,this.refDefs=t.refDefs,this.app=t.app,this.x=t.x,this.y=t.y,this.isBacklink=t.isBacklink,this.originalRefBlockIDs=t.originalRefBlockIDs,this.element=document.createElement("div"),this.element.classList.add("block__popover");const n=$(this.targetElement,"block__popover",!0);let a=1;n?(this.element.setAttribute("data-oid",n.getAttribute("data-oid")),a=parseInt(n.getAttribute("data-level"))+1):this.element.setAttribute("data-oid",this.refDefs[0].refID),this.element.setAttribute("data-level",a.toString());for(let s=0;s<window.siyuan.blockPanels.length;s++){const i=window.siyuan.blockPanels[s];i.element.getAttribute("data-pin")==="false"&&i.targetElement&&parseInt(i.element.getAttribute("data-level"))>=a&&(i.destroy(),s--)}document.body.insertAdjacentElement("beforeend",this.element),this.targetElement&&(this.targetElement.style.cursor="wait"),this.element.setAttribute("data-pin","false"),this.element.addEventListener("dblclick",s=>{const i=s.target,l=$(i,"block__icons");if(l){const o=l.querySelector('[data-type="pin"]');this.element.getAttribute("data-pin")==="true"?(o.setAttribute("aria-label",window.siyuan.languages.pin),o.querySelector("use").setAttribute("xlink:href","#iconPin"),this.element.setAttribute("data-pin","false")):(o.setAttribute("aria-label",window.siyuan.languages.unpin),o.querySelector("use").setAttribute("xlink:href","#iconUnpin"),this.element.setAttribute("data-pin","true")),s.preventDefault(),s.stopPropagation()}}),this.element.addEventListener("click",s=>{this.element&&window.siyuan.blockPanels.length>1&&(this.element.style.zIndex=(++window.siyuan.zIndex).toString());let i=s.target;for(;i&&!i.isEqualNode(this.element);){if(i.classList.contains("block__icon")||i.classList.contains("block__logo")){const l=i.getAttribute("data-type");l==="close"?this.destroy():l==="pin"?this.element.getAttribute("data-pin")==="true"?(i.setAttribute("aria-label",window.siyuan.languages.pin),i.querySelector("use").setAttribute("xlink:href","#iconPin"),this.element.setAttribute("data-pin","false")):(i.setAttribute("aria-label",window.siyuan.languages.unpin),i.querySelector("use").setAttribute("xlink:href","#iconUnpin"),this.element.setAttribute("data-pin","true")):l==="open"||l==="stickTab"&&(Mn(this.refDefs[0].refID,(o,r)=>{openFileById({app:t.app,id:this.refDefs[0].refID,action:r,zoomIn:o,openNewTab:!0})}),this.destroy()),s.preventDefault(),s.stopPropagation();break}i=i.parentElement}}),this.render()}initProtyle(t,n){const a=parseInt(t.getAttribute("data-index"));A("/api/block/getBlockInfo",{id:this.refDefs[a].refID},s=>{if(s.code===3){ae(s.msg);return}if(!this.targetElement&&typeof this.x=="undefined"&&typeof this.y=="undefined")return;const i=[];s.data.rootID!==this.refDefs[a].refID?i.push(f.CB_GET_ALL):i.push(f.CB_GET_CONTEXT),this.isBacklink&&i.push(f.CB_GET_BACKLINK);const l=new Yn(this.app,t,{blockId:this.refDefs[a].refID,defIds:this.refDefs[a].defIDs||[],originalRefBlockIDs:this.isBacklink?this.originalRefBlockIDs:void 0,action:i,render:{scroll:!0,gutter:!0,breadcrumbDocName:!0},typewriterMode:!1,after:o=>{s.data.rootID!==this.refDefs[a].refID&&o.protyle.breadcrumb.element.parentElement.lastElementChild.classList.remove("fn__none"),n&&n(),(o.protyle.element.nextElementSibling||o.protyle.element.previousElementSibling)&&(o.protyle.element.style.minHeight=Math.min(30+o.protyle.wysiwyg.element.clientHeight,window.innerHeight/3)+"px"),o.protyle.scroll.element.parentElement.setAttribute("style",`--b3-dynamicscroll-width:${Math.min(o.protyle.contentElement.clientHeight-49,200)}px;`)}});this.editors.push(l)})}destroy(){var t,n;(t=this.observerResize)==null||t.disconnect(),(n=this.observerLoad)==null||n.disconnect(),window.siyuan.blockPanels.find((i,l)=>{if(i.id===this.id)return window.siyuan.blockPanels.splice(l,1),!0}),this.editors.length>0&&(this.editors.forEach(i=>{J(["util"],i.protyle),i.destroy()}),this.editors=[]);const a=parseInt(this.element.dataset.level);this.element.remove(),this.element=void 0,this.targetElement=void 0;const s=parseInt(window.siyuan.menus.menu.element.dataset.from);window.siyuan.menus.menu.element.dataset.from!=="app"&&s&&s>=a&&window.siyuan.menus.menu.remove()}render(){if(!document.body.contains(this.element)){this.destroy();return}let t="";this.refDefs.length===1&&(t=`<span data-type="stickTab" class="block__icon block__icon--show b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.openInNewTab} ${Me(window.siyuan.config.keymap.editor.general.openInNewTab.custom)}"><svg><use xlink:href="#iconOpen"></use></svg></span>
<span class="fn__space"></span>`);let n=`<div class="block__icons block__icons--menu">
    <span class="fn__space fn__flex-1 resize__move"></span>${t}
    <span data-type="pin" class="block__icon block__icon--show b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.pin}"><svg><use xlink:href="#iconPin"></use></svg></span>
    <span class="fn__space"></span>
    <span data-type="close" class="block__icon block__icon--show b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.close}"><svg style="width: 12px;margin: 0 1px;"><use xlink:href="#iconClose"></use></svg></span>
</div>
<div class="block__content">`;this.refDefs.length===0?n+=`<div class="ft__smaller ft__smaller ft__secondary b3-form__space--small" contenteditable="false">${window.siyuan.languages.refExpired}</div>`:this.refDefs.forEach((s,i)=>{n+=`<div class="block__edit fn__flex-1 protyle" data-index="${i}"></div>`}),n&&(n+='</div><div class="resize__rd"></div><div class="resize__ld"></div><div class="resize__lt"></div><div class="resize__rt"></div><div class="resize__r"></div><div class="resize__d"></div><div class="resize__t"></div><div class="resize__l"></div>'),this.element.innerHTML=n;let a;this.observerResize=new ResizeObserver(()=>{clearTimeout(a),a=window.setTimeout(()=>{this.editors.forEach(s=>{Qa(s.protyle)})},f.TIMEOUT_TRANSITION)}),this.observerResize.observe(this.element),this.observerLoad=new IntersectionObserver(s=>{s.forEach(i=>{i.isIntersecting&&i.target.innerHTML===""&&this.initProtyle(i.target)})},{threshold:0}),this.element.querySelectorAll(".block__edit").forEach((s,i)=>{i<5?this.initProtyle(s,i===0?()=>{if(!document.contains(this.element))return;let l;if(this.targetElement&&this.targetElement.classList.contains("protyle-wysiwyg__embed")){l=this.targetElement.getBoundingClientRect();let r=l.top;const c=$(this.targetElement,"protyle-content",!0);if(c){const d=c.getBoundingClientRect().top;l.top<d&&(r=d)}this.element.style.height=Math.min(window.innerHeight-f.SIZE_TOOLBAR_HEIGHT,l.height+42)+"px",ke(this.element,l.left,Math.max(r-42,f.SIZE_TOOLBAR_HEIGHT),-42,0)}else this.targetElement?(this.targetElement.classList.contains("pdf__rect")?l=this.targetElement.firstElementChild.getBoundingClientRect():l=this.targetElement.getBoundingClientRect(),window.innerHeight-l.bottom-4>l.top+12&&(this.element.style.maxHeight=Math.floor(window.innerHeight-l.bottom-12)+"px"),ke(this.element,l.left,l.bottom+4,l.height+12,8)):typeof this.x=="number"&&typeof this.y=="number"&&(ke(this.element,this.x,this.y),this.element.style.maxHeight=Math.floor(window.innerHeight-Math.max(this.y,f.SIZE_TOOLBAR_HEIGHT)-12)+"px");const o=this.element.getBoundingClientRect();this.targetElement&&!this.targetElement.classList.contains("protyle-wysiwyg__embed")&&(o.top<l.top?this.element.style.maxHeight=Math.floor(l.top-o.top-8)+"px":this.element.style.maxHeight=Math.floor(window.innerHeight-o.top-8)+"px"),this.element.classList.add("block__popover--open"),this.element.style.zIndex=(++window.siyuan.zIndex).toString()}:void 0):this.observerLoad.observe(s)}),this.targetElement&&(this.targetElement.style.cursor=""),this.element.querySelector(".block__content").addEventListener("scroll",()=>{this.editors.forEach(s=>{J(["gutter"],s.protyle)})})}}var sp=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{o(n.next(r))}catch(c){s(c)}},l=r=>{try{o(n.throw(r))}catch(c){s(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,l);o((n=n.apply(e,t)).next())});class Td{constructor(t){this.data={},this.protyleSlash=[],this.customBlockRenders={},this.topBarIcons=[],this.statusBarIcons=[],this.commands=[],this.models={},this.docks={},this.addFloatLayer=n=>{window.siyuan.blockPanels.push(new Cd({app:this.app,targetElement:n.targetElement,isBacklink:n.isBacklink,x:n.x,y:n.y,refDefs:n.refDefs}))},this.app=t.app,this.i18n=t.i18n,this.displayName=t.displayName,this.eventBus=new Cu(t.name),Object.defineProperty(this,"name",{value:t.name,writable:!1}),this.updateProtyleToolbar([]).forEach(n=>{typeof n=="string"||f.INLINE_TYPE.concat("|").includes(n.name)||!n.hotkey||(window.siyuan.config.keymap.plugin||(window.siyuan.config.keymap.plugin={}),window.siyuan.config.keymap.plugin[t.name]||(window.siyuan.config.keymap.plugin[t.name]={[n.name]:{default:n.hotkey,custom:n.hotkey}}),window.siyuan.config.keymap.plugin[t.name][n.name]||(window.siyuan.config.keymap.plugin[t.name][n.name]={default:n.hotkey,custom:n.hotkey}))})}onload(){}onunload(){}uninstall(){}updateCards(t){return sp(this,null,function*(){return t})}onLayoutReady(){}addCommand(t){window.siyuan.config.keymap.plugin||(window.siyuan.config.keymap.plugin={}),window.siyuan.config.keymap.plugin[this.name]?window.siyuan.config.keymap.plugin[this.name][t.langKey]?window.siyuan.config.keymap.plugin[this.name][t.langKey]&&(typeof window.siyuan.config.keymap.plugin[this.name][t.langKey].custom=="string"?t.customHotkey=window.siyuan.config.keymap.plugin[this.name][t.langKey].custom:t.customHotkey=t.hotkey,window.siyuan.config.keymap.plugin[this.name][t.langKey].default=t.hotkey):(t.customHotkey=t.hotkey,window.siyuan.config.keymap.plugin[this.name][t.langKey]={default:t.hotkey,custom:t.hotkey}):(t.customHotkey=t.hotkey,window.siyuan.config.keymap.plugin[this.name]={[t.langKey]:{default:t.hotkey,custom:t.hotkey}}),typeof t.customHotkey!="string"?console.error(`${this.name} - commands data is error and has been removed.`):this.commands.push(t)}addIcons(t){document.body.insertAdjacentHTML("afterbegin",`<svg data-name="${this.name}" style="position: absolute; width: 0; height: 0; overflow: hidden;" xmlns="http://www.w3.org/2000/svg">
<defs>${t}</defs></svg>`)}addTopBar(t){if(!t.icon.startsWith("icon")&&!t.icon.startsWith("<svg")){console.error(`plugin ${this.name} addTopBar error: icon must be svg id or svg tag`);return}const n=document.createElement("div");return n.setAttribute("data-menu","true"),n.addEventListener("click",t.callback),n.id=`plugin_${this.name}_${this.topBarIcons.length}`,H()?(n.className="b3-menu__item",n.innerHTML=(t.icon.startsWith("icon")?`<svg class="b3-menu__icon"><use xlink:href="#${t.icon}"></use></svg>`:t.icon)+`<span class="b3-menu__label">${t.title}</span>`):ie()||(n.className="toolbar__item ariaLabel",n.setAttribute("aria-label",t.title),n.innerHTML=t.icon.startsWith("icon")?`<svg><use xlink:href="#${t.icon}"></use></svg>`:t.icon,n.addEventListener("click",t.callback),n.setAttribute("data-location",t.position||"right")),this.topBarIcons.push(n),n}addStatusBar(t){}openSetting(){this.setting&&this.setting.open(this.name)}loadData(t){return typeof this.data[t]=="undefined"&&(this.data[t]=""),new Promise(n=>{A("/api/file/getFile",{path:`/data/storage/petal/${this.name}/${t}`},a=>{a.code!==404&&(this.data[t]=a),n(this.data[t])})})}saveData(t,n){return new Promise(a=>{const s=`/data/storage/petal/${this.name}/${t}`;let i;typeof n=="object"?i=new File([new Blob([JSON.stringify(n)],{type:"application/json"})],s.split("/").pop()):i=new File([new Blob([n])],s.split("/").pop());const l=new FormData;l.append("path",s),l.append("file",i),l.append("isDir","false"),A("/api/file/putFile",l,o=>{this.data[t]=n,a(o)})})}removeData(t){return new Promise(n=>{this.data||(this.data={}),A("/api/file/removeFile",{path:`/data/storage/petal/${this.name}/${t}`},a=>{delete this.data[t],n(a)})})}getOpenedTab(){const t={};return Object.keys(this.models).forEach(a=>{t[a.replace(this.name,"")]=[]}),t}addTab(t){}addDock(t){const n=this.name+t.type;return typeof t.config.index=="undefined"&&(t.config.index=1e3),this.docks[n]={config:t.config,mobileModel:a=>new ip({element:a,type:n,data:t.data,init:t.init,update:t.update,destroy:t.destroy})},window.siyuan.config.keymap.plugin||(window.siyuan.config.keymap.plugin={}),t.config.hotkey&&(window.siyuan.config.keymap.plugin[this.name]?window.siyuan.config.keymap.plugin[this.name][n]?window.siyuan.config.keymap.plugin[this.name][n]&&(typeof window.siyuan.config.keymap.plugin[this.name][n].custom!="string"&&(window.siyuan.config.keymap.plugin[this.name][n].custom=t.config.hotkey),window.siyuan.config.keymap.plugin[this.name][n].default=t.config.hotkey):window.siyuan.config.keymap.plugin[this.name][n]={default:t.config.hotkey,custom:t.config.hotkey}:window.siyuan.config.keymap.plugin[this.name]={[n]:{default:t.config.hotkey,custom:t.config.hotkey}}),this.docks[n]}updateProtyleToolbar(t){return t}set protyleOptions(t){this.protyleOptionsValue=t}get protyleOptions(){return this.protyleOptionsValue}}class lp{constructor(t){this.items=[],this.confirmCallback=t.confirmCallback,this.destroyCallback=t.destroyCallback,this.width=t.width||(H()?"92vw":"768px"),this.height=t.height||"80vh"}addItem(t){this.items.push(t)}open(t){var n;const a=new we({title:t,content:`<div class="b3-dialog__content">
</div>
<div class="b3-dialog__action${this.confirmCallback?"":" fn__none"}">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button>
    <div class="fn__space${this.confirmCallback?"":" fn__none"}"></div>
    <button class="b3-button b3-button--text${this.confirmCallback?"":" fn__none"}">${window.siyuan.languages.save}</button>
</div>`,width:this.width,height:this.height,destroyCallback:()=>{this.destroyCallback&&this.destroyCallback()}}),s=a.element.querySelector(".b3-dialog__content");this.items.forEach(l=>{let o="",r=l.actionElement;!l.actionElement&&l.createActionElement&&(r=l.createActionElement());const c=r!=null&&r.classList.contains("b3-switch")?"label":"div";typeof l.direction=="undefined"&&(l.direction=!r||r.tagName==="TEXTAREA"?"row":"column"),l.direction==="row"?o=`<${c} class="b3-label">
    <div class="fn__block">
        ${l.title}
        ${l.description?`<div class="b3-label__text">${l.description}</div>`:""}
        <div class="fn__hr"></div>
    </div>
</${c}>`:o=`<${c} class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${l.title}
        ${l.description?`<div class="b3-label__text">${l.description}</div>`:""}
    </div>
    <span class="fn__space${r?"":" fn__none"}"></span>
</${c}>`,s.insertAdjacentHTML("beforeend",o),r&&(["INPUT","TEXTAREA"].includes(r.tagName)&&a.bindInput(r,()=>{i[1].dispatchEvent(new CustomEvent("click"))},r.tagName==="INPUT"),l.direction==="row"?(s.lastElementChild.lastElementChild.insertAdjacentElement("beforeend",r),r.classList.add("fn__block")):(r.classList.remove("fn__block"),r.classList.add("fn__flex-center","fn__size200"),s.lastElementChild.insertAdjacentElement("beforeend",r)))}),(n=s.querySelector("input, textarea"))==null||n.focus();const i=a.element.querySelectorAll(".b3-dialog__action .b3-button");i[0].addEventListener("click",()=>{a.destroy()}),i[1].addEventListener("click",()=>{this.confirmCallback&&this.confirmCallback(),a.destroy()}),this.dialog=a}}const wo=(e,t)=>{let n="";return e.forEach(a=>{typeof a=="string"?n+=`<option value="${a}" ${t===a?"selected":""}>${a}</option>`:n+=`<option value="${a.name}" ${t===a.name?"selected":""}>${a.label}</option>`}),n},op=(e,t)=>{let n="";return e.forEach(a=>{n+=`<option value="${a.name}" ${t===a.name?"selected":""}>${a.label} (${a.name})</option>`}),n},rp=()=>{sn({title:window.siyuan.languages.appearance,icon:"iconTheme",html:`<div class="b3-label">
    ${window.siyuan.languages.appearance4}
    <div class="fn__hr"></div>
    <select class="b3-select fn__block" id="mode">
      <option value="0" ${window.siyuan.config.appearance.mode===0&&!window.siyuan.config.appearance.modeOS?"selected":""}>${window.siyuan.languages.themeLight}</option>
      <option value="1" ${window.siyuan.config.appearance.mode===1&&!window.siyuan.config.appearance.modeOS?"selected":""}>${window.siyuan.languages.themeDark}</option>
      <option value="2" ${window.siyuan.config.appearance.modeOS?"selected":""}>${window.siyuan.languages.themeOS}</option>
    </select>
    <div class="b3-label__text">${window.siyuan.languages.appearance5}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.theme}
    <div class="fn__hr"></div>
    <select class="b3-select fn__block" id="themeLight">
      ${wo(window.siyuan.config.appearance.lightThemes,window.siyuan.config.appearance.themeLight)}
    </select>
    <div class="b3-label__text">${window.siyuan.languages.theme11}</div>
    <div class="fn__hr"></div>
    <select class="b3-select fn__block" id="themeDark">
       ${wo(window.siyuan.config.appearance.darkThemes,window.siyuan.config.appearance.themeDark)}
    </select>
    <div class="b3-label__text">${window.siyuan.languages.theme12}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.icon}
    <div class="fn__hr"></div>
    <select class="b3-select fn__block" id="icon">
        ${wo(window.siyuan.config.appearance.icons,window.siyuan.config.appearance.icon)}
    </select>
    <div class="b3-label__text">${window.siyuan.languages.theme2}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.language}
    <div class="fn__hr"></div>
    <select id="lang" class="b3-select fn__block">${op(window.siyuan.config.langs,window.siyuan.config.appearance.lang)}</select>
    <div class="b3-label__text">${window.siyuan.languages.language1}</div>
</div>`,bindEvent(e){e.querySelectorAll("select").forEach(t=>{t.addEventListener("change",()=>{const n=parseInt(e.querySelector("#mode").value);A("/api/setting/setAppearance",Object.assign({},window.siyuan.config.appearance,{icon:e.querySelector("#icon").value,mode:n===2?window.siyuan.config.appearance.mode:n,modeOS:n===2,themeDark:e.querySelector("#themeDark").value,themeLight:e.querySelector("#themeLight").value,lang:e.querySelector("#lang").value}),()=>{window.location.reload()})})})}})},cp=e=>{const t=new we({title:window.siyuan.languages.cloudSyncDir,content:`<div class="b3-dialog__content">
    <input class="b3-text-field fn__block" value="main">
    <div class="b3-label__text">${window.siyuan.languages.reposTip}</div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:H()?"92vw":"520px"});t.element.setAttribute("data-key",f.DIALOG_SYNCADDCLOUDDIR);const n=t.element.querySelector("input"),a=t.element.querySelectorAll(".b3-button");t.bindInput(n,()=>{a[1].click()}),n.focus(),n.select(),a[0].addEventListener("click",()=>{t.destroy()}),a[1].addEventListener("click",()=>{e.innerHTML='<img style="margin: 0 auto;display: block;width: 64px;height: 100%" src="/stage/loading-pure.svg">',A("/api/sync/createCloudSyncDir",{name:n.value},()=>{t.destroy(),Wi(e,!0)})})},$d=(e,t)=>{e.addEventListener("click",n=>{let a=n.target;for(;a&&!a.isEqualNode(e);){const s=a.getAttribute("data-type");if(s){switch(s){case"addCloud":cp(e);break;case"removeCloud":$e(window.siyuan.languages.deleteOpConfirm,`${window.siyuan.languages.confirmDeleteCloudDir} <i>${a.parentElement.getAttribute("data-name")}</i>`,()=>{e.innerHTML='<img style="margin: 0 auto;display: block;width: 64px;height: 100%" src="/stage/loading-pure.svg">',A("/api/sync/removeCloudSyncDir",{name:a.parentElement.getAttribute("data-name")},i=>{window.siyuan.config.sync.cloudName=i.data,Wi(e,!0,t)})},void 0,!0);break;case"selectCloud":e.innerHTML='<img style="margin: 0 auto;display: block;width: 64px;height: 100%" src="/stage/loading-pure.svg">',A("/api/sync/setCloudSyncDir",{name:a.getAttribute("data-name")},()=>{window.siyuan.config.sync.cloudName=a.getAttribute("data-name"),Wi(e,!0,t)});break}n.preventDefault(),n.stopPropagation();break}a=a.parentElement}})},Wi=(e,t=!1,n)=>{!t&&e.firstElementChild.tagName!=="IMG"||A("/api/sync/listCloudSyncDir",{},a=>{let s=`<ul><li style="padding: 0 16px" class="b3-list--empty">${window.siyuan.languages.emptyCloudSyncList}</li></ul>`;a.code===1?s=`<ul>
    <li class="b3-list--empty ft__error">
        ${a.msg}
    </li>
    <li class="b3-list--empty">
        ${window.siyuan.languages.cloudConfigTip}
    </li>
</ul>`:a.code!==1&&(s='<ul class="b3-list b3-list--background fn__flex-1" style="overflow: auto;">',a.data.syncDirs.forEach(i=>{s+=`<li data-type="selectCloud" data-name="${i.cloudName}" class="b3-list-item b3-list-item--two">
    <div class="b3-list-item__first" data-name="${i.cloudName}">
        <input type="radio" name="cloudName"${i.cloudName===a.data.checkedSyncDir?" checked":""}/>
        <span class="fn__space"></span>
        <span>${i.cloudName}</span>
        <span class="fn__flex-1 fn__space"></span>
        <span data-type="removeCloud" class="b3-list-item__action">
            <svg><use xlink:href="#iconTrashcan"></use></svg>
        </span>
    </div>
    <div class="b3-list-item__meta fn__flex">
        <span>${i.hSize}</span>
        <span class="fn__flex-1 fn__space"></span>
        <span>${i.updated}</span>
    </div>
</li>`}),s+=`</ul>
<div class="fn__hr"></div>
<div class="fn__flex">
    <div class="fn__flex-1"></div>
    <button class="b3-button b3-button--outline${window.siyuan.config.sync.provider===2||window.siyuan.config.sync.provider===3?" fn__none":""}" data-type="addCloud"><svg><use xlink:href="#iconAdd"></use></svg>${window.siyuan.languages.addAttr}</button>
</div>`),e.innerHTML=s,n&&n()})},ho=e=>{if(!window.siyuan.config.readonly){if(window.siyuan.config.sync.provider===0){if(Vn())return}else if(!zn()){ae(window.siyuan.languages._kernel[214]);return}if(!window.siyuan.config.repo.key){Dd(!0);return}if(!window.siyuan.config.sync.enabled){Id();return}_o()}},_o=()=>{if(window.siyuan.config.sync.mode!==3){A("/api/sync/performSync",{});return}const e=new we({title:window.siyuan.languages.chooseSyncDirection,content:`<div class="b3-dialog__content">
    <label class="fn__flex b3-label">
        <input type="radio" name="upload" value="true">
        <span class="fn__space"></span>
        <div>
            ${window.siyuan.languages.uploadData2Cloud}
            <div class="b3-label__text">${window.siyuan.languages.uploadData2CloudTip}</div>
        </div>
    </label>
    <label class="fn__flex b3-label">
        <input type="radio" name="upload" value="false">
        <span class="fn__space"></span>
        <div>
            ${window.siyuan.languages.downloadDataFromCloud}
            <div class="b3-label__text">${window.siyuan.languages.downloadDataFromCloudTip}</div>
        </div>
    </label>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:H()?"92vw":"520px"});e.element.setAttribute("data-key",f.DIALOG_SYNCCHOOSEDIRECTION);const t=e.element.querySelectorAll(".b3-button");t[0].addEventListener("click",()=>{e.destroy()}),t[1].addEventListener("click",()=>{const n=e.element.querySelector("input[name=upload]:checked");if(!n){ae(window.siyuan.languages.plsChoose);return}A("/api/sync/performSync",{upload:n.value==="true"}),e.destroy()})},Id=(e,t)=>{if(e&&(window.siyuan.config.repo.key=e),window.siyuan.config.sync.enabled)t&&t.destroy(),$e("\u{1F504} "+window.siyuan.languages.syncConfGuide4,window.siyuan.languages.syncConfGuide5,()=>{_o()});else{const n=`<div class="b3-dialog__content">
    <div class="ft__on-surface">${window.siyuan.languages.syncConfGuide3}</div>
    <div class="fn__hr--b"></div>
    <div style="display: flex;flex-direction: column;height: 40vh;">
        <img style="margin: 0 auto;display: block;width: 64px;height: 100%" src="/stage/loading-pure.svg">
    </div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button" disabled="disabled">${window.siyuan.languages.openSyncTip1}</button>
</div>`;t?(t.element.querySelector(".b3-dialog__header").innerHTML="\u{1F5C2}\uFE0F "+window.siyuan.languages.cloudSyncDir,t.element.querySelector(".b3-dialog__body").innerHTML=n):t=new we({title:"\u{1F5C2}\uFE0F "+window.siyuan.languages.cloudSyncDir,content:n,width:H()?"92vw":"520px"}),t.element.setAttribute("data-key",f.DIALOG_SYNCCHOOSEDIR);const a=t.element.querySelector(".b3-dialog__content").lastElementChild,s=t.element.querySelector(".b3-button");$d(a,()=>{a.querySelector("input[checked]")?s.removeAttribute("disabled"):s.setAttribute("disabled","disabled")}),Wi(a,!1,()=>{a.querySelector("input[checked]")?s.removeAttribute("disabled"):s.setAttribute("disabled","disabled")}),s.addEventListener("click",()=>{t.destroy(),A("/api/sync/setSyncEnable",{enabled:!0},()=>{window.siyuan.config.sync.enabled=!0,Cn(),$e("\u{1F504} "+window.siyuan.languages.syncConfGuide4,window.siyuan.languages.syncConfGuide5,()=>{_o()})})})}},Dd=(e,t)=>{const n=new we({title:"\u{1F511} "+window.siyuan.languages.syncConfGuide1,content:`<div class="b3-dialog__content ft__center">
    <img style="width: 260px" src="/stage/images/sync-guide.svg"/>
    <div class="fn__hr--b"></div>
    <div class="ft__on-surface">${window.siyuan.languages.syncConfGuide2}</div>
    <div class="fn__hr--b"></div>
    <input class="b3-text-field fn__block ft__center" placeholder="${window.siyuan.languages.passphrase}">
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__block ft__center" placeholder="${window.siyuan.languages.reEnterPassphrase}">
</div>
<div class="b3-dialog__action">
    <label class="fn__flex">
        <input type="checkbox" class="b3-switch fn__flex-center">
        <span class="fn__space"></span>
        ${window.siyuan.languages.confirmPassword}
    </label>
    <span class="fn__flex-1"></span>
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button>
    <span class="fn__space"></span>
    <button class="b3-button b3-button--text" id="initKeyByPW" disabled>
        ${window.siyuan.languages.confirm}
    </button>
</div>`,width:H()?"92vw":"520px"});n.element.setAttribute("data-key",f.DIALOG_SETPASSWORD),n.element.querySelector(".b3-button--cancel").addEventListener("click",()=>{n.destroy()});const a=n.element.querySelector("#initKeyByPW");n.element.querySelector(".b3-switch").addEventListener("change",function(){this.checked?a.removeAttribute("disabled"):a.setAttribute("disabled","disabled")});const s=n.element.querySelectorAll(".b3-text-field");a.addEventListener("click",()=>{if(!s[0].value||!s[1].value){ae(window.siyuan.languages._kernel[142]);return}if(s[0].value!==s[1].value){ae(window.siyuan.languages.passwordNoMatch);return}$e("\u{1F511} "+window.siyuan.languages.genKeyByPW,window.siyuan.languages.initRepoKeyTip,()=>{e||n.destroy(),A("/api/repo/initRepoKeyFromPassphrase",{pass:s[0].value},i=>{window.siyuan.config.repo.key=i.data.key,t&&t(),e&&Id(i.data.key,n)})})}),s[0].focus()},vo=e=>e===0?Vn("")?`<div class="b3-label b3-label--inner">${window.siyuan.config.system.container==="ios"?window.siyuan.languages._kernel[122]:window.siyuan.languages._kernel[29].replace("${url}",Pt("subscribe/siyuan"))}</div>
<div class="b3-label b3-label--inner">
    ${window.siyuan.languages.cloudIntro1}
    <div class="b3-label__text">
        <ul class="fn__list">
            <li>${window.siyuan.languages.cloudIntro2}</li>
            <li>${window.siyuan.languages.cloudIntro3}</li>
            <li>${window.siyuan.languages.cloudIntro4}</li>
            <li>${window.siyuan.languages.cloudIntro5}</li>
            <li>${window.siyuan.languages.cloudIntro6}</li>
            <li>${window.siyuan.languages.cloudIntro7}</li>
            <li>${window.siyuan.languages.cloudIntro8}</li>
        </ul>
    </div>
</div>
<div class="b3-label b3-label--inner">
    ${window.siyuan.languages.cloudIntro9}
    <div class="b3-label__text">
        <ul style="padding-left: 2em">
            <li>${window.siyuan.languages.cloudIntro10}</li>
            <li>${window.siyuan.languages.cloudIntro11}</li>
        </ul>
    </div>
</div>`:`<div class="b3-label b3-label--inner">
    ${window.siyuan.languages.syncOfficialProviderIntro}
</div>`:zn()?e===2?`<div class="b3-label b3-label--inner">
    ${window.siyuan.languages.syncThirdPartyProviderS3Intro}
    <div class="fn__hr"></div>
    <em>${window.siyuan.languages.proFeature}</em>
    <div class="fn__hr"></div>
    ${window.siyuan.languages.syncThirdPartyProviderTip}
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Endpoint</div>
    <div class="fn__space"></div>
    <input id="endpoint" class="b3-text-field fn__block" value="${window.siyuan.config.sync.s3.endpoint}">
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Access Key</div>
    <div class="fn__space"></div>
    <input id="accessKey" class="b3-text-field fn__block" value="${window.siyuan.config.sync.s3.accessKey}">
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Secret Key</div>
    <div class="fn__space"></div>
    <div class="b3-form__icona fn__block">
        <input id="secretKey" type="password" class="b3-text-field b3-form__icona-input" value="${window.siyuan.config.sync.s3.secretKey}">
        <svg class="b3-form__icona-icon" data-action="togglePassword"><use xlink:href="#iconEye"></use></svg>
    </div>
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Bucket</div>
    <div class="fn__space"></div>
    <input id="bucket" class="b3-text-field fn__block" value="${window.siyuan.config.sync.s3.bucket}">
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Region ID</div>
    <div class="fn__space"></div>
    <input id="region" class="b3-text-field fn__block" value="${window.siyuan.config.sync.s3.region}">
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Timeout (s)</div>
    <div class="fn__space"></div>
    <input id="timeout" class="b3-text-field fn__block" type="number" min="7" max="300" value="${window.siyuan.config.sync.s3.timeout}">
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Addressing</div>
    <div class="fn__space"></div>
    <select class="b3-select fn__block" id="pathStyle">
        <option ${window.siyuan.config.sync.s3.pathStyle?"selected":""} value="true">Path-style</option>
        <option ${window.siyuan.config.sync.s3.pathStyle?"":"selected"} value="false">Virtual-hosted-style</option>
    </select>
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">TLS Verify</div>
    <div class="fn__space"></div>
    <select class="b3-select fn__block" id="s3SkipTlsVerify">
        <option ${window.siyuan.config.sync.s3.skipTlsVerify?"":"selected"} value="false">Verify</option>
        <option ${window.siyuan.config.sync.s3.skipTlsVerify?"selected":""} value="true">Skip</option>
    </select>
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Concurrent Reqs</div>
    <div class="fn__space"></div>
    <input id="s3ConcurrentReqs" class="b3-text-field fn__block" type="number" min="1" max="16" value="${window.siyuan.config.sync.s3.concurrentReqs}">
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-1"></div>
    <button class="b3-button b3-button--outline fn__size200" data-action="purgeData">
        <svg><use xlink:href="#iconTrashcan"></use></svg>${window.siyuan.languages.purge}
    </button>
    <div class="fn__space"></div>
    <button class="b3-button b3-button--outline fn__size200" style="position: relative">
        <input id="importData" class="b3-form__upload" type="file" data-type="s3">
        <svg><use xlink:href="#iconDownload"></use></svg>${window.siyuan.languages.import}
    </button>
    <div class="fn__space"></div>
    <button class="b3-button b3-button--outline fn__size200" data-action="exportData" data-type="s3">
        <svg><use xlink:href="#iconUpload"></use></svg>${window.siyuan.languages.export}
    </button>
</div>`:e===3?`<div class="b3-label b3-label--inner">
    ${window.siyuan.languages.syncThirdPartyProviderWebDAVIntro}
    <div class="fn__hr"></div>
    <em>${window.siyuan.languages.proFeature}</em>
    <div class="fn__hr"></div>
    ${window.siyuan.languages.syncThirdPartyProviderTip}
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Endpoint</div>
    <div class="fn__space"></div>
    <input id="endpoint" class="b3-text-field fn__block" value="${window.siyuan.config.sync.webdav.endpoint}">
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Username</div>
    <div class="fn__space"></div>
    <input id="username" class="b3-text-field fn__block" value="${window.siyuan.config.sync.webdav.username}">
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Password</div>
    <div class="fn__space"></div>
    <div class="b3-form__icona fn__block">
        <input id="password" type="password" class="b3-text-field b3-form__icona-input" value="${window.siyuan.config.sync.webdav.password}">
        <svg class="b3-form__icona-icon" data-action="togglePassword"><use xlink:href="#iconEye"></use></svg>
    </div>
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Timeout (s)</div>
    <div class="fn__space"></div>
    <input id="timeout" class="b3-text-field fn__block" type="number" min="7" max="300" value="${window.siyuan.config.sync.webdav.timeout}">
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">TLS Verify</div>
    <div class="fn__space"></div>
    <select class="b3-select fn__block" id="webdavSkipTlsVerify">
        <option ${window.siyuan.config.sync.webdav.skipTlsVerify?"":"selected"} value="false">Verify</option>
        <option ${window.siyuan.config.sync.webdav.skipTlsVerify?"selected":""} value="true">Skip</option>
    </select>
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Concurrent Reqs</div>
    <div class="fn__space"></div>
    <input id="webdavConcurrentReqs" class="b3-text-field fn__block" type="number" min="1" max="16" value="${window.siyuan.config.sync.webdav.concurrentReqs}">
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-1"></div>
    <button class="b3-button b3-button--outline fn__size200" data-action="purgeData">
        <svg><use xlink:href="#iconTrashcan"></use></svg>${window.siyuan.languages.purge}
    </button>
    <div class="fn__space"></div>
    <button class="b3-button b3-button--outline fn__size200" style="position: relative">
        <input id="importData" class="b3-form__upload" type="file" data-type="webdav">
        <svg><use xlink:href="#iconDownload"></use></svg>${window.siyuan.languages.import}
    </button>
    <div class="fn__space"></div>
    <button class="b3-button b3-button--outline fn__size200" data-action="exportData" data-type="webdav">
        <svg><use xlink:href="#iconUpload"></use></svg>${window.siyuan.languages.export}
    </button>
</div>`:e===4?G()?`<div class="b3-label b3-label--inner">
    ${window.siyuan.languages.syncThirdPartyProviderLocalIntro}
    <div class="fn__hr"></div>
    <em>${window.siyuan.languages.proFeature}</em>
    <div class="fn__hr"></div>
    ${window.siyuan.languages.deviceNotSupport}
</div>`:`<div class="b3-label b3-label--inner">
    ${window.siyuan.languages.syncThirdPartyProviderLocalIntro}
    <div class="fn__hr"></div>
    <em>${window.siyuan.languages.proFeature}</em>
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Endpoint</div>
    <div class="fn__space"></div>
    <input id="endpoint" class="b3-text-field fn__block" value="${window.siyuan.config.sync.local.endpoint}">
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Timeout (s)</div>
    <div class="fn__space"></div>
    <input id="timeout" class="b3-text-field fn__block" type="number" min="7" max="300" value="${window.siyuan.config.sync.local.timeout}">
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Concurrent Reqs</div>
    <div class="fn__space"></div>
    <input id="localConcurrentReqs" class="b3-text-field fn__block" type="number" min="1" max="1024" value="${window.siyuan.config.sync.local.concurrentReqs}">
</div>`:"":`<div class="b3-label b3-label--inner">${window.siyuan.languages._kernel[214]}</div>`,ko=()=>{const e=gt.element.querySelector("#importData");e&&e.addEventListener("change",()=>{const i=new FormData;i.append("file",e.files[0]);const l=e.getAttribute("data-type")==="s3";A(l?"/api/sync/importSyncProviderS3":"/api/sync/importSyncProviderWebDAV",i,o=>{l?window.siyuan.config.sync.s3=o.data.s3:window.siyuan.config.sync.webdav=o.data.webdav,gt.element.querySelector("#syncProviderPanel").innerHTML=vo(window.siyuan.config.sync.provider),ko(),ae(window.siyuan.languages.imported),e.value=""})});const t=gt.element.querySelector("#reposData"),n=gt.element.querySelector("#reposLoading");if(window.siyuan.config.sync.provider===0){if(Vn("")){n.classList.add("fn__none");let i=t;for(;i;)i.classList.add("fn__none"),i=i.nextElementSibling;return}A("/api/cloud/getCloudSpace",{},i=>{if(n.classList.add("fn__none"),i.code===1){t.innerHTML=i.msg;return}else t.innerHTML=`<div class="fn__flex">
    <div class="fn__flex-1">
        ${window.siyuan.languages.cloudStorage}
        <div class="fn__hr"></div>
        <ul class="b3-list" style="margin-left: 12px">
            <li class="b3-list-item" style="cursor: auto;">${window.siyuan.languages.sync}<span class="b3-list-item__meta">${i.data.sync?i.data.sync.hSize:"0B"}</span></li>
            <li class="b3-list-item" style="cursor: auto;">${window.siyuan.languages.backup}<span class="b3-list-item__meta">${i.data.backup?i.data.backup.hSize:"0B"}</span></li>
            <li class="b3-list-item" style="cursor: auto;"><a href="${Pt("settings/file?type=3")}" target="_blank">${window.siyuan.languages.cdn}</a><span class="b3-list-item__meta">${i.data.hAssetSize}</span></li>
            <li class="b3-list-item" style="cursor: auto;">${window.siyuan.languages.total}<span class="b3-list-item__meta">${i.data.hSize}</span></li>
            <li class="b3-list-item" style="cursor: auto;">${window.siyuan.languages.sizeLimit}<span class="b3-list-item__meta">${i.data.hTotalSize}</span></li>
            <li class="b3-list-item" style="cursor: auto;"><a href="${Pt("settings/point")}" target="_blank">${window.siyuan.languages.pointExchangeSize}</a><span class="b3-list-item__meta">${i.data.hExchangeSize}</span></li>
        </ul>
    </div>
    <div class="fn__flex-1">
        ${window.siyuan.languages.trafficStat}
        <div class="fn__hr"></div>
        <ul class="b3-list" style="margin-left: 12px">
            <li class="b3-list-item" style="cursor: auto;">${window.siyuan.languages.upload}<span class="fn__space"></span><span class="ft__on-surface">${i.data.hTrafficUploadSize}</span></li>
            <li class="b3-list-item" style="cursor: auto;">${window.siyuan.languages.download}<span class="fn__space"></span><span class="ft__on-surface">${i.data.hTrafficDownloadSize}</span></li>
            <li class="b3-list-item" style="cursor: auto;">API GET<span class="fn__space"></span><span class="ft__on-surface">${i.data.hTrafficAPIGet}</span></li>
            <li class="b3-list-item" style="cursor: auto;">API PUT<span class="fn__space"></span><span class="ft__on-surface">${i.data.hTrafficAPIPut}</span></li>
        </ul>
    </div>
</div>`}),t.classList.remove("fn__none");return}n.classList.add("fn__none");let a=t.nextElementSibling;for(;a;)zn()?a.classList.remove("fn__none"):a.classList.add("fn__none"),a=a.nextElementSibling;t.classList.add("fn__none");const s=gt.element.querySelector("#syncProviderPanel");s.querySelectorAll(".b3-text-field, .b3-select").forEach(i=>{i.addEventListener("blur",()=>{if(window.siyuan.config.sync.provider===2){let l=parseInt(s.querySelector("#timeout").value,10);7>l&&(1>l?l=30:l=7),300<l&&(l=300);let o=parseInt(s.querySelector("#s3ConcurrentReqs").value,10);1>o&&(o=1),16<o&&(o=16),s.querySelector("#timeout").value=l.toString();let r=s.querySelector("#endpoint").value;r=r.trim().replace("http://http(s)://","https://"),r=r.replace("http(s)://","https://"),r.startsWith("http")||(r="http://"+r);const c={endpoint:r,accessKey:s.querySelector("#accessKey").value.trim(),secretKey:s.querySelector("#secretKey").value.trim(),bucket:s.querySelector("#bucket").value.trim(),pathStyle:s.querySelector("#pathStyle").value==="true",region:s.querySelector("#region").value.trim(),skipTlsVerify:s.querySelector("#s3SkipTlsVerify").value==="true",timeout:l,concurrentReqs:o};A("/api/sync/setSyncProviderS3",{s3:c},()=>{window.siyuan.config.sync.s3=c})}else if(window.siyuan.config.sync.provider===3){let l=parseInt(s.querySelector("#timeout").value,10);7>l&&(l=7),300<l&&(l=300);let o=parseInt(s.querySelector("#webdavConcurrentReqs").value,10);1>o&&(o=1),16<o&&(o=16),s.querySelector("#timeout").value=l.toString();let r=s.querySelector("#endpoint").value;r=r.trim().replace("http://http(s)://","https://"),r=r.replace("http(s)://","https://"),r.startsWith("http")||(r="http://"+r);const c={endpoint:r,username:s.querySelector("#username").value.trim(),password:s.querySelector("#password").value.trim(),skipTlsVerify:s.querySelector("#webdavSkipTlsVerify").value==="true",timeout:l,concurrentReqs:o};A("/api/sync/setSyncProviderWebDAV",{webdav:c},()=>{window.siyuan.config.sync.webdav=c})}else if(window.siyuan.config.sync.provider===4){let l=parseInt(s.querySelector("#timeout").value,10);7>l&&(l=7),300<l&&(l=300);let o=parseInt(s.querySelector("#localConcurrentReqs").value,10);1>o&&(o=1),1024<o&&(o=1024),s.querySelector("#timeout").value=l.toString();const r={endpoint:s.querySelector("#endpoint").value,timeout:l,concurrentReqs:o};A("/api/sync/setSyncProviderLocal",{local:r},c=>{if(c.code===0){window.siyuan.config.sync.local=c.data.local;const d=s.querySelector("#endpoint");d&&(d.value=c.data.local.endpoint)}else window.siyuan.config.sync.local=r})}})})},gt={element:void 0,genHTML:()=>`<div>
<div style="position: fixed;width: 800px;height: 434px;box-sizing: border-box;text-align: center;display: flex;align-items: center;justify-content: center;z-index: 1;" id="reposLoading">
    <img src="/stage/loading-pure.svg">
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.syncProvider}
        <div class="b3-label__text">${window.siyuan.languages.syncProviderTip}</div>
    </div>
    <span class="fn__space"></span>
    <select id="syncProvider" class="b3-select fn__flex-center fn__size200">
        <option value="0" ${window.siyuan.config.sync.provider===0?"selected":""}>SiYuan</option>
        <option value="2" ${window.siyuan.config.sync.provider===2?"selected":""}>S3</option>
        <option value="3" ${window.siyuan.config.sync.provider===3?"selected":""}>WebDAV</option>
        <option value="4" ${window.siyuan.config.sync.provider===4?"selected":""}>${window.siyuan.languages.localFlieSystem}</option>
    </select>
</div>
<div id="syncProviderPanel" class="b3-label">
    ${vo(window.siyuan.config.sync.provider)}
</div>
<div id="reposData" class="b3-label">
    <div class="fn__flex">
        <div class="fn__flex-1">
            ${window.siyuan.languages.cloudStorage}
        </div>
        <div class="fn__flex-1">
            ${window.siyuan.languages.trafficStat}
        </div>
    </div>
</div>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.openSyncTip1}
        <div class="b3-label__text">${window.siyuan.languages.openSyncTip2}</div>
    </div>
    <span class="fn__space"></span>
    <input type="checkbox" id="reposCloudSyncSwitch"${window.siyuan.config.sync.enabled?" checked='checked'":""} class="b3-switch fn__flex-center">
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.generateConflictDoc}
        <div class="b3-label__text">${window.siyuan.languages.generateConflictDocTip}</div>
    </div>
    <span class="fn__space"></span>
    <input type="checkbox" id="generateConflictDoc"${window.siyuan.config.sync.generateConflictDoc?" checked='checked'":""} class="b3-switch fn__flex-center">
</label>
<div class="b3-label">
    <div class="fn__flex config__item">
        <div class="fn__flex-1">
            ${window.siyuan.languages.syncMode}
            <div class="b3-label__text">${window.siyuan.languages.syncModeTip}</div>
        </div>
        <span class="fn__space"></span>
        <select id="syncMode" class="b3-select fn__flex-center fn__size200">
            <option value="1" ${window.siyuan.config.sync.mode===1?"selected":""}>${window.siyuan.languages.syncMode1}</option>
            <option value="2" ${window.siyuan.config.sync.mode===2?"selected":""}>${window.siyuan.languages.syncMode2}</option>
            <option value="3" ${window.siyuan.config.sync.mode===3?"selected":""}>${window.siyuan.languages.syncMode3}</option>
        </select>
    </div>
    <div class="fn__flex b3-label${window.siyuan.config.sync.mode!==1?" fn__none":""}">
        <div class="fn__flex-1">
            ${window.siyuan.languages.syncInterval}
            <div class="b3-label__text">${window.siyuan.languages.syncIntervalTip}</div>
        </div>
        <span class="fn__space"></span>
        <input type="number" min="30" max="43200" id="syncInterval" class="b3-text-field fn__flex-center" value="${window.siyuan.config.sync.interval}" >
        <span class="fn__space"></span>        
        <span class="fn__flex-center ft__on-surface">${window.siyuan.languages.second}</span> 
    </div>
    <label class="fn__flex b3-label${window.siyuan.config.sync.mode!==1||window.siyuan.config.system.container==="docker"||window.siyuan.config.sync.provider!==0?" fn__none":""}">
        <div class="fn__flex-1">
            ${window.siyuan.languages.syncPerception}
            <div class="b3-label__text">${window.siyuan.languages.syncPerceptionTip}</div>
        </div>
        <span class="fn__space"></span>
        <input type="checkbox" id="syncPerception"${window.siyuan.config.sync.perception?" checked='checked'":""} class="b3-switch fn__flex-center">
    </label>
</div>
<div class="b3-label">
    <div class="fn__flex config__item">
        <div class="fn__flex-1">
            ${window.siyuan.languages.cloudSyncDir}
            <div class="b3-label__text">${window.siyuan.languages.cloudSyncDirTip}</div>
        </div>
        <div class="fn__space"></div>
        <button class="b3-button b3-button--outline fn__flex-center fn__size200" data-action="config">
            <svg><use xlink:href="#iconSettings"></use></svg>${window.siyuan.languages.config}
        </button>
    </div>
    <div id="reposCloudSyncList" class="fn__none b3-label"><img style="margin: 0 auto;display: block;width: 64px;height: 100%" src="/stage/loading-pure.svg"></div>
</div>
<div class="b3-label fn__flex">
    <div class="fn__flex-center">${window.siyuan.languages.cloudBackup}</div>
    <div class="b3-list-item__meta fn__flex-center">${window.siyuan.languages.cloudBackupTip}</div>
</div>
</div>`,bindEvent:()=>{ko();const e=gt.element.querySelector("#reposCloudSyncSwitch");e.addEventListener("change",()=>{if(e.checked&&window.siyuan.config.sync.cloudName===""){e.checked=!1,ae(window.siyuan.languages._kernel[123]);return}A("/api/sync/setSyncEnable",{enabled:e.checked},()=>{window.siyuan.config.sync.enabled=e.checked,Cn()})});const t=gt.element.querySelector("#syncInterval");t.addEventListener("change",()=>{let r=parseInt(t.value);30>r&&(r=30),43200<r&&(r=43200),t.value=r.toString(),A("/api/sync/setSyncInterval",{interval:r},()=>{window.siyuan.config.sync.interval=r,Cn()})});const n=gt.element.querySelector("#syncPerception");n.addEventListener("change",()=>{A("/api/sync/setSyncPerception",{enabled:n.checked},()=>{window.siyuan.config.sync.perception=n.checked,Cn()})});const a=gt.element.querySelector("#generateConflictDoc");a.addEventListener("change",()=>{A("/api/sync/setSyncGenerateConflictDoc",{enabled:a.checked},()=>{window.siyuan.config.sync.generateConflictDoc=a.checked})});const s=gt.element.querySelector("#syncMode");s.addEventListener("change",()=>{A("/api/sync/setSyncMode",{mode:parseInt(s.value,10)},()=>{s.value==="1"&&window.siyuan.config.sync.provider===0&&window.siyuan.config.system.container!=="docker"?n.parentElement.classList.remove("fn__none"):n.parentElement.classList.add("fn__none"),s.value==="1"?t.parentElement.classList.remove("fn__none"):t.parentElement.classList.add("fn__none"),window.siyuan.config.sync.mode=parseInt(s.value,10)})});const i=gt.element.querySelector("#reposCloudSyncList"),l=gt.element.querySelector("#syncProvider");l.addEventListener("change",()=>{A("/api/sync/setSyncProvider",{provider:parseInt(l.value,10)},r=>{r.code===1?(ae(r.msg),l.value="0",window.siyuan.config.sync.provider=0):window.siyuan.config.sync.provider=parseInt(l.value,10),gt.element.querySelector("#syncProviderPanel").innerHTML=vo(window.siyuan.config.sync.provider),ko(),i.innerHTML="",i.classList.add("fn__none"),window.siyuan.config.sync.mode!==1||window.siyuan.config.system.container==="docker"||window.siyuan.config.sync.provider!==0?n.parentElement.classList.add("fn__none"):n.parentElement.classList.remove("fn__none"),window.siyuan.config.sync.mode!==1?t.parentElement.classList.add("fn__none"):t.parentElement.classList.remove("fn__none")})});const o=gt.element.querySelector("#reposLoading");o.style.width=gt.element.clientWidth+"px",o.style.height=gt.element.clientHeight+"px",$d(i),gt.element.firstElementChild.addEventListener("click",r=>{let c=r.target;for(;c&&c!==gt.element;){const d=c.getAttribute("data-action");if(d==="config"){i.classList.contains("fn__none")?(Wi(i,!0),i.classList.remove("fn__none")):i.classList.add("fn__none");break}else if(d==="togglePassword"){const u=c.firstElementChild.getAttribute("xlink:href")==="#iconEye";c.firstElementChild.setAttribute("xlink:href",u?"#iconEyeoff":"#iconEye"),c.previousElementSibling.setAttribute("type",u?"text":"password");break}else if(d==="exportData"){A(c.getAttribute("data-type")==="s3"?"/api/sync/exportSyncProviderS3":"/api/sync/exportSyncProviderWebDAV",{},u=>{Et(u.data.zip)});break}else if(d==="purgeData"){$e("\u267B\uFE0F "+window.siyuan.languages.cloudStoragePurge,`<div class="b3-typography">${window.siyuan.languages.cloudStoragePurgeConfirm}</div>`,()=>{A("/api/repo/purgeCloudRepo")});break}c=c.parentElement}})}},Yt={element:void 0,genHTML:()=>{let e="";return e=`<div class="b3-label">
    ${window.siyuan.languages.apiProvider}
    <div class="b3-label__text">
        ${window.siyuan.languages.apiProviderTip}
    </div>
    <div class="b3-label__text fn__flex config__item" style="padding: 4px 0 4px 4px;">
        <select id="apiProvider" class="b3-select">
            <option value="OpenAI" ${window.siyuan.config.ai.openAI.apiProvider==="OpenAI"?"selected":""}>OpenAI</option>
            <option value="Azure" ${window.siyuan.config.ai.openAI.apiProvider==="Azure"?"selected":""}>Azure</option>
        </select>
    </div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.apiTimeout}
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__flex-center fn__block" type="number" step="1" min="5" max="600" id="apiTimeout" value="${window.siyuan.config.ai.openAI.apiTimeout}"/>     
    <div class="b3-label__text">${window.siyuan.languages.apiTimeoutTip}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.apiMaxTokens}
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__flex-center fn__block" type="number" step="1" min="0" id="apiMaxTokens" value="${window.siyuan.config.ai.openAI.apiMaxTokens}"/>
    <div class="b3-label__text">${window.siyuan.languages.apiMaxTokensTip}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.apiTemperature}
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__flex-center fn__block" type="number" step="0.1" min="0" max="2" id="apiTemperature" value="${window.siyuan.config.ai.openAI.apiTemperature}"/>
    <div class="b3-label__text">${window.siyuan.languages.apiTemperatureTip}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.apiMaxContexts}
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__flex-center fn__block" type="number" step="1" min="1" max="64" id="apiMaxContexts" value="${window.siyuan.config.ai.openAI.apiMaxContexts}"/>
    <div class="b3-label__text">${window.siyuan.languages.apiMaxContextsTip}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.apiModel}
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__block" id="apiModel" value="${window.siyuan.config.ai.openAI.apiModel}"/>
    <div class="b3-label__text">${window.siyuan.languages.apiModelTip}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.apiKey}
    <div class="fn__hr"></div>
    <div class="b3-form__icona fn__block">
        <input id="apiKey" type="password" class="b3-text-field b3-form__icona-input" value="${window.siyuan.config.ai.openAI.apiKey}">
        <svg class="b3-form__icona-icon" data-action="togglePassword"><use xlink:href="#iconEye"></use></svg>
    </div>
    <div class="b3-label__text">${window.siyuan.languages.apiKeyTip}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.apiProxy}
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__block" id="apiProxy" value="${window.siyuan.config.ai.openAI.apiProxy}"/>
    <div class="b3-label__text">${window.siyuan.languages.apiProxyTip}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.apiBaseURL}
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__block" id="apiBaseURL" value="${window.siyuan.config.ai.openAI.apiBaseURL}"/>
    <div class="b3-label__text">${window.siyuan.languages.apiBaseURLTip}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.apiVersion}
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__block" id="apiVersion" value="${window.siyuan.config.ai.openAI.apiVersion}"/>
    <div class="b3-label__text">${window.siyuan.languages.apiVersionTip}</div>
</div>
<div class="b3-label">
    User-Agent
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__block" id="apiUserAgent" value="${window.siyuan.config.ai.openAI.apiUserAgent}"/>
    <div class="b3-label__text">${window.siyuan.languages.apiUserAgentTip}</div>
</div>`,`<div class="fn__flex-column" style="height: 100%">
<div class="layout-tab-bar fn__flex">
    <div data-type="openai" class="item item--full item--focus"><span class="fn__flex-1"></span><span class="item__text">OpenAI</span><span class="fn__flex-1"></span></div>
</div>
<div class="fn__flex-1">
    <div data-type="openai">
        ${e}
    </div>
</div>
</div>`},bindEvent:()=>{const e=Yt.element.querySelector('.b3-form__icona-icon[data-action="togglePassword"]');e.addEventListener("click",()=>{const t=e.firstElementChild.getAttribute("xlink:href")==="#iconEye";e.firstElementChild.setAttribute("xlink:href",t?"#iconEyeoff":"#iconEye"),e.previousElementSibling.setAttribute("type",t?"text":"password")}),Yt.element.querySelectorAll("input, select").forEach(t=>{t.addEventListener("change",()=>{A("/api/setting/setAI",{openAI:{apiUserAgent:Yt.element.querySelector("#apiUserAgent").value,apiBaseURL:Yt.element.querySelector("#apiBaseURL").value,apiVersion:Yt.element.querySelector("#apiVersion").value,apiKey:Yt.element.querySelector("#apiKey").value,apiModel:Yt.element.querySelector("#apiModel").value,apiMaxTokens:parseInt(Yt.element.querySelector("#apiMaxTokens").value),apiTemperature:parseFloat(Yt.element.querySelector("#apiTemperature").value),apiMaxContexts:parseInt(Yt.element.querySelector("#apiMaxContexts").value),apiProxy:Yt.element.querySelector("#apiProxy").value,apiTimeout:parseInt(Yt.element.querySelector("#apiTimeout").value),apiProvider:Yt.element.querySelector("#apiProvider").value}},n=>{window.siyuan.config.ai=n.data})})})}},dp=()=>{sn({title:"AI",icon:"iconSparkles",html:Yt.genHTML(),bindEvent(e){Yt.element=e,Yt.bindEvent()}})},Zt={element:void 0,genHTML:()=>{let e=`<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.flashcardMark}
        <div class="b3-label__text">${window.siyuan.languages.flashcardMarkTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="mark" type="checkbox"${window.siyuan.config.flashcard.mark?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.flashcardList}
        <div class="b3-label__text">${window.siyuan.languages.flashcardListTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="list" type="checkbox"${window.siyuan.config.flashcard.list?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.flashcardHeading}
        <div class="b3-label__text">${window.siyuan.languages.flashcardHeadingTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="heading" type="checkbox"${window.siyuan.config.flashcard.heading?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.flashcardSuperBlock}
        <div class="b3-label__text">${window.siyuan.languages.flashcardSuperBlockTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="superBlock" type="checkbox"${window.siyuan.config.flashcard.superBlock?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.flashcardDeck}
        <div class="b3-label__text">${window.siyuan.languages.flashcardDeckTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="deck" type="checkbox"${window.siyuan.config.flashcard.deck?" checked":""}/>
</label>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.reviewMode}
        <div class="b3-label__text">${window.siyuan.languages.reviewModeTip}</div>
    </div>
    <span class="fn__space"></span>
    <select class="b3-select fn__flex-center fn__size200" id="reviewMode">
      <option value="0" ${window.siyuan.config.flashcard.reviewMode===0?"selected":""}>${window.siyuan.languages.reviewMode0}</option>
      <option value="1" ${window.siyuan.config.flashcard.reviewMode===1?"selected":""}>${window.siyuan.languages.reviewMode1}</option>
      <option value="2" ${window.siyuan.config.flashcard.reviewMode===2?"selected":""}>${window.siyuan.languages.reviewMode2}</option>
    </select>    
</div>`;return e=`${e}<div class="b3-label">
    ${window.siyuan.languages.flashcardNewCardLimit}
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__block" id="newCardLimit" step="1" min="0" type="number"${window.siyuan.config.flashcard.newCardLimit?" checked":""} value="${window.siyuan.config.flashcard.newCardLimit}"/>
    <div class="b3-label__text">${window.siyuan.languages.flashcardNewCardLimitTip}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.flashcardReviewCardLimit}
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__block" id="reviewCardLimit" step="1" min="0" type="number"${window.siyuan.config.flashcard.reviewCardLimit?" checked":""} value="${window.siyuan.config.flashcard.reviewCardLimit}"/>
    <div class="b3-label__text">${window.siyuan.languages.flashcardReviewCardLimitTip}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.flashcardFSRSParamRequestRetention}
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__block" id="requestRetention" step="0.01" min="0" max="1" type="number" value="${window.siyuan.config.flashcard.requestRetention}"/>
    <div class="b3-label__text">${window.siyuan.languages.flashcardFSRSParamRequestRetentionTip}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.flashcardFSRSParamMaximumInterval}
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__block" id="maximumInterval" step="1" min="365" max="36500" type="number" value="${window.siyuan.config.flashcard.maximumInterval}"/>
    <div class="b3-label__text">${window.siyuan.languages.flashcardFSRSParamMaximumIntervalTip}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.flashcardFSRSParamWeights}
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__block" id="weights" value="${window.siyuan.config.flashcard.weights}"/>
    <div class="b3-label__text">${window.siyuan.languages.flashcardFSRSParamWeightsTip}</div>
</div>`,e},bindEvent:()=>{Zt.element.querySelectorAll("input, select.b3-select").forEach(e=>{e.addEventListener("change",()=>{A("/api/setting/setFlashcard",{reviewMode:parseInt(Zt.element.querySelector("#reviewMode").value),newCardLimit:parseInt(Zt.element.querySelector("#newCardLimit").value),reviewCardLimit:parseInt(Zt.element.querySelector("#reviewCardLimit").value),mark:Zt.element.querySelector("#mark").checked,list:Zt.element.querySelector("#list").checked,superBlock:Zt.element.querySelector("#superBlock").checked,heading:Zt.element.querySelector("#heading").checked,deck:Zt.element.querySelector("#deck").checked,requestRetention:parseFloat(Zt.element.querySelector("#requestRetention").value),maximumInterval:parseInt(Zt.element.querySelector("#maximumInterval").value),weights:Zt.element.querySelector("#weights").value},t=>{window.siyuan.config.flashcard=t.data})})})}},up=()=>{sn({title:window.siyuan.languages.riffCard,icon:"iconRiffCard",html:Zt.genHTML(),bindEvent(e){Zt.element=e,Zt.bindEvent()}})};var fp=Jt(43),gp=Jt.n(fp);const Md=()=>{var e;const t=Dn()?" fn__none":"",n=`<a class="b3-button b3-button--big${t}" href="${yu("pricing.html")}" target="_blank">
    <svg><use xlink:href="#iconVIP"></use></svg>${window.siyuan.languages[((e=window.siyuan.user)==null?void 0:e.userSiYuanOneTimePayStatus)===1?"account4":"account1"]}
</a>
<div class="fn__hr--b${t}"></div>
<span class="b3-chip b3-chip--primary b3-chip--hover${window.siyuan.user&&window.siyuan.user.userSiYuanSubscriptionStatus===2?" fn__none":""}" id="trialSub">
    <svg class="ft__secondary"><use xlink:href="#iconVIP"></use></svg>
    ${window.siyuan.languages.freeSub}
</span>
<div class="fn__hr${window.siyuan.user&&window.siyuan.user.userSiYuanSubscriptionStatus===2?" fn__none":""}"></div>
<a href="${Pt("sponsor")}" target="_blank" class="b3-chip b3-chip--pink b3-chip--hover${Dn()?" fn__none":""}">
    <svg version='1.1' xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 32 32'><path fill='#ffe43c' d='M6.4 0h19.2c4.268 0 6.4 2.132 6.4 6.4v19.2c0 4.268-2.132 6.4-6.4 6.4h-19.2c-4.268 0-6.4-2.132-6.4-6.4v-19.2c0-4.268 2.135-6.4 6.4-6.4z'></path> <path fill='#00f5d4' d='M25.6 0h-8.903c-7.762 1.894-14.043 7.579-16.697 15.113v10.487c0 3.533 2.867 6.4 6.4 6.4h19.2c3.533 0 6.4-2.867 6.4-6.4v-19.2c0-3.537-2.863-6.4-6.4-6.4z'></path> <path fill='#01beff' d='M25.6 0h-0.119c-12.739 2.754-20.833 15.316-18.079 28.054 0.293 1.35 0.702 2.667 1.224 3.946h16.974c3.533 0 6.4-2.867 6.4-6.4v-19.2c0-3.537-2.863-6.4-6.4-6.4z'></path> <path fill='#9a5ce5' d='M31.005 2.966c-0.457-0.722-1.060-1.353-1.784-1.849-8.342 3.865-13.683 12.223-13.679 21.416-0.003 3.256 0.67 6.481 1.978 9.463h8.081c0.602 0 1.185-0.084 1.736-0.238-2.1-3.189-3.401-7.624-3.401-12.526 0-7.337 2.921-13.628 7.070-16.266z'></path> <path fill='#f15bb5' d='M32 25.6v-19.2c0-1.234-0.354-2.419-0.998-3.43-4.149 2.638-7.067 8.928-7.067 16.266 0 4.902 1.301 9.334 3.401 12.526 2.693-0.757 4.664-3.231 4.664-6.162z'></path> <path fill='#fff' opacity='0.2' d='M26.972 22.415c-2.889 0.815-4.297 2.21-6.281 3.182 1.552 0.348 3.105 0.461 4.902 0.461 2.644 0 5.363-1.449 6.406-2.519v-1.085c-1.598-0.399-2.664-0.705-5.028-0.039zM4.773 21.612c-0.003 0-0.006-0.003-0.006-0.003-1.726-0.863-3.382-1.205-4.767-1.301v2.487c0.779-0.341 2.396-0.921 4.773-1.182zM17.158 26.599c1.472-0.158 2.57-0.531 3.533-1.002-1.063-0.238-2.126-0.583-3.269-1.079-2.767-1.205-5.63-3.092-10.491-3.034-0.779 0.010-1.495 0.058-2.158 0.132 4.503 2.248 7.882 5.463 12.384 4.983z'></path> <path fill='#fff' opacity='0.2' d='M20.691 25.594c-0.963 0.47-2.061 0.844-3.533 1.002-4.503 0.483-7.882-2.731-12.381-4.983-2.38 0.261-3.994 0.841-4.773 1.179v2.809c0 4.268 2.132 6.4 6.4 6.4h19.197c4.268 0 6.4-2.132 6.4-6.4v-2.065c-1.044 1.069-3.762 2.519-6.406 2.519-1.797 0-3.35-0.113-4.902-0.461z'></path> <path fill='#fff' opacity='0.5' d='M3.479 19.123c0 0.334 0.271 0.606 0.606 0.606s0.606-0.271 0.606-0.606v0c0-0.334-0.271-0.606-0.606-0.606s-0.606 0.271-0.606 0.606v0z'></path> <path fill='#fff' opacity='0.5' d='M29.027 14.266c0 0.334 0.271 0.606 0.606 0.606s0.606-0.271 0.606-0.606v0c0-0.334-0.271-0.606-0.606-0.606s-0.606 0.271-0.606 0.606v0z'></path> <path fill='#fff' d='M9.904 1.688c0 0.167 0.136 0.303 0.303 0.303s0.303-0.136 0.303-0.303v0c0-0.167-0.136-0.303-0.303-0.303s-0.303 0.136-0.303 0.303v0z'></path> <path fill='#fff' d='M2.673 10.468c0 0.167 0.136 0.303 0.303 0.303s0.303-0.136 0.303-0.303v0c0-0.167-0.136-0.303-0.303-0.303s-0.303 0.136-0.303 0.303v0z'></path> <path fill='#fff' opacity='0.6' d='M30.702 9.376c0 0.167 0.136 0.303 0.303 0.303s0.303-0.136 0.303-0.303v0c0-0.167-0.136-0.303-0.303-0.303s-0.303 0.136-0.303 0.303v0z'></path> <path fill='#fff' opacity='0.8' d='M29.236 20.881c0 0.276 0.224 0.499 0.499 0.499s0.499-0.224 0.499-0.499v0c0-0.276-0.224-0.499-0.499-0.499s-0.499 0.224-0.499 0.499v0z'></path> <path fill='#fff' opacity='0.8' d='M15.38 1.591c0.047 0.016 0.101 0.026 0.158 0.026 0.276 0 0.499-0.224 0.499-0.499 0-0.219-0.141-0.406-0.338-0.473l-0.004-0.001c-0.047-0.016-0.101-0.026-0.158-0.026-0.276 0-0.499 0.224-0.499 0.499 0 0.219 0.141 0.406 0.338 0.473l0.004 0.001z'></path> <path fill='#ffdeeb' d='M25.732 8.268c-2.393-2.371-6.249-2.371-8.642 0l-1.089 1.085-1.079-1.089c-2.38-2.39-6.249-2.393-8.639-0.013s-2.393 6.249-0.013 8.639l2.158 2.158 6.474 6.464c0.596 0.593 1.562 0.593 2.158 0l6.474-6.464 2.193-2.158c2.384-2.383 2.384-6.242 0.003-8.622z'></path> <path fill='#fff' d='M17.081 8.268l-1.079 1.085-1.079-1.089c-2.38-2.39-6.249-2.393-8.639-0.013s-2.393 6.249-0.013 8.639l2.158 2.158 2.548 2.487c4.097-1.044 7.627-3.646 9.837-7.254 1.424-2.271 2.284-4.848 2.503-7.518-2.193-0.715-4.606-0.132-6.236 1.504z'></path> </svg>
    ${window.siyuan.languages.sponsor}
</a>`;let a="";window.siyuan.user.userTitles.length>0&&(a='<div class="b3-chips" style="position: absolute">',window.siyuan.user.userTitles.forEach(i=>{a+=`<div class="b3-chip b3-chip--middle">${i.icon} ${i.name}</div>`}),a+="</div>");let s="";if(window.siyuan.user.userSiYuanProExpireTime===-1)s=`<div class="b3-chip b3-chip--secondary">${f.SIYUAN_IMAGE_VIP}${window.siyuan.languages.account12}</div>`;else if(window.siyuan.user.userSiYuanProExpireTime>0){const i=`<div class="fn__hr--b"></div>
<div class="ft__on-surface ft__smaller">
    ${window.siyuan.languages.account6} 
    ${Math.max(0,Math.floor((window.siyuan.user.userSiYuanProExpireTime-new Date().getTime())/1e3/60/60/24))} 
    ${window.siyuan.languages.day} 
    <a class="${t}" href="${Pt("subscribe/siyuan")}" target="_blank">${window.siyuan.languages.clickMeToRenew}</a>
</div>`;window.siyuan.user.userSiYuanOneTimePayStatus===1&&(s=`<div class="b3-chip"><svg><use xlink:href="#iconVIP"></use></svg>${window.siyuan.languages.onepay}</div>
<div class="fn__hr--b"></div>`),window.siyuan.user.userSiYuanSubscriptionPlan===2?s+=`<div class="b3-chip b3-chip--primary"><svg><use xlink:href="#iconVIP"></use></svg>${window.siyuan.languages.account3}</div>
${i}`:s+=`<div class="b3-chip b3-chip--primary"><svg class="ft__secondary"><use xlink:href="#iconVIP"></use></svg>${window.siyuan.languages.account10}</div>${i}`}else window.siyuan.user.userSiYuanOneTimePayStatus===1?s=`<div class="b3-chip"><svg><use xlink:href="#iconVIP"></use></svg>${window.siyuan.languages.onepay}</div>
<div class="fn__hr--b"></div>${n}`:s=n;sn({title:window.siyuan.languages.manage,icon:"iconAccount",html:`<div class="fn__flex-column">
<div class="config-account__bg">
    <div class="config-account__cover" style="background-image: url(${window.siyuan.user.userHomeBImgURL})"></div>
    <a href="${Pt("settings/avatar")}" class="config-account__avatar" style="background-image: url(${window.siyuan.user.userAvatarURL})" target="_blank"></a>
    <div class="config-account__name">
        <div class="fn__hr--b"></div>
        <h1>
            <a target="_blank" class="fn__a" href="${Pt("member/"+window.siyuan.user.userName)}">${window.siyuan.user.userName}</a>
            <span class="ft__on-surface ft__smaller">${window.siyuan.config.cloudRegion===0?"ld246.com":"liuyun.io"}</span>
        </h1>
        <div class="fn__hr--b"></div>
        <div class="fn__hr--b"></div>
        <div>${s}</div>
    </div>
    ${a}
</div>
<div class="config-account__info">
    <div class="fn__flex">
        <a class="b3-button b3-button--text${t}" href="${Pt("settings")}" target="_blank">${window.siyuan.languages.manage}</a>
        <span class="fn__space${t}"></span>
        <button class="b3-button b3-button--cancel" id="logout">
            ${window.siyuan.languages.logout}
        </button>
        <span class="fn__space"></span>
        <button class="b3-button b3-button--cancel" id="deactivateUser">
            ${window.siyuan.languages.deactivateUser}
        </button>
        <span class="fn__flex-1"></span>
        <button class="b3-button b3-button--cancel" id="refresh">
            <svg><use xlink:href="#iconRefresh"></use></svg>
        </button>
    </div>
</div></div>`,bindEvent(i){i.querySelector("#logout").addEventListener(wa(),()=>{A("/api/setting/logoutCloudUser",{},()=>{window.siyuan.user=null,Ve(),document.getElementById("menuAccount").innerHTML=`<svg class="b3-menu__icon"><use xlink:href="#iconAccount"></use></svg><span class="b3-menu__label">${window.siyuan.languages.login}</span>`,Cn()})}),i.querySelector("#deactivateUser").addEventListener("click",()=>{const r=new we({title:"\u26A0\uFE0F "+window.siyuan.languages.deactivateUser,width:"92vw",content:Hd(!0)});Pd(r.element.querySelector(".b3-dialog__body"),!0),r.element.setAttribute("data-key",f.DIALOG_DEACTIVATEUSER)});const l=i.querySelector("#trialSub");l&&l.addEventListener("click",()=>{A("/api/account/startFreeTrial",{},()=>{i.querySelector("#refresh").dispatchEvent(new Event("click"))})});const o=i.querySelector("#refresh");o.addEventListener("click",()=>{const r=o.firstElementChild;r.classList.contains("fn__rotate")||(r.classList.add("fn__rotate"),A("/api/setting/getCloudUser",{token:window.siyuan.user.userToken},c=>{window.siyuan.user=c.data,ae(window.siyuan.languages.refreshUser,3e3),Md();const d=document.getElementById("menuAccount");window.siyuan.user?d.innerHTML=`<img class="b3-menu__icon" src="${window.siyuan.user.userAvatarURL}"/><span class="b3-menu__label">${window.siyuan.user.userName}</span>`:d.innerHTML=`<svg class="b3-menu__icon"><use xlink:href="#iconAccount"></use></svg><span class="b3-menu__label">${window.siyuan.languages.login}</span>`,Cn()}))})}})},Hd=(e=!1)=>{let t;return e?t=`<div class="b3-form__img fn__none">
    <div class="fn__hr--b"></div>
    <img id="captchaImg" class="fn__pointer" style="top: 17px">
    <input id="captcha" class="b3-text-field fn__block" placeholder="${window.siyuan.languages.captcha}">
</div>
<div class="fn__hr--b"></div>
<button id="login" class="b3-button fn__block">${window.siyuan.languages.deactivateUser}</button>`:t=`<div class="b3-form__icon">
    <svg class="b3-form__icon-icon"><use xlink:href="#iconFocus"></use></svg>
    <select class="b3-select b3-form__icon-input fn__block" id="cloudRegion">
        <option value="0"${window.siyuan.config.cloudRegion===0?" selected":""}>${window.siyuan.languages.cloudRegionChina}</option>
        <option value="1"${window.siyuan.config.cloudRegion===1?" selected":""}>${window.siyuan.languages.cloudRegionNorthAmerica}</option>
    </select>
</div>
<div class="b3-form__img fn__none">
    <div class="fn__hr--b"></div>
    <img id="captchaImg" class="fn__pointer" style="top: 17px">
    <input id="captcha" class="b3-text-field fn__block" placeholder="${window.siyuan.languages.captcha}">
</div>
<div class="fn__hr--b"></div>
<label class="ft__smaller ft__on-surface fn__flex">
    <span class="fn__space"></span>
    <input type="checkbox" class="b3-switch fn__flex-center" id="agreeLogin">
    <span class="fn__space"></span>
    <span>${window.siyuan.languages.accountTip}</span>
</label>
<div class="fn__hr--b"></div>
<button id="login" disabled class="b3-button fn__block">${window.siyuan.languages.login}</button>
<div class="fn__hr--b"></div>
<div class="ft__center">
    <a href="${Pt("forget-pwd")}" class="b3-button b3-button--cancel" target="_blank">${window.siyuan.languages.forgetPassword}</a>
    <span class="fn__space${window.siyuan.config.system.container==="ios"?" fn__none":""}"></span>
    <a href="${Pt("register")}" class="b3-button b3-button--cancel${window.siyuan.config.system.container==="ios"?" fn__none":""}" target="_blank">${window.siyuan.languages.register}</a>
</div>`,`<div class="b3-form__space" id="form1">
    <div class="b3-form__icon">
        <svg class="b3-form__icon-icon"><use xlink:href="#iconAccount"></use></svg>
        <input id="userName" class="b3-text-field fn__block b3-form__icon-input" placeholder="${window.siyuan.languages.accountName}">
    </div>
    <div class="fn__hr--b"></div>
    <div class="b3-form__icon">
        <svg class="b3-form__icon-icon"><use xlink:href="#iconLock"></use></svg>
        <input type="password" id="userPassword" class="b3-text-field b3-form__icon-input fn__block" placeholder="${window.siyuan.languages.password}">
    </div>
    <div class="fn__hr--b"></div>
    ${t}
</div>
<div class="b3-form__space fn__none" id="form2">
    <div class="b3-form__icon">
        <svg class="b3-form__icon-icon"><use xlink:href="#iconLock"></use></svg>
        <input id="twofactorAuthCode" class="b3-text-field fn__block b3-form__icon-input" placeholder="${window.siyuan.languages.twoFactorCaptcha}">
    </div>
    <div class="fn__hr--b"></div>
    <button id="login2" class="b3-button fn__block">${e?window.siyuan.languages.deactivateUser:window.siyuan.languages.login}</button>
</div>`},Nd=(e,t=!1)=>{t?(J(["dialog"]),$e("\u26A0\uFE0F "+window.siyuan.languages.deactivateUser,window.siyuan.languages.deactivateUserTip,()=>{A("/api/account/deactivate",{},()=>{window.siyuan.user=null,Ve(),document.getElementById("menuAccount").innerHTML=`<svg class="b3-menu__icon"><use xlink:href="#iconAccount"></use></svg><span class="b3-menu__label">${window.siyuan.languages.login}</span>`,Cn()})})):A("/api/setting/getCloudUser",{token:e.data.token},n=>{window.siyuan.user=n.data,Ve(),document.getElementById("menuAccount").innerHTML=`<img class="b3-menu__icon" src="${window.siyuan.user.userAvatarURL}"/>
<span class="b3-menu__label">${window.siyuan.user.userName}</span>`,Cn()})},Pd=(e,t=!1)=>{const n=e.querySelector("#agreeLogin"),a=e.querySelector("#userName"),s=e.querySelector("#userPassword"),i=e.querySelector("#captchaImg"),l=e.querySelector("#captcha"),o=e.querySelector("#twofactorAuthCode"),r=e.querySelector("#login"),c=e.querySelector("#login2");a.focus();let d,u;n&&n.addEventListener("click",()=>{n.checked?r.removeAttribute("disabled"):r.setAttribute("disabled","disabled")}),i.addEventListener("click",()=>{i.setAttribute("src",Pt("captcha")+`/login?needCaptcha=${u}&t=${new Date().getTime()}`)});const p=e.querySelector("#cloudRegion");p&&p.addEventListener("change",()=>{window.siyuan.config.cloudRegion=parseInt(p.value),e.querySelector("#form1").lastElementChild.innerHTML=`<a href="${Pt("forget-pwd")}" class="b3-button b3-button--cancel" target="_blank">${window.siyuan.languages.forgetPassword}</a>
        <span class="fn__space${window.siyuan.config.system.container==="ios"?" fn__none":""}"></span>
        <a href="${Pt("register")}" class="b3-button b3-button--cancel${window.siyuan.config.system.container==="ios"?" fn__none":""}" target="_blank">${window.siyuan.languages.register}</a>`}),r.addEventListener("click",()=>{A("/api/account/login",{userName:a.value.replace(/(^\s*)|(\s*$)/g,""),userPassword:gp()(s.value),captcha:l.value.replace(/(^\s*)|(\s*$)/g,""),cloudRegion:window.siyuan.config.cloudRegion},g=>{if(g.code===1){if(ae(g.msg),g.data.needCaptcha){u=g.data.needCaptcha,l.parentElement.classList.remove("fn__none"),l.previousElementSibling.setAttribute("src",Pt("captcha")+`/login?needCaptcha=${g.data.needCaptcha}`),l.value="";return}return}if(g.code===10){e.querySelector("#form1").classList.add("fn__none"),e.querySelector("#form2").classList.remove("fn__none"),o.focus(),d=g.data.token;return}Nd(g,t)})}),c.addEventListener("click",()=>{A("/api/setting/login2faCloudUser",{code:o.value,token:d},g=>{Nd(g,t)})})},pp=()=>{sn({title:window.siyuan.languages.login,icon:"iconAccount",html:Hd(),bindEvent(e){Pd(e)}})},mp=()=>{(!window.siyuan.config.localIPs||window.siyuan.config.localIPs.length===0||window.siyuan.config.localIPs.length===1&&window.siyuan.config.localIPs[0]==="")&&(window.siyuan.config.localIPs=["127.0.0.1"]),sn({title:window.siyuan.languages.about,icon:"iconInfo",html:`<div>
<label class="b3-label fn__flex${window.siyuan.config.readonly?" fn__none":""}">
    <div class="fn__flex-1">
        ${window.siyuan.languages.about11}
        <div class="b3-label__text">${window.siyuan.languages.about12}</div>
    </div>
    <div class="fn__space"></div>
    <input class="b3-switch fn__flex-center" id="networkServe" type="checkbox"${window.siyuan.config.system.networkServe?" checked":""}>
</label>
<div class="b3-label">
        ${window.siyuan.languages.about2}
        <div class="fn__hr"></div>
        <input class="b3-text-field fn__block" readonly value="http://${window.siyuan.config.system.networkServe?window.siyuan.config.localIPs[0]:"127.0.0.1"}:${location.port}">
        <div class="b3-label__text">${window.siyuan.languages.about3.replace("${port}",location.port)}</div>
        <div class="fn__hr"></div>
        <div class="b3-label__text"><code class="fn__code">${window.siyuan.config.localIPs.filter(e=>!(e.startsWith("[")&&e.endsWith("]"))).join("</code> <code class='fn__code'>")}</code></div>
        <div class="b3-label__text"><code class="fn__code">${window.siyuan.config.localIPs.filter(e=>e.startsWith("[")&&e.endsWith("]")).join("</code> <code class='fn__code'>")}</code></div>
        <div class="fn__hr"></div>
        <div class="b3-label__text">${window.siyuan.languages.about18}</div>
</div>
<div class="b3-label${window.siyuan.config.readonly||qe()&&!Qt()&&!ft()&&!gi()&&!yt()?" fn__none":""}">
    ${window.siyuan.languages.about5}
    <div class="fn__hr"></div>
    <button class="b3-button b3-button--outline fn__block" id="authCode">
        <svg><use xlink:href="#iconLock"></use></svg>${window.siyuan.languages.config}
    </button>
    <div class="b3-label__text">${window.siyuan.languages.about6}</div>
</div>
<div class="b3-label${window.siyuan.config.readonly?" fn__none":""}">
    ${window.siyuan.languages.dataRepoKey}
    <div class="fn__hr"></div>
    <div class="${window.siyuan.config.repo.key?"fn__none":""}">
        <button class="b3-button b3-button--outline fn__block" id="importKey">
            <svg><use xlink:href="#iconDownload"></use></svg>${window.siyuan.languages.importKey}
        </button>
        <div class="fn__hr"></div>
        <button class="b3-button b3-button--outline fn__block" id="initKey">
            <svg><use xlink:href="#iconLock"></use></svg>${window.siyuan.languages.genKey}
        </button>
        <div class="fn__hr"></div>
        <button class="b3-button b3-button--outline fn__block" id="initKeyByPW">
            ${window.siyuan.languages.genKeyByPW}
        </button>
    </div>
    <div class="${window.siyuan.config.repo.key?"":"fn__none"}">
        <button class="b3-button b3-button--outline fn__block" id="copyKey">
            <svg><use xlink:href="#iconCopy"></use></svg>${window.siyuan.languages.copyKey}
        </button>
        <div class="fn__hr"></div>
        <button class="b3-button b3-button--outline fn__block" id="removeKey">
            <svg><use xlink:href="#iconUndo"></use></svg>${window.siyuan.languages.resetRepo}
        </button>
    </div>
    <div class="b3-label__text">${window.siyuan.languages.dataRepoKeyTip1}</div>
    <div class="b3-label__text ft__error">${window.siyuan.languages.dataRepoKeyTip2}</div>
</div>
<div class="b3-label${window.siyuan.config.readonly?" fn__none":""}">
    ${window.siyuan.languages.dataRepoPurge}
    <div class="fn__hr"></div>
    <button class="b3-button b3-button--outline fn__block" id="purgeRepo">
        <svg><use xlink:href="#iconTrashcan"></use></svg>${window.siyuan.languages.purge}
    </button>
    <div class="b3-label__text">${window.siyuan.languages.dataRepoPurgeTip}</div>
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__block" style="padding-right: 64px;" id="indexRetentionDays" min="1" type="number" class="b3-text-field" value="${window.siyuan.config.repo.indexRetentionDays}">
    <div class="b3-label__text">${window.siyuan.languages.dataRepoAutoPurgeIndexRetentionDays}</div>
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__block" style="padding-right: 64px;" id="retentionIndexesDaily" min="1" type="number" class="b3-text-field" value="${window.siyuan.config.repo.retentionIndexesDaily}">
    <div class="b3-label__text">${window.siyuan.languages.dataRepoAutoPurgeRetentionIndexesDaily}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.systemLog}
    <div class="fn__hr"></div>
    <button class="b3-button b3-button--outline fn__block" id="exportLog">
       <svg><use xlink:href="#iconUpload"></use></svg>${window.siyuan.languages.export}
    </button>
    <div class="b3-label__text">${window.siyuan.languages.systemLogTip}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.export} Data
    <div class="fn__hr"></div>
    <button class="b3-button b3-button--outline fn__block" id="exportData">
       <svg><use xlink:href="#iconUpload"></use></svg>${window.siyuan.languages.export}
    </button>
    <div class="b3-label__text">${window.siyuan.languages.exportDataTip}</div>
</div>
<div class="b3-label${window.siyuan.config.readonly?" fn__none":""}">
    <div class="fn__flex">
        ${window.siyuan.languages.import} Data
    </div>
    <div class="fn__hr"></div>
    <button class="b3-button b3-button--outline fn__block" style="position: relative">
        <input id="importData" class="b3-form__upload" type="file">
        <svg><use xlink:href="#iconDownload"></use></svg> ${window.siyuan.languages.import}
    </button>
    <div class="b3-label__text">${window.siyuan.languages.importDataTip}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.exportConf}
    <div class="fn__hr"></div>
    <button class="b3-button b3-button--outline fn__block" id="exportConf">
       <svg><use xlink:href="#iconUpload"></use></svg>${window.siyuan.languages.export}
    </button>
    <div class="b3-label__text">${window.siyuan.languages.exportConfTip}</div>
</div>
<div class="b3-label${window.siyuan.config.readonly?" fn__none":""}">
    <div class="fn__flex">
        ${window.siyuan.languages.importConf}
    </div>
    <div class="fn__hr"></div>
    <button class="b3-button b3-button--outline fn__block" style="position: relative">
        <input id="importConf" class="b3-form__upload" type="file">
        <svg><use xlink:href="#iconDownload"></use></svg> ${window.siyuan.languages.import}
    </button>
    <div class="b3-label__text">${window.siyuan.languages.importConfTip}</div>
</div>
<div class="b3-label${!window.siyuan.config.readonly&&(ft()||Qt()||yt())?"":" fn__none"}">
    ${window.siyuan.languages.workspaceList}
    <div class="fn__hr"></div>
    <button id="openWorkspace" class="b3-button b3-button--outline fn__block">${window.siyuan.languages.openBy}...</button>
    <div class="fn__hr"></div>
    <ul id="workspaceDir" class="b3-list b3-list--background"></ul>
    <div class="fn__hr"></div>
    <button id="creatWorkspace" class="b3-button fn__block">${window.siyuan.languages.new}</button>
</div>
<div class="b3-label${window.siyuan.config.readonly?" fn__none":""}">
    ${window.siyuan.languages.about13}
    <div class="fn__hr"></div>
    <div class="b3-form__icon">
        <input class="b3-text-field fn__block" id="token" style="padding-right: 64px;" value="${window.siyuan.config.api.token}">
        <button class="b3-button b3-button--text" id="tokenCopy" style="position: absolute;right: 0;height: 28px;">
            <svg><use xlink:href="#iconCopy"></use></svg>${window.siyuan.languages.copy}
        </button>
    </div>
    <div class="b3-label__text" id="tokenTip">${window.siyuan.languages.about14.replace("${token}",window.siyuan.config.api.token)}</div>
</div>
<div class="b3-label">
    <div class="config-about__logo">
        <img src="/stage/icon.png">
        <span class="fn__space"></span>
        <div>
            <span>${window.siyuan.languages.siyuanNote}</span>
            <span class="fn__space"></span>
            <span class="ft__on-surface">v${f.SIYUAN_VERSION}</span>
            <br>
            <span class="ft__on-surface">${window.siyuan.languages.slogan}</span>
        </div>
    </div>
    <div style="color:var(--b3-theme-surface);font-family: cursive;">\u4F1A\u6CFD\u767E\u5BB6&nbsp;\u81F3\u516C\u5929\u4E0B</div>
    ${window.siyuan.languages.about1} ${window.siyuan.config.system.container==="harmony"?" \u2022 "+window.siyuan.languages.feedback+" 845765@qq.com":""}
</div>
</div>`,bindEvent(e){const t=e.querySelector("#workspaceDir");Eo(t);const n=e.querySelector("#importKey");e.firstElementChild.addEventListener("click",o=>{let r=o.target;for(;r&&!r.isSameNode(e);){if(r.id==="authCode"){bu(),o.preventDefault(),o.stopPropagation();break}else if(r.id==="importKey"){const c=new we({title:"\u{1F511} "+window.siyuan.languages.key,content:`<div class="b3-dialog__content">
    <textarea spellcheck="false" style="resize: vertical;"  class="b3-text-field fn__block" placeholder="${window.siyuan.languages.keyPlaceholder}"></textarea>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:"92vw"});c.element.setAttribute("data-key",f.DIALOG_PASSWORD);const d=c.element.querySelector("textarea");d.focus();const u=c.element.querySelectorAll(".b3-button");u[0].addEventListener("click",()=>{c.destroy()}),u[1].addEventListener("click",()=>{A("/api/repo/importRepoKey",{key:d.value},p=>{window.siyuan.config.repo.key=p.data.key,n.parentElement.classList.add("fn__none"),n.parentElement.nextElementSibling.classList.remove("fn__none"),c.destroy()})}),o.preventDefault(),o.stopPropagation();break}else if(r.id==="initKey"){$e("\u{1F511} "+window.siyuan.languages.genKey,window.siyuan.languages.initRepoKeyTip,()=>{A("/api/repo/initRepoKey",{},c=>{window.siyuan.config.repo.key=c.data.key,n.parentElement.classList.add("fn__none"),n.parentElement.nextElementSibling.classList.remove("fn__none")})}),o.preventDefault(),o.stopPropagation();break}else if(r.id==="initKeyByPW"){Dd(!1,()=>{n.parentElement.classList.add("fn__none"),n.parentElement.nextElementSibling.classList.remove("fn__none")}),o.preventDefault(),o.stopPropagation();break}else if(r.id==="copyKey"){ae(window.siyuan.languages.copied),Be(window.siyuan.config.repo.key),o.preventDefault(),o.stopPropagation();break}else if(r.id==="removeKey"){$e("\u26A0\uFE0F "+window.siyuan.languages.resetRepo,window.siyuan.languages.resetRepoTip,()=>{A("/api/repo/resetRepo",{},()=>{window.siyuan.config.repo.key="",window.siyuan.config.sync.enabled=!1,Cn(),n.parentElement.classList.remove("fn__none"),n.parentElement.nextElementSibling.classList.add("fn__none")})}),o.preventDefault(),o.stopPropagation();break}else if(r.id==="purgeRepo"){$e("\u267B\uFE0F "+window.siyuan.languages.dataRepoPurge,window.siyuan.languages.dataRepoPurgeConfirm,()=>{A("/api/repo/purgeRepo")}),o.preventDefault(),o.stopPropagation();break}else if(r.id==="tokenCopy"){ae(window.siyuan.languages.copied),Be(window.siyuan.config.api.token),o.preventDefault(),o.stopPropagation();break}else if(r.id==="exportData"){A("/api/export/exportData",{},c=>{Et(c.data.zip)}),o.preventDefault(),o.stopPropagation();break}else if(r.id==="exportConf"){A("/api/system/exportConf",{},c=>{Et(c.data.zip)}),o.preventDefault(),o.stopPropagation();break}else if(r.id==="exportLog"){A("/api/system/exportLog",{},c=>{Et(c.data.zip)}),o.preventDefault(),o.stopPropagation();break}else if(r.id==="openWorkspace"){A("/api/system/getMobileWorkspaces",{},c=>{let d="";c.data.forEach((g,m)=>{d+=`<option value="${g}"${m===0?' selected="selected"':""}>${me().basename(g)}</option>`});const u=new we({title:window.siyuan.languages.openBy,content:`<div class="b3-dialog__content">
    <select class="b3-text-field fn__block">${d}</select>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:"92vw"});u.element.setAttribute("data-key",f.SIYUAN_OPEN_WORKSPACE);const p=u.element.querySelectorAll(".b3-button");p[0].addEventListener("click",()=>{u.destroy()}),p[1].addEventListener("click",()=>{const g=u.element.querySelector("select").value;if(g===window.siyuan.config.system.workspaceDir){u.destroy();return}$e(window.siyuan.languages.confirm,`${me().basename(window.siyuan.config.system.workspaceDir)} -> ${me().basename(g)}?`,()=>{A("/api/system/setWorkspaceDir",{path:g},()=>{Da()})})})}),o.preventDefault(),o.stopPropagation();break}else if(r.id==="creatWorkspace"){const c=new we({title:window.siyuan.languages.new,content:`<div class="b3-dialog__content">
    <input class="b3-text-field fn__block">
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:"92vw"});c.element.setAttribute("data-key",f.DIALOG_CREATEWORKSPACE);const d=c.element.querySelector("input");d.focus();const u=c.element.querySelectorAll(".b3-button");u[0].addEventListener("click",()=>{c.destroy()}),u[1].addEventListener("click",()=>{A("/api/system/createWorkspaceDir",{path:me().join(me().dirname(window.siyuan.config.system.workspaceDir),d.value)},()=>{Eo(t),c.destroy()})}),o.preventDefault(),o.stopPropagation();break}else if(r.getAttribute("data-type")==="remove"){const c=r.parentElement.getAttribute("data-path");A("/api/system/removeWorkspaceDir",{path:c},()=>{Eo(t),$e(window.siyuan.languages.deleteOpConfirm,window.siyuan.languages.removeWorkspacePhysically.replace("${x}",c),()=>{A("/api/system/removeWorkspaceDirPhysically",{path:c})},void 0,!0)}),o.preventDefault(),o.stopPropagation();break}else if(r.classList.contains("b3-list-item")&&!r.classList.contains("b3-list-item--focus")){$e(window.siyuan.languages.confirm,`${me().basename(window.siyuan.config.system.workspaceDir)} -> ${me().basename(r.getAttribute("data-path"))}?`,()=>{A("/api/system/setWorkspaceDir",{path:r.getAttribute("data-path")},()=>{Da()})}),o.preventDefault(),o.stopPropagation();break}r=r.parentElement}}),e.querySelector("#importData").addEventListener("change",o=>{const r=new FormData;r.append("file",o.target.files[0]),A("/api/import/importData",r)}),e.querySelector("#importConf").addEventListener("change",o=>{const r=new FormData;r.append("file",o.target.files[0]),A("/api/system/importConf",r,c=>{if(c.code!==0){ae(c.msg);return}Da()})});const a=e.querySelector("#networkServe");a.addEventListener("change",()=>{A("/api/system/setNetworkServe",{networkServe:a.checked},()=>{Da()})});const s=e.querySelector("#token");s.addEventListener("change",()=>{A("/api/system/setAPIToken",{token:s.value},()=>{window.siyuan.config.api.token=s.value,e.querySelector("#tokenTip").innerHTML=window.siyuan.languages.about14.replace("${token}",window.siyuan.config.api.token)})});const i=e.querySelector("#indexRetentionDays");i.addEventListener("change",()=>{A("/api/repo/setRepoIndexRetentionDays",{days:parseInt(i.value)},()=>{window.siyuan.config.repo.indexRetentionDays=parseInt(i.value)})});const l=e.querySelector("#retentionIndexesDaily");l.addEventListener("change",()=>{A("/api/repo/setRetentionIndexesDaily",{indexes:parseInt(l.value)},()=>{window.siyuan.config.repo.retentionIndexesDaily=parseInt(l.value)})})}})},Eo=e=>{A("/api/system/getWorkspaces",{},t=>{let n="";t.data.forEach(a=>{n+=`<li data-path="${a.path}" class="b3-list-item b3-list-item--narrow${window.siyuan.config.system.workspaceDir===a.path?" b3-list-item--focus":""}">
    <span class="b3-list-item__text">${me().basename(a.path)}</span>
    <span data-type="remove" class="b3-list-item__action">
        <svg><use xlink:href="#iconMin"></use></svg>
    </span>
</li>`}),e.innerHTML=n})},qd=e=>{let t=parseInt(e.querySelector("#dynamicLoadBlocks").value);48>t&&(t=48,e.querySelector("#dynamicLoadBlocks").value="48"),1024<t&&(t=1024,e.querySelector("#dynamicLoadBlocks").value="1024"),window.siyuan.config.editor.markdown={inlineAsterisk:e.querySelector("#editorMarkdownInlineAsterisk").checked,inlineUnderscore:e.querySelector("#editorMarkdownInlineUnderscore").checked,inlineSup:e.querySelector("#editorMarkdownInlineSup").checked,inlineSub:e.querySelector("#editorMarkdownInlineSub").checked,inlineTag:e.querySelector("#editorMarkdownInlineTag").checked,inlineMath:e.querySelector("#editorMarkdownInlineMath").checked,inlineStrikethrough:e.querySelector("#editorMarkdownInlineStrikethrough").checked,inlineMark:e.querySelector("#editorMarkdownInlineMark").checked},window.siyuan.config.editor.allowHTMLBLockScript=e.querySelector("#allowHTMLBLockScript").checked,window.siyuan.config.editor.dynamicLoadBlocks=t,window.siyuan.config.editor.justify=e.querySelector("#justify").checked,window.siyuan.config.editor.rtl=e.querySelector("#rtl").checked,window.siyuan.config.editor.readOnly=e.querySelector("#readOnly").checked,window.siyuan.config.editor.displayBookmarkIcon=e.querySelector("#displayBookmarkIcon").checked,window.siyuan.config.editor.displayNetImgMark=e.querySelector("#displayNetImgMark").checked,window.siyuan.config.editor.codeSyntaxHighlightLineNum=e.querySelector("#codeSyntaxHighlightLineNum").checked,window.siyuan.config.editor.embedBlockBreadcrumb=e.querySelector("#embedBlockBreadcrumb").checked,window.siyuan.config.editor.listLogicalOutdent=e.querySelector("#listLogicalOutdent").checked,window.siyuan.config.editor.listItemDotNumberClickFocus=e.querySelector("#listItemDotNumberClickFocus").checked,window.siyuan.config.editor.spellcheck=e.querySelector("#spellcheck").checked,window.siyuan.config.editor.onlySearchForDoc=e.querySelector("#onlySearchForDoc").checked,window.siyuan.config.editor.plantUMLServePath=e.querySelector("#plantUMLServePath").value,window.siyuan.config.editor.katexMacros=e.querySelector("#katexMacros").value,window.siyuan.config.editor.codeLineWrap=e.querySelector("#codeLineWrap").checked,window.siyuan.config.editor.virtualBlockRef=e.querySelector("#virtualBlockRef").checked,window.siyuan.config.editor.virtualBlockRefInclude=e.querySelector("#virtualBlockRefInclude").value,window.siyuan.config.editor.virtualBlockRefExclude=e.querySelector("#virtualBlockRefExclude").value,window.siyuan.config.editor.blockRefDynamicAnchorTextMaxLen=parseInt(e.querySelector("#blockRefDynamicAnchorTextMaxLen").value),window.siyuan.config.editor.backlinkExpandCount=parseInt(e.querySelector("#backlinkExpandCount").value),window.siyuan.config.editor.backmentionExpandCount=parseInt(e.querySelector("#backmentionExpandCount").value),window.siyuan.config.editor.backlinkContainChildren=e.querySelector("#backlinkContainChildren").checked,window.siyuan.config.editor.codeLigatures=e.querySelector("#codeLigatures").checked,window.siyuan.config.editor.codeTabSpaces=parseInt(e.querySelector("#codeTabSpaces").value),window.siyuan.config.editor.fontSize=parseInt(e.querySelector("#fontSize").value),window.siyuan.config.editor.generateHistoryInterval=parseInt(e.querySelector("#generateHistoryInterval").value),window.siyuan.config.editor.historyRetentionDays=parseInt(e.querySelector("#historyRetentionDays").value),A("/api/setting/setEditor",window.siyuan.config.editor,n=>{window.siyuan.config.editor=n.data,Un(window.siyuan.mobile.editor.protyle,!1),is()})},bp=()=>{let e="";for(let t=9;t<=72;t++)e+=`<option ${window.siyuan.config.editor.fontSize===t?"selected":""} value="${t}">${t}</option>`;sn({title:window.siyuan.languages.editor,icon:"iconEdit",html:`<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.justify}
        <div class="b3-label__text">${window.siyuan.languages.justifyTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="justify" type="checkbox"${window.siyuan.config.editor.justify?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.rtl}
        <div class="b3-label__text">${window.siyuan.languages.rtlTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="rtl" type="checkbox"${window.siyuan.config.editor.rtl?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.editReadonly}
        <div class="b3-label__text">${window.siyuan.languages.editReadonlyTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="readOnly" type="checkbox"${window.siyuan.config.editor.readOnly?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.md12}
        <div class="b3-label__text">${window.siyuan.languages.md16}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="displayBookmarkIcon" type="checkbox"${window.siyuan.config.editor.displayBookmarkIcon?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.md7}
        <div class="b3-label__text">${window.siyuan.languages.md8}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="displayNetImgMark" type="checkbox"${window.siyuan.config.editor.displayNetImgMark?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.embedBlockBreadcrumb}
        <div class="b3-label__text">${window.siyuan.languages.embedBlockBreadcrumbTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="embedBlockBreadcrumb" type="checkbox"${window.siyuan.config.editor.embedBlockBreadcrumb?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.outlineOutdent}
        <div class="b3-label__text">${window.siyuan.languages.outlineOutdentTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="listLogicalOutdent" type="checkbox"${window.siyuan.config.editor.listLogicalOutdent?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.listItemDotNumberClickFocus}
        <div class="b3-label__text">${window.siyuan.languages.listItemDotNumberClickFocusTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="listItemDotNumberClickFocus" type="checkbox"${window.siyuan.config.editor.listItemDotNumberClickFocus?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.spellcheck}
        <div class="b3-label__text">${window.siyuan.languages.spellcheckTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="spellcheck" type="checkbox"${window.siyuan.config.editor.spellcheck?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.onlySearchForDoc}
        <div class="b3-label__text">${window.siyuan.languages.onlySearchForDocTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="onlySearchForDoc" type="checkbox"${window.siyuan.config.editor.spellcheck?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.md31}
        <div class="b3-label__text">${window.siyuan.languages.md32}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="codeLineWrap" type="checkbox"${window.siyuan.config.editor.codeLineWrap?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.md2}
        <div class="b3-label__text">${window.siyuan.languages.md3}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="codeLigatures" type="checkbox"${window.siyuan.config.editor.codeLigatures?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.md27}
        <div class="b3-label__text">${window.siyuan.languages.md28}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="codeSyntaxHighlightLineNum" type="checkbox"${window.siyuan.config.editor.codeSyntaxHighlightLineNum?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.md33}
        <div class="b3-label__text">${window.siyuan.languages.md34}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="virtualBlockRef" type="checkbox"${window.siyuan.config.editor.virtualBlockRef?" checked":""}/>
</label>
<div class="b3-label">
    ${window.siyuan.languages.md9}
    <span class="fn__hr"></span>
    <input class="b3-text-field fn__block" id="virtualBlockRefInclude" value="${window.siyuan.config.editor.virtualBlockRefInclude}" />
    <div class="b3-label__text">${window.siyuan.languages.md36}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.md35}
    <span class="fn__hr"></span>
    <input class="b3-text-field fn__block" id="virtualBlockRefExclude" value="${window.siyuan.config.editor.virtualBlockRefExclude}" />
    <div class="b3-label__text">${window.siyuan.languages.md36}</div>
    <div class="b3-label__text">${window.siyuan.languages.md41}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.md39}
    <span class="fn__hr"></span>
    <input class="b3-text-field fn__block" id="plantUMLServePath" value="${window.siyuan.config.editor.plantUMLServePath}"/>
    <div class="b3-label__text">${window.siyuan.languages.md40}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.dynamicLoadBlocks}
    <span class="fn__hr"></span>
    <input class="b3-text-field fn__block" id="dynamicLoadBlocks" type="number" min="48" value="${window.siyuan.config.editor.dynamicLoadBlocks}"/>
    <div class="b3-label__text">${window.siyuan.languages.dynamicLoadBlocksTip}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.md37}
    <span class="fn__hr"></span>
    <input class="b3-text-field fn__block" id="blockRefDynamicAnchorTextMaxLen" type="number" min="1" max="5120" value="${window.siyuan.config.editor.blockRefDynamicAnchorTextMaxLen}"/>
    <div class="b3-label__text">${window.siyuan.languages.md38}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.backlinkExpand}
    <span class="fn__hr"></span>
    <input class="b3-text-field fn__block" id="backlinkExpandCount" type="number" min="0" max="512" value="${window.siyuan.config.editor.backlinkExpandCount}"/>
    <div class="b3-label__text">${window.siyuan.languages.backlinkExpandTip}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.backmentionExpand}
    <span class="fn__hr"></span>
    <input class="b3-text-field fn__block" id="backmentionExpandCount" type="number" min="-1" max="512" value="${window.siyuan.config.editor.backmentionExpandCount}"/>
    <div class="b3-label__text">${window.siyuan.languages.backmentionExpandTip}</div>
</div>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.backlinkContainChildren}
        <div class="b3-label__text">${window.siyuan.languages.backlinkContainChildrenTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="backlinkContainChildren" type="checkbox"${window.siyuan.config.editor.backlinkContainChildren?" checked":""}/>
</label>
<div class="b3-label">
    ${window.siyuan.languages.generateHistory}
    <span class="fn__hr"></span>
    <input class="b3-text-field fn__block" id="generateHistoryInterval" type="number" min="0" max="120" value="${window.siyuan.config.editor.generateHistoryInterval}"/>
    <div class="b3-label__text">${window.siyuan.languages.generateHistoryInterval}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.historyRetentionDays} 
    <a href="javascript:void(0)" id="clearHistory">${window.siyuan.languages.clearHistory}</a>
    <span class="fn__hr"></span>
    <input class="b3-text-field fn__block" id="historyRetentionDays" type="number" min="0" value="${window.siyuan.config.editor.historyRetentionDays}"/>
    <div class="b3-label__text">${window.siyuan.languages.historyRetentionDaysTip}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.fontSize} 
    <span class="ft__on-surface">${window.siyuan.config.editor.fontSize}</span>
    <div class="fn__hr"></div>
    <select id="fontSize" class="b3-select fn__block">${e}</select>
    <div class="b3-label__text">${window.siyuan.languages.fontSizeTip}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.md29} 
    <div class="fn__hr"></div>
    <select id="codeTabSpaces" class="b3-select fn__block">
        <option ${window.siyuan.config.editor.codeTabSpaces===0?"selected":""} value="0">0</option>
        <option ${window.siyuan.config.editor.codeTabSpaces===2?"selected":""} value="2">2</option>
        <option ${window.siyuan.config.editor.codeTabSpaces===4?"selected":""} value="4">4</option>
        <option ${window.siyuan.config.editor.codeTabSpaces===6?"selected":""} value="6">6</option>
        <option ${window.siyuan.config.editor.codeTabSpaces===8?"selected":""} value="8">8</option>
    </select>
    <div class="b3-label__text">${window.siyuan.languages.md30}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.katexMacros}
    <div class="fn__hr"></div>
    <textarea class="b3-text-field fn__block" id="katexMacros">${window.siyuan.config.editor.katexMacros}</textarea>
    <div class="b3-label__text">${window.siyuan.languages.katexMacrosTip}</div>
</div>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
       ${window.siyuan.languages.allowHTMLBLockScript}
        <div class="b3-label__text">${window.siyuan.languages.allowHTMLBLockScriptTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="allowHTMLBLockScript" type="checkbox"${window.siyuan.config.editor.allowHTMLBLockScript?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
       ${window.siyuan.languages.editorMarkdownInlineAsterisk}
        <div class="b3-label__text">${window.siyuan.languages.editorMarkdownInlineAsteriskTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="editorMarkdownInlineAsterisk" type="checkbox"${window.siyuan.config.editor.markdown.inlineAsterisk?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
       ${window.siyuan.languages.editorMarkdownInlineUnderscore}
        <div class="b3-label__text">${window.siyuan.languages.editorMarkdownInlineUnderscoreTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="editorMarkdownInlineUnderscore" type="checkbox"${window.siyuan.config.editor.markdown.inlineUnderscore?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
       ${window.siyuan.languages.editorMarkdownInlineSup}
        <div class="b3-label__text">${window.siyuan.languages.editorMarkdownInlineSupTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="editorMarkdownInlineSup" type="checkbox"${window.siyuan.config.editor.markdown.inlineSup?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
       ${window.siyuan.languages.editorMarkdownInlineSub}
        <div class="b3-label__text">${window.siyuan.languages.editorMarkdownInlineSubTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="editorMarkdownInlineSub" type="checkbox"${window.siyuan.config.editor.markdown.inlineSub?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
       ${window.siyuan.languages.editorMarkdownInlineTag}
        <div class="b3-label__text">${window.siyuan.languages.editorMarkdownInlineTagTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="editorMarkdownInlineTag" type="checkbox"${window.siyuan.config.editor.markdown.inlineTag?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
       ${window.siyuan.languages.editorMarkdownInlineMath}
        <div class="b3-label__text">${window.siyuan.languages.editorMarkdownInlineMathTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="editorMarkdownInlineMath" type="checkbox"${window.siyuan.config.editor.markdown.inlineMath?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
       ${window.siyuan.languages.editorMarkdownInlineStrikethrough}
        <div class="b3-label__text">${window.siyuan.languages.editorMarkdownInlineStrikethroughTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="editorMarkdownInlineStrikethrough" type="checkbox"${window.siyuan.config.editor.markdown.inlineStrikethrough?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
       ${window.siyuan.languages.editorMarkdownInlineMark}
        <div class="b3-label__text">${window.siyuan.languages.editorMarkdownInlineMarkTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="editorMarkdownInlineMark" type="checkbox"${window.siyuan.config.editor.markdown.inlineMark?" checked":""}/>
</label>`,bindEvent(t){t.querySelector("#clearHistory").addEventListener("click",()=>{$e(window.siyuan.languages.clearHistory,window.siyuan.languages.confirmClearHistory,()=>{A("/api/history/clearWorkspaceHistory",{})})}),t.querySelectorAll("input.b3-switch, select.b3-select, input.b3-slider").forEach(n=>{n.addEventListener("change",()=>{qd(t)})}),t.querySelectorAll("textarea.b3-text-field, input.b3-text-field, input.b3-slider").forEach(n=>{n.addEventListener("blur",()=>{qd(t)})}),t.querySelectorAll("input.b3-slider").forEach(n=>{n.addEventListener("input",a=>{const s=a.target;s.previousElementSibling.previousElementSibling.textContent=s.value})})}})};class yp extends Oi{constructor(t){super({app:t.app,id:t.tab.id}),window.siyuan.config.fileTree.openFilesUseCurrentTab&&t.tab.headElement.classList.add("item--unupdate"),this.headElement=t.tab.headElement,this.element=t.tab.panelElement,this.initProtyle(t)}initProtyle(t){this.editor=new Yn(this.app,this.element,{action:t.action||[],blockId:t.blockId,rootId:t.rootId,mode:t.mode,render:{title:!0,background:!0,scroll:!0},typewriterMode:!0,after:n=>{window.siyuan.editorIsFullscreen&&(El(n.protyle.element),Fc(n.protyle)),Ht([],n.protyle.block.rootID)}}),this.editor.protyle.model=this}}const Ys=e=>{document.getElementById("toolbarFile").dispatchEvent(new CustomEvent("click")),document.querySelector("#sidebar .toolbar--border").dispatchEvent(new CustomEvent("click",{detail:e}))},wp=e=>{window.siyuan.config.editor.readOnly=e,A("/api/setting/setEditor",window.siyuan.config.editor)},hp=()=>{var e;(e=window.siyuan.mobile.editor)!=null&&e.protyle&&(Ys("file"),window.siyuan.mobile.docks.file.selectItem(window.siyuan.mobile.editor.protyle.notebookId,window.siyuan.mobile.editor.protyle.path))},_p=(e,t)=>{switch(e){case"fileTree":return Ys("file"),!0;case"outline":case"bookmark":case"tag":case"inbox":return Ys(e),!0;case"backlinks":return Ys("backlink"),!0;case"mainMenu":return Na(),!0;case"globalSearch":return qt(t),!0;case"recentDocs":return Ql(t),!0}switch(e){case"dailyNote":return zc(t),!0;case"dataHistory":return no(t),!0;case"editReadonly":return wp(!window.siyuan.config.editor.readOnly),!0;case"lockScreen":return io(t),!0;case"newFile":return aa({app:t,useSavePath:!0}),!0;case"riffCard":return bd(t),!0;case"selectOpen1":return hp(),!0;case"syncNow":return ho(t),!0}return!1};var vp=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{o(n.next(r))}catch(c){s(c)}},l=r=>{try{o(n.throw(r))}catch(c){s(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,l);o((n=n.apply(e,t)).next())});const kp=e=>{const t=getSelection().rangeCount>0?getSelection().getRangeAt(0):void 0,n=new we({width:H()?"92vw":"80vw",height:H()?"80vh":"70vh",title:window.siyuan.languages.commandPanel,content:`<div class="fn__flex-column">
    <div class="b3-form__icon search__header" style="border-top: 0;border-bottom: 1px solid var(--b3-theme-surface-lighter);">
        <svg class="b3-form__icon-icon"><use xlink:href="#iconSearch"></use></svg>
        <input class="b3-text-field b3-text-field--text" style="padding-left: 32px !important;">
    </div>
    <ul class="b3-list b3-list--background search__list" id="commands"></ul>
    <div class="search__tip">
        <kbd>\u2191/\u2193</kbd> ${window.siyuan.languages.searchTip1}
        <kbd>${window.siyuan.languages.enterKey}/${window.siyuan.languages.click}</kbd> ${window.siyuan.languages.confirm}
        <kbd>Esc</kbd> ${window.siyuan.languages.close}
    </div>
</div>`});n.element.setAttribute("data-key",f.DIALOG_COMMANDPANEL);const a=n.element.querySelector("#commands");let s="";if(Object.keys(window.siyuan.config.keymap.general).forEach(l=>{let o;o=["addToDatabase","fileTree","outline","bookmark","tag","dailyNote","inbox","backlinks","dataHistory","editReadonly","enter","enterBack","globalSearch","lockScreen","mainMenu","move","newFile","recentDocs","replace","riffCard","search","selectOpen1","syncNow"],o.includes(l)&&(s+=`<li class="b3-list-item" data-command="${l}">
    <span class="b3-list-item__text">${window.siyuan.languages[l]}</span>
    <span class="b3-list-item__meta${H()?" fn__none":""}">${Me(window.siyuan.config.keymap.general[l].custom)}</span>
</li>`)}),Object.keys(window.siyuan.config.keymap.editor.general).forEach(l=>{["switchReadonly","switchAdjust"].includes(l)&&(s+=`<li class="b3-list-item" data-command="${l}">
    <span class="b3-list-item__text">${window.siyuan.languages[l]}</span>
    <span class="b3-list-item__meta${H()?" fn__none":""}">${Me(window.siyuan.config.keymap.editor.general[l].custom)}</span>
</li>`)}),a.insertAdjacentHTML("beforeend",s),e.plugins.forEach(l=>{l.commands.forEach(o=>{const r=document.createElement("li");r.classList.add("b3-list-item"),r.innerHTML=`<span class="b3-list-item__text">${l.displayName}: ${o.langText||l.i18n[o.langKey]}</span>
<span class="b3-list-item__meta${H()?" fn__none":""}">${Me(o.customHotkey)}</span>`,r.addEventListener("click",c=>{o.callback?o.callback():o.globalCallback&&o.globalCallback(),n.destroy(),c.preventDefault(),c.stopPropagation()}),a.insertAdjacentElement("beforeend",r)})}),a.childElementCount===0){const l=document.createElement("li");l.classList.add("b3-list-item","b3-list-item--focus"),l.innerHTML=`<span class="b3-list-item__text" style="-webkit-line-clamp: inherit;">${window.siyuan.languages._kernel[122]}</span>`,l.addEventListener("click",()=>{n.destroy()}),a.insertAdjacentElement("beforeend",l)}else a.firstElementChild.classList.add("b3-list-item--focus");const i=n.element.querySelector(".b3-text-field");i.focus(),a.addEventListener("click",l=>{const o=$(l.target,"b3-list-item");if(o){const r=o.getAttribute("data-command");r&&(Lo({command:r,app:e,previousRange:t}),n.destroy(),l.preventDefault(),l.stopPropagation())}}),i.addEventListener("keydown",l=>{if(l.stopPropagation(),!l.isComposing)if(Wt(a,l),l.key==="Enter"){const o=a.querySelector(".b3-list-item--focus");if(o){const r=o.getAttribute("data-command");r?Lo({command:r,app:e,previousRange:t}):o.dispatchEvent(new CustomEvent("click"))}n.destroy()}else l.key==="Escape"&&n.destroy()}),i.addEventListener("compositionend",()=>{Od(i,a)}),i.addEventListener("input",l=>{l.isComposing||(l.stopPropagation(),Od(i,a))})},Od=(e,t)=>{var n;const a=e.value.toLowerCase();(n=t.querySelector(".b3-list-item--focus"))==null||n.classList.remove("b3-list-item--focus");let s=!1;Array.from(t.children).forEach(i=>{const l=i.querySelector(".b3-list-item__text").textContent.toLowerCase(),o=i.dataset.command;a.indexOf(l)>-1||l.indexOf(a)>-1||a.indexOf(o)>-1||(o==null?void 0:o.indexOf(a))>-1?(s||i.classList.add("b3-list-item--focus"),s=!0,i.classList.remove("fn__none")):i.classList.add("fn__none")})},Lo=e=>vp(void 0,null,function*(){var t,n,a;if(_p(e.command,e.app))return;const s=(t=document.querySelector(".layout__tab--active"))==null?void 0:t.classList.contains("sy__file");let i=e.protyle;i||(i=Dt().protyle,e.previousRange=i.toolbar.range);const l=e.previousRange||(getSelection().rangeCount>0?getSelection().getRangeAt(0):document.createRange());let o=e.fileLiElements;if(!s&&!i){l&&window.siyuan.dialogs.find(c=>{if(c.editors&&(Object.keys(c.editors).find(d=>{if(c.editors[d].protyle.element.contains(l.startContainer))return i=c.editors[d].protyle,!0}),i))return!0});const r=getActiveTab();if(!i&&r)r.model instanceof yp?i=r.model.editor.protyle:r.model instanceof Search?r.model.element.querySelector("#searchUnRefPanel").classList.contains("fn__none")?i=r.model.editors.edit.protyle:i=r.model.editors.unRefEdit.protyle:r.model instanceof Custom&&((n=r.model.editors)==null?void 0:n.length)>0&&l&&r.model.editors.find(c=>{if(c.protyle.element.contains(l.startContainer))return i=c.protyle,!0});else if(!i){!i&&l&&window.siyuan.blockPanels.find(d=>{if(d.editors.find(u=>{if(u.protyle.element.contains(l.startContainer))return i=u.protyle,!0}),i)return!0});const c=getAllModels();i||c.backlink.find(d=>{if(d.element.classList.contains("layout__tab--active"))return l&&d.editors.find(u=>{if(u.protyle.element.contains(l.startContainer))return i=u.protyle,!0}),!i&&d.editors.length>0&&(i=d.editors[0].protyle),!0}),i||c.editor.find(d=>{if(d.parent.headElement.classList.contains("item--focus"))return i=d.editor.protyle,!0})}}if(!(!s&&i&&fo({command:e.command,previousRange:l,protyle:i}))){if(s&&!o){const r=getDockByType("file");if(!r)return!1;const c=r.data.file;o=Array.from(c.element.querySelectorAll(".b3-list-item--focus"))}if(!i&&!s||s&&(!o||o.length===0)||H()&&!document.getElementById("empty").classList.contains("fn__none")){e.command==="replace"?qt(e.app,{hasReplace:!0,page:1}):e.command==="search"&&qt(e.app,{hasReplace:!1,page:1});return}switch(e.command){case"replace":if(!s){const r=yield Ye("/api/filetree/getHPathByPath",{notebook:i.notebookId,path:i.path.endsWith(".sy")?i.path:i.path+".sy"});qt(e.app,{page:1,hasReplace:!0,hPath:me().join(Ft(i.notebookId),r.data),idPath:[me().join(i.notebookId,i.path)]})}break;case"search":if(!s){const r=yield Ye("/api/filetree/getHPathByPath",{notebook:i.notebookId,path:i.path.endsWith(".sy")?i.path:i.path+".sy"});qt(e.app,{page:1,hasReplace:!1,hPath:me().join(Ft(i.notebookId),r.data),idPath:[me().join(i.notebookId,i.path)]})}break;case"addToDatabase":s?mo(o):Ms(i,l);break;case"move":if(s){const r=ol(o);Wn((c,d)=>{rl(r,d[0],c[0])},r)}else{const r=B(l.startContainer);if((a=i.title)!=null&&a.editElement.contains(l.startContainer)||!r||window.siyuan.menus.menu.element.getAttribute("data-name")==="titleMenu")Wn((c,d)=>{rl([i.path],d[0],c[0])},[i.path],l);else if(r&&l&&i.element.contains(l.startContainer)){let c=Array.from(i.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));c.length===0&&(c=[r]),Wn(d=>{ro(d[0],c,i)})}}break}}}),Ep=(e,t)=>{var n;const a=new Ke("topBarPlugin");let s=!1;if(e.plugins.forEach(i=>{const l=i.setting||i.__proto__.hasOwnProperty("openSetting");let o=!1;i.topBarIcons.forEach(r=>{const c=window.siyuan.storage[f.LOCAL_PLUGINTOPUNPIN].includes(r.id),d=[{icon:c?"iconPin":"iconUnpin",label:c?window.siyuan.languages.pin:window.siyuan.languages.unpin,click(){c?(window.siyuan.storage[f.LOCAL_PLUGINTOPUNPIN].splice(window.siyuan.storage[f.LOCAL_PLUGINTOPUNPIN].indexOf(r.id),1),r.classList.remove("fn__none")):(window.siyuan.storage[f.LOCAL_PLUGINTOPUNPIN].push(r.id),window.siyuan.storage[f.LOCAL_PLUGINTOPUNPIN]=Array.from(new Set(window.siyuan.storage[f.LOCAL_PLUGINTOPUNPIN])),r.classList.add("fn__none")),Ae(f.LOCAL_PLUGINTOPUNPIN,window.siyuan.storage[f.LOCAL_PLUGINTOPUNPIN])}}];l&&d.push({icon:"iconSettings",label:window.siyuan.languages.config,click(){i.openSetting()}});const u=t?r.getAttribute("aria-label"):r.textContent.trim();t||d.push({icon:"iconPlay",label:u,click(){return r.dispatchEvent(new CustomEvent("click")),!0}});const p={icon:"iconInfo",label:u,click:t?()=>{r.dispatchEvent(new CustomEvent("click"))}:void 0,type:"submenu",submenu:d};if(r.querySelector("use"))p.icon=r.querySelector("use").getAttribute("xlink:href").replace("#","");else{const g=r.querySelector("svg").cloneNode(!0);g.classList.add("b3-menu__icon"),p.iconHTML=g.outerHTML}a.addItem(p),s=!0,o=!0}),!o&&l&&(s=!0,a.addItem({icon:"iconSettings",label:i.displayName,click(){i.openSetting()}}))}),s||(t?(n=window.siyuan.menus.menu.element.querySelector(".b3-menu__separator"))==null||n.remove():a.addItem({iconHTML:"",type:"readonly",label:window.siyuan.languages.emptyContent})),t){let i=t.getBoundingClientRect();i.width===0&&(i=document.querySelector("#barMore").getBoundingClientRect()),a.open({x:i.right,y:i.bottom,isLeft:!0})}else a.fullscreen()},Lp=()=>{sn({title:window.siyuan.languages.editor,icon:"iconEdit",html:`<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.fileTree18}
        <div class="b3-label__text">${window.siyuan.languages.fileTree19}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="allowCreateDeeper" type="checkbox"${window.siyuan.config.fileTree.allowCreateDeeper?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.fileTree3}
        <div class="b3-label__text">${window.siyuan.languages.fileTree4}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="removeDocWithoutConfirm" type="checkbox"${window.siyuan.config.fileTree.removeDocWithoutConfirm?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.fileTree20}
        <div class="b3-label__text">${window.siyuan.languages.fileTree21}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="useSingleLineSave" type="checkbox"${window.siyuan.config.fileTree.useSingleLineSave?" checked":""}/>
</label>
<div class="b3-label">
    ${window.siyuan.languages.fileTree16}
    <span class="fn__hr"></span>
    <input class="b3-text-field fn__block" id="maxListCount" type="number" min="1" max="10240" value="${window.siyuan.config.fileTree.maxListCount}">
    <div class="b3-label__text">${window.siyuan.languages.fileTree17}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.fileTree12}
    <span class="fn__hr"></span>
    <select class="b3-select fn__block" id="docCreateSaveBox">${Bs(window.siyuan.config.fileTree.docCreateSaveBox)}</select>
    <span class="fn__hr"></span>
    <input class="b3-text-field fn__block" id="docCreateSavePath" value="">
    <div class="b3-label__text">${window.siyuan.languages.fileTree13}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.fileTree5}
    <span class="fn__hr"></span>
    <select class="b3-select fn__block" id="refCreateSaveBox">${Bs(window.siyuan.config.fileTree.refCreateSaveBox)}</select>
    <span class="fn__hr"></span>
    <input class="b3-text-field fn__block" id="refCreateSavePath" value="${window.siyuan.config.fileTree.refCreateSavePath}">
    <div class="b3-label__text">${window.siyuan.languages.fileTree6}</div>
</div>`,bindEvent(e){e.querySelector("#docCreateSavePath").value=window.siyuan.config.fileTree.docCreateSavePath,e.querySelector("#refCreateSavePath").value=window.siyuan.config.fileTree.refCreateSavePath,e.querySelectorAll("input, select").forEach(t=>{t.addEventListener("change",()=>{A("/api/setting/setFiletree",{sort:window.siyuan.config.fileTree.sort,alwaysSelectOpenedFile:window.siyuan.config.fileTree.alwaysSelectOpenedFile,refCreateSavePath:e.querySelector("#refCreateSavePath").value,refCreateSaveBox:e.querySelector("#refCreateSaveBox").value,docCreateSavePath:e.querySelector("#docCreateSavePath").value,docCreateSaveBox:e.querySelector("#docCreateSaveBox").value,openFilesUseCurrentTab:window.siyuan.config.fileTree.openFilesUseCurrentTab,closeTabsOnStart:window.siyuan.config.fileTree.closeTabsOnStart,allowCreateDeeper:e.querySelector("#allowCreateDeeper").checked,removeDocWithoutConfirm:e.querySelector("#removeDocWithoutConfirm").checked,useSingleLineSave:e.querySelector("#useSingleLineSave").checked,maxListCount:parseInt(e.querySelector("#maxListCount").value),maxOpenTabCount:window.siyuan.config.fileTree.maxOpenTabCount},n=>{window.siyuan.config.fileTree=n.data})})})}})},Na=()=>{fn(),tn(),document.getElementById("menu").style.transform="translateX(0px)"},Sp=e=>{const t=document.getElementById("menu");let n="";window.siyuan.user&&!window.siyuan.config.readonly?n=`<div class="b3-menu__item" id="menuAccount">
    <img class="b3-menu__icon" src="${window.siyuan.user.userAvatarURL}"/>
    <span class="b3-menu__label">${window.siyuan.user.userName}</span>
</div>`:window.siyuan.config.readonly||(n=`<div class="b3-menu__item" id="menuAccount">
    <svg class="b3-menu__icon"><use xlink:href="#iconAccount"></use></svg><span class="b3-menu__label">${window.siyuan.languages.login}</span>
</div>`);let a=`<div class="b3-menu__item${window.siyuan.config.readonly?" fn__none":""}" id="menuAI">
        <svg class="b3-menu__icon"><use xlink:href="#iconSparkles"></use></svg><span class="b3-menu__label">AI</span>
    </div>`;($o()||Io("ai"))&&(a=""),t.innerHTML=`<div class="b3-menu__title">
    <svg class="b3-menu__icon"><use xlink:href="#iconLeft"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.back}</span>
</div>
<div class="b3-menu__items">
    ${n}
    <div id="menuRecent" class="b3-menu__item">
        <svg class="b3-menu__icon"><use xlink:href="#iconList"></use></svg><span class="b3-menu__label">${window.siyuan.languages.recentDocs}</span>
    </div>
    <div id="menuSearch" class="b3-menu__item">
        <svg class="b3-menu__icon"><use xlink:href="#iconSearch"></use></svg><span class="b3-menu__label">${window.siyuan.languages.search}</span>
    </div>
    <div id="menuCommand" class="b3-menu__item">
        <svg class="b3-menu__icon"><use xlink:href="#iconTerminal"></use></svg><span class="b3-menu__label">${window.siyuan.languages.commandPanel}</span>
    </div>
    <div class="b3-menu__item${window.siyuan.config.readonly?" fn__none":""}" id="menuSyncNow">
        <svg class="b3-menu__icon"><use xlink:href="#iconCloudSucc"></use></svg><span class="b3-menu__label">${window.siyuan.languages.syncNow}</span>
    </div>
    <div class="b3-menu__item${window.siyuan.config.readonly?" fn__none":""}" id="menuNewDoc">
        <svg class="b3-menu__icon"><use xlink:href="#iconFile"></use></svg><span class="b3-menu__label">${window.siyuan.languages.newFile}</span>
    </div>
    <div class="b3-menu__item${window.siyuan.config.readonly?" fn__none":""}" id="menuNewNotebook">
        <svg class="b3-menu__icon"><use xlink:href="#iconFilesRoot"></use></svg><span class="b3-menu__label">${window.siyuan.languages.newNotebook}</span>
    </div>
    <div class="b3-menu__separator"></div>
    <div id="menuNewDaily" class="b3-menu__item${window.siyuan.config.readonly?" fn__none":""}">
        <svg class="b3-menu__icon"><use xlink:href="#iconCalendar"></use></svg><span class="b3-menu__label">${window.siyuan.languages.dailyNote}</span>
    </div>
    <div id="menuCard" class="b3-menu__item${window.siyuan.config.readonly?" fn__none":""}">
        <svg class="b3-menu__icon" style="color: var(--b3-theme-secondary)"><use xlink:href="#iconRiffCard"></use></svg><span class="b3-menu__label">${window.siyuan.languages.spaceRepetition}</span>
    </div>
    <div class="b3-menu__item${window.siyuan.config.readonly?" fn__none":""}" id="menuLock">
        <svg class="b3-menu__icon"><use xlink:href="#iconLock"></use></svg><span class="b3-menu__label">${window.siyuan.languages.lockScreen}</span>
    </div>
    <div class="b3-menu__item${window.siyuan.config.readonly?" fn__none":""}" id="menuHistory">
        <svg class="b3-menu__icon"><use xlink:href="#iconHistory"></use></svg><span class="b3-menu__label">${window.siyuan.languages.dataHistory}</span>
    </div>
    <div class="b3-menu__separator${ft()||Qt()||yt()?"":" fn__none"}"></div>
    <div class="b3-menu__item b3-menu__item--warning${ft()||Qt()||yt()?"":" fn__none"}" id="menuSafeQuit">
        <svg class="b3-menu__icon"><use xlink:href="#iconQuit"></use></svg><span class="b3-menu__label">${window.siyuan.languages.safeQuit}</span>
    </div>
    <div class="b3-menu__separator"></div>
    <div class="b3-menu__item${window.siyuan.config.readonly?" fn__none":""}" id="menuEditor">
        <svg class="b3-menu__icon"><use xlink:href="#iconEdit"></use></svg><span class="b3-menu__label">${window.siyuan.languages.editor}</span>
    </div>
    <div class="b3-menu__item${window.siyuan.config.readonly?" fn__none":""}" id="menuFileTree">
        <svg class="b3-menu__icon"><use xlink:href="#iconFiles"></use></svg><span class="b3-menu__label">${window.siyuan.languages.fileTree}</span>
    </div>
    <div class="b3-menu__item${window.siyuan.config.readonly?" fn__none":""}" id="menuRiffCard">
        <svg class="b3-menu__icon"><use xlink:href="#iconRiffCard"></use></svg><span class="b3-menu__label">${window.siyuan.languages.riffCard}</span>
    </div>
    ${a}
    <div class="b3-menu__item${window.siyuan.config.readonly?" fn__none":""}" id="menuAppearance">
        <svg class="b3-menu__icon"><use xlink:href="#iconTheme"></use></svg><span class="b3-menu__label">${window.siyuan.languages.appearance}</span>
    </div>
    <div id="menuSync" class="b3-menu__item${window.siyuan.config.readonly?" fn__none":""}">
        <svg class="b3-menu__icon"><use xlink:href="#iconCloud"></use></svg><span class="b3-menu__label">${window.siyuan.languages.cloud}</span>
    </div>
    <div class="b3-menu__item" id="menuAbout">
        <svg class="b3-menu__icon"><use xlink:href="#iconInfo"></use></svg><span class="b3-menu__label">${window.siyuan.languages.about}</span>
    </div>
    <div class="b3-menu__item" id="menuPlugin">
        <svg class="b3-menu__icon"><use xlink:href="#iconPlugin"></use></svg><span class="b3-menu__label">${window.siyuan.languages.plugin}</span>
    </div>
    <div class="b3-menu__separator"></div>
    <div class="b3-menu__item${Dn()||window.siyuan.config.readonly?" fn__none":""}" id="menuHelp">
        <svg class="b3-menu__icon"><use xlink:href="#iconHelp"></use></svg><span class="b3-menu__label">${window.siyuan.languages.userGuide}</span>
    </div>
    <a class="b3-menu__item" href="${window.siyuan.config.lang==="zh_CN"||window.siyuan.config.lang==="zh_CHT"?"https://ld246.com/article/1649901726096":"https://liuyun.io/article/1686530886208"}" target="_blank">
        <svg class="b3-menu__icon"><use xlink:href="#iconFeedback"></use></svg>
        <span class="b3-menu__label">${window.siyuan.languages.feedback}</span>
    </a>
</div>`,Cn(),e.plugins.forEach(s=>{So(s)}),t.addEventListener("click",s=>{let i=s.target;for(;i&&!i.isEqualNode(t);){if(i.classList.contains("b3-menu__title")){Ve(),s.preventDefault(),s.stopPropagation();break}else if(i.id==="menuCommand"){Ve(),kp(e),s.preventDefault(),s.stopPropagation();break}else if(i.id==="menuSearch"){qt(e),s.preventDefault(),s.stopPropagation();break}else if(i.id==="menuRecent"){Ql(e),s.preventDefault(),s.stopPropagation();break}else if(i.id==="menuAppearance"){rp(),s.preventDefault(),s.stopPropagation();break}else if(i.id==="menuAI"){dp(),s.preventDefault(),s.stopPropagation();break}else if(i.id==="menuRiffCard"){up(),s.preventDefault(),s.stopPropagation();break}else if(i.id==="menuEditor"){bp(),s.preventDefault(),s.stopPropagation();break}else if(i.id==="menuFileTree"){Lp(),s.preventDefault(),s.stopPropagation();break}else if(i.id==="menuSafeQuit"){s.preventDefault(),s.stopPropagation(),Da();break}else if(i.id==="menuAbout"){mp(),s.preventDefault(),s.stopPropagation();break}else if(i.id==="menuPlugin"){Ep(e),s.preventDefault(),s.stopPropagation();break}else if(i.id==="menuNewDaily"){zc(e),Ve(),s.preventDefault(),s.stopPropagation();break}else if(i.id==="menuCard"){bd(e),Ve(),s.preventDefault(),s.stopPropagation();break}else if(i.id==="menuNewNotebook"){Jl(),Ve(),s.preventDefault(),s.stopPropagation();break}else if(i.id==="menuNewDoc"){aa({app:e,useSavePath:!0}),Ve(),s.preventDefault(),s.stopPropagation();break}else if(i.id==="menuHelp"){Xl(),s.preventDefault(),s.stopPropagation();break}else if(i.id==="menuLock"){io(e),s.preventDefault(),s.stopPropagation();break}else if(i.id==="menuSync"){sn({title:window.siyuan.languages.cloud,icon:"iconCloud",html:gt.genHTML(),bindEvent(l){gt.element=l,gt.bindEvent()}}),s.preventDefault(),s.stopPropagation();break}else if(i.id==="menuSyncNow"){ho(),s.preventDefault(),s.stopPropagation();break}else if(i.id==="menuHistory"){no(e),s.preventDefault(),s.stopPropagation();break}else if(i.id==="menuAccount"){if(s.preventDefault(),s.stopPropagation(),document.querySelector("#menuAccount img")){Md();return}pp();break}i=i.parentElement}})},$m=(e,t,n)=>{switch(e){case"filetree":t.innerHTML=fileTree.genHTML(),fileTree.element=t,fileTree.bindEvent();break;case"AI":t.innerHTML=ai.genHTML(),ai.element=t,ai.bindEvent();break;case"card":t.innerHTML=flashcard.genHTML(),flashcard.element=t,flashcard.bindEvent();break;case"image":t.innerHTML=image.genHTML(),image.element=t,image.bindEvent();break;case"export":t.innerHTML=exportConfig.genHTML(),exportConfig.element=t,exportConfig.bindEvent();break;case"appearance":t.innerHTML=appearance.genHTML(),appearance.element=t,appearance.bindEvent();break;case"keymap":t.innerHTML=keymap.genHTML(n),keymap.element=t,keymap.bindEvent(n);break;case"bazaar":bazaar.element=t,t.innerHTML=bazaar.genHTML(),bazaar.bindEvent(n);break;case"account":t.innerHTML=account.genHTML(),account.element=t,account.bindEvent(account.element);break;case"repos":t.innerHTML=repos.genHTML(),repos.element=t,repos.bindEvent();break;case"about":t.innerHTML=about.genHTML(),about.element=t,about.bindEvent();break;case"search":t.innerHTML=query.genHTML(),query.element=t,query.bindEvent();break;case"publish":t.innerHTML=publish.genHTML(),publish.element=t,publish.bindEvent();break;default:break}},xp=e=>{Na()};let Rd,Bd;Rd=()=>{},Bd=()=>{};const Ap={adaptHotkey:Me,confirm:$e,Constants:f,showMessage:ae,fetchPost:A,fetchSyncPost:Ye,fetchGet:so,getFrontend:de,getBackend:ce,getModelByDockType:e=>window.siyuan.mobile.docks[e],openTab:Rd,openWindow:Bd,openMobileFileById:at,lockScreen:io,exitSiYuan:Da,Protyle:Yn,Plugin:Td,Dialog:we,Menu:Ke,Setting:lp,getAllEditor:ba,getAllModels:Zs,platformUtils:Ge,openSetting:xp},Cp=(e,t,n=!1)=>{e.plugins.find((a,s)=>{if(a.name===t){try{a.onunload(),n&&(a.uninstall(),window.siyuan.storage[f.LOCAL_PLUGIN_DOCKS][a.name]={},Ae(f.LOCAL_PLUGIN_DOCKS,window.siyuan.storage[f.LOCAL_PLUGIN_DOCKS]))}catch(l){console.error(`plugin ${a.name} onunload error:`,l)}return a.topBarIcons.forEach(l=>{l.remove()}),Object.keys(a.docks).forEach(l=>{Object.keys(window.siyuan.layout.leftDock.data).includes(l)?window.siyuan.layout.leftDock.remove(l):Object.keys(window.siyuan.layout.rightDock.data).includes(l)?window.siyuan.layout.rightDock.remove(l):Object.keys(window.siyuan.layout.bottomDock.data).includes(l)&&window.siyuan.layout.bottomDock.remove(l)}),Array.from(document.childNodes).find(l=>{if(l.nodeType===8&&l.textContent===t)return l.remove(),!0}),e.plugins.splice(s,1),ba().forEach(l=>{l.protyle.toolbar.update(l.protyle)}),!0}})};var Fs=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{o(n.next(r))}catch(c){s(c)}},l=r=>{try{o(n.throw(r))}catch(c){s(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,l);o((n=n.apply(e,t)).next())});const Ud=e=>{var t,n;return(n={siyuan:Ap}[e])!=null?n:(t=window.require)==null?void 0:t.call(window,e)};window.require instanceof Function&&(Ud.__proto__=window.require);const Tp=(e,t)=>window.eval("(function anonymous(require, module, exports){".concat(e,`
})
//# sourceURL=`).concat(t,`
`)),Yd=(e,t)=>Fs(void 0,null,function*(){const n=yield Ye("/api/petal/loadPetals",{frontend:de()});let a="";n.data.forEach(i=>{(!t||t&&t.includes(i.name))&&Fd(e,i),a+=i.css||`
`});const s=document.getElementById("pluginsStyle");s?s.innerHTML=a:document.head.insertAdjacentHTML("beforeend",`<style id="pluginsStyle">${a}</style>`)}),Fd=(e,t)=>Fs(void 0,null,function*(){const n={},a={exports:n};try{Tp(t.js,"plugin:"+encodeURIComponent(t.name))(Ud,a,n)}catch(l){console.error(`plugin ${t.name} run error:`,l);return}const s=(a.exports||n).default||a.exports;if(typeof s!="function"){console.error(`plugin ${t.name} has no export`);return}if(!(s.prototype instanceof Td)){console.error(`plugin ${t.name} does not extends Plugin`);return}const i=new s({app:e,displayName:t.displayName,name:t.name,i18n:t.i18n});e.plugins.push(i);try{yield i.onload()}catch(l){console.error(`plugin ${t.name} onload error:`,l)}return i}),Dm=(e,t)=>Fs(void 0,null,function*(){const n=yield Fd(e,t),a=document.createElement("style");return a.textContent=t.css,document.head.append(a),So(n),saveLayout(),getAllEditor().forEach(s=>{s.protyle.toolbar.update(s.protyle)}),n}),Mm=(e,t,n,a)=>{const s=Object.keys(n.docks);e.forEach((i,l)=>{s.includes(i.type)&&(a==="Left"?n.docks[i.type].config.position=t===0?"LeftTop":"LeftBottom":a==="Right"?n.docks[i.type].config.position=t===0?"RightTop":"RightBottom":a==="Bottom"&&(n.docks[i.type].config.position=t===0?"BottomLeft":"BottomRight"),n.docks[i.type].config.index=l,n.docks[i.type].config.show=i.show,n.docks[i.type].config.size=i.size,window.siyuan.storage[Constants.LOCAL_PLUGIN_DOCKS][n.name]||(window.siyuan.storage[Constants.LOCAL_PLUGIN_DOCKS][n.name]={}),window.siyuan.storage[Constants.LOCAL_PLUGIN_DOCKS][n.name][i.type]=n.docks[i.type].config,setStorageVal(Constants.LOCAL_PLUGIN_DOCKS,window.siyuan.storage[Constants.LOCAL_PLUGIN_DOCKS]))})},So=e=>{try{e.onLayoutReady()}catch(t){console.error(`plugin ${e.name} onLayoutReady error:`,t)}(!ie()||H())&&e.topBarIcons.forEach(t=>{H()?window.siyuan.storage[f.LOCAL_PLUGINTOPUNPIN].includes(t.id)||document.querySelector("#menuAbout").after(t):ie()||(window.siyuan.storage[f.LOCAL_PLUGINTOPUNPIN].includes(t.id)&&t.classList.add("fn__none"),document.querySelector("#"+(t.getAttribute("data-location")==="right"?"barPlugins":"drag")).before(t))}),ie()},$p=(e,t)=>Fs(void 0,null,function*(){t.removePlugins.concat(t.upsertPlugins).forEach(n=>{Cp(e,n)}),Yd(e,t.upsertPlugins).then(()=>{e.plugins.forEach(n=>{t.upsertPlugins.includes(n.name)&&So(n)})})}),Ip=(e,t)=>{if(t)switch(t.cmd){case"setDefRefCount":yg(t.data);break;case"setRefDynamicText":bg(t.data);break;case"reloadPlugin":$p(e,t.data);break;case"reloadEmojiConf":ru();break;case"syncMergeResult":ao(e,t.data);break;case"setConf":window.siyuan.config=t.data;break;case"reloaddoc":ao(void 0,{upsertRootIDs:[t.data],removeRootIDs:[]},!1,!1,!0);break;case"readonly":window.siyuan.config.editor.readOnly=t.data;break;case"progress":_g(t);break;case"syncing":Cn(t,e.plugins),t.code===1&&document.getElementById("toolbarSync").classList.add("fn__none");break;case"openFileById":at(e,t.data.id);break;case"txerr":wg();break;case"statusbar":hg(t);break}};class Dp{constructor(t){this.menu=new xu}getDir(t){const n=ee(t,"UL");if(n)return n.getAttribute("data-url")}unselect(){getSelection().rangeCount>0&&getSelection().getRangeAt(0).collapse(!0)}}const Mp=e=>{var t;const n=e.target,a=$(n,"protyle-background");if(a&&n.tagName==="IMG"&&a.firstElementChild.querySelector(".protyle-icons").classList.contains("fn__none")){const s=$(n,"protyle-content",!0);if(!s)return!1;s.style.overflow="hidden";const i=e.touches[0].clientY,l=n.naturalHeight*n.clientWidth/n.naturalWidth-n.clientHeight;let o=parseFloat(n.style.objectPosition.substring(7))||50;n.style.objectPosition.endsWith("px")&&(o=-parseInt(n.style.objectPosition.substring(7))/l*100);const r=document;return r.ontouchmove=c=>{n.style.objectPosition=`center ${((i-c.touches[0].clientY)/l*100+o).toFixed(2)}%`},r.ontouchend=()=>{s.style.overflow="",r.ontouchmove=null,r.ontouchstart=null,r.ondragstart=null,r.onselectstart=null,r.onselect=null},e.stopImmediatePropagation(),!0}return a?a.classList.contains("protyle-background--enable")&&a.classList.add("protyle-background--mobileshow"):(t=document.querySelector(".protyle-background--mobileshow"))==null||t.classList.remove("protyle-background--mobileshow"),!1},Hp=(e,t,n,a)=>{const s=e.target,i=gi();if(typeof t=="undefined"&&new Date().getTime()-n>900){const l=D(s,"data-type","navigation-root")||D(s,"data-type","navigation-file");if(l){if(!window.siyuan.config.readonly&&l.dataset.type==="navigation-root"){const o=Ed(a,l);if(i){const r=l.getBoundingClientRect();o.popup({x:r.right-52,y:r.bottom,h:r.height}),un()}else window.siyuan.menus.menu.fullscreen("bottom")}else if(l.dataset.type==="navigation-file"){const o=ee(l,"UL");if(o){const r=Ld(a,o.dataset.url,l.dataset.path,l);if(i){const c=l.getBoundingClientRect();r.popup({x:c.right-52,y:c.bottom,h:c.height}),un()}else window.siyuan.menus.menu.fullscreen("bottom")}}return!0}if(s.tagName==="SPAN"&&!re(s)){let o;if($(s,"protyle-wysiwyg",!0)&&(o=Dt()),!o)return!1;const r=(s.getAttribute("data-type")||"").split(" ");if(r.includes("inline-memo")&&o.protyle.toolbar.showRender(o.protyle,s),o.protyle.disabled)return e.stopImmediatePropagation(),e.preventDefault(),!0;if(r.includes("block-ref"))return Il(o.protyle,s),!0;if(r.includes("file-annotation-ref"))return $l(o.protyle,s),!0;if(r.includes("tag"))return Hl(o.protyle,s),!0;if(r.includes("a"))return Ai(o.protyle,s),!0;const c=D(s,"data-type","inline-math");if(c)return bs(o.protyle,c),!0}}return!1};let ji,Vi,mt,ga,Ws,Tn,Pa,bn,js,Vs=!0;const zs=(e=!0)=>{e?document.getElementById("toolbarFile").dispatchEvent(new CustomEvent("click")):(tn(),fn(),document.getElementById("sidebar").style.transform="translateX(0px)")},Np=(e,t)=>{if(Dn()&&Hp(e,ga,Ws,t)){e.stopImmediatePropagation(),e.preventDefault();return}Vs=!0;const n=e.target;if(!Vi||typeof ga=="undefined"||n.tagName==="AUDIO"||$(n,"b3-dialog",!0)||window.siyuan.mobile.editor&&!window.siyuan.mobile.editor.protyle.toolbar.subElement.classList.contains("fn__none")||$(n,"viewer-container")||$(n,"keyboard")||D(n,"id","commonMenu"))return;if(window.siyuan.mobile.editor&&(window.siyuan.mobile.editor.protyle.contentElement.style.overflow=""),ji=null,js){Ve();return}let a=!1;(new Date().getTime()-Ws<1e3||Math.abs(mt)>window.innerWidth/3)&&(a=!0);const s=Math.abs(mt)>Math.abs(ga);if(D(n,"id","model",!0)){s&&Tn==="toRight"&&!bn&&_l();return}if(D(n,"id","menu")){s?Tn==="toRight"?bn?Na():Ve():bn?Ve():Na():Na();return}if(D(n,"id","sidebar")){s?Tn==="toLeft"?bn?zs(!1):Ve():bn?Ve():zs(!1):zs(!1);return}if(!a||!s){Ve();return}mt>0?bn?Ve():Na():bn?Ve():zs()},Pp=e=>{Mp(e)||(Tn=null,mt=void 0,ga=void 0,bn=void 0,Pa=void 0,Dn()||e.touches[0].clientX>8&&e.touches[0].clientX<window.innerWidth-8?(ji=e.touches[0].clientX,Vi=e.touches[0].clientY,Ws=new Date().getTime()):(ji=null,Vi=null,Ws=0,e.stopImmediatePropagation()),Vs=!0,js=!1)};let Gs;const xo=document.querySelector(".side-mask"),qp=e=>{const t=e.target;if(!(!ji||!Vi||t.tagName==="AUDIO"||$(t,"b3-dialog",!0)||window.siyuan.mobile.editor&&!window.siyuan.mobile.editor.protyle.toolbar.subElement.classList.contains("fn__none")||$(t,"keyboard")||$(t,"viewer-container")||D(t,"id","commonMenu")||Pa==="y")&&document.querySelector("#keyboardToolbar").classList.contains("fn__none")){if(getSelection().rangeCount>0){const n=getSelection().getRangeAt(0);if(n.toString()!==""&&window.siyuan.mobile.editor.protyle.wysiwyg.element.contains(n.startContainer))return}if(mt=Math.floor(ji-e.touches[0].clientX),ga=Math.floor(Vi-e.touches[0].clientY),Tn||(Tn=mt>0?"toLeft":"toRight"),Pa||(Math.abs(mt)>Math.abs(ga)?Pa="x":Pa="y",Pa==="x"&&(D(t,"id","menu")&&Tn==="toLeft"||D(t,"id","sidebar")&&Tn==="toRight")&&(Pa="y",ga=void 0)),Gs&&(Tn==="toRight"?Gs>e.touches[0].clientX?bn=e.touches[0].clientX:bn=void 0:Tn==="toLeft"&&(Gs<e.touches[0].clientX?bn=e.touches[0].clientX:bn=void 0)),Gs=e.touches[0].clientX,Math.abs(mt)>Math.abs(ga)){if(D(t,"id","model",!0))return;let n=D(t,"data-type","NodeCodeBlock")||D(t,"data-type","NodeAttributeView")||D(t,"data-type","NodeMathBlock")||D(t,"data-type","NodeTable")||Q(t,"list");if(n){if(n.classList.contains("table"))n=n.firstElementChild;else if(n.classList.contains("code-block"))n=n.firstElementChild.nextElementSibling;else if(n.classList.contains("av"))n=$(t,"layout-tab-bar")||$(t,"av__scroll");else if(n.dataset.type==="NodeMathBlock")for(n=t;n&&n.dataset.type!=="NodeMathBlock"&&!(n.nodeType===1&&n.scrollLeft>0);)n=n.parentElement;if(n&&(mt<0&&n.scrollLeft>0||mt>0&&n.clientWidth+n.scrollLeft<n.scrollWidth)){js=!0;return}if(js)return}Vs&&(xo.style.zIndex=(++window.siyuan.zIndex).toString(),document.getElementById("sidebar").style.zIndex=(++window.siyuan.zIndex).toString(),document.getElementById("menu").style.zIndex=(++window.siyuan.zIndex).toString(),Vs=!1);const a=window.innerWidth,s=D(t,"id","menu");if(s){mt<0?(s.style.transform=`translateX(${-mt}px)`,oi(-mt/a)):(s.style.transform="translateX(0px)",oi(0));return}const i=D(t,"id","sidebar");if(i){mt>0?(i.style.transform=`translateX(${-mt}px)`,oi(mt/a)):(i.style.transform="translateX(0px)",oi(0));return}Tn==="toRight"?(document.getElementById("sidebar").style.transform=`translateX(${Math.min(-mt-a,0)}px)`,oi((a+mt)/a)):(document.getElementById("menu").style.transform=`translateX(${Math.max(a-mt,0)}px)`,oi((a-mt)/a)),fn(),tn(),window.siyuan.mobile.editor&&(window.siyuan.mobile.editor.protyle.contentElement.style.overflow="hidden")}}},oi=e=>{xo.classList.remove("fn__none"),xo.style.opacity=Math.min(1-e,.68).toString()},Wd=()=>{A("/api/snippet/getSnippet",{type:"all",enabled:2},e=>{e.data.snippets.forEach(t=>{const n=`snippet${t.type==="css"?"CSS":"JS"}${t.id}`;let a=document.getElementById(n);if(!window.siyuan.config.snippet.enabledCSS&&t.type==="css"||!window.siyuan.config.snippet.enabledJS&&t.type==="js"){a&&a.remove();return}if(!t.enabled){a&&a.remove();return}if(a){if(a.innerHTML===t.content)return;a.remove()}t.type==="css"?document.head.insertAdjacentHTML("beforeend",`<style id="${n}">${t.content}</style>`):t.type==="js"&&(a=document.createElement("script"),a.type="text/javascript",a.text=t.content,a.id=n,document.head.appendChild(a))})})},Hm=()=>{fetchPost("/api/snippet/getSnippet",{type:"all",enabled:2},e=>{let t="",n="";e.data.snippets.forEach(i=>{i.type==="css"?t+=Ao(i):n+=Ao(i)});const a=new Dialog({width:"70vw",height:"80vh",content:`<div class="layout-tab-bar fn__flex fn__flex-shrink" style="border-radius: var(--b3-border-radius-b) var(--b3-border-radius-b) 0 0">
    <div data-type="css" class="item item--full item--focus"><span class="fn__flex-1"></span><span class="item__text">CSS</span><span class="fn__flex-1"></span></div>
    <div data-type="js" class="item item--full"><span class="fn__flex-1"></span><span class="item__text">JS</span><span class="fn__flex-1"></span></div>
</div>
<div class="fn__flex-1" style="overflow:auto;padding: 16px 24px">
    <div>
        <div class="fn__flex">
            <div class="fn__flex-1"></div>
            <div class="b3-form__icon">
                <svg class="b3-form__icon-icon"><use xlink:href="#iconSearch"></use></svg>
                <input data-type="css" data-action="search" type="text" placeholder="${window.siyuan.languages.search}" class="b3-text-field b3-form__icon-input">
            </div>
            <div class="fn__space"></div>
            <span aria-label="${window.siyuan.languages.addAttr} CSS" id="addCodeSnippetCSS" class="b3-tooltips b3-tooltips__sw block__icon block__icon--show">
                <svg><use xlink:href="#iconAdd"></use></svg>
            </span>
            <div class="fn__space"></div>
            <input data-action="toggleCSS" class="b3-switch b3-switch--side fn__flex-center" type="checkbox"${window.siyuan.config.snippet.enabledCSS?" checked":""}>
        </div>
        ${t}
    </div>
    <div class="fn__none">
        <div class="fn__flex">
            <div class="fn__flex-1"></div>
             <div class="b3-form__icon">
                <svg class="b3-form__icon-icon"><use xlink:href="#iconSearch"></use></svg>
                <input data-type="js" data-action="search" type="text" placeholder="${window.siyuan.languages.search}" class="b3-text-field b3-form__icon-input">
            </div>
            <div class="fn__space"></div>
            <span aria-label="${window.siyuan.languages.addAttr} JS" id="addCodeSnippetJS" class="b3-tooltips b3-tooltips__sw block__icon block__icon--show">
                <svg><use xlink:href="#iconAdd"></use></svg>
            </span>
            <div class="fn__space"></div>
            <input data-action="toggleJS" class="b3-switch b3-switch--side fn__flex-center" type="checkbox"${window.siyuan.config.snippet.enabledJS?" checked":""}>
        </div>
        ${n}
    </div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,destroyCallback:i=>{(i==null?void 0:i.cancel)!=="true"&&zd(a,e.data.snippets,s,!0)}});e.data.snippets.forEach(i=>{const l=a.element.querySelector(`[data-id="${i.id}"] input`);l.value=i.name;const o=a.element.querySelector(`[data-id="${i.id}"] textarea`);o.textContent=i.content});const s=[];a.element.setAttribute("data-key",Constants.DIALOG_SNIPPETS),a.element.addEventListener("click",i=>{let l=i.target;for(;l&&!l.isSameNode(a.element);){if(l.id==="addCodeSnippetCSS"||l.id==="addCodeSnippetJS"){l.parentElement.insertAdjacentHTML("afterend",Ao({type:l.id==="addCodeSnippetCSS"?"css":"js",name:"",content:"",enabled:!1})),i.stopPropagation(),i.preventDefault();break}else if(l.classList.contains("b3-button--cancel")){a.destroy({cancel:"true"}),i.stopPropagation(),i.preventDefault();break}else if(l.classList.contains("b3-button--text")){zd(a,e.data.snippets,s),i.stopPropagation(),i.preventDefault();break}else if(l.classList.contains("item")){l.getAttribute("data-type")==="css"?(l.classList.add("item--focus"),l.nextElementSibling.classList.remove("item--focus"),l.parentElement.nextElementSibling.firstElementChild.classList.remove("fn__none"),l.parentElement.nextElementSibling.lastElementChild.classList.add("fn__none")):(l.classList.add("item--focus"),l.previousElementSibling.classList.remove("item--focus"),l.parentElement.nextElementSibling.firstElementChild.classList.add("fn__none"),l.parentElement.nextElementSibling.lastElementChild.classList.remove("fn__none")),i.stopPropagation(),i.preventDefault();break}else if(l.dataset.action==="remove"){const o=l.parentElement.parentElement;s.push("#snippet"+(o.getAttribute("data-type")==="css"?"CSS":"JS")+o.getAttribute("data-id")),o.remove(),i.stopPropagation(),i.preventDefault();break}l=l.parentElement}}),a.element.querySelectorAll('[data-action="search"]').forEach(i=>{i.addEventListener("input",l=>{l.isComposing||jd(a,i)}),i.addEventListener("compositionend",()=>{jd(a,i)})})})},jd=(e,t)=>{e.element.querySelectorAll(`.fn__flex-1 > div > [data-type="${t.dataset.type}"]`).forEach(n=>{const a=n.querySelector("input").value.toLowerCase(),s=n.querySelector("textarea").value.toLowerCase(),i=t.value.toLowerCase();!i||a&&(i.includes(a)||a.includes(i))||s&&(s.includes(i)||i.includes(s))?n.classList.remove("fn__none"):n.classList.add("fn__none")})},Ao=e=>`<div data-id="${e.id||""}" data-type="${e.type}">
    <div class="fn__hr--b"></div>
    <div class="fn__flex">
        <input type="text" class="fn__size200 b3-text-field" placeholder="${window.siyuan.languages.title}">
        <div class="fn__flex-1"></div>
        <div class="fn__space"></div>
        <span aria-label="${window.siyuan.languages.remove}" data-action="remove" class="b3-tooltips b3-tooltips__sw block__icon block__icon--show">
            <svg><use xlink:href="#iconTrashcan"></use></svg>
        </span>
        <div class="fn__space"></div>
        <input data-type="snippet" class="b3-switch b3-switch--side fn__flex-center" type="checkbox"${e.enabled?" checked":""}>
    </div>
    <div class="fn__hr"></div>
    <textarea class="fn__block b3-text-field" placeholder="${window.siyuan.languages.codeSnippet}" style="resize: vertical;font-family:var(--b3-font-family-code)" spellcheck="false"></textarea>
    <div class="fn__hr--b"></div>
</div>`,Vd=(e,t,n)=>{fetchPost("/api/snippet/setSnippet",{snippets:t},()=>{n.forEach(a=>{const s=document.querySelector(a);s&&s.remove()}),window.siyuan.config.snippet.enabledCSS=e.element.querySelector('.b3-switch[data-action="toggleCSS"]').checked,window.siyuan.config.snippet.enabledJS=e.element.querySelector('.b3-switch[data-action="toggleJS"]').checked,fetchPost("/api/setting/setSnippet",window.siyuan.config.snippet),Wd(),e.destroy({cancel:"true"})})},zd=(e,t,n,a=!1)=>{const s=[];e.element.querySelectorAll("[data-id]").forEach(i=>{s.push({id:i.getAttribute("data-id"),name:i.querySelector("input").value,type:i.getAttribute("data-type"),content:i.querySelector("textarea").value,enabled:i.querySelector(".b3-switch").checked})}),objEquals(t,s)&&window.siyuan.config.snippet.enabledCSS===e.element.querySelector('.b3-switch[data-action="toggleCSS"]').checked&&window.siyuan.config.snippet.enabledJS===e.element.querySelector('.b3-switch[data-action="toggleJS"]').checked?e.destroy({cancel:"true"}):a?confirmDialog(window.siyuan.languages.save,window.siyuan.languages.snippetsTip,()=>{Vd(e,s,n)}):Vd(e,s,n)};class Op extends Oi{constructor(t){super({app:t,id:na(),type:"filetree",msgCallback(a){if(a)switch(a.cmd){case"moveDoc":this.onMove(a.data);break;case"reloadFiletree":jn(()=>{this.init(!1)});break;case"mount":this.onMount(a);break;case"createnotebook":jn(s=>{let i;s.find(l=>{if(!l.closed){if(l.id===a.data.box.id)return i?this.element.querySelector(`.b3-list[data-url="${i}"]`).insertAdjacentHTML("afterend",this.genNotebook(a.data.box)):this.element.insertAdjacentHTML("afterbegin",this.genNotebook(a.data.box)),!0;i=l.id}})});break;case"unmount":case"removeDoc":this.onRemove(a);break;case"create":a.data.listDocTree?this.selectItem(a.data.box.id,a.data.path):this.updateItemArrow(a.data.box.id,a.data.path);break;case"createdailynote":case"heading2doc":case"li2doc":this.selectItem(a.data.box.id,a.data.path);break;case"renamenotebook":this.element.querySelector(`[data-url="${a.data.box}"] .b3-list-item__text`).innerHTML=a.data.name;break;case"rename":this.onRename(a.data);break}}}),this.genFileHTML=a=>{let s="";return a.count&&a.count>0&&(s=`<span class="counter">${a.count}</span>`),`<li data-node-id="${a.id}" data-name="${Lute.EscapeHTMLStr(a.name)}" data-type="navigation-file" 
class="b3-list-item" data-path="${a.path}">
    <span style="padding-left: ${(a.path.split("/").length-1)*20}px" class="b3-list-item__toggle${a.subFileCount===0?" fn__hidden":""}">
        <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
    </span>
    <span class="b3-list-item__icon">${ge(a.icon||(a.subFileCount===0?window.siyuan.storage[f.LOCAL_IMAGES].file:window.siyuan.storage[f.LOCAL_IMAGES].folder))}</span>
    <span class="b3-list-item__text">${ct(a.name,!0,!0)}</span>
    <span data-type="more-file" class="b3-list-item__action b3-tooltips b3-tooltips__nw" aria-label="${window.siyuan.languages.more}">
        <svg><use xlink:href="#iconMore"></use></svg>
    </span>
    <span data-type="new" class="b3-list-item__action b3-tooltips b3-tooltips__nw${window.siyuan.config.readonly?" fn__none":""}" aria-label="${window.siyuan.languages.newSubDoc}">
        <svg><use xlink:href="#iconAdd"></use></svg>
    </span>
    ${s}
</li>`};const n=document.querySelector('#sidebar [data-type="sidebar-file"]');n.innerHTML=`<div class="toolbar toolbar--border toolbar--dark">
    <div class="fn__space"></div>
    <div class="toolbar__text">${window.siyuan.languages.fileTree}</div>
    <div class="fn__flex-1 fn__space"></div>
    <svg data-type="newNotebook" class="toolbar__icon"><use xlink:href="#iconFilesRoot"></use></svg>
    <svg data-type="refresh" class="toolbar__icon"><use xlink:href="#iconRefresh"></use></svg>
    <svg data-type="focus" class="toolbar__icon"><use xlink:href="#iconFocus"></use></svg>
    <svg data-type="collapse" class="toolbar__icon"><use xlink:href="#iconContract"></use></svg>
    <svg data-type="sort" class="toolbar__icon${window.siyuan.config.readonly?" fn__none":""}"><use xlink:href="#iconSort"></use></svg>
</div>
<div class="fn__flex-1"></div>
<ul class="b3-list b3-list--background fn__flex-column" style="min-height: auto;height:42px;transition: height  .2s cubic-bezier(0, 0, .2, 1) 0ms">
    <li class="b3-list-item" data-type="toggle">
        <span class="b3-list-item__toggle">
            <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
        </span>
        <span class="b3-list-item__text">${window.siyuan.languages.closeNotebook}</span>
        <span class="counter fn__none" style="cursor: auto"></span>
    </li>
    <ul class="fn__none fn__flex-1"></ul>
</ul>`,this.actionsElement=n.firstElementChild,this.element=this.actionsElement.nextElementSibling,this.closeElement=this.element.nextElementSibling,n.addEventListener("click",a=>{let s=a.target;for(;s&&!s.isEqualNode(this.actionsElement);){const i=s.getAttribute("data-type");if(i==="refresh"){if(!s.getAttribute("disabled")){s.setAttribute("disabled","disabled");const l=[];Array.from(this.element.children).forEach(o=>{l.push(o.getAttribute("data-url"))}),Jc(()=>{s.removeAttribute("disabled"),this.init(!1)})}a.preventDefault();break}else if(i==="focus"){window.siyuan.mobile.editor&&this.selectItem(window.siyuan.mobile.editor.protyle.notebookId,window.siyuan.mobile.editor.protyle.path),a.preventDefault();break}else if(i==="newNotebook")Jl();else if(i==="collapse"){Array.from(this.element.children).forEach(l=>{const o=l.firstElementChild,r=o.querySelector(".b3-list-item__arrow");r.classList.contains("b3-list-item__arrow--open")&&(r.classList.remove("b3-list-item__arrow--open"),o.nextElementSibling.remove())}),a.preventDefault();break}else if(i==="sort"){this.genSort(),a.preventDefault(),a.stopPropagation();break}else if(s.classList.contains("b3-list-item__toggle")&&!s.classList.contains("fn__hidden")&&s.parentElement.getAttribute("data-type")!=="toggle"){const l=ee(s,"UL");if(l){const o=l.getAttribute("data-url");this.getLeaf(s.parentElement,o),this.setCurrent(s.parentElement),window.siyuan.menus.menu.remove()}a.preventDefault(),a.stopPropagation();break}else if(i==="toggle"){const l=s.querySelector("svg");l.classList.contains("b3-list-item__arrow--open")?(this.closeElement.style.height="42px",l.classList.remove("b3-list-item__arrow--open"),this.closeElement.lastElementChild.classList.add("fn__none")):(this.closeElement.style.height="40%",l.classList.add("b3-list-item__arrow--open"),this.closeElement.lastElementChild.classList.remove("fn__none")),a.stopPropagation(),a.preventDefault();break}else if(i==="remove"){$e(window.siyuan.languages.deleteOpConfirm,`${window.siyuan.languages.confirmDelete} <b>${pe(s.parentElement.querySelector(".b3-list-item__text").textContent)}</b>?`,()=>{A("/api/notebook/removeNotebook",{notebook:s.getAttribute("data-url"),callback:f.CB_MOUNT_REMOVE})},void 0,!0),a.stopPropagation(),a.preventDefault();break}else if(i==="open"){A("/api/notebook/openNotebook",{notebook:s.getAttribute("data-url")}),a.stopPropagation(),a.preventDefault();break}else if(s.classList.contains("b3-list-item__action")){const l=s.getAttribute("data-type"),o=s.parentElement.getAttribute("data-path"),r=ee(s,"UL");if(r){const c=r.getAttribute("data-url");window.siyuan.config.readonly||(l==="new"?aa({app:t,notebookId:c,currentPath:o,useSavePath:!1,listDocTree:!0}):l==="more-root"&&(Ed(t,s.parentElement),window.siyuan.menus.menu.fullscreen("bottom"))),l==="more-file"&&(Ld(t,c,o,s.parentElement),window.siyuan.menus.menu.fullscreen("bottom"))}a.preventDefault(),a.stopPropagation();break}else if(s.tagName==="LI"){if(this.setCurrent(s),s.getAttribute("data-type")==="navigation-file")at(t,s.getAttribute("data-node-id"),[f.CB_GET_SCROLL]);else if(s.getAttribute("data-type")==="navigation-root"){const l=ee(s,"UL");if(l){const o=l.getAttribute("data-url");this.getLeaf(s,o)}}a.preventDefault();break}s=s.parentElement}}),this.init(),window.siyuan.config.openHelp&&Xl()}genSort(){window.siyuan.menus.menu.remove(),Sd("notebooks",window.siyuan.config.fileTree.sort,n=>{window.siyuan.config.fileTree.sort=n,A("/api/setting/setFiletree",{sort:window.siyuan.config.fileTree.sort,alwaysSelectOpenedFile:window.siyuan.config.fileTree.alwaysSelectOpenedFile,refCreateSavePath:window.siyuan.config.fileTree.refCreateSavePath,docCreateSavePath:window.siyuan.config.fileTree.docCreateSavePath,openFilesUseCurrentTab:window.siyuan.config.fileTree.openFilesUseCurrentTab,maxListCount:window.siyuan.config.fileTree.maxListCount},()=>{jn(()=>{this.init(!1)})})}).forEach(n=>{window.siyuan.menus.menu.append(new M(n).element)}),window.siyuan.menus.menu.fullscreen("bottom")}updateItemArrow(t,n){const a=this.element.querySelector(`[data-url="${t}"]`);if(!a)return;let s=n,i;for(;!i;)if(i=a.querySelector(`[data-path="${s}"]`),i){const l=i.querySelector(".fn__hidden");l?l.classList.remove("fn__hidden"):this.getLeaf(i,t,!0);break}else{const l=me().dirname(s);if(l==="/"){a.firstElementChild.querySelector(".b3-list-item__arrow--open")&&this.getLeaf(a.firstElementChild,t,!0);break}else s=l+".sy"}}genNotebook(t){const n=`<span class="b3-list-item__icon b3-tooltips b3-tooltips__e" aria-label="${window.siyuan.languages.changeIcon}">${ge(t.icon||window.siyuan.storage[f.LOCAL_IMAGES].note)}</span>`;return t.closed?`<li data-type="open" data-url="${t.id}" class="b3-list-item">
    <span class="b3-list-item__toggle fn__hidden">
        <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
    </span>
    ${n}
    <span class="b3-list-item__text">${pe(t.name)}</span>
    <span data-type="remove" data-url="${t.id}" class="b3-list-item__action${window.siyuan.config.readonly?" fn__none":""}">
        <svg><use xlink:href="#iconTrashcan"></use></svg>
    </span>
</li>`:`<ul class="b3-list b3-list--background" data-url="${t.id}" data-sortmode="${t.sortMode}">
<li class="b3-list-item" data-type="navigation-root" data-path="/">
    <span class="b3-list-item__toggle${t.closed?" fn__hidden":""}">
        <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
    </span>
    ${n}
    <span class="b3-list-item__text${t.closed?" ft__on-surface":""}">${pe(t.name)}</span>
    <span data-type="more-root" class="b3-list-item__action${window.siyuan.config.readonly||t.closed?" fn__none":""}">
        <svg><use xlink:href="#iconMore"></use></svg>
    </span>
    <span data-type="new" class="b3-list-item__action${window.siyuan.config.readonly||t.closed?" fn__none":""}">
        <svg><use xlink:href="#iconAdd"></use></svg>
    </span>
</li></ul>`}init(t=!0){let n="",a="",s=0;window.siyuan.notebooks.forEach(o=>{o.closed?(s++,a+=this.genNotebook(o)):n+=this.genNotebook(o)}),this.element.innerHTML=n,this.closeElement.lastElementChild.innerHTML=a;const i=this.closeElement.querySelector(".counter");if(i.textContent=s.toString(),s?i.classList.remove("fn__none"):i.classList.add("fn__none"),window.siyuan.storage[f.LOCAL_FILESPATHS].forEach(o=>{o.openPaths.forEach(r=>{this.selectItem(o.notebookId,r,void 0,!1)})}),!t)return;const l=this.closeElement.querySelector("svg");n!==""?(this.closeElement.style.height="30px",l.classList.remove("b3-list-item__arrow--open"),this.closeElement.lastElementChild.classList.add("fn__none")):(this.closeElement.style.height="40%",l.classList.add("b3-list-item__arrow--open"),this.closeElement.lastElementChild.classList.remove("fn__none"))}onMove(t){const n=this.element.querySelector(`ul[data-url="${t.fromNotebook}"] li[data-path="${t.fromPath}"]`);if(n)if(n.nextElementSibling&&n.nextElementSibling.tagName==="UL"&&n.nextElementSibling.remove(),n.parentElement.childElementCount===1){if(n.parentElement.previousElementSibling){n.parentElement.previousElementSibling.querySelector(".b3-list-item__toggle").classList.add("fn__hidden"),n.parentElement.previousElementSibling.querySelector(".b3-list-item__arrow").classList.remove("b3-list-item__arrow--open");const s=n.parentElement.previousElementSibling.querySelector(".b3-list-item__icon");s.innerHTML===ge(window.siyuan.storage[f.LOCAL_IMAGES].folder)&&(s.innerHTML=ge(window.siyuan.storage[f.LOCAL_IMAGES].file))}n.parentElement.remove()}else n.remove();const a=this.element.querySelector(`[data-url="${t.toNotebook}"] li[data-path="${t.toPath}"]`);if(a){const s=a.querySelector(".b3-list-item__icon");s.innerHTML===ge(window.siyuan.storage[f.LOCAL_IMAGES].file)&&(s.innerHTML=ge(window.siyuan.storage[f.LOCAL_IMAGES].folder)),a.querySelector(".b3-list-item__toggle").classList.remove("fn__hidden"),a.querySelector(".b3-list-item__arrow").classList.remove("b3-list-item__arrow--open"),a.nextElementSibling&&a.nextElementSibling.tagName==="UL"&&a.nextElementSibling.remove(),this.getLeaf(a,t.toNotebook)}}onRemove(t){if(t.cmd==="unmount"){if(jn(n=>{const a=this.element.querySelector(`ul[data-url="${t.data.box}"] li[data-path="/"]`);if(a&&(a.parentElement.remove(),f.CB_MOUNT_REMOVE!==t.callback)){let s="";n.find(l=>{l.closed&&(s+=this.genNotebook(l))}),this.closeElement.lastElementChild.innerHTML=s;const i=this.closeElement.querySelector(".counter");i.textContent=(parseInt(i.textContent)+1).toString(),i.classList.remove("fn__none")}}),f.CB_MOUNT_REMOVE===t.callback){const n=this.closeElement.querySelector(`li[data-url="${t.data.box}"]`);if(n){n.remove();const a=this.closeElement.querySelector(".counter");a.textContent=(parseInt(a.textContent)-1).toString(),a.textContent==="0"&&a.classList.add("fn__none")}}return}t.data.ids.forEach(n=>{var a;const s=this.element.querySelector(`li.b3-list-item[data-node-id="${n}"]`);if(s){((a=s.nextElementSibling)==null?void 0:a.tagName)==="UL"&&s.nextElementSibling.remove();const i=s.parentElement.previousElementSibling;if(s.parentElement.childElementCount===1){if(i){const l=i.querySelector("svg");l.classList.remove("b3-list-item__arrow--open"),i.dataset.type!=="navigation-root"&&l.parentElement.classList.add("fn__hidden");const o=l.parentElement.nextElementSibling;o.innerHTML===ge(window.siyuan.storage[f.LOCAL_IMAGES].folder)&&(o.innerHTML=ge(window.siyuan.storage[f.LOCAL_IMAGES].file))}s.parentElement.remove()}else s.remove()}})}onRename(t){const n=this.element.querySelector(`ul[data-url="${t.box}"] li[data-path="${t.path}"]`);n&&(n.setAttribute("data-name",Lute.EscapeHTMLStr(t.title)),n.querySelector(".b3-list-item__text").innerHTML=pe(t.title))}onMount(t){if(t.data.existed)return;const n=this.closeElement.querySelector(`li[data-url="${t.data.box.id}"]`);if(n){n.remove();const a=this.closeElement.querySelector(".counter");a.textContent=(parseInt(a.textContent)-1).toString(),a.textContent==="0"&&a.classList.add("fn__none")}jn(a=>{const s=this.genNotebook(t.data.box);if(this.element.childElementCount===0)this.element.innerHTML=s;else{let i;a.find((l,o)=>{if(l.id===t.data.box.id){for(;o>0;)if(a[o-1].closed)o--;else{i=a[o-1].id;break}return!0}}),i?this.element.querySelector(`[data-url="${i}"]`).insertAdjacentHTML("afterend",s):this.element.insertAdjacentHTML("afterbegin",s)}})}onLsHTML(t){if(t.files.length===0)return;const n=this.element.querySelector(`ul[data-url="${t.box}"] li[data-path="${t.path}"]`);if(!n)return;let a="";t.files.forEach(i=>{a+=this.genFileHTML(i)});let s=n.nextElementSibling;if(s&&s.tagName==="UL"){const i=document.createElement("template");i.innerHTML=a,s.querySelectorAll(":scope > .b3-list-item > .b3-list-item__toggle> .b3-list-item__arrow--open").forEach(l=>{const o=$(l,"b3-list-item");if(o){const r=i.content.querySelector(`.b3-list-item[data-node-id="${o.getAttribute("data-node-id")}"]`);r.after(o.nextElementSibling),r.querySelector(".b3-list-item__arrow").classList.add("b3-list-item__arrow--open")}}),s.innerHTML=i.innerHTML;return}n.querySelector(".b3-list-item__arrow").classList.add("b3-list-item__arrow--open"),n.insertAdjacentHTML("afterend",`<ul class="file-tree__sliderDown">${a}</ul>`),s=n.nextElementSibling,setTimeout(()=>{s.setAttribute("style",`height:${s.childElementCount*n.clientHeight}px;`),setTimeout(()=>{this.element.querySelectorAll(".file-tree__sliderDown").forEach(i=>{i.classList.remove("file-tree__sliderDown"),i.removeAttribute("style")})},120)},2)}onLsSelect(t,n,a){let s="";if(t.files.forEach(l=>{s+=this.genFileHTML(l),n===l.path?this.selectItem(t.box,n,void 0,a):n.startsWith(l.path.replace(".sy",""))&&A("/api/filetree/listDocsByPath",{notebook:t.box,path:l.path},o=>{this.selectItem(o.data.box,n,o.data,a)})}),s==="")return;const i=this.element.querySelector(`ul[data-url="${t.box}"] li[data-path="${t.path}"]`);i.nextElementSibling&&i.nextElementSibling.tagName==="UL"&&i.nextElementSibling.remove(),i.querySelector(".b3-list-item__arrow").classList.add("b3-list-item__arrow--open"),i.insertAdjacentHTML("afterend",`<ul>${s}</ul>`),a&&this.setCurrent(this.element.querySelector(`ul[data-url="${t.box}"] li[data-path="${n}"]`))}setCurrent(t){if(!t)return;this.element.querySelectorAll("li").forEach(a=>{a.classList.remove("b3-list-item--focus")}),t.classList.add("b3-list-item--focus");const n=this.actionsElement.clientHeight;t.offsetTop-n<this.element.scrollTop?this.element.scrollTop=t.offsetTop-n:t.offsetTop-this.element.clientHeight-n+t.clientHeight>this.element.scrollTop&&(this.element.scrollTop=t.offsetTop-this.element.clientHeight-n+t.clientHeight)}getLeaf(t,n,a=!1){var s;const i=t.querySelector(".b3-list-item__arrow");if(i.classList.contains("b3-list-item__arrow--open")&&!a){i.classList.remove("b3-list-item__arrow--open"),(s=t.nextElementSibling)==null||s.remove(),this.getOpenPaths();return}A("/api/filetree/listDocsByPath",{notebook:n,path:t.getAttribute("data-path")},l=>{if(l.data.path==="/"&&l.data.files.length===0){ae(window.siyuan.languages.emptyContent);return}this.onLsHTML(l.data),this.getOpenPaths()})}selectItem(t,n,a,s=!0){var i;const l=this.element.querySelector(`[data-url="${t}"]`);if(!l)return;let o=n,r;for(;!r;)if(r=l.querySelector(`[data-path="${o}"]`),!r){const c=me().dirname(o);c==="/"?o=c:o=c+".sy"}if(r.getAttribute("data-path")===n){s?(this.setCurrent(r),this.getOpenPaths()):(i=this.element.querySelector(".b3-list-item--focus"))==null||i.classList.remove("b3-list-item--focus");return}a&&a.path===o?this.onLsSelect(a,n,s):A("/api/filetree/listDocsByPath",{notebook:t,path:o},c=>{this.onLsSelect(c.data,n,s)})}getOpenPaths(){const t=[];this.element.querySelectorAll(".b3-list[data-url]").forEach(n=>{const a={notebookId:n.getAttribute("data-url"),openPaths:[]};if(n.querySelectorAll(".b3-list-item__arrow--open").forEach(s=>{const i=O(s,"LI");i&&a.openPaths.push(i.getAttribute("data-path"))}),a.openPaths.length>0){for(let s=0;s<a.openPaths.length;s++)for(let i=s+1;i<a.openPaths.length;i++)a.openPaths[i].startsWith(a.openPaths[s].replace(".sy",""))&&(a.openPaths.splice(s,1),i--);a.openPaths.forEach((s,i)=>{var l,o,r;const c=(r=(o=(l=this.element.querySelector(`[data-url="${a.notebookId}"] li[data-path="${s}"]`))==null?void 0:l.nextElementSibling)==null?void 0:o.firstElementChild)==null?void 0:r.getAttribute("data-path");c&&(a.openPaths[i]=c)}),t.push(a)}}),window.siyuan.storage[f.LOCAL_FILESPATHS]=t,Ae(f.LOCAL_FILESPATHS,t)}}class zi{constructor(t){this.click=t.click,this.ctrlClick=t.ctrlClick,this.altClick=t.altClick,this.shiftClick=t.shiftClick,this.rightClick=t.rightClick,this.toggleClick=t.toggleClick,this.element=t.element,this.blockExtHTML=t.blockExtHTML,this.topExtHTML=t.topExtHTML,this.updateData(t.data),this.bindEvent()}updateData(t){this.data=t,!this.data||this.data.length===0?this.element.innerHTML=`<ul class="b3-list b3-list--background"><li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li></ul>`:(this.element.innerHTML=this.genHTML(this.data),_n(this.element))}genHTML(t){let n=`<ul${t[0].depth===0?" class='b3-list b3-list--background'":""}>`;return t.forEach(a=>{let s="",i='<svg class="b3-list-item__graphic"><use xlink:href="#iconFolder"></use></svg>';a.type==="bookmark"?i='<svg class="b3-list-item__graphic"><use xlink:href="#iconBookmark"></use></svg>':a.type==="tag"?i='<svg class="b3-list-item__graphic"><use xlink:href="#iconTags"></use></svg>':a.type==="backlink"?(s=` aria-label="${Nt(a.hPath)}"`,i=`<svg class="b3-list-item__graphic popover__block" data-id="${a.id}"><use xlink:href="#${dn(a.nodeType,a.subType)}"></use></svg>`):a.type==="outline"&&(s=` aria-label="${Nt(Lute.BlockDOM2Content(a.name))}"`,i=`<svg class="b3-list-item__graphic popover__block" data-id="${a.id}" style="height: 22px;width: 10px;"><use xlink:href="#${dn(a.nodeType,a.subType)}"></use></svg>`);let l="";a.count&&(l=`<span class="counter">${a.count}</span>`);const o=a.children&&a.children.length>0||a.blocks&&a.blocks.length>0;let r="";H()?a.depth>0&&(r=`padding-left: ${(a.depth-1)*20+24}px`):r=`padding-left: ${a.depth*18||4}px;margin-right: 2px`;const c=o||a.type==="backlink"&&!H();n+=`<li class="b3-list-item${H()?"":" b3-list-item--hide-action"}" 
${a.id?'data-node-id="'+a.id+'"':""} 
${a.box?'data-notebook-id="'+a.box+'"':""} 
style="--file-toggle-width:${a.depth===0?22:(a.depth+1)*18}px" 
data-treetype="${a.type}" 
data-type="${a.nodeType}" 
data-subtype="${a.subType}" 
${a.label?"data-label='"+a.label+"'":""}>
    <span style="${r}" class="b3-list-item__toggle${c?" b3-list-item__toggle--hl":""}${c?"":" fn__hidden"}">
        <svg data-id="${a.id||encodeURIComponent(a.name+a.depth)}" class="b3-list-item__arrow${o?" b3-list-item__arrow--open":""}"><use xlink:href="#iconRight"></use></svg>
    </span>
    ${i}
    <span class="b3-list-item__text ariaLabel" data-position="parentE"${s}>${a.name}</span>
    ${this.topExtHTML||""}
    ${l}
</li>`,a.children&&a.children.length>0&&(n+=this.genHTML(a.children)+"</ul>"),a.blocks&&a.blocks.length>0&&(n+=this.genBlockHTML(a.blocks,!0,a.type)+"</ul>")}),n}genBlockHTML(t,n=!1,a){let s=`<ul class="${n?"":"fn__none"}">`;return t.forEach(i=>{let l="";i.count&&(l=`<span class="counter">${i.count}</span>`);let o;a==="outline"?o=`<svg data-showref="true" class="b3-list-item__graphic popover__block" data-id="${i.id}" style="height: 22px;width: 10px;"><use xlink:href="#${dn(i.type,i.subType)}"></use></svg>`:i.type==="NodeDocument"?o=`<span data-showref="true" class="b3-list-item__graphic popover__block" data-id="${i.id}">${ge(i.ial.icon||window.siyuan.storage[f.LOCAL_IMAGES].file)}</span>`:o=`<svg data-showref="true" class="b3-list-item__graphic popover__block" data-id="${i.id}"><use xlink:href="#${dn(i.type,i.subType)}"></use></svg>`;let r="";H()?i.depth>0&&(r=`padding-left: ${(i.depth-1)*20+24}px`):r=`padding-left: ${i.depth*18||4}px;margin-right: 2px`,s+=`<li class="b3-list-item${H()?"":" b3-list-item--hide-action"}"  
style="--file-toggle-width:${i.depth===0?22:(i.depth+1)*18}px" 
data-node-id="${i.id}" 
data-ref-text="${encodeURIComponent(i.refText)}" 
data-def-id="${i.defID}" 
data-type="${i.type}" 
data-subtype="${i.subType}" 
data-treetype="${a}" 
data-def-path="${i.defPath}">
    <span style="${r}" class="b3-list-item__toggle${i.children?" b3-list-item__toggle--hl":""}${i.children?"":" fn__hidden"}">
        <svg data-id="${i.id}" class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
    </span>
    ${o}
    <span class="b3-list-item__text ariaLabel" data-position="parentE" ${a==="outline"?' aria-label="'+Nt(Lute.BlockDOM2Content(i.content))+'"':""}>${i.content}</span>
    ${l}
    ${this.blockExtHTML||""}
</li>`,i.children&&i.children.length>0&&(s+=this.genBlockHTML(i.children,!1,a)+"</ul>")}),s}toggleBlocks(t){if(this.toggleClick){this.toggleClick(t);return}if(!t.nextElementSibling)return;const n=t.firstElementChild.firstElementChild;n.classList.contains("b3-list-item__arrow--open")?(n.classList.remove("b3-list-item__arrow--open"),t.nextElementSibling.classList.add("fn__none"),t.nextElementSibling.nextElementSibling&&t.nextElementSibling.nextElementSibling.tagName==="UL"&&t.nextElementSibling.nextElementSibling.classList.add("fn__none")):(n.classList.add("b3-list-item__arrow--open"),t.nextElementSibling.classList.remove("fn__none"),t.nextElementSibling.nextElementSibling&&t.nextElementSibling.nextElementSibling.tagName==="UL"&&t.nextElementSibling.nextElementSibling.classList.remove("fn__none"))}setCurrent(t){t.classList.contains("b3-list--empty")||(this.element.querySelectorAll("li").forEach(n=>{n.classList.remove("b3-list-item--focus")}),t.classList.add("b3-list-item--focus"))}bindEvent(){this.element.addEventListener("contextmenu",t=>{let n=t.target;for(;n&&!n.isEqualNode(this.element);){if(n.tagName==="LI"&&this.rightClick){this.rightClick(n,t),t.preventDefault(),t.stopPropagation();break}n=n.parentElement}}),this.element.addEventListener("click",t=>{let n=t.target;for(;n&&!n.isEqualNode(this.element);){if(n.classList.contains("b3-list-item__toggle")&&!n.classList.contains("fn__hidden")){this.toggleBlocks(n.parentElement),this.setCurrent(n.parentElement),t.preventDefault();break}if(n.classList.contains("b3-list-item__action")&&this.click){const a=O(n,"LI");a&&this.click(a,t),t.preventDefault(),t.stopPropagation();break}else if(n.tagName==="LI"){this.setCurrent(n),n.getAttribute("data-node-id")||n.getAttribute("data-treetype")==="tag"?(this.ctrlClick&&window.siyuan.ctrlIsPressed?this.ctrlClick(n):this.altClick&&window.siyuan.altIsPressed?this.altClick(n):this.shiftClick&&window.siyuan.shiftIsPressed?this.shiftClick(n):this.click&&this.click(n,t),t.stopPropagation()):this.toggleBlocks(n),t.preventDefault();break}n=n.parentElement}}),this.element.addEventListener("dragstart",t=>{const n=O(t.target,"LI");n&&(t.dataTransfer.setData("text/html",n.outerHTML),n.style.opacity="0.1",window.siyuan.dragElement=n)}),this.element.addEventListener("dragend",t=>{const n=O(t.target,"LI");n&&(n.style.opacity="1"),window.siyuan.dragElement=void 0})}expandAll(){this.element.querySelectorAll("ul").forEach(t=>{t.classList.contains("b3-list")||t.classList.remove("fn__none")}),this.element.querySelectorAll(".b3-list-item__arrow").forEach(t=>{t.classList.add("b3-list-item__arrow--open")})}collapseAll(){this.element.querySelectorAll("ul").forEach(t=>{t.classList.contains("b3-list")||t.classList.add("fn__none")}),this.element.querySelectorAll(".b3-list-item__arrow").forEach(t=>{t.classList.remove("b3-list-item__arrow--open")})}getExpandIds(){const t=[];return this.element.querySelectorAll(".b3-list-item__arrow--open").forEach(n=>{t.push(n.getAttribute("data-id"))}),t}setExpandIds(t){this.element.querySelectorAll(".b3-list-item__arrow").forEach(n=>{t.includes(n.getAttribute("data-id"))?(n.classList.add("b3-list-item__arrow--open"),n.parentElement.parentElement.nextElementSibling&&n.parentElement.parentElement.nextElementSibling.classList.remove("fn__none")):(n.classList.remove("b3-list-item__arrow--open"),n.parentElement.parentElement.nextElementSibling&&n.parentElement.parentElement.nextElementSibling.tagName==="UL"&&n.parentElement.parentElement.nextElementSibling.classList.add("fn__none"))})}}class Rp{constructor(t){this.openNodes={},this.element=document.querySelector('#sidebar [data-type="sidebar-outline"]'),this.element.innerHTML=`<div class="toolbar toolbar--border toolbar--dark">
    <div class="fn__space"></div>
    <div class="toolbar__text">
        ${window.siyuan.languages.outline}
    </div>
    <span class="fn__flex-1 fn__space"></span>
    <svg data-type="expand" class="toolbar__icon"><use xlink:href="#iconExpand"></use></svg>
    <span class="fn__space"></span>
    <svg data-type="collapse" class="toolbar__icon"><use xlink:href="#iconContract"></use></svg>
</div>
<div class="fn__flex-1"></div>`,this.tree=new zi({element:this.element.lastElementChild,data:null,click:a=>{var s;const i=a.getAttribute("data-node-id");window.siyuan.mobile.editor.protyle.preview.element.classList.contains("fn__none")?Mn(i,l=>{at(t,i,l?[f.CB_GET_ALL,f.CB_GET_HTML]:[f.CB_GET_HL,f.CB_GET_SETID,f.CB_GET_CONTEXT,f.CB_GET_HTML])}):(Ve(),(s=document.getElementById(i))==null||s.scrollIntoView())}}),this.element.firstElementChild.querySelector('[data-type="collapse"]').addEventListener(wa(),()=>{this.tree.collapseAll()});const n=this.element.firstElementChild.querySelector('[data-type="expand"]');n.addEventListener(wa(),()=>{n.classList.contains("toolbar__icon--active")?n.classList.remove("toolbar__icon--active"):n.classList.add("toolbar__icon--active"),this.tree.expandAll()}),this.update()}update(){A("/api/outline/getDocOutline",{id:window.siyuan.mobile.editor.protyle.block.rootID,preview:!window.siyuan.mobile.editor.protyle.preview.element.classList.contains("fn__none")},t=>{var n,a;let s,i=this.element.querySelector(".b3-list-item--focus");i&&(s=i.getAttribute("data-node-id"));const l=window.siyuan.mobile.editor.protyle.block.rootID;if(this.openNodes[l]&&(this.openNodes[l]=this.tree.getExpandIds()),this.tree.updateData(t.data),this.openNodes[l]&&!this.element.firstElementChild.querySelector('[data-type="expand"]').classList.contains("toolbar__icon--active")?this.tree.setExpandIds(this.openNodes[l]):(this.tree.expandAll(),this.openNodes[l]=this.tree.getExpandIds()),(a=(n=window.siyuan.mobile.editor)==null?void 0:n.protyle)!=null&&a.toolbar.range){const o=B(window.siyuan.mobile.editor.protyle.toolbar.range.startContainer);if(o){this.setCurrent(o);return}}s&&(i=this.element.querySelector(`[data-node-id="${s}"]`),i&&i.classList.add("b3-list-item--focus"))})}setCurrentByPreview(t){if(!t)return;let n=t;for(;n&&!n.classList.contains("b3-typography")&&!["H1","H2","H3","H4","H5","H6"].includes(n.tagName);)n=n.previousElementSibling||n.parentElement;n.id&&this.setCurrentById(n.id)}setCurrentById(t){this.element.querySelectorAll(".b3-list-item.b3-list-item--focus").forEach(a=>{a.classList.remove("b3-list-item--focus")});let n=this.element.querySelector(`.b3-list-item[data-node-id="${t}"]`);for(;n&&n.clientHeight===0;)n=n.parentElement.previousElementSibling;n&&(n.classList.add("b3-list-item--focus"),this.tree.element.scrollTop=n.offsetTop-this.element.clientHeight/2-30)}setCurrent(t){if(t)if(t.getAttribute("data-type")==="NodeHeading")this.setCurrentById(t.getAttribute("data-node-id"));else{let n=De(t);for(;n&&n.getAttribute("data-type")!=="NodeHeading";)n=De(n);n?this.setCurrentById(n.getAttribute("data-node-id")):A("/api/block/getBlockBreadcrumb",{id:t.getAttribute("data-node-id"),excludeTypes:[]},a=>{a.data.reverse().find(s=>{if(s.type==="NodeHeading")return this.setCurrentById(s.id),!0})})}}}class Bp{constructor(t){this.beforeLen=10,this.element=document.querySelector('#sidebar [data-type="sidebar-backlink"]'),this.element.innerHTML=`<div class="toolbar toolbar--border toolbar--dark">
    <div class="fn__space"></div>
    <div class="toolbar__text">
        ${window.siyuan.languages.backlinks}
    </div>
    <span class="counter listCount"></span>
    <span class="fn__space"></span>
    <svg data-type="expand" class="toolbar__icon"><use xlink:href="#iconExpand"></use></svg>
    <span class="fn__space"></span>
    <svg data-type="collapse" class="toolbar__icon"><use xlink:href="#iconContract"></use></svg>
</div>
<div class="backlinkList fn__flex-1"></div>
<div class="toolbar">
    <div class="fn__space"></div>
    <div class="toolbar__text">
        ${window.siyuan.languages.mentions}
    </div>
    <span class="counter listMCount"></span>
    <span class="fn__space"></span>
    <svg data-type="mExpand" class="toolbar__icon"><use xlink:href="#iconExpand"></use></svg>
    <span class="fn__space"></span>
    <svg data-type="mCollapse" class="toolbar__icon"><use xlink:href="#iconContract"></use></svg>
    <span class="fn__space"></span>
    <svg data-type="layout" class="toolbar__icon"><use xlink:href="#iconDown"></use></svg>
</div>
<div class="backlinkMList fn__flex-1"></div>`,this.tree=new zi({element:this.element.querySelector(".backlinkList"),data:null,click(n){at(t,n.getAttribute("data-node-id"),[f.CB_GET_HL,f.CB_GET_CONTEXT])}}),this.mTree=new zi({element:this.element.querySelector(".backlinkMList"),data:null,click:n=>{at(t,n.getAttribute("data-node-id"),[f.CB_GET_HL,f.CB_GET_CONTEXT])}}),this.element.addEventListener("click",n=>{let a=n.target;for(;a&&!a.isEqualNode(this.element);){if(a.classList.contains("toolbar__icon"))switch(a.getAttribute("data-type")){case"collapse":this.tree.collapseAll();break;case"expand":this.tree.expandAll();break;case"mExpand":this.mTree.expandAll();break;case"mCollapse":this.mTree.collapseAll();break;case"layout":this.mTree.element.style.flex?this.mTree.element.style.height==="0px"?(this.mTree.element.removeAttribute("style"),a.setAttribute("aria-label",window.siyuan.languages.up),a.querySelector("use").setAttribute("xlink:href","#iconUp")):(this.mTree.element.removeAttribute("style"),a.setAttribute("aria-label",window.siyuan.languages.down),a.querySelector("use").setAttribute("xlink:href","#iconDown")):a.getAttribute("aria-label")===window.siyuan.languages.down?(this.mTree.element.setAttribute("style","flex:none;height:0px"),a.setAttribute("aria-label",window.siyuan.languages.up),a.querySelector("use").setAttribute("xlink:href","#iconUp")):(this.mTree.element.setAttribute("style",`flex:none;height:${this.element.clientHeight-this.tree.element.previousElementSibling.clientHeight*2}px`),a.setAttribute("aria-label",window.siyuan.languages.down),a.querySelector("use").setAttribute("xlink:href","#iconDown")),a.setAttribute("data-clicked","true");break}a=a.parentElement}}),this.update()}update(){A("/api/ref/getBacklink",{id:window.siyuan.mobile.editor.protyle.block.id,beforeLen:this.beforeLen,k:"",mk:""},t=>{this.notebookId=t.data.box,this.tree.updateData(t.data.backlinks),this.mTree.updateData(t.data.backmentions);const n=this.element.querySelector(".listCount");t.data.linkRefsCount===0?n.classList.add("fn__none"):(n.classList.remove("fn__none"),n.textContent=t.data.linkRefsCount.toString());const a=this.element.querySelector(".listMCount");t.data.mentionsCount===0?a.classList.add("fn__none"):(a.classList.remove("fn__none"),a.textContent=t.data.mentionsCount.toString());const s=this.element.querySelector("[data-type='layout']");if(!s.getAttribute("data-clicked")){if(t.data.mentionsCount===0){this.mTree.element.setAttribute("style","flex:none;height:0px"),s.setAttribute("aria-label",window.siyuan.languages.up),s.querySelector("use").setAttribute("xlink:href","#iconUp");return}t.data.linkRefsCount===0?(this.mTree.element.setAttribute("style",`flex:none;height:${this.element.clientHeight-this.tree.element.previousElementSibling.clientHeight*2}px`),s.setAttribute("aria-label",window.siyuan.languages.down),s.querySelector("use").setAttribute("xlink:href","#iconDown")):(this.mTree.element.removeAttribute("style"),s.setAttribute("aria-label",window.siyuan.languages.down),s.querySelector("use").setAttribute("xlink:href","#iconDown"))}})}}const Up=(e,t,n)=>{if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="bookmarkMenu"){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove();const a=e.getAttribute("data-node-id");!a&&!window.siyuan.config.readonly&&window.siyuan.menus.menu.append(new M({id:"rename",icon:"iconEdit",label:window.siyuan.languages.rename,click:()=>{const s=e.querySelector(".b3-list-item__text").textContent,i=new we({title:window.siyuan.languages.rename,content:`<div class="b3-dialog__content"><input class="b3-text-field fn__block"></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:H()?"92vw":"520px"});i.element.setAttribute("data-key",f.DIALOG_RENAMEBOOKMARK);const l=i.element.querySelectorAll(".b3-button");l[0].addEventListener("click",()=>{i.destroy()});const o=i.element.querySelector("input");i.bindInput(o,()=>{l[1].click()}),o.value=s,o.focus(),o.select(),l[1].addEventListener("click",()=>{A("/api/bookmark/renameBookmark",{oldBookmark:s,newBookmark:o.value},()=>{i.destroy()})})}}).element),a&&window.siyuan.menus.menu.append(new M({id:"copy",label:window.siyuan.languages.copy,type:"submenu",icon:"iconCopy",submenu:Ba([e.getAttribute("data-node-id")],!1)}).element),window.siyuan.config.readonly||window.siyuan.menus.menu.append(new M({id:"remove",icon:"iconTrashcan",label:window.siyuan.languages.remove,click:()=>{const s=e.querySelector(".b3-list-item__text").textContent;$e(window.siyuan.languages.deleteOpConfirm,window.siyuan.languages.removeBookmark.replace("${x}",`<b>${pe(s)}</b>`),()=>{a?(A("/api/attr/setBlockAttrs",{id:a,attrs:{bookmark:""}},()=>{n.update()}),document.querySelectorAll(`.protyle-wysiwyg [data-node-id="${a}"]`).forEach(i=>{i.setAttribute("bookmark","");const l=i.querySelector(".protyle-attr--bookmark");l&&l.remove()})):A("/api/bookmark/removeBookmark",{bookmark:s})},void 0,!0)}}).element),window.siyuan.menus.menu.element.setAttribute("data-name","bookmarkMenu"),window.siyuan.menus.menu.popup({x:t.clientX-11,y:t.clientY+11,h:22,w:12})};class Yp{constructor(t){this.element=document.querySelector('#sidebar [data-type="sidebar-bookmark"]'),this.element.innerHTML=`<div class="toolbar toolbar--border toolbar--dark">
    <div class="fn__space"></div>
    <div class="toolbar__text">
        ${window.siyuan.languages.bookmark}
    </div>
    <span class="fn__space"></span>
    <svg data-type="expand" class="toolbar__icon"><use xlink:href="#iconExpand"></use></svg>
    <span class="fn__space"></span>
    <svg data-type="collapse" class="toolbar__icon"><use xlink:href="#iconContract"></use></svg>
</div>
<div class="fn__flex-1 bookmarkList"></div>
<img style="position: absolute;top: 0;left: 0;height: 100%;width: 100%;padding: 30vw;box-sizing: border-box;" src="/stage/loading-pure.svg">`,this.tree=new zi({element:this.element.querySelector(".bookmarkList"),data:null,click:(n,a)=>{const s=n.getAttribute("data-node-id");if(a){const i=$(a.target,"b3-list-item__action");if(i){Up(i.parentElement,a,this);return}}Mn(s,i=>{at(t,s,i?[f.CB_GET_HL,f.CB_GET_ALL]:[f.CB_GET_HL,f.CB_GET_CONTEXT,f.CB_GET_ROOTSCROLL])})},blockExtHTML:'<span class="b3-list-item__action"><svg><use xlink:href="#iconMore"></use></svg></span>',topExtHTML:'<span class="b3-list-item__action"><svg><use xlink:href="#iconMore"></use></svg></span>'}),this.element.addEventListener("click",n=>{let a=n.target;for(;a&&!a.isEqualNode(this.element);){if(a.classList.contains("toolbar__icon"))switch(a.getAttribute("data-type")){case"collapse":this.tree.collapseAll();break;case"expand":this.tree.expandAll();break}a=a.parentElement}}),this.update()}update(){this.element.lastElementChild.classList.remove("fn__none"),A("/api/bookmark/getBookmark",{},t=>{this.openNodes&&(this.openNodes=this.tree.getExpandIds()),this.tree.updateData(t.data),this.openNodes?this.tree.setExpandIds(this.openNodes):this.openNodes=this.tree.getExpandIds(),this.element.lastElementChild.classList.add("fn__none")})}}const Fp=(e,t,n)=>{if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="tagMenu"){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.append(new M({icon:"iconEdit",label:window.siyuan.languages.rename,click:()=>{Ro(n)}}).element),window.siyuan.menus.menu.append(new M({icon:"iconTrashcan",label:window.siyuan.languages.remove,click:()=>{$e(window.siyuan.languages.deleteOpConfirm,`${window.siyuan.languages.confirmDelete} <b>${pe(n)}</b>?`,()=>{A("/api/tag/removeTag",{label:n})},void 0,!0)}}).element),window.siyuan.menus.menu.element.setAttribute("data-name","tagMenu"),window.siyuan.menus.menu.popup({x:t.clientX-11,y:t.clientY+11,h:22,w:12})};class Wp{constructor(t){this.element=document.querySelector('#sidebar [data-type="sidebar-tag"]'),this.element.innerHTML=`<div class="toolbar toolbar--border toolbar--dark">
    <div class="fn__space"></div>
    <div class="toolbar__text">
        ${window.siyuan.languages.tag}
    </div>
    <span class="fn__space"></span>
    <svg data-type="expand" class="toolbar__icon"><use xlink:href="#iconExpand"></use></svg>
    <span class="fn__space"></span>
    <svg data-type="collapse" class="toolbar__icon"><use xlink:href="#iconContract"></use></svg>
    <span class="fn__space${window.siyuan.config.readonly?" fn__none":""}"></span>
    <svg data-type="sort" class="toolbar__icon${window.siyuan.config.readonly?" fn__none":""}"><use xlink:href="#iconSort"></use></svg>
</div>
<div class="fn__flex-1 tagList"></div>
<img style="position: absolute;top: 0;left: 0;height: 100%;width: 100%;padding: 30vw;box-sizing: border-box;" src="/stage/loading-pure.svg">`,this.tree=new zi({element:this.element.querySelector(".tagList"),data:null,click:(n,a)=>{const s=n.getAttribute("data-label");if(a){const i=$(a.target,"b3-list-item__action");if(i){Fp(i.parentElement,a,s);return}}qt(t,{hasReplace:!1,method:0,hPath:"",idPath:[],k:`#${s}#`,r:"",page:1})},blockExtHTML:window.siyuan.config.readonly?void 0:'<span class="b3-list-item__action"><svg><use xlink:href="#iconMore"></use></svg></span>',topExtHTML:window.siyuan.config.readonly?void 0:'<span class="b3-list-item__action"><svg><use xlink:href="#iconMore"></use></svg></span>'}),this.element.addEventListener("click",n=>{let a=n.target;for(;a&&!a.isEqualNode(this.element);){if(a.classList.contains("toolbar__icon"))switch(a.getAttribute("data-type")){case"collapse":this.tree.collapseAll(),n.preventDefault(),n.stopPropagation();break;case"expand":this.tree.expandAll(),n.preventDefault(),n.stopPropagation();break;case"sort":window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.append(new M({icon:window.siyuan.config.tag.sort===0?"iconSelect":void 0,label:window.siyuan.languages.fileNameASC,click:()=>{window.siyuan.config.tag.sort=0,this.update()}}).element),window.siyuan.menus.menu.append(new M({icon:window.siyuan.config.tag.sort===1?"iconSelect":void 0,label:window.siyuan.languages.fileNameDESC,click:()=>{window.siyuan.config.tag.sort=1,this.update()}}).element),window.siyuan.menus.menu.append(new M({icon:window.siyuan.config.tag.sort===4?"iconSelect":void 0,label:window.siyuan.languages.fileNameNatASC,click:()=>{window.siyuan.config.tag.sort=4,this.update()}}).element),window.siyuan.menus.menu.append(new M({icon:window.siyuan.config.tag.sort===5?"iconSelect":void 0,label:window.siyuan.languages.fileNameNatDESC,click:()=>{window.siyuan.config.tag.sort=5,this.update()}}).element),window.siyuan.menus.menu.append(new M({icon:window.siyuan.config.tag.sort===7?"iconSelect":void 0,label:window.siyuan.languages.refCountASC,click:()=>{window.siyuan.config.tag.sort=7,this.update()}}).element),window.siyuan.menus.menu.append(new M({icon:window.siyuan.config.tag.sort===8?"iconSelect":void 0,label:window.siyuan.languages.refCountDESC,click:()=>{window.siyuan.config.tag.sort=8,this.update()}}).element),window.siyuan.menus.menu.popup({x:n.clientX,y:n.clientY}),n.preventDefault(),n.stopPropagation();break}a=a.parentElement}}),this.update()}update(){this.element.lastElementChild.classList.remove("fn__none"),A("/api/tag/getTag",{sort:window.siyuan.config.tag.sort},t=>{this.openNodes&&(this.openNodes=this.tree.getExpandIds()),this.tree.updateData(t.data),this.openNodes?this.tree.setExpandIds(this.openNodes):this.openNodes=this.tree.getExpandIds(),this.element.lastElementChild.classList.add("fn__none")})}}class jp extends Oi{constructor(t,n){super({app:t,id:n.id}),this.selectIds=[],this.currentPage=1,this.pageCount=1,this.data={},n instanceof Element?this.element=n:this.element=n.panelElement,this.element.innerHTML=`<div class="toolbar toolbar--border toolbar--dark">
    <div class="fn__space"></div>
    <div class="toolbar__text">
        ${window.siyuan.languages.inbox}
        <span class="fn__space"></span>
        <span class="inboxSelectCount ft__smaller ft__on-surface"></span>
    </div>
    <span class="fn__flex-1"></span>
    <span class="fn__space"></span>
    <svg data-type="selectall" class="toolbar__icon"><use xlink:href="#iconUncheck"></use></svg>
    <svg data-type="previous" disabled="disabled" class="toolbar__icon"><use xlink:href='#iconLeft'></use></svg>
    <svg data-type="next" disabled="disabled" class="toolbar__icon"><use xlink:href='#iconRight'></use></svg>
    <svg data-type="more" class="toolbar__icon"><use xlink:href='#iconMore'></use></svg>
</div>
<div class="fn__loading fn__none">
    <img width="64px" src="/stage/loading-pure.svg"></div>
</div>
<div class="fn__flex-1 fn__none inboxDetails fn__flex-column" style="min-height: auto;background-color: var(--b3-theme-background)"></div>
<div class="fn__flex-1"></div>`;const a=this.element.querySelector(".inboxSelectCount"),s=this.element.querySelector(".inboxDetails"),i=this.element.firstElementChild.querySelector('[data-type="selectall"]');this.element.lastElementChild.addEventListener("contextmenu",l=>{const o=$(l.target,"b3-list-item");o&&this.more(l,o)}),this.element.addEventListener("click",l=>{let o=l.target;for(;o&&!o.isEqualNode(this.element);){if(o.tagName==="A"){l.stopPropagation();break}const r=o.getAttribute("data-type");if(r==="min"){getDockByType("inbox").toggleModel("inbox",!1,!0),l.preventDefault();break}else if(r==="selectall"){const c=o.querySelector("use");c.getAttribute("xlink:href")==="#iconUncheck"?(this.element.lastElementChild.querySelectorAll(".b3-list-item").forEach(d=>{d.querySelector("use").setAttribute("xlink:href","#iconCheck"),this.selectIds.push(d.getAttribute("data-id")),this.selectIds=[...new Set(this.selectIds)]}),c.setAttribute("xlink:href","#iconCheck")):(this.element.lastElementChild.querySelectorAll(".b3-list-item").forEach(d=>{d.querySelector("use").setAttribute("xlink:href","#iconUncheck"),this.selectIds.splice(this.selectIds.indexOf(d.getAttribute("data-id")),1)}),c.setAttribute("xlink:href","#iconUncheck")),a.innerHTML=`${this.selectIds.length.toString()}/${this.pageCount.toString()}`,window.siyuan.menus.menu.remove(),l.stopPropagation();break}else if(r==="select"){const c=o.querySelector("use");c.getAttribute("xlink:href")==="#iconUncheck"?(this.selectIds.push(o.parentElement.getAttribute("data-id")),this.selectIds=[...new Set(this.selectIds)],c.setAttribute("xlink:href","#iconCheck")):(this.selectIds.splice(this.selectIds.indexOf(o.parentElement.getAttribute("data-id")),1),c.setAttribute("xlink:href","#iconUncheck")),a.innerHTML=`${this.selectIds.length.toString()}/${this.pageCount.toString()}`,i.querySelector("use").setAttribute("xlink:href",this.element.lastElementChild.querySelectorAll('[*|href="#iconCheck"]').length===this.element.lastElementChild.querySelectorAll(".b3-list-item").length?"#iconCheck":"#iconUncheck"),window.siyuan.menus.menu.remove(),l.stopPropagation();break}else if(r==="previous"){o.getAttribute("disabled")!=="disabled"&&(this.currentPage--,this.update()),l.preventDefault();break}else if(r==="next"){o.getAttribute("disabled")!=="disabled"&&(this.currentPage++,this.update()),l.preventDefault();break}else if(r==="back"){this.back(),l.preventDefault();break}else if(r==="more"){this.more(l),l.stopPropagation(),l.preventDefault();break}else if(o.classList.contains("b3-list-item")){const c=this.data[o.getAttribute("data-id")];i.classList.add("fn__none"),this.element.firstElementChild.querySelector('[data-type="previous"]').classList.add("fn__none"),this.element.firstElementChild.querySelector('[data-type="next"]').classList.add("fn__none"),s.innerHTML=this.genDetail(c),s.setAttribute("data-id",c.oId),s.classList.remove("fn__none"),s.scrollTop=0,this.element.lastElementChild.classList.add("fn__none"),l.preventDefault();break}o=o.parentElement}}),this.update()}back(){this.element.firstElementChild.querySelector('[data-type="selectall"]').classList.remove("fn__none"),this.element.firstElementChild.querySelector('[data-type="previous"]').classList.remove("fn__none"),this.element.firstElementChild.querySelector('[data-type="next"]').classList.remove("fn__none"),this.element.querySelector(".inboxDetails").classList.add("fn__none"),this.element.lastElementChild.classList.remove("fn__none")}genDetail(t){let n="";return t.shorthandURL&&(n=`<a href="${t.shorthandURL}" target="_blank">
        <svg class="toolbar__icon" style="float: left"><use xlink:href="#iconLink"></use></svg>
    </a>`),`<div class="toolbar">
    <svg data-type="back" class="toolbar__icon"><use xlink:href="#iconLeft"></use></svg>
    <span data-type="back" class="toolbar__text fn__flex-1">${t.shorthandTitle}</span>
    ${n}
</div>
<div class="b3-typography b3-typography--default" style="padding: 0 8px 8px">
${t.shorthandContent}
</div>`}genItemHTML(t){return`<li style="padding-left: 0" data-id="${t.oId}" class="b3-list-item">
    <span data-type="select" class="b3-list-item__action">
        <svg><use xlink:href="#icon${this.selectIds.includes(t.oId)?"Check":"Uncheck"}"></use></svg> 
    </span>
    <span class="fn__space--small"></span>
    <span class="b3-list-item__text" title="${t.shorthandTitle}${t.shorthandTitle===t.shorthandDesc?"":`
`+t.shorthandDesc}">${t.shorthandTitle}</span>
    <span class="b3-list-item__meta">${t.hCreated}</span>
</li>`}more(t,n){const a=this.element.querySelector(".inboxDetails");window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.append(new M({label:window.siyuan.languages.refresh,icon:"iconRefresh",click:()=>{n?A("/api/inbox/getShorthand",{id:n.dataset.id},i=>{this.data[i.data.oId]=i.data,n.outerHTML=this.genItemHTML(i.data)}):a.classList.contains("fn__none")?(this.currentPage=1,this.update()):A("/api/inbox/getShorthand",{id:a.getAttribute("data-id")},i=>{this.data[i.data.oId]=i.data,a.innerHTML=this.genDetail(i.data),a.scrollTop=0})}}).element);let s=[];n?s=[n.dataset.id]:a.classList.contains("fn__none")?s=this.selectIds:s=[a.getAttribute("data-id")],s.length>0&&(window.siyuan.menus.menu.append(new M({label:window.siyuan.languages.move,icon:"iconMove",click:()=>{this.move(s)}}).element),window.siyuan.menus.menu.append(new M({label:window.siyuan.languages.remove,icon:"iconTrashcan",click:()=>{let i="";s.forEach((l,o)=>{i+='<code class="fn__code">'+pe(this.data[l].shorthandTitle)+"</code>"+(o===s.length-1?"":", ")}),$e(window.siyuan.languages.deleteOpConfirm,`${window.siyuan.languages.confirmDelete} ${i}?`,()=>{n?this.remove(n.dataset.id):a.classList.contains("fn__none")?this.remove():this.remove(a.getAttribute("data-id"))},void 0,!0)}}).element)),this.app.plugins&&jt({plugins:this.app.plugins,type:"open-menu-inbox",detail:{ids:s,element:n||a},separatorPosition:"top"}),window.siyuan.menus.menu.popup({x:t.clientX,y:t.clientY+16})}remove(t){let n;t?n=[t]:n=this.selectIds,A("/api/inbox/removeShorthands",{ids:n},()=>{t?(this.back(),this.selectIds.find((a,s)=>{if(a===t)return this.selectIds.splice(s,1),!0})):this.selectIds=[],this.currentPage=1,this.update()})}move(t){Wn((n,a)=>{t.forEach(s=>{A("/api/inbox/getShorthand",{id:s},i=>{this.data[i.data.oId]=i.data;let l=i.data.shorthandMd;l===""&&i.data.shorthandContent===""&&i.data.shorthandURL!=""&&(l="["+i.data.shorthandTitle+"]("+i.data.shorthandURL+")"),A("/api/filetree/createDoc",{notebook:a[0],path:me().join(ct(n[0],!1,!0),Lute.NewNodeID()+".sy"),title:Pn(i.data.shorthandTitle),md:l,listDocTree:!0},()=>{this.remove(s)})})})})}update(){const t=this.element.querySelector(".fn__loading");if(Vn("")){this.element.lastElementChild.innerHTML=`<ul class="b3-list b3-list--background">
    <li class="b3-list--empty">
        ${window.siyuan.languages.inboxTip}
    </li>
    <li class="b3-list--empty">
        ${window.siyuan.config.system.container==="ios"?window.siyuan.languages._kernel[122]:window.siyuan.languages._kernel[29].replace("${url}",Pt("subscribe/siyuan"))}
    </li>
</ul>`,t.classList.add("fn__none");return}t.classList.contains("fn__none")&&(t.classList.remove("fn__none"),A("/api/inbox/getShorthands",{page:this.currentPage},n=>{t.classList.add("fn__none");let a="";n.data.data.shorthands.length===0?a=`<ul class="b3-list b3-list--background"><li class="b3-list--empty">${window.siyuan.languages.inboxTip}</li></ul>`:(a='<ul style="padding: 8px 0" class="b3-list b3-list--background">',n.data.data.shorthands.forEach(o=>{a+=this.genItemHTML(o),this.data[o.oId]=o}),a+="</ul>"),this.element.lastElementChild.innerHTML=a,this.pageCount=n.data.data.pagination.paginationRecordCount,this.element.querySelector(".inboxSelectCount").innerHTML=`${this.selectIds.length}/${this.pageCount}`;const s=this.element.querySelector('[data-type="previous"]'),i=this.element.querySelector('[data-type="next"]');n.data.data.pagination.paginationPageCount>this.currentPage?i.removeAttribute("disabled"):i.setAttribute("disabled","disabled"),this.currentPage===1?s.setAttribute("disabled","disabled"):s.removeAttribute("disabled");const l=this.element.lastElementChild.querySelectorAll(".b3-list-item").length;this.element.firstElementChild.querySelector('[data-type="selectall"] use').setAttribute("xlink:href",this.element.lastElementChild.querySelectorAll('[*|href="#iconCheck"]').length===l&&l!==0?"#iconCheck":"#iconUncheck"),this.element.lastElementChild.scrollTop=0}))}}let Fn;const Gd=e=>{const t=new Ke("dockMobileMenu");t.isOpen||(e.plugins.forEach(n=>{Object.keys(n.docks).forEach(a=>{t.addItem({label:n.docks[a].config.title,icon:n.docks[a].config.icon,click(){(Fn==null?void 0:Fn.type)!==a&&(Fn&&Fn.destroy&&Fn.destroy(),Fn=n.docks[a].mobileModel(document.querySelector('#sidebar [data-type="sidebar-plugin"]')),window.siyuan.mobile.docks[a]=Fn)}})})}),t.fullscreen(),t.element.lastElementChild.innerHTML===""&&ae(window.siyuan.languages._kernel[122]))},Vp=(e,t)=>{is(),Wd(),ef();const n=document.getElementById("sidebar"),a=n.querySelector(".toolbar--border");if(a.addEventListener("click",s=>{const i=s.target;let l;if(typeof s.detail=="string"?l=a.querySelector(`svg[data-type="sidebar-${s.detail}-tab"]`):l=ee(i,"svg"),!l)return;const o=l.getAttribute("data-type");if(l.classList.contains("toolbar__icon--active")){o==="sidebar-plugin-tab"&&Gd(e);return}if(!o){Ve();return}a.querySelectorAll(".toolbar__icon").forEach(r=>{const c=r.getAttribute("data-type");if(!c)return;const d=n.lastElementChild.querySelector(`[data-type="${c.replace("-tab","")}"]`);c===o?(o==="sidebar-outline-tab"?window.siyuan.mobile.docks.outline?window.siyuan.mobile.docks.outline.update():window.siyuan.mobile.docks.outline=new Rp(e):o==="sidebar-backlink-tab"?window.siyuan.mobile.docks.backlink?window.siyuan.mobile.docks.backlink.update():window.siyuan.mobile.docks.backlink=new Bp(e):o==="sidebar-bookmark-tab"?window.siyuan.mobile.docks.bookmark?window.siyuan.mobile.docks.bookmark.update():window.siyuan.mobile.docks.bookmark=new Yp(e):o==="sidebar-tag-tab"?window.siyuan.mobile.docks.tag?window.siyuan.mobile.docks.tag.update():window.siyuan.mobile.docks.tag=new Wp(e):o==="sidebar-inbox-tab"&&!window.siyuan.mobile.docks.inbox?window.siyuan.mobile.docks.inbox=new jp(e,document.querySelector('#sidebar [data-type="sidebar-inbox"]')):o==="sidebar-plugin-tab"&&(Fn?Fn.update&&Fn.update():(d.innerHTML=`<div class="b3-list--empty">${window.siyuan.languages.emptyContent}</div>`,Gd(e))),l.classList.add("toolbar__icon--active"),d.classList.remove("fn__none")):(r.classList.remove("toolbar__icon--active"),d.classList.add("fn__none"))})}),window.siyuan.mobile.docks.file=new Op(e),document.getElementById("toolbarFile").addEventListener("click",()=>{tn(),fn(),n.style.transform="translateX(0px)";const s=n.querySelector(".toolbar--border .toolbar__icon--active").getAttribute("data-type");s==="sidebar-outline-tab"?window.siyuan.mobile.docks.outline.update():s==="sidebar-backlink-tab"?window.siyuan.mobile.docks.backlink.update():s==="sidebar-bookmark-tab"?window.siyuan.mobile.docks.bookmark.update():s==="sidebar-tag-tab"&&window.siyuan.mobile.docks.tag.update()}),document.getElementById("toolbarMore").addEventListener("click",()=>{Na()}),document.getElementById("toolbarSync").addEventListener(wa(),()=>{ho(e)}),document.getElementById("modelClose").addEventListener("click",()=>{_l()}),zp(),as()>0){if(window.JSAndroid&&window.openFileByURL(window.JSAndroid.getBlockURL()))return;const s=cu();if(s.id){at(e,s.id,s.isZoomIn?[f.CB_GET_ALL]:[f.CB_GET_HL,f.CB_GET_CONTEXT,f.CB_GET_ROOTSCROLL]);return}if(window.siyuan.config.fileTree.closeTabsOnStart&&t){ii(e);return}const i=window.siyuan.storage[f.LOCAL_DOCINFO];A("/api/block/checkBlockExist",{id:i.id},l=>{l.data?at(e,i.id,[f.CB_GET_SCROLL]):A("/api/block/getRecentUpdatedBlocks",{},o=>{o.data.length!==0?Mn(o.data[0].id,r=>{at(e,o.data[0].id,r?[f.CB_GET_ALL]:[f.CB_GET_CONTEXT,f.CB_GET_ROOTSCROLL])}):ii(e)})});return}ii(e)},zp=()=>{const e=document.getElementById("toolbarName");e.setAttribute("placeholder",window.siyuan.languages._kernel[16]),e.addEventListener("blur",()=>{if(e.getAttribute("readonly")!=="readonly"){if(!ki(e.value))return e.value=e.value.substring(0,f.SIZE_TITLE),!1;A("/api/filetree/renameDoc",{notebook:window.siyuan.mobile.editor.protyle.notebookId,path:window.siyuan.mobile.editor.protyle.path,title:e.value}),si(e.value)}})},Gp=()=>{A("/api/system/getChangelog",{},e=>{if(!e.data.show)return;const t=new we({title:`\u2728 ${window.siyuan.languages.whatsNewInSiYuan} v${window.siyuan.config.system.kernelVersion}`,width:H()?"92vw":"768px",height:H()?"80vh":"70vh",content:`<div style="overflow:auto;" class="b3-dialog__content b3-typography b3-typography--default">${e.data.html}</div>`});t.element.setAttribute("data-key",f.DIALOG_CHANGELOG),Pe(t.element)})},Kp=(e,t={scope:"/",type:"classic",updateViaCache:"all"})=>{var n;(n=window.webkit)!=null&&n.messageHandlers||window.JSAndroid||window.JSHarmony||!("serviceWorker"in window.navigator)||!("caches"in window)||!("fetch"in window)||navigator.serviceWorker==null||window.navigator.serviceWorker.register(e,t).then(a=>{a.update()}).catch(a=>{console.debug(`Registration failed with ${a}`)})};var Zp=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{o(n.next(r))}catch(c){s(c)}},l=r=>{try{o(n.throw(r))}catch(c){s(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,l);o((n=n.apply(e,t)).next())});let ve,qa;const Nm=e=>{let t,n;document.addEventListener("mouseover",a=>{var s;if(!window.siyuan.config||!window.siyuan.menus)return;const i=hasClosestByAttribute(a.target,"data-type","a",!0)||hasClosestByClassName(a.target,"ariaLabel")||hasClosestByAttribute(a.target,"data-type","tab-header")||hasClosestByAttribute(a.target,"data-type","inline-memo")||hasClosestByClassName(a.target,"av__calc--ashow")||hasClosestByClassName(a.target,"av__cell");if(i){let l="",o=i.getAttribute("aria-label")||"";if(i.classList.contains("av__cell"))if(i.classList.contains("av__cell--header")){const r=i.querySelector(".av__celltext"),c=i.getAttribute("data-desc");(r.scrollWidth>r.clientWidth+2||c)&&(c?o=`${getCellText(i)}<div class='ft__on-surface'>${escapeAriaLabel(c)}</div>`:o=getCellText(i))}else((s=i.firstElementChild)==null?void 0:s.getAttribute("data-type"))==="url"&&i.firstElementChild.textContent.indexOf("...")>-1&&(o=Lute.EscapeHTMLStr(i.firstElementChild.getAttribute("data-href")),l="href"),!o&&i.dataset.wrap!=="true"&&a.target.dataset.type!=="block-more"&&!hasClosestByClassName(a.target,"block__icon")&&(i.style.overflow="auto",i.scrollWidth>i.clientWidth+2&&(o=Lute.EscapeHTMLStr(getCellText(i))),i.style.overflow="");else if(i.parentElement.parentElement.classList.contains("av__views")&&i.parentElement.classList.contains("layout-tab-bar")){const r=i.querySelector(".item__text"),c=i.getAttribute("data-desc");(r.scrollWidth>r.clientWidth+2||c)&&(c?o=`${r.textContent}<div class='ft__on-surface'>${escapeAriaLabel(c)}</div>`:o=r.textContent)}else if(i.classList.contains("av__celltext--url")){const r=i.getAttribute("data-name")||"";o=o?`<span style="word-break: break-all">${o.substring(0,Constants.SIZE_TITLE)}</span>${r?'<div class="fn__hr"></div><span>'+r+"</span>":""}`:r,l="href"}else if(i.classList.contains("av__calc--ashow")&&i.clientWidth+2<i.scrollWidth)o=i.lastChild.textContent+" "+i.firstElementChild.textContent;else if(i.getAttribute("data-type")==="setRelationCell"){const r=i.querySelector(".b3-menu__label");r&&r.clientWidth<r.scrollWidth&&(o=r.textContent)}if(o||(o=i.getAttribute("data-inline-memo-content"),o&&(l="memo")),!o){const r=i.getAttribute("data-href")||"";r&&(o=`<span style="word-break: break-all">${r.substring(0,Constants.SIZE_TITLE)}</span>`,l="href");const c=i.getAttribute("data-title");if(o&&isLocalPath(r)&&!i.classList.contains("b3-tooltips")){let d=o;fetchPost("/api/asset/statAsset",{path:r},u=>{u.code===1?c&&(d+='<div class="fn__hr"></div><span>'+c+"</span>"):d+=` ${u.data.hSize}${c?'<div class="fn__hr"></div><span>'+c+"</span>":""}<br>${window.siyuan.languages.modifiedAt} ${u.data.hUpdated}<br>${window.siyuan.languages.createdAt} ${u.data.hCreated}`,showTooltip(d,i,l)}),o=""}else c&&(o+='<div class="fn__hr"></div><span>'+c+"</span>")}if(qa=hasClosestByClassName(a.target,"b3-list-item__text"),qa&&qa.parentElement.getAttribute("data-type")==="navigation-root"&&fetchPost("/api/notebook/getNotebookInfo",{notebook:qa.parentElement.parentElement.getAttribute("data-url")},r=>{const c=r.data.boxInfo,d=`${c.name} <small class='ft__on-surface'>${c.hSize}</small>${c.docCount!==0?window.siyuan.languages.includeSubFile.replace("x",c.docCount):""}<br>${window.siyuan.languages.modifiedAt} ${c.hMtime}<br>${window.siyuan.languages.createdAt} ${c.hCtime}`,u=hasClosestByClassName(a.target,"b3-list-item__text");qa&&u&&qa.isSameNode(u)&&showTooltip(d,qa),u&&u.parentElement.getAttribute("data-type")==="navigation-root"&&u.parentElement.parentElement.getAttribute("data-url")===c.id&&u.setAttribute("aria-label",d)}),o&&!i.classList.contains("b3-tooltips")){try{showTooltip(decodeURIComponent(o),i,l)}catch(r){showTooltip(o,i,l)}a.stopPropagation()}else hideTooltip()}else if(!i){const l=hasClosestByAttribute(a.target,"id","tooltip",!0);(!l||l&&l.clientHeight>=l.scrollHeight&&l.clientWidth>=l.scrollWidth)&&hideTooltip()}if(window.siyuan.config.editor.floatWindowMode===1||window.siyuan.shiftIsPressed){if(clearTimeout(n),n=window.setTimeout(()=>{Kd(a)},Constants.TIMEOUT_INPUT),!Zd(a,i)||a.relatedTarget&&!document.contains(a.relatedTarget))return;window.siyuan.ctrlIsPressed?(clearTimeout(n),Gi(e)):window.siyuan.shiftIsPressed&&(clearTimeout(n),Gi(e,!0));return}clearTimeout(t),clearTimeout(n),n=window.setTimeout(()=>{Kd(a)&&!ve&&!i&&clearTimeout(t)},Constants.TIMEOUT_INPUT),t=window.setTimeout(()=>{!Zd(a,i)||isTouchDevice()||(clearTimeout(n),Gi(e))},620)})},Kd=e=>{var t,n;const a=isTouchDevice()?document.elementFromPoint(e.clientX,e.clientY):e.target;if(!a||a.id&&a.tagName!=="svg"&&(a.id.startsWith("minder_node")||a.id.startsWith("kity_")||a.id.startsWith("node_"))||a.classList.contains("counter")||a.tagName==="circle")return!1;const s=hasClosestByClassName(a,"av__panel")||hasClosestByClassName(a,"av__mask");if(s){if(window.siyuan.blockPanels.find(o=>{if(o.element.style.zIndex<s.style.zIndex)return!0}))return!1}else{const l=hasClosestByClassName(a,"b3-menu");if(l&&l.getAttribute("data-name")!=="docTreeMore"&&window.siyuan.blockPanels.find(r=>{if(r.element.style.zIndex<l.style.zIndex)return!0}))return!1}ve=hasClosestByAttribute(a,"data-type","block-ref")||hasClosestByAttribute(a,"data-type","virtual-block-ref"),ve&&ve.classList.contains("b3-tooltips")&&(ve=void 0),ve||(ve=hasClosestByClassName(a,"popover__block"));const i=hasClosestByAttribute(a,"data-type","a",!0);if(!ve&&i&&((t=i.getAttribute("data-href"))!=null&&t.startsWith("siyuan://blocks"))&&(ve=i),!ve||ve&&((n=window.siyuan.menus.menu.data)!=null&&n.isSameNode(ve))){let l=a;!l.parentElement&&e.path&&e.path[1]&&(l=e.path[1]);const o=hasClosestByClassName(l,"block__popover",!0),r={oid:0};window.siyuan.blockPanels.forEach(d=>{if((d.targetElement||typeof d.x=="number")&&d.element.getAttribute("data-pin")==="true"){const u=parseInt(d.element.getAttribute("data-level")),p=d.element.getAttribute("data-oid");r[p]?u>r[p]&&(r[p]=u):r[p]=u}});const c=parseInt(window.siyuan.menus.menu.element.dataset.from);if(o)for(let d=window.siyuan.blockPanels.length-1;d>=0;d--){const u=window.siyuan.blockPanels[d],p=parseInt(u.element.getAttribute("data-level"));(u.targetElement||typeof u.x=="number")&&p>(r[u.element.getAttribute("data-oid")]||0)&&u.element.getAttribute("data-pin")==="false"&&p>parseInt(o.getAttribute("data-level"))&&(c&&c>=p||u.destroy())}else for(let d=window.siyuan.blockPanels.length-1;d>=0;d--){const u=window.siyuan.blockPanels[d],p=parseInt(u.element.getAttribute("data-level"));(u.targetElement||typeof u.x=="number")&&u.element.getAttribute("data-pin")==="false"&&(c&&c>=p||u.targetElement&&u.targetElement.classList.contains("protyle-wysiwyg__embed")&&u.targetElement.contains(l)||u.destroy())}}},Zd=(e,t)=>{var n,a;if(window.siyuan.config.editor.floatWindowMode===2||hasClosestByClassName(e.target,"history__repo",!0))return!1;if(ve=hasClosestByAttribute(e.target,"data-type","block-ref")||hasClosestByAttribute(e.target,"data-type","virtual-block-ref"),ve&&ve.classList.contains("b3-tooltips")&&(ve=void 0),ve||(ve=hasClosestByClassName(e.target,"popover__block")),!ve&&t){if((n=t.getAttribute("data-href"))!=null&&n.startsWith("siyuan://blocks")&&t.getAttribute("prevent-popover")!=="true")ve=t;else if(t.classList.contains("av__cell")){const s=t.querySelector(".av__celltext--url");s&&s.dataset.type==="url"&&((a=s.dataset.href)!=null&&a.startsWith("siyuan://blocks"))&&(ve=s)}}if(!ve||window.siyuan.altIsPressed||window.siyuan.config.editor.floatWindowMode===0&&window.siyuan.ctrlIsPressed||ve&&ve.getAttribute("prevent-popover")==="true")return!1;if(ve&&getSelection().rangeCount>0){const s=getSelection().getRangeAt(0);if(s.toString()!==""&&ve.contains(s.startContainer))return!1}return!0},Gi=(e,t=!1)=>Zp(void 0,null,function*(){var n,a,s;if(!ve||(n=window.siyuan.menus.menu.data)!=null&&n.isSameNode(ve))return;let i=[],l;const o=ve.getAttribute("data-id");if(o)if(t){const c=yield Ye("/api/block/getRefIDs",{id:o});i=c.data.refDefs,l=c.data.originalRefBlockIDs}else o.startsWith("[")?JSON.parse(o).forEach(c=>{i.push({refID:c})}):i=[{refID:o}];else if(((a=ve.getAttribute("data-type"))==null?void 0:a.indexOf("virtual-block-ref"))>-1){const c=B(ve);c&&(i=(yield Ye("/api/block/getBlockDefIDsByRefText",{anchor:ve.textContent,excludeIDs:[c.getAttribute("data-node-id")]})).data.refDefs)}else if((s=ve.getAttribute("data-type"))!=null&&s.split(" ").includes("a"))i=[{refID:ns(ve.getAttribute("data-href"))}];else if(ve.dataset.type==="url")i=[{refID:ns(ve.textContent.trim())}];else if(ve.dataset.popoverUrl)i=(yield Ye(ve.dataset.popoverUrl,{avID:ve.dataset.avId})).data.refDefs;else{let c,d="/api/block/getRefIDs";if(ve.classList.contains("protyle-attr--refcount"))c=ve.parentElement.parentElement.getAttribute("data-node-id");else if(ve.classList.contains("pdf__rect")){const u=ve.getAttribute("data-relations");u?(u.split(",").forEach(p=>{i.push({refID:p})}),d=""):(c=ve.getAttribute("data-node-id"),d="/api/block/getRefIDsByFileAnnotationID")}else c||(c=ve.parentElement.getAttribute("data-node-id"));if(d){const u=yield Ye(d,{id:c});i=u.data.refDefs,l=u.data.originalRefBlockIDs}}if(i.length===0)return;let r=!1;window.siyuan.blockPanels.find(c=>{if((c.targetElement||typeof c.x=="number")&&c.element.getAttribute("data-pin")==="true"&&JSON.stringify(i)===JSON.stringify(c.refDefs))return r=!0,!0}),!r&&ve.parentElement&&ve.parentElement.style.opacity!=="0.1"&&window.siyuan.blockPanels.push(new Cd({app:e,targetElement:ve,isBacklink:t||ve.classList.contains("protyle-attr--refcount")||ve.classList.contains("counter"),refDefs:i,originalRefBlockIDs:l}))}),ri=(e,t,n)=>{if(t==="general"){if(!window.siyuan.config.keymap[t])return window.siyuan.config.keymap[t]=e,!1}else{if(!window.siyuan.config.keymap[t])return window.siyuan.config.keymap[t]=JSON.parse(JSON.stringify(f.SIYUAN_KEYMAP.editor)),!1;if(!window.siyuan.config.keymap[t][n])return window.siyuan.config.keymap[t][n]=e,!1}let a=!0;return Object.keys(e).forEach(s=>{t==="general"?(!window.siyuan.config.keymap[t][s]||window.siyuan.config.keymap[t][s].default!==e[s].default)&&(a=!1,window.siyuan.config.keymap[t][s]=e[s]):(!window.siyuan.config.keymap[t][n][s]||window.siyuan.config.keymap[t][n][s].default!==e[s].default)&&(a=!1,window.siyuan.config.keymap[t][n][s]=e[s])}),a},ci=(e,t,n)=>{let a=!0;return t==="editor"?Object.keys(window.siyuan.config.keymap[t][n]).length!==Object.keys(f.SIYUAN_KEYMAP[t][n]).length&&Object.keys(window.siyuan.config.keymap[t][n]).forEach(s=>{f.SIYUAN_KEYMAP[t][n][s]||(a=!1,delete window.siyuan.config.keymap[t][n][s])}):Object.keys(window.siyuan.config.keymap[t]).length!==Object.keys(f.SIYUAN_KEYMAP[t]).length&&Object.keys(window.siyuan.config.keymap[t]).forEach(s=>{f.SIYUAN_KEYMAP[t][s]||(a=!1,delete window.siyuan.config.keymap[t][s])}),a},Xp=e=>{const t=ri(f.SIYUAN_KEYMAP.general,"general"),n=ri(f.SIYUAN_KEYMAP.editor.general,"editor","general"),a=ri(f.SIYUAN_KEYMAP.editor.insert,"editor","insert"),s=ri(f.SIYUAN_KEYMAP.editor.heading,"editor","heading"),i=ri(f.SIYUAN_KEYMAP.editor.list,"editor","list"),l=ri(f.SIYUAN_KEYMAP.editor.table,"editor","table"),o=ci(f.SIYUAN_KEYMAP.general,"general"),r=ci(f.SIYUAN_KEYMAP.editor.general,"editor","general"),c=ci(f.SIYUAN_KEYMAP.editor.insert,"editor","insert"),d=ci(f.SIYUAN_KEYMAP.editor.heading,"editor","heading"),u=ci(f.SIYUAN_KEYMAP.editor.list,"editor","list"),p=ci(f.SIYUAN_KEYMAP.editor.table,"editor","table");!window.siyuan.config.readonly&&(!t||!n||!a||!s||!i||!l||!o||!r||!c||!d||!u||!p)&&A("/api/setting/setKeymap",{data:window.siyuan.config.keymap},()=>{})},Jp=(e,t)=>{if(document.getElementById("progress")||document.getElementById("errorLog")||e.isComposing)return!0;const n=e.target;if(e.isTrusted&&Ue(e)&&!e.shiftKey&&!e.altKey&&!["INPUT","TEXTAREA"].includes(n.tagName)&&["0","1","2","3","4","j","k","l",";","s"," ","p","enter","a","s","d","f","q","x"].includes(e.key.toLowerCase())){let a;if(window.siyuan.dialogs.find(s=>{if(s.element.getAttribute("data-key")===f.DIALOG_OPENCARD)return a=s.element,!0}),a||(a=document.querySelector(`.layout__wnd--active div[data-key="${f.DIALOG_OPENCARD}"]:not(.fn__none)`)),a)return e.preventDefault(),a.dispatchEvent(new CustomEvent("click",{detail:e.key.toLowerCase()})),!0}if(Ue(e)&&e.key!=="Escape"&&!e.shiftKey&&!e.altKey&&f.KEYCODELIST[e.keyCode]!=="PageUp"&&f.KEYCODELIST[e.keyCode]!=="PageDown"&&e.key!=="Home"&&e.key!=="End"&&!/^F\d{1,2}$/.test(e.key)&&e.key.indexOf("Arrow")===-1&&e.key!=="Enter"&&e.key!=="Backspace"&&e.key!=="Delete")return!0;!e.altKey&&!e.shiftKey&&bt(e)&&((Lt()?e.key==="Meta":e.key==="Control")||bt(e)?(window.siyuan.ctrlIsPressed=!0,(e.key==="Meta"||e.key==="Control")&&window.siyuan.config.editor.floatWindowMode===1&&!e.repeat&&Gi(t)):window.siyuan.ctrlIsPressed=!1),!e.altKey&&e.shiftKey&&Ue(e)&&(e.key==="Shift"?(window.siyuan.shiftIsPressed=!0,e.repeat||Gi(t,!0)):window.siyuan.shiftIsPressed=!1),e.altKey&&!e.shiftKey&&Ue(e)&&(e.key==="Alt"?window.siyuan.altIsPressed=!0:window.siyuan.altIsPressed=!1)},Qp=(e,t)=>{if(Jp(t,e))return;const n=Dt().protyle;if(Object.keys(window.siyuan.config.keymap.general).find(i=>{if(te(window.siyuan.config.keymap.general[i].custom,t))return Lo({command:i,app:e,protyle:n,previousRange:n.toolbar.range}),!0})){t.preventDefault();return}let s=!1;if(e.plugins.find(i=>{if(i.commands.find(l=>{if(l.callback&&!l.fileTreeCallback&&!l.editorCallback&&!l.dockCallback&&!l.globalCallback&&te(l.customHotkey,t))return s=!0,l.callback(),!0}),s)return!0}),s)return t.preventDefault(),!0};var em=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{o(n.next(r))}catch(c){s(c)}},l=r=>{try{o(n.throw(r))}catch(c){s(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,l);o((n=n.apply(e,t)).next())});class tm{constructor(){this.plugins=[],Kp(`${f.SERVICE_WORKER_PATH}?v=${f.SIYUAN_VERSION}`),fu(),this.appId=f.SIYUAN_APPID,window.siyuan={zIndex:10,notebooks:[],transactions:[],reqIds:{},backStack:[],dialogs:[],blockPanels:[],mobile:{docks:{outline:null,file:null,bookmark:null,tag:null,backlink:null,inbox:null}},ws:new Oi({app:this,id:na(),type:"main",msgCallback:t=>{this.plugins.forEach(n=>{n.eventBus.emit("ws-main",t)}),Ip(this,t)}})},window.addEventListener("click",t=>{!window.siyuan.menus.menu.element.contains(t.target)&&!D(t.target,"data-menu","true")&&window.siyuan.menus.menu.remove();const n=Q(t.target,"protyle-action__copy");if(n){let a=n.parentElement.nextElementSibling.textContent.trimEnd();a=a.replace(/\u00A0/g," "),Be(a),ae(window.siyuan.languages.copied,2e3),t.preventDefault()}}),window.addEventListener("beforeunload",()=>{Pi(window.siyuan.mobile.editor.protyle)},!1),window.addEventListener("pagehide",()=>{Pi(window.siyuan.mobile.editor.protyle)},!1),window.matchMedia("(orientation:portrait)").addEventListener("change",()=>{pd()}),A("/api/system/getConf",{},t=>em(this,null,function*(){ot(`${f.PROTYLE_CDN}/js/lute/lute.min.js?v=${f.SIYUAN_VERSION}`,"protyleLuteScript"),Re(`${f.PROTYLE_CDN}/js/protyle-html.js?v=${f.SIYUAN_VERSION}`,"protyleWcHtmlScript"),window.siyuan.config=t.data.conf,window.siyuan.isPublish=t.data.isPublish,Xp(Ks),yield Yd(this),Ho(()=>{so(`/appearance/langs/${window.siyuan.config.appearance.lang}.json?v=${f.SIYUAN_VERSION}`,n=>{window.siyuan.languages=n,window.siyuan.menus=new Dp(this),document.title=window.siyuan.languages.siyuanNote,vg(),Yo(t.data.conf.appearance),lu(),wu(),A("/api/setting/getCloudUser",{},a=>{window.siyuan.user=a.data,A("/api/system/getEmojiConf",{},s=>{window.siyuan.emojis=s.data,jn(()=>{Vp(this,t.data.start),Sp(this),Gp()})})}),hu()})}),document.addEventListener("touchstart",Pp,!1),document.addEventListener("touchmove",qp,!1),document.addEventListener("touchend",n=>{Np(n,Ks)},!1),window.addEventListener("keydown",n=>{Qp(Ks,n)}),window.addEventListener("keydown",n=>{if(getSelection().rangeCount>0){const a=getSelection().getRangeAt(0),s=Dt();if(a.toString()===""&&s&&s.protyle.wysiwyg.element.contains(a.startContainer)&&!n.altKey&&(n.key==="Backspace"||n.key==="Delete")){const i=B(a.startContainer);if(i&&At(i)){i.classList.add("protyle-wysiwyg--select"),ln(s.protyle,i,a,n.key),n.stopPropagation(),n.preventDefault();return}}}})}))}}const Ks=new tm;window.reconnectWebSocket=()=>{window.siyuan.ws.send("ping",{}),window.siyuan.mobile.docks.file.send("ping",{}),window.siyuan.mobile.editor.protyle.ws.send("ping",{}),window.siyuan.mobile.popEditor.protyle.ws.send("ping",{})},window.goBack=nf,window.showKeyboardToolbar=e=>{document.getElementById("keyboardToolbar").setAttribute("data-keyboardheight",(e||window.outerHeight/2-42).toString()),Hr()},window.hideKeyboardToolbar=tn,window.openFileByURL=e=>e&&du(e)?(at(Ks,ns(e),st("focus",e)==="1"?[f.CB_GET_ALL]:[f.CB_GET_HL,f.CB_GET_CONTEXT,f.CB_GET_ROOTSCROLL]),!0):!1})()})();})();
