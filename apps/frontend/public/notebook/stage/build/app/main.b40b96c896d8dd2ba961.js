var _0=Object.defineProperty;var v0=(Et,ft,Ze)=>ft in Et?_0(Et,ft,{enumerable:!0,configurable:!0,writable:!0,value:Ze}):Et[ft]=Ze;var qu=(Et,ft,Ze)=>(v0(Et,typeof ft!="symbol"?ft+"":ft,Ze),Ze),Fb=(Et,ft,Ze)=>{if(!ft.has(Et))throw TypeError("Cannot "+Ze)};var v=(Et,ft,Ze)=>(Fb(Et,ft,"read from private field"),Ze?Ze.call(Et):ft.get(Et)),D=(Et,ft,Ze)=>{if(ft.has(Et))throw TypeError("Cannot add the same private member more than once");ft instanceof WeakSet?ft.add(Et):ft.set(Et,Ze)},R=(Et,ft,Ze,Yr)=>(Fb(Et,ft,"write to private field"),Yr?Yr.call(Et,Ze):ft.set(Et,Ze),Ze),ih=(Et,ft,Ze,Yr)=>({set _(kt){R(Et,ft,kt,Ze)},get _(){return v(Et,ft,Yr)}}),I=(Et,ft,Ze)=>(Fb(Et,ft,"access private method"),Ze);(()=>{var Et={43:function(kt,Nt,zt){var Ta;(function(bl){"use strict";function W(z,u){var K=(z&65535)+(u&65535),Le=(z>>16)+(u>>16)+(K>>16);return Le<<16|K&65535}function ja(z,u){return z<<u|z>>>32-u}function xt(z,u,K,Le,fe,re){return W(ja(W(W(u,z),W(Le,re)),fe),K)}function ve(z,u,K,Le,fe,re,B){return xt(u&K|~u&Le,z,u,fe,re,B)}function St(z,u,K,Le,fe,re,B){return xt(u&Le|K&~Le,z,u,fe,re,B)}function je(z,u,K,Le,fe,re,B){return xt(u^K^Le,z,u,fe,re,B)}function Tt(z,u,K,Le,fe,re,B){return xt(K^(u|~Le),z,u,fe,re,B)}function It(z,u){z[u>>5]|=128<<u%32,z[(u+64>>>9<<4)+14]=u;var K,Le,fe,re,B,q=1732584193,L=-271733879,P=-1732584194,F=271733878;for(K=0;K<z.length;K+=16)Le=q,fe=L,re=P,B=F,q=ve(q,L,P,F,z[K],7,-680876936),F=ve(F,q,L,P,z[K+1],12,-389564586),P=ve(P,F,q,L,z[K+2],17,606105819),L=ve(L,P,F,q,z[K+3],22,-1044525330),q=ve(q,L,P,F,z[K+4],7,-176418897),F=ve(F,q,L,P,z[K+5],12,1200080426),P=ve(P,F,q,L,z[K+6],17,-1473231341),L=ve(L,P,F,q,z[K+7],22,-45705983),q=ve(q,L,P,F,z[K+8],7,1770035416),F=ve(F,q,L,P,z[K+9],12,-1958414417),P=ve(P,F,q,L,z[K+10],17,-42063),L=ve(L,P,F,q,z[K+11],22,-1990404162),q=ve(q,L,P,F,z[K+12],7,1804603682),F=ve(F,q,L,P,z[K+13],12,-40341101),P=ve(P,F,q,L,z[K+14],17,-1502002290),L=ve(L,P,F,q,z[K+15],22,1236535329),q=St(q,L,P,F,z[K+1],5,-165796510),F=St(F,q,L,P,z[K+6],9,-1069501632),P=St(P,F,q,L,z[K+11],14,643717713),L=St(L,P,F,q,z[K],20,-373897302),q=St(q,L,P,F,z[K+5],5,-701558691),F=St(F,q,L,P,z[K+10],9,38016083),P=St(P,F,q,L,z[K+15],14,-660478335),L=St(L,P,F,q,z[K+4],20,-405537848),q=St(q,L,P,F,z[K+9],5,568446438),F=St(F,q,L,P,z[K+14],9,-1019803690),P=St(P,F,q,L,z[K+3],14,-187363961),L=St(L,P,F,q,z[K+8],20,1163531501),q=St(q,L,P,F,z[K+13],5,-1444681467),F=St(F,q,L,P,z[K+2],9,-51403784),P=St(P,F,q,L,z[K+7],14,1735328473),L=St(L,P,F,q,z[K+12],20,-1926607734),q=je(q,L,P,F,z[K+5],4,-378558),F=je(F,q,L,P,z[K+8],11,-2022574463),P=je(P,F,q,L,z[K+11],16,1839030562),L=je(L,P,F,q,z[K+14],23,-35309556),q=je(q,L,P,F,z[K+1],4,-1530992060),F=je(F,q,L,P,z[K+4],11,1272893353),P=je(P,F,q,L,z[K+7],16,-155497632),L=je(L,P,F,q,z[K+10],23,-1094730640),q=je(q,L,P,F,z[K+13],4,681279174),F=je(F,q,L,P,z[K],11,-358537222),P=je(P,F,q,L,z[K+3],16,-722521979),L=je(L,P,F,q,z[K+6],23,76029189),q=je(q,L,P,F,z[K+9],4,-640364487),F=je(F,q,L,P,z[K+12],11,-421815835),P=je(P,F,q,L,z[K+15],16,530742520),L=je(L,P,F,q,z[K+2],23,-995338651),q=Tt(q,L,P,F,z[K],6,-198630844),F=Tt(F,q,L,P,z[K+7],10,1126891415),P=Tt(P,F,q,L,z[K+14],15,-1416354905),L=Tt(L,P,F,q,z[K+5],21,-57434055),q=Tt(q,L,P,F,z[K+12],6,1700485571),F=Tt(F,q,L,P,z[K+3],10,-1894986606),P=Tt(P,F,q,L,z[K+10],15,-1051523),L=Tt(L,P,F,q,z[K+1],21,-2054922799),q=Tt(q,L,P,F,z[K+8],6,1873313359),F=Tt(F,q,L,P,z[K+15],10,-30611744),P=Tt(P,F,q,L,z[K+6],15,-1560198380),L=Tt(L,P,F,q,z[K+13],21,1309151649),q=Tt(q,L,P,F,z[K+4],6,-145523070),F=Tt(F,q,L,P,z[K+11],10,-1120210379),P=Tt(P,F,q,L,z[K+2],15,718787259),L=Tt(L,P,F,q,z[K+9],21,-343485551),q=W(q,Le),L=W(L,fe),P=W(P,re),F=W(F,B);return[q,L,P,F]}function pt(z){var u,K="",Le=z.length*32;for(u=0;u<Le;u+=8)K+=String.fromCharCode(z[u>>5]>>>u%32&255);return K}function wi(z){var u,K=[];for(K[(z.length>>2)-1]=void 0,u=0;u<K.length;u+=1)K[u]=0;var Le=z.length*8;for(u=0;u<Le;u+=8)K[u>>5]|=(z.charCodeAt(u/8)&255)<<u%32;return K}function zr(z){return pt(It(wi(z),z.length*8))}function Vr(z,u){var K,Le=wi(z),fe=[],re=[],B;for(fe[15]=re[15]=void 0,Le.length>16&&(Le=It(Le,z.length*8)),K=0;K<16;K+=1)fe[K]=Le[K]^909522486,re[K]=Le[K]^1549556828;return B=It(fe.concat(wi(u)),512+u.length*8),pt(It(re.concat(B),640))}function Gi(z){var u="0123456789abcdef",K="",Le,fe;for(fe=0;fe<z.length;fe+=1)Le=z.charCodeAt(fe),K+=u.charAt(Le>>>4&15)+u.charAt(Le&15);return K}function tn(z){return unescape(encodeURIComponent(z))}function yl(z){return zr(tn(z))}function _i(z){return Gi(yl(z))}function la(z,u){return Vr(tn(z),tn(u))}function Lt(z,u){return Gi(la(z,u))}function ji(z,u,K){return u?K?la(u,z):Lt(u,z):K?yl(z):_i(z)}Ta=function(){return ji}.call(Nt,zt,Nt,kt),Ta!==void 0&&(kt.exports=Ta)})(this)},752:function(kt){(function(Nt,zt){kt.exports=zt()})(this,function(){"use strict";var Nt=1e3,zt=6e4,Ta=36e5,bl="millisecond",W="second",ja="minute",xt="hour",ve="day",St="week",je="month",Tt="quarter",It="year",pt="date",wi="Invalid Date",zr=/^(\d{4})[-/]?(\d{1,2})?[-/]?(\d{0,2})[Tt\s]*(\d{1,2})?:?(\d{1,2})?:?(\d{1,2})?[.:]?(\d+)?$/,Vr=/\[([^\]]+)]|Y{1,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,Gi={name:"en",weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_")},tn=function(fe,re,B){var q=String(fe);return!q||q.length>=re?fe:""+Array(re+1-q.length).join(B)+fe},yl={s:tn,z:function(fe){var re=-fe.utcOffset(),B=Math.abs(re),q=Math.floor(B/60),L=B%60;return(re<=0?"+":"-")+tn(q,2,"0")+":"+tn(L,2,"0")},m:function fe(re,B){if(re.date()<B.date())return-fe(B,re);var q=12*(B.year()-re.year())+(B.month()-re.month()),L=re.clone().add(q,je),P=B-L<0,F=re.clone().add(q+(P?-1:1),je);return+(-(q+(B-L)/(P?L-F:F-L))||0)},a:function(fe){return fe<0?Math.ceil(fe)||0:Math.floor(fe)},p:function(fe){return{M:je,y:It,w:St,d:ve,D:pt,h:xt,m:ja,s:W,ms:bl,Q:Tt}[fe]||String(fe||"").toLowerCase().replace(/s$/,"")},u:function(fe){return fe===void 0}},_i="en",la={};la[_i]=Gi;var Lt=function(fe){return fe instanceof K},ji=function fe(re,B,q){var L;if(!re)return _i;if(typeof re=="string"){var P=re.toLowerCase();la[P]&&(L=P),B&&(la[P]=B,L=P);var F=re.split("-");if(!L&&F.length>1)return fe(F[0])}else{var Pe=re.name;la[Pe]=re,L=Pe}return!q&&L&&(_i=L),L||!q&&_i},z=function(fe,re){if(Lt(fe))return fe.clone();var B=typeof re=="object"?re:{};return B.date=fe,B.args=arguments,new K(B)},u=yl;u.l=ji,u.i=Lt,u.w=function(fe,re){return z(fe,{locale:re.$L,utc:re.$u,x:re.$x,$offset:re.$offset})};var K=function(){function fe(B){this.$L=ji(B.locale,null,!0),this.parse(B)}var re=fe.prototype;return re.parse=function(B){this.$d=function(q){var L=q.date,P=q.utc;if(L===null)return new Date(NaN);if(u.u(L))return new Date;if(L instanceof Date)return new Date(L);if(typeof L=="string"&&!/Z$/i.test(L)){var F=L.match(zr);if(F){var Pe=F[2]-1||0,bt=(F[7]||"0").substring(0,3);return P?new Date(Date.UTC(F[1],Pe,F[3]||1,F[4]||0,F[5]||0,F[6]||0,bt)):new Date(F[1],Pe,F[3]||1,F[4]||0,F[5]||0,F[6]||0,bt)}}return new Date(L)}(B),this.$x=B.x||{},this.init()},re.init=function(){var B=this.$d;this.$y=B.getFullYear(),this.$M=B.getMonth(),this.$D=B.getDate(),this.$W=B.getDay(),this.$H=B.getHours(),this.$m=B.getMinutes(),this.$s=B.getSeconds(),this.$ms=B.getMilliseconds()},re.$utils=function(){return u},re.isValid=function(){return this.$d.toString()!==wi},re.isSame=function(B,q){var L=z(B);return this.startOf(q)<=L&&L<=this.endOf(q)},re.isAfter=function(B,q){return z(B)<this.startOf(q)},re.isBefore=function(B,q){return this.endOf(q)<z(B)},re.$g=function(B,q,L){return u.u(B)?this[q]:this.set(L,B)},re.unix=function(){return Math.floor(this.valueOf()/1e3)},re.valueOf=function(){return this.$d.getTime()},re.startOf=function(B,q){var L=this,P=!!u.u(q)||q,F=u.p(B),Pe=function(Je,Oe){var Ia=u.w(L.$u?Date.UTC(L.$y,Oe,Je):new Date(L.$y,Oe,Je),L);return P?Ia:Ia.endOf(ve)},bt=function(Je,Oe){return u.w(L.toDate()[Je].apply(L.toDate("s"),(P?[0,0,0,0]:[23,59,59,999]).slice(Oe)),L)},it=this.$W,et=this.$M,Hn=this.$D,le="set"+(this.$u?"UTC":"");switch(F){case It:return P?Pe(1,0):Pe(31,11);case je:return P?Pe(1,et):Pe(0,et+1);case St:var Ln=this.$locale().weekStart||0,Ki=(it<Ln?it+7:it)-Ln;return Pe(P?Hn-Ki:Hn+(6-Ki),et);case ve:case pt:return bt(le+"Hours",0);case xt:return bt(le+"Minutes",1);case ja:return bt(le+"Seconds",2);case W:return bt(le+"Milliseconds",3);default:return this.clone()}},re.endOf=function(B){return this.startOf(B,!1)},re.$set=function(B,q){var L,P=u.p(B),F="set"+(this.$u?"UTC":""),Pe=(L={},L[ve]=F+"Date",L[pt]=F+"Date",L[je]=F+"Month",L[It]=F+"FullYear",L[xt]=F+"Hours",L[ja]=F+"Minutes",L[W]=F+"Seconds",L[bl]=F+"Milliseconds",L)[P],bt=P===ve?this.$D+(q-this.$W):q;if(P===je||P===It){var it=this.clone().set(pt,1);it.$d[Pe](bt),it.init(),this.$d=it.set(pt,Math.min(this.$D,it.daysInMonth())).$d}else Pe&&this.$d[Pe](bt);return this.init(),this},re.set=function(B,q){return this.clone().$set(B,q)},re.get=function(B){return this[u.p(B)]()},re.add=function(B,q){var L,P=this;B=Number(B);var F=u.p(q),Pe=function(et){var Hn=z(P);return u.w(Hn.date(Hn.date()+Math.round(et*B)),P)};if(F===je)return this.set(je,this.$M+B);if(F===It)return this.set(It,this.$y+B);if(F===ve)return Pe(1);if(F===St)return Pe(7);var bt=(L={},L[ja]=zt,L[xt]=Ta,L[W]=Nt,L)[F]||1,it=this.$d.getTime()+B*bt;return u.w(it,this)},re.subtract=function(B,q){return this.add(-1*B,q)},re.format=function(B){var q=this,L=this.$locale();if(!this.isValid())return L.invalidDate||wi;var P=B||"YYYY-MM-DDTHH:mm:ssZ",F=u.z(this),Pe=this.$H,bt=this.$m,it=this.$M,et=L.weekdays,Hn=L.months,le=function(Oe,Ia,At,Ks){return Oe&&(Oe[Ia]||Oe(q,P))||At[Ia].slice(0,Ks)},Ln=function(Oe){return u.s(Pe%12||12,Oe,"0")},Ki=L.meridiem||function(Oe,Ia,At){var Ks=Oe<12?"AM":"PM";return At?Ks.toLowerCase():Ks},Je={YY:String(this.$y).slice(-2),YYYY:this.$y,M:it+1,MM:u.s(it+1,2,"0"),MMM:le(L.monthsShort,it,Hn,3),MMMM:le(Hn,it),D:this.$D,DD:u.s(this.$D,2,"0"),d:String(this.$W),dd:le(L.weekdaysMin,this.$W,et,2),ddd:le(L.weekdaysShort,this.$W,et,3),dddd:et[this.$W],H:String(Pe),HH:u.s(Pe,2,"0"),h:Ln(1),hh:Ln(2),a:Ki(Pe,bt,!0),A:Ki(Pe,bt,!1),m:String(bt),mm:u.s(bt,2,"0"),s:String(this.$s),ss:u.s(this.$s,2,"0"),SSS:u.s(this.$ms,3,"0"),Z:F};return P.replace(Vr,function(Oe,Ia){return Ia||Je[Oe]||F.replace(":","")})},re.utcOffset=function(){return 15*-Math.round(this.$d.getTimezoneOffset()/15)},re.diff=function(B,q,L){var P,F=u.p(q),Pe=z(B),bt=(Pe.utcOffset()-this.utcOffset())*zt,it=this-Pe,et=u.m(this,Pe);return et=(P={},P[It]=et/12,P[je]=et,P[Tt]=et/3,P[St]=(it-bt)/6048e5,P[ve]=(it-bt)/864e5,P[xt]=it/Ta,P[ja]=it/zt,P[W]=it/Nt,P)[F]||it,L?et:u.a(et)},re.daysInMonth=function(){return this.endOf(je).$D},re.$locale=function(){return la[this.$L]},re.locale=function(B,q){if(!B)return this.$L;var L=this.clone(),P=ji(B,q,!0);return P&&(L.$L=P),L},re.clone=function(){return u.w(this.$d,this)},re.toDate=function(){return new Date(this.valueOf())},re.toJSON=function(){return this.isValid()?this.toISOString():null},re.toISOString=function(){return this.$d.toISOString()},re.toString=function(){return this.$d.toUTCString()},fe}(),Le=K.prototype;return z.prototype=Le,[["$ms",bl],["$s",W],["$m",ja],["$H",xt],["$W",ve],["$M",je],["$y",It],["$D",pt]].forEach(function(fe){Le[fe[1]]=function(re){return this.$g(re,fe[0],fe[1])}}),z.extend=function(fe,re){return fe.$i||(fe(re,K,z),fe.$i=!0),z},z.locale=ji,z.isDayjs=Lt,z.unix=function(fe){return z(1e3*fe)},z.en=la[_i],z.Ls=la,z.p={},z})},119:kt=>{"use strict";kt.exports=window.pdfjsLib},843:kt=>{function Nt(zt){return Promise.resolve().then(()=>{var Ta=new Error("Cannot find module '"+zt+"'");throw Ta.code="MODULE_NOT_FOUND",Ta})}Nt.keys=()=>[],Nt.resolve=Nt,Nt.id=843,kt.exports=Nt}},ft={};function Ze(kt){var Nt=ft[kt];if(Nt!==void 0)return Nt.exports;var zt=ft[kt]={exports:{}};return Et[kt].call(zt.exports,zt,zt.exports,Ze),zt.exports}Ze.d=(kt,Nt)=>{for(var zt in Nt)Ze.o(Nt,zt)&&!Ze.o(kt,zt)&&Object.defineProperty(kt,zt,{enumerable:!0,get:Nt[zt]})},Ze.o=(kt,Nt)=>Object.prototype.hasOwnProperty.call(kt,Nt),Ze.r=kt=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(kt,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(kt,"__esModule",{value:!0})};var Yr={};(()=>{var ms,Do,bs,Zl,$o,ys,Bp,kk,Jl,Gc,jc,Kc,Mo,Ri,Zc,Xl,Ql,Yn,qp,Sk,Fp,Lk,Jc,Xc,Qt,Qc,ed,di,td,Po,No,er,_s,ia,nd,ad,tr,nr,Ea,ar,ir,id,vs,sa,sd,Kt,Ho,Oi,hl,sr,sh,Ro,Fu,Wp,xk,od,Ub,ka,yi,Yp,Ak,ld,Wb,zp,Ck,Vp,Tk,or,oh,rd,Yb,Gp,Ik,Oo,ui,Bo,qo,lr,Es,ks,cd,Fo,Uu,dd,zb,ud,Vb,fd,Gb,Ss,Br,jp,Dk,Kp,$k,pd,rr,gd,hd,jb,md,Kb,Zp,Mk,bd,Zb,yd,Jb,wd,Xb,Uo,Wu,Jp,Pk,cr,Ls,Sa,Bi,Wo,_d,vd,Qb,Qp,Nk,Ed,ey,eg,Hk,tg,Rk,ng,Ok,ag,Bk,xs,fi,dr,lh,ig,qk,La,kd,ty,Yo,Yu,Sd,ny,sg,Fk,Ld,ay,og,Uk,un,ur,zo,lg,Wk,xd,iy,Ad,sy,rg,Yk,cg,zk,Cd,oy,dg,Vk,ug,Gk,fr,rh,Vo,zu,As,qr,fg,jk,Td,ly,Id,ry,pr,ch,pg,Kk,Dd,cy,$d,dy,Go,Vu,Md,gr,gg,Zk,Cs,za,Vi,hr,dh,mr,uh,Ts,Fr,br,fh,Pd,uy,hg,Jk,mg,Xk,Nd,fy,bg,Qk,yg,eS,Hd,py,yr,Sn,Is,Ds,wg,tS,jo,Gu,_g,nS,vg,aS,Eg,iS,kg,sS,Rd,gy,Sg,oS,Ko,ju,Lg,lS,xg,rS,Ag,cS,Cg,dS,Od,hy,pi,Zo,Bd,Jo,Xo,qd,Nn,qi,wr,en,xa,Tg,uS,_r,ph,Fd,my,Ig,fS,Qo,Ku,Ud,el,Wd,$s,Ms,Ur,Dg,pS,Yd,by,$g,gS,vr,gh,Mg,hS,zd,yy,Er,Vd,wy,Gd,_y,jd,vy,Kd,Ey,Pg,mS,Fi,ml,Ng,bS,Zd,ky,Jd,Sy,Hg,yS,Rg,wS,Og,_S,Xd,Qd,eu,tu,nu,kr,au,Ps,iu,Ly,gi,Sr,Va,Lr,xr,Ar,Ns,su,xy,Bg,vS,ou,Ay,Ui,Aa,Wi,Hs,Cr,hh,lu,Cy,Rs,cu,du,tl,hi,zn,Os,qg,ES,Fg,kS,Ug,SS,nl,fu,al,pu,Bs,qs,gu,hu,mu,il,Tr,Ir,Yi,sl,Fs,Us,Wr,Dr,mh,ol,Zu,bu,Ty,yu,Iy,wu,Dy,_u,$y,vu,My,Wg,LS,Yg,xS,Eu,Py,zi,ll,ku,Ny,Ws,Su,Lu,mi,oa,rl,xu,Au,Cu,Tu,Iu,Du,Ys,cl,dl,ul,$r,zs,Mr,$u,Pr,fl,Vs,Nr,zg,AS,Vg,CS,Gg,TS,pl,Ju,Hr,bh,jg,IS,Mu,Hy,Kg,DS,bi,js,Pu,Ry,Zg,$S,Jg,MS,Xg,PS,Nu,Oy,Qg,NS,Rr,yh,Ga,Or,wh,eh,HS,th,RS,Hu,By,Ru,qy,Gs,Ou,Fy,nh,OS,ah,BS,Bu,Uy,gl,Xu;"use strict";var kt={};Ze.r(kt),Ze.d(kt,{copyPlainText:()=>Zi,getEventName:()=>Gr,getLocalStorage:()=>Vy,isDisabledFeature:()=>FS,isHuawei:()=>tf,isIPad:()=>Da,isIPhone:()=>nf,isInAndroid:()=>fn,isInHarmony:()=>pn,isInIOS:()=>ra,isMac:()=>gt,isNotCtrl:()=>qe,isOnlyMeta:()=>Dt,isWin11:()=>Yy,isWindows:()=>zy,openByMobile:()=>Ht,readClipboard:()=>ef,readText:()=>Qu,setStorageVal:()=>ue,updateHotkeyTip:()=>X,writeText:()=>De});const Nt=new Set(["docker","ios","android","harmony"]),zt=new Set(["ios","android","harmony"]),Ta=()=>Nt.has(window.siyuan.config.system.container),bl=()=>zt.has(window.siyuan.config.system.container),W=()=>!!document.getElementById("sidebar"),ja=()=>Ta()?window.siyuan.config.system.container:window.siyuan.config.system.os,xt=()=>window.navigator.userAgent.startsWith("SiYuan/")?ve()?"desktop-window":"desktop":"browser-desktop",ve=()=>!document.getElementById("toolbar"),St=()=>"ontouchstart"in window&&navigator.maxTouchPoints>1,je=(t,e)=>t.length===e.length&&t.every(n=>e.includes(n)),Tt=(t,e)=>Math.floor(Math.random()*(e-t+1))+t,It=(t,e=window.location.search)=>{const n=e.substring(e.indexOf("?")),a=n.indexOf("#");return new URLSearchParams(n.substring(0,a>=0?a:void 0)).get(t)},pt=()=>!1,wi=t=>/^\(\(\d{14}-\w{7} '.*'\)\)$/.test(t),zr=t=>/^<<assets\/.+\/\d{14}-\w{7} ".+">>$/.test(t),Vr=t=>/^[_a-zA-Z][_.\-0-9a-zA-Z]*$/.test(t),Gi=t=>Function(`"use strict";return (${t})`)(),tn=(t,e)=>{if(t===e||typeof t=="number"&&isNaN(t)&&typeof e=="number"&&isNaN(e))return!0;if(t instanceof Date&&e instanceof Date)return t.getTime()===e.getTime();if(!t||!e||typeof t!="object"&&typeof e!="object")return t===e;if(t.prototype!==e.prototype)return!1;const n=Object.keys(t);return n.length!==Object.keys(e).length?!1:n.every(a=>tn(t[a],e[a]))},yl=t=>{const e=t.match(/^(.*) \((\d+)\)$/);return e?t=`${e[1]} (${parseInt(e[2])+1})`:t=`${t} (1)`,t},_i="3.1.24",la="production",Lt=navigator.platform.toUpperCase().indexOf("MAC")>-1?"\u2303":"\u2325",ji=()=>{const t={};for(let e=1;e<=32;e++)t[e+111]="F"+e;return t},z=class{};let u=z;u.SIYUAN_VERSION=_i,u.NODE_ENV=la,u.SIYUAN_APPID=Math.random().toString(36).substring(8),u.ASSETS_ADDRESS="https://assets.b3logfile.com/siyuan/",u.PROTYLE_CDN="/stage/protyle",u.UPLOAD_ADDRESS="/upload",u.SERVICE_WORKER_PATH="/service-worker.js",u.SIYUAN_DROP_FILE="application/siyuan-file",u.SIYUAN_DROP_GUTTER="application/siyuan-gutter",u.SIYUAN_DROP_TAB="application/siyuan-tab",u.SIYUAN_DROP_EDITOR="application/siyuan-editor",u.SIYUAN_CMD="siyuan-cmd",u.SIYUAN_GET="siyuan-get",u.SIYUAN_EVENT="siyuan-event",u.SIYUAN_CONFIG_TRAY="siyuan-config-tray",u.SIYUAN_QUIT="siyuan-quit",u.SIYUAN_HOTKEY="siyuan-hotkey",u.SIYUAN_INIT="siyuan-init",u.SIYUAN_SEND_WINDOWS="siyuan-send-windows",u.SIYUAN_SAVE_CLOSE="siyuan-save-close",u.SIYUAN_AUTO_LAUNCH="siyuan-auto-launch",u.SIYUAN_OPEN_WORKSPACE="siyuan-open-workspace",u.SIYUAN_OPEN_URL="siyuan-open-url",u.SIYUAN_OPEN_WINDOW="siyuan-open-window",u.SIYUAN_OPEN_FOLDER="siyuan-open-folder",u.SIYUAN_OPEN_FILE="siyuan-open-file",u.SIYUAN_EXPORT_PDF="siyuan-export-pdf",u.SIYUAN_EXPORT_NEWWINDOW="siyuan-export-newwindow",u.SIYUAN_CONTEXT_MENU="siyuan-context-menu",u.SIYUAN_SHOW_WINDOW="siyuan-show-window",u.CUSTOM_SY_READONLY="custom-sy-readonly",u.CUSTOM_SY_FULLWIDTH="custom-sy-fullwidth",u.CUSTOM_SY_AV_VIEW="custom-sy-av-view",u.CUSTOM_REMINDER_WECHAT="custom-reminder-wechat",u.CUSTOM_RIFF_DECKS="custom-riff-decks",u.SIZE_DATABASE_MAZ_SIZE=102400,u.SIZE_SCROLL_TB=24,u.SIZE_SCROLL_STEP=256,u.SIZE_LINK_TEXT_MAX=64,u.SIZE_TOOLBAR_HEIGHT=W()?0:32,u.SIZE_GET_MAX=102400,u.SIZE_UNDO=64,u.SIZE_TITLE=512,u.SIZE_EDITOR_WIDTH=760,u.SIZE_ZOOM=[{zoom:.67,position:{x:0,y:2}},{zoom:.75,position:{x:1,y:4}},{zoom:.8,position:{x:2,y:4}},{zoom:.9,position:{x:5,y:6}},{zoom:1,position:{x:8,y:8}},{zoom:1.1,position:{x:12,y:9}},{zoom:1.25,position:{x:18,y:12}},{zoom:1.5,position:{x:27,y:16}},{zoom:1.75,position:{x:36,y:20}},{zoom:2,position:{x:45,y:23}},{zoom:2.5,position:{x:63,y:31}},{zoom:3,position:{x:80,y:39}}],u.CB_MOVE_NOLIST="cb-move-nolist",u.CB_MOUNT_REMOVE="cb-mount-remove",u.CB_GET_APPEND="cb-get-append",u.CB_GET_BEFORE="cb-get-before",u.CB_GET_UNCHANGEID="cb-get-unchangeid",u.CB_GET_HL="cb-get-hl",u.CB_GET_FOCUS="cb-get-focus",u.CB_GET_FOCUSFIRST="cb-get-focusfirst",u.CB_GET_SETID="cb-get-setid",u.CB_GET_ALL="cb-get-all",u.CB_GET_BACKLINK="cb-get-backlink",u.CB_GET_UNUNDO="cb-get-unundo",u.CB_GET_SCROLL="cb-get-scroll",u.CB_GET_CONTEXT="cb-get-context",u.CB_GET_ROOTSCROLL="cb-get-rootscroll",u.CB_GET_HTML="cb-get-html",u.CB_GET_HISTORY="cb-get-history",u.CB_GET_OPENNEW="cb-get-opennew",u.LOCAL_ZOOM="local-zoom",u.LOCAL_SEARCHDATA="local-searchdata",u.LOCAL_SEARCHKEYS="local-searchkeys",u.LOCAL_SEARCHASSET="local-searchasset",u.LOCAL_SEARCHUNREF="local-searchunref",u.LOCAL_DOCINFO="local-docinfo",u.LOCAL_DAILYNOTEID="local-dailynoteid",u.LOCAL_HISTORY="local-history",u.LOCAL_CODELANG="local-codelang",u.LOCAL_FONTSTYLES="local-fontstyles",u.LOCAL_EXPORTPDF="local-exportpdf",u.LOCAL_EXPORTWORD="local-exportword",u.LOCAL_EXPORTIMG="local-exportimg",u.LOCAL_BAZAAR="local-bazaar",u.LOCAL_PDFTHEME="local-pdftheme",u.LOCAL_LAYOUTS="local-layouts",u.LOCAL_AI="local-ai",u.LOCAL_PLUGINTOPUNPIN="local-plugintopunpin",u.LOCAL_FLASHCARD="local-flashcard",u.LOCAL_FILEPOSITION="local-fileposition",u.LOCAL_FILESPATHS="local-filespaths",u.LOCAL_DIALOGPOSITION="local-dialogposition",u.LOCAL_SESSION_FIRSTLOAD="local-session-firstload",u.LOCAL_OUTLINE="local-outline",u.LOCAL_PLUGIN_DOCKS="local-plugin-docks",u.LOCAL_IMAGES="local-images",u.LOCAL_EMOJIS="local-emojis",u.LOCAL_MOVE_PATH="local-move-path",u.DIALOG_CONFIRM="dialog-confirm",u.DIALOG_OPENCARD="dialog-opencard",u.DIALOG_MAKECARD="dialog-makecard",u.DIALOG_VIEWCARDS="dialog-viewcards",u.DIALOG_DIALYNOTE="dialog-dialynote",u.DIALOG_RECENTDOCS="dialog-recentdocs",u.DIALOG_SWITCHTAB="dialog-switchtab",u.DIALOG_SEARCH="dialog-search",u.DIALOG_REPLACE="dialog-replace",u.DIALOG_GLOBALSEARCH="dialog-globalsearch",u.DIALOG_HISTORYCOMPARE="dialog-historycompare",u.DIALOG_ACCESSAUTHCODE="dialog-accessauthcode",u.DIALOG_AICUSTOMACTION="dialog-aicustomaction",u.DIALOG_AIUPDATECUSTOMACTION="dialog-aiupdatecustomaction",u.DIALOG_BACKGROUNDLINK="dialog-backgroundlink",u.DIALOG_BACKGROUNDRANDOM="dialog-backgroundrandom",u.DIALOG_CHANGELOG="dialog-changelog",u.DIALOG_COMMANDPANEL="dialog-commandpanel",u.DIALOG_DEACTIVATEUSER="dialog-deactivateuser",u.DIALOG_EMOJIS="dialog-emojis",u.DIALOG_EXPORTIMAGE="dialog-exportimage",u.DIALOG_EXPORTTEMPLATE="dialog-exporttemplate",u.DIALOG_EXPORTWORD="dialog-exportword",u.DIALOG_HISTORY="dialog-history",u.DIALOG_HISTORYDOC="dialog-historydoc",u.DIALOG_MOVEPATHTO="dialog-movepathto",u.DIALOG_RENAME="dialog-rename",u.DIALOG_RENAMEASSETS="dialog-renameassets",u.DIALOG_RENAMEBOOKMARK="dialog-renamebookmark",u.DIALOG_RENAMETAG="dialog-renametag",u.DIALOG_REPLACETYPE="dialog-replacetype",u.DIALOG_SAVECRITERION="dialog-savecriterion",u.DIALOG_SEARCHTYPE="dialog-searchtype",u.DIALOG_SEARCHASSETSTYPE="dialog-searchassetstype",u.DIALOG_SETTING="dialog-setting",u.DIALOG_SNAPSHOTTAG="dialog-snapshottag",u.DIALOG_SNAPSHOTMEMO="dialog-snapshotmemo",u.DIALOG_SNIPPETS="dialog-snippets",u.DIALOG_SYNCADDCLOUDDIR="dialog-syncaddclouddir",u.DIALOG_SYNCCHOOSEDIR="dialog-syncchoosedir",u.DIALOG_SYNCCHOOSEDIRECTION="dialog-syncchoosedirection",u.DIALOG_TRANSFERBLOCKREF="dialog-transferblockref",u.DIALOG_WECHATREMINDER="dialog-wechatreminder",u.DIALOG_PASSWORD="dialog-password",u.DIALOG_SETPASSWORD="dialog-setpassword",u.DIALOG_BOOTSYNCFAILED="dialog-bootsyncfailed",u.DIALOG_KERNELFAULT="dialog-kernelfault",u.DIALOG_STATEEXCEPTED="dialog-stateexcepted",u.DIALOG_ATTR="dialog-attr",u.DIALOG_SETCUSTOMATTR="dialog-setcustomattr",u.DIALOG_CREATENOTEBOOK="dialog-createnotebook",u.DIALOG_NOTEBOOKCONF="dialog-notebookconf",u.DIALOG_CREATEWORKSPACE="dialog-createworkspace",u.DIALOG_OPENWORKSPACE="dialog-openworkspace",u.DIALOG_SAVEWORKSPACE="dialog-saveworkspace",u.TIMEOUT_DBLCLICK=190,u.TIMEOUT_INPUT=256,u.TIMEOUT_LOAD=300,u.TIMEOUT_TRANSITION=300,u.TIMEOUT_COUNT=1e3,u.HELP_PATH={zh_CN:"20210808180117-czj9bvb",zh_CHT:"20211226090932-5lcq56f",ja_JP:"20240530133126-axarxgx",en_US:"20210808180117-6v0mkxr",fr_FR:"20210808180117-6v0mkxr",es_ES:"20210808180117-6v0mkxr",it_IT:"20210808180117-6v0mkxr",de_DE:"20210808180117-6v0mkxr",he_IL:"20210808180117-6v0mkxr",ru_RU:"20210808180117-6v0mkxr",pl_PL:"20210808180117-6v0mkxr",ar_SA:"20210808180117-6v0mkxr"},u.QUICK_DECK_ID="20230218211946-2kw8jgx",u.KEYCODELIST=Object.assign(ji(),{8:"\u232B",9:"\u21E5",13:"\u21A9",16:"\u21E7",17:"\u2303",18:"\u2325",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"\u2190",38:"\u2191",39:"\u2192",40:"\u2193",44:"PrintScreen",45:"Insert",46:"\u2326",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",65:"A",66:"B",67:"C",68:"D",69:"E",70:"F",71:"G",72:"H",73:"I",74:"J",75:"K",76:"L",77:"M",78:"N",79:"O",80:"P",81:"Q",82:"R",83:"S",84:"T",85:"U",86:"V",87:"W",88:"X",89:"Y",90:"Z",91:"\u2318",92:"\u2318",93:"ContextMenu",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"*",107:"+",109:"-",110:".",111:"/",144:"NumLock",145:"ScrollLock",182:"MyComputer",183:"MyCalculator",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"}),u.SIYUAN_KEYMAP={general:{mainMenu:{default:"\u2325\\",custom:"\u2325\\"},commandPanel:{default:"\u2325\u21E7P",custom:"\u2325\u21E7P"},editReadonly:{default:"\u21E7\u2318G",custom:"\u21E7\u2318G"},syncNow:{default:"F9",custom:"F9"},enterBack:{default:"\u2325\u2190",custom:"\u2325\u2190"},enter:{default:"\u2325\u2192",custom:"\u2325\u2192"},goForward:{default:"\u2318]",custom:"\u2318]"},goBack:{default:"\u2318[",custom:"\u2318["},newFile:{default:"\u2318N",custom:"\u2318N"},search:{default:"\u2318F",custom:"\u2318F"},globalSearch:{default:"\u2318P",custom:"\u2318P"},stickSearch:{default:"\u21E7\u2318F",custom:"\u21E7\u2318F"},replace:{default:"\u2318R",custom:"\u2318R"},closeTab:{default:"\u2318W",custom:"\u2318W"},fileTree:{default:Lt+"1",custom:Lt+"1"},outline:{default:Lt+"2",custom:Lt+"2"},bookmark:{default:Lt+"3",custom:Lt+"3"},tag:{default:Lt+"4",custom:Lt+"4"},dailyNote:{default:Lt+"5",custom:Lt+"5"},inbox:{default:Lt+"6",custom:Lt+"6"},backlinks:{default:Lt+"7",custom:Lt+"7"},graphView:{default:Lt+"8",custom:Lt+"8"},globalGraph:{default:Lt+"9",custom:Lt+"9"},riffCard:{default:Lt+"0",custom:Lt+"0"},config:{default:"\u2325P",custom:"\u2325P"},dataHistory:{default:"\u2325H",custom:"\u2325H"},toggleWin:{default:"\u2325M",custom:"\u2325M"},lockScreen:{default:"\u2325N",custom:"\u2325N"},recentDocs:{default:"\u2318E",custom:"\u2318E"},goToTab1:{default:"\u23181",custom:"\u23181"},goToTab2:{default:"\u23182",custom:"\u23182"},goToTab3:{default:"\u23183",custom:"\u23183"},goToTab4:{default:"\u23184",custom:"\u23184"},goToTab5:{default:"\u23185",custom:"\u23185"},goToTab6:{default:"\u23186",custom:"\u23186"},goToTab7:{default:"\u23187",custom:"\u23187"},goToTab8:{default:"\u23188",custom:"\u23188"},goToTab9:{default:"\u23189",custom:"\u23189"},goToTabNext:{default:"\u21E7\u2318]",custom:"\u21E7\u2318]"},goToTabPrev:{default:"\u21E7\u2318[",custom:"\u21E7\u2318["},goToEditTabNext:{default:"\u2303\u21E5",custom:"\u2303\u21E5"},goToEditTabPrev:{default:"\u2303\u21E7\u21E5",custom:"\u2303\u21E7\u21E5"},move:{default:"",custom:""},selectOpen1:{default:"",custom:""},toggleDock:{default:"",custom:""},splitLR:{default:"",custom:""},splitMoveR:{default:"",custom:""},splitTB:{default:"",custom:""},splitMoveB:{default:"",custom:""},closeOthers:{default:"",custom:""},closeAll:{default:"",custom:""},closeUnmodified:{default:"",custom:""},closeLeft:{default:"",custom:""},closeRight:{default:"",custom:""},tabToWindow:{default:"",custom:""},addToDatabase:{default:"",custom:""},unsplit:{default:"",custom:""},unsplitAll:{default:"",custom:""}},editor:{general:{duplicate:{default:"\u2318D",custom:"\u2318D"},expandDown:{default:"\u2325\u21E7\u2193",custom:"\u2325\u21E7\u2193"},expandUp:{default:"\u2325\u21E7\u2191",custom:"\u2325\u21E7\u2191"},expand:{default:"\u2318\u2193",custom:"\u2318\u2193"},collapse:{default:"\u2318\u2191",custom:"\u2318\u2191"},insertBottom:{default:"\u2325\u2318.",custom:"\u2325\u2318."},refTab:{default:"\u21E7\u2318.",custom:"\u21E7\u2318."},openBy:{default:"\u2325,",custom:"\u2325,"},insertRight:{default:"\u2325.",custom:"\u2325."},attr:{default:"\u2325\u2318A",custom:"\u2325\u2318A"},quickMakeCard:{default:"\u2325\u2318F",custom:"\u2325\u2318F"},refresh:{default:"F5",custom:"F5"},copyBlockRef:{default:"\u21E7\u2318C",custom:"\u21E7\u2318C"},copyProtocol:{default:"\u21E7\u2318H",custom:"\u21E7\u2318H"},copyBlockEmbed:{default:"\u21E7\u2318E",custom:"\u21E7\u2318E"},copyHPath:{default:"\u21E7\u2318P",custom:"\u21E7\u2318P"},undo:{default:"\u2318Z",custom:"\u2318Z"},redo:{default:"\u2318Y",custom:"\u2318Y"},rename:{default:"F2",custom:"F2"},newNameFile:{default:"F3",custom:"F3"},newContentFile:{default:"F4",custom:"F4"},newNameSettingFile:{default:"\u2318F3",custom:"\u2318F3"},showInFolder:{default:"\u2325A",custom:"\u2325A"},outline:{default:"\u2325O",custom:"\u2325O"},backlinks:{default:"\u2325B",custom:"\u2325B"},graphView:{default:"\u2325G",custom:"\u2325G"},spaceRepetition:{default:"\u2325F",custom:"\u2325F"},fullscreen:{default:"\u2325Y",custom:"\u2325Y"},alignLeft:{default:"\u2325L",custom:"\u2325L"},alignCenter:{default:"\u2325C",custom:"\u2325C"},alignRight:{default:"\u2325R",custom:"\u2325R"},wysiwyg:{default:"\u2325\u23187",custom:"\u2325\u23187"},preview:{default:"\u2325\u23189",custom:"\u2325\u23189"},insertBefore:{default:"\u21E7\u2318B",custom:"\u21E7\u2318B"},insertAfter:{default:"\u21E7\u2318A",custom:"\u21E7\u2318A"},jumpToParentNext:{default:"\u21E7\u2318N",custom:"\u21E7\u2318N"},jumpToParentPrev:{default:"\u21E7\u2318M",custom:"\u21E7\u2318M"},jumpToParent:{default:"\u21E7\u2318J",custom:"\u21E7\u2318J"},moveToUp:{default:"\u21E7\u2318\u2191",custom:"\u21E7\u2318\u2191"},moveToDown:{default:"\u21E7\u2318\u2193",custom:"\u21E7\u2318\u2193"},duplicateCompletely:{default:"",custom:""},copyPlainText:{default:"",custom:""},copyID:{default:"",custom:""},copyProtocolInMd:{default:"",custom:""},netImg2LocalAsset:{default:"",custom:""},netAssets2LocalAssets:{default:"",custom:""},optimizeTypography:{default:"",custom:""},hLayout:{default:"",custom:""},vLayout:{default:"",custom:""},refPopover:{default:"",custom:""},copyText:{default:"",custom:""},exitFocus:{default:"",custom:""},ai:{default:"",custom:""},switchReadonly:{default:"",custom:""},switchAdjust:{default:"",custom:""},rtl:{default:"",custom:""},ltr:{default:"",custom:""},aiWriting:{default:"",custom:""},openInNewTab:{default:"",custom:""}},insert:{appearance:{default:"\u2325\u2318X",custom:"\u2325\u2318X"},lastUsed:{default:"\u2325X",custom:"\u2325X"},ref:{default:"\u2325[",custom:"\u2325["},kbd:{default:"\u2318'",custom:"\u2318'"},sup:{default:"\u2318H",custom:"\u2318H"},sub:{default:"\u2318J",custom:"\u2318J"},bold:{default:"\u2318B",custom:"\u2318B"},"inline-math":{default:"\u2318M",custom:"\u2318M"},memo:{default:"\u2325\u2318M",custom:"\u2325\u2318M"},underline:{default:"\u2318U",custom:"\u2318U"},italic:{default:"\u2318I",custom:"\u2318I"},mark:{default:"\u2325D",custom:"\u2325D"},tag:{default:"\u2318T",custom:"\u2318T"},strike:{default:"\u21E7\u2318S",custom:"\u21E7\u2318S"},"inline-code":{default:"\u2318G",custom:"\u2318G"},link:{default:"\u2318K",custom:"\u2318K"},check:{default:"\u2318L",custom:"\u2318L"},"ordered-list":{default:"",custom:""},list:{default:"",custom:""},table:{default:"\u2318O",custom:"\u2318O"},code:{default:"\u21E7\u2318K",custom:"\u21E7\u2318K"},quote:{default:"",custom:""},clearInline:{default:"\u2318\\",custom:"\u2318\\"}},heading:{paragraph:{default:"\u2325\u23180",custom:"\u2325\u23180"},heading1:{default:"\u2325\u23181",custom:"\u2325\u23181"},heading2:{default:"\u2325\u23182",custom:"\u2325\u23182"},heading3:{default:"\u2325\u23183",custom:"\u2325\u23183"},heading4:{default:"\u2325\u23184",custom:"\u2325\u23184"},heading5:{default:"\u2325\u23185",custom:"\u2325\u23185"},heading6:{default:"\u2325\u23186",custom:"\u2325\u23186"}},list:{indent:{default:"\u21E5",custom:"\u21E5"},outdent:{default:"\u21E7\u21E5",custom:"\u21E7\u21E5"},checkToggle:{default:"\u2318\u21A9",custom:"\u2318\u21A9"}},table:{insertRowAbove:{default:"\u21E7\u2318T",custom:"\u21E7\u2318T"},insertRowBelow:{default:"\u21E7\u2318D",custom:"\u21E7\u2318D"},insertColumnLeft:{default:"\u21E7\u2318L",custom:"\u21E7\u2318L"},insertColumnRight:{default:"\u21E7\u2318R",custom:"\u21E7\u2318R"},moveToUp:{default:"\u2325\u2318T",custom:"\u2325\u2318T"},moveToDown:{default:"\u2325\u2318B",custom:"\u2325\u2318B"},moveToLeft:{default:"\u2325\u2318L",custom:"\u2325\u2318L"},moveToRight:{default:"\u2325\u2318R",custom:"\u2325\u2318R"},"delete-row":{default:"\u2318-",custom:"\u2318-"},"delete-column":{default:"\u21E7\u2318-",custom:"\u21E7\u2318-"}}},plugin:{}},u.SIYUAN_EMPTY_LAYOUT={hideDock:!1,layout:{direction:"tb",size:"0px",type:"normal",instance:"Layout",children:[{direction:"lr",size:"auto",type:"normal",instance:"Layout",children:[{direction:"tb",size:"0px",type:"left",instance:"Layout",children:[{instance:"Wnd",children:[]},{instance:"Wnd",resize:"tb",children:[]}]},{direction:"lr",resize:"lr",size:"auto",type:"center",instance:"Layout",children:[{instance:"Wnd",children:[{instance:"Tab",children:[]}]}]},{direction:"tb",size:"0px",resize:"lr",type:"right",instance:"Layout",children:[{instance:"Wnd",children:[]},{instance:"Wnd",resize:"tb",children:[]}]}]},{direction:"lr",size:"0px",resize:"tb",type:"bottom",instance:"Layout",children:[{instance:"Wnd",children:[]},{instance:"Wnd",resize:"lr",children:[]}]}]},bottom:{pin:!0,data:[]},left:{pin:!0,data:[[{type:"file",size:{width:232,height:0},show:!0,icon:"iconFiles",hotkeyLangId:"fileTree"},{type:"outline",size:{width:232,height:0},show:!1,icon:"iconAlignCenter",hotkeyLangId:"outline"},{type:"inbox",size:{width:320,height:0},show:!1,icon:"iconInbox",hotkeyLangId:"inbox"}],[{type:"bookmark",size:{width:232,height:0},show:!1,icon:"iconBookmark",hotkeyLangId:"bookmark"},{type:"tag",size:{width:232,height:0},show:!1,icon:"iconTags",hotkeyLangId:"tag"}]]},right:{pin:!0,data:[[{type:"graph",size:{width:320,height:0},show:!1,icon:"iconGraph",hotkeyLangId:"graphView"},{type:"globalGraph",size:{width:320,height:0},show:!1,icon:"iconGlobalGraph",hotkeyLangId:"globalGraph"}],[{type:"backlink",size:{width:320,height:0},show:!1,icon:"iconLink",hotkeyLangId:"backlinks"}]]}},u.SIYUAN_DEFAULT_REPLACETYPES={text:!0,imgText:!0,imgTitle:!0,imgSrc:!0,aText:!0,aTitle:!0,aHref:!0,code:!0,em:!0,strong:!0,inlineMath:!0,inlineMemo:!0,blockRef:!0,fileAnnotationRef:!0,kbd:!0,mark:!0,s:!0,sub:!0,sup:!0,tag:!0,u:!0,docTitle:!0,codeBlock:!0,mathBlock:!0,htmlBlock:!0},u.SIYUAN_IMAGE_VIP=`<svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32">
<path fill="#ffd00f" d="M2.288 12.643l23.487 12.853c0.286 0.153 0.477 0.45 0.477 0.791 0 0.082-0.011 0.161-0.032 0.237l0.001-0.006c-0.119 0.395-0.479 0.678-0.905 0.678-0.004 0-0.009-0-0.013-0h-19.439c-0.958 0-1.766-0.684-1.885-1.595l-1.691-12.956z"></path>
<path fill="#ffd00f" d="M29.676 12.643l-1.691 12.957c-0.119 0.911-0.927 1.594-1.884 1.594h-19.442c-0.004 0-0.009 0-0.013 0-0.425 0-0.785-0.281-0.903-0.668l-0.002-0.007c-0.019-0.070-0.031-0.15-0.031-0.232 0-0.341 0.191-0.638 0.472-0.788l0.005-0.002 23.487-12.853z"></path>
<path fill="#ffe668" d="M15.413 8.369l10.394 15.921c0.378 0.579 0.407 1.317 0.076 1.924-0.328 0.591-0.948 0.985-1.66 0.985-0 0-0.001 0-0.001 0h-17.617c-0.694 0-1.331-0.378-1.661-0.985-0.144-0.26-0.229-0.569-0.229-0.899 0-0.382 0.114-0.736 0.31-1.033l-0.004 0.007 10.394-15.921z"></path>
<path fill="#ffdd4e" d="M15.396 8.403l11.659 15.921c0.401 0.579 0.432 1.317 0.081 1.924-0.361 0.594-1.005 0.985-1.741 0.985-0.008 0-0.017-0-0.025-0h-9.344l-0.63-18.83z"></path>
<path fill="#ffd00f" d="M13.868 6.478c0 0.946 0.767 1.712 1.712 1.712s1.712-0.767 1.712-1.712v0c0-0.945-0.766-1.712-1.712-1.712s-1.712 0.766-1.712 1.712v0zM28.577 10.818c0 0.945 0.766 1.712 1.712 1.712s1.712-0.766 1.712-1.712v0c0-0.945-0.766-1.712-1.712-1.712s-1.712 0.766-1.712 1.712v0zM0 10.822c0 0.945 0.766 1.712 1.712 1.712s1.712-0.766 1.712-1.712v0c0-0.945-0.766-1.712-1.712-1.712s-1.712 0.766-1.712 1.712v0z"></path>
</svg>`,u.SIYUAN_ASSETS_IMAGE=[".apng",".ico",".cur",".jpg",".jpe",".jpeg",".jfif",".pjp",".pjpeg",".png",".gif",".webp",".bmp",".svg",".avif"],u.SIYUAN_ASSETS_AUDIO=[".mp3",".wav",".ogg",".m4a",".aac",".flac"],u.SIYUAN_ASSETS_VIDEO=[".mov",".weba",".mkv",".mp4",".webm"],u.SIYUAN_ASSETS_EXTS=[".pdf"].concat(z.SIYUAN_ASSETS_IMAGE).concat(z.SIYUAN_ASSETS_AUDIO).concat(z.SIYUAN_ASSETS_VIDEO),u.SIYUAN_ASSETS_SEARCH=[".txt",".md",".markdown",".docx",".xlsx",".pptx",".pdf",".json",".log",".sql",".html",".xml",".java",".h",".c",".cpp",".go",".rs",".swift",".kt",".py",".php",".js",".css",".ts",".sh",".bat",".cmd",".ini",".yaml",".rst",".adoc",".textile",".opml",".org",".wiki",".epub"],u.SIYUAN_CONFIG_APPEARANCE_DARK_CODE=["a11y-dark","agate","an-old-hope","androidstudio","arta","atom-one-dark","atom-one-dark-reasonable","base16/3024","base16/apathy","base16/apprentice","base16/ashes","base16/atelier-cave","base16/atelier-dune","base16/atelier-estuary","base16/atelier-forest","base16/atelier-heath","base16/atelier-lakeside","base16/atelier-plateau","base16/atelier-savanna","base16/atelier-seaside","base16/atelier-sulphurpool","base16/atlas","base16/bespin","base16/black-metal","base16/black-metal-bathory","base16/black-metal-burzum","base16/black-metal-dark-funeral","base16/black-metal-gorgoroth","base16/black-metal-immortal","base16/black-metal-khold","base16/black-metal-marduk","base16/black-metal-mayhem","base16/black-metal-nile","base16/black-metal-venom","base16/brewer","base16/bright","base16/brogrammer","base16/brush-trees-dark","base16/chalk","base16/circus","base16/classic-dark","base16/codeschool","base16/colors","base16/danqing","base16/darcula","base16/dark-violet","base16/darkmoss","base16/darktooth","base16/decaf","base16/default-dark","base16/dracula","base16/edge-dark","base16/eighties","base16/embers","base16/equilibrium-dark","base16/equilibrium-gray-dark","base16/espresso","base16/eva","base16/eva-dim","base16/flat","base16/framer","base16/gigavolt","base16/google-dark","base16/grayscale-dark","base16/green-screen","base16/gruvbox-dark-hard","base16/gruvbox-dark-medium","base16/gruvbox-dark-pale","base16/gruvbox-dark-soft","base16/hardcore","base16/harmonic16-dark","base16/heetch-dark","base16/helios","base16/hopscotch","base16/horizon-dark","base16/humanoid-dark","base16/ia-dark","base16/icy-dark","base16/ir-black","base16/isotope","base16/kimber","base16/london-tube","base16/macintosh","base16/marrakesh","base16/materia","base16/material","base16/material-darker","base16/material-palenight","base16/material-vivid","base16/mellow-purple","base16/mocha","base16/monokai","base16/nebula","base16/nord","base16/nova","base16/ocean","base16/oceanicnext","base16/onedark","base16/outrun-dark","base16/papercolor-dark","base16/paraiso","base16/pasque","base16/phd","base16/pico","base16/pop","base16/porple","base16/qualia","base16/railscasts","base16/rebecca","base16/ros-pine","base16/ros-pine-moon","base16/sandcastle","base16/seti-ui","base16/silk-dark","base16/snazzy","base16/solar-flare","base16/solarized-dark","base16/spacemacs","base16/summercamp","base16/summerfruit-dark","base16/synth-midnight-terminal-dark","base16/tango","base16/tender","base16/tomorrow-night","base16/twilight","base16/unikitty-dark","base16/vulcan","base16/windows-10","base16/windows-95","base16/windows-high-contrast","base16/windows-nt","base16/woodland","base16/xcode-dusk","base16/zenburn","codepen-embed","cybertopia-cherry","cybertopia-dimmer","cybertopia-icecap","cybertopia-saturated","dark","devibeans","far","felipec","github-dark","github-dark-dimmed","gml","gradient-dark","hybrid","ir-black","isbl-editor-dark","kimbie-dark","lioshi","monokai","monokai-sublime","night-owl","nnfx-dark","nord","obsidian","panda-syntax-dark","paraiso-dark","pojoaque","qtcreator-dark","rainbow","rose-pine","rose-pine-moon","shades-of-purple","srcery","stackoverflow-dark","sunburst","tomorrow-night-blue","tomorrow-night-bright","tokyo-night-dark","vs2015","xt256"],u.SIYUAN_CONFIG_APPEARANCE_LIGHT_CODE=["ant-design","1c-light","a11y-light","arduino-light","ascetic","atom-one-light","base16/atelier-cave-light","base16/atelier-dune-light","base16/atelier-estuary-light","base16/atelier-forest-light","base16/atelier-heath-light","base16/atelier-lakeside-light","base16/atelier-plateau-light","base16/atelier-savanna-light","base16/atelier-seaside-light","base16/atelier-sulphurpool-light","base16/brush-trees","base16/classic-light","base16/cupcake","base16/cupertino","base16/default-light","base16/dirtysea","base16/edge-light","base16/equilibrium-gray-light","base16/equilibrium-light","base16/fruit-soda","base16/github","base16/google-light","base16/grayscale-light","base16/gruvbox-light-hard","base16/gruvbox-light-medium","base16/gruvbox-light-soft","base16/harmonic16-light","base16/heetch-light","base16/humanoid-light","base16/horizon-light","base16/ia-light","base16/material-lighter","base16/mexico-light","base16/one-light","base16/papercolor-light","base16/ros-pine-dawn","base16/sagelight","base16/shapeshifter","base16/silk-light","base16/solar-flare-light","base16/solarized-light","base16/summerfruit-light","base16/synth-midnight-terminal-light","base16/tomorrow","base16/unikitty-light","base16/windows-10-light","base16/windows-95-light","base16/windows-high-contrast-light","brown-paper","base16/windows-nt-light","color-brewer","docco","foundation","github","googlecode","gradient-light","grayscale","idea","intellij-light","isbl-editor-light","kimbie-light","lightfair","magula","mono-blue","nnfx-light","panda-syntax-light","paraiso-light","purebasic","qtcreator-light","rose-pine-dawn","routeros","school-book","stackoverflow-light","tokyo-night-light","vs","xcode","default"],u.ZWSP="\u200B",u.INLINE_TYPE=["block-ref","kbd","text","file-annotation-ref","a","strong","em","u","s","mark","sup","sub","tag","code","inline-math","inline-memo","clear"],u.BLOCK_HINT_KEYS=["((","[[","\uFF08\uFF08","\u3010\u3010"],u.BLOCK_HINT_CLOSE_KEYS={"((":"))","[[":"]]","\uFF08\uFF08":"\uFF09\uFF09","\u3010\u3010":"\u3011\u3011"},u.ALIAS_CODE_LANGUAGES=["js","ts","html","toml","c#","bat"],u.SIYUAN_RENDER_CODE_LANGUAGES=["abc","plantuml","mermaid","flowchart","echarts","mindmap","graphviz","math"],u.PROTYLE_TOOLBAR=W()?["block-ref","a","|","text","strong","em","u","clear","|","code","tag","inline-math","inline-memo"]:["block-ref","a","|","text","strong","em","u","s","mark","sup","sub","clear","|","code","kbd","tag","inline-math","inline-memo"],u.ANALYTICS_EVT_ON_GET_CONFIG="siyuan.onGetConfig";const K=()=>([1e7].toString()+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,t=>(parseInt(t,10)^window.crypto.getRandomValues(new Uint32Array(1))[0]&15>>parseInt(t,10)/4).toString(16)),Le=(t,e,n=!1)=>{let a=L(t,e,n),i=!1,s=!1;for(;a&&(n?a.tagName!=="BODY":!a.classList.contains("protyle-wysiwyg"))&&!s;)i=L(a.parentElement,e,n),i?a=i:s=!0;return a||!1},fe=(t,e)=>{let n=q(t,e),a=!1,i=!1;for(;n&&!n.classList.contains("protyle-wysiwyg")&&!i;)a=q(n.parentElement,e),a?n=a:i=!0;return n||!1},re=(t,e,n,a=!1)=>{let i=B(t,e,n,a),s=!1,o=!1;for(;i&&!i.classList.contains("protyle-wysiwyg")&&!o;)s=B(i.parentElement,e,n,a),s?i=s:o=!0;return i||!1},B=(t,e,n,a=!1)=>{if(!t||t.nodeType===9)return!1;t.nodeType===3&&(t=t.parentElement);let i=t,s=!1;for(;i&&!s&&(a?i.tagName!=="BODY":!i.classList.contains("protyle-wysiwyg"));)typeof n=="string"&&i.getAttribute(e)?.split(" ").includes(n)||typeof n!="string"&&i.hasAttribute(e)?s=!0:i=i.parentElement;return s&&i},q=(t,e)=>{if(!t||t.nodeType===9)return!1;t.nodeType===3&&(t=t.parentElement);let n=t,a=!1;for(;n&&!a&&!n.classList.contains("protyle-wysiwyg");)n.nodeName===e?a=!0:n=n.parentElement;return a&&n},L=(t,e,n=!1)=>{if(!t||t.nodeType===9)return!1;t.nodeType===3&&(t=t.parentElement);let a=t,i=!1;for(;a&&!i&&(n?a.tagName!=="BODY":!a.classList.contains("protyle-wysiwyg"));)a.classList?.contains(e)?i=!0:a=a.parentElement;return i&&a},P=t=>{const e=B(t,"data-node-id",null);return e&&e.tagName!=="BUTTON"&&e.getAttribute("data-type")?.startsWith("Node")?e:!1},F=t=>{const e=re(t,"data-type","NodeBlockQueryEmbed");return e?e.isSameNode(t)?!1:e:!1},Pe=t=>{let e=t;for(;e;){if(e.previousElementSibling&&e.previousElementSibling.getAttribute("data-node-id"))return e.previousElementSibling;const n=P(e.parentElement);if(n)e=n;else return!1}},bt=t=>{let e;return Array.from(t.querySelectorAll("[data-node-id]")).reverse().find(n=>{if(!F(n))return e=n,!0}),e||t},it=t=>{let e;return Array.from(t.querySelectorAll("[data-node-id]")).find(n=>{if(!F(n)&&!n.classList.contains("li")&&!n.classList.contains("sb"))return e=n,!0}),e||t},et=t=>{let e=t;for(;e;){if(e.nextElementSibling&&!e.nextElementSibling.classList.contains("protyle-attr"))return e.nextElementSibling;const n=P(e.parentElement);if(n)e=n;else return!1}return!1},Hn=t=>{let e=t;for(;e;)if(e.classList.contains("list")||e.classList.contains("li")||e.classList.contains("bq")||e.classList.contains("sb"))e=e.querySelector("[data-node-id]");else return e;return!1},le=t=>{if(!t||t.getAttribute("contenteditable")==="true"&&!t.classList.contains("protyle-wysiwyg"))return t;const e=t.querySelector('[contenteditable="true"]');if(e&&!B(e,"data-type","NodeBlockQueryEmbed"))return e},Ln=t=>["NodeBlockQueryEmbed","NodeThematicBreak","NodeMathBlock","NodeHTMLBlock","NodeIFrame","NodeWidget","NodeVideo","NodeAudio"].includes(t.getAttribute("data-type"))||t.getAttribute("data-type")==="NodeCodeBlock"&&t.classList.contains("render-node"),Ki=t=>{let e=t;for(;e.parentElement&&!e.parentElement.classList.contains("protyle-wysiwyg");)if(!e.parentElement.getAttribute("data-node-id"))e=e.parentElement;else{let n=!1;if(Array.from(e.parentElement.querySelectorAll('[contenteditable="true"]')).find(a=>{if(a.textContent.replace(u.ZWSP,"").replace(`
`,"")!=="")return n=!0,!0}),n||e.previousElementSibling?.getAttribute("data-node-id")||e.nextElementSibling?.getAttribute("data-node-id"))break;e=e.parentElement}return e},Je=t=>{if(t.parentElement.getAttribute("data-type")==="NodeBlockquote"&&t.parentElement.childElementCount===2)for(;!t.parentElement.classList.contains("protyle-wysiwyg");)if(t.parentElement.getAttribute("data-type")==="NodeBlockquote"&&t.parentElement.childElementCount===2)t=t.parentElement;else{t=Je(t);break}else if(t.parentElement.getAttribute("data-type")==="NodeSuperBlock"&&t.parentElement.childElementCount===2)for(;!t.parentElement.classList.contains("protyle-wysiwyg");)if(t.parentElement.getAttribute("data-type")==="NodeSuperBlock"&&t.parentElement.childElementCount===2)t=t.parentElement;else{t=Je(t);break}else if(t.parentElement.getAttribute("data-type")==="NodeListItem"&&t.parentElement.childElementCount===3)for(;!t.parentElement.classList.contains("protyle-wysiwyg");)if(t.parentElement.getAttribute("data-type")==="NodeListItem"&&t.parentElement.childElementCount===3)t=t.parentElement;else if(t.parentElement.getAttribute("data-type")==="NodeList"&&t.parentElement.childElementCount===2)t=t.parentElement;else{t=Je(t);break}else if(t.parentElement.getAttribute("data-type")==="NodeList"&&t.parentElement.childElementCount===2)for(;!t.parentElement.classList.contains("protyle-wysiwyg");)if(t.parentElement.getAttribute("data-type")==="NodeList"&&t.parentElement.childElementCount===2)t=t.parentElement;else if(t.parentElement.getAttribute("data-type")==="NodeListItem"&&t.parentElement.childElementCount===3)t=t.parentElement;else{t=Je(t);break}return t},Oe=t=>{let e=t.nextSibling;for(;e;)if(e.textContent===""&&e.nodeType===3)e=e.nextSibling;else return e;return!1},Ia=t=>{if(t.endContainer.textContent.length!==t.endOffset)return!1;let e=t.endContainer;for(;e;){if(Oe(e))return!1;if(e.parentElement.getAttribute("spellcheck"))return!0;e=e.parentElement}return!0},At=t=>{let e=t.previousSibling;for(;e;)if(e.textContent===""&&e.nodeType===3)e=e.previousSibling;else return e;return!1},Ks=t=>{let e=t.nextElementSibling;if(e)return e.tagName==="LI"?e:e.tagName==="UL"?e.firstElementChild:!1;for(e=t.parentElement;e.tagName==="UL";)if(!e.nextElementSibling)e=e.parentElement;else{if(e.nextElementSibling.tagName==="LI")return e.nextElementSibling;if(e.nextElementSibling.tagName==="UL")return e.nextElementSibling.firstElementChild}return!1},Wy=t=>{let e=t.previousElementSibling;if(e)return e.tagName==="LI"?e:e.tagName==="UL"?e.lastElementChild:!1;for(e=t.parentElement;e.tagName==="UL";)if(!e.previousElementSibling)e=e.parentElement;else{if(e.previousElementSibling.tagName==="LI")return e.previousElementSibling;if(e.previousElementSibling.tagName==="UL"){const n=e.previousElementSibling.querySelectorAll(".b3-list-item");return n[n.length-1]}}return!1},ee=require("electron"),qS=()=>{const t=document.getElementById("message");t.innerHTML=`<div class="fn__flex-1"></div>
<button class="b3-button ft__smaller fn__none">${window.siyuan.languages.clearMessage}</button>`,t.addEventListener("click",n=>{let a=n.target;for(;a&&!a.isEqualNode(t);){if(a.classList.contains("b3-snackbar__close")){Ue(a.parentElement.getAttribute("data-id")),n.preventDefault();break}else if(a.isSameNode(t.lastElementChild)){a.parentElement.classList.remove("b3-snackbars--show"),setTimeout(()=>{a.parentElement.firstElementChild.innerHTML=""},u.TIMEOUT_INPUT),n.preventDefault();break}else{if(a.tagName==="A"||a.tagName==="BUTTON")break;if(a.classList.contains("b3-snackbar")){(getSelection().rangeCount===0||!getSelection().getRangeAt(0).toString())&&Ue(a.getAttribute("data-id")),n.preventDefault(),n.stopPropagation();break}}a=a.parentElement}});const e=document.getElementById("tempMessage");e&&(j(e.innerHTML),e.remove())},j=(t,e=6e3,n="info",a)=>{const i=document.getElementById("message").firstElementChild;if(!i){document.body.insertAdjacentHTML("beforeend",`<div style="top: 10px;
    position: fixed;
    z-index: 100;
    background: white;
    padding: 10px;
    border-radius: 5px;
    right: 10px;
    border: 1px solid #e0e0e0;" id='tempMessage'>${t}</div>`);return}const s=a||K(),o=i.querySelector(`.b3-snackbar[data-id="${s}"]`),l=t+(n==="error"?" v"+u.SIYUAN_VERSION:"");if(o){if(window.clearTimeout(parseInt(o.getAttribute("data-timeoutid"))),o.innerHTML=`<div data-type="textMenu" class="b3-snackbar__content${e===0?" b3-snackbar__content--close":""}">${l}</div>${e===0?'<svg class="b3-snackbar__close"><use xlink:href="#iconCloseRound"></use></svg>':""}`,n==="error"?o.classList.add("b3-snackbar--error"):o.classList.remove("b3-snackbar--error"),e>0){const d=window.setTimeout(()=>{Ue(s)},e);o.setAttribute("data-timeoutid",d.toString())}return}let r=`<div data-id="${s}" class="b3-snackbar--hide b3-snackbar${n==="error"?" b3-snackbar--error":""}"><div data-type="textMenu" class="b3-snackbar__content${e===0?" b3-snackbar__content--close":""}">${l}</div>`;if(e===0)r+='<svg class="b3-snackbar__close"><use xlink:href="#iconCloseRound"></use></svg>';else if(e!==-1){const d=window.setTimeout(()=>{Ue(s)},e);r=r.replace("<div data-id",`<div data-timeoutid="${d}" data-id`)}return i.parentElement.classList.add("b3-snackbars--show"),i.parentElement.style.zIndex=(++window.siyuan.zIndex).toString(),i.insertAdjacentHTML("afterbegin",r+"</div>"),setTimeout(()=>{i.querySelectorAll(".b3-snackbar--hide").forEach(d=>{d.classList.remove("b3-snackbar--hide")})}),i.firstElementChild.nextElementSibling&&i.firstElementChild.nextElementSibling.innerHTML===i.firstElementChild.innerHTML&&i.firstElementChild.nextElementSibling.remove(),i.scrollTo({top:0,behavior:"smooth"}),s},Ue=t=>{const e=document.getElementById("message").firstElementChild;if(e)if(t){const n=e.querySelector(`[data-id="${t}"]`);n&&(n.classList.add("b3-snackbar--hide"),window.clearTimeout(parseInt(n.getAttribute("data-timeoutid"))),setTimeout(()=>{n.remove(),e.childElementCount===0&&(e.parentElement.classList.remove("b3-snackbars--show"),e.innerHTML="")},u.TIMEOUT_INPUT));let a=!1;Array.from(e.children).find(i=>{if(!i.classList.contains("b3-snackbar--hide"))return a=!0,!0}),a?e.parentElement.classList.add("b3-snackbars--show"):e.parentElement.classList.remove("b3-snackbars--show")}else e.parentElement.classList.remove("b3-snackbars--show"),setTimeout(()=>{e.innerHTML=""},u.TIMEOUT_INPUT)},Ht=t=>{if(t)if(ra())if(t.startsWith("assets/"))window.webkit.messageHandlers.openLink.postMessage(location.origin+"/assets/"+encodeURIComponent(t.replace("assets/","")));else if(t.startsWith("/"))window.webkit.messageHandlers.openLink.postMessage(location.origin+t);else try{new URL(t),window.webkit.messageHandlers.openLink.postMessage(t)}catch{window.webkit.messageHandlers.openLink.postMessage("https://"+t)}else fn()?window.JSAndroid.openExternal(t):pn()?window.JSHarmony.openExternal(t):window.open(t)},Qu=()=>fn()?window.JSAndroid.readClipboard():pn()?window.JSHarmony.readClipboard():navigator.clipboard.readText(),ef=async()=>{const t={textPlain:"",textHTML:""};try{const e=await navigator.clipboard.read();for(const n of e){if(n.types.includes("text/html")){const a=await n.getType("text/html");t.textHTML=await a.text()}if(n.types.includes("text/plain")){const a=await n.getType("text/plain");t.textPlain=await a.text()}if(n.types.includes("image/png")){const a=await n.getType("image/png");t.files=[new File([a],"image.png",{type:"image/png",lastModified:Date.now()})]}}return t}catch{return fn()?(t.textPlain=window.JSAndroid.readClipboard(),t.textHTML=window.JSAndroid.readHTMLClipboard()):pn()&&(t.textPlain=window.JSHarmony.readClipboard(),t.textHTML=window.JSHarmony.readHTMLClipboard()),t}},De=t=>{let e;getSelection().rangeCount>0&&(e=getSelection().getRangeAt(0).cloneRange());try{if(fn()){window.JSAndroid.writeClipboard(t);return}if(pn()){window.JSHarmony.writeClipboard(t);return}if(ra()){window.webkit.messageHandlers.setClipboard.postMessage(t);return}navigator.clipboard.writeText(t)}catch{if(ra())window.webkit.messageHandlers.setClipboard.postMessage(t);else if(fn())window.JSAndroid.writeClipboard(t);else if(pn())window.JSHarmony.writeClipboard(t);else{const a=document.createElement("textarea");a.value=t,a.style.position="fixed",document.body.appendChild(a),a.focus(),a.select(),document.execCommand("copy"),document.body.removeChild(a),e&&Z(e)}}},Zi=async t=>{t=t.replace(new RegExp(u.ZWSP,"g"),""),await De(t)},Gr=()=>nf()?"touchstart":"click",Dt=t=>gt()?!!(t.metaKey&&!t.ctrlKey):!!(!t.metaKey&&t.ctrlKey),qe=t=>!t.metaKey&&!t.ctrlKey,tf=()=>window.siyuan.config.system.osPlatform.toLowerCase().indexOf("huawei")>-1,FS=t=>window.siyuan.config.system.disabledFeatures?.indexOf(t)>-1,nf=()=>navigator.userAgent.indexOf("iPhone")>-1,Da=()=>navigator.userAgent.indexOf("iPad")>-1,gt=()=>navigator.platform.toUpperCase().indexOf("MAC")>-1,Yy=async()=>{if(!navigator.userAgentData||!navigator.userAgentData.getHighEntropyValues)return!1;const t=await navigator.userAgentData.getHighEntropyValues(["platformVersion"]);return navigator.userAgentData.platform==="Windows"&&parseInt(t.platformVersion.split(".")[0])>=13},zy=()=>navigator.platform.toUpperCase().indexOf("WIN")>-1,fn=()=>window.siyuan.config.system.container==="android"&&window.JSAndroid,ra=()=>window.siyuan.config.system.container==="ios"&&window.webkit?.messageHandlers,pn=()=>window.siyuan.config.system.container==="harmony"&&window.JSHarmony,X=t=>{if(gt())return t;const e=new Map(Object.entries({"\u2318":"Ctrl","\u2303":"Ctrl","\u21E7":"Shift","\u2325":"Alt","\u21E5":"Tab","\u232B":"Backspace","\u2326":"Delete","\u21A9":"Enter"})),n=[];(t.indexOf("\u2318")>-1||t.indexOf("\u2303")>-1)&&n.push(e.get("\u2318")),t.indexOf("\u21E7")>-1&&n.push(e.get("\u21E7")),t.indexOf("\u2325")>-1&&n.push(e.get("\u2325"));const a=t.replace(/⌘|⇧|⌥|⌃/g,"");return a&&n.push(e.get(a)||a),n.join("+")},Vy=t=>{E("/api/storage/getLocalStorage",void 0,e=>{window.siyuan.storage=e.data;const n={};n[u.LOCAL_SEARCHASSET]={keys:[],col:"",row:"",layout:0,method:0,types:{},sort:0,k:""},n[u.LOCAL_SEARCHUNREF]={col:"",row:"",layout:0},u.SIYUAN_ASSETS_SEARCH.forEach(a=>{n[u.LOCAL_SEARCHASSET].types[a]=!0}),n[u.LOCAL_SEARCHKEYS]={keys:[],replaceKeys:[],col:"",row:"",layout:0,colTab:"",rowTab:"",layoutTab:0},n[u.LOCAL_PDFTHEME]={light:"light",dark:"dark",annoColor:"var(--b3-pdf-background1)"},n[u.LOCAL_LAYOUTS]=[],n[u.LOCAL_AI]=[],n[u.LOCAL_PLUGIN_DOCKS]={},n[u.LOCAL_PLUGINTOPUNPIN]=[],n[u.LOCAL_OUTLINE]={keepExpand:!0},n[u.LOCAL_FILEPOSITION]={},n[u.LOCAL_DIALOGPOSITION]={},n[u.LOCAL_HISTORY]={notebookId:"%",type:0,operation:"all",sideWidth:"256px",sideDocWidth:"256px",sideDiffWidth:"256px"},n[u.LOCAL_FLASHCARD]={fullscreen:!1},n[u.LOCAL_BAZAAR]={theme:"0",template:"0",icon:"0",widget:"0"},n[u.LOCAL_EXPORTWORD]={removeAssets:!1,mergeSubdocs:!1},n[u.LOCAL_EXPORTPDF]={landscape:!1,marginType:"0",scale:1,pageSize:"A4",removeAssets:!0,keepFold:!1,mergeSubdocs:!1,watermark:!1},n[u.LOCAL_EXPORTIMG]={keepFold:!1,watermark:!1},n[u.LOCAL_DOCINFO]={id:""},n[u.LOCAL_IMAGES]={file:"1f4c4",note:"1f5c3",folder:"1f4d1"},n[u.LOCAL_EMOJIS]={currentTab:"emoji"},n[u.LOCAL_FONTSTYLES]=[],n[u.LOCAL_FILESPATHS]=[],n[u.LOCAL_SEARCHDATA]={page:1,sort:0,group:0,hasReplace:!1,method:0,hPath:"",idPath:[],k:"",r:"",types:{document:window.siyuan.config.search.document,heading:window.siyuan.config.search.heading,list:window.siyuan.config.search.list,listItem:window.siyuan.config.search.listItem,codeBlock:window.siyuan.config.search.codeBlock,htmlBlock:window.siyuan.config.search.htmlBlock,mathBlock:window.siyuan.config.search.mathBlock,table:window.siyuan.config.search.table,blockquote:window.siyuan.config.search.blockquote,superBlock:window.siyuan.config.search.superBlock,paragraph:window.siyuan.config.search.paragraph,embedBlock:window.siyuan.config.search.embedBlock,databaseBlock:window.siyuan.config.search.databaseBlock},replaceTypes:Object.assign({},u.SIYUAN_DEFAULT_REPLACETYPES)},n[u.LOCAL_ZOOM]=1,n[u.LOCAL_MOVE_PATH]={keys:[],k:""},[u.LOCAL_EXPORTIMG,u.LOCAL_SEARCHKEYS,u.LOCAL_PDFTHEME,u.LOCAL_BAZAAR,u.LOCAL_EXPORTWORD,u.LOCAL_EXPORTPDF,u.LOCAL_DOCINFO,u.LOCAL_FONTSTYLES,u.LOCAL_SEARCHDATA,u.LOCAL_ZOOM,u.LOCAL_LAYOUTS,u.LOCAL_AI,u.LOCAL_PLUGINTOPUNPIN,u.LOCAL_SEARCHASSET,u.LOCAL_FLASHCARD,u.LOCAL_DIALOGPOSITION,u.LOCAL_SEARCHUNREF,u.LOCAL_HISTORY,u.LOCAL_OUTLINE,u.LOCAL_FILEPOSITION,u.LOCAL_FILESPATHS,u.LOCAL_IMAGES,u.LOCAL_PLUGIN_DOCKS,u.LOCAL_EMOJIS,u.LOCAL_MOVE_PATH].forEach(a=>{if(typeof e.data[a]=="string")try{const i=JSON.parse(e.data[a]);typeof i=="number"?window.siyuan.storage[a]=i:window.siyuan.storage[a]=Object.assign(n[a],i)}catch{window.siyuan.storage[a]=n[a]}else typeof e.data[a]>"u"&&(window.siyuan.storage[a]=n[a])}),(!window.siyuan.storage[u.LOCAL_SEARCHDATA].replaceTypes||Object.keys(window.siyuan.storage[u.LOCAL_SEARCHDATA].replaceTypes).length===0)&&(window.siyuan.storage[u.LOCAL_SEARCHDATA].replaceTypes=Object.assign({},u.SIYUAN_DEFAULT_REPLACETYPES)),t()})},ue=(t,e,n)=>{window.siyuan.config.readonly||E("/api/storage/setLocalStorageVal",{app:u.SIYUAN_APPID,key:t,val:e},()=>{n&&n()})},_h=t=>{if(t.cmd==="msg"){const e=j(t.msg,t.data.closeTimeout,t.code===0?"info":"error",t.data.id);return document.querySelector("#message #addMicrosoftDefenderExclusion")?.addEventListener("click",n=>{n.target.innerHTML='<svg class="fn__rotate" style="margin-right: 0;"><use xlink:href="#iconRefresh"></use></svg>',E("/api/system/addMicrosoftDefenderExclusion",{},()=>{Ue(e)})},{once:!0}),document.querySelector("#message #ignoreAddMicrosoftDefenderExclusion")?.addEventListener("click",()=>{Ue(e),E("/api/system/ignoreAddMicrosoftDefenderExclusion")},{once:!0}),!1}if(t.cmd==="cmsg")return Ue(t.data.id),!1;if(t.cmd==="cprogress"){const e=document.getElementById("progress");return e&&e.remove(),!1}return t.cmd==="reloadui"?(t.data?.resetScroll?(window.siyuan.storage[u.LOCAL_FILEPOSITION]={},ue(u.LOCAL_FILEPOSITION,window.siyuan.storage[u.LOCAL_FILEPOSITION],()=>{Xt({cb(){window.location.reload()},errorExit:!1})})):Xt({cb(){window.location.reload()},errorExit:!1}),!1):t.code<0?(j(t.msg,t.data&&t.data.closeTimeout||0,t.code===-1?"error":"info"),!1):t};class Vn{constructor(e){this.app=e.app,e.msgCallback&&this.connect(e)}connect(e){const n=`${window.location.protocol==="https:"?"wss":"ws"}://${window.location.host}/ws`,a=new WebSocket(`${n}?app=${u.SIYUAN_APPID}&id=${e.id}${e.type?"&type="+e.type:""}`);a.onopen=()=>{e.callback&&e.callback.call(this),document.getElementById("errorLog")&&(hb(this.app,{upsertRootIDs:[],removeRootIDs:[]}),window.siyuan.dialogs.find(s=>{if(s.element.id==="errorLog")return s.destroy(),!0}))},a.onmessage=i=>{if(e.msgCallback){const s=_h(JSON.parse(i.data));e.msgCallback.call(this,s)}},a.onclose=i=>{0<=i.reason.indexOf("unauthenticated")||0>i.reason.indexOf("close websocket")&&(console.warn("WebSocket is closed. Reconnect will be attempted in 3 second.",i),setTimeout(()=>{this.connect({id:e.id,type:e.type,msgCallback:e.msgCallback})},3e3))},a.onerror=i=>{i.target.url.endsWith("&type=main")&&i.target.readyState===3&&HE()},this.ws=a}send(e,n,a=!1){this.ws&&(this.reqId=a?0:new Date().getTime(),this.ws.send(JSON.stringify({cmd:e,reqId:this.reqId,param:n})))}}const US=async(t,e)=>{if(document.getElementById(e))return!1;const n=new XMLHttpRequest;n.open("GET",t,!1),n.setRequestHeader("Accept","text/javascript, application/javascript, application/ecmascript, application/x-ecmascript, */*; q=0.01"),n.send("");const a=document.createElement("script");a.type="text/javascript",a.text=n.responseText,a.id=e,document.head.appendChild(a),typeof Lute>"u"&&window.location.reload()},Ct=(t,e)=>new Promise(n=>{if(document.getElementById(e))return n(!1),!1;const a=document.createElement("script");a.src=t,a.async=!0,document.head.appendChild(a),a.onload=()=>{if(document.getElementById(e))return a.remove(),n(!1),!1;a.id=e,n(!0)}}),ke=(t,e,n,a=0,i=0)=>{t.style.top=n+"px",t.style.left=e+"px";const s=t.getBoundingClientRect();if(s.bottom>window.innerHeight||s.top<u.SIZE_TOOLBAR_HEIGHT){const o=n-s.height-a;o>u.SIZE_TOOLBAR_HEIGHT&&o+s.height<window.innerHeight?t.style.top=o+"px":o<=u.SIZE_TOOLBAR_HEIGHT?t.style.top=u.SIZE_TOOLBAR_HEIGHT+"px":t.style.top=Math.max(u.SIZE_TOOLBAR_HEIGHT,window.innerHeight-s.height)+"px"}s.right>window.innerWidth?t.style.left=`${window.innerWidth-s.width-i}px`:s.left<0&&(t.style.left="0")},Q=(t,e,n=!1)=>{if(!e){if(t.includes("dialog"))for(let a=0;a<window.siyuan.dialogs.length;a++)window.siyuan.dialogs[a].destroy(),a--;return}if(t.includes("hint")&&(clearTimeout(e.hint.timeId),e.hint.element.classList.add("fn__none")),e.gutter&&t.includes("gutter")&&(e.gutter.element.classList.add("fn__none"),e.gutter.element.innerHTML="",e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl").forEach(a=>{a.classList.remove("protyle-wysiwyg--hl")})),e.gutter&&t.includes("gutterOnly")&&(e.gutter.element.classList.add("fn__none"),e.gutter.element.innerHTML=""),e.toolbar&&t.includes("toolbar")&&(e.toolbar.element.classList.add("fn__none"),e.toolbar.element.style.display=""),e.toolbar&&t.includes("util")){const a=e.toolbar.subElement.querySelector('[data-type="pin"]');(n||!a||a&&a.getAttribute("aria-label")===window.siyuan.languages.pin)&&(e.toolbar.subElement.classList.add("fn__none"),e.toolbar.subElementCloseCB&&(e.toolbar.subElementCloseCB(),e.toolbar.subElementCloseCB=void 0))}t.includes("select")&&e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").forEach(a=>{a.classList.remove("protyle-wysiwyg--select"),a.removeAttribute("select-start"),a.removeAttribute("select-end")})},Ji=t=>{t.includes("toolbar")&&document.querySelectorAll(".protyle-toolbar").forEach(e=>{e.classList.add("fn__none"),e.style.display=""}),t.includes("util")&&Mn().forEach(e=>{e.protyle.toolbar&&(e.protyle.toolbar.subElement.classList.add("fn__none"),e.protyle.toolbar.subElementCloseCB&&(e.protyle.toolbar.subElementCloseCB(),e.protyle.toolbar.subElementCloseCB=void 0))}),t.includes("pdfutil")&&document.querySelectorAll(".pdf__util").forEach(e=>{e.classList.add("fn__none")}),t.includes("gutter")&&document.querySelectorAll(".protyle-gutters").forEach(e=>{e.classList.add("fn__none"),e.innerHTML=""})},Ft=require("path"),vh=(t,e)=>{t.addEventListener("mousedown",n=>{if(L(n.target,"protyle-util")&&!t.classList.contains("protyle-util"))return;let a=L(n.target,"resize__move"),i,s;const o=t.getBoundingClientRect();if(a?(i=n.clientX-o.left,s=n.clientY-o.top):(i=n.clientX,s=n.clientY,a=L(n.target,"resize__rd")||L(n.target,"resize__r")||L(n.target,"resize__rt")||L(n.target,"resize__d")||L(n.target,"resize__l")||L(n.target,"resize__ld")||L(n.target,"resize__lt")||L(n.target,"resize__t")),!a)return;const l=t.clientHeight,r=t.clientWidth,d=a.className.split("resize__")[1].split(" ")[0],c=document;t.style.userSelect="none",t.classList.contains("b3-dialog__container")&&t.parentElement.style.display!=="block"&&(t.parentElement.style.display="block",t.style.left=o.left+"px",t.style.top=o.top+"px",t.style.width=o.width+"px"),c.ondragstart=()=>!1;let f=!1;c.onmousemove=g=>{if(f=!0,!!t)if(d==="move"){let p=g.clientX-i,h=g.clientY-s;p>window.innerWidth-r&&(p=window.innerWidth-r),h>window.innerHeight-l&&(h=window.innerHeight-l),t.style.left=Math.max(p,0)+"px",t.style.top=Math.max(h,u.SIZE_TOOLBAR_HEIGHT)+"px"}else d==="r"&&g.clientX-i+r>200&&g.clientX-i+r<window.innerWidth?(t.style.width=g.clientX-i+r+"px",t.style.maxWidth="none"):d==="d"&&g.clientY-s+l>160&&g.clientY-s+l<window.innerHeight-u.SIZE_TOOLBAR_HEIGHT?(t.style.height=g.clientY-s+l+"px",t.style.maxHeight=""):d==="t"&&g.clientY>u.SIZE_TOOLBAR_HEIGHT&&s-g.clientY+l>160?(t.style.top=g.clientY+"px",t.style.maxHeight="",t.style.height=s-g.clientY+l+"px"):d==="l"&&g.clientX>0&&i-g.clientX+r>200?(t.style.left=g.clientX+"px",t.style.width=i-g.clientX+r+"px",t.style.maxWidth="none"):d==="rd"&&g.clientX-i+r>200&&g.clientX-i+r<window.innerWidth&&g.clientY-s+l>160&&g.clientY-s+l<window.innerHeight-u.SIZE_TOOLBAR_HEIGHT?(t.style.height=g.clientY-s+l+"px",t.style.maxHeight="",t.style.maxWidth="none",t.style.width=g.clientX-i+r+"px"):d==="rt"&&g.clientX-i+r>200&&g.clientX-i+r<window.innerWidth&&g.clientY>u.SIZE_TOOLBAR_HEIGHT&&s-g.clientY+l>160?(t.style.width=g.clientX-i+r+"px",t.style.top=g.clientY+"px",t.style.maxHeight="",t.style.maxWidth="none",t.style.height=s-g.clientY+l+"px"):d==="lt"&&g.clientX>0&&i-g.clientX+r>200&&g.clientY>u.SIZE_TOOLBAR_HEIGHT&&s-g.clientY+l>160?(t.style.left=g.clientX+"px",t.style.width=i-g.clientX+r+"px",t.style.top=g.clientY+"px",t.style.maxHeight="",t.style.maxWidth="none",t.style.height=s-g.clientY+l+"px"):d==="ld"&&g.clientX>0&&i-g.clientX+r>200&&g.clientY-s+l>160&&g.clientY-s+l<window.innerHeight-u.SIZE_TOOLBAR_HEIGHT&&(t.style.left=g.clientX+"px",t.style.width=i-g.clientX+r+"px",t.style.height=g.clientY-s+l+"px",t.style.maxHeight="",t.style.maxWidth="none")},c.onmouseup=()=>{if(!t)return;window.siyuan.dragElement&&(window.siyuan.dragElement.style.opacity="",window.siyuan.dragElement=void 0),t.style.userSelect="auto",c.onmousemove=null,c.onmouseup=null,c.ondragstart=null,c.onselectstart=null,c.onselect=null,Ji(["gutter"]);const g=L(t,"b3-dialog--open");if(g){const p=g.dataset.key;p&&t.offsetWidth&&(window.siyuan.storage[u.LOCAL_DIALOGPOSITION][p]={width:t.offsetWidth,height:t.offsetHeight,left:parseInt(t.style.left),top:parseInt(t.style.top)},ue(u.LOCAL_DIALOGPOSITION,window.siyuan.storage[u.LOCAL_DIALOGPOSITION]))}f&&e&&e(d)}})};class we{constructor(e){this.disableClose=e.disableClose,this.id=K(),window.siyuan.dialogs.push(this),this.destroyCallback=e.destroyCallback,this.element=document.createElement("div");let n,a;if(!W()&&e.positionId){const i=window.siyuan.storage[u.LOCAL_DIALOGPOSITION][e.positionId];i&&i.left+i.width+34<=window.innerWidth&&i.top+i.height<=window.innerHeight&&(n=i.left+"px",a=i.top+"px",e.width=i.width+"px",e.height=i.height+"px")}this.element.innerHTML=`<div class="b3-dialog" style="z-index: ${++window.siyuan.zIndex};${typeof n=="string"?"display:block":""}">
<div class="b3-dialog__scrim"${e.transparent?'style="background-color:transparent"':""}></div>
<div class="b3-dialog__container ${e.containerClassName||""}" style="width:${e.width||"auto"};height:${e.height||"auto"};
left:${n||"auto"};top:${a||"auto"}">
  <svg ${W()&&e.title?'style="top:0;right:0;"':""} class="b3-dialog__close${this.disableClose||e.hideCloseIcon?" fn__none":""}"><use xlink:href="#iconCloseRound"></use></svg>
  <div class="resize__move b3-dialog__header${e.title?"":" fn__none"}" onselectstart="return false;">${e.title||""}</div>
  <div class="b3-dialog__body">${e.content}</div>
  <div class="resize__rd"></div><div class="resize__ld"></div><div class="resize__lt"></div><div class="resize__rt"></div><div class="resize__r"></div><div class="resize__d"></div><div class="resize__t"></div><div class="resize__l"></div>
</div></div>`,this.element.querySelector(".b3-dialog__scrim").addEventListener("click",i=>{this.disableClose||this.destroy(),i.preventDefault(),i.stopPropagation()}),this.disableClose||this.element.querySelector(".b3-dialog__close").addEventListener("click",i=>{this.destroy(),i.preventDefault(),i.stopPropagation()}),document.body.append(this.element),e.disableAnimation?this.element.classList.add("b3-dialog--open"):setTimeout(()=>{this.element.classList.add("b3-dialog--open")}),vh(this.element.querySelector(".b3-dialog__container"),e.resizeCallback)}destroy(e){this.element.querySelector(".b3-dialog").style.zIndex<window.siyuan.menus.menu.element.style.zIndex&&window.siyuan.menus.menu.remove(),this.element.remove(),this.destroyCallback&&this.destroyCallback(e),window.siyuan.dialogs.find((n,a)=>{if(n.id===this.id)return window.siyuan.dialogs.splice(a,1),!0}),document.getElementById("drag")?.classList.remove("fn__hidden")}bindInput(e,n,a=!0){e.focus(),e.addEventListener("keydown",i=>{if(i.isComposing){i.preventDefault();return}if(i.key==="Escape"){this.destroy(),i.preventDefault(),i.stopPropagation();return}!i.shiftKey&&qe(i)&&i.key==="Enter"&&n&&a&&(n(),i.preventDefault(),i.stopPropagation())})}}const pe=t=>t&&t.replace(/&/g,"&amp;").replace(/</g,"&lt;"),Ka=t=>t.replace(/</g,"&lt;"),Xe=t=>t&&t.replace(/"/g,"&quot;").replace(/'/g,"&apos;"),Rt=t=>t&&t.replace(/"/g,"&quot;").replace(/'/g,"&apos;").replace(/</g,"&amp;lt;").replace(/&lt;/g,"&amp;lt;");var Y=Ze(752);const Gy=()=>{const t=window.siyuan.emojis[Tt(0,window.siyuan.emojis.length-1)];return typeof t.items[Tt(0,t.items.length-1)]>"u"?"1f600":t.items[Tt(0,t.items.length-1)].unicode},ge=(t,e="",n=!1,a=!1)=>{if(!t)return"";let i="";if(t.startsWith("api/icon/getDynamicIcon"))i=`<img class="${e}" ${a?"data-":""}src="${t}"/>`;else if(t.indexOf(".")>-1)i=`<img class="${e}" ${a?"data-":""}src="/emojis/${t}"/>`;else try{t.split("-").forEach(s=>{s.length<5?i+=String.fromCodePoint(parseInt("0"+s,16)):i+=String.fromCodePoint(parseInt(s,16))}),n&&(i=`<span class="${e}">${i}</span>`)}catch{}return i},af=t=>{const e=new IntersectionObserver(n=>{n.forEach(a=>{const i=a.target.getAttribute("data-index");if((typeof a.isIntersecting>"u"?a.intersectionRatio!==0:a.isIntersecting)&&i){let s="";window.siyuan.emojis[parseInt(i)].items.forEach(o=>{s+=`<button data-unicode="${o.unicode}" class="emojis__item ariaLabel" aria-label="${Xs(o)}">
${ge(o.unicode)}</button>`}),a.target.innerHTML=s,a.target.removeAttribute("data-index"),a.target.style.minHeight=""}})});t.querySelectorAll(".emojis__content").forEach(n=>{e.observe(n)})},jr=t=>{const e=new IntersectionObserver(n=>{n.forEach(a=>{const i=a.target.getAttribute("data-src");(typeof a.isIntersecting>"u"?a.intersectionRatio!==0:a.isIntersecting)&&i&&(a.target.src=i,a.target.removeAttribute("data-src"))})});t.querySelectorAll("img").forEach(n=>{e.observe(n)})},Kr=(t="",e)=>{let n="";const a=[];t&&(n=`<div class="emojis__title">${window.siyuan.languages.emoji}</div><div class="emojis__content">`);let i=0,s="";const o=[];window.siyuan.emojis.forEach((r,d)=>{t||(n+=`<div class="emojis__title" data-type="${d+1}">${nn(d)}</div><div style="min-height:${d===0?"30px":"300px"}" class="emojis__content"${d>1?' data-index="'+d+'"':""}>`),r.items.length===0&&d===0&&!t&&(n+=`<div style="margin-left: 4px">${window.siyuan.languages.setEmojiTip}</div>`),r.items.forEach(c=>{if(t){if(window.siyuan.config.editor.emoji.includes(c.unicode)&&(ge(c.unicode)===t||c.keywords.toLowerCase().indexOf(t.toLowerCase())>-1||c.description.toLowerCase().indexOf(t.toLowerCase())>-1||c.description_zh_cn.toLowerCase().indexOf(t.toLowerCase())>-1||c.description_ja_jp.toLowerCase().indexOf(t.toLowerCase())>-1)&&a.push(c),e&&i>e)return;(ge(c.unicode)===t||c.keywords.toLowerCase().indexOf(t.toLowerCase())>-1||c.description.toLowerCase().indexOf(t.toLowerCase())>-1||c.description_zh_cn.toLowerCase().indexOf(t.toLowerCase())>-1||c.description_ja_jp.toLowerCase().indexOf(t.toLowerCase())>-1)&&(r.id==="custom"?o.push(c):s+=`<button data-unicode="${c.unicode}" class="emojis__item ariaLabel" aria-label="${Xs(c)}">
${ge(c.unicode,void 0,!1,!0)}</button>`,i++)}else window.siyuan.config.editor.emoji.includes(c.unicode)&&a.push(c),d<2&&(n+=`<button data-unicode="${c.unicode}" class="emojis__item ariaLabel" aria-label="${Xs(c)}">
${ge(c.unicode,void 0,!1,!0)}</button>`)}),t||(n+="</div>")}),t&&(o.sort((r,d)=>{const c=r.keywords.split("/"),f=d.keywords.split("/");return c[c.length-1].toLowerCase().indexOf(t.toLowerCase())<f[f.length-1].toLowerCase().indexOf(t.toLowerCase())?-1:0}).sort((r,d)=>{const c=r.keywords.split("/"),f=d.keywords.split("/");return c[c.length-1].toLowerCase().indexOf(t.toLowerCase())===f[f.length-1].toLowerCase().indexOf(t.toLowerCase())&&c[c.length-1].length<f[f.length-1].length?-1:0}).forEach(r=>{n+=`<button data-unicode="${r.unicode}" class="emojis__item ariaLabel" aria-label="${Xs(r)}">
${ge(r.unicode,void 0,!1,!0)}</button>`}),n=n+s+"</div>");let l="";return a.length>0&&(l=`<div class="emojis__title" data-type="0">${window.siyuan.languages.recentEmoji}</div><div class="emojis__content">`,window.siyuan.config.editor.emoji.forEach(r=>{const d=a.filter(c=>c.unicode===r);d[0]&&(l+=`<button data-unicode="${d[0].unicode}" class="emojis__item ariaLabel" aria-label="${Xs(d[0])}">
${ge(d[0].unicode,void 0,!1,!0)}
</button>`)}),l+="</div>"),l+n===""?`<div class="emojis__title">${window.siyuan.languages.emptyContent}</div>`:l+n},Zs=t=>{window.siyuan.config.editor.emoji.unshift(t),window.siyuan.config.editor.emoji.length>u.SIZE_UNDO&&window.siyuan.config.editor.emoji.pop(),window.siyuan.config.editor.emoji=Array.from(new Set(window.siyuan.config.editor.emoji)),E("/api/setting/setEmoji",{emoji:window.siyuan.config.editor.emoji})},jy=(t,e)=>{const n={1:["Sun","\u5468\u65E5","\u9031\u65E5"],2:["SUN","\u5468\u5929","\u9031\u5929"],3:["Sunday","\u661F\u671F\u65E5","\u661F\u671F\u65E5"],4:["SUNDAY","\u661F\u671F\u5929","\u661F\u671F\u5929"]};let a=0;return t===""&&(t=window.siyuan.config.lang),t==="zh_CN"?a=1:t==="zh_CHT"&&(a=2),`<option value="1" ${e==="1"?" selected":""}>${n[1][a]}</option>
<option value="2" ${e==="2"?" selected":""}>${n[2][a]}</option>
<option value="3" ${e==="3"?" selected":""}>${n[3][a]}</option>
<option value="4" ${e==="4"?" selected":""}>${n[4][a]}</option>`},Ky=(t,e)=>{if(!t)return;let n="";window.siyuan.emojis[parseInt(t)].items.forEach(a=>{n+=`<button data-unicode="${a.unicode}" class="emojis__item ariaLabel" aria-label="${Xs(a)}">${ge(a.unicode)}</button>`}),e.innerHTML=n,e.removeAttribute("data-index"),e.removeAttribute("style")},Za=(t,e,n,a,i)=>{e!=="av"?window.siyuan.menus.menu.remove():window.siyuan.menus.menu.removeScrollEvent();const s="api/icon/getDynamicIcon?",o={color:"#d23f31",lang:"",date:"",weekdayType:"1",type:"1",content:"SiYuan"};if(i&&i.getAttribute("src").startsWith(s)){const b=new URLSearchParams(i.getAttribute("src").replace(s,""));o.color=b.get("color")||"#d23f31",o.color.startsWith("#")||(o.color="#"+o.color),o.lang=b.get("lang")||"",o.date=b.get("date")||"",o.weekdayType=b.get("weekdayType")||"1",o.type=b.get("type")||"1",o.content=b.get("content")||"SiYuan"}const l=new we({disableAnimation:!0,transparent:!0,hideCloseIcon:!0,width:W()?"80vw":"368px",height:"50vh",content:`<div class="emojis">
    <div class="emojis__tabheader">
        <div data-type="tab-emoji" class="ariaLabel block__icon block__icon--show" aria-label="${window.siyuan.languages.emoji}"><svg><use xlink:href="#iconEmoji"></use></svg></div>
        <div class="fn__space"></div>
        <div data-type="tab-dynamic" class="ariaLabel block__icon block__icon--show" aria-label="${window.siyuan.languages.dynamicEmoji}"><svg><use xlink:href="#iconCalendar"></use></svg></div>
        <div class="fn__flex-1"></div>
        <span class="block__icon block__icon--show fn__flex-center ariaLabel" data-action="remove" aria-label="${window.siyuan.languages.remove}"><svg><use xlink:href="#iconTrashcan"></use></svg></span>
    </div>
    <div class="emojis__tabbody">
        <div class="fn__none" data-type="tab-emoji">
            <div class="fn__hr"></div>
            <div class="fn__flex">
                <span class="fn__space"></span>
                <label class="b3-form__icon fn__flex-1" style="overflow:initial;">
                    <svg class="b3-form__icon-icon"><use xlink:href="#iconSearch"></use></svg>
                    <input class="b3-form__icon-input b3-text-field fn__block" placeholder="${window.siyuan.languages.search}">
                </label>
                <span class="fn__space"></span>
                <span class="block__icon block__icon--show fn__flex-center ariaLabel" data-action="random" aria-label="${window.siyuan.languages.random}"><svg><use xlink:href="#iconRefresh"></use></svg></span>
                <span class="fn__space"></span>
            </div>
            <div class="emojis__panel">${Kr()}</div>
            <div class="fn__flex">
                ${[["2b50",window.siyuan.languages.recentEmoji],["1f527",nn(0)],["1f60d",nn(1)],["1f433",nn(2)],["1f96a",nn(3)],["1f3a8",nn(4)],["1f3dd-fe0f",nn(5)],["1f52e",nn(6)],["267e-fe0f",nn(7)],["1f6a9",nn(8)]].map(([b,y],w)=>`<div data-type="${w}" class="emojis__type ariaLabel" aria-label="${y}">${ge(b)}</div>`).join("")}
            </div>
        </div>
        <div class="fn__none" data-type="tab-dynamic">
            <div class="fn__flex emoji__dynamic-color">
                <div class="color__square fn__pointer${o.color==="#d23f31"?" color__square--current":""}" style="background-color:#d23f31"></div>
                <div class="color__square fn__pointer${o.color==="#3575f0"?" color__square--current":""}" style="background-color:#3575f0"></div>
                <div class="color__square fn__pointer${o.color==="#f3a92f"?" color__square--current":""}" style="background-color:#f3a92f"></div>
                <div class="color__square fn__pointer${o.color==="#65b84d"?" color__square--current":""}" style="background-color:#65b84d"></div>
                <div class="color__square fn__pointer${o.color==="#e099ff"?" color__square--current":""}" style="background-color:#e099ff"></div>
                <div class="color__square fn__pointer${o.color==="#ea5d97"?" color__square--current":""}" style="background-color:#ea5d97"></div>
                <div class="color__square fn__pointer${o.color==="#93627f"?" color__square--current":""}" style="background-color:#93627f"></div>
                <div class="color__square fn__pointer${o.color==="#5f6368"?" color__square--current":""}" style="background-color:#5f6368"></div>
                <div class="fn__space--small"></div>
                <input type="text" class="b3-text-field fn__flex-1 fn__flex-center" value="${o.color}">
            </div>
            <div class="fn__flex">
                <span class="fn__space"></span>
                <span class="fn__flex-center ft__on-surface" style="width: 89px">${window.siyuan.languages.language}</span>
                <span class="fn__space--small"></span>
                <select class="b3-select fn__flex-1">
                    <option value="" ${o.lang===""?" selected":""}>${window.siyuan.languages.themeOS}</option>
                    <option value="en_US" ${o.lang==="en_US"?" selected":""}>English (en_US)</option>
                    <option value="zh_CHT" ${o.lang==="zh_CHT"?" selected":""}>\u7E41\u9AD4\u4E2D\u6587 (zh_CHT)</option>
                    <option value="zh_CN" ${o.lang==="zh_CN"?" selected":""}>\u7B80\u4F53\u4E2D\u6587 (zh_CN)</option>
                </select>
                <span class="fn__space"></span>
            </div>
            <div class="fn__hr"></div>
            <div class="fn__flex">
                <span class="fn__space"></span>
                <span class="fn__flex-center ft__on-surface" style="width: 89px">${window.siyuan.languages.date}</span>
                <span class="fn__space--small"></span>
                <input type="date" max="9999-12-31" class="b3-text-field fn__flex-1" value="${o.date}"/>
                <span class="fn__space"></span>
            </div>
            <div class="fn__hr"></div>
            <div class="fn__flex">
                <span class="fn__space"></span>
                <span class="fn__flex-center ft__on-surface" style="width: 89px">${window.siyuan.languages.format}</span>
                <span class="fn__space--small"></span>
                <select class="b3-select fn__flex-1">
                    ${jy(o.lang,o.weekdayType)}
                </select>
                <span class="fn__space"></span>
            </div>
            <div class="fn__flex fn__flex-wrap">
                <img class="emoji__dynamic-item${o.type==="1"?" emoji__dynamic-item--current":""}" src="${s}type=1&color=${encodeURIComponent(o.color)}&date=${o.date}&weekdayType=${o.weekdayType}&lang=${o.lang}">
                <img class="emoji__dynamic-item${o.type==="2"?" emoji__dynamic-item--current":""}" src="${s}type=2&color=${encodeURIComponent(o.color)}&date=${o.date}&weekdayType=${o.weekdayType}&lang=${o.lang}">
                <img class="emoji__dynamic-item${o.type==="3"?" emoji__dynamic-item--current":""}" src="${s}type=3&color=${encodeURIComponent(o.color)}&date=${o.date}&weekdayType=${o.weekdayType}&lang=${o.lang}">
                <img class="emoji__dynamic-item${o.type==="4"?" emoji__dynamic-item--current":""}" src="${s}type=4&color=${encodeURIComponent(o.color)}&date=${o.date}&weekdayType=${o.weekdayType}&lang=${o.lang}">
                <img class="emoji__dynamic-item${o.type==="5"?" emoji__dynamic-item--current":""}" src="${s}type=5&color=${encodeURIComponent(o.color)}&date=${o.date}&weekdayType=${o.weekdayType}&lang=${o.lang}">
                <img class="emoji__dynamic-item${o.type==="6"?" emoji__dynamic-item--current":""}" src="${s}type=6&color=${encodeURIComponent(o.color)}&date=${o.date}&weekdayType=${o.weekdayType}&lang=${o.lang}">
                <img class="emoji__dynamic-item${o.type==="7"?" emoji__dynamic-item--current":""}" src="${s}type=7&color=${encodeURIComponent(o.color)}&date=${o.date}&weekdayType=${o.weekdayType}&lang=${o.lang}">
            </div>
            <div class="fn__hr"></div>
            <div class="fn__flex">
                <span class="fn__space"></span>
                <span class="fn__flex-center ft__on-surface" style="width: 89px">${window.siyuan.languages.custom}</span>
                <span class="fn__space--small"></span>
                <input type="text" class="b3-text-field fn__flex-1" value="${o.content}">
                <span class="fn__space"></span>
            </div>
            <div>
                <img data-type="text" class="emoji__dynamic-item${o.type==="8"?" emoji__dynamic-item--current":""}" src="${s}type=8&color=${encodeURIComponent(o.color)}&content=${o.content}&id=${t}">
            </div>
        </div>
    </div>
</div>`});l.element.setAttribute("data-key",u.DIALOG_EMOJIS),l.element.querySelector(".b3-dialog__container").setAttribute("data-menu","true");const r=l.element.querySelector(".b3-dialog");r.style.justifyContent="inherit",r.style.alignItems="inherit";const d=window.siyuan.storage[u.LOCAL_EMOJIS].currentTab;l.element.querySelector(`.emojis__tabheader [data-type="tab-${d}"]`).classList.add("block__icon--active"),l.element.querySelector(`.emojis__tabbody [data-type="tab-${d}"]`).classList.remove("fn__none"),ke(l.element.querySelector(".b3-dialog__container"),n.x,n.y,n.h,n.w),l.element.querySelector(".emojis__item").classList.add("emojis__item--current");const c=l.element.querySelector('[data-type="tab-emoji"] .b3-text-field'),f=l.element.querySelector(".emojis__panel");c.addEventListener("compositionend",()=>{f.innerHTML=Kr(c.value),c.value?f.nextElementSibling.classList.add("fn__none"):f.nextElementSibling.classList.remove("fn__none"),f.scrollTop=0,l.element.querySelector(".emojis__item")?.classList.add("emojis__item--current"),c.value===""&&af(l.element),jr(l.element)}),c.addEventListener("input",b=>{b.isComposing||(f.innerHTML=Kr(c.value),c.value?f.nextElementSibling.classList.add("fn__none"):f.nextElementSibling.classList.remove("fn__none"),f.scrollTop=0,l.element.querySelector(".emojis__item")?.classList.add("emojis__item--current"),c.value===""&&af(l.element),jr(l.element))}),c.addEventListener("keydown",b=>{if(b.isComposing||b.key.indexOf("Arrow")===-1&&b.key!=="Enter")return;const y=l.element.querySelector(".emojis__item--current");if(!y)return;if(b.key==="Enter"){const _=y.getAttribute("data-unicode");e==="notebook"?E("/api/notebook/setNotebookIcon",{notebook:t,icon:_},()=>{l.destroy(),Zs(_),Js(_,t,"iconFilesRoot")}):e==="doc"&&E("/api/attr/setBlockAttrs",{id:t,attrs:{icon:_}},()=>{l.destroy(),Zs(_),Js(_,t),sf(_,t)}),a&&a(_),b.preventDefault(),b.stopPropagation();return}let w;if(b.key==="ArrowLeft")y.previousElementSibling?(y.classList.remove("emojis__item--current"),w=y.previousElementSibling,b.preventDefault(),b.stopPropagation()):y.parentElement.previousElementSibling?.previousElementSibling&&(y.classList.remove("emojis__item--current"),w=y.parentElement.previousElementSibling.previousElementSibling.lastElementChild,b.preventDefault(),b.stopPropagation());else if(b.key==="ArrowRight")y.nextElementSibling?(y.classList.remove("emojis__item--current"),w=y.nextElementSibling,b.preventDefault(),b.stopPropagation()):y.parentElement.nextElementSibling?.nextElementSibling&&(y.classList.remove("emojis__item--current"),w=y.parentElement.nextElementSibling.nextElementSibling.firstElementChild,b.preventDefault(),b.stopPropagation());else if(b.key==="ArrowDown"){if(y.nextElementSibling){y.classList.remove("emojis__item--current");let _=Math.floor(y.parentElement.clientWidth/(y.clientWidth+2));for(w=y;w.nextElementSibling&&_>0;)w=w.nextElementSibling,_--}else{const _=y.parentElement.nextElementSibling?.nextElementSibling;_&&(w=_.firstElementChild,y.classList.remove("emojis__item--current"))}b.preventDefault(),b.stopPropagation()}else if(b.key==="ArrowUp"){if(y.previousElementSibling){y.classList.remove("emojis__item--current");let _=Math.floor(y.parentElement.clientWidth/(y.clientWidth+2));for(w=y;w.previousElementSibling&&_>0;)w=w.previousElementSibling,_--}else{const _=y.parentElement.previousElementSibling?.previousElementSibling;_&&(w=_.lastElementChild,y.classList.remove("emojis__item--current"))}b.preventDefault(),b.stopPropagation()}if(w){w.classList.add("emojis__item--current");const _=c.clientHeight+6;w.offsetTop-_<f.scrollTop?f.scrollTop=w.offsetTop-_-6:w.offsetTop-_-f.clientHeight+w.clientHeight>f.scrollTop&&(f.scrollTop=w.offsetTop-_-f.clientHeight+w.clientHeight)}}),!W()&&d==="emoji"&&c.focus(),af(l.element),jr(l.element),l.element.addEventListener("click",b=>{let y=b.target;for(;y&&y!==l.element;){if(y.classList.contains("emojis__type")){const w=f.querySelector(`[data-type="${y.getAttribute("data-type")}"]`);if(w){const _=w.nextElementSibling.getAttribute("data-index");_&&(Ky(w.previousElementSibling?.getAttribute("data-index"),w.previousElementSibling),Ky(_,w.nextElementSibling)),f.scrollTo({top:w.offsetTop-77})}break}else if(y.getAttribute("data-action")==="remove"){e==="notebook"?E("/api/notebook/setNotebookIcon",{notebook:t,icon:""},()=>{l.destroy(),Js("",t,"iconFilesRoot")}):e==="doc"&&E("/api/attr/setBlockAttrs",{id:t,attrs:{icon:""}},()=>{l.destroy(),Js("",t),sf("",t)}),a&&a("");break}else if(y.classList.contains("emojis__item")||y.getAttribute("data-action")==="random"||y.classList.contains("emoji__dynamic-item")){let w="";y.classList.contains("emojis__item")?(w=y.getAttribute("data-unicode"),l.destroy()):y.classList.contains("emoji__dynamic-item")?(w=y.getAttribute("src"),l.destroy()):w=Gy(),e==="notebook"?E("/api/notebook/setNotebookIcon",{notebook:t,icon:w},()=>{Zs(w),Js(w,t,"iconFilesRoot")}):e==="doc"&&E("/api/attr/setBlockAttrs",{id:t,attrs:{icon:w}},()=>{Zs(w),Js(w,t),sf(w,t)}),a&&a(w);break}else if(y.getAttribute("data-type")?.startsWith("tab-")){r.querySelectorAll('.emojis__tabheader [data-type|="tab"]').forEach(w=>{w.dataset.type===y.dataset.type?w.classList.add("block__icon--active"):w.classList.remove("block__icon--active")}),r.querySelectorAll(".emojis__tabbody > div").forEach(w=>{w.dataset.type===y.dataset.type?w.classList.remove("fn__none"):w.classList.add("fn__none")}),window.siyuan.storage[u.LOCAL_EMOJIS].currentTab=y.dataset.type.replace("tab-",""),ue(u.LOCAL_EMOJIS,window.siyuan.storage[u.LOCAL_EMOJIS]);break}else if(y.classList.contains("color__square")){h[0].value=y.getAttribute("style").replace("background-color:",""),h[0].dispatchEvent(new CustomEvent("input"));break}y=y.parentElement}});const g=l.element.querySelectorAll('[data-type="tab-dynamic"] .b3-select');g[0].addEventListener("change",()=>{l.element.querySelectorAll(".fn__flex-wrap .emoji__dynamic-item").forEach(b=>{const y=new URLSearchParams(b.getAttribute("src").replace(s,""));g[0].value?y.set("lang",g[0].value):y.delete("lang"),b.setAttribute("src",s+y.toString()),g[1].innerHTML=jy(g[0].value,g[1].value)})}),g[1].addEventListener("change",()=>{l.element.querySelectorAll(".fn__flex-wrap .emoji__dynamic-item").forEach(b=>{const y=new URLSearchParams(b.getAttribute("src").replace(s,""));y.set("weekdayType",g[1].value),b.setAttribute("src",s+y.toString())})});const p=l.element.querySelector('[data-type="tab-dynamic"] [type="date"]');p.addEventListener("change",()=>{l.element.querySelectorAll(".fn__flex-wrap .emoji__dynamic-item").forEach(b=>{const y=new URLSearchParams(b.getAttribute("src").replace(s,""));y.set("date",p.value?Y(p.value).format("YYYY-MM-DD"):""),b.setAttribute("src",s+y.toString())})});const h=l.element.querySelectorAll('[data-type="tab-dynamic"] [type="text"]'),m=l.element.querySelector('.emoji__dynamic-item[data-type="text"]');h[0].addEventListener("input",()=>{h[0].value.startsWith("#")&&(l.element.querySelectorAll(".emoji__dynamic-item").forEach(b=>{const y=new URLSearchParams(b.getAttribute("src").replace(s,""));y.set("color",h[0].value),b.setAttribute("src",s+y.toString())}),l.element.querySelectorAll(".color__square").forEach(b=>{b.style.backgroundColor===h[0].value?b.classList.add("color__square--current"):b.classList.remove("color__square--current")}))}),h[1].addEventListener("input",()=>{const b=new URLSearchParams(m.getAttribute("src").replace(s,""));b.set("content",h[1].value),m.setAttribute("src",s+b.toString())})},sf=(t,e)=>{Ce().outline.forEach(n=>{n.blockId===e&&(n.headerElement.nextElementSibling.firstElementChild.outerHTML=ge(t||window.siyuan.storage[u.LOCAL_IMAGES].file,"b3-list-item__graphic",!0))})},Js=(t,e,n="iconFile")=>{let a;const i=Qe("file");if(i){const s=i.data.file;n==="iconFile"?a=s.element.querySelector(`[data-node-id="${e}"] .b3-list-item__icon`):a=s.element.querySelector(`[data-node-id="${e}"] .b3-list-item__icon`)||s.element.querySelector(`[data-url="${e}"] .b3-list-item__icon`)||s.closeElement.querySelector(`[data-url="${e}"] .b3-list-item__icon`)}a&&(a.innerHTML=ge(t||(n==="iconFile"?a.previousElementSibling.classList.contains("fn__hidden")?window.siyuan.storage[u.LOCAL_IMAGES].file:window.siyuan.storage[u.LOCAL_IMAGES].folder:window.siyuan.storage[u.LOCAL_IMAGES].note))),n!=="iconFile"&&Ei()},Xs=t=>window.siyuan.config.lang==="zh_CN"?t.description_zh_cn:window.siyuan.config.lang==="ja_JP"?t.description_ja_jp:t.description,nn=t=>window.siyuan.config.lang==="zh_CN"?window.siyuan.emojis[t].title_zh_cn:window.siyuan.config.lang==="ja_JP"?window.siyuan.emojis[t].title_ja_jp:window.siyuan.emojis[t].title,WS=t=>{if(window.siyuan.emojis[0].items.length>0){const e={};window.siyuan.emojis[0].items.forEach(n=>{e[n.keywords]=t.options.hint.emojiPath+"/"+n.unicode}),t.lute.PutEmojis(e)}},YS=()=>{E("/api/system/getEmojiConf",{},t=>{window.siyuan.emojis=t.data,Mn().forEach(e=>{WS(e.protyle)})})},Zy=(t,e)=>{if(t.includes("\u2303")){if(!e.ctrlKey)return!1}else if(gt()?e.ctrlKey:t.includes("\u2318")?!e.ctrlKey:e.ctrlKey)return!1;if(t.includes("\u2325")){if(!e.altKey)return!1}else if(e.altKey)return!1;if(t.includes("\u21E7")){if(!e.shiftKey)return!1}else if(e.shiftKey)return!1;if(t.includes("\u2318")){if(gt()?!e.metaKey:!e.ctrlKey)return!1}else if(gt()?e.metaKey:t.includes("\u2303")?!e.ctrlKey:e.ctrlKey)return!1;return!0},of=(t,e)=>{const n=t.replace(e,u.ZWSP).split("");return n.forEach((a,i)=>{a===u.ZWSP&&(n[i]=e)}),n},H=(t,e)=>{if(!t)return!1;if(t.startsWith("\u2303")&&!gt()){if(t==="\u2303D")return!1;t=t.replace("\u2318","").replace("\u2303","\u2318").replace("\u2318\u21E7","\u21E7\u2318").replace("\u2318\u2325\u21E7","\u2325\u21E7\u2318").replace("\u2318\u2325","\u2325\u2318")}if(t.indexOf("\u21E7")===-1&&t.indexOf("\u2318")===-1&&t.indexOf("\u2325")===-1&&t.indexOf("\u2303")===-1)return!!(qe(e)&&!e.altKey&&!e.shiftKey&&t===u.KEYCODELIST[e.keyCode]);let n=t.split("");if(t.indexOf("F")>-1?n.forEach((i,s)=>{i==="F"&&(n[s]="F"+n.splice(s+1,1),n[s+1]&&(n[s+1]+=n.splice(s+1,1)))}):t.indexOf("PageUp")>-1?n=of(t,"PageUp"):t.indexOf("PageDown")>-1?n=of(t,"PageDown"):t.indexOf("Home")>-1?n=of(t,"Home"):t.indexOf("End")>-1&&(n=of(t,"End")),t.startsWith("\u21E7")&&n.length===2)return!!(qe(e)&&!e.altKey&&e.shiftKey&&n[1]===u.KEYCODELIST[e.keyCode]);if(t.startsWith("\u2325")){let i=n.length===3?n[2]:n[1];n.length===4&&(i=n[3]);const s=i===u.KEYCODELIST[e.keyCode];return!!(s&&e.altKey&&!e.shiftKey&&n.length<4&&(n.length===3?Dt(e)&&t.startsWith("\u2325\u2318"):qe(e))||s&&t.startsWith("\u2325\u21E7\u2318")&&n.length===4&&e.altKey&&e.shiftKey&&Dt(e)||s&&t.startsWith("\u2325\u21E7")&&n.length===3&&e.altKey&&e.shiftKey&&qe(e))}if(t.startsWith("\u2303")){if(!gt())return!1;let i=n.length===3?n[2]:n[1];n.length===4?i=n[3]:n.length===5&&(i=n[4]);const s=i===u.KEYCODELIST[e.keyCode];return!!(s&&e.ctrlKey&&!e.altKey&&!e.shiftKey&&n.length<4&&(n.length===3?e.metaKey&&t.startsWith("\u2303\u2318"):!e.metaKey)||s&&t.startsWith("\u2303\u21E7")&&n.length===3&&e.ctrlKey&&!e.altKey&&e.shiftKey&&!e.metaKey||s&&t.startsWith("\u2303\u2325")&&n.length===3&&e.ctrlKey&&e.altKey&&!e.shiftKey&&!e.metaKey||s&&n.length===4&&e.ctrlKey&&(t.startsWith("\u2303\u2325\u21E7")&&e.shiftKey&&!e.metaKey&&e.altKey||t.startsWith("\u2303\u2325\u2318")&&!e.shiftKey&&e.metaKey&&e.altKey||t.startsWith("\u2303\u21E7\u2318")&&e.shiftKey&&e.metaKey&&!e.altKey)||s&&n.length===5&&e.ctrlKey&&e.shiftKey&&e.metaKey&&e.altKey)}const a=n.length>2&&n[0]==="\u21E7";return Dt(e)&&!e.altKey&&(!a&&!e.shiftKey||a&&e.shiftKey)?(a?n[2]:n[1])===u.KEYCODELIST[e.keyCode]:!1};class st{constructor(e,n){if(this.menu=window.siyuan.menus.menu,this.isOpen=!1,this.element=this.menu.element,e){const a=this.menu.element.getAttribute("data-name");a&&a===e&&(this.isOpen=!0)}this.menu.remove(),this.isOpen||(this.menu.element.setAttribute("data-name",e||""),this.menu.removeCB=n)}showSubMenu(e){this.menu.showSubMenu(e)}addItem(e){if(!this.isOpen)return this.menu.addItem(e)}addSeparator(e,n=!1){let a,i,s=!1;if(typeof e=="object"?(s=e.ignore||!1,i=e.index,a=e.id):typeof e=="number"&&(i=e,s=n),!(s||this.isOpen))return this.menu.addItem({id:a,type:"separator",index:i})}open(e){this.isOpen||this.menu.popup(e)}fullscreen(e="all"){this.isOpen||this.menu.fullscreen(e)}close(){this.menu.remove()}}const Ja=t=>{ee.ipcRenderer.send(u.SIYUAN_OPEN_FOLDER,t)},zS=()=>{const t=new URLSearchParams(window.location.search),e=t.get("url");let n="",a=!1;if(/^web\+siyuan:\/\/blocks\/\d{14}-\w{7}/.test(e))n=e.substring(20,20+22),a=It("focus",e)==="1";else if(window.JSAndroid){const i=window.JSAndroid.getBlockURL();n=Zr(i),a=It("focus",i)==="1"}else n=t.get("id"),a=t.get("focus")==="1";return{id:n,isZoomIn:a}},Jy=t=>/^siyuan:\/\/blocks\/\d{14}-\w{7}/.test(t),Zr=t=>t.substring(16,16+22),Xy=(t=window.location.href)=>{const e=new URL(window.location.origin);e.pathname="/check-auth",e.searchParams.set("to",t),window.location.href=e.href},VS=()=>{let t=document.getElementById("baseURL");t||(t=document.createElement("base"),t.id="baseURL"),t.setAttribute("href",location.origin),document.getElementsByTagName("head")[0].appendChild(t)},nt=(t,e=!0,n=!1)=>{let a=t;return e&&(a=Ee().basename(t)),n&&a.endsWith(".sy")&&(a=a.substr(0,a.length-3)),a},Jr=t=>Ee().basename(t,Ee().extname(t)).replace(/-\d{14}-\w{7}/,""),Qs=t=>!t||(t=t.trim(),1>t.length)?!1:(t=t.toLowerCase(),t.startsWith("assets/")||t.startsWith("file://")||t.startsWith("\\\\")?!0:zy()?t.indexOf(":")===1:t.startsWith("/")),Ee=()=>Ft.posix?Ft.posix:Ft,GS=()=>Ft,Eh=t=>{const e=[];return t.forEach(n=>{if(n.getAttribute("data-type")!=="navigation-root"){const a=n.getAttribute("data-path");e.find(s=>{if(a.startsWith(s.replace(".sy","")))return!0})||e.push(a)}}),e},kh=(t,e,n)=>{E("/api/filetree/moveDocs",{toNotebook:e,fromPaths:t,toPath:n})},vi=(t,e,n,a,i=!1)=>{if(window.siyuan.dialogs.find(p=>{if(p.element.querySelector("#foldList"))return p.destroy(),!0}))return;const o=new we({title:`<div style="padding: 8px;">
    ${a||window.siyuan.languages.move}
    <div style="max-height: 16px;overflow: auto;line-height: 14px;-webkit-mask-image: linear-gradient(to top, rgba(0, 0, 0, 0) 0, #000 6px);padding-bottom: 4px;margin-bottom: -4px" class="ft__smaller ft__on-surface fn__hidescrollbar"></div>
</div>`,content:`<div class="b3-form__icon" style="margin: 8px">
    <span data-menu="true" class="b3-form__icon-list fn__a b3-tooltips b3-tooltips__s" aria-label="${X("\u2325\u2193")}">
        <svg class="svg--mid"><use xlink:href="#iconSearch"></use></svg>
        <svg class="svg--smaller"><use xlink:href="#iconDown"></use></svg>
    </span>
    <input class="b3-text-field fn__block" style="padding-left: 42px;" value="" placeholder="${window.siyuan.languages.search}">
</div>
<ul id="foldList" class="fn__flex-1 fn__none b3-list b3-list--background${W()?" b3-list--mobile":""}" style="overflow: auto;position: relative"></ul>
<div id="foldTree" class="fn__flex-1${W()?" b3-list--mobile":""}" style="overflow: auto;position: relative"></div>
<div class="fn__hr"></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:W()?"92vw":"50vw",height:W()?"80vh":"70vh",destroyCallback(){n&&Z(n)}});o.element.querySelector(".b3-dialog__header").setAttribute("style","padding:0"),o.element.setAttribute("data-key",u.DIALOG_MOVEPATHTO),e&&e.length>0&&E("/api/filetree/getHPathsByPaths",{paths:e},p=>{o.element.querySelector(".b3-dialog__header .ft__smaller").innerHTML=pe(p.data.join(" "))});const l=o.element.querySelector("#foldList"),r=o.element.querySelector("#foldTree");Ei(p=>{let h="";p.forEach(m=>{if(!m.closed){let b="";i&&(b=`<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardNewCard}">${m.newFlashcardCount}</span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardDueCard}">${m.dueFlashcardCount}</span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardCard}">${m.flashcardCount}</span>`),h+=`<ul class="b3-list b3-list--background">
<li class="b3-list-item${h===""?" b3-list-item--focus":""}" data-path="/" data-box="${m.id}">
    <span class="b3-list-item__toggle b3-list-item__toggle--hl">
        <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
    </span>
    ${ge(m.icon||window.siyuan.storage[u.LOCAL_IMAGES].note,"b3-list-item__graphic",!0)}
    <span class="b3-list-item__text">${pe(m.name)}</span>
    ${b}
</li></ul>`}}),r.innerHTML=h},i);const d=o.element.querySelector(".b3-text-field");d.value=window.siyuan.storage[u.LOCAL_MOVE_PATH].k,d.select();const c=p=>{if(!(p&&p.isComposing)){if(d.value.trim()===""){l.classList.add("fn__none"),r.classList.remove("fn__none");return}r.classList.add("fn__none"),l.classList.remove("fn__none"),l.scrollTo(0,0),E("/api/filetree/searchDocs",{k:d.value,flashcard:i},h=>{let m="";h.data.forEach(b=>{let y="";i&&(y=`<span class="fn__flex-1"></span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardNewCard}">${b.newFlashcardCount}</span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardDueCard}">${b.dueFlashcardCount}</span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardCard}">${b.flashcardCount}</span>`),m+=`<li class="b3-list-item${m===""?" b3-list-item--focus":""}" data-path="${b.path}" data-box="${b.box}">
    ${ge(b.boxIcon||window.siyuan.storage[u.LOCAL_IMAGES].note,"b3-list-item__graphic",!0)}
    <span class="b3-list-item__showall" style="padding: 4px 0">${pe(b.hPath)}</span>
    ${y}
</li>`}),l.innerHTML=m})}},f=()=>{const p=window.siyuan.storage[u.LOCAL_MOVE_PATH].keys;if(!p||p.length===0||p.length===1&&p[0]===d.value)return;const h=new st("move-path-history");if(h.isOpen)return;h.element.classList.add("b3-menu--list"),h.addItem({iconHTML:"",label:window.siyuan.languages.clearHistory,click(){window.siyuan.storage[u.LOCAL_MOVE_PATH].keys=[],ue(u.LOCAL_MOVE_PATH,window.siyuan.storage[u.LOCAL_MOVE_PATH])}});const m=h.addSeparator(1);let b=!0;p.forEach(w=>{if(w!==d.value&&w){const _=h.addItem({iconHTML:"",label:pe(w),action:"iconCloseRound",bind(x){x.addEventListener("click",S=>{L(S.target,"b3-menu__action")?(p.find((k,A)=>{if(k===w)return p.splice(A,1),!0}),window.siyuan.storage[u.LOCAL_MOVE_PATH].keys=p,ue(u.LOCAL_MOVE_PATH,window.siyuan.storage[u.LOCAL_MOVE_PATH]),x.previousElementSibling?.classList.contains("b3-menu__separator")&&!x.nextElementSibling?window.siyuan.menus.menu.remove():x.remove()):(d.value=x.textContent,c(),window.siyuan.menus.menu.remove()),S.preventDefault(),S.stopPropagation()})}});b&&_.classList.add("b3-menu__item--current"),b=!1}}),b&&m.remove();const y=d.getBoundingClientRect();h.open({x:y.left,y:y.bottom})};c(),d.addEventListener("compositionend",p=>{c(p)}),d.addEventListener("input",p=>{c(p)}),d.addEventListener("blur",()=>{if(!d.value)return;let p=window.siyuan.storage[u.LOCAL_MOVE_PATH].keys;p.splice(0,0,d.value),p=Array.from(new Set(p)),p.length>window.siyuan.config.search.limit&&p.splice(window.siyuan.config.search.limit,p.length-window.siyuan.config.search.limit),window.siyuan.storage[u.LOCAL_MOVE_PATH].k=d.value,window.siyuan.storage[u.LOCAL_MOVE_PATH].keys=p,ue(u.LOCAL_MOVE_PATH,window.siyuan.storage[u.LOCAL_MOVE_PATH])});const g=28;d.addEventListener("keydown",p=>{if(p.isComposing)return;if(H("\u2325\u2193",p)){p.stopPropagation(),f();return}if(window.siyuan.menus.menu.element.getAttribute("data-name")==="move-path-history")return;const h=l.classList.contains("fn__none")?r:l,m=h.querySelectorAll(".b3-list-item--focus");if(m.length===0)return;let b=m[0];if(p.key.startsWith("Arrow")&&m.forEach((y,w)=>{w!==0&&y.classList.remove("b3-list-item--focus")}),l.classList.contains("fn__none")){if(p.key==="ArrowRight"&&!b.querySelector(".b3-list-item__arrow--open")&&!b.querySelector(".b3-list-item__toggle").classList.contains("fn__hidden")||p.key==="ArrowLeft"&&b.querySelector(".b3-list-item__arrow--open")){Sh(b,i),p.preventDefault();return}if(p.key==="ArrowLeft"){let y=b.parentElement.previousElementSibling;if(y){y.tagName!=="LI"&&(y=h.querySelector(".b3-list-item")),b.classList.remove("b3-list-item--focus"),y.classList.add("b3-list-item--focus");const w=y.getBoundingClientRect(),_=h.getBoundingClientRect();(w.top<_.top||w.bottom>_.bottom)&&y.scrollIntoView(w.top<_.top)}return p.preventDefault(),!0}if(p.key==="ArrowDown"||p.key==="ArrowRight"){let y=b;for(;y;)if(y.nextElementSibling)if(y.nextElementSibling.classList.contains("fn__none"))y=y.nextElementSibling;else{y.nextElementSibling.tagName==="UL"?y=y.nextElementSibling.firstElementChild:y=y.nextElementSibling;break}else{if(y.parentElement.id==="foldTree")break;y=y.parentElement}if(y.classList.contains("b3-list-item")){b.classList.remove("b3-list-item--focus"),y.classList.add("b3-list-item--focus");const w=y.getBoundingClientRect(),_=r.getBoundingClientRect();(w.top<_.top||w.bottom>_.bottom)&&y.scrollIntoView(w.top<_.top)}return p.preventDefault(),!0}if(p.key==="ArrowUp"){let y=b;for(;y;)if(y.previousElementSibling)if(y.previousElementSibling.classList.contains("fn__none"))y=y.previousElementSibling;else{if(y.previousElementSibling.tagName==="LI")y=y.previousElementSibling;else{const w=y.previousElementSibling.querySelectorAll(".b3-list-item");y=w[w.length-1]}break}else{if(y.parentElement.id==="foldTree")break;y=y.parentElement}if(y.classList.contains("b3-list-item")){b.classList.remove("b3-list-item--focus"),y.classList.add("b3-list-item--focus");const w=y.getBoundingClientRect(),_=r.getBoundingClientRect();(w.top<_.top||w.bottom>_.bottom)&&y.scrollIntoView(w.top<_.top)}p.preventDefault()}}else{if(p.key==="ArrowDown"){b.classList.remove("b3-list-item--focus"),b.nextElementSibling?b.nextElementSibling.classList.add("b3-list-item--focus"):h.children[0].classList.add("b3-list-item--focus"),b=h.querySelector(".b3-list-item--focus"),(h.scrollTop<b.offsetTop-h.clientHeight+g||h.scrollTop>b.offsetTop)&&(h.scrollTop=b.offsetTop-h.clientHeight+g),p.preventDefault();return}if(p.key==="ArrowUp"){if(b.classList.remove("b3-list-item--focus"),b.previousElementSibling)b.previousElementSibling.classList.add("b3-list-item--focus");else{const y=h.children.length;h.children[y-1].classList.add("b3-list-item--focus")}b=h.querySelector(".b3-list-item--focus"),(h.scrollTop<b.offsetTop-h.clientHeight+g||h.scrollTop>b.offsetTop-g*2)&&(h.scrollTop=b.offsetTop-g*2),p.preventDefault();return}}if(p.key==="Enter"){const y=h.querySelectorAll(".b3-list-item--focus");if(y.length===0)return;const w=[],_=[];y.forEach(x=>{w.push(x.getAttribute("data-path")),_.push(x.getAttribute("data-box"))}),t(w,_),o.destroy(),p.preventDefault()}}),o.element.addEventListener("click",p=>{let h=p.target;for(;h&&!h.isEqualNode(o.element);){if(h.classList.contains("b3-list-item__toggle")){Sh(h.parentElement,i),p.preventDefault(),p.stopPropagation();break}else if(h.classList.contains("b3-form__icon-list")){f(),p.preventDefault(),p.stopPropagation();break}else if(h.classList.contains("b3-button--text")){const b=(l.classList.contains("fn__none")?r:l).querySelectorAll(".b3-list-item--focus");if(b.length===0)return;const y=[],w=[];b.forEach(_=>{y.push(_.getAttribute("data-path")),w.push(_.getAttribute("data-box"))}),t(y,w),o.destroy(),p.preventDefault(),p.stopPropagation();break}else if(h.classList.contains("b3-button--cancel")){o.destroy(),p.preventDefault(),p.stopPropagation();break}else if(h.classList.contains("b3-list-item")){const b=(l.classList.contains("fn__none")?r:l).querySelectorAll(".b3-list-item--focus");if(b.length===0)return;a===window.siyuan.languages.specifyPath&&Dt(p)?b.length===1&&b[0].isSameNode(h)||h.classList.toggle("b3-list-item--focus"):(b[0].classList.remove("b3-list-item--focus"),h.classList.add("b3-list-item--focus")),h.getAttribute("data-path")==="/"&&Sh(h,i),p.preventDefault(),p.stopPropagation();break}h=h.parentElement}d.focus()})},Sh=(t,e)=>{const n=t.querySelector(".b3-list-item__arrow");if(n.classList.contains("b3-list-item__arrow--open")){n.classList.remove("b3-list-item__arrow--open"),t.nextElementSibling&&t.nextElementSibling.tagName==="UL"&&t.nextElementSibling.classList.add("fn__none");return}if(t.nextElementSibling&&t.nextElementSibling.tagName==="UL"){n.classList.add("b3-list-item__arrow--open"),t.nextElementSibling.classList.remove("fn__none");return}const a=t.getAttribute("data-box");E("/api/filetree/listDocsByPath",{notebook:a,path:t.getAttribute("data-path"),flashcard:e},i=>{if(i.data.files.length===0){j(window.siyuan.languages.emptyContent);return}let s="";if(i.data.files.forEach(l=>{let r="";e?r=`<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardNewCard}">${l.newFlashcardCount}</span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardDueCard}">${l.dueFlashcardCount}</span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardCard}">${l.flashcardCount}</span>`:l.count&&l.count>0&&(r=`<span class="popover__block counter b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.ref}">${l.count}</span>`),s+=`<li data-box="${a}" class="b3-list-item" data-path="${l.path}">
    <span style="padding-left: ${l.path.split("/").length*8}px" class="b3-list-item__toggle b3-list-item__toggle--hl${l.subFileCount===0?" fn__hidden":""}">
        <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
    </span>
    ${ge(l.icon||(l.subFileCount===0?window.siyuan.storage[u.LOCAL_IMAGES].file:window.siyuan.storage[u.LOCAL_IMAGES].folder),"b3-list-item__graphic",!0)}
    <span class="b3-list-item__text ariaLabel" data-position="parentE" aria-label="${nt(l.name,!0,!0)} <small class='ft__on-surface'>${l.hSize}</small>${l.bookmark?"<br>"+window.siyuan.languages.bookmark+" "+l.bookmark:""}${l.name1?"<br>"+window.siyuan.languages.name+" "+l.name1:""}${l.alias?"<br>"+window.siyuan.languages.alias+" "+l.alias:""}${l.memo?"<br>"+window.siyuan.languages.memo+" "+l.memo:""}${l.subFileCount!==0?window.siyuan.languages.includeSubFile.replace("x",l.subFileCount):""}<br>${window.siyuan.languages.modifiedAt} ${l.hMtime}<br>${window.siyuan.languages.createdAt} ${l.hCtime}">${nt(l.name,!0,!0)}</span>
    ${r}
</li>`}),s==="")return;n.classList.add("b3-list-item__arrow--open"),t.insertAdjacentHTML("afterend",`<ul class="file-tree__sliderDown">${s}</ul>`);const o=t.nextElementSibling;setTimeout(()=>{o.setAttribute("style",`height:${o.childElementCount*t.clientHeight}px;`),setTimeout(()=>{o.classList.remove("file-tree__sliderDown"),o.removeAttribute("style")},120)},2)})},$a=t=>{let e="";return window.siyuan.notebooks.find(n=>{if(n.id===t)return e=n.name,!0}),e},jS=t=>{let e="";return window.siyuan.notebooks.find(n=>{if(n.id===t)return e=n.icon,!0}),e},KS=(t,e)=>{window.siyuan.notebooks.find(n=>{if(n.id===t)return n.name=e,!0})},Lh=()=>{let t=0;return window.siyuan.notebooks.forEach(e=>{e.closed||t++}),t},Ei=(t,e=!1)=>{E("/api/notebook/lsNotebooks",{flashcard:e},n=>{e||(window.siyuan.notebooks=n.data.notebooks),t&&t(n.data.notebooks)})},lf=(t,e={})=>{const n={};Hi(t,n),ee.ipcRenderer.send(u.SIYUAN_OPEN_WINDOW,{position:e.position,width:e.width,height:e.height,url:`${window.location.protocol}//${window.location.host}/stage/build/app/window.html?v=${u.SIYUAN_VERSION}&json=${encodeURIComponent(JSON.stringify([n]))}`}),t.parent.removeTab(t.id)},Xr=async(t,e={})=>{let n=t;typeof n=="string"&&(n=[n]);const a=[];for(let i=0;i<n.length;i++){const s=await Re("/api/block/getBlockInfo",{id:n[i]});if(s.code===3){j(s.msg);return}a.push({title:s.data.rootTitle,docIcon:s.data.rootIcon,pin:!1,active:!0,instance:"Tab",action:"Tab",children:{notebookId:s.data.box,blockId:n[i],rootId:s.data.rootID,mode:"wysiwyg",instance:"Editor",action:s.data.rootID===n[i]?u.CB_GET_SCROLL:u.CB_GET_ALL}})}ee.ipcRenderer.send(u.SIYUAN_OPEN_WINDOW,{position:e.position,width:e.width,height:e.height,url:`${window.location.protocol}//${window.location.host}/stage/build/app/window.html?v=${u.SIYUAN_VERSION}&json=${encodeURIComponent(JSON.stringify(a))}`})},ZS=(t,e={})=>{const n=Ee().extname(t.split("?page")[0]);if(u.SIYUAN_ASSETS_EXTS.includes(n)){let a="iconPDF";u.SIYUAN_ASSETS_IMAGE.includes(n)?a="iconImage":u.SIYUAN_ASSETS_AUDIO.includes(n)?a="iconRecord":u.SIYUAN_ASSETS_VIDEO.includes(n)&&(a="iconVideo");const i=[{title:nt(t),docIcon:a,pin:!1,active:!0,instance:"Tab",action:"Tab",children:{path:t,page:parseInt(It("page",t)),instance:"Asset"}}];ee.ipcRenderer.send(u.SIYUAN_OPEN_WINDOW,{position:e.position,width:e.width,height:e.height,url:`${window.location.protocol}//${window.location.host}/stage/build/app/window.html?v=${u.SIYUAN_VERSION}&json=${encodeURIComponent(JSON.stringify(i))}`})}},rf=t=>{t.classList.add("protyle-wysiwyg--hl"),setTimeout(function(){t.classList.remove("protyle-wysiwyg--hl")},1024)},cf=(t,e,n=!1)=>{let a;const i=t.wysiwyg.element;if(!t.preview.element.classList.contains("fn__none")){a=document.getElementById(e),a&&(t.preview.element.scrollTop=a.offsetTop,rf(a));return}if(Array.from(i.querySelectorAll(`[data-node-id="${e}"]`)).find(s=>{if(!B(s,"data-type","block-render",!0))return a=s,!0}),a)return Ne(t,a,n),rf(a),a;if(e===t.block.rootID&&t.options.render.title&&t.title.editElement)return rf(t.title.editElement),t.title.editElement},Ne=(t,e,n=!1,a="auto")=>{if(!t.disabled&&!n&&getSelection().rangeCount>0){const r=getSelection().getRangeAt(0),d=P(r.startContainer);if(d){if(d.classList.contains("code-block")){const m=document.createElement("br");r.insertNode(m),m.scrollIntoView({block:"nearest",behavior:a}),m.remove();return}if(d.classList.contains("av")&&d.dataset.render==="true"&&(d.querySelector(".av__row--header").getAttribute("style")?.indexOf("transform")>-1||d.querySelector(".av__row--footer").getAttribute("style")?.indexOf("transform")>-1))return;const c=r.cloneRange(),f=document.createElement("br");r.insertNode(f);const g=t.contentElement,p=f.getBoundingClientRect().top-g.getBoundingClientRect().top;let h=0;p<0?h=g.scrollTop+p:p>g.clientHeight-74&&(h=g.scrollTop+(p+74-g.clientHeight)),h!==0&&g.scroll({top:h,behavior:a}),f.remove(),Z(c);return}}if(!e&&document.activeElement?.tagName!=="TEXTAREA"&&document.activeElement?.tagName!=="INPUT"&&(e=P(me(t.wysiwyg.element).startContainer)),!e)return;let i=0,s=e;for(;s&&!s.classList.contains("protyle-wysiwyg");)i+=s.offsetTop,s=s.parentElement;let o=0,l=t.element.firstElementChild;for(;l&&!l.classList.contains("protyle-content");)o+=l.clientHeight,l=l.nextElementSibling;if(n){t.contentElement.scroll({top:i-o,behavior:a});return}t.contentElement.scrollTop>i-32?t.contentElement.scroll({top:i-o,behavior:a}):t.contentElement.scrollTop+t.contentElement.clientHeight<i+e.clientHeight-o&&t.contentElement.scroll({top:i+e.clientHeight-o-t.contentElement.clientHeight,behavior:a})},ki=t=>{let e=!0;if(t){const n=t.getAttribute("data-readonly");if(typeof n=="string")e=n==="false";else return'<div class="protyle-icons"></div>'}return`<div class="protyle-icons">
    <span aria-label="${window.siyuan.languages.edit}" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-icon--first protyle-action__edit${e?"":" fn__none"}"><svg><use xlink:href="#iconEdit"></use></svg></span>
    <span aria-label="${window.siyuan.languages.more}" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-action__menu protyle-icon--last${e?"":" protyle-icon--first"}"><svg><use xlink:href="#iconMore"></use></svg></span>
</div>`},Xa=t=>{if(t.getAttribute("data-type")==="NodeHTMLBlock"){const e=t.querySelector("protyle-html");e.setAttribute("data-content",Lute.UnEscapeHTMLStr(e.getAttribute("data-content")))}return t},Qy="%%params",JS=t=>{let e={responsive:"resize"};const n=t.substring(0,t.indexOf(`
`));if(n.startsWith(Qy))try{e=Gi(n.substring(Qy.length))}catch(a){console.error(`Failed to parse ABCJS params: ${a}`)}return e},ew=(t,e=u.PROTYLE_CDN)=>{let n=[];t.getAttribute("data-subtype")==="abc"?n=[t]:n=Array.from(t.querySelectorAll('[data-subtype="abc"]')),n.length!==0&&n.length>0&&Ct(`${e}/js/abcjs/abcjs-basic-min.js?v=6.2.2`,"protyleAbcjsScript").then(()=>{const a=L(t,"protyle-wysiwyg",!0);n.forEach(i=>{if(i.getAttribute("data-render")==="true")return;i.firstElementChild.classList.contains("protyle-icons")||i.insertAdjacentHTML("afterbegin",ki(a));const s=i.firstElementChild.nextElementSibling;s.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${u.ZWSP}</span><div contenteditable="false"></div>`;const o=Lute.UnEscapeHTMLStr(i.getAttribute("data-content"));window.ABCJS.renderAbc(s.lastElementChild,o,JS(o)),i.setAttribute("data-render","true")})})},tw=(t,e=u.PROTYLE_CDN)=>{let n=[];t.getAttribute("data-subtype")==="echarts"?n=[t]:n=Array.from(t.querySelectorAll('[data-subtype="echarts"]')),n.length!==0&&n.length>0&&Ct(`${e}/js/echarts/echarts.min.js?v=5.3.2`,"protyleEchartsScript").then(()=>{Ct(`${e}/js/echarts/echarts-gl.min.js?v=2.0.9`,"protyleEchartsGLScript").then(()=>{const a=L(t,"protyle-wysiwyg",!0);let i;a&&a.clientWidth>0&&n[0].firstElementChild.clientWidth===0&&a.firstElementChild&&(i=a.firstElementChild.clientWidth),n.forEach(async s=>{if(s.getAttribute("data-render")==="true")return;s.firstElementChild.classList.contains("protyle-icons")||s.insertAdjacentHTML("afterbegin",ki(a));const o=s.firstElementChild.nextElementSibling;try{o.style.height=s.style.height;const l=await Gi(Lute.UnEscapeHTMLStr(s.getAttribute("data-content")));window.echarts.init(o,window.siyuan.config.appearance.mode===1?"dark":void 0,{width:i}).setOption(l),s.setAttribute("data-render","true"),o.classList.remove("ft__error"),o.textContent.endsWith(u.ZWSP)||o.firstElementChild.insertAdjacentText("beforeend",u.ZWSP)}catch(l){window.echarts.dispose(o),o.classList.add("ft__error"),o.innerHTML=`echarts render error: <br>${l}`}})})})},nw=(t,e=u.PROTYLE_CDN)=>{let n=[];t.getAttribute("data-subtype")==="graphviz"?n=[t]:n=Array.from(t.querySelectorAll('[data-subtype="graphviz"]')),n.length!==0&&Ct(`${e}/js/graphviz/viz.js?v=3.11.0`,"protyleGraphVizScript").then(()=>{const a=L(t,"protyle-wysiwyg",!0);n.forEach(i=>{if(i.getAttribute("data-render")==="true")return;i.firstElementChild.classList.contains("protyle-icons")||i.insertAdjacentHTML("afterbegin",ki(a));const s=i.firstElementChild.nextElementSibling;try{Viz.instance().then(o=>{const l=o.renderSVGElement(Lute.UnEscapeHTMLStr(i.getAttribute("data-content")));s.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${u.ZWSP}</span><div contenteditable="false">${l.outerHTML}</div>`}).catch(o=>{s.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${u.ZWSP}</span><div class="ft__error" contenteditable="false">graphviz render error: <br>${o}</div>`})}catch(o){console.error("Graphviz error",o)}i.setAttribute("data-render","true")})})},Qr=(t,e)=>{if(!document.getElementById(e)){const n=document.createElement("link");n.id=e,n.rel="stylesheet",n.type="text/css",n.href=t;const a=document.querySelector("#pluginsStyle");a?a.before(n):document.getElementsByTagName("head")[0].appendChild(n)}},Ma=(t,e=u.PROTYLE_CDN,n=!1)=>{let a=[];t.getAttribute("data-subtype")==="math"?a=[t]:a=Array.from(t.querySelectorAll('[data-subtype="math"]')),a.length!==0&&(Qr(`${e}/js/katex/katex.min.css?v=0.16.9`,"protyleKatexStyle"),Ct(`${e}/js/katex/katex.min.js?v=0.16.9`,"protyleKatexScript").then(()=>{Ct(`${e}/js/katex/mhchem.min.js?v=0.16.9`,"protyleKatexMhchemScript").then(()=>{a.forEach(i=>{if(i.getAttribute("data-render")==="true")return;i.setAttribute("data-render","true");let s=i;i.tagName==="DIV"&&(s=i.firstElementChild);let o={};try{o=Gi(window.siyuan.config.editor.katexMacros||"{}")}catch(l){console.warn("KaTex macros is not JSON",l)}try{s.innerHTML=window.katex.renderToString(Lute.UnEscapeHTMLStr(i.getAttribute("data-content")),{displayMode:i.tagName==="DIV",output:"html",macros:o,trust:!0,strict:r=>r==="unicodeTextInMathMode"?"ignore":"warn"}),s.classList.remove("ft__error");const l=P(i);if(i.tagName==="DIV"){s.firstElementChild.setAttribute("contenteditable","false"),s.childElementCount<2&&s.insertAdjacentHTML("beforeend",`<span style="position: absolute;right: 0;top: 0;">${u.ZWSP}</span>`);const r=s.querySelectorAll(".base");r.length>0&&r[r.length-1].insertAdjacentHTML("afterend","<span class='fn__flex-1'></span>");const d=s.querySelector(".katex-html > .newline");d&&(d.parentElement.style.display="block")}else{l&&i.getBoundingClientRect().width>l.clientWidth?(i.style.maxWidth="100%",i.style.overflowX="auto",i.style.overflowY="hidden",i.style.display="inline-block"):(i.style.maxWidth="",i.style.overflowX="",i.style.overflowY="",i.style.display="");const r=Oe(i);r?r&&r.nodeType!==3&&(r.getAttribute("data-type")?.indexOf("inline-math")>-1||r.classList.contains("img"))?i.after(document.createTextNode(u.ZWSP)):r&&!r.textContent.startsWith(`
`)&&r.textContent!==u.ZWSP&&i.insertAdjacentHTML("beforeend","&#xFEFF;"):i.parentElement.tagName!=="TH"&&i.parentElement.tagName!=="TD"?i.insertAdjacentText("afterend",`
`):i.insertAdjacentText("afterend",u.ZWSP),i.previousSibling?.textContent.endsWith(`
`)?i.insertAdjacentText("beforebegin",u.ZWSP):!At(i)&&["TH","TD"].includes(i.parentElement.tagName)&&i.insertAdjacentText("afterbegin",u.ZWSP)}n&&setTimeout(()=>{if(i.tagName==="DIV"){const r=i.querySelector(".katex-display");r.clientWidth<r.scrollWidth&&r.firstElementChild.setAttribute("style",`font-size:${r.clientWidth*100/r.scrollWidth}%`)}else l&&i.offsetWidth>l.clientWidth&&i.firstElementChild.setAttribute("style",`font-size:${l.clientWidth*100/i.offsetWidth}%`)})}catch(l){s.innerHTML=l.message,s.classList.add("ft__error")}})})}))},aw=(t,e=u.PROTYLE_CDN)=>{let n=[];t.getAttribute("data-subtype")==="mermaid"?n=[t]:n=Array.from(t.querySelectorAll('[data-subtype="mermaid"]')),n.length!==0&&Ct(`${e}/js/mermaid/mermaid.min.js?v=11.4.0`,"protyleMermaidScript").then(()=>{const a={securityLevel:"loose",altFontFamily:"sans-serif",fontFamily:"sans-serif",startOnLoad:!1,flowchart:{htmlLabels:!0,useMaxWidth:!0},sequence:{useMaxWidth:!0,diagramMarginX:8,diagramMarginY:8,boxMargin:8,showSequenceNumbers:!0},gantt:{leftPadding:75,rightPadding:20}};if(window.siyuan.config.appearance.mode===1&&(a.theme="dark"),window.mermaid.initialize(a),n[0].firstElementChild.clientWidth===0){const i=new MutationObserver(()=>{iw(n),i.disconnect()}),s=B(n[0],"fold","1");if(s)i.observe(s,{attributeFilter:["fold"]});else{const o=L(n[0],"card__block",!0);o&&i.observe(o,{attributeFilter:["class"]})}}else iw(n)})},iw=t=>{const e=L(t[0],"protyle-wysiwyg",!0);t.forEach(async n=>{if(n.getAttribute("data-render")==="true")return;n.firstElementChild.classList.contains("protyle-icons")||n.insertAdjacentHTML("afterbegin",ki(e));const a=n.firstElementChild.nextElementSibling,i="mermaid"+Lute.NewNodeID();a.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${u.ZWSP}</span><div contenteditable="false"><span id="${i}"></span></div>`;try{const s=await window.mermaid.render(i,Lute.UnEscapeHTMLStr(n.getAttribute("data-content")));a.lastElementChild.innerHTML=s.svg}catch(s){const o=document.querySelector("#"+i);a.lastElementChild.innerHTML=`${o.outerHTML}<div class="fn__hr"></div><div class="ft__error">${s.message.replace(/\n/,"<br>")}</div>`,o.parentElement.remove()}n.setAttribute("data-render","true")})},sw=(t,e=u.PROTYLE_CDN)=>{let n=[];t.getAttribute("data-subtype")==="mindmap"?n=[t]:n=Array.from(t.querySelectorAll('[data-subtype="mindmap"]')),n.length!==0&&Ct(`${e}/js/echarts/echarts.min.js?v=0.0.0`,"protyleEchartsScript").then(()=>{const a=L(t,"protyle-wysiwyg",!0);let i;a&&a.clientWidth>0&&n[0].firstElementChild.clientWidth===0&&a.firstElementChild&&(i=a.firstElementChild.clientWidth),n.forEach(s=>{if(s.getAttribute("data-render")==="true")return;s.firstElementChild.classList.contains("protyle-icons")||s.insertAdjacentHTML("afterbegin",ki(a));const o=s.firstElementChild.nextElementSibling;try{o.style.height=s.style.height,window.echarts.init(o,window.siyuan.config.appearance.mode===1?"dark":void 0,{width:i}).setOption({series:[{data:[JSON.parse(Lute.EChartsMindmapStr(Lute.UnEscapeHTMLStr(s.getAttribute("data-content"))))],initialTreeDepth:-1,itemStyle:{borderWidth:0,color:"#4285f4"},label:{backgroundColor:"#f6f8fa",borderColor:"#d1d5da",borderRadius:6,borderWidth:.5,color:"#586069",lineHeight:20,offset:[-5,0],padding:[0,5],position:"insideRight"},lineStyle:{color:"#d1d5da",width:1},roam:!0,symbol:(l,r)=>r?.data?.children?"circle":"path://",type:"tree"}],tooltip:{trigger:"item",triggerOn:"mousemove"},backgroundColor:"transparent"}),s.setAttribute("data-render","true"),o.textContent.endsWith(u.ZWSP)||o.firstElementChild.insertAdjacentText("beforeend",u.ZWSP),o.classList.remove("ft__error")}catch(l){o.classList.add("ft__error"),o.innerHTML=`Mindmap render error: <br>${l}`}})})},ow=(t,e=u.PROTYLE_CDN)=>{let n=[];t.getAttribute("data-subtype")==="flowchart"?n=[t]:n=Array.from(t.querySelectorAll('[data-subtype="flowchart"]')),n.length!==0&&Ct(`${e}/js/flowchart.js/flowchart.min.js?v=1.18.0`,"protyleFlowchartScript").then(()=>{if(n[0].firstElementChild.clientWidth===0){const a=new MutationObserver(()=>{lw(n),a.disconnect()}),i=B(n[0],"fold","1");if(i)a.observe(i,{attributeFilter:["fold"]});else{const s=L(n[0],"card__block",!0);s&&a.observe(s,{attributeFilter:["class"]})}}else lw(n)})},lw=t=>{const e=L(t[0],"protyle-wysiwyg",!0);t.forEach(n=>{if(n.getAttribute("data-render")==="true")return;n.firstElementChild.classList.contains("protyle-icons")||n.insertAdjacentHTML("afterbegin",ki(e));const a=n.firstElementChild.nextElementSibling;a.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${u.ZWSP}</span><div class="ft__error" contenteditable="false"></div>`;try{flowchart.parse(Lute.UnEscapeHTMLStr(n.getAttribute("data-content"))).drawSVG(a.lastElementChild)}catch(i){a.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${u.ZWSP}</span><div class="ft__error" contenteditable="false">Flow Chart render error: <br>${i}</div>`}n.setAttribute("data-render","true")})},rw=(t,e=u.PROTYLE_CDN)=>{let n=[];t.getAttribute("data-subtype")==="plantuml"?n=[t]:n=Array.from(t.querySelectorAll('[data-subtype="plantuml"]')),n.length!==0&&Ct(`${e}/js/plantuml/plantuml-encoder.min.js?v=0.0.0`,"protylePlantumlScript").then(()=>{const a=L(t,"protyle-wysiwyg",!0);n.forEach(i=>{if(i.getAttribute("data-render")==="true")return;i.firstElementChild.classList.contains("protyle-icons")||i.insertAdjacentHTML("afterbegin",ki(a));const s=i.firstElementChild.nextElementSibling;try{s.innerHTML=`<object type="image/svg+xml" data="${window.siyuan.config.editor.plantUMLServePath}${window.plantumlEncoder.encode(Lute.UnEscapeHTMLStr(i.getAttribute("data-content")))}"/>`,s.classList.remove("ft__error"),i.setAttribute("data-render","true")}catch(o){s.classList.add("ft__error"),s.innerHTML=`plantuml render error: <br>${o}`}})})},cw=t=>{let e=[];t.getAttribute("data-type")==="NodeHTMLBlock"?e=[t]:e=Array.from(t.querySelectorAll('[data-type="NodeHTMLBlock"]')),e.length!==0&&e.length>0&&e.forEach(n=>{n.firstElementChild.firstElementChild.setAttribute("aria-label",window.siyuan.languages.edit),n.firstElementChild.lastElementChild.setAttribute("aria-label",window.siyuan.languages.more)})},XS=(t,e)=>{const n=document.createElement("div");n.innerHTML=t;let a=!1;if((n.childElementCount===1&&n.lastElementChild.style.fontFamily.indexOf("monospace")>-1||n.childElementCount===1&&n.querySelectorAll("pre").length===1||t.indexOf(`
<p class="p1">`)===0||n.childElementCount===1&&n.firstElementChild.tagName==="TABLE"&&n.querySelector(".line-number")&&n.querySelector(".line-content"))&&(a=!0),a){let i=e||t;return/\n/.test(i)?`<div data-type="NodeCodeBlock" class="code-block" data-node-id="${Lute.NewNodeID()}"><div class="protyle-action"><span class="protyle-action--first protyle-action__language" contenteditable="false">${window.siyuan.storage[u.LOCAL_CODELANG]}</span><span class="fn__flex-1"></span><span aria-label="${window.siyuan.languages.copy}" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-icon--first protyle-action__copy"><svg><use xlink:href="#iconCopy"></use></svg></span><span aria-label="${window.siyuan.languages.more}" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-icon--last protyle-action__menu"><svg><use xlink:href="#iconMore"></use></svg></span></div><div contenteditable="true" spellcheck="${window.siyuan.config.editor.spellcheck}">${i.replace(/&/g,"&amp;").replace(/</g,"&lt;")}<wbr></div><div class="protyle-attr" contenteditable="false">${u.ZWSP}</div></div>`:(i=i.replace("<","&lt;").replace(">","&gt;"),"`"+i+"`")}return!1},yt=t=>{const e=t.getAttribute("data-subtype");if(!u.SIYUAN_RENDER_CODE_LANGUAGES.includes(e)||t.getAttribute("data-type")!=="NodeHTMLBlock"){ew(t),cw(t),rw(t),aw(t),ow(t),tw(t),sw(t),nw(t),Ma(t);return}e==="abc"?ew(t):e==="plantuml"?rw(t):e==="mermaid"?aw(t):e==="flowchart"?ow(t):e==="echarts"?tw(t):e==="mindmap"?sw(t):e==="graphviz"?nw(t):e==="math"?Ma(t):t.getAttribute("data-type")==="NodeHTMLBlock"&&cw(t)},Xi=(t,e)=>{let n="";return t.forEach(a=>{typeof a=="string"?n+=`<option value="${a}" ${e===a?"selected":""}>${a}</option>`:n+=`<option value="${a.name}" ${e===a.name?"selected":""}>${a.label}</option>`}),n},QS=(t,e)=>{let n="";return t.forEach(a=>{n+=`<option value="${a.name}" ${e===a.name?"selected":""}>${a.label} (${a.name})</option>`}),n},xe=(t,e,n,a,i=!1)=>{if(!e&&!t){n();return}const s=new we({title:t,content:`<div class="b3-dialog__content">
    <div class="ft__breakword">${e}</div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel" id="cancelDialogConfirmBtn">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button ${i?"b3-button--remove":"b3-button--text"}" id="confirmDialogConfirmBtn">${window.siyuan.languages[i?"delete":"confirm"]}</button>
</div>`,width:W()?"92vw":"520px"});s.element.addEventListener("click",o=>{let l=o.target;const r=typeof o.detail=="string";for(;l&&!l.isSameNode(s.element)||r;){if(l.id==="cancelDialogConfirmBtn"||r&&o.detail==="Escape"){a&&a(s),s.destroy();break}else if(l.id==="confirmDialogConfirmBtn"||r&&o.detail==="Enter"){n&&n(s),s.destroy();break}l=l.parentElement}}),s.element.setAttribute("data-key",u.DIALOG_CONFIRM)},dw=()=>{E("/api/snippet/getSnippet",{type:"all",enabled:2},t=>{t.data.snippets.forEach(e=>{const n=`snippet${e.type==="css"?"CSS":"JS"}${e.id}`;let a=document.getElementById(n);if(!window.siyuan.config.snippet.enabledCSS&&e.type==="css"||!window.siyuan.config.snippet.enabledJS&&e.type==="js"){a&&a.remove();return}if(!e.enabled){a&&a.remove();return}if(a){if(a.innerHTML===e.content)return;a.remove()}e.type==="css"?document.head.insertAdjacentHTML("beforeend",`<style id="${n}">${e.content}</style>`):e.type==="js"&&(a=document.createElement("script"),a.type="text/javascript",a.text=e.content,a.id=n,document.head.appendChild(a))})})},eL=()=>{E("/api/snippet/getSnippet",{type:"all",enabled:2},t=>{let e="",n="";t.data.snippets.forEach(s=>{s.type==="css"?e+=xh(s):n+=xh(s)});const a=new we({width:"70vw",height:"80vh",content:`<div class="layout-tab-bar fn__flex fn__flex-shrink" style="border-radius: var(--b3-border-radius-b) var(--b3-border-radius-b) 0 0">
    <div data-type="css" class="item item--full item--focus"><span class="fn__flex-1"></span><span class="item__text">CSS</span><span class="fn__flex-1"></span></div>
    <div data-type="js" class="item item--full"><span class="fn__flex-1"></span><span class="item__text">JS</span><span class="fn__flex-1"></span></div>
</div>
<div class="fn__flex-1" style="overflow:auto;padding: 16px 24px">
    <div>
        <div class="fn__flex">
            <div class="fn__flex-1"></div>
            <div class="b3-form__icon">
                <svg class="b3-form__icon-icon"><use xlink:href="#iconSearch"></use></svg>
                <input data-type="css" data-action="search" type="text" placeholder="${window.siyuan.languages.search}" class="b3-text-field b3-form__icon-input">
            </div>
            <div class="fn__space"></div>
            <span aria-label="${window.siyuan.languages.addAttr} CSS" id="addCodeSnippetCSS" class="b3-tooltips b3-tooltips__sw block__icon block__icon--show">
                <svg><use xlink:href="#iconAdd"></use></svg>
            </span>
            <div class="fn__space"></div>
            <input data-action="toggleCSS" class="b3-switch b3-switch--side fn__flex-center" type="checkbox"${window.siyuan.config.snippet.enabledCSS?" checked":""}>
        </div>
        ${e}
    </div>
    <div class="fn__none">
        <div class="fn__flex">
            <div class="fn__flex-1"></div>
             <div class="b3-form__icon">
                <svg class="b3-form__icon-icon"><use xlink:href="#iconSearch"></use></svg>
                <input data-type="js" data-action="search" type="text" placeholder="${window.siyuan.languages.search}" class="b3-text-field b3-form__icon-input">
            </div>
            <div class="fn__space"></div>
            <span aria-label="${window.siyuan.languages.addAttr} JS" id="addCodeSnippetJS" class="b3-tooltips b3-tooltips__sw block__icon block__icon--show">
                <svg><use xlink:href="#iconAdd"></use></svg>
            </span>
            <div class="fn__space"></div>
            <input data-action="toggleJS" class="b3-switch b3-switch--side fn__flex-center" type="checkbox"${window.siyuan.config.snippet.enabledJS?" checked":""}>
        </div>
        ${n}
    </div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,destroyCallback:s=>{s?.cancel!=="true"&&pw(a,t.data.snippets,i,!0)}});t.data.snippets.forEach(s=>{const o=a.element.querySelector(`[data-id="${s.id}"] input`);o.value=s.name;const l=a.element.querySelector(`[data-id="${s.id}"] textarea`);l.textContent=s.content});const i=[];a.element.setAttribute("data-key",u.DIALOG_SNIPPETS),a.element.addEventListener("click",s=>{let o=s.target;for(;o&&!o.isSameNode(a.element);){if(o.id==="addCodeSnippetCSS"||o.id==="addCodeSnippetJS"){o.parentElement.insertAdjacentHTML("afterend",xh({type:o.id==="addCodeSnippetCSS"?"css":"js",name:"",content:"",enabled:!1})),s.stopPropagation(),s.preventDefault();break}else if(o.classList.contains("b3-button--cancel")){a.destroy({cancel:"true"}),s.stopPropagation(),s.preventDefault();break}else if(o.classList.contains("b3-button--text")){pw(a,t.data.snippets,i),s.stopPropagation(),s.preventDefault();break}else if(o.classList.contains("item")){o.getAttribute("data-type")==="css"?(o.classList.add("item--focus"),o.nextElementSibling.classList.remove("item--focus"),o.parentElement.nextElementSibling.firstElementChild.classList.remove("fn__none"),o.parentElement.nextElementSibling.lastElementChild.classList.add("fn__none")):(o.classList.add("item--focus"),o.previousElementSibling.classList.remove("item--focus"),o.parentElement.nextElementSibling.firstElementChild.classList.add("fn__none"),o.parentElement.nextElementSibling.lastElementChild.classList.remove("fn__none")),s.stopPropagation(),s.preventDefault();break}else if(o.dataset.action==="remove"){const l=o.parentElement.parentElement;i.push("#snippet"+(l.getAttribute("data-type")==="css"?"CSS":"JS")+l.getAttribute("data-id")),l.remove(),s.stopPropagation(),s.preventDefault();break}o=o.parentElement}}),a.element.querySelectorAll('[data-action="search"]').forEach(s=>{s.addEventListener("input",o=>{o.isComposing||uw(a,s)}),s.addEventListener("compositionend",()=>{uw(a,s)})})})},uw=(t,e)=>{t.element.querySelectorAll(`.fn__flex-1 > div > [data-type="${e.dataset.type}"]`).forEach(n=>{const a=n.querySelector("input").value.toLowerCase(),i=n.querySelector("textarea").value.toLowerCase(),s=e.value.toLowerCase();!s||a&&(s.includes(a)||a.includes(s))||i&&(i.includes(s)||s.includes(i))?n.classList.remove("fn__none"):n.classList.add("fn__none")})},xh=t=>`<div data-id="${t.id||""}" data-type="${t.type}">
    <div class="fn__hr--b"></div>
    <div class="fn__flex">
        <input type="text" class="fn__size200 b3-text-field" placeholder="${window.siyuan.languages.title}">
        <div class="fn__flex-1"></div>
        <div class="fn__space"></div>
        <span aria-label="${window.siyuan.languages.remove}" data-action="remove" class="b3-tooltips b3-tooltips__sw block__icon block__icon--show">
            <svg><use xlink:href="#iconTrashcan"></use></svg>
        </span>
        <div class="fn__space"></div>
        <input data-type="snippet" class="b3-switch b3-switch--side fn__flex-center" type="checkbox"${t.enabled?" checked":""}>
    </div>
    <div class="fn__hr"></div>
    <textarea class="fn__block b3-text-field" placeholder="${window.siyuan.languages.codeSnippet}" style="resize: vertical;font-family:var(--b3-font-family-code)" spellcheck="false"></textarea>
    <div class="fn__hr--b"></div>
</div>`,fw=(t,e,n)=>{E("/api/snippet/setSnippet",{snippets:e},()=>{n.forEach(a=>{const i=document.querySelector(a);i&&i.remove()}),window.siyuan.config.snippet.enabledCSS=t.element.querySelector('.b3-switch[data-action="toggleCSS"]').checked,window.siyuan.config.snippet.enabledJS=t.element.querySelector('.b3-switch[data-action="toggleJS"]').checked,E("/api/setting/setSnippet",window.siyuan.config.snippet),dw(),t.destroy({cancel:"true"})})},pw=(t,e,n,a=!1)=>{const i=[];t.element.querySelectorAll("[data-id]").forEach(s=>{i.push({id:s.getAttribute("data-id"),name:s.querySelector("input").value,type:s.getAttribute("data-type"),content:s.querySelector("textarea").value,enabled:s.querySelector(".b3-switch").checked})}),tn(e,i)&&window.siyuan.config.snippet.enabledCSS===t.element.querySelector('.b3-switch[data-action="toggleCSS"]').checked&&window.siyuan.config.snippet.enabledJS===t.element.querySelector('.b3-switch[data-action="toggleJS"]').checked?t.destroy({cancel:"true"}):a?xe(window.siyuan.languages.save,window.siyuan.languages.snippetsTip,()=>{fw(t,i,n)}):fw(t,i,n)},Rn=(t,e)=>{let n="";switch(t){case"NodeDocument":n="iconFile";break;case"NodeThematicBreak":n="iconLine";break;case"NodeParagraph":n="iconParagraph";break;case"NodeHeading":e?n="icon"+e.toUpperCase():n="iconHeadings";break;case"NodeBlockquote":n="iconQuote";break;case"NodeList":e==="t"?n="iconCheck":e==="o"?n="iconOrderedList":n="iconList";break;case"NodeListItem":n="iconListItem";break;case"NodeCodeBlock":case"NodeYamlFrontMatter":n="iconCode";break;case"NodeTable":n="iconTable";break;case"NodeBlockQueryEmbed":n="iconSQL";break;case"NodeSuperBlock":n="iconSuper";break;case"NodeMathBlock":n="iconMath";break;case"NodeHTMLBlock":n="iconHTML5";break;case"NodeWidget":n="iconBoth";break;case"NodeIFrame":n="iconLanguage";break;case"NodeVideo":n="iconVideo";break;case"NodeAudio":n="iconRecord";break;case"NodeAttributeView":n="iconDatabase";break}return n};class ec{constructor(e){this.click=e.click,this.ctrlClick=e.ctrlClick,this.altClick=e.altClick,this.shiftClick=e.shiftClick,this.rightClick=e.rightClick,this.toggleClick=e.toggleClick,this.element=e.element,this.blockExtHTML=e.blockExtHTML,this.topExtHTML=e.topExtHTML,this.updateData(e.data),this.bindEvent()}updateData(e){this.data=e,!this.data||this.data.length===0?this.element.innerHTML=`<ul class="b3-list b3-list--background"><li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li></ul>`:(this.element.innerHTML=this.genHTML(this.data),Ma(this.element))}genHTML(e){let n=`<ul${e[0].depth===0?" class='b3-list b3-list--background'":""}>`;return e.forEach(a=>{let i="",s='<svg class="b3-list-item__graphic"><use xlink:href="#iconFolder"></use></svg>';a.type==="bookmark"?s='<svg class="b3-list-item__graphic"><use xlink:href="#iconBookmark"></use></svg>':a.type==="tag"?s='<svg class="b3-list-item__graphic"><use xlink:href="#iconTags"></use></svg>':a.type==="backlink"?(i=` aria-label="${Rt(a.hPath)}"`,s=`<svg class="b3-list-item__graphic popover__block" data-id="${a.id}"><use xlink:href="#${Rn(a.nodeType,a.subType)}"></use></svg>`):a.type==="outline"&&(i=` aria-label="${Rt(Lute.BlockDOM2Content(a.name))}"`,s=`<svg class="b3-list-item__graphic popover__block" data-id="${a.id}" style="height: 22px;width: 10px;"><use xlink:href="#${Rn(a.nodeType,a.subType)}"></use></svg>`);let o="";a.count&&(o=`<span class="counter">${a.count}</span>`);const l=a.children&&a.children.length>0||a.blocks&&a.blocks.length>0;let r="";W()?a.depth>0&&(r=`padding-left: ${(a.depth-1)*20+24}px`):r=`padding-left: ${a.depth*18||4}px;margin-right: 2px`;const d=l||a.type==="backlink"&&!W();n+=`<li class="b3-list-item${W()?"":" b3-list-item--hide-action"}" 
${a.id?'data-node-id="'+a.id+'"':""} 
${a.box?'data-notebook-id="'+a.box+'"':""} 
style="--file-toggle-width:${a.depth===0?22:(a.depth+1)*18}px" 
data-treetype="${a.type}" 
data-type="${a.nodeType}" 
data-subtype="${a.subType}" 
${a.label?"data-label='"+a.label+"'":""}>
    <span style="${r}" class="b3-list-item__toggle${d?" b3-list-item__toggle--hl":""}${d?"":" fn__hidden"}">
        <svg data-id="${a.id||encodeURIComponent(a.name+a.depth)}" class="b3-list-item__arrow${l?" b3-list-item__arrow--open":""}"><use xlink:href="#iconRight"></use></svg>
    </span>
    ${s}
    <span class="b3-list-item__text ariaLabel" data-position="parentE"${i}>${a.name}</span>
    ${this.topExtHTML||""}
    ${o}
</li>`,a.children&&a.children.length>0&&(n+=this.genHTML(a.children)+"</ul>"),a.blocks&&a.blocks.length>0&&(n+=this.genBlockHTML(a.blocks,!0,a.type)+"</ul>")}),n}genBlockHTML(e,n=!1,a){let i=`<ul class="${n?"":"fn__none"}">`;return e.forEach(s=>{let o="";s.count&&(o=`<span class="counter">${s.count}</span>`);let l;a==="outline"?l=`<svg data-showref="true" class="b3-list-item__graphic popover__block" data-id="${s.id}" style="height: 22px;width: 10px;"><use xlink:href="#${Rn(s.type,s.subType)}"></use></svg>`:s.type==="NodeDocument"?l=`<span data-showref="true" class="b3-list-item__graphic popover__block" data-id="${s.id}">${ge(s.ial.icon||window.siyuan.storage[u.LOCAL_IMAGES].file)}</span>`:l=`<svg data-showref="true" class="b3-list-item__graphic popover__block" data-id="${s.id}"><use xlink:href="#${Rn(s.type,s.subType)}"></use></svg>`;let r="";W()?s.depth>0&&(r=`padding-left: ${(s.depth-1)*20+24}px`):r=`padding-left: ${s.depth*18||4}px;margin-right: 2px`,i+=`<li class="b3-list-item${W()?"":" b3-list-item--hide-action"}"  
style="--file-toggle-width:${s.depth===0?22:(s.depth+1)*18}px" 
data-node-id="${s.id}" 
data-ref-text="${encodeURIComponent(s.refText)}" 
data-def-id="${s.defID}" 
data-type="${s.type}" 
data-subtype="${s.subType}" 
data-treetype="${a}" 
data-def-path="${s.defPath}">
    <span style="${r}" class="b3-list-item__toggle${s.children?" b3-list-item__toggle--hl":""}${s.children?"":" fn__hidden"}">
        <svg data-id="${s.id}" class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
    </span>
    ${l}
    <span class="b3-list-item__text ariaLabel" data-position="parentE" ${a==="outline"?' aria-label="'+Rt(Lute.BlockDOM2Content(s.content))+'"':""}>${s.content}</span>
    ${o}
    ${this.blockExtHTML||""}
</li>`,s.children&&s.children.length>0&&(i+=this.genBlockHTML(s.children,!1,a)+"</ul>")}),i}toggleBlocks(e){if(this.toggleClick){this.toggleClick(e);return}if(!e.nextElementSibling)return;const n=e.firstElementChild.firstElementChild;n.classList.contains("b3-list-item__arrow--open")?(n.classList.remove("b3-list-item__arrow--open"),e.nextElementSibling.classList.add("fn__none"),e.nextElementSibling.nextElementSibling&&e.nextElementSibling.nextElementSibling.tagName==="UL"&&e.nextElementSibling.nextElementSibling.classList.add("fn__none")):(n.classList.add("b3-list-item__arrow--open"),e.nextElementSibling.classList.remove("fn__none"),e.nextElementSibling.nextElementSibling&&e.nextElementSibling.nextElementSibling.tagName==="UL"&&e.nextElementSibling.nextElementSibling.classList.remove("fn__none"))}setCurrent(e){e.classList.contains("b3-list--empty")||(this.element.querySelectorAll("li").forEach(n=>{n.classList.remove("b3-list-item--focus")}),e.classList.add("b3-list-item--focus"))}bindEvent(){this.element.addEventListener("contextmenu",e=>{let n=e.target;for(;n&&!n.isEqualNode(this.element);){if(n.tagName==="LI"&&this.rightClick){this.rightClick(n,e),e.preventDefault(),e.stopPropagation();break}n=n.parentElement}}),this.element.addEventListener("click",e=>{let n=e.target;for(;n&&!n.isEqualNode(this.element);){if(n.classList.contains("b3-list-item__toggle")&&!n.classList.contains("fn__hidden")){this.toggleBlocks(n.parentElement),this.setCurrent(n.parentElement),e.preventDefault();break}if(n.classList.contains("b3-list-item__action")&&this.click){const a=q(n,"LI");a&&this.click(a,e),e.preventDefault(),e.stopPropagation();break}else if(n.tagName==="LI"){this.setCurrent(n),n.getAttribute("data-node-id")||n.getAttribute("data-treetype")==="tag"?(this.ctrlClick&&window.siyuan.ctrlIsPressed?this.ctrlClick(n):this.altClick&&window.siyuan.altIsPressed?this.altClick(n):this.shiftClick&&window.siyuan.shiftIsPressed?this.shiftClick(n):this.click&&this.click(n,e),e.stopPropagation()):this.toggleBlocks(n),e.preventDefault();break}n=n.parentElement}}),this.element.addEventListener("dragstart",e=>{const n=q(e.target,"LI");n&&(e.dataTransfer.setData("text/html",n.outerHTML),n.style.opacity="0.1",window.siyuan.dragElement=n)}),this.element.addEventListener("dragend",e=>{const n=q(e.target,"LI");n&&(n.style.opacity="1"),window.siyuan.dragElement=void 0})}expandAll(){this.element.querySelectorAll("ul").forEach(e=>{e.classList.contains("b3-list")||e.classList.remove("fn__none")}),this.element.querySelectorAll(".b3-list-item__arrow").forEach(e=>{e.classList.add("b3-list-item__arrow--open")})}collapseAll(){this.element.querySelectorAll("ul").forEach(e=>{e.classList.contains("b3-list")||e.classList.add("fn__none")}),this.element.querySelectorAll(".b3-list-item__arrow").forEach(e=>{e.classList.remove("b3-list-item__arrow--open")})}getExpandIds(){const e=[];return this.element.querySelectorAll(".b3-list-item__arrow--open").forEach(n=>{e.push(n.getAttribute("data-id"))}),e}setExpandIds(e){this.element.querySelectorAll(".b3-list-item__arrow").forEach(n=>{e.includes(n.getAttribute("data-id"))?(n.classList.add("b3-list-item__arrow--open"),n.parentElement.parentElement.nextElementSibling&&n.parentElement.parentElement.nextElementSibling.classList.remove("fn__none")):(n.classList.remove("b3-list-item__arrow--open"),n.parentElement.parentElement.nextElementSibling&&n.parentElement.parentElement.nextElementSibling.tagName==="UL"&&n.parentElement.parentElement.nextElementSibling.classList.add("fn__none"))})}}const gw=t=>{const e=new we({title:window.siyuan.languages.rename,content:`<div class="b3-dialog__content"><input class="b3-text-field fn__block" value="${t}"></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:W()?"92vw":"520px"});e.element.setAttribute("data-key",u.DIALOG_RENAMETAG);const n=e.element.querySelectorAll(".b3-button");n[0].addEventListener("click",()=>{e.destroy()});const a=e.element.querySelector("input");e.bindInput(a,()=>{n[1].click()}),a.focus(),a.select(),n[1].addEventListener("click",()=>{E("/api/tag/renameTag",{oldLabel:t,newLabel:a.value})})},hw=()=>Ee().basename(window.siyuan.config.system.workspaceDir.replace(/\\/g,"/")),Ke=(t,e)=>{t&&E("/api/block/checkBlockFold",{id:t},n=>{e(n.data.isFolded,n.data.isFolded?[u.CB_GET_FOCUS,u.CB_GET_ALL]:[u.CB_GET_FOCUS,u.CB_GET_CONTEXT,u.CB_GET_ROOTSCROLL],n.data.isRoot)})},tc=(t,e)=>!t.classList.contains(e)||t.getBoundingClientRect().height===0,xn=(t,e,n="b3-list-item--focus",a)=>{let i=t.querySelector("."+n);if(!i&&a){a.classList.add(n),a.scrollIntoView(!0);return}if(!i)return;const s=n.split("--")[0];if(e.key==="ArrowDown"){for(e.preventDefault(),e.stopPropagation(),i.classList.remove(n),i=i.nextElementSibling;i&&tc(i,s);)i=i.nextElementSibling;if(!i)for(i=t.children[0];i&&tc(i,s);)i=i.nextElementSibling;return i?(i.classList.add(n),(t.scrollTop<i.offsetTop-t.clientHeight+i.clientHeight||t.scrollTop>i.offsetTop)&&i.scrollIntoView(t.scrollTop>i.offsetTop),i):void 0}else if(e.key==="ArrowUp"){for(e.preventDefault(),e.stopPropagation(),i.classList.remove(n),i=i.previousElementSibling;i&&tc(i,s);)i=i.previousElementSibling;if(!i)for(i=t.children[t.children.length-1];i&&(i.classList.contains("fn__none")||!i.classList.contains(s));)i=i.previousElementSibling;if(!i)return;i.classList.add(n);const o=t.scrollTop>i.offsetTop-(i.previousElementSibling?.clientHeight||0);return(t.scrollTop<i.offsetTop-t.clientHeight+i.clientHeight||o)&&i.scrollIntoView(o),i}else if(e.key==="Home"){for(e.preventDefault(),e.stopPropagation(),i.classList.remove(n),i=t.children[0];i&&tc(i,s);)i=i.nextElementSibling;return i?(i.classList.add(n),i.scrollIntoView(),i):void 0}else if(e.key==="End"){for(e.preventDefault(),e.stopPropagation(),i.classList.remove(n),i=t.children[t.children.length-1];i&&tc(i,s);)i=i.previousElementSibling;return i?(i.classList.add(n),i.scrollIntoView(!1),i):void 0}};class tL{constructor(){this.wheelEvent="onwheel"in document.createElement("div")?"wheel":"mousewheel",this.element=document.getElementById("commonMenu"),this.element.querySelector(".b3-menu__title .b3-menu__label").innerHTML=window.siyuan.languages.back,this.element.addEventListener(W()?"click":"mouseover",e=>{const n=e.target;if(W()&&(L(n,"b3-menu__title")||typeof e.detail=="string"&&e.detail==="back")){const o=this.element.querySelectorAll(".b3-menu__item--show");o.length>0?o[o.length-1].classList.remove("b3-menu__item--show"):(this.element.style.transform="",setTimeout(()=>{this.remove()},u.TIMEOUT_DBLCLICK));return}const a=L(n,"b3-menu__item");if(!a||a.classList.contains("b3-menu__item--readonly"))return;const i=a.querySelector(".b3-menu__submenu");this.element.querySelectorAll(".b3-menu__item--show").forEach(s=>{!s.contains(a)&&!s.isSameNode(a)&&!a.contains(s)&&s.classList.remove("b3-menu__item--show")}),this.element.querySelectorAll(".b3-menu__item--current").forEach(s=>{s.classList.remove("b3-menu__item--current")}),a.classList.add("b3-menu__item--current"),i&&(a.classList.add("b3-menu__item--show"),this.element.classList.contains("b3-menu--fullscreen")||this.showSubMenu(i))})}showSubMenu(e){const n=e.parentElement.getBoundingClientRect();e.style.top=n.top-8+"px",e.style.left=n.right+8+"px",e.style.bottom="auto";const a=e.getBoundingClientRect();a.right>window.innerWidth&&(n.left-8>a.width?e.style.left=n.left-8-a.width+"px":e.style.left=window.innerWidth-a.width+"px"),a.bottom>window.innerHeight&&(e.style.top="auto",e.style.bottom="8px")}preventDefault(e){!L(e.target,"b3-menu")&&!L(e.target,"keyboard__bar")&&e.preventDefault()}addItem(e){const n=new T(e);return this.append(n.element,e.index),n.element}removeScrollEvent(){window.removeEventListener(W()?"touchmove":this.wheelEvent,this.preventDefault,!1)}remove(){window.siyuan.menus.menu.removeCB&&(window.siyuan.menus.menu.removeCB(),window.siyuan.menus.menu.removeCB=void 0),this.removeScrollEvent(),this.element.firstElementChild.classList.add("fn__none"),this.element.lastElementChild.innerHTML="",this.element.lastElementChild.removeAttribute("style"),this.element.classList.add("fn__none"),this.element.classList.remove("b3-menu--list","b3-menu--fullscreen"),this.element.removeAttribute("style"),this.element.removeAttribute("data-name"),this.element.removeAttribute("data-from"),this.data=void 0}append(e,n){if(e){if(typeof n=="number"){const a=this.element.querySelectorAll(".b3-menu__items > .b3-menu__separator")[n];if(a){a.before(e);return}}this.element.lastElementChild.append(e)}}popup(e){this.element.lastElementChild.innerHTML!==""&&(window.addEventListener(W()?"touchmove":this.wheelEvent,this.preventDefault,{passive:!1}),this.element.style.zIndex=(++window.siyuan.zIndex).toString(),this.element.classList.remove("fn__none"),ke(this.element,e.x-(e.isLeft?this.element.clientWidth:0),e.y,e.h,e.w))}fullscreen(e="all"){this.element.lastElementChild.innerHTML!==""&&(this.element.classList.add("b3-menu--fullscreen"),this.element.style.zIndex=(++window.siyuan.zIndex).toString(),this.element.firstElementChild.classList.remove("fn__none"),this.element.classList.remove("fn__none"),window.addEventListener("touchmove",this.preventDefault,{passive:!1}),setTimeout(()=>{e==="bottom"?(this.element.style.transform="translateY(-50vh)",this.element.style.height="50vh"):this.element.style.transform="translateY(-100vh)"}),this.element.lastElementChild.scrollTop=0)}}class T{constructor(e){if(!e.ignore){if(e.type==="empty"){this.element=document.createElement("div"),this.element.innerHTML=e.label,e.bind&&e.bind(this.element);return}if(this.element=document.createElement("button"),e.disabled&&this.element.setAttribute("disabled","disabled"),e.id&&this.element.setAttribute("data-id",e.id),e.type==="separator"){this.element.classList.add("b3-menu__separator");return}if(this.element.classList.add("b3-menu__item"),e.current&&this.element.classList.add("b3-menu__item--selected"),e.click&&this.element.addEventListener("click",n=>{if(this.element.getAttribute("disabled"))return;let a=e.click(this.element,n);a instanceof Promise&&(a=!1),n.preventDefault(),n.stopImmediatePropagation(),n.stopPropagation(),this.element.parentElement&&!a&&window.siyuan.menus.menu.remove()}),e.type==="readonly"&&this.element.classList.add("b3-menu__item--readonly"),(e.icon==="iconTrashcan"||e.warning)&&this.element.classList.add("b3-menu__item--warning"),e.element)this.element.append(e.element);else{let n=`<span class="b3-menu__label">${e.label||"&nbsp;"}</span>`;typeof e.iconHTML=="string"?n=e.iconHTML+n:n=`<svg class="b3-menu__icon ${e.iconClass||""}" style="${e.icon==="iconClose"?"height:10px;":""}"><use xlink:href="#${e.icon||""}"></use></svg>${n}`,e.accelerator&&(n+=`<span class="b3-menu__accelerator">${X(e.accelerator)}</span>`),e.action&&(n+=`<svg class="b3-menu__action${e.action==="iconCloseRound"?" b3-menu__action--close":""}"><use xlink:href="#${e.action}"></use></svg>`),e.checked&&(n+='<svg class="b3-menu__checked"><use xlink:href="#iconSelect"></use></svg></span>'),this.element.innerHTML=n}if(e.bind&&(this.element.classList.add("b3-menu__item--custom"),e.bind(this.element)),e.submenu){const n=document.createElement("div");n.classList.add("b3-menu__submenu"),n.innerHTML='<div class="b3-menu__items"></div>',e.submenu.forEach(a=>{n.firstElementChild.append(new T(a).element)}),this.element.insertAdjacentHTML("beforeend",'<svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>'),this.element.append(n)}}}}const eo=(t,e)=>{let n=t;for(;n&&(n.classList.contains("b3-menu__separator")||n.classList.contains("b3-menu__item--readonly")||n.getBoundingClientRect().height===0)&&!n.querySelector(".b3-text-field");)e?n=n.nextElementSibling:n=n.previousElementSibling;return n},nL=t=>{if(window.siyuan.menus.menu.element.classList.contains("fn__none")||t.altKey||t.shiftKey||t.ctrlKey||t.metaKey)return!1;const e=t.target;if(window.siyuan.menus.menu.element.contains(e)&&["INPUT","TEXTAREA"].includes(e.tagName))return!1;const n=u.KEYCODELIST[t.keyCode];if(n==="\u2193"||n==="\u2191"){const a=window.siyuan.menus.menu.element.querySelector(".b3-menu__item--current");let i;if(a?(a.classList.remove("b3-menu__item--current","b3-menu__item--show"),n==="\u2191"?(i=eo(a.previousElementSibling,!1),i||(i=eo(a.parentElement.lastElementChild,!1))):(i=eo(a.nextElementSibling,!0),i||(i=eo(a.parentElement.firstElementChild,!0)))):n==="\u2191"?i=eo(window.siyuan.menus.menu.element.lastElementChild.lastElementChild,!1):i=eo(window.siyuan.menus.menu.element.lastElementChild.firstElementChild,!0),i){i.classList.add("b3-menu__item--current"),i.classList.remove("b3-menu__item--show");const s=i.parentElement.getBoundingClientRect(),o=i.getBoundingClientRect();(s.top>o.top||s.bottom<o.bottom)&&i.scrollIntoView(s.top>o.top)}return!0}else if(n==="\u2192"){const a=window.siyuan.menus.menu.element.querySelector(".b3-menu__item--current");if(!a)return!0;const i=a.querySelector(".b3-menu__submenu");if(!i)return!0;a.classList.remove("b3-menu__item--current"),a.classList.add("b3-menu__item--show");const s=eo(i.firstElementChild.firstElementChild,!0);return s&&s.classList.add("b3-menu__item--current"),window.siyuan.menus.menu.showSubMenu(i),!0}else if(n==="\u2190"){const a=window.siyuan.menus.menu.element.querySelector(".b3-menu__submenu .b3-menu__item--current");if(!a)return!0;const i=L(a,"b3-menu__item--show");return i&&(i.classList.remove("b3-menu__item--show"),i.classList.add("b3-menu__item--current"),a.classList.remove("b3-menu__item--current")),!0}else if(n==="\u21A9"){const a=window.siyuan.menus.menu.element.querySelector(".b3-menu__item--current");if(a){const i=a.querySelector(".b3-text-field"),s=a.querySelector(".b3-switch");if(i)return i.focus(),!0;s?s.click():a.dispatchEvent(new CustomEvent(Gr())),window.siyuan.menus.menu.element.contains(a)&&window.siyuan.menus.menu.remove()}else return!1;return!0}};class aL{constructor(){this.menus=[]}addSeparator(e,n){typeof e=="number"?this.menus.splice(e,0,{type:"separator",id:n}):this.menus.push({type:"separator",id:n})}addItem(e){typeof e.index=="number"?this.menus.splice(e.index,0,e):this.menus.push(e)}}const df=t=>({id:"export",label:window.siyuan.languages.export,icon:"iconUpload",async click(){const e=await ee.ipcRenderer.invoke(u.SIYUAN_GET,{cmd:"showSaveDialog",defaultPath:Jr(t)+Ee().extname(t),properties:["showOverwriteConfirmation"]});e.canceled||E("/api/file/copyFile",{src:t,dest:e.filePath})}}),Ah=(t,e,n,a,i=!1)=>{const s=[{id:"insertRight",icon:"iconLayoutRight",label:window.siyuan.languages.insertRight,accelerator:e.length===1?`${X(window.siyuan.config.keymap.editor.general.insertRight.custom)}/${X("\u2325"+window.siyuan.languages.click)}`:void 0,click:()=>{n?de({app:t,id:e[0],position:"right",action:[u.CB_GET_FOCUS,u.CB_GET_SCROLL]}):e.forEach(o=>{Ke(o,(l,r)=>{de({app:t,id:o,position:"right",action:r,zoomIn:l})})})}},{id:"insertBottom",icon:"iconLayoutBottom",label:window.siyuan.languages.insertBottom,accelerator:e.length===1?"\u21E7"+window.siyuan.languages.click:"",click:()=>{n?de({app:t,id:e[0],position:"bottom",action:[u.CB_GET_FOCUS,u.CB_GET_SCROLL]}):e.forEach(o=>{Ke(o,(l,r)=>{de({app:t,id:o,position:"bottom",action:r,zoomIn:l})})})}}];if(window.siyuan.config.fileTree.openFilesUseCurrentTab&&s.push({id:"openInNewTab",label:window.siyuan.languages.openInNewTab,accelerator:e.length===1?"\u2325\u2318"+window.siyuan.languages.click:void 0,click:()=>{n?de({app:t,id:e[0],action:[u.CB_GET_FOCUS,u.CB_GET_SCROLL],removeCurrentTab:!1}):e.forEach(o=>{Ke(o,(l,r)=>{de({app:t,id:o,action:r,zoomIn:l,removeCurrentTab:!1})})})}}),s.push({id:"openByNewWindow",label:window.siyuan.languages.openByNewWindow,icon:"iconOpenWindow",click(){Xr(e)}}),s.push({id:"separator_1",type:"separator"}),s.push({id:"preview",icon:"iconPreview",label:window.siyuan.languages.preview,click:()=>{e.forEach(o=>{de({app:t,id:o,mode:"preview"})})}}),s.push({id:"separator_2",type:"separator"}),s.push({id:"showInFolder",icon:"iconFolder",label:window.siyuan.languages.showInFolder,click:()=>{n?Ja(Ft.join(window.siyuan.config.system.dataDir,n,a)):e.forEach(o=>{E("/api/block/getBlockInfo",{id:o},l=>{Ja(Ft.join(window.siyuan.config.system.dataDir,l.data.box,l.data.path))})})}}),i)return s;window.siyuan.menus.menu.append(new T({id:"openBy",label:window.siyuan.languages.openBy,icon:"iconOpen",submenu:s}).element)},Ch=t=>{if(fn()){window.JSAndroid.writeImageClipboard(t);return}else{const e=document.createElement("canvas"),n=document.createElement("img");n.onload=a=>{e.width=a.target.width,e.height=a.target.height,e.getContext("2d").drawImage(a.target,0,0,a.target.width,a.target.height),e.toBlob(i=>{navigator.clipboard.write([new ClipboardItem({["image/png"]:i})])},"image/png",1)},n.src=t}},Qi=require("fs"),iL=()=>{const t=new we({title:window.siyuan.languages.about5,content:`<div class="b3-dialog__content">
    <input class="b3-text-field fn__block" placeholder="${window.siyuan.languages.about5}" value="${window.siyuan.config.accessAuthCode}">
    <div class="b3-label__text">${window.siyuan.languages.about6}</div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:W()?"92vw":"520px"}),e=t.element.querySelector("input"),n=t.element.querySelectorAll(".b3-button");t.element.setAttribute("data-key",u.DIALOG_ACCESSAUTHCODE),t.bindInput(e,()=>{n[1].click()}),e.select(),n[0].addEventListener("click",()=>{t.destroy()}),n[1].addEventListener("click",()=>{E("/api/system/setAccessAuthCode",{accessAuthCode:e.value})})},yn=t=>`${window.siyuan.config.cloudRegion===0?"https://ld246.com":"https://liuyun.io"}/${t}`,sL=t=>`https://b3log.org/siyuan${window.siyuan.config.lang==="zh_CN"?"":"/en"}/${t}`,Si=(t=window.siyuan.languages._kernel[29])=>window.siyuan.user&&(window.siyuan.user.userSiYuanProExpireTime===-1||window.siyuan.user.userSiYuanProExpireTime>0)?!1:(t&&(t===window.siyuan.languages._kernel[29]&&window.siyuan.config.system.container==="ios"?j(window.siyuan.languages._kernel[122]):(t===window.siyuan.languages._kernel[29]&&(t=window.siyuan.languages._kernel[29].replace("${url}",yn("subscribe/siyuan"))),j(t))),!0),es=()=>window.siyuan.user&&(window.siyuan.user.userSiYuanSubscriptionStatus===0||window.siyuan.user.userSiYuanOneTimePayStatus===1),uf=(t,e)=>{j(`${window.siyuan.languages.exported} ${pe(t)}
<div class="fn__space"></div>
<button class="b3-button b3-button--white">${window.siyuan.languages.showInFolder}</button>`,6e3,"info",e),document.querySelector(`#message [data-id="${e}"] button`).addEventListener("click",()=>{Ja(Ft.join(t)),Ue(e)})},oL=t=>{const e=new we({title:window.siyuan.languages.exportAsImage,content:`<div class="b3-dialog__content" style="${W()?"padding:8px;":""};background-color: var(--b3-theme-background)">
    <div style="${W()?"padding: 16px;margin: 8px 0":"padding: 48px;margin: 8px 0"};" class="export-img">
        <div class="protyle-wysiwyg${window.siyuan.config.editor.displayBookmarkIcon?" protyle-wysiwyg--attr":""}"></div>
        <div class="export-img__watermark"></div>
    </div>
</div>
<div class="b3-dialog__action">
    <label class="fn__flex">
        ${window.siyuan.languages.exportPDF5}
        <span class="fn__space"></span>
        <input id="keepFold" class="b3-switch fn__flex-center" type="checkbox" ${window.siyuan.storage[u.LOCAL_EXPORTIMG].keepFold?"checked":""}>
    </label>
    <label class="fn__flex" style="margin-left: 24px">
        ${window.siyuan.languages.export30}
        <span class="fn__space"></span>
        <input id="watermark" class="b3-switch fn__flex-center" type="checkbox" ${window.siyuan.storage[u.LOCAL_EXPORTIMG].watermark?"checked":""}>
    </label>
    <span class="fn__flex-1 export-img__space"></span>
    <button disabled class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button disabled class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>
 <div class="fn__loading"><img height="128px" width="128px" src="stage/loading-pure.svg"></div>`,width:W()?"92vw":"990px",height:"70vh"});e.element.setAttribute("data-key",u.DIALOG_EXPORTIMAGE);const n=e.element.querySelectorAll(".b3-button");n[0].addEventListener("click",()=>{e.destroy()}),n[1].addEventListener("click",()=>{const r=j(window.siyuan.languages.exporting,0);e.element.querySelector(".b3-dialog__container").style.height="",ue(u.LOCAL_EXPORTIMG,window.siyuan.storage[u.LOCAL_EXPORTIMG]),setTimeout(()=>{Ct("/stage/protyle/js/html2canvas.min.js?v=1.4.1","protyleHtml2canvas").then(()=>{window.html2canvas(e.element.querySelector(".b3-dialog__content"),{useCORS:!0}).then(d=>{d.toBlob(c=>{const f=new FormData;f.append("file",c,n[1].getAttribute("data-title")),f.append("type","image/png"),E("/api/export/exportAsFile",f,g=>{Ht(g.data.file)}),Ue(r),e.destroy()})})})},u.TIMEOUT_LOAD)});const a=e.element.querySelector(".protyle-wysiwyg"),i=e.element.querySelector("#keepFold");i.addEventListener("change",()=>{n[0].setAttribute("disabled","disabled"),n[1].setAttribute("disabled","disabled"),n[1].parentElement.insertAdjacentHTML("afterend",'<div class="fn__loading"><img height="128px" width="128px" src="stage/loading-pure.svg"></div>'),window.siyuan.storage[u.LOCAL_EXPORTIMG].keepFold=i.checked,E("/api/export/exportPreviewHTML",{id:t,keepFold:i.checked,image:!0},r=>{l(r)})});const s=e.element.querySelector("#watermark");s.addEventListener("change",()=>{window.siyuan.storage[u.LOCAL_EXPORTIMG].watermark=s.checked,s.checked&&!es()&&(s.checked=!1,j(window.siyuan.languages._kernel[214])),o()});const o=()=>{if(!es())return;const r=e.element.querySelector(".export-img__watermark");r.innerHTML="",s.checked?window.siyuan.config.export.imageWatermarkDesc?r.innerHTML=window.siyuan.config.export.imageWatermarkDesc:window.siyuan.config.export.imageWatermarkStr&&(window.siyuan.config.export.imageWatermarkStr.startsWith("http")?r.setAttribute("style",`background-image: url(${window.siyuan.config.export.imageWatermarkStr});background-repeat: repeat;position: absolute;top: 0;left: 0;width: 100%;height: 100%;border-radius: var(--b3-border-radius-b);`):Ct("/stage/protyle/js/html2canvas.min.js?v=1.4.1","protyleHtml2canvas").then(()=>{const d=Math.max(e.element.querySelector(".export-img").clientWidth/3,150);r.setAttribute("style",`width: ${d}px;height: ${d}px;display: flex;justify-content: center;align-items: center;color: var(--b3-border-color);font-size: 14px;`),r.innerHTML=`<div style="transform: rotate(-45deg)">${window.siyuan.config.export.imageWatermarkStr}</div>`,window.html2canvas(r,{useCORS:!0,scale:1}).then(c=>{r.innerHTML="",r.setAttribute("style",`background-image: url(${c.toDataURL("image/png")});background-repeat: repeat;position: absolute;top: 0;left: 0;width: 100%;height: 100%;border-radius: var(--b3-border-radius-b);`)})})):r.removeAttribute("style")},l=r=>{a.innerHTML=r.data.content,a.querySelectorAll('[data-type~="mark"], [data-type~="u"], [data-type~="text"], [data-type~="code"], [data-type~="tag"], [data-type~="kbd"]').forEach(d=>{d.childNodes.forEach(c=>{let f="";Array.from(c.textContent).forEach(p=>{f+=`<span style="${d.getAttribute("style")||""};border-radius: 0;padding-left: 0;padding-right: 0;box-shadow: none;border-left:0;border-right:0;border-top:0" data-type="${d.getAttribute("data-type")}">${p}</span>`});const g=document.createElement("template");g.innerHTML=f,c.after(g.content),c.remove()}),d.childNodes.length>0&&(d.setAttribute("style",""),d.setAttribute("data-type",d.getAttribute("data-type").replace(/mark|u|text|code|tag|kbd/g,"")))}),a.setAttribute("data-doc-type",r.data.type||"NodeDocument"),r.data.attrs.memo&&a.setAttribute("memo",r.data.attrs.memo),r.data.attrs.name&&a.setAttribute("name",r.data.attrs.name),r.data.attrs.bookmark&&a.setAttribute("bookmark",r.data.attrs.bookmark),r.data.attrs.alias&&a.setAttribute("alias",r.data.attrs.alias),a.querySelectorAll(".code-block").forEach(d=>{d.setAttribute("linewrap","true")}),yt(a),ze(a),a.querySelectorAll("table").forEach(d=>{d.clientWidth>d.parentElement.clientWidth&&(d.setAttribute("style",`margin-bottom:${d.parentElement.clientWidth*d.clientHeight/d.clientWidth-d.parentElement.clientHeight+1}px;transform: scale(${d.parentElement.clientWidth/d.clientWidth});transform-origin: top left;`),d.parentElement.style.overflow="hidden")}),a.querySelectorAll(".li > .protyle-action > svg").forEach(d=>{const c=d.firstElementChild.getAttribute("xlink:href"),f=document.querySelectorAll(c);let g="0 0 32 32";c==="#iconDot"&&(g="0 0 20 20"),d.setAttribute("viewBox",g),d.innerHTML=f[f.length-1].innerHTML}),a.querySelectorAll(".img img").forEach(d=>{const c=d.getAttribute("src");c.endsWith(".svg")?mb(d.src,f=>{d.src=`data:image/svg+xml;base64,${btoa(unescape(encodeURIComponent(f)))}`}):c.startsWith("assets/")&&(d.src=location.origin+"/"+c)}),o(),n[0].removeAttribute("disabled"),n[1].removeAttribute("disabled"),e.element.querySelector(".fn__loading").remove()};E("/api/export/exportPreviewHTML",{id:t,keepFold:i.checked,image:!0},r=>{l(r),n[1].setAttribute("data-title",r.data.name+".png")})},ff=(t,e="outerHTML")=>{if(!t.querySelector("[data-type='block-render']"))return t[e];const n=t.cloneNode(!0);return n.querySelectorAll("span[data-render='1'][data-type='block-render']").forEach(a=>{a.innerHTML="",a.setAttribute("data-render","2")}),n[e]},lL=t=>{const e=document.createElement("template");return e.innerHTML=t,e.content.querySelectorAll('[contenteditable="false"][spellcheck]').forEach(n=>{L(n,"protyle-wysiwyg__embed")||n.setAttribute("contenteditable","true")}),e.innerHTML},Qa=(t,e,n)=>{if(W())return;const a=e.getBoundingClientRect();if(a.height===0||!t){Zt();return}const i=document.getElementById("tooltip");i.className=n?`tooltip tooltip--${n}`:"tooltip",i.innerHTML=t,i.removeAttribute("style");const s=e.getAttribute("data-position"),o=e.parentElement.getBoundingClientRect();let l,r;if(s==="parentE")r=Math.max(0,o.top-(i.clientHeight-o.height)/2),r>window.innerHeight-i.clientHeight&&(r=window.innerHeight-i.clientHeight),l=o.right+8,l+i.clientWidth>window.innerWidth&&(l=o.left-i.clientWidth-8);else if(s==="parentW")r=Math.max(0,o.top-(i.clientHeight-o.height)/2),r>window.innerHeight-i.clientHeight&&(r=window.innerHeight-i.clientHeight),l=o.left-i.clientWidth,l<0&&(l=o.right);else if(s?.endsWith("west")){const d=parseInt(s)||.5;r=Math.max(0,a.top-(i.clientHeight-a.height)/2),r>window.innerHeight-i.clientHeight&&(r=window.innerHeight-i.clientHeight),l=a.left-i.clientWidth-d,l<0&&(l=a.right)}else if(s==="north")l=Math.max(0,a.left-(i.clientWidth-a.width)/2),r=a.top-i.clientHeight-.5,r<0&&(a.top<window.innerHeight-a.bottom?(r=a.bottom+.5,i.style.maxHeight=window.innerHeight-r+"px"):(r=0,i.style.maxHeight=a.top-.5+"px")),l+i.clientWidth>window.innerWidth&&(l=window.innerWidth-i.clientWidth);else{const d=parseInt(s)||.5;l=Math.max(0,a.left-(i.clientWidth-a.width)/2),r=a.bottom+d,r+i.clientHeight>window.innerHeight&&(a.top-d>window.innerHeight-r?(r=a.top-d-i.clientHeight,i.style.maxHeight=a.top-d+"px"):i.style.maxHeight=window.innerHeight-r+"px"),l+i.clientWidth>window.innerWidth&&(l=window.innerWidth-i.clientWidth)}i.style.top=r+"px",i.style.left=l+"px"},Zt=()=>{document.getElementById("tooltip").classList.add("fn__none")},pf=(t,e)=>/\r\n|\r|\n|\u2028|\u2029|\t|\//.test(t)?(e?Qa(window.siyuan.languages.fileNameRule,e,"error"):j(window.siyuan.languages.fileNameRule),!1):t.length>u.SIZE_TITLE?(e?Qa(window.siyuan.languages._kernel[106],e,"error"):j(window.siyuan.languages._kernel[106]),!1):!0,On=t=>t.replace(/\r\n|\r|\n|\u2028|\u2029|\t|\//g,"").substring(0,u.SIZE_TITLE),mw=t=>t.replace(/\\\\|\/|"|:|\*|\?|\\|'|<|>|\|/g,""),Th=t=>{if(window.siyuan.config.readonly)return;const e=new we({title:window.siyuan.languages.rename,content:`<div class="b3-dialog__content"><input class="b3-text-field fn__block" value=""></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:W()?"92vw":"520px",destroyCallback(){t.range&&Z(t.range)}});e.element.setAttribute("data-key",u.DIALOG_RENAME);const n=e.element.querySelector("input"),a=e.element.querySelectorAll(".b3-button");e.bindInput(n,()=>{a[1].click()}),n.value=Lute.UnEscapeHTMLStr(t.name),n.focus(),n.select(),a[0].addEventListener("click",()=>{e.destroy()}),a[1].addEventListener("click",()=>{if(!pf(n.value))return!1;if(n.value===t.name)return e.destroy(),!1;n.value.trim()===""?n.value=window.siyuan.languages.untitled:n.value=On(n.value),t.type==="notebook"?E("/api/notebook/renameNotebook",{notebook:t.notebookId,name:n.value},()=>{KS(t.notebookId,n.value)}):E("/api/filetree/renameDoc",{notebook:t.notebookId,path:t.path,title:n.value}),e.destroy()})},gf=t=>{const e=new we({title:window.siyuan.languages.rename,content:`<div class="b3-dialog__content"><input class="b3-text-field fn__block" value=""></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:W()?"92vw":"520px"});e.element.setAttribute("data-key",u.DIALOG_RENAMEASSETS);const n=e.element.querySelector("input"),a=e.element.querySelectorAll(".b3-button");e.bindInput(n,()=>{a[1].click()});const i=Jr(t);n.value=i,n.focus(),n.select(),a[0].addEventListener("click",()=>{e.destroy()}),a[1].addEventListener("click",()=>{if(n.value===i||!n.value)return e.destroy(),!1;E("/api/asset/renameAsset",{oldPath:t,newName:n.value},s=>{Ce().asset.forEach(o=>{o.path===t&&(o.path=s.data.newPath,o.parent.updateTitle(nt(s.data.newPath)))}),Mn().forEach(o=>{o.reload(!1)}),e.destroy()})})},rL=t=>{if(getSelection().rangeCount===0)return;const e=getSelection().getRangeAt(0),n=P(e.startContainer);if(!n)return;let a=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));a.length===0&&(a=[n]);let i="",s=e.toString();if(s===""){if(s=a[0].textContent,a.forEach(o=>{i+=ff(o)}),!s)return}else{const o=document.createElement("div");o.appendChild(e.cloneContents()),i=o.innerHTML}s.length>10&&(s=s.substr(0,10)+"..."),s=On(s),E("/api/filetree/createDoc",{notebook:t.notebookId,path:Ee().join(nt(t.path,!1,!0),Lute.NewNodeID()+".sy"),title:s,md:t.lute.BlockDOM2StdMd(i)})},hf=t=>{if(t.type==="pdf")window.siyuan.config.appearance.mode===1?xe(window.siyuan.languages.pdfTip,window.siyuan.languages.pdfConfirm,()=>{yw(t.id)}):yw(t.id);else if(t.type==="word"){const e=window.siyuan.storage[u.LOCAL_EXPORTWORD],n=new we({title:"Word "+window.siyuan.languages.config,content:`<div class="b3-dialog__content">
    <label class="fn__flex b3-label">
        <div class="fn__flex-1">
            ${window.siyuan.languages.removeAssetsFolder}
        </div>
        <span class="fn__space"></span>
        <input id="removeAssets" class="b3-switch" type="checkbox" ${e.removeAssets?"checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <div class="fn__flex-1">
            ${window.siyuan.languages.mergeSubdocs}
        </div>
        <span class="fn__space"></span>
        <input id="mergeSubdocs" class="b3-switch" type="checkbox" ${e.mergeSubdocs?"checked":""}>
    </label>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:"520px"});n.element.setAttribute("data-key",u.DIALOG_EXPORTWORD);const a=n.element.querySelectorAll(".b3-button");a[0].addEventListener("click",()=>{n.destroy()}),a[1].addEventListener("click",()=>{const i=n.element.querySelector("#removeAssets").checked,s=n.element.querySelector("#mergeSubdocs").checked;window.siyuan.storage[u.LOCAL_EXPORTWORD]={removeAssets:i,mergeSubdocs:s},ue(u.LOCAL_EXPORTWORD,window.siyuan.storage[u.LOCAL_EXPORTWORD]),ww(t,i,s),n.destroy()})}else ww(t,!1,!0)},bw=()=>{let t="";return document.querySelectorAll("style").forEach(e=>{e.id.startsWith("snippet")&&(t+=e.innerHTML)}),t},yw=async t=>{const e=window.siyuan.storage[u.LOCAL_EXPORTPDF],n=window.location.protocol+"//"+window.location.host,a=window.siyuan.config.appearance.mode===1&&window.siyuan.config.appearance.themeDark==="midnight"||window.siyuan.config.appearance.mode===0&&window.siyuan.config.appearance.themeLight==="daylight";let i="";a||(i=`<link rel="stylesheet" type="text/css" id="themeStyle" href="${n}/appearance/themes/${window.siyuan.config.appearance.themeLight}/theme.css?${u.SIYUAN_VERSION}"/>`);const s=await ee.ipcRenderer.invoke(u.SIYUAN_GET,{cmd:"getContentsId"}),o=`<!DOCTYPE html>
<html lang="${window.siyuan.config.appearance.lang}" data-theme-mode="light" data-light-theme="${window.siyuan.config.appearance.themeLight}" data-dark-theme="${window.siyuan.config.appearance.themeDark}">
<head>
    <base href="${n}/">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"/>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes"/>
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="stylesheet" type="text/css" id="baseStyle" href="${n}/stage/build/export/base.css?v=${u.SIYUAN_VERSION}"/>
    <link rel="stylesheet" type="text/css" id="themeDefaultStyle" href="${n}/appearance/themes/daylight/theme.css?v=${u.SIYUAN_VERSION}"/>
    <script src="${n}/stage/protyle/js/protyle-html.js?v=${u.SIYUAN_VERSION}"><\/script>
    ${i}
    <title>${window.siyuan.languages.export} PDF</title>
    <style>
        body {
          margin: 0;
          font-family: var(--b3-font-family);
        }
        
        #action {
          width: 232px;
          background: var(--b3-theme-surface);
          padding: 16px 0;
          position: fixed;
          right: 0;
          top: 0;
          overflow-y: auto;
          bottom: 0;
          overflow-x: hidden;
          z-index: 1;
          display: flex;
          flex-direction: column;
        }
        
        #preview {
          max-width: 800px;
          margin: 0 auto;
          position: absolute;
          right: 232px;
          left: 0;
          box-sizing: border-box;
        }
        
        #preview.exporting {
          position: inherit;
          max-width: none;
        }
        
        .b3-switch {
            margin-left: 14px;
        }
        
        .exporting::-webkit-scrollbar {
          width: 0;
          height: 0;
        }
        
        .protyle-wysiwyg {
          height: 100%;
          overflow: auto;
          box-sizing: border-box;
        }
        
        .b3-label {
          border-bottom: 1px solid var(--b3-theme-surface-lighter);
          display: block;
          color: var(--b3-theme-on-surface);
          padding-bottom: 16px;
          margin: 0 16px 16px 16px;
        }
        
        .b3-label:last-child {
            border-bottom: none;
        }
        ${await Rl(!1)}
        ${document.getElementById("pluginsStyle").innerHTML}
        ${bw()}
    </style>
</head>
<body style="-webkit-print-color-adjust: exact;">
<div id="action">
    <div style="flex: 1;overflow: auto;">
        <div class="b3-label">
            <div>
                ${window.siyuan.languages.exportPDF0}
            </div>
            <span class="fn__hr"></span>
            <select class="b3-select" id="pageSize">
                <option ${e.pageSize==="A3"?"selected":""} value="A3">A3</option>
                <option ${e.pageSize==="A4"?"selected":""} value="A4">A4</option>
                <option ${e.pageSize==="A5"?"selected":""} value="A5">A5</option>
                <option ${e.pageSize==="Legal"?"selected":""} value="Legal">Legal</option>
                <option ${e.pageSize==="Letter"?"selected":""} value="Letter">Letter</option>
                <option ${e.pageSize==="Tabloid"?"selected":""} value="Tabloid">Tabloid</option>
            </select>
        </div>
        <div class="b3-label">
            <div>
                ${window.siyuan.languages.exportPDF2}
            </div>
            <span class="fn__hr"></span>
            <select class="b3-select" id="marginsType">
                <option ${e.marginType==="default"?"selected":""} value="default">${window.siyuan.languages.defaultMargin}</option>
                <option ${e.marginType==="none"?"selected":""} value="none">${window.siyuan.languages.noneMargin}</option>
                <option ${e.marginType==="printableArea"?"selected":""} value="printableArea">${window.siyuan.languages.minimalMargin}</option>
                <option ${e.marginType==="custom"?"selected":""} value="custom">${window.siyuan.languages.customMargin}</option>
            </select>
            <div class="${e.marginType==="custom"?"":"fn__none"}">
                <span class="fn__hr"></span>
                <div>${window.siyuan.languages.marginTop}</div>
                <input id="marginsTop" class="b3-text-field fn__block" value="${e.marginTop||0}" type="number" min="0" step="0.01">
                <span class="fn__hr"></span>
                <div>${window.siyuan.languages.marginRight}</div>
                <input id="marginsRight" class="b3-text-field fn__block" value="${e.marginRight||0}" type="number" min="0" step="0.01">
                <span class="fn__hr"></span>
                <div>${window.siyuan.languages.marginBottom}</div>
                <input id="marginsBottom" class="b3-text-field fn__block" value="${e.marginBottom||0}" type="number" min="0" step="0.01">
                <span class="fn__hr"></span>
                <div>${window.siyuan.languages.marginLeft}</div>
                <input id="marginsLeft" class="b3-text-field fn__block" value="${e.marginLeft||0}" type="number" min="0" step="0.01">
            </div>
        </div>
        <div class="b3-label">
            <div>
                ${window.siyuan.languages.exportPDF3}
                <span id="scaleTip" style="float: right;color: var(--b3-theme-on-background);">${e.scale||1}</span>
            </div>
            <span class="fn__hr"></span>
            <input style="width: 192px" value="${e.scale||1}" id="scale" step="0.1" class="b3-slider" type="range" min="0.1" max="2">
        </div>
        <label class="b3-label">
            <div>
                ${window.siyuan.languages.exportPDF1}
            </div>
            <span class="fn__hr"></span>
          <input id="landscape" class="b3-switch" type="checkbox" ${e.landscape?"checked":""}>
        </label>
        <label class="b3-label">
            <div>
                ${window.siyuan.languages.exportPDF4}
            </div>
            <span class="fn__hr"></span>
            <input id="removeAssets" class="b3-switch" type="checkbox" ${e.removeAssets?"checked":""}>
        </label>
        <label class="b3-label">
            <div>
                ${window.siyuan.languages.exportPDF5}
            </div>
            <span class="fn__hr"></span>
            <input id="keepFold" class="b3-switch" type="checkbox" ${e.keepFold?"checked":""}>
        </label>
        <label class="b3-label">
            <div>
                ${window.siyuan.languages.mergeSubdocs}
            </div>
            <span class="fn__hr"></span>
            <input id="mergeSubdocs" class="b3-switch" type="checkbox" ${e.mergeSubdocs?"checked":""}>
        </label>
        <label class="b3-label">
            <div>
                ${window.siyuan.languages.export27}
            </div>
            <span class="fn__hr"></span>
            <input id="watermark" class="b3-switch" type="checkbox" ${e.watermark?"checked":""}>
            <div style="display:none;font-size: 12px;margin-top: 12px;color: var(--b3-theme-on-surface);">${window.siyuan.languages._kernel[214]}</div>
        </label>
    </div>
    <div class="fn__flex" style="padding: 0 16px">
      <div class="fn__flex-1"></div>
      <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button>
      <div class="fn__space"></div>
      <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
    </div>
</div>
<div style="zoom:${e.scale||1}" id="preview">
    <div class="fn__loading" style="left:0;height:100vh"><img width="48px" src="${n}/stage/loading-pure.svg"></div>
</div>
<script src="${n}/appearance/icons/${window.siyuan.config.appearance.icon}/icon.js?${u.SIYUAN_VERSION}"><\/script>
<script src="${n}/stage/build/export/protyle-method.js?${u.SIYUAN_VERSION}"><\/script>
<script src="${n}/stage/protyle/js/lute/lute.min.js?${u.SIYUAN_VERSION}"><\/script>    
<script>
    const previewElement = document.getElementById('preview');
    const fixBlockWidth = () => {
        const isLandscape = document.querySelector("#landscape").checked;
        let width = 800
        switch (document.querySelector("#action #pageSize").value) {
            case "A3":
              width = isLandscape ? 1587.84 : 1122.24 
              break;
            case "A4":
              width = isLandscape ? 1122.24 : 793.92
              break;
            case "A5":
              width = isLandscape ? 793.92 : 559.68
              break;
            case "Legal":
              width = isLandscape ? 1344: 816 
              break;
            case "Letter":
              width = isLandscape ? 1056 : 816
              break;
            case "Tabloid":
              width = isLandscape ? 1632 : 1056
              break;
        }
        width = width / parseFloat(document.querySelector("#scale").value);
        previewElement.style.width = width + "px";
        width = width - parseFloat(previewElement.style.paddingLeft) * 96 * 2;
        // \u4E3A\u4FDD\u6301\u4EE3\u7801\u5757\u5BBD\u5EA6\u4E00\u81F4\uFF0C\u5168\u90E8\u90FD\u8FDB\u884C\u5BBD\u5EA6\u8BBE\u5B9A https://github.com/siyuan-note/siyuan/issues/7692 
        previewElement.querySelectorAll('.hljs').forEach((item) => {
            // \u5F3A\u5236\u6362\u884C https://ld246.com/article/1679228783553
            item.parentElement.setAttribute("linewrap", "true");
            item.parentElement.style.width = "";
            item.parentElement.style.boxSizing = "border-box";
            item.parentElement.style.width = Math.min(item.parentElement.clientWidth, width) + "px";
            item.removeAttribute('data-render');
        })
        Protyle.highlightRender(previewElement, "${n}/stage/protyle");
        previewElement.querySelectorAll('[data-type="NodeMathBlock"]').forEach((item) => {
            item.style.width = "";
            item.style.boxSizing = "border-box";
            item.style.width = Math.min(item.clientWidth, width) + "px";
            item.removeAttribute('data-render');
        })
        previewElement.querySelectorAll('[data-type="NodeCodeBlock"][data-subtype="mermaid"] svg').forEach((item) => {
            item.style.maxHeight = width * 1.414 + "px";
        })
        Protyle.mathRender(previewElement, "${n}/stage/protyle", true);
        previewElement.querySelectorAll("table").forEach(item => {
            if (item.clientWidth > item.parentElement.clientWidth) {
                item.style.zoom = (item.parentElement.clientWidth / item.clientWidth).toFixed(2) - 0.01;
                item.parentElement.style.overflow = "hidden";
            }
        })
    }
    const setPadding = () => {
        const isLandscape = document.querySelector("#landscape").checked;
        const topElement = document.querySelector("#marginsTop")
        const rightElement = document.querySelector("#marginsRight")
        const bottomElement = document.querySelector("#marginsBottom")
        const leftElement = document.querySelector("#marginsLeft")
        switch (document.querySelector("#marginsType").value) {
            case "default":
                if (isLandscape) {
                    topElement.value = "0.42";
                    rightElement.value = "0.42";
                    bottomElement.value = "0.42";
                    leftElement.value = "0.42";
                } else {
                    topElement.value = "1";
                    rightElement.value = "0.54";
                    bottomElement.value = "1";
                    leftElement.value = "0.54";
                }
                break;
            case "none": // none
                topElement.value = "0";
                rightElement.value = "0";
                bottomElement.value = "0";
                leftElement.value = "0";
                break;
            case "printableArea": // minimal
                if (isLandscape) {
                    topElement.value = ".07";
                    rightElement.value = ".07";
                    bottomElement.value = ".07";
                    leftElement.value = ".07";
                } else {
                    topElement.value = "0.58";
                    rightElement.value = "0.1";
                    bottomElement.value = "0.58";
                    leftElement.value = "0.1";
                }
                break;
        }
        document.getElementById('preview').style.padding = topElement.value + "in " 
                             + rightElement.value + "in "
                             + bottomElement.value + "in "
                             + leftElement.value + "in";
        setTimeout(() => {
            fixBlockWidth();
        }, 300);
    }
    const fetchPost = (url, data, cb) => {
        fetch("${n}" + url, {
            method: "POST",
            body: JSON.stringify(data)
        }).then((response) => {
            return response.json();
        }).then((response) => {
            cb(response);
        })
    }
    const renderPreview = (data) => {
        previewElement.innerHTML = '<div style="padding:6px 0 0 0" class="protyle-wysiwyg${window.siyuan.config.editor.displayBookmarkIcon?" protyle-wysiwyg--attr":""}">' + data.content + '</div>';
        const wysElement = previewElement.querySelector(".protyle-wysiwyg");
        wysElement.setAttribute("data-doc-type", data.type || "NodeDocument");
        if (data.attrs.memo) {
            wysElement.setAttribute("memo", data.attrs.memo);
        }
        if (data.attrs.name) {
            wysElement.setAttribute("name", data.attrs.name);
        }
        if (data.attrs.bookmark) {
            wysElement.setAttribute("bookmark", data.attrs.bookmark);
        }
        if (data.attrs.alias) {
            wysElement.setAttribute("alias", data.attrs.alias);
        }
        // https://github.com/siyuan-note/siyuan/issues/13669
        wysElement.querySelectorAll('[data-node-id]').forEach((item) => {
            if (item.querySelector(".img")) {
                item.insertAdjacentHTML("beforeend", "<hr style='margin:0;border:0'>");
            }
        })
        Protyle.mermaidRender(wysElement, "${n}/stage/protyle");
        Protyle.flowchartRender(wysElement, "${n}/stage/protyle");
        Protyle.graphvizRender(wysElement, "${n}/stage/protyle");
        Protyle.chartRender(wysElement, "${n}/stage/protyle");
        Protyle.mindmapRender(wysElement, "${n}/stage/protyle");
        Protyle.abcRender(wysElement, "${n}/stage/protyle");
        Protyle.htmlRender(wysElement);
        Protyle.plantumlRender(wysElement, "${n}/stage/protyle");
    }
    fetchPost("/api/export/exportPreviewHTML", {
        id: "${t}",
        keepFold: ${e.keepFold},
        merge: ${e.mergeSubdocs},
    }, response => {
        if (response.code === 1) {
            alert(response.msg)
            return;
        }
        document.title = response.data.name
        window.siyuan = {
          config: {
            appearance: { mode: 0, codeBlockThemeDark: "${window.siyuan.config.appearance.codeBlockThemeDark}", codeBlockThemeLight: "${window.siyuan.config.appearance.codeBlockThemeLight}" },
            editor: { 
              allowHTMLBLockScript: ${window.siyuan.config.editor.allowHTMLBLockScript},
              fontSize: ${window.siyuan.config.editor.fontSize},
              codeLineWrap: true,
              codeLigatures: ${window.siyuan.config.editor.codeLigatures},
              plantUMLServePath: "${window.siyuan.config.editor.plantUMLServePath}",
              codeSyntaxHighlightLineNum: ${window.siyuan.config.editor.codeSyntaxHighlightLineNum},
              katexMacros: JSON.stringify(${window.siyuan.config.editor.katexMacros}),
            }
          },
          languages: {copy:"${window.siyuan.languages.copy}"}
        };
        previewElement.addEventListener("click", (event) => {
            let target = event.target;
            while (target && !target.isEqualNode(previewElement)) {
                if (target.tagName === "A") {
                    const linkAddress = target.getAttribute("href");
                    if (linkAddress.startsWith("#")) {
                        // \u5BFC\u51FA\u9884\u89C8\u6A21\u5F0F\u70B9\u51FB\u5757\u5F15\u8F6C\u6362\u540E\u7684\u811A\u6CE8\u8DF3\u8F6C\u4E0D\u6B63\u786E https://github.com/siyuan-note/siyuan/issues/5700
                        const hash = linkAddress.substring(1);
                        previewElement.querySelector('[data-node-id="' + hash + '"], [id="' + hash + '"]').scrollIntoView();
                        event.stopPropagation();
                        event.preventDefault();
                        return;
                    }
                } else if (target.classList.contains("protyle-action__copy")) {
                    let text = target.parentElement.nextElementSibling.textContent.trimEnd();
                    text = text.replace(/\xA0/g, " "); // Replace non-breaking spaces with normal spaces when copying https://github.com/siyuan-note/siyuan/issues/9382
                    navigator.clipboard.writeText(text);
                    event.preventDefault();
                    event.stopPropagation();
                    break;
                }
                target = target.parentElement;
            }
        });
        const actionElement = document.getElementById('action');
        const keepFoldElement = actionElement.querySelector('#keepFold');
        keepFoldElement.addEventListener('change', () => {
            refreshPreview();
        });
        const mergeSubdocsElement = actionElement.querySelector('#mergeSubdocs');
        mergeSubdocsElement.addEventListener('change', () => {
            refreshPreview();
        });
        const  watermarkElement = actionElement.querySelector('#watermark');
        watermarkElement.addEventListener('change', () => {
            if (watermarkElement.checked && ${!es()}) {
                watermarkElement.nextElementSibling.style.display = "";
                watermarkElement.checked = false;
            }
        });
        const refreshPreview = () => {
            previewElement.innerHTML = '<div class="fn__loading" style="left:0;height: 100vh"><img width="48px" src="${n}/stage/loading-pure.svg"></div>'
            fetchPost("/api/export/exportPreviewHTML", {
                id: "${t}",
                keepFold: keepFoldElement.checked,
                merge: mergeSubdocsElement.checked,
            }, response2 => {
                if (response2.code === 1) {
                    alert(response2.msg)
                    return;
                }
                setPadding();
                renderPreview(response2.data);
            })
        };
        
        actionElement.querySelector("#scale").addEventListener("input", () => {
            const scale = actionElement.querySelector("#scale").value;
            actionElement.querySelector("#scaleTip").innerText = scale;
            previewElement.style.zoom = scale;
            fixBlockWidth();
        })
        actionElement.querySelector("#pageSize").addEventListener('change', () => {
            fixBlockWidth();
        });
        actionElement.querySelector("#marginsType").addEventListener('change', (event) => {
            setPadding();
            if (event.target.value === "custom") {
                event.target.nextElementSibling.classList.remove("fn__none");
            } else {
                event.target.nextElementSibling.classList.add("fn__none");
            }
        });
        actionElement.querySelector("#marginsTop").addEventListener('change', () => {
            setPadding();
        });
        actionElement.querySelector("#marginsRight").addEventListener('change', () => {
            setPadding();
        });
        actionElement.querySelector("#marginsBottom").addEventListener('change', () => {
            setPadding();
        });
        actionElement.querySelector("#marginsLeft").addEventListener('change', () => {
            setPadding();
        });
        actionElement.querySelector("#landscape").addEventListener('change', () => {
            setPadding();
        });
        actionElement.querySelector('.b3-button--cancel').addEventListener('click', () => {
            const {ipcRenderer}  = require("electron");
            ipcRenderer.send("${u.SIYUAN_CMD}", "destroy")
        });
        actionElement.querySelector('.b3-button--text').addEventListener('click', () => {
            const {ipcRenderer}  = require("electron");
            ipcRenderer.send("${u.SIYUAN_EXPORT_PDF}", {
              title: "${window.siyuan.languages.export} PDF",
              pdfOptions:{
                printBackground: true,
                landscape: actionElement.querySelector("#landscape").checked,
                marginType: actionElement.querySelector("#marginsType").value,
                margins: {
                  top: parseFloat(document.querySelector("#marginsTop").value),
                  bottom: parseFloat(document.querySelector("#marginsBottom").value),
                  left: parseFloat(document.querySelector("#marginsLeft").value),
                  right: parseFloat(document.querySelector("#marginsRight").value),
                },
                scale:  parseFloat(actionElement.querySelector("#scale").value),
                pageSize: actionElement.querySelector("#pageSize").value,
              },
              keepFold: keepFoldElement.checked,
              mergeSubdocs: mergeSubdocsElement.checked,
              watermark: watermarkElement.checked,
              removeAssets: actionElement.querySelector("#removeAssets").checked,
              rootId: "${t}",
              rootTitle: response.data.name,
              parentWindowId: ${s},
            })
            previewElement.classList.add("exporting");
            previewElement.style.zoom = "";
            previewElement.style.paddingTop = "6px";
            previewElement.style.paddingBottom = "0";
            fixBlockWidth();
            actionElement.remove();
        });
        setPadding();
        renderPreview(response.data);
        window.addEventListener("keydown", (event) => {
            if (event.key === "Escape") {
                const {ipcRenderer}  = require("electron");
                ipcRenderer.send("${u.SIYUAN_CMD}", "destroy")
                event.preventDefault();
            }
        })
    });
<\/script></body></html>`;E("/api/export/exportTempContent",{content:o},l=>{ee.ipcRenderer.send(u.SIYUAN_EXPORT_NEWWINDOW,l.data.url)})},ww=(t,e,n)=>{E("/api/block/getBlockInfo",{id:t.id},async a=>{if(a.code===3){j(a.msg);return}let i="HTML (SiYuan)";switch(t.type){case"htmlmd":i="HTML (Markdown)";break;case"word":i="Word .docx";break;case"pdf":i="PDF";break}const s=await ee.ipcRenderer.invoke(u.SIYUAN_GET,{cmd:"showOpenDialog",title:window.siyuan.languages.export+" "+i,properties:["createDirectory","openDirectory"]});if(!s.canceled){const o=j(window.siyuan.languages.exporting,-1);let l="/api/export/exportHTML";t.type==="htmlmd"?l="/api/export/exportMdHTML":t.type==="word"&&(l="/api/export/exportDocx");let r=s.filePaths[0];t.type!=="word"&&!r.endsWith(a.data.rootTitle)&&(r=Ft.join(r,mw(a.data.rootTitle))),r=r.trim(),E(l,{id:t.id,pdf:t.type==="pdf",removeAssets:e,merge:n,savePath:r},d=>{if(t.type==="word"){if(d.code===1){j(d.msg,void 0,"error"),Ue(o);return}uf(d.data.path,o)}else cL(d,r,t,e,o)})}})},cL=async(t,e,n,a,i)=>{let s=window.siyuan.config.appearance.themeLight,o=0;["html","htmlmd"].includes(n.type)&&window.siyuan.config.appearance.mode===1&&(s=window.siyuan.config.appearance.themeDark,o=1);const l=window.siyuan.config.appearance.mode===1&&window.siyuan.config.appearance.themeDark==="midnight"||window.siyuan.config.appearance.mode===0&&window.siyuan.config.appearance.themeLight==="daylight";let r="";l||(r=`<link rel="stylesheet" type="text/css" id="themeStyle" href="appearance/themes/${s}/theme.css?${u.SIYUAN_VERSION}"/>`);const d=`<!DOCTYPE html>
<html lang="${window.siyuan.config.appearance.lang}" data-theme-mode="${Sv()}" data-light-theme="${window.siyuan.config.appearance.themeLight}" data-dark-theme="${window.siyuan.config.appearance.themeDark}">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"/>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes"/>
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="stylesheet" type="text/css" id="baseStyle" href="stage/build/export/base.css?v=${u.SIYUAN_VERSION}"/>
    <link rel="stylesheet" type="text/css" id="themeDefaultStyle" href="appearance/themes/${s}/theme.css?v=${u.SIYUAN_VERSION}"/>
    <script src="stage/protyle/js/protyle-html.js?v=${u.SIYUAN_VERSION}"><\/script>
    ${r}
    <title>${t.data.name}</title>
    <!-- Exported by SiYuan v${u.SIYUAN_VERSION} -->
    <style>
        body {font-family: var(--b3-font-family);background-color: var(--b3-theme-background);color: var(--b3-theme-on-background)}
        ${await Rl(!1)}
        ${document.getElementById("pluginsStyle").innerHTML}
        ${bw()}
    </style>
</head>
<body>
<div class="${["htmlmd","word"].includes(n.type)?"b3-typography":"protyle-wysiwyg"+(window.siyuan.config.editor.displayBookmarkIcon?" protyle-wysiwyg--attr":"")}" 
style="max-width: 800px;margin: 0 auto;" 
id="preview">${t.data.content}</div>
<script src="appearance/icons/${window.siyuan.config.appearance.icon}/icon.js?v=${u.SIYUAN_VERSION}"><\/script>
<script src="stage/build/export/protyle-method.js?v=${u.SIYUAN_VERSION}"><\/script>
<script src="stage/protyle/js/lute/lute.min.js?v=${u.SIYUAN_VERSION}"><\/script>  
<script>
    window.siyuan = {
      config: {
        appearance: { mode: ${o}, codeBlockThemeDark: "${window.siyuan.config.appearance.codeBlockThemeDark}", codeBlockThemeLight: "${window.siyuan.config.appearance.codeBlockThemeLight}" },
        editor: { 
          codeLineWrap: true,
          fontSize: ${window.siyuan.config.editor.fontSize},
          codeLigatures: ${window.siyuan.config.editor.codeLigatures},
          plantUMLServePath: "${window.siyuan.config.editor.plantUMLServePath}",
          codeSyntaxHighlightLineNum: ${window.siyuan.config.editor.codeSyntaxHighlightLineNum},
          katexMacros: JSON.stringify(${window.siyuan.config.editor.katexMacros}),
        }
      },
      languages: {copy:"${window.siyuan.languages.copy}"}
    };
    const previewElement = document.getElementById('preview');
    Protyle.highlightRender(previewElement, "stage/protyle");
    Protyle.mathRender(previewElement, "stage/protyle", ${n.type==="pdf"});
    Protyle.mermaidRender(previewElement, "stage/protyle");
    Protyle.flowchartRender(previewElement, "stage/protyle");
    Protyle.graphvizRender(previewElement, "stage/protyle");
    Protyle.chartRender(previewElement, "stage/protyle");
    Protyle.mindmapRender(previewElement, "stage/protyle");
    Protyle.abcRender(previewElement, "stage/protyle");
    Protyle.htmlRender(previewElement);
    Protyle.plantumlRender(previewElement, "stage/protyle");
    document.querySelectorAll(".protyle-action__copy").forEach((item) => {
      item.addEventListener("click", (event) => {
            let text = item.parentElement.nextElementSibling.textContent.trimEnd();
            text = text.replace(/\xA0/g, " "); // Replace non-breaking spaces with normal spaces when copying
            navigator.clipboard.writeText(text);
            event.preventDefault();
            event.stopPropagation();
      })
    });
<\/script></body></html>`,c=Ft.join(e,"index.html");Qi.writeFileSync(c,d),uf(c,i)},Ih=(t,e,n)=>{if(t.getAttribute("custom-pinthead")==="true"){const a=t.querySelector("table");a.clientHeight+a.scrollTop<e.offsetTop+e.clientHeight?a.scrollTop=e.offsetTop-a.clientHeight+e.clientHeight+1:a.scrollTop>e.offsetTop-e.clientHeight&&(a.scrollTop=e.offsetTop-e.clientHeight+1)}else Ne(n,e)},ca=t=>{let e=t.previousElementSibling,n=0;for(;e;)n++,e=e.previousElementSibling;return n},_w=(t,e,n=!0)=>{let a=t.previousElementSibling;return a||(t.parentElement.previousElementSibling?a=t.parentElement.previousElementSibling.lastElementChild:t.parentElement.parentElement.tagName==="TBODY"&&t.parentElement.parentElement.previousElementSibling?a=t.parentElement.parentElement.previousElementSibling.lastElementChild.lastElementChild:a=null),a&&(e.selectNodeContents(a),n||e.collapse(!1),Z(e)),a},Pa=(t,e,n,a,i)=>{i.insertNode(document.createElement("wbr"));const s=n.outerHTML,o=n.querySelector("table"),l=o.rows[0].cells.length,r=o.rows.length,d=[];for(let c=0;c<r;c++){for(let f=0;f<l;f++)o.rows[c].cells[f].isSameNode(e[d.length])&&d.push(f);if(d.length>0)break}for(let c=0;c<r;c++)d.forEach(f=>{o.rows[c].cells[f].setAttribute("align",a)});J(t,n.getAttribute("data-node-id"),n.outerHTML,s),he(o,i)},Dh=(t,e,n,a)=>{const i=document.createElement("wbr");e.insertNode(i);const s=a.outerHTML;i.remove();let o="";for(let r=0;r<n.parentElement.childElementCount;r++)o+=`<td align="${n.parentElement.children[r].getAttribute("align")||""}"></td>`;let l;if(n.tagName==="TH"){const r=a.querySelector("tbody");r?(r.insertAdjacentHTML("afterbegin",`<tr>${o}</tr>`),l=r.firstElementChild):(n.parentElement.parentElement.insertAdjacentHTML("afterend",`<tbody><tr>${o}</tr></tbody>`),l=n.parentElement.parentElement.nextElementSibling.firstElementChild)}else n.parentElement.insertAdjacentHTML("afterend",`<tr>${o}</tr>`),l=n.parentElement.nextElementSibling;e.selectNodeContents(l.cells[ca(n)]),e.collapse(!0),Z(e),J(t,a.getAttribute("data-node-id"),a.outerHTML,s),Ih(a,l,t)},vw=(t,e,n,a)=>{const i=document.createElement("wbr");e.insertNode(i);const s=a.outerHTML;i.remove();let o="",l=!1;for(let d=0;d<n.parentElement.childElementCount;d++){const c=n.parentElement.children[d];c.className==="fn__none"&&(l=!0),n.tagName==="TH"?o+=`<th class="${c.className}" colspan="${c.colSpan}" align="${c.getAttribute("align")}"></th>`:o+=`<td class="${c.className}" colspan="${c.colSpan}" align="${c.getAttribute("align")}"></td>`}if(l){let d=n.parentElement.previousElementSibling,c=1;for(;d;)c++,Array.from(d.children).forEach(f=>{f.rowSpan>=c&&f.rowSpan>1&&(f.rowSpan=f.rowSpan+1)}),d=d.previousElementSibling}let r;n.parentElement.parentElement.tagName==="THEAD"&&!n.parentElement.previousElementSibling?(n.parentElement.parentElement.insertAdjacentHTML("beforebegin",`<thead><tr>${o}</tr></thead>`),r=a.querySelector("thead tr"),n.parentElement.parentElement.nextElementSibling.insertAdjacentHTML("afterbegin",n.parentElement.parentElement.innerHTML),n.parentElement.parentElement.remove()):(n.parentElement.insertAdjacentHTML("beforebegin",`<tr>${o}</tr>`),r=n.parentElement.previousElementSibling),e.selectNodeContents(r.cells[ca(n)]),e.collapse(!0),Z(e),J(t,a.getAttribute("data-node-id"),a.outerHTML,s),Ih(a,r,t)},mf=(t,e,n,a,i)=>{const s=document.createElement("wbr");i.insertNode(s);const o=e.outerHTML;s.remove();const l=ca(n),r=e.querySelector("table");for(let d=0;d<r.rows.length;d++){const c=r.rows[d].cells[l],f=document.createElement(c.tagName);c.insertAdjacentElement(a,f),c.isSameNode(n)?(f.innerHTML="<wbr> ",f.offsetLeft+f.clientWidth>e.firstElementChild.scrollLeft+e.firstElementChild.clientWidth&&(e.firstElementChild.scrollLeft=f.offsetLeft+f.clientWidth-e.firstElementChild.clientWidth)):f.textContent=" "}r.querySelectorAll("col")[l].insertAdjacentHTML(a,"<col>"),he(e,i),J(t,e.getAttribute("data-node-id"),e.outerHTML,o)},Ew=(t,e,n,a)=>{if(n.parentElement.parentElement.tagName!=="THEAD"){const i=document.createElement("wbr");e.insertNode(i);const s=a.outerHTML;i.remove();const o=ca(n),l=n.parentElement.parentElement;let r=l.previousElementSibling.lastElementChild;n.parentElement.previousElementSibling&&(r=n.parentElement.previousElementSibling),l.childElementCount===1?l.remove():n.parentElement.remove(),e.selectNodeContents(r.cells[o]),e.collapse(!0),Z(e),Ih(a,r,t),J(t,a.getAttribute("data-node-id"),a.outerHTML,s)}},kw=(t,e,n,a)=>{const i=document.createElement("wbr");e.insertNode(i);const s=n.outerHTML;i.remove();const o=ca(a),l=a.previousElementSibling||a.nextElementSibling;if(l)e.selectNodeContents(l),e.collapse(!0),l.offsetLeft+l.clientWidth>n.firstElementChild.scrollLeft+n.firstElementChild.clientWidth&&(n.firstElementChild.scrollLeft=l.offsetLeft+l.clientWidth-n.firstElementChild.clientWidth);else{n.classList.add("protyle-wysiwyg--select"),fa(t,n,e,"remove");return}const r=n.querySelector("table");for(let d=0;d<r.rows.length;d++){const c=r.rows[d].cells;if(c.length===1){r.remove();break}c[o].remove()}n.querySelectorAll("col")[o]?.remove(),J(t,n.getAttribute("data-node-id"),n.outerHTML,s),Z(e)},Sw=(t,e,n,a)=>{const i=n.parentElement;if(i.parentElement.tagName==="THEAD")return;e.insertNode(document.createElement("wbr"));const s=a.outerHTML;if(i.previousElementSibling)i.after(i.previousElementSibling);else{const o=i.parentElement.previousElementSibling.firstElementChild;o.querySelectorAll("th").forEach(l=>{const r=document.createElement("td");r.innerHTML=l.innerHTML,l.parentNode.replaceChild(r,l)}),i.querySelectorAll("td").forEach(l=>{const r=document.createElement("th");r.innerHTML=l.innerHTML,l.parentNode.replaceChild(r,l)}),i.after(o),i.parentElement.previousElementSibling.append(i)}J(t,a.getAttribute("data-node-id"),a.outerHTML,s),he(a,e),Ne(t,i)},Lw=(t,e,n,a)=>{const i=n.parentElement;if(i.parentElement.tagName==="TBODY"&&!i.nextElementSibling||i.parentElement.tagName==="THEAD"&&!i.parentElement.nextElementSibling)return;e.insertNode(document.createElement("wbr"));const s=a.outerHTML;if(i.nextElementSibling)i.before(i.nextElementSibling);else{const o=i.parentElement.nextElementSibling.firstElementChild;o.querySelectorAll("td").forEach(l=>{const r=document.createElement("th");r.innerHTML=l.innerHTML,l.parentNode.replaceChild(r,l)}),i.querySelectorAll("th").forEach(l=>{const r=document.createElement("td");r.innerHTML=l.innerHTML,l.parentNode.replaceChild(r,l)}),i.after(o),i.parentElement.nextElementSibling.insertAdjacentElement("afterbegin",i)}J(t,a.getAttribute("data-node-id"),a.outerHTML,s),he(a,e),Ne(t,i)},xw=(t,e,n,a)=>{if(!n.previousElementSibling)return;e.insertNode(document.createElement("wbr"));const i=a.outerHTML;let s=0;Array.from(n.parentElement.children).find((l,r)=>{if(n.isSameNode(l))return s=r,!0}),a.querySelectorAll("tr").forEach(l=>{l.cells[s].after(l.cells[s-1])}),n.offsetLeft<a.firstElementChild.scrollLeft&&(a.firstElementChild.scrollLeft=n.offsetLeft);const o=a.querySelectorAll("col");o[s].after(o[s-1]),J(t,a.getAttribute("data-node-id"),a.outerHTML,i),he(a,e)},Aw=(t,e,n,a)=>{if(!n.nextElementSibling)return;e.insertNode(document.createElement("wbr"));const i=a.outerHTML;let s=0;Array.from(n.parentElement.children).find((l,r)=>{if(n.isSameNode(l))return s=r,!0}),a.querySelectorAll("tr").forEach(l=>{l.cells[s].before(l.cells[s+1])}),n.offsetLeft+n.clientWidth>a.firstElementChild.scrollLeft+a.firstElementChild.clientWidth&&(a.firstElementChild.scrollLeft=n.offsetLeft+n.clientWidth-a.firstElementChild.clientWidth);const o=a.querySelectorAll("col");o[s].before(o[s+1]),J(t,a.getAttribute("data-node-id"),a.outerHTML,i),he(a,e)},dL=(t,e,n)=>{const a=q(n.startContainer,"TD")||q(n.startContainer,"TH"),i=P(n.startContainer);if(!a||!i)return!1;if(e.key==="Enter"&&e.shiftKey&&qe(e)&&!e.altKey){const S=document.createElement("wbr");n.insertNode(S);const k=i.outerHTML;if(S.remove(),a&&!a.innerHTML.endsWith("<br>")&&a.insertAdjacentHTML("beforeend","<br>"),n.extractContents(),t.toolbar.getCurrentType(n).includes("code")&&n.startContainer.nodeType!==3){const $=document.createElement("br");n.startContainer.after($),n.setStartAfter($)}else n.insertNode(document.createElement("br"));return n.collapse(!1),Ne(t),J(t,i.getAttribute("data-node-id"),i.outerHTML,k),e.preventDefault(),!0}if(!i.classList.contains("protyle-wysiwyg--select")&&!L(i,"protyle-wysiwyg--select")){if(qe(e)&&!e.shiftKey&&!e.altKey&&e.key==="Enter"){e.preventDefault();const S=a.parentElement;if(!S.nextElementSibling&&S.parentElement.tagName==="TBODY"||S.parentElement.tagName==="THEAD"&&!S.parentElement.nextElementSibling)return _n(t,"afterend",i.getAttribute("data-node-id")),!0;let k=S.nextElementSibling;return k||(k=S.parentElement.nextElementSibling.firstChild),k&&(n.selectNodeContents(k.cells[ca(a)]),n.collapse(!0),Ne(t)),!0}if(e.key==="ArrowRight"&&n.toString()===""&&!i.nextElementSibling&&a.isSameNode(i.querySelector("table").lastElementChild.lastElementChild.lastElementChild)&&ct(a,t.wysiwyg.element,n).start===a.textContent.length)return e.preventDefault(),_n(t,"afterend",i.getAttribute("data-node-id")),!0;if(e.key==="Tab"&&qe(e)){if(e.shiftKey)return _w(a,n),e.preventDefault(),!0;let S=a.nextElementSibling;return S||(a.parentElement.nextElementSibling?S=a.parentElement.nextElementSibling.firstElementChild:a.parentElement.parentElement.tagName==="THEAD"&&a.parentElement.parentElement.nextElementSibling?S=a.parentElement.parentElement.nextElementSibling.firstElementChild.firstElementChild:S=null),S?n.selectNodeContents(S):(Dh(t,n,a,i),n.selectNodeContents(i.querySelector("tbody").lastElementChild.firstElementChild)),e.preventDefault(),!0}if(e.key==="ArrowUp"&&qe(e)&&!e.shiftKey&&!e.altKey){const S=n.startContainer;let k;for(S.nodeType!==3&&(S.tagName==="TH"||S.tagName==="TD")?k=S.childNodes[Math.min(n.startOffset,S.childNodes.length-1)]:S.parentElement.tagName==="SPAN"?k=S.parentElement.previousElementSibling:k=S.previousElementSibling;k;){if(k.tagName==="BR"&&At(k))return!1;k=k.previousElementSibling}const A=a.parentElement;let $=A.previousElementSibling;return $||($=A.parentElement.previousElementSibling.lastElementChild),!$||$?.tagName==="COL"?!1:(n.selectNodeContents($.cells[ca(a)]),n.collapse(!1),Ne(t),e.preventDefault(),!0)}if(e.key==="ArrowDown"&&qe(e)&&!e.shiftKey&&!e.altKey){const S=n.endContainer;let k;for(S.nodeType!==3&&(S.tagName==="TH"||S.tagName==="TD")?k=S.childNodes[Math.max(0,n.endOffset-1)]?.nextElementSibling:S.parentElement.tagName==="SPAN"?k=S.parentElement.nextElementSibling:k=S.nextElementSibling;k;){if(k.tagName==="BR"&&k.nextSibling)return!1;k=k.nextElementSibling}const A=a.parentElement;if(!A.nextElementSibling&&A.parentElement.tagName==="TBODY"||A.parentElement.tagName==="THEAD"&&!A.parentElement.nextElementSibling)return!1;let $=A.nextElementSibling;return $||($=A.parentElement.nextElementSibling.firstChild),$?(n.selectNodeContents($.cells[ca(a)]),n.collapse(!0),Ne(t),e.preventDefault(),!0):!1}if(qe(e)&&!e.shiftKey&&!e.altKey&&e.key==="Backspace"&&ct(a,t.wysiwyg.element,n).start===0&&n.toString()===""&&(n.startOffset===0||n.startOffset===1&&a.querySelectorAll("br").length===1))return!_w(a,n,!1)&&i.previousElementSibling&&ae(i.previousElementSibling,void 0,!1),Ne(t),e.preventDefault(),!0;if(H(window.siyuan.config.keymap.editor.general.alignLeft.custom,e))return Pa(t,[a],i,"left",n),e.preventDefault(),!0;if(H(window.siyuan.config.keymap.editor.general.alignCenter.custom,e))return Pa(t,[a],i,"center",n),e.preventDefault(),!0;if(H(window.siyuan.config.keymap.editor.general.alignRight.custom,e))return Pa(t,[a],i,"right",n),e.preventDefault(),!0}const s=i.querySelector("table"),o=a.parentElement.querySelector(".fn__none");let l=!1,r=!1;Array.from(a.parentElement.children).forEach(S=>{S.colSpan>1&&(l=!0),S.rowSpan>1&&(r=!0)});let d=!1,c=!1,f=!1,g=a.parentElement.previousElementSibling;!g&&a.parentElement.parentElement.tagName==="TBODY"&&(g=s.querySelector("thead").lastElementChild),g&&(d=g.querySelector(".fn__none"),Array.from(g.children).forEach(S=>{S.colSpan>1&&(c=!0),S.rowSpan>1&&(f=!0)}));let p=!1,h=!1,m=!1,b=a.parentElement.nextElementSibling;!b&&a.parentElement.parentElement.tagName==="THEAD"&&(b=s.querySelector("tbody")?.firstElementChild),b&&(p=b.querySelector(".fn__none"),Array.from(b.children).forEach(S=>{S.colSpan>1&&(h=!0),S.rowSpan>1&&(m=!0)}));const y=ca(a);let w=!0;Array.from(s.rows).find(S=>{const k=S.cells[y];if(k.classList.contains("fn__none")||k.colSpan>1||k.rowSpan>1)return w=!1,!0});let _=!0;Array.from(s.rows).find(S=>{const k=S.cells[y+1];if(k&&(k.classList.contains("fn__none")||k.colSpan>1||k.rowSpan>1))return _=!1,!0});let x=!0;if(Array.from(s.rows).find(S=>{const k=S.cells[y-1];if(k&&(k.classList.contains("fn__none")||k.colSpan>1||k.rowSpan>1))return x=!1,!0}),H(window.siyuan.config.keymap.editor.table.moveToUp.custom,e))return(!o||o&&!r&&l)&&(!d||d&&!f&&c)&&Sw(t,n,a,i),e.preventDefault(),!0;if(H(window.siyuan.config.keymap.editor.table.moveToDown.custom,e))return(!o||o&&!r&&l)&&(!p||p&&!m&&h)&&Lw(t,n,a,i),e.preventDefault(),!0;if(H(window.siyuan.config.keymap.editor.table.moveToLeft.custom,e))return w&&x&&xw(t,n,a,i),e.preventDefault(),!0;if(H(window.siyuan.config.keymap.editor.table.moveToRight.custom,e))return w&&_&&Aw(t,n,a,i),e.preventDefault(),!0;if(H(window.siyuan.config.keymap.editor.table.insertRowAbove.custom,e))return vw(t,n,a,i),e.preventDefault(),e.stopPropagation(),!0;if(H(window.siyuan.config.keymap.editor.table.insertRowBelow.custom,e))return(!p||p&&!m&&h)&&Dh(t,n,a,i),e.preventDefault(),!0;if(H(window.siyuan.config.keymap.editor.table.insertColumnLeft.custom,e))return(w||x)&&mf(t,i,a,"beforebegin",n),e.preventDefault(),!0;if(H(window.siyuan.config.keymap.editor.table.insertColumnRight.custom,e))return(w||_)&&mf(t,i,a,"afterend",n),e.preventDefault(),!0;if(H(window.siyuan.config.keymap.editor.table["delete-row"].custom,e))return(!o&&!r||o&&!r&&l)&&Ew(t,n,a,i),e.preventDefault(),e.stopPropagation(),!0;if(H(window.siyuan.config.keymap.editor.table["delete-column"].custom,e))return w&&kw(t,n,i,a),e.preventDefault(),!0},Cw=(t,e)=>{if(!e)return;const n=e.querySelector(".table__select"),a=[],i=e.firstElementChild.scrollLeft;if(e.querySelectorAll("th, td").forEach(o=>{!o.classList.contains("fn__none")&&o.offsetLeft+6>n.offsetLeft+i&&o.offsetLeft+o.clientWidth-6<n.offsetLeft+i+n.clientWidth&&o.offsetTop+6>n.offsetTop&&o.offsetTop+o.clientHeight-6<n.offsetTop+n.clientHeight&&a.push(o)}),n.removeAttribute("style"),getSelection().rangeCount>0){const o=getSelection().getRangeAt(0);e.contains(o.startContainer)&&o.insertNode(document.createElement("wbr"))}const s=e.outerHTML;e.querySelector("wbr")?.remove(),e.setAttribute("updated",Y().format("YYYYMMDDHHmmss")),a.forEach(o=>{o.innerHTML=""}),J(t,e.getAttribute("data-node-id"),e.outerHTML,s)},Bn=(t,e=0,n=1e3)=>{t.scroll.lastScrollTop=-1,setTimeout(()=>{t.scroll.lastScrollTop=e},n)},$h=t=>{const e=t.dataset.type;let n="";if(["NodeHeading","NodeParagraph"].includes(e))n=le(t).innerHTML;else if(e==="NodeHTMLBlock")n="HTML";else if(e==="NodeAttributeView")n=t.querySelector(".av__title").textContent||window.siyuan.languages.database;else if(e==="NodeThematicBreak")n=window.siyuan.languages.line;else if(e==="NodeIFrame")n="IFrame";else if(e==="NodeWidget")n=window.siyuan.languages.widget;else if(e==="NodeVideo")n=window.siyuan.languages.video;else if(e==="NodeAudio")n=window.siyuan.languages.audio;else if(["NodeCodeBlock","NodeTable"].includes(e))n=nc(t);else if(t.classList.contains("render-node"))n+=t.dataset.subtype||Lute.UnEscapeHTMLStr(t.getAttribute("data-content"));else if(["NodeBlockquote","NodeList","NodeSuperBlock","NodeListItem"].includes(e)&&(Array.from(t.querySelectorAll("[data-node-id]")).find(a=>{if(!["NodeBlockquote","NodeList","NodeSuperBlock","NodeListItem"].includes(a.getAttribute("data-type")))return n=$h(t.querySelector("[data-node-id]")),!0}),n))return n;return n+` <span data-type="block-ref" data-subtype="s" data-id="${t.getAttribute("data-node-id")}">*</span>`},nc=(t,e=!1)=>{let n="";const a=t.dataset.type;return a==="NodeHTMLBlock"?n+=Lute.UnEscapeHTMLStr(t.querySelector("protyle-html").getAttribute("data-content")):a==="NodeAttributeView"?(t.querySelectorAll(".av__row").forEach(i=>{i.querySelectorAll(".av__cell").forEach(s=>{n+=go(s)+" "}),n+=`
`}),n=n.trimEnd()):a==="NodeThematicBreak"?n+="---":a==="NodeIFrame"||a==="NodeWidget"?n+=t.querySelector("iframe").getAttribute("src"):a==="NodeVideo"?n+=t.querySelector("video").getAttribute("src"):a==="NodeAudio"?n+=t.querySelector("audio").getAttribute("src"):t.classList.contains("render-node")?n+=Lute.UnEscapeHTMLStr(t.getAttribute("data-content")):["NodeHeading","NodeParagraph","NodeCodeBlock","NodeTable"].includes(a)?n+=t.querySelector("[spellcheck]").textContent:!e&&["NodeBlockquote","NodeList","NodeSuperBlock","NodeListItem"].includes(a)&&t.querySelectorAll("[data-node-id]").forEach(i=>{const s=nc(i,!0);n+=s?s+`
`:""}),n},Tw=async(t,e)=>{try{let n=await Qu();n=n.replace(/<span data-type="text".*?>(.*?)<\/span>/g,"$1"),n=n.replace(/\\/g,"\\\\").replace(/\*/g,"\\*").replace(/_/g,"\\_").replace(/\[/g,"\\[").replace(/]/g,"\\]").replace(/!/g,"\\!").replace(/`/g,"\\`").replace(/</g,"\\<").replace(/>/g,"\\>").replace(/&/g,"\\&").replace(/~/g,"\\~").replace(/\{/g,"\\{").replace(/}/g,"\\}").replace(/\(/g,"\\(").replace(/\)/g,"\\)").replace(/=/g,"\\=").replace(/#/g,"\\#").replace(/\$/g,"\\$").replace(/\^/g,"\\^").replace(/\|/g,"\\|").replace(/\./g,"\\."),wl(t,{textPlain:n,textHTML:"",target:e})}catch(n){console.log(n)}},bf=(t,e)=>{let n=!0;t.options.hint.extend.find(a=>{if(a.key===e)return n=!1,!0}),n&&t.hint.render(t)},Mh=async t=>{let e=[];if(window.siyuan.config.system.os==="darwin"){const n=ee.clipboard.read("NSFilenamesPboardType"),i=new DOMParser().parseFromString(n,"application/xml");Array.from(i.getElementsByTagName("string")).forEach(s=>{e.push(s.childNodes[0].nodeValue)})}else{const n=await Re("/api/clipboard/readFilePaths",{});n.data.length>0&&(e=n.data)}if(e.length>0){jf(e,t,!1);return}e.length===0&&navigator.clipboard.readText().then(n=>{if(getSelection().rangeCount>0){const i=getSelection().getRangeAt(0);if(B(i.startContainer,"data-type","code")||L(i.startContainer,"hljs")){wt(n.replace(/\u200D```/g,"```").replace(/```/g,"\u200D```"),t);return}}n=n.replace(/<sub>/g,"__@sub@__").replace(/<\/sub>/g,"__@/sub@__"),n=n.replace(/<sup>/g,"__@sup@__").replace(/<\/sup>/g,"__@/sup@__"),n=n.replace(/<kbd>/g,"__@kbd@__").replace(/<\/kbd>/g,"__@/kbd@__"),n=n.replace(/<u>/g,"__@u@__").replace(/<\/u>/g,"__@/u@__"),n=n.replace(/<span data-type="text".*?>(.*?)<\/span>/g,"$1"),n=n.replace(/</g,";;;lt;;;").replace(/>/g,";;;gt;;;"),n=n.replace(/__@sub@__/g,"<sub>").replace(/__@\/sub@__/g,"</sub>"),n=n.replace(/__@sup@__/g,"<sup>").replace(/__@\/sup@__/g,"</sup>"),n=n.replace(/__@kbd@__/g,"<kbd>").replace(/__@\/kbd@__/g,"</kbd>"),n=n.replace(/__@u@__/g,"<u>").replace(/__@\/u@__/g,"</u>"),Ph(t);const a=t.lute.BlockDOM2EscapeMarkerContent(t.lute.Md2BlockDOM(n));yf(t),wt(a,t,!1,!1,!0),bf(t,n)})},Ph=t=>{t.lute.SetInlineAsterisk(!0),t.lute.SetGFMStrikethrough(!0),t.lute.SetInlineMath(!0),t.lute.SetSub(!0),t.lute.SetSup(!0),t.lute.SetTag(!0),t.lute.SetInlineUnderscore(!0)},yf=t=>{t.lute.SetInlineAsterisk(window.siyuan.config.editor.markdown.inlineAsterisk),t.lute.SetGFMStrikethrough(window.siyuan.config.editor.markdown.inlineStrikethrough),t.lute.SetInlineMath(window.siyuan.config.editor.markdown.inlineMath),t.lute.SetSub(window.siyuan.config.editor.markdown.inlineSub),t.lute.SetSup(window.siyuan.config.editor.markdown.inlineSup),t.lute.SetTag(window.siyuan.config.editor.markdown.inlineTag),t.lute.SetInlineUnderscore(window.siyuan.config.editor.markdown.inlineUnderscore),t.lute.SetMark(window.siyuan.config.editor.markdown.inlineMark)},Iw=async(t,e)=>{if(t&&t.app&&t.app.plugins)for(let n=0;n<t.app.plugins.length;n++){const a=await new Promise(i=>{t.app.plugins[n].eventBus.emit("paste",{protyle:t,resolve:i,textHTML:"",textPlain:"",siyuanHTML:"",files:e})&&i(void 0)});a?.files&&(e=a.files)}jf(e,t,!0)},wl=async(t,e)=>{("clipboardData"in e||"dataTransfer"in e)&&(e.stopPropagation(),e.preventDefault());let n,a,i,s;if("clipboardData"in e?(n=e.clipboardData.getData("text/html"),a=e.clipboardData.getData("text/plain"),i=e.clipboardData.getData("text/siyuan"),s=e.clipboardData.files):"dataTransfer"in e?(n=e.dataTransfer.getData("text/html"),a=e.dataTransfer.getData("text/plain"),i=e.dataTransfer.getData("text/siyuan"),e.dataTransfer.types[0]==="Files"&&(s=e.dataTransfer.items)):(n=e.textHTML,a=e.textPlain,s=e.files),a=a.replace(/\r\n|\r|\u2028|\u2029/g,`
`),!i&&!n&&!a&&"clipboardData"in e)if(window.siyuan.config.system.os==="darwin"){const c=ee.clipboard.read("NSFilenamesPboardType"),g=new DOMParser().parseFromString(c,"application/xml"),p=[];if(Array.from(g.getElementsByTagName("string")).forEach(h=>{p.push(h.childNodes[0].nodeValue)}),p.length>0){Iw(t,p);return}}else{const c=await Re("/api/clipboard/readFilePaths",{});if(c.data.length>0){Iw(t,c.data);return}}if((n.replace(/&amp;/g,"&").replace(/<(|\/)(html|body|meta)[^>]*?>/ig,"").trim()===`<a href="${a}">${a}</a>`||n.replace(/&amp;/g,"&").replace(/<(|\/)(html|body|meta)[^>]*?>/ig,"").trim()===`<!--StartFragment--><a href="${a}">${a}</a><!--EndFragment-->`)&&(n=""),a.endsWith(u.ZWSP)&&!n&&!i&&(i=a.substr(0,a.length-1)),!i){const c=new DOMParser().parseFromString(n,"text/html");c.body&&c.body.innerHTML&&(n=c.body.innerHTML),n.startsWith(`
<!--StartFragment-->`)&&n.endsWith(`<!--EndFragment-->

`)&&(n=c.body.innerHTML.trim().replace("<!--StartFragment-->","").replace("<!--EndFragment-->","")),n=Lute.Sanitize(n)}if(t&&t.app&&t.app.plugins)for(let c=0;c<t.app.plugins.length;c++){const f=await new Promise(g=>{t.app.plugins[c].eventBus.emit("paste",{protyle:t,resolve:g,textHTML:n,textPlain:a,siyuanHTML:i,files:s})&&g(void 0)});f?.textHTML&&(n=f.textHTML),f?.textPlain&&(a=f.textPlain),f?.siyuanHTML&&(i=f.siyuanHTML),f?.files&&(s=f.files)}const o=P(e.target);if(!o){s&&s.length>0&&ii(t,s);return}Q(["select"],t),t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl").forEach(c=>{c.classList.remove("protyle-wysiwyg--hl")});const l=XS(n,a),r=me(t.wysiwyg.element);if(o.getAttribute("data-type")==="NodeCodeBlock"||t.toolbar.getCurrentType(r).includes("code")){wt(a.replace(/\u200D```/g,"```").replace(/```/g,"\u200D```"),t);return}else if(i){const c=document.createElement("div");c.innerHTML=i;let f=!1;c.querySelectorAll("[data-node-id]").forEach(p=>{const h=Lute.NewNodeID();p.setAttribute("data-node-id",h),p.removeAttribute(u.CUSTOM_RIFF_DECKS),p.classList.remove("protyle-wysiwyg--select","protyle-wysiwyg--hl"),p.setAttribute("updated",h.split("-")[0]),p.removeAttribute("refcount"),f=!0}),o.classList.contains("table")&&(f=!1),c.querySelectorAll('[contenteditable="false"][spellcheck]').forEach(p=>{p.setAttribute("contenteditable","true")});let g=c.innerHTML;if(!o.classList.contains("av")&&g.startsWith("[[{")&&g.endsWith("}]]"))try{const p=JSON.parse(g);p.length>0&&p[0].length>0&&p[0][0].id&&p[0][0].type?wt(a,t,f):wt(g,t,f)}catch{wt(g,t,f)}else-1<g.indexOf("NodeHTMLBlock")&&(g=Lute.UnEscapeHTMLStr(g)),g=g.replace(/\u200D```/g,"```"),wt(g,t,f,!1,!0);bf(t,t.lute.BlockDOM2StdMd(g)),Be(t,t.wysiwyg.element),yt(t.wysiwyg.element),ze(t.wysiwyg.element),dt(t.wysiwyg.element,t)}else if(l)l.startsWith('<div data-type="NodeCodeBlock" class="code-block" data-node-id="')?(wt(l,t,!0,!1,!0),ze(t.wysiwyg.element)):wt(l,t),Q(["hint"],t);else{let c=!1;if(n.replace("<!--StartFragment--><!--EndFragment-->","").trim()!==""&&(n=n.replace("<!--StartFragment-->","").replace("<!--EndFragment-->","").trim(),s&&s.length===1&&(n.startsWith("<img")||n.startsWith("<table")&&n.indexOf("<img")>-1)?c=!1:c=!0,a&&a.trim()!==""&&n.startsWith("<span")&&-1<n.indexOf("white-space: pre;")&&(c=!1)),c){const f=document.createElement("div");f.innerHTML=n,f.querySelectorAll("[style]").forEach(g=>{g.removeAttribute("style")}),f.querySelectorAll("a").forEach(g=>{g.innerHTML.trim()===""&&g.remove()}),E("/api/lute/html2BlockDOM",{dom:f.innerHTML},g=>{wt(g.data,t,!1,!1,!0),t.wysiwyg.element.querySelectorAll('[data-type~="block-ref"]').forEach(p=>{p.textContent===""&&E("/api/block/getRefText",{id:p.getAttribute("data-id")},h=>{p.innerHTML=h.data})}),Be(t,t.wysiwyg.element),yt(t.wysiwyg.element),ze(t.wysiwyg.element),dt(t.wysiwyg.element,t),bf(t,g.data),Ne(t,void 0,!1,"smooth")});return}else if(s&&s.length>0){ii(t,s);return}else if(a.trim()!==""&&(s&&s.length===0||!s)){if(r.toString()!==""){const g=a.split(`
`)[0];if(wi(a)){t.toolbar.setInlineMark(t,"block-ref","range",{type:"id",color:`${a.substring(2,22+2)}${u.ZWSP}s${u.ZWSP}${r.toString()}`});return}else if(zr(g)){t.toolbar.setInlineMark(t,"file-annotation-ref","range",{type:"file-annotation-ref",color:g.substring(2).replace(/ ".+">>$/,"")});return}else{const p=a.startsWith("assets/")?a:t.lute.GetLinkDest(a);if(p){t.toolbar.setInlineMark(t,"a","range",{type:"a",color:p});return}}}a=a.replace(/\u200D```/g,"```");const f=t.lute.Md2BlockDOM(a);wt(f,t,!1,!1,!0),bf(t,a)}Be(t,t.wysiwyg.element),yt(t.wysiwyg.element),ze(t.wysiwyg.element),dt(t.wysiwyg.element,t)}const d=o.querySelector(".av__cell--select");o.classList.contains("av")&&d?Ii(o,d):Ne(t,void 0,!1,"smooth")},ac=(t,e,n,a)=>{!qn()||(!e||e.length===0)&&!n||setTimeout(()=>{t.highlight.markHL.clear(),t.highlight.mark.clear(),t.highlight.ranges=[];let i=!1,s;typeof n=="string"&&Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id='${n}']`)).find(p=>{if(!F(p))return s=p,!0});const o=[],l=[];let r=0;const d=document.createTreeWalker(t.wysiwyg.element,NodeFilter.SHOW_TEXT);let c=d.nextNode();for(;c;)o.push(c),r+=c.textContent.length,l.push(r),c=d.nextNode();const f=t.wysiwyg.element.textContent,g=[];if(e&&e.length>0&&e.forEach(p=>{if(!p)return;let h=0,m=0,b=0;for(;(h=f.indexOf(p,h))!==-1;){const y=new Range;m=h+p.length;try{for(;b<o.length&&l[b]<=h;)b++;let w=o[b];for(y.setStart(w,h-(b?l[b-1]:0));b<o.length&&l[b]<m;)b++;w=o[b],y.setEnd(w,m-(b?l[b-1]:0));let _=!1;!i&&s&&s.contains(w)&&(i=!0,_=!0),g.push({range:y,startIndex:h,isCurrent:_})}catch(w){console.error("searchMarkRender error:",w)}h=m}}),!i&&s){const p=f.indexOf(s.textContent);if(p>-1){const h=new Range;let m=0;for(;o.length&&l[m]<=p;)m++;h.setStart(o[m],0),g.push({range:h,startIndex:p,isCurrent:!0})}}g.sort((p,h)=>h.startIndex>p.startIndex?-1:0).forEach((p,h)=>{typeof n=="string"&&p.isCurrent||typeof n=="number"&&n===h?(t.highlight.rangeIndex=h,t.highlight.markHL.add(p.range)):t.highlight.mark.add(p.range),t.highlight.ranges.push(p.range)}),CSS.highlights.set("search-mark-"+t.highlight.styleElement.dataset.uuid,t.highlight.mark),typeof n<"u"&&CSS.highlights.set("search-mark-hl-"+t.highlight.styleElement.dataset.uuid,t.highlight.markHL),a&&a()},t.wysiwyg.element.querySelector(".hljs")?u.TIMEOUT_TRANSITION:0)},qn=()=>!!(CSS&&CSS.highlights),ic=(t,e=!1)=>{if(!t.wysiwyg.element.firstElementChild||window.siyuan.config.readonly)return;const n={rootId:t.block.rootID,startId:t.wysiwyg.element.firstElementChild.getAttribute("data-node-id"),endId:t.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),scrollTop:t.contentElement.scrollTop||parseInt(t.contentElement.getAttribute("data-scrolltop"))||0};let a;if(getSelection().rangeCount>0&&(a=getSelection().getRangeAt(0)),(!a||!t.wysiwyg.element.contains(a.startContainer))&&(a=t.toolbar.range),a&&t.wysiwyg.element.contains(a.startContainer)){const i=P(a.startContainer);if(i){const s=ct(i,void 0,a);n.focusId=i.getAttribute("data-node-id"),n.focusStart=s.start,n.focusEnd=s.end}}return t.block.showAll&&(n.zoomInId=t.block.id),e?n:(window.siyuan.storage[u.LOCAL_FILEPOSITION][t.block.rootID]=n,new Promise(i=>{ue(u.LOCAL_FILEPOSITION,window.siyuan.storage[u.LOCAL_FILEPOSITION],()=>{i(!0)})}))},Nh=t=>{let e=[];if(t.mergedOptions?e=t.mergedOptions.action:t.focus?e=[u.CB_GET_UNUNDO,u.CB_GET_FOCUS]:e=[u.CB_GET_UNUNDO],t.scrollAttr?.zoomInId){E("/api/filetree/getDoc",{id:t.scrollAttr.zoomInId,size:u.SIZE_GET_MAX,query:t.protyle.query?.key,queryMethod:t.protyle.query?.method,queryTypes:t.protyle.query?.types,highlight:!qn()},n=>{n.code===1?E("/api/filetree/getDoc",{id:t.scrollAttr.rootId||t.mergedOptions?.blockId||t.protyle.block?.rootID||t.scrollAttr.startId,query:t.protyle.query?.key,queryMethod:t.protyle.query?.method,queryTypes:t.protyle.query?.types,highlight:!qn()},a=>{rt({data:a,protyle:t.protyle,action:e,scrollAttr:t.scrollAttr,afterCB:t.cb?()=>{t.cb(a.data.keywords)}:void 0,updateReadonly:t.updateReadonly})}):(e.push(u.CB_GET_ALL),rt({data:n,protyle:t.protyle,action:e,scrollAttr:t.scrollAttr,afterCB:t.cb?()=>{t.cb(n.data.keywords)}:void 0,updateReadonly:t.updateReadonly}))});return}E("/api/filetree/getDoc",{id:t.scrollAttr?.rootId||t.mergedOptions?.blockId||t.protyle.block?.rootID||t.scrollAttr?.startId,startID:t.scrollAttr?.startId,endID:t.scrollAttr?.endId,query:t.protyle.query?.key,queryMethod:t.protyle.query?.method,queryTypes:t.protyle.query?.types,highlight:!qn()},n=>{rt({data:n,protyle:t.protyle,action:e,scrollAttr:t.scrollAttr,afterCB:t.cb?()=>{t.cb(n.data.keywords)}:void 0,updateReadonly:t.updateReadonly})})},ei=(t,e,n)=>{if(!t.preview.element.classList.contains("fn__none")){t.preview.render(t),Ac(t);return}if(window.siyuan.config.editor.displayBookmarkIcon?t.wysiwyg.element.classList.add("protyle-wysiwyg--attr"):t.wysiwyg.element.classList.remove("protyle-wysiwyg--attr"),t.title&&(t.title.element.removeAttribute("data-render"),t.title.element.setAttribute("spellcheck",window.siyuan.config.editor.spellcheck.toString()),window.siyuan.config.editor.displayBookmarkIcon?t.title.element.classList.add("protyle-wysiwyg--attr"):t.title.element.classList.remove("protyle-wysiwyg--attr")),t.lute.SetProtyleMarkNetImg(window.siyuan.config.editor.displayNetImgMark),t.lute.SetSpellcheck(window.siyuan.config.editor.spellcheck),yf(t),t.lute.SetGFMStrikethrough1(!1),ho(t),t.options.backlinkData){const a=t.element.getAttribute("data-ismention")==="true",i=L(t.element,"sy__backlink");if(i){const s=i.querySelectorAll(".b3-text-field"),o=a?s[1].value:s[0].value;E(a?"/api/ref/getBackmentionDoc":"/api/ref/getBacklinkDoc",{defID:t.element.getAttribute("data-defid"),refTreeID:t.block.rootID,highlight:!qn(),keyword:o},l=>{t.options.backlinkData=a?l.data.backmentions:l.data.backlinks,cv(t,t.options.backlinkData),ac(t,l.data.keywords)})}}else Bn(t),Nh({protyle:t,focus:e,scrollAttr:ic(t,!0),updateReadonly:n,cb(a){t.query?.key&&ac(t,a,t.highlight.rangeIndex)}})},Dw=t=>{const e=document.getElementById("model");e.style.transform="translateY(0px)",e.style.zIndex=(++window.siyuan.zIndex).toString();const n=e.querySelector(".toolbar__icon");t.icon?(n.classList.remove("fn__none"),n.querySelector("use").setAttribute("xlink:href","#"+t.icon)):n.classList.add("fn__none"),e.querySelector(".toolbar__text").innerHTML=t.title;const a=e.querySelector("#modelMain");a.innerHTML=t.html,t.bindEvent(a)},wf=(t,e)=>{let n=`<option value="">${window.siyuan.languages.currentNotebook}</option>`;const a=[];return Object.keys(u.HELP_PATH).forEach(i=>{a.push(u.HELP_PATH[i])}),window.siyuan.notebooks.forEach(i=>{a.includes(i.id)||i.id===e||(n+=`<option value="${i.id}" ${t===i.id?"selected":""}>${pe(i.name)}</option>`)}),n},uL=t=>{const e=`<div class="fn__flex">${pe(t.name)}
<div class="fn__space"></div>
<button class="b3-button b3-button--small fn__flex-center">${window.siyuan.languages.copy} ID</button></div>`,n=`<div class="b3-dialog__content" style="background-color: var(--b3-theme-background);">
<div class="b3-label config__item">
    ${window.siyuan.languages.fileTree12}
    <div class="b3-label__text">${window.siyuan.languages.fileTree13}</div>
    <span class="fn__hr"></span>
    <div class="fn__flex">
        <select style="min-width: 200px" class="b3-select" id="docCreateSaveBox">${wf(t.conf.docCreateSaveBox,t.box)}</select>
        <div class="fn__space"></div>
        <input class="b3-text-field fn__flex-1" id="docCreateSavePath" value="">
    </div>
</div>
<div class="b3-label config__item">
    ${window.siyuan.languages.fileTree5}
    <div class="b3-label__text">${window.siyuan.languages.fileTree6}</div>
    <span class="fn__hr"></span>
    <div class="fn__flex">
        <select style="min-width: 200px" class="b3-select" id="refCreateSaveBox">${wf(t.conf.refCreateSaveBox,t.box)}</select>
        <div class="fn__space"></div>
        <input class="b3-text-field fn__flex-1" id="refCreateSavePath" value="">
    </div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.fileTree11}
    <div class="b3-label__text">${window.siyuan.languages.fileTree14}</div>
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__flex-center fn__block" id="dailyNoteSavePath" value="">
    <div class="fn__hr"></div>
    <div class="b3-label__text">${window.siyuan.languages.fileTree15}</div>
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__flex-center fn__block" id="dailyNoteTemplatePath" value="${t.conf.dailyNoteTemplatePath}">
</div></div>`;if(W())Dw({title:e,icon:"iconSettings",html:`<div>${n}</div>`,bindEvent(){$w(document.querySelector("#model"),t)}});else{const a=new we({width:"80vw",title:e,content:n});a.element.setAttribute("data-key",u.DIALOG_NOTEBOOKCONF),$w(a.element,t)}},$w=(t,e)=>{t.querySelector(".b3-button--small").addEventListener("click",()=>{De(e.box),j(window.siyuan.languages.copied)});const n=t.querySelector("#dailyNoteSavePath");n.value=e.conf.dailyNoteSavePath;const a=t.querySelector("#docCreateSavePath");a.value=e.conf.docCreateSavePath;const i=t.querySelector("#refCreateSavePath");i.value=e.conf.refCreateSavePath;const s=t.querySelector("#dailyNoteTemplatePath");s.value=e.conf.dailyNoteTemplatePath,t.querySelectorAll("input, select").forEach(o=>{o.addEventListener("change",()=>{E("/api/notebook/setNotebookConf",{notebook:e.box,conf:{refCreateSavePath:i.value,refCreateSaveBox:t.querySelector("#refCreateSaveBox").value,docCreateSaveBox:t.querySelector("#docCreateSaveBox").value,docCreateSavePath:a.value,dailyNoteSavePath:n.value,dailyNoteTemplatePath:s.value}})})})},wn=async t=>{const e=window.siyuan.storage[u.LOCAL_SEARCHDATA];let n="",a=[];if(t.notebookId){if(n=$a(t.notebookId),a.push(t.notebookId),t.searchPath&&t.searchPath!=="/"){const r=await Re("/api/filetree/getHPathByPath",{notebook:t.notebookId,path:t.searchPath.endsWith(".sy")?t.searchPath:t.searchPath+".sy"});n=Ee().join(n,r.data),a[0]=Ee().join(a[0],t.searchPath)}}else u.DIALOG_GLOBALSEARCH===t.hotkey&&(e.removed?(n="",a=[]):(n=e.hPath,a=e.idPath));const i={removed:e.removed,k:t.key||e.k,r:e.r,hasReplace:t.hotkey===u.DIALOG_REPLACE,method:e.method,hPath:n,idPath:a,group:e.group,sort:e.sort,types:Object.assign({},e.types),replaceTypes:Object.assign({},e.replaceTypes),page:t.key?1:e.page};if(window.siyuan.dialogs.find(r=>{if(r.element.querySelector("#searchList")){const d=r.element.querySelector(".b3-dialog__body"),c=JSON.parse(JSON.stringify(r.data)),f=getSelection().rangeCount>0?getSelection().getRangeAt(0).toString():void 0;if(f&&(c.k=f),r.element.setAttribute("data-key",t.hotkey),t.hotkey===u.DIALOG_REPLACE)c.hasReplace=!0,io(d,c,r.data,r.editors.edit);else if(t.hotkey===u.DIALOG_GLOBALSEARCH)c.hasReplace=!1,c.hPath="",c.idPath=[],io(d,c,r.data,r.editors.edit);else if(t.hotkey===u.DIALOG_SEARCH){c.hasReplace=!1;const g=r.editors.edit.protyle.path;E("/api/filetree/getHPathsByPaths",{paths:[g]},p=>{c.idPath=[Ee().join(r.editors.edit.protyle.notebookId,g)],c.hPath=p.data[0],r.data.idPath=c.idPath,r.data.hPath=c.hPath,io(d,c,r.data,r.editors.edit)})}return!0}}))return;let o;getSelection().rangeCount>0&&(o=getSelection().getRangeAt(0));const l=new we({positionId:t.hotkey,content:"",width:"80vw",height:"90vh",destroyCallback(r){o&&!r&&Z(o),l.editors.edit.destroy(),l.editors.unRefEdit.destroy()},resizeCallback(r){r!=="d"&&r!=="t"&&(l.element.querySelector("#searchUnRefPanel").classList.contains("fn__none")?l.editors.edit.resize():l.editors.unRefEdit.resize())}});l.element.setAttribute("data-key",t.hotkey),l.editors=Xw(t.app,i,l.element.querySelector(".b3-dialog__body"),()=>{l.destroy({focus:"false"})}),l.data=i},Mw=(t,e)=>{if(window.siyuan.config.fileTree.removeDocWithoutConfirm){E("/api/filetree/removeDoc",{notebook:t,path:e});return}E("/api/block/getDocInfo",{id:nt(e,!0,!0)},n=>{const a=pe(n.data.name);let i=`${window.siyuan.languages.confirmDeleteTip.replace("${x}",a)}
<div class="fn__hr"></div>
<div class="ft__smaller ft__on-surface">${window.siyuan.languages.rollbackTip.replace("${x}",window.siyuan.config.editor.historyRetentionDays)}</div>`;n.data.subFileCount>0&&(i=`${window.siyuan.languages.andSubFile.replace("${x}",a).replace("${y}",n.data.subFileCount)}
<div class="fn__hr"></div>
<div class="ft__smaller ft__on-surface">${window.siyuan.languages.rollbackTip.replace("${x}",window.siyuan.config.editor.historyRetentionDays)}</div>`),xe(window.siyuan.languages.deleteOpConfirm,i,()=>{E("/api/filetree/removeDoc",{notebook:t,path:e})},void 0,!0)})},_f=t=>{if(t.length===1){const e=fe(t[0],"UL");if(e){const n=e.getAttribute("data-url");t[0].getAttribute("data-type")==="navigation-file"?Mw(n,t[0].getAttribute("data-path")):xe(window.siyuan.languages.deleteOpConfirm,`${window.siyuan.languages.confirmDeleteTip.replace("${x}",Lute.EscapeHTMLStr($a(n)))}
<div class="fn__hr"></div>
<div class="ft__smaller ft__on-surface">${window.siyuan.languages.rollbackTip.replace("${x}",window.siyuan.config.editor.historyRetentionDays)}</div>`,()=>{E("/api/notebook/removeNotebook",{notebook:n,callback:u.CB_MOUNT_REMOVE})},void 0,!0)}}else{const e=[];if(t.forEach(n=>{n.getAttribute("data-path")!=="/"&&e.push(n.getAttribute("data-path"))}),e.length===0){j(window.siyuan.languages.notBatchRemove);return}xe(window.siyuan.languages.deleteOpConfirm,`${window.siyuan.languages.confirmRemoveAll.replace("${count}",e.length)}
<div class="fn__hr"></div>
<div class="ft__smaller ft__on-surface">${window.siyuan.languages.rollbackTip.replace("${x}",window.siyuan.config.editor.historyRetentionDays)}</div>`,()=>{E("/api/filetree/removeDocs",{paths:e})},void 0,!0)}},vf=(t,e)=>{t.element.querySelector(".wysiwygLoading")||(ho(t),Q(["toolbar"],t),E(`/api/format/net${e}2LocalAssets`,{id:t.block.rootID},()=>{Mn().forEach(n=>{n.protyle.block.rootID===t.block.rootID&&ei(n.protyle,n.protyle.element.isSameNode(t.element))})}))},to=(t,e)=>{setTimeout(()=>{Ji(["gutter"])},u.TIMEOUT_TRANSITION);const n=t.className.includes("fullscreen");if(n?(t.classList.remove("fullscreen"),document.getElementById("drag")?.classList.remove("fn__hidden")):(t.classList.add("fullscreen"),document.getElementById("drag")?.classList.add("fn__hidden")),ve()){const a=[];ko(window.siyuan.layout.layout,a),a.find(async i=>{const s=i.headersElement.parentElement;if(s.getBoundingClientRect().top<=0)return s.querySelector(".item--readonly .fn__flex-1").style.WebkitAppRegion=n?"drag":"",!0})}if(window.siyuan.config.system.os!=="darwin"){const a=document.getElementById("windowControls");n?a.style.zIndex="":(window.siyuan.zIndex++,a.style.zIndex=window.siyuan.zIndex.toString())}if(e){n?e.querySelector("use").setAttribute("xlink:href","#iconFullscreen"):e.querySelector("use").setAttribute("xlink:href","#iconFullscreenExit");const a=L(t,"layout--float");a&&(n?(a.setAttribute("data-temp",a.style.transform),a.style.transform="none"):(a.style.transform=a.getAttribute("data-temp"),a.removeAttribute("data-temp")));return}if(t.classList.contains("protyle")&&(window.siyuan.editorIsFullscreen=!n),Ce().editor.forEach(a=>{t.isSameNode(a.element)||(window.siyuan.editorIsFullscreen,a.element.classList.contains("fullscreen")&&(a.element.classList.remove("fullscreen"),Jt(a.editor.protyle)))}),window.siyuan.config.system.os!=="darwin"){const a=document.getElementById("windowControls");n?a.style.zIndex="":(window.siyuan.zIndex++,a.style.zIndex=window.siyuan.zIndex.toString())}},Hh=(t,e)=>{if(!window.siyuan.config.readonly){const n=t.querySelector("use").getAttribute("xlink:href")!=="#iconUnlock";window.siyuan.config.editor.readOnly?n?sp(e):Zn(e):E("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{[u.CUSTOM_SY_READONLY]:n?"false":"true"}})}},fL=()=>{},Ef=(t,e=0)=>{let n=0,a=0;return t.cards.forEach((i,s)=>{s>e||(i.state===0?n++:a++)}),`<span class="ariaLabel" aria-label="${window.siyuan.languages.flashcardNewCard}">
    <span class="ft__error">${n}</span> /
    <span class="ariaLabel ft__primary" aria-label="${window.siyuan.languages.flashcardNewCard}">${t.unreviewedNewCardCount}</span>
</span>
<span class="fn__space"></span>+<span class="fn__space"></span>
<span class="ariaLabel" aria-label="${window.siyuan.languages.flashcardReviewCard}">
    <span class="ft__error">${a}</span> /
    <span class="ft__success">${t.unreviewedOldCardCount}</span>
</span>`},kf=t=>{let e;return e=`<div class="block__icons">
        ${t.isTab?'<div class="fn__flex-1"></div>':`<div class="block__logo">
            <svg class="block__logoicon"><use xlink:href="#iconRiffCard"></use></svg>${window.siyuan.languages.riffCard}
        </div>`}
        <span class="fn__flex-1 resize__move" style="min-height: 100%"></span>
        <div data-type="count" class="ft__on-surface ft__smaller fn__flex-center${t.cardsData.cards.length===0?" fn__none":" fn__flex"}">${Ef(t.cardsData)}</span></div>
        <div class="fn__space"></div>
        <button data-id="${t.id||""}" data-cardtype="${t.cardType}" data-type="filter" class="block__icon block__icon--show">
            <svg><use xlink:href="#iconFilter"></use></svg>
        </button>
        <div class="fn__space"></div>
        <div data-type="fullscreen" class="b3-tooltips b3-tooltips__sw block__icon block__icon--show" aria-label="${window.siyuan.languages.fullscreen}">
            <svg><use xlink:href="#iconFullscreen"></use></svg>
        </div>
        <div class="fn__space"></div>
        <div data-type="more" class="b3-tooltips b3-tooltips__sw block__icon block__icon--show" aria-label="${window.siyuan.languages.more}">
            <svg><use xlink:href="#iconMore"></use></svg>
        </div>
        <div class="fn__space${t.isTab?" fn__none":""}"></div>
        <div data-type="sticktab" class="b3-tooltips b3-tooltips__sw block__icon block__icon--show${t.isTab?" fn__none":""}" aria-label="${window.siyuan.languages.openBy}">
            <svg><use xlink:href="#iconOpen"></use></svg>
        </div>
    </div>`,`<div class="card__main">
    ${e}
    <div class="card__block fn__flex-1 ${t.cardsData.cards.length===0?"fn__none":""}" data-type="render"></div>
    <div class="card__empty card__empty--space${t.cardsData.cards.length===0?"":" fn__none"}" data-type="empty">
        <div>\u{1F52E}</div>
        ${window.siyuan.languages.noDueCard}
    </div>
    <div class="fn__flex card__action fn__none">
        <button class="b3-button b3-button--cancel" disabled="disabled" data-type="-2" style="width: 25%;min-width: 86px;display: flex">
            <svg><use xlink:href="#iconLeft"></use></svg>
            ${W()?"":"(p / q)"}
        </button>
        <span class="fn__space"></span>
        <button data-type="-1" class="b3-button fn__flex-1">${window.siyuan.languages.cardShowAnswer}${W()?"":" ("+window.siyuan.languages.space+" / "+window.siyuan.languages.enterKey+")"}</button>
    </div>
    <div class="fn__flex card__action fn__none">
        <div>
            <button class="b3-button b3-button--cancel" disabled="disabled" style="display: flex;margin-bottom: 8px;height: 28px;padding: 0;" data-type="-2"><svg><use xlink:href="#iconLeft"></use></svg>${W()?"":"(p / q)"}</button>
            <button data-type="-3" aria-label="0 / x" class="b3-button b3-button--cancel b3-tooltips__n b3-tooltips">
                <div class="card__icon">\u{1F4A4}</div>
                ${window.siyuan.languages.skip}${W()?"":" (0)"}
            </button>
        </div>
        <div>
            <span></span>
            <button data-type="1" aria-label="1 / j / a" class="b3-button b3-button--error b3-tooltips__n b3-tooltips">
                <div class="card__icon">\u{1F648}</div>
                ${window.siyuan.languages.cardRatingAgain}${W()?"":" (1)"}
            </button>
        </div>
        <div>
            <span></span>
            <button data-type="2" aria-label="2 / k / s" class="b3-button b3-button--warning b3-tooltips__n b3-tooltips">
                <div class="card__icon">\u{1F62C}</div>
                ${window.siyuan.languages.cardRatingHard}${W()?"":" (2)"}
            </button>
        </div>
        <div>
            <span></span>
            <button data-type="3" aria-label="3 / l / d / ${window.siyuan.languages.space} / ${window.siyuan.languages.enterKey}" class="b3-button b3-button--info b3-tooltips__n b3-tooltips">
                <div class="card__icon">\u{1F60A}</div>
                ${window.siyuan.languages.cardRatingGood}${W()?"":" (3)"}
            </button>
        </div>
        <div>
            <span></span>
            <button data-type="4" aria-label="4 / ; / f" class="b3-button b3-button--success b3-tooltips__n b3-tooltips">
                <div class="card__icon">\u{1F308}</div>
                ${window.siyuan.languages.cardRatingEasy}${W()?"":" (4)"}
            </button>
        </div>
    </div>
</div>`},Pw=(t,e,n,a)=>{E("/api/block/getDocInfo",{id:t},i=>{e.wysiwyg.renderCustom(i.data.ial),E("/api/filetree/getDoc",{id:t,mode:0,size:u.SIZE_GET_MAX},s=>{rt({updateReadonly:!0,data:s,protyle:e,action:s.data.rootID===s.data.id?[u.CB_GET_HTML]:[u.CB_GET_ALL,u.CB_GET_HTML],afterCB:()=>{let o=!1;!window.siyuan.config.flashcard.superBlock&&!window.siyuan.config.flashcard.heading&&!window.siyuan.config.flashcard.list&&!window.siyuan.config.flashcard.mark?o=!1:(window.siyuan.config.flashcard.superBlock&&e.wysiwyg.element.querySelector(":scope > .sb")&&(o=!0),window.siyuan.config.flashcard.heading&&e.wysiwyg.element.querySelector(':scope > [data-type="NodeHeading"]')&&(o=!0),window.siyuan.config.flashcard.list&&e.wysiwyg.element.querySelector(".list, .li")&&(o=!0),window.siyuan.config.flashcard.mark&&e.wysiwyg.element.querySelector('span[data-type~="mark"]')&&(o=!0));const l=n.querySelectorAll(".card__action");o?(window.siyuan.config.flashcard.superBlock&&e.element.classList.add("card__block--hidesb"),window.siyuan.config.flashcard.heading&&e.element.classList.add("card__block--hideh"),window.siyuan.config.flashcard.list&&e.element.classList.add("card__block--hideli"),window.siyuan.config.flashcard.mark&&e.element.classList.add("card__block--hidemark"),l[0].classList.remove("fn__none"),l[1].classList.add("fn__none")):(e.element.classList.remove("card__block--hidemark","card__block--hideli","card__block--hidesb","card__block--hideh"),l[0].classList.add("fn__none"),l[1].querySelectorAll("button.b3-button").forEach((r,d)=>{d<2||(r.previousElementSibling.textContent=a.nextDues[d-1])}),l[1].classList.remove("fn__none"))}})})})},Rh=async t=>{window.siyuan.storage[u.LOCAL_FLASHCARD].fullscreen&&to(t.element.querySelector(".card__main"),t.element.querySelector('[data-type="fullscreen"]'));let e=0;typeof t.index=="number"&&(e=t.index);const n=new aa(t.app,t.element.querySelector("[data-type='render']"),{blockId:"",action:[u.CB_GET_ALL],render:{background:!1,gutter:!0,breadcrumbDocName:!0},typewriterMode:!1});window.siyuan.mobile&&(window.siyuan.mobile.popEditor=n),t.cardsData.cards.length>0&&Pw(t.cardsData.cards[e].blockID,n.protyle,t.element,t.cardsData.cards[e]),t.element.setAttribute("data-key",u.DIALOG_OPENCARD);const a=t.element.querySelectorAll(".card__action");t.index===0||typeof t.index>"u"?(a[0].firstElementChild.setAttribute("disabled","disabled"),a[1].querySelector(".b3-button").setAttribute("disabled","disabled")):(a[0].firstElementChild.removeAttribute("disabled"),a[1].querySelector(".b3-button").removeAttribute("disabled"));const i=t.element.querySelector('[data-type="count"]'),s=t.element.querySelector('[data-type="filter"]'),o=()=>{const l=s.getAttribute("data-cardtype"),r=s.getAttribute("data-id");E(l==="all"?"/api/riff/getRiffDueCards":l==="doc"?"/api/riff/getTreeRiffDueCards":"/api/riff/getNotebookRiffDueCards",{rootID:r,deckID:r,notebook:r},async d=>{e=0,t.cardsData=d.data;for(let c=0;c<t.app.plugins.length;c++)t.cardsData=await t.app.plugins[c].updateCards(t.cardsData);t.cardsData.cards.length>0?Lf({countElement:i,editor:n,actionElements:a,index:e,cardsData:t.cardsData}):Nw(i,n,a)})};return i.innerHTML=Ef(t.cardsData,e),t.element.addEventListener("click",l=>{const r=l.target;let d="";const c=t.cardsData.cards[e],f=s.getAttribute("data-id");if(typeof l.detail=="string")["1","j","a"].includes(l.detail)?d="1":["2","k","s"].includes(l.detail)?d="2":["3","l","d"].includes(l.detail)?d="3":["4",";","f"].includes(l.detail)?d="4":[" ","enter"].includes(l.detail)?d="-1":["p","q"].includes(l.detail)?d="-2":["0","x"].includes(l.detail)&&(d="-3");else{if(B(r,"data-type","fullscreen")){to(t.element.querySelector(".card__main"),t.element.querySelector('[data-type="fullscreen"]')),Jt(n.protyle),window.siyuan.storage[u.LOCAL_FLASHCARD].fullscreen=!window.siyuan.storage[u.LOCAL_FLASHCARD].fullscreen,ue(u.LOCAL_FLASHCARD,window.siyuan.storage[u.LOCAL_FLASHCARD]),l.stopPropagation(),l.preventDefault();return}const p=B(r,"data-type","more");if(p){if(l.stopPropagation(),l.preventDefault(),s.getAttribute("data-cardtype")==="all"&&s.getAttribute("data-id")){j(window.siyuan.languages.noSupportTip);return}const w=new st;w.addItem({id:"setDueTime",icon:"iconClock",label:window.siyuan.languages.setDueTime,click(){const x=new we({title:window.siyuan.languages.setDueTime,content:`<div class="b3-dialog__content">
    <div class="b3-label__text">${window.siyuan.languages.showCardDay}</div>
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__block" value="1" type="number" step="1" min="1">
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:W()?"92vw":"520px"}),S=x.element.querySelector("input"),k=x.element.querySelectorAll(".b3-button");x.bindInput(S,()=>{k[1].click()}),S.focus(),S.select(),k[0].addEventListener("click",()=>{x.destroy()}),k[1].addEventListener("click",()=>{E("/api/riff/batchSetRiffCardsDueTime",{cardDues:[{id:c.cardID,due:Y().add(parseInt(S.value),"day").format("YYYYMMDDHHmmss")}]},()=>{a[0].classList.add("fn__none"),a[1].classList.remove("fn__none"),c.state===0?t.cardsData.unreviewedNewCardCount--:t.cardsData.unreviewedOldCardCount--,t.element.dispatchEvent(new CustomEvent("click",{detail:"0"})),t.cardsData.cards.splice(e,1),e--,x.destroy()})})}}),c.state!==0&&w.addItem({id:"reset",icon:"iconRefresh",label:window.siyuan.languages.reset,click(){E("/api/riff/resetRiffCards",{type:s.getAttribute("data-cardtype"),id:f,deckID:u.QUICK_DECK_ID,blockIDs:[c.blockID]},()=>{const x=window.siyuan.languages._time["1m"].replace("%s","");c.lapses=0,c.lastReview=-621355968e5,c.reps=0,c.state=0,c.nextDues={1:x,2:x.replace("1","5"),3:x.replace("1","10"),4:window.siyuan.languages._time["1d"].replace("%s","").replace("1","6")},a[1].querySelectorAll("button.b3-button").forEach((S,k)=>{k<2||(S.previousElementSibling.textContent=c.nextDues[k-1])}),t.cardsData.unreviewedOldCardCount--,t.cardsData.unreviewedNewCardCount++,i.innerHTML=Ef(t.cardsData,e)})}}),w.addItem({id:"removeRiffCard",icon:"iconTrashcan",label:`${window.siyuan.languages.remove} <b>${window.siyuan.languages.riffCard}</b>`,click(){a[0].classList.add("fn__none"),a[1].classList.remove("fn__none"),c.state===0?t.cardsData.unreviewedNewCardCount--:t.cardsData.unreviewedOldCardCount--,t.element.dispatchEvent(new CustomEvent("click",{detail:"0"})),U(void 0,[{action:"removeFlashcards",deckID:u.QUICK_DECK_ID,blockIDs:[c.blockID]}]),t.cardsData.cards.splice(e,1),e--}}),w.addSeparator(),w.addItem({id:"forgetCountAndRevisionCountAndCardStatusAndLastReviewTime",iconHTML:"",type:"readonly",label:`<div class="fn__flex">
    <div class="fn__flex-1 ft__breakword">${window.siyuan.languages.forgetCount}</div>
    <div class="fn__space"></div>
    <div>${c.lapses}</div>
</div><div class="fn__flex">
    <div class="fn__flex-1 ft__breakword">${window.siyuan.languages.revisionCount}</div>
    <div class="fn__space"></div>
    <div>${c.reps}</div>
</div><div class="fn__flex">
    <div class="fn__flex-1 ft__breakword">${window.siyuan.languages.cardStatus}</div>
    <div class="fn__space"></div>
    <div class="${c.state===0?"ft__primary":"ft__success"}">${c.state===0?window.siyuan.languages.flashcardNewCard:window.siyuan.languages.flashcardReviewCard}</div>
</div><div class="fn__flex${c.lastReview>0?"":" fn__none"}">
    <div class="fn__flex-1 ft__breakword" style="width: 170px;">${window.siyuan.languages.lastReviewTime}</div>
    <div class="fn__space"></div>
    <div>${Y(c.lastReview).format("YYYY-MM-DD")}</div>
</div>`});const _=p.getBoundingClientRect();w.open({x:_.left,y:_.bottom});return}const h=B(r,"data-type","sticktab");if(h){const w=new st;w.addItem({id:"insertRight",icon:"iconLayoutRight",label:window.siyuan.languages.insertRight,click(){ma({app:t.app,position:"right",custom:{icon:"iconRiffCard",title:window.siyuan.languages.spaceRepetition,data:{cardsData:t.cardsData,index:e,cardType:s.getAttribute("data-cardtype"),id:f,title:t.title},id:"siyuan-card"}}),t.dialog.destroy()}}),w.addItem({id:"openByNewWindow",icon:"iconOpenWindow",label:window.siyuan.languages.openByNewWindow,click(){const x=[{title:window.siyuan.languages.spaceRepetition,icon:"iconRiffCard",instance:"Tab",children:{instance:"Custom",customModelType:"siyuan-card",customModelData:{cardType:s.getAttribute("data-cardtype"),id:f,title:t.title}}}];ee.ipcRenderer.send(u.SIYUAN_OPEN_WINDOW,{url:`${window.location.protocol}//${window.location.host}/stage/build/app/window.html?v=${u.SIYUAN_VERSION}&json=${encodeURIComponent(JSON.stringify(x))}`}),t.dialog.destroy()}});const _=h.getBoundingClientRect();w.open({x:_.left,y:_.bottom}),l.stopPropagation(),l.preventDefault();return}if(B(r,"data-type","close")){t.dialog&&t.dialog.destroy(),l.stopPropagation(),l.preventDefault();return}const b=B(r,"data-type","filter");if(b){E("/api/riff/getRiffDecks",{},w=>{window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.append(new T({id:"all",iconHTML:"",label:window.siyuan.languages.all,click(){s.setAttribute("data-id",""),s.setAttribute("data-cardtype","all"),o()}}).element),window.siyuan.menus.menu.append(new T({id:"fileTree",iconHTML:"",label:window.siyuan.languages.fileTree,click(){vi((x,S)=>{s.setAttribute("data-id",x[0]==="/"?S[0]:nt(x[0],!0,!0)),s.setAttribute("data-cardtype",x[0]==="/"?"notebook":"doc"),o()},[],void 0,window.siyuan.languages.specifyPath,!0)}}).element),(t.title||w.data.length>0)&&window.siyuan.menus.menu.append(new T({type:"separator"}).element),t.title&&(window.siyuan.menus.menu.append(new T({iconHTML:"",label:pe(t.title),click(){s.setAttribute("data-id",t.id),s.setAttribute("data-cardtype",t.cardType),o()}}).element),w.data.length>0&&window.siyuan.menus.menu.append(new T({type:"separator"}).element)),w.data.forEach(x=>{window.siyuan.menus.menu.append(new T({iconHTML:"",label:pe(x.name),click(){s.setAttribute("data-id",x.id),s.setAttribute("data-cardtype","all"),o()}}).element)});const _=b.getBoundingClientRect();window.siyuan.menus.menu.popup({x:_.left,y:_.bottom})}),l.stopPropagation(),l.preventDefault();return}if(B(r,"data-type","newround")){o(),l.stopPropagation(),l.preventDefault();return}}if(!d){const g=L(r,"b3-button");g&&(d=g.getAttribute("data-type"))}if(!(!d||!c)){if(l.preventDefault(),l.stopPropagation(),Q(["toolbar","hint","util","gutter"],n.protyle),d==="-1")if(a[0].classList.contains("fn__none"))d="3";else{n.protyle.element.classList.remove("card__block--hidemark","card__block--hideli","card__block--hidesb","card__block--hideh"),a[0].classList.add("fn__none"),a[1].querySelectorAll("button.b3-button").forEach((g,p)=>{p<2||(g.previousElementSibling.textContent=c.nextDues[p-1])}),a[1].classList.remove("fn__none"),Sf(t.app,c,d);return}else if(d==="-2"){e>0&&(e--,Lf({countElement:i,editor:n,actionElements:a,index:e,cardsData:t.cardsData}),Sf(t.app,t.cardsData.cards[e+1],d));return}["1","2","3","4","-3"].includes(d)&&a[0].classList.contains("fn__none")&&E(d==="-3"?"/api/riff/skipReviewRiffCard":"/api/riff/reviewRiffCard",{deckID:c.deckID,cardID:c.cardID,rating:parseInt(d),reviewedCards:t.cardsData.cards},()=>{if(e++,e>t.cardsData.cards.length-1){const g=s.getAttribute("data-cardtype");E(g==="all"?"/api/riff/getRiffDueCards":g==="doc"?"/api/riff/getTreeRiffDueCards":"/api/riff/getNotebookRiffDueCards",{rootID:f,deckID:f,notebook:f,reviewedCards:t.cardsData.cards},async p=>{Sf(t.app,t.cardsData.cards[e-1],d),e=0,t.cardsData=p.data;for(let h=0;h<t.app.plugins.length;h++)t.cardsData=await t.app.plugins[h].updateCards(t.cardsData);t.cardsData.cards.length===0?t.cardsData.unreviewedCount>0?pL(i,n,a,p.data.unreviewedCount):Nw(i,n,a):Lf({countElement:i,editor:n,actionElements:a,index:e,cardsData:t.cardsData})});return}Lf({countElement:i,editor:n,actionElements:a,index:e,cardsData:t.cardsData}),Sf(t.app,t.cardsData.cards[e-1],d)})}}),n},Sf=(t,e,n)=>{t.plugins.forEach(a=>{a.eventBus.emit("click-flashcard-action",{type:n,card:e})})},_l=t=>{window.siyuan.config.readonly||E("/api/riff/getRiffDueCards",{deckID:""},e=>{no(t,e.data,"all")})},no=async(t,e,n,a,i)=>{if(window.siyuan.dialogs.find(f=>{if(f.element.getAttribute("data-key")===u.DIALOG_OPENCARD)return f.destroy(),!0}))return;let o;getSelection().rangeCount>0&&(o=getSelection().getRangeAt(0));for(let f=0;f<t.plugins.length;f++)e=await t.plugins[f].updateCards(e);const l=new we({positionId:u.DIALOG_OPENCARD,content:kf({id:a,cardType:n,cardsData:e,isTab:!1}),width:W()?"100vw":"80vw",height:W()?"100vh":"70vh",destroyCallback(){r&&(r.destroy(),window.siyuan.mobile&&(window.siyuan.mobile.popEditor=null)),o&&Z(o)},resizeCallback(f){f!=="d"&&f!=="t"&&r&&r.resize()}});l.element.querySelector(".b3-dialog__scrim").style.backgroundColor="var(--b3-theme-background)",l.element.querySelector(".b3-dialog__container").style.maxWidth="1024px";const r=await Rh({app:t,element:l.element,cardsData:e,title:i,id:a,cardType:n,dialog:l});r.resize(),l.editors={card:r};const d=l.element.querySelector(".block__icons button.block__icon");d.focus();const c=document.createRange();c.selectNodeContents(d),c.collapse(),Z(c),fL()},Lf=t=>{t.editor.protyle.element.classList.remove("fn__none"),t.editor.protyle.element.nextElementSibling.classList.add("fn__none"),t.countElement.innerHTML=Ef(t.cardsData,t.index),t.countElement.classList.remove("fn__none"),t.index===0?(t.actionElements[0].firstElementChild.setAttribute("disabled","disabled"),t.actionElements[1].querySelector(".b3-button").setAttribute("disabled","disabled")):(t.actionElements[0].firstElementChild.removeAttribute("disabled"),t.actionElements[1].querySelector(".b3-button").removeAttribute("disabled")),Pw(t.cardsData.cards[t.index].blockID,t.editor.protyle,B(t.countElement,"data-key",u.DIALOG_OPENCARD),t.cardsData.cards[t.index])},Nw=(t,e,n)=>{t.classList.add("fn__none"),e.protyle.element.classList.add("fn__none");const a=e.protyle.element.nextElementSibling;a.innerHTML=`<div>\u{1F52E}</div>${window.siyuan.languages.noDueCard}`,a.classList.remove("fn__none"),n[0].classList.add("fn__none"),n[1].classList.add("fn__none")},pL=(t,e,n,a)=>{t.classList.add("fn__none"),e.protyle.element.classList.add("fn__none");const i=e.protyle.element.nextElementSibling;i.innerHTML=`<div>\u267B\uFE0F </div>
<span>${window.siyuan.languages.continueReview2.replace("${count}",a)}</span>
<div class="fn__hr"></div>
<button data-type="newround" class="b3-button fn__size200">${window.siyuan.languages.continueReview1}</button>`,i.classList.remove("fn__none"),n[0].classList.add("fn__none"),n[1].classList.add("fn__none")},vl=(t,e,n,a,i)=>{let s=1,o;E(`/api/riff/get${a}RiffCards`,{id:e,page:s},l=>{const r=new we({positionId:u.DIALOG_VIEWCARDS,content:`<div class="fn__flex-column" style="height: 100%">
    <div class="block__icons">
        <span class="fn__flex-1 fn__flex-center resize__move">${pe(n)}</span>
        <span class="fn__space"></span>
        <span data-type="resetAll" class="block__icon block__icon--show b3-tooltips b3-tooltips__w${a===""&&e===""?" fn__none":""}" aria-label="${window.siyuan.languages.reset}"><svg><use xlink:href='#iconUndo'></use></svg></span>
        <span class="fn__space"></span>
        <span data-type="previous" class="block__icon block__icon--show b3-tooltips b3-tooltips__w" disabled="disabled" aria-label="${window.siyuan.languages.previousLabel}"><svg><use xlink:href='#iconLeft'></use></svg></span>
        <span class="fn__space"></span>
        <span data-type="next" class="block__icon block__icon--show b3-tooltips b3-tooltips__w" disabled="disabled" aria-label="${window.siyuan.languages.nextLabel}"><svg><use xlink:href='#iconRight'></use></svg></span>
        <span class="fn__space"></span>
        <span class="fn__flex-center ft__on-surface">${s}/${l.data.pageCount||1}</span>
        <span class="fn__space"></span>
        <span class="counter">${l.data.total}</span>
        ${W()?`<span class="fn__space"></span>
<div data-type="close" class="block__icon block__icon--show">
    <svg><use xlink:href="#iconCloseRound"></use></svg>
</div>`:""}
    </div>
    <div class="${W()?"fn__flex-column":"fn__flex"} fn__flex-1" style="min-height: auto">
        <ul class="fn__flex-1 b3-list b3-list--background" style="user-select: none">
            ${Oh(l.data.blocks,n,a)}
        </ul>
        <div id="cardPreview" style="border-bottom-right-radius:var(--b3-border-radius-b);" class="fn__flex-1 fn__none"></div>
        <div class="fn__flex-1 card__empty">${window.siyuan.languages.emptyContent}</div>
    </div>
</div>`,width:W()?"100vw":"80vw",height:W()?"100vh":"70vh",destroyCallback(){o&&(o.destroy(),window.siyuan.mobile&&(window.siyuan.mobile.popEditor=null))},resizeCallback(g){g!=="d"&&g!=="t"&&o&&o.resize()}});l.data.blocks.length>0&&(o=new aa(t,r.element.querySelector("#cardPreview"),{blockId:"",render:{gutter:!0,breadcrumbDocName:!0}}),window.siyuan.mobile&&(window.siyuan.mobile.popEditor=o),r.editors={card:o},o.resize(),ao(o,r.element.querySelector(".b3-list-item--focus")?.getAttribute("data-id")));const d=r.element.querySelector('[data-type="previous"]'),c=r.element.querySelector('[data-type="next"]'),f=r.element.querySelector(".b3-list--background");l.data.pageCount>1&&c.removeAttribute("disabled"),r.element.setAttribute("data-key",u.DIALOG_VIEWCARDS),r.element.addEventListener("click",g=>{if(typeof g.detail=="string"){let h=f.querySelector(".b3-list-item--focus");if(h){h.classList.remove("b3-list-item--focus"),g.detail==="arrowup"?h=h.previousElementSibling||h.parentElement.lastElementChild:g.detail==="arrowdown"?h=h.nextElementSibling||h.parentElement.firstElementChild:g.detail==="home"?h=h.parentElement.firstElementChild:g.detail==="end"&&(h=h.parentElement.lastElementChild);const m=h.getBoundingClientRect(),b=h.parentElement.getBoundingClientRect();(m.top<b.top||m.bottom>b.bottom)&&h.scrollIntoView(m.top<b.top),ao(o,h.getAttribute("data-id")),h.classList.add("b3-list-item--focus")}g.stopPropagation(),g.preventDefault();return}let p=g.target;for(;p&&!r.element.isSameNode(p);){const h=p.getAttribute("data-type");if(h==="close"){r.destroy(),g.stopPropagation(),g.preventDefault();break}else if(h==="previous"){if(s<=1)return;s--,s<=1&&d.setAttribute("disabled","disabled"),E(`/api/riff/get${a}RiffCards`,{id:e,page:s},m=>{s===m.data.pageCount?c.setAttribute("disabled","disabled"):m.data.pageCount>1&&c.removeAttribute("disabled"),c.nextElementSibling.nextElementSibling.textContent=`${s}/${m.data.pageCount||1}`,f.innerHTML=Oh(m.data.blocks,n,a),f.scrollTop=0,ao(o,r.element.querySelector(".b3-list-item--focus")?.getAttribute("data-id"))}),g.stopPropagation(),g.preventDefault();break}else if(h==="next"){if(s>=l.data.pageCount)return;s++,d.removeAttribute("disabled"),E(`/api/riff/get${a}RiffCards`,{id:e,page:s},m=>{s===m.data.pageCount?c.setAttribute("disabled","disabled"):m.data.pageCount>1&&c.removeAttribute("disabled"),c.nextElementSibling.nextElementSibling.textContent=`${s}/${m.data.pageCount||1}`,f.innerHTML=Oh(m.data.blocks,n,a),f.scrollTop=0,ao(o,r.element.querySelector(".b3-list-item--focus")?.getAttribute("data-id"))}),g.stopPropagation(),g.preventDefault();break}else if(h==="reset"){E("/api/riff/resetRiffCards",{type:a===""?"deck":a.toLowerCase(),deckID:a===""?e:u.QUICK_DECK_ID,id:e,blockIDs:[p.getAttribute("data-id")]},()=>{p.parentElement.querySelector(".ariaLabel.b3-list-item__meta").textContent=Y().format("YYYY-MM-DD")}),g.stopPropagation(),g.preventDefault();break}else if(h==="resetAll"){xe(window.siyuan.languages.reset,window.siyuan.languages.resetCardTip.replace("${x}",r.element.querySelector(".counter").textContent),()=>{E("/api/riff/resetRiffCards",{type:a===""?"deck":a.toLowerCase(),deckID:a===""?e:u.QUICK_DECK_ID,id:e},()=>{r.element.querySelectorAll(".ariaLabel.b3-list-item__meta").forEach(m=>{m.textContent=Y().format("YYYY-MM-DD")})})}),g.stopPropagation(),g.preventDefault();break}else if(h==="card-item"){ao(o,p.getAttribute("data-id")),f.querySelector(".b3-list-item--focus")?.classList.remove("b3-list-item--focus"),p.classList.add("b3-list-item--focus"),g.stopPropagation(),g.preventDefault();break}else if(h==="remove"){E("/api/riff/removeRiffCards",{deckID:a===""?e:u.QUICK_DECK_ID,blockIDs:[p.getAttribute("data-id")]},m=>{let b=p.parentElement.nextElementSibling;b||(b=p.parentElement.previousElementSibling),!b&&p.parentElement.parentElement.childElementCount>1&&(b=p.parentElement.parentElement.firstElementChild),b?(ao(o,b.getAttribute("data-id")),f.querySelector(".b3-list-item--focus")?.classList.remove("b3-list-item--focus"),b.classList.add("b3-list-item--focus"),p.parentElement.remove()):(ao(o,""),f.innerHTML=`<div class="b3-list--empty">${window.siyuan.languages.emptyContent}</div>`),r.element.querySelector(".counter").textContent=(parseInt(r.element.querySelector(".counter").textContent)-1).toString(),i&&i(m)}),g.stopPropagation(),g.preventDefault();break}p=p.parentElement}})})},Oh=(t,e,n)=>{let a="",i=!0;const s=e.split("/");return s.splice(0,1),t.forEach(o=>{if(o.type){let l;n===""?l=$a(o.box)+nt(Lute.UnEscapeHTMLStr(o.hPath),!1):(l=nt(Lute.UnEscapeHTMLStr(o.hPath),!1).replace("/"+s.join("/"),""),l.startsWith("/")&&(l=l.substring(1))),a+=`<div data-type="card-item" class="b3-list-item${i?" b3-list-item--focus":""}${W()?"":" b3-list-item--hide-action"}" data-id="${o.id}">
<svg class="b3-list-item__graphic"><use xlink:href="#${Rn(o.type)}"></use></svg>
${ge(o.ial.icon,"b3-list-item__graphic",!0)}
<span class="b3-list-item__text">${o.content||u.ZWSP}</span>
<span class="${W()||!l?"fn__none ":""}b3-list-item__meta b3-list-item__meta--ellipsis" title="${Xe(l)}">${pe(l)}</span>
<span data-position="parentE" aria-label="${window.siyuan.languages.revisionCount}" class="ariaLabel counter${o.riffCard?.reps===0?" fn__none":""}">${o.riffCard?.reps}</span>
<span data-position="parentE" aria-label="${window.siyuan.languages.nextDue}" class="ariaLabel b3-list-item__meta${o.riffCard?.due?"":" fn__none"}">${Y(o.riffCard?.due).format("YYYY-MM-DD")}</span>
<span data-position="parentE" data-type="reset" data-id="${o.id}" class="b3-list-item__action ariaLabel" aria-label="${window.siyuan.languages.reset}">
    <svg><use xlink:href="#iconUndo"></use></svg>
</span>
<span data-position="parentE" data-type="remove" data-id="${o.id}" class="b3-list-item__action b3-list-item__action--warning ariaLabel" aria-label="${window.siyuan.languages.removeDeck}">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
</span>
</div>`,i=!1}else a+=`<div data-type="card-item" class="b3-list-item${W()?"":" b3-list-item--hide-action"}">
<span class="b3-list-item__text">${o.content}</span>
<span data-position="parentE" data-type="remove" data-id="${o.id}" class="b3-list-item__action b3-list-item__action--warning ariaLabel" aria-label="${window.siyuan.languages.removeDeck}">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
</span>
</div>`}),t.length===0&&(a=`<div class="b3-list--empty">${window.siyuan.languages.emptyContent}</div>`),a},ao=(t,e)=>{if(!e){t.protyle.element.classList.add("fn__none"),t.protyle.element.nextElementSibling.classList.remove("fn__none");return}t.protyle.element.classList.remove("fn__none"),t.protyle.element.nextElementSibling.classList.add("fn__none"),t.protyle.scroll.lastScrollTop=0,ho(t.protyle),E("/api/block/getDocInfo",{id:e},n=>{t.protyle.wysiwyg.renderCustom(n.data.ial),E("/api/filetree/getDoc",{id:e,mode:0,size:u.SIZE_GET_MAX},a=>{rt({updateReadonly:!0,data:a,protyle:t.protyle,action:a.data.rootID===a.data.id?[u.CB_GET_HTML]:[u.CB_GET_ALL,u.CB_GET_HTML]})})})},xf=(t,e,n)=>{t.addEventListener("mousedown",a=>{const i=L(e,"b3-dialog__body")||L(e,"protyle-util");if(!i)return;i.style.userSelect="none",i.style.pointerEvents="none";const s=document;s.ondragstart=()=>!1;const o=a.clientX,l=e.clientWidth,r=i.clientWidth-256;s.onmousemove=d=>{const c=l+(d.clientX-o);c<256||c>r||(e.style.width=c+"px")},s.onmouseup=()=>{i.style.userSelect="auto",i.style.pointerEvents="",s.onmousemove=null,s.onmouseup=null,s.ondragstart=null,s.onselectstart=null,s.onselect=null,n&&(window.siyuan.storage[u.LOCAL_HISTORY][n]=e.clientWidth+"px",ue(u.LOCAL_HISTORY,window.siyuan.storage[u.LOCAL_HISTORY]))}})};let sc,oc=!1;const Af=(t,e,n)=>{const a=t.querySelector('[data-type="docprevious"]'),i=t.querySelector('[data-type="docnext"]');e>1?a.removeAttribute("disabled"):a.setAttribute("disabled","disabled");const s=t.querySelector('.b3-select[data-type="opselect"]'),o=t.querySelector(".b3-list--background");t.querySelector(".protyle-title__input").classList.add("fn__none"),t.querySelector('.history__text[data-type="docPanel"]').classList.add("fn__none"),t.querySelector('.history__text[data-type="mdPanel"]').classList.add("fn__none"),E("/api/history/searchHistory",{query:n,page:e,op:s.value,type:3},l=>{e<l.data.pageCount?i.removeAttribute("disabled"):i.setAttribute("disabled","disabled");const r=t.querySelector('[data-type="jumpRepoPage"]');l.data.pageCount>1?r.removeAttribute("disabled"):r.setAttribute("disabled","disabled"),r.setAttribute("data-totalpage",l.data.pageCount.toString()),r.textContent=e.toString();const d=i.nextElementSibling.nextElementSibling;if(d.classList.remove("fn__none"),d.textContent=window.siyuan.languages.pageCountAndHistoryCount.replace("${x}",l.data.pageCount).replace("${y}",l.data.totalCount),l.data.histories.length===0){o.innerHTML=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;return}let c="";l.data.histories.forEach(f=>{c+=`<li class="b3-list-item b3-list-item--hide-action" data-created="${f}">
    <span class="b3-list-item__text">${Y(parseInt(f)*1e3).format("YYYY-MM-DD HH:mm:ss")}</span>
    <span class="fn__space"></span>
    <span class="b3-list-item__action b3-tooltips b3-tooltips__w" data-type="rollback" aria-label="${window.siyuan.languages.rollback}">
        <svg><use xlink:href="#iconUndo"></use></svg>
    </span>
</li>`}),o.innerHTML=c})},Hw=t=>{const e=`<div class="history__action">
    <div class="block__icons">
        <span data-type="docprevious" class="block__icon block__icon--show b3-tooltips b3-tooltips__e" disabled="disabled" aria-label="${window.siyuan.languages.previousLabel}"><svg><use xlink:href="#iconLeft"></use></svg></span>
        <button class="b3-button b3-button--text ft__selectnone" data-type="jumpRepoPage" disabled>1</button>
        <span data-type="docnext" class="block__icon block__icon--show b3-tooltips b3-tooltips__e" disabled="disabled" aria-label="${window.siyuan.languages.nextLabel}"><svg><use xlink:href="#iconRight"></use></svg></span>
        <span class="fn__space"></span>
        <span class="ft__on-surface fn__flex-shrink ft__selectnone fn__none">${window.siyuan.languages.pageCountAndHistoryCount}</span>
        <span class="fn__space"></span>
        <div class="fn__flex-1"></div>
        <select data-type="opselect" class="b3-select">
            <option value="all" selected>${window.siyuan.languages.allOp}</option>
            <option value="update">${window.siyuan.languages.historyUpdate}</option>
            <option value="format">${window.siyuan.languages.historyFormat}</option>
            <option value="sync">${window.siyuan.languages.historySync}</option>
            <option value="replace">${window.siyuan.languages.historyReplace}</option>
            <option value="outline">${window.siyuan.languages.historyOutline}</option>
        </select>
    </div>
</div>
<div class="fn__flex fn__flex-1 history__panel">
    <ul class="b3-list b3-list--background history__side" ${W()?"":`style="width: ${window.siyuan.storage[u.LOCAL_HISTORY].sideDocWidth}"`}>
        <li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>
    </ul>
    <div class="history__resize"></div>
    <div class="fn__flex-1 fn__flex-column">
        <div class="protyle-title__input fn__none ft__center ft__breakword"></div>
        <textarea class="fn__flex-1 history__text fn__none" readonly data-type="mdPanel"></textarea>
        <div class="fn__flex-1 history__text fn__none" style="padding: 0" data-type="docPanel"></div>
    </div>
</div>`,n=new we({title:t.pathString,content:e,width:W()?"100vw":"90vw",height:W()?"100vh":"80vh",containerClassName:"b3-dialog__container--theme",destroyCallback(){sc=void 0}});n.element.setAttribute("data-key",u.DIALOG_HISTORYDOC);const a=n.element.querySelector(".b3-select");a.addEventListener("change",()=>{Af(n.element,1,t.id)});const i=n.element.querySelector('.history__text[data-type="docPanel"]'),s=n.element.querySelector('.history__text[data-type="mdPanel"]');Af(n.element,1,t.id),sc=new aa(t.app,i,{blockId:"",history:{created:""},action:[u.CB_GET_HISTORY],render:{background:!1,gutter:!1,breadcrumb:!1,breadcrumbDocName:!1},typewriterMode:!1}),Zn(sc.protyle);const o=n.element.querySelector('[data-type="jumpRepoPage"]'),l=n.element.querySelector(".protyle-title__input");n.element.addEventListener("click",r=>{let d=r.target;for(;d&&!d.isEqualNode(n.element);){const c=d.getAttribute("data-type");if(c==="rollback"&&!oc){Rw(d.parentElement,a.value,t.id,f=>{const g=f.path;oc=!1;const p=window.siyuan.languages.rollbackConfirm.replace("${name}",f.title).replace("${time}",d.previousElementSibling.previousElementSibling.textContent.trim());xe("\u26A0\uFE0F "+window.siyuan.languages.rollback,p,()=>{E("/api/history/rollbackDocHistory",{notebook:t.notebookId,historyPath:g})})}),r.stopPropagation(),r.preventDefault();break}else if(d.classList.contains("b3-list-item")&&!oc){Rw(d,a.value,t.id,f=>{const g=f.path;E("/api/history/getDocHistoryContent",{historyPath:g},p=>{p.data.isLargeDoc?(s.value=p.data.content,s.classList.remove("fn__none"),i.classList.add("fn__none")):(s.classList.add("fn__none"),i.classList.remove("fn__none"),rt({data:p,protyle:sc.protyle,action:[u.CB_GET_HISTORY,u.CB_GET_HTML]})),l.textContent=f.title,l.classList.remove("fn__none"),oc=!1}),d.parentElement.querySelector(".b3-list-item--focus")?.classList.remove("b3-list-item--focus"),d.classList.add("b3-list-item--focus")}),r.stopPropagation(),r.preventDefault();break}else if((c==="docprevious"||c==="docnext")&&d.getAttribute("disabled")!=="disabled"){const f=parseInt(o.textContent);Af(n.element,c==="docprevious"?f-1:f+1,t.id),r.stopPropagation(),r.preventDefault();break}else if(c==="jumpRepoPage"){const f=parseInt(d.getAttribute("data-totalpage")||"1");xe(window.siyuan.languages.jumpToPage.replace("${x}",f),`<input class="b3-text-field fn__block" type="number" min="1" max="${f}" value="${o.textContent}">`,g=>{const p=g.element.querySelector(".b3-text-field");p.value!==""&&Af(n.element,Math.max(1,Math.min(parseInt(p.value),f)),t.id)})}d=d.parentElement}}),xf(n.element.querySelector(".history__resize"),n.element.querySelector(".history__side"),"sideDocWidth")},Rw=(t,e,n,a)=>{oc=!0;const i=t.getAttribute("data-path");i&&a(i);const s=t.getAttribute("data-created");sc.protyle.options.history.created=s,E("/api/history/getHistoryItems",{query:n,op:e,type:3,created:s},o=>{a(o.data.items[0])})},lc=t=>`<li data-id="${t.id}" data-name="${Xe(t.name)}" class="b3-list-item b3-list-item--narrow${W()?"":" b3-list-item--hide-action"}">
<span class="b3-list-item__text">
    <span>${pe(t.name)}</span>
    <span class="b3-list-item__meta">${t.size}</span>
</span>
<span data-type="rename" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.rename}">
    <svg><use xlink:href="#iconEdit"></use></svg>
</span>
<span data-type="delete" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.delete}">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
</span>
<span data-type="view" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.cardPreview}">
    <svg><use xlink:href="#iconEye"></use></svg>
</span>
<span data-type="remove" class="b3-list-item__action b3-list-item__action--warning b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.removeDeck}">
    <svg><use xlink:href="#iconMin"></use></svg>
</span>
<span data-type="add" style="display: flex" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.addDeck}">
    <svg><use xlink:href="#iconAdd"></use></svg>
</span>
<span class="b3-list-item__meta${W()?" fn__none":""}">${t.updated}</span>
</li>`,rc=(t,e)=>{window.siyuan.dialogs.find(n=>{if(n.element.getAttribute("data-key")===u.DIALOG_MAKECARD)return Q(["dialog"]),!0}),E("/api/riff/getRiffDecks",{},n=>{let a="";n.data.forEach(s=>{a+=lc(s)});const i=new we({positionId:u.DIALOG_MAKECARD,width:W()?"92vw":"50vw",height:"70vh",title:window.siyuan.languages.riffCard,content:`<div class="b3-dialog__content fn__flex-column" style="box-sizing: border-box;height: 100%">
    <div class="fn__flex">
        <input class="b3-text-field fn__flex-1">
        <span class="fn__space"></span>
        <span data-type="create" class="block__icon block__icon--show b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.createDeck}">
            <svg><use xlink:href="#iconAdd"></use></svg>
        </span>
        <span class="fn__space"></span>
        <span data-type="viewall" class="block__icon block__icon--show b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.cardPreview}">
            <svg><use xlink:href="#iconEye"></use></svg>
        </span>
    </div>
    <div class="fn__hr"></div>
    <ul class="b3-list b3-list--background fn__flex-1">${a}</ul>
</div>`});i.element.setAttribute("data-key",u.DIALOG_MAKECARD),i.element.addEventListener("click",s=>{let o=s.target;for(;o&&!o.isSameNode(i.element);){const l=o.getAttribute("data-type");if(l==="create"){let r="";const d=i.element.querySelector(".b3-text-field");d.value?(r&&Ue(r),E("/api/riff/createRiffDeck",{name:d.value},c=>{i.element.querySelector(".b3-list").insertAdjacentHTML("afterbegin",lc(c.data)),d.value=""})):(r=j(window.siyuan.languages._kernel[142]),d.focus()),s.stopPropagation(),s.preventDefault();break}else if(l==="add"){E("/api/riff/addRiffCards",{deckID:o.parentElement.getAttribute("data-id"),blockIDs:e},r=>{o.parentElement.outerHTML=lc(r.data)}),s.stopPropagation(),s.preventDefault();break}else if(l==="remove"){E("/api/riff/removeRiffCards",{deckID:o.parentElement.getAttribute("data-id"),blockIDs:e},r=>{o.parentElement.outerHTML=lc(r.data)}),s.stopPropagation(),s.preventDefault();break}else if(l==="delete"){xe(window.siyuan.languages.deleteOpConfirm,`${window.siyuan.languages.confirmDelete} <b>${pe(o.parentElement.getAttribute("data-name"))}</b>?`,()=>{E("/api/riff/removeRiffDeck",{deckID:o.parentElement.getAttribute("data-id")},()=>{o.parentElement.remove()})},void 0,!0),s.stopPropagation(),s.preventDefault();break}else if(l==="view"){vl(t,o.parentElement.getAttribute("data-id"),o.parentElement.getAttribute("data-name"),"",r=>{o.parentElement.outerHTML=lc(r.data)}),s.stopPropagation(),s.preventDefault();break}else if(l==="viewall"){vl(t,"",window.siyuan.languages.all,""),s.stopPropagation(),s.preventDefault();break}else if(l==="rename"){const r=new we({title:window.siyuan.languages.rename,content:`<div class="b3-dialog__content"><input class="b3-text-field fn__block" value=""></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:W()?"92vw":"520px"}),d=r.element.querySelector("input"),c=r.element.querySelectorAll(".b3-button");r.bindInput(d,()=>{c[1].click()}),d.value=o.parentElement.getAttribute("data-name"),d.focus(),d.select(),c[0].addEventListener("click",()=>{r.destroy()}),c[1].addEventListener("click",()=>{E("/api/riff/renameRiffDeck",{name:d.value,deckID:o.parentElement.getAttribute("data-id")},()=>{o.parentElement.querySelector(".b3-list-item__text span").textContent=d.value,o.parentElement.setAttribute("data-name",d.value)}),r.destroy()}),s.stopPropagation(),s.preventDefault();break}o=o.parentElement}})})},cc=(t,e)=>{let n=!0;const a=[];e.forEach(i=>{i.getAttribute("data-type")!=="NodeThematicBreak"&&(i.classList.remove("protyle-wysiwyg--select"),a.push(i.getAttribute("data-node-id")),(i.getAttribute(u.CUSTOM_RIFF_DECKS)||"").indexOf(u.QUICK_DECK_ID)===-1&&(n=!1))}),n?U(t,[{action:"removeFlashcards",deckID:u.QUICK_DECK_ID,blockIDs:a}],[{action:"addFlashcards",deckID:u.QUICK_DECK_ID,blockIDs:a}]):U(t,[{action:"addFlashcards",deckID:u.QUICK_DECK_ID,blockIDs:a}],[{action:"removeFlashcards",deckID:u.QUICK_DECK_ID,blockIDs:a}])};class gL{constructor(e=""){this.eventTarget=document.appendChild(document.createComment(e))}on(e,n){this.eventTarget.addEventListener(e,n)}once(e,n){this.eventTarget.addEventListener(e,n,{once:!0})}off(e,n){this.eventTarget.removeEventListener(e,n)}emit(e,n){return this.eventTarget.dispatchEvent(new CustomEvent(e,{detail:n,cancelable:!0}))}}const An=t=>{const e=new aL;t.detail.menu=e,t.plugins.forEach(n=>{n.eventBus.emit(t.type,t.detail)}),e.menus.length>0&&(t.separatorPosition==="top"&&window.siyuan.menus.menu.append(new T({id:"separator_pluginTop",type:"separator"}).element),window.siyuan.menus.menu.append(new T({id:"plugin",label:window.siyuan.languages.plugin,icon:"iconPlugin",type:"submenu",submenu:e.menus}).element),t.separatorPosition==="bottom"&&window.siyuan.menus.menu.append(new T({id:"separator_pluginBottom",type:"separator"}).element))},Bh=(t,e,n,a=!0,i)=>{E("/api/av/searchAttributeView",{keyword:e,excludes:a&&n?[n]:void 0},s=>{let o="";s.data.results.forEach((l,r)=>{o+=`<div class="b3-list-item b3-list-item--narrow${r===0?" b3-list-item--focus":""}" data-av-id="${l.avID}" data-block-id="${l.blockID}">
    <div class="b3-list-item--two fn__flex-1">
        <div class="b3-list-item__first">
            <span class="b3-list-item__text">${pe(l.avName||window.siyuan.languages.title)}</span>
        </div>
        <div class="b3-list-item__meta b3-list-item__showall">${Ka(l.hPath)}</div>
    </div>
    <svg aria-label="${window.siyuan.languages.thisDatabase}" style="margin: 0 0 0 4px" class="b3-list-item__hinticon ariaLabel${l.avID===n?"":" fn__none"}"><use xlink:href="#iconInfo"></use></svg>
</div>`}),t.innerHTML=o,i&&i()})},Ow=(t,e,n)=>{e.dataset.avId=n.dataset.avId,e.dataset.blockId=n.dataset.blockId,e.querySelector(".b3-menu__accelerator").textContent=n.querySelector(".b3-list-item__hinticon").classList.contains("fn__none")?n.querySelector(".b3-list-item__text").textContent:window.siyuan.languages.thisDatabase;const a=L(e,"b3-menu__items");a&&uc(a,t,!0)},dc=(t,e,n,a=!0)=>{window.siyuan.menus.menu.remove();const i=new st;i.addItem({iconHTML:"",type:"empty",label:`<div class="fn__flex-column b3-menu__filter">
    <input class="b3-text-field fn__flex-shrink"/>
    <div class="fn__hr"></div>
    <div class="b3-list fn__flex-1 b3-list--background">
        <img style="margin: 0 auto;display: block;width: 64px;height: 64px" src="/stage/loading-pure.svg">
    </div>
</div>`,bind(o){const l=o.querySelector(".b3-list"),r=o.querySelector("input");r.addEventListener("keydown",d=>{if(d.isComposing)return;if(xn(l,d)&&d.stopPropagation(),d.key==="Enter"){d.preventDefault(),d.stopPropagation();const f=l.querySelector(".b3-list-item--focus");n?n(f):Ow(t,e,f),window.siyuan.menus.menu.remove()}}),r.addEventListener("input",d=>{d.stopPropagation(),!d.isComposing&&Bh(l,r.value,t,a)}),r.addEventListener("compositionend",()=>{Bh(l,r.value,t,a)}),o.lastElementChild.addEventListener("click",d=>{const c=L(d.target,"b3-list-item");c&&(d.stopPropagation(),n?n(c):Ow(t,e,c),window.siyuan.menus.menu.remove())}),Bh(l,"",t,a,()=>{const d=e.getBoundingClientRect();i.open({x:d.left,y:d.bottom,h:d.height}),o.querySelector("input").focus()})}}),i.element.querySelector(".b3-menu__items").setAttribute("style","overflow: initial");const s=Le(e,"block__popover",!0);i.element.setAttribute("data-from",s?s.dataset.level+"popover":"app")},hL=t=>{const e=t.avElement.querySelector('input[data-type="colName"]'),a=t.avElement.querySelector('.b3-menu__item[data-type="goSearchAV"]').getAttribute("data-av-id"),i=t.avElement.querySelector(".b3-menu__item").getAttribute("data-col-id");let s;t.colsData.find(l=>{if(l.id===i)return l.relation||(l.relation={}),s=l,!0});const o=t.avElement.querySelector('[data-type="name"]').value;U(t.protyle,[{action:"updateAttrViewColRelation",avID:t.avID,keyID:i,id:a||s.relation.avID,backRelationKeyID:s.relation.avID===a&&s.relation.backKeyID||Lute.NewNodeID(),isTwoWay:t.avElement.querySelector(".b3-switch").checked,name:e.value,format:o}],[{action:"updateAttrViewColRelation",avID:t.avID,keyID:i,id:s.relation.avID||a,backRelationKeyID:s.relation.backKeyID,isTwoWay:s.relation.isTwoWay,name:e.dataset.oldValue,format:s.name}]),t.avElement.remove(),gn(t.blockElement.querySelector(`.av__row--header .av__cell[data-col-id="${i}"]`),void 0,{name:o}),ae(t.blockElement)},uc=(t,e,n=!1)=>{const a=t.querySelector('.b3-menu__item[data-type="goSearchAV"]'),i=a.nextElementSibling,s=i.querySelector(".b3-switch"),o=i.nextElementSibling,l=o.nextElementSibling,r=JSON.parse(a.dataset.oldValue);if(r.avID){const d=o.querySelector("input");n&&(a.dataset.avId!==r.avID?(d.value="",s.checked=!1):(d.value=d.dataset.oldValue,s.checked=r.isTwoWay)),s.checked?o.classList.remove("fn__none"):o.classList.add("fn__none"),a.dataset.avId&&r.avID!==a.dataset.avId||r.isTwoWay!==s.checked||d.dataset.oldValue!==d.value?l.classList.remove("fn__none"):l.classList.add("fn__none")}else a.dataset.avId&&(s.checked?o.classList.remove("fn__none"):o.classList.add("fn__none"),l.classList.remove("fn__none"))},Na=(t,e,n,a)=>{if(t==="selected")return`<svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>
<span class="b3-menu__label fn__ellipsis ${n?"":" popover__block"}" ${n?"":'style="color:var(--b3-protyle-inline-blockref-color)"'} data-id="${e}">${a}</span>
<svg class="b3-menu__action"><use xlink:href="#iconMin"></use></svg>`;if(t==="empty")return e?`<button class="b3-menu__item" data-type="setRelationCell">
    <span class="b3-menu__label fn__ellipsis">${window.siyuan.languages.newRowInRelation.replace("${x}",a).replace("${y}",e)}</span>
</button>`:`<button class="b3-menu__item">
    <span class="b3-menu__label">${window.siyuan.languages.emptyContent}</span>
</button>`;if(t=="unselect")return`<button data-id="${e}" class="b3-menu__item ariaLabel" data-position="west" data-type="setRelationCell">
    <span class="b3-menu__label fn__ellipsis${n?"":" popover__block"}" ${n?"":'style="color:var(--b3-protyle-inline-blockref-color)"'} data-id="${e}">${a}</span>
    <svg class="b3-menu__action"><use xlink:href="#iconAdd"></use></svg>
</button>`},Bw=(t,e,n)=>{E("/api/av/getAttributeViewPrimaryKeyValues",{id:t.firstElementChild.getAttribute("data-av-id"),keyword:n},a=>{const i=a.data.rows.values||[];let s="",o="";const l=[];e.querySelectorAll(".av__cell--relation").forEach(r=>{const d=r.querySelector(".av__celltext");l.push(d.dataset.id),o+=`<button data-id="${d.dataset.id}" data-position="west" data-type="setRelationCell" 
class="b3-menu__item ariaLabel${d.textContent.indexOf(n)>-1?"":" fn__none"}" 
draggable="true">${Na("selected",d.dataset.id,!d.classList.contains("av__celltext--ref"),Lute.EscapeHTMLStr(d.textContent||window.siyuan.languages.untitled))}</button>`}),i.forEach(r=>{l.includes(r.block.id)||(s+=Na("unselect",r.block.id,r.isDetached,Lute.EscapeHTMLStr(r.block.content||window.siyuan.languages.untitled)))}),t.querySelector(".b3-menu__items").innerHTML=`${o}
<button class="b3-menu__separator"></button>
${s}
${n?Na("empty",Lute.EscapeHTMLStr(n),void 0,t.querySelector(".popover__block").outerHTML):s?"":Na("empty")}`,t.querySelector(".b3-menu__items .b3-menu__item:not(.fn__none)").classList.add("b3-menu__item--current")})},mL=t=>{E("/api/av/getAttributeViewPrimaryKeyValues",{id:t.menuElement.firstElementChild.getAttribute("data-av-id"),keyword:""},e=>{const n=e.data.rows.values||[];let a="",i="";const s=[];t.cellElements[0].querySelectorAll(".av__cell--relation").forEach(c=>{const f=c.querySelector(".av__celltext");s.push(f.dataset.id),i+=`<button data-id="${f.dataset.id}" data-position="west" data-type="setRelationCell" class="b3-menu__item ariaLabel" 
draggable="true">${Na("selected",f.dataset.id,!f.classList.contains("av__celltext--ref"),Lute.EscapeHTMLStr(f.textContent||window.siyuan.languages.untitled))}</button>`}),n.forEach(c=>{s.includes(c.block.id)||(a+=Na("unselect",c.block.id,c.isDetached,Lute.EscapeHTMLStr(c.block.content||window.siyuan.languages.untitled)))}),t.menuElement.querySelector(".b3-menu__items").innerHTML=`${i}
<button class="b3-menu__separator"></button>
${a||Na("empty")}`;const o=t.cellElements[t.cellElements.length-1].getBoundingClientRect();ke(t.menuElement,o.left,o.bottom,o.height),t.menuElement.querySelector(".b3-menu__items .b3-menu__item:not(.fn__none)").classList.add("b3-menu__item--current");const l=t.menuElement.querySelector("input");l.focus();const r=l.parentElement.querySelector(".popover__block");r.innerHTML=Lute.EscapeHTMLStr(e.data.name),r.setAttribute("data-id",e.data.blockIDs[0]);const d=t.menuElement.querySelector(".b3-menu__items");l.addEventListener("keydown",c=>{if(c.isComposing)return;xn(d,c,"b3-menu__item--current");const f=t.menuElement.querySelector(".b3-menu__item--current");c.key==="Enter"&&f&&f.getAttribute("data-type")==="setRelationCell"?(qw(t.protyle,t.blockElement,f,t.cellElements),c.preventDefault(),c.stopPropagation()):c.key==="Escape"&&(t.menuElement.parentElement.remove(),c.preventDefault(),c.stopPropagation())}),l.addEventListener("input",c=>{c.isComposing||(Bw(t.menuElement,t.cellElements[0],l.value),c.stopPropagation())}),l.addEventListener("compositionend",c=>{c.stopPropagation(),Bw(t.menuElement,t.cellElements[0],l.value)})})},bL=(t,e)=>{let n;return t.view.columns.find(a=>{if(a.id===e[0].dataset.colId)return n=a.relation,!0}),n&&n.avID?`<div data-av-id="${n.avID}" class="fn__flex-column">
<div class="b3-menu__item" data-type="nobg">
    <input class="b3-text-field fn__flex-1"/>
    <span class="fn__space"></span>
    <span style="color: var(--b3-protyle-inline-blockref-color);" data-id="" class="popover__block fn__pointer"></span>
</div>
<div class="fn__hr"></div>
<div class="b3-menu__items">
    <img style="margin: 0 auto;display: block;width: 64px;height: 64px" src="/stage/loading-pure.svg">
</div>`:""},qw=(t,e,n,a)=>{const i=L(n,"b3-menu");if(!i||i.querySelector(".dragover__bottom, .dragover__top"))return;const s=L(a[0],"av__row");if(!s)return;e.contains(a[0])||(a[0]=e.querySelector(`.av__row[data-id="${s.dataset.id}"] .av__cell[data-col-id="${a[0].dataset.colId}"]`)||e.querySelector(`.fn__flex-1[data-col-id="${a[0].dataset.colId}"]`));const o={blockIDs:[],contents:[]};if(i.querySelectorAll('[draggable="true"]').forEach(l=>{const r=l.getAttribute("data-id");o.blockIDs.push(r),o.contents.push({type:"block",block:{id:r,content:l.querySelector(".b3-menu__label").textContent},isDetached:!l.querySelector(".popover__block")})}),n.classList.contains("b3-menu__item")){const l=n.getAttribute("data-id"),r=i.querySelector(".b3-menu__separator"),d=i.querySelector("input").value;if(n.getAttribute("draggable")){!r.nextElementSibling.getAttribute("data-id")&&!d&&r.nextElementSibling.remove();const c=o.blockIDs.indexOf(l);o.blockIDs.splice(c,1),o.contents.splice(c,1),r.after(n),n.outerHTML=Na("unselect",l,!n.querySelector(".popover__block"),Lute.EscapeHTMLStr(n.querySelector(".b3-menu__label").textContent))}else if(l)o.blockIDs.push(l),o.contents.push({type:"block",block:{id:l,content:n.firstElementChild.textContent},isDetached:!n.firstElementChild.getAttribute("style")}),r.before(n),n.outerHTML=`<button data-id="${l}" data-position="west" data-type="setRelationCell" class="b3-menu__item ariaLabel" 
draggable="true">${Na("selected",l,!n.querySelector(".popover__block"),Lute.EscapeHTMLStr(n.querySelector(".b3-menu__label").textContent))}</button>`,r.nextElementSibling||r.insertAdjacentHTML("afterend",Na("empty"));else{const c=n.querySelector(".popover__block").getAttribute("data-id"),f=n.querySelector("b").textContent,g=Lute.NewNodeID();U(t,[{action:"insertAttrViewBlock",ignoreFillFilter:!0,avID:i.firstElementChild.getAttribute("data-av-id"),srcs:[{id:g,isDetached:!0,content:f}],blockID:c},{action:"doUpdateUpdated",id:c,data:Y().format("YYYYMMDDHHmmss")}]),o.blockIDs.push(g),o.contents.push({type:"block",block:{id:g,content:f},isDetached:!0}),r.insertAdjacentHTML("beforebegin",`<button data-id="${g}" data-position="west" data-type="setRelationCell" 
class="b3-menu__item ariaLabel" draggable="true">${Na("selected",g,!0,Lute.EscapeHTMLStr(f))}</button>`)}i.querySelector(".b3-menu__item--current")?.classList.remove("b3-menu__item--current"),i.querySelector(".b3-menu__items .b3-menu__item:not(.fn__none)").classList.add("b3-menu__item--current")}Tn(t,e,o,a)},qh=t=>{const e=[];t.forEach(n=>{const a=n.getAttribute("data-node-id");a&&e.push({id:a,isDetached:!1})}),e.length>0&&dc("",t[0],n=>{const a=n.dataset.avId;U(void 0,[{action:"insertAttrViewBlock",avID:a,ignoreFillFilter:!0,srcs:e,blockID:n.dataset.blockId},{action:"doUpdateUpdated",id:n.dataset.blockId,data:Y().format("YYYYMMDDHHmmss")}])})},Cf=(t,e,n)=>{if(e&&t.title?.editElement?.contains(e.startContainer)||n==="title")dc("",t.breadcrumb.element,a=>{const i=a.dataset.avId;U(t,[{action:"insertAttrViewBlock",avID:i,ignoreFillFilter:!0,srcs:[{id:t.block.rootID,isDetached:!1}],blockID:a.dataset.blockId},{action:"doUpdateUpdated",id:a.dataset.blockId,data:Y().format("YYYYMMDDHHmmss")}],[{action:"removeAttrViewBlock",srcIDs:[t.block.rootID],avID:i}]),Z(e)});else{let a;const i=[];if(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").forEach(s=>{a||(a=s),i.push(s.getAttribute("data-node-id"))}),!a){const s=P(e.startContainer);s&&(a=s,i.push(s.getAttribute("data-node-id")))}a||(a=t.wysiwyg.element,i.push(t.block.rootID)),dc("",a,s=>{const o=[],l=[];i.forEach(d=>{o.push(d),l.push({id:d,isDetached:!1})});const r=s.dataset.avId;U(t,[{action:"insertAttrViewBlock",avID:r,ignoreFillFilter:!0,srcs:l,blockID:s.dataset.blockId},{action:"doUpdateUpdated",id:s.dataset.blockId,data:Y().format("YYYYMMDDHHmmss")}],[{action:"removeAttrViewBlock",srcIDs:o,avID:r}]),Z(e)})}},Fw=(t,e)=>{if(!Array.from(t).find(i=>{if(i.getAttribute("data-type")==="navigation-file")return!0}))return window.siyuan.menus.menu;const a=[];if(t.forEach(i=>{const s=i.getAttribute("data-node-id");s&&a.push(s)}),a.length>0&&window.siyuan.menus.menu.append(new T({id:"copy",label:window.siyuan.languages.copy,type:"submenu",icon:"iconCopy",submenu:ls(a).concat([{id:"duplicate",iconHTML:"",label:window.siyuan.languages.duplicate,accelerator:window.siyuan.config.keymap.editor.general.duplicate.custom,click(){a.forEach(i=>{E("/api/filetree/duplicateDoc",{id:i})})}}])}).element),window.siyuan.menus.menu.append(wm(Eh(Array.from(t)))),a.length>0&&window.siyuan.menus.menu.append(new T({id:"addToDatabase",label:window.siyuan.languages.addToDatabase,accelerator:window.siyuan.config.keymap.general.addToDatabase.custom,icon:"iconDatabase",click:()=>{qh(Array.from(t))}}).element),window.siyuan.menus.menu.append(new T({id:"delete",icon:"iconTrashcan",label:window.siyuan.languages.delete,accelerator:"\u2326",click:()=>{_f(Array.from(t))}}).element),a.length===0)return window.siyuan.menus.menu;if(window.siyuan.menus.menu.append(new T({id:"separator_1",type:"separator"}).element),!window.siyuan.config.readonly){const i=[{id:"quickMakeCard",iconHTML:"",accelerator:window.siyuan.config.keymap.editor.general.quickMakeCard.custom,label:window.siyuan.languages.quickMakeCard,click:()=>{U(void 0,[{action:"addFlashcards",deckID:u.QUICK_DECK_ID,blockIDs:a}],[{action:"removeFlashcards",deckID:u.QUICK_DECK_ID,blockIDs:a}])}},{id:"removeCard",iconHTML:"",label:window.siyuan.languages.removeCard,click:()=>{U(void 0,[{action:"removeFlashcards",deckID:u.QUICK_DECK_ID,blockIDs:a}],[{action:"addFlashcards",deckID:u.QUICK_DECK_ID,blockIDs:a}])}}];window.siyuan.config.flashcard.deck&&i.push({id:"addToDeck",iconHTML:"",label:window.siyuan.languages.addToDeck,click:()=>{rc(e,a)}}),window.siyuan.menus.menu.append(new T({id:"riffCard",label:window.siyuan.languages.riffCard,icon:"iconRiffCard",submenu:i}).element),window.siyuan.menus.menu.append(new T({id:"separator_2",type:"separator"}).element)}return Ah(e,a),window.siyuan.menus.menu.append(new T({id:"export",label:window.siyuan.languages.export,type:"submenu",icon:"iconUpload",submenu:[{id:"exportMarkdown",label:"Markdown",icon:"iconMarkdown",click:()=>{const i=j(window.siyuan.languages.exporting,-1);E(" /api/export/exportMds",{ids:a},s=>{Ue(i),Ht(s.data.zip)})}}]}).element),e.plugins&&An({plugins:e.plugins,type:"open-menu-doctree",detail:{elements:t,type:"docs"},separatorPosition:"top"}),window.siyuan.menus.menu},Tf=(t,e)=>{window.siyuan.menus.menu.remove();const n=q(e,"DIV");if(!n)return window.siyuan.menus.menu;e.classList.contains("b3-list-item--focus")||(n.querySelectorAll(".b3-list-item--focus").forEach(o=>{o.classList.remove("b3-list-item--focus"),o.removeAttribute("select-end"),o.removeAttribute("select-start")}),e.classList.add("b3-list-item--focus"));const a=n.querySelectorAll(".b3-list-item--focus");if(a.length>1)return Fw(a,t);const i=e.parentElement.getAttribute("data-url"),s=$a(i);if(!window.siyuan.config.readonly){window.siyuan.menus.menu.append(B_({path:"/",notebookId:i,name:s,type:"notebook"})),window.siyuan.menus.menu.append(new T({id:"config",label:window.siyuan.languages.config,icon:"iconSettings",click:()=>{E("/api/notebook/getNotebookConf",{notebook:i},l=>{uL(l.data)})}}).element);const o=Uw("notebook",parseInt(e.parentElement.getAttribute("data-sortmode")),l=>(E("/api/notebook/setNotebookConf",{notebook:i,conf:{sortMode:l}},()=>{e.parentElement.setAttribute("data-sortmode",l.toString());let r;r=Qe("file").data.file;const d=e.querySelector(".b3-list-item__arrow--open");d&&(d.classList.remove("b3-list-item__arrow--open"),e.nextElementSibling?.remove(),r.getLeaf(e,i))}),!0));window.siyuan.menus.menu.append(new T({id:"sort",icon:"iconSort",label:window.siyuan.languages.sort,type:"submenu",submenu:o}).element)}return window.siyuan.config.readonly||window.siyuan.menus.menu.append(new T({id:"riffCard",label:window.siyuan.languages.riffCard,type:"submenu",icon:"iconRiffCard",submenu:[{id:"spaceRepetition",iconHTML:"",label:window.siyuan.languages.spaceRepetition,accelerator:window.siyuan.config.keymap.editor.general.spaceRepetition.custom,click:()=>{E("/api/riff/getNotebookRiffDueCards",{notebook:i},o=>{no(t,o.data,"notebook",i,s)})}},{id:"manage",iconHTML:"",label:window.siyuan.languages.manage,click:()=>{vl(t,i,s,"Notebook")}}]}).element),window.siyuan.menus.menu.append(new T({id:"search",label:window.siyuan.languages.search,accelerator:window.siyuan.config.keymap.general.search.custom,icon:"iconSearch",click(){wn({app:t,hotkey:u.DIALOG_SEARCH,notebookId:i})}}).element),window.siyuan.config.readonly||window.siyuan.menus.menu.append(new T({id:"replace",label:window.siyuan.languages.replace,accelerator:window.siyuan.config.keymap.general.replace.custom,icon:"iconReplace",click(){wn({app:t,hotkey:u.DIALOG_REPLACE,notebookId:i})}}).element),window.siyuan.config.readonly||(window.siyuan.menus.menu.append(new T({id:"separator_1",type:"separator"}).element),window.siyuan.menus.menu.append(new T({id:"close",label:window.siyuan.languages.close,icon:"iconClose",click:()=>{E("/api/notebook/closeNotebook",{notebook:i})}}).element),window.siyuan.menus.menu.append(new T({id:"delete",icon:"iconTrashcan",label:window.siyuan.languages.delete,accelerator:"\u2326",click:()=>{_f(Array.from(n.querySelectorAll(".b3-list-item--focus")))}}).element)),window.siyuan.menus.menu.append(new T({id:"separator_2",type:"separator"}).element),window.siyuan.menus.menu.append(new T({id:"showInFolder",icon:"iconFolder",label:window.siyuan.languages.showInFolder,click:()=>{ee.shell.openPath(Ft.join(window.siyuan.config.system.dataDir,i))}}).element),Fh(i,"/"),window.siyuan.menus.menu.append(new T({id:"export",label:window.siyuan.languages.export,type:"submenu",icon:"iconUpload",submenu:[{id:"exportMarkdown",label:"Markdown",icon:"iconMarkdown",click:()=>{const o=j(window.siyuan.languages.exporting,-1);E("/api/export/exportNotebookMd",{notebook:i},l=>{Ue(o),Ht(l.data.zip)})}},{id:"exportSiYuanZip",label:"SiYuan .sy.zip",icon:"iconSiYuan",click:()=>{const o=j(window.siyuan.languages.exporting,-1);E("/api/export/exportNotebookSY",{id:i},l=>{Ue(o),Ht(l.data.zip)})}}]}).element),t.plugins&&An({plugins:t.plugins,type:"open-menu-doctree",detail:{elements:a,type:"notebook"},separatorPosition:"top"}),window.siyuan.menus.menu},If=(t,e,n,a)=>{window.siyuan.menus.menu.remove();const i=q(a,"DIV");if(!i)return window.siyuan.menus.menu;a.classList.contains("b3-list-item--focus")||(i.querySelectorAll(".b3-list-item--focus").forEach(r=>{r.classList.remove("b3-list-item--focus"),r.removeAttribute("select-end"),r.removeAttribute("select-start")}),a.classList.add("b3-list-item--focus"));const s=i.querySelectorAll(".b3-list-item--focus");if(s.length>1)return Fw(s,t);const o=a.getAttribute("data-node-id");let l=a.getAttribute("data-name");if(l=nt(l,!1,!0),!window.siyuan.config.readonly){const r=fe(a,"UL");if((window.siyuan.config.fileTree.sort===6||r&&r.dataset.sortmode==="6")&&(window.siyuan.menus.menu.append(new T({id:"newDocAbove",icon:"iconBefore",label:window.siyuan.languages.newDocAbove,click:()=>{const d=[];Array.from(a.parentElement.children).forEach(c=>{c.tagName==="LI"&&(c.isSameNode(a)&&d.push(void 0),d.push(c.getAttribute("data-path")))}),xi({app:t,notebookId:e,currentPath:Ee().dirname(n),paths:d,useSavePath:!1,listDocTree:!0})}}).element),window.siyuan.menus.menu.append(new T({id:"newDocBelow",icon:"iconAfter",label:window.siyuan.languages.newDocBelow,click:()=>{const d=[];Array.from(a.parentElement.children).forEach(c=>{c.tagName==="LI"&&(d.push(c.getAttribute("data-path")),c.isSameNode(a)&&d.push(void 0))}),xi({app:t,notebookId:e,currentPath:Ee().dirname(n),paths:d,useSavePath:!1,listDocTree:!0})}}).element),window.siyuan.menus.menu.append(new T({id:"separator_1",type:"separator"}).element)),window.siyuan.menus.menu.append(new T({id:"copy",label:window.siyuan.languages.copy,type:"submenu",icon:"iconCopy",submenu:ls([o]).concat([{id:"duplicate",iconHTML:"",label:window.siyuan.languages.duplicate,accelerator:window.siyuan.config.keymap.editor.general.duplicate.custom,click(){E("/api/filetree/duplicateDoc",{id:o})}}])}).element),window.siyuan.menus.menu.append(wm(Eh(Array.from(i.querySelectorAll(".b3-list-item--focus"))))),window.siyuan.menus.menu.append(new T({id:"addToDatabase",label:window.siyuan.languages.addToDatabase,accelerator:window.siyuan.config.keymap.general.addToDatabase.custom,icon:"iconDatabase",click:()=>{qh([a])}}).element),window.siyuan.menus.menu.append(new T({id:"delete",icon:"iconTrashcan",label:window.siyuan.languages.delete,accelerator:"\u2326",click:()=>{_f(Array.from(i.querySelectorAll(".b3-list-item--focus")))}}).element),window.siyuan.menus.menu.append(new T({id:"separator_2",type:"separator"}).element),window.siyuan.menus.menu.append(B_({path:n,notebookId:e,name:l,type:"file"})),window.siyuan.menus.menu.append(new T({id:"attr",label:window.siyuan.languages.attr,icon:"iconAttr",click(){E("/api/block/getDocInfo",{id:o},d=>{Gn(d.data.ial)})}}).element),!window.siyuan.config.readonly){const d=[{id:"spaceRepetition",iconHTML:"",label:window.siyuan.languages.spaceRepetition,accelerator:window.siyuan.config.keymap.editor.general.spaceRepetition.custom,click:()=>{E("/api/riff/getTreeRiffDueCards",{rootID:o},c=>{no(t,c.data,"doc",o,l)})}},{id:"manage",iconHTML:"",label:window.siyuan.languages.manage,click:()=>{E("/api/filetree/getHPathByID",{id:o},c=>{vl(t,o,Ee().join($a(e),c.data),"Tree")})}},{id:"quickMakeCard",iconHTML:"",accelerator:window.siyuan.config.keymap.editor.general.quickMakeCard.custom,label:window.siyuan.languages.quickMakeCard,click:()=>{U(void 0,[{action:"addFlashcards",deckID:u.QUICK_DECK_ID,blockIDs:[o]}],[{action:"removeFlashcards",deckID:u.QUICK_DECK_ID,blockIDs:[o]}])}},{id:"removeCard",iconHTML:"",label:window.siyuan.languages.removeCard,click:()=>{U(void 0,[{action:"removeFlashcards",deckID:u.QUICK_DECK_ID,blockIDs:[o]}],[{action:"addFlashcards",deckID:u.QUICK_DECK_ID,blockIDs:[o]}])}}];window.siyuan.config.flashcard.deck&&d.push({id:"addToDeck",iconHTML:"",label:window.siyuan.languages.addToDeck,click:()=>{rc(t,[o])}}),window.siyuan.menus.menu.append(new T({id:"riffCard",label:window.siyuan.languages.riffCard,type:"submenu",icon:"iconRiffCard",submenu:d}).element)}window.siyuan.menus.menu.append(new T({id:"search",label:window.siyuan.languages.search,icon:"iconSearch",accelerator:window.siyuan.config.keymap.general.search.custom,async click(){const d=nt(n,!1,!0);wn({app:t,hotkey:u.DIALOG_SEARCH,notebookId:e,searchPath:d})}}).element),window.siyuan.menus.menu.append(new T({id:"replace",label:window.siyuan.languages.replace,accelerator:window.siyuan.config.keymap.general.replace.custom,icon:"iconReplace",async click(){const d=nt(n,!1,!0);wn({app:t,hotkey:u.DIALOG_REPLACE,notebookId:e,searchPath:d})}}).element),window.siyuan.menus.menu.append(new T({id:"separator_3",type:"separator"}).element)}return Ah(t,[o],e,n),window.siyuan.config.readonly||window.siyuan.menus.menu.append(new T({id:"fileHistory",label:window.siyuan.languages.fileHistory,icon:"iconHistory",click(){Hw({app:t,id:o,notebookId:e,pathString:l})}}).element),Fh(e,n),window.siyuan.menus.menu.append(O_(o)),t.plugins&&An({plugins:t.plugins,type:"open-menu-doctree",detail:{elements:s,type:"doc"},separatorPosition:"top"}),window.siyuan.menus.menu.element.setAttribute("data-name","docTreeMore"),window.siyuan.menus.menu},Fh=(t,e)=>{if(window.siyuan.config.readonly)return;const n=()=>{let i;i=Qe("file").data.file;const s=i.element.querySelector(`[data-path="${e}"]`);s.querySelector(".b3-list-item__toggle").classList.remove("fn__hidden"),i.getLeaf(s,t,!0),window.siyuan.menus.menu.remove()},a=(i,s)=>({id:s?"importMarkdownDoc":"importMarkdownFolder",icon:s?"iconMarkdown":"iconFolder",label:i,click:async()=>{let o=[];s&&(o=[{name:"Markdown",extensions:["md","markdown"]}]);const l=await ee.ipcRenderer.invoke(u.SIYUAN_GET,{cmd:"showOpenDialog",defaultPath:window.siyuan.config.system.homeDir,filters:o,properties:[s?"openFile":"openDirectory"]});l.filePaths.length!==0&&E("/api/import/importStdMd",{notebook:t,localPath:l.filePaths[0],toPath:e},()=>{n()})}});window.siyuan.menus.menu.append(new T({id:"import",icon:"iconDownload",label:window.siyuan.languages.import,submenu:[{id:"importSiYuanZip",icon:"iconSiYuan",label:'SiYuan .sy.zip<input class="b3-form__upload" type="file" accept="application/zip">',bind:i=>{i.querySelector(".b3-form__upload").addEventListener("change",s=>{const o=new FormData;o.append("file",s.target.files[0]),o.append("notebook",t),o.append("toPath",e),E("/api/import/importSY",o,()=>{n()})})}},a("Markdown "+window.siyuan.languages.doc,!0),a("Markdown "+window.siyuan.languages.folder)]}).element)},Uw=(t,e,n)=>{const a=[{id:"fileNameASC",icon:e===0?"iconSelect":void 0,label:window.siyuan.languages.fileNameASC,click:()=>{n(0)}},{id:"fileNameDESC",icon:e===1?"iconSelect":void 0,label:window.siyuan.languages.fileNameDESC,click:()=>{n(1)}},{id:"fileNameNatASC",icon:e===4?"iconSelect":void 0,label:window.siyuan.languages.fileNameNatASC,click:()=>{n(4)}},{id:"fileNameNatDESC",icon:e===5?"iconSelect":void 0,label:window.siyuan.languages.fileNameNatDESC,click:()=>{n(5)}},{id:"separator_1",type:"separator"},{id:"createdASC",icon:e===9?"iconSelect":void 0,label:window.siyuan.languages.createdASC,click:()=>{n(9)}},{id:"createdDESC",icon:e===10?"iconSelect":void 0,label:window.siyuan.languages.createdDESC,click:()=>{n(10)}},{id:"modifiedASC",icon:e===2?"iconSelect":void 0,label:window.siyuan.languages.modifiedASC,click:()=>{n(2)}},{id:"modifiedDESC",icon:e===3?"iconSelect":void 0,label:window.siyuan.languages.modifiedDESC,click:()=>{n(3)}},{id:"separator_2",type:"separator"},{id:"refCountASC",icon:e===7?"iconSelect":void 0,label:window.siyuan.languages.refCountASC,click:()=>{n(7)}},{id:"refCountDESC",icon:e===8?"iconSelect":void 0,label:window.siyuan.languages.refCountDESC,click:()=>{n(8)}},{id:"separator_3",type:"separator"},{id:"docSizeASC",icon:e===11?"iconSelect":void 0,label:window.siyuan.languages.docSizeASC,click:()=>{n(11)}},{id:"docSizeDESC",icon:e===12?"iconSelect":void 0,label:window.siyuan.languages.docSizeDESC,click:()=>{n(12)}},{id:"separator_4",type:"separator"},{id:"subDocCountASC",icon:e===13?"iconSelect":void 0,label:window.siyuan.languages.subDocCountASC,click:()=>{n(13)}},{id:"subDocCountDESC",icon:e===14?"iconSelect":void 0,label:window.siyuan.languages.subDocCountDESC,click:()=>{n(14)}},{id:"separator_5",type:"separator"},{id:"customSort",icon:e===6?"iconSelect":void 0,label:window.siyuan.languages.customSort,click:()=>{n(6)}}];return t==="notebook"&&a.push({id:"sortByFiletree",icon:e===15?"iconSelect":void 0,label:window.siyuan.languages.sortByFiletree,click:()=>{n(15)}}),a},Df=(t,e)=>{E("/api/filetree/createDailyNote",{notebook:e,app:u.SIYUAN_APPID},n=>{de({app:t,id:n.data.id,action:[u.CB_GET_FOCUS]})})},Uh=t=>{if(window.siyuan.dialogs.find(s=>{if(s.element.getAttribute("data-key")===u.DIALOG_DIALYNOTE)return s.destroy(),!0}))return;const n=Lh();if(n===0){j(window.siyuan.languages.newFileTip);return}if(n===1){let s="";window.siyuan.notebooks.find(o=>{o.closed||(s=o.id)}),Df(t,s);return}const a=window.siyuan.storage[u.LOCAL_DAILYNOTEID],i=window.siyuan.notebooks.find(s=>{if(s.id===a&&!s.closed)return!0});if(a&&i&&!W())Df(t,a);else{let s="";window.siyuan.notebooks.forEach(d=>{d.closed||(s+=`<option value="${d.id}">${d.name}</option>`)});const o=new we({positionId:u.DIALOG_DIALYNOTE,title:window.siyuan.languages.plsChoose,content:`<div class="b3-dialog__content">
    <select class="b3-select fn__block">${s}</select>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:W()?"92vw":"520px"});o.element.setAttribute("data-key",u.DIALOG_DIALYNOTE);const l=o.element.querySelectorAll(".b3-button"),r=o.element.querySelector(".b3-select");r.value=a,l[0].addEventListener("click",()=>{o.destroy()}),l[1].addEventListener("click",()=>{const d=r.value;window.siyuan.storage[u.LOCAL_DAILYNOTEID]=d,ue(u.LOCAL_DAILYNOTEID,window.siyuan.storage[u.LOCAL_DAILYNOTEID]),Df(t,d),o.destroy()})}},$f=()=>{const t=u.HELP_PATH[window.siyuan.config.appearance.lang];E("/api/notebook/removeNotebook",{notebook:t,callback:u.CB_MOUNT_REMOVE},()=>{E("/api/notebook/openNotebook",{notebook:t,app:u.SIYUAN_APPID})})},Ww=()=>{const t=new we({title:window.siyuan.languages.newNotebook,content:`<div class="b3-dialog__content">
    <input placeholder="${window.siyuan.languages.notebookName}" class="b3-text-field fn__block">
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:W()?"92vw":"520px"});t.element.setAttribute("data-key",u.DIALOG_CREATENOTEBOOK);const e=t.element.querySelectorAll(".b3-button");t.bindInput(t.element.querySelector("input"),()=>{e[1].dispatchEvent(new CustomEvent("click"))}),e[0].addEventListener("click",()=>{t.destroy()}),e[1].addEventListener("click",()=>{const n=t.element.querySelector("input").value;if(!pf(n))return!1;E("/api/notebook/createNotebook",{name:n}),t.destroy()})};class Li extends Vn{constructor(e){super({app:e.app,type:"filetree",id:e.tab.id,msgCallback(a){if(a)switch(a.cmd){case"reloadDocInfo":this.updateDocInfo(a);break;case"moveDoc":this.onMove(a);break;case"reloadFiletree":Ei(()=>{this.init(!1)});break;case"mount":this.onMount(a),e.app.plugins.forEach(i=>{i.eventBus.emit("opened-notebook",a)});break;case"createnotebook":Ei(i=>{let s;i.find(o=>{if(!o.closed){if(o.id===a.data.box.id)return s?this.element.querySelector(`.b3-list[data-url="${s}"]`).insertAdjacentHTML("afterend",this.genNotebook(a.data.box)):this.element.insertAdjacentHTML("afterbegin",this.genNotebook(a.data.box)),!0;s=o.id}})});break;case"unmount":this.onRemove(a),e.app.plugins.forEach(i=>{i.eventBus.emit("closed-notebook",a)});break;case"removeDoc":this.onRemove(a);break;case"create":a.data.listDocTree?this.selectItem(a.data.box.id,a.data.path):this.updateItemArrow(a.data.box.id,a.data.path);break;case"createdailynote":case"heading2doc":case"li2doc":this.selectItem(a.data.box.id,a.data.path);break;case"renamenotebook":this.element.querySelector(`[data-url="${a.data.box}"] .b3-list-item__text`).innerHTML=pe(a.data.name);break;case"rename":this.onRename(a.data);break}}}),e.tab.panelElement.classList.add("fn__flex-column","file-tree","sy__file"),e.tab.panelElement.innerHTML=`<div class="block__icons">
    <div class="block__logo">
        <svg class="block__logoicon"><use xlink:href="#iconFiles"></use></svg>${window.siyuan.languages.fileTree}
    </div>
    <span class="fn__flex-1 fn__space"></span>
    <span data-type="focus" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.selectOpen1} ${X(window.siyuan.config.keymap.general.selectOpen1.custom)}"><svg><use xlink:href='#iconFocus'></use></svg></span>
    <span class="fn__space"></span>
    <span data-type="collapse" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.collapse} ${X(window.siyuan.config.keymap.editor.general.collapse.custom)}">
        <svg><use xlink:href="#iconContract"></use></svg>
    </span>
    <div class="fn__space${window.siyuan.config.readonly?" fn__none":""}"></div>
    <div data-type="more" class="b3-tooltips b3-tooltips__sw block__icon${window.siyuan.config.readonly?" fn__none":""}" aria-label="${window.siyuan.languages.more}">
        <svg><use xlink:href="#iconMore"></use></svg>
    </div> 
    <span class="fn__space"></span>
    <span data-type="min" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.min} ${X(window.siyuan.config.keymap.general.closeTab.custom)}"><svg><use xlink:href='#iconMin'></use></svg></span>
</div>
<div class="fn__flex-1" style="padding-top: 2px;"></div>
<ul class="b3-list fn__flex-column" style="min-height: auto;height:30px;transition: height  .2s cubic-bezier(0, 0, .2, 1) 0ms">
    <li class="b3-list-item" data-type="toggle">
        <span class="b3-list-item__toggle">
            <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
        </span>
        <span class="b3-list-item__text">${window.siyuan.languages.closeNotebook}</span>
        <span class="counter fn__none" style="cursor: auto"></span>
    </li>
    <ul class="fn__none fn__flex-1"></ul>
</ul>`,this.actionsElement=e.tab.panelElement.firstElementChild,this.element=this.actionsElement.nextElementSibling,this.closeElement=e.tab.panelElement.lastElementChild,this.closeElement.addEventListener("click",a=>{tt(this.element.parentElement);let i=a.target;for(;i&&!i.isEqualNode(this.closeElement);){const s=i.getAttribute("data-type");if(i.classList.contains("b3-list-item__icon")){a.preventDefault(),a.stopPropagation();const o=i.getBoundingClientRect();Za(i.parentElement.getAttribute("data-url"),"notebook",{x:o.left,y:o.bottom,h:o.height,w:o.width},void 0,i.querySelector("img"));break}else if(s==="toggle"){const o=i.querySelector("svg");o.classList.contains("b3-list-item__arrow--open")?(this.closeElement.style.height="30px",o.classList.remove("b3-list-item__arrow--open"),this.closeElement.lastElementChild.classList.add("fn__none")):(this.closeElement.style.height="40%",o.classList.add("b3-list-item__arrow--open"),this.closeElement.lastElementChild.classList.remove("fn__none")),window.siyuan.menus.menu.remove(),a.stopPropagation(),a.preventDefault();break}else if(s==="remove"){xe(window.siyuan.languages.deleteOpConfirm,`${window.siyuan.languages.confirmDelete} <b>${pe(i.parentElement.querySelector(".b3-list-item__text").textContent)}</b>?`,()=>{E("/api/notebook/removeNotebook",{notebook:i.getAttribute("data-url"),callback:u.CB_MOUNT_REMOVE})},void 0,!0),window.siyuan.menus.menu.remove(),a.stopPropagation(),a.preventDefault();break}else if(s==="open"){E("/api/notebook/openNotebook",{notebook:i.getAttribute("data-url")}),window.siyuan.menus.menu.remove(),a.stopPropagation(),a.preventDefault();break}i=i.parentElement}}),this.actionsElement.querySelector('[data-type="collapse"]').addEventListener("click",()=>{Array.from(this.element.children).forEach(a=>{const i=a.firstElementChild,s=i.querySelector(".b3-list-item__arrow");s.classList.contains("b3-list-item__arrow--open")&&(s.classList.remove("b3-list-item__arrow--open"),i.nextElementSibling.remove())}),window.siyuan.storage[u.LOCAL_FILESPATHS]=[],ue(u.LOCAL_FILESPATHS,[])}),this.actionsElement.addEventListener("click",a=>{let i=a.target;for(;i&&!i.isEqualNode(this.actionsElement);){const s=i.getAttribute("data-type");if(s==="min"){Qe("file").toggleModel("file",!1,!0),a.preventDefault(),a.stopPropagation(),window.siyuan.menus.menu.remove();break}else if(s==="focus"){let o=document.querySelector(".layout__wnd--active > .fn__flex > .layout-tab-bar > .item--focus");if(o||document.querySelectorAll("ul.layout-tab-bar > .item--focus").forEach((l,r)=>{(r===0||l.dataset.activetime>o.dataset.activetime)&&(o=l)}),o){const l=Bt(o.getAttribute("data-id"));l&&l.model instanceof ht&&this.selectItem(l.model.editor.protyle.notebookId,l.model.editor.protyle.path)}a.preventDefault();break}else if(s==="more"){this.initMoreMenu().popup({x:a.clientX,y:a.clientY}),a.preventDefault(),a.stopPropagation();break}i=i.parentElement}tt(this.element.parentElement)}),this.element.addEventListener("mousedown",a=>{if(a.button!==1||!window.siyuan.config.fileTree.openFilesUseCurrentTab)return;let i=a.target;for(;i&&!i.isEqualNode(this.element);){if(i.tagName==="LI"&&!i.getAttribute("data-opening")){i.setAttribute("data-opening","true"),de({app:e.app,removeCurrentTab:!1,id:i.getAttribute("data-node-id"),action:[u.CB_GET_FOCUS,u.CB_GET_SCROLL],afterOpen(){i.removeAttribute("data-opening")}}),a.stopPropagation(),a.preventDefault();break}i=i.parentElement}}),this.element.addEventListener("click",a=>{let i=a.target;const s=fe(i,"UL");let o=!0;if(s){const l=s.getAttribute("data-url");for(;i&&!i.isEqualNode(this.element);){if(qe(a)&&i.classList.contains("b3-list-item__icon")&&window.siyuan.config.system.container!=="ios"){a.preventDefault(),a.stopPropagation();const r=i.getBoundingClientRect();i.parentElement.getAttribute("data-type")==="navigation-file"?Za(i.parentElement.getAttribute("data-node-id"),"doc",{x:r.left,y:r.bottom,h:r.height,w:r.width},void 0,i.querySelector("img")):Za(i.parentElement.parentElement.getAttribute("data-url"),"notebook",{x:r.left,y:r.bottom,h:r.height,w:r.width},void 0,i.querySelector("img"));break}else if(qe(a)&&i.classList.contains("b3-list-item__toggle")){this.getLeaf(i.parentElement,l),a.preventDefault(),a.stopPropagation(),window.siyuan.menus.menu.remove();break}else if(qe(a)&&i.classList.contains("b3-list-item__action")){const r=i.getAttribute("data-type"),d=i.parentElement.getAttribute("data-path");window.siyuan.config.readonly||(r==="new"?xi({app:e.app,notebookId:l,currentPath:d,useSavePath:!1,listDocTree:!0}):r==="more-root"&&Tf(e.app,i.parentElement).popup({x:a.clientX,y:a.clientY})),r==="more-file"&&If(e.app,l,d,i.parentElement).popup({x:a.clientX,y:a.clientY}),a.preventDefault(),a.stopPropagation();break}else if(i.tagName==="LI"){if(Dt(a)&&!a.altKey&&!a.shiftKey)i.classList.toggle("b3-list-item--focus");else if(this.setCurrent(i,!1),i.getAttribute("data-type")==="navigation-file"){if(o=!1,i.getAttribute("data-opening"))return;i.setAttribute("data-opening","true"),a.altKey&&qe(a)&&!a.shiftKey?de({app:e.app,id:i.getAttribute("data-node-id"),position:"right",action:[u.CB_GET_FOCUS,u.CB_GET_SCROLL],afterOpen(){i.removeAttribute("data-opening")}}):!a.altKey&&qe(a)&&a.shiftKey?de({app:e.app,id:i.getAttribute("data-node-id"),position:"bottom",action:[u.CB_GET_FOCUS,u.CB_GET_SCROLL],afterOpen(){i.removeAttribute("data-opening")}}):window.siyuan.config.fileTree.openFilesUseCurrentTab&&a.altKey&&Dt(a)&&!a.shiftKey?de({app:e.app,removeCurrentTab:!1,id:i.getAttribute("data-node-id"),action:[u.CB_GET_FOCUS,u.CB_GET_SCROLL],afterOpen(){i.removeAttribute("data-opening")}}):de({app:e.app,id:i.getAttribute("data-node-id"),action:[u.CB_GET_FOCUS,u.CB_GET_SCROLL],afterOpen(){i.removeAttribute("data-opening")}})}else i.getAttribute("data-type")==="navigation-root"&&this.getLeaf(i,l);this.element.querySelector('[select-end="true"]')?.removeAttribute("select-end"),this.element.querySelector('[select-start="true"]')?.removeAttribute("select-start"),window.siyuan.menus.menu.remove(),a.stopPropagation(),a.preventDefault();break}i=i.parentElement}}o&&tt(this.element.parentElement)}),this.element.addEventListener("dragstart",a=>{if(St()){a.stopPropagation(),a.preventDefault();return}window.getSelection().removeAllRanges(),Zt();const i=q(a.target,"LI");if(i){let s=Array.from(this.element.querySelectorAll(".b3-list-item--focus"));i.classList.contains("b3-list-item--focus")||(s.forEach(r=>{r.classList.remove("b3-list-item--focus")}),i.classList.add("b3-list-item--focus"),s=[i]);let o="";const l=document.createElement("ul");s.forEach((r,d)=>{l.append(r.cloneNode(!0)),r.style.opacity="0.1";const c=r.dataset.nodeId||r.dataset.path;c&&(o+=c,d<s.length-1&&(o+=","))}),l.setAttribute("style",`width: 219px;position: fixed;top:-${s.length*30}px`),l.setAttribute("class","b3-list b3-list--background"),document.body.append(l),a.dataTransfer.setDragImage(l,16,16),a.dataTransfer.setData(u.SIYUAN_DROP_FILE,o),a.dataTransfer.dropEffect="move",window.siyuan.dragElement=document.createElement("div"),window.siyuan.dragElement.innerText=o,setTimeout(()=>{l.remove()})}}),this.element.addEventListener("dragend",()=>{this.element.querySelectorAll(".b3-list-item--focus").forEach((a,i)=>{if(a.style.opacity="",i===0){const s=a.querySelector(".ariaLabel");s&&Qa(s.getAttribute("aria-label"),s)}}),window.siyuan.dragElement=void 0,document.querySelectorAll(".layout-tab-bars--drag").forEach(a=>{a.classList.remove("layout-tab-bars--drag")})}),this.element.addEventListener("dragover",a=>{if(window.siyuan.config.readonly||a.dataTransfer.types.includes(u.SIYUAN_DROP_TAB))return;const i=this.element.getBoundingClientRect();(a.clientY<i.top+u.SIZE_SCROLL_TB||a.clientY>i.bottom-u.SIZE_SCROLL_TB)&&this.element.scroll({top:this.element.scrollTop+(a.clientY<i.top+u.SIZE_SCROLL_TB?-u.SIZE_SCROLL_STEP:u.SIZE_SCROLL_STEP),behavior:"smooth"});let s=q(a.target,"LI");if(s||(s=q(document.elementFromPoint(a.clientX,a.clientY-1),"LI")),!s||!window.siyuan.dragElement){a.preventDefault();return}this.element.querySelectorAll(".dragover, .dragover__bottom, .dragover__top").forEach(f=>{f.classList.remove("dragover","dragover__bottom","dragover__top")});let o="";for(const f of a.dataTransfer.items)f.type.startsWith(u.SIYUAN_DROP_GUTTER)&&(o=f.type);if(o){const f=o.replace(u.SIYUAN_DROP_GUTTER,"").split(u.ZWSP);if(!["nodelistitem","nodeheading"].includes(f[0])){a.preventDefault();return}}else if(s.classList.contains("b3-list-item--focus"))return;let l=!o;Array.from(this.element.querySelectorAll(".b3-list-item--focus")).find(f=>{if(f.getAttribute("data-type")==="navigation-file")return l=!1,!0});const r=s.getAttribute("data-type");if(l&&r!=="navigation-root"){a.preventDefault();return}const d=B(s,"data-sortmode",null);if(!d)return;const c=d.getAttribute("data-sortmode");if((c==="6"||window.siyuan.config.fileTree.sort===6&&c==="15")&&!(!l&&r==="navigation-root")){const f=s.getBoundingClientRect(),g=f.height*.2;r==="navigation-root"&&l?a.clientY>f.top+f.height/2?s.classList.add("dragover__bottom"):s.classList.add("dragover__top"):a.clientY>f.bottom-g?s.classList.add("dragover__bottom"):a.clientY<f.top+g&&s.classList.add("dragover__top"),a.preventDefault()}if(s.classList.contains("dragover__top")||s.classList.contains("dragover__bottom")||r==="navigation-root"&&l){a.preventDefault();return}s.classList.add("dragover"),a.preventDefault()});let n=0;this.element.addEventListener("dragleave",()=>{n--,n===0&&this.element.querySelectorAll(".dragover, .dragover__bottom, .dragover__top").forEach(a=>{a.classList.remove("dragover","dragover__bottom","dragover__top")})}),this.element.addEventListener("dragenter",a=>{a.preventDefault(),n++}),this.element.addEventListener("drop",async a=>{n=0;const i=this.element.querySelector(".dragover, .dragover__bottom, .dragover__top");if(!i)return;const s=fe(i,"UL");if(!s)return;const o=this.element.scrollTop,l=s.getAttribute("data-url"),r=i.getAttribute("data-path");let d="";for(const h of a.dataTransfer.items)h.type.startsWith(u.SIYUAN_DROP_GUTTER)&&(d=h.type);if(d){const h=d.replace(u.SIYUAN_DROP_GUTTER,"").split(u.ZWSP);if(["nodelistitem","nodeheading"].includes(h[0])){const m={targetNoteBook:l,pushMode:0};i.classList.contains("dragover")?m.targetPath=r:i.classList.contains("dragover__bottom")?m.previousPath=r:i.classList.contains("dragover__top")&&(i.previousElementSibling?m.previousPath=i.previousElementSibling.getAttribute("data-path"):m.targetPath=i.parentElement.previousElementSibling.getAttribute("data-path")),h[0]==="nodeheading"?(m.srcHeadingID=h[2].split(",")[0],E("/api/filetree/heading2Doc",m)):(m.srcListItemID=h[2].split(",")[0],E("/api/filetree/li2Doc",m))}i.classList.remove("dragover","dragover__bottom","dragover__top"),window.siyuan.dragElement=void 0;return}if(window.siyuan.dragElement=void 0,!a.dataTransfer.getData(u.SIYUAN_DROP_FILE)){i.classList.remove("dragover","dragover__bottom","dragover__top");return}const c=[],f=[],g=[];if(this.element.querySelectorAll(".b3-list-item--focus").forEach(h=>{if(h.getAttribute("data-type")==="navigation-root")c.push(h);else{const m=h.getAttribute("data-path");if(!g.find(y=>{if(m.startsWith(y.replace(".sy","")))return!0})){if(i.getAttribute("data-path").startsWith(h.dataset.path.replace(".sy","")))return;f.push(h),g.push(m)}}}),i.classList.contains("dragover")){E("/api/filetree/moveDocs",{toNotebook:l,fromPaths:g,toPath:r}),i.classList.remove("dragover","dragover__bottom","dragover__top");return}const p=s.getAttribute("data-sortmode");if((i.classList.contains("dragover__bottom")||i.classList.contains("dragover__top"))&&(p==="6"||window.siyuan.config.fileTree.sort===6&&p==="15"))if(c.length>0&&i.getAttribute("data-path")==="/"){i.classList.contains("dragover__top")?c.forEach(m=>{i.parentElement.before(m.parentElement)}):c.reverse().forEach(m=>{i.parentElement.after(m.parentElement)});const h=[];Array.from(this.element.children).forEach(m=>{h.push(m.getAttribute("data-url"))}),E("/api/notebook/changeSortNotebook",{notebooks:h})}else{let h=!1;const m=Ee().dirname(r);g.length>0&&(await Re("/api/filetree/moveDocs",{toNotebook:l,fromPaths:g,toPath:m==="/"?"/":m+".sy",callback:u.CB_MOVE_NOLIST}),f.forEach(y=>{y.setAttribute("data-path",Ee().join(m,y.getAttribute("data-node-id")+".sy"))}),h=!0),i.classList.contains("dragover__top")?f.forEach(y=>{let w;y.nextElementSibling&&y.nextElementSibling.tagName==="UL"&&(w=y.nextElementSibling),i.before(y),w&&y.after(w)}):i.classList.contains("dragover__bottom")&&f.reverse().forEach(y=>{let w;y.nextElementSibling&&y.nextElementSibling.tagName==="UL"&&(w=y.nextElementSibling),i.nextElementSibling&&i.nextElementSibling.tagName==="UL"?i.nextElementSibling.after(y):i.after(y),w&&y.after(w)});const b=[];Array.from(i.parentElement.children).forEach(y=>{y.tagName==="LI"&&b.push(y.getAttribute("data-path"))}),E("/api/filetree/changeSort",{paths:b,notebook:l},()=>{h&&E("/api/filetree/listDocsByPath",{notebook:l,path:m==="/"?"/":m+".sy"},y=>{if(y.data.path==="/"&&y.data.files.length===0){j(window.siyuan.languages.emptyContent);return}this.onLsHTML(y.data,o)})})}i.classList.remove("dragover","dragover__bottom","dragover__top")}),this.init(),window.siyuan.config.openHelp&&$f()}updateDocInfo(e){const n=this.element.querySelector(`li[data-node-id="${e.data.rootID}"]`);n&&(n.setAttribute("data-count",e.data.subFileCount),n.querySelector(".ariaLabel")?.setAttribute("aria-label",this.genDocAriaLabel(e.data,Ka)))}updateItemArrow(e,n){const a=this.element.querySelector(`[data-url="${e}"]`);if(!a)return;let i=n,s;for(;!s;)if(s=a.querySelector(`[data-path="${i}"]`),s){const o=s.querySelector(".fn__hidden");o?o.classList.remove("fn__hidden"):this.getLeaf(s,e,!0);break}else{const o=Ee().dirname(i);if(o==="/"){a.firstElementChild.querySelector(".b3-list-item__arrow--open")&&this.getLeaf(a.firstElementChild,e,!0);break}else i=o+".sy"}}genNotebook(e){const n=`<span class="b3-list-item__icon b3-tooltips b3-tooltips__e" aria-label="${window.siyuan.languages.changeIcon}">${ge(e.icon||window.siyuan.storage[u.LOCAL_IMAGES].note)}</span>`;return e.closed?`<li data-type="open" data-url="${e.id}" class="b3-list-item b3-list-item--hide-action">
    <span class="b3-list-item__toggle fn__hidden">
        <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
    </span>
    ${n}
    <span class="b3-list-item__text">${pe(e.name)}</span>
    <span data-type="remove" data-url="${e.id}" class="b3-list-item__action b3-tooltips b3-tooltips__w${window.siyuan.config.readonly?" fn__none":""}" aria-label="${window.siyuan.languages.delete}">
        <svg><use xlink:href="#iconTrashcan"></use></svg>
    </span>
</li>`:`<ul class="b3-list b3-list--background" data-url="${e.id}" data-sort="${e.sort}" data-sortmode="${e.sortMode}">
<li class="b3-list-item b3-list-item--hide-action" ${window.siyuan.config.fileTree.sort===6?'draggable="true"':""} 
style="--file-toggle-width:22px" 
data-type="navigation-root" data-path="/">
    <span class="b3-list-item__toggle b3-list-item__toggle--hl">
        <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
    </span>
    ${n}
    <span class="b3-list-item__text ariaLabel" data-position="parentE">${pe(e.name)}</span>
    <span data-type="more-root" class="b3-list-item__action b3-tooltips b3-tooltips__w${window.siyuan.config.readonly?" fn__none":""}" aria-label="${window.siyuan.languages.more}">
        <svg><use xlink:href="#iconMore"></use></svg>
    </span>
    <span data-type="new" class="b3-list-item__action b3-tooltips b3-tooltips__w${window.siyuan.config.readonly?" fn__none":""}" aria-label="${window.siyuan.languages.newSubDoc}">
        <svg><use xlink:href="#iconAdd"></use></svg>
    </span>
</li></ul>`}init(e=!0){let n="",a="",i=0;window.siyuan.notebooks.forEach(l=>{l.closed?(i++,a+=this.genNotebook(l)):n+=this.genNotebook(l)}),this.element.innerHTML=n,this.closeElement.lastElementChild.innerHTML=a;const s=this.closeElement.querySelector(".counter");if(s.textContent=i.toString(),i?s.classList.remove("fn__none"):s.classList.add("fn__none"),window.siyuan.storage[u.LOCAL_FILESPATHS].forEach(l=>{l.openPaths.forEach(r=>{this.selectItem(l.notebookId,r,void 0,!1)})}),!e)return;const o=this.closeElement.querySelector("svg");n!==""?(this.closeElement.style.height="30px",o.classList.remove("b3-list-item__arrow--open"),this.closeElement.lastElementChild.classList.add("fn__none")):(this.closeElement.style.height="40%",o.classList.add("b3-list-item__arrow--open"),this.closeElement.lastElementChild.classList.remove("fn__none"))}onRemove(e){if(e.cmd==="unmount"){if(Ei(n=>{const a=this.element.querySelector(`ul[data-url="${e.data.box}"] li[data-path="/"]`);if(a&&(a.parentElement.remove(),u.CB_MOUNT_REMOVE!==e.callback)){let i="";n.find(o=>{o.closed&&(i+=this.genNotebook(o))}),this.closeElement.lastElementChild.innerHTML=i;const s=this.closeElement.querySelector(".counter");s.textContent=(parseInt(s.textContent)+1).toString(),s.classList.remove("fn__none")}}),u.CB_MOUNT_REMOVE===e.callback){const n=this.closeElement.querySelector(`li[data-url="${e.data.box}"]`);if(n){n.remove();const a=this.closeElement.querySelector(".counter");a.textContent=(parseInt(a.textContent)-1).toString(),a.textContent==="0"&&a.classList.add("fn__none")}}return}e.data.ids.forEach(n=>{const a=this.element.querySelector(`li.b3-list-item[data-node-id="${n}"]`);if(a){a.nextElementSibling?.tagName==="UL"&&a.nextElementSibling.remove();const i=a.parentElement.previousElementSibling;if(a.parentElement.childElementCount===1){if(i){const s=i.querySelector("svg");s.classList.remove("b3-list-item__arrow--open"),i.dataset.type!=="navigation-root"&&s.parentElement.classList.add("fn__hidden");const o=s.parentElement.nextElementSibling;o.innerHTML===ge(window.siyuan.storage[u.LOCAL_IMAGES].folder)&&(o.innerHTML=ge(window.siyuan.storage[u.LOCAL_IMAGES].file))}a.parentElement.remove()}else a.remove()}})}onMount(e){if(e.data.existed)return;const n=this.closeElement.querySelector(`li[data-url="${e.data.box.id}"]`);if(n){const a=this.closeElement.querySelector(".counter");a.textContent=(parseInt(a.textContent)-1).toString(),a.textContent==="0"&&a.classList.add("fn__none"),n.remove()}Ei(a=>{const i=this.genNotebook(e.data.box);if(this.element.childElementCount===0)this.element.innerHTML=i;else{let s;a.find((o,l)=>{if(o.id===e.data.box.id){for(;l>0;)if(a[l-1].closed)l--;else{s=a[l-1].id;break}return!0}}),s?this.element.querySelector(`[data-url="${s}"]`).insertAdjacentHTML("afterend",i):this.element.insertAdjacentHTML("afterbegin",i)}})}onRename(e){const n=this.element.querySelector(`ul[data-url="${e.box}"] li[data-path="${e.path}"]`);n&&(n.setAttribute("data-name",Lute.EscapeHTMLStr(e.title)),n.querySelector(".b3-list-item__text").innerHTML=pe(e.title))}onMove(e){const n=this.element.querySelector(`ul[data-url="${e.data.fromNotebook}"] li[data-path="${e.data.fromPath}"]`);if(n)if(n.nextElementSibling&&n.nextElementSibling.tagName==="UL"&&n.nextElementSibling.remove(),n.parentElement.childElementCount===1){if(n.parentElement.previousElementSibling){n.parentElement.previousElementSibling.querySelector(".b3-list-item__toggle").classList.add("fn__hidden"),n.parentElement.previousElementSibling.querySelector(".b3-list-item__arrow").classList.remove("b3-list-item__arrow--open");const i=n.parentElement.previousElementSibling.querySelector(".b3-list-item__icon");i.innerHTML===ge(window.siyuan.storage[u.LOCAL_IMAGES].folder)&&(i.innerHTML=ge(window.siyuan.storage[u.LOCAL_IMAGES].file))}n.parentElement.remove()}else n.remove();const a=this.element.querySelector(`[data-url="${e.data.toNotebook}"] li[data-path="${e.data.toPath}"]`);if(a){a.querySelector(".b3-list-item__toggle").classList.remove("fn__hidden");const i=a.querySelector(".b3-list-item__icon");i.innerHTML===ge(window.siyuan.storage[u.LOCAL_IMAGES].file)&&(i.innerHTML=ge(window.siyuan.storage[u.LOCAL_IMAGES].folder)),a.querySelector(".b3-list-item__arrow").classList.contains("b3-list-item__arrow--open")&&e.callback!==u.CB_MOVE_NOLIST&&this.getLeaf(a,e.data.toNotebook,!0)}}onLsHTML(e,n){if(e.files.length===0)return;const a=this.element.querySelector(`ul[data-url="${e.box}"] li[data-path="${e.path}"]`);if(!a)return;let i="";e.files.forEach(o=>{i+=this.genFileHTML(o)});let s=a.nextElementSibling;if(s&&s.tagName==="UL"){const o=document.createElement("template");o.innerHTML=i,s.querySelectorAll(":scope > .b3-list-item > .b3-list-item__toggle> .b3-list-item__arrow--open").forEach(l=>{const r=L(l,"b3-list-item");if(r){const d=o.content.querySelector(`.b3-list-item[data-node-id="${r.getAttribute("data-node-id")}"]`);d.after(r.nextElementSibling),d.querySelector(".b3-list-item__arrow").classList.add("b3-list-item__arrow--open")}}),s.innerHTML=o.innerHTML,typeof n=="number"&&this.element.scroll({top:n,behavior:"smooth"});return}a.querySelector(".b3-list-item__arrow").classList.add("b3-list-item__arrow--open"),a.insertAdjacentHTML("afterend",`<ul class="file-tree__sliderDown">${i}</ul>`),s=a.nextElementSibling,setTimeout(()=>{s.setAttribute("style",`top: -1px;position: relative;height:${s.childElementCount*(a.clientHeight+1)-1}px;`),setTimeout(()=>{this.element.querySelectorAll(".file-tree__sliderDown").forEach(o=>{o.classList.remove("file-tree__sliderDown"),o.removeAttribute("style")}),typeof n=="number"&&this.element.scroll({top:n,behavior:"smooth"})},120)},2)}onLsSelect(e,n,a){let i="";if(e.files.forEach(r=>{i+=this.genFileHTML(r)}),i==="")return;const s=this.element.querySelector(`ul[data-url="${e.box}"] li[data-path="${e.path}"]`);s.nextElementSibling&&s.nextElementSibling.tagName==="UL"&&s.nextElementSibling.remove();const o=s.querySelector(".b3-list-item__arrow");o.classList.add("b3-list-item__arrow--open"),o.parentElement.classList.remove("fn__hidden");const l=s.querySelector(".b3-list-item__icon");l.textContent===ge(window.siyuan.storage[u.LOCAL_IMAGES].file)&&(l.textContent=ge(window.siyuan.storage[u.LOCAL_IMAGES].folder)),s.insertAdjacentHTML("afterend",`<ul>${i}</ul>`),e.files.forEach(r=>{n===r.path?this.selectItem(e.box,n,void 0,a):n.startsWith(r.path.replace(".sy",""))&&E("/api/filetree/listDocsByPath",{notebook:e.box,path:r.path},d=>{this.selectItem(d.data.box,n,d.data,a)})}),a&&this.setCurrent(this.element.querySelector(`ul[data-url="${e.box}"] li[data-path="${n}"]`))}setCurrent(e,n=!0){if(e&&(this.element.querySelectorAll("li").forEach(a=>{a.classList.remove("b3-list-item--focus")}),e.classList.add("b3-list-item--focus"),n)){const a=this.element.getBoundingClientRect();this.element.scrollTop=this.element.scrollTop+(e.getBoundingClientRect().top-(a.top+a.height/2))}}getLeaf(e,n,a=!1){const i=e.querySelector(".b3-list-item__arrow");if(i.classList.contains("b3-list-item__arrow--open")&&!a){i.classList.remove("b3-list-item__arrow--open"),e.nextElementSibling?.remove(),this.getOpenPaths();return}E("/api/filetree/listDocsByPath",{notebook:n,path:e.getAttribute("data-path")},s=>{if(s.data.path==="/"&&s.data.files.length===0){j(window.siyuan.languages.emptyContent);return}this.onLsHTML(s.data),this.getOpenPaths()})}selectItem(e,n,a,i=!0){const s=this.element.querySelector(`[data-url="${e}"]`);if(!s)return;let o=n,l;for(;!l;)if(l=s.querySelector(`[data-path="${o}"]`),!l){const r=Ee().dirname(o);r==="/"?o=r:o=r+".sy"}if(l.getAttribute("data-path")===n){i?(this.setCurrent(l),this.getOpenPaths()):this.element.querySelector(".b3-list-item--focus")?.classList.remove("b3-list-item--focus");return}a&&a.path===o?this.onLsSelect(a,n,i):E("/api/filetree/listDocsByPath",{notebook:e,path:o},r=>{this.onLsSelect(r.data,n,i)})}getOpenPaths(){const e=[];this.element.querySelectorAll(".b3-list[data-url]").forEach(n=>{const a={notebookId:n.getAttribute("data-url"),openPaths:[]};if(n.querySelectorAll(".b3-list-item__arrow--open").forEach(i=>{const s=q(i,"LI");s&&a.openPaths.push(s.getAttribute("data-path"))}),a.openPaths.length>0){for(let i=0;i<a.openPaths.length;i++)for(let s=i+1;s<a.openPaths.length;s++)a.openPaths[s].startsWith(a.openPaths[i].replace(".sy",""))&&(a.openPaths.splice(i,1),s--);a.openPaths.forEach((i,s)=>{const o=this.element.querySelector(`[data-url="${a.notebookId}"] li[data-path="${i}"]`)?.nextElementSibling?.firstElementChild?.getAttribute("data-path");o&&(a.openPaths[s]=o)}),e.push(a)}}),window.siyuan.storage[u.LOCAL_FILESPATHS]=e,ue(u.LOCAL_FILESPATHS,e)}genDocAriaLabel(e,n){return`${n(nt(e.name,!0,!0))} <small class='ft__on-surface'>${e.hSize}</small>${e.bookmark?"<br>"+window.siyuan.languages.bookmark+" "+n(e.bookmark):""}${e.name1?"<br>"+window.siyuan.languages.name+" "+n(e.name1):""}${e.alias?"<br>"+window.siyuan.languages.alias+" "+n(e.alias):""}${e.memo?"<br>"+window.siyuan.languages.memo+" "+n(e.memo):""}${e.subFileCount!==0?window.siyuan.languages.includeSubFile.replace("x",e.subFileCount):""}<br>${window.siyuan.languages.modifiedAt} ${e.hMtime}<br>${window.siyuan.languages.createdAt} ${e.hCtime}`}genFileHTML(e){let n="";e.count&&e.count>0&&(n=`<span class="popover__block counter b3-tooltips b3-tooltips__nw" aria-label="${window.siyuan.languages.ref}">${e.count}</span>`);const a=this.genDocAriaLabel(e,Rt),i=(e.path.split("/").length-1)*18;return`<li data-node-id="${e.id}" data-name="${Lute.EscapeHTMLStr(e.name)}" draggable="true" data-count="${e.subFileCount}" 
data-type="navigation-file" 
style="--file-toggle-width:${i+18}px" 
class="b3-list-item b3-list-item--hide-action" data-path="${e.path}">
    <span style="padding-left: ${i}px" class="b3-list-item__toggle b3-list-item__toggle--hl${e.subFileCount===0?" fn__hidden":""}">
        <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
    </span>
    <span class="b3-list-item__icon b3-tooltips b3-tooltips__n popover__block" data-id="${e.id}" aria-label="${window.siyuan.languages.changeIcon}">${ge(e.icon||(e.subFileCount===0?window.siyuan.storage[u.LOCAL_IMAGES].file:window.siyuan.storage[u.LOCAL_IMAGES].folder))}</span>
    <span class="b3-list-item__text ariaLabel" data-position="parentE"
aria-label="${a}">${nt(e.name,!0,!0)}</span>
    <span data-type="more-file" class="b3-list-item__action b3-tooltips b3-tooltips__nw" aria-label="${window.siyuan.languages.more}">
        <svg><use xlink:href="#iconMore"></use></svg>
    </span>
    <span data-type="new" class="b3-list-item__action b3-tooltips b3-tooltips__nw${window.siyuan.config.readonly?" fn__none":""}" aria-label="${window.siyuan.languages.newSubDoc}">
        <svg><use xlink:href="#iconAdd"></use></svg>
    </span>
    ${n}
</li>`}initMoreMenu(){if(window.siyuan.menus.menu.remove(),window.siyuan.config.readonly||window.siyuan.menus.menu.append(new T({icon:"iconFilesRoot",label:window.siyuan.languages.newNotebook,click:()=>{Ww()}}).element),window.siyuan.menus.menu.append(new T({icon:"iconRefresh",label:window.siyuan.languages.rebuildIndex,click:()=>{this.element.getAttribute("disabled")||(this.element.setAttribute("disabled","disabled"),RE(()=>{this.element.removeAttribute("disabled"),this.init(!1)}))}}).element),!window.siyuan.config.readonly){const e=Uw("notebooks",window.siyuan.config.fileTree.sort,n=>{window.siyuan.config.fileTree.sort=n,E("/api/setting/setFiletree",{sort:window.siyuan.config.fileTree.sort,alwaysSelectOpenedFile:window.siyuan.config.fileTree.alwaysSelectOpenedFile,refCreateSavePath:window.siyuan.config.fileTree.refCreateSavePath,docCreateSavePath:window.siyuan.config.fileTree.docCreateSavePath,openFilesUseCurrentTab:window.siyuan.config.fileTree.openFilesUseCurrentTab,maxListCount:window.siyuan.config.fileTree.maxListCount},()=>{Ei(()=>{this.init(!1)})})});window.siyuan.menus.menu.append(new T({icon:"iconSort",label:window.siyuan.languages.sort,type:"submenu",submenu:e}).element)}return window.siyuan.menus.menu}}const yL=t=>{let e="",n="";if(Ce().editor.find(a=>{const i=a.parent.headElement;if(i.classList.contains("item--focus")&&(e=a.editor.protyle.notebookId,t?n=a.editor.protyle.path:n=Ee().dirname(a.editor.protyle.path),L(i,"layout__wnd--active")))return!0}),!e){const a=Qe("file").data.file;if(a instanceof Li){const i=a.element.querySelector(".b3-list-item--focus");if(i){const s=fe(i,"UL");s&&(e=s.getAttribute("data-url"));const o=i.getAttribute("data-path");t?n=o:n=Ee().dirname(o)}}}return e||window.siyuan.notebooks.find(a=>{if(!a.closed)return e=a.id,n="/",!0}),{notebookId:e,currentPath:n}},xi=t=>{if(Lh()===0){j(window.siyuan.languages.newFileTip);return}if(!t.notebookId){const e=yL(t.useSavePath);t.notebookId=e.notebookId,t.currentPath=e.currentPath}E("/api/filetree/getDocCreateSavePath",{notebook:t.notebookId},e=>{if(t.useSavePath||(e.data.box=t.notebookId),e.data.path.indexOf("/")>-1&&t.useSavePath||t.name)if(e.data.path.startsWith("/")||t.currentPath==="/"){const n=Ee().join(e.data.path,t.name||(e.data.path.endsWith("/")?window.siyuan.languages.untitled:""));E("/api/filetree/createDocWithMd",{notebook:e.data.box,path:n,markdown:"",listDocTree:t.listDocTree},a=>{t.afterCB&&t.afterCB(a.data,Ee().basename(n)),de({app:t.app,id:a.data,action:[u.CB_GET_CONTEXT,u.CB_GET_OPENNEW]})})}else E("/api/filetree/getHPathByPath",{notebook:e.data.box,path:t.notebookId===e.data.box?t.currentPath.endsWith(".sy")?t.currentPath:t.currentPath+".sy":e.data.path||"/"},n=>{const a=Ee().join(n.data,e.data.path,t.name||(e.data.path.endsWith("/")?window.siyuan.languages.untitled:""));E("/api/filetree/createDocWithMd",{notebook:e.data.box,path:a,parentID:nt(t.currentPath,!0,!0),markdown:"",listDocTree:t.listDocTree},i=>{t.afterCB&&t.afterCB(i.data,Ee().basename(a)),de({app:t.app,id:i.data,action:[u.CB_GET_CONTEXT,u.CB_GET_OPENNEW]})})});else{const n=Ee().basename(e.data.path||window.siyuan.languages.untitled);if(!pf(n))return;if(t.notebookId!==e.data.box){const s=Ee().join(e.data.path||"/",t.name||(e.data.path.endsWith("/")?window.siyuan.languages.untitled:""));E("/api/filetree/createDocWithMd",{notebook:e.data.box,path:s,markdown:"",listDocTree:t.listDocTree},o=>{t.afterCB&&t.afterCB(o.data,Ee().basename(s)),de({app:t.app,id:o.data,action:[u.CB_GET_CONTEXT,u.CB_GET_OPENNEW]})});return}const a=Lute.NewNodeID(),i=Ee().join(nt(t.currentPath,!1,!0),a+".sy");t.paths&&(t.paths[t.paths.indexOf(void 0)]=i),E("/api/filetree/createDoc",{notebook:e.data.box,path:i,title:n,md:"",sorts:t.paths,listDocTree:t.listDocTree},()=>{t.afterCB&&t.afterCB(a,n),de({app:t.app,id:a,action:[u.CB_GET_CONTEXT,u.CB_GET_OPENNEW]})})}})},Wh=(t,e,n)=>{E("/api/filetree/getRefCreateSavePath",{notebook:e},a=>{let i=t;e!==a.data.box&&(i=a.data.path||"/"),a.data.path?a.data.path.startsWith("/")?n(nt(a.data.path,!1,!0),a.data.box):E("/api/filetree/getHPathByPath",{notebook:a.data.box,path:i},s=>{n(nt(Ee().join(s.data,a.data.path),!1,!0),a.data.box)}):E("/api/filetree/getHPathByPath",{notebook:a.data.box,path:i},s=>{n(nt(s.data,!1,!0),a.data.box)})})},Yh=(t,e)=>{Q(["dialog"]),xi({app:t,useSavePath:!0,name:On(e.trim())||window.siyuan.languages.untitled})},Yw=(t,e,n,a,i)=>{const s=On(e.trim()?e.trim():t.lute.BlockDOM2Content(n.outerHTML).replace(/\n/g,"").trim())||window.siyuan.languages.untitled,o=Ee().join(a,s);E("/api/filetree/getIDsByHPath",{path:o,notebook:i},l=>{const r=pe(s.substring(0,window.siyuan.config.editor.blockRefDynamicAnchorTextMaxLen));l.data&&l.data.length>0?t.toolbar.setInlineMark(t,"block-ref","range",{type:"id",color:`${l.data[0]}${u.ZWSP}d${u.ZWSP}${r}`}):E("/api/filetree/createDocWithMd",{notebook:i,path:o,parentID:t.notebookId===i?t.block.rootID:"",markdown:""},d=>{t.toolbar.setInlineMark(t,"block-ref","range",{type:"id",color:`${d.data}${u.ZWSP}d${u.ZWSP}${r}`})}),Q(["toolbar"],t)})},wL=(t,e)=>{const n=new we({title:window.siyuan.languages.searchType,content:`<div class="b3-dialog__content">
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconMath"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.math}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="mathBlock" type="checkbox"${t.types.mathBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconTable"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.table}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="table" type="checkbox"${t.types.table?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconParagraph"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.paragraph}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="paragraph" type="checkbox"${t.types.paragraph?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconHeadings"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.headings}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="heading" type="checkbox"${t.types.heading?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconCode"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.code}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="codeBlock" type="checkbox"${t.types.codeBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconHTML5"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            HTML
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="htmlBlock" type="checkbox"${t.types.htmlBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconDatabase"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.database}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="databaseBlock" type="checkbox"${t.types.databaseBlock?" checked":""}>
    </label>    
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconSQL"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.embedBlock}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="embedBlock" type="checkbox"${t.types.embedBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconVideo"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.video}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="videoBlock" type="checkbox"${t.types.videoBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconRecord"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.audio}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="audioBlock" type="checkbox"${t.types.audioBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconLanguage"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            IFrame
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="iframeBlock" type="checkbox"${t.types.iframeBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconBoth"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.widget}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="widgetBlock" type="checkbox"${t.types.widgetBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconQuote"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.quote} <sup>[1]</sup>
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="blockquote" type="checkbox"${t.types.blockquote?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconSuper"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.superBlock} <sup>[1]</sup>
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="superBlock" type="checkbox"${t.types.superBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconList"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.list1} <sup>[1]</sup>
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="list" type="checkbox"${t.types.list?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconListItem"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.listItem} <sup>[1]</sup>
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="listItem" type="checkbox"${t.types.listItem?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconFile"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.doc}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="document" type="checkbox"${t.types.document?" checked":""}>
    </label>
    <span class="fn__space"></span>
    <div class="fn__flex-1">
        <div class="b3-label__text">[1] ${window.siyuan.languages.containerBlockTip1}</div>
    </div>    
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:W()?"92vw":"520px",height:"70vh"});n.element.setAttribute("data-key",u.DIALOG_SEARCHTYPE);const a=n.element.querySelectorAll(".b3-button");a[0].addEventListener("click",()=>{n.destroy()}),a[1].addEventListener("click",()=>{n.element.querySelectorAll(".b3-switch").forEach(i=>{t.types[i.getAttribute("data-type")]=i.checked}),e(),n.destroy()})},_L=t=>{let e="";Object.keys(u.SIYUAN_DEFAULT_REPLACETYPES).forEach(i=>{e+=`<label class="fn__flex b3-label">
    <span class="fn__space"></span>
    <div class="fn__flex-1 fn__flex-center">
        ${window.siyuan.languages.replaceTypes[i]}
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" data-type="${i}" type="checkbox"${t.replaceTypes[i]?" checked":""}>
</label>`});const n=new we({title:window.siyuan.languages.replaceType,content:`<div class="b3-dialog__content">${e}</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:W()?"92vw":"520px",height:"70vh"});n.element.setAttribute("data-key",u.DIALOG_REPLACETYPE);const a=n.element.querySelectorAll(".b3-button");a[0].addEventListener("click",()=>{n.destroy()}),a[1].addEventListener("click",()=>{n.element.querySelectorAll(".b3-switch").forEach(i=>{t.replaceTypes[i.getAttribute("data-type")]=i.checked}),n.destroy()})},vL=(t,e)=>{if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="searchMethod"){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name","searchMethod"),window.siyuan.menus.menu.append(new T({iconHTML:"",label:window.siyuan.languages.keyword,current:t.method===0,click(){t.method=0,e()}}).element),window.siyuan.menus.menu.append(new T({iconHTML:"",label:window.siyuan.languages.querySyntax,current:t.method===1,click(){t.method=1,e()}}).element),window.siyuan.menus.menu.append(new T({iconHTML:"",label:"SQL",current:t.method===2,click(){t.method=2,e()}}).element),window.siyuan.menus.menu.append(new T({iconHTML:"",label:window.siyuan.languages.regex,current:t.method===3,click(){t.method=3,e()}}).element)},Mf=(t,e,n,a,i)=>{t.removed=!1;const s=t;s.name=a,e.push(Object.assign({},s)),window.siyuan.storage[u.LOCAL_SEARCHDATA]=Object.assign({},t),ue(u.LOCAL_SEARCHDATA,window.siyuan.storage[u.LOCAL_SEARCHDATA]),E("/api/storage/setCriterion",{criterion:s},()=>{i.destroy();const o=n.querySelector("#criteria").firstElementChild;o.classList.remove("fn__none"),o.querySelector(".b3-chip--current")?.classList.remove("b3-chip--current"),o.insertAdjacentHTML("beforeend",`<div data-type="set-criteria" class="b3-chip b3-chip--current b3-chip--middle b3-chip--pointer">${s.name}<svg class="b3-chip__close" data-type="remove-criteria"><use xlink:href="#iconCloseRound"></use></svg></div>`)})},zw=(t,e,n)=>{const a=new we({title:window.siyuan.languages.saveCriterion,content:`<div class="b3-dialog__content">
        <input class="b3-text-field fn__block" placeholder="${window.siyuan.languages.memo}">
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:W()?"92vw":"520px"});a.element.setAttribute("data-key",u.DIALOG_SAVECRITERION);const i=a.element.querySelectorAll(".b3-button");a.bindInput(a.element.querySelector("input"),()=>{i[1].dispatchEvent(new CustomEvent("click"))}),i[0].addEventListener("click",()=>{a.destroy()}),i[1].addEventListener("click",()=>{const s=a.element.querySelector("input"),o=s.value.trim();if(!o){j(window.siyuan.languages._kernel[142]);return}W()?(t.k=document.querySelector("#toolbarSearch").value,t.r=n.querySelector("#toolbarReplace").value):(t.k=n.querySelector("#searchInput").value,t.r=n.querySelector("#replaceInput").value);const l=n.querySelector("#criteria").firstElementChild;let r="",d="";if(e.forEach(c=>{c.name===o&&(r=c.name),Vw(c,t)&&(d=c.name)}),s.blur(),r&&!d)xe(window.siyuan.languages.confirm,window.siyuan.languages.searchOverwrite,()=>{Array.from(l.children).forEach(c=>{c.textContent===o&&c.remove()}),e.find((c,f)=>{if(c.name===o)return e.splice(f,1),!0}),Mf(t,e,n,o,a)});else if(r&&d)if(r===d)a.destroy();else{const c=r===o?d:r;xe(window.siyuan.languages.confirm,window.siyuan.languages.searchRemoveName.replace("${x}",c).replace("${y}",o),()=>{Array.from(l.children).forEach(f=>{(f.textContent===d||f.textContent===r)&&f.remove()}),e.find((f,g)=>{if(f.name===c||f.name===r)return E("/api/storage/removeCriterion",{name:c}),e.splice(g,1),!0}),Mf(t,e,n,o,a)})}else!r&&d?xe(window.siyuan.languages.confirm,window.siyuan.languages.searchUpdateName.replace("${x}",d).replace("${y}",o),()=>{Array.from(l.children).forEach(c=>{c.textContent===d&&c.remove()}),e.find((c,f)=>{if(c.name===d)return E("/api/storage/removeCriterion",{name:d}),e.splice(f,1),!0}),Mf(t,e,n,o,a)}):Mf(t,e,n,o,a)})},EL=async(t,e,n,a,i,s)=>{if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="searchMore"){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name","searchMore");const o=[{iconHTML:"",label:window.siyuan.languages.type,current:t.sort===0,click(){t.sort=0,a()}},{iconHTML:"",label:window.siyuan.languages.createdASC,current:t.sort===1,click(){t.sort=1,a()}},{iconHTML:"",label:window.siyuan.languages.createdDESC,current:t.sort===2,click(){t.sort=2,a()}},{iconHTML:"",label:window.siyuan.languages.modifiedASC,current:t.sort===3,click(){t.sort=3,a()}},{iconHTML:"",label:window.siyuan.languages.modifiedDESC,current:t.sort===4,click(){t.sort=4,a()}},{iconHTML:"",label:window.siyuan.languages.sortByRankAsc,current:t.sort===6,click(){t.sort=6,a()}},{iconHTML:"",label:window.siyuan.languages.sortByRankDesc,current:t.sort===7,click(){t.sort=7,a()}}];t.group===1&&o.push({iconHTML:"",label:window.siyuan.languages.sortByContent,current:t.sort===5,click(){t.sort=5,a()}}),window.siyuan.menus.menu.append(new T({iconHTML:"",label:window.siyuan.languages.sort,type:"submenu",submenu:o}).element),window.siyuan.menus.menu.append(new T({iconHTML:"",label:window.siyuan.languages.group,type:"submenu",submenu:[{iconHTML:"",label:window.siyuan.languages.noGroupBy,current:t.group===0,click(){W()?(n.querySelector('[data-type="expand"]').classList.add("fn__none"),n.querySelector('[data-type="contract"]').classList.add("fn__none")):n.querySelector("#searchCollapse").parentElement.classList.add("fn__none"),t.group=0,t.sort===5&&(t.sort=0),a()}},{iconHTML:"",label:window.siyuan.languages.groupByDoc,current:t.group===1,click(){W()?(n.querySelector('[data-type="expand"]').classList.remove("fn__none"),n.querySelector('[data-type="contract"]').classList.remove("fn__none")):n.querySelector("#searchCollapse").parentElement.classList.remove("fn__none"),t.group=1,a()}}]}).element),s&&s(),window.siyuan.menus.menu.append(new T({type:"separator"}).element),window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.saveCriterion,iconHTML:"",click(){zw(t,e,n)}}).element),window.siyuan.menus.menu.append(new T({iconHTML:"",label:window.siyuan.languages.removeCriterion,click(){i()}}).element)},Vw=(t,e)=>!!(e.group===t.group&&e.hPath===t.hPath&&e.hasReplace===t.hasReplace&&e.k===t.k&&e.method===t.method&&e.r===t.r&&e.sort===t.sort&&tn(e.types,t.types)&&tn(e.replaceTypes,t.replaceTypes)&&tn(e.idPath,t.idPath)),kL=(t,e,n)=>{E("/api/storage/getCriteria",{},a=>{let i="";a.data.forEach(s=>{e.push(s);let o=!1;Vw(s,n)&&(o=!0),i+=`<div data-type="set-criteria" class="${o?"b3-chip--current ":""}b3-chip b3-chip--middle b3-chip--pointer">${pe(s.name)}<svg class="b3-chip__close" data-type="remove-criteria"><use xlink:href="#iconCloseRound"></use></svg></div>`}),t.innerHTML=`<div class="b3-chips${i?"":" fn__none"}">
    ${i}
</div>
<span class="fn__flex-1"></span>
<button data-type="saveCriterion" class="b3-button b3-button--small b3-button--outline fn__flex-center">${window.siyuan.languages.saveCriterion}</button>
<span class="fn__space"></span>
<button data-type="removeCriterion" aria-label="${window.siyuan.languages.useCriterion}" class="ariaLabel b3-button b3-button--small b3-button--outline fn__flex-center fn__flex-shrink" data-position="9south">${window.siyuan.languages.removeCriterion}</button>
<span class="fn__space"></span>`})},SL=t=>{const e=[];return t.querySelectorAll("mark").forEach(n=>{e.push(n.textContent)}),[...new Set(e)].join(" ")},zh=(t,e,n)=>{t.value===""?(e.classList.add("fn__none"),typeof n=="number"&&(t.style.paddingRight=t.dataset.oldPaddingRight)):(e.classList.remove("fn__none"),typeof n=="number"&&t.style.setProperty("padding-right",`${n*2+e.clientWidth}px`,"important"))},Pf=t=>{t.inputElement.dataset.oldPaddingRight=t.inputElement.style.paddingRight,t.inputElement.insertAdjacentHTML("afterend",`<svg class="${t.className||"b3-form__icon-clear"} ariaLabel" aria-label="${window.siyuan.languages.clear}" style="${t.right?"right: "+t.right+"px;":""}${t.height?"height:"+t.height+"px;":""}${t.width?"width:"+t.width:""}">
<use xlink:href="#iconCloseRound"></use></svg>`);const e=t.inputElement.nextElementSibling;e.addEventListener("click",()=>{t.inputElement.value="",t.inputElement.focus(),zh(t.inputElement,e,t.right),t.clearCB&&t.clearCB()}),t.inputElement.addEventListener("input",()=>{zh(t.inputElement,e,t.right)}),zh(t.inputElement,e,t.right)},Gw=t=>{const e=window.siyuan.storage[u.LOCAL_SEARCHKEYS];if(!e.replaceKeys||e.replaceKeys.length===0||e.length===1&&e[0]===t.value)return;const n=new st("search-replace-history");if(n.isOpen)return;n.element.classList.add("b3-menu--list"),n.addItem({iconHTML:"",label:window.siyuan.languages.clearHistory,click(){window.siyuan.storage[u.LOCAL_SEARCHKEYS].replaceKeys=[],ue(u.LOCAL_SEARCHKEYS,window.siyuan.storage[u.LOCAL_SEARCHKEYS])}});const a=n.addSeparator(1);let i=!0;e.replaceKeys.forEach(o=>{if(o!==t.value&&o){const l=n.addItem({iconHTML:"",label:pe(o),action:"iconCloseRound",bind(r){r.addEventListener("click",d=>{L(d.target,"b3-menu__action")?(e.replaceKeys.find((c,f)=>{if(c===o)return e.replaceKeys.splice(f,1),!0}),window.siyuan.storage[u.LOCAL_SEARCHKEYS].replaceKeys=e.replaceKeys,ue(u.LOCAL_SEARCHKEYS,window.siyuan.storage[u.LOCAL_SEARCHKEYS]),r.previousElementSibling?.classList.contains("b3-menu__separator")&&!r.nextElementSibling?window.siyuan.menus.menu.remove():r.remove()):(t.value=r.textContent,window.siyuan.menus.menu.remove()),d.preventDefault(),d.stopPropagation()})}});i&&l.classList.add("b3-menu__item--current"),i=!1}}),i&&a.remove();const s=t.previousElementSibling.getBoundingClientRect();n.open({x:s.left,y:s.bottom})},jw=(t,e,n)=>{const a=t.querySelector("#searchInput, #toolbarSearch"),i=window.siyuan.storage[u.LOCAL_SEARCHKEYS];if(!i.keys||i.keys.length===0||i.length===1&&i[0]===a.value)return;const s=new st("search-history");if(s.isOpen)return;s.element.classList.add("b3-menu--list"),s.addItem({iconHTML:"",label:window.siyuan.languages.clearHistory,click(){window.siyuan.storage[u.LOCAL_SEARCHKEYS].keys=[],ue(u.LOCAL_SEARCHKEYS,window.siyuan.storage[u.LOCAL_SEARCHKEYS])}});const o=s.addSeparator(1);let l=!0;i.keys.forEach(d=>{if(d!==a.value&&d){const c=s.addItem({iconHTML:"",label:pe(d),action:"iconCloseRound",bind(f){f.addEventListener("click",g=>{L(g.target,"b3-menu__action")?(i.keys.find((p,h)=>{if(p===d)return i.keys.splice(h,1),!0}),window.siyuan.storage[u.LOCAL_SEARCHKEYS].keys=i.keys,ue(u.LOCAL_SEARCHKEYS,window.siyuan.storage[u.LOCAL_SEARCHKEYS]),f.previousElementSibling?.classList.contains("b3-menu__separator")&&!f.nextElementSibling?window.siyuan.menus.menu.remove():f.remove()):(a.value=f.textContent,e.page=1,cn(t,e,n,!0),window.siyuan.menus.menu.remove()),g.preventDefault(),g.stopPropagation()})}});l&&c.classList.add("b3-menu__item--current"),l=!1}}),l&&o.remove();const r=a.previousElementSibling.getBoundingClientRect();s.open({x:r.left,y:r.bottom})},Kw=t=>{const e=t.querySelector("#searchAssetInput"),n=window.siyuan.storage[u.LOCAL_SEARCHASSET].keys;if(!n||n.length===0||n.length===1&&n[0]===e.value)return;const a=new st("search-asset-history");if(a.isOpen)return;a.element.classList.add("b3-menu--list"),a.addItem({iconHTML:"",label:window.siyuan.languages.clearHistory,click(){window.siyuan.storage[u.LOCAL_SEARCHASSET].keys=[],ue(u.LOCAL_SEARCHASSET,window.siyuan.storage[u.LOCAL_SEARCHASSET])}});const i=a.addSeparator(1);let s=!0;n.forEach(l=>{if(l!==e.value&&l){const r=a.addItem({iconHTML:"",label:pe(l),action:"iconCloseRound",bind(d){d.addEventListener("click",c=>{L(c.target,"b3-menu__action")?(n.find((f,g)=>{if(f===l)return n.splice(g,1),!0}),window.siyuan.storage[u.LOCAL_SEARCHASSET].keys=n,ue(u.LOCAL_SEARCHASSET,window.siyuan.storage[u.LOCAL_SEARCHASSET]),d.previousElementSibling?.classList.contains("b3-menu__separator")&&!d.nextElementSibling?window.siyuan.menus.menu.remove():d.remove()):(e.value=d.textContent,Fn(t),window.siyuan.menus.menu.remove()),c.preventDefault(),c.stopPropagation()})}});s&&r.classList.add("b3-menu__item--current"),s=!1}}),s&&i.remove();const o=e.previousElementSibling.getBoundingClientRect();a.open({x:o.left,y:o.bottom})},Zw=(t,e)=>{let n=window.siyuan.storage[u.LOCAL_SEARCHKEYS][t];n.splice(0,0,e),n=Array.from(new Set(n)),n.length>window.siyuan.config.search.limit&&n.splice(window.siyuan.config.search.limit,n.length-window.siyuan.config.search.limit),window.siyuan.storage[u.LOCAL_SEARCHKEYS][t]=n,ue(u.LOCAL_SEARCHKEYS,window.siyuan.storage[u.LOCAL_SEARCHKEYS])},LL=t=>{if(!t.value)return;let e=window.siyuan.storage[u.LOCAL_SEARCHASSET].keys;e.splice(0,0,t.value),e=Array.from(new Set(e)),e.length>window.siyuan.config.search.limit&&e.splice(window.siyuan.config.search.limit,e.length-window.siyuan.config.search.limit),window.siyuan.storage[u.LOCAL_SEARCHASSET].k=t.value,window.siyuan.storage[u.LOCAL_SEARCHASSET].keys=e,ue(u.LOCAL_SEARCHASSET,window.siyuan.storage[u.LOCAL_SEARCHASSET])},xL=(t,e)=>{if(window.siyuan.menus.menu.remove(),t.previousElementSibling.classList.add("fn__none"),t.classList.remove("fn__none"),t.innerHTML){t.querySelector("#searchAssetInput").select();return}const n=window.siyuan.storage[u.LOCAL_SEARCHASSET];t.parentElement.querySelector(".fn__loading--top").classList.remove("fn__none");let a="";if(a=`<kbd>${window.siyuan.languages.enterKey}/${window.siyuan.languages.doubleClick}</kbd> ${window.siyuan.languages.showInFolder}`,t.innerHTML=`<div class="block__icons">
    <span data-type="assetPrevious" class="block__icon block__icon--show ariaLabel" data-position="9south" disabled="disabled" aria-label="${window.siyuan.languages.previousLabel}"><svg><use xlink:href='#iconLeft'></use></svg></span>
    <span class="fn__space"></span>
    <span data-type="assetNext" class="block__icon block__icon--show ariaLabel" data-position="9south" disabled="disabled" aria-label="${window.siyuan.languages.nextLabel}"><svg><use xlink:href='#iconRight'></use></svg></span>
    <span class="fn__space"></span>
    <span id="searchAssetResult" class="ft__selectnone"></span>
    <span class="fn__flex-1"></span>
    <span class="fn__space"></span>
    <span id="assetMore" aria-label="${window.siyuan.languages.more}" class="block__icon block__icon--show ariaLabel" data-position="9south">
        <svg><use xlink:href="#iconMore"></use></svg>
    </span>
    <span class="fn__space"></span>
    <span id="searchAssetClose" aria-label="${e?window.siyuan.languages.stickSearch:window.siyuan.languages.globalSearch}" class="block__icon block__icon--show ariaLabel" data-position="9south">
        <svg><use xlink:href="#iconBack"></use></svg>
    </span>
</div>
<div class="b3-form__icon search__header">
    <div class="fn__flex-1" style="position: relative">
        <span class="search__history-icon ariaLabel" id="assetHistoryBtn" aria-label="${X("\u2325\u2193")}">
            <svg data-menu="true" class="b3-form__icon-icon"><use xlink:href="#iconSearch"></use></svg>
            <svg class="search__arrowdown"><use xlink:href="#iconDown"></use></svg>
        </span>
        <input id="searchAssetInput" value="${n.k}" class="b3-text-field b3-text-field--text" placeholder="${window.siyuan.languages.keyword}">
    </div>
    <div class="block__icons">
        <span data-type="assetRefresh" aria-label="${window.siyuan.languages.refresh}" class="block__icon ariaLabel" data-position="9south">
            <svg><use xlink:href="#iconRefresh"></use></svg>
        </span>
        <span class="fn__space"></span>
        <span id="assetSyntaxCheck" aria-label="${Hf(n.method)}" class="block__icon ariaLabel" data-position="9south">
            <svg><use xlink:href="#iconRegex"></use></svg>
        </span>
        <span class="fn__space"></span>
        <span id="assetFilter" aria-label="${window.siyuan.languages.type}" class="block__icon ariaLabel" data-position="9south">
            <svg><use xlink:href="#iconFilter"></use></svg>
        </span>
    </div>
</div>
<div class="search__layout${n.layout===1?" search__layout--row":""}">
    <div id="searchAssetList" class="fn__flex-1 search__list b3-list b3-list--background"></div>
    <div class="search__drag"></div>
    <div id="searchAssetPreview" class="fn__flex-1 search__preview b3-typography" style="padding: 8px;box-sizing: border-box;"></div>
</div>
<div class="search__tip${e?" fn__none":""}">
    <kbd>\u2191/\u2193/PageUp/PageDown</kbd> ${window.siyuan.languages.searchTip1}
    ${a}
    <kbd>${window.siyuan.languages.click}</kbd> ${window.siyuan.languages.searchTip3}
    <kbd>Esc</kbd> ${window.siyuan.languages.searchTip5}
</div>`,t.querySelector("#searchAssetList").innerHTML!=="")return;const i=t.querySelector("#searchAssetPreview");n.layout===1?n.col&&(i.style.width=n.col,i.classList.remove("fn__flex-1")):n.row&&(i.classList.remove("fn__flex-1"),i.style.height=n.row);const s=t.querySelector("#searchAssetInput");s.select(),s.addEventListener("compositionend",l=>{l.isComposing||Fn(t,n)}),s.addEventListener("input",l=>{l.isComposing||Fn(t,n)}),s.addEventListener("blur",()=>{LL(s)}),Fn(t,n),Pf({right:8,height:s.clientHeight,inputElement:s,clearCB(){Fn(t,n)}});const o=t.querySelector(".search__drag");o.addEventListener("mousedown",l=>{const r=document,d=o.previousElementSibling,c=n.layout===1?"lr":"tb",f=l[c==="lr"?"clientX":"clientY"],g=c==="lr"?d.offsetWidth:d.offsetHeight,p=c==="lr"?i.offsetWidth:i.offsetHeight;i.classList.remove("fn__flex-1"),i.style[c==="lr"?"width":"height"]=p+"px",t.style.userSelect="none",r.onmousemove=h=>{h.preventDefault(),h.stopPropagation();const m=g+(h[c==="lr"?"clientX":"clientY"]-f),b=p-(h[c==="lr"?"clientX":"clientY"]-f);m<120||b<120||(i.style[c==="lr"?"width":"height"]=b+"px")},r.onmouseup=()=>{t.style.userSelect="none",r.onmousemove=null,r.onmouseup=null,r.ondragstart=null,r.onselectstart=null,r.onselect=null,window.siyuan.storage[u.LOCAL_SEARCHASSET][c==="lr"?"col":"row"]=i[c==="lr"?"offsetWidth":"offsetHeight"]+"px",ue(u.LOCAL_SEARCHASSET,window.siyuan.storage[u.LOCAL_SEARCHASSET])}}),o.addEventListener("dblclick",()=>{i.style[n.layout===1?"width":"height"]="",i.classList.add("fn__flex-1");const l=n.layout===1?"lr":"tb";window.siyuan.storage[u.LOCAL_SEARCHASSET][l==="lr"?"col":"row"]="",ue(u.LOCAL_SEARCHASSET,window.siyuan.storage[u.LOCAL_SEARCHASSET])})};let Jw;const Fn=(t,e,n=1)=>{const a=t.parentElement.querySelector(".fn__loading--top");if(!es()){a.classList.add("fn__none"),t.querySelector(".search__drag")?.classList.add("fn__none"),t.querySelector("#searchAssetPreview").classList.add("fn__none"),t.querySelector("#searchAssetList").innerHTML=`<div class="search__empty">
    ${window.siyuan.languages._kernel[214]}
</div>`;return}a.classList.remove("fn__none"),clearTimeout(Jw),Jw=window.setTimeout(()=>{e||(e=window.siyuan.storage[u.LOCAL_SEARCHASSET]);const i=t.querySelector('[data-type="assetPrevious"]');n>1?i.removeAttribute("disabled"):i.setAttribute("disabled","disabled");const s=t.querySelector("#searchAssetInput");E("/api/search/fullTextSearchAssetContent",{page:n,query:s.value,types:e.types,method:e.method,orderBy:e.sort},o=>{a.classList.add("fn__none");const l=t.querySelector('[data-type="assetNext"]');n<o.data.pageCount?l.removeAttribute("disabled"):l.setAttribute("disabled","disabled");let r="";o.data.assetContents.forEach((c,f)=>{r+=`<div data-type="search-item" class="b3-list-item${f===0?" b3-list-item--focus":""}" data-id="${c.id}">
<span class="ft__on-surface">${c.ext}</span>
<span class="fn__space"></span>
<span class="b3-list-item__text">${c.content}</span>
<span class="b3-list-item__meta">${c.hSize}</span>
<span class="b3-list-item__meta b3-list-item__meta--ellipsis ariaLabel" aria-label="${Rt(c.path)}">${c.name}</span>
</div>`});const d=t.querySelector("#searchAssetPreview");o.data.assetContents.length>0?(d.classList.remove("fn__none"),t.querySelector(".search__drag")?.classList.remove("fn__none"),Nf(d,o.data.assetContents[0].id,s.value,e.method)):(d.classList.add("fn__none"),t.querySelector(".search__drag")?.classList.add("fn__none")),t.querySelector("#searchAssetResult").innerHTML=`<span class="fn__flex-center">${n}/${o.data.pageCount||1}</span><span class="fn__space"></span>
<span class="ft__on-surface">${window.siyuan.languages.total} ${o.data.matchedAssetCount}</span>`,t.querySelector("#searchAssetList").innerHTML=r||`<div class="search__empty">
    ${window.siyuan.languages.emptyContent}
</div>`})},u.TIMEOUT_INPUT)},Nf=(t,e,n,a)=>{E("/api/search/getAssetContent",{id:e,query:n,queryMethod:a},i=>{t.innerHTML=`<p style="white-space: pre-wrap;">${i.data.assetContent.content}</p>`;const s=t.querySelector("mark");if(s){s.classList.add("mark--hl");const o=t.getBoundingClientRect();t.scrollTop=t.scrollTop+s.getBoundingClientRect().top-o.top-o.height/2}})},AL=t=>{let e;const n=Array.from(t.querySelectorAll("mark"));if(n.find((a,i)=>{if(a.classList.contains("mark--hl")){a.classList.remove("mark--hl"),e=n[i+1];return}}),e||(e=n[0]),e){e.classList.add("mark--hl");const a=t.getBoundingClientRect();t.scrollTop=t.scrollTop+e.getBoundingClientRect().top-a.top-a.height/2}},CL=(t,e)=>{const n=window.siyuan.storage[u.LOCAL_SEARCHASSET].method;if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="searchAssetMethod"){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name","searchAssetMethod"),window.siyuan.menus.menu.append(new T({iconHTML:"",label:window.siyuan.languages.keyword,current:n===0,click(){window.siyuan.storage[u.LOCAL_SEARCHASSET].method=0,e()}}).element),window.siyuan.menus.menu.append(new T({iconHTML:"",label:window.siyuan.languages.querySyntax,current:n===1,click(){window.siyuan.storage[u.LOCAL_SEARCHASSET].method=1,e()}}).element),window.siyuan.menus.menu.append(new T({iconHTML:"",label:window.siyuan.languages.regex,current:n===3,click(){window.siyuan.storage[u.LOCAL_SEARCHASSET].method=3,e()}}).element);const a=t.getBoundingClientRect();window.siyuan.menus.menu.popup({x:a.right,y:a.bottom,isLeft:!0})},TL=t=>{let e="";return u.SIYUAN_ASSETS_SEARCH.sort((n,a)=>n.localeCompare(a)).forEach(n=>{e+=`<label class="fn__flex b3-label">
        <div class="fn__flex-1 fn__flex-center">
            ${n}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="${n}" type="checkbox" ${t[n]?" checked":""}>
    </label>`}),e},IL=t=>{const e=window.siyuan.storage[u.LOCAL_SEARCHASSET].types,n=new we({title:window.siyuan.languages.type,content:`<div class="b3-dialog__content">${TL(e)}</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:"520px",height:"70vh"});n.element.setAttribute("data-key",u.DIALOG_SEARCHASSETSTYPE);const a=n.element.querySelectorAll(".b3-button");a[0].addEventListener("click",()=>{n.destroy()}),a[1].addEventListener("click",()=>{n.element.querySelectorAll(".b3-switch").forEach(i=>{e[i.getAttribute("data-type")]=i.checked}),Fn(t),ue(u.LOCAL_SEARCHASSET,window.siyuan.storage[u.LOCAL_SEARCHASSET]),n.destroy()})},DL=(t,e,n)=>{if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="searchAssetMore"){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name","searchAssetMore");const a=window.siyuan.storage[u.LOCAL_SEARCHASSET],i=[{iconHTML:"",label:window.siyuan.languages.sortByRankAsc,current:a.sort===1,click(){a.sort=1,n()}},{iconHTML:"",label:window.siyuan.languages.sortByRankDesc,current:a.sort===0,click(){a.sort=0,n()}},{iconHTML:"",label:window.siyuan.languages.modifiedASC,current:a.sort===3,click(){a.sort=3,n()}},{iconHTML:"",label:window.siyuan.languages.modifiedDESC,current:a.sort===2,click(){a.sort=2,n()}}];window.siyuan.menus.menu.append(new T({iconHTML:"",label:window.siyuan.languages.sort,type:"submenu",submenu:i}).element),window.siyuan.menus.menu.append(new T({iconHTML:"",label:window.siyuan.languages.layout,type:"submenu",submenu:[{iconHTML:"",label:window.siyuan.languages.topBottomLayout,current:a.layout===0,click(){e.querySelector(".search__layout").classList.remove("search__layout--row");const o=e.querySelector("#searchAssetPreview");o.style.width="",a.row?(o.style.height=a.row,o.classList.remove("fn__flex-1")):o.classList.add("fn__flex-1"),a.layout=0,ue(u.LOCAL_SEARCHASSET,window.siyuan.storage[u.LOCAL_SEARCHASSET])}},{iconHTML:"",label:window.siyuan.languages.leftRightLayout,current:a.layout===1,click(){const o=e.querySelector("#searchAssetPreview");e.querySelector(".search__layout").classList.add("search__layout--row"),o.style.height="",a.col?(o.style.width=a.col,o.classList.remove("fn__flex-1")):o.classList.add("fn__flex-1"),a.layout=1,ue(u.LOCAL_SEARCHASSET,window.siyuan.storage[u.LOCAL_SEARCHASSET])}}]}).element),window.siyuan.menus.menu.append(new T({iconHTML:"",label:window.siyuan.languages.rebuildIndex,click(){if(!es()){j(window.siyuan.languages._kernel[214]);return}e.parentElement.querySelector(".fn__loading--top").classList.remove("fn__none"),E("/api/asset/fullReindexAssetContent",{},()=>{Fn(e,a)})}}).element);const s=t.getBoundingClientRect();window.siyuan.menus.menu.popup({x:s.right,y:s.bottom,isLeft:!0})},$L=(t,e)=>{if(window.siyuan.menus.menu.remove(),t.previousElementSibling.previousElementSibling.classList.add("fn__none"),t.classList.remove("fn__none"),t.querySelector("#searchUnRefResult").innerHTML||(t.parentElement.querySelector(".fn__loading--top").classList.remove("fn__none"),t.querySelector("#searchUnRefList").innerHTML!==""))return;const n=window.siyuan.storage[u.LOCAL_SEARCHUNREF];n.layout===1?n.col&&(e.protyle.element.style.width=n.col,e.protyle.element.classList.remove("fn__flex-1")):n.row&&(e.protyle.element.classList.remove("fn__flex-1"),e.protyle.element.style.height=n.row);const a=t.querySelector(".search__drag");a.addEventListener("mousedown",i=>{const s=document,o=a.nextElementSibling,l=a.previousElementSibling,r=n.layout===1?"lr":"tb",d=i[r==="lr"?"clientX":"clientY"],c=r==="lr"?l.clientWidth:l.clientHeight,f=r==="lr"?o.clientWidth:o.clientHeight;o.classList.remove("fn__flex-1"),o.style[r==="lr"?"width":"height"]=f+"px",t.style.userSelect="none",s.onmousemove=g=>{g.preventDefault(),g.stopPropagation();const p=c+(g[r==="lr"?"clientX":"clientY"]-d),h=f-(g[r==="lr"?"clientX":"clientY"]-d);p<120||h<120||(o.style[r==="lr"?"width":"height"]=h+"px")},s.onmouseup=()=>{t.style.userSelect="",s.onmousemove=null,s.onmouseup=null,s.ondragstart=null,s.onselectstart=null,s.onselect=null,window.siyuan.storage[u.LOCAL_SEARCHUNREF][r==="lr"?"col":"row"]=o[r==="lr"?"clientWidth":"clientHeight"]+"px",ue(u.LOCAL_SEARCHUNREF,window.siyuan.storage[u.LOCAL_SEARCHUNREF]),r==="lr"&&Jt(e.protyle)}}),a.addEventListener("dblclick",()=>{e.protyle.element.style[n.layout===1?"width":"height"]="",e.protyle.element.classList.add("fn__flex-1");const i=n.layout===1?"lr":"tb";window.siyuan.storage[u.LOCAL_SEARCHUNREF][i==="lr"?"col":"row"]="",ue(u.LOCAL_SEARCHUNREF,window.siyuan.storage[u.LOCAL_SEARCHUNREF]),i==="lr"&&Jt(e.protyle)}),El(t,e)},El=(t,e,n=1)=>{const a=t.querySelector('[data-type="unRefPrevious"]');n>1?a.removeAttribute("disabled"):a.setAttribute("disabled","disabled"),E("/api/search/listInvalidBlockRefs",{page:n},i=>{t.parentElement.querySelector(".fn__loading--top").classList.add("fn__none");const s=t.querySelector('[data-type="unRefNext"]');n<i.data.pageCount?s.removeAttribute("disabled"):s.setAttribute("disabled","disabled");let o="";i.data.blocks.forEach((l,r)=>{const d=$a(l.box)+nt(l.hPath,!1);o+=`<div data-type="search-item" class="b3-list-item${r===0?" b3-list-item--focus":""}" data-node-id="${l.id}" data-root-id="${l.rootID}">
<svg class="b3-list-item__graphic"><use xlink:href="#${Rn(l.type)}"></use></svg>
${ge(l.ial.icon,"b3-list-item__graphic",!0)}
<span class="b3-list-item__text">${l.content}</span>
${jh(l)}
<span class="b3-list-item__meta b3-list-item__meta--ellipsis ariaLabel" aria-label="${Rt(d)}">${Ka(d)}</span>
</div>`}),i.data.blocks.length>0?(e.protyle.element.classList.remove("fn__none"),t.querySelector(".search__drag")?.classList.remove("fn__none"),Ai({edit:e,id:i.data.blocks[0].id})):(e.protyle.element.classList.add("fn__none"),t.querySelector(".search__drag")?.classList.add("fn__none")),t.querySelector("#searchUnRefResult").innerHTML=`${n}/${i.data.pageCount||1}<span class="fn__space"></span>
<span class="ft__on-surface">${window.siyuan.languages.findInDoc.replace("${x}",i.data.matchedRootCount).replace("${y}",i.data.matchedBlockCount)}</span>`,t.querySelector("#searchUnRefList").innerHTML=o||`<div class="search__empty">
    ${window.siyuan.languages.emptyContent}
</div>`})},ML=(t,e,n)=>{const a=new st("searchUnRefMore");if(a.isOpen)return;const i=window.siyuan.storage[u.LOCAL_SEARCHUNREF];a.addItem({icon:"iconLayout",label:window.siyuan.languages.layout,type:"submenu",submenu:[{iconHTML:"",label:window.siyuan.languages.topBottomLayout,current:i.layout===0,click(){e.querySelector(".search__layout").classList.remove("search__layout--row"),n.protyle.element.style.width="",i.row?(n.protyle.element.style.height=i.row,n.protyle.element.classList.remove("fn__flex-1")):n.protyle.element.classList.add("fn__flex-1"),Jt(n.protyle),i.layout=0,ue(u.LOCAL_SEARCHUNREF,window.siyuan.storage[u.LOCAL_SEARCHUNREF])}},{iconHTML:"",label:window.siyuan.languages.leftRightLayout,current:i.layout===1,click(){e.querySelector(".search__layout").classList.add("search__layout--row"),n.protyle.element.style.height="",i.col?(n.protyle.element.style.width=i.col,n.protyle.element.classList.remove("fn__flex-1")):n.protyle.element.classList.add("fn__flex-1"),Jt(n.protyle),i.layout=1,ue(u.LOCAL_SEARCHUNREF,window.siyuan.storage[u.LOCAL_SEARCHUNREF])}}]}),a.addItem({icon:"iconRefresh",label:window.siyuan.languages.refresh,click(){e.parentElement.querySelector(".fn__loading--top").classList.remove("fn__none"),El(e,n)}});const s=t.getBoundingClientRect();a.open({x:s.right,y:s.bottom,isLeft:!0})},Vh=()=>({audioBlock:window.siyuan.config.search.audioBlock,videoBlock:window.siyuan.config.search.videoBlock,iframeBlock:window.siyuan.config.search.iframeBlock,widgetBlock:window.siyuan.config.search.widgetBlock,document:window.siyuan.config.search.document,heading:window.siyuan.config.search.heading,list:window.siyuan.config.search.list,listItem:window.siyuan.config.search.listItem,codeBlock:window.siyuan.config.search.codeBlock,htmlBlock:window.siyuan.config.search.htmlBlock,mathBlock:window.siyuan.config.search.mathBlock,table:window.siyuan.config.search.table,blockquote:window.siyuan.config.search.blockquote,superBlock:window.siyuan.config.search.superBlock,paragraph:window.siyuan.config.search.paragraph,embedBlock:window.siyuan.config.search.embedBlock,databaseBlock:window.siyuan.config.search.databaseBlock}),ti=(t,e,n,a)=>{if(e=e.trim(),Ce().search.find(o=>(o.parent.parent.switchTab(o.parent.headElement),o.updateSearch(e,n),!0)))return;const s=window.siyuan.storage[u.LOCAL_SEARCHDATA];ma({app:t,searchData:{k:e,r:"",hasReplace:!1,method:a?a.method:s.method,hPath:"",idPath:[],group:s.group,sort:s.sort,types:Object.assign({},s.types),replaceTypes:Object.assign({},s.replaceTypes),removed:s.removed,page:1},position:window.siyuan.layout.centerLayout.children.length>1||window.innerWidth>1024?"right":void 0})},Xw=(t,e,n,a)=>{let i=window.siyuan.languages.keyword;e.method===1?i=window.siyuan.languages.querySyntax:e.method===2?i="SQL":e.method===3&&(i=window.siyuan.languages.regex);let s=!0,o=!1;e.idPath.forEach(S=>{S.endsWith(".sy")&&(s=!1),S.split("/").length>1&&(o=!0)});const l=window.siyuan.storage[u.LOCAL_SEARCHKEYS],r=window.siyuan.storage[u.LOCAL_SEARCHUNREF];n.innerHTML=`<div class="fn__flex-column" style="height: 100%;${a?"border-radius: var(--b3-border-radius-b);overflow: hidden;":""}">
    <div class="block__icons" style="overflow: auto">
        <span data-position="9south" data-type="previous" class="block__icon block__icon--show ariaLabel" disabled="disabled" aria-label="${window.siyuan.languages.previousLabel}"><svg><use xlink:href='#iconLeft'></use></svg></span>
        <span class="fn__space"></span>
        <span data-position="9south" data-type="next" class="block__icon block__icon--show ariaLabel" disabled="disabled" aria-label="${window.siyuan.languages.nextLabel}"><svg><use xlink:href='#iconRight'></use></svg></span>
        <span class="fn__space"></span>
        <span id="searchResult" class="fn__flex-shrink ft__selectnone"></span>
        <span class="fn__space"></span>
        <span class="fn__flex-1${a?" resize__move":""}" style="min-height: 100%"></span>
        <span id="searchPathInput" data-position="9south" class="search__path ft__on-surface fn__flex-center ft__smaller fn__ellipsis ariaLabel" aria-label="${Rt(e.hPath)}">
            ${pe(e.hPath)}
            <svg class="search__rmpath${e.hPath?"":" fn__none"}"><use xlink:href="#iconCloseRound"></use></svg>
        </span>
        <span class="fn__space"></span>
        <span data-position="9south" id="searchInclude" ${o?"":"disabled"} aria-label="${window.siyuan.languages.includeChildDoc}" class="block__icon block__icon--show ariaLabel">
            <svg${s?' class="ft__primary"':""}><use xlink:href="#iconCopy"></use></svg>
        </span>
        <span class="fn__space"></span>
        <span id="searchPath" aria-label="${window.siyuan.languages.specifyPath}" class="block__icon block__icon--show ariaLabel" data-position="9south">
            <svg><use xlink:href="#iconFolder"></use></svg>
        </span>
        <span class="fn__space"></span>
        <span id="searchMore" aria-label="${window.siyuan.languages.more}" class="block__icon block__icon--show ariaLabel" data-position="9south">
            <svg><use xlink:href="#iconMore"></use></svg>
        </span>
        <span class="${a?"":"fn__none "}fn__space"></span>
        <span id="searchOpen" aria-label="${window.siyuan.languages.openInNewTab}" class="${a?"":"fn__none "}block__icon block__icon--show ariaLabel" data-position="9south">
            <svg><use xlink:href="#iconLayoutRight"></use></svg>
        </span>
        <span class="fn__space"></span>
        <span id="searchUnRef" aria-label="${window.siyuan.languages.listInvalidRefBlocks}" class="block__icon block__icon--show ariaLabel" data-position="9south">
            <svg><use xlink:href="#iconLinkOff"></use></svg>
        </span>
        <span class="fn__space"></span>
        <span id="searchAsset" aria-label="${window.siyuan.languages.searchAssetContent}" class="block__icon block__icon--show ariaLabel" data-position="9south">
            <svg><use xlink:href="#iconExact"></use></svg>
        </span>
    </div>
    <div class="b3-form__icon search__header">
        <div style="position: relative" class="fn__flex-1">
            <span class="search__history-icon ariaLabel" id="searchHistoryBtn" aria-label="${X("\u2325\u2193")}">
                <svg data-menu="true" class="b3-form__icon-icon"><use xlink:href="#iconSearch"></use></svg>
                <svg class="search__arrowdown"><use xlink:href="#iconDown"></use></svg>
            </span>
            <input id="searchInput" class="b3-text-field b3-text-field--text" placeholder="${window.siyuan.languages.showRecentUpdatedBlocks}">
        </div>
        <div class="block__icons">
            <span id="searchFilter" aria-label="${window.siyuan.languages.searchType}" class="block__icon ariaLabel" data-position="9south">
                <svg><use xlink:href="#iconFilter"></use></svg>
            </span> 
            <span class="fn__space"></span>
            <span id="searchSyntaxCheck" aria-label="${window.siyuan.languages.searchMethod} ${i}" class="block__icon ariaLabel" data-position="9south">
                <svg><use xlink:href="#iconRegex"></use></svg>
            </span>
            <span class="fn__space"></span>
            <span id="searchReplace" aria-label="${window.siyuan.languages.replace}" class="block__icon ariaLabel" data-position="9south">
                <svg><use xlink:href="#iconReplace"></use></svg>
            </span>
            <span class="fn__space"></span>
            <span id="searchRefresh" aria-label="${window.siyuan.languages.refresh}" class="block__icon ariaLabel" data-position="9south">
                <svg><use xlink:href="#iconRefresh"></use></svg>
            </span>
            <div class="fn__flex${e.group===0?" fn__none":""}">
                <span class="fn__space"></span>
                <span id="searchExpand" class="block__icon block__icon--show ariaLabel" data-position="9south" aria-label="${window.siyuan.languages.expand}">
                    <svg><use xlink:href="#iconExpand"></use></svg>
                </span>
                <span class="fn__space"></span>
                <span id="searchCollapse" class="block__icon block__icon--show ariaLabel" data-position="9south" aria-label="${window.siyuan.languages.collapse}">
                    <svg><use xlink:href="#iconContract"></use></svg>
                </span>
            </div>
        </div>
    </div>
    <div class="b3-form__icon search__header${e.hasReplace?"":" fn__none"}">
        <div class="fn__flex-1" style="position: relative">
            <span class="search__history-icon ariaLabel" id="replaceHistoryBtn" aria-label="${X("\u2325\u2193")}">
                <svg data-menu="true" class="b3-form__icon-icon"><use xlink:href="#iconReplace"></use></svg>
                <svg class="search__arrowdown"><use xlink:href="#iconDown"></use></svg>
            </span>
            <input id="replaceInput" class="b3-text-field b3-text-field--text">
        </div>
        <div class="fn__space"></div>
        <svg class="fn__rotate fn__none svg" style="padding: 0 8px;align-self: center;margin-right: 8px"><use xlink:href="#iconRefresh"></use></svg>
        <span id="replaceFilter" aria-label="${window.siyuan.languages.replaceType}" class="block__icon ariaLabel fn__flex-center" data-position="9south">
            <svg><use xlink:href="#iconFilter"></use></svg>
        </span>
        <span class="fn__space"></span>
        <button id="replaceAllBtn" class="b3-button b3-button--small b3-button--outline fn__flex-center">${window.siyuan.languages.replaceAll}</button>
        <div class="fn__space"></div>
        <button id="replaceBtn" class="b3-button b3-button--small b3-button--outline fn__flex-center">\u21B5 ${window.siyuan.languages.replace}</button>
        <div class="fn__space"></div>
    </div>
    <div id="criteria" class="search__header"></div>
    <div class="search__layout${(a?l.layout===1:l.layoutTab===1)?" search__layout--row":""}">
        <div id="searchList" class="fn__flex-1 search__list b3-list b3-list--background"></div>
        <div class="search__drag"></div>
        <div id="searchPreview" class="fn__flex-1 search__preview"></div>
    </div>
    <div class="search__tip${a?"":" fn__none"}">
        <kbd>\u2191/\u2193/PageUp/PageDown</kbd> ${window.siyuan.languages.searchTip1}
        <kbd>${X(window.siyuan.config.keymap.general.newFile.custom)}</kbd> ${window.siyuan.languages.new}
        <kbd>${window.siyuan.languages.enterKey}/${window.siyuan.languages.doubleClick}</kbd> ${window.siyuan.languages.searchTip2}
        <kbd>${window.siyuan.languages.click}</kbd> ${window.siyuan.languages.searchTip3}
        <kbd>${X(window.siyuan.config.keymap.editor.general.insertRight.custom)}/${X("\u2325"+window.siyuan.languages.click)}</kbd> ${window.siyuan.languages.searchTip4}
        <kbd>Esc</kbd> ${window.siyuan.languages.searchTip5}
    </div>
</div>
<div class="fn__flex-column fn__none" id="searchAssets" style="height: 100%;${a?"border-radius: var(--b3-border-radius-b);overflow: hidden;":""}"></div>
<div class="fn__flex-column fn__none" id="searchUnRefPanel" style="height: 100%;${a?"border-radius: var(--b3-border-radius-b);overflow: hidden;":""}">
    <div class="block__icons">
        <span data-type="unRefPrevious" class="block__icon block__icon--show ariaLabel" data-position="9south" disabled="disabled" aria-label="${window.siyuan.languages.previousLabel}"><svg><use xlink:href='#iconLeft'></use></svg></span>
        <span class="fn__space"></span>
        <span data-type="unRefNext" class="block__icon block__icon--show ariaLabel" data-position="9south" disabled="disabled" aria-label="${window.siyuan.languages.nextLabel}"><svg><use xlink:href='#iconRight'></use></svg></span>
        <span class="fn__space"></span>
        <span id="searchUnRefResult" class="ft__selectnone"></span>
        <span class="fn__flex-1"></span>
        <span class="fn__space"></span>
        <span id="unRefMore" aria-label="${window.siyuan.languages.more}" class="block__icon block__icon--show ariaLabel" data-position="9south">
            <svg><use xlink:href="#iconMore"></use></svg>
        </span>
        <span class="fn__space"></span>
        <span id="searchUnRefClose" aria-label="${a?window.siyuan.languages.globalSearch:window.siyuan.languages.stickSearch}" class="block__icon block__icon--show ariaLabel" data-position="9south">
            <svg><use xlink:href="#iconBack"></use></svg>
        </span>
    </div>
    <div class="search__layout${r.layout===1?" search__layout--row":""}">
        <div id="searchUnRefList" class="fn__flex-1 search__list b3-list b3-list--background"></div>
        <div class="search__drag"></div>
        <div id="searchUnRefPreview" class="fn__flex-1 search__preview"></div>
    </div>
    <div class="search__tip${a?"":" fn__none"}">
        <kbd>\u2191/\u2193/PageUp/PageDown</kbd> ${window.siyuan.languages.searchTip1}
        <kbd>${window.siyuan.languages.enterKey}/${window.siyuan.languages.doubleClick}</kbd> ${window.siyuan.languages.searchTip2}
        <kbd>${X(window.siyuan.config.keymap.editor.general.insertRight.custom)}/${X("\u2325"+window.siyuan.languages.click)}</kbd> ${window.siyuan.languages.searchTip4}
        <kbd>Esc</kbd> ${window.siyuan.languages.searchTip5}
    </div>
</div>
<div class="fn__loading fn__loading--top"><img width="120px" src="/stage/loading-pure.svg"></div>`;const d=[];kL(n.querySelector("#criteria"),d,e);const c=n.querySelector("#searchList"),f=n.querySelector("#searchInput"),g=n.querySelector("#replaceInput"),p=new aa(t,n.querySelector("#searchPreview"),{blockId:"",render:{gutter:!0,breadcrumbDocName:!0}});p.resize();const h=new aa(t,n.querySelector("#searchUnRefPreview"),{blockId:"",render:{gutter:!0,breadcrumbDocName:!0}});h.resize(),a?l.layout===1?l.col&&(p.protyle.element.style.width=l.col,p.protyle.element.classList.remove("fn__flex-1")):l.row&&(p.protyle.element.classList.remove("fn__flex-1"),p.protyle.element.style.height=l.row):l.layoutTab===1?l.colTab&&(p.protyle.element.style.width=l.colTab,p.protyle.element.classList.remove("fn__flex-1")):l.rowTab&&(p.protyle.element.classList.remove("fn__flex-1"),p.protyle.element.style.height=l.rowTab);let m,b=new Date().getTime();f.value=e.k||"",g.value=e.r||"",f.select();const y=n.querySelector(".search__drag");y.addEventListener("mousedown",S=>{const k=document,A=y.nextElementSibling,$=y.previousElementSibling,M=window.siyuan.storage[u.LOCAL_SEARCHKEYS][a?"layout":"layoutTab"]===1?"lr":"tb",C=S[M==="lr"?"clientX":"clientY"],N=M==="lr"?$.clientWidth:$.clientHeight,O=M==="lr"?A.clientWidth:A.clientHeight;A.classList.remove("fn__flex-1"),A.style[M==="lr"?"width":"height"]=O+"px",n.style.userSelect="none",k.onmousemove=te=>{te.preventDefault(),te.stopPropagation();const ne=N+(te[M==="lr"?"clientX":"clientY"]-C),oe=O-(te[M==="lr"?"clientX":"clientY"]-C);ne<120||oe<120||(A.style[M==="lr"?"width":"height"]=oe+"px")},k.onmouseup=()=>{n.style.userSelect="",k.onmousemove=null,k.onmouseup=null,k.ondragstart=null,k.onselectstart=null,k.onselect=null,window.siyuan.storage[u.LOCAL_SEARCHKEYS][M==="lr"?a?"col":"colTab":a?"row":"rowTab"]=A[M==="lr"?"clientWidth":"clientHeight"]+"px",ue(u.LOCAL_SEARCHKEYS,window.siyuan.storage[u.LOCAL_SEARCHKEYS]),M==="lr"&&Jt(p.protyle)}}),y.addEventListener("dblclick",()=>{p.protyle.element.style[w.layout===1?"width":"height"]="",p.protyle.element.classList.add("fn__flex-1");const S=window.siyuan.storage[u.LOCAL_SEARCHKEYS][a?"layout":"layoutTab"]===1?"lr":"tb";window.siyuan.storage[u.LOCAL_SEARCHKEYS][S==="lr"?a?"col":"colTab":a?"row":"rowTab"]="",ue(u.LOCAL_SEARCHKEYS,window.siyuan.storage[u.LOCAL_SEARCHKEYS]),S==="lr"&&Jt(p.protyle)});const w=window.siyuan.storage[u.LOCAL_SEARCHASSET],_=n.querySelector("#searchAssets"),x=n.querySelector("#searchUnRefPanel");return n.addEventListener("click",S=>{let k=S.target;const A=n.querySelector("#searchPathInput");for(;k&&!k.isSameNode(n);){const $=k.getAttribute("data-type");if($==="removeCriterion"){io(n,{removed:!0,sort:0,group:0,hasReplace:!1,method:0,hPath:"",idPath:[],k:"",r:"",page:1,types:Vh(),replaceTypes:Object.assign({},u.SIYUAN_DEFAULT_REPLACETYPES)},e,p,!0),n.querySelector(".b3-chip--current")?.classList.remove("b3-chip--current"),S.stopPropagation(),S.preventDefault();break}else if($==="saveCriterion"){zw(e,d,n),S.stopPropagation(),S.preventDefault();break}else if($==="next"){k.getAttribute("disabled")||e.page<parseInt(k.parentElement.querySelector("#searchResult").getAttribute("data-pagecount"))&&(e.page++,cn(n,e,p)),S.stopPropagation(),S.preventDefault();break}else if($==="previous"){k.getAttribute("disabled")||e.page>1&&(e.page--,cn(n,e,p)),S.stopPropagation(),S.preventDefault();break}else if(k.classList.contains("b3-chip")&&$==="set-criteria"){e.removed=!1,k.parentElement.querySelector(".b3-chip--current")?.classList.remove("b3-chip--current"),k.classList.add("b3-chip--current"),d.find(M=>{if(M.name===k.innerText.trim())return io(n,M,e,p),!0}),S.stopPropagation(),S.preventDefault();break}else if(k.classList.contains("b3-chip__close")&&$==="remove-criteria"){const M=k.parentElement.textContent;E("/api/storage/removeCriterion",{name:M}),d.find((C,N)=>{if(C.name===M)return d.splice(N,1),!0}),k.parentElement.classList.contains("b3-chip--current")&&io(n,{removed:!0,sort:0,group:0,hasReplace:!1,method:0,hPath:"",idPath:[],k:"",r:"",page:1,types:Vh(),replaceTypes:Object.assign({},u.SIYUAN_DEFAULT_REPLACETYPES)},e,p,!0),k.parentElement.remove(),S.stopPropagation(),S.preventDefault();break}else if(k.classList.contains("search__rmpath")){e.idPath=[],e.hPath="",e.page=1,A.textContent="",A.setAttribute("aria-label",""),cn(n,e,p,!0);const M=n.querySelector("#searchInclude");M.firstElementChild.classList.add("ft__primary"),M.setAttribute("disabled","disabled"),S.stopPropagation(),S.preventDefault();break}else if(k.id==="searchExpand"){Array.from(c.children).forEach(M=>{M.classList.contains("b3-list-item")&&(M.querySelector(".b3-list-item__arrow").classList.add("b3-list-item__arrow--open"),M.nextElementSibling.classList.remove("fn__none"))}),S.stopPropagation(),S.preventDefault();break}else if(k.id==="searchCollapse"){Array.from(c.children).forEach(M=>{M.classList.contains("b3-list-item")&&(M.querySelector(".b3-list-item__arrow").classList.remove("b3-list-item__arrow--open"),M.nextElementSibling.classList.add("fn__none"))}),S.stopPropagation(),S.preventDefault();break}else if(k.id==="searchPath"){vi((M,C)=>{E("/api/filetree/getHPathsByPaths",{paths:M},N=>{e.idPath=[];const O=[];let te=!1;M.forEach((oe,ce)=>{oe==="/"?(e.idPath.push(C[ce]),O.push($a(C[ce]))):(te=!0,e.idPath.push(Ee().join(C[ce],oe.replace(".sy",""))))}),N.data&&O.push(...N.data),e.hPath=O.join(" "),e.page=1,A.innerHTML=`${Ka(e.hPath)}<svg class="search__rmpath"><use xlink:href="#iconCloseRound"></use></svg>`,A.setAttribute("aria-label",pe(e.hPath));const ne=n.querySelector("#searchInclude");ne.firstElementChild.classList.add("ft__primary"),te?ne.removeAttribute("disabled"):ne.setAttribute("disabled","disabled"),cn(n,e,p,!0)})},[],void 0,window.siyuan.languages.specifyPath),S.stopPropagation(),S.preventDefault();break}else if(k.id==="searchInclude"){const M=k.firstElementChild;M.classList.toggle("ft__primary"),M.classList.contains("ft__primary")?e.idPath.forEach((C,N)=>{C.endsWith(".sy")&&(e.idPath[N]=C.replace(".sy",""))}):e.idPath.forEach((C,N)=>{!C.endsWith(".sy")&&C.split("/").length>1&&(e.idPath[N]=C+".sy")}),e.page=1,cn(n,e,p,!0),S.stopPropagation(),S.preventDefault();break}else if(k.id==="searchReplace"){e.hasReplace=!e.hasReplace,n.querySelectorAll(".search__header")[1].classList.toggle("fn__none"),S.stopPropagation(),S.preventDefault();break}else if(k.id==="searchUnRef"){$L(x,h),S.stopPropagation(),S.preventDefault();break}else if(k.id==="unRefMore"){ML(k,x,h),S.stopPropagation(),S.preventDefault();break}else if(k.id==="searchUnRefClose"){window.siyuan.menus.menu.remove(),x.classList.add("fn__none"),_.previousElementSibling.classList.remove("fn__none"),f.select(),S.stopPropagation(),S.preventDefault();break}else if($==="unRefPrevious"){if(!k.getAttribute("disabled")){let M=parseInt(x.querySelector("#searchUnRefResult").textContent);M>1&&(M--,El(x,h,M))}S.stopPropagation(),S.preventDefault();break}else if($==="unRefNext"){if(!k.getAttribute("disabled")){let M=parseInt(x.querySelector("#searchUnRefResult").textContent);M<parseInt(x.querySelector("#searchUnRefResult").textContent.split("/")[1])&&(M++,El(x,h,M))}S.stopPropagation(),S.preventDefault();break}else if(k.id==="searchAsset"){xL(_,!a),S.stopPropagation(),S.preventDefault();break}else if(k.id==="searchAssetClose"){window.siyuan.menus.menu.remove(),_.classList.add("fn__none"),_.previousElementSibling.classList.remove("fn__none"),f.select(),S.stopPropagation(),S.preventDefault();break}else if(k.id==="searchOpen"){e.k=f.value,e.r=g.value,ma({app:t,searchData:e,position:window.siyuan.layout.centerLayout.children.length>1||window.innerWidth>1024?"right":void 0}),a&&a(),S.stopPropagation(),S.preventDefault();break}else if(k.id==="searchRefresh"){cn(n,e,p),S.stopPropagation(),S.preventDefault();break}else if(k.id==="searchMore"){EL(e,d,n,()=>{e.page=1,cn(n,e,p,!0)},()=>{io(n,{removed:!0,sort:0,group:0,hasReplace:!1,method:0,hPath:"",idPath:[],k:"",r:"",page:1,types:Vh(),replaceTypes:Object.assign({},u.SIYUAN_DEFAULT_REPLACETYPES)},e,p,!0),n.querySelector("#criteria .b3-chip--current")?.classList.remove("b3-chip--current")},()=>{const C=window.siyuan.storage[u.LOCAL_SEARCHKEYS],N=L(n,"b3-dialog__container");window.siyuan.menus.menu.append(new T({iconHTML:"",label:window.siyuan.languages.layout,type:"submenu",submenu:[{iconHTML:"",label:window.siyuan.languages.topBottomLayout,current:N?C.layout===0:C.layoutTab===0,click(){n.querySelector(".search__layout").classList.remove("search__layout--row"),p.protyle.element.style.width="",N&&C.row||!N&&C.rowTab?(p.protyle.element.style.height=N?C.row:C.rowTab,p.protyle.element.classList.remove("fn__flex-1")):p.protyle.element.classList.add("fn__flex-1"),Jt(p.protyle),N?C.layout=0:C.layoutTab=0,ue(u.LOCAL_SEARCHKEYS,window.siyuan.storage[u.LOCAL_SEARCHKEYS])}},{iconHTML:"",label:window.siyuan.languages.leftRightLayout,current:N?C.layout===1:C.layoutTab===1,click(){n.querySelector(".search__layout").classList.add("search__layout--row"),p.protyle.element.style.height="",N&&C.col||!N&&C.colTab?(p.protyle.element.style.width=N?C.col:C.colTab,p.protyle.element.classList.remove("fn__flex-1")):p.protyle.element.classList.add("fn__flex-1"),Jt(p.protyle),N?C.layout=1:C.layoutTab=1,ue(u.LOCAL_SEARCHKEYS,window.siyuan.storage[u.LOCAL_SEARCHKEYS])}}]}).element)});const M=k.getBoundingClientRect();window.siyuan.menus.menu.popup({x:M.right,y:M.bottom,isLeft:!0}),S.stopPropagation(),S.preventDefault();break}else if(k.id==="searchFilter"){window.siyuan.menus.menu.remove(),wL(e,()=>{e.page=1,cn(n,e,p,!0)}),S.stopPropagation(),S.preventDefault();break}else if(k.id==="replaceFilter"){window.siyuan.menus.menu.remove(),_L(e),S.stopPropagation(),S.preventDefault();break}else if($==="assetPrevious"){if(!k.getAttribute("disabled")){let M=parseInt(_.querySelector("#searchAssetResult .fn__flex-center").textContent.split("/")[0]);M>1&&(M--,Fn(_,w,M))}S.stopPropagation(),S.preventDefault();break}else if($==="assetNext"){if(!k.getAttribute("disabled")){let M=parseInt(_.querySelector("#searchAssetResult .fn__flex-center").textContent.split("/")[0]);M<parseInt(_.querySelector("#searchAssetResult .fn__flex-center").textContent.split("/")[1])&&(M++,Fn(_,w,M))}S.stopPropagation(),S.preventDefault();break}else if(k.id==="assetMore"){DL(k,_,()=>{Fn(_),ue(u.LOCAL_SEARCHASSET,w)}),S.stopPropagation(),S.preventDefault();break}else if(k.id==="assetFilter"){IL(_),S.stopPropagation(),S.preventDefault();break}else if(k.id==="assetSyntaxCheck"){CL(k,()=>{n.querySelector("#assetSyntaxCheck").setAttribute("aria-label",Hf(w.method)),Fn(_,w),ue(u.LOCAL_SEARCHASSET,w)}),S.stopPropagation(),S.preventDefault();break}else if(k.id==="searchSyntaxCheck"){vL(e,()=>{n.querySelector("#searchSyntaxCheck").setAttribute("aria-label",Hf(e.method)),e.page=1,cn(n,e,p,!0)});const M=k.getBoundingClientRect();window.siyuan.menus.menu.popup({x:M.right,y:M.bottom,isLeft:!0}),S.stopPropagation(),S.preventDefault();break}else if(k.id==="searchHistoryBtn"){jw(n,e,p),S.stopPropagation(),S.preventDefault();return}else if(k.id==="assetHistoryBtn"){Kw(_),S.stopPropagation(),S.preventDefault();return}else if(k.id==="replaceHistoryBtn"){Gw(n.querySelector("#replaceInput")),S.stopPropagation(),S.preventDefault();return}else if(k.id==="replaceAllBtn"){Gh(n,e,p,!0),S.stopPropagation(),S.preventDefault();break}else if($==="assetRefresh"){Fn(_),S.stopPropagation(),S.preventDefault();break}else if(k.id==="replaceBtn"){Gh(n,e,p,!1),S.stopPropagation(),S.preventDefault();break}else if(k.classList.contains("b3-list-item__toggle")){k.parentElement.nextElementSibling.classList.toggle("fn__none"),k.firstElementChild.classList.toggle("b3-list-item__arrow--open"),S.stopPropagation(),S.preventDefault();break}else if(k.classList.contains("b3-list-item")){const M=n.querySelector("#searchAssetInput");if($==="search-new")e.method==0&&Yh(t,f.value);else if($==="search-item"){const C=k.dataset.id?"asset":x.classList.contains("fn__none")?"doc":"unRef";let N=S.detail===1,O=S.detail===2;if(N)m=window.setTimeout(()=>{if(C==="asset")k.classList.contains("b3-list-item--focus")?k.classList.contains("b3-list-item--focus")&&(AL(n.querySelector("#searchAssetPreview")),M.focus()):(_.querySelector(".b3-list-item--focus").classList.remove("b3-list-item--focus"),k.classList.add("b3-list-item--focus"),Nf(n.querySelector("#searchAssetPreview"),k.dataset.id,M.value,window.siyuan.storage[u.LOCAL_SEARCHASSET].method),M.focus());else if(S.altKey){const te=k.getAttribute("data-node-id");Ke(te,(ne,oe)=>{de({app:t,id:te,action:oe,zoomIn:ne,position:"right"}),a&&a()})}else k.classList.contains("b3-list-item--focus")?C==="doc"&&k.classList.contains("b3-list-item--focus")&&(PL({edit:p,id:k.getAttribute("data-node-id"),target:k}),f.focus()):((C==="doc"?c:x).querySelector(".b3-list-item--focus").classList.remove("b3-list-item--focus"),k.classList.add("b3-list-item--focus"),Ai({edit:C==="doc"?p:h,id:k.getAttribute("data-node-id"),config:C==="doc"?e:null,value:C==="doc"?f.value:null}),f.focus())},u.TIMEOUT_DBLCLICK);else if(O&&qe(S))if(clearTimeout(m),C==="asset")Ja(Ft.join(window.siyuan.config.system.dataDir,k.lastElementChild.getAttribute("aria-label")));else{const te=k.getAttribute("data-node-id");Ke(te,(ne,oe)=>{de({app:t,id:te,action:oe,zoomIn:ne}),a&&a()})}window.siyuan.menus.menu.remove()}else k.querySelector(".b3-list-item__toggle")&&(k.nextElementSibling.classList.toggle("fn__none"),k.firstElementChild.firstElementChild.classList.toggle("b3-list-item__arrow--open"));S.stopPropagation(),S.preventDefault();break}k=k.parentElement}},!1),f.addEventListener("compositionend",S=>{e.page=1,!S.isComposing&&cn(n,e,p,!0)}),f.addEventListener("input",S=>{e.page=1,!S.isComposing&&cn(n,e,p,!0)}),f.addEventListener("blur",()=>{e.removed&&(e.k=f.value,window.siyuan.storage[u.LOCAL_SEARCHDATA]=Object.assign({},e),ue(u.LOCAL_SEARCHDATA,window.siyuan.storage[u.LOCAL_SEARCHDATA])),Zw("keys",f.value)}),Pf({inputElement:f,right:8,height:f.clientHeight,clearCB(){e.page=1,cn(n,e,p)}}),Pf({right:8,inputElement:g,height:f.clientHeight}),cn(n,e,p),{edit:p,unRefEdit:h}},Hf=t=>{let e=window.siyuan.languages.searchMethod+" ";switch(t){case 0:e+=window.siyuan.languages.keyword;break;case 1:e+=window.siyuan.languages.querySyntax;break;case 2:e+="SQL";break;case 3:e+=window.siyuan.languages.regex;break}return e},io=(t,e,n,a,i=!1)=>{const s=L(t,"b3-dialog--open");if(s&&s.getAttribute("data-key")===u.DIALOG_SEARCH&&(e.hPath=n.hPath,e.idPath=n.idPath.join(",").split(",")),n.hasReplace!==e.hasReplace){const c=t.querySelectorAll(".search__header")[1];e.hasReplace?c.classList.remove("fn__none"):c.classList.add("fn__none")}const o=t.querySelector("#searchPathInput");e.hPath?(o.innerHTML=`${Ka(e.hPath)}<svg class="search__rmpath"><use xlink:href="#iconCloseRound"></use></svg>`,o.setAttribute("aria-label",pe(e.hPath))):(o.innerHTML="",o.setAttribute("aria-label","")),n.group!==e.group&&(e.group===0?t.querySelector("#searchExpand").parentElement.classList.add("fn__none"):t.querySelector("#searchExpand").parentElement.classList.remove("fn__none"));let l=!0,r=!1;e.idPath.forEach(c=>{c.endsWith(".sy")&&(l=!1),c.split("/").length>1&&(r=!0)});const d=t.querySelector("#searchInclude");l?d.firstElementChild.classList.add("ft__primary"):d.firstElementChild.classList.remove("ft__primary"),r?d.removeAttribute("disabled"):d.setAttribute("disabled","disabled"),(e.k||i)&&(t.querySelector("#searchInput").value=e.k),t.querySelector("#replaceInput").value=e.r,t.querySelector("#searchSyntaxCheck").setAttribute("aria-label",Hf(e.method)),Object.assign(n,e),window.siyuan.storage[u.LOCAL_SEARCHDATA]=Object.assign({},n),ue(u.LOCAL_SEARCHDATA,window.siyuan.storage[u.LOCAL_SEARCHDATA]),cn(t,n,a),window.siyuan.menus.menu.remove()},Qw=(t,e,n)=>{t.scrollTop=t.scrollTop+e.getBoundingClientRect().top-n.top-n.height/2;const a=L(e.startContainer,"table");if(a){const i=q(e.startContainer,"TD")||q(e.startContainer,"TH");i&&(a.firstElementChild.scrollLeft=i.offsetLeft,a.getAttribute("custom-pinthead")==="true"&&(t.scrollTop=t.scrollTop+a.getBoundingClientRect().top-n.top,a.querySelector("table").scrollTop=i.offsetTop))}},PL=t=>{const e=t.edit.protyle.contentElement.getBoundingClientRect();if(qn()){t.edit.protyle.highlight.markHL.clear(),t.edit.protyle.highlight.mark.clear(),t.edit.protyle.highlight.rangeIndex++,t.edit.protyle.highlight.rangeIndex>=t.edit.protyle.highlight.ranges.length&&(t.edit.protyle.highlight.rangeIndex=0);let i;t.edit.protyle.highlight.ranges.forEach((s,o)=>{t.edit.protyle.highlight.rangeIndex===o?(t.edit.protyle.highlight.markHL.add(s),i=s):t.edit.protyle.highlight.mark.add(s)}),i&&(i.toString()?Qw(t.edit.protyle.contentElement,i,e):cf(t.edit.protyle,t.id));return}let n;const a=Array.from(t.edit.protyle.wysiwyg.element.querySelectorAll('span[data-type~="search-mark"]'));a.find((i,s)=>{if(i.classList.contains("search-mark--hl")){i.classList.remove("search-mark--hl"),n=a[s+1];return}}),n||(n=a[0]),n&&(n.classList.add("search-mark--hl"),t.edit.protyle.contentElement.scrollTop=t.edit.protyle.contentElement.scrollTop+n.getBoundingClientRect().top-e.top-e.height/2)};let Rf;const Ai=t=>{Rf=t.id,Ke(t.id,e=>{Rf===t.id&&(t.edit.protyle.scroll.lastScrollTop=0,ho(t.edit.protyle),E("/api/block/getDocInfo",{id:t.id},n=>{Rf===t.id&&(t.edit.protyle.wysiwyg.renderCustom(n.data.ial),E("/api/filetree/getDoc",{id:t.id,query:t.value||null,queryMethod:t.config?.method||null,queryTypes:t.config?.types||null,mode:e?0:3,size:e?u.SIZE_GET_MAX:window.siyuan.config.editor.dynamicLoadBlocks,zoom:e,highlight:!qn()},a=>{if(Rf!==t.id)return;t.edit.protyle.query={key:t.value||null,method:t.config?.method||null,types:t.config?.types||null},rt({updateReadonly:!0,data:a,protyle:t.edit.protyle,action:e?[u.CB_GET_ALL,u.CB_GET_HTML]:[u.CB_GET_HTML]});const i=t.edit.protyle.contentElement.getBoundingClientRect();if(qn())ac(t.edit.protyle,a.data.keywords,t.id,()=>{const s=()=>{const l=t.edit.protyle.highlight.ranges[t.edit.protyle.highlight.rangeIndex];t.edit.protyle.highlight.ranges.length>0&&l&&l.toString()?Qw(t.edit.protyle.contentElement,l,i):cf(t.edit.protyle,t.id)};s();const o=new ResizeObserver(()=>{s()});o.observe(t.edit.protyle.wysiwyg.element),setTimeout(()=>{o.disconnect()},u.TIMEOUT_COUNT)});else{const s=t.edit.protyle.wysiwyg.element.querySelectorAll('span[data-type~="search-mark"]');if(s.length===0)return;s[0].classList.add("search-mark--hl"),t.edit.protyle.contentElement.scrollTop=t.edit.protyle.contentElement.scrollTop+s[0].getBoundingClientRect().top-i.top-i.height/2}}))}))})},Gh=(t,e,n,a)=>{if(e.method===1||e.method===2){j(window.siyuan.languages._kernel[132]);return}const i=t.querySelector("#searchList"),s=t.querySelector("#replaceInput"),o=t.querySelector("#searchInput"),l=t.querySelector("svg.fn__rotate");if(!l.classList.contains("fn__none"))return;Zw("replaceKeys",s.value);let r=i.querySelector(".b3-list-item--focus");!r||r.dataset.type==="search-new"||(l.classList.remove("fn__none"),E("/api/search/findReplace",{k:e.method===0?SL(r):o.value,r:s.value,method:e.method,types:e.types,paths:e.idPath||[],groupBy:e.group,orderBy:e.sort,page:e.page,ids:a?[]:[r.getAttribute("data-node-id")],replaceTypes:e.replaceTypes},d=>{if(l.classList.add("fn__none"),d.code===1){j(d.msg);return}if(a){cn(t,e,n,!0);return}const c=r.getAttribute("data-root-id");if(Ce().editor.forEach(f=>{c===f.editor.protyle.block.rootID&&ei(f.editor.protyle,!1)}),r.nextElementSibling?r.nextElementSibling.classList.add("b3-list-item--focus"):r.previousElementSibling&&r.previousElementSibling.classList.add("b3-list-item--focus"),e.group===1)if(r.nextElementSibling||r.previousElementSibling)r.remove();else{const f=r.parentElement.nextElementSibling||r.parentElement.previousElementSibling.previousElementSibling?.previousElementSibling;f&&(f.nextElementSibling.firstElementChild.classList.add("b3-list-item--focus"),f.nextElementSibling.classList.remove("fn__none"),f.firstElementChild.firstElementChild.classList.add("b3-list-item__arrow--open")),r.parentElement.previousElementSibling.remove(),r.parentElement.remove()}else r.remove();if(r=i.querySelector(".b3-list-item--focus"),!r){i.innerHTML=`<div class="b3-list--empty">${window.siyuan.languages.emptyContent}</div>`,n.protyle.element.classList.add("fn__none"),t.querySelector(".search__drag").classList.add("fn__none");return}(i.scrollTop<r.offsetTop-i.clientHeight+30||i.scrollTop>r.offsetTop)&&(i.scrollTop=r.offsetTop-i.clientHeight+30),Ai({edit:n,id:r.getAttribute("data-node-id"),config:e,value:o.value})}))},cn=(t,e,n,a=!1)=>{let i=parseInt(t.getAttribute("data-timeout")||"0");clearTimeout(i),i=window.setTimeout(()=>{a&&t.querySelector("#criteria .b3-chip--current")?.classList.remove("b3-chip--current");const s=t.querySelector(".fn__loading--top");s.classList.remove("fn__none");const o=t.querySelector("#searchInput"),l=o.value;t.querySelector("#searchList").scrollTo(0,0);const r=t.querySelector('[data-type="previous"]'),d=t.querySelector('[data-type="next"]');n.protyle?.app.plugins.forEach(f=>{f.eventBus.emit("input-search",{protyle:n,config:e,searchElement:o})});const c=t.querySelector("#searchResult");l===""&&(!e.idPath||e.idPath.length===0)?E("/api/block/getRecentUpdatedBlocks",{},f=>{window.siyuan.reqIds["/api/block/getRecentUpdatedBlocks"]&&window.siyuan.reqIds["/api/search/fullTextSearchBlock"]&&window.siyuan.reqIds["/api/block/getRecentUpdatedBlocks"]<window.siyuan.reqIds["/api/search/fullTextSearchBlock"]||(e_(f.data,n,t,e),s.classList.add("fn__none"),c.innerHTML="",r.setAttribute("disabled","true"),d.setAttribute("disabled","true"))}):(e.page>1?r.removeAttribute("disabled"):r.setAttribute("disabled","disabled"),E("/api/search/fullTextSearchBlock",{query:l,method:e.method,types:e.types,paths:e.idPath||[],groupBy:e.group,orderBy:e.sort,page:e.page||1},f=>{if(window.siyuan.reqIds["/api/block/getRecentUpdatedBlocks"]&&window.siyuan.reqIds["/api/search/fullTextSearchBlock"]&&window.siyuan.reqIds["/api/block/getRecentUpdatedBlocks"]>window.siyuan.reqIds["/api/search/fullTextSearchBlock"])return;e.page||(e.page=1),e.page<f.data.pageCount?d.removeAttribute("disabled"):d.setAttribute("disabled","disabled"),e_(f.data.blocks,n,t,e);let g=window.siyuan.languages.findInDoc.replace("${x}",f.data.matchedRootCount).replace("${y}",f.data.matchedBlockCount);f.data.docMode&&(g=window.siyuan.languages.matchDoc.replace("${x}",f.data.matchedRootCount)),c.innerHTML=`${e.page}/${f.data.pageCount||1}<span class="fn__space"></span>
<span class="ft__on-surface">${g}</span>`,s.classList.add("fn__none"),c.setAttribute("data-pagecount",f.data.pageCount||1)}))},u.TIMEOUT_INPUT),t.setAttribute("data-timeout",i.toString())},jh=t=>{let e="";return t.name&&(e+=`<span class="b3-list-item__meta fn__flex" style="max-width: 30%"><svg class="b3-list-item__hinticon"><use xlink:href="#iconN"></use></svg><span class="b3-list-item__hinttext">${t.name}</span></span>`),t.alias&&(e+=`<span class="b3-list-item__meta fn__flex" style="max-width: 30%"><svg class="b3-list-item__hinticon"><use xlink:href="#iconA"></use></svg><span class="b3-list-item__hinttext">${t.alias}</span></span>`),t.memo&&(e+=`<span class="b3-list-item__meta fn__flex" style="max-width: 30%"><svg class="b3-list-item__hinticon"><use xlink:href="#iconM"></use></svg><span class="b3-list-item__hinttext">${t.memo}</span></span>`),e},e_=(t,e,n,a)=>{let i="";if(t.forEach((s,o)=>{const l=$a(s.box)+nt(s.hPath,!1);s.children?(i+=`<div class="b3-list-item">
<span class="b3-list-item__toggle b3-list-item__toggle--hl">
    <svg class="b3-list-item__arrow b3-list-item__arrow--open"><use xlink:href="#iconRight"></use></svg>
</span>
${ge(jS(s.box)||window.siyuan.storage[u.LOCAL_IMAGES].note,"b3-list-item__graphic",!0)}
<span class="b3-list-item__text ariaLabel" style="color: var(--b3-theme-on-surface)" aria-label="${Rt(l)}">${Ka(l)}</span>
</div><div>`,s.children.forEach((r,d)=>{i+=`<div style="padding-left: 36px" data-type="search-item" class="b3-list-item${d===0&&o===0?" b3-list-item--focus":""}" data-node-id="${r.id}" data-root-id="${r.rootID}">
<svg class="b3-list-item__graphic popover__block" data-id="${r.id}"><use xlink:href="#${Rn(r.type)}"></use></svg>
${ge(r.ial.icon,"b3-list-item__graphic",!0)}
<span class="b3-list-item__text">${r.content}</span>
${jh(r)}
${r.tag?`<span class="b3-list-item__meta b3-list-item__meta--ellipsis">${r.tag.split("# #").map(c=>`${c.replace("#","")}`).join(" ").replace("#","")}</span>`:""}
</div>`}),i+="</div>"):i+=`<div data-type="search-item" class="b3-list-item${o===0?" b3-list-item--focus":""}" data-node-id="${s.id}" data-root-id="${s.rootID}">
<svg class="b3-list-item__graphic popover__block" data-id="${s.id}"><use xlink:href="#${Rn(s.type)}"></use></svg>
${ge(s.ial.icon,"b3-list-item__graphic",!0)}
<span class="b3-list-item__text">${s.content}</span>
${jh(s)}
${s.tag?`<span class="b3-list-item__meta b3-list-item__meta--ellipsis">${s.tag.split("# #").map(r=>`${r.replace("#","")}`).join(" ").replace("#","")}</span>`:""}
<span class="b3-list-item__meta b3-list-item__meta--ellipsis ariaLabel" aria-label="${Rt(l)}">${Ka(l)}</span>
</div>`}),t[0]){e.protyle.element.classList.remove("fn__none"),n.querySelector(".search__drag").classList.remove("fn__none");const s=n.querySelector("#searchInput");t[0].children?Ai({edit:e,id:t[0].children[0].id,config:a,value:s.value}):Ai({edit:e,id:t[0].id,config:a,value:s.value})}else e.protyle.element.classList.add("fn__none"),n.querySelector(".search__drag").classList.add("fn__none");n.querySelector("#searchList").innerHTML=i||(a.method===0?`<div class="b3-list-item b3-list-item--focus" data-type="search-new">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg>
    <span class="b3-list-item__text">
        ${window.siyuan.languages.newFile} <mark>${pe(n.querySelector("#searchInput").value)}</mark>
    </span>
    <kbd class="b3-list-item__meta">${window.siyuan.languages.enterNew}</kbd>
</div>
<div class="search__empty">
    ${window.siyuan.languages.enterNewTip}
</div>`:`<div class="b3-list-item b3-list-item--focus" data-type="search-new">
    <span class="b3-list-item__text">
        ${window.siyuan.languages.emptyContent}
    </span>
</div>`)},t_=t=>{const e=parseInt(t.getAttribute("data-subtype").substr(1));let n=t.nextElementSibling;for(;n;){const a=parseInt(n.getAttribute("data-subtype")?.substr(1));if(!n.classList.contains("protyle-attr")&&(isNaN(a)||a>e)){const i=n;n=n.nextElementSibling,i.remove()}else break}};class NL{constructor(){this.hasUndo=!1,this.redoStack=[],this.undoStack=[]}undo(e){if(e.disabled||this.undoStack.length===0)return;const n=this.undoStack.pop();if(this.render(e,n,!1),this.hasUndo=!0,this.redoStack.push(n),e.breadcrumb){const a=e.breadcrumb.element.parentElement.querySelector('[data-type="undo"]');a&&(this.undoStack.length===0&&a.setAttribute("disabled","true"),e.breadcrumb.element.parentElement.querySelector('[data-type="redo"]').removeAttribute("disabled"))}}redo(e){if(e.disabled||this.redoStack.length===0)return;const n=this.redoStack.pop();if(this.render(e,n,!0),this.undoStack.push(n),e.breadcrumb){const a=e.breadcrumb.element.parentElement.querySelector('[data-type="redo"]');a&&(e.breadcrumb.element.parentElement.querySelector('[data-type="undo"]').removeAttribute("disabled"),this.redoStack.length===0&&a.setAttribute("disabled","true"))}}render(e,n,a){Q(["hint","gutter"],e),e.wysiwyg.lastHTMLs={},a?(n.doOperations.forEach(i=>{Dm(e,i,!0)}),U(e,n.doOperations)):(n.undoOperations.forEach(i=>{Dm(e,i,!0)}),U(e,n.undoOperations)),Bn(e),Ne(e)}replace(e,n){if(this.hasUndo&&this.redoStack.length>0&&(this.undoStack.push(this.redoStack.pop()),this.redoStack=[],this.hasUndo=!1,n.breadcrumb)){const a=n.breadcrumb.element.parentElement.querySelector('[data-type="redo"]');a&&a.setAttribute("disabled","true")}this.undoStack.length>0&&(this.undoStack[this.undoStack.length-1].doOperations=e)}add(e,n,a){if(this.undoStack.push({undoOperations:n,doOperations:e}),this.undoStack.length>u.SIZE_UNDO&&this.undoStack.shift(),this.hasUndo&&(this.redoStack=[],this.hasUndo=!1),a.breadcrumb){const i=a.breadcrumb.element.parentElement.querySelector('[data-type="undo"]');i&&i.removeAttribute("disabled")}}clear(){this.undoStack=[],this.redoStack=[]}}const ni=t=>H(window.siyuan.config.keymap.editor.general.undo.custom,t)?(ee.ipcRenderer.send(u.SIYUAN_CMD,"undo"),t.preventDefault(),t.stopPropagation(),!0):H(window.siyuan.config.keymap.editor.general.redo.custom,t)?(ee.ipcRenderer.send(u.SIYUAN_CMD,"redo"),t.preventDefault(),t.stopPropagation(),!0):!1,HL=(t,e,n)=>{let a,i="",s=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(s.length===0){let l=Je(e);const r=B(l,"fold","1");r&&(l=r),l.previousElementSibling?.classList.contains("protyle-action")&&(l=Je(l.parentElement)),s=[l]}const o=s[0].getAttribute("data-type");if(o==="NodeListItem"&&!s[0].previousElementSibling&&s[0].parentElement.previousElementSibling?.previousElementSibling?.classList.contains("protyle-action"))if(s[0].parentElement.parentElement.previousElementSibling?.classList.contains("li")){if(a=s[0].parentElement.parentElement.previousElementSibling.querySelector(".list"),n.insertNode(document.createElement("wbr")),i=s[0].parentElement.parentElement.parentElement.outerHTML,!a){const l=Lute.NewNodeID();s[0].parentElement.parentElement.previousElementSibling.lastElementChild.insertAdjacentHTML("beforebegin",`<div data-subtype="${s[0].getAttribute("data-subtype")}" data-node-id="${l}" data-type="NodeList" class="list" updated="${l.split("-")[0]}"><div id="moveTempLi"></div><div class="protyle-attr" contenteditable="false">&ZeroWidthSpace;</div></div>`),a=s[0].parentElement.parentElement.previousElementSibling.querySelector(".list")}}else return;if(o==="NodeList"&&s[0].previousElementSibling?.previousElementSibling?.classList.contains("protyle-action"))if(s[0].parentElement.previousElementSibling?.classList.contains("li")){if(a=s[0].parentElement.previousElementSibling.querySelector(".list"),n.insertNode(document.createElement("wbr")),i=s[0].parentElement.parentElement.outerHTML,!a){const l=Lute.NewNodeID();s[0].parentElement.previousElementSibling.lastElementChild.insertAdjacentHTML("beforebegin",`<div data-subtype="${s[0].getAttribute("data-subtype")}" data-node-id="${l}" data-type="NodeList" class="list" updated="${l.split("-")[0]}"><div id="moveTempLi"></div><div class="protyle-attr" contenteditable="false">&ZeroWidthSpace;</div></div>`),a=s[0].parentElement.previousElementSibling.querySelector(".list")}}else return;if(a){a=a.lastElementChild.previousElementSibling;const l=s[0].classList.contains("list")?s[0]:s[0].parentElement;s.reverse().forEach(r=>{r.classList.contains("list")?a.after(r.firstElementChild):a.after(r)}),a.id==="moveTempLi"&&(a=a.nextElementSibling,a.previousElementSibling.remove()),l.childElementCount===1?l.remove():l.getAttribute("data-subtype")==="o"&&l.classList.contains("list")&&ot(l,1),a.getAttribute("data-subtype")==="o"&&ot(a.parentElement),J(t,a.parentElement.parentElement.parentElement.getAttribute("data-node-id"),a.parentElement.parentElement.parentElement.outerHTML,i),Bn(t),Ne(t),he(a.parentElement,n);return}if(!(!s[0].previousElementSibling||s[0].previousElementSibling?.classList.contains("protyle-action"))){if(a=s[0].previousElementSibling,s[0].getAttribute("data-subtype")==="o"&&o==="NodeListItem"){const l=s[0].parentElement.outerHTML;s[s.length-1].after(a),ot(s[0].parentElement,1),J(t,s[0].parentElement.getAttribute("data-node-id"),s[0].parentElement.outerHTML,l)}else{const l=a.getAttribute("data-node-id");U(t,[{action:"move",id:l,previousID:s[s.length-1].getAttribute("data-node-id")}],[{action:"move",id:l,previousID:a.previousElementSibling?.getAttribute("data-node-id"),parentID:a.parentElement.getAttribute("data-node-id")||t.block.parentID}]),s[s.length-1].after(a)}Bn(t),Ne(t)}},RL=(t,e,n)=>{let a,i="",s=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(s.length===0){let l=Je(e);const r=B(l,"fold","1");r&&(l=r),l.previousElementSibling?.classList.contains("protyle-action")&&(l=Je(l.parentElement)),s=[l]}const o=s[0].getAttribute("data-type");if(o==="NodeListItem"&&s[s.length-1].nextElementSibling.classList.contains("protyle-attr")&&s[0].parentElement.parentElement?.classList.contains("li"))if(s[0].parentElement.parentElement.nextElementSibling?.classList.contains("li")){if(a=s[0].parentElement.parentElement.nextElementSibling.querySelector(".list > .li"),n.insertNode(document.createElement("wbr")),i=s[0].parentElement.parentElement.parentElement.outerHTML,!a){const l=Lute.NewNodeID();s[0].parentElement.parentElement.nextElementSibling.lastElementChild.insertAdjacentHTML("beforebegin",`<div data-subtype="${s[0].getAttribute("data-subtype")}" data-node-id="${l}" data-type="NodeList" class="list" updated="${l.split("-")[0]}"><div class="protyle-attr" contenteditable="false">&ZeroWidthSpace;</div></div>`),a=s[0].parentElement.parentElement.nextElementSibling.querySelector(".list > div")}}else return;if(o==="NodeList"&&s[s.length-1].nextElementSibling.classList.contains("protyle-attr")&&s[0].parentElement?.classList.contains("li"))if(s[0].parentElement.nextElementSibling?.classList.contains("li")){if(a=s[0].parentElement.nextElementSibling.querySelector(".list > .li"),n.insertNode(document.createElement("wbr")),i=s[0].parentElement.parentElement.outerHTML,!a){const l=Lute.NewNodeID();s[0].parentElement.nextElementSibling.lastElementChild.insertAdjacentHTML("beforebegin",`<div data-subtype="${s[0].getAttribute("data-subtype")}" data-node-id="${l}" data-type="NodeList" class="list" updated="${l.split("-")[0]}"><div class="protyle-attr" contenteditable="false">&ZeroWidthSpace;</div></div>`),a=s[0].parentElement.nextElementSibling.querySelector(".list > div")}}else return;if(a){const l=s[0].classList.contains("list")?s[0]:s[0].parentElement;s.forEach(r=>{r.classList.contains("list")?a.before(r.firstElementChild):a.before(r)}),l.childElementCount===1?l.remove():l.getAttribute("data-subtype")==="o"&&l.classList.contains("list")&&ot(l,1),a.getAttribute("data-subtype")==="o"&&ot(a.parentElement,1),J(t,a.parentElement.parentElement.parentElement.getAttribute("data-node-id"),a.parentElement.parentElement.parentElement.outerHTML,i),Bn(t),Ne(t),he(a.parentElement,n);return}if(!(!s[s.length-1].nextElementSibling||s[s.length-1].nextElementSibling?.classList.contains("protyle-attr"))){if(a=s[s.length-1].nextElementSibling,a.getAttribute("data-subtype")==="o"&&a.getAttribute("data-type")==="NodeListItem"){const l=a.parentElement.outerHTML;s[0].before(a),ot(a.parentElement,1),J(t,a.parentElement.getAttribute("data-node-id"),a.parentElement.outerHTML,l)}else{const l=a.getAttribute("data-node-id");U(t,[{action:"move",id:l,previousID:s[0].previousElementSibling?.getAttribute("data-node-id"),parentID:a.parentElement.getAttribute("data-node-id")||t.block.parentID}],[{action:"move",id:l,previousID:s[s.length-1].getAttribute("data-node-id")}]),s[0].before(a)}Bn(t),Ne(t)}},n_=(t,e,n)=>{if(e.method===1||e.method===2){showMessage(window.siyuan.languages._kernel[132]);return}const a=t.querySelector("#searchList"),i=t.querySelector("#toolbarReplace"),s=i.parentElement.querySelector(".fn__rotate");if(!s.classList.contains("fn__none"))return;saveKeyList("replaceKeys",i.value);let o=a.querySelector(".b3-list-item--focus");if(!o)return;s.classList.remove("fn__none"),s.nextElementSibling.classList.add("fn__none");let l=[];n?a.querySelectorAll('.b3-list-item[data-type="search-item"]').forEach(r=>{l.push(r.getAttribute("data-node-id"))}):l=[o.getAttribute("data-node-id")],fetchPost("/api/search/findReplace",{k:e.method===0?getKeyByLiElement(o):document.querySelector("#toolbarSearch").value,r:i.value,ids:l,types:e.types,method:e.method,replaceTypes:e.replaceTypes},r=>{if(s.classList.add("fn__none"),s.nextElementSibling.classList.remove("fn__none"),r.code===1){showMessage(r.msg);return}if(!(l.length>1)){if(reloadProtyle(window.siyuan.mobile.editor.protyle,!1),o.nextElementSibling?o.nextElementSibling.classList.add("b3-list-item--focus"):o.previousElementSibling&&o.previousElementSibling.classList.add("b3-list-item--focus"),e.group===1)if(o.nextElementSibling||o.previousElementSibling)o.remove();else{const d=o.parentElement.nextElementSibling||o.parentElement.previousElementSibling.previousElementSibling?.previousElementSibling;d&&(d.nextElementSibling.firstElementChild.classList.add("b3-list-item--focus"),d.nextElementSibling.classList.remove("fn__none"),d.firstElementChild.firstElementChild.classList.add("b3-list-item__arrow--open")),o.parentElement.previousElementSibling.remove(),o.parentElement.remove()}else o.remove();if(o=a.querySelector(".b3-list-item--focus"),!o){a.innerHTML=`<div class="b3-list--empty">${window.siyuan.languages.emptyContent}</div>`;return}(a.scrollTop<o.offsetTop-a.clientHeight+30||a.scrollTop>o.offsetTop)&&(a.scrollTop=o.offsetTop-a.clientHeight+30)}})},Kh=(t,e,n)=>{n.hasReplace!==e.hasReplace&&(e.hasReplace?(t.querySelector('[data-type="toggle-replace"]').classList.add("toolbar__icon--active"),t.querySelector(".toolbar").classList.remove("fn__none")):(t.querySelector('[data-type="toggle-replace"]').classList.remove("toolbar__icon--active"),t.querySelector(".toolbar").classList.add("fn__none")));const a=t.querySelector("#searchPath");e.hPath?(a.classList.remove("fn__none"),a.innerHTML=`<div class="b3-chip b3-chip--middle">${escapeHtml(e.hPath)}<svg data-type="remove-path" class="b3-chip__close"><use xlink:href="#iconCloseRound"></use></svg></div>`):a.classList.add("fn__none"),n.group!==e.group&&(e.group===0?(t.querySelector('[data-type="expand"]').classList.add("fn__none"),t.querySelector('[data-type="contract"]').classList.add("fn__none")):(t.querySelector('[data-type="expand"]').classList.remove("fn__none"),t.querySelector('[data-type="contract"]').classList.remove("fn__none")));let i=!0,s=!1;e.idPath.forEach(l=>{l.endsWith(".sy")&&(i=!1),l.split("/").length>1&&(s=!0)});const o=t.querySelector('[data-type="include"]');i?o.classList.add("toolbar__icon--active"):o.classList.remove("toolbar__icon--active"),s?o.removeAttribute("disabled"):o.setAttribute("disabled","disabled"),document.querySelector("#toolbarSearch").value=e.k,t.querySelector("#toolbarReplace").value=e.r,Object.assign(n,e),window.siyuan.storage[Constants.LOCAL_SEARCHDATA]=Object.assign({},n),setStorageVal(Constants.LOCAL_SEARCHDATA,window.siyuan.storage[Constants.LOCAL_SEARCHDATA]),da(n,t),window.siyuan.menus.menu.remove()},a_=(t,e,n)=>{const a=document.querySelector("#searchList");let i="";t.forEach((o,l)=>{const r=getNotebookName(o.box)+getDisplayName(o.hPath,!1);o.children?(i+=`<div class="b3-list-item">
<span class="b3-list-item__toggle b3-list-item__toggle--hl">
    <svg class="b3-list-item__arrow b3-list-item__arrow--open"><use xlink:href="#iconRight"></use></svg>
</span>
${unicode2Emoji(getNotebookIcon(o.box)||window.siyuan.storage[Constants.LOCAL_IMAGES].note,"b3-list-item__graphic",!0)}
<span class="b3-list-item__text" style="color: var(--b3-theme-on-surface)">${escapeGreat(r)}</span>
</div><div>`,o.children.forEach((d,c)=>{i+=`<div style="padding-left: 36px" data-type="search-item" class="b3-list-item${c===0&&l===0?" b3-list-item--focus":""}" data-node-id="${d.id}">
<svg class="b3-list-item__graphic"><use xlink:href="#${getIconByType(d.type)}"></use></svg>
${unicode2Emoji(d.ial.icon,"b3-list-item__graphic",!0)}
<span class="b3-list-item__text">${d.content}</span>
</div>`}),i+="</div>"):i+=`<div class="b3-list-item b3-list-item--two${l===0?" b3-list-item--focus":""}" data-type="search-item" data-node-id="${o.id}">
<div class="b3-list-item__first">
    <svg class="b3-list-item__graphic"><use xlink:href="#${getIconByType(o.type)}"></use></svg>
    ${unicode2Emoji(o.ial.icon,"b3-list-item__graphic",!0)}
    <span class="b3-list-item__text">${o.content}</span>
</div>
<span class="b3-list-item__text b3-list-item__meta">${escapeGreat(r)}</span>
</div>`}),a.innerHTML=i||`<div class="b3-list-item b3-list-item--focus" data-type="search-new">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg>
    <span class="b3-list-item__text">
        ${window.siyuan.languages.newFile} <mark>${document.querySelector("#toolbarSearch").value}</mark>
    </span>
</div>`,a.scrollTop=0;let s="";if(n){let o=window.siyuan.languages.findInDoc.replace("${x}",n.data.matchedRootCount).replace("${y}",n.data.matchedBlockCount);n.data.docMode&&(o=window.siyuan.languages.matchDoc.replace("${x}",n.data.matchedRootCount)),s=`<span class="fn__flex-center">${o}</span>
<span class="fn__flex-1"></span>
<span class="fn__flex-center">${e.page}/${n.data.pageCount||1}</span>`}a.previousElementSibling.querySelector('[data-type="result"]').innerHTML=s};let i_=0;const da=(t,e,n=!1)=>{clearTimeout(i_),i_=window.setTimeout(()=>{n&&e.querySelector("#criteria .b3-chip--current")?.classList.remove("b3-chip--current");const a=e.querySelector(".fn__loading--top");a.classList.remove("fn__none");const i=e.querySelector('[data-type="previous"]'),s=e.querySelector('[data-type="next"]'),o=document.getElementById("toolbarSearch");o.value===""&&(!t.idPath||t.idPath.length===0)?fetchPost("/api/block/getRecentUpdatedBlocks",{},l=>{a_(l.data,t),a.classList.add("fn__none"),i.setAttribute("disabled","true"),s.setAttribute("disabled","true")}):(t.page||(t.page=1),t.page>1?i.removeAttribute("disabled"):i.setAttribute("disabled","disabled"),fetchPost("/api/search/fullTextSearchBlock",{query:o.value,method:t.method,types:t.types,paths:t.idPath||[],groupBy:t.group,orderBy:t.sort,page:t.page},l=>{a_(l.data.blocks,t,l),a.classList.add("fn__none"),t.page<l.data.pageCount?s.removeAttribute("disabled"):s.setAttribute("disabled","disabled")}))},Constants.TIMEOUT_INPUT)},OL=(t,e,n)=>{const a=document.getElementById("toolbarSearch");a.value=n.k||"",a.addEventListener("compositionend",c=>{c&&c.isComposing||(n.page=1,da(n,e,!0))}),a.addEventListener("input",c=>{c&&c.isComposing||(n.page=1,da(n,e,!0))}),a.addEventListener("blur",()=>{n.removed&&(n.k=a.value,window.siyuan.storage[Constants.LOCAL_SEARCHDATA]=Object.assign({},n),setStorageVal(Constants.LOCAL_SEARCHDATA,window.siyuan.storage[Constants.LOCAL_SEARCHDATA])),saveKeyList("keys",a.value)}),addClearButton({inputElement:a,className:"toolbar__icon",clearCB(){n.page=1,da(n,e)}});const i=e.querySelector(".toolbar .toolbar__title");i.value=n.r||"",addClearButton({inputElement:i,className:"toolbar__icon"});const s=[];initCriteriaMenu(e.querySelector("#criteria"),s,n);const o=document.querySelector("#searchAssetsPanel"),l=document.querySelector("#searchUnRefPanel"),r=e.querySelector("#searchList"),d=window.siyuan.storage[Constants.LOCAL_SEARCHASSET];e.addEventListener("click",c=>{let f=c.target;for(;f&&!f.isSameNode(e);){const g=f.getAttribute("data-type");if(g==="replaceHistory"){toggleReplaceHistory(f.nextElementSibling),c.stopPropagation(),c.preventDefault();break}else if(g==="assetHistory"){toggleAssetHistory(o),c.stopPropagation(),c.preventDefault();break}else if(g==="previous"){f.getAttribute("disabled")||(n.page--,da(n,e)),c.stopPropagation(),c.preventDefault();break}else if(g==="next"){f.getAttribute("disabled")||(n.page++,da(n,e)),c.stopPropagation(),c.preventDefault();break}else if(g==="set-criteria"){n.removed=!1,f.parentElement.querySelector(".b3-chip--current")?.classList.remove("b3-chip--current"),f.classList.add("b3-chip--current"),s.find(p=>{if(p.name===f.innerText.trim())return Kh(e,p,n),!0}),c.stopPropagation(),c.preventDefault();break}else if(g==="remove-criteria"){const p=f.parentElement.innerText.trim();fetchPost("/api/storage/removeCriterion",{name:p}),s.find((h,m)=>{if(h.name===p)return s.splice(m,1),!0}),f.parentElement.classList.contains("b3-chip--current")&&Kh(e,{removed:!0,sort:0,group:0,hasReplace:!1,method:0,hPath:"",idPath:[],k:"",r:"",page:1,types:getDefaultType(),replaceTypes:Object.assign({},Constants.SIYUAN_DEFAULT_REPLACETYPES)},n),f.parentElement.parentElement.childElementCount===1&&f.parentElement.parentElement.classList.add("fn__none"),f.parentElement.remove(),c.stopPropagation(),c.preventDefault();break}else if(g==="remove-path"){n.idPath=[],n.hPath="",e.querySelector("#searchPath").classList.add("fn__none"),n.page=1,da(n,e,!0);const p=e.querySelector('[data-type="include"]');p.classList.remove("toolbar__icon--active"),p.setAttribute("disabled","disabled"),c.stopPropagation(),c.preventDefault();break}else if(g==="expand"){Array.from(r.children).forEach(p=>{p.classList.contains("b3-list-item")&&(p.querySelector(".b3-list-item__arrow").classList.add("b3-list-item__arrow--open"),p.nextElementSibling.classList.remove("fn__none"))}),c.stopPropagation(),c.preventDefault();break}else if(g==="contract"){Array.from(r.children).forEach(p=>{p.classList.contains("b3-list-item")&&(p.querySelector(".b3-list-item__arrow").classList.remove("b3-list-item__arrow--open"),p.nextElementSibling.classList.add("fn__none"))}),c.stopPropagation(),c.preventDefault();break}else if(g==="currentPath"&&!f.hasAttribute("disabled")){const p=getCurrentEditor().protyle;fetchPost("/api/filetree/getHPathsByPaths",{paths:[p.path]},h=>{n.idPath=[pathPosix().join(p.notebookId,p.path)],n.hPath=h.data[0];const m=e.querySelector("#searchPath");m.classList.remove("fn__none"),m.innerHTML=`<div class="b3-chip b3-chip--middle">${escapeHtml(n.hPath)}<svg data-type="remove-path" class="b3-chip__close"><use xlink:href="#iconCloseRound"></use></svg></div>`;const b=e.querySelector('[data-type="include"]');b.classList.remove("toolbar__icon--active"),b.removeAttribute("disabled"),n.page=1,da(n,e,!0)}),c.stopPropagation(),c.preventDefault();break}else if(g==="path"){movePathTo((p,h)=>{fetchPost("/api/filetree/getHPathsByPaths",{paths:p},m=>{n.idPath=[];const b=[];let y=!1;p.forEach((x,S)=>{x==="/"?(n.idPath.push(h[S]),b.push(getNotebookName(h[S]))):(y=!0,n.idPath.push(pathPosix().join(h[S],x.replace(".sy",""))))}),m.data&&b.push(...m.data),n.hPath=b.join(" ");const w=e.querySelector("#searchPath");w.classList.remove("fn__none"),w.innerHTML=`<div class="b3-chip b3-chip--middle">${escapeHtml(n.hPath)}<svg data-type="remove-path" class="b3-chip__close"><use xlink:href="#iconCloseRound"></use></svg></div>`;const _=e.querySelector('[data-type="include"]');_.classList.add("toolbar__icon--active"),y?_.removeAttribute("disabled"):_.setAttribute("disabled","disabled"),n.page=1,da(n,e,!0)})},[],void 0,window.siyuan.languages.specifyPath),c.stopPropagation(),c.preventDefault();break}else if(g==="include"&&!f.hasAttribute("disabled")){f.classList.toggle("toolbar__icon--active"),f.classList.contains("toolbar__icon--active")?n.idPath.forEach((p,h)=>{p.endsWith(".sy")&&(n.idPath[h]=p.replace(".sy",""))}):n.idPath.forEach((p,h)=>{!p.endsWith(".sy")&&p.split("/").length>1&&(n.idPath[h]=p+".sy")}),n.page=1,da(n,e,!0),c.stopPropagation(),c.preventDefault();break}else if(g==="toggle-replace"){n.hasReplace=!n.hasReplace,i.parentElement.classList.toggle("fn__none"),f.classList.toggle("toolbar__icon--active"),c.stopPropagation(),c.preventDefault();break}else if(g==="more"){moreMenu(n,s,e,()=>{n.page=1,da(n,e,!0)},()=>{Kh(e,{removed:!0,sort:0,group:0,hasReplace:!1,method:0,hPath:"",idPath:[],k:"",r:"",page:1,types:getDefaultType(),replaceTypes:Object.assign({},Constants.SIYUAN_DEFAULT_REPLACETYPES)},n)}),window.siyuan.menus.menu.fullscreen(),c.stopPropagation(),c.preventDefault();break}else if(g==="replace-all"){n_(e,n,!0),c.stopPropagation(),c.preventDefault();break}else if(g==="refreshUnRef"){Of(l),c.stopPropagation(),c.preventDefault();break}else if(g==="unRefPrevious"){if(!f.getAttribute("disabled")){let p=parseInt(l.querySelector("#searchUnRefResult").lastElementChild.textContent);p>1&&(p--,Of(l,p))}c.stopPropagation(),c.preventDefault();break}else if(g==="unRefNext"){const p=l.querySelector("#searchUnRefResult").lastElementChild;let h=parseInt(p.textContent);h<parseInt(p.textContent.split("/")[1])&&(h++,Of(l,h)),c.stopPropagation(),c.preventDefault();break}else if(g==="queryAsset"){assetMethodMenu(f,()=>{assetInputEvent(o,d),setStorageVal(Constants.LOCAL_SEARCHASSET,d)}),c.stopPropagation(),c.preventDefault();break}else if(g==="filterAsset"){assetFilterMenu(o),c.stopPropagation(),c.preventDefault();break}else if(g==="moreAsset"){assetMoreMenu(f,o,()=>{assetInputEvent(o),setStorageVal(Constants.LOCAL_SEARCHASSET,d)}),c.stopPropagation(),c.preventDefault();break}else if(g==="goAsset"){BL(),c.stopPropagation(),c.preventDefault();break}else if(g==="goSearch"){o.classList.add("fn__none"),l.classList.add("fn__none"),c.stopPropagation(),c.preventDefault();break}else if(g==="assetPrevious"){f.getAttribute("disabled")||assetInputEvent(o,d,parseInt(o.querySelector("#searchAssetResult .fn__flex-center").textContent.split("/")[1])-1),c.stopPropagation(),c.preventDefault();break}else if(g==="assetNext"){f.getAttribute("disabled")||assetInputEvent(o,d,parseInt(o.querySelector("#searchAssetResult .fn__flex-center").textContent.split("/")[1])+1),c.stopPropagation(),c.preventDefault();break}else if(g==="replace"){n_(e,n,!1),c.stopPropagation(),c.preventDefault();break}else if(f.classList.contains("b3-list-item__toggle")){f.parentElement.nextElementSibling.classList.toggle("fn__none"),f.firstElementChild.classList.toggle("b3-list-item__arrow--open"),c.stopPropagation(),c.preventDefault();break}else if(f.classList.contains("b3-list-item")){if(f.getAttribute("data-type")==="search-new")newFileByName(t,a.value);else if(f.getAttribute("data-type")==="search-item"){const p=f.getAttribute("data-node-id");p?(window.siyuan.mobile.editor?.protyle&&preventScroll(window.siyuan.mobile.editor.protyle),checkFold(p,h=>{openMobileFileById(t,p,h?[Constants.CB_GET_ALL]:[Constants.CB_GET_HL,Constants.CB_GET_CONTEXT,Constants.CB_GET_ROOTSCROLL])}),closePanel()):f.classList.contains("b3-list-item--focus")?f.classList.contains("b3-list-item--focus")&&renderNextAssetMark(e.querySelector("#searchAssetPreview")):(e.querySelector("#searchAssetList .b3-list-item--focus").classList.remove("b3-list-item--focus"),f.classList.add("b3-list-item--focus"),renderPreview(e.querySelector("#searchAssetPreview"),f.dataset.id,e.querySelector("#searchAssetInput").value,window.siyuan.storage[Constants.LOCAL_SEARCHASSET].method))}else f.querySelector(".b3-list-item__toggle")&&(f.nextElementSibling.classList.toggle("fn__none"),f.firstElementChild.firstElementChild.classList.toggle("b3-list-item__arrow--open"));c.stopPropagation(),c.preventDefault();break}f=f.parentElement}},!1)},E0=(t,e)=>{const n=JSON.parse(JSON.stringify(window.siyuan.storage[Constants.LOCAL_SEARCHDATA])),a=(getCurrentEditor()?.protyle.toolbar.range||(getSelection().rangeCount>0?getSelection().getRangeAt(0):document.createRange())).toString();a&&(n.k=a),e&&Object.keys(e).forEach(o=>{n[o]=e[o]}),activeBlur(),hideKeyboardToolbar();let i=!0,s=!1;n.idPath.forEach(o=>{o.endsWith(".sy")&&(i=!1),o.split("/").length>1&&(s=!0)}),openModel({title:`<div class="fn__flex">
    <span data-menu="true" class="toolbar__icon toolbar__icon--history" data-type="history">
        <svg class="svg--mid"><use xlink:href="#iconSearch"></use></svg>
        <svg class="svg--smaller"><use xlink:href="#iconDown"></use></svg>
    </span>
    <input id="toolbarSearch" placeholder="${window.siyuan.languages.showRecentUpdatedBlocks}" class="toolbar__title fn__block">
    <svg id="toolbarSearchNew" class="toolbar__icon"><use xlink:href="#iconFile"></use></svg>
</div>`,html:`<div class="fn__flex-column" style="height: 100%">
    <div class="toolbar toolbar--border${n.hasReplace?"":" fn__none"}">
        <span data-menu="true" class="toolbar__icon toolbar__icon--history" data-type="replaceHistory">
            <svg class="svg--mid"><use xlink:href="#iconReplace"></use></svg>
            <svg class="svg--smaller"><use xlink:href="#iconDown"></use></svg>
        </span>
        <input id="toolbarReplace" class="toolbar__title">
        <svg class="fn__rotate fn__none toolbar__icon"><use xlink:href="#iconRefresh"></use></svg>
        <div class="fn__space"></div>
        <button data-type="replace-all" class="b3-button b3-button--outline fn__flex-center">${window.siyuan.languages.replaceAll}</button>
        <div class="fn__space"></div>
        <button data-type="replace" class="b3-button b3-button--outline fn__flex-center">${window.siyuan.languages.replace}</button>
        <div class="fn__space"></div>
    </div>
    <div id="criteria" style="background-color: var(--b3-theme-background);"></div>
    <div class="toolbar">
        <span class="fn__space"></span>
        <span data-type="result" class="fn__flex-1 fn__flex"></span>
        <span class="fn__space"></span>
        <svg data-type="previous" disabled="disabled" class="toolbar__icon"><use xlink:href="#iconLeft"></use></svg>
        <svg data-type="next" disabled="disabled" class="toolbar__icon"><use xlink:href="#iconRight"></use></svg>
    </div>
    <div id="searchList" style="overflow:auto;" class="fn__flex-1 b3-list b3-list--background"></div>
    <div id="searchPath" class="b3-chips${n.hPath?"":" fn__none"}" style="background-color: var(--b3-theme-background);">
        <div class="b3-chip b3-chip--middle">
            ${escapeHtml(n.hPath)}
            <svg data-type="remove-path" class="b3-chip__close"><use xlink:href="#iconCloseRound"></use></svg>
        </div>
    </div>
    <div class="toolbar">
        <span class="fn__flex-1"></span>
        <svg data-type="toggle-replace" class="toolbar__icon${n.hasReplace?" toolbar__icon--active":""}"><use xlink:href="#iconReplace"></use></svg>
        <svg ${s?"":"disabled"} data-type="include" class="toolbar__icon${i?" toolbar__icon--active":""}"><use xlink:href="#iconCopy"></use></svg>
        <svg data-type="path" class="toolbar__icon"><use xlink:href="#iconFolder"></use></svg>
        <svg ${document.querySelector("#empty").classList.contains("fn__none")?"":"disabled"} data-type="currentPath" class="toolbar__icon"><use xlink:href="#iconFocus"></use></svg>
        <svg data-type="expand" class="toolbar__icon${n.group===0?" fn__none":""}"><use xlink:href="#iconExpand"></use></svg>
        <svg data-type="contract" class="toolbar__icon${n.group===0?" fn__none":""}"><use xlink:href="#iconContract"></use></svg>
        <svg data-type="more" class="toolbar__icon"><use xlink:href="#iconMore"></use></svg>
        <svg data-type="goAsset" class="toolbar__icon"><use xlink:href="#iconExact"></use></svg>
        <span class="fn__flex-1"></span>
     </div>
     <div class="fn__none fn__flex-column" style="position: fixed;top: 0;width: 100%;background: var(--b3-theme-surface);height: 100%;" id="searchAssetsPanel">
        <div class="toolbar toolbar--border">
           <span data-menu="true" class="toolbar__icon toolbar__icon--history" data-type="assetHistory">
                <svg class="svg--mid"><use xlink:href="#iconSearch"></use></svg>
                <svg class="svg--smaller"><use xlink:href="#iconDown"></use></svg>
            </span>
            <input id="searchAssetInput" placeholder="${window.siyuan.languages.keyword}" class="toolbar__title fn__block">
        </div>
        <div class="toolbar">
            <span class="fn__space"></span>
            <span id="searchAssetResult" class="fn__flex-1 fn__flex"><span class="fn__flex-1"></span></span>
            <span class="fn__space"></span>
            <svg data-type="assetPrevious" disabled="disabled" class="toolbar__icon"><use xlink:href="#iconLeft"></use></svg>
            <svg data-type="assetNext" disabled="disabled" class="toolbar__icon"><use xlink:href="#iconRight"></use></svg>
        </div>
        <div id="searchAssetList" style="overflow:auto;" class="fn__flex-1 b3-list b3-list--background"></div>
        <div id="searchAssetPreview" class="fn__flex-1 search__preview b3-typography" style="padding: 8px;border-bottom: 1px solid var(--b3-border-color);"></div>
        <div class="toolbar">
            <span class="fn__flex-1"></span>
            <svg data-type="queryAsset" class="toolbar__icon"><use xlink:href="#iconRegex"></use></svg>
            <svg data-type="filterAsset" class="toolbar__icon"><use xlink:href="#iconFilter"></use></svg>
            <svg data-type="moreAsset" class="toolbar__icon"><use xlink:href="#iconMore"></use></svg>
            <svg data-type="goSearch" class="toolbar__icon"><use xlink:href="#iconBack"></use></svg>
            <span class="fn__flex-1"></span>
         </div>
    </div>
     <div class="fn__none fn__flex-column" style="position: fixed;top: 0;width: 100%;background: var(--b3-theme-surface);height: 100%;" id="searchUnRefPanel">
        <div class="toolbar">
            <span class="fn__space"></span>
            <span id="searchUnRefResult" class="fn__flex-1 fn__flex"></span>
            <span class="fn__space"></span>
            <svg data-type="unRefPrevious" disabled="disabled" class="toolbar__icon"><use xlink:href="#iconLeft"></use></svg>
            <svg data-type="unRefNext" disabled="disabled" class="toolbar__icon"><use xlink:href="#iconRight"></use></svg>
        </div>
        <div id="searchUnRefList" style="overflow:auto;" class="fn__flex-1 b3-list b3-list--background"></div>
        <div class="toolbar">
            <span class="fn__flex-1"></span>
            <svg data-type="refreshUnRef" class="toolbar__icon"><use xlink:href="#iconRefresh"></use></svg>
            <svg data-type="goSearch" class="toolbar__icon"><use xlink:href="#iconBack"></use></svg>
            <span class="fn__flex-1"></span>
         </div>
    </div>
     <div class="fn__loading fn__loading--top"><img width="120px" src="/stage/loading-pure.svg"></div>
</div>`,bindEvent(o){document.querySelector("#toolbarSearchNew").addEventListener("click",()=>{newFileByName(t,document.querySelector("#toolbarSearch").value)}),document.querySelector('.toolbar [data-type="history"]').addEventListener("click",()=>{toggleSearchHistory(document.querySelector("#model"),n,void 0)}),OL(t,o.firstElementChild,n),da(n,o)}})},BL=()=>{const t=document.querySelector("#searchAssetsPanel");if(t.classList.remove("fn__none"),t.querySelector("#searchAssetList").innerHTML)return;const n=window.siyuan.storage[Constants.LOCAL_SEARCHASSET],a=t.querySelector("input");a.value=n.k,a.addEventListener("compositionend",i=>{i.isComposing||assetInputEvent(t,n)}),a.addEventListener("input",i=>{i.isComposing||assetInputEvent(t,n)}),a.addEventListener("blur",()=>{saveAssetKeyList(a)}),assetInputEvent(t,n),addClearButton({inputElement:a,className:"toolbar__icon",clearCB(){assetInputEvent(t,n)}})},k0=()=>{window.siyuan.menus.menu.remove();const t=document.querySelector("#searchUnRefPanel");t.classList.remove("fn__none"),!t.querySelector("#searchUnRefList").innerHTML&&Of(t)},Of=(t,e=1)=>{const n=t.querySelector('[data-type="unRefPrevious"]');e>1?n.removeAttribute("disabled"):n.setAttribute("disabled","disabled"),fetchPost("/api/search/listInvalidBlockRefs",{page:e},a=>{t.parentElement.querySelector(".fn__loading--top").classList.add("fn__none");const i=t.querySelector('[data-type="unRefNext"]');e<a.data.pageCount?i.removeAttribute("disabled"):i.setAttribute("disabled","disabled");let s="";a.data.blocks.forEach((o,l)=>{const r=getNotebookName(o.box)+getDisplayName(o.hPath,!1);s+=`<div class="b3-list-item b3-list-item--two${l===0?" b3-list-item--focus":""}" data-type="search-item" data-node-id="${o.id}">
<div class="b3-list-item__first">
    <svg class="b3-list-item__graphic"><use xlink:href="#${getIconByType(o.type)}"></use></svg>
    ${unicode2Emoji(o.ial.icon,"b3-list-item__graphic",!0)}
    <span class="b3-list-item__text">${o.content}</span>
</div>
<span class="b3-list-item__text b3-list-item__meta">${escapeGreat(r)}</span>
</div>`}),t.querySelector("#searchUnRefResult").innerHTML=`<span class="fn__flex-center">${window.siyuan.languages.findInDoc.replace("${x}",a.data.matchedRootCount).replace("${y}",a.data.matchedBlockCount)}</span>
<span class="fn__flex-1"></span>
<span class="fn__flex-center">${e}/${a.data.pageCount||1}</span>`,t.querySelector("#searchUnRefList").innerHTML=s||`<div class="search__empty">
    ${window.siyuan.languages.emptyContent}
</div>`})},S0=t=>{fetchPost("/api/storage/getRecentDocs",{},e=>{let n="";e.data.forEach((a,i)=>{n+=`<li data-index="${i}" data-node-id="${a.rootID}" class="b3-list-item${i===0?" b3-list-item--focus":""}">
${unicode2Emoji(a.icon||window.siyuan.storage[Constants.LOCAL_IMAGES].file,"b3-list-item__graphic",!0)}
<span class="b3-list-item__text">${escapeHtml(a.title)}</span>
</li>`}),openModel({title:window.siyuan.languages.recentDocs,icon:"iconList",html:`<ul class="b3-list b3-list--mobile">${n}</ul>`,bindEvent(a){a.firstElementChild.addEventListener("click",i=>{const s=hasClosestByClassName(i.target,"b3-list-item");s&&openMobileFileById(t,s.dataset.nodeId,[Constants.CB_GET_SCROLL])})}})})},so=t=>{if(!t)return"";const e=Ee().extname(t).toLowerCase();return u.SIYUAN_ASSETS_IMAGE.includes(e)?`<img style="max-height: 100%" src="${t}">`:u.SIYUAN_ASSETS_AUDIO.includes(e)?`<audio style="max-width: 100%" controls="controls" src="${t}"></audio>`:u.SIYUAN_ASSETS_VIDEO.includes(e)?`<video style="max-width: 100%" controls="controls" src="${t}"></video>`:t},qL=()=>{Ce().asset.forEach(t=>{const e=t.pdfObject;if(!e)return;const{pdfDocument:n,pdfViewer:a}=e;if(!n)return;const i=t.element.querySelector("#viewerContainer");if(i.clientHeight===0)return;if(i){const o=i.getAttribute("data-scrolltop");o&&(i.scrollTo(0,parseInt(o)),i.removeAttribute("data-scrolltop"))}const s=a.currentScaleValue;(s==="auto"||s==="page-fit"||s==="page-width")&&(a.currentScaleValue=s),a.update()})},s_=(t,e,n,a)=>{let i="";if(u.SIYUAN_ASSETS_AUDIO.includes(t))i=`<div data-node-id="${Lute.NewNodeID()}" data-type="NodeAudio" class="iframe" updated="${Y().format("YYYYMMDDHHmmss")}"><div class="iframe-content"><audio controls="controls" src="${e}" data-src="${e}"></audio>${u.ZWSP}</div><div class="protyle-attr" contenteditable="false">${u.ZWSP}</div></div>`;else if(u.SIYUAN_ASSETS_IMAGE.includes(t)){let s="";e.startsWith("assets/")||(s='<span class="img__net"><svg><use xlink:href="#iconLanguage"></use></svg></span>'),i=`<span contenteditable="false" data-type="img" class="img"><span> </span><span><span class="protyle-action protyle-icons"><span class="protyle-icon protyle-icon--only"><svg><use xlink:href="#iconMore"></use></svg></span></span><img src="${e}" data-src="${e}" alt="${n}" /><span class="protyle-action__drag"></span>${s}<span class="protyle-action__title"></span></span><span> </span></span>`}else u.SIYUAN_ASSETS_VIDEO.includes(t)?i=`<div data-node-id="${Lute.NewNodeID()}" data-type="NodeVideo" class="iframe" updated="${Y().format("YYYYMMDDHHmmss")}"><div class="iframe-content">${u.ZWSP}<video controls="controls" src="${e}" data-src="${e}"></video><span class="protyle-action__drag" contenteditable="false"></span></div><div class="protyle-attr" contenteditable="false">${u.ZWSP}</div></div>`:i=`<span data-type="a" data-href="${e}">${a}</span>`;return i},Zh=(t,e)=>{if(!t||t.length===0)return`<li style="padding-left: 40px;" class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;let n="";return t.forEach((a,i)=>{let s="";e&&(s=`data-id2="${e[i].fileID}"`),n+=`<li style="padding-left: 40px;" class="b3-list-item" ${s} data-id="${a.fileID}">
    <span class="b3-list-item__text" title="${Xe(a.path)} ${a.hSize}">${pe(a.title)}</span>
</li>`}),n};let oo,kl;const o_=(t,e)=>{if(!L(e,"history__side"))return;const a=L(e,"b3-dialog__container");if(!a)return;const i=a.querySelector('[data-type="editors"]'),s=i.firstElementChild,o=i.lastElementChild;oo||(oo=new aa(t,s.lastElementChild,{blockId:"",history:{snapshot:""},action:[u.CB_GET_HISTORY],render:{background:!1,gutter:!1,breadcrumb:!1,breadcrumbDocName:!1},typewriterMode:!1}),Zn(oo.protyle),kl=new aa(t,o.lastElementChild,{blockId:"",action:[u.CB_GET_HISTORY],history:{snapshot:""},render:{background:!1,gutter:!1,breadcrumb:!1,breadcrumbDocName:!1},typewriterMode:!1}),Zn(kl.protyle)),E("/api/repo/openRepoSnapshotDoc",{id:e.getAttribute("data-id")},r=>{s.classList.remove("fn__none");const d=s.querySelector("textarea"),c=Ee().extname(r.data.content).toLowerCase(),f=s.querySelector(".protyle-title__input");u.SIYUAN_ASSETS_IMAGE.concat(u.SIYUAN_ASSETS_AUDIO).concat(u.SIYUAN_ASSETS_VIDEO).includes(c)?(d.previousElementSibling.innerHTML=so(r.data.content),d.previousElementSibling.classList.remove("fn__none"),d.classList.add("fn__none"),s.lastElementChild.classList.add("fn__none")):r.data.displayInText?(d.value=r.data.content,d.classList.remove("fn__none"),s.lastElementChild.classList.add("fn__none"),d.previousElementSibling.classList.add("fn__none")):(d.classList.add("fn__none"),s.lastElementChild.classList.remove("fn__none"),d.previousElementSibling.classList.add("fn__none"),oo.protyle.options.history.snapshot=a.querySelector(".b3-dialog__header code").getAttribute("data-snapshot"),rt({data:r,protyle:oo.protyle,action:[u.CB_GET_HISTORY,u.CB_GET_HTML]})),f.textContent=r.data.title,s.querySelector(".history__date").textContent=Y(r.data.updated).format("YYYY-MM-DD HH:mm")});const l=e.getAttribute("data-id2");l?(o.classList.remove("fn__none"),E("/api/repo/openRepoSnapshotDoc",{id:l},r=>{const d=o.querySelector("textarea"),c=Ee().extname(r.data.content).toLowerCase(),f=o.querySelector(".protyle-title__input");u.SIYUAN_ASSETS_IMAGE.concat(u.SIYUAN_ASSETS_AUDIO).concat(u.SIYUAN_ASSETS_VIDEO).includes(c)?(d.previousElementSibling.innerHTML=so(r.data.content),d.previousElementSibling.classList.remove("fn__none"),d.classList.add("fn__none"),o.lastElementChild.classList.add("fn__none")):r.data.displayInText?(d.value=r.data.content,d.classList.remove("fn__none"),o.lastElementChild.classList.add("fn__none"),d.previousElementSibling.classList.add("fn__none")):(d.classList.add("fn__none"),o.lastElementChild.classList.remove("fn__none"),d.previousElementSibling.classList.add("fn__none"),kl.protyle.options.history.snapshot=a.querySelectorAll(".b3-dialog__header code")[1].getAttribute("data-snapshot"),rt({data:r,protyle:kl.protyle,action:[u.CB_GET_HISTORY,u.CB_GET_HTML]})),f.textContent=r.data.title,o.querySelector(".history__date").textContent=Y(r.data.updated).format("YYYY-MM-DD HH:mm")})):o.classList.add("fn__none")},FL=(t,e)=>{if(e.length!==2)return;let n,a;e[0].time>e[1].time?(n=e[1].id,a=e[0].id):(n=e[0].id,a=e[1].id);const i=new we({title:window.siyuan.languages.compare,content:"",width:W()?"92vw":"90vw",height:"80vh",containerClassName:"b3-dialog__container--theme",destroyCallback(){oo=void 0,kl=void 0}});i.element.setAttribute("data-key",u.DIALOG_HISTORYCOMPARE),i.element.addEventListener("click",s=>{if(typeof s.detail=="string"){o_(t,i.element.querySelector(".history__side .b3-list-item--focus")),s.stopPropagation(),s.preventDefault();return}let o=s.target;for(;o&&o!==i.element;){if(o.classList.contains("b3-list-item")&&!o.dataset.id){o.nextElementSibling.classList.toggle("fn__none"),o.querySelector("svg").classList.toggle("b3-list-item__arrow--open"),s.preventDefault(),s.stopPropagation();break}else if(o.classList.contains("b3-list-item")&&o.dataset.id){if(o.classList.contains("b3-list-item--focus"))return;i.element.querySelector(".history__side .b3-list-item--focus")?.classList.remove("b3-list-item--focus"),o.classList.add("b3-list-item--focus"),o_(t,o),s.preventDefault(),s.stopPropagation();break}else if(o.classList.contains("block__icon")){o.getAttribute("data-direct")==="left"?(o.setAttribute("data-direct","right"),Jh(a,n,i,"right")):(o.setAttribute("data-direct","left"),Jh(n,a,i,"left")),s.preventDefault(),s.stopPropagation();break}o=o.parentElement}}),Jh(n,a,i,"left")},Jh=(t,e,n,a)=>{oo=void 0,kl=void 0;const i=W();E("/api/repo/diffRepoSnapshots",{left:t,right:e},s=>{const o=n.element.querySelector(".b3-dialog__header");o.innerHTML=`<div style="padding: 0;min-height: auto;" class="block__icons">
    <span class="fn__flex-1"></span>
    <code class="fn__code${i?" fn__none":""}" data-snapshot="${t}">${t.substring(0,7)}</code>
    ${i?"":'<span class="fn__space"></span>'}
    ${Y(s.data.left.created).format("YYYY-MM-DD HH:mm")}
    <span class="fn__space"></span>
    <span class="block__icon block__icon--show b3-tooltips b3-tooltips__s" aria-label="${window.siyuan.languages.switchDirect}" data-direct="${a}"><svg><use xlink:href="#iconScrollHoriz"></use></svg></span>
    <span class="fn__space"></span>
    <code class="fn__code${i?" fn__none":""}" data-snapshot="${e}">${e.substring(0,7)}</code>
    ${i?"":'<span class="fn__space"></span>'}
    ${Y(s.data.right.created).format("YYYY-MM-DD HH:mm")}
    <span class="fn__flex-1"></span>
</div>`,o.nextElementSibling.innerHTML=`<div class="fn__flex history__panel" style="height: 100%">
    <div class="history__side" ${W()?"":`style="width: ${window.siyuan.storage[u.LOCAL_HISTORY].sideDiffWidth}"`}>
        <ul class="b3-list b3-list--background">
            <li class="b3-list-item">
                <span class="b3-list-item__toggle b3-list-item__toggle--hl">
                    <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
                </span>
                <span style="padding-left: 4px" class="b3-list-item__text">${window.siyuan.languages.update}</span>
                <span class="counter${s.data.updatesLeft.length===0?" fn__none":""}">${s.data.updatesLeft.length}</span>
            </li>
            <ul class="fn__none">${Zh(s.data.updatesLeft,s.data.updatesRight)}</ul>
        </ul>
        <ul class="b3-list b3-list--background">
            <li class="b3-list-item">
                <span class="b3-list-item__toggle b3-list-item__toggle--hl">
                    <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
                </span>
                <span style="padding-left: 4px" class="b3-list-item__text">${window.siyuan.languages.addAttr}</span>
                <span class="counter${s.data.addsLeft.length===0?" fn__none":""}">${s.data.addsLeft.length}</span>
            </li>
            <ul class="fn__none">${Zh(s.data.addsLeft)}</ul>
        </ul>
        <ul class="b3-list b3-list--background">
            <li class="b3-list-item">
                <span class="b3-list-item__toggle b3-list-item__toggle--hl">
                    <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
                </span>
                <span style="padding-left: 4px" class="b3-list-item__text">${window.siyuan.languages.remove}</span>
                <span class="counter${s.data.removesRight.length===0?" fn__none":""}">${s.data.removesRight.length}</span>
            </li>
            <ul class="fn__none">${Zh(s.data.removesRight)}</ul>
        </ul>
    </div>
    <div class="history__resize"></div>
    <div class="fn__flex-1 fn__flex" data-type="editors">
        <div class="fn__none fn__flex-1 fn__flex-column">
            <div class="history__date">${Y(s.data.left.created).format("YYYY-MM-DD HH:mm")}</div>
            <div class="protyle-title__input ft__center ft__breakword">${s.data.left.title}</div>
            <div class="ft__center"></div>
            <textarea class="history__text fn__none fn__flex-1" readonly></textarea>
            <div class="fn__flex-1"></div>
        </div>
        <div class="fn__none fn__flex-1 fn__flex-column" style="border-left: 1px solid var(--b3-border-color);">
            <div class="history__date">${s.data.right.title} ${Y(s.data.right.created).format("YYYY-MM-DD HH:mm")}</div>
            <div class="protyle-title__input ft__center ft__breakword">${s.data.right.title}</div>
            <div class="ft__center"></div>
            <textarea class="history__text fn__none fn__flex-1" readonly></textarea>
            <div class="fn__flex-1"></div>
        </div>
    </div>
</div>`,xf(n.element.querySelector(".history__resize"),n.element.querySelector(".history__side"),"sideDiffWidth")})};let lo;const Sl=(t,e)=>{const n=t.querySelector('[data-type="docprevious"]'),a=t.querySelector('[data-type="docnext"]');t.setAttribute("data-page",e.toString()),e>1?n.removeAttribute("disabled"):n.setAttribute("disabled","disabled");const i=t.querySelector('button[data-type="jumpHistoryPage"]');i.textContent=`${e}`;const s=t.querySelector(".b3-text-field"),o=t.querySelector('.b3-select[data-type="opselect"]'),l=t.querySelector('.b3-select[data-type="typeselect"]'),r=t.querySelector('.b3-select[data-type="notebookselect"]'),d=t.querySelector('.history__text[data-type="docPanel"]'),c=t.querySelector('.history__text[data-type="assetPanel"]'),f=t.querySelector('.history__text[data-type="mdPanel"]'),g=t.querySelector(".b3-list");t.querySelector(".protyle-title__input").classList.add("fn__none"),c.classList.add("fn__none"),f.classList.add("fn__none"),d.classList.add("fn__none"),l.value==="2"?(r.setAttribute("disabled","disabled"),window.siyuan.storage[u.LOCAL_HISTORY].type!==2&&(o.value="all"),o.querySelector('option[value="clean"]').classList.remove("fn__none"),o.querySelector('option[value="update"]').classList.remove("fn__none"),o.querySelector('option[value="delete"]').classList.add("fn__none"),o.querySelector('option[value="format"]').classList.add("fn__none"),o.querySelector('option[value="sync"]').classList.remove("fn__none"),o.querySelector('option[value="replace"]').classList.add("fn__none"),o.querySelector('option[value="outline"]').classList.add("fn__none")):(r.removeAttribute("disabled"),window.siyuan.storage[u.LOCAL_HISTORY].type===2&&(o.value="all"),o.querySelector('option[value="clean"]').classList.add("fn__none"),o.querySelector('option[value="update"]').classList.remove("fn__none"),o.querySelector('option[value="delete"]').classList.remove("fn__none"),o.querySelector('option[value="format"]').classList.remove("fn__none"),o.querySelector('option[value="sync"]').classList.remove("fn__none"),o.querySelector('option[value="replace"]').classList.remove("fn__none"),o.querySelector('option[value="outline"]').classList.remove("fn__none")),window.siyuan.storage[u.LOCAL_HISTORY].notebookId=r.value,window.siyuan.storage[u.LOCAL_HISTORY].type=parseInt(l.value),window.siyuan.storage[u.LOCAL_HISTORY].operation=o.value,ue(u.LOCAL_HISTORY,window.siyuan.storage[u.LOCAL_HISTORY]),E("/api/history/searchHistory",{notebook:r.value,query:s.value,page:e,op:o.value,type:parseInt(l.value)},p=>{e<p.data.pageCount?a.removeAttribute("disabled"):a.setAttribute("disabled","disabled"),i.setAttribute("data-totalpage",(p.data.pageCount||1).toString());const h=a.nextElementSibling.nextElementSibling;if(h.textContent=`${window.siyuan.languages.pageCountAndHistoryCount.replace("${x}",p.data.pageCount).replace("${y}",p.data.totalCount||1)}`,h.classList.remove("fn__none"),p.data.histories.length===0){g.innerHTML=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;return}let m="";p.data.histories.forEach(b=>{m+=`<li class="b3-list-item" data-type="toggle" data-created="${b}">
    <span class="b3-list-item__toggle b3-list-item__toggle--hl"><svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg></span>
    <span style="padding-left: 4px" class="b3-list-item__text">${Y(parseInt(b)*1e3).format("YYYY-MM-DD HH:mm:ss")}</span>
</li>`}),g.innerHTML=m})},l_=(t,e,n)=>{if(t.data.snapshots.length===0){e.lastElementChild.innerHTML=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;return}let a="";n==="getCloudRepoTagSnapshots"?a=`<span class="b3-list-item__action b3-tooltips b3-tooltips__w" data-type="downloadSnapshot" aria-label="${window.siyuan.languages.download}"><svg><use xlink:href="#iconDownload"></use></svg></span>
<span class="b3-list-item__action b3-tooltips b3-tooltips__w" data-type="removeCloudRepoTagSnapshot" aria-label="${window.siyuan.languages.remove}"><svg><use xlink:href="#iconTrashcan"></use></svg></span>`:n==="getCloudRepoSnapshots"?a=`<span class="b3-list-item__action b3-tooltips b3-tooltips__w" data-type="downloadSnapshot" aria-label="${window.siyuan.languages.download}"><svg><use xlink:href="#iconDownload"></use></svg></span>`:n==="getRepoTagSnapshots"?a=`<span class="b3-list-item__action b3-tooltips b3-tooltips__w" data-type="uploadSnapshot" aria-label="${window.siyuan.languages.upload}"><svg><use xlink:href="#iconUpload"></use></svg></span>
<span class="b3-list-item__action b3-tooltips b3-tooltips__w" data-type="rollback" aria-label="${window.siyuan.languages.rollback}"><svg><use xlink:href="#iconUndo"></use></svg></span>
<span class="b3-list-item__action b3-tooltips b3-tooltips__w" data-type="removeRepoTagSnapshot" aria-label="${window.siyuan.languages.remove}"><svg><use xlink:href="#iconTrashcan"></use></svg></span>`:n==="getRepoSnapshots"&&(a=`<span class="b3-list-item__action b3-tooltips b3-tooltips__w" data-type="genTag" aria-label="${window.siyuan.languages.tagSnapshot}"><svg><use xlink:href="#iconTags"></use></svg></span>
<span class="b3-list-item__action b3-tooltips b3-tooltips__w" data-type="rollback" aria-label="${window.siyuan.languages.rollback}"><svg><use xlink:href="#iconUndo"></use></svg></span>`);let i="";const s=W();t.data.snapshots.forEach(o=>{let l="";o.typesCount&&(l=`<div class="b3-list-item__meta${s?" fn__none":""}">
${window.siyuan.languages.fileCount} ${o.count}<span class="fn__space"></span>`,o.typesCount.forEach(d=>{l+=`${d.type} ${d.count}<span class="fn__space"></span>`}),l+="</div>");const r=`<div${s?' style="padding-top:8px"':""}>
    <span data-type="hCreated">${o.hCreated}</span>
    <span class="fn__space"></span>
    ${o.hSize}
    <span class="fn__space"></span>
    ${o.systemOS}${o.systemName&&o.systemOS?"/":""}${o.systemName}
    <span class="fn__space"></span>
    <span class="b3-chip b3-chip--secondary b3-chip--small${o.tag?"":" fn__none"}">${o.tag}</span>
</div>
<div class="b3-list-item__meta${s?" fn__none":""}">
    ${pe(o.memo)}
    <span class="fn__space"></span>
    <code class="fn__code">${o.id.substring(0,7)}</code>
</div>
${l}`;i+=`<li class="b3-list-item b3-list-item--hide-action" data-type="repoitem" data-id="${o.id}" data-tag="${o.tag}">
<div class="fn__flex-1">${r}</div>
${a}
</li>`}),e.lastElementChild.innerHTML=`${i}`},ts=(t,e)=>{const n=t.querySelector(".b3-select");n.disabled=!0;const a=n.value;t.lastElementChild.innerHTML='<li style="position: relative;height: 100%;"><div class="fn__loading"><img width="64px" src="/stage/loading-pure.svg"></div></li>';const i=t.querySelector('button[data-type="jumpRepoPage"]');i.textContent=`${e}`;const s=t.querySelector('[data-type="previous"]'),o=t.querySelector('[data-type="next"]'),l=o.nextElementSibling.nextElementSibling;t.setAttribute("data-init","true"),a==="getRepoTagSnapshots"||a==="getCloudRepoTagSnapshots"?(E(`/api/repo/${a}`,{},r=>{l_(r,t,a),n.disabled=!1}),s.classList.add("fn__none"),o.classList.add("fn__none"),l.classList.add("fn__none"),i.classList.add("fn__none")):(s.classList.remove("fn__none"),o.classList.remove("fn__none"),i.classList.remove("fn__none"),t.setAttribute("data-page",e.toString()),e>1?s.removeAttribute("disabled"):s.setAttribute("disabled","disabled"),o.setAttribute("disabled","disabled"),E(`/api/repo/${a}`,{page:e},r=>{n.disabled=!1,e<r.data.pageCount?o.removeAttribute("disabled"):o.setAttribute("disabled","disabled"),i.setAttribute("data-totalpage",(r.data.pageCount||1).toString()),l.textContent=`${window.siyuan.languages.pageCountAndSnapshotCount.replace("${x}",r.data.pageCount).replace("${y}",r.data.totalCount||1)}`,l.classList.remove("fn__none"),l_(r,t,a)}))},UL=t=>{t.setAttribute("data-init","true"),E("/api/history/getNotebookHistory",{},e=>{if(e.data.histories.length===0){t.innerHTML=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;return}let n="";e.data.histories.forEach((a,i)=>{n+=`<li class="b3-list-item" style="padding-left: 0" data-type="rmtoggle">
    <span style="padding-left: 8px" class="b3-list-item__toggle"><svg class="b3-list-item__arrow${i===0?" b3-list-item__arrow--open":""}${a.items.length>0?"":" fn__hidden"}"><use xlink:href="#iconRight"></use></svg></span>
    <span class="b3-list-item__text">${a.hCreated}</span>
</li>`,a.items.length>0&&(n+=`<ul class="${i===0?"":"fn__none"}">`,a.items.forEach(s=>{n+=`<li data-type="notebook" data-path="${s.path}" class="b3-list-item b3-list-item--hide-action" style="padding-left: 32px">
    <span class="b3-list-item__text">${pe(s.title)}</span>
    <span class="fn__space"></span>
    <span class="b3-list-item__action b3-tooltips b3-tooltips__w" data-type="rollback" aria-label="${window.siyuan.languages.rollback}">
        <svg><use xlink:href="#iconUndo"></use></svg>
    </span>
</li>`}),n+="</ul>")}),t.innerHTML=n})},Bf=t=>{if(window.siyuan.config.readonly||window.siyuan.dialogs.find(s=>{if(s.element.querySelector("#historyContainer"))return s.destroy(),!0}))return;const n=window.siyuan.storage[u.LOCAL_HISTORY];let a=`<option value='%' ${n.notebookId==="%"?"selected":""}>${window.siyuan.languages.allNotebooks}</option>`;window.siyuan.notebooks.forEach(s=>{s.closed||(a+=` <option value="${s.id}"${s.id===n.notebookId?" selected":""}>${pe(s.name)}</option>`)});const i=`<div class="fn__flex-column" style="height: 100%;">
    <div class="layout-tab-bar fn__flex" ${W()?"":'style="border-radius: var(--b3-border-radius-b) var(--b3-border-radius-b) 0 0"'}>
        <div data-type="doc" class="item item--full item--focus"><span class="fn__flex-1"></span><span class="item__text">${window.siyuan.languages.fileHistory}</span><span class="fn__flex-1"></span></div>
        <div data-type="notebook" style="min-width: 160px" class="item item--full"><span class="fn__flex-1"></span><span class="item__text">${window.siyuan.languages.removedNotebook}</span><span class="fn__flex-1"></span></div>
        <div data-type="repo" class="item item--full"><span class="fn__flex-1"></span><span class="item__text">${window.siyuan.languages.dataSnapshot}</span><span class="fn__flex-1"></span></div>
    </div>
    <div class="fn__flex-1 fn__flex" id="historyContainer">
        <div data-type="doc" class="history__repo fn__block" data-init="true">
            <div class="history__action">
                <div class="block__icons">
                    <span data-type="docprevious" class="block__icon block__icon--show b3-tooltips b3-tooltips__e" disabled="disabled" aria-label="${window.siyuan.languages.previousLabel}"><svg><use xlink:href='#iconLeft'></use></svg></span>
                    <button class="b3-button b3-button--text ft__selectnone" data-type="jumpHistoryPage" data-totalpage="1">1</button>
                    <span data-type="docnext" class="block__icon block__icon--show b3-tooltips b3-tooltips__e" disabled="disabled" aria-label="${window.siyuan.languages.nextLabel}"><svg><use xlink:href='#iconRight'></use></svg></span>
                    <span class="fn__space"></span>
                    <span class="ft__on-surface fn__flex-shrink ft__selectnone fn__none">${window.siyuan.languages.pageCountAndHistoryCount}</span>
                    <span class="fn__space"></span>
                    <div class="fn__flex-1"></div>
                    <div style="position: relative">
                        <svg class="b3-form__icon-icon ft__on-surface"><use xlink:href="#iconSearch"></use></svg>
                        <input class="b3-text-field b3-form__icon-input ${W()?"fn__size96":"fn__size200"}">
                    </div>
                    <span class="fn__space"></span>
                    <select data-type="typeselect" class="b3-select ${W()?"fn__size96":"fn__size200"}">
                        <option value="0" ${n.type===0?"selected":""}>${window.siyuan.languages.docName}</option>
                        <option value="1" ${n.type===1?"selected":""}>${window.siyuan.languages.docNameAndContent}</option>
                        <option value="2" ${n.type===2?"selected":""}>${window.siyuan.languages.assets}</option>
                    </select>
                    <span class="fn__space"></span>
                    <select data-type="opselect" class="b3-select${W()?" fn__size96":""}">
                        <option value="all" ${n.operation==="all"?"selected":""}>${window.siyuan.languages.allOp}</option>
                        <option value="clean" ${n.operation==="clean"?"selected":""}>${window.siyuan.languages.historyClean}</option>
                        <option value="update" ${n.operation==="update"?"selected":""}>${window.siyuan.languages.historyUpdate}</option>
                        <option value="delete" ${n.operation==="delete"?"selected":""}>${window.siyuan.languages.historyDelete}</option>
                        <option value="format" ${n.operation==="format"?"selected":""}>${window.siyuan.languages.historyFormat}</option>
                        <option value="sync" ${n.operation==="sync"?"selected":""}>${window.siyuan.languages.historySync}</option>
                        <option value="replace" ${n.operation==="replace"?"selected":""}>${window.siyuan.languages.historyReplace}</option>
                        <option value="outline" ${n.operation==="outline"?"selected":""}>${window.siyuan.languages.historyOutline}</option>
                    </select>
                    <span class="fn__space"></span>
                    <select data-type="notebookselect" class="b3-select ${W()?"fn__size96":"fn__size200"}">
                        ${a}
                    </select>
                    <span class="fn__space"></span>
                    <button data-type="rebuildIndex" class="b3-button b3-button--outline">${window.siyuan.languages.rebuildIndex}</button>
                </div>
            </div>
            <div class="fn__flex fn__flex-1 history__panel">
                <ul class="b3-list b3-list--background history__side" ${W()?"":`style="width: ${n.sideWidth}"`}>
                    <li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>
                </ul>
                <div class="history__resize"></div>
                <div class="fn__flex-column fn__flex-1">
                    <div class="protyle-title__input ft__center ft__breakword fn__none"></div>
                    <div class="fn__flex-1 history__text fn__none" data-type="assetPanel"></div>
                    <textarea class="fn__flex-1 history__text fn__none" data-type="mdPanel"></textarea>
                    <div class="fn__flex-1 history__text fn__none" style="padding: 0" data-type="docPanel"></div>
                </div>
            </div>
        </div>
        <ul data-type="notebook" style="padding: 8px 0;" class="fn__none b3-list b3-list--background">
            <li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>
        </ul>
        <div data-type="repo" class="fn__none history__repo">
            <div class="history__action">
                <div class="block__icons">
                    <span data-type="previous" class="block__icon block__icon--show b3-tooltips b3-tooltips__e" disabled="disabled" aria-label="${window.siyuan.languages.previousLabel}"><svg><use xlink:href='#iconLeft'></use></svg></span>
                    <button class="b3-button b3-button--text ft__selectnone" data-type="jumpRepoPage" data-totalpage="1">1</button>
                    <span data-type="next" class="block__icon block__icon--show b3-tooltips b3-tooltips__e" disabled="disabled" aria-label="${window.siyuan.languages.nextLabel}"><svg><use xlink:href='#iconRight'></use></svg></span>
                    <span class="fn__space"></span>
                    <span class="ft__on-surface fn__flex-shrink ft__selectnone fn__none">${window.siyuan.languages.pageCountAndSnapshotCount}</span>
                    <span class="fn__space"></span>
                    <div class="fn__flex-1"></div>
                    <select class="b3-select ${W()?"fn__size96":"fn__size200"}">
                        <option value="getRepoSnapshots">${window.siyuan.languages.localSnapshot}</option>
                        <option value="getRepoTagSnapshots">${window.siyuan.languages.localTagSnapshot}</option>
                        <option value="getCloudRepoSnapshots">${window.siyuan.languages.cloudSnapshot}</option>
                        <option value="getCloudRepoTagSnapshots">${window.siyuan.languages.cloudTagSnapshot}</option>
                    </select>
                    <span class="fn__space"></span>
                    <button class="b3-button b3-button--outline" disabled data-type="compare">${window.siyuan.languages.compare}</button>
                    <span class="fn__space"></span>
                    <button class="b3-button b3-button--outline" data-type="genRepo">
                        <svg><use xlink:href="#iconAdd"></use></svg>${window.siyuan.languages.createSnapshot}
                    </button>
                </div>    
            </div>
            <ul class="b3-list b3-list--background fn__flex-1" style="padding-bottom: 8px">
                <li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>
            </ul>
        </div>
    </div>
</div>`;if(W())Dw({html:i,icon:"iconHistory",title:window.siyuan.languages.dataHistory,bindEvent(s){s.firstElementChild.setAttribute("style","background-color:var(--b3-theme-background);height:100%"),r_(t,s.firstElementChild)}});else{const s=new we({content:i,width:"90vw",height:"80vh",containerClassName:"b3-dialog__container--theme",destroyCallback(){lo=void 0}});s.element.setAttribute("data-key",u.DIALOG_HISTORY),s.element.querySelector("input").focus(),r_(t,s.element,s),xf(s.element.querySelector(".history__resize"),s.element.querySelector(".history__side"),"sideWidth")}},r_=(t,e,n)=>{const a=e.querySelector("#historyContainer [data-type=doc]");a.querySelectorAll(".b3-select").forEach(f=>{f.addEventListener("change",()=>{Sl(a,1)})}),a.querySelector(".b3-text-field").addEventListener("input",f=>{f.isComposing||Sl(a,1)}),a.querySelector(".b3-text-field").addEventListener("compositionend",()=>{Sl(a,1)});const i=a.querySelector('.history__text[data-type="docPanel"]'),s=a.querySelector('.history__text[data-type="assetPanel"]'),o=a.querySelector('.history__text[data-type="mdPanel"]'),l=a.querySelector(".protyle-title__input");Sl(a,1),lo=new aa(t,i,{blockId:"",history:{created:""},action:[u.CB_GET_HISTORY],render:{background:!1,gutter:!1,breadcrumb:!1,breadcrumbDocName:!1},typewriterMode:!1}),Zn(lo.protyle);const r=e.querySelector('#historyContainer [data-type="repo"]'),d=e.querySelector('#historyContainer [data-type="doc"]'),c=r.querySelector(".b3-select");c.addEventListener("change",()=>{ts(r,1);const f=e.querySelector(".b3-button[data-type='compare']");f.setAttribute("disabled","disabled"),f.removeAttribute("data-ids")}),e.addEventListener("click",f=>{let g=f.target;for(;g&&!g.isEqualNode(e);){const p=g.getAttribute("data-type");if(g.classList.contains("item")){g.parentElement.querySelector(".item--focus").classList.remove("item--focus"),Array.from(e.querySelector("#historyContainer").children).forEach(h=>{h.getAttribute("data-type")===p?(h.classList.remove("fn__none"),h.classList.add("fn__block"),g.classList.add("item--focus"),h.getAttribute("data-init")!=="true"&&(p==="notebook"?UL(h):p==="repo"&&ts(h,1))):(h.classList.add("fn__none"),h.classList.remove("fn__block"))}),f.stopPropagation(),f.preventDefault();break}else if(g.classList.contains("b3-list-item__action")&&p==="rollback"&&!window.siyuan.config.readonly){const h=g.parentElement.getAttribute("data-type");let m=g.previousElementSibling.previousElementSibling.textContent.trim(),b=Y(parseInt(g.parentElement.getAttribute("data-created"))*1e3).format("YYYY-MM-DD HH:mm:ss");h==="notebook"?b=g.parentElement.parentElement.previousElementSibling.textContent.trim():h==="repoitem"&&(m=window.siyuan.languages.workspaceData,b=g.parentElement.querySelector("span[data-type='hCreated']").textContent.trim());const y=window.siyuan.languages.rollbackConfirm.replace("${name}",m).replace("${time}",b);xe("\u26A0\uFE0F "+window.siyuan.languages.rollback,y,()=>{h==="assets"?E("/api/history/rollbackAssetsHistory",{historyPath:g.parentElement.getAttribute("data-path")}):h==="doc"?E("/api/history/rollbackDocHistory",{notebook:g.parentElement.getAttribute("data-notebook-id"),historyPath:g.parentElement.getAttribute("data-path")}):h==="notebook"?E("/api/history/rollbackNotebookHistory",{historyPath:g.parentElement.getAttribute("data-path")}):E("/api/repo/checkoutRepo",{id:g.parentElement.getAttribute("data-id")})}),f.stopPropagation(),f.preventDefault();break}else if(p==="more"){g.parentElement.parentElement.querySelectorAll(".b3-list-item__meta").forEach(h=>{h.classList.toggle("fn__none")}),f.stopPropagation(),f.preventDefault();break}else if(p==="toggle"){const h=g.firstElementChild.firstElementChild;if(h.classList.contains("b3-list-item__arrow--open"))g.nextElementSibling.classList.add("fn__none"),h.classList.remove("b3-list-item__arrow--open");else if(g.nextElementSibling&&g.nextElementSibling.tagName==="UL")g.nextElementSibling.classList.remove("fn__none"),h.classList.add("b3-list-item__arrow--open");else{const m=a.querySelector(".b3-text-field"),b=a.querySelector('.b3-select[data-type="opselect"]'),y=a.querySelector('.b3-select[data-type="typeselect"]'),w=a.querySelector('.b3-select[data-type="notebookselect"]'),_=g.getAttribute("data-created");E("/api/history/getHistoryItems",{notebook:w.value,query:m.value,op:b.value,type:parseInt(y.value),created:_},x=>{h.classList.add("b3-list-item__arrow--open");let S="",k="";x.data.items.forEach(A=>{let $=" b3-chip b3-chip--list ";A.op==="clean"?($+="b3-chip--primary ",k=window.siyuan.languages.historyClean):A.op==="update"?($+="b3-chip--info ",k=window.siyuan.languages.historyUpdate):A.op==="delete"?($+="b3-chip--error ",k=window.siyuan.languages.historyDelete):A.op==="format"?($+="b3-chip--pink ",k=window.siyuan.languages.historyFormat):A.op==="sync"?($+="b3-chip--success ",k=window.siyuan.languages.historySync):A.op==="replace"?($+="b3-chip--secondary ",k=window.siyuan.languages.historyReplace):A.op==="outline"&&($+="b3-chip--warning ",k=window.siyuan.languages.historyOutline),S+=`<li data-notebook-id="${A.notebook}" data-created="${_}" data-type="${y.value==="2"?"assets":"doc"}" data-path="${A.path}" class="b3-list-item b3-list-item--hide-action" style="padding-left: 22px">
    <span class="${b.value==="all"?"":"fn__none"}${$}ariaLabel" data-position="6south" aria-label="${k}">${A.op.substring(0,1).toUpperCase()}</span>
    <span class="b3-list-item__text" title="${Xe(A.title)}">${pe(A.title)}</span>
    <span class="fn__space"></span>
    <span class="b3-list-item__action ariaLabel" data-type="rollback" data-position="6south" aria-label="${window.siyuan.languages.rollback}">
        <svg><use xlink:href="#iconUndo"></use></svg>
    </span>
</li>`}),g.insertAdjacentHTML("afterend",`<ul>${S}</ul>`)})}f.stopPropagation(),f.preventDefault();break}else if(p==="rmtoggle"){g.nextElementSibling.classList.toggle("fn__none"),g.firstElementChild.firstElementChild.classList.toggle("b3-list-item__arrow--open"),f.stopPropagation(),f.preventDefault();break}else if(g.classList.contains("b3-list-item")&&p==="repoitem"&&["getRepoSnapshots","getRepoTagSnapshots"].includes(c.value)){const h=e.querySelector(".b3-button[data-type='compare']"),m=JSON.parse(h.getAttribute("data-ids")||"[]"),b=g.getAttribute("data-id");if(g.classList.contains("b3-list-item--focus"))g.classList.remove("b3-list-item--focus"),m.forEach((y,w)=>{b===y.id&&m.splice(w,1)});else{for(g.classList.add("b3-list-item--focus");m.length>1;)m[0].id!==b&&g.parentElement.querySelector(`.b3-list-item[data-id="${m.splice(0,1)[0].id}"]`)?.classList.remove("b3-list-item--focus");m.push({id:b,time:g.querySelector('[data-type="hCreated"]').textContent})}m.length===2?h.removeAttribute("disabled"):h.setAttribute("disabled","disabled"),h.setAttribute("data-ids",JSON.stringify(m)),f.stopPropagation(),f.preventDefault();break}else if(g.classList.contains("b3-list-item")&&(p==="assets"||p==="doc")){const h=g.getAttribute("data-path");if(p==="assets")s.classList.remove("fn__none"),s.innerHTML=so(h);else if(p==="doc"){const b=a.querySelector(".b3-text-field").value;E("/api/history/getDocHistoryContent",{historyPath:h,highlight:!qn(),k:b},y=>{y.data.isLargeDoc?(o.value=y.data.content,o.classList.remove("fn__none"),i.classList.add("fn__none")):(o.classList.add("fn__none"),i.classList.remove("fn__none"),lo.protyle.options.history.created=g.dataset.created,rt({data:y,protyle:lo.protyle,action:[u.CB_GET_HISTORY,u.CB_GET_HTML]}),ac(lo.protyle,b.split(" ")))})}l.classList.remove("fn__none"),l.textContent=g.querySelector(".b3-list-item__text").textContent;let m=L(g,"b3-list");m&&(m=m.querySelector(".b3-list-item--focus"),m&&m.classList.remove("b3-list-item--focus")),g.classList.add("b3-list-item--focus"),f.stopPropagation(),f.preventDefault();break}else if(p==="genRepo"){const h=new we({title:window.siyuan.languages.snapshotMemo,content:`<div class="b3-dialog__content">
    <textarea class="b3-text-field fn__block" placeholder="${window.siyuan.languages.snapshotMemoTip}"></textarea>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:W()?"92vw":"520px"});h.element.setAttribute("data-key",u.DIALOG_SNAPSHOTMEMO);const m=h.element.querySelector("textarea");m.focus();const b=h.element.querySelectorAll(".b3-button");h.bindInput(m,()=>{b[1].click()}),b[0].addEventListener("click",()=>{h.destroy()}),b[1].addEventListener("click",()=>{E("/api/repo/createSnapshot",{memo:m.value},()=>{ts(r,1)}),h.destroy()}),f.stopPropagation(),f.preventDefault();break}else if(p==="removeRepoTagSnapshot"||p==="removeCloudRepoTagSnapshot"){const h=g.parentElement.getAttribute("data-tag");xe(window.siyuan.languages.deleteOpConfirm,`${window.siyuan.languages.confirmDelete} <i>${h}</i>?`,()=>{E("/api/repo/"+p,{tag:h},()=>{ts(r,1)})},void 0,!0),f.stopPropagation(),f.preventDefault();break}else if(p==="uploadSnapshot"){E("/api/repo/uploadCloudSnapshot",{tag:g.parentElement.getAttribute("data-tag"),id:g.parentElement.getAttribute("data-id")}),f.stopPropagation(),f.preventDefault();break}else if(p==="downloadSnapshot"){E("/api/repo/downloadCloudSnapshot",{tag:g.parentElement.getAttribute("data-tag"),id:g.parentElement.getAttribute("data-id")}),f.stopPropagation(),f.preventDefault();break}else if(p==="genTag"){const h=new we({title:window.siyuan.languages.tagSnapshot,content:`<div class="b3-dialog__content">
    <input class="b3-text-field fn__block" value="${Y().format("YYYYMMDDHHmmss")}" placeholder="${window.siyuan.languages.tagSnapshotTip}">
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.tagSnapshot}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.tagSnapshotUpload}</button>
</div>`,width:W()?"92vw":"520px"});h.element.setAttribute("data-key",u.DIALOG_SNAPSHOTTAG);const m=h.element.querySelector(".b3-text-field");m.select();const b=h.element.querySelectorAll(".b3-button");b[0].addEventListener("click",()=>{h.destroy()}),b[2].addEventListener("click",()=>{E("/api/repo/tagSnapshot",{id:g.parentElement.getAttribute("data-id"),name:m.value},()=>{E("/api/repo/uploadCloudSnapshot",{tag:m.value,id:g.parentElement.getAttribute("data-id")},()=>{ts(r,1)})}),h.destroy()}),b[1].addEventListener("click",()=>{E("/api/repo/tagSnapshot",{id:g.parentElement.getAttribute("data-id"),name:m.value},()=>{ts(r,1)}),h.destroy()}),f.stopPropagation(),f.preventDefault();break}else if((p==="previous"||p==="next")&&g.getAttribute("disabled")!=="disabled"){const h=parseInt(r.getAttribute("data-page"));ts(r,p==="previous"?h-1:h+1),f.stopPropagation(),f.preventDefault();break}else if(p==="jumpRepoPage"){const h=parseInt(r.getAttribute("data-page")),m=parseInt(g.getAttribute("data-totalpage")||"1");m>1&&xe(window.siyuan.languages.jumpToPage.replace("${x}",m),`<input class="b3-text-field fn__block" type="number" min="1" max="${m}" value="${h}">`,b=>{const y=b.element.querySelector(".b3-text-field");if(y.value==="")return;let w=parseInt(y.value);w=Math.max(1,Math.min(w,m)),ts(r,w)})}else if(p==="jumpHistoryPage"){const h=parseInt(d.getAttribute("data-page")),m=parseInt(g.getAttribute("data-totalpage")||"1");m>1&&xe(window.siyuan.languages.jumpToPage.replace("${x}",m),`<input class="b3-text-field fn__block" type="number" min="1" max="${m}" value="${h}">`,b=>{const y=b.element.querySelector(".b3-text-field");if(y.value==="")return;let w=parseInt(y.value);w=Math.max(1,Math.min(w,m)),Sl(a,w)})}else if((p==="docprevious"||p==="docnext")&&g.getAttribute("disabled")!=="disabled"){const h=parseInt(a.getAttribute("data-page"));Sl(a,p==="docprevious"?h-1:h+1),f.stopPropagation(),f.preventDefault();break}else if(p==="rebuildIndex"){E("/api/history/reindexHistory"),n?n.destroy():(XL(),lo=void 0),f.stopPropagation(),f.preventDefault();break}else if(p==="compare"&&!g.getAttribute("disabled")){FL(t,JSON.parse(g.getAttribute("data-ids")||"[]")),f.stopPropagation(),f.preventDefault();break}g=g.parentElement}})},L0=t=>{setTitle(window.siyuan.languages.siyuanNote),document.getElementById("toolbarName").classList.add("fn__hidden"),document.getElementById("editor").classList.add("fn__none");const e=document.getElementById("empty");e.classList.remove("fn__none"),e.innerHTML===""&&(e.innerHTML=`<div id="emptySearch" class="b3-list-item">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconSearch"></use></svg><span class="fn__space"></span><span class="b3-list-item__text">${window.siyuan.languages.search}</span>
</div>
<div id="emptyRecent" class="b3-list-item">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconList"></use></svg><span class="fn__space"></span><span class="b3-list-item__text">${window.siyuan.languages.recentDocs}</span>
</div>
<div id="emptyHistory" class="b3-list-item${window.siyuan.config.readonly?" fn__none":""}">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconHistory"></use></svg><span class="fn__space"></span><span class="b3-list-item__text">${window.siyuan.languages.dataHistory}</span>
</div>
<div id="emptyNewFile" class="b3-list-item${getOpenNotebookCount()>0||!window.siyuan.config.readonly?"":" fn__none"}">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg><span class="fn__space"></span><span class="b3-list-item__text">${window.siyuan.languages.newFile}</span>
</div>
<div class="b3-list-item" id="emptyNewNotebook${window.siyuan.config.readonly?" fn__none":""}">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconFilesRoot"></use></svg><span class="fn__space"></span><span class="b3-list-item__text">${window.siyuan.languages.newNotebook}</span>
</div>
<div class="b3-list-item${isIPhone()||window.siyuan.config.readonly?" fn__none":""}" id="emptyHelp">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconHelp"></use></svg><span class="fn__space"></span><span class="b3-list-item__text">${window.siyuan.languages.userGuide}</span>
</div>`,e.addEventListener("click",n=>{let a=n.target;for(;a&&!a.isEqualNode(e);){if(a.id==="emptySearch"){popSearch(t),n.stopPropagation(),n.preventDefault();break}else if(a.id==="emptyRecent"){getRecentDocs(t),n.stopPropagation(),n.preventDefault();break}else if(a.id==="emptyHistory"){openHistory(t),n.stopPropagation(),n.preventDefault();break}else if(a.id==="emptyNewFile"){newFile({app:t,useSavePath:!0}),n.stopPropagation(),n.preventDefault();break}else if(a.id==="emptyNewNotebook"){newNotebook(),n.stopPropagation(),n.preventDefault();break}else if(a.id==="emptyHelp"){mountHelp(),n.stopPropagation(),n.preventDefault();break}a=a.parentElement}}))},WL=()=>{const t=document.getElementById("toolbarName");Oc(t.value),t.classList.remove("fn__hidden"),document.getElementById("editor").classList.remove("fn__none"),document.getElementById("empty").classList.add("fn__none")},qf=()=>window.siyuan.mobile.popEditor||window.siyuan.mobile.editor,YL=(t,e,n=[u.CB_GET_HL])=>{window.siyuan.storage[u.LOCAL_DOCINFO]={id:e},ue(u.LOCAL_DOCINFO,window.siyuan.storage[u.LOCAL_DOCINFO]);const a=document.querySelector(".av__panel");if(a&&!a.classList.contains("fn__none")&&a.dispatchEvent(new CustomEvent("click",{detail:"close"})),window.siyuan.mobile.editor){ic(window.siyuan.mobile.editor.protyle),Q(["toolbar","hint","util"],window.siyuan.mobile.editor.protyle),window.siyuan.mobile.editor.protyle.contentElement.classList.contains("fn__none")&&mo(window.siyuan.mobile.editor.protyle,"wysiwyg");let i;if(Array.from(window.siyuan.mobile.editor.protyle.wysiwyg.element.querySelectorAll(`[data-node-id="${e}"]`)).find(s=>{if(!F(s))return i=s,!0}),i){nm(),Ne(window.siyuan.mobile.editor.protyle,i,!0),p_();return}}E("/api/block/getBlockInfo",{id:e},i=>{if(i.code===3){j(i.msg);return}const s={blockId:e,rootId:i.data.rootID,action:n,render:{scroll:!0,title:!0,background:!0,gutter:!0},typewriterMode:!0,preview:{actions:["mp-wechat","zhihu","yuque"]}};window.siyuan.mobile.editor?(window.siyuan.mobile.editor.protyle.title.element.removeAttribute("data-render"),nm(),ho(window.siyuan.mobile.editor.protyle),window.siyuan.mobile.editor.protyle.block.rootID!==i.data.rootID&&(window.siyuan.mobile.editor.protyle.wysiwyg.element.innerHTML=""),n.includes(u.CB_GET_SCROLL)&&window.siyuan.storage[u.LOCAL_FILEPOSITION][i.data.rootID]?Nh({protyle:window.siyuan.mobile.editor.protyle,scrollAttr:window.siyuan.storage[u.LOCAL_FILEPOSITION][i.data.rootID],mergedOptions:s,cb(){t.plugins.forEach(o=>{o.eventBus.emit("switch-protyle",{protyle:window.siyuan.mobile.editor.protyle})})}}):E("/api/filetree/getDoc",{id:e,size:n.includes(u.CB_GET_ALL)?u.SIZE_GET_MAX:window.siyuan.config.editor.dynamicLoadBlocks,mode:n.includes(u.CB_GET_CONTEXT)?3:0},o=>{rt({data:o,protyle:window.siyuan.mobile.editor.protyle,action:n,afterCB(){t.plugins.forEach(l=>{l.eventBus.emit("switch-protyle",{protyle:window.siyuan.mobile.editor.protyle})})}})}),window.siyuan.mobile.editor.protyle.undo.clear()):window.siyuan.mobile.editor=new aa(t,document.getElementById("editor"),s),WL(),p_()})};class ro{constructor(e,n){this.element=document.createElement("button");const a=n.hotkey?` ${X(n.hotkey)}`:"",i=n.tip||window.siyuan.languages[n.lang];this.element.classList.add("protyle-toolbar__item","b3-tooltips",`b3-tooltips__${n.tipPosition}`),this.element.setAttribute("data-type",n.name),this.element.setAttribute("aria-label",i+a),this.element.innerHTML=`<svg><use xlink:href="#${n.icon}"></use></svg>`,!["text","a","block-ref","inline-math","inline-memo"].includes(n.name)&&this.element.addEventListener(Gr(),s=>{s.preventDefault(),u.INLINE_TYPE.includes(n.name)?e.toolbar.setInlineMark(e,n.name,"toolbar"):n.click&&n.click(e.getInstance())})}}class zL extends ro{constructor(e,n){super(e,n),this.element.addEventListener("click",()=>{e.toolbar.element.classList.add("fn__none"),e.toolbar.subElement.innerHTML="",e.toolbar.subElement.style.width="",e.toolbar.subElement.style.padding="",e.toolbar.subElement.append(Xh(e,c_(e))),e.toolbar.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),e.toolbar.subElement.classList.remove("fn__none"),e.toolbar.subElementCloseCB=void 0,Z(e.toolbar.range);const a=ta(e.wysiwyg.element,e.toolbar.range);ke(e.toolbar.subElement,a.left,a.top+18,26)})}}const Xh=(t,e)=>{let n="";["","var(--b3-font-color1)","var(--b3-font-color2)","var(--b3-font-color3)","var(--b3-font-color4)","var(--b3-font-color5)","var(--b3-font-color6)","var(--b3-font-color7)","var(--b3-font-color8)","var(--b3-font-color9)","var(--b3-font-color10)","var(--b3-font-color11)","var(--b3-font-color12)","var(--b3-font-color13)"].forEach(c=>{n+=`<button ${c?`class="color__square" style="color:${c}"`:`class="color__square ariaLabel" data-position="3south" aria-label="${window.siyuan.languages.default}"`} data-type="color">A</button>`});let a="";["","var(--b3-font-background1)","var(--b3-font-background2)","var(--b3-font-background3)","var(--b3-font-background4)","var(--b3-font-background5)","var(--b3-font-background6)","var(--b3-font-background7)","var(--b3-font-background8)","var(--b3-font-background9)","var(--b3-font-background10)","var(--b3-font-background11)","var(--b3-font-background12)","var(--b3-font-background13)"].forEach(c=>{a+=`<button ${c?`class="color__square" style="background-color:${c}"`:`class="color__square ariaLabel" data-position="3south" aria-label="${window.siyuan.languages.default}"`} data-type="backgroundColor"></button>`});const i=document.createElement("div");i.classList.add("protyle-font");let s=!1;e?.find(c=>{if(c.classList.contains("list")||c.classList.contains("li"))return s=!0,!0});let o="";const l=window.siyuan.storage[u.LOCAL_FONTSTYLES];l.length>0&&(o=`<div class="fn__flex">
    ${window.siyuan.languages.lastUsed}
    <span class="fn__space"></span>
    <kbd class="fn__kbd fn__flex-center">${X(window.siyuan.config.keymap.editor.insert.lastUsed.custom)}</kbd>
</div>
<div class="fn__hr--small"></div>
<div class="fn__flex fn__flex-wrap" style="align-items: center">`,l.forEach(c=>{const f=c.split(u.ZWSP);switch(f[0]){case"color":o+=`<button class="color__square ariaLabel" data-position="3south" aria-label="${window.siyuan.languages.colorFont}${f[1]?"":" "+window.siyuan.languages.default}" ${f[1]?`style="color:${f[1]}"`:""} data-type="${f[0]}">A</button>`;break;case"backgroundColor":o+=`<button class="color__square ariaLabel" data-position="3south" aria-label="${window.siyuan.languages.colorPrimary}${f[1]?"":" "+window.siyuan.languages.default}" ${f[1]?`style="background-color:${f[1]}"`:""} data-type="${f[0]}"></button>`;break;case"style2":o+=`<button data-type="${f[0]}" class="protyle-font__style" style="-webkit-text-stroke: 0.2px var(--b3-theme-on-background);-webkit-text-fill-color : transparent;">${window.siyuan.languages.hollow}</button>`;break;case"style4":o+=`<button data-type="${f[0]}" class="protyle-font__style" style="text-shadow: 1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)">${window.siyuan.languages.shadow}</button>`;break;case"fontSize":s||(o+=`<button data-type="${f[0]}" class="protyle-font__style">${f[1]}</button>`);break;case"style1":o+=`<button class="color__square ariaLabel" data-position="3south" aria-label="${window.siyuan.languages.color}${f[1]?"":" "+window.siyuan.languages.default}" ${f[1]?`style="background-color:${f[1]};color:${f[2]}"`:""} data-type="${f[0]}">A</button>`;break;case"clear":o+=`<button style="height: 26px;display: flex;align-items: center;padding: 0 5px;" data-type="${f[0]}" class="protyle-font__style ariaLabel" aria-label="${window.siyuan.languages.clearFontStyle}"><svg class="svg--mid"><use xlink:href="#iconTrashcan"></use></svg></button>`;break}}),o+="</div>");let r,d="16px";return e&&e.length>0?r=e[0]:(r=t.toolbar.range.cloneContents().querySelector('[data-type~="text"]'),r||(r=B(t.toolbar.range.startContainer,"data-type","text"))),r&&(d=r.style.fontSize||"16px"),i.innerHTML=`${o}
<div class="fn__hr"></div>
<div>${window.siyuan.languages.color}</div>
<div class="fn__hr--small"></div>
<div class="fn__flex fn__flex-wrap">
    <button class="color__square ariaLabel" data-position="3south" data-type="style1" aria-label="${window.siyuan.languages.default}">A</button>
    <button class="color__square" data-type="style1" style="color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);">A</button>
    <button class="color__square" data-type="style1" style="color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);">A</button>
    <button class="color__square" data-type="style1" style="color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);">A</button>
    <button class="color__square" data-type="style1" style="color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);">A</button>
</div>
<div class="fn__hr"></div>
<div>${window.siyuan.languages.colorFont}</div>
<div class="fn__hr--small"></div>
<div class="fn__flex fn__flex-wrap">
    ${n}
</div>
<div class="fn__hr"></div>
<div>${window.siyuan.languages.colorPrimary}</div>
<div class="fn__hr--small"></div>
<div class="fn__flex fn__flex-wrap">
    ${a}
</div>
<div class="fn__hr"></div>
<div>${window.siyuan.languages.fontStyle}</div>
<div class="fn__hr--small"></div>
<div class="fn__flex">
    <button data-type="style2" class="protyle-font__style" style="-webkit-text-stroke: 0.2px var(--b3-theme-on-background);-webkit-text-fill-color : transparent;">${window.siyuan.languages.hollow}</button>
    <button data-type="style4" class="protyle-font__style" style="text-shadow: 1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)">${window.siyuan.languages.shadow}</button>
</div>
<div class="fn__hr${s?" fn__none":""}"></div>
<div class="${s?" fn__none":""}">${window.siyuan.languages.fontSize}</div>
<div class="fn__hr--small${s?" fn__none":""}"></div>
<div class="fn__flex${s?" fn__none":""}">
    <div class="fn__space--small"></div>
    <select class="b3-select fn__block">
        <option ${d==="12px"?"selected":""} value="12px">12px</option>
        <option ${d==="13px"?"selected":""} value="13px">13px</option>
        <option ${d==="14px"?"selected":""} value="14px">14px</option>
        <option ${d==="15px"?"selected":""} value="15px">15px</option>
        <option ${d==="16px"?"selected":""} value="16px">16px</option>
        <option ${d==="19px"?"selected":""} value="19px">19px</option>
        <option ${d==="22px"?"selected":""} value="22px">22px</option>
        <option ${d==="24px"?"selected":""} value="24px">24px</option>
        <option ${d==="29px"?"selected":""} value="29px">29px</option>
        <option ${d==="32px"?"selected":""} value="32px">32px</option>
        <option ${d==="40px"?"selected":""} value="40px">40px</option>
        <option ${d==="48px"?"selected":""} value="48px">48px</option>
    </select>
    <div class="fn__space--small"></div>
</div>
<div class="fn__hr--b"></div>
<div class="fn__flex">
    <div class="fn__space--small"></div>
    <button class="b3-button b3-button--remove fn__block" data-type="clear">
        <svg><use xlink:href="#iconTrashcan"></use></svg>${window.siyuan.languages.clearFontStyle}
    </button>
    <div class="fn__space--small"></div>
</div>`,i.addEventListener("click",function(c){let f=c.target;for(;f&&!f.isEqualNode(i);){const g=f.getAttribute("data-type");if(f.tagName==="BUTTON"){g==="style1"?ns(t,e,g,f.style.backgroundColor+u.ZWSP+f.style.color):g==="fontSize"?ns(t,e,g,f.textContent.trim()):g==="backgroundColor"?ns(t,e,g,f.style.backgroundColor):g==="color"?ns(t,e,g,f.style.color):ns(t,e,g);break}f=f.parentElement}}),i.querySelector("select").addEventListener("change",function(c){ns(t,e,"fontSize",c.target.value)}),i},ns=(t,e,n,a)=>{let i=window.siyuan.storage[u.LOCAL_FONTSTYLES];if(n)i.splice(0,0,`${n}${u.ZWSP}${a}`),i=[...new Set(i)],i.length>8&&i.splice(8,1),window.siyuan.storage[u.LOCAL_FONTSTYLES]=i,ue(u.LOCAL_FONTSTYLES,window.siyuan.storage[u.LOCAL_FONTSTYLES]);else if(i.length===0)n="style1",a="var(--b3-card-error-color)"+u.ZWSP+"var(--b3-card-error-background)";else{const s=i[0].split(u.ZWSP);n=s.splice(0,1)[0],a=s.join(u.ZWSP)}e&&e.length>0?(ds(e,t,s=>{if(n==="clear")s.style.color="",s.style.webkitTextFillColor="",s.style.webkitTextStroke="",s.style.textShadow="",s.style.backgroundColor="",s.style.fontSize="",s.style.removeProperty("--b3-parent-background");else if(n==="style1"){const o=a.split(u.ZWSP);s.style.backgroundColor=o[0],s.style.color=o[1],s.style.setProperty("--b3-parent-background",o[0])}else n==="style2"?(s.style.webkitTextStroke="0.2px var(--b3-theme-on-background)",s.style.webkitTextFillColor="transparent"):n==="style4"?s.style.textShadow="1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)":n==="color"?s.style.color=a:n==="backgroundColor"?(s.style.backgroundColor=a,s.style.setProperty("--b3-parent-background",a)):n==="fontSize"&&(s.style.fontSize=a);(n==="fontSize"||n==="clear")&&s.getAttribute("data-type")==="NodeCodeBlock"&&Ol(s.querySelector(".hljs"))}),Z(t.toolbar.range)):n==="clear"?t.toolbar.setInlineMark(t,"clear","range",{type:"text"}):t.toolbar.setInlineMark(t,"text","range",{type:n,color:a})},Qh=(t,e)=>{const n=s=>{const o=s.split(u.ZWSP);t.setAttribute("data-id",o.splice(0,1)[0]),t.setAttribute("data-subtype",o.splice(0,1)[0]),t.removeAttribute("data-href"),t.innerText=o.join("")},a=s=>{const o=s.split(u.ZWSP);t.setAttribute("data-href",o[0]),t.removeAttribute("data-subtype"),t.removeAttribute("data-id"),o[1]&&(t.textContent=o[1])},i=s=>{const o=s.split(u.ZWSP);t.setAttribute("data-id",o[0]),t.removeAttribute("data-href"),t.removeAttribute("data-subtype"),o[1]&&(t.textContent=o[1])};if(e){switch(e.type){case"color":t.style.color=e.color;break;case"fontSize":t.style.fontSize=e.color;break;case"backgroundColor":t.style.backgroundColor=e.color;break;case"style1":t.style.backgroundColor=e.color.split(u.ZWSP)[0],t.style.color=e.color.split(u.ZWSP)[1];break;case"style2":t.style.webkitTextStroke="0.2px var(--b3-theme-on-background)",t.style.webkitTextFillColor="transparent";break;case"style4":t.style.textShadow="1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)";break;case"id":n(e.color);break;case"inline-math":t.className="render-node",t.setAttribute("contenteditable","false"),t.setAttribute("data-subtype","math"),t.setAttribute("data-content",t.textContent.replace(u.ZWSP,"")),t.removeAttribute("data-render"),t.textContent="";break;case"a":a(e.color);break;case"file-annotation-ref":i(e.color);break;case"inline-memo":t.removeAttribute("contenteditable"),t.removeAttribute("data-subtype"),t.removeAttribute("data-content");break}t.getAttribute("style")||t.removeAttribute("style")}},Ll=(t,e,n)=>{if(!n)return t.nodeType!==3&&e.nodeType!==3&&e.style.color===t.style.color&&e.style.webkitTextFillColor===t.style.webkitTextFillColor&&e.style.webkitTextStroke===t.style.webkitTextStroke&&e.style.textShadow===t.style.textShadow&&e.style.backgroundColor===t.style.backgroundColor&&e.style.fontSize===t.style.fontSize;if(n.type==="inline-math"||n.type==="inline-memo"||n.type==="a")return!1;if(n.type==="id"){if(t.nodeType!==3)return t.getAttribute("data-id")===e.getAttribute("data-id")&&t.getAttribute("data-subtype")===e.getAttribute("data-subtype")&&t.textContent===e.textContent;const d=n.color.split(u.ZWSP);return d[0]===e.getAttribute("data-id")&&d[1]===e.getAttribute("data-subtype")&&d[2]===e.textContent}if(n.type==="file-annotation-ref")return t.nodeType!==3?t.getAttribute("data-id")===e.getAttribute("data-id")&&t.textContent===e.textContent:n.color===e.getAttribute("data-id");let a="",i="",s="",o="",l="",r="";return t.nodeType!==3&&(a=t.style.color,i=t.style.webkitTextFillColor,s=t.style.webkitTextStroke,o=t.style.textShadow,l=t.style.backgroundColor,r=t.style.fontSize),n.type==="text"?a===e.style.color&&i===e.style.webkitTextFillColor&&s===e.style.webkitTextStroke&&o===e.style.textShadow&&r===e.style.fontSize&&l===e.style.backgroundColor:n.type==="color"?n.color===e.style.color&&i===e.style.webkitTextFillColor&&s===e.style.webkitTextStroke&&o===e.style.textShadow&&r===e.style.fontSize&&l===e.style.backgroundColor:n.type==="backgroundColor"?a===e.style.color&&i===e.style.webkitTextFillColor&&s===e.style.webkitTextStroke&&o===e.style.textShadow&&r===e.style.fontSize&&n.color===e.style.backgroundColor:n.type==="style1"?n.color.split(u.ZWSP)[0]===e.style.color&&i===e.style.webkitTextFillColor&&s===e.style.webkitTextStroke&&o===e.style.textShadow&&r===e.style.fontSize&&n.color.split(u.ZWSP)[1]===e.style.backgroundColor:n.type==="style2"?a===e.style.color&&e.style.webkitTextFillColor==="transparent"&&e.style.webkitTextStroke==="0.2px var(--b3-theme-on-background)"&&o===e.style.textShadow&&r===e.style.fontSize&&l===e.style.backgroundColor:n.type==="style4"?a===e.style.color&&i===e.style.webkitTextFillColor&&s===e.style.webkitTextStroke&&r===e.style.fontSize&&e.style.textShadow==="1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)"&&l===e.style.backgroundColor:n.type==="fontSize"?a===e.style.color&&i===e.style.webkitTextFillColor&&s===e.style.webkitTextStroke&&o===e.style.textShadow&&n.color===e.style.fontSize&&l===e.style.backgroundColor:!0},c_=t=>{let e;if(t.toolbar.range.toString()===""&&(e=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select")),e.length===0)){const n=P(t.toolbar.range.startContainer);n&&(e=[n])}return e},VL=(t,e,n)=>{if(L(t,"protyle-wysiwyg__embed"))return;const a=Ln(t);if(!a&&t.classList.contains("protyle-wysiwyg--select")){Pt(le(t),e,!1),e.collapse(!1),Q(["select"],n);return}if(a||t.classList.contains("table")){if(t.parentElement.classList.contains("li")){const _=t.parentElement.parentElement.outerHTML,x=os(t.parentElement,0,!0);t.parentElement.insertAdjacentElement("afterend",x),J(n,t.parentElement.parentElement.getAttribute("data-node-id"),t.parentElement.parentElement.outerHTML,_),he(x,e),fc(x),Ne(n);return}if(t.classList.contains("hr")){_n(n,"afterend");return}t.classList.contains("protyle-wysiwyg--select")&&t.classList.contains("render-node")?n.toolbar.showRender(n,t):_n(n,"afterend");return}const i=le(t);if(i.querySelectorAll(".img--select").forEach(_=>{_.classList.remove("img--select")}),t.getAttribute("data-type")==="NodeAttributeView")return!0;const s=i.innerHTML.trimStart();if((s.startsWith("```")||s.startsWith("\xB7\xB7\xB7")||s.startsWith("~~~")||s.indexOf("\n```")>-1||s.indexOf(`
~~~`)>-1||s.indexOf(`
\xB7\xB7\xB7`)>-1)&&!(s.indexOf(`
`)===-1&&s.replace(/·|~/g,"`").replace(/^`{3,}/g,"").indexOf("`")>-1)){if(t.classList.contains("p")){const _=t.outerHTML;let x=i.innerHTML.replace(/\n(~|·|`){3,}/g,"\n```").trim().replace(/^(~|·|`){3,}/g,"```");x.endsWith("\n```")||(x+="<wbr>\n```"),i.innerHTML=x,t.outerHTML=n.lute.SpinBlockDOM(t.outerHTML),t=n.wysiwyg.element.querySelector(`[data-node-id="${t.getAttribute("data-node-id")}"]`);const S=t.querySelector(".protyle-action__language");return S?(window.siyuan.storage[u.LOCAL_CODELANG]&&S.textContent===""?S.textContent=window.siyuan.storage[u.LOCAL_CODELANG]:u.SIYUAN_RENDER_CODE_LANGUAGES.includes(S.textContent)||(window.siyuan.storage[u.LOCAL_CODELANG]=S.textContent,ue(u.LOCAL_CODELANG,window.siyuan.storage[u.LOCAL_CODELANG])),u.SIYUAN_RENDER_CODE_LANGUAGES.includes(S.textContent)?(t.dataset.content="",t.dataset.subtype=S.textContent,t.className="render-node",t.innerHTML=`<div spin="1"></div><div class="protyle-attr" contenteditable="false">${u.ZWSP}</div>`,n.toolbar.showRender(n,t),yt(t)):ze(t)):(n.toolbar.showRender(n,t),yt(t)),J(n,t.getAttribute("data-node-id"),t.outerHTML,_),!0}}if(t.getAttribute("data-type")==="NodeCodeBlock"){const _=document.createElement("wbr");e.insertNode(_);const x=t.outerHTML;return _.remove(),e.extractContents(),i.textContent.endsWith(`
`)||i.insertAdjacentText("beforeend",`
`),e.insertNode(document.createTextNode(`
`)),e.collapse(!1),e.insertNode(_),i.parentElement.removeAttribute("data-render"),ze(t),J(n,t.getAttribute("data-node-id"),t.outerHTML,x),Ne(n),!0}if(i.textContent.replace(u.ZWSP,"").replace(`
`,"")===""&&t.nextElementSibling&&t.nextElementSibling.classList.contains("protyle-attr")&&t.parentElement.getAttribute("data-type")==="NodeBlockquote"){e.insertNode(document.createElement("wbr"));const _=Ki(t),x=t.getAttribute("data-node-id"),S=_.getAttribute("data-node-id"),k={action:"insert",id:x,data:t.outerHTML},A={action:"insert",id:S,data:_.outerHTML};return S===x?(k.previousID=t.parentElement.getAttribute("data-node-id"),A.previousID=t.previousElementSibling.getAttribute("data-node-id"),t.parentElement.after(t)):(k.previousID=_.previousElementSibling?_.previousElementSibling.getAttribute("data-node-id"):void 0,k.parentID=_.parentElement.getAttribute("data-node-id")||n.block.parentID,A.previousID=k.previousID,A.parentID=k.parentID,_.after(t),_.remove()),U(n,[{action:"delete",id:S},k],[{action:"delete",id:x},A]),S===x&&t.parentElement.classList.contains("sb")&&t.parentElement.getAttribute("data-sb-layout")==="col"&&Dn({protyle:n,selectsElement:[t.previousElementSibling,t],type:"BlocksMergeSuperBlock",level:"row"}),he(t,e),!0}const o=ct(i,n.wysiwyg.element,e);if(t.parentElement.getAttribute("data-type")==="NodeListItem"&&(t.nextElementSibling.classList.contains("protyle-attr")||t.nextElementSibling.classList.contains("list")&&t.previousElementSibling?.classList.contains("protyle-action")||o.start===0&&t.previousElementSibling.classList.contains("protyle-action")||t.parentElement.getAttribute("fold")==="1")&&GL(n,t,e))return!0;if(i.textContent!==""&&e.toString()===""&&o.start===0){const _=pa(!1,!0),x=_.getAttribute("data-node-id");return U(n,[{action:"insert",data:_.outerHTML,id:x,previousID:t.previousElementSibling?t.previousElementSibling.getAttribute("data-node-id"):"",parentID:t.parentElement.getAttribute("data-node-id")||n.block.parentID}],[{action:"delete",id:x}]),_.querySelector("wbr").remove(),t.insertAdjacentElement("beforebegin",_),fc(_),!0}const l=document.createElement("wbr");e.insertNode(l);const r=t.outerHTML;if(l.remove(),e.toString()!==""){const _=B(e.startContainer,"data-type","inline-math");if(_){const x=Oe(_);return x&&(e=getSelection().getRangeAt(0),e.setEnd(x,x.textContent.startsWith(u.ZWSP)?1:0),e.collapse(!1)),!0}e.extractContents()}i.lastChild&&e.setEndAfter(i.lastChild);const d=t.getAttribute("data-node-id"),c=document.createElement("div");c.appendChild(pa(!1,!1));const f=c.querySelector('[contenteditable="true"]');f.appendChild(e.extractContents());const g=f.innerHTML.trimStart();if((g.startsWith("```")||g.startsWith("\xB7\xB7\xB7")||g.startsWith("~~~")||g.indexOf("\n```")>-1||g.indexOf(`
~~~`)>-1||g.indexOf(`
\xB7\xB7\xB7`)>-1)&&!(g.indexOf(`
`)===-1&&g.replace(/·|~/g,"`").replace(/^`{3,}/g,"").indexOf("`")>-1)){let _=f.innerHTML.replace(/\n(~|·|`){3,}/g,"\n```").trim().replace(/^(~|·|`){3,}/g,"```");_.endsWith("\n```")||(_+="\n```"),f.innerHTML=_}c.innerHTML=n.lute.SpinBlockDOM(c.innerHTML);const p=document.createElement("div");p.innerHTML=n.lute.SpinBlockDOM(i.parentElement.outerHTML);const h=[],m=[];let b=t;const y=[];Array.from(p.children).forEach(_=>{_.dataset.nodeId===d?(t.before(_),t.remove(),h.push({action:"update",data:_.outerHTML,id:d}),m.push({action:"update",data:r,id:d})):(h.push({action:"insert",data:_.outerHTML,id:_.dataset.nodeId,nextID:d}),b.insertAdjacentElement("afterend",_),m.push({action:"delete",id:_.dataset.nodeId})),Ma(_),b=_,y.push(_)}),Array.from(c.children).forEach(_=>{const x=_.getAttribute("data-node-id");h.push({action:"insert",data:_.outerHTML,id:x,previousID:b.getAttribute("data-node-id")}),m.push({action:"delete",id:x}),b.insertAdjacentElement("afterend",_),_.classList.contains("code-block")?ze(_):Ma(b.nextElementSibling),b=_,y.push(_)});const w=b.parentElement;return U(n,h,m),w.classList.contains("sb")&&w.getAttribute("data-sb-layout")==="col"&&Dn({protyle:n,selectsElement:y,type:"BlocksMergeSuperBlock",level:"row"}),ae(b),Ne(n),!0},GL=(t,e,n)=>{const a=e.parentElement,i=le(e);if(["",`
`].includes(i.textContent)&&e.previousElementSibling.classList.contains("protyle-action")&&!e.querySelector("img")){if(a.nextElementSibling?.classList.contains("protyle-attr"))return yc(t,[e.parentElement],n),!0;if(!a.parentElement.classList.contains("protyle-wysiwyg"))return ox(t,e,n),!0}const s=ct(i,t.wysiwyg.element,n);if(n.toString()===""&&s.start===0&&!At(n.startContainer)){if(a.parentElement.classList.contains("protyle-wysiwyg"))return!0;const f=document.createElement("wbr");n.insertNode(f);const g=a.parentElement.outerHTML;f.remove();let p=os(a,-1,!0);if(e.previousElementSibling.classList.contains("protyle-action"))le(e).textContent===""?a.insertAdjacentElement("afterend",p):a.insertAdjacentElement("beforebegin",p);else{if(le(e).textContent!=="")return!1;e.remove(),p=os(a,-1,!0),a.insertAdjacentElement("afterend",p)}return a.getAttribute("data-subtype")==="o"&&ot(a.parentElement),J(t,a.parentElement.getAttribute("data-node-id"),a.parentElement.outerHTML,g),he(p,n),Ne(t),fc(p),!0}const o=a.querySelector(".list");let l;if(o&&a.getAttribute("fold")!=="1"&&e.nextElementSibling.isSameNode(o)){if(s.end>=i.textContent.length-(i.textContent.endsWith(u.ZWSP)?1:0)){n.insertNode(document.createElement("wbr"));const f=o.outerHTML;e.querySelector("wbr").remove(),l=os(o.firstElementChild,-1,!0),o.firstElementChild.before(l),o.getAttribute("data-subtype")==="o"&&ot(o),J(t,o.getAttribute("data-node-id"),o.outerHTML,f),he(a,n),Ne(t)}else{n.insertNode(document.createElement("wbr"));const f=a.outerHTML,g=a.parentElement.outerHTML;n.toString()!==""&&(n.extractContents(),n.insertNode(document.createElement("wbr"))),n.setEndAfter(i.lastChild),l=os(a,0,!1),le(l).appendChild(n.extractContents());let h=o.nextElementSibling;for(l.lastElementChild.before(o);!h.classList.contains("protyle-attr");)h=h.nextElementSibling,l.lastElementChild.before(h.previousElementSibling);a.insertAdjacentElement("afterend",l),a.getAttribute("data-subtype")==="o"&&ot(a.parentElement),a.parentElement.classList.contains("protyle-wysiwyg")?U(t,[{action:"update",data:a.outerHTML,id:a.getAttribute("data-node-id")},{action:"insert",id:l.getAttribute("data-node-id"),data:l.outerHTML,previousID:a.getAttribute("data-node-id")}],[{action:"delete",id:l.getAttribute("data-node-id")},{action:"update",data:f,id:a.getAttribute("data-node-id")}]):J(t,a.parentElement.getAttribute("data-node-id"),a.parentElement.outerHTML,g),he(l,n),Ne(t)}return fc(l),!0}if((n.toString()===""||n.toString()===u.ZWSP)&&n.startContainer.nodeType===3&&n.startOffset===0){let f=n.startContainer;for(;f;)if(f.textContent===u.ZWSP){n.setStart(f,1),n.collapse(!1);break}else f=f.nextSibling}n.insertNode(document.createElement("wbr"));const r=a.outerHTML,d=a.parentElement.outerHTML;if(n.toString()!==""){const f=B(n.startContainer,"data-type","inline-math");if(f){const g=Oe(f);return g&&(n=getSelection().getRangeAt(0),n.setEnd(g,g.textContent.startsWith(u.ZWSP)?1:0),n.collapse(!1)),!0}n.extractContents(),n.insertNode(document.createElement("wbr"))}n.setEndAfter(i.lastChild),l=os(a,0,!1);const c=n.extractContents();return c.firstChild.nodeType!==3&&c.firstChild.textContent===""&&(c.firstChild.after(document.createElement("wbr")),c.firstChild.remove()),(i?.lastElementChild?.getAttribute("data-type")||"").indexOf("inline-math")>-1&&!Oe(i?.lastElementChild)&&i.insertAdjacentText("beforeend",`
`),i?.lastElementChild?.classList.contains("img")&&!Oe(i?.lastElementChild)&&i.insertAdjacentText("beforeend",u.ZWSP),le(l).appendChild(c),a.insertAdjacentElement("afterend",l),a.getAttribute("data-subtype")==="o"&&ot(a.parentElement),a.parentElement.classList.contains("protyle-wysiwyg")?U(t,[{action:"update",id:a.getAttribute("data-node-id"),data:a.outerHTML},{action:"insert",id:l.getAttribute("data-node-id"),data:l.outerHTML,previousID:a.getAttribute("data-node-id")}],[{action:"delete",id:l.getAttribute("data-node-id")},{action:"update",id:a.getAttribute("data-node-id"),data:r}]):J(t,a.parentElement.getAttribute("data-node-id"),a.parentElement.outerHTML,d),he(l,n),Ne(t),fc(l),!0},fc=t=>{const e=le(t).childNodes;for(let n=0;n<e.length;n++)e[n].nodeType===3&&e[n].textContent.length===0&&(e[n].remove(),n--)},jL=(t,e,n)=>{let a=t.startContainer;const i=Oe(a);if(e.getAttribute("data-type")==="NodeAttributeView")return!0;if(i&&i.nodeType!==3&&ct(t.startContainer,n.wysiwyg.element,t).end===t.endContainer.textContent.length&&(i.classList.contains("img")||i.getAttribute("data-type")==="inline-math")){i.insertAdjacentHTML("beforebegin","<wbr>");const o=e.outerHTML;i.previousElementSibling.remove();const l=document.createTextNode(`
`);return a.after(document.createTextNode(u.ZWSP)),a.after(l),t.selectNode(l),t.collapse(!1),J(n,e.getAttribute("data-node-id"),e.outerHTML,o),!0}if(a.nodeType===3&&(a=a.parentElement),a&&n.toolbar.getCurrentType(t).length>0&&ct(a,a,t).end===a.textContent.length)return d_(t,e,n,a),!0;if(Da()||W()){a=t.startContainer;const s=Oe(a);return s&&s.textContent.trim()!==""?(document.execCommand("insertHTML",!1,`
`),!0):(d_(t,e,n,a),!0)}return!1},d_=(t,e,n,a)=>{const i=document.createElement("wbr");a.nodeType===3?t.insertNode(i):a.insertAdjacentElement("afterend",i);const s=e.outerHTML;i.remove();let o;Oe(a)||(o=document.createTextNode(`
`),a.after(o));const l=document.createTextNode(`
`);a.after(l),o?t.setStart(o,0):t.setStart(l,1),t.collapse(!0),Z(t),J(n,e.getAttribute("data-node-id"),e.outerHTML,s)};let u_,pc=!1;const He=(t,e,n,a="false")=>{let i;return e&&e.startsWith("icon")?i=`<svg class="keyboard__slash-icon"><use xlink:href="#${e}"></use></svg>`:i=e,`<button class="keyboard__slash-item" data-focus="${a}" data-value="${encodeURIComponent(t)}">
    ${i}
    <span class="keyboard__slash-text">${n}</span>
</button>`},f_=(t,e)=>{let n="";["","var(--b3-font-color1)","var(--b3-font-color2)","var(--b3-font-color3)","var(--b3-font-color4)","var(--b3-font-color5)","var(--b3-font-color6)","var(--b3-font-color7)","var(--b3-font-color8)","var(--b3-font-color9)","var(--b3-font-color10)","var(--b3-font-color11)","var(--b3-font-color12)","var(--b3-font-color13)"].forEach((f,g)=>{n+=`<button class="keyboard__slash-item" data-type="color">
    <span class="keyboard__slash-icon" ${f?`style="color:${f}"`:""}>A</span>
    <span class="keyboard__slash-text">${window.siyuan.languages.colorFont} ${f?g+1:window.siyuan.languages.default}</span>
</button>`});let a="";["","var(--b3-font-background1)","var(--b3-font-background2)","var(--b3-font-background3)","var(--b3-font-background4)","var(--b3-font-background5)","var(--b3-font-background6)","var(--b3-font-background7)","var(--b3-font-background8)","var(--b3-font-background9)","var(--b3-font-background10)","var(--b3-font-background11)","var(--b3-font-background12)","var(--b3-font-background13)"].forEach((f,g)=>{a+=`<button class="keyboard__slash-item" data-type="backgroundColor">
    <span class="keyboard__slash-icon" ${f?`style="background-color:${f}"`:""}>A</span>
    <span class="keyboard__slash-text">${window.siyuan.languages.colorPrimary} ${f?g+1:window.siyuan.languages.default}</span>
</button>`});const i=c_(t);let s=!1;i?.find(f=>{if(f.classList.contains("list")||f.classList.contains("li"))return s=!0,!0});let o="";const l=window.siyuan.storage[u.LOCAL_FONTSTYLES];l.length>0&&(o=`<div class="keyboard__slash-title">
    ${window.siyuan.languages.lastUsed}
</div>
<div class="keyboard__slash-block">`,l.forEach(f=>{const g=f.split(u.ZWSP);switch(g[0]){case"color":o+=`<button class="keyboard__slash-item" data-type="${g[0]}">
    <span class="keyboard__slash-icon" ${g[1]?`style="color:${g[1]}"`:""} >A</span>
    <span class="keyboard__slash-text">${window.siyuan.languages.colorFont} ${g[1]?parseInt(g[1].replace("var(--b3-font-color",""))+1:window.siyuan.languages.default}</span>
</button>`;break;case"backgroundColor":o+=`<button class="keyboard__slash-item" data-type="${g[0]}">
    <span class="keyboard__slash-icon" ${g[1]?`style="background-color:${g[1]}"`:""}>A</span>
    <span class="keyboard__slash-text">${window.siyuan.languages.colorPrimary} ${g[1]?parseInt(g[1].replace("var(--b3-font-background",""))+1:window.siyuan.languages.default}</span>
</button>`;break;case"style2":o+=`<button class="keyboard__slash-item" data-type="${g[0]}">
    <span class="keyboard__slash-text" style="-webkit-text-stroke: 0.2px var(--b3-theme-on-background);-webkit-text-fill-color : transparent;">${window.siyuan.languages.hollow}</span>
</button>`;break;case"style4":o+=`<button class="keyboard__slash-item" data-type="${g[0]}">
    <span class="keyboard__slash-text" style="text-shadow: 1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)">${window.siyuan.languages.shadow}</span>
</button>`;break;case"fontSize":s||(o+=`<button class="keyboard__slash-item" data-type="${g[0]}">
    <span class="keyboard__slash-text">${g[1]}</span>
</button>`);break;case"style1":g[1]?o+=`<button class="keyboard__slash-item" data-type="${g[0]}">
    <span class="keyboard__slash-icon" style="background-color:${g[1]};color:${g[2]}">A</span>
    <span class="keyboard__slash-text">${window.siyuan.languages[g[2].replace("var(--b3-card-","").replace("-color)","")+"Style"]}</span>
</button>`:o+=`<button class="keyboard__slash-item" data-type="${g[0]}">
    <span class="keyboard__slash-icon">A</span>
    <span class="keyboard__slash-text">${window.siyuan.languages.color} ${window.siyuan.languages.default}</span>
</button>`;break;case"clear":o+=`<button class="keyboard__slash-item" data-type="${g[0]}">
    <span class="keyboard__slash-text">${window.siyuan.languages.clearFontStyle}</span>
</button>`;break}}),o+="</div>");let r,d="16px";i&&i.length>0?r=i[0]:(r=t.toolbar.range.cloneContents().querySelector('[data-type~="text"]'),r||(r=B(t.toolbar.range.startContainer,"data-type","text"))),r&&(d=r.style.fontSize||"16px");const c=e.querySelector(".keyboard__util");c.innerHTML=`${o}
<div class="keyboard__slash-title">${window.siyuan.languages.color}</div>
<div class="keyboard__slash-block">
    <button class="keyboard__slash-item" data-type="style1">
        <span class="keyboard__slash-icon">A</span>
        <span class="keyboard__slash-text">${window.siyuan.languages.color} ${window.siyuan.languages.default}</span>
    </button>
    <button class="keyboard__slash-item" data-type="style1">
        <span class="keyboard__slash-icon" style="color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);">A</span>
        <span class="keyboard__slash-text">${window.siyuan.languages.errorStyle}</span>
    </button>
    <button class="keyboard__slash-item" data-type="style1">
        <span class="keyboard__slash-icon" style="color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);">A</span>
        <span class="keyboard__slash-text">${window.siyuan.languages.warningStyle}</span>
    </button>
    <button class="keyboard__slash-item" data-type="style1">
        <span class="keyboard__slash-icon" style="color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);">A</span>
        <span class="keyboard__slash-text">${window.siyuan.languages.infoStyle}</span>
    </button>
    <button class="keyboard__slash-item" data-type="style1">
        <span class="keyboard__slash-icon" style="color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);">A</span>
        <span class="keyboard__slash-text">${window.siyuan.languages.successStyle}</span>
    </button>
</div>
<div class="keyboard__slash-title">${window.siyuan.languages.colorFont}</div>
<div class="keyboard__slash-block">
    ${n}
</div>
<div class="keyboard__slash-title">${window.siyuan.languages.colorPrimary}</div>
<div class="keyboard__slash-block">
    ${a}
</div>
<div class="keyboard__slash-title">${window.siyuan.languages.fontStyle}</div>
<div class="keyboard__slash-block">
    <button class="keyboard__slash-item" data-type="style2">
        <span class="keyboard__slash-text" style="-webkit-text-stroke: 0.2px var(--b3-theme-on-background);-webkit-text-fill-color : transparent;">${window.siyuan.languages.hollow}</span>
    </button>
    <button class="keyboard__slash-item" data-type="style4">
        <span class="keyboard__slash-text" style="text-shadow: 1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)">${window.siyuan.languages.shadow}</span>
    </button>
    <button class="keyboard__slash-item" data-type="clear">
        <svg class="keyboard__slash-icon"><use xlink:href="#iconTrashcan"></use></svg>
        <span class="keyboard__slash-text">${window.siyuan.languages.clearFontStyle}</span>
    </button>
</div>
<div class="keyboard__slash-title${s?" fn__none":""}">${window.siyuan.languages.fontSize}</div>
<div class="keyboard__slash-block${s?" fn__none":""}">
    <select class="b3-select fn__block" style="width: calc(50% - 8px);margin: 4px 0 8px 0;">
        <option ${d==="12px"?"selected":""} value="12px">12px</option>
        <option ${d==="13px"?"selected":""} value="13px">13px</option>
        <option ${d==="14px"?"selected":""} value="14px">14px</option>
        <option ${d==="15px"?"selected":""} value="15px">15px</option>
        <option ${d==="16px"?"selected":""} value="16px">16px</option>
        <option ${d==="19px"?"selected":""} value="19px">19px</option>
        <option ${d==="22px"?"selected":""} value="22px">22px</option>
        <option ${d==="24px"?"selected":""} value="24px">24px</option>
        <option ${d==="29px"?"selected":""} value="29px">29px</option>
        <option ${d==="32px"?"selected":""} value="32px">32px</option>
        <option ${d==="40px"?"selected":""} value="40px">40px</option>
        <option ${d==="48px"?"selected":""} value="48px">48px</option>
    </select>
</div>`,c.querySelector("select").addEventListener("change",function(f){ns(t,i,"fontSize",f.target.value)})},KL=(t,e)=>{t.hint.splitChar="/",t.hint.lastIndex=-1;let n="";t.app.plugins.forEach(i=>{i.protyleSlash.forEach(s=>{n+=He(`plugin${Constants.ZWSP}${i.name}${Constants.ZWSP}${s.id}`,"",s.html,"true")})}),n&&(n=`<div class="keyboard__slash-title"></div><div class="keyboard__slash-block">${n}</div>`);const a=e.querySelector(".keyboard__util");a.innerHTML=`<div class="keyboard__slash-title"></div>
<div class="keyboard__slash-block">
    ${He(Constants.ZWSP,"iconMarkdown",window.siyuan.languages.template)}
    ${He(Constants.ZWSP+1,"iconBoth",window.siyuan.languages.widget)}
    ${He(Constants.ZWSP+2,"iconImage",window.siyuan.languages.assets)}
    ${He("((","iconRef",window.siyuan.languages.ref,"true")}
    ${He("{{","iconSQL",window.siyuan.languages.blockEmbed,"true")}
    ${He(Constants.ZWSP+5,"iconSparkles",window.siyuan.languages.aiWriting)}
    ${He('<div data-type="NodeAttributeView" data-av-type="table"></div>',"iconDatabase",window.siyuan.languages.database,"true")}
    ${He(Constants.ZWSP+4,"iconFile",window.siyuan.languages.newSubDocRef)}
</div>
<div class="keyboard__slash-title"></div>
<div class="keyboard__slash-block">
    ${He(Constants.ZWSP+3,"iconDownload",window.siyuan.languages.insertAsset+'<input class="b3-form__upload" type="file"'+(t.options.upload.accept?' multiple="'+t.options.upload.accept+'"':"")+"/>","true")}
    ${isInAndroid()?He(Constants.ZWSP+3,"iconCamera",window.siyuan.languages.insertPhoto+'<input class="b3-form__upload" capture="user" type="file"'+(t.options.upload.accept?' multiple="'+t.options.upload.accept+'"':"")+"/>","true"):""}
    ${He('<iframe sandbox="allow-forms allow-presentation allow-same-origin allow-scripts allow-modals allow-popups" src="" border="0" frameborder="no" framespacing="0" allowfullscreen="true"></iframe>',"iconLanguage",window.siyuan.languages.insertIframeURL,"true")}
    ${He("![]()","iconImage",window.siyuan.languages.insertImgURL,"true")}
    ${He('<video controls="controls" src=""></video>',"iconVideo",window.siyuan.languages.insertVideoURL,"true")}
    ${He('<audio controls="controls" src=""></audio>',"iconRecord",window.siyuan.languages.insertAudioURL,"true")}
    ${He("emoji","iconEmoji",window.siyuan.languages.emoji,"true")}
</div>
<div class="keyboard__slash-title"></div>
<div class="keyboard__slash-block">
    ${He("# "+Lute.Caret,"iconH1",window.siyuan.languages.heading1,"true")}
    ${He("## "+Lute.Caret,"iconH2",window.siyuan.languages.heading2,"true")}
    ${He("### "+Lute.Caret,"iconH3",window.siyuan.languages.heading3,"true")}
    ${He("#### "+Lute.Caret,"iconH4",window.siyuan.languages.heading4,"true")}
    ${He("##### "+Lute.Caret,"iconH5",window.siyuan.languages.heading5,"true")}
    ${He("###### "+Lute.Caret,"iconH6",window.siyuan.languages.heading6,"true")}
    ${He("* "+Lute.Caret,"iconList",window.siyuan.languages.list,"true")}
    ${He("1. "+Lute.Caret,"iconOrderedList",window.siyuan.languages["ordered-list"],"true")}
    ${He("* [ ] "+Lute.Caret,"iconCheck",window.siyuan.languages.check,"true")}
    ${He("> "+Lute.Caret,"iconQuote",window.siyuan.languages.quote,"true")}
    ${He("```","iconCode",window.siyuan.languages.code,"true")}
    ${He(`| ${Lute.Caret} |  |  |
| --- | --- | --- |
|  |  |  |
|  |  |  |`,"iconTable",window.siyuan.languages.table,"true")}
    ${He("---","iconLine",window.siyuan.languages.line,"true")}
    ${He("$$","iconMath",window.siyuan.languages.math)}
    ${He("<div>","iconHTML5","HTML")}
</div>
<div class="keyboard__slash-title"></div>
<div class="keyboard__slash-block">
    ${He("```abc\n```","",window.siyuan.languages.staff,"true")}
    ${He("```echarts\n```","",window.siyuan.languages.chart,"true")}
    ${He("```flowchart\n```","","Flow Chart","true")}
    ${He("```graphviz\n```","","Graph","true")}
    ${He("```mermaid\n```","","Mermaid","true")}
    ${He("```mindmap\n```","",window.siyuan.languages.mindmap,"true")}
    ${He("```plantuml\n```","","UML","true")}
</div>
<div class="keyboard__slash-title"></div>
<div class="keyboard__slash-block">
    ${He(`style${Constants.ZWSP}color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);`,'<div style="color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);" class="keyboard__slash-icon">A</div>',window.siyuan.languages.infoStyle,"true")}
    ${He(`style${Constants.ZWSP}color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);`,'<div style="color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);" class="keyboard__slash-icon">A</div>',window.siyuan.languages.successStyle,"true")}
    ${He(`style${Constants.ZWSP}color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);`,'<div style="color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);" class="keyboard__slash-icon">A</div>',window.siyuan.languages.warningStyle,"true")}
    ${He(`style${Constants.ZWSP}color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);`,'<div style="color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);" class="keyboard__slash-icon">A</div>',window.siyuan.languages.errorStyle,"true")}
    ${He(`style${Constants.ZWSP}`,'<div class="keyboard__slash-icon">A</div>',window.siyuan.languages.clearFontStyle,"true")}
</div>${n}`,t.hint.bindUploadEvent(t,a)},em=t=>{window.siyuan.menus.menu.remove(),pc=!0;const e=document.getElementById("keyboardToolbar");let n=e.getAttribute("data-keyboardheight");n=(n?parseInt(n)+42:window.outerHeight/2)+"px";const a=qf();a&&(a.protyle.element.parentElement.style.paddingBottom=n,a.protyle.contentElement.scrollTop=t),setTimeout(()=>{e.style.height=n},u.TIMEOUT_TRANSITION),setTimeout(()=>{pc=!1},1e3)},gc=()=>{const t=document.getElementById("keyboardToolbar");t.style.height="";const e=getCurrentEditor();e&&(e.protyle.element.parentElement.style.paddingBottom="42px"),t.querySelector('.keyboard__action[data-type="add"]').classList.remove("protyle-toolbar__item--current"),t.querySelector('.keyboard__action[data-type="text"]').classList.remove("protyle-toolbar__item--current"),t.querySelector('.keyboard__action[data-type="done"] use').setAttribute("xlink:href","#iconKeyboardHide")},ZL=()=>{clearTimeout(u_),u_=window.setTimeout(()=>{if(getSelection().rangeCount===0||window.siyuan.config.readonly||document.getElementById("toolbarName").getAttribute("readonly")==="readonly"||window.screen.height-window.innerHeight<160||!document.activeElement||document.activeElement&&!["INPUT","TEXTAREA"].includes(document.activeElement.tagName)&&!document.activeElement.classList.contains("protyle-wysiwyg")&&document.activeElement.getAttribute("contenteditable")!=="true"){hc();return}if(document.activeElement&&!["INPUT","TEXTAREA"].includes(document.activeElement.tagName)&&(document.getElementById("menu").style.transform==="translateX(0px)"||document.getElementById("model").style.transform==="translateY(0px)")){hc();return}pc||gc(),JL();const t=document.querySelectorAll("#keyboardToolbar .keyboard__dynamic"),e=getSelection().getRangeAt(0);if(!hasClosestByClassName(e.startContainer,"protyle-wysiwyg",!0)){t[0].classList.add("fn__none"),t[1].classList.add("fn__none");return}e.toString()||t[0].querySelector('[data-type="goinline"]').classList.contains("protyle-toolbar__item--current")?(t[0].classList.add("fn__none"),t[1].classList.remove("fn__none")):(t[0].classList.remove("fn__none"),t[1].classList.add("fn__none"));const i=getCurrentEditor().protyle;if(!t[0].classList.contains("fn__none")){i.undo.undoStack.length===0?t[0].querySelector('[data-type="undo"]').setAttribute("disabled","disabled"):t[0].querySelector('[data-type="undo"]').removeAttribute("disabled"),i.undo.redoStack.length===0?t[0].querySelector('[data-type="redo"]').setAttribute("disabled","disabled"):t[0].querySelector('[data-type="redo"]').removeAttribute("disabled");const s=hasClosestBlock(e.startContainer);if(s){const o=t[0].querySelector('[data-type="outdent"]');s.parentElement.classList.contains("li")?(o.classList.remove("fn__none"),o.nextElementSibling.classList.remove("fn__none")):(o.classList.add("fn__none"),o.nextElementSibling.classList.add("fn__none"))}}t[1].classList.contains("fn__none")||(t[1].querySelectorAll(".protyle-toolbar__item--current").forEach(o=>{o.classList.remove("protyle-toolbar__item--current")}),i.toolbar.getCurrentType(e).forEach(o=>{if(["search-mark","a","block-ref","virtual-block-ref","text","file-annotation-ref","inline-math","inline-memo","","backslash"].includes(o))return;const l=t[1].querySelector(`[data-type="${o}"]`);l&&l.classList.add("protyle-toolbar__item--current")}))},620)},JL=()=>{pc||gc();const t=document.getElementById("keyboardToolbar");if(!t.classList.contains("fn__none"))return;t.classList.remove("fn__none"),t.style.zIndex=(++window.siyuan.zIndex).toString();const e=document.getElementById("model");e.style.transform==="translateY(0px)"&&(e.style.paddingBottom="42px");const n=getSelection().getRangeAt(0),a=getCurrentEditor();a&&a.protyle.wysiwyg.element.contains(n.startContainer)&&(a.protyle.element.parentElement.style.paddingBottom="42px"),getCurrentEditor().protyle.app.plugins.forEach(i=>{i.eventBus.emit("mobile-keyboard-show")}),setTimeout(()=>{const i=hasClosestByClassName(n.startContainer,"protyle-content",!0);if(i){const s=i.getBoundingClientRect().top,o=getSelectionPosition(i).top;if(o<window.innerHeight-42&&o>s)return;i.scroll({top:i.scrollTop+o-window.innerHeight+42+26,left:i.scrollLeft,behavior:"smooth"})}},Constants.TIMEOUT_TRANSITION)},hc=()=>{if(pc)return;const t=document.getElementById("keyboardToolbar");if(t.classList.contains("fn__none"))return;t.classList.add("fn__none"),t.style.height="";const e=qf();e&&(e.protyle.element.parentElement.style.paddingBottom="");const n=document.getElementById("model");n.style.transform==="translateY(0px)"&&(n.style.paddingBottom=""),qf().protyle.app.plugins.forEach(a=>{a.eventBus.emit("mobile-keyboard-hide")})},Ff=()=>{document.activeElement.blur()},x0=()=>{let t=!1;document.addEventListener("selectionchange",()=>{t||ZL()},!1);const e=document.getElementById("keyboardToolbar");e.innerHTML=`<div class="fn__flex keyboard__bar">
    <div class="fn__flex-1">
        <div class="fn__none keyboard__dynamic">
            <button class="keyboard__action" data-type="outdent"><svg><use xlink:href="#iconOutdent"></use></svg></button>
            <button class="keyboard__action" data-type="indent"><svg><use xlink:href="#iconIndent"></use></svg></button>
            <button class="keyboard__action" data-type="add"><svg><use xlink:href="#iconAdd"></use></svg></button>
            <button class="keyboard__action" data-type="block"><svg><use xlink:href="#iconParagraph"></use></svg></button>
            <button class="keyboard__action" data-type="goinline"><svg class="keyboard__svg--big"><use xlink:href="#iconBIU"></use></svg></button>
            <button class="keyboard__action" data-type="softLine"><svg><use xlink:href="#iconSoftWrap"></use></svg></button>
            <span class="keyboard__split"></span>
            <button class="keyboard__action" data-type="undo"><svg><use xlink:href="#iconUndo"></use></svg></button>
            <button class="keyboard__action" data-type="redo"><svg><use xlink:href="#iconRedo"></use></svg></button>
            <span class="keyboard__split"></span>
            <button class="keyboard__action" data-type="moveup"><svg><use xlink:href="#iconUp"></use></svg></button>
            <button class="keyboard__action" data-type="movedown"><svg><use xlink:href="#iconDown"></use></svg></button>
        </div>
        <div class="fn__none keyboard__dynamic">
            <button class="keyboard__action" data-type="goback"><svg><use xlink:href="#iconBack"></use></svg></button>
            <button class="keyboard__action" data-type="block-ref"><svg><use xlink:href="#iconRef"></use></svg></button>
            <button class="keyboard__action" data-type="a"><svg><use xlink:href="#iconLink"></use></svg></button>
            <button class="keyboard__action" data-type="text"><svg><use xlink:href="#iconFont"></use></svg></button>
            <button class="keyboard__action" data-type="strong"><svg><use xlink:href="#iconBold"></use></svg></button>
            <button class="keyboard__action" data-type="em"><svg><use xlink:href="#iconItalic"></use></svg></button>
            <button class="keyboard__action" data-type="u"><svg><use xlink:href="#iconUnderline"></use></svg></button>
            <button class="keyboard__action" data-type="s"><svg><use xlink:href="#iconStrike"></use></svg></button>
            <button class="keyboard__action" data-type="mark"><svg><use xlink:href="#iconMark"></use></svg></button>
            <button class="keyboard__action" data-type="sup"><svg><use xlink:href="#iconSup"></use></svg></button>
            <button class="keyboard__action" data-type="sub"><svg><use xlink:href="#iconSub"></use></svg></button>
            <button class="keyboard__action" data-type="clear"><svg><use xlink:href="#iconClear"></use></svg></button>
            <button class="keyboard__action" data-type="code"><svg><use xlink:href="#iconInlineCode"></use></svg></button>
            <button class="keyboard__action" data-type="kbd"<use xlink:href="#iconKeymap"></use></svg></button>
            <button class="keyboard__action" data-type="tag"><svg><use xlink:href="#iconTags"></use></svg></button>
            <button class="keyboard__action" data-type="inline-math"><svg><use xlink:href="#iconMath"></use></svg></button>
            <button class="keyboard__action" data-type="inline-memo"><svg><use xlink:href="#iconM"></use></svg></button>
            <button class="keyboard__action" data-type="goback"><svg><use xlink:href="#iconCloseRound"></use></svg></button>
        </div>
    </div>
    <span class="keyboard__split"></span>
    <button class="keyboard__action" data-type="done"><svg style="width: 36px"><use xlink:href="#iconKeyboardHide"></use></svg></button>
</div>
<div class="keyboard__util"></div>`,e.addEventListener("click",n=>{const a=getCurrentEditor()?.protyle,i=n.target,s=hasClosestByClassName(n.target,"keyboard__slash-item");if(s&&!s.getAttribute("data-type")){const c=decodeURIComponent(s.getAttribute("data-value"));a.hint.fill(c,a,!1),c!==Constants.ZWSP+3&&(n.preventDefault(),n.stopPropagation()),s.getAttribute("data-focus")==="true"&&focusByRange(a.toolbar.range);return}const o=hasClosestByTag(i,"BUTTON");if(!o||o.getAttribute("disabled"))return;const l=o.getAttribute("data-type");if(["clear","style2","style4","color","backgroundColor","fontSize","style1"].includes(l)){const c=getFontNodeElements(a),f=o.firstElementChild;l==="style1"?fontEvent(a,c,l,f.style.backgroundColor+Constants.ZWSP+f.style.color):l==="fontSize"?fontEvent(a,c,l,f.textContent.trim()):l==="backgroundColor"?fontEvent(a,c,l,f.style.backgroundColor):l==="color"?fontEvent(a,c,l,f.style.color):fontEvent(a,c,l)}if(n.preventDefault(),n.stopPropagation(),getSelection().rangeCount===0)return;const r=getSelection().getRangeAt(0);if(l==="done"){e.clientHeight>100?(gc(),focusByRange(r)):(Ff(),hc());return}if(window.siyuan.config.readonly||!a||a.disabled)return;if(l==="undo"){a.undo.undo(a);return}else if(l==="redo"){a.undo.redo(a);return}if(getSelection().rangeCount===0)return;const d=hasClosestBlock(r.startContainer);if(d){if(l==="goback"){e.querySelector('.keyboard__action[data-type="goinline"]').classList.remove("protyle-toolbar__item--current");const c=document.querySelectorAll("#keyboardToolbar .keyboard__dynamic");c[0].classList.remove("fn__none"),c[1].classList.add("fn__none"),focusByRange(r),t=!0,setTimeout(()=>{t=!1},1e3);return}else if(l==="goinline"){o.classList.add("protyle-toolbar__item--current");const c=document.querySelectorAll("#keyboardToolbar .keyboard__dynamic");c[1].classList.remove("fn__none"),c[0].classList.add("fn__none"),focusByRange(r);return}else if(["a","block-ref","inline-math","inline-memo"].includes(l)){hasClosestByAttribute(r.startContainer,"data-type","NodeCodeBlock")||(hideElements(["util"],a),a.toolbar.element.querySelector(`[data-type="${l}"]`).dispatchEvent(new CustomEvent("click")));return}else if(o.classList.contains("keyboard__action")&&["strong","em","s","code","mark","tag","u","sup","clear","sub","kbd"].includes(l)){hasClosestByAttribute(r.startContainer,"data-type","NodeCodeBlock")||a.toolbar.setInlineMark(a,l,"toolbar");return}else if(l==="text"){if(o.classList.contains("protyle-toolbar__item--current"))gc(),focusByRange(r);else{o.classList.add("protyle-toolbar__item--current"),e.querySelector('.keyboard__action[data-type="done"] use').setAttribute("xlink:href","#iconCloseRound");const c=a.contentElement.scrollTop;f_(a,e),em(c)}return}else if(l==="moveup"){moveToUp(a,d,r),focusByRange(r);return}else if(l==="movedown"){moveToDown(a,d,r),focusByRange(r);return}else if(l==="softLine"){r.extractContents(),softEnter(r,d,a),focusByRange(r);return}else if(l==="add"){if(o.classList.contains("protyle-toolbar__item--current"))gc(),focusByRange(r);else{o.classList.add("protyle-toolbar__item--current"),e.querySelector('.keyboard__action[data-type="done"] use').setAttribute("xlink:href","#iconCloseRound");const c=a.contentElement.scrollTop;KL(a,e),em(c)}return}else if(l==="block"){a.gutter.renderMenu(a,d),window.siyuan.menus.menu.fullscreen(),Ff(),hc();return}else if(l==="outdent"){listOutdent(a,[d.parentElement],r),focusByRange(r);return}else if(l==="indent"){listIndent(a,[d.parentElement],r),focusByRange(r);return}}})},p_=()=>{document.getElementById("menu").style.transform="",document.getElementById("sidebar").style.transform="",document.getElementById("model").style.transform="";const t=document.querySelector(".side-mask");t.classList.add("fn__none"),t.style.opacity="",window.siyuan.menus.menu.remove()},XL=()=>{document.getElementById("model").style.transform="",Ff(),hc()},tm=null,QL=t=>{const e=getCurrentEditor().protyle;if(e.observerLoad.disconnect(),window.siyuan.storage[Constants.LOCAL_DOCINFO]={id:t.id},setStorageVal(Constants.LOCAL_DOCINFO,window.siyuan.storage[Constants.LOCAL_DOCINFO]),hideElements(["toolbar","hint","util"],e),e.contentElement.classList.contains("fn__none")&&setEditMode(e,"wysiwyg"),e.notebookId=t.data.notebookId,e.path=t.data.path,t.data.startId===e.wysiwyg.element.firstElementChild.getAttribute("data-node-id")&&t.data.endId===e.wysiwyg.element.lastElementChild.getAttribute("data-node-id")){e.contentElement.scrollTo({top:t.scrollTop,behavior:"smooth"});return}if(t.id!==e.block.rootID&&fetchPost("/api/block/getDocInfo",{id:t.id},n=>{setTitle(n.data.name),e.title.setTitle(n.data.name),e.background.render(n.data.ial,e.block.rootID),e.wysiwyg.renderCustom(n.data.ial)}),t.zoomId){t.zoomId!==e.block.id?fetchPost("/api/block/checkBlockExist",{id:t.id},n=>{n.data&&zoomOut({protyle:e,id:t.id,isPushBack:!1,callback:()=>{e.contentElement.scrollTop=t.scrollTop}})}):e.contentElement.scrollTop=t.scrollTop;return}fetchPost("/api/filetree/getDoc",{id:t.id,startID:t.data.startId,endID:t.data.endId},n=>{e.block.parentID=n.data.parentID,e.block.parent2ID=n.data.parent2ID,e.block.rootID=n.data.rootID,e.block.showAll=!1,e.block.mode=n.data.mode,e.block.blockCount=n.data.blockCount,e.block.id=n.data.id,e.block.action=t.callback,e.wysiwyg.element.setAttribute("data-doc-type",n.data.type),e.wysiwyg.element.innerHTML=n.data.content,processRender(e.wysiwyg.element),highlightRender(e.wysiwyg.element),avRender(e.wysiwyg.element,e),blockRender(e,e.wysiwyg.element,t.scrollTop),n.data.isSyncing?disabledForeverProtyle(e):setReadonlyByConfig(e,!0),e.contentElement.scrollTop=t.scrollTop,setTimeout(()=>{e.contentElement.scrollTop=t.scrollTop},Constants.TIMEOUT_LOAD)})},nm=()=>{const t=qf().protyle;t.wysiwyg.element.firstElementChild&&window.siyuan.backStack.push({id:t.block.showAll?t.block.id:t.block.rootID,data:{startId:t.wysiwyg.element.firstElementChild.getAttribute("data-node-id"),endId:t.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),notebookId:t.notebookId,path:t.path},scrollTop:t.contentElement.scrollTop,callback:t.block.action,zoomId:t.block.showAll?t.block.id:void 0})},A0=()=>{const t=getCurrentEditor();if(window.siyuan.menus.menu.element.classList.contains("b3-menu--fullscreen")&&!window.siyuan.menus.menu.element.classList.contains("fn__none")){window.siyuan.menus.menu.element.dispatchEvent(new CustomEvent("click",{detail:"back"}));return}else if(document.getElementById("model").style.transform==="translateY(0px)"){const n=document.getElementById("searchAssetsPanel");!n||n.classList.contains("fn__none")?document.getElementById("model").style.transform="":n.classList.add("fn__none");return}else if(window.siyuan.viewer&&!window.siyuan.viewer.destroyed){window.siyuan.viewer.destroy();return}else if(document.getElementById("menu").style.transform==="translateX(0px)"||document.getElementById("sidebar").style.transform==="translateX(0px)"){closePanel();return}else if(t&&!t.protyle.toolbar.subElement.classList.contains("fn__none")){hideElements(["util"],t.protyle),closePanel();return}else if(window.siyuan.dialogs.length!==0){hideElements(["dialog"]),closePanel();return}if((window.JSAndroid||window.JSHarmony)&&window.siyuan.backStack.length<1){document.querySelector('#message [data-id="exitTip"]')?window.JSAndroid?window.JSAndroid.returnDesktop():window.JSHarmony&&window.JSHarmony.returnDesktop():showMessage(window.siyuan.languages.returnDesktop,3e3,"info","exitTip");return}if(window.siyuan.backStack.length<1)return;if(tm.length===0&&t){const n=t.protyle;tm.push({id:n.block.showAll?n.block.id:n.block.rootID,data:{startId:n.wysiwyg.element.firstElementChild.getAttribute("data-node-id"),endId:n.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),notebookId:n.notebookId,path:n.path},scrollTop:n.contentElement.scrollTop,callback:n.block.action,zoomId:n.block.showAll?n.block.id:void 0})}const e=window.siyuan.backStack.pop();tm.push(e),QL(e)},xl=(t,e,n)=>{if(!t){e.innerHTML="";return}E("/api/template/render",{id:n,path:t,preview:!0},a=>{e.innerHTML=`<div class="protyle-wysiwyg" style="padding: 8px">${a.data.content.replace(/contenteditable="true"/g,"")}</div>`})},g_=(t,e,n=!0)=>{if(!t.getAttribute("data-type")||!e.getAttribute("data-type"))return!1;t.setAttribute("data-type",t.getAttribute("data-type").replace("search-mark","").trim()),e.setAttribute("data-type",e.getAttribute("data-type").replace("search-mark","").trim());const a=t.attributes;let i=!0;for(let s=0;s<a.length;s++)e.getAttribute(a[s].name)!==a[s].value&&(i=!1);return i&&(n?t.innerHTML=t.innerHTML+e.innerHTML:t.innerHTML=e.innerHTML+t.innerHTML,e.remove()),i},h_=t=>{let e=t.previousSibling;for(;e&&e.nodeType!==3&&g_(t,e,!1);)e=t.previousSibling;let n=t.nextSibling;for(;n&&n.nodeType!==3&&g_(t,n);)n=t.nextSibling;(t.getAttribute("data-type")||"").includes("search-mark")&&t.setAttribute("data-type",t.getAttribute("data-type").replace("search-mark","").trim())},am=(t,e,n)=>{const a=t.getAttribute("data-type").split(" ");if(a.length===1){const i=t.parentElement;t.outerHTML=t.innerHTML.replace(u.ZWSP,"")+"<wbr>",n&&he(i,n)}else a.find((i,s)=>{if(e===i)return a.splice(s,1),!0}),t.setAttribute("data-type",a.join(" ")),e==="a"?t.removeAttribute("data-href"):e==="file-annotation-ref"?t.removeAttribute("data-id"):e==="block-ref"&&(t.removeAttribute("data-id"),t.removeAttribute("data-subtype")),n&&(n.selectNodeContents(t),n.collapse(!1),Z(n))},Uf=t=>{const e=[{name:"block-ref",hotkey:window.siyuan.config.keymap.editor.insert.ref.custom,lang:"ref",icon:"iconRef",tipPosition:"ne"},{name:"a",hotkey:window.siyuan.config.keymap.editor.insert.link.custom,lang:"link",icon:"iconLink",tipPosition:"n"},{name:"strong",lang:"bold",hotkey:window.siyuan.config.keymap.editor.insert.bold.custom,icon:"iconBold",tipPosition:"n"},{name:"em",lang:"italic",hotkey:window.siyuan.config.keymap.editor.insert.italic.custom,icon:"iconItalic",tipPosition:"n"},{name:"u",lang:"underline",hotkey:window.siyuan.config.keymap.editor.insert.underline.custom,icon:"iconUnderline",tipPosition:"n"},{name:"s",lang:"strike",hotkey:window.siyuan.config.keymap.editor.insert.strike.custom,icon:"iconStrike",tipPosition:"n"},{name:"mark",lang:"mark",hotkey:window.siyuan.config.keymap.editor.insert.mark.custom,icon:"iconMark",tipPosition:"n"},{name:"sup",lang:"sup",hotkey:window.siyuan.config.keymap.editor.insert.sup.custom,icon:"iconSup",tipPosition:"n"},{name:"sub",lang:"sub",hotkey:window.siyuan.config.keymap.editor.insert.sub.custom,icon:"iconSub",tipPosition:"n"},{name:"kbd",lang:"kbd",hotkey:window.siyuan.config.keymap.editor.insert.kbd.custom,icon:"iconKeymap",tipPosition:"n"},{name:"tag",lang:"tag",hotkey:window.siyuan.config.keymap.editor.insert.tag.custom,icon:"iconTags",tipPosition:"n"},{name:"code",lang:"inline-code",hotkey:window.siyuan.config.keymap.editor.insert["inline-code"].custom,icon:"iconInlineCode",tipPosition:"n"},{name:"inline-math",lang:"inline-math",hotkey:window.siyuan.config.keymap.editor.insert["inline-math"].custom,icon:"iconMath",tipPosition:"n"},{name:"inline-memo",lang:"memo",hotkey:window.siyuan.config.keymap.editor.insert.memo.custom,icon:"iconM",tipPosition:"n"},{name:"text",lang:"appearance",hotkey:window.siyuan.config.keymap.editor.insert.appearance.custom,icon:"iconFont",tipPosition:"n"},{name:"clear",lang:"clearInline",hotkey:window.siyuan.config.keymap.editor.insert.clearInline.custom,icon:"iconClear",tipPosition:"n"},{name:"|"}],n=[];return t.forEach(a=>{let i=a;e.find(s=>{if(typeof a=="string"&&s.name===a)return i=s,!0;if(typeof a=="object"&&s.name===a.name)return i=Object.assign({},s,a),!0}),n.push(i)}),n},$t=async(t,e)=>{let n="";for(let a=0;a<t.length;a++){const i=t[a];if(t.length>1&&(n+="* "),e==="ref"){const s=await Re("/api/block/getRefText",{id:i});n+=`((${i} '${s.data}'))`}else if(e==="blockEmbed")n+=`{{select * from blocks where id='${i}'}}`;else if(e==="protocol")n+=`siyuan://blocks/${i}`;else if(e==="protocolMd"){const s=await Re("/api/block/getRefText",{id:i});n+=`[${s.data}](siyuan://blocks/${i})`}else if(e==="hPath"){const s=await Re("/api/filetree/getHPathByID",{id:i});n+=s.data}else e==="id"&&(n+=i);t.length>1&&a!==t.length-1&&(n+=`
`)}De(n)},m_=(t,e,n)=>{if(H(window.siyuan.config.keymap.editor.general.netImg2LocalAsset.custom,e))return vf(t,"Img"),e.preventDefault(),e.stopPropagation(),!0;if(H(window.siyuan.config.keymap.editor.general.netAssets2LocalAssets.custom,e))return vf(t,"Assets"),e.preventDefault(),e.stopPropagation(),!0;if(H(window.siyuan.config.keymap.editor.general.optimizeTypography.custom,e))return E("/api/format/autoSpace",{id:t.block.rootID}),e.preventDefault(),e.stopPropagation(),!0;if(H(window.siyuan.config.keymap.editor.general.copyHPath.custom,e))return E("/api/filetree/getHPathByID",{id:t.block.rootID},i=>{De(i.data)}),e.preventDefault(),e.stopPropagation(),!0;if(H(window.siyuan.config.keymap.editor.general.copyProtocolInMd.custom,e)){if(n){const i=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));i.length===0&&i.push(n),$t(i.map(s=>s.getAttribute("data-node-id")),"protocolMd")}else $t([t.block.rootID],"protocolMd");return e.preventDefault(),e.stopPropagation(),!0}if(H(window.siyuan.config.keymap.editor.general.copyID.custom,e)){if(n){const i=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));i.length===0&&i.push(n),$t(i.map(s=>s.getAttribute("data-node-id")),"id")}else $t([t.block.rootID],"id");return e.preventDefault(),e.stopPropagation(),!0}if(H(window.siyuan.config.keymap.editor.general.copyProtocol.custom,e)){if(n){const i=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));i.length===0&&i.push(n),$t(i.map(s=>s.getAttribute("data-node-id")),"protocol")}else $t([t.block.rootID],"protocol");return e.preventDefault(),e.stopPropagation(),!0}if(H(window.siyuan.config.keymap.editor.general.copyBlockEmbed.custom,e)){if(n){const i=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));i.length===0&&i.push(n),$t(i.map(s=>s.getAttribute("data-node-id")),"blockEmbed")}else $t([t.block.rootID],"blockEmbed");return e.preventDefault(),e.stopPropagation(),!0}let a=!1;if(t.app.plugins.find(i=>{if(i.commands.find(s=>{if(s.editorCallback&&H(s.customHotkey,e))return a=!0,s.editorCallback(t),!0}),a)return!0}),a)return!0},b_=t=>{const e=t.protyle.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(e.length>0)t.event.stopPropagation(),t.event.preventDefault();else{const i=q(t.range.startContainer,"TD")||q(t.range.startContainer,"TH")||le(t.nodeElement)||t.nodeElement,s=ct(i,t.editorElement,t.range).start,o=i.innerText,l=H(window.siyuan.config.keymap.editor.general.expandUp.custom,t.event);if(!(!gt()&&l)){if(s>0){o.substr(0,s).indexOf(`
`)===-1&&t.range.getBoundingClientRect().top-i.getBoundingClientRect().top-parseInt(getComputedStyle(i).paddingTop)<14&&(xo(i,t.range),t.event.preventDefault());return}}}t.range.collapse(!0),Q(["toolbar"],t.protyle),e.length===0?t.nodeElement.classList.add("protyle-wysiwyg--select"):t.cb(e);const n=[];t.protyle.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").forEach(a=>{n.push(a.getAttribute("data-node-id"))}),bn(n,t.protyle.block.rootID),t.event.stopPropagation(),t.event.preventDefault()},y_=t=>{const e=t.protyle.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(e.length>0)t.event.stopPropagation(),t.event.preventDefault();else{const i=q(t.range.startContainer,"TD")||q(t.range.startContainer,"TH")||le(t.nodeElement)||t.nodeElement,s=ct(i,t.editorElement,t.range).end,o=i.innerText,l=H(window.siyuan.config.keymap.editor.general.expandDown.custom,t.event);if(!(!gt()&&l)){if(s<o.length){!et(t.nodeElement)&&o.trimRight().substr(s).indexOf(`
`)===-1&&i.getBoundingClientRect().bottom-t.range.getBoundingClientRect().bottom-parseInt(getComputedStyle(i).paddingBottom)<14&&(Pt(i,t.range,!1),t.nodeElement.classList.contains("code-block")&&l&&t.event.preventDefault());return}}}t.range.collapse(!1),Q(["toolbar"],t.protyle),e.length===0?t.nodeElement.classList.add("protyle-wysiwyg--select"):t.cb(e);const n=[];t.protyle.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").forEach(a=>{n.push(a.getAttribute("data-node-id"))}),bn(n,t.protyle.block.rootID),t.event.stopPropagation(),t.event.preventDefault()},Wf=t=>{let e,n;return t.forEach(a=>{a.getAttribute("select-start")&&(e=a),a.getAttribute("select-end")&&(n=a)}),e||(e=t[0],e.setAttribute("select-start","true")),n||(n=t[t.length-1],n.setAttribute("select-end","true")),{startElement:e,endElement:n}},im=(t,e)=>{let n;const a=[],i=[];let s;if(t[t.length-1].classList.contains("li")&&t[t.length-1].getAttribute("data-subtype")==="o"&&(s=parseInt(t[t.length-1].getAttribute("data-marker"),10)),t.reverse().forEach((o,l)=>{const r=o.cloneNode(!0);l===0&&(n=r);const d=Lute.NewNodeID();if(r.setAttribute("data-node-id",d),r.setAttribute("data-node-id",d),r.removeAttribute(u.CUSTOM_RIFF_DECKS),r.classList.remove("protyle-wysiwyg--select","protyle-wysiwyg--hl"),r.setAttribute("updated",d.split("-")[0]),r.removeAttribute("refcount"),r.lastElementChild.querySelector(".protyle-attr--refcount")?.remove(),r.querySelectorAll("[data-node-id]").forEach(c=>{c.setAttribute("data-node-id",d),c.removeAttribute(u.CUSTOM_RIFF_DECKS),c.classList.remove("protyle-wysiwyg--select","protyle-wysiwyg--hl"),c.setAttribute("updated",d.split("-")[0]),c.removeAttribute("refcount"),c.lastElementChild.querySelector(".protyle-attr--refcount")?.remove()}),o.classList.remove("protyle-wysiwyg--select"),typeof s=="number"){const c=s+(t.length-l);r.setAttribute("data-marker",c+"."),r.querySelector(".protyle-action--order").textContent=c+"."}t[0].after(Xa(r)),a.push({action:"insert",data:r.outerHTML,id:d,previousID:t[0].getAttribute("data-node-id")}),i.push({action:"delete",id:d})}),typeof s=="number"){let o=n.nextElementSibling;for(s=s+t.length;o&&o.getAttribute("data-subtype")==="o";){s++;const l=o.getAttribute("data-node-id");i.push({action:"update",id:l,data:o.outerHTML}),o.setAttribute("data-marker",s+"."),o.querySelector(".protyle-action--order").textContent=s+".",a.push({action:"update",data:o.outerHTML,id:l}),o=o.nextElementSibling}}U(e,a,i),ae(n),Ne(e)},sm=t=>{t.wysiwyg.element.firstElementChild.getAttribute("data-node-index")==="0"||t.wysiwyg.element.firstElementChild.getAttribute("data-eof")==="1"||t.options.backlinkData?(ae(t.wysiwyg.element.firstElementChild),t.contentElement.scrollTop=0,t.scroll.lastScrollTop=1):E("/api/filetree/getDoc",{id:t.block.rootID,mode:0,size:window.siyuan.config.editor.dynamicLoadBlocks},e=>{rt({data:e,protyle:t,action:[u.CB_GET_FOCUS]})})},w_=t=>{!t.scroll.element.classList.contains("fn__none")&&t.wysiwyg.element.lastElementChild.getAttribute("data-eof")!=="2"?E("/api/filetree/getDoc",{id:t.block.rootID,mode:4,size:window.siyuan.config.editor.dynamicLoadBlocks},e=>{rt({data:e,protyle:t,action:[u.CB_GET_FOCUS],afterCB(){ae(t.wysiwyg.element.lastElementChild,void 0,!1)}})}):(t.contentElement.scrollTop=t.contentElement.scrollHeight,t.scroll.lastScrollTop=t.contentElement.scrollTop,ae(t.wysiwyg.element.lastElementChild,void 0,!1))},__=(t,e,n,a,i)=>{e.setAttribute("updated",Y().format("YYYYMMDDHHmmss")),n.forEach(s=>{s.style.minWidth="calc(100% - 0.1em)"}),J(t,a,e.outerHTML,i)},v_=(t,e,n,a,i)=>{e.setAttribute("updated",Y().format("YYYYMMDDHHmmss")),n.forEach(s=>{s.removeAttribute("style")}),J(t,a,e.outerHTML,i)},Ha=(t,e)=>{const n=L(t,"av__row");if(!n)return;const a=t.querySelector("use");n.classList.contains("av__row--header")||e==="unselectAll"?a.getAttribute("xlink:href")==="#iconCheck"||e==="unselectAll"?n.parentElement.querySelectorAll(".av__firstcol").forEach(i=>{i.querySelector("use").setAttribute("xlink:href","#iconUncheck");const s=L(i,"av__row");s&&s.classList.remove("av__row--select")}):n.parentElement.querySelectorAll(".av__firstcol").forEach(i=>{i.querySelector("use").setAttribute("xlink:href","#iconCheck");const s=L(i,"av__row");s&&s.classList.add("av__row--select")}):e==="select"||a.getAttribute("xlink:href")==="#iconUncheck"&&e==="toggle"?(n.classList.add("av__row--select"),a.setAttribute("xlink:href","#iconCheck")):(e==="unselect"||a.getAttribute("xlink:href")==="#iconCheck"&&e==="toggle")&&(n.classList.remove("av__row--select"),a.setAttribute("xlink:href","#iconUncheck")),ae(P(n)),as(n)},as=t=>{const e=P(t);if(!e)return;const n=t.parentElement.querySelectorAll(".av__row--select:not(.av__row--header)").length,a=t.parentElement.childElementCount-3-n,i=t.parentElement.firstElementChild,s=i.querySelector("use"),o=e.querySelector(".av__counter"),l=e.querySelector(".av__header");if(a===0&&t.parentElement.childElementCount-3!==0)i.classList.add("av__row--select"),s.setAttribute("xlink:href","#iconCheck");else if(a===t.parentElement.childElementCount-3){i.classList.remove("av__row--select"),s.setAttribute("xlink:href","#iconUncheck"),o.classList.add("fn__none"),l.style.position="";return}else a>0&&(i.classList.add("av__row--select"),s.setAttribute("xlink:href","#iconIndeterminateCheck"));o.classList.remove("fn__none"),o.innerHTML=`${n} ${window.siyuan.languages.selected}`,l.style.position="sticky"},E_=t=>{const e=parseInt(t.getAttribute("data-page-size"));if(e){const n=t.querySelectorAll(".av__row:not(.av__row--header)").length;e<n&&t.setAttribute("data-page-size",n.toString())}},Yf=(t,e,n,a,i)=>{if(e.querySelector('[data-type="av-search"]').value!==""){j(window.siyuan.languages.insertRowTip);return}let s=e.querySelector(`.av__row[data-id="${a}"]`)||e.querySelector(".av__row--header");e.querySelector('.av__views [data-type="av-sort"]').classList.contains("block__icon--active")&&(s=e.querySelector(".av__row--util").previousElementSibling);let o='<div class="av__colsticky"><div class="av__firstcol"><svg><use xlink:href="#iconUncheck"></use></svg></div></div>';const l=s.querySelectorAll(".av__colsticky .av__cell").length-1;l>-1&&(o='<div class="av__colsticky"><div class="av__firstcol"><svg><use xlink:href="#iconUncheck"></use></svg></div>'),s.querySelectorAll(".av__cell").forEach((d,c)=>{let f="";if(vn(d)==="lineNumber"){const g=d.querySelector(".av__celltext")?.getAttribute("data-value");g&&(f=(parseInt(g)+1).toString())}o+=`<div class="av__cell" data-col-id="${d.dataset.colId}" 
style="width: ${d.style.width};${d.dataset.dtype==="number"?"text-align: right;":""}" 
${vn(d)==="block"?' data-detached="true"':""}><span class="${i?"av__celltext":"av__pulse"}">${f}</span></div>`,l===c&&(o+="</div>")});let r="";if(n.forEach(d=>{const c=e.querySelector(`[data-block-id="${d}"]`);c?(e.querySelectorAll(".av__cell--select, .av__cell--active").forEach(f=>{f.classList.remove("av__cell--select","av__cell--active"),f.querySelector(".av__drag-fill")?.remove()}),In(c),c.classList.add("av__cell--select")):r+=`<div class="av__row" data-type="ghost" data-id="${d}" data-avid="${i}" data-previous-id="${a}">
    ${o}
</div>`}),s.insertAdjacentHTML("afterend",r),i){const d=s.nextElementSibling;e.querySelector('.av__views [data-type="av-sort"]').classList.contains("block__icon--active")&&!e.querySelector('[data-type="av-load-more"]').classList.contains("fn__none")&&d.setAttribute("data-need-update","true");const c=s.classList.contains("av__row--header")?d.nextElementSibling:s;E("/api/av/getAttributeViewFilterSort",{id:i,blockID:e.getAttribute("data-node-id")},f=>{let g=!1;f.data.filters.find(p=>{const h=e.querySelector(`.av__cell--header[data-col-id="${p.column}"]`);if(!h)return;const m=h.getAttribute("data-dtype");if(p.value&&m!==p.value.type)return;if(["relation","rollup","template"].includes(m))return g=!0,!0;["created","updated"].includes(m)?d.setAttribute("data-need-update","true"):f.data.sorts.find(y=>{if(y.column===p.column)return d.setAttribute("data-need-update","true"),!0});let b=!0;if(p.operator!=="Is empty"&&p.operator!=="Is not empty")switch(p.value.type){case"select":case"mSelect":(!p.value.mSelect||p.value.mSelect.length===0)&&(b=!1);break;case"block":(!p.value.block||!p.value.block.content)&&(b=!1);break;case"number":(!p.value.number||!p.value.number.isNotEmpty)&&(b=!1);break;case"date":case"created":case"updated":(!p.value[p.value.type]||!p.value[p.value.type].isNotEmpty)&&(b=!1);break;case"mAsset":(!p.value.mAsset||p.value.mAsset.length===0)&&(b=!1);break;case"checkbox":p.value.checkbox||(b=!1);break;case"text":case"url":case"phone":case"email":(!p.value[p.value.type]||!p.value[p.value.type].content)&&(b=!1);break}if(c.classList.contains("av__row")&&b){const y=c.querySelector(`.av__cell[data-col-id="${p.column}"]`),w=d.querySelector(`.av__cell[data-col-id="${p.column}"]`),_=ga(vn(y),y);w.innerHTML=kc(_),Sm(w,_)}}),g?(d.remove(),j(window.siyuan.languages.insertRowTip)):n.length===1&&Kn(t,[d.querySelector('.av__cell[data-detached="true"]')],"block"),E_(e)})}E_(e)},is=(t,e,n)=>{const a=t.querySelector(".av__scroll").getBoundingClientRect(),i=t.querySelector(".av__row--header");if(i&&(n==="top"||n==="all")){const o=Math.floor(e.top-a.top);o>0&&o<a.height?i.style.transform=`translateY(${o}px)`:i.style.transform=""}const s=t.querySelector(".av__row--footer");if(s&&(n==="bottom"||n==="all"))if(s.querySelector(".av__calc--ashow")){const o=Math.ceil(e.bottom-s.parentElement.getBoundingClientRect().bottom);o<0&&-o<a.height?s.style.transform=`translateY(${o}px)`:s.style.transform=""}else s.style.transform=""},mc=t=>{if(t.currentPageSize===t.newPageSize)return;t.nodeElement.setAttribute("data-page-size",t.newPageSize);const e=t.nodeElement.getAttribute("data-node-id");U(t.protyle,[{action:"setAttrViewPageSize",avID:t.avID,data:parseInt(t.newPageSize),blockID:e}],[{action:"setAttrViewPageSize",data:parseInt(t.currentPageSize),avID:t.avID,blockID:e}]),document.querySelector(".av__panel")?.remove()},k_=t=>{const e=new st("av-page-size");if(e.isOpen)return;const n=t.target.dataset.size;e.addItem({iconHTML:"",label:"10",checked:n==="10",click(){mc({currentPageSize:n,newPageSize:"10",protyle:t.protyle,avID:t.avID,nodeElement:t.nodeElement})}}),e.addItem({iconHTML:"",checked:n==="25",label:"25",click(){mc({currentPageSize:n,newPageSize:"25",protyle:t.protyle,avID:t.avID,nodeElement:t.nodeElement})}}),e.addItem({iconHTML:"",checked:n==="50",label:"50",click(){mc({currentPageSize:n,newPageSize:"50",protyle:t.protyle,avID:t.avID,nodeElement:t.nodeElement})}}),e.addItem({iconHTML:"",checked:n==="100",label:"100",click(){mc({currentPageSize:n,newPageSize:"100",protyle:t.protyle,avID:t.avID,nodeElement:t.nodeElement})}}),e.addItem({iconHTML:"",checked:n===u.SIZE_DATABASE_MAZ_SIZE.toString(),label:window.siyuan.languages.all,click(){mc({currentPageSize:n,newPageSize:u.SIZE_DATABASE_MAZ_SIZE.toString(),protyle:t.protyle,avID:t.avID,nodeElement:t.nodeElement})}});const a=t.target.getBoundingClientRect();e.open({x:a.left,y:a.bottom})},S_=(t,e)=>{const n=t.querySelectorAll(".av__row--select:not(.av__row--header)");if(n.length===0)return;const a=t.getAttribute("data-av-id"),i=[],s=[];n.forEach(l=>{s.push(l.querySelector(".av__cell[data-block-id]").getAttribute("data-block-id"))}),n.forEach(l=>{const r=ga("block",l.querySelector(".av__cell[data-block-id]"));i.push({action:"insertAttrViewBlock",avID:a,previousID:l.previousElementSibling?.getAttribute("data-id")||"",srcs:[{id:l.getAttribute("data-id"),isDetached:r.isDetached,content:r.block.content}],blockID:t.dataset.nodeId})});const o=Y().format("YYYYMMDDHHmmss");i.push({action:"doUpdateUpdated",id:t.dataset.nodeId,data:t.getAttribute("updated")}),U(e,[{action:"removeAttrViewBlock",srcIDs:s,avID:a},{action:"doUpdateUpdated",id:t.dataset.nodeId,data:o}],i),n.forEach(l=>{l.remove()}),is(t,e.contentElement.getBoundingClientRect(),"all"),as(t.querySelector(".av__row")),t.setAttribute("updated",o)},Al=(t,e,n,a)=>{const i=t.getAttribute("data-av-id"),s=[],o=[];new Array(n).fill(0).forEach(()=>{const r=Lute.NewNodeID();s.push(r),o.push({id:r,isDetached:!0,content:""})});const l=Y().format("YYYYMMDDHHmmss");U(e,[{action:"insertAttrViewBlock",avID:i,previousID:a,srcs:o,blockID:t.dataset.nodeId},{action:"doUpdateUpdated",id:t.dataset.nodeId,data:l}],[{action:"removeAttrViewBlock",srcIDs:s,avID:i},{action:"doUpdateUpdated",id:t.dataset.nodeId,data:t.getAttribute("updated")}]),Yf(e,t,s,a,i),t.setAttribute("updated",l)},ua=(t,e)=>t?`<span class="b3-menu__accelerator">${X(t)}</span>`:e?`<span class="b3-list-item__meta">${e}</span>`:"",om=(t,e)=>{const n=[{filter:[window.siyuan.languages.template,"template","\u6A21\u677F","moban","muban","mb"],id:"template",value:u.ZWSP,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconMarkdown"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.template}</span></div>`},{filter:[window.siyuan.languages.widget,"widget","\u6302\u4EF6","guajian","gj"],id:"widget",value:u.ZWSP+1,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconBoth"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.widget}</span></div>`},{filter:[window.siyuan.languages.assets,"assets","\u8D44\u6E90","ziyuan","zy"],id:"assets",value:u.ZWSP+2,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconImage"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.assets}</span></div>`},{filter:[window.siyuan.languages.ref,"block reference","\u5757\u5F15\u7528","kuaiyinyong","kyy"],id:"ref",value:"((",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconRef"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.ref}</span><span class="b3-list-item__meta">((</span></div>`},{filter:[window.siyuan.languages.blockEmbed,"embed block","\u5D4C\u5165\u5757","qianrukuai","qrk"],id:"blockEmbed",value:"{{",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconSQL"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.blockEmbed}</span><span class="b3-list-item__meta">{{</span></div>`},{filter:[window.siyuan.languages.aiWriting,"ai writing","ai\u7F16\u5199","aibianxie","aibx","\u4EBA\u5DE5\u667A\u80FD","rengongzhineng","rgzn"],id:"aiWriting",value:u.ZWSP+5,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconSparkles"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.aiWriting}</span>${ua(window.siyuan.config.keymap.editor.general.aiWriting.custom,"")}</div>`},{filter:[window.siyuan.languages.database,"database","db","\u6570\u636E\u5E93","shujuku","sjk","\u89C6\u56FE","view"],id:"database",value:'<div data-type="NodeAttributeView" data-av-type="table"></div>',html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconDatabase"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.database}</span></div>`},{filter:[window.siyuan.languages.newFileRef,"create new doc with reference","\u65B0\u5EFA\u6587\u6863\u5E76\u5F15\u7528","xinjianwendangbingyinyong","xjwdbyy"],id:"newFileRef",value:u.ZWSP+4,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.newFileRef}</span></div>`},{filter:[window.siyuan.languages.newSubDocRef,"create sub doc with reference","\u65B0\u5EFA\u5B50\u6587\u6863\u5E76\u5F15\u7528","xinjianziwendangbingyinyong","xjzwdbyy"],id:"newSubDocRef",value:u.ZWSP+6,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.newSubDocRef}</span></div>`},{value:"",id:"separator_1",html:"separator"},{filter:[window.siyuan.languages.heading1,"heading1","h1","\u4E00\u7EA7\u6807\u9898","yijibiaoti","yjbt"],id:"heading1",value:"# "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH1"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading1}</span>${ua(window.siyuan.config.keymap.editor.heading.heading1.custom,"# ")}</div>`},{filter:[window.siyuan.languages.heading2,"heading2","h2","\u4E8C\u7EA7\u6807\u9898","erjibiaoti","ejbt"],id:"heading2",value:"## "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH2"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading2}</span>${ua(window.siyuan.config.keymap.editor.heading.heading2.custom,"## ")}</div>`},{filter:[window.siyuan.languages.heading3,"heading3","h3","\u4E09\u7EA7\u6807\u9898","sanjibiaoti","sjbt"],id:"heading3",value:"### "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH3"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading3}</span>${ua(window.siyuan.config.keymap.editor.heading.heading3.custom,"### ")}</div>`},{filter:[window.siyuan.languages.heading4,"heading4","h4","\u56DB\u7EA7\u6807\u9898","sijibiaoti","sjbt"],id:"heading4",value:"#### "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH4"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading4}</span>${ua(window.siyuan.config.keymap.editor.heading.heading4.custom,"#### ")}</div>`},{filter:[window.siyuan.languages.heading5,"heading5","h5","\u4E94\u7EA7\u6807\u9898","wujibiaoti","wjbt"],id:"heading5",value:"##### "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH5"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading5}</span>${ua(window.siyuan.config.keymap.editor.heading.heading5.custom,"##### ")}</div>`},{filter:[window.siyuan.languages.heading6,"heading6","h6","\u516D\u7EA7\u6807\u9898","liujibiaoti","ljbt"],id:"heading6",value:"###### "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH6"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading6}</span>${ua(window.siyuan.config.keymap.editor.heading.heading6.custom,"###### ")}</div>`},{filter:[window.siyuan.languages.list,"unordered list","\u65E0\u5E8F\u5217\u8868","wuxvliebiao","wuxuliebiao","wxlb"],id:"list",value:"* "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconList"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.list}</span>${ua(window.siyuan.config.keymap.editor.insert.list.custom,"* ")}</div>`},{filter:[window.siyuan.languages["ordered-list"],"order list","ordered list","\u6709\u5E8F\u5217\u8868","youxvliebiao","youxuliebiao","yxlb"],id:"orderedList",value:"1. "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconOrderedList"></use></svg><span class="b3-list-item__text">${window.siyuan.languages["ordered-list"]}</span>${ua(window.siyuan.config.keymap.editor.insert["ordered-list"].custom,"1. ")}</div>`},{filter:[window.siyuan.languages.check,"task list","todo list","\u4EFB\u52A1\u5217\u8868","renwuliebiao","rwlb"],id:"check",value:"* [ ] "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconCheck"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.check}</span>${ua(window.siyuan.config.keymap.editor.insert.check.custom,"[]")}</div>`},{filter:[window.siyuan.languages.quote,"blockquote","bq","\u5F15\u8FF0","yinshu","ys"],id:"quote",value:"> "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconQuote"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.quote}</span>${ua(window.siyuan.config.keymap.editor.insert.quote.custom,">")}</div>`},{filter:[window.siyuan.languages.code,"code block","\u4EE3\u7801\u5757","daimakuai","dmk"],id:"code",value:"```",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconCode"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.code}</span>${ua(window.siyuan.config.keymap.editor.insert.code.custom,"```"+window.siyuan.languages.enterKey)}</div>`},{filter:[window.siyuan.languages.table,"table","\u8868\u683C","biaoge","bg"],id:"table",value:`| ${Lute.Caret} |  |  |
| --- | --- | --- |
|  |  |  |
|  |  |  |`,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconTable"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.table}</span><span class="b3-menu__accelerator">${X(window.siyuan.config.keymap.editor.insert.table.custom)}</span></div>`},{filter:[window.siyuan.languages.line,"thematic break","divider","\u5206\u9694\u7EBF","\u5206\u5272\u7EBF","fengexian","fgx"],id:"line",value:"---",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconLine"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.line}</span><span class="b3-list-item__meta">---</span></div>`},{filter:[window.siyuan.languages.math,"formulas block","math block","\u6570\u5B66\u516C\u5F0F\u5757","shuxuegongshikuai","sxgsk"],id:"math",value:"$$",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconMath"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.math}</span><span class="b3-list-item__meta">$$</span></div>`},{filter:["html"],id:"html",value:"<div>",html:'<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconHTML5"></use></svg><span class="b3-list-item__text">HTML</span></div>'},{value:"",id:"separator_2",html:"separator"},{filter:[window.siyuan.languages.emoji,"emoji","\u8868\u60C5","biaoqing","bq"],id:"emoji",value:"emoji",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconEmoji"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.emoji}</span><span class="b3-list-item__meta">:</span></div>`},{filter:[window.siyuan.languages.link,"link","a","\u94FE\u63A5","lianjie","lj"],id:"link",value:"a",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconLink"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.link}</span><span class="b3-menu__accelerator">${X(window.siyuan.config.keymap.editor.insert.link.custom)}</span></div>`},{filter:[window.siyuan.languages.bold,"bold","strong","\u7C97\u4F53","cuti","ct","\u52A0\u7C97","jiacu","jc"],id:"bold",value:"strong",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconBold"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.bold}</span><span class="b3-menu__accelerator">${X(window.siyuan.config.keymap.editor.insert.bold.custom)}</span></div>`},{filter:[window.siyuan.languages.italic,"italic","em","\u659C\u4F53","xieti","xt"],id:"italic",value:"em",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconItalic"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.italic}</span><span class="b3-menu__accelerator">${X(window.siyuan.config.keymap.editor.insert.italic.custom)}</span></div>`},{filter:[window.siyuan.languages.underline,"underline","\u4E0B\u5212\u7EBF","xiahuaxian","xhx"],id:"underline",value:"u",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconUnderline"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.underline}</span><span class="b3-menu__accelerator">${X(window.siyuan.config.keymap.editor.insert.underline.custom)}</span></div>`},{filter:[window.siyuan.languages.strike,"strike","delete","\u5220\u9664\u7EBF","shanchuxian","scx"],id:"strike",value:"s",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconStrike"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.strike}</span><span class="b3-menu__accelerator">${X(window.siyuan.config.keymap.editor.insert.strike.custom)}</span></div>`},{filter:[window.siyuan.languages.mark,"mark","\u6807\u8BB0","biaoji","bj","\u9AD8\u4EAE","gaoliang","gl"],id:"mark",value:"mark",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconMark"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.mark}</span><span class="b3-menu__accelerator">${X(window.siyuan.config.keymap.editor.insert.mark.custom)}</span></div>`},{filter:[window.siyuan.languages.sup,"superscript","\u4E0A\u6807","shangbiao","sb"],id:"sup",value:"sup",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconSup"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.sup}</span><span class="b3-menu__accelerator">${X(window.siyuan.config.keymap.editor.insert.sup.custom)}</span></div>`},{filter:[window.siyuan.languages.sub,"subscript","\u4E0B\u6807","xiaobiao","xb"],id:"sub",value:"sub",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconSub"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.sub}</span><span class="b3-menu__accelerator">${X(window.siyuan.config.keymap.editor.insert.sub.custom)}</span></div>`},{filter:[window.siyuan.languages["inline-code"],"inline code","\u884C\u7EA7\u4EE3\u7801","hangjidaima","hjdm"],id:"inlineCode",value:"code",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconInlineCode"></use></svg><span class="b3-list-item__text">${window.siyuan.languages["inline-code"]}</span><span class="b3-menu__accelerator">${X(window.siyuan.config.keymap.editor.insert["inline-code"].custom)}</span></div>`},{filter:[window.siyuan.languages.kbd,"kbd","\u952E\u76D8","jianpan","jp"],id:"kbd",value:"kbd",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconKeymap"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.kbd}</span><span class="b3-menu__accelerator">${X(window.siyuan.config.keymap.editor.insert.kbd.custom)}</span></div>`},{filter:[window.siyuan.languages.tag,"tags","\u6807\u7B7E","biaoqian","bq"],id:"tag",value:"tag",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconTags"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.tag}</span><span class="b3-menu__accelerator">${X(window.siyuan.config.keymap.editor.insert.tag.custom)}</span></div>`},{filter:[window.siyuan.languages["inline-math"],"inline formulas","inline math","\u884C\u7EA7\u516C\u5F0F","hangjigongshi","hjgs","\u884C\u7EA7\u6570\u5B66\u516C\u5F0F","hangjishuxvegongshi","hangjishuxuegongshi","hjsxgs"],id:"inlineMath",value:"inline-math",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconMath"></use></svg><span class="b3-list-item__text">${window.siyuan.languages["inline-math"]}</span><span class="b3-menu__accelerator">${X(window.siyuan.config.keymap.editor.insert["inline-math"].custom)}</span></div>`},{value:"",id:"separator_3",html:"separator"},{filter:[window.siyuan.languages.insertAsset,"insert image or file","upload","\u63D2\u5165\u56FE\u7247\u6216\u6587\u4EF6","charutupianhuowenjian","crtphwj","\u4E0A\u4F20","sc"],id:"insertAsset",value:u.ZWSP+3,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconDownload"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.insertAsset}</span>
<input class="b3-form__upload" type="file" ${e.options.upload.accept?'multiple="'+e.options.upload.accept+'"':""}></div>`},{filter:[window.siyuan.languages.insertIframeURL,"insert iframe link","\u63D2\u5165 iframe \u94FE\u63A5","charuiframelianjie","criframelj"],id:"insertIframeURL",value:'<iframe sandbox="allow-forms allow-presentation allow-same-origin allow-scripts allow-modals allow-popups" src="" border="0" frameborder="no" framespacing="0" allowfullscreen="true"></iframe>',html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconLanguage"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.insertIframeURL}</span></div>`},{filter:[window.siyuan.languages.insertImgURL,"insert image link","image","img","\u63D2\u5165\u56FE\u7247\u94FE\u63A5","charutupianlianjie","crtplj"],id:"insertImgURL",value:"![]()",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconImage"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.insertImgURL}</span></div>`},{filter:[window.siyuan.languages.insertVideoURL,"insert video link","\u63D2\u5165\u89C6\u9891\u94FE\u63A5","charushipinlianjie","crsplj"],id:"insertVideoURL",value:'<video controls="controls" src=""></video>',html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconVideo"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.insertVideoURL}</span></div>`},{filter:[window.siyuan.languages.insertAudioURL,"insert audio link","\u63D2\u5165\u97F3\u9891\u94FE\u63A5","charuyinpinlianjie","cryplj"],id:"insertAudioURL",value:'<audio controls="controls" src=""></audio>',html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconRecord"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.insertAudioURL}</span></div>`},{value:"",id:"separator_4",html:"separator"},{filter:[window.siyuan.languages.staff,"staff","\u4E94\u7EBF\u8C31","wuxianpu","wxp"],id:"staff",value:"```abc\n```",html:`<div class="b3-list-item__first"><span class="b3-list-item__text">ABC</span><span class="b3-list-item__meta">${window.siyuan.languages.staff}</span></div>`},{filter:[window.siyuan.languages.chart,"chart","\u56FE\u8868","tubiao","tb"],id:"chart",value:"```echarts\n```",html:`<div class="b3-list-item__first"><span class="b3-list-item__text">Chart</span><span class="b3-list-item__meta">${window.siyuan.languages.chart}</span></div>`},{filter:["flowchart","flow chart","\u6D41\u7A0B\u56FE","liuchengtu","lct"],id:"flowChart",value:"```flowchart\n```",html:'<div class="b3-list-item__first"><span class="b3-list-item__text">FlowChart</span><span class="b3-list-item__meta">Flow Chart</span></div>'},{filter:["graphviz","\u72B6\u6001\u56FE","zhuangtaitu","ztt"],id:"graph",value:"```graphviz\n```",html:'<div class="b3-list-item__first"><span class="b3-list-item__text">Graphviz</span><span class="b3-list-item__meta">Graph</span></div>'},{filter:["mermaid","diagram","\u56FE\u8868","tubiao","tb"],id:"mermaid",value:"```mermaid\n```",html:'<div class="b3-list-item__first"><span class="b3-list-item__text">Mermaid</span><span class="b3-list-item__meta">Mermaid</span></div>'},{filter:[window.siyuan.languages.mindmap,"mindmap","\u8111\u56FE","naotu","nt"],id:"mindmap",value:"```mindmap\n```",html:`<div class="b3-list-item__first"><span class="b3-list-item__text">Mind map</span><span class="b3-list-item__meta">${window.siyuan.languages.mindmap}</span></div>`},{filter:["plantuml","\u5EFA\u6A21\u8BED\u8A00","jianmoyuyan","jmyy"],id:"UML",value:"```plantuml\n```",html:'<div class="b3-list-item__first"><span class="b3-list-item__text">PlantUML</span><span class="b3-list-item__meta">UML</span></div>'},{value:"",id:"separator_5",html:"separator"},{filter:[window.siyuan.languages.infoStyle,"info style","\u4FE1\u606F\u6837\u5F0F","xinxiyangshi","xxys"],id:"infoStyle",value:`style${u.ZWSP}color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);`,html:`<div class="b3-list-item__first"><div style="color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);" class="color__square color__square--list">A</div><span class="b3-list-item__text">${window.siyuan.languages.infoStyle}</span></div>`},{filter:[window.siyuan.languages.successStyle,"success style","\u6210\u529F\u6837\u5F0F","chenggongyangshi","cgys"],id:"successStyle",value:`style${u.ZWSP}color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);`,html:`<div class="b3-list-item__first"><div style="color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);" class="color__square color__square--list">A</div><span class="b3-list-item__text">${window.siyuan.languages.successStyle}</span></div>`},{filter:[window.siyuan.languages.warningStyle,"warning style","\u8B66\u544A\u6837\u5F0F","jinggaoyangshi","jgys"],id:"warningStyle",value:`style${u.ZWSP}color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);`,html:`<div class="b3-list-item__first"><div style="color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);" class="color__square color__square--list">A</div><span class="b3-list-item__text">${window.siyuan.languages.warningStyle}</span></div>`},{filter:[window.siyuan.languages.errorStyle,"error style","\u9519\u8BEF\u6837\u5F0F","cuowuyangshi","cwys"],id:"errorStyle",value:`style${u.ZWSP}color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);`,html:`<div class="b3-list-item__first"><div style="color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);" class="color__square color__square--list">A</div><span class="b3-list-item__text">${window.siyuan.languages.errorStyle}</span></div>`},{filter:[window.siyuan.languages.clearFontStyle,"clear style","\u6E05\u9664\u6837\u5F0F","qingchuyangshi","qcys"],id:"clearFontStyle",value:`style${u.ZWSP}`,html:`<div class="b3-list-item__first"><div class="color__square color__square--list">A</div><span class="b3-list-item__text">${window.siyuan.languages.clearFontStyle}</span></div>`},{value:"",id:"separator_6",html:"separator"}];let a=!1;return e.app.plugins.forEach(i=>{i.protyleSlash.forEach(s=>{n.push({filter:s.filter,value:`plugin${u.ZWSP}${i.name}${u.ZWSP}${s.id}`,html:s.html}),a=!0})}),a||n.pop(),t===""?n:n.filter(i=>i.filter?!!i.filter.find(o=>{if(o.toLowerCase().indexOf(t.toLowerCase())>-1)return!0}):!1)},ex=(t,e)=>(e.hint.genLoading(e),E("/api/search/searchTag",{k:t},n=>{const a=[];let i=!1;n.data.tags.forEach(s=>{const o=s.replace(/<mark>/g,"").replace(/<\/mark>/g,"");a.push({value:`<span data-type="tag">${o}</span>`,html:`<div class="b3-list-item__text">${s}</div>`}),o===n.data.k&&(i=!0)}),n.data.k&&!i&&(a.splice(0,0,{value:`<span data-type="tag">${n.data.k}</span>`,html:`<div class="b3-list-item__text">${window.siyuan.languages.new} <mark>${pe(n.data.k)}</mark></div>`}),a.length>1&&(a[1].focus=!0)),e.hint.genHTML(a,e,!0,"hint")}),[]),lm=t=>{let e;t.type==="NodeDocument"&&t.ial.icon?(e=ge(t.ial.icon,"b3-list-item__graphic popover__block",!0),e=e.replace('popover__block"',`popover__block" data-id="${t.id}"`)):e=`<svg class="b3-list-item__graphic popover__block" data-id="${t.id}"><use xlink:href="#${Rn(t.type)}"></use></svg>`;let n="";return t.name&&(n+=`<span class="fn__flex"><svg class="b3-list-item__hinticon"><use xlink:href="#iconN"></use></svg><span>${t.name}</span></span><span class="fn__space"></span>`),t.alias&&(n+=`<span class="fn__flex"><svg class="b3-list-item__hinticon"><use xlink:href="#iconA"></use></svg><span>${t.alias}</span></span><span class="fn__space"></span>`),t.memo&&(n+=`<span class="fn__flex"><svg class="b3-list-item__hinticon"><use xlink:href="#iconM"></use></svg><span>${t.memo}</span></span>`),n&&(n=`<div class="fn__flex b3-list-item__meta b3-list-item__showall">${n}</div>`),`${n}<div class="b3-list-item__first">
    ${e}
    <span class="b3-list-item__text">${t.content}</span>
</div>
<div class="b3-list-item__meta b3-list-item__showall">${t.hPath}</div>`},ss=(t,e,n)=>{const a=P(me(e.wysiwyg.element).startContainer);return e.hint.genLoading(e),E("/api/search/searchRefBlock",{k:t,id:a?a.getAttribute("data-node-id"):e.block.parentID,beforeLen:Math.floor((Math.max(e.element.clientWidth/2,320)-58)/28.8),rootID:n==="av"?"":e.block.rootID,isDatabase:n==="av",isSquareBrackets:["[[","\u3010\u3010"].includes(e.hint.splitChar)},i=>{const s=[];if(i.data.newDoc){const o=Lute.UnEscapeHTMLStr(On(i.data.k));s.push({value:`((newFile "${o}"${u.ZWSP}'${o}${Lute.Caret}'))`,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg>
<span class="b3-list-item__text">${window.siyuan.languages.newFile} <mark>${i.data.k}</mark></span></div>`})}i.data.blocks.forEach(o=>{let l=`<span data-type="block-ref" data-id="${o.id}" data-subtype="d">${o.name||o.refText.replace(new RegExp(u.ZWSP,"g"),"")}</span>`;if(n==="search")l=`<span data-type="block-ref" data-id="${o.id}" data-subtype="s">${t}${u.ZWSP}${o.name||o.refText.replace(new RegExp(u.ZWSP,"g"),"")}</span>`;else if(n==="av"){let r=o.name||o.refText.replace(new RegExp(u.ZWSP,"g"),"");a&&(r=o.ial["custom-sy-av-s-text-"+a.getAttribute("data-av-id")]||r),l=`<span data-type="block-ref" data-id="${o.id}" data-subtype="s">${r}</span>`}s.push({value:l,html:lm(o)})}),n==="search"&&(e.hint.splitChar="((",e.hint.lastIndex=-1),s.length===0?s.push({value:"",html:window.siyuan.languages.emptyContent}):i.data.newDoc&&s.length>1&&(s[1].focus=!0),e.hint.genHTML(s,e,!0,n)}),[]},Cl=(t,e)=>{if(t.endsWith("}}")||t.endsWith("\u300D\u300D"))return[];e.hint.genLoading(e);const n=P(me(e.wysiwyg.element).startContainer);return E("/api/search/searchRefBlock",{k:t,isDatabase:!1,beforeLen:Math.floor((Math.max(e.element.clientWidth/2,320)-58)/28.8),id:n?n.getAttribute("data-node-id"):e.block.parentID,rootID:e.block.rootID},a=>{const i=[];a.data.blocks.forEach(s=>{i.push({value:`{{select * from blocks where id='${s.id}'}}`,html:lm(s)})}),i.length===0&&i.push({value:"",html:window.siyuan.languages.emptyContent}),e.hint.genHTML(i,e,!0,"hint")}),[]},L_=(t,e,n)=>{E("/api/template/render",{id:e.block.parentID,path:t},a=>{Z(e.toolbar.range);const i=le(n);i&&i.textContent.trim()===""?wt(a.data.content,e,!0):wt(a.data.content,e),e.wysiwyg.element.querySelectorAll('[status="temp"]').forEach(s=>{s.remove()}),Be(e,e.wysiwyg.element),yt(e.wysiwyg.element),ze(e.wysiwyg.element),dt(e.wysiwyg.element,e),Q(["util"],e)})},x_=(t,e)=>{Z(e.toolbar.range),wt(e.lute.SpinBlockDOM(`<iframe src="/widgets/${t}/" data-subtype="widget" border="0" frameborder="no" framespacing="0" allowfullscreen="true"></iframe>`),e,!0),Q(["util"],e)},A_=(t,e)=>{Z(e.toolbar.range);const n=Ee().extname(t).toLowerCase(),a=t.startsWith("assets/")?Jr(t):t;wt(s_(n,t,a,t.startsWith("assets/")?a+n:t),e),Q(["util"],e)},rm=(t,e,n)=>{if(t==="/")return;const a=nt(t,!0,!0);if(n.block.rootID===a)return;const i=[];let s;const o=e[0].parentElement;let l;if(e.forEach((r,d)=>{d===e.length-1&&r.parentElement&&(s=Je(r),l=s.nextElementSibling||s.previousElementSibling,s.isSameNode(r)&&(s=void 0)),i.push({action:"append",id:r.getAttribute("data-node-id"),parentID:a}),r.remove()}),s)i.push({action:"delete",id:s.getAttribute("data-node-id")}),s.remove();else if(o.classList.contains("list")&&o.getAttribute("data-subtype")==="o"&&o.childElementCount>1)ot(o,1),Array.from(o.children).forEach(r=>{r.classList.contains("protyle-attr")||i.push({action:"update",id:r.getAttribute("data-node-id"),data:r.outerHTML})});else if(n.block.showAll&&o.classList.contains("protyle-wysiwyg")&&o.childElementCount===0)setTimeout(()=>{Vt({protyle:n,id:n.block.parent2ID,focusId:n.block.parent2ID})},u.TIMEOUT_INPUT*2+100);else if(o.classList.contains("protyle-wysiwyg")&&o.innerHTML===""&&!L(o,"block__edit",!0)&&n.block.id===n.block.rootID){const r=Lute.NewNodeID(),d=pa(!1,!1,r);i.splice(0,0,{action:"insert",id:r,data:d.outerHTML,parentID:n.block.parentID}),o.innerHTML=d.outerHTML,ae(d)}else l&&ae(l);U(n,i)},co=t=>{t.style.minWidth?t.style.width="":t.removeAttribute("style")},cm=(t,e,n,a=[])=>{E("/api/search/searchAsset",{k:e,exts:a},i=>{let s="";i.data.forEach((d,c)=>{s+=`<div data-value="${d.path}" class="b3-list-item${c===0?" b3-list-item--focus":""}"><div class="b3-list-item__text">${d.hName}</div></div>`});const o=t.querySelector(".b3-list"),l=t.querySelector("#preview"),r=t.querySelector("input");o.innerHTML=s||`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`,i.data.length>0?l.innerHTML=so(i.data[0].path):l.innerHTML=window.siyuan.languages.emptyContent,window.siyuan.menus.menu.popup(n),e||r.select()})},dm=(t,e,n,a)=>{const i=new st("background-asset");i.isOpen||i.addItem({iconHTML:"",type:"readonly",label:`<div class="fn__flex" style="max-height: 50vh">
<div class="fn__flex-column" style="${W()?"width:100%":"min-width: 260px;max-width:420px"}">
    <div class="fn__flex" style="margin: 0 8px 4px 8px">
        <input class="b3-text-field fn__flex-1"/>
        <span class="fn__space"></span>
        <span data-type="previous" class="block__icon block__icon--show"><svg><use xlink:href="#iconLeft"></use></svg></span>
        <span class="fn__space"></span>
        <span data-type="next" class="block__icon block__icon--show"><svg><use xlink:href="#iconRight"></use></svg></span>
    </div>
    <div class="b3-list fn__flex-1 b3-list--background" style="position: relative"><img style="margin: 0 auto;display: block;width: 64px;height: 64px" src="/stage/loading-pure.svg"></div>
</div>
<div id="preview" style="width: 360px;display: ${W()||window.outerWidth<window.outerWidth/2+260?"none":"flex"};padding: 8px;overflow: auto;justify-content: center;align-items: center;word-break: break-all;"></div>
</div>`,bind(s){s.style.maxWidth="none";const o=s.querySelector(".b3-list"),l=s.querySelector("#preview");o.addEventListener("mouseover",d=>{const c=d.target,f=L(c,"b3-list-item");f&&(l.innerHTML=so(f.getAttribute("data-value")))});const r=s.querySelector("input");r.addEventListener("keydown",d=>{if(d.isComposing)return;const c=s.querySelector(".b3-list--empty");if(!c){const f=xn(o,d);f&&(l.innerHTML=so(f.getAttribute("data-value")),d.stopPropagation())}if(d.key==="Enter"){if(c)n||(window.siyuan.menus.menu.remove(),Z(t.toolbar.range));else{const f=s.querySelector(".b3-list-item--focus");n?n(f.getAttribute("data-value"),f.textContent):(A_(f.getAttribute("data-value"),t),window.siyuan.menus.menu.remove())}d.preventDefault(),d.stopPropagation()}else d.key==="Escape"&&(n||Z(t.toolbar.range))}),r.addEventListener("input",d=>{d.isComposing||(d.stopPropagation(),cm(s,r.value,e,a))}),r.addEventListener("compositionend",d=>{d.stopPropagation(),cm(s,r.value,e,a)}),s.lastElementChild.addEventListener("click",d=>{const c=d.target;if(B(c,"data-type","previous")){r.dispatchEvent(new KeyboardEvent("keydown",{key:"ArrowUp"})),d.stopPropagation();return}if(B(c,"data-type","next")){r.dispatchEvent(new KeyboardEvent("keydown",{key:"ArrowDown"})),d.stopPropagation();return}const p=L(c,"b3-list-item");if(p){d.stopPropagation();const h=p.getAttribute("data-value");n?n(h,p.textContent):(A_(h,t),window.siyuan.menus.menu.remove())}}),cm(s,"",e,a)}})},um=(t,e)=>{const n=P(e);if(!n)return;Q(["util","toolbar","hint"],t);const a=n.getAttribute("data-node-id");let i=n.outerHTML;window.siyuan.menus.menu.remove();let s;window.siyuan.menus.menu.append(new T({id:"idAndAnchor",iconHTML:"",type:"readonly",label:`<div>ID</div>
<textarea spellcheck="false" rows="1" style="margin:4px 0;width: ${W()?"200":"360"}px" class="b3-text-field" readonly>${e.getAttribute("data-id")||""}</textarea>
<div class="fn__hr"></div>
<div>${window.siyuan.languages.anchor}</div>
<textarea rows="1" style="margin:4px 0;width: ${W()?"200":"360"}px" class="b3-text-field"></textarea>`,bind(r){r.style.maxWidth="none",s=r.querySelectorAll(".b3-text-field")[1],s.value=e.textContent;const d=()=>{s.value?e.innerHTML=Lute.EscapeHTMLStr(s.value):e.innerHTML="*"};s.addEventListener("input",c=>{c.isComposing||(d(),c.stopPropagation())}),s.addEventListener("compositionend",c=>{c.isComposing||(d(),c.stopPropagation())}),s.addEventListener("keydown",c=>{if(!c.isComposing){if(c.key==="Enter"&&!c.isComposing)window.siyuan.menus.menu.remove();else if(ni(c))return}})}}).element),window.siyuan.menus.menu.append(new T({type:"separator"}).element),window.siyuan.menus.menu.append(new T({id:"turnInto",label:window.siyuan.languages.turnInto,icon:"iconRefresh",submenu:[{id:"text",iconHTML:"",label:window.siyuan.languages.text,click(){n.setAttribute("updated",Y().format("YYYYMMDDHHmmss")),am(e,"file-annotation-ref",t.toolbar.range),J(t,a,n.outerHTML,i),i=n.outerHTML}},{id:"text*",iconHTML:"",label:window.siyuan.languages.text+" *",click(){e.insertAdjacentHTML("beforebegin",e.innerHTML+" "),e.textContent="*",n.setAttribute("updated",Y().format("YYYYMMDDHHmmss")),J(t,a,n.outerHTML,i),i=n.outerHTML}}]}).element),window.siyuan.menus.menu.append(new T({id:"remove",icon:"iconTrashcan",label:window.siyuan.languages.remove,click(){e.insertAdjacentHTML("afterend","<wbr>"),e.remove(),n.setAttribute("updated",Y().format("YYYYMMDDHHmmss")),J(t,a,n.outerHTML,i),he(n,t.toolbar.range),i=n.outerHTML}}).element),t?.app?.plugins&&An({plugins:t.app.plugins,type:"open-menu-fileannotationref",detail:{protyle:t,element:e},separatorPosition:"top"});const o=e.getBoundingClientRect();window.siyuan.menus.menu.popup({x:o.left,y:o.top+26,h:26});const l=Le(t.element,"block__popover",!0);window.siyuan.menus.menu.element.setAttribute("data-from",l?l.dataset.level+"popover":"app"),s.select(),window.siyuan.menus.menu.removeCB=()=>{n.outerHTML!==i&&(n.setAttribute("updated",Y().format("YYYYMMDDHHmmss")),J(t,a,n.outerHTML,i));const r=getSelection().rangeCount===0?void 0:getSelection().getRangeAt(0);r&&!t.element.contains(r.startContainer)&&(t.toolbar.range.selectNodeContents(e),t.toolbar.range.collapse(!1),Z(t.toolbar.range))}},fm=(t,e)=>{const n=P(e);if(!n)return;Q(["util","toolbar","hint"],t);const a=e.getAttribute("data-id"),i=n.getAttribute("data-node-id");let s=n.outerHTML;if(window.siyuan.menus.menu.remove(),t.disabled||(window.siyuan.menus.menu.append(new T({id:"anchor",iconHTML:"",type:"readonly",label:`<input style="margin: 4px 0" class="b3-text-field fn__block" placeholder="${window.siyuan.languages.anchor}">`,bind(r){const d=r.querySelector("input");d.value=e.getAttribute("data-subtype")==="d"?"":e.textContent,d.addEventListener("input",()=>{d.value?e.innerHTML=Lute.EscapeHTMLStr(d.value):E("/api/block/getRefText",{id:a},c=>{e.innerHTML=c.data}),e.setAttribute("data-subtype",d.value?"s":"d")}),d.addEventListener("keydown",c=>{if(!c.isComposing){if(c.key==="Enter"&&!c.isComposing)window.siyuan.menus.menu.remove();else if(ni(c))return}})}}).element),window.siyuan.menus.menu.append(new T({id:"separator_1",type:"separator"}).element)),window.siyuan.menus.menu.append(new T({id:"openBy",label:window.siyuan.languages.openBy,icon:"iconOpen",accelerator:window.siyuan.config.keymap.editor.general.openBy.custom+"/"+window.siyuan.languages.click,click(){Ke(a,(r,d,c)=>{c||d.push(u.CB_GET_HL),de({app:t.app,id:a,action:d,zoomIn:r})})}}).element),window.siyuan.menus.menu.append(new T({id:"refTab",label:window.siyuan.languages.refTab,icon:"iconEyeoff",accelerator:window.siyuan.config.keymap.editor.general.refTab.custom+"/"+X("\u2318"+window.siyuan.languages.click),click(){Ke(a,r=>{de({app:t.app,id:a,action:r?[u.CB_GET_HL,u.CB_GET_ALL]:[u.CB_GET_HL,u.CB_GET_CONTEXT,u.CB_GET_ROOTSCROLL],keepCursor:!0,zoomIn:r})})}}).element),window.siyuan.menus.menu.append(new T({id:"insertRight",label:window.siyuan.languages.insertRight,icon:"iconLayoutRight",accelerator:window.siyuan.config.keymap.editor.general.insertRight.custom+"/"+X("\u2325"+window.siyuan.languages.click),click(){Ke(a,(r,d,c)=>{c||d.push(u.CB_GET_HL),de({app:t.app,id:a,position:"right",action:d,zoomIn:r})})}}).element),window.siyuan.menus.menu.append(new T({id:"insertBottom",label:window.siyuan.languages.insertBottom,icon:"iconLayoutBottom",accelerator:window.siyuan.config.keymap.editor.general.insertBottom.custom+(window.siyuan.config.keymap.editor.general.insertBottom.custom?"/":"")+X("\u21E7"+window.siyuan.languages.click),click(){Ke(a,(r,d,c)=>{c||d.push(u.CB_GET_HL),de({app:t.app,id:a,position:"bottom",action:d,zoomIn:r})})}}).element),window.siyuan.menus.menu.append(new T({id:"openByNewWindow",label:window.siyuan.languages.openByNewWindow,icon:"iconOpenWindow",click(){Xr(a)}}).element),window.siyuan.menus.menu.append(new T({id:"separator_2",type:"separator"}).element),window.siyuan.menus.menu.append(new T({id:"backlinks",icon:"iconLink",label:window.siyuan.languages.backlinks,accelerator:window.siyuan.config.keymap.editor.general.backlinks.custom,click:()=>{Qf({app:t.app,blockId:a})}}).element),window.siyuan.menus.menu.append(new T({id:"graphView",icon:"iconGraph",label:window.siyuan.languages.graphView,accelerator:window.siyuan.config.keymap.editor.general.graphView.custom,click:()=>{ep({app:t.app,blockId:a})}}).element),window.siyuan.menus.menu.append(new T({id:"separator_3",type:"separator"}).element),!t.disabled){let r=[];e.getAttribute("data-subtype")==="s"?r.push({id:"turnToDynamic",iconHTML:"",label:window.siyuan.languages.turnToDynamic,click(){e.setAttribute("data-subtype","d"),E("/api/block/getRefText",{id:a},d=>{e.innerHTML=d.data,n.setAttribute("updated",Y().format("YYYYMMDDHHmmss")),J(t,i,n.outerHTML,s),s=n.outerHTML}),Z(t.toolbar.range)}}):r.push({id:"turnToStatic",iconHTML:"",label:window.siyuan.languages.turnToStatic,click(){e.setAttribute("data-subtype","s"),n.setAttribute("updated",Y().format("YYYYMMDDHHmmss")),J(t,i,n.outerHTML,s),Z(t.toolbar.range),s=n.outerHTML}}),r=r.concat([{id:"text",iconHTML:"",label:window.siyuan.languages.text,click(){n.setAttribute("updated",Y().format("YYYYMMDDHHmmss")),am(e,"block-ref",t.toolbar.range),J(t,i,n.outerHTML,s),s=n.outerHTML}},{id:"*",iconHTML:"",label:"*",click(){e.setAttribute("data-subtype","s"),e.textContent="*",n.setAttribute("updated",Y().format("YYYYMMDDHHmmss")),J(t,i,n.outerHTML,s),Z(t.toolbar.range),s=n.outerHTML}},{id:"text*",iconHTML:"",label:window.siyuan.languages.text+" *",click(){e.insertAdjacentHTML("beforebegin",e.innerHTML+" "),e.setAttribute("data-subtype","s"),e.textContent="*",n.setAttribute("updated",Y().format("YYYYMMDDHHmmss")),J(t,i,n.outerHTML,s),Z(t.toolbar.range),s=n.outerHTML}},{id:"link",label:window.siyuan.languages.link,iconHTML:"",click(){e.outerHTML=`<span data-type="a" data-href="siyuan://blocks/${e.getAttribute("data-id")}">${e.innerHTML}</span><wbr>`,n.setAttribute("updated",Y().format("YYYYMMDDHHmmss")),J(t,i,n.outerHTML,s),he(n,t.toolbar.range),s=n.outerHTML}}]),e.parentElement.textContent.trim()===e.textContent.trim()&&e.parentElement.tagName==="DIV"&&r.push({id:"blockEmbed",iconHTML:"",label:window.siyuan.languages.blockEmbed,click(){const d=`<div data-content="select * from blocks where id='${a}'" data-node-id="${i}" data-type="NodeBlockQueryEmbed" class="render-node" updated="${Y().format("YYYYMMDDHHmmss")}">${n.querySelector(".protyle-attr").outerHTML}</div>`;n.outerHTML=d,J(t,i,d,s),Be(t,t.wysiwyg.element),s=n.outerHTML}}),r.push({id:"defBlock",iconHTML:"",label:window.siyuan.languages.defBlock,click(){E("/api/block/swapBlockRef",{refID:i,defID:a,includeChildren:!1})}}),r.push({id:"defBlockChildren",iconHTML:"",label:window.siyuan.languages.defBlockChildren,click(){E("/api/block/swapBlockRef",{refID:i,defID:a,includeChildren:!0})}}),window.siyuan.menus.menu.append(new T({id:"iconRefresh",label:window.siyuan.languages.turnInto,icon:"iconRefresh",submenu:r}).element)}window.siyuan.menus.menu.append(new T({id:"copy",label:window.siyuan.languages.copy,icon:"iconCopy",click(){De(t.lute.BlockDOM2StdMd(e.outerHTML))}}).element),t.disabled||(window.siyuan.menus.menu.append(new T({id:"cut",label:window.siyuan.languages.cut,icon:"iconCut",click(){De(t.lute.BlockDOM2StdMd(e.outerHTML)),e.insertAdjacentHTML("afterend","<wbr>"),e.remove(),n.setAttribute("updated",Y().format("YYYYMMDDHHmmss")),J(t,i,n.outerHTML,s),he(n,t.toolbar.range),s=n.outerHTML}}).element),window.siyuan.menus.menu.append(new T({id:"remove",label:window.siyuan.languages.remove,icon:"iconTrashcan",click(){e.insertAdjacentHTML("afterend","<wbr>"),e.remove(),n.setAttribute("updated",Y().format("YYYYMMDDHHmmss")),J(t,i,n.outerHTML,s),he(n,t.toolbar.range),s=n.outerHTML}}).element)),t?.app?.plugins&&An({plugins:t.app.plugins,type:"open-menu-blockref",detail:{protyle:t,element:e},separatorPosition:"top"});const o=e.getBoundingClientRect();window.siyuan.menus.menu.popup({x:o.left,y:o.top+26,h:26});const l=Le(t.element,"block__popover",!0);window.siyuan.menus.menu.data=e,window.siyuan.menus.menu.element.setAttribute("data-from",l?l.dataset.level+"popover":"app"),t.disabled||(window.siyuan.menus.menu.element.querySelector("input").select(),window.siyuan.menus.menu.removeCB=()=>{n.outerHTML!==s&&(n.setAttribute("updated",Y().format("YYYYMMDDHHmmss")),J(t,i,n.outerHTML,s));const r=getSelection().rangeCount===0?void 0:getSelection().getRangeAt(0);r&&!t.element.contains(r.startContainer)&&(t.toolbar.range.selectNodeContents(e),t.toolbar.range.collapse(!1),Z(t.toolbar.range))})},tx=(t,e)=>{const n=me(e);window.siyuan.menus.menu.remove();const a=e.outerHTML,i=e.getAttribute("data-node-id");if(n.toString()!==""||n.cloneContents().childNodes[0]?.classList?.contains("emoji")){if(window.siyuan.menus.menu.append(new T({id:"copy",icon:"iconCopy",accelerator:"\u2318C",label:window.siyuan.languages.copy,click(){Z(me(e)),document.execCommand("copy")}}).element),window.siyuan.menus.menu.append(new T({id:"copyPlainText",label:window.siyuan.languages.copyPlainText,accelerator:window.siyuan.config.keymap.editor.general.copyPlainText.custom,click(){Z(me(e)),Zi(getSelection().getRangeAt(0).toString())}}).element),t.disabled)return;window.siyuan.menus.menu.append(new T({id:"cut",icon:"iconCut",accelerator:"\u2318X",label:window.siyuan.languages.cut,click(){Z(me(e)),document.execCommand("cut")}}).element),window.siyuan.menus.menu.append(new T({id:"delete",icon:"iconTrashcan",accelerator:"\u232B",label:window.siyuan.languages.delete,click(){const s=me(e);s.insertNode(document.createElement("wbr")),s.extractContents(),he(e,s),Z(s),J(t,i,e.outerHTML,a)}}).element)}else{const s=q(n.startContainer,"SPAN");if(s){const o=t.toolbar.getCurrentType(n);if(o.includes("code")||o.includes("kbd")){if(window.siyuan.menus.menu.append(new T({id:"copy",label:window.siyuan.languages.copy,icon:"iconCopy",click(){De(t.lute.BlockDOM2StdMd(s.outerHTML))}}).element),window.siyuan.menus.menu.append(new T({id:"copyPlainText",label:window.siyuan.languages.copyPlainText,click(){Zi(s.textContent)}}).element),!t.disabled){const l=e.getAttribute("data-node-id");window.siyuan.menus.menu.append(new T({id:"cut",icon:"iconCut",label:window.siyuan.languages.cut,click(){De(t.lute.BlockDOM2StdMd(s.outerHTML)),s.insertAdjacentHTML("afterend","<wbr>"),s.remove(),e.setAttribute("updated",Y().format("YYYYMMDDHHmmss")),J(t,l,e.outerHTML,a),he(e,t.toolbar.range)}}).element),window.siyuan.menus.menu.append(new T({id:"remove",icon:"iconTrashcan",label:window.siyuan.languages.remove,click(){s.insertAdjacentHTML("afterend","<wbr>"),s.remove(),e.setAttribute("updated",Y().format("YYYYMMDDHHmmss")),J(t,l,e.outerHTML,a),he(e,t.toolbar.range)}}).element)}window.siyuan.menus.menu.append(new T({type:"separator"}).element)}}}if(t.disabled||(window.siyuan.menus.menu.append(new T({id:"paste",label:window.siyuan.languages.paste,icon:"iconPaste",accelerator:"\u2318V",async click(){if(document.queryCommandSupported("paste"))document.execCommand("paste");else try{const s=await ef();wl(t,Object.assign(s,{target:e}))}catch(s){console.log(s)}}}).element),window.siyuan.menus.menu.append(new T({id:"pasteAsPlainText",label:window.siyuan.languages.pasteAsPlainText,accelerator:"\u21E7\u2318V",click(){Z(me(e)),Mh(t)}}).element),window.siyuan.menus.menu.append(new T({id:"pasteEscaped",label:window.siyuan.languages.pasteEscaped,click(){Tw(t,e)}}).element)),window.siyuan.menus.menu.append(new T({id:"selectAll",label:window.siyuan.languages.selectAll,icon:"iconSelect",accelerator:"\u2318A",click(){Lp(t,e,n)}}).element),e.classList.contains("table")&&!t.disabled){const s=q(n.startContainer,"TD")||q(n.startContainer,"TH");if(s){const o=C_(t,e,s,n);o.insertMenus.length>0&&(window.siyuan.menus.menu.append(new T({id:"separator_1",type:"separator"}).element),o.insertMenus.forEach(l=>{window.siyuan.menus.menu.append(new T(l).element)})),o.removeMenus.length>0&&(window.siyuan.menus.menu.append(new T({id:"separator_2",type:"separator"}).element),o.removeMenus.forEach(l=>{window.siyuan.menus.menu.append(new T(l).element)})),window.siyuan.menus.menu.append(new T({id:"separator_3",type:"separator"}).element),window.siyuan.menus.menu.append(new T({id:"more",type:"submenu",icon:"iconMore",label:window.siyuan.languages.more,submenu:o.otherMenus.concat(o.other2Menus)}).element)}}t?.app?.plugins&&An({plugins:t.app.plugins,type:"open-menu-content",detail:{protyle:t,range:n,element:e},separatorPosition:"top"})},pm=(t,e)=>{if(t.block.showAll)Vt({protyle:t,id:t.block.parent2ID,focusId:e});else{const n=t.path.split("/");n.length>2&&de({app:t.app,id:n[n.length-2],action:[u.CB_GET_FOCUS,u.CB_GET_SCROLL]})}},Vt=t=>{if(t.protyle.options.backlinkData)return;typeof t.isPushBack>"u"&&(t.isPushBack=!0),typeof t.reload>"u"&&(t.reload=!1);const e=t.protyle.breadcrumb?.element.querySelector(".protyle-breadcrumb__item--active");if(!t.reload&&e&&e.getAttribute("data-node-id")===t.id){if(t.id===t.protyle.block.rootID)return;const n=t.protyle.wysiwyg.element.querySelector(`[data-node-id="${t.focusId||t.id}"]`);if(n){ae(n),n.scrollIntoView();return}}window.siyuan.mobile?.editor&&(window.siyuan.storage[u.LOCAL_DOCINFO]={id:t.id},ue(u.LOCAL_DOCINFO,window.siyuan.storage[u.LOCAL_DOCINFO]),t.isPushBack&&nm()),E("/api/filetree/getDoc",{id:t.id,size:t.id===t.protyle.block.rootID?window.siyuan.config.editor.dynamicLoadBlocks:u.SIZE_GET_MAX},async n=>{if(t.isPushBack?rt({data:n,protyle:t.protyle,action:t.id===t.protyle.block.rootID?[u.CB_GET_FOCUS,u.CB_GET_HTML]:[u.CB_GET_ALL,u.CB_GET_FOCUS,u.CB_GET_HTML],afterCB:t.callback}):rt({data:n,protyle:t.protyle,action:t.id===t.protyle.block.rootID?[u.CB_GET_FOCUS,u.CB_GET_HTML,u.CB_GET_UNUNDO]:[u.CB_GET_ALL,u.CB_GET_FOCUS,u.CB_GET_UNUNDO,u.CB_GET_HTML],afterCB:t.callback}),t.focusId){let a=t.protyle.wysiwyg.element.querySelector(`[data-node-id="${t.focusId}"]`);if(!a){const i=await Re("/api/block/getUnfoldedParentID",{id:t.focusId});t.focusId=i.data.parentID,a=t.protyle.wysiwyg.element.querySelector(`[data-node-id="${i.data.parentID}"]`)}if(a){let i=a;for(;i.getBoundingClientRect().height===0;)i=i.parentElement;i.classList.contains("protyle-wysiwyg")?i=a.previousElementSibling||a.nextElementSibling:i=it(i),ae(i);const s=new ResizeObserver(()=>{i.scrollIntoView()});s.observe(t.protyle.wysiwyg.element),setTimeout(()=>{s.disconnect()},1e3*3)}else if(t.id===t.protyle.block.rootID){E("/api/filetree/getDoc",{id:t.focusId,mode:3,size:window.siyuan.config.editor.dynamicLoadBlocks},i=>{rt({data:i,protyle:t.protyle,action:t.isPushBack?[u.CB_GET_FOCUS]:[u.CB_GET_FOCUS,u.CB_GET_UNUNDO]})});return}}else t.id!==t.protyle.block.rootID&&(t.protyle.wysiwyg.element.classList.add("protyle-wysiwyg--animate"),setTimeout(()=>{t.protyle.wysiwyg.element.classList.remove("protyle-wysiwyg--animate")},365));if(t.protyle.model){const a=Ce();a.outline.forEach(i=>{i.blockId===t.protyle.block.rootID&&i.setCurrent(t.protyle.wysiwyg.element.querySelector(`[data-node-id="${t.focusId||t.id}"]`))}),fb(a,t.protyle)}})},gm=(t,e,n,a)=>{window.siyuan.menus.menu.remove();const i=P(n);if(!i)return;Q(["util","toolbar","hint"],t);const s=i.getAttribute("data-node-id"),o=n.querySelector("img"),l=n.querySelector(".protyle-action__title span"),r=i.outerHTML;if(t.disabled||(window.siyuan.menus.menu.append(new T({id:"imageUrlAndTitleAndTooltipText",iconHTML:"",type:"readonly",label:`<div class="fn__flex">
    <span class="fn__flex-center">${window.siyuan.languages.imageURL}</span>
    <span class="fn__space"></span>
    <span data-action="copy" class="block__icon block__icon--show b3-tooltips b3-tooltips__e fn__flex-center" aria-label="${window.siyuan.languages.copy}">
        <svg><use xlink:href="#iconCopy"></use></svg>
    </span>   
</div>
<textarea spellcheck="false" style="margin:4px 0;width: ${W()?"200":"360"}px" rows="1" class="b3-text-field">${o.getAttribute("src")}</textarea>
<div class="fn__hr"></div>
<div class="fn__flex">
    <span class="fn__flex-center">${window.siyuan.languages.title}</span>
    <span class="fn__space"></span>
    <span data-action="copy" class="block__icon block__icon--show b3-tooltips b3-tooltips__e fn__flex-center" aria-label="${window.siyuan.languages.copy}">
        <svg><use xlink:href="#iconCopy"></use></svg>
    </span>   
</div>
<textarea style="margin:4px 0;width: ${W()?"200":"360"}px" rows="1" class="b3-text-field"></textarea>
<div class="fn__hr"></div>
<div class="fn__flex">
    <span class="fn__flex-center">${window.siyuan.languages.tooltipText}</span>
    <span class="fn__space"></span>
    <span data-action="copy" class="block__icon block__icon--show b3-tooltips b3-tooltips__e fn__flex-center" aria-label="${window.siyuan.languages.copy}">
        <svg><use xlink:href="#iconCopy"></use></svg>
    </span>   
</div>
<textarea style="margin:4px 0;width: ${W()?"200":"360"}px" rows="1" class="b3-text-field"></textarea>`,bind(g){g.style.maxWidth="none";const p=g.querySelectorAll("textarea");p[0].addEventListener("input",h=>{const m=h.target.value.replace(/\n|\r\n|\r|\u2028|\u2029/g,"").trim();if(o.setAttribute("src",m),o.setAttribute("data-src",m),m.startsWith("assets/")){const b=n.querySelector(".img__net");b&&b.remove()}else window.siyuan.config.editor.displayNetImgMark&&n.querySelector(".protyle-action__drag").insertAdjacentHTML("afterend",'<span class="img__net"><svg><use xlink:href="#iconLanguage"></use></svg></span>')}),p[1].value=l.innerText,p[1].addEventListener("input",h=>{const m=h.target.value;o.setAttribute("title",m),l.innerText=m,Ma(l)}),p[2].value=o.getAttribute("alt")||"",g.addEventListener("click",h=>{let m=h.target;for(;m;){if(m.dataset.action==="copy"){De(m.parentElement.nextElementSibling.value),j(window.siyuan.languages.copied);break}m=m.parentElement}})}}).element),window.siyuan.menus.menu.append(new T({id:"separator_1",type:"separator"}).element)),window.siyuan.menus.menu.append(new T({id:"copy",label:window.siyuan.languages.copy,accelerator:"\u2318C",icon:"iconCopy",click(){let g=t.lute.BlockDOM2StdMd(n.outerHTML);g=g.replace(/%20/g," "),De(g)}}).element),t.disabled&&window.siyuan.menus.menu.append(new T({id:"copyImageURL",label:window.siyuan.languages.copy+" "+window.siyuan.languages.imageURL,icon:"iconLink",click(){De(o.getAttribute("src"))}}).element),window.siyuan.menus.menu.append(new T({id:"copyAsPNG",label:window.siyuan.languages.copyAsPNG,accelerator:window.siyuan.config.keymap.editor.general.copyBlockRef.custom,icon:"iconImage",click(){Ch(o.getAttribute("src"))}}).element),!t.disabled){window.siyuan.menus.menu.append(new T({id:"cut",icon:"iconCut",accelerator:"\u2318X",label:window.siyuan.languages.cut,click(){let m=t.lute.BlockDOM2StdMd(n.outerHTML);m=m.replace(/%20/g," "),De(m),n.outerHTML="<wbr>",i.setAttribute("updated",Y().format("YYYYMMDDHHmmss")),J(t,s,i.outerHTML,r),he(t.wysiwyg.element,e)}}).element),window.siyuan.menus.menu.append(new T({id:"delete",icon:"iconTrashcan",accelerator:"\u232B",label:window.siyuan.languages.delete,click:function(){n.outerHTML="<wbr>",i.setAttribute("updated",Y().format("YYYYMMDDHHmmss")),J(t,s,i.outerHTML,r),he(t.wysiwyg.element,e)}}).element),window.siyuan.menus.menu.append(new T({id:"separator_2",type:"separator"}).element);const g=o.getAttribute("data-src");g.startsWith("assets/")&&window.siyuan.menus.menu.append(new T({id:"rename",label:window.siyuan.languages.rename,icon:"iconEdit",click(){gf(g)}}).element),window.siyuan.menus.menu.append(new T({id:"ocr",label:"OCR",submenu:[{id:"ocrResult",iconHTML:"",type:"readonly",label:`<textarea spellcheck="false" data-type="ocr" style="margin: 4px 0" rows="1" class="b3-text-field fn__size200" placeholder="${window.siyuan.languages.ocrResult}"></textarea>`,bind(m){m.style.maxWidth="none",E("/api/asset/getImageOCRText",{path:o.getAttribute("src")},b=>{const y=m.querySelector("textarea");y.value=b.data.text,y.dataset.ocrText=b.data.text})}},{type:"separator"},{id:"reOCR",iconHTML:"",label:window.siyuan.languages.reOCR,click(){E("/api/asset/ocr",{path:o.getAttribute("src"),force:!0})}}]}).element),window.siyuan.menus.menu.append(new T({id:"alignCenter",icon:"iconAlignCenter",label:window.siyuan.languages.alignCenter,accelerator:window.siyuan.config.keymap.editor.general.alignCenter.custom,click(){__(t,i,[n],s,r)}}).element),window.siyuan.menus.menu.append(new T({id:"alignLeft",icon:"iconAlignLeft",label:window.siyuan.languages.alignLeft,accelerator:window.siyuan.config.keymap.editor.general.alignLeft.custom,click(){v_(t,i,[n],s,r)}}).element);let p;window.siyuan.menus.menu.append(new T({id:"width",label:window.siyuan.languages.width,submenu:[{id:"widthInput",iconHTML:"",type:"readonly",label:`<div class="fn__flex-center">
<input class="b3-text-field" style="margin: 4px 8px 4px 0" value="${o.parentElement.style.width.endsWith("px")?parseInt(o.parentElement.style.width):""}" type="number" placeholder="${window.siyuan.languages.width}">px
</div>`,bind(m){const b=m.querySelector("input");b.addEventListener("input",()=>{p.value="0",p.parentElement.setAttribute("aria-label",b.value?b.value+"px":window.siyuan.languages.default),co(n),o.parentElement.style.width=b.value?b.value+"px":"",o.style.height=""}),b.addEventListener("blur",()=>{b.value!==o.parentElement.style.width.replace("px","")&&(i.setAttribute("updated",Y().format("YYYYMMDDHHmmss")),J(t,s,i.outerHTML,r),window.siyuan.menus.menu.remove(),ae(i))})}},uo("25%",o,t,s,i,r),uo("33%",o,t,s,i,r),uo("50%",o,t,s,i,r),uo("67%",o,t,s,i,r),uo("75%",o,t,s,i,r),uo("100%",o,t,s,i,r),{id:"separator_1",type:"separator"},{id:"widthDrag",iconHTML:"",type:"readonly",label:`<div style="margin: 4px 0;" aria-label="${o.parentElement.style.width?o.parentElement.style.width.replace("vw","%").replace("calc(","").replace(" - 8px)",""):window.siyuan.languages.default}" class="b3-tooltips b3-tooltips__n${W()?"":" fn__size200"}">
    <input style="box-sizing: border-box" value="${o.parentElement.style.width.indexOf("%")>-1||o.parentElement.style.width.endsWith("vw")?parseInt(o.parentElement.style.width.replace("calc(","")):0}" class="b3-slider fn__block" max="100" min="1" step="1" type="range">
</div>`,bind(m){p=m.querySelector("input"),p.addEventListener("input",()=>{co(n),o.parentElement.style.width=`calc(${p.value}% - 8px)`,o.style.height="",p.parentElement.setAttribute("aria-label",`${p.value}%`)}),p.addEventListener("change",()=>{i.setAttribute("updated",Y().format("YYYYMMDDHHmmss")),J(t,s,i.outerHTML,r),window.siyuan.menus.menu.remove(),ae(i)})}},{id:"separator_2",type:"separator"},uo(window.siyuan.languages.default,o,t,s,i,r)]}).element);let h;window.siyuan.menus.menu.append(new T({id:"height",label:window.siyuan.languages.height,submenu:[{id:"heightInput",iconHTML:"",type:"readonly",label:`<div class="fn__flex-center">
<input class="b3-text-field" value="${o.style.height.endsWith("px")?parseInt(o.style.height):""}" type="number" style="margin: 4px 8px 4px 0" placeholder="${window.siyuan.languages.height}">px
</div>`,bind(m){const b=m.querySelector("input");b.addEventListener("input",()=>{h.value="0",h.parentElement.setAttribute("aria-label",b.value?b.value+"px":window.siyuan.languages.default),o.style.height=b.value?b.value+"px":"",co(n),o.parentElement.style.width=""}),b.addEventListener("blur",()=>{b.value!==o.style.height.replace("px","")&&(i.setAttribute("updated",Y().format("YYYYMMDDHHmmss")),J(t,s,i.outerHTML,r),window.siyuan.menus.menu.remove(),ae(i))})}},fo("25%",o,t,s,i,r),fo("33%",o,t,s,i,r),fo("50%",o,t,s,i,r),fo("67%",o,t,s,i,r),fo("75%",o,t,s,i,r),fo("100%",o,t,s,i,r),{id:"separator_1",type:"separator"},{id:"heightDrag",iconHTML:"",type:"readonly",label:`<div style="margin: 4px 0;" aria-label="${o.style.height?o.style.height.replace("vh","%"):window.siyuan.languages.default}" class="b3-tooltips b3-tooltips__n${W()?"":" fn__size200"}">
    <input style="box-sizing: border-box" value="${o.style.height.endsWith("vh")?parseInt(o.style.height):0}" class="b3-slider fn__block" max="100" min="1" step="1" type="range">
</div>`,bind(m){h=m.querySelector("input"),h.addEventListener("input",()=>{co(n),o.parentElement.style.width="",o.style.height=h.value+"vh",h.parentElement.setAttribute("aria-label",`${h.value}%`)}),h.addEventListener("change",()=>{i.setAttribute("updated",Y().format("YYYYMMDDHHmmss")),J(t,s,i.outerHTML,r),window.siyuan.menus.menu.remove(),ae(i)})}},{id:"separator_2",type:"separator"},fo(window.siyuan.languages.default,o,t,s,i,r)]}).element)}const d=o.getAttribute("src");d&&(window.siyuan.menus.menu.append(new T({id:"separator_3",type:"separator"}).element),vc(t.app,d,!1,!1));const c=o.getAttribute("data-src");c&&c.startsWith("assets/")&&window.siyuan.menus.menu.append(new T(df(c)).element),t?.app?.plugins&&An({plugins:t.app.plugins,type:"open-menu-image",detail:{protyle:t,element:n},separatorPosition:"top"}),window.siyuan.menus.menu.popup({x:a.clientX,y:a.clientY});const f=Le(t.element,"block__popover",!0);if(window.siyuan.menus.menu.element.setAttribute("data-from",f?f.dataset.level+"popover":"app"),!t.disabled){const g=window.siyuan.menus.menu.element.querySelectorAll("textarea");g[0].value?g[1].select():g[0].select(),window.siyuan.menus.menu.removeCB=()=>{const p=window.siyuan.menus.menu.element.querySelector('[data-type="ocr"]');p&&p.dataset.ocrText!==p.value&&E("/api/asset/setImageOCRText",{path:o.getAttribute("src"),text:p.value}),o.setAttribute("alt",g[2].value.replace(/\n|\r\n|\r|\u2028|\u2029/g,"")),i.setAttribute("updated",Y().format("YYYYMMDDHHmmss")),J(t,s,i.outerHTML,r)}}},bc=(t,e,n=!1)=>{window.siyuan.menus.menu.remove();const a=P(e);if(!a)return;Zt(),Q(["util","toolbar","hint"],t);const i=a.getAttribute("data-node-id");let s=a.outerHTML;const o=e.getAttribute("data-href");let l;t.disabled||(window.siyuan.menus.menu.append(new T({id:"linkAndAnchorAndTitle",iconHTML:"",type:"readonly",label:`<div class="fn__flex">
    <span class="fn__flex-center">${window.siyuan.languages.link}</span>
    <span class="fn__space"></span>
    <span data-action="copy" class="block__icon block__icon--show b3-tooltips b3-tooltips__e fn__flex-center" aria-label="${window.siyuan.languages.copy}">
        <svg><use xlink:href="#iconCopy"></use></svg>
    </span>   
</div>
<textarea spellcheck="false" rows="1" style="margin:4px 0;width: ${W()?"200":"360"}px" class="b3-text-field"></textarea>
<div class="fn__hr"></div>
<div class="fn__flex">
    <span class="fn__flex-center">${window.siyuan.languages.anchor}</span>
    <span class="fn__space"></span>
    <span data-action="copy" class="block__icon block__icon--show b3-tooltips b3-tooltips__e fn__flex-center" aria-label="${window.siyuan.languages.copy}">
        <svg><use xlink:href="#iconCopy"></use></svg>
    </span>   
</div>
<textarea style="width: ${W()?"200":"360"}px;margin: 4px 0;" rows="1" class="b3-text-field"></textarea>
<div class="fn__hr"></div>
<div class="fn__flex">
    <span class="fn__flex-center">${window.siyuan.languages.title}</span>
    <span class="fn__space"></span>
    <span data-action="copy" class="block__icon block__icon--show b3-tooltips b3-tooltips__e fn__flex-center" aria-label="${window.siyuan.languages.copy}">
        <svg><use xlink:href="#iconCopy"></use></svg>
    </span>   
</div>
<textarea style="width: ${W()?"200":"360"}px;margin: 4px 0;" rows="1" class="b3-text-field"></textarea>`,bind(c){c.style.maxWidth="none",l=c.querySelectorAll("textarea"),l[0].value=Lute.UnEscapeHTMLStr(o)||"",l[0].addEventListener("keydown",g=>{if((g.key==="Enter"||g.key==="Escape")&&!g.isComposing)g.preventDefault(),g.stopPropagation(),window.siyuan.menus.menu.remove();else if(g.key==="Tab"&&!g.isComposing)g.preventDefault(),g.stopPropagation(),l[1].focus();else if(ni(g))return});let f=e.textContent.replace(u.ZWSP,"");!f&&o&&(f=decodeURIComponent(o.replace("https://","").replace("http://","")),f.length>u.SIZE_LINK_TEXT_MAX&&(f=f.substring(0,u.SIZE_LINK_TEXT_MAX)+"..."),e.innerHTML=Lute.EscapeHTMLStr(f)),l[1].value=f,l[1].addEventListener("compositionend",()=>{e.innerHTML=Lute.EscapeHTMLStr(l[1].value.replace(/\n|\r\n|\r|\u2028|\u2029/g,"")||"*")}),l[1].addEventListener("input",g=>{g.isComposing||(e.innerHTML=Lute.EscapeHTMLStr(l[1].value.replace(/\n|\r\n|\r|\u2028|\u2029/g,""))||"*")}),l[1].addEventListener("keydown",g=>{if((g.key==="Enter"||g.key==="Escape")&&!g.isComposing)g.preventDefault(),g.stopPropagation(),window.siyuan.menus.menu.remove();else if(g.key==="Tab"&&!g.isComposing)g.preventDefault(),g.stopPropagation(),g.shiftKey?l[0].focus():l[2].focus();else if(ni(g))return}),l[2].value=Lute.UnEscapeHTMLStr(e.getAttribute("data-title")||""),l[2].addEventListener("keydown",g=>{if((g.key==="Enter"||g.key==="Escape")&&!g.isComposing)g.preventDefault(),g.stopPropagation(),window.siyuan.menus.menu.remove();else if(g.key==="Tab"&&g.shiftKey&&!g.isComposing)g.preventDefault(),g.stopPropagation(),l[1].focus();else if(ni(g))return}),c.addEventListener("click",g=>{let p=g.target;for(;p;){if(p.dataset.action==="copy"){De(p.parentElement.nextElementSibling.value),j(window.siyuan.languages.copied);break}p=p.parentElement}})}}).element),window.siyuan.menus.menu.append(new T({id:"separator_1",type:"separator"}).element)),window.siyuan.menus.menu.append(new T({id:"copy",label:window.siyuan.languages.copy,icon:"iconCopy",click(){const c=document.createRange();c.selectNode(e),Z(c),document.execCommand("copy")}}).element),t.disabled&&window.siyuan.menus.menu.append(new T({id:"copyAHref",label:window.siyuan.languages.copy+" "+window.siyuan.languages.replaceTypes.aHref,icon:"iconLink",click(){De(o)}}).element),t.disabled||(window.siyuan.menus.menu.append(new T({id:"cut",icon:"iconCut",label:window.siyuan.languages.cut,click(){const c=document.createRange();c.selectNode(e),Z(c),document.execCommand("cut")}}).element),window.siyuan.menus.menu.append(new T({id:"remove",icon:"iconTrashcan",label:window.siyuan.languages.remove,click(){e.insertAdjacentHTML("afterend","<wbr>"),e.remove(),a.setAttribute("updated",Y().format("YYYYMMDDHHmmss")),J(t,i,a.outerHTML,s),he(a,t.toolbar.range),s=a.outerHTML}}).element),o?.startsWith("assets/")&&window.siyuan.menus.menu.append(new T({id:"rename",label:window.siyuan.languages.rename,icon:"iconEdit",click(){gf(o)}}).element),o?.startsWith("siyuan://blocks/")&&window.siyuan.menus.menu.append(new T({id:"turnIntoRef",label:`${window.siyuan.languages.turnInto} <b>${window.siyuan.languages.ref}</b>`,icon:"iconRef",click(){e.setAttribute("data-subtype","s");const c=e.getAttribute("data-type").split(" ");c.push("block-ref"),c.splice(c.indexOf("a"),1),e.setAttribute("data-type",c.join(" ")),e.setAttribute("data-id",l[0].value.replace("siyuan://blocks/","")),l[0].value="",l[2].value="",e.removeAttribute("data-href"),e.removeAttribute("data-title"),a.setAttribute("updated",Y().format("YYYYMMDDHHmmss")),J(t,i,a.outerHTML,s),t.toolbar.range.selectNode(e),t.toolbar.range.collapse(!1),Z(t.toolbar.range),s=a.outerHTML}}).element),window.siyuan.menus.menu.append(new T({id:"turnIntoText",label:`${window.siyuan.languages.turnInto} <b>${window.siyuan.languages.text}</b>`,icon:"iconRefresh",click(){l[0].value="",l[2].value="",a.setAttribute("updated",Y().format("YYYYMMDDHHmmss")),am(e,"a",t.toolbar.range),J(t,i,a.outerHTML,s),s=a.outerHTML}}).element)),o&&(window.siyuan.menus.menu.append(new T({id:"separator_2",type:"separator"}).element),vc(t.app,o,!1,!0),o?.startsWith("assets/")&&window.siyuan.menus.menu.append(new T(df(o)).element)),!t.disabled&&t?.app?.plugins&&An({plugins:t.app.plugins,type:"open-menu-link",detail:{protyle:t,element:e},separatorPosition:"top"});const r=e.getBoundingClientRect();window.siyuan.menus.menu.popup({x:r.left,y:r.top+26,h:26});const d=Le(t.element,"block__popover",!0);window.siyuan.menus.menu.element.setAttribute("data-from",d?d.dataset.level+"popover":"app"),!t.disabled&&(n||t.lute.GetLinkDest(o)||o?.startsWith("assets/")?l[1].select():l[0].select(),window.siyuan.menus.menu.removeCB=()=>{l[2].value?e.setAttribute("data-title",Lute.EscapeHTMLStr(l[2].value.replace(/\n|\r\n|\r|\u2028|\u2029/g,""))):e.removeAttribute("data-title"),e.getAttribute("data-type").indexOf("a")>-1?e.setAttribute("data-href",Lute.EscapeHTMLStr(l[0].value.replace(/\n|\r\n|\r|\u2028|\u2029/g,""))):e.removeAttribute("data-href");const c=getSelection().rangeCount===0?void 0:getSelection().getRangeAt(0);c&&!t.element.contains(c.startContainer)&&(t.toolbar.range.selectNodeContents(e),t.toolbar.range.collapse(!1),Z(t.toolbar.range)),s!==a.outerHTML&&(a.setAttribute("updated",Y().format("YYYYMMDDHHmmss")),J(t,i,a.outerHTML,s))})},hm=(t,e)=>{window.siyuan.menus.menu.remove();const n=P(e);if(!n)return;Q(["util","toolbar","hint"],t);const a=n.getAttribute("data-node-id");let i=n.outerHTML;window.siyuan.menus.menu.append(new T({id:"tag",iconHTML:"",type:"readonly",label:`<input class="b3-text-field fn__size200" style="margin: 4px 0" placeholder="${window.siyuan.languages.tag}">`,bind(l){const r=l.querySelector("input");r.value=e.textContent.replace(u.ZWSP,""),r.addEventListener("change",()=>{J(t,a,n.outerHTML,i),i=n.outerHTML}),r.addEventListener("compositionend",()=>{e.innerHTML=u.ZWSP+Lute.EscapeHTMLStr(r.value||"")}),r.addEventListener("input",d=>{d.isComposing||(e.innerHTML=u.ZWSP+Lute.EscapeHTMLStr(r.value||""))}),r.addEventListener("keydown",d=>{if((d.key==="Enter"||d.key==="Escape")&&!d.isComposing){if(d.preventDefault(),d.stopPropagation(),r.value)t.toolbar.range.selectNodeContents(e),t.toolbar.range.collapse(!1),Z(t.toolbar.range);else{const c=n.outerHTML;e.insertAdjacentHTML("afterend","<wbr>"),e.remove(),n.setAttribute("updated",Y().format("YYYYMMDDHHmmss")),J(t,a,n.outerHTML,c),he(n,t.toolbar.range)}window.siyuan.menus.menu.remove()}else if(ni(d))return})}}).element),window.siyuan.menus.menu.append(new T({id:"separator_1",type:"separator"}).element),window.siyuan.menus.menu.append(new T({id:"search",label:window.siyuan.languages.search,accelerator:window.siyuan.languages.click,icon:"iconSearch",click(){ti(t.app,`#${e.textContent}#`,!1,{method:0})}}).element),window.siyuan.menus.menu.append(new T({id:"rename",label:window.siyuan.languages.rename,icon:"iconEdit",click(){gw(e.textContent.replace(u.ZWSP,""))}}).element),window.siyuan.menus.menu.append(new T({id:"separator_2",type:"separator"}).element),window.siyuan.menus.menu.append(new T({id:"turnIntoText",label:`${window.siyuan.languages.turnInto} <b>${window.siyuan.languages.text}</b>`,icon:"iconRefresh",click(){t.toolbar.range.setStart(e.firstChild,0),t.toolbar.range.setEnd(e.lastChild,e.lastChild.textContent.length),t.toolbar.setInlineMark(t,"tag","range")}}).element),window.siyuan.menus.menu.append(new T({id:"copy",label:window.siyuan.languages.copy,icon:"iconCopy",click(){const l=document.createRange();l.selectNode(e),Z(l),document.execCommand("copy")}}).element),window.siyuan.menus.menu.append(new T({id:"cut",label:window.siyuan.languages.cut,icon:"iconCut",click(){const l=document.createRange();l.selectNode(e),Z(l),document.execCommand("cut")}}).element),window.siyuan.menus.menu.append(new T({id:"remove",icon:"iconTrashcan",label:window.siyuan.languages.remove,click(){const l=n.outerHTML;e.insertAdjacentHTML("afterend","<wbr>"),e.remove(),n.setAttribute("updated",Y().format("YYYYMMDDHHmmss")),J(t,a,n.outerHTML,l),he(n,t.toolbar.range)}}).element),t?.app?.plugins&&An({plugins:t.app.plugins,type:"open-menu-tag",detail:{protyle:t,element:e},separatorPosition:"top"});const s=e.getBoundingClientRect();window.siyuan.menus.menu.popup({x:s.left,y:s.top+26,h:26});const o=Le(t.element,"block__popover",!0);window.siyuan.menus.menu.element.setAttribute("data-from",o?o.dataset.level+"popover":"app"),window.siyuan.menus.menu.element.querySelector("input").select()},zf=(t,e)=>{window.siyuan.menus.menu.remove();const n=P(e);if(!n)return;const a=n.getAttribute("data-node-id"),i=n.outerHTML;window.siyuan.menus.menu.append(new T({id:"copy",label:window.siyuan.languages.copy,icon:"iconCopy",click(){const o=document.createRange();o.selectNode(e),Z(o),document.execCommand("copy")}}).element),t.disabled||(window.siyuan.menus.menu.append(new T({id:"cut",icon:"iconCut",label:window.siyuan.languages.cut,click(){const o=document.createRange();o.selectNode(e),Z(o),document.execCommand("cut")}}).element),window.siyuan.menus.menu.append(new T({id:"remove",icon:"iconTrashcan",label:window.siyuan.languages.remove,click(){e.insertAdjacentHTML("afterend","<wbr>"),e.remove(),n.setAttribute("updated",Y().format("YYYYMMDDHHmmss")),J(t,a,n.outerHTML,i),he(n,t.toolbar.range)}}).element));const s=e.getBoundingClientRect();window.siyuan.menus.menu.popup({x:s.left,y:s.top+26,h:26})},uo=(t,e,n,a,i,s)=>({id:t===window.siyuan.languages.default?"default":"width_"+t,iconHTML:"",label:t,click(){i.setAttribute("updated",Y().format("YYYYMMDDHHmmss")),co(e.parentElement.parentElement),e.parentElement.style.width=t===window.siyuan.languages.default?"":`calc(${t} - 8px)`,e.style.height="",J(n,a,i.outerHTML,s),ae(i)}}),fo=(t,e,n,a,i,s)=>({id:t===window.siyuan.languages.default?"default":"width_"+t,iconHTML:"",label:t,click(){i.setAttribute("updated",Y().format("YYYYMMDDHHmmss")),e.style.height=t===window.siyuan.languages.default?"":parseInt(t)+"vh",co(e.parentElement.parentElement),e.parentElement.style.width="",J(n,a,i.outerHTML,s),ae(i)}}),nx=(t,e)=>{const n=e.getAttribute("data-node-id"),a=e.querySelector("iframe");let i=e.outerHTML;const s=[{id:"asset",iconHTML:"",type:"readonly",label:`<textarea spellcheck="false" rows="1" class="b3-text-field fn__size200" placeholder="${window.siyuan.languages.link}" style="margin: 4px 0">${a.getAttribute("src")||""}</textarea>`,bind(l){l.style.maxWidth="none",l.querySelector("textarea").addEventListener("change",r=>{const d=r.target.value.replace(/\n|\r\n|\r|\u2028|\u2029/g,"").trim(),c=d.match(/(?:www\.|\/\/)bilibili\.com\/video\/(\w+)/);if(d.indexOf("bilibili.com")>-1&&(d.indexOf("bvid=")>-1||c&&c[1])){const f={bvid:It("bvid",d)||c&&c[1],page:"1",high_quality:"1",as_wide:"1",allowfullscreen:"true",autoplay:"0"};new URL(d.startsWith("http")?d:"https:"+d).search.split("&").forEach((h,m)=>{if(!h)return;m===0&&(h=h.substr(1));const b=h.split("=");f[b[0]]=b[1]});let g="https://player.bilibili.com/player.html?";const p=Object.keys(f);p.forEach((h,m)=>{g+=`${h}=${f[h]}`,m<p.length-1&&(g+="&")}),a.setAttribute("src",g),a.setAttribute("sandbox","allow-top-navigation-by-user-activation allow-same-origin allow-forms allow-scripts allow-popups"),a.style.height||(a.style.height="360px"),a.style.width||(a.style.width="640px")}else a.setAttribute("src",d);J(t,n,e.outerHTML,i),i=e.outerHTML,r.stopPropagation()})}}],o=a.getAttribute("src");return o?(s.push({type:"separator"}),s.concat(vc(t.app,o,!0,!1))):s},ax=(t,e,n)=>{const a=e.getAttribute("data-node-id"),i=e.querySelector(n==="NodeVideo"?"video":"audio");let s=e.outerHTML;const o=[{id:"asset",iconHTML:"",type:"readonly",label:`<textarea spellcheck="false" rows="1" style="margin: 4px 0" class="b3-text-field" placeholder="${window.siyuan.languages.link}">${i.getAttribute("src")}</textarea>`,bind(r){r.style.maxWidth="none",r.querySelector("textarea").addEventListener("change",d=>{i.setAttribute("src",d.target.value.replace(/\n|\r\n|\r|\u2028|\u2029/g,"").trim()),J(t,a,e.outerHTML,s),s=e.outerHTML,d.stopPropagation()})}}],l=i.getAttribute("src");return l&&l.startsWith("assets/")&&(o.push({type:"separator"}),o.push({id:"rename",label:window.siyuan.languages.rename,icon:"iconEdit",click(){gf(l)}})),l&&o.push({id:"openBy",label:window.siyuan.languages.openBy,icon:"iconOpen",submenu:vc(t.app,l,!0,!1)}),l&&l.startsWith("assets/")&&o.push(df(l)),o},C_=(t,e,n,a)=>{const i=[],s=ca(n);(n.rowSpan>1||n.colSpan>1)&&i.push({id:"cancelMerged",label:window.siyuan.languages.cancelMerged,click:()=>{const N=e.outerHTML;let O=n.rowSpan,te=n.parentElement;const ne=n.colSpan;for(;O>0&&te;){let oe=te.children[s],ce=ne;for(;ce>0&&oe;)oe.classList.remove("fn__none"),oe.colSpan=1,oe.rowSpan=1,oe=oe.nextElementSibling,ce--;te=te.nextElementSibling,O--}if(n.rowSpan=1,n.colSpan=1,n.tagName==="TH"){let oe;if(Array.from(e.querySelectorAll("thead tr")).find(ce=>{if(oe=ce,Array.from(ce.children).forEach(Ge=>{(Ge.rowSpan!==1||Ge.classList.contains("fn__none"))&&(oe=void 0)}),oe)return!0}),oe){const ce=e.querySelector("tbody"),Ge=e.querySelector("thead");for(;!oe.isSameNode(Ge.lastElementChild);)ce.insertAdjacentElement("afterbegin",Ge.lastElementChild)}}Z(a),J(t,e.getAttribute("data-node-id"),e.outerHTML,N)}});const o=e.querySelectorAll("col")[s];(o.style.width||o.style.minWidth)&&i.push({id:"useDefaultWidth",label:window.siyuan.languages.useDefaultWidth,click:()=>{const N=e.outerHTML;o.style.width="",o.style.minWidth="",J(t,e.getAttribute("data-node-id"),e.outerHTML,N)}});const l=e.getAttribute("custom-pinthead");i.push({id:l?"unpinTableHead":"pinTableHead",icon:l?"iconUnpin":"iconPin",label:l?window.siyuan.languages.unpinTableHead:window.siyuan.languages.pinTableHead,click:()=>{const N=e.outerHTML;l?e.removeAttribute("custom-pinthead"):e.setAttribute("custom-pinthead","true"),J(t,e.getAttribute("data-node-id"),e.outerHTML,N)}}),i.push({id:"separator_1",type:"separator"}),i.push({id:"alignLeft",icon:"iconAlignLeft",accelerator:window.siyuan.config.keymap.editor.general.alignLeft.custom,label:window.siyuan.languages.alignLeft,click:()=>{Pa(t,[n],e,"left",a)}}),i.push({id:"alignCenter",icon:"iconAlignCenter",label:window.siyuan.languages.alignCenter,accelerator:window.siyuan.config.keymap.editor.general.alignCenter.custom,click:()=>{Pa(t,[n],e,"center",a)}}),i.push({id:"alignRight",icon:"iconAlignRight",label:window.siyuan.languages.alignRight,accelerator:window.siyuan.config.keymap.editor.general.alignRight.custom,click:()=>{Pa(t,[n],e,"right",a)}}),i.push({id:"useDefaultAlign",icon:"",label:window.siyuan.languages.useDefaultAlign,click:()=>{Pa(t,[n],e,"",a)}});const r=[];r.push(...i),r.push({type:"separator"});const d=e.querySelector("table"),c=n.parentElement.querySelector(".fn__none");let f=!1,g=!1;Array.from(n.parentElement.children).forEach(N=>{N.colSpan>1&&(f=!0),N.rowSpan>1&&(g=!0)});let p=!1,h=!1,m=!1,b=n.parentElement.previousElementSibling;!b&&n.parentElement.parentElement.tagName==="TBODY"&&(b=d.querySelector("thead").lastElementChild),b&&(p=b.querySelector(".fn__none"),Array.from(b.children).forEach(N=>{N.colSpan>1&&(h=!0),N.rowSpan>1&&(m=!0)}));let y=!1,w=!1,_=!1,x=n.parentElement.nextElementSibling;!x&&n.parentElement.parentElement.tagName==="THEAD"&&(x=d.querySelector("tbody")?.firstElementChild),x&&(y=x.querySelector(".fn__none"),Array.from(x.children).forEach(N=>{N.colSpan>1&&(w=!0),N.rowSpan>1&&(_=!0)}));let S=!0;Array.from(d.rows).find(N=>{const O=N.cells[s];if(O.classList.contains("fn__none")||O.colSpan>1||O.rowSpan>1)return S=!1,!0});let k=!0;Array.from(d.rows).find(N=>{const O=N.cells[s+1];if(O&&(O.classList.contains("fn__none")||O.colSpan>1||O.rowSpan>1))return k=!1,!0});let A=!0;Array.from(d.rows).find(N=>{const O=N.cells[s-1];if(O&&(O.classList.contains("fn__none")||O.colSpan>1||O.rowSpan>1))return A=!1,!0});const $=[];$.push({id:"insertRowAbove",icon:"iconBefore",label:window.siyuan.languages.insertRowAbove,accelerator:window.siyuan.config.keymap.editor.table.insertRowAbove.custom,click:()=>{vw(t,a,n,e)}}),(!y||y&&!_&&w)&&$.push({id:"insertRowBelow",icon:"iconAfter",label:window.siyuan.languages.insertRowBelow,accelerator:window.siyuan.config.keymap.editor.table.insertRowBelow.custom,click:()=>{Dh(t,a,n,e)}}),(S||A)&&$.push({id:"insertColumnLeft",icon:"iconInsertLeft",label:window.siyuan.languages.insertColumnLeft,accelerator:window.siyuan.config.keymap.editor.table.insertColumnLeft.custom,click:()=>{mf(t,e,n,"beforebegin",a)}}),(S||k)&&$.push({id:"insertColumnRight",icon:"iconInsertRight",label:window.siyuan.languages.insertColumnRight,accelerator:window.siyuan.config.keymap.editor.table.insertColumnRight.custom,click:()=>{mf(t,e,n,"afterend",a)}}),r.push(...$);const M=[];((!c||c&&!g&&f)&&(!p||p&&!m&&h)||(!c||c&&!g&&f)&&(!y||y&&!_&&w)||S&&A||S&&k)&&M.push({id:"separator_2",type:"separator"}),(!c||c&&!g&&f)&&(!p||p&&!m&&h)&&M.push({id:"moveToUp",icon:"iconUp",label:window.siyuan.languages.moveToUp,accelerator:window.siyuan.config.keymap.editor.table.moveToUp.custom,click:()=>{Sw(t,a,n,e)}}),(!c||c&&!g&&f)&&(!y||y&&!_&&w)&&M.push({id:"moveToDown",icon:"iconDown",label:window.siyuan.languages.moveToDown,accelerator:window.siyuan.config.keymap.editor.table.moveToDown.custom,click:()=>{Lw(t,a,n,e)}}),S&&A&&M.push({id:"moveToLeft",icon:"iconLeft",label:window.siyuan.languages.moveToLeft,accelerator:window.siyuan.config.keymap.editor.table.moveToLeft.custom,click:()=>{xw(t,a,n,e)}}),S&&k&&M.push({id:"moveToRight",icon:"iconRight",label:window.siyuan.languages.moveToRight,accelerator:window.siyuan.config.keymap.editor.table.moveToRight.custom,click:()=>{Aw(t,a,n,e)}}),r.push(...M),(n.parentElement.parentElement.tagName!=="THEAD"&&(!c&&!g||c&&!g&&f)||S)&&r.push({type:"separator"});const C=[];return n.parentElement.parentElement.tagName!=="THEAD"&&(!c&&!g||c&&!g&&f)&&C.push({id:"deleteRow",icon:"iconDeleteRow",label:window.siyuan.languages["delete-row"],accelerator:window.siyuan.config.keymap.editor.table["delete-row"].custom,click:()=>{Ew(t,a,n,e)}}),S&&C.push({id:"deleteColumn",icon:"iconDeleteColumn",label:window.siyuan.languages["delete-column"],accelerator:window.siyuan.config.keymap.editor.table["delete-column"].custom,click:()=>{kw(t,a,e,n)}}),r.push(...C),{menus:r,removeMenus:C,insertMenus:$,otherMenus:i,other2Menus:M}},an=(t,e,n,a,i=!0)=>{if(e.getAttribute("data-type")==="NodeListItem"&&e.childElementCount<4||e.getAttribute("data-type")==="NodeThematicBreak")return-1;const s=e.getAttribute("fold")==="1";if(s){if(typeof n=="boolean"&&!n)return-1;e.removeAttribute("fold"),e.querySelectorAll(".protyle-linenumber__rows").forEach(l=>{Ol(l.parentElement)})}else{if(typeof n=="boolean"&&n)return-1;if(e.setAttribute("fold","1"),getSelection().rangeCount>0){const l=getSelection().getRangeAt(0),r=P(l.startContainer);r&&r.getBoundingClientRect().width===0&&ae(e,void 0,!1)}e.querySelectorAll(".img--select, .av__cell--select, .av__cell--active, .av__row--select").forEach(l=>{l.classList.contains("av__row--select")?(l.classList.remove("av__row--select"),l.querySelector(".av__firstcol use").setAttribute("xlink:href","#iconUncheck"),as(l)):(l.querySelector(".av__drag-fill")?.remove(),l.classList.remove("img--select","av__cell--select","av__cell--active"))})}const o=e.getAttribute("data-node-id");return e.getAttribute("data-type")==="NodeHeading"?s?(i&&e.insertAdjacentHTML("beforeend",'<div spin="1" style="text-align: center"><img width="24px" height="24px" src="/stage/loading-pure.svg"></div>'),U(t,[{action:"unfoldHeading",id:o,data:a?"remove":void 0}],[{action:"foldHeading",id:o}])):(U(t,[{action:"foldHeading",id:o}],[{action:"unfoldHeading",id:o}]),t_(e)):U(t,[{action:"setAttrs",id:o,data:JSON.stringify({fold:s?"":"1"})}],[{action:"setAttrs",id:o,data:JSON.stringify({fold:s?"1":""})}]),Bn(t),s?0:1},fa=(t,e,n,a)=>{Bn(t);const i=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(i?.length>0){const b=[],y=[];let w,_=!1;a==="Backspace"?(w=i[0].previousElementSibling,w||(_=!0,w=i[i.length-1].nextElementSibling)):(w=i[i.length-1].nextElementSibling,_=!0,w||(_=!1,w=i[0].previousElementSibling));let x,S;Q(["select"],t);let k;if(i.find(A=>{const $=Je(A);S=$.parentElement;const M=$.getAttribute("data-node-id");if(b.push({action:"delete",id:M}),a==="Backspace"?(w=Pe($),w||(_=!0,w=et($))):(w=et($),_=!0,w||(_=!1,w=Pe($))),w||(w=$.parentElement||t.wysiwyg.element.firstElementChild,_=!1),$.getAttribute("data-type")==="NodeHeading"&&$.getAttribute("fold")==="1"){an(t,$,void 0,!0);let C=$.previousElementSibling?$.previousElementSibling.getAttribute("data-node-id"):"";typeof k<"u"&&(C=k),y.push({action:"insert",data:$.outerHTML,id:M,previousID:C,parentID:$.parentElement.getAttribute("data-node-id")||t.block.parentID});let N=Pe($);for(;N&&N.childElementCount===3;)N=Pe(N);N?k=N.getAttribute("data-node-id"):k="",$.firstElementChild.removeAttribute("contenteditable");const O=$.nextElementSibling;if(O){const te=O.getAttribute("data-type");if(te!=="NodeHeading"||te==="NodeHeading"&&O.getAttribute("data-subtype")>$.getAttribute("data-subtype"))return!0}}else{let C=$.outerHTML;($.classList.contains("render-node")||$.querySelector("div.render-node"))&&(C=t.lute.SpinBlockDOM($.outerHTML));let N=$.previousElementSibling?$.previousElementSibling.getAttribute("data-node-id"):"";typeof k<"u"&&(N=k),y.push({action:"insert",data:C,id:M,previousID:N,parentID:$.parentElement.getAttribute("data-node-id")||t.block.parentID}),$.getAttribute("data-subtype")==="o"&&$.classList.contains("li")?x=$.parentElement:x=void 0,$.remove()}}),w)if(t.block.showAll&&w.classList.contains("protyle-wysiwyg")&&t.wysiwyg.element.childElementCount===0)setTimeout(()=>{Vt({protyle:t,id:t.block.parent2ID,focusId:t.block.parent2ID})},u.TIMEOUT_INPUT*2+100);else{if(w.classList.contains("protyle-wysiwyg")&&t.wysiwyg.element.childElementCount===0){const A=Lute.NewNodeID(),$=pa(!1,!0,A);w.insertAdjacentElement("afterbegin",$),b.push({action:"insert",data:$.outerHTML,id:A,parentID:w.getAttribute("data-node-id")||t.block.parentID}),y.push({action:"delete",id:A}),w=void 0,he($,n)}a!=="Backspace"&&_?ae(w):ae(w,void 0,!1),Ne(t,w),x&&(y.push({action:"update",id:x.getAttribute("data-node-id"),data:x.outerHTML}),ot(x,1),b.push({action:"update",id:x.getAttribute("data-node-id"),data:x.outerHTML}))}if(b.length>0)if(S&&S.getAttribute("data-type")==="NodeSuperBlock"&&S.childElementCount===2){const A=ai(t,S);U(t,b.concat(A.doOperations),A.undoOperations.concat(y.reverse()))}else U(t,b,y.reverse());Q(["util"],t);return}const s=e.getAttribute("data-type");if(s==="NodeCodeBlock"&&le(e).textContent.trim()===""){e.classList.add("protyle-wysiwyg--select"),fa(t,e,n,a);return}if(!e.previousElementSibling&&e.parentElement.getAttribute("data-type")==="NodeBlockquote"){n.insertNode(document.createElement("wbr"));const b=e.parentElement;b.insertAdjacentElement("beforebegin",e),b.childElementCount===1?(U(t,[{action:"move",id:e.getAttribute("data-node-id"),previousID:e.previousElementSibling?.getAttribute("data-node-id"),parentID:b.parentElement.getAttribute("data-node-id")||t.block.parentID},{action:"delete",id:b.getAttribute("data-node-id")}],[{action:"insert",id:b.getAttribute("data-node-id"),data:b.outerHTML,previousID:e.previousElementSibling?.getAttribute("data-node-id"),parentID:b.parentElement.getAttribute("data-node-id")||t.block.parentID},{action:"move",id:e.getAttribute("data-node-id"),parentID:b.getAttribute("data-node-id")}]),b.remove()):U(t,[{action:"move",id:e.getAttribute("data-node-id"),previousID:e.previousElementSibling?.getAttribute("data-node-id"),parentID:b.parentElement.getAttribute("data-node-id")||t.block.parentID}],[{action:"move",id:e.getAttribute("data-node-id"),parentID:b.getAttribute("data-node-id")}]),he(e,n);return}if(e.parentElement.classList.contains("li")&&e.getAttribute("data-type")!=="NodeHeading"&&e.previousElementSibling.classList.contains("protyle-action")){ix(t,e,n,a==="Delete");return}const o=Pe(e);if(["NodeCodeBlock","NodeTable","NodeAttributeView"].includes(s)){if(o)if(o.classList.contains("p")&&le(o).textContent===""){const b=Pe(o);U(t,[{action:"delete",id:o.getAttribute("data-node-id")}],[{action:"insert",data:o.outerHTML,id:o.getAttribute("data-node-id"),parentID:o.parentElement.getAttribute("data-node-id")||t.block.parentID,previousID:b&&(!o.previousElementSibling||!o.previousElementSibling.classList.contains("protyle-action"))?b.getAttribute("data-node-id"):void 0}]),o.remove()}else ae(o,void 0,!1);return}if(s==="NodeHeading"){Ba({protyle:t,selectsElement:[e],type:"Blocks2Ps",range:Tl(e,n,a==="Delete")});return}if(e.previousElementSibling&&e.previousElementSibling.classList.contains("protyle-breadcrumb__bar"))return;if(!o){if(t.wysiwyg.element.childElementCount>1&&le(e).textContent===""){ae(t.wysiwyg.element.firstElementChild.nextElementSibling);const b=Je(e);U(t,[{action:"delete",id:b.getAttribute("data-node-id")}],[{action:"insert",data:b.outerHTML,id:b.getAttribute("data-node-id"),parentID:t.block.parentID}]),b.remove()}return}const l=e.parentElement,r=le(e),d=bt(o);if(n.toString()===""&&W()&&d&&d.classList.contains("hr")&&ct(r).start===0){U(t,[{action:"delete",id:d.getAttribute("data-node-id")}],[{action:"insert",data:d.outerHTML,id:d.getAttribute("data-node-id"),previousID:d.previousElementSibling?.getAttribute("data-node-id"),parentID:d.parentElement.getAttribute("data-node-id")}]),d.remove();return}const c=d&&(d.classList.contains("table")||d.classList.contains("render-node")||d.classList.contains("iframe")||d.classList.contains("hr")||d.classList.contains("av")||d.classList.contains("code-block")),f=d.getAttribute("data-node-id");if(c){if(d.classList.contains("code-block")){if(r.textContent.trim()===""){const b=e.getAttribute("data-node-id"),y=[{action:"delete",id:b}],w=[{action:"insert",data:e.outerHTML,id:b,previousID:e.previousElementSibling?.getAttribute("data-node-id"),parentID:e.parentElement.getAttribute("data-node-id")}];if(e.remove(),l.getAttribute("data-type")==="NodeSuperBlock"&&l.childElementCount===2){const _=ai(t,l);U(t,y.concat(_.doOperations),_.undoOperations.concat(w))}else U(t,y,w);ae(t.wysiwyg.element.querySelector(`[data-node-id="${f}"]`),void 0,!1)}else ae(d,void 0,!1);return}if(r.textContent!==""||e.classList.contains("av")){ae(d,void 0,!1);return}}const g=Ki(e),p=g.getAttribute("data-node-id");n.insertNode(document.createElement("wbr"));const h=[{action:"update",data:d.outerHTML,id:f},{action:"insert",data:g.outerHTML,id:p,previousID:e.previousElementSibling?.getAttribute("data-node-id"),parentID:l.getAttribute("data-node-id")}],m=[{action:"delete",id:p}];if(c)g.remove(),ae(d,void 0,!1),h.splice(0,1);else{const b=le(d);if(r&&(r.textContent!==""||r.querySelector(".emoji"))&&(n.setEndAfter(r.lastChild),(b?.lastElementChild?.getAttribute("data-type")||"").indexOf("inline-math")>-1)){const _=Oe(b?.lastElementChild);_&&_.textContent===`
`&&_.remove()}const y=t.contentElement.scrollTop,w=n.extractContents();n.selectNodeContents(b),n.collapse(!1),n.insertNode(w),g.remove(),t.contentElement.scrollTop=y,t.scroll.lastScrollTop=y-1,m.push({action:"update",data:d.outerHTML,id:f})}if(l.getAttribute("data-type")==="NodeSuperBlock"&&l.childElementCount===2){const b=ai(t,l);U(t,m.concat(b.doOperations),b.undoOperations.concat(h))}else U(t,m,h);he(t.wysiwyg.element,n)},Tl=(t,e,n)=>{if(n){const a=Pe(t);if(a){const i=le(bt(a));if(i)return Pt(i,e,!1)}}},mm=(t,e,n,a)=>{const i=e.outerHTML,s=At(t);s&&s.textContent.endsWith(u.ZWSP)&&(s.textContent=s.textContent.substring(0,s.textContent.length-1));const o=Oe(t);o&&o.textContent.startsWith(u.ZWSP)&&(o.textContent=o.textContent.replace(u.ZWSP,"")),t.insertAdjacentHTML("afterend","<wbr>"),t.remove(),J(a,e.getAttribute("data-node-id"),e.outerHTML,i),he(e,n);const l=le(e);l.innerHTML.trim()===""&&(l.innerHTML="")},ix=(t,e,n,a=!1)=>{if(!e.parentElement.previousElementSibling&&e.parentElement.nextElementSibling&&e.parentElement.nextElementSibling.classList.contains("protyle-attr")){yc(t,[e.parentElement],n,a,e);return}if(!e.parentElement.previousElementSibling&&e.parentElement.parentElement.parentElement.classList.contains("list")){n.insertNode(document.createElement("wbr"));const f=e.parentElement.parentElement,g=f.outerHTML,p=e.parentElement.parentElement.previousElementSibling.lastElementChild,h=p.parentElement.outerHTML;e.parentElement.firstElementChild.remove(),e.parentElement.lastElementChild.remove(),p.insertAdjacentHTML("beforebegin",e.parentElement.innerHTML),e.parentElement.remove(),f.getAttribute("data-subtype")==="o"&&ot(f),U(t,[{action:"update",id:f.getAttribute("data-node-id"),data:f.outerHTML},{action:"update",data:p.parentElement.outerHTML,id:p.parentElement.getAttribute("data-node-id")}],[{action:"update",data:h,id:p.parentElement.getAttribute("data-node-id")},{action:"update",data:g,id:f.getAttribute("data-node-id")}]),he(p.parentElement,n);return}if(!e.parentElement.previousElementSibling){if(e.parentElement.parentElement.classList.contains("protyle-wysiwyg"))return;Tl(e,n,a),n.insertNode(document.createElement("wbr"));const f=e.parentElement.parentElement,g=f.outerHTML;e.parentElement.firstElementChild.remove(),e.parentElement.lastElementChild.remove();const p=document.createElement("div");p.innerHTML=e.parentElement.innerHTML;const h=[],m=[];if(Array.from(p.children).forEach((b,y)=>{h.push({action:"insert",id:b.getAttribute("data-node-id"),data:b.outerHTML,previousID:y===0?f.previousElementSibling?.getAttribute("data-node-id"):h[y-1].id,parentID:f.parentElement.getAttribute("data-node-id")||t.block.parentID}),m.push({action:"delete",id:b.getAttribute("data-node-id")})}),f.insertAdjacentHTML("beforebegin",e.parentElement.innerHTML),e.parentElement.remove(),f.getAttribute("data-subtype")==="o"&&ot(f,parseInt(f.firstElementChild.getAttribute("data-marker"))-1),h.splice(0,0,{action:"update",id:f.getAttribute("data-node-id"),data:f.outerHTML}),m.push({action:"update",data:g,id:f.getAttribute("data-node-id")}),U(t,h,m),f.parentElement.classList.contains("sb")&&f.parentElement.getAttribute("data-sb-layout")==="col"){const b=[];let y=f;for(;y&&(b.push(y),m[0].id!==y.getAttribute("data-node-id"));)y=y.previousElementSibling;Dn({protyle:t,selectsElement:b.reverse(),type:"BlocksMergeSuperBlock",level:"row"})}he(t.wysiwyg.element,n);return}const i=e.parentElement;if(i.previousElementSibling&&i.previousElementSibling.classList.contains("protyle-breadcrumb__bar"))return;const s=i.getAttribute("data-node-id"),o=i.parentElement;Tl(e,n,a),n.insertNode(document.createElement("wbr"));const l=o.outerHTML,r=[],d=[{action:"insert",id:s,data:"",previousID:i.previousElementSibling.getAttribute("data-node-id")}],c=i.previousElementSibling.lastElementChild;if(i.previousElementSibling.getAttribute("fold")==="1")if(le(e).textContent.trim()===""&&e.nextElementSibling.classList.contains("protyle-attr"))r.push({action:"delete",id:s}),d[0].data=i.outerHTML,Pt(le(i.previousElementSibling),n),n.collapse(!0),i.remove();else{Pt(le(i.previousElementSibling),n),n.collapse(!0),Z(n),e.querySelector("wbr")?.remove();return}else{let f=c.previousElementSibling.getAttribute("data-node-id");Array.from(e.parentElement.children).forEach((g,p)=>{if(g.classList.contains("protyle-action")||g.classList.contains("protyle-attr"))return;const h=g.getAttribute("data-node-id");r.push({action:"move",id:h,previousID:f}),d.push({action:"move",id:h,previousID:p===1?void 0:f,parentID:s}),f=h,c.before(g)}),r.push({action:"delete",id:s}),d[0].data=i.outerHTML,i.remove()}o.classList.contains("protyle-wysiwyg")?U(t,r,d):(o.getAttribute("data-subtype")==="o"&&ot(o),J(t,o.getAttribute("data-node-id"),o.outerHTML,l)),he(c.parentElement,n)},ot=(t,e)=>{if(t.getAttribute("data-subtype")!=="o")return;let n;Array.from(t.children).forEach((a,i)=>{i===0?e?(n=e,a.setAttribute("data-marker",n+"."),a.querySelector(".protyle-action--order").textContent=n+"."):n=parseInt(a.getAttribute("data-marker")):a.classList.contains("li")&&(n++,a.setAttribute("data-marker",n+"."),a.querySelector(".protyle-action--order").textContent=n+".")})},os=(t,e=0,n=!1)=>{const a=document.createElement("template"),i=t.getAttribute("data-subtype");if(i==="o"){const s=parseInt(t.getAttribute("data-marker"))+e;a.innerHTML=`<div data-marker="${s+1}." data-subtype="${i}" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div contenteditable="false" class="protyle-action protyle-action--order" draggable="true">${s+1}.</div>${Vf(!1,n)}<div class="protyle-attr" contenteditable="false"></div></div>`}else i==="t"?a.innerHTML=`<div data-marker="*" data-subtype="${i}" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#iconUncheck"></use></svg></div>${Vf(!1,n)}<div class="protyle-attr" contenteditable="false"></div></div>`:a.innerHTML=`<div data-marker="*" data-subtype="${i}" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div class="protyle-action" draggable="true"><svg><use xlink:href="#iconDot"></use></svg></div>${Vf(!1,n)}<div class="protyle-attr" contenteditable="false"></div></div>`;return a.content.firstElementChild},sx=(t,e,n)=>{const a=L(e,"li");if(!a)return;const i=a.querySelector(".list")?.lastElementChild.previousElementSibling;if(!i)return;const s=os(i,0,!0),o=s.getAttribute("data-node-id");i.after(s),i.parentElement.getAttribute("fold")==="1"&&an(t,i.parentElement,!0),a.getAttribute("fold")==="1"&&an(t,a,!0),U(t,[{action:"insert",id:o,data:s.outerHTML,previousID:i.getAttribute("data-node-id")}],[{action:"delete",id:o}]),he(s,n)},bm=(t,e,n)=>{if(e.forEach(s=>{s.removeAttribute("select-start"),s.removeAttribute("select-end")}),!e[0].classList.contains("li"))if(e[0].parentElement.childElementCount===e.length+2)e=[e[0].parentElement];else return;const a=e[0].previousElementSibling;if(!a)return;n.collapse(!1),n.insertNode(document.createElement("wbr"));const i=a.parentElement.outerHTML;if(a.lastElementChild.previousElementSibling.getAttribute("data-type")==="NodeList"){const s=a.lastElementChild.previousElementSibling.outerHTML,o=[],l=[],r=a.lastElementChild.previousElementSibling.getAttribute("data-subtype");let d=a.lastElementChild.previousElementSibling.lastElementChild.previousElementSibling.getAttribute("data-node-id");e.forEach((c,f)=>{o.push({action:"move",id:c.getAttribute("data-node-id"),previousID:d}),l.push({action:"move",id:c.getAttribute("data-node-id"),previousID:f===0?a.getAttribute("data-node-id"):d}),d=c.getAttribute("data-node-id"),c.setAttribute("data-subtype",r);const g=c.querySelector(".protyle-action");r==="o"?(g.classList.add("protyle-action--order"),g.classList.remove("protyle-action--task"),a.lastElementChild.previousElementSibling.lastElementChild.before(c)):r==="t"?(c.setAttribute("data-marker","*"),g.innerHTML=`<svg><use xlink:href="#icon${c.classList.contains("protyle-task--done")?"Check":"Uncheck"}"></use></svg>`,g.classList.remove("protyle-action--order"),g.classList.add("protyle-action--task"),a.lastElementChild.previousElementSibling.lastElementChild.before(c)):(c.setAttribute("data-marker","*"),g.innerHTML='<svg><use xlink:href="#iconDot"></use></svg>',g.classList.remove("protyle-action--order","protyle-action--task"),a.lastElementChild.previousElementSibling.lastElementChild.before(c))}),r==="o"?(ot(a.lastElementChild.previousElementSibling),ot(a.parentElement)):a.getAttribute("data-subtype")==="o"&&ot(a.parentElement),a.parentElement.classList.contains("protyle-wysiwyg")&&(o.push({action:"update",data:a.lastElementChild.previousElementSibling.outerHTML,id:a.lastElementChild.previousElementSibling.getAttribute("data-node-id")}),l.push({action:"update",data:s,id:a.lastElementChild.previousElementSibling.getAttribute("data-node-id")}),U(t,o,l))}else{const s=a.outerHTML,o=e[0].getAttribute("data-subtype"),l=document.createElement("div"),r=Lute.NewNodeID();l.setAttribute("data-node-id",r),l.setAttribute("data-type","NodeList"),l.setAttribute("class","list"),l.setAttribute("data-subtype",o),l.innerHTML='<div class="protyle-attr" contenteditable="false"></div>';const d=[{action:"insert",data:l.outerHTML,id:r,previousID:a.lastElementChild.previousElementSibling.getAttribute("data-node-id")}];a.lastElementChild.before(l);const c=[];let f;e.forEach((g,p)=>{d.push({action:"move",id:g.getAttribute("data-node-id"),parentID:r,previousID:f}),c.push({action:"move",id:g.getAttribute("data-node-id"),previousID:p===0?a.getAttribute("data-node-id"):f}),f=g.getAttribute("data-node-id"),l.lastElementChild.before(g)}),c.push({action:"delete",id:r}),o==="o"&&(ot(l,1),ot(a.parentElement)),a.parentElement.classList.contains("protyle-wysiwyg")&&(d.push({action:"update",data:a.outerHTML,id:a.getAttribute("data-node-id")}),c.push({action:"update",data:s,id:a.getAttribute("data-node-id")}),U(t,d,c))}a.parentElement.classList.contains("protyle-wysiwyg")||J(t,a.parentElement.getAttribute("data-node-id"),a.parentElement.outerHTML,i),he(a,n)},ox=(t,e,n)=>{const a=e.parentElement,i=a.getAttribute("data-node-id"),s=[],o=[];n.insertNode(document.createElement("wbr"));const l=Lute.NewNodeID();let r="",d=0;Array.from(a.parentElement.children).forEach(f=>{!d&&f.isSameNode(a)?d=1:d&&!f.classList.contains("protyle-attr")&&(o.push({id:f.getAttribute("data-node-id"),action:"move",previousID:i}),s.push({id:f.getAttribute("data-node-id"),action:"delete"}),f.getAttribute("data-subtype")==="o"&&(o.push({id:f.getAttribute("data-node-id"),action:"update",data:f.outerHTML}),f.setAttribute("data-marker",d+"."),f.firstElementChild.innerHTML=d+"."),r+=f.outerHTML,f.remove(),d++)}),o.reverse(),r=`<div data-subtype="${a.getAttribute("data-subtype")}" data-node-id="${l}" data-type="NodeList" class="list" updated="${Y().format("YYYYMMDDHHmmss")}">${r}<div class="protyle-attr" contenteditable="false">${u.ZWSP}</div></div>`,a.parentElement.insertAdjacentHTML("afterend",r),s.push({id:l,action:"insert",previousID:a.parentElement.getAttribute("data-node-id"),data:r}),o.push({id:l,action:"delete"}),Array.from(a.children).reverse().forEach(f=>{!f.classList.contains("protyle-action")&&!f.classList.contains("protyle-attr")&&(s.push({id:f.getAttribute("data-node-id"),action:"move",previousID:a.parentElement.getAttribute("data-node-id")}),o.push({id:f.getAttribute("data-node-id"),action:"move",parentID:i}),a.parentElement.after(f))});const c=a.parentElement.getAttribute("data-node-id");a.parentElement.childElementCount===2?(o.splice(0,0,{id:c,action:"insert",data:a.parentElement.outerHTML,previousID:a.parentElement.previousElementSibling?.getAttribute("data-node-id"),parentID:a.parentElement.parentElement.getAttribute("data-node-id")||t.block.rootID}),a.parentElement.remove(),s.push({id:c,action:"delete"})):(o.splice(0,0,{id:i,action:"insert",data:a.outerHTML,previousID:a.previousElementSibling?.getAttribute("data-node-id"),parentID:c}),a.remove(),s.push({id:i,action:"delete"})),U(t,s,o),he(t.wysiwyg.element,n)},yc=(t,e,n,a=!1,i)=>{if(e.forEach(b=>{b.removeAttribute("select-start"),b.removeAttribute("select-end")}),!e[0].classList.contains("li"))if(e[0].parentElement.childElementCount===e.length+2)e=[e[0].parentElement];else return;const s=e[0].parentElement,o=s.getAttribute("data-node-id");if(!o)return;const l=s.parentElement,r=l.parentElement;if(s.previousElementSibling?.classList.contains("protyle-action")&&!r.getAttribute("data-node-id"))return;if(l.classList.contains("protyle-wysiwyg")||l.classList.contains("sb")||l.classList.contains("bq")){const b=[],y=[];n.collapse(!1),Tl(i,n,a),n.insertNode(document.createElement("wbr"));let w;!e[0].previousElementSibling&&s.getAttribute("data-subtype")==="o"&&(w=parseInt(e[0].getAttribute("data-marker")));let _=o,x=s,S=e[e.length-1].nextElementSibling,k=e[e.length-1].lastElementChild.previousElementSibling;if(e.forEach($=>{Array.from($.children).forEach((M,C)=>{const N=M.getAttribute("data-node-id");N&&(b.push({action:"move",id:N,previousID:_,parentID:l.getAttribute("data-node-id")||t.block.parentID}),y.push({action:"move",id:N,previousID:C===1?void 0:_,parentID:$.getAttribute("data-node-id"),data:M.contains(n.startContainer)?"focus":""}),_=N,x.after(M),x=M)})}),!window.siyuan.config.editor.listLogicalOutdent&&!S.classList.contains("protyle-attr")){let $;k.getAttribute("data-subtype")!==S.getAttribute("data-subtype")&&($=Lute.NewNodeID(),k=document.createElement("div"),k.classList.add("list"),k.setAttribute("data-subtype",S.getAttribute("data-subtype")),k.setAttribute("data-node-id",$),k.setAttribute("data-type","NodeList"),k.setAttribute("updated",Y().format("YYYYMMDDHHmmss")),k.innerHTML=`<div class="protyle-attr" contenteditable="false">${u.ZWSP}</div>`,x.after(k),b.push({action:"insert",id:$,data:k.outerHTML,previousID:x.getAttribute("data-node-id")}));let M;for(;S&&!S.classList.contains("protyle-attr");){b.push({action:"move",id:S.getAttribute("data-node-id"),previousID:M||k.lastElementChild.previousElementSibling?.getAttribute("data-node-id"),parentID:k.getAttribute("data-node-id")}),y.push({action:"move",id:S.getAttribute("data-node-id"),parentID:k.getAttribute("data-node-id"),previousID:M||S.previousElementSibling?.getAttribute("data-node-id")}),M=S.getAttribute("data-node-id");const C=S;S=S.nextElementSibling,k.lastElementChild.before(C)}k.getAttribute("data-subtype")==="o"&&(Array.from(k.children).forEach(C=>{const N=C.getAttribute("data-node-id");N&&y.push({action:"update",id:N,data:C.outerHTML})}),ot(k,1),Array.from(k.children).forEach(C=>{const N=C.getAttribute("data-node-id");N&&b.push({action:"update",id:N,data:C.outerHTML})})),$&&y.push({action:"delete",id:$})}const A=s.outerHTML;e.forEach($=>{$.remove()}),s.childElementCount===1?(b.push({action:"delete",id:o}),o===t.block.id&&(t.block.id=t.block.parentID),y.splice(0,0,{action:"insert",data:A,id:o,previousID:s.previousElementSibling?.getAttribute("data-node-id"),parentID:l.getAttribute("data-node-id")||t.block.parentID}),s.remove()):(s.getAttribute("data-subtype")==="o"&&ot(s,w),b.push({action:"update",id:o,data:s.outerHTML}),y.splice(0,0,{action:"update",id:o,data:A})),U(t,b,y),s.childElementCount!==1&&l.classList.contains("sb")&&l.getAttribute("data-sb-layout")==="col"&&Dn({protyle:t,selectsElement:[s,s.nextElementSibling],type:"BlocksMergeSuperBlock",level:"row"}),he(l,n);return}if(s.childElementCount===2&&l.childElementCount===3){n.collapse(!1),Tl(i,n,a),n.insertNode(document.createElement("wbr"));const b=l.outerHTML;e[0].firstElementChild.remove(),e[0].lastElementChild.remove(),s.outerHTML=e[0].innerHTML,J(t,l.getAttribute("data-node-id"),l.outerHTML,b),he(l,n);return}n.collapse(!1),Tl(i,n,a),n.insertNode(document.createElement("wbr"));const d=[],c=[],f=e[0].previousElementSibling?.getAttribute("data-node-id");let g;!e[0].previousElementSibling&&s.getAttribute("data-subtype")==="o"&&(g=parseInt(e[0].getAttribute("data-marker")));const p=l.parentElement.outerHTML;let h=e[e.length-1].nextElementSibling,m=e[e.length-1].lastElementChild.previousElementSibling;if(e.reverse().forEach(b=>{const y=b.getAttribute("data-node-id");d.push({action:"move",id:y,previousID:l.getAttribute("data-node-id")}),c.push({action:"move",id:y,previousID:f,parentID:s.getAttribute("data-node-id")}),l.after(b),(b.getAttribute("data-subtype")==="o"||b.getAttribute("data-subtype")==="t")&&l.getAttribute("data-subtype")==="u"?(c.push({action:"update",id:y,data:b.outerHTML}),b.querySelector(".protyle-action").outerHTML='<div class="protyle-action" draggable="true"><svg><use xlink:href="#iconDot"></use></svg></div>',b.setAttribute("data-subtype","u"),b.setAttribute("data-marker","*"),b.classList.remove("protyle-task--done"),d.push({action:"update",id:y,data:b.outerHTML})):(b.getAttribute("data-subtype")==="u"||b.getAttribute("data-subtype")==="t")&&l.getAttribute("data-subtype")==="o"?(c.push({action:"update",id:y,data:b.outerHTML}),b.querySelector(".protyle-action").outerHTML='<div contenteditable="false" draggable="true" class="protyle-action protyle-action--order">1.</div>',b.setAttribute("data-subtype","o"),b.setAttribute("data-marker","1."),d.push({action:"update",id:y,data:b.outerHTML})):(b.getAttribute("data-subtype")==="u"||b.getAttribute("data-subtype")==="o")&&l.getAttribute("data-subtype")==="t"&&(c.push({action:"update",id:y,data:b.outerHTML}),b.querySelector(".protyle-action").outerHTML='<div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#iconUncheck"></use></svg></div>',b.setAttribute("data-subtype","t"),b.setAttribute("data-marker","*"),d.push({action:"update",id:y,data:b.outerHTML}))}),!window.siyuan.config.editor.listLogicalOutdent&&!h.classList.contains("protyle-attr")){let b;m.classList.contains("list")||(b=Lute.NewNodeID(),m=document.createElement("div"),m.classList.add("list"),m.setAttribute("data-subtype",h.getAttribute("data-subtype")),m.setAttribute("data-node-id",b),m.setAttribute("data-type","NodeList"),m.setAttribute("updated",Y().format("YYYYMMDDHHmmss")),m.innerHTML=`<div class="protyle-attr" contenteditable="false">${u.ZWSP}</div>`,d.push({action:"insert",id:b,data:m.outerHTML,previousID:e[0].lastElementChild.previousElementSibling.getAttribute("data-node-id")}),e[0].lastElementChild.before(m));let y;for(;h&&!h.classList.contains("protyle-attr");){const w=h.getAttribute("data-node-id");h.getAttribute("data-subtype")!==m.getAttribute("data-subtype")&&(c.push({action:"update",id:w,data:h.outerHTML}),h.querySelector(".protyle-action").outerHTML=m.querySelector(".protyle-action").outerHTML,h.setAttribute("data-subtype",m.getAttribute("data-subtype")),h.setAttribute("data-marker",m.getAttribute("data-marker")),d.push({action:"update",id:w,data:h.outerHTML})),d.push({action:"move",id:w,previousID:y||m.lastElementChild.previousElementSibling?.getAttribute("data-node-id"),parentID:m.getAttribute("data-node-id")}),c.push({action:"move",id:w,previousID:y||m.parentElement?.getAttribute("data-node-id")}),y=w;const _=h;h=h.nextElementSibling,m.lastElementChild.before(_)}m.getAttribute("data-subtype")==="o"&&(Array.from(m.children).forEach(w=>{const _=w.getAttribute("data-node-id");_&&c.push({action:"update",id:_,data:w.outerHTML})}),ot(m,1),Array.from(m.children).forEach(w=>{const _=w.getAttribute("data-node-id");_&&d.push({action:"update",id:_,data:w.outerHTML})})),b&&c.push({action:"delete",id:b})}if(!window.siyuan.config.editor.listLogicalOutdent&&s.nextElementSibling){h=s.nextElementSibling;let b;for(;h&&!h.classList.contains("protyle-attr");){const y=h.getAttribute("data-node-id");d.push({action:"move",id:y,previousID:b||m.getAttribute("data-node-id")}),c.push({action:"move",id:y,previousID:b||s.getAttribute("data-node-id")}),b=y;const w=h;h=h.nextElementSibling,m.after(w),m=w}}s.childElementCount===1&&l.childElementCount===3?(d.push({action:"delete",id:l.getAttribute("data-node-id")}),c.splice(0,0,{action:"insert",id:l.getAttribute("data-node-id"),data:l.outerHTML,previousID:l.previousElementSibling?.getAttribute("data-node-id"),parentID:l.parentElement.getAttribute("data-node-id")}),l.remove()):s.childElementCount===1?(d.push({action:"delete",id:s.getAttribute("data-node-id")}),c.splice(0,0,{action:"insert",id:s.getAttribute("data-node-id"),data:s.outerHTML,previousID:s.previousElementSibling.getAttribute("data-node-id")}),s.remove()):s.getAttribute("data-subtype")==="o"&&(c.splice(0,0,{action:"update",data:s.outerHTML,id:s.getAttribute("data-node-id")}),ot(s,g),d.push({action:"update",data:s.outerHTML,id:s.getAttribute("data-node-id")})),r.classList.contains("protyle-wysiwyg")?U(t,d,c):(l&&l.getAttribute("data-subtype")==="o"&&ot(r),J(t,r.getAttribute("data-node-id"),r.outerHTML,p)),he(r,n)},ai=(t,e)=>{const n=[],a=[];let i=e.previousElementSibling?e.previousElementSibling.getAttribute("data-node-id"):void 0;e.classList.remove("protyle-wysiwyg--select"),e.removeAttribute("select-start"),e.removeAttribute("select-end");const s=e.getAttribute("data-node-id"),o=e.cloneNode();return o.innerHTML=e.lastElementChild.outerHTML,a.push({action:"insert",id:s,data:o.outerHTML,previousID:e.previousElementSibling?e.previousElementSibling.getAttribute("data-node-id"):void 0,parentID:e.parentElement.getAttribute("data-node-id")||t.block.parentID}),Array.from(e.children).forEach((l,r)=>{if(r===e.childElementCount-1){n.push({action:"delete",id:s}),e.lastElementChild.remove(),e.querySelectorAll("protyle-html").forEach(d=>{d.setAttribute("data-content",d.getAttribute("data-content").replace(/&lt;/g,"<").replace(/&gt;/g,">"))}),e.outerHTML=e.innerHTML;return}n.push({action:"move",id:l.getAttribute("data-node-id"),previousID:i,parentID:e.parentElement.getAttribute("data-node-id")||t.block.parentID}),a.push({action:"move",id:l.getAttribute("data-node-id"),previousID:l.previousElementSibling?l.previousElementSibling.getAttribute("data-node-id"):void 0,parentID:s}),i=l.getAttribute("data-node-id")}),n.forEach(l=>{const r=t.wysiwyg.element.querySelector(`[data-node-id="${l.id}"]`);r&&r.getAttribute("data-type")==="NodeBlockQueryEmbed"&&(r.removeAttribute("data-render"),Be(t,r))}),{doOperations:n,undoOperations:a,previousId:i}},T_=(t,e,n)=>{const a=document.createElement("div");return a.setAttribute("data-node-id",e||Lute.NewNodeID()),a.setAttribute("data-type","NodeSuperBlock"),a.setAttribute("class","sb"),a.setAttribute("data-sb-layout",t),a.innerHTML=n||`<div class="protyle-attr" contenteditable="false">${u.ZWSP}</div>`,a},Il=(t,e,n)=>{E("/api/block/getBlockSiblingID",{id:e.getAttribute("data-node-id")},a=>{const i=a.data[n];i&&de({app:t.app,id:i,action:i!==t.block.rootID&&t.block.showAll?[u.CB_GET_ALL,u.CB_GET_FOCUS]:[u.CB_GET_FOCUS]})})},_n=(t,e,n)=>{const a=me(t.wysiwyg.element);let i;if(n)i=t.wysiwyg.element.querySelector(`[data-node-id="${n}"]`);else{const d=t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");d.length>0?(e==="beforebegin"?i=d[0]:i=d[d.length-1],Q(["select"],t)):(i=P(a.startContainer),i=Je(i))}if(!i)return;let s=pa(!1,!0),o=1;i.getAttribute("data-type")==="NodeListItem"&&(s=os(i,0,!0),o=parseInt(i.parentElement.firstElementChild.getAttribute("data-marker")));const l=i.parentElement.outerHTML,r=s.getAttribute("data-node-id");if(i.insertAdjacentElement(e,s),i.getAttribute("data-type")==="NodeListItem"&&i.getAttribute("data-subtype")==="o"&&!s.parentElement.classList.contains("protyle-wysiwyg"))ot(s.parentElement,o),J(t,s.parentElement.getAttribute("data-node-id"),s.parentElement.outerHTML,l);else{let d;e==="beforebegin"?d=[{action:"insert",data:s.outerHTML,id:r,nextID:i.getAttribute("data-node-id")}]:d=[{action:"insert",data:s.outerHTML,id:r,previousID:i.getAttribute("data-node-id")}],U(t,d,[{action:"delete",id:r}])}i.parentElement.classList.contains("sb")&&i.parentElement.getAttribute("data-sb-layout")==="col"&&Dn({protyle:t,selectsElement:e==="afterend"?[i,i.nextElementSibling]:[i.previousElementSibling,i],type:"BlocksMergeSuperBlock",level:"row"}),he(t.wysiwyg.element,a),Ne(t)},Vf=(t=!0,e=!0,n)=>{let a="";return t&&(a=u.ZWSP),e&&(a+="<wbr>"),n&&(a+=n),`<div data-node-id="${Lute.NewNodeID()}" data-type="NodeParagraph" class="p"><div contenteditable="true" spellcheck="${window.siyuan.config.editor.spellcheck}">${a}</div><div contenteditable="false" class="protyle-attr">${u.ZWSP}</div></div>`},pa=(t=!0,e=!0,n)=>{const a=document.createElement("div");return a.setAttribute("data-node-id",n||Lute.NewNodeID()),a.setAttribute("data-type","NodeParagraph"),a.classList.add("p"),a.innerHTML=`<div contenteditable="true" spellcheck="${window.siyuan.config.editor.spellcheck}">${t?u.ZWSP:""}${e?"<wbr>":""}</div><div class="protyle-attr" contenteditable="false">${u.ZWSP}</div>`,a},lx=t=>{let e=t;switch(t){case"NodeIFrame":e="IFrame";break;case"NodeAttributeView":e=window.siyuan.languages.database;break;case"NodeThematicBreak":e=window.siyuan.languages.line;break;case"NodeWidget":e=window.siyuan.languages.widget;break;case"NodeVideo":e=window.siyuan.languages.video;break;case"NodeAudio":e=window.siyuan.languages.audio;break;case"NodeBlockQueryEmbed":e=window.siyuan.languages.blockEmbed;break}return e},rx=(t,e,n,a,i)=>{if(e!=="NodeCodeBlock"&&!n.previousElementSibling?.classList.contains("protyle-action--task")&&(["[ ]","[x]","[X]","\u3010 \u3011","\u3010x\u3011","\u3010X\u3011"].includes(a.innerHTML.substring(0,3))||["[]","\u3010\u3011"].includes(a.innerHTML.substring(0,2)))){const s=a.innerHTML.indexOf("]")+1||a.innerHTML.indexOf("\u3011")+1,o=a.innerHTML.substring(1,2).toLowerCase()==="x";if(n.parentElement.classList.contains("li")&&n.parentElement.childElementCount===3){if(!n.parentElement.parentElement.classList.contains("protyle-wysiwyg")&&n.parentElement.parentElement.childElementCount===2){const l=n.parentElement.parentElement,r=l.outerHTML;return l.setAttribute("data-subtype","t"),l.setAttribute("updated",Y().format("YYYYMMDDHHmmss")),n.parentElement.setAttribute("data-subtype","t"),o&&n.parentElement.classList.add("protyle-task--done"),n.previousElementSibling.outerHTML=`<div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#icon${o?"C":"Unc"}heck"></use></svg></div>`,a.innerHTML=a.innerHTML.substring(s),J(t,l.getAttribute("data-node-id"),l.outerHTML,r),he(t.wysiwyg.element,i),!0}return!1}else{const l=n.getAttribute("data-node-id"),r=Lute.NewNodeID(),d=Lute.NewNodeID(),c=Lute.NewNodeID(),f=n.outerHTML;return a.innerHTML=a.innerHTML.substring(s),U(t,[{action:"update",id:l,data:n.outerHTML},{action:"insert",id:r,data:`<div data-subtype="t" data-node-id="${r}" updated="${r.split("-")[0]}" data-type="NodeList" class="list"><div data-marker="*" data-subtype="t" data-node-id="${c}" data-type="NodeListItem" class="li${o?" protyle-task--done":""}" updated="${c.split("-")[0]}"><div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#icon${o?"C":"Unc"}heck"></use></svg></div><div data-node-id="${d}" data-type="NodeParagraph" class="p"><div contenteditable="true" spellcheck="${window.siyuan.config.editor.spellcheck}"></div><div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div>`,previousID:l},{action:"move",id:l,previousID:d},{action:"delete",id:d}],[{action:"move",id:l,previousID:r},{action:"delete",id:r},{action:"update",id:l,data:f}]),n.outerHTML=`<div data-subtype="t" data-node-id="${r}" data-type="NodeList" class="list" updated="${r.split("-")[0]}"><div data-marker="*" data-subtype="t" data-node-id="${c}" data-type="NodeListItem" class="li${o?" protyle-task--done":""}" updated="${c.split("-")[0]}"><div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#icon${o?"C":"Unc"}heck"></use></svg></div>${n.outerHTML}<div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div>`,he(t.wysiwyg.element,i),!0}}return!1},cx=(t,e,n,a,i)=>{if(e==="NodeHeading"&&["* ","- "].includes(a.innerHTML.substring(0,2))&&n.parentElement.getAttribute("data-type")!=="NodeListItem"){const s=n.getAttribute("data-node-id"),o=Lute.NewNodeID(),l=Lute.NewNodeID(),r=Lute.NewNodeID(),d=n.outerHTML,c=a.innerHTML.substring(0,1);return a.innerHTML=a.innerHTML.substring(2),U(t,[{action:"update",id:s,data:n.outerHTML},{action:"insert",id:o,data:`<div data-subtype="u" data-node-id="${o}" data-type="NodeList" class="list" updated="${o.split("-")[0]}"><div data-marker="${c}" data-subtype="u" data-node-id="${r}" data-type="NodeListItem" class="li" updated="${r.split("-")[0]}"><div class="protyle-action" draggable="true"><svg><use xlink:href="#iconDot"></use></svg></div><div data-node-id="${l}" data-type="NodeParagraph" class="p"><div contenteditable="true" spellcheck="${window.siyuan.config.editor.spellcheck}"></div><div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div>`,previousID:s},{action:"move",id:s,previousID:l},{action:"delete",id:l}],[{action:"update",id:s,data:d},{action:"move",id:s,previousID:o},{action:"delete",id:o}]),n.outerHTML=`<div data-subtype="u" data-node-id="${o}" data-type="NodeList" class="list" updated="${o.split("-")[0]}"><div data-marker="${c}" data-subtype="u" data-node-id="${r}" data-type="NodeListItem" class="li" updated="${r.split("-")[0]}"><div class="protyle-action" draggable="true"><svg><use xlink:href="#iconDot"></use></svg></div>${n.outerHTML}<div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div>`,he(t.wysiwyg.element,i),!0}return!1},Gf=async(t,e,n,a=!0,i)=>{if(!e.parentElement)return;if(e.classList.contains("av")){L(n.startContainer,"av__cursor")?n.startContainer.textContent=u.ZWSP:vm(t,e);return}const s=le(e),o=e.getAttribute("data-type");if(!s){o==="NodeThematicBreak"?e.innerHTML="<div><wbr></div>":o==="NodeBlockQueryEmbed"?e.lastElementChild.previousElementSibling.innerHTML="<wbr>"+u.ZWSP:o==="NodeMathBlock"||o==="NodeHTMLBlock"?e.lastElementChild.previousElementSibling.lastElementChild.innerHTML="<wbr>"+u.ZWSP:o==="NodeIFrame"||o==="NodeWidget"?e.innerHTML="<wbr>"+e.firstElementChild.outerHTML+e.lastElementChild.outerHTML:o==="NodeVideo"?e.firstElementChild.innerHTML="<wbr>"+u.ZWSP+e.firstElementChild.firstElementChild.outerHTML+e.firstElementChild.lastElementChild.outerHTML:o==="NodeAudio"?e.firstElementChild.innerHTML=e.firstElementChild.firstElementChild.outerHTML+"<wbr>"+u.ZWSP:o==="NodeCodeBlock"&&(n.startContainer.textContent=u.ZWSP),he(e,n);return}e.setAttribute("updated",Y().format("YYYYMMDDHHmmss"));const l=document.createElement("wbr");if(n.insertNode(l),i){const m=Oe(l);if(i.inputType==="deleteContentForward"&&m&&m.nodeType===1&&!m.textContent.startsWith(u.ZWSP)){const b=(m.getAttribute("data-type")||"").split(" ");(b.includes("code")||b.includes("kbd")||b.includes("tag"))&&m.insertAdjacentElement("afterbegin",l)}if((i.inputType==="deleteContentBackward"||i.inputType==="deleteContentForward")&&m&&m.nodeType===1&&m.tagName==="BR"){const b=Oe(m);b&&b.nodeType===1&&b.getAttribute("data-type")?.indexOf("inline-math")>-1&&m.remove()}}const r=e.getAttribute("data-node-id");if(o!=="NodeCodeBlock"&&o!=="NodeHeading"&&(s.innerHTML.endsWith(`
<wbr>`)||s.innerHTML.endsWith(`
<wbr>
`))){J(t,r,e.outerHTML,t.wysiwyg.lastHTMLs[r]||e.outerHTML.replace(`
<wbr>`,"<wbr>")),l.remove();return}if(rx(t,o,e,s,n)||cx(t,o,e,s,n))return;const d=e.querySelector("br");d&&d.parentElement.tagName!=="TD"&&d.parentElement.tagName!=="TH"&&(d.parentElement.textContent.trim()===""||d.previousSibling?.previousSibling?.textContent===`
`)&&d.remove(),o!=="NodeHeading"&&(s.innerHTML.startsWith("\u300B<wbr>")||s.innerHTML.indexOf(`
\u300B<wbr>`)>-1)&&(s.innerHTML=s.innerHTML.replace("\u300B<wbr>","><wbr>"));const c=s.innerHTML.trimStart();if(!((c.startsWith("````")||c.startsWith("\xB7\xB7\xB7\xB7")||c.startsWith("~~~~"))&&c.indexOf(`
`)===-1)){if((c.startsWith("```")||c.startsWith("\xB7\xB7\xB7")||c.startsWith("~~~"))&&c.indexOf(`
`)===-1&&c.replace(/·|~/g,"`").replace(/^`{3,}/g,"").indexOf("`")===-1){J(t,r,e.outerHTML,t.wysiwyg.lastHTMLs[r]),l.remove();return}}o==="NodeParagraph"&&(s.innerHTML.startsWith("\xA5\xA5<wbr>")||s.innerHTML.startsWith("\uFFE5\uFFE5<wbr>")||c.indexOf(`
\xA5\xA5<wbr>`)>-1||c.indexOf(`
\uFFE5\uFFE5<wbr>`)>-1)&&(s.innerHTML=s.innerHTML.replace("\xA5\xA5<wbr>","$$$$<wbr>").replace("\uFFE5\uFFE5<wbr>","$$$$<wbr>"));const f=B(n.startContainer,"data-type","block-ref");f&&f.getAttribute("data-subtype")==="d"&&(await Re("/api/block/getRefText",{id:f.getAttribute("data-id")})).data!==f.innerHTML.replace("<wbr>","")&&f.setAttribute("data-subtype","s");let g=e.outerHTML,p=!1;if(["---","___","***"].includes(s.textContent)&&o!=="NodeCodeBlock"){g=`<div data-node-id="${r}" data-type="NodeThematicBreak" class="hr"><div></div></div>`;const m=e.nextElementSibling;m&&m.getAttribute("data-node-id")?Ln(m)?p=!0:ae(m):g+=Vf(!1,!0)}else{if(o!=="NodeCodeBlock"&&(c.startsWith("```")||c.startsWith("~~~")||c.startsWith("\xB7\xB7\xB7")||c.indexOf("\n```")>-1||c.indexOf(`
~~~`)>-1||c.indexOf(`
\xB7\xB7\xB7`)>-1)&&!(c.indexOf(`
`)===-1&&c.replace(/·|~/g,"`").replace(/^`{3,}/g,"").indexOf("`")>-1)){let m=s.innerHTML.trim().replace(/^(~|·|`){3,}/g,"```").replace(/\n(~|·|`){3,}/g,"\n```").trim();m.endsWith("\n```")||(m=m.replace("<wbr>","")+"<wbr>\n```"),s.innerHTML=m,g=e.outerHTML}g=t.lute.SpinBlockDOM(g)}Q(["util"],t,!0),o==="NodeTable"&&e.querySelector(".table__select").removeAttribute("style");const h=document.createElement("template");if(h.innerHTML=g,a&&(le(h.content.firstElementChild)?.innerHTML!==le(e).innerHTML||h.content.childElementCount===1&&le(h.content.firstElementChild)?.innerHTML==="<wbr>")&&!(h.content.childElementCount===1&&h.content.firstElementChild.classList.contains("code-block")&&o==="NodeCodeBlock")){e.getAttribute("data-type")==="NodeHeading"&&e.getAttribute("fold")==="1"&&h.content.firstElementChild.getAttribute("data-subtype")!==e.dataset.subtype&&(an(t,e,void 0,void 0,!1),g=g.replace(' fold="1"',""),t.wysiwyg.lastHTMLs[r]=e.outerHTML);let m;e.classList.contains("table")&&(m=e.firstElementChild.scrollLeft),/<span data-type="backslash">.+<\/span><wbr>/.test(g)?e.outerHTML=g:e.outerHTML=g.replace("</span><wbr>","</span>"+u.ZWSP+"<wbr>"),t.wysiwyg.element.querySelectorAll(`[data-node-id="${r}"]`).forEach(b=>{F(b)||(e=b)}),g.split('<span data-type="inline-math" data-subtype="math"').length>1&&Array.from(e.querySelectorAll('[data-type="inline-math"]')).find(b=>{if(b.dataset.content.indexOf("<wbr>")>-1)return b.setAttribute("data-content",b.dataset.content.replace("<wbr>","")),t.toolbar.showRender(t,b),!0}),Array.from(h.content.children).forEach((b,y)=>{const w=b.getAttribute("data-node-id");let _;w===r?_=e:_=t.wysiwyg.element.querySelector(`[data-node-id="${w}"]`);const x=_.getAttribute("data-type");if(x==="NodeCodeBlock"){const S=_.querySelector(".protyle-action__language");S?(window.siyuan.storage[u.LOCAL_CODELANG]&&S.textContent===""&&(S.textContent=window.siyuan.storage[u.LOCAL_CODELANG]),ze(_)):h.content.childElementCount===1&&t.toolbar.showRender(t,_)}else if(["NodeMathBlock","NodeHTMLBlock"].includes(x))x==="NodeMathBlock"&&Ma(_),t.toolbar.showRender(t,_);else if(x==="NodeBlockQueryEmbed")Be(t,_),t.toolbar.showRender(t,_),Q(["hint"],t);else if(x==="NodeThematicBreak"&&p)ae(e);else if(_.querySelectorAll('[data-type="block-ref"][data-subtype="d"]').forEach(S=>{S.textContent===""&&E("/api/block/getRefText",{id:S.getAttribute("data-id")},k=>{S.innerHTML=k.data})}),Ma(_),y===h.content.childElementCount-1){const S=e.querySelector("wbr");if(S&&S.parentElement.tagName==="SPAN"&&S.parentElement.innerHTML==="<wbr>"){const k=S.parentElement.getAttribute("data-type")||"";(k.includes("sup")||k.includes("u")||k.includes("sub"))&&S.insertAdjacentText("beforebegin",u.ZWSP)}he(t.wysiwyg.element,n),t.hint.render(t),m>0&&(e.firstElementChild.scrollLeft=m)}})}else e.getAttribute("data-type")==="NodeCodeBlock"?(s.parentElement.removeAttribute("data-render"),ze(e)):(he(t.wysiwyg.element,n),t.hint.render(t));Q(["gutter"],t),dx(g,t,r)},dx=(t,e,n)=>{const a=document.createElement("template");a.innerHTML=t;const i=[],s=[];Array.from(a.content.children).forEach((o,l)=>{o.getAttribute("spellcheck")==="false"&&o.getAttribute("contenteditable")==="false"&&o.setAttribute("contenteditable","true");const r=o.getAttribute("data-node-id");if(r===n)i.push({id:n,data:o.outerHTML,action:"update"}),s.push({id:n,data:e.wysiwyg.lastHTMLs[n],action:"update"}),e.wysiwyg.lastHTMLs[n]=o.outerHTML;else{let d;l===0&&(d=e.wysiwyg.element.querySelector(`[data-node-id="${r}"]`)),i.push({action:"insert",data:o.outerHTML,id:r,previousID:l===0?d?.previousElementSibling?.getAttribute("data-node-id"):o.previousElementSibling.getAttribute("data-node-id"),parentID:d?.parentElement.getAttribute("data-node-id")||e.block.parentID}),s.push({id:r,action:"delete"})}}),U(e,i,s)},ux=(t,e,n,a)=>{const i=document.createElement("template");i.innerHTML=e;let s=[];if(e.endsWith("]")&&e.startsWith("["))try{s=JSON.parse(e)}catch{console.warn("insert cell: JSON.parse error")}else i.content.querySelector("table")&&i.content.querySelectorAll("tr").forEach(l=>{s.push([]),Array.from(l.children).forEach(r=>{s[s.length-1].push({text:{content:r.textContent},type:"text"})})});const o=a.dataset.avId;E("/api/av/getAttributeViewKeysByAvID",{avID:o},l=>{const r=l.data;if(s&&Array.isArray(s)&&s.length>0){const h=Array.from(a.querySelectorAll(".av__cell--active, .av__cell--select"))||[];h.length===0&&a.querySelectorAll(".av__row--select:not(.av__row--header)").forEach(S=>{S.querySelectorAll(".av__cell").forEach(k=>{h.push(k)})}),h.length===0&&h.push(a.querySelector(".av__row:not(.av__row--header) .av__cell"));const m=[],b=[],y=a.dataset.avId,w=a.dataset.nodeId;let _;const x=h[0].getAttribute("data-col-id");s.find(S=>{if(_?_=_.nextElementSibling:_=h[0].parentElement,!_.classList.contains("av__row"))return!0;let k;S.find(A=>{if(k?k=k.nextElementSibling:k=_.querySelector(`.av__cell[data-col-id="${x}"]`),!k.classList.contains("av__cell"))return!0;const $=vn(k)||k.dataset.type;if(["created","updated","template","rollup"].includes($)||$==="block"&&!k.dataset.detached)return;const M=_.getAttribute("data-id"),C=k.getAttribute("data-id"),N=k.getAttribute("data-col-id"),O=ga($,k);if(A.type!==$&&!(["select","mSelect"].includes($)&&["select","mSelect"].includes(A.type))){if($==="date"||!A[A.type]?.content)return;A=si($,A[A.type].content.toString())}if(A.type==="block")A.isDetached=!0,delete A.block.id;else if($==="select"||$==="mSelect"){$==="select"&&A.type==="mSelect"&&A.mSelect.length>0&&A.mSelect.splice(1,A.mSelect.length-1);const te=j_(r.find(ne=>ne.id===k.dataset.colId),A,y);m.push(...te.doOperations),b.push(...te.undoOperations)}A.id=C,!(A.type==="date"&&typeof A.date=="string"||A.type==="relation"&&typeof A.relation=="string")&&(tn(A,O)||(m.push({action:"updateAttrViewCell",id:C,avID:y,keyID:N,rowID:M,data:A}),b.push({action:"updateAttrViewCell",id:C,avID:y,keyID:N,rowID:M,data:O}),gn(k,A)))})}),m.length>0&&(m.push({action:"doUpdateUpdated",id:w,data:Y().format("YYYYMMDDHHmmss")}),b.push({action:"doUpdateUpdated",id:w,data:a.getAttribute("updated")}),U(n,m,b));return}const d=le(i.content.firstElementChild);if(d&&d.childNodes.length===1&&d.firstElementChild?.getAttribute("data-type")==="block-ref"){const h=a.querySelector(".av__cell--select");if(h){const m=d.firstElementChild.getAttribute("data-id"),b=h.dataset.blockId;U(n,[{action:"replaceAttrViewBlock",avID:o,previousID:b,nextID:m,isDetached:!1}],[{action:"replaceAttrViewBlock",avID:o,previousID:m,nextID:b,isDetached:h.dataset.detached==="true"}]),gn(h,{type:"block",isDetached:!1,block:{content:d.firstElementChild.textContent,id:m}});return}}const c=n.lute.BlockDOM2Content(e),f=Array.from(a.querySelectorAll(".av__cell--active, .av__cell--select")),g=a.querySelectorAll(".av__row--select"),p=[];if(c.split(`
`).forEach(h=>{p.push(h.split("	"))}),g.length>0&&p.length===1&&p[0].length===1){Tn(n,a,c,void 0,r,e);return}if(g.length>0&&g.forEach(h=>{h.querySelectorAll(".av__cell").forEach(m=>{f.push(m)})}),f.length>0){if(p.length===1&&p[0].length===1)Tn(n,a,c,f,r,e);else{let h;const m=f[0].getAttribute("data-col-id");p.forEach(b=>{if(h?h=h.nextElementSibling:h=f[0].parentElement,!h.classList.contains("av__row"))return!0;let y;b.forEach(w=>{if(y?y=y.nextElementSibling:y=h.querySelector(`.av__cell[data-col-id="${m}"]`),!y.classList.contains("av__cell"))return!0;Tn(n,a,w,[y],r,e)})})}document.querySelector(".av__panel")?.remove()}else if(L(t.startContainer,"av__title")){const h=document.createTextNode(c);t.insertNode(h),t.setEnd(h,c.length),t.collapse(!1),Z(t),vm(n,a)}})},fx=(t,e,n,a)=>{const i=document.createElement("template");i.innerHTML=e;const s=i.content.querySelectorAll("th, td");if(s.length===0)return!1;const o=a.firstElementChild.scrollLeft,l=a.querySelector(".table__select");let r=0;const d=[];a.querySelectorAll("th, td").forEach(f=>{!f.classList.contains("fn__none")&&f.offsetLeft+6>l.offsetLeft+o&&f.offsetLeft+f.clientWidth-6<l.offsetLeft+o+l.clientWidth&&f.offsetTop+6>l.offsetTop&&f.offsetTop+f.clientHeight-6<l.offsetTop+l.clientHeight&&s.length>r&&(d.push(f),r++)}),l.removeAttribute("style");const c=a.outerHTML;return a.setAttribute("updated",Y().format("YYYYMMDDHHmmss")),d.forEach((f,g)=>{f.innerHTML=s[g].innerHTML,g===d.length-1&&Pt(f,t,!1)}),t.collapse(!1),J(n,a.getAttribute("data-node-id"),a.outerHTML,c),!0},wt=(t,e,n=!1,a=!1,i=!1)=>{if(t==="")return;const s=a?e.toolbar.range:me(e.wysiwyg.element);bb(s);let o;B(s.startContainer,"data-type","NodeTable")&&!n&&(q(s.startContainer,"TABLE")?o=e.lute.BlockDOM2InlineBlockDOM(t):n=!0);let l=P(s.startContainer);if(l||(e.toolbar.range?l=P(e.toolbar.range.startContainer):l=e.wysiwyg.element.firstElementChild),!l)return;if(l.classList.contains("av")){s.deleteContents(),ux(s,t,e,l);return}if(l.classList.contains("table")&&l.querySelector(".table__select").clientWidth>0&&fx(s,t,e,l))return;let r=l.getAttribute("data-node-id");s.insertNode(document.createElement("wbr"));let d=l.outerHTML;const c=l.getAttribute("data-type")==="NodeCodeBlock",f=le(l);if(!n&&(c||e.toolbar.getCurrentType(s).includes("code"))){s.deleteContents(),c&&f.textContent===""&&(t+=`
`),s.insertNode(document.createTextNode(t.replace(/\r\n|\r|\u2028|\u2029/g,`
`))),s.collapse(!1),s.insertNode(document.createElement("wbr")),c?(l.querySelector('[data-render="true"]')?.removeAttribute("data-render"),ze(l)):he(l,s),l.setAttribute("updated",Y().format("YYYYMMDDHHmmss")),J(e,r,l.outerHTML,d),setTimeout(()=>{Ne(e,l,!1,"smooth")},u.TIMEOUT_LOAD);return}const g=[],p=[];if(s.toString()!==""){const S=B(s.commonAncestorContainer,"data-type","inline-math");S?S.remove():s.startContainer.nodeType===3&&s.startContainer.parentElement.getAttribute("data-type")?.indexOf("block-ref")>-1?(s.deleteContents(),s.startContainer.nodeType!==3&&s.startContainer.textContent===""&&s.startContainer.remove()):s.deleteContents(),s.insertNode(document.createElement("wbr")),g.push({action:"update",id:r,data:d}),p.push({action:"update",id:r,data:l.outerHTML})}const h=document.createElement("template");t.startsWith("&gt;")&&f.textContent.replace(u.ZWSP,"")!==""&&(o=t);let m=o||e.lute.SpinBlockDOM(t)||t;m=m.replace(/;;;lt;;;/g,"&lt;").replace(/;;;gt;;;/g,"&gt;"),h.innerHTML=m;let b=!1;if((f.textContent.replace(u.ZWSP,"")!==""||l.getAttribute("data-type")==="NodeHeading")&&h.content.childElementCount===1&&h.content.firstChild.nodeType!==3&&h.content.firstElementChild.getAttribute("data-type")==="NodeHeading"&&(n=!1,b=!0),!n&&(h.content.firstChild.nodeType===3||b||h.content.firstChild.nodeType!==3&&(h.content.firstElementChild.classList.contains("p")&&h.content.childElementCount===1||h.content.firstElementChild.tagName!=="DIV"))){h.content.firstChild.nodeType!==3&&h.content.firstElementChild.classList.contains("p")&&(h.innerHTML=h.content.firstElementChild.firstElementChild.innerHTML.trim());const S=s.startContainer.nodeType===3?s.startContainer.parentElement:s.startContainer;if(S.tagName==="SPAN"&&S.isSameNode(s.endContainer.nodeType===3?s.endContainer.parentElement:s.endContainer)&&h.content.querySelector("span, img")){const k=document.createElement("span"),A=S.attributes;for(let $=0;$<A.length;$++)k.setAttribute(A[$].name,A[$].value);s.setEnd(S.lastChild,S.lastChild.textContent.length),k.append(s.extractContents()),S.after(k),s.setStartBefore(k),s.collapse(!0)}s.insertNode(h.content.cloneNode(!0)),s.collapse(!1),l.querySelector("wbr")?.remove(),e.wysiwyg.lastHTMLs[r]=d,Gf(e,l,s);return}const y=L(l,"li");if(h.content.children[0]?.getAttribute("data-type")==="NodeListItem")if(y)l=y,r=l.getAttribute("data-node-id"),d=l.outerHTML;else{const k=h.content.children[0].getAttribute("data-subtype");h.innerHTML=`<div${k==="o"?' data-marker="1."':""} data-subtype="${k}" data-node-id="${Lute.NewNodeID()}" data-type="NodeList" class="list">${t}<div class="protyle-attr" contenteditable="false">${u.ZWSP}</div></div>`}let w,_=!1;!s.toString()&&i&&ct(l,e.wysiwyg.element,s).start===0&&f.textContent!==""&&(_=!0),(_?Array.from(h.content.children):Array.from(h.content.children).reverse()).forEach(S=>{S.getAttribute("data-type")==="NodeHeading"&&S.getAttribute("fold")==="1"&&S.removeAttribute("fold");let k=S.getAttribute("data-node-id");if(k===r)p.push({action:"update",data:S.outerHTML,id:k}),g.push({action:"update",id:k,data:d});else{if(S.classList.contains("li")&&!l.parentElement.classList.contains("list")){k=Lute.NewNodeID();const A=document.createElement("div");A.setAttribute("data-subtype",S.getAttribute("data-subtype")),A.setAttribute("data-node-id",k),A.setAttribute("data-type","NodeList"),A.setAttribute("updated",Y().format("YYYYMMDDHHmmss")),A.classList.add("list"),A.append(S),S=A}p.push({action:"insert",data:S.outerHTML,id:k,nextID:_?r:void 0,previousID:_?void 0:r}),g.push({action:"delete",id:k})}_?l.before(S):l.after(S),w||(w=S)}),f&&f.textContent===""&&l.classList.contains("p")&&(p.find((S,k)=>{if(S.id===r)return p.splice(k,1),!0}),p.push({action:"delete",id:r}),g.find((S,k)=>{if(S.id===r&&S.action==="update")return g.splice(k,1),!0}),g.push({action:"insert",data:d,id:r,previousID:l.previousElementSibling?l.previousElementSibling.getAttribute("data-node-id"):"",parentID:l.parentElement.getAttribute("data-node-id")||e.block.parentID}),l.remove()),w&&ae(w,void 0,!1);const x=e.wysiwyg.element.querySelector("wbr");x&&x.remove(),U(e,p,g)},I_=t=>{if(t){Q(["util"],t),qn()&&(t.highlight.markHL.clear(),t.highlight.mark.clear(),t.highlight.ranges=[],t.highlight.rangeIndex=0),t.observer?.disconnect(),t.observerLoad?.disconnect(),t.element.classList.remove("protyle"),t.element.removeAttribute("style"),t.wysiwyg&&(t.wysiwyg.lastHTMLs={}),t.undo&&t.undo.clear();try{t.ws.send("closews",{})}catch{setTimeout(()=>{t.ws.send("closews",{})},10240)}t.app.plugins.forEach(e=>{e.eventBus.emit("destroy-protyle",{protyle:t})})}};class px{constructor(){this.isUploading=!1,this.element=document.createElement("div"),this.element.className="protyle-upload"}}const gx=(t,e)=>{const n=[];let a="",i="";for(let o=e.length,l=0;l<o;l++){const r=e[l];let d=!0;r.name||(a+=`<li>${window.siyuan.languages.nameEmpty}</li>`,d=!1),r.size>t.options.upload.max&&(a+=`<li>${r.name} ${window.siyuan.languages.over} ${t.options.upload.max/1024/1024}M</li>`,d=!1);const c=r.name.lastIndexOf("."),f=c===-1?"":r.name.substr(c),g=c===-1?r.name:t.options.upload.filename(r.name.substr(0,c))+f;t.options.upload.accept&&(t.options.upload.accept.split(",").some(h=>{const m=h.trim();if(m.indexOf(".")===0){if(f.toLowerCase()===m.toLowerCase())return!0}else if(r.type.split("/")[0]===m.split("/")[0])return!0;return!1})||(a+=`<li>${r.name} ${window.siyuan.languages.fileTypeError}</li>`,d=!1)),d&&(n.push(r),i+=`<li>${g} ${window.siyuan.languages.uploading}</li>`)}let s;return(a!==""||i!=="")&&(s=j(`<ul>${a}${i}</ul>`,-1)),{files:n,msgId:s}},D_=(t,e)=>{const n=JSON.parse(t);let a="";n.code===1&&(a=`${n.msg}`),n.data.errFiles&&n.data.errFiles.length>0&&(a=`<ul><li>${a}</li>`,n.data.errFiles.forEach(f=>{const g=f.lastIndexOf("."),p=g===-1?f:e.options.upload.filename(f.substr(0,g))+f.substr(g);a+=`<li>${p} ${window.siyuan.languages.uploadError}</li>`}),a+="</ul>"),a&&j(a);let i=!0;const s=me(e.wysiwyg.element);s.toString()===""&&s.startContainer.nodeType===3&&e.toolbar.getCurrentType(s).length>0&&(s.setEndAfter(s.startContainer.parentElement),s.collapse(!1));const o=P(s.startContainer);if(o)if(o.classList.contains("table"))i=!1;else{const f=le(o);f&&f.textContent!==""&&o.classList.contains("p")&&(i=!1)}let l="";const r=Object.keys(n.data.succMap),d=[];let c=!1;if(r.forEach((f,g)=>{const p=n.data.succMap[f],h=Ee().extname(f).toLowerCase(),m=e.options.upload.filename(f),b=m.substring(0,m.length-h.length);c=u.SIYUAN_ASSETS_IMAGE.includes(h),d.push({type:u.SIYUAN_ASSETS_IMAGE.includes(h)?"image":"file",content:p,name:b}),l+=s_(h,p,b,m),!u.SIYUAN_ASSETS_AUDIO.includes(h)&&!u.SIYUAN_ASSETS_VIDEO.includes(h)&&r.length-1!==g&&(o&&o.classList.contains("table")?l+="<br>":i?l+=`

`:l+=`
`)}),o&&o.classList.contains("av")){const f=[];if(o.querySelectorAll(".av__row--select:not(.av__row--header)").forEach(g=>{g.querySelectorAll(".av__cell").forEach(p=>{vn(p)==="mAsset"&&f.push(p)})}),f.length===0&&e.wysiwyg.element.querySelectorAll(".av__cell--active").forEach(g=>{vn(g)==="mAsset"&&f.push(g)}),f.length>0){Tn(e,o,d,f),document.querySelector(".av__panel")?.remove();return}else return}if(document.querySelector(".av__panel")){const f=[document.querySelector('.custom-attr__avvalue[data-type="mAsset"][data-active="true"]')];if(f[0]||(f.splice(0,1),e.wysiwyg.element.querySelectorAll(".av__cell--active").forEach(g=>{vn(g)==="mAsset"&&f.push(g)})),f.length>0){const g=P(f[0]);if(g){Tn(e,g,d,f),document.querySelector(".av__panel")?.remove();return}}else return}wt(l,e,i),setTimeout(()=>{Ne(e,void 0,!1,"smooth")},c?0:u.TIMEOUT_LOAD)},jf=(t,e,n)=>{const a=j(window.siyuan.languages.uploading,0);E("/api/asset/insertLocalAssets",{assetPaths:t,isUpload:n,id:e.block.rootID},i=>{Ue(a);let s="";Object.keys(i.data.succMap).forEach(o=>{i.data.succMap[o].startsWith("file:")&&(s+=o+", ")}),s&&j(window.siyuan.languages.dndFolderTip.replace("${x}",`<b>${s.substring(0,s.length-2)}</b>`)),D_(JSON.stringify(i),e)})},ii=(t,e,n,a)=>{if(!t){const c=new FormData;for(let g=0,p=e.length;g<p;g++)c.append("file[]",e[g]);const f=new XMLHttpRequest;f.open("POST",u.UPLOAD_ADDRESS),f.onreadystatechange=()=>{f.readyState===XMLHttpRequest.DONE&&(f.status===200?a(f.responseText):f.status===0?j(window.siyuan.languages.fileTypeError):j(f.responseText),n&&(n.value=""))},f.send(c);return}let i=[];for(let c=0;c<e.length;c++){let f=e[c];f instanceof DataTransferItem&&(f=f.getAsFile()),f.size===0&&f.type===""&&f.name.indexOf(".")===-1?jf([f.path],t,!1):i.push(f)}if(t.options.upload.handler){const c=t.options.upload.handler(i);if(typeof c=="string"){j(c);return}return}if(!t.options.upload.url||!t.upload){n&&(n.value=""),j("please config: options.upload.url");return}if(t.options.upload.file&&(i=t.options.upload.file(i)),t.options.upload.validate){const c=t.options.upload.validate(i);if(typeof c=="string"){j(c);return}}const s=t.wysiwyg.element,o=gx(t,i);if(o.files.length===0){n&&(n.value="");return}const l=new FormData,r=t.options.upload.extraData;for(const c of Object.keys(r))l.append(c,r[c]);for(let c=0,f=o.files.length;c<f;c++)l.append(t.options.upload.fieldName,o.files[c]);l.append("id",t.block.rootID);const d=new XMLHttpRequest;d.open("POST",t.options.upload.url),t.options.upload.token&&d.setRequestHeader("X-Upload-Token",t.options.upload.token),t.options.upload.withCredentials&&(d.withCredentials=!0),t.upload.isUploading=!0,d.onreadystatechange=()=>{if(d.readyState===XMLHttpRequest.DONE){if(t.upload.isUploading=!1,!document.body.contains(t.element)){I_(t);return}if(d.status===200)if(Ue(o.msgId),t.options.upload.success)t.options.upload.success(s,d.responseText);else if(a)a(d.responseText);else{let c=d.responseText;t.options.upload.format&&(c=t.options.upload.format(e,d.responseText)),D_(c,t)}else d.status===0?j(window.siyuan.languages.fileTypeError):t.options.upload.error?t.options.upload.error(d.responseText):j(d.responseText);n&&(n.value=""),t.upload.element.style.display="none"}},d.upload.onprogress=c=>{if(!c.lengthComputable)return;const f=c.loaded/c.total*100;t.upload.element.style.display="block";const g=t.upload.element;g.style.width=f+"%"},d.send(l)},wc=(t,e,n,a=!1)=>{let i=Lute.UnEscapeHTMLStr(e),s;if(Qs(i)&&!i.startsWith("file://")&&i.indexOf(".pdf")>-1){const o=i.split("/");o.length===3&&o[0]==="assets"&&o[1].endsWith(".pdf")&&/\d{14}-\w{7}/.test(o[2])?(i=`assets/${o[1]}`,s=o[2]):(s=parseInt(It("page",i)),i=i.split("?page")[0])}Qs(i)?u.SIYUAN_ASSETS_EXTS.includes(Ee().extname(i))&&(!i.endsWith(".pdf")||i.endsWith(".pdf")&&i.startsWith("assets/"))?n&&n.altKey?Ul(t.app,i,s):n&&n.shiftKey?ea(i,"app"):a?ea(i,"folder"):Ul(t.app,i,s,"right"):a?ea(i,"folder"):ea(i,"app"):i&&(0>i.indexOf(":")&&(i=`https://${i}`),ee.shell.openExternal(i).catch(o=>{j(o)}))},_c=t=>{Ct(`${u.PROTYLE_CDN}/js/viewerjs/viewer.js?v=1.11.7`,"protyleViewerScript").then(()=>{const e=document.createElement("ul");e.innerHTML=`<li><img src="${t}"></li>`,window.siyuan.viewer=new Viewer(e,{title:[1,(n,a)=>{let i=n.alt;return i||(i=n.src.substring(n.src.lastIndexOf("/")+1)),i=i.substring(0,i.lastIndexOf(".")).replace(/-\d{14}-\w{7}$/,""),`${i} [${a.naturalWidth} \xD7 ${a.naturalHeight}]`}],button:!1,transition:!1,hidden:function(){window.siyuan.viewer.destroy()},toolbar:{zoomIn:!0,zoomOut:!0,oneToOne:!0,reset:!0,prev:!0,play:!0,next:!0,rotateLeft:!0,rotateRight:!0,flipHorizontal:!0,flipVertical:!0,close:function(){window.siyuan.viewer.destroy()}}}),window.siyuan.viewer.show()})},$_=(t,e)=>{Ct(`${u.PROTYLE_CDN}/js/viewerjs/viewer.js?v=1.11.7`,"protyleViewerScript").then(()=>{E("/api/asset/getDocImageAssets",{id:e},n=>{const a=document.createElement("ul");let i="",s=-1;n.data.forEach((o,l)=>{o&&(i+=`<li><img src="${o}"></li>`,s===-1&&(t.endsWith(encodeURI(o))||t.endsWith(o))&&(s=l))}),a.innerHTML=i,window.siyuan.viewer=new Viewer(a,{title:[1,(o,l)=>{let r=o.alt;return r||(r=o.src.substring(o.src.lastIndexOf("/")+1)),r=r.substring(0,r.lastIndexOf(".")).replace(/-\d{14}-\w{7}$/,""),`${r} [${l.naturalWidth} \xD7 ${l.naturalHeight}]`}],button:!1,initialViewIndex:s,transition:!1,hidden:function(){window.siyuan.viewer.destroy()},toolbar:{zoomIn:!0,zoomOut:!0,oneToOne:!0,reset:!0,prev:!0,play:!0,next:!0,rotateLeft:!0,rotateRight:!0,flipHorizontal:!0,flipVertical:!0,close:function(){window.siyuan.viewer.destroy()}}}),window.siyuan.viewer.show()})})},M_=t=>{t.menuElement.querySelector("input").addEventListener("change",e=>{e.target.files.length!==0&&ii(t.protyle,e.target.files,e.target,n=>{const a=JSON.parse(n),i=[];Object.keys(a.data.succMap).forEach(s=>{i.push({name:s,content:a.data.succMap[s],type:u.SIYUAN_ASSETS_IMAGE.includes(Ee().extname(a.data.succMap[s]).toLowerCase())?"image":"file"})}),po({protyle:t.protyle,cellElements:t.cellElements,addValue:i,blockElement:t.blockElement})})})},P_=t=>{let e="";return ga("mAsset",t[0]).mAsset.forEach((n,a)=>{let i;n.type==="image"?i=`<span data-type="openAssetItem" class="fn__flex-1 ariaLabel" aria-label="${n.content}">
    <img style="max-height: 180px;max-width: 360px;border-radius: var(--b3-border-radius);margin: 4px 0;" src="${n.content}"/>
</span>`:i=`<span data-type="openAssetItem" class="fn__ellipsis b3-menu__label ariaLabel" aria-label="${Xe(n.content)}" style="max-width: 360px">${n.name||n.content}</span>`,e+=`<button class="b3-menu__item" draggable="true" data-index="${a}" data-name="${Xe(n.name)}" data-type="${n.type}" data-content="${Xe(n.content)}">
<svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>
${i}
<svg class="b3-menu__action" data-type="editAssetItem"><use xlink:href="#iconEdit"></use></svg>
</button>`}),`<div class="b3-menu__items">
    ${e}
    <button data-type="addAssetExist" class="b3-menu__item">
        <svg class="b3-menu__icon"><use xlink:href="#iconImage"></use></svg>
        <span class="b3-menu__label">${window.siyuan.languages.assets}</span>
    </button>
    <button class="b3-menu__item">
        <svg class="b3-menu__icon"><use xlink:href="#iconDownload"></use></svg>
        <span class="b3-menu__label">${window.siyuan.languages.insertAsset}</span> 
        <input multiple class="b3-form__upload" type="file">
    </button>
    <button data-type="addAssetLink" class="b3-menu__item">
        <svg class="b3-menu__icon"><use xlink:href="#iconLink"></use></svg>
        <span class="b3-menu__label">${window.siyuan.languages.link}</span>
    </button>
</div>`},po=t=>{const e=t.cellElements[0].dataset.colId,n=[],a=[];let i;t.cellElements.forEach((o,l)=>{if(!t.blockElement.contains(o)){const g=L(o,"av__row");g&&(o=t.cellElements[l]=t.blockElement.querySelector(`.av__row[data-id="${g.dataset.id}"] .av__cell[data-col-id="${o.dataset.colId}"]`)||t.blockElement.querySelector(`.fn__flex-1[data-col-id="${o.dataset.colId}"]`))}const r=ga(vn(o)||o.dataset.type,o),d=L(o,"av__row").dataset.id,c=JSON.parse(JSON.stringify(r));l===0?(typeof t.removeIndex=="number"?r.mAsset.splice(t.removeIndex,1):t.addValue?.length>0?r.mAsset=r.mAsset.concat(t.addValue):t.updateValue?r.mAsset.find((g,p)=>{if(p===t.updateValue.index)return g.content=t.updateValue.value.content,g.type=t.updateValue.value.type,g.name=t.updateValue.value.name,!0}):t.replaceValue?.length>0&&(r.mAsset=t.replaceValue),i=r.mAsset):r.mAsset=i;const f=t.blockElement.getAttribute("data-av-id");n.push({action:"updateAttrViewCell",id:r.id,keyID:e,rowID:d,avID:f,data:r}),a.push({action:"updateAttrViewCell",id:r.id,keyID:e,rowID:d,avID:f,data:c}),o.classList.contains("custom-attr__avvalue")?o.innerHTML=Ci(r):gn(o,r)}),U(t.protyle,n,a);const s=document.querySelector(".av__panel > .b3-menu");if(s){s.innerHTML=P_(t.cellElements),M_({protyle:t.protyle,menuElement:s,cellElements:t.cellElements,blockElement:t.blockElement});const o=(t.cellElements[0].classList.contains("custom-attr__avvalue")?t.cellElements[0]:t.protyle.wysiwyg.element.querySelector(`.av__cell[data-id="${t.cellElements[0].dataset.id}"]`)).getBoundingClientRect();setTimeout(()=>{ke(s,o.left,o.bottom,o.height)},u.TIMEOUT_LOAD)}},Kf=t=>{const e=t.content,n=t.type,a=new st("av-asset-edit",()=>{!o[1]&&o[0].value===e||o[1]&&o[0].value===e&&o[1].value===t.name||po({protyle:t.protyle,cellElements:t.cellElements,blockElement:t.blockElement,updateValue:{index:t.index,value:{content:o[0].value,name:o[1]?o[1].value:"",type:n}}})});if(a.isOpen)return;n==="file"?(a.addItem({id:"linkAndTitle",iconHTML:"",type:"readonly",label:`<div class="fn__flex">
    <span class="fn__flex-center">${window.siyuan.languages.link}</span>
    <span class="fn__space"></span>
    <span data-action="copy" class="block__icon block__icon--show b3-tooltips b3-tooltips__e fn__flex-center" aria-label="${window.siyuan.languages.copy}">
        <svg><use xlink:href="#iconCopy"></use></svg>
    </span>   
</div>
<textarea rows="1" style="margin:4px 0;width: ${W()?"200":"360"}px;resize: vertical;" class="b3-text-field"></textarea>
<div class="fn__hr"></div>
<div class="fn__flex">
    <span class="fn__flex-center">${window.siyuan.languages.title}</span>
    <span class="fn__space"></span>
    <span data-action="copy" class="block__icon block__icon--show b3-tooltips b3-tooltips__e fn__flex-center" aria-label="${window.siyuan.languages.copy}">
        <svg><use xlink:href="#iconCopy"></use></svg>
    </span>   
</div>
<textarea style="width: ${W()?"200":"360"}px;margin: 4px 0;resize: vertical;" rows="1" class="b3-text-field"></textarea>`,bind(l){l.addEventListener("click",r=>{let d=r.target;for(;d;){if(d.dataset.action==="copy"){De(d.parentElement.nextElementSibling.value),j(window.siyuan.languages.copied);break}d=d.parentElement}})}}),a.addSeparator({id:"separator_1"}),a.addItem({id:"copy",label:window.siyuan.languages.copy,icon:"iconCopy",click(){De(`[${o[1].value||o[0].value}](${o[0].value})`)}})):(a.addItem({id:"link",iconHTML:"",type:"readonly",label:`<div class="fn__flex">
    <span class="fn__flex-center">${window.siyuan.languages.link}</span>
    <span class="fn__space"></span>
    <span data-action="copy" class="block__icon block__icon--show b3-tooltips b3-tooltips__e fn__flex-center" aria-label="${window.siyuan.languages.copy}">
        <svg><use xlink:href="#iconCopy"></use></svg>
    </span>   
</div>
<textarea rows="1" style="margin:4px 0;width: ${W()?"200":"360"}px;resize: vertical;" class="b3-text-field"></textarea>`,bind(l){l.addEventListener("click",r=>{let d=r.target;for(;d;){if(d.dataset.action==="copy"){De(d.parentElement.nextElementSibling.value),j(window.siyuan.languages.copied);break}d=d.parentElement}})}}),a.addSeparator({id:"separator_1"}),a.addItem({id:"copy",label:window.siyuan.languages.copy,icon:"iconCopy",click(){De(`![](${e.replace(/%20/g," ")})`)}}),a.addItem({id:"copyAsPNG",label:window.siyuan.languages.copyAsPNG,icon:"iconImage",click(){Ch(e)}})),a.addItem({id:"delete",icon:"iconTrashcan",label:window.siyuan.languages.delete,click(){po({protyle:t.protyle,cellElements:t.cellElements,blockElement:t.blockElement,removeIndex:t.index})}}),e?.startsWith("assets/")&&a.addItem({id:"rename",label:window.siyuan.languages.rename,icon:"iconEdit",click(){gf(e),document.querySelector(".av__panel")?.remove()}});const i=vc(t.protyle?t.protyle.app:window.siyuan.ws.app,e,!0,!1);(n!=="file"||i.length>0)&&a.addSeparator({id:"separator_2"}),n!=="file"&&a.addItem({id:"cardPreview",icon:"iconPreview",label:window.siyuan.languages.cardPreview,click(){_c(e)}}),i.length>0&&window.siyuan.menus.menu.append(new T({id:"openBy",label:window.siyuan.languages.openBy,icon:"iconOpen",submenu:i}).element),e?.startsWith("assets/")&&window.siyuan.menus.menu.append(new T(df(e)).element);const s=t.rect;a.open({x:s.right,y:s.top,w:s.width,h:s.height});const o=a.element.querySelectorAll("textarea");o[0].value=e,o[0].focus(),o[0].select(),o.length>1&&(o[1].value=t.name)},hx=(t,e,n,a)=>{const i=new st("av-asset-link",()=>{const o=i.element.querySelectorAll("textarea");!o[0].value&&!o[1].value||po({protyle:t,cellElements:e,blockElement:a,addValue:[{type:"file",name:o[1].value,content:o[0].value}]})});if(i.isOpen)return;i.addItem({iconHTML:"",type:"readonly",label:`${window.siyuan.languages.link}
<textarea rows="1" style="margin:4px 0;width: ${W()?"200":"360"}px;resize: vertical;" class="b3-text-field"></textarea>
<div class="fn__hr"></div>
${window.siyuan.languages.title}
<textarea style="width: ${W()?"200":"360"}px;margin: 4px 0;resize: vertical;" rows="1" class="b3-text-field"></textarea>`});const s=n.getBoundingClientRect();i.open({x:s.right,y:s.bottom,w:n.parentElement.clientWidth+8,h:s.height}),i.element.querySelector("textarea").focus()},N_=(t,e,n)=>{const a=j(window.siyuan.languages.uploading,0);E("/api/asset/insertLocalAssets",{assetPaths:t,isUpload:!0,id:e.block.rootID},i=>{const s=P(n);if(s){Ue(a);const o=[];Object.keys(i.data.succMap).forEach(l=>{const r=Ee().extname(l).toLowerCase(),d=l.substring(0,l.length-r.length);u.SIYUAN_ASSETS_IMAGE.includes(r)?o.push({type:"image",name:d,content:i.data.succMap[l]}):o.push({type:"file",name:d,content:i.data.succMap[l]})}),po({protyle:e,blockElement:s,cellElements:[n],addValue:o})}})},mx=t=>{let e="";switch(t.type){case"block":t?.isDetached?e=`<span data-id="${t.block?.id}">${t.block?.content||window.siyuan.languages.untitled}</span>`:e=`<span data-type="block-ref" data-id="${t.block?.id}" data-subtype="s" class="av__celltext--ref">${t.block?.content||window.siyuan.languages.untitled}</span>`;break;case"text":e=t.text.content;break;case"number":e=t.number.formattedContent||t.number.content.toString();break;case"date":t[t.type]&&t[t.type].isNotEmpty&&(e=Y(t[t.type].content).format(t[t.type].isNotTime?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")),t[t.type]&&t[t.type].hasEndDate&&t[t.type].isNotEmpty&&t[t.type].isNotEmpty2&&(e+=`<svg class="av__cellicon"><use xlink:href="#iconForward"></use></svg>${Y(t[t.type].content2).format(t[t.type].isNotTime?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")}`),e&&(e=`<span class="av__celltext">${e}</span>`);break;case"url":e=t.url.content?`<a class="fn__a" href="${t.url.content}" target="_blank">${t.url.content}</a>`:"";break;case"phone":e=t.phone.content?`<a class="fn__a" href="tel:${t.phone.content}" target="_blank">${t.phone.content}</a>`:"";break;case"email":e=t.email.content?`<a class="fn__a" href="mailto:${t.email.content}" target="_blank">${t.email.content}</a>`:"";break}return e},Ci=t=>{let e="";switch(t.type){case"block":e=`<input value="${Xe(t.block.content)}" type="text" class="b3-text-field b3-text-field--text fn__flex-1" placeholder="${window.siyuan.languages.empty}">`;break;case"text":e=`<textarea style="resize: vertical" rows="${t.text.content.split(`
`).length}" class="b3-text-field b3-text-field--text fn__flex-1" placeholder="${window.siyuan.languages.empty}">${t.text.content}</textarea>`;break;case"number":e=`<input value="${t.number.isNotEmpty?t.number.content:""}" type="number" class="b3-text-field b3-text-field--text fn__flex-1" placeholder="${window.siyuan.languages.empty}">
<span class="fn__space"></span><span class="fn__flex-center ft__on-surface b3-tooltips__w b3-tooltips" aria-label="${window.siyuan.languages.format}">${t.number.formattedContent}</span><span class="fn__space"></span>`;break;case"mSelect":case"select":t.mSelect?.forEach((n,a)=>{t.type==="select"&&a>0||(e+=`<span class="b3-chip b3-chip--middle" style="background-color:var(--b3-font-background${n.color});color:var(--b3-font-color${n.color})">${pe(n.content)}</span>`)});break;case"mAsset":t.mAsset?.forEach(n=>{n.type==="image"?e+=`<img class="av__cellassetimg ariaLabel" aria-label="${n.content}" src="${n.content}">`:e+=`<span class="b3-chip b3-chip--middle av__celltext--url ariaLabel" aria-label="${Xe(n.content)}" data-name="${Xe(n.name)}" data-url="${Xe(n.content)}">${n.name||n.content}</span>`});break;case"date":e=`<span class="av__celltext" data-value='${JSON.stringify(t[t.type])}' placeholder="${window.siyuan.languages.empty}">`,t[t.type]&&t[t.type].isNotEmpty&&(e+=Y(t[t.type].content).format(t[t.type].isNotTime?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")),t[t.type]&&t[t.type].hasEndDate&&t[t.type].isNotEmpty&&t[t.type].isNotEmpty2&&(e+=`<svg class="av__cellicon"><use xlink:href="#iconForward"></use></svg>${Y(t[t.type].content2).format(t[t.type].isNotTime?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")}`),e+="</span>";break;case"created":case"updated":t[t.type].isNotEmpty&&(e=`<span data-content="${t[t.type].content}">${Y(t[t.type].content).format("YYYY-MM-DD HH:mm")}</span>`);break;case"url":e=`<input value="${t.url.content}" class="b3-text-field b3-text-field--text fn__flex-1" placeholder="${window.siyuan.languages.empty}">
<span class="fn__space"></span>
<a ${t.url.content?`href="${t.url.content}"`:""} target="_blank" aria-label="${window.siyuan.languages.openBy}" class="block__icon block__icon--show fn__flex-center b3-tooltips__w b3-tooltips"><svg><use xlink:href="#iconLink"></use></svg></a>`;break;case"phone":e=`<input value="${t.phone.content}" class="b3-text-field b3-text-field--text fn__flex-1" placeholder="${window.siyuan.languages.empty}">
<span class="fn__space"></span>
<a ${t.phone.content?`href="tel:${t.phone.content}"`:""} target="_blank" aria-label="${window.siyuan.languages.openBy}" class="block__icon block__icon--show fn__flex-center b3-tooltips__w b3-tooltips"><svg><use xlink:href="#iconPhone"></use></svg></a>`;break;case"checkbox":e=`<svg class="av__checkbox"><use xlink:href="#icon${t.checkbox.checked?"Check":"Uncheck"}"></use></svg>`;break;case"template":e=`<div class="fn__flex-1" placeholder="${window.siyuan.languages.empty}">${t.template.content}</div>`;break;case"email":e=`<input value="${t.email.content}" class="b3-text-field b3-text-field--text fn__flex-1" placeholder="${window.siyuan.languages.empty}">
<span class="fn__space"></span>
<a ${t.email.content?`href="mailto:${t.email.content}"`:""} target="_blank" aria-label="${window.siyuan.languages.openBy}" class="block__icon block__icon--show fn__flex-center b3-tooltips__w b3-tooltips"><svg><use xlink:href="#iconEmail"></use></svg></a>`;break;case"relation":t?.relation?.contents?.forEach(n=>{n&&n.block&&(n?.isDetached?e+=`<span class="av__cell--relation"><span>\u2796 </span><span class="av__celltext" data-id="${n.block?.id}">${Lute.EscapeHTMLStr(n.block.content||window.siyuan.languages.untitled)}</span></span>`:e+=`<span class="av__cell--relation" data-block-id="${n.block.id}"><span class="b3-menu__avemoji" data-unicode="${n.block.icon||""}">${ge(n.block.icon||window.siyuan.storage[u.LOCAL_IMAGES].file)}</span><span data-type="block-ref" data-id="${n.block.id}" data-subtype="s" class="av__celltext av__celltext--ref">${Lute.EscapeHTMLStr(n.block.content||window.siyuan.languages.untitled)}</span></span>`)}),e&&e.endsWith(", ")&&(e=e.substring(0,e.length-2));break;case"rollup":t?.rollup?.contents?.forEach(n=>{const a=["select","mSelect","mAsset","checkbox","relation"].includes(n.type)?Ci(n):mx(n);a&&(e+=a+",&nbsp;")}),e&&e.endsWith(",&nbsp;")&&(e=e.substring(0,e.length-7));break}return e},ym=(t,e,n,a)=>{E("/api/av/getAttributeViewKeys",{id:e},i=>{let s="";if(i.data.forEach(o=>{let l=`<div class="custom-attr__avheader">
    <div class="block__logo popover__block" style="max-width:calc(100% - 40px)" data-id='${JSON.stringify(o.blockIDs)}'>
        <svg class="block__logoicon"><use xlink:href="#iconDatabase"></use></svg>
        <span class="fn__ellipsis">${o.avName||window.siyuan.languages.database}</span>
    </div>
    <div class="fn__flex-1"></div>
    <span data-type="remove" class="block__icon block__icon--warning block__icon--show b3-tooltips__w b3-tooltips" aria-label="${window.siyuan.languages.removeAV}"><svg><use xlink:href="#iconTrashcan"></use></svg></span>
</div>`;o.keyValues?.forEach(r=>{l+=`<div class="block__icons av__row" data-id="${e}" data-col-id="${r.key.id}">
    <div class="block__icon" draggable="true"><svg><use xlink:href="#iconDrag"></use></svg></div>
    <div class="block__logo ariaLabel fn__pointer" data-type="editCol" data-position="parentW" aria-label="${Rt(r.key.name)}<div class='ft__on-surface'>${Rt(r.key.desc)}</div>">
        ${r.key.icon?ge(r.key.icon,"block__logoicon",!0):`<svg class="block__logoicon"><use xlink:href="#${sn(r.key.type)}"></use></svg>`}
        <span>${pe(r.key.name)}</span>
    </div>
    <div data-av-id="${o.avID}" data-col-id="${r.values[0].keyID}" data-block-id="${r.values[0].blockID}" data-id="${r.values[0].id}" data-type="${r.values[0].type}" 
data-options="${r.key?.options?Xe(JSON.stringify(r.key.options)):"[]"}" 
${["text","number","date","url","phone","template","email"].includes(r.values[0].type)?"":`placeholder="${window.siyuan.languages.empty}"`}  
class="fn__flex-1 fn__flex${["url","text","number","email","phone","block"].includes(r.values[0].type)?"":" custom-attr__avvalue"}${["created","updated"].includes(r.values[0].type)?" custom-attr__avvalue--readonly":""}">${Ci(r.values[0])}</div>
</div>`}),l+=`<div class="fn__hr"></div>
<button data-type="addColumn" class="b3-button b3-button--cancel"><svg><use xlink:href="#iconAdd"></use></svg>${window.siyuan.languages.newCol}</button>
<div class="fn__hr--b"></div><div class="fn__hr--b"></div>`,s+=`<div data-av-id="${o.avID}" data-node-id="${e}" data-type="NodeAttributeView">${l}</div>`,t.innerHTML&&(t.querySelector(`div[data-node-id="${e}"][data-av-id="${o.avID}"]`).innerHTML=l)}),t.innerHTML===""){let o;t.addEventListener("dragstart",r=>{const d=r.target;window.siyuan.dragElement=d.parentElement,window.siyuan.dragElement.style.opacity=".1",o=P(window.siyuan.dragElement);const c=document.createElement("div");c.className="block__icons",c.innerHTML=d.nextElementSibling.outerHTML,c.setAttribute("style","width: 160px;position:fixed;opacity:.1;"),document.body.append(c),r.dataTransfer.setDragImage(c,0,0),setTimeout(()=>{c.remove()})}),t.addEventListener("drop",r=>{if(l=0,n.disabled){r.preventDefault(),r.stopPropagation();return}const d=t.querySelector(".dragover__bottom, .dragover__top");if(d&&o){const c=d.classList.contains("dragover__bottom"),f=c?d.dataset.colId:d.previousElementSibling?.getAttribute("data-col-id"),g=window.siyuan.dragElement.previousElementSibling?.getAttribute("data-col-id");f!==g&&f!==window.siyuan.dragElement.dataset.colId&&(U(n,[{action:"sortAttrViewKey",avID:o.dataset.avId,previousID:f,id:window.siyuan.dragElement.dataset.colId}],[{action:"sortAttrViewKey",avID:o.dataset.avId,previousID:g,id:e}]),c?d.after(window.siyuan.dragElement):d.before(window.siyuan.dragElement)),d.classList.remove("dragover__bottom","dragover__top")}else if(!window.siyuan.dragElement&&r.dataTransfer.types[0]==="Files"){const c=t.querySelector(".custom-attr__avvalue--active");if(c&&r.dataTransfer.types[0]==="Files"&&!pt()){const f=[];for(let g=0;g<r.dataTransfer.files.length;g++)f.push(ee.webUtils.getPathForFile(r.dataTransfer.files[g]));N_(f,n,c)}}window.siyuan.dragElement&&(window.siyuan.dragElement.style.opacity="",window.siyuan.dragElement=void 0)}),t.addEventListener("dragover",r=>{const d=r.target;let c;if(r.dataTransfer.types.includes("Files")){t.querySelectorAll(".custom-attr__avvalue--active").forEach(p=>{p.classList.remove("custom-attr__avvalue--active")}),c=L(d,"custom-attr__avvalue"),c&&c.getAttribute("data-type")==="mAsset"&&(c.classList.add("custom-attr__avvalue--active"),r.preventDefault());return}if(c=L(d,"av__row"),c||(c=L(document.elementFromPoint(r.clientX,r.clientY-1),"av__row")),!c||c.isSameNode(window.siyuan.dragElement)||!o)return;const f=P(c);if(!f||!f.isSameNode(o))return;r.preventDefault();const g=c.getBoundingClientRect();t.querySelectorAll(".dragover__bottom, .dragover__top").forEach(p=>{p.classList.remove("dragover__bottom","dragover__top")}),r.clientY>g.top+g.height/2?c.classList.add("dragover__bottom"):c.classList.add("dragover__top")});let l=0;t.addEventListener("dragleave",()=>{l--,l===0&&t.querySelectorAll(".dragover__bottom, .dragover__top").forEach(r=>{r.classList.remove("dragover__bottom","dragover__top")})}),t.addEventListener("dragenter",r=>{r.preventDefault(),l++}),t.addEventListener("dragend",()=>{window.siyuan.dragElement&&(window.siyuan.dragElement.style.opacity="",window.siyuan.dragElement=void 0)}),t.addEventListener("paste",r=>{const d=r.clipboardData.files;if(document.querySelector(".av__panel .b3-form__upload"))if(d&&d.length>0)ii(n,d);else{const c=r.clipboardData.getData("text/plain"),f=r.target,g=P(f),p=B(f,"data-type","mAsset");g&&p&&c&&(Tn(n,g,c,[p],void 0,n.lute.Md2BlockDOM(c)),document.querySelector(".av__panel")?.remove())}}),t.addEventListener("click",r=>{const d=B(r.target,"data-type","remove");if(d){const c=P(d);c&&(U(n,[{action:"removeAttrViewBlock",srcIDs:[e],avID:c.dataset.avId},{action:"doUpdateUpdated",id:e,data:Y().format("YYYYMMDDHHmmss")}]),c.remove(),t.innerHTML||window.siyuan.dialogs.find(f=>{if(f.element.getAttribute("data-key")===u.DIALOG_ATTR)return f.destroy(),!0})),r.stopPropagation();return}H_(n,t,r)}),t.addEventListener("contextmenu",r=>{H_(n,t,r)}),t.innerHTML=s}t.querySelectorAll(".b3-text-field--text").forEach(o=>{o.addEventListener("change",()=>{let l;const r=o.parentElement.dataset.type;if(["url","text","email","phone"].includes(r)){if(l={[r]:{content:o.value}},r!=="text"){const d=o.parentElement.querySelector("a");o.value?d.setAttribute("href",(r==="url"?"":r==="email"?"mailto:":"tel:")+o.value):d.removeAttribute("href")}}else r==="number"?o.value==="undefined"||!o.value?l={number:{content:null,isNotEmpty:!1}}:l={number:{content:parseFloat(o.value)||0,isNotEmpty:!0}}:r==="block"&&(l={block:{content:o.value,id:o.parentElement.dataset.blockId},isDetached:!1});E("/api/av/setAttributeViewBlockAttr",{avID:o.parentElement.dataset.avId,keyID:o.parentElement.dataset.colId,rowID:o.parentElement.dataset.blockId,value:l},d=>{r==="number"?o.parentElement.querySelector(".fn__flex-center").textContent=d.data.value.number.formattedContent:r==="block"&&!o.value&&(o.value=d.data.value.block.content)})})}),a&&a(t)})},H_=(t,e,n)=>{let a=n.target;const i=P(a);if(i)for(;a&&!e.isSameNode(a);){const s=a.getAttribute("data-type");if(a.classList.contains("av__celltext--url")||a.classList.contains("av__cellassetimg")){if(n.type==="contextmenu"||!a.dataset.url&&a.tagName!=="IMG"){let o=0;Array.from(a.parentElement.children).find((l,r)=>{if(l.isSameNode(a))return o=r,!0}),Kf({protyle:t,cellElements:[a.parentElement],blockElement:P(a),content:a.tagName==="IMG"?a.getAttribute("src"):a.getAttribute("data-url"),type:a.tagName==="IMG"?"image":"file",name:a.tagName==="IMG"?"":a.getAttribute("data-name"),index:o,rect:a.getBoundingClientRect()})}else a.tagName==="IMG"?_c(a.getAttribute("src")):wc(t,a.dataset.url,n,n.ctrlKey||n.metaKey);n.stopPropagation(),n.preventDefault();break}else if(s==="date"){Kn(t,[a],"date"),n.stopPropagation(),n.preventDefault();break}else if(s==="select"||s==="mSelect"){Kn(t,[a],a.getAttribute("data-type")),n.stopPropagation(),n.preventDefault();break}else if(s==="mAsset"){e.querySelectorAll('.custom-attr__avvalue[data-type="mAsset"]').forEach(o=>{o.removeAttribute("data-active")}),a.setAttribute("data-active","true"),a.focus(),Kn(t,[a],"mAsset"),n.stopPropagation(),n.preventDefault();break}else if(s==="checkbox"){Kn(t,[a],"checkbox"),n.stopPropagation(),n.preventDefault();break}else if(s==="relation"){Kn(t,[a],"relation"),n.stopPropagation(),n.preventDefault();break}else if(s==="template"){Kn(t,[a],"template"),n.stopPropagation(),n.preventDefault();break}else if(s==="rollup"){Kn(t,[a],"rollup"),n.stopPropagation(),n.preventDefault();break}else if(s==="addColumn"){const o=i.querySelectorAll(".av__row"),l=Lc(t,i,o[o.length-1].getAttribute("data-col-id")),r=a.getBoundingClientRect();l.open({x:r.left,y:r.bottom,h:r.height}),n.stopPropagation(),n.preventDefault();break}else if(s==="editCol"){hn({protyle:t,blockElement:i,type:"edit",colId:a.parentElement.dataset.colId}),n.stopPropagation(),n.preventDefault();break}a=a.parentElement}},R_=(t,e)=>{t.addEventListener("change",()=>{E("/api/attr/setBlockAttrs",{id:e,attrs:{[t.dataset.name]:t.value}})})},bx=t=>{const e=t.getAttribute("data-node-id"),n=me(t),a=t.getAttribute(u.CUSTOM_REMINDER_WECHAT);let i="";a&&(i=Y(a).format("YYYY-MM-DD HH:mm"));const s=new we({width:W()?"92vw":"50vw",title:window.siyuan.languages.wechatReminder,content:`<div class="b3-dialog__content custom-attr">
    <div class="fn__flex">
        <span class="ft__on-surface fn__flex-center" style="text-align: right;white-space: nowrap;width: 100px">${window.siyuan.languages.notifyTime}</span>
        <div class="fn__space"></div>
        <input class="b3-text-field fn__flex-1" type="datetime-local" max="9999-12-31 23:59" value="${i}">
    </div>
    <div class="b3-label__text" style="text-align: center">${window.siyuan.languages.wechatTip}</div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.remove}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,destroyCallback(){Z(n)}});s.element.setAttribute("data-key",u.DIALOG_WECHATREMINDER);const o=s.element.querySelectorAll(".b3-button");o[0].addEventListener("click",()=>{s.destroy()}),o[1].addEventListener("click",()=>{o[1].getAttribute("disabled")||(o[1].setAttribute("disabled","disabled"),E("/api/block/setBlockReminder",{id:e,timed:"0"},()=>{t.removeAttribute(u.CUSTOM_REMINDER_WECHAT),s.destroy()}))}),o[2].addEventListener("click",()=>{const l=s.element.querySelector("input").value;if(l){if(new Date(l)<=new Date){j(window.siyuan.languages.reminderTip);return}if(o[2].getAttribute("disabled"))return;o[2].setAttribute("disabled","disabled");const r=Y(l).format("YYYYMMDDHHmmss");E("/api/block/setBlockReminder",{id:e,timed:r},()=>{t.setAttribute(u.CUSTOM_REMINDER_WECHAT,r),s.destroy()})}else j(window.siyuan.languages.notEmpty)})},yx=t=>{E("/api/block/getDocInfo",{id:t.block.rootID},e=>{const n=e.data.ial[u.CUSTOM_REMINDER_WECHAT];let a="";n&&(a=Y(n).format("YYYY-MM-DD HH:mm"));const i=new we({width:W()?"92vw":"50vw",title:window.siyuan.languages.wechatReminder,content:`<div class="b3-dialog__content custom-attr">
    <div class="fn__flex">
        <span class="ft__on-surface fn__flex-center" style="text-align: right;white-space: nowrap;width: 100px">${window.siyuan.languages.notifyTime}</span>
        <div class="fn__space"></div>
        <input class="b3-text-field fn__flex-1" type="datetime-local" max="9999-12-31 23:59" value="${a}">
    </div>
    <div class="b3-label__text" style="text-align: center">${window.siyuan.languages.wechatTip}</div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.remove}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`});i.element.setAttribute("data-key",u.DIALOG_WECHATREMINDER);const s=i.element.querySelectorAll(".b3-button");s[0].addEventListener("click",()=>{i.destroy()}),s[1].addEventListener("click",()=>{E("/api/block/setBlockReminder",{id:t.block.rootID,timed:"0"},()=>{i.destroy()})}),s[2].addEventListener("click",()=>{const o=i.element.querySelector("input").value;if(o){if(new Date(o)<=new Date){j(window.siyuan.languages.reminderTip);return}E("/api/block/setBlockReminder",{id:t.block.rootID,timed:Y(o).format("YYYYMMDDHHmmss")},()=>{i.destroy()})}else j(window.siyuan.languages.notEmpty)})})},Gn=(t,e="bookmark",n)=>{let a="",i="",s=!1;const o=getSelection().rangeCount>0?getSelection().getRangeAt(0):null;Object.keys(t).forEach(r=>{u.CUSTOM_RIFF_DECKS===r||r.startsWith("custom-sy-")||(r===u.CUSTOM_REMINDER_WECHAT?i=`<label class="b3-label b3-label--noborder">
    ${window.siyuan.languages.wechatReminder}
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__block" type="datetime-local" max="9999-12-31 23:59" readonly data-name="${r}" value="${Y(t[r]).format("YYYY-MM-DD HH:mm")}">
</label>`:r.indexOf("custom-av")>-1?s=!0:r.indexOf("custom")>-1&&(a+=`<label class="b3-label b3-label--noborder">
     <div class="fn__flex">
        <span class="fn__flex-1">${r.replace("custom-","")}</span>
        <span data-action="remove" class="block__icon block__icon--show"><svg><use xlink:href="#iconMin"></use></svg></span>
    </div>
    <div class="fn__hr"></div>
    <textarea style="resize: vertical;" spellcheck="false" class="b3-text-field fn__block" rows="1" data-name="${r}">${t[r]}</textarea>
</label>`))});const l=new we({width:W()?"92vw":"50vw",containerClassName:"b3-dialog__container--theme",height:"80vh",content:`<div class="fn__flex-column">
    <div class="layout-tab-bar fn__flex" style="flex-shrink:0;border-radius: var(--b3-border-radius-b) var(--b3-border-radius-b) 0 0">
        <div class="item item--full item--focus" data-type="attr">
            <span class="fn__flex-1"></span>
            <span class="item__text">${window.siyuan.languages.builtIn}</span>
            <span class="fn__flex-1"></span>
        </div>
        <div class="item item--full${s?"":" fn__none"}" data-type="NodeAttributeView">
            <span class="fn__flex-1"></span>
            <span class="item__text">${window.siyuan.languages.database}</span>
            <span class="fn__flex-1"></span>
        </div>
        <div class="item item--full" data-type="custom">
            <span class="fn__flex-1"></span>
            <span class="item__text">${window.siyuan.languages.custom}</span>
            <span class="fn__flex-1"></span>
        </div>
    </div>
    <div class="fn__flex-1">
        <div class="custom-attr" data-type="attr">
            <label class="b3-label b3-label--noborder">
                <div class="fn__flex">
                    <span class="fn__flex-1">${window.siyuan.languages.bookmark}</span>
                    <span data-action="bookmark" class="block__icon block__icon--show"><svg><use xlink:href="#iconDown"></use></svg></span>
                </div>
                <div class="fn__hr"></div>
                <input spellcheck="${window.siyuan.config.editor.spellcheck}" class="b3-text-field fn__block" placeholder="${window.siyuan.languages.attrBookmarkTip}" data-name="bookmark">
            </label>
            <label class="b3-label b3-label--noborder">
                ${window.siyuan.languages.name}
                <div class="fn__hr"></div>
                <input spellcheck="${window.siyuan.config.editor.spellcheck}" class="b3-text-field fn__block" placeholder="${window.siyuan.languages.attrNameTip}" data-name="name">
            </label>
            <label class="b3-label b3-label--noborder">
                ${window.siyuan.languages.alias}
                <div class="fn__hr"></div>
                <input spellcheck="${window.siyuan.config.editor.spellcheck}" class="b3-text-field fn__block" placeholder="${window.siyuan.languages.attrAliasTip}" data-name="alias">
            </label>
            <label class="b3-label b3-label--noborder">
                ${window.siyuan.languages.memo}
                <div class="fn__hr"></div>
                <textarea style="resize: vertical" spellcheck="${window.siyuan.config.editor.spellcheck}" class="b3-text-field fn__block" placeholder="${window.siyuan.languages.attrMemoTip}" rows="2" data-name="memo">${t.memo||""}</textarea>
            </label>
            ${i}
        </div>
        <div data-type="NodeAttributeView" class="fn__none custom-attr"></div>
        <div data-type="custom" class="fn__none custom-attr">
           ${a}
           <div class="b3-label">
               <button data-action="addCustom" class="b3-button b3-button--cancel">
                   <svg><use xlink:href="#iconAdd"></use></svg>${window.siyuan.languages.addAttr}
               </button>
           </div>
        </div>
    </div>
</div>`,destroyCallback(){Z(o),Q(["select"],n)}});l.element.setAttribute("data-key",u.DIALOG_ATTR),l.element.querySelector('.b3-text-field[data-name="bookmark"]').value=t.bookmark||"",l.element.querySelector('.b3-text-field[data-name="name"]').value=t.name||"",l.element.querySelector('.b3-text-field[data-name="alias"]').value=t.alias||"",l.element.addEventListener("click",r=>{let d=r.target;for(typeof r.detail=="string"&&(d=l.element.querySelector('.item--full[data-type="NodeAttributeView"]'));!d.isSameNode(l.element);){const c=d.dataset.action;if(d.classList.contains("item--full"))d.parentElement.querySelector(".item--focus").classList.remove("item--focus"),d.classList.add("item--focus"),l.element.querySelectorAll(".custom-attr").forEach(f=>{f.dataset.type===d.dataset.type?(f.dataset.type==="NodeAttributeView"&&f.innerHTML===""&&ym(f,t.id,n),f.classList.remove("fn__none")):f.classList.add("fn__none")});else if(c==="remove"){E("/api/attr/setBlockAttrs",{id:t.id,attrs:{["custom-"+d.previousElementSibling.textContent]:""}}),d.parentElement.parentElement.remove(),r.stopPropagation(),r.preventDefault();break}else if(c==="bookmark"){E("/api/attr/getBookmarkLabels",{},f=>{window.siyuan.menus.menu.remove(),f.data.length===0?window.siyuan.menus.menu.append(new T({id:"emptyContent",iconHTML:"",label:window.siyuan.languages.emptyContent,type:"readonly"}).element):f.data.forEach(g=>{window.siyuan.menus.menu.append(new T({label:g,click(){const p=d.parentElement.parentElement.querySelector("input");p.value=g,p.dispatchEvent(new CustomEvent("change"))}}).element)}),window.siyuan.menus.menu.element.classList.add("b3-menu--list"),window.siyuan.menus.menu.popup({x:r.clientX,y:r.clientY+16,w:16})}),r.stopPropagation(),r.preventDefault();break}else if(c==="addCustom"){const f=new we({title:window.siyuan.languages.attrName,content:`<div class="b3-dialog__content"><input spellcheck="false" class="b3-text-field fn__block" value=""></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:W()?"92vw":"520px"});f.element.setAttribute("data-key",u.DIALOG_SETCUSTOMATTR);const g=f.element.querySelector("input"),p=f.element.querySelectorAll(".b3-button");f.bindInput(g,()=>{p[1].click()}),g.focus(),g.select(),p[0].addEventListener("click",()=>{f.destroy()}),p[1].addEventListener("click",()=>{if(!Vr(g.value))return j(window.siyuan.languages.attrName+" <b>"+pe(g.value)+"</b> "+window.siyuan.languages.invalid),!1;d.parentElement.insertAdjacentHTML("beforebegin",`<div class="b3-label b3-label--noborder">
    <div class="fn__flex">
        <span class="fn__flex-1">${g.value}</span>
        <span data-action="remove" class="block__icon block__icon--show"><svg><use xlink:href="#iconMin"></use></svg></span>
    </div>
    <div class="fn__hr"></div>
    <textarea style="resize: vertical" spellcheck="false" data-name="custom-${g.value}" class="b3-text-field fn__block" rows="1" placeholder="${window.siyuan.languages.attrValue1}"></textarea>
</div>`);const h=d.parentElement.previousElementSibling.querySelector(".b3-text-field");h.focus(),R_(h,t.id),f.destroy()}),r.stopPropagation(),r.preventDefault();break}d=d.parentElement}}),l.element.querySelectorAll(".b3-text-field").forEach(r=>{e!=="av"&&e===r.getAttribute("data-name")&&r.focus(),R_(r,t.id)}),e==="av"&&l.element.dispatchEvent(new CustomEvent("click",{detail:"av"}))},Ti=(t,e="bookmark",n)=>{if(t.getAttribute("data-type")==="NodeThematicBreak")return;const a=t.getAttribute("data-node-id");E("/api/attr/getBlockAttrs",{id:a},i=>{Gn(i.data,e,n)})},ls=(t,e=!0,n)=>[{id:"copyBlockRef",iconHTML:"",accelerator:e?window.siyuan.config.keymap.editor.general.copyBlockRef.custom:void 0,label:window.siyuan.languages.copyBlockRef,click:()=>{$t(t,"ref"),n&&ae(n)}},{id:"copyBlockEmbed",iconHTML:"",label:window.siyuan.languages.copyBlockEmbed,accelerator:e?window.siyuan.config.keymap.editor.general.copyBlockEmbed.custom:void 0,click:()=>{$t(t,"blockEmbed"),n&&ae(n)}},{id:"copyProtocol",iconHTML:"",label:window.siyuan.languages.copyProtocol,accelerator:e?window.siyuan.config.keymap.editor.general.copyProtocol.custom:void 0,click:()=>{$t(t,"protocol"),n&&ae(n)}},{id:"copyProtocolInMd",iconHTML:"",label:window.siyuan.languages.copyProtocolInMd,accelerator:e?window.siyuan.config.keymap.editor.general.copyProtocolInMd.custom:void 0,click:()=>{$t(t,"protocolMd"),n&&ae(n)}},{id:"copyHPath",iconHTML:"",label:window.siyuan.languages.copyHPath,accelerator:e?window.siyuan.config.keymap.editor.general.copyHPath.custom:void 0,click:()=>{$t(t,"hPath"),n&&ae(n)}},{id:"copyID",iconHTML:"",label:window.siyuan.languages.copyID,accelerator:e?window.siyuan.config.keymap.editor.general.copyID.custom:void 0,click:()=>{$t(t,"id"),n&&ae(n)}}],O_=t=>{if(!window.siyuan.isPublish)return new T({id:"export",label:window.siyuan.languages.export,type:"submenu",icon:"iconUpload",submenu:[{id:"exportTemplate",label:window.siyuan.languages.template,iconClass:"ft__error",icon:"iconMarkdown",click:async()=>{const e=await Re("/api/block/getRefText",{id:t}),n=new we({title:window.siyuan.languages.fileName,content:`<div class="b3-dialog__content"><input class="b3-text-field fn__block" value=""></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:W()?"92vw":"520px"});n.element.setAttribute("data-key",u.DIALOG_EXPORTTEMPLATE);const a=n.element.querySelector("input"),i=n.element.querySelectorAll(".b3-button");n.bindInput(a,()=>{i[1].click()});let s=On(e.data);const o=32;s.length>o&&(s=s.substring(0,o)),a.value=s,a.focus(),a.select(),i[0].addEventListener("click",()=>{n.destroy()}),i[1].addEventListener("click",()=>{a.value.trim()===""?a.value=window.siyuan.languages.untitled:a.value=On(a.value),s.length>o&&(s=s.substring(0,o)),E("/api/template/docSaveAsTemplate",{id:t,name:a.value,overwrite:!1},l=>{if(l.code===1){xe(window.siyuan.languages.export,window.siyuan.languages.exportTplTip,()=>{E("/api/template/docSaveAsTemplate",{id:t,name:a.value,overwrite:!0},r=>{r.code===0&&j(window.siyuan.languages.exportTplSucc)})});return}j(window.siyuan.languages.exportTplSucc)}),n.destroy()})}},{id:"exportMarkdown",label:"Markdown",icon:"iconMarkdown",click:()=>{const e=j(window.siyuan.languages.exporting,-1);E("/api/export/exportMd",{id:t},n=>{Ue(e),Ht(n.data.zip)})}},{id:"exportSiYuanZip",label:"SiYuan .sy.zip",icon:"iconSiYuan",click:()=>{const e=j(window.siyuan.languages.exporting,-1);E("/api/export/exportSY",{id:t},n=>{Ue(e),Ht(n.data.zip)})}},{id:"exportImage",label:window.siyuan.languages.image,icon:"iconImage",click:()=>{oL(t)}},{id:"exportPDF",label:"PDF",icon:"iconPDF",click:()=>{hf({type:"pdf",id:t})}},{id:"exportHTML_SiYuan",label:"HTML (SiYuan)",iconClass:"ft__error",icon:"iconHTML5",click:()=>{hf({type:"html",id:t})}},{id:"exportHTML_Markdown",label:"HTML (Markdown)",icon:"iconHTML5",click:()=>{hf({type:"htmlmd",id:t})}},{id:"exportWord",label:"Word .docx",icon:"iconExact",click:()=>{hf({type:"word",id:t})}},{id:"exportMore",label:window.siyuan.languages.more,icon:"iconMore",type:"submenu",submenu:[{id:"exportReStructuredText",label:"reStructuredText",click:()=>{const e=j(window.siyuan.languages.exporting,-1);E("/api/export/exportReStructuredText",{id:t},n=>{Ue(e),Ht(n.data.zip)})}},{id:"exportAsciiDoc",label:"AsciiDoc",click:()=>{const e=j(window.siyuan.languages.exporting,-1);E("/api/export/exportAsciiDoc",{id:t},n=>{Ue(e),Ht(n.data.zip)})}},{id:"exportTextile",label:"Textile",click:()=>{const e=j(window.siyuan.languages.exporting,-1);E("/api/export/exportTextile",{id:t},n=>{Ue(e),Ht(n.data.zip)})}},{id:"exportOPML",label:"OPML",click:()=>{const e=j(window.siyuan.languages.exporting,-1);E("/api/export/exportOPML",{id:t},n=>{Ue(e),Ht(n.data.zip)})}},{id:"exportOrgMode",label:"Org-Mode",click:()=>{const e=j(window.siyuan.languages.exporting,-1);E("/api/export/exportOrgMode",{id:t},n=>{Ue(e),Ht(n.data.zip)})}},{id:"exportMediaWiki",label:"MediaWiki",click:()=>{const e=j(window.siyuan.languages.exporting,-1);E("/api/export/exportMediaWiki",{id:t},n=>{Ue(e),Ht(n.data.zip)})}},{id:"exportODT",label:"ODT",click:()=>{const e=j(window.siyuan.languages.exporting,-1);E("/api/export/exportODT",{id:t},n=>{Ue(e),Ht(n.data.zip)})}},{id:"exportRTF",label:"RTF",click:()=>{const e=j(window.siyuan.languages.exporting,-1);E("/api/export/exportRTF",{id:t},n=>{Ue(e),Ht(n.data.zip)})}},{id:"exportEPUB",label:"EPUB",click:()=>{const e=j(window.siyuan.languages.exporting,-1);E("/api/export/exportEPUB",{id:t},n=>{Ue(e),Ht(n.data.zip)})}}]}]}).element},vc=(t,e,n,a)=>{const i=[];if(Qs(e)?u.SIYUAN_ASSETS_EXTS.includes(Ee().extname(e))&&(!e.endsWith(".pdf")||e.endsWith(".pdf")&&!e.startsWith("file://"))?(i.push({id:"insertRight",icon:"iconLayoutRight",label:window.siyuan.languages.insertRight,accelerator:a?window.siyuan.languages.click:"",click(){Ul(t,e.trim(),parseInt(It("page",e)),"right")}}),i.push({id:"openBy",label:window.siyuan.languages.openBy,icon:"iconOpen",accelerator:a?"\u2325"+window.siyuan.languages.click:"",click(){Ul(t,e.trim(),parseInt(It("page",e)))}}),i.push({id:"openByNewWindow",label:window.siyuan.languages.openByNewWindow,icon:"iconOpenWindow",click(){ZS(e.trim())}}),i.push({id:"showInFolder",icon:"iconFolder",label:window.siyuan.languages.showInFolder,accelerator:a?"\u2318"+window.siyuan.languages.click:"",click:()=>{ea(e,"folder")}}),i.push({id:"useDefault",label:window.siyuan.languages.useDefault,accelerator:a?"\u21E7"+window.siyuan.languages.click:"",click(){ea(e,"app")}})):(i.push({id:"useDefault",label:window.siyuan.languages.useDefault,accelerator:a?window.siyuan.languages.click:"",click(){ea(e,"app")}}),i.push({id:"showInFolder",icon:"iconFolder",label:window.siyuan.languages.showInFolder,accelerator:a?"\u2318"+window.siyuan.languages.click:"",click:()=>{ea(e,"folder")}})):e&&(0>e.indexOf(":")&&(e=`https://${e}`),i.push({id:"useDefault",label:window.siyuan.languages.useDefault,accelerator:a?window.siyuan.languages.click:"",click:()=>{ee.shell.openExternal(e).catch(s=>{j(s)})}})),n)return i;window.siyuan.menus.menu.append(new T({id:"openBy",label:window.siyuan.languages.openBy,icon:"iconOpen",submenu:i}).element)},B_=t=>new T({id:"rename",accelerator:window.siyuan.config.keymap.editor.general.rename.custom,icon:"iconEdit",label:window.siyuan.languages.rename,click:()=>{Th(t)}}).element,wm=t=>new T({id:"move",label:window.siyuan.languages.move,icon:"iconMove",accelerator:window.siyuan.config.keymap.general.move.custom,click(){vi((e,n)=>{kh(t,n[0],e[0])},t)}}).element,Ut=t=>{t.menu.addItem({iconHTML:"",label:_m(t.operator,!!t.data),click(){if(!t.data)U(t.protyle,[{action:"setAttrViewColCalc",avID:t.avId,id:t.colId,data:{operator:t.operator},blockID:t.blockID}],[{action:"setAttrViewColCalc",avID:t.avId,id:t.colId,data:{operator:t.oldOperator},blockID:t.blockID}]);else{t.target.querySelector(".b3-menu__accelerator").textContent=_m(t.operator,!0);const e=t.data.view.columns.find(n=>{if(n.id===t.colId)return n.rollup||(n.rollup={}),!0});e.rollup.calc={operator:t.operator},U(t.protyle,[{action:"updateAttrViewColRollup",id:t.colId,avID:t.avId,parentID:e.rollup.relationKeyID,keyID:e.rollup.keyID,data:{calc:e.rollup.calc}}],[{action:"updateAttrViewColRollup",id:t.colId,avID:t.avId,parentID:e.rollup.relationKeyID,keyID:e.rollup.keyID,data:{calc:{operator:t.oldOperator}}}])}}})},q_=async(t,e,n,a)=>{let i,s,o,l,r,d;if(n)l=n.data.id,s=e.dataset.colType,r=e.dataset.calc,o=n.colId,d=n.blockID;else{const p=P(e);if(!p||(i=L(e,"av__row--footer"),!i))return;i.classList.add("av__row--show"),s=e.dataset.dtype,o=e.dataset.colId,l=p.dataset.avId,r=e.dataset.operator,d=p.dataset.nodeId}if(s==="lineNumber")return;const c=new st("av-calc",()=>{i&&i.classList.remove("av__row--show")});if(c.isOpen)return;Ut({menu:c,protyle:t,colId:o,avId:l,oldOperator:r,operator:"",data:n?.data,blockID:d,target:e}),Ut({menu:c,protyle:t,colId:o,avId:l,oldOperator:r,operator:"Count all",data:n?.data,blockID:d,target:e}),s!=="checkbox"?(Ut({menu:c,protyle:t,colId:o,avId:l,oldOperator:r,operator:"Count empty",data:n?.data,blockID:d,target:e}),Ut({menu:c,protyle:t,colId:o,avId:l,oldOperator:r,operator:"Count not empty",data:n?.data,blockID:d,target:e}),Ut({menu:c,protyle:t,colId:o,avId:l,oldOperator:r,operator:"Count values",data:n?.data,blockID:d,target:e}),Ut({menu:c,protyle:t,colId:o,avId:l,oldOperator:r,operator:"Count unique values",data:n?.data,blockID:d,target:e}),Ut({menu:c,protyle:t,colId:o,avId:l,oldOperator:r,operator:"Percent empty",data:n?.data,blockID:d,target:e}),Ut({menu:c,protyle:t,colId:o,avId:l,oldOperator:r,operator:"Percent not empty",data:n?.data,blockID:d,target:e}),Ut({menu:c,protyle:t,colId:o,avId:l,oldOperator:r,operator:"Percent unique values",data:n?.data,blockID:d,target:e})):(Ut({menu:c,protyle:t,colId:o,avId:l,oldOperator:r,operator:"Checked",data:n?.data,blockID:d,target:e}),Ut({menu:c,protyle:t,colId:o,avId:l,oldOperator:r,operator:"Unchecked",data:n?.data,blockID:d,target:e}),Ut({menu:c,protyle:t,colId:o,avId:l,oldOperator:r,operator:"Percent checked",data:n?.data,blockID:d,target:e}),Ut({menu:c,protyle:t,colId:o,avId:l,oldOperator:r,operator:"Percent unchecked",data:n?.data,blockID:d,target:e}));let f=!1;if(s==="rollup"){let p,h,m=n?.data;if(m||(m=(await Re("api/av/renderAttributeView",{id:l})).data),m.view.columns.find(b=>{if(b.id===o)return p=b.rollup?.relationKeyID,h=b.rollup?.keyID,!0}),p&&h){let b;m.view.columns.find(y=>{if(y.id===p)return b=y.relation?.avID,!0}),b&&(await Re("api/av/getAttributeView",{id:b})).data.av.keyValues.find(w=>{if(w.key.id===h)return f=w.key.type==="number",!0})}}["number","template"].includes(s)||f?(Ut({menu:c,protyle:t,colId:o,avId:l,oldOperator:r,operator:"Sum",data:n?.data,blockID:d,target:e}),Ut({menu:c,protyle:t,colId:o,avId:l,oldOperator:r,operator:"Average",data:n?.data,blockID:d,target:e}),Ut({menu:c,protyle:t,colId:o,avId:l,oldOperator:r,operator:"Median",data:n?.data,blockID:d,target:e}),Ut({menu:c,protyle:t,colId:o,avId:l,oldOperator:r,operator:"Min",data:n?.data,blockID:d,target:e}),Ut({menu:c,protyle:t,colId:o,avId:l,oldOperator:r,operator:"Max",data:n?.data,blockID:d,target:e}),Ut({menu:c,protyle:t,colId:o,avId:l,oldOperator:r,operator:"Range",data:n?.data,blockID:d,target:e})):["date","created","updated"].includes(s)&&(Ut({menu:c,protyle:t,colId:o,avId:l,oldOperator:r,operator:"Earliest",data:n?.data,blockID:d,target:e}),Ut({menu:c,protyle:t,colId:o,avId:l,oldOperator:r,operator:"Latest",data:n?.data,blockID:d,target:e}),Ut({menu:c,protyle:t,colId:o,avId:l,oldOperator:r,operator:"Range",data:n?.data,blockID:d,target:e}));const g=e.getBoundingClientRect();c.open({x:Math.max(a||0,g.left),y:g.bottom,h:g.height})},wx=t=>{if(!t.calc||!t.calc.result)return"";let e=t.calc.result.number;(t.calc.operator==="Earliest"||t.calc.operator==="Latest"||t.calc.operator==="Range"&&["date","created","updated"].includes(t.type))&&(e=t.calc.result[t.type]);let n="";switch(t.calc.operator){case"Count all":n=`<span>${e.formattedContent}</span><small>${window.siyuan.languages.calcResultCountAll}</small>`;break;case"Count values":n=`<span>${e.formattedContent}</span><small>${window.siyuan.languages.calcResultCountValues}</small>`;break;case"Count unique values":n=`<span>${e.formattedContent}</span><small>${window.siyuan.languages.calcResultCountUniqueValues}</small>`;break;case"Count empty":n=`<span>${e.formattedContent}</span><small>${window.siyuan.languages.calcResultCountEmpty}</small>`;break;case"Count not empty":n=`<span>${e.formattedContent}</span><small>${window.siyuan.languages.calcResultCountNotEmpty}</small>`;break;case"Percent empty":n=`<span>${e.formattedContent}</span><small>${window.siyuan.languages.calcResultPercentEmpty}</small>`;break;case"Percent not empty":n=`<span>${e.formattedContent}</span><small>${window.siyuan.languages.calcResultPercentNotEmpty}</small>`;break;case"Percent unique values":n=`<span>${e.formattedContent}</span><small>${window.siyuan.languages.calcResultPercentUniqueValues}</small>`;break;case"Sum":n=`<span>${e.formattedContent}</span><small>${window.siyuan.languages.calcResultSum}</small>`;break;case"Average":n=`<span>${e.formattedContent}</span><small>${window.siyuan.languages.calcResultAverage}</small>`;break;case"Median":n=`<span>${e.formattedContent}</span><small>${window.siyuan.languages.calcResultMedian}</small>`;break;case"Min":n=`<span>${e.formattedContent}</span><small>${window.siyuan.languages.calcResultMin}</small>`;break;case"Max":n=`<span>${e.formattedContent}</span><small>${window.siyuan.languages.calcResultMax}</small>`;break;case"Range":n=`<span>${e.formattedContent}</span><small>${window.siyuan.languages.calcResultRange}</small>`;break;case"Earliest":n=`<span>${e.formattedContent}</span><small>${window.siyuan.languages.calcOperatorEarliest}</small>`;break;case"Latest":n=`<span>${e.formattedContent}</span><small>${window.siyuan.languages.calcOperatorLatest}</small>`;break;case"Checked":n=`<span>${e.formattedContent}</span><small>${window.siyuan.languages.checked}</small>`;break;case"Unchecked":n=`<span>${e.formattedContent}</span><small>${window.siyuan.languages.unchecked}</small>`;break;case"Percent checked":n=`<span>${e.formattedContent}</span><small>${window.siyuan.languages.percentChecked}</small>`;break;case"Percent unchecked":n=`<span>${e.formattedContent}</span><small>${window.siyuan.languages.percentUnchecked}</small>`;break}return n},_m=(t,e)=>{switch(t){case void 0:case"":return e?window.siyuan.languages.original:window.siyuan.languages.calcOperatorNone;case"Count all":return window.siyuan.languages.calcOperatorCountAll;case"Count values":return window.siyuan.languages.calcOperatorCountValues;case"Count unique values":return window.siyuan.languages.calcOperatorCountUniqueValues;case"Count empty":return window.siyuan.languages.calcOperatorCountEmpty;case"Count not empty":return window.siyuan.languages.calcOperatorCountNotEmpty;case"Percent empty":return window.siyuan.languages.calcOperatorPercentEmpty;case"Percent not empty":return window.siyuan.languages.calcOperatorPercentNotEmpty;case"Percent unique values":return window.siyuan.languages.calcOperatorPercentUniqueValues;case"Checked":return window.siyuan.languages.checked;case"Unchecked":return window.siyuan.languages.unchecked;case"Percent checked":return window.siyuan.languages.percentChecked;case"Percent unchecked":return window.siyuan.languages.percentUnchecked;case"Sum":return window.siyuan.languages.calcOperatorSum;case"Average":return window.siyuan.languages.calcOperatorAverage;case"Median":return window.siyuan.languages.calcOperatorMedian;case"Min":return window.siyuan.languages.calcOperatorMin;case"Max":return window.siyuan.languages.calcOperatorMax;case"Range":return window.siyuan.languages.calcOperatorRange;case"Earliest":return window.siyuan.languages.calcOperatorEarliest;case"Latest":return window.siyuan.languages.calcOperatorLatest;default:return""}},Ec=t=>{if(t.protyle.disabled)return;const e=new st("av-view");if(e.isOpen)return;e.addItem({id:"rename",icon:"iconEdit",label:window.siyuan.languages.rename,click(){document.querySelector(".av__panel")?.remove(),hn({protyle:t.protyle,blockElement:t.blockElement,type:"config",cb:a=>{a.querySelector('.b3-text-field[data-type="name"]').focus()}})}}),e.addItem({id:"config",icon:"iconSettings",label:window.siyuan.languages.config,click(){document.querySelector(".av__panel")?.remove(),hn({protyle:t.protyle,blockElement:t.blockElement,type:"config"})}}),e.addSeparator(),e.addItem({id:"duplicate",icon:"iconCopy",label:window.siyuan.languages.duplicate,click(){document.querySelector(".av__panel")?.remove();const a=Lute.NewNodeID();U(t.protyle,[{action:"duplicateAttrViewView",avID:t.blockElement.dataset.avId,previousID:t.element.dataset.id,id:a,blockID:t.blockElement.dataset.nodeId}],[{action:"removeAttrViewView",avID:t.blockElement.dataset.avId,id:a,blockID:t.blockElement.dataset.nodeId}]),t.blockElement.setAttribute(u.CUSTOM_SY_AV_VIEW,a)}}),t.blockElement.querySelectorAll(".layout-tab-bar .item").length>1&&e.addItem({id:"delete",icon:"iconTrashcan",label:window.siyuan.languages.delete,click(){document.querySelector(".av__panel")?.remove(),U(t.protyle,[{action:"removeAttrViewView",avID:t.blockElement.dataset.avId,id:t.element.dataset.id,blockID:t.blockElement.dataset.nodeId}])}});const n=t.element.getBoundingClientRect();e.open({x:n.left,y:n.bottom})},F_=t=>{const e=t.menuElement.querySelector('.b3-text-field[data-type="name"]');e.addEventListener("blur",()=>{e.value!==e.dataset.value&&(U(t.protyle,[{action:"setAttrViewViewName",avID:t.data.id,id:t.data.viewID,data:e.value}],[{action:"setAttrViewViewName",avID:t.data.id,id:t.data.viewID,data:e.dataset.value}]),e.dataset.value=e.value)}),e.addEventListener("keydown",i=>{i.isComposing||i.key==="Enter"&&(i.preventDefault(),e.blur(),t.menuElement.parentElement.remove())}),e.select(),e.value=e.dataset.value;const n=t.menuElement.querySelector('.b3-text-field[data-type="desc"]');e.nextElementSibling.addEventListener("click",()=>{const i=n.parentElement;i.classList.toggle("fn__none"),i.classList.contains("fn__none")||n.focus()}),n.addEventListener("blur",()=>{n.value!==n.dataset.value&&(U(t.protyle,[{action:"setAttrViewViewDesc",avID:t.data.id,id:t.data.viewID,data:n.value}],[{action:"setAttrViewViewDesc",avID:t.data.id,id:t.data.viewID,data:n.dataset.value}]),n.dataset.value=n.value)}),n.addEventListener("keydown",i=>{i.isComposing||i.key==="Enter"&&(i.preventDefault(),n.blur(),t.menuElement.parentElement.remove())}),n.addEventListener("input",()=>{e.nextElementSibling.setAttribute("aria-label",n.value?pe(n.value):window.siyuan.languages.addDesc)});const a=t.menuElement.querySelector('.b3-switch[data-type="toggle-view-title"]');a.addEventListener("change",()=>{const i=t.blockElement.getAttribute("data-av-id"),s=t.blockElement.getAttribute("data-node-id");a.checked?(U(t.protyle,[{action:"hideAttrViewName",avID:i,blockID:s,data:!1}],[{action:"hideAttrViewName",avID:i,blockID:s,data:!0}]),t.blockElement.querySelector(".av__title").classList.remove("fn__none")):(U(t.protyle,[{action:"hideAttrViewName",avID:i,blockID:s,data:!0}],[{action:"hideAttrViewName",avID:i,blockID:s,data:!1}]),t.blockElement.querySelector(".av__title").classList.add("fn__none"))})},U_=t=>{const e=t.view;return`<div class="b3-menu__items">
<button class="b3-menu__item" data-type="nobg">
    <span class="b3-menu__label ft__center">${window.siyuan.languages.config}</span>
</button>
<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="nobg">
    <div class="fn__block">
        <div class="fn__flex">
            <span class="b3-menu__avemoji" data-type="update-view-icon">${e.icon?ge(e.icon):'<svg style="height: 14px;width: 14px"><use xlink:href="#iconTable"></use></svg>'}</span>
            <div class="b3-form__icona fn__block">
                <input data-type="name" class="b3-text-field b3-form__icona-input" type="text" data-value="${Xe(e.name)}">
                <svg data-position="north" class="b3-form__icona-icon ariaLabel" aria-label="${e.desc?Rt(e.desc):window.siyuan.languages.addDesc}"><use xlink:href="#iconInfo"></use></svg>
            </div>
        </div>
        <div class="fn__none">
            <div class="fn__hr"></div>
            <textarea style="margin-left: 22px;width: calc(100% - 22px);" placeholder="${window.siyuan.languages.addDesc}" rows="1" data-type="desc" class="b3-text-field fn__size200" type="text" data-value="${Xe(e.desc)}">${e.desc}</textarea>
        </div>
    </div>
</button>
<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="go-properties">
    <svg class="b3-menu__icon"></svg>
    <span class="b3-menu__label">${window.siyuan.languages.fields}</span>
    <span class="b3-menu__accelerator">${e.columns.filter(n=>!n.hidden).length}/${e.columns.length}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<button class="b3-menu__item" data-type="goFilters">
    <svg class="b3-menu__icon"><use xlink:href="#iconFilter"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.filter}</span>
    <span class="b3-menu__accelerator">${e.filters.length}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<button class="b3-menu__item" data-type="goSorts">
    <svg class="b3-menu__icon"><use xlink:href="#iconSort"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.sort}</span>
    <span class="b3-menu__accelerator">${e.sorts.length}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<button class="b3-menu__item" data-type="set-page-size" data-size="${e.pageSize}">
    <svg class="b3-menu__icon"></svg>
    <span class="b3-menu__label">${window.siyuan.languages.entryNum}</span>
    <span class="b3-menu__accelerator">${e.pageSize===u.SIZE_DATABASE_MAZ_SIZE?window.siyuan.languages.all:e.pageSize}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<label class="b3-menu__item">
    <svg class="b3-menu__icon"></svg>
    <span class="fn__flex-center">${window.siyuan.languages.showTitle}</span>
    <span class="fn__space fn__flex-1"></span>
    <input data-type="toggle-view-title" type="checkbox" class="b3-switch b3-switch--menu" ${e.hideAttrViewName?"":"checked"}>
</label>
<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="duplicate-view">
    <svg class="b3-menu__icon">
        <use xlink:href="#iconCopy"></use>
    </svg>
    <span class="b3-menu__label">${window.siyuan.languages.duplicate}</span>
</button>
<button class="b3-menu__item${t.views.length>1?"":" fn__none"}" data-type="delete-view">
    <svg class="b3-menu__icon"><use xlink:href="#iconTrashcan"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.delete}</span>
</button>
</div>`},_x=t=>{const e=t.menuElement.querySelector(".b3-text-field");e.focus(),e.addEventListener("keydown",n=>{if(n.stopPropagation(),!n.isComposing)if(xn(t.menuElement.querySelector(".fn__flex-1"),n,"b3-menu__item--current"),n.key==="Enter"){const a=t.menuElement.querySelector(".b3-menu__item--current");a&&(t.blockElement.removeAttribute("data-render"),dt(t.blockElement,t.protyle,void 0,a.dataset.id),t.menuElement.remove(),ae(t.blockElement))}else n.key==="Escape"&&(t.menuElement.remove(),ae(t.blockElement))}),e.addEventListener("input",n=>{n.isComposing||W_(t.menuElement)}),e.addEventListener("compositionend",()=>{W_(t.menuElement)})},W_=t=>{const n=t.querySelector(".b3-text-field").value;t.querySelectorAll('.b3-menu__item[draggable="true"]').forEach(a=>{!n||n.toLowerCase().indexOf(a.textContent.trim().toLowerCase())>-1||a.textContent.trim().toLowerCase().indexOf(n.toLowerCase())>-1?a.classList.remove("fn__none"):(a.classList.add("fn__none"),a.classList.remove("b3-menu__item--current"))}),t.querySelector(".b3-menu__item--current")||t.querySelector(".fn__flex-1 .b3-menu__item:not(.fn__none)")?.classList.add("b3-menu__item--current")},vx=(t,e)=>{let n="";return t.forEach(a=>{n+=`<button draggable="true" class="b3-menu__item${a.id===e?" b3-menu__item--current":""}" data-id="${a.id}">
    <svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>
    <div class="b3-menu__label fn__flex" data-type="av-view-switch">
        ${a.icon?ge(a.icon,"b3-menu__icon",!0):'<svg class="b3-menu__icon"><use xlink:href="#iconTable"></use></svg>'}
        <span class="fn__ellipsis">${a.name}</span>
    </div>
    <svg class="b3-menu__action" data-type="av-view-edit"><use xlink:href="#iconEdit"></use></svg>
</button>`}),`<div class="b3-menu__items fn__flex-column">
<button class="b3-menu__item" data-type="av-add">
    <svg class="b3-menu__icon"><use xlink:href="#iconAdd"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.newView}</span>
</button>
<button class="b3-menu__separator"></button>
<div class="b3-menu__item fn__flex-shrink" data-type="nobg">
    <input class="b3-text-field fn__block" type="text" style="margin: 4px 0" placeholder="${window.siyuan.languages.search}">
</div>
<div class="fn__flex-1" style="overflow: auto">
    ${n}
</div>
</div>`},Y_=(t,e)=>{const n=Lute.NewNodeID(),a=e.getAttribute("data-av-id");U(t,[{action:"addAttrViewView",avID:a,id:n,blockID:e.getAttribute("data-node-id")}],[{action:"removeAttrViewView",avID:a,id:n,blockID:e.getAttribute("data-node-id")}]),e.setAttribute(u.CUSTOM_SY_AV_VIEW,n)},Ex=(t,e)=>{if(Dt(e))return!1;const n=P(e.target);if(!n)return!1;if(B(e.target,"data-type","av-load-more")&&!B(e.target,"data-type","set-page-size"))return n.querySelector(".av__row--footer").style.transform="",n.removeAttribute("data-render"),n.dataset.pageSize=(parseInt(n.dataset.pageSize)+parseInt(n.querySelector('[data-type="set-page-size"]').getAttribute("data-size"))).toString(),dt(n,t),e.preventDefault(),e.stopPropagation(),!0;const i=L(e.target,"av__firstcol");if(i)return window.siyuan.menus.menu.remove(),Ha(i,"toggle"),e.preventDefault(),e.stopPropagation(),!0;const s=L(e.target,"av__cellassetimg");if(s)return _c(s.src),e.preventDefault(),e.stopPropagation(),!0;if(e.shiftKey){const c=L(e.target,"av__row");if(c&&!c.classList.contains("av__row--header"))return Ha(c.querySelector(".av__firstcol"),"toggle"),e.preventDefault(),e.stopPropagation(),!0}const o=B(e.target,"data-type","copy");if(o)return De(go(L(o,"av__cell"))),j(window.siyuan.languages.copied),e.preventDefault(),e.stopPropagation(),!0;if(B(e.target,"data-type","av-search-icon")){const c=n.querySelector('input[data-type="av-search"]');c.style.width="128px",c.style.paddingLeft="",c.style.paddingRight="";const f=L(c,"av__views");return f&&f.classList.add("av__views--show"),setTimeout(()=>{c.focus()},u.TIMEOUT_TRANSITION),e.preventDefault(),e.stopPropagation(),!0}const r=L(e.target,"item");if(r&&r.parentElement.classList.contains("layout-tab-bar"))return r.classList.contains("item--focus")?Ec({protyle:t,blockElement:n,element:r}):(n.removeAttribute("data-render"),dt(n,t,void 0,r.dataset.id)),e.preventDefault(),e.stopPropagation(),!0;if(t.disabled)return!1;let d=e.target;for(;d&&!d.isEqualNode(n);){const c=d.getAttribute("data-type");if(c==="av-header-add"){const f=Lc(t,n),g=d.getBoundingClientRect();return f.open({x:g.left,y:g.bottom,h:g.height}),e.preventDefault(),e.stopPropagation(),!0}else{if(c==="av-header-more")return hn({protyle:t,blockElement:n,type:"properties"}),e.preventDefault(),e.stopPropagation(),!0;if(c==="av-add-more")return Al(n,t,1,void 0),e.preventDefault(),e.stopPropagation(),!0;if(c==="av-more")return hn({protyle:t,blockElement:n,type:"config"}),e.preventDefault(),e.stopPropagation(),!0;if(c==="av-switcher")return hn({protyle:t,blockElement:n,type:"switcher"}),e.preventDefault(),e.stopPropagation(),!0;if(c==="av-sort")return hn({protyle:t,blockElement:n,type:"sorts"}),e.preventDefault(),e.stopPropagation(),!0;if(c==="av-filter")return hn({protyle:t,blockElement:n,type:"filters"}),e.preventDefault(),e.stopPropagation(),!0;if(c==="av-add")return Y_(t,n),e.preventDefault(),e.stopPropagation(),!0;if(c==="block-more")return window.siyuan.menus.menu.remove(),t.toolbar.range=document.createRange(),t.toolbar.range.selectNodeContents(d),Z(t.toolbar.range),d.parentElement.classList.add("av__cell--select"),In(d.parentElement),ss(d.previousElementSibling.textContent.trim(),t,"av"),e.preventDefault(),e.stopPropagation(),!0;if(c==="set-page-size")return k_({target:d,protyle:t,avID:n.getAttribute("data-av-id"),nodeElement:n}),e.preventDefault(),e.stopPropagation(),!0;if(c==="av-add-bottom")return Al(n,t,1,n.querySelector(".av__row--util").previousElementSibling.getAttribute("data-id")||""),e.preventDefault(),e.stopPropagation(),!0;if(d.classList.contains("av__cell--header"))return ov(t,n,d),e.preventDefault(),e.stopPropagation(),!0;if(d.classList.contains("av__cell")){if(!L(d,"av__row--header")){const f=L(d,"av__scroll");if(!f||d.querySelector(".av__pulse"))return;const g=L(d,"av__row");if(!g)return;const p=vn(d);p==="updated"||p==="created"||p==="lineNumber"?Ha(g.querySelector(".av__firstcol"),"toggle"):(f.querySelectorAll(".av__row--select").forEach(h=>{h.querySelector(".av__firstcol use").setAttribute("xlink:href","#iconUncheck"),h.classList.remove("av__row--select")}),as(g),Kn(t,[d]))}return e.preventDefault(),e.stopPropagation(),!0}else{if(d.classList.contains("av__calc"))return q_(t,d,void 0,e.clientX-64),e.preventDefault(),e.stopPropagation(),!0;if(d.classList.contains("b3-menu__avemoji")){const f=d.getBoundingClientRect();return Za(d.parentElement.getAttribute("data-block-id"),"doc",{x:f.left,y:f.bottom,h:f.height,w:f.width},g=>{d.innerHTML=ge(g||window.siyuan.storage[u.LOCAL_IMAGES].file)},d.querySelector("img")),e.preventDefault(),e.stopPropagation(),!0}}}d=d.parentElement}return!1},Zf=(t,e,n)=>{if(Q(["hint"],t),e.classList.contains("av__row--header"))return!1;const a=P(e);if(!a)return!1;a.querySelectorAll(".av__cell--select, .av__cell--active").forEach(c=>{c.classList.remove("av__cell--select","av__cell--active"),c.querySelector(".av__drag-fill")?.remove()}),e.classList.contains("av__row--select")||(a.querySelectorAll(".av__row--select").forEach(c=>{c.classList.remove("av__row--select")}),a.querySelectorAll(".av__firstcol use").forEach(c=>{c.setAttribute("xlink:href","#iconUncheck")}));const i=new st;e.classList.add("av__row--select"),e.querySelector(".av__firstcol use").setAttribute("xlink:href","#iconCheck");const s=a.querySelectorAll(".av__row--select:not(.av__row--header)");as(e);const o=s[0].querySelector(".av__cell[data-block-id]"),l=Array.from(s).map(c=>c.getAttribute("data-id"));if(s.length===1&&o.getAttribute("data-detached")!=="true"){const c=l[0],f=Ah(t.app,[c],void 0,void 0,!0);f.push({id:"separator_3",type:"separator"}),f.push({id:"attr",icon:"iconAttr",label:window.siyuan.languages.attr,click:()=>{E("/api/attr/getBlockAttrs",{id:c},g=>{Gn(g.data,"av",t)})}}),i.addItem({id:"openBy",label:window.siyuan.languages.openBy,icon:"iconOpen",submenu:f})}let r=!1;s.forEach(c=>{c.querySelector('.av__cell[data-dtype="block"]').getAttribute("data-detached")!=="true"&&(r=!0)});const d=[{id:"copyKeyContent",iconHTML:"",label:window.siyuan.languages.copyKeyContent,click(){let c="";s.forEach((f,g)=>{s.length>1&&(c+="* "),c+=f.querySelector('.av__cell[data-dtype="block"] .av__celltext').textContent.trim(),l.length>1&&g!==l.length-1&&(c+=`
`)}),De(c)}}];if(r&&d.splice(1,0,{id:"copyBlockRef",iconHTML:"",label:window.siyuan.languages.copyBlockRef,click:()=>{let c="";for(let f=0;f<l.length;f++){const g=l[f];let p="";const h=s[f].querySelector(".av__cell[data-dtype='block']");h.getAttribute("data-detached")==="true"?p=h.querySelector(".av__celltext").textContent:p=`((${g} '${h.querySelector(".av__celltext").textContent.replace(/[\n]+/g," ")}'))`,l.length>1&&(c+="* "),c+=p,l.length>1&&f!==l.length-1&&(c+=`
`)}De(c)}},{id:"copyBlockEmbed",iconHTML:"",label:window.siyuan.languages.copyBlockEmbed,click:()=>{let c="";l.forEach((f,g)=>{l.length>1&&(c+="* ");const p=s[g].querySelector(".av__cell[data-dtype='block']");p.getAttribute("data-detached")==="true"?c+=p.querySelector(".av__celltext").textContent:c+=`{{select * from blocks where id='${f}'}}`,l.length>1&&g!==l.length-1&&(c+=`
`)}),De(c)}},{id:"copyProtocol",iconHTML:"",label:window.siyuan.languages.copyProtocol,click:()=>{let c="";l.forEach((f,g)=>{l.length>1&&(c+="* ");const p=s[g].querySelector(".av__cell[data-dtype='block']");p.getAttribute("data-detached")==="true"?c+=p.querySelector(".av__celltext").textContent:c+=`siyuan://blocks/${f}`,l.length>1&&g!==l.length-1&&(c+=`
`)}),De(c)}},{id:"copyProtocolInMd",iconHTML:"",label:window.siyuan.languages.copyProtocolInMd,click:()=>{let c="";for(let f=0;f<l.length;f++){const g=l[f];let p="";const h=s[f].querySelector(".av__cell[data-dtype='block']");h.getAttribute("data-detached")==="true"?p=h.querySelector(".av__celltext").textContent:p=`[${h.querySelector(".av__celltext").textContent.replace(/[\n]+/g," ")}](siyuan://blocks/${g})`,l.length>1&&(c+="* "),c+=p,l.length>1&&f!==l.length-1&&(c+=`
`)}De(c)}},{id:"copyHPath",iconHTML:"",label:window.siyuan.languages.copyHPath,click:async()=>{let c="";for(let f=0;f<l.length;f++){const g=l[f];let p="";const h=s[f].querySelector(".av__cell[data-dtype='block']");h.getAttribute("data-detached")==="true"?p=h.querySelector(".av__celltext").textContent:p=(await Re("/api/filetree/getHPathByID",{id:g})).data,l.length>1&&(c+="* "),c+=p,l.length>1&&f!==l.length-1&&(c+=`
`)}De(c)}},{id:"copyID",iconHTML:"",label:window.siyuan.languages.copyID,click:()=>{let c="";l.forEach((f,g)=>{l.length>1&&(c+="* ");const p=s[g].querySelector(".av__cell[data-dtype='block']");p.getAttribute("data-detached")==="true"?c+=p.querySelector(".av__celltext").textContent:c+=f,l.length>1&&g!==l.length-1&&(c+=`
`)}),De(c)}}),i.addItem({id:"copy",label:window.siyuan.languages.copy,icon:"iconCopy",type:"submenu",submenu:d}),!t.disabled){i.addItem({id:"addToDatabase",label:window.siyuan.languages.addToDatabase,icon:"iconDatabase",click(){dc(a.getAttribute("data-av-id"),s[0],f=>{const g=[],p=[];s.forEach(m=>{const b=m.getAttribute("data-id"),y=ga("block",m.querySelector(".av__cell[data-block-id]"));g.push({content:y.block.content,id:b,isDetached:y.isDetached}),p.push(b)});const h=f.dataset.avId;U(t,[{action:"insertAttrViewBlock",avID:h,ignoreFillFilter:!0,srcs:g,blockID:f.dataset.blockId},{action:"doUpdateUpdated",id:f.dataset.blockId,data:Y().format("YYYYMMDDHHmmss")}],[{action:"removeAttrViewBlock",srcIDs:p,avID:h}])})}}),s.length===1&&(o.getAttribute("data-detached")!=="true"&&i.addSeparator({id:"separator_1"}),i.addItem({id:"insertRowBefore",icon:"iconBefore",label:`<div class="fn__flex" style="align-items: center;">
${window.siyuan.languages.insertRowBefore.replace("${x}",`<span class="fn__space"></span><input style="width:64px" type="number" step="1" min="1" value="1" placeholder="${window.siyuan.languages.enterKey}" class="b3-text-field"><span class="fn__space"></span>`)}
</div>`,bind(f){const g=f.querySelector("input");f.addEventListener("click",()=>{document.activeElement.isSameNode(g)||(Al(a,t,parseInt(g.value),s[0].previousElementSibling.getAttribute("data-id")),i.close())}),g.addEventListener("keydown",p=>{!p.isComposing&&p.key==="Enter"&&(Al(a,t,parseInt(g.value),s[0].previousElementSibling.getAttribute("data-id")),i.close())})}}),i.addItem({id:"insertRowAfter",icon:"iconAfter",label:`<div class="fn__flex" style="align-items: center;">
${window.siyuan.languages.insertRowAfter.replace("${x}",`<span class="fn__space"></span><input style="width:64px" type="number" step="1" min="1" placeholder="${window.siyuan.languages.enterKey}" class="b3-text-field" value="1"><span class="fn__space"></span>`)}
</div>`,bind(f){const g=f.querySelector("input");f.addEventListener("click",()=>{document.activeElement.isSameNode(g)||(Al(a,t,parseInt(g.value),s[0].getAttribute("data-id")),i.close())}),g.addEventListener("keydown",p=>{!p.isComposing&&p.key==="Enter"&&(Al(a,t,parseInt(g.value),s[0].getAttribute("data-id")),i.close())})}}),i.addSeparator({id:"separator_2"}),o.getAttribute("data-detached")!=="true"&&i.addItem({id:"unbindBlock",label:window.siyuan.languages.unbindBlock,icon:"iconLinkOff",click(){Tn(t,a,{content:o.querySelector(".av__celltext").textContent},[o])}})),i.addItem({id:"delete",icon:"iconTrashcan",label:window.siyuan.languages.delete,click(){S_(a,t)}});const c=[];e.parentElement.querySelectorAll(".av__row--header .av__cell").forEach(f=>{const g=Array.from(a.querySelectorAll(`.av__row--select:not(.av__row--header) .av__cell[data-col-id="${f.dataset.colId}"]`)),p=f.getAttribute("data-dtype");if(!["updated","created"].includes(p)){const h=f.dataset.icon;c.push({iconHTML:h?ge(h,"b3-menu__icon",!0):`<svg class="b3-menu__icon"><use xlink:href="#${sn(p)}"></use></svg>`,label:pe(f.querySelector(".av__celltext").textContent.trim()),click(){Kn(t,g)}})}}),i.addItem({id:"fields",icon:"iconAttr",label:window.siyuan.languages.fields,type:"submenu",submenu:c})}return t?.app?.plugins&&An({plugins:t.app.plugins,type:"open-menu-av",detail:{protyle:t,element:a,selectRowElements:s},separatorPosition:"top"}),i.open(n),!0},vm=(t,e)=>{const n=e.getAttribute("data-av-id"),a=e.getAttribute("data-node-id"),i=e.querySelector(".av__title"),s=i.textContent.trim();if(s===i.dataset.title.trim())return;const o=Y().format("YYYYMMDDHHmmss");U(t,[{action:"setAttrViewName",id:n,data:s},{action:"doUpdateUpdated",id:a,data:o}],[{action:"setAttrViewName",id:n,data:i.dataset.title},{action:"doUpdateUpdated",id:a,data:e.getAttribute("updated")}]),e.setAttribute("updated",o),i.dataset.title=s,Array.from(t.wysiwyg.element.querySelectorAll(`[data-av-id="${n}"]`)).forEach(l=>{if(e.isSameNode(l))return;const r=l.querySelector(".av__title");r&&(r.textContent=s,r.dataset.title=s)})},gn=(t,e,n)=>{if(t)if(n)Tx(t,n);else{const a=t.querySelector(".av__drag-fill");t.innerHTML=kc(e),a&&In(t),Sm(t,e)}},z_=(t,e)=>{t.querySelectorAll(`.av__cell[data-col-id="${e}"]`).forEach(n=>{n.remove()})},V_=(t,e)=>{E("/api/av/duplicateAttributeViewBlock",{avID:e.getAttribute("data-av-id")},n=>{e.classList.remove("protyle-wysiwyg--select");const a=document.createElement("template");a.innerHTML=t.lute.SpinBlockDOM(`<div data-node-id="${n.data.blockID}" data-av-id="${n.data.avID}" data-type="NodeAttributeView" data-av-type="table"></div>`);const i=a.content.firstElementChild;e.after(i),dt(i,t,()=>{ae(i),Ne(t)}),U(t,[{action:"insert",data:i.outerHTML,id:n.data.blockID,previousID:e.dataset.nodeId}],[{action:"delete",id:n.data.blockID}])})};let Cn;const Em=(t,e,n=[])=>{let a="",i=!1;if(n.length===0&&document.querySelectorAll(".av__panel .b3-chips .b3-chip").forEach(s=>{n.push(s.dataset.content)}),e&&e.forEach(s=>{if(!t||t.toLowerCase().indexOf(s.name.toLowerCase())>-1||s.name.toLowerCase().indexOf(t.toLowerCase())>-1){const o=s.desc?`${Rt(s.name)}<div class='ft__on-surface'>${Rt(s.desc||"")}</div>`:"";a+=`<button data-type="addColOptionOrCell" class="b3-menu__item" data-name="${Xe(s.name)}" data-desc="${Xe(s.desc||"")}" draggable="true" data-color="${s.color}">
    <svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>
    <div class="fn__flex-1 ariaLabel" data-position="parentW" aria-label="${o}">
        <span class="b3-chip" style="background-color:var(--b3-font-background${s.color});color:var(--b3-font-color${s.color})">
            <span class="fn__ellipsis">${pe(s.name)}</span>
        </span>
    </div>
    <svg class="b3-menu__action" data-type="setColOption"><use xlink:href="#iconEdit"></use></svg>
    ${n.includes(s.name)?'<svg class="b3-menu__checked"><use xlink:href="#iconSelect"></use></svg></span>':""}
</button>`}t===s.name&&(i=!0)}),!i&&t){const s=(e?.length||0)%14+1;a=`<button data-type="addColOptionOrCell" class="b3-menu__item b3-menu__item--current" data-name="${t}" data-color="${s}">
<svg class="b3-menu__icon"><use xlink:href="#iconAdd"></use></svg>
<div class="fn__flex-1">
    <span class="b3-chip" style="background-color:var(--b3-font-background${s});color:var(--b3-font-color${s})">
        <span class="fn__ellipsis">${pe(t)}</span>
    </span>
</div>
<span class="b3-menu__accelerator">${window.siyuan.languages.enterKey}</span>
</button>${a}`}return a},Jf=(t,e,n,a)=>{if(!n)return;const i=e[0].dataset.colId,s=[],o=[];let l;const r=a.getAttribute("data-av-id");e.forEach((d,c)=>{if(!a.contains(d)){const h=L(d,"av__row");h&&(d=e[c]=a.querySelector(`.av__row[data-id="${h.dataset.id}"] .av__cell[data-col-id="${d.dataset.colId}"]`)||a.querySelector(`.fn__flex-1[data-col-id="${d.dataset.colId}"]`))}const f=L(d,"av__row").dataset.id,g=Cn[c],p=JSON.parse(JSON.stringify(g));c===0?(g.mSelect?.find((h,m)=>{if(h.content===n.dataset.content)return g.mSelect.splice(m,1),!0}),l=g.mSelect):g.mSelect=l,s.push({action:"updateAttrViewCell",id:g.id,keyID:i,rowID:f,avID:r,data:g}),o.push({action:"updateAttrViewCell",id:g.id,keyID:i,rowID:f,avID:r,data:p}),d.classList.contains("custom-attr__avvalue")?d.innerHTML=Ci(g):gn(d,g)}),U(t,s,o),Array.from(document.querySelectorAll(".av__panel .b3-menu__item")).find(d=>{if(d.dataset.name===n.dataset.content)return d.querySelector(".b3-menu__checked")?.remove(),!0}),n.remove()},kx=(t,e,n,a,i,s)=>{const o=L(n,"b3-menu");if(!o)return;const l=a.getAttribute("data-node-id"),r=s?s[0].dataset.colId:o.querySelector(".b3-menu__item").getAttribute("data-col-id");let d=n.parentElement.dataset.name,c=n.parentElement.dataset.desc,f=n.parentElement.dataset.color;const g=new st("av-col-option",()=>{if(d===m.value&&c===b.value||!m.value)return;U(t,[{action:"updateAttrViewColOption",id:r,avID:e.id,data:{newColor:f,oldName:d,newName:m.value,newDesc:b.value}}],[{action:"updateAttrViewColOption",id:r,avID:e.id,data:{newColor:f,oldName:m.value,newName:d,newDesc:c}}]),e.view.columns.find(x=>{if(x.id===r){let S=!1;return x.options.find(k=>{if(k.name===m.value)return S=!0,!0}),S||x.options.find(k=>{if(k.name===d)return k.name=m.value,k.desc=b.value,!0}),!0}});const y=o.querySelector(".b3-menu__items").scrollTop,w=o.querySelector(".b3-chips"),_=w?w.clientHeight:0;s?(s.forEach((x,S)=>{const k=L(x,"av__row");k&&(x=s[S]=a.querySelector(`.av__row[data-id="${k.dataset.id}"] .av__cell[data-col-id="${x.dataset.colId}"]`)||a.querySelector(`.fn__flex-1[data-col-id="${x.dataset.colId}"]`)),Cn[S].mSelect.find(A=>{if(A.content===d)return A.content=m.value,!0}),x.classList.contains("custom-attr__avvalue")?x.innerHTML=Ci(Cn[S]):gn(x,Cn[S])}),o.innerHTML=$l(e.view,s),Dl(t,e,o,s,a)):(o.innerHTML=Ra({protyle:t,data:e,colId:r,isCustomAttr:i}),Oa({protyle:t,data:e,menuElement:o,isCustomAttr:i,blockID:l})),w&&(o.querySelector(".b3-menu__items").scrollTop=y+(o.querySelector(".b3-chips").clientHeight-_))});if(g.isOpen)return;g.addItem({iconHTML:"",type:"empty",label:`<div class="fn__hr"></div>
<div class="b3-form__icona fn__block">
    <input class="b3-text-field b3-form__icona-input" type="text">
    <svg data-position="north" class="b3-form__icona-icon ariaLabel" aria-label="${c?Rt(c):window.siyuan.languages.addDesc}"><use xlink:href="#iconInfo"></use></svg>
</div>
<div class="fn__none">
    <div class="fn__hr"></div>
    <textarea rows="1" placeholder="${window.siyuan.languages.addDesc}" class="b3-text-field fn__block" type="text" data-value="${Xe(c)}">${c}</textarea>
</div>
<div class="fn__hr--small"></div>`,bind(y){const w=y.querySelector("input");w.addEventListener("keydown",x=>{x.isComposing||x.key==="Enter"&&g.close()}),w.value=d;const _=y.querySelector("textarea");w.nextElementSibling.addEventListener("click",()=>{const x=_.parentElement;x.classList.toggle("fn__none"),x.classList.contains("fn__none")||_.focus()}),_.addEventListener("keydown",x=>{x.isComposing||x.key==="Enter"&&g.close()}),_.addEventListener("input",()=>{w.nextElementSibling.setAttribute("aria-label",_.value?pe(_.value):window.siyuan.languages.addDesc)})}}),g.addItem({id:"delete",label:window.siyuan.languages.delete,icon:"iconTrashcan",click(){xe(window.siyuan.languages.deleteOpConfirm,window.siyuan.languages.confirmDelete,()=>{let y=[];e.view.columns.find(k=>{if(k.id===r)return y=k.options,!0});const w=n.parentElement.dataset.name;U(t,[{action:"removeAttrViewColOption",id:r,avID:e.id,data:w}],[{action:"updateAttrViewColOptions",id:r,avID:e.id,data:y}]),y.find((k,A)=>{if(k.name===w)return y.splice(A,1),!0});const _=o.querySelector(".b3-menu__items").scrollTop,x=o.querySelector(".b3-chips"),S=x?x.clientHeight:0;s?(s.forEach((k,A)=>{const $=L(k,"av__row");$&&(k=s[A]=a.querySelector(`.av__row[data-id="${$.dataset.id}"] .av__cell[data-col-id="${k.dataset.colId}"]`)||a.querySelector(`.fn__flex-1[data-col-id="${k.dataset.colId}"]`)),Cn[A].mSelect.find((M,C)=>{if(M.content===w)return Cn[A].mSelect.splice(C,1),!0}),k.classList.contains("custom-attr__avvalue")?k.innerHTML=Ci(Cn[A]):gn(k,Cn[A])}),o.innerHTML=$l(e.view,s),Dl(t,e,o,s,a)):(o.innerHTML=Ra({protyle:t,data:e,colId:r,isCustomAttr:i}),Oa({protyle:t,data:e,menuElement:o,isCustomAttr:i,blockID:l})),x&&(o.querySelector(".b3-menu__items").scrollTop=_+(o.querySelector(".b3-chips").clientHeight-S))},void 0,!0)}}),g.addSeparator();let p='<div class="fn__flex fn__flex-wrap" style="width: 238px">';Array.from(Array(14).keys()).forEach(y=>{p+=`<button data-color="${y+1}" class="color__square${parseInt(f)===y+1?" color__square--current":""}" style="color: var(--b3-font-color${y+1});background-color: var(--b3-font-background${y+1});">A</button>`}),g.addItem({type:"empty",iconHTML:"",label:p+"</div>",bind(y){y.addEventListener("click",w=>{const _=w.target;if(_.classList.contains("color__square")&&!_.classList.contains("color__square--current")){y.querySelector(".color__square--current")?.classList.remove("color__square--current"),_.classList.add("color__square--current");const x=_.getAttribute("data-color");U(t,[{action:"updateAttrViewColOption",id:r,avID:e.id,data:{oldName:d,newName:m.value,oldColor:f,newColor:x,newDesc:b.value}}],[{action:"updateAttrViewColOption",id:r,avID:e.id,data:{oldName:m.value,newName:d,oldColor:x,newColor:f,newDesc:b.value}}]),e.view.columns.find(k=>{if(k.id===r)return k.options.find(A=>{if(A.name===d)return A.name=m.value,A.color=x,!0}),!0});const S=o.querySelector(".b3-menu__items").scrollTop;s?(s.forEach((k,A)=>{const $=L(k,"av__row");$&&(k=s[A]=a.querySelector(`.av__row[data-id="${$.dataset.id}"] .av__cell[data-col-id="${k.dataset.colId}"]`)||a.querySelector(`.fn__flex-1[data-col-id="${k.dataset.colId}"]`)),Cn[A].mSelect.find(M=>{if(M.content===d)return M.content=m.value,M.color=x,!0}),k.classList.contains("custom-attr__avvalue")?k.innerHTML=Ci(Cn[A]):gn(k,Cn[A])}),o.innerHTML=$l(e.view,s),Dl(t,e,o,s,a)):(o.innerHTML=Ra({protyle:t,data:e,colId:r,isCustomAttr:i}),Oa({protyle:t,data:e,menuElement:o,isCustomAttr:i,blockID:l})),o.querySelector(".b3-menu__items").scrollTop=S,d=m.value,c=b.value,f=x}})}});const h=n.getBoundingClientRect();g.open({x:h.right,y:h.bottom,w:h.width,h:h.height});const m=window.siyuan.menus.menu.element.querySelector("input");m.select();const b=window.siyuan.menus.menu.element.querySelector("textarea")},Dl=(t,e,n,a,i)=>{const s=n.querySelector("input"),o=a[0].dataset.colId;let l;e.view.columns.find(d=>{if(d.id===o){l=d;return}}),l.options||(l.options=[]);const r=n.lastElementChild.lastElementChild;s.addEventListener("input",d=>{d.isComposing||(r.innerHTML=Em(s.value,l.options))}),s.addEventListener("compositionend",()=>{r.innerHTML=Em(s.value,l.options)}),s.addEventListener("keydown",d=>{if(d.isComposing)return;let c=xn(r,d,"b3-menu__item--current",r.firstElementChild);d.key==="Enter"?(c||(c=n.querySelector(".b3-menu__item--current")),c.querySelector(".b3-menu__checked")?Jf(t,a,n.querySelector(`.b3-chips .b3-chip[data-content="${Xe(c.dataset.name)}"]`),i):G_(t,e,a,c,n,i)):d.key==="Backspace"&&s.value===""&&Jf(t,a,s.previousElementSibling,i)})},G_=(t,e,n,a,i,s)=>{let o=!1;if(Array.from(i.querySelectorAll(".b3-chips .b3-chip")).find(p=>{if(p.dataset.content===a.dataset.name)return o=!0,!0}),o){i.querySelector("input").focus();return}P(n[0])||n.forEach((p,h)=>{const m=L(p,"av__row");m&&(n[h]=s.querySelector(`.av__row[data-id="${m.dataset.id}"] .av__cell[data-col-id="${p.dataset.colId}"]`)||s.querySelector(`.fn__flex-1[data-col-id="${p.dataset.colId}"]`))});const r=n[0].dataset.colId;let d;e.view.columns.find(p=>{if(p.id===r){d=p,d.options||(d.options=[]);return}});const c=[],f=[];let g;if(n.forEach((p,h)=>{const m=L(p,"av__row");if(!m)return;const b=m.dataset.id,y=Cn[h],w=JSON.parse(JSON.stringify(y));if(h===0){if(d.type==="mSelect"){let _=!1;y.mSelect.find(x=>{if(x.content===a.dataset.name)return _=!0,!0}),_||y.mSelect.push({color:a.dataset.color,content:a.dataset.name})}else y.mSelect=[{color:a.dataset.color,content:a.dataset.name}];g=y.mSelect}else y.mSelect=g;c.push({action:"updateAttrViewCell",id:y.id,keyID:r,rowID:b,avID:e.id,data:y}),f.push({action:"updateAttrViewCell",id:y.id,keyID:r,rowID:b,avID:e.id,data:w}),p.classList.contains("custom-attr__avvalue")?p.innerHTML=Ci(y):gn(p,y)}),a.querySelector(".b3-menu__accelerator")?(d.options.push({color:a.dataset.color,name:a.dataset.name}),c.splice(0,0,{action:"updateAttrViewColOptions",id:r,avID:e.id,data:d.options}),U(t,c,[{action:"removeAttrViewColOption",id:r,avID:e.id,data:a.dataset.name}])):U(t,c,f),d.type==="select")i.parentElement.remove();else{const p=i.querySelector(".b3-menu__items").scrollTop,h=i.querySelector(".b3-chips").clientHeight;i.innerHTML=$l(e.view,n),Dl(t,e,i,n,s),i.querySelector("input").focus(),i.querySelector(".b3-menu__items").scrollTop=p+(i.querySelector(".b3-chips").clientHeight-h)}},$l=(t,e,n=!1)=>{if(n){Cn=[];const l=e[0].classList.contains("custom-attr__avvalue");e.forEach(r=>{Cn.push(ga(l?r.dataset.type:vn(r),r))})}const a=e[0].dataset.colId,i=t.columns.find(l=>{if(l.id===a)return l});let s="";const o=[];return Cn[0].mSelect?.forEach(l=>{o.push(l.content),s+=`<div class="b3-chip b3-chip--middle" data-content="${Xe(l.content)}" style="white-space: nowrap;max-width:100%;background-color:var(--b3-font-background${l.color});color:var(--b3-font-color${l.color})"><span class="fn__ellipsis">${pe(l.content)}</span><svg class="b3-chip__close" data-type="removeCellOption"><use xlink:href="#iconCloseRound"></use></svg></div>`}),`<div class="b3-menu__items">
<div class="b3-chips" style="max-width: 50vw">
    ${s}
    <input>
</div>
<div>${Em("",i.options,o)}</div>
</div>`},j_=(t,e,n)=>{const a=[],i=[];return e.mSelect.forEach(s=>{if(t.options||(t.options=[]),!t.options.find(l=>{if(l.name===s.content)return s.color=l.color,!0})){const l=((t.options?.length||0)%14+1).toString();t.options.push({name:s.content,color:l}),s.color=l,a.push({action:"updateAttrViewColOptions",id:t.id,avID:n,data:t.options}),i.push({action:"removeAttrViewColOption",id:t.id,avID:n,data:s.content})}}),{doOperations:a,undoOperations:i}},Sx=t=>{const e=new st("av-add-sort");t.data.view.columns.forEach(n=>{let a=!1;n.type==="lineNumber"?a=!0:t.data.view.sorts.find(i=>{if(i.column===n.id)return a=!0,!0}),a||e.addItem({label:n.name,iconHTML:n.icon?ge(n.icon,"b3-menu__icon",!0):`<svg class="b3-menu__icon"><use xlink:href="#${sn(n.type)}"></use></svg>`,click:()=>{const i=Object.assign([],t.data.view.sorts);t.data.view.sorts.push({column:n.id,order:"ASC"}),U(t.protyle,[{action:"setAttrViewSorts",avID:t.data.id,data:t.data.view.sorts,blockID:t.blockID}],[{action:"setAttrViewSorts",avID:t.data.id,data:i,blockID:t.blockID}]),t.menuElement.innerHTML=Pl(t.data.view.columns,t.data.view.sorts),Ml(t.protyle,t.menuElement,t.data,t.blockID),ke(t.menuElement,t.tabRect.right-t.menuElement.clientWidth,t.tabRect.bottom,t.tabRect.height)}})}),e.open({x:t.rect.left,y:t.rect.bottom,h:t.rect.height})},Ml=(t,e,n,a)=>{e.querySelectorAll("select").forEach(i=>{i.addEventListener("change",()=>{const s=i.parentElement.getAttribute("data-id"),o=JSON.parse(JSON.stringify(n.view.sorts));i.previousElementSibling.classList.contains("b3-menu__icon")?n.view.sorts.find(l=>{if(l.column===s)return l.column=i.value,i.parentElement.setAttribute("data-id",i.value),!0}):n.view.sorts.find(l=>l.column===s).order=i.value,U(t,[{action:"setAttrViewSorts",avID:n.id,data:n.view.sorts,blockID:a}],[{action:"setAttrViewSorts",avID:n.id,data:o,blockID:a}])})})},Pl=(t,e)=>{let n="";const a=i=>{let s="";return t.forEach(o=>{s+=`<option value="${o.id}" ${o.id===i?"selected":""}>${o.icon&&ge(o.icon)}${o.name}</option>`}),s};return e.forEach(i=>{n+=`<button draggable="true" class="b3-menu__item" data-id="${i.column}">
    <svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>
    <select class="b3-select" style="margin: 4px 0">
        ${a(i.column)}
    </select>
    <span class="fn__space"></span>
    <select class="b3-select" style="margin: 4px 0">
        <option value="ASC" ${i.order==="ASC"?"selected":""}>${window.siyuan.languages.asc}</option>
        <option value="DESC" ${i.order==="DESC"?"selected":""}>${window.siyuan.languages.desc}</option>
    </select>
    <svg class="b3-menu__action" data-type="removeSort"><use xlink:href="#iconTrashcan"></use></svg>
</button>`}),`<div class="b3-menu__items">
<button class="b3-menu__item" data-type="nobg">
    <span class="block__icon" style="padding: 8px;margin-left: -4px;" data-type="go-config">
        <svg><use xlink:href="#iconLeft"></use></svg>
    </span>
    <span class="b3-menu__label ft__center">${window.siyuan.languages.sort}</span>
</button>
<button class="b3-menu__separator"></button>
${n}
<button class="b3-menu__item${e.length===t.length?" fn__none":""}" data-type="addSort">
    <svg class="b3-menu__icon"><use xlink:href="#iconAdd"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.new}</span>
</button>
<button class="b3-menu__item${n?"":" fn__none"}" data-type="removeSorts">
    <svg class="b3-menu__icon"><use xlink:href="#iconTrashcan"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.delete}</span>
</button>
</div>`},Lx=t=>{const e=ga("date",t[0]).date,n=e.isNotTime;let a="";const i=new Date().getTime();if(e.isNotEmpty){a=Y(e.content).format(n?"YYYY-MM-DD":"YYYY-MM-DD HH:mm");const o=a.split("-")[0];o.length!==4&&(a=new Array(4-o.length).fill(0).join("")+a)}else a=Y(i).format(n?"YYYY-MM-DD":"YYYY-MM-DD HH:mm");let s="";if(e.isNotEmpty2){s=Y(e.content2).format(n?"YYYY-MM-DD":"YYYY-MM-DD HH:mm");const o=a.split("-")[0];o.length!==4&&(a=new Array(4-o.length).fill(0).join("")+a)}else e.hasEndDate&&(s=Y(i).format(n?"YYYY-MM-DD":"YYYY-MM-DD HH:mm"));return`<div class="b3-menu__items">
<div>
    <input type="${n?"date":"datetime-local"}" max="${n?"9999-12-31":"9999-12-31 23:59"}" value="${a}" data-value="${Y(e.content||i).format("YYYY-MM-DD HH:mm")}" class="b3-text-field fn__size200" style="margin-top: 4px;"><br>
    <input type="${n?"date":"datetime-local"}" max="${n?"9999-12-31":"9999-12-31 23:59"}" value="${s}" data-value="${e.isNotEmpty2?Y(e.content2).format("YYYY-MM-DD HH:mm"):""}" style="margin-top: 8px;margin-bottom: 4px" class="b3-text-field fn__size200${e.hasEndDate?"":" fn__none"}">
    <button class="b3-menu__separator"></button>
    <label class="b3-menu__item">
        <span class="fn__flex-center">${window.siyuan.languages.endDate}</span>
        <span class="fn__space fn__flex-1"></span>
        <input type="checkbox" class="b3-switch b3-switch--menu"${e.hasEndDate?" checked":""}>
    </label>
    <label class="b3-menu__item">
        <span class="fn__flex-center">${window.siyuan.languages.includeTime}</span>
        <span class="fn__space fn__flex-1"></span>
        <input type="checkbox" class="b3-switch b3-switch--menu"${n?"":" checked"}>
    </label>
    <button class="b3-menu__separator"></button>
    <button class="b3-menu__item" data-type="clearDate">
        <svg class="b3-menu__icon"><use xlink:href="#iconTrashcan"></use></svg>
        <span class="b3-menu__label">${window.siyuan.languages.clear}</span>
    </button>
</div>
</div>`},xx=t=>{const e=t.menuElement.querySelectorAll("input");return e.forEach(n=>{n.addEventListener("keydown",a=>{a.isComposing||a.key==="Enter"&&(Tn(t.protyle,t.blockElement,{content:Xf(e[0].dataset.value),isNotEmpty:e[0].value!=="",content2:Xf(e[1].dataset.value),isNotEmpty2:e[1].value!=="",hasEndDate:e[2].checked,isNotTime:!e[3].checked},t.cellElements),document.querySelector(".av__panel")?.remove())})}),e[0].addEventListener("change",()=>{e[0].dataset.value=e[0].value.length>10?e[0].value:e[0].value+" 00:00"}),e[1].addEventListener("change",()=>{e[1].dataset.value=e[1].value.length>10?e[1].value:e[1].value+" 00:00"}),e[2].addEventListener("change",()=>{if(e[2].checked){if(!e[1].dataset.value){const n=new Date().getTime();e[1].dataset.value=Y(n).format("YYYY-MM-DD HH:mm"),e[1].value=Y(n).format(e[3].checked?"YYYY-MM-DD HH:mm":"YYYY-MM-DD")}e[1].classList.remove("fn__none")}else e[1].classList.add("fn__none")}),e[3].addEventListener("change",()=>{e[3].checked?(e[0].setAttribute("type","datetime-local"),e[1].setAttribute("type","datetime-local"),e[0].setAttribute("max","9999-12-31 23:59"),e[1].setAttribute("max","9999-12-31 23:59"),e[0].value=e[0].dataset.value,e[1].value=e[1].dataset.value):(e[0].setAttribute("type","date"),e[1].setAttribute("type","date"),e[0].setAttribute("max","9999-12-31"),e[1].setAttribute("max","9999-12-31"),e[0].value=e[0].dataset.value.substring(0,10),e[1].value=e[1].dataset.value.substring(0,10))}),()=>{Tn(t.protyle,t.blockElement,{content:Xf(e[0].dataset.value),isNotEmpty:e[0].value!=="",content2:Xf(e[1].dataset.value),isNotEmpty2:e[1].value!=="",hasEndDate:e[2].checked,isNotTime:!e[3].checked},t.cellElements)}},Xf=t=>{const e=t.split("-")[0],n=new Date(t);return(e.startsWith("00")||e.startsWith("000")||e.length<3)&&n.setFullYear(parseInt(e)),n.getTime()},jn=t=>{t.menu.addItem({iconHTML:"",label:K_(t.format),click(){U(t.protyle,[{action:"updateAttrViewColNumberFormat",id:t.colId,avID:t.avID,format:t.format,type:"number"}],[{action:"updateAttrViewColNumberFormat",id:t.colId,avID:t.avID,format:t.oldFormat,type:"number"}]),t.avPanelElement.remove()}})},Ax=t=>{const e=new st("av-col-format-number");jn({menu:e,protyle:t.protyle,colId:t.colId,avID:t.avID,format:"",oldFormat:t.oldFormat,avPanelElement:t.avPanelElement}),jn({menu:e,protyle:t.protyle,colId:t.colId,avID:t.avID,format:"commas",oldFormat:t.oldFormat,avPanelElement:t.avPanelElement}),jn({menu:e,protyle:t.protyle,colId:t.colId,avID:t.avID,format:"percent",oldFormat:t.oldFormat,avPanelElement:t.avPanelElement}),jn({menu:e,protyle:t.protyle,colId:t.colId,avID:t.avID,format:"usDollar",oldFormat:t.oldFormat,avPanelElement:t.avPanelElement}),jn({menu:e,protyle:t.protyle,colId:t.colId,avID:t.avID,format:"yuan",oldFormat:t.oldFormat,avPanelElement:t.avPanelElement}),jn({menu:e,protyle:t.protyle,colId:t.colId,avID:t.avID,format:"euro",oldFormat:t.oldFormat,avPanelElement:t.avPanelElement}),jn({menu:e,protyle:t.protyle,colId:t.colId,avID:t.avID,format:"pound",oldFormat:t.oldFormat,avPanelElement:t.avPanelElement}),jn({menu:e,protyle:t.protyle,colId:t.colId,avID:t.avID,format:"yen",oldFormat:t.oldFormat,avPanelElement:t.avPanelElement}),jn({menu:e,protyle:t.protyle,colId:t.colId,avID:t.avID,format:"ruble",oldFormat:t.oldFormat,avPanelElement:t.avPanelElement}),jn({menu:e,protyle:t.protyle,colId:t.colId,avID:t.avID,format:"rupee",oldFormat:t.oldFormat,avPanelElement:t.avPanelElement}),jn({menu:e,protyle:t.protyle,colId:t.colId,avID:t.avID,format:"won",oldFormat:t.oldFormat,avPanelElement:t.avPanelElement}),jn({menu:e,protyle:t.protyle,colId:t.colId,avID:t.avID,format:"canadianDollar",oldFormat:t.oldFormat,avPanelElement:t.avPanelElement}),jn({menu:e,protyle:t.protyle,colId:t.colId,avID:t.avID,format:"franc",oldFormat:t.oldFormat,avPanelElement:t.avPanelElement});const n=t.element.getBoundingClientRect();e.open({x:n.left,y:n.bottom,h:n.height,w:n.width,isLeft:!0})},K_=t=>{switch(t){case"":return window.siyuan.languages.numberFormatNone;case"commas":return window.siyuan.languages.numberFormatCommas;case"percent":return window.siyuan.languages.numberFormatPercent;case"usDollar":return window.siyuan.languages.numberFormatUSDollar;case"yuan":return window.siyuan.languages.numberFormatYuan;case"euro":return window.siyuan.languages.numberFormatEuro;case"pound":return window.siyuan.languages.numberFormatPound;case"yen":return window.siyuan.languages.numberFormatYen;case"ruble":return window.siyuan.languages.numberFormatRuble;case"rupee":return window.siyuan.languages.numberFormatRupee;case"won":return window.siyuan.languages.numberFormatWon;case"canadianDollar":return window.siyuan.languages.numberFormatCanadianDollar;case"franc":return window.siyuan.languages.numberFormatFranc}},Z_=(t,e)=>{if(e.classList.contains("b3-list--empty"))return;t.target.querySelector(".b3-menu__accelerator").textContent=e.querySelector(".b3-list-item__text").textContent;const n=t.data.view.columns.find(i=>{if(i.id===t.colId)return i.rollup||(i.rollup={}),!0});if(t.isRelation){if(e.dataset.colId===n.rollup?.relationKeyID)return;n.rollup={relationKeyID:e.dataset.colId};const i=t.target.nextElementSibling;i.querySelector(".b3-menu__accelerator").textContent="",i.setAttribute("data-av-id",e.dataset.targetAvId);const s=i.nextElementSibling;s.removeAttribute("data-col-type"),s.removeAttribute("data-calc"),s.querySelector(".b3-menu__accelerator").textContent=window.siyuan.languages.original}else{if(e.dataset.colId===n.rollup?.keyID)return;n.rollup.keyID=e.dataset.colId,delete n.rollup.calc;const i=t.target.nextElementSibling;i.removeAttribute("data-calc"),i.setAttribute("data-col-type",e.dataset.colType),i.querySelector(".b3-menu__accelerator").textContent=window.siyuan.languages.original}const a=JSON.parse(JSON.stringify(n.rollup));U(t.protyle,[{action:"updateAttrViewColRollup",id:t.colId,avID:t.data.id,parentID:n.rollup.relationKeyID,keyID:n.rollup.keyID,data:{calc:n.rollup.calc}}],[{action:"updateAttrViewColRollup",id:t.colId,avID:t.data.id,parentID:a.relationKeyID,keyID:a.keyID,data:{calc:a.calc}}])},J_=(t,e,n,a,i)=>{if(!a&&!n){j(window.siyuan.languages.selectRelation);return}E(a?"/api/av/searchAttributeViewRelationKey":"/api/av/searchAttributeViewNonRelationKey",{avID:n,keyword:e},s=>{let o="";s.data.keys.forEach((l,r)=>{o+=`<div class="b3-list-item b3-list-item--narrow${r===0?" b3-list-item--focus":""}" data-col-id="${l.id}" ${a?`data-target-av-id="${l.relation.avID}"`:`data-col-type="${l.type}"`}>
        ${l.icon?ge(l.icon,"b3-list-item__graphic",!0):`<svg class="b3-list-item__graphic"><use xlink:href="#${sn(l.type)}"></use></svg>`}
        <span class="b3-list-item__text">${pe(l.name||window.siyuan.languages.title)}</span>
</div>`}),t.innerHTML=o||`<div class="b3-list--empty">${window.siyuan.languages.emptyContent}</div>`,i&&i()})},X_=t=>{window.siyuan.menus.menu.remove();const e=new st;e.addItem({iconHTML:"",type:"empty",label:`<div class="fn__flex-column b3-menu__filter">
    <input class="b3-text-field fn__flex-shrink" placeholder="${window.siyuan.languages[t.isRelation?"searchRelation":"searchRollupProperty"]}"/>
    <div class="fn__hr"></div>
    <div class="b3-list fn__flex-1 b3-list--background">
        <img style="margin: 0 auto;display: block;width: 64px;height: 64px" src="/stage/loading-pure.svg">
    </div>
</div>`,bind(n){const a=n.querySelector(".b3-list"),i=n.querySelector("input");i.addEventListener("keydown",s=>{if(s.isComposing)return;xn(a,s)&&s.stopPropagation(),s.key==="Enter"&&(s.preventDefault(),s.stopPropagation(),Z_(t,a.querySelector(".b3-list-item--focus")),window.siyuan.menus.menu.remove())}),i.addEventListener("input",s=>{s.stopPropagation(),J_(a,i.value,t.isRelation?t.data.id:t.target.dataset.avId,t.isRelation)}),n.lastElementChild.addEventListener("click",s=>{const o=L(s.target,"b3-list-item");o&&(s.stopPropagation(),Z_(t,o),window.siyuan.menus.menu.remove())}),J_(a,"",t.isRelation?t.data.id:t.target.dataset.avId,t.isRelation,()=>{const s=t.target.getBoundingClientRect();e.open({x:s.left,y:s.bottom,h:s.height}),n.querySelector("input").focus()})}}),e.element.querySelector(".b3-menu__items").setAttribute("style","overflow: initial")},Q_=t=>{let e;return t.colData?e=t.colData:t.data.view.columns.find(n=>{if(n.id===t.cellElements[0].dataset.colId)return e=n,!0}),`<button class="b3-menu__item" data-type="goSearchRollupCol" data-old-value='${JSON.stringify(e.rollup||{})}'>
    <span class="b3-menu__label">${window.siyuan.languages.relation}</span>
    <span class="b3-menu__accelerator"></span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<button class="b3-menu__item" data-type="goSearchRollupTarget">
    <span class="b3-menu__label">${window.siyuan.languages.rollupProperty}</span>
    <span class="b3-menu__accelerator"></span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<button class="b3-menu__item" data-type="goSearchRollupCalc">
    <span class="b3-menu__label">${window.siyuan.languages.rollupCalc}</span>
    <span class="b3-menu__accelerator">${_m(e.rollup?.calc?.operator,!0)}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>`},ev=t=>{const e=t.menuElement.querySelector('[data-type="goSearchRollupCol"]');if(e){const n=JSON.parse(e.dataset.oldValue),a=t.menuElement.querySelector('[data-type="goSearchRollupTarget"]');let i="";n.relationKeyID&&t.data.view.columns.find(s=>{if(s.id===n.relationKeyID)return e.querySelector(".b3-menu__accelerator").textContent=s.name,i=s.relation.avID,a.dataset.avId=i,!0}),n.keyID&&i&&E("/api/av/getAttributeView",{id:i},s=>{s.data.av.keyValues.find(o=>{if(o.key.id===n.keyID){a.querySelector(".b3-menu__accelerator").textContent=o.key.name;const l=t.menuElement.querySelector('[data-type="goSearchRollupCalc"]');return l.dataset.colType=o.key.type,n.calc&&(l.dataset.calc=n.calc.operator),!0}})})}},hn=t=>{let e=document.querySelector(".av__panel");if(e){e.remove();return}const n=t.blockElement.getAttribute("data-av-id");E("/api/av/renderAttributeView",{id:n,query:t.blockElement.querySelector('[data-type="av-search"]')?.value.trim()||"",pageSize:parseInt(t.blockElement.getAttribute("data-page-size"))||void 0,viewID:t.blockElement.getAttribute(u.CUSTOM_SY_AV_VIEW)},a=>{if(e=document.querySelector(".av__panel"),e){e.remove();return}window.siyuan.menus.menu.remove();const i=t.blockElement.getAttribute("data-node-id"),s=!t.blockElement.classList.contains("av"),o=a.data;let l;if(t.type==="config")l=U_(o);else if(t.type==="properties")l=rs(o.view);else if(t.type==="sorts")l=Pl(o.view.columns,o.view.sorts);else if(t.type==="switcher")l=vx(o.views,o.viewID);else if(t.type==="filters")l=cs(o.view);else if(t.type==="select")l=$l(o.view,t.cellElements,!0);else if(t.type==="asset")l=P_(t.cellElements);else if(t.type==="edit")t.editData&&(t.editData.previousID?o.view.columns.find((p,h)=>{if(p.id===t.editData.previousID)return o.view.columns.splice(h+1,0,t.editData.colData),!0}):o.view.columns.splice(0,0,t.editData.colData)),l=Ra({protyle:t.protyle,data:o,colId:t.colId,isCustomAttr:s});else if(t.type==="date")l=Lx(t.cellElements);else if(t.type==="rollup")l=`<div class="b3-menu__items">${Q_({data:o,cellElements:t.cellElements})}</div>`;else if(t.type==="relation"&&(l=bL(o,t.cellElements),!l)){hn({protyle:t.protyle,blockElement:t.blockElement,type:"edit",colId:t.cellElements[0].dataset.colId});return}document.body.insertAdjacentHTML("beforeend",`<div class="av__panel" style="z-index: ${++window.siyuan.zIndex}">
    <div class="b3-dialog__scrim" data-type="close"></div>
    <div class="b3-menu">${l}</div>
</div>`),e=document.querySelector(".av__panel");let r;const d=e.lastElementChild;let c=t.blockElement.querySelector(`.av__views, .av__row[data-col-id="${t.colId}"] > .block__logo`)?.getBoundingClientRect();if(["select","date","asset","relation","rollup"].includes(t.type)){const p=t.cellElements[t.cellElements.length-1].getBoundingClientRect();if(t.type==="select"?Dl(t.protyle,o,d,t.cellElements,t.blockElement):t.type==="date"?r=xx({protyle:t.protyle,data:o,menuElement:d,cellElements:t.cellElements,blockElement:t.blockElement}):t.type==="asset"?(M_({protyle:t.protyle,menuElement:d,cellElements:t.cellElements,blockElement:t.blockElement}),setTimeout(()=>{ke(d,p.left,p.bottom,p.height)},u.TIMEOUT_LOAD)):t.type==="relation"?mL({menuElement:d,cellElements:t.cellElements,protyle:t.protyle,blockElement:t.blockElement}):t.type==="rollup"&&ev({protyle:t.protyle,data:o,menuElement:d}),["select","date","relation","rollup"].includes(t.type)){const h=d.querySelector("input");h&&(h.select(),h.focus()),ke(d,p.left,p.bottom,p.height)}}else ke(d,c.right-d.clientWidth,c.bottom,c.height),t.type==="sorts"?Ml(t.protyle,d,o,i):t.type==="edit"?Oa({protyle:t.protyle,data:o,menuElement:d,isCustomAttr:s,blockID:i}):t.type==="config"?F_({protyle:t.protyle,data:o,menuElement:d,blockElement:t.blockElement}):t.type==="switcher"&&_x({protyle:t.protyle,menuElement:d,blockElement:t.blockElement});t.cb&&t.cb(e),e.addEventListener("dragstart",p=>{window.siyuan.dragElement=p.target,window.siyuan.dragElement.style.opacity=".1"}),e.addEventListener("drop",p=>{if(g=0,!window.siyuan.dragElement){p.preventDefault(),p.stopPropagation();return}window.siyuan.dragElement.style.opacity="";const h=window.siyuan.dragElement;if(window.siyuan.dragElement=void 0,t.protyle&&t.protyle.disabled){p.preventDefault(),p.stopPropagation();return}if(!t.protyle&&window.siyuan.config.readonly){p.preventDefault(),p.stopPropagation();return}const m=e.querySelector(".dragover__bottom, .dragover__top");if(!m)return;const b=m.classList.contains("dragover__top"),y=h.dataset.id,w=m.dataset.id;if(m.querySelector('[data-type="removeSort"]')){const _=o.view.sorts,x=Object.assign([],_);let S;_.find((k,A)=>{if(k.column===y)return S=_.splice(A,1)[0],!0}),_.find((k,A)=>{if(k.column===w)return b?_.splice(A,0,S):_.splice(A+1,0,S),!0}),U(t.protyle,[{action:"setAttrViewSorts",avID:n,data:_,blockID:i}],[{action:"setAttrViewSorts",avID:n,data:x,blockID:i}]),d.innerHTML=Pl(o.view.columns,o.view.sorts),Ml(t.protyle,d,o,i);return}if(m.querySelector('[data-type="removeFilter"]')){const _=o.view.filters,x=Object.assign([],_);let S;_.find((k,A)=>{if(k.column===y)return S=_.splice(A,1)[0],!0}),_.find((k,A)=>{if(k.column===w)return b?_.splice(A,0,S):_.splice(A+1,0,S),!0}),U(t.protyle,[{action:"setAttrViewFilters",avID:n,data:_,blockID:i}],[{action:"setAttrViewFilters",avID:n,data:x,blockID:i}]),d.innerHTML=cs(o.view);return}if(m.querySelector('[data-type="av-view-edit"]')){U(t.protyle,[{action:"sortAttrViewView",avID:n,blockID:i,id:y,previousID:b?m.previousElementSibling?.getAttribute("data-id"):m.getAttribute("data-id")}],[{action:"sortAttrViewView",avID:n,blockID:i,id:y,previousID:h.previousElementSibling?.getAttribute("data-id")}]),b?(m.before(h),m.classList.remove("dragover__top")):(m.after(h),m.classList.remove("dragover__bottom"));return}if(m.querySelector('[data-type="editAssetItem"]')){b?m.before(h):m.after(h);const _=[];Array.from(m.parentElement.children).forEach(x=>{x.dataset.content&&_.push({content:x.dataset.content,name:x.dataset.name,type:x.dataset.type})}),po({protyle:t.protyle,cellElements:t.cellElements,replaceValue:_,blockElement:t.blockElement});return}if(m.querySelector('[data-type="setColOption"]')){const _=t.cellElements?t.cellElements[0].dataset.colId:d.querySelector(".b3-menu__item").getAttribute("data-col-id"),x=o.view.columns.find($=>$.id===_).options,S=Object.assign([],x);let k;x.find(($,M)=>{if($.name===h.dataset.name)return k=x.splice(M,1)[0],!0}),x.find(($,M)=>{if($.name===m.dataset.name)return b?x.splice(M,0,k):x.splice(M+1,0,k),!0}),U(t.protyle,[{action:"updateAttrViewColOptions",id:_,avID:n,data:x}],[{action:"updateAttrViewColOptions",id:_,avID:n,data:S}]);const A=d.querySelector(".b3-menu__items").scrollTop;t.cellElements?(d.innerHTML=$l(o.view,t.cellElements),Dl(t.protyle,o,d,t.cellElements,t.blockElement)):(d.innerHTML=Ra({protyle:t.protyle,data:o,colId:_,isCustomAttr:s}),Oa({protyle:t.protyle,data:o,menuElement:d,isCustomAttr:s,blockID:i})),d.querySelector(".b3-menu__items").scrollTop=A;return}if(m.getAttribute("data-type")==="setRelationCell"){b?m.before(h):m.after(h),m.classList.remove("dragover__bottom","dragover__top");const _=[],x=[];m.parentElement.querySelectorAll(".fn__grab").forEach(S=>{const k=S.nextElementSibling;_.push(k.dataset.id),x.push({isDetached:!k.style.color,type:"block",block:{content:k.textContent,id:k.dataset.id}})}),Tn(t.protyle,t.blockElement,{blockIDs:_,contents:x},t.cellElements);return}if(m.getAttribute("data-type")==="editCol"){const _=(m.classList.contains("dragover__top")?m.previousElementSibling?.getAttribute("data-id"):m.getAttribute("data-id"))||"",x=h.previousElementSibling?.getAttribute("data-id")||"";if(_!==x&&_!==y){U(t.protyle,[{action:"sortAttrViewCol",avID:n,previousID:_,id:y,blockID:i}],[{action:"sortAttrViewCol",avID:n,previousID:x,id:y,blockID:i}]);let S;o.view.columns.find((k,A)=>{if(k.id===y)return S=o.view.columns.splice(A,1)[0],!0}),o.view.columns.find((k,A)=>{if(k.id===w)return b?o.view.columns.splice(A,0,S):o.view.columns.splice(A+1,0,S),!0})}d.innerHTML=rs(o.view);return}});let f;e.addEventListener("dragover",p=>{if(p.dataTransfer.types.includes("Files")){p.preventDefault();return}const h=p.target;let m=B(h,"draggable","true");if(m||(m=B(document.elementFromPoint(p.clientX,p.clientY-1),"draggable","true")),!(!m||m.isSameNode(window.siyuan.dragElement))){if(p.preventDefault(),f&&m.isSameNode(f)){const b=m.getBoundingClientRect();e.querySelectorAll(".dragover__bottom, .dragover__top").forEach(y=>{y.classList.remove("dragover__bottom","dragover__top")}),p.clientY>b.top+b.height/2?m.classList.add("dragover__bottom"):m.classList.add("dragover__top");return}f=m}});let g=0;e.addEventListener("dragleave",()=>{g--,g===0&&e.querySelectorAll(".dragover__bottom, .dragover__top").forEach(p=>{p.classList.remove("dragover__bottom","dragover__top")})}),e.addEventListener("dragenter",p=>{p.preventDefault(),g++}),e.addEventListener("dragend",()=>{window.siyuan.dragElement&&(window.siyuan.dragElement.style.opacity="",window.siyuan.dragElement=void 0)}),e.addEventListener("mousedown",p=>{p.button===1&&!L(p.target,"b3-menu")&&document.querySelector(".av__panel").dispatchEvent(new CustomEvent("click",{detail:"close"}))}),e.addEventListener("click",p=>{let h;typeof p.detail=="string"&&(h=p.detail);let m=p.target;for(;m&&!m.isSameNode(e)||h;){if(h=m?.dataset.type||h,h==="close"){t.protyle.toolbar.subElement.classList.contains("fn__none")?window.siyuan.menus.menu.element.classList.contains("fn__none")?(r?.(),e.remove(),ae(t.blockElement)):window.siyuan.menus.menu.remove():Q(["util"],t.protyle),window.siyuan.menus.menu.remove(),p.preventDefault(),p.stopPropagation();break}else if(h==="go-config"){d.innerHTML=U_(o),ke(d,c.right-d.clientWidth,c.bottom,c.height),F_({protyle:t.protyle,data:o,menuElement:d,blockElement:t.blockElement}),window.siyuan.menus.menu.remove(),p.preventDefault(),p.stopPropagation();break}else if(h==="go-properties"){c=t.blockElement.querySelector(".av__views").getBoundingClientRect(),d.innerHTML=rs(o.view),ke(d,c.right-d.clientWidth,c.bottom,c.height),window.siyuan.menus.menu.remove(),p.preventDefault(),p.stopPropagation();break}else if(h==="goSorts"){d.innerHTML=Pl(o.view.columns,o.view.sorts),Ml(t.protyle,d,o,i),ke(d,c.right-d.clientWidth,c.bottom,c.height),window.siyuan.menus.menu.remove(),p.preventDefault(),p.stopPropagation();break}else if(h==="removeSorts"){U(t.protyle,[{action:"setAttrViewSorts",avID:n,data:[],blockID:i}],[{action:"setAttrViewSorts",avID:n,data:o.view.sorts,blockID:i}]),o.view.sorts=[],d.innerHTML=Pl(o.view.columns,o.view.sorts),Ml(t.protyle,d,o,i),ke(d,c.right-d.clientWidth,c.bottom,c.height),p.preventDefault(),p.stopPropagation();break}else if(h==="addSort"){Sx({data:o,rect:m.getBoundingClientRect(),menuElement:d,tabRect:c,avId:n,protyle:t.protyle,blockID:i}),p.preventDefault(),p.stopPropagation();break}else if(h==="removeSort"){const b=Object.assign([],o.view.sorts);o.view.sorts.find((y,w)=>{if(y.column===m.parentElement.dataset.id)return o.view.sorts.splice(w,1),!0}),U(t.protyle,[{action:"setAttrViewSorts",avID:n,data:o.view.sorts,blockID:i}],[{action:"setAttrViewSorts",avID:n,data:b,blockID:i}]),d.innerHTML=Pl(o.view.columns,o.view.sorts),Ml(t.protyle,d,o,i),ke(d,c.right-d.clientWidth,c.bottom,c.height),p.preventDefault(),p.stopPropagation();break}else if(h==="goFilters"){d.innerHTML=cs(o.view),ke(d,c.right-d.clientWidth,c.bottom,c.height),window.siyuan.menus.menu.remove(),p.preventDefault(),p.stopPropagation();break}else if(h==="removeFilters"){U(t.protyle,[{action:"setAttrViewFilters",avID:n,data:[],blockID:i}],[{action:"setAttrViewFilters",avID:n,data:o.view.filters,blockID:i}]),o.view.filters=[],d.innerHTML=cs(o.view),ke(d,c.right-d.clientWidth,c.bottom,c.height),window.siyuan.menus.menu.remove(),p.preventDefault(),p.stopPropagation();break}else if(h==="addFilter"){Dx({data:o,rect:m.getBoundingClientRect(),menuElement:d,tabRect:c,avId:n,protyle:t.protyle,blockElement:t.blockElement}),p.preventDefault(),p.stopPropagation();break}else if(h==="removeFilter"){window.siyuan.menus.menu.remove();const b=Object.assign([],o.view.filters);o.view.filters.find((y,w)=>{if(y.column===m.parentElement.dataset.id&&y.value.type===m.parentElement.dataset.filterType)return o.view.filters.splice(w,1),!0}),U(t.protyle,[{action:"setAttrViewFilters",avID:n,data:o.view.filters,blockID:i}],[{action:"setAttrViewFilters",avID:n,data:b,blockID:i}]),d.innerHTML=cs(o.view),ke(d,c.right-d.clientWidth,c.bottom,c.height),p.preventDefault(),p.stopPropagation();break}else if(h==="setFilter"){o.view.filters.find(b=>{if(b.column===m.parentElement.parentElement.dataset.id&&b.value.type===m.parentElement.parentElement.dataset.filterType)return Lm({filter:b,protyle:t.protyle,data:o,target:m,blockElement:t.blockElement}),!0}),p.preventDefault(),p.stopPropagation();break}else if(h==="numberFormat"){Ax({avPanelElement:e,element:m,protyle:t.protyle,oldFormat:m.dataset.format,colId:d.querySelector(".b3-menu__item").getAttribute("data-col-id"),avID:n}),p.preventDefault(),p.stopPropagation();break}else if(h==="newCol"){e.remove(),Lc(t.protyle,t.blockElement).open({x:c.right,y:c.bottom,h:c.height,isLeft:!0}),p.preventDefault(),p.stopPropagation();break}else if(h==="update-view-icon"){const b=m.getBoundingClientRect();Za("","av",{x:b.left,y:b.bottom+4,h:b.height,w:b.width},y=>{U(t.protyle,[{action:"setAttrViewViewIcon",avID:n,id:o.viewID,data:y}],[{action:"setAttrViewViewIcon",id:o.viewID,avID:n,data:m.dataset.icon}]),m.innerHTML=y?ge(y):'<svg style="width: 14px;height: 14px;"><use xlink:href="#iconTable"></use></svg>',m.dataset.icon=y},m.querySelector("img")),p.preventDefault(),p.stopPropagation();break}else if(h==="set-page-size"){k_({target:m,protyle:t.protyle,avID:n,nodeElement:t.blockElement}),p.preventDefault(),p.stopPropagation();break}else if(h==="duplicate-view"){const b=Lute.NewNodeID();U(t.protyle,[{action:"duplicateAttrViewView",avID:n,previousID:o.viewID,id:b,blockID:i}],[{action:"removeAttrViewView",avID:n,id:b,blockID:i}]),t.blockElement.setAttribute(u.CUSTOM_SY_AV_VIEW,b),e.remove(),p.preventDefault(),p.stopPropagation();break}else if(h==="delete-view"){U(t.protyle,[{action:"removeAttrViewView",avID:n,id:o.viewID,blockID:i}]),e.remove(),p.preventDefault(),p.stopPropagation();break}else if(h==="update-icon"){const b=m.getBoundingClientRect();Za("","av",{x:b.left,y:b.bottom+4,h:b.height,w:b.width},y=>{const w=d.querySelector(".b3-menu__item").getAttribute("data-col-id");if(U(t.protyle,[{action:"setAttrViewColIcon",id:w,avID:n,data:y}],[{action:"setAttrViewColIcon",id:w,avID:n,data:m.dataset.icon}]),m.innerHTML=y?ge(y):`<svg style="height: 14px;width: 14px"><use xlink:href="#${sn(m.dataset.colType)}"></use></svg>`,s){const _=t.blockElement.querySelector(`.av__row[data-col-id="${w}"] .block__logoicon`);_.outerHTML=y?ge(y,"block__logoicon",!0):`<svg class="block__logoicon"><use xlink:href="#${sn(_.nextElementSibling.getAttribute("data-type"))}"></use></svg>`}else gn(t.blockElement.querySelector(`.av__row--header .av__cell[data-col-id="${w}"]`),void 0,{icon:y});m.dataset.icon=y},m.querySelector("img")),p.preventDefault(),p.stopPropagation();break}else if(h==="showAllCol"){const b=[],y=[];o.view.columns.forEach(w=>{w.hidden&&(b.push({action:"setAttrViewColHidden",id:w.id,avID:n,data:!1,blockID:i}),y.push({action:"setAttrViewColHidden",id:w.id,avID:n,data:!0,blockID:i}),w.hidden=!1)}),b.length>0&&(U(t.protyle,b,y),d.innerHTML=rs(o.view),ke(d,c.right-d.clientWidth,c.bottom,c.height)),p.preventDefault(),p.stopPropagation();break}else if(h==="hideAllCol"){const b=[],y=[];o.view.columns.forEach(w=>{!w.hidden&&w.type!=="block"&&(b.push({action:"setAttrViewColHidden",id:w.id,avID:n,data:!0,blockID:i}),y.push({action:"setAttrViewColHidden",id:w.id,avID:n,data:!1,blockID:i}),w.hidden=!0)}),b.length>0&&(U(t.protyle,b,y),d.innerHTML=rs(o.view),ke(d,c.right-d.clientWidth,c.bottom,c.height)),p.preventDefault(),p.stopPropagation();break}else if(h==="editCol"){d.innerHTML=Ra({protyle:t.protyle,data:o,colId:m.dataset.id,isCustomAttr:s}),Oa({protyle:t.protyle,data:o,menuElement:d,isCustomAttr:s,blockID:i}),ke(d,c.right-d.clientWidth,c.bottom,c.height),p.preventDefault(),p.stopPropagation();break}else if(h==="updateColType"){if(m.dataset.newType!==m.dataset.oldType){const y=e.querySelector('.b3-text-field[data-type="name"]').value;let w=y;if(o.view.columns.find(_=>{if(_.id===t.colId)return _.type=m.dataset.newType,Nl(m.dataset.oldType)===y&&(w=Nl(m.dataset.newType),_.name=w),!0}),U(t.protyle,[{action:"updateAttrViewCol",id:t.colId,avID:n,name:w,type:m.dataset.newType}],[{action:"updateAttrViewCol",id:t.colId,avID:n,name:y,type:m.dataset.oldType}]),m.dataset.newType==="lineNumber"){if(o.view.sorts.find(S=>S.column===t.colId)){const S=Object.assign([],o.view.sorts),k=o.view.sorts.filter(A=>A.column!==t.colId);U(t.protyle,[{action:"setAttrViewSorts",avID:o.id,data:k,blockID:i}],[{action:"setAttrViewSorts",avID:o.id,data:S,blockID:i}])}if(o.view.filters.find(S=>S.column===t.colId)){const S=JSON.parse(JSON.stringify(o.view.filters)),k=o.view.filters.filter(A=>A.column!==t.colId);U(t.protyle,[{action:"setAttrViewFilters",avID:o.id,data:k,blockID:i}],[{action:"setAttrViewFilters",avID:o.id,data:S,blockID:i}])}}}d.innerHTML=Ra({protyle:t.protyle,data:o,colId:t.colId,isCustomAttr:s}),Oa({protyle:t.protyle,data:o,menuElement:d,isCustomAttr:s,blockID:i}),ke(d,c.right-d.clientWidth,c.bottom,c.height),p.preventDefault(),p.stopPropagation();break}else if(h==="goUpdateColType"){const b=L(m,"b3-menu");b&&(b.firstElementChild.classList.add("fn__none"),b.lastElementChild.classList.remove("fn__none")),ke(d,c.right-d.clientWidth,c.bottom,c.height),p.preventDefault(),p.stopPropagation();break}else if(h==="goSearchAV"){dc(n,m,void 0,!1),p.preventDefault(),p.stopPropagation();break}else if(h==="goSearchRollupCol"){X_({target:m,data:o,isRelation:!0,protyle:t.protyle,colId:t.colId||d.querySelector(".b3-menu__item").getAttribute("data-col-id")}),p.preventDefault(),p.stopPropagation();break}else if(h==="goSearchRollupTarget"){X_({target:m,data:o,isRelation:!1,protyle:t.protyle,colId:t.colId||d.querySelector(".b3-menu__item").getAttribute("data-col-id")}),p.preventDefault(),p.stopPropagation();break}else if(h==="goSearchRollupCalc"){q_(t.protyle,m,{data:o,colId:t.colId||d.querySelector(".b3-menu__item").getAttribute("data-col-id"),blockID:i}),p.preventDefault(),p.stopPropagation();break}else if(h==="updateRelation"){hL({protyle:t.protyle,avElement:e,avID:n,colsData:o.view.columns,blockElement:t.blockElement}),p.preventDefault(),p.stopPropagation();break}else if(h==="goEditCol"){const b=L(m,"b3-menu");b&&(b.firstElementChild.classList.remove("fn__none"),b.lastElementChild.classList.add("fn__none")),ke(d,c.right-d.clientWidth,c.bottom,c.height),p.preventDefault(),p.stopPropagation();break}else if(h==="hideCol"){const b=d.querySelector('[data-type="go-properties"]'),y=b?d.querySelector(".b3-menu__item").getAttribute("data-col-id"):m.parentElement.getAttribute("data-id");U(t.protyle,[{action:"setAttrViewColHidden",id:y,avID:n,data:!0,blockID:i}],[{action:"setAttrViewColHidden",id:y,avID:n,data:!1,blockID:i}]),o.view.columns.find(w=>w.id===y).hidden=!0,b?(d.innerHTML=Ra({protyle:t.protyle,data:o,colId:y,isCustomAttr:s}),Oa({protyle:t.protyle,data:o,menuElement:d,isCustomAttr:s,blockID:i})):d.innerHTML=rs(o.view),ke(d,c.right-d.clientWidth,c.bottom,c.height),p.preventDefault(),p.stopPropagation();break}else if(h==="showCol"){const b=d.querySelector('[data-type="go-properties"]'),y=b?d.querySelector(".b3-menu__item").getAttribute("data-col-id"):m.parentElement.getAttribute("data-id");U(t.protyle,[{action:"setAttrViewColHidden",id:y,avID:n,data:!1,blockID:i}],[{action:"setAttrViewColHidden",id:y,avID:n,data:!0,blockID:i}]),o.view.columns.find(w=>w.id===y).hidden=!1,b?(d.innerHTML=Ra({protyle:t.protyle,data:o,colId:y,isCustomAttr:s}),Oa({protyle:t.protyle,data:o,menuElement:d,isCustomAttr:s,blockID:i})):d.innerHTML=rs(o.view),ke(d,c.right-d.clientWidth,c.bottom,c.height),p.preventDefault(),p.stopPropagation();break}else if(h==="duplicateCol"){sv({blockElement:t.blockElement,protyle:t.protyle,colId:d.querySelector(".b3-menu__item").getAttribute("data-col-id"),data:o,viewID:o.viewID}),p.preventDefault(),p.stopPropagation();break}else if(h==="removeCol"){s||(c=t.blockElement.querySelector(".av__views").getBoundingClientRect());const b=d.querySelector(".b3-menu__item").getAttribute("data-col-id"),y=o.view.columns.find(_=>{if(_.id===b)return!0}),w=y.type==="relation"&&y.relation?.isTwoWay;if(s||w){const _=new we({title:w?window.siyuan.languages.removeCol.replace("${x}",d.querySelector("input").value):window.siyuan.languages.deleteOpConfirm,content:`<div class="b3-dialog__content">
    ${w?window.siyuan.languages.confirmRemoveRelationField.replace("${x}",d.querySelector('.b3-menu__item[data-type="goSearchAV"] .b3-menu__accelerator').textContent):window.siyuan.languages.removeCol.replace("${x}",d.querySelector("input").value)}
    <div class="fn__hr--b"></div>
    <button class="fn__block b3-button b3-button--remove" data-action="delete">${window.siyuan.languages.delete}</button>
    <div class="fn__hr"></div>
    <button class="fn__block b3-button b3-button--remove${w?"":" fn__none"}" data-action="keep-relation">${window.siyuan.languages.removeButKeepRelationField}</button>
    <div class="fn__hr"></div>
    <button class="fn__block b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button>
</div>`});_.element.addEventListener("click",x=>{let S=x.target;const k=typeof x.detail=="string";for(;S&&!S.isSameNode(_.element)||k;){const A=S.getAttribute("data-action");if(A==="delete"||k&&x.detail==="Enter"){Am({protyle:t.protyle,data:o,avID:n,blockID:i,menuElement:d,isCustomAttr:s,blockElement:t.blockElement,avPanelElement:e,tabRect:c,isTwoWay:!0}),_.destroy();break}else if(A==="keep-relation"){Am({protyle:t.protyle,data:o,avID:n,blockID:i,menuElement:d,isCustomAttr:s,blockElement:t.blockElement,avPanelElement:e,tabRect:c,isTwoWay:!1}),_.destroy();break}else if(S.classList.contains("b3-button--cancel")||k&&x.detail==="Escape"){_.destroy();break}S=S.parentElement}}),_.element.setAttribute("data-key",u.DIALOG_CONFIRM)}else Am({protyle:t.protyle,data:o,avID:n,blockID:i,menuElement:d,isCustomAttr:s,blockElement:t.blockElement,avPanelElement:e,tabRect:c,isTwoWay:!1});p.preventDefault(),p.stopPropagation();break}else if(h==="setColOption"){kx(t.protyle,o,m,t.blockElement,s,t.cellElements),p.preventDefault(),p.stopPropagation();break}else if(h==="setRelationCell"){qw(t.protyle,t.blockElement,m,t.cellElements),p.preventDefault(),p.stopPropagation();break}else if(h==="addColOptionOrCell"){m.querySelector(".b3-menu__checked")?Jf(t.protyle,t.cellElements,d.querySelector(`.b3-chips .b3-chip[data-content="${Xe(m.dataset.name)}"]`),t.blockElement):G_(t.protyle,o,t.cellElements,m,d,t.blockElement),window.siyuan.menus.menu.remove(),p.preventDefault(),p.stopPropagation();break}else if(h==="removeCellOption"){Jf(t.protyle,t.cellElements,m.parentElement,t.blockElement),p.preventDefault(),p.stopPropagation();break}else if(h==="addAssetLink"){hx(t.protyle,t.cellElements,m,t.blockElement),p.preventDefault(),p.stopPropagation();break}else if(h==="addAssetExist"){const b=m.getBoundingClientRect();dm(t.protyle,{x:b.right,y:b.bottom,w:m.parentElement.clientWidth+8,h:b.height},(y,w)=>{let _;u.SIYUAN_ASSETS_IMAGE.includes(Ee().extname(y).toLowerCase())?_={type:"image",content:y,name:""}:_={type:"file",content:y,name:w},po({protyle:t.protyle,cellElements:t.cellElements,addValue:[_],blockElement:t.blockElement}),window.siyuan.menus.menu.remove()}),p.preventDefault(),p.stopPropagation();break}else if(h==="openAssetItem"){const b=m.parentElement.dataset.content,y=Ee().extname(b);Qs(b)&&[".pdf"].concat(u.SIYUAN_ASSETS_AUDIO).concat(u.SIYUAN_ASSETS_VIDEO).includes(y)&&(y!==".pdf"||y===".pdf"&&!b.startsWith("file://"))?Ul(t.protyle.app,b.trim(),parseInt(It("page",b)),"right"):u.SIYUAN_ASSETS_IMAGE.includes(y)?_c(b):window.open(b),p.preventDefault(),p.stopPropagation();break}else if(h==="editAssetItem"){Kf({protyle:t.protyle,cellElements:t.cellElements,blockElement:t.blockElement,content:m.parentElement.dataset.content,type:m.parentElement.dataset.type,name:m.parentElement.dataset.name,index:parseInt(m.parentElement.dataset.index),rect:m.parentElement.getBoundingClientRect()}),p.preventDefault(),p.stopPropagation();break}else if(h==="clearDate"){Tn(t.protyle,t.blockElement,{isNotEmpty2:!1,isNotEmpty:!1,content:null,content2:null,hasEndDate:!1,isNotTime:!0},t.cellElements),e.remove(),p.preventDefault(),p.stopPropagation();break}else if(h==="av-add"){window.siyuan.menus.menu.remove(),Y_(t.protyle,t.blockElement),e.remove(),p.preventDefault(),p.stopPropagation();break}else if(h==="av-view-switch"){m.parentElement.classList.contains("b3-menu__item--current")||(e.querySelector(".b3-menu__item--current")?.classList.remove("b3-menu__item--current"),m.parentElement.classList.add("b3-menu__item--current"),t.blockElement.removeAttribute("data-render"),dt(t.blockElement,t.protyle,void 0,m.parentElement.dataset.id)),p.preventDefault(),p.stopPropagation();break}else if(h==="av-view-edit"){m.parentElement.classList.contains("b3-menu__item--current")?Ec({protyle:t.protyle,blockElement:t.blockElement,element:m.parentElement}):(e.querySelector(".b3-menu__item--current")?.classList.remove("b3-menu__item--current"),m.parentElement.classList.add("b3-menu__item--current"),t.blockElement.removeAttribute("data-render"),dt(t.blockElement,t.protyle,()=>{Ec({protyle:t.protyle,blockElement:t.blockElement,element:m.parentElement}),e.querySelector(".b3-chip--primary").classList.remove("b3-chip--primary"),m.parentElement.querySelector(".b3-chip").classList.add("b3-chip--primary")},m.parentElement.dataset.id)),p.preventDefault(),p.stopPropagation();break}if(!m||!m.parentElement)break;m=m.parentElement}})})},rs=t=>{let e="",n="";return t.columns.forEach(a=>{a.hidden?n+=`<button class="b3-menu__item" data-type="editCol" draggable="true" data-id="${a.id}">
    <svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>
    <div class="b3-menu__label fn__flex">
        ${a.icon?ge(a.icon,"b3-menu__icon",!0):`<svg class="b3-menu__icon"><use xlink:href="#${sn(a.type)}"></use></svg>`}
        ${pe(a.name)||"&nbsp;"}
    </div>
    <svg class="b3-menu__action" data-type="showCol"><use xlink:href="#iconEye"></use></svg>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>`:e+=`<button class="b3-menu__item" data-type="editCol" draggable="true" data-id="${a.id}">
    <svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>
    <div class="b3-menu__label fn__flex">
        ${a.icon?ge(a.icon,"b3-menu__icon",!0):`<svg class="b3-menu__icon"><use xlink:href="#${sn(a.type)}"></use></svg>`}
        ${pe(a.name)||"&nbsp;"}
    </div>
    <svg class="b3-menu__action${a.type==="block"?" fn__none":""}" data-type="hideCol"><use xlink:href="#iconEyeoff"></use></svg>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>`}),n&&(n=`<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="nobg">
    <span class="b3-menu__label">
        ${window.siyuan.languages.hideCol} 
    </span>
    <span class="block__icon" data-type="showAllCol">
        ${window.siyuan.languages.showAll}
        <span class="fn__space"></span>
        <svg><use xlink:href="#iconEye"></use></svg>
    </span>
</button>
${n}`),`<div class="b3-menu__items">
<button class="b3-menu__item" data-type="nobg">
    <span class="block__icon" style="padding: 8px;margin-left: -4px;" data-type="go-config">
        <svg><use xlink:href="#iconLeft"></use></svg>
    </span>
    <span class="b3-menu__label ft__center">${window.siyuan.languages.fields}</span>
</button>
<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="nobg">
    <span class="b3-menu__label">
        ${window.siyuan.languages.showCol} 
    </span>
    <span class="block__icon" data-type="hideAllCol">
        ${window.siyuan.languages.hideAll}
        <span class="fn__space"></span>
        <svg><use xlink:href="#iconEyeoff"></use></svg>
    </span>
</button>
${e}
${n}
<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="newCol">
    <svg class="b3-menu__icon"><use xlink:href="#iconAdd"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.new}</span>
</button>
</div>`},tv=t=>{let e=t,n="";try{const a=new URL(t);a.protocol.startsWith("http")&&(e=a.host,n=a.href.replace(a.origin,""),n.length>12&&(n=n.substring(0,4)+"..."+n.substring(n.length-6)))}catch{e=Lute.EscapeHTMLStr(t)}return`<span class="av__celltext av__celltext--url" data-type="url" data-href="${Xe(t)}"><span>${e}</span><span class="ft__on-surface">${n}</span></span>`},go=t=>{if(!t)return"";let e="";const n=t.querySelectorAll(".b3-chip, .av__celltext--ref, .av__celltext");return n.length>0?(n.forEach(a=>{a.querySelector(".av__cellicon")?e+=`${a.firstChild.textContent} \u2192 ${a.lastChild.textContent}, `:a.getAttribute("data-type")==="url"?e=a.getAttribute("data-href")+", ":a.getAttribute("data-type")!=="block-more"&&(e+=a.textContent+", ")}),e=e.substring(0,e.length-2)):e=t.textContent,e},ga=(t,e)=>{const n={type:t,id:e.dataset.id};if(t==="number"){const a=e.querySelector(".av__celltext").getAttribute("data-content");n.number={content:parseFloat(a)||0,isNotEmpty:!!a}}else if(["text","block","url","phone","email","template"].includes(t)){const a=e.querySelector(".av__celltext");n[t]={content:t==="url"?a.dataset.href:a.textContent},t==="block"&&a.dataset.id&&(n.block.id=a.dataset.id,a.previousElementSibling?.classList.contains("b3-menu__avemoji")&&(n.block.icon=a.previousElementSibling.getAttribute("data-unicode")))}else if(t==="mSelect"||t==="select"){const a=[];e.querySelectorAll(".b3-chip").forEach(i=>{a.push({content:i.textContent.trim(),color:i.style.color.replace("var(--b3-font-color","").replace(")","")})}),n.mSelect=a}else if(["date","created","updated"].includes(t))n[t]=JSON.parse(e.querySelector(".av__celltext").getAttribute("data-value"));else if(t==="checkbox")n.checkbox={checked:e.querySelector("use").getAttribute("xlink:href")==="#iconCheck"};else if(t==="relation"){const a=[],i=[];Array.from(e.querySelectorAll(".av__cell--relation")).forEach(s=>{const o=s.querySelector(".av__celltext");a.push(o.dataset.id),i.push({isDetached:!o.classList.contains("av__celltext--ref"),block:{content:o.textContent,id:o.dataset.id},type:"block"})}),n.relation={blockIDs:a,contents:i}}else if(t==="mAsset"){const a=[];Array.from(e.children).forEach(i=>{if(i.classList.contains("av__drag-fill"))return;const s=i.classList.contains("av__cellassetimg");a.push({type:s?"image":"file",content:s?i.getAttribute("src"):i.getAttribute("data-url"),name:s?"":i.getAttribute("data-name")})}),n.mAsset=a}return t==="block"&&(n.isDetached=e.dataset.detached==="true"),n},si=(t,e)=>{let n={type:t,[t==="select"?"mSelect":t]:e};if(typeof e=="string"&&e){if(t==="number")n={type:t,number:{content:parseFloat(e)||0,isNotEmpty:!0}};else if(["text","block","url","phone","email","template"].includes(t))n={type:t,[t]:{content:e}};else if(t==="mSelect"||t==="select")n={type:t,mSelect:[{content:e,color:"1"}]};else if(t==="checkbox")n={type:t,checkbox:{checked:!0}};else if(t==="date"){let a=e.split("\u2192");a.length!==2&&(a=e.split("-"),a.length!==2&&(a=e.split("~")));const i=Y(a[0]),s=Y(a[1]||"");isNaN(i.valueOf())?n={type:t,date:{content:null,isNotEmpty:!1,content2:null,isNotEmpty2:!1,formattedContent:"",hasEndDate:!1,isNotTime:!0}}:n={type:t,date:{content:i.valueOf(),isNotEmpty:!0,content2:s.valueOf()||0,isNotEmpty2:!isNaN(s.valueOf()),hasEndDate:!isNaN(s.valueOf()),isNotTime:i.hour()===0,formattedContent:""}}}else if(t==="relation")n={type:t,relation:{blockIDs:[e],contents:[]}};else if(t==="mAsset"){const a=Ee().extname(e).toLowerCase();n={type:t,mAsset:[{type:u.SIYUAN_ASSETS_IMAGE.includes(a)?"image":"file",content:e,name:""}]}}}else(typeof e>"u"||!e)&&(t==="number"?n={type:t,number:{content:null,isNotEmpty:!1}}:["text","block","url","phone","email","template"].includes(t)?n={type:t,[t]:{content:""}}:t==="mSelect"||t==="select"||t==="mAsset"?n={type:t,[t==="select"?"mSelect":t]:[]}:["date","created","updated"].includes(t)?n={type:t,[t]:{content:null,isNotEmpty:!1,content2:null,isNotEmpty2:!1,hasEndDate:!1,isNotTime:!0}}:t==="checkbox"?n={type:t,checkbox:{checked:!1}}:t==="relation"?n={type:t,relation:{blockIDs:[],contents:[]}}:t==="rollup"&&(n={type:t,rollup:{contents:[]}}));return t==="block"&&(typeof e=="object"&&e.id?n.isDetached=!1:n.isDetached=!0),n},Ii=(t,e,n=!0)=>{const a=e.getBoundingClientRect();if(!n){const s=t.querySelector(".av__scroll"),o=L(e,"av__row");if(s&&o){const l=o.querySelector(".av__colsticky");if(!l.contains(e)){const r=l.getBoundingClientRect().right,d=s.getBoundingClientRect();r>a.left||d.right<a.left?s.scrollLeft=s.scrollLeft+a.left-r:r<a.left&&d.right<a.right&&(a.width+r>d.right?s.scrollLeft=s.scrollLeft+a.left-r:s.scrollLeft=s.scrollLeft+a.right-d.right)}}}if(!t.querySelector(".av__header"))return;const i=t.querySelector(".av__row--header").getBoundingClientRect();if(i.bottom>a.top){const s=L(t,"protyle-content",!0);s&&(s.scrollTop=s.scrollTop+a.top-i.bottom)}else{const s=t.querySelector(".av__row--footer");if(s.querySelector(".av__calc--ashow")){const o=s.getBoundingClientRect();if(o.top<a.bottom){const l=L(t,"protyle-content",!0);l&&(l.scrollTop=l.scrollTop+a.bottom-o.top)}}else{const o=L(t,"protyle-content",!0);if(o){const l=o.getBoundingClientRect();a.bottom>l.bottom&&(o.scrollTop=o.scrollTop+(a.top-l.top-33))}}}},vn=t=>{const e=L(t,"av__scroll");if(e)return e.querySelector(".av__row--header").querySelector(`[data-col-id="${t.getAttribute("data-col-id")}"]`).getAttribute("data-dtype")},Kn=(t,e,n)=>{if(e.length===0||e.length===1&&!e[0]||(n||(n=vn(e[0])),n==="updated"||n==="created"||document.querySelector(".av__mask")))return;const a=P(e[0]);if(!a)return;let i=e[0].getBoundingClientRect();const s=L(a,"protyle-content",!0);Ii(a,e[0],!1),i=e[0].getBoundingClientRect();let o="",l=i.height,r;if(s){const g=s.getBoundingClientRect();i.bottom>g.bottom&&(l=g.bottom-i.top);const p=Math.min(Math.max(i.width,25),g.width);r=`style="padding-top: 6.5px;position:absolute;left: ${i.left<g.left||i.left+p>g.right?g.left:i.left}px;top: ${i.top}px;width:${p}px;height: ${l}px"`}else r=`style="padding-top: 6.5px;position:absolute;left: ${i.left}px;top: ${i.top}px;width:${Math.max(i.width,25)}px;height: ${l}px"`;if(["text","email","phone","block","template"].includes(n))o=`<textarea ${r} spellcheck="false" class="b3-text-field"></textarea>`;else if(n==="url")o=`<textarea ${r} spellcheck="false" class="b3-text-field">${e[0].firstElementChild.getAttribute("data-href")}</textarea>`;else if(n==="number")o=`<input type="number" spellcheck="false" value="${e[0].firstElementChild.getAttribute("data-content")}" ${r} class="b3-text-field">`;else{["select","mSelect"].includes(n)?hn({protyle:t,blockElement:a,type:"select",cellElements:e}):n==="mAsset"?(hn({protyle:t,blockElement:a,type:"asset",cellElements:e}),ae(a)):n==="date"?hn({protyle:t,blockElement:a,type:"date",cellElements:e}):n==="checkbox"?km(t,n,a,e):n==="relation"?hn({protyle:t,blockElement:a,type:"relation",cellElements:e}):n==="rollup"&&hn({protyle:t,blockElement:a,type:"rollup",cellElements:e,colId:e[0].dataset.colId}),L(e[0],"custom-attr")||(e[0].classList.add("av__cell--select"),In(e[0]));return}window.siyuan.menus.menu.remove(),document.body.insertAdjacentHTML("beforeend",`<div class="av__mask" style="z-index: ${++window.siyuan.zIndex}">
    ${o}
</div>`);const d=document.querySelector(".av__mask"),c=d.querySelector(".b3-text-field");c&&(["text","email","phone","block","template"].includes(n)&&(c.value=e[0].querySelector(".av__celltext")?.textContent||""),c.select(),c.focus(),n==="template"&&E("/api/av/renderAttributeView",{id:a.dataset.avId,viewID:a.getAttribute(u.CUSTOM_SY_AV_VIEW)},g=>{g.data.view.columns.find(p=>{if(p.id===e[0].dataset.colId)return c.value=p.template,c.dataset.template=p.template,!0})}),n==="block"&&c.addEventListener("input",g=>{if(u.BLOCK_HINT_KEYS.includes(c.value.substring(0,2))){if(t.toolbar.range=document.createRange(),!a.contains(e[0])){const h=L(e[0],"av__row");e[0]&&(e[0]=a.querySelector(`.av__row[data-id="${h.dataset.id}"] .av__cell[data-col-id="${e[0].dataset.colId}"]`))}t.toolbar.range.selectNodeContents(e[0].lastChild),Z(t.toolbar.range),e[0].classList.add("av__cell--select"),In(e[0]);let p=c.value;wi(p)?p=p.substring(2,22+2):p=p.substring(2),ss(p,t,"av"),d?.remove(),g.preventDefault(),g.stopPropagation()}}),c.addEventListener("keydown",g=>{g.isComposing||ni(g)||(g.key==="Escape"||g.key==="Tab"||g.key==="Enter"&&!g.shiftKey&&qe(g))&&(km(t,n,a,e),g.key==="Tab"&&t.wysiwyg.element.dispatchEvent(new KeyboardEvent("keydown",{shiftKey:g.shiftKey,ctrlKey:g.ctrlKey,altKey:g.altKey,metaKey:g.metaKey,key:"Tab",keyCode:9})),g.preventDefault(),g.stopPropagation())}));const f=g=>{g.target.classList.contains("av__mask")&&document.activeElement.tagName!=="TEXTAREA"&&document.activeElement.tagName!=="INPUT"&&(km(t,n,a,e),d?.remove())};d.addEventListener("click",g=>{f(g)}),d.addEventListener("contextmenu",g=>{f(g)}),d.addEventListener("mousedown",g=>{g.button===1&&(g.target.classList.contains("av__mask")&&document.activeElement&&document.activeElement.nodeType===1&&document.activeElement.blur(),f(g))})},km=(t,e,n,a)=>{const i=L(a[0],"av__row");if(!i||a.length===1&&a[0].dataset.detached==="true"&&!i.dataset.id)return;const s=document.querySelector(".av__mask"),o=n.getAttribute("data-av-id");if(e==="template"){const l=a[0].getAttribute("data-col-id"),r=s.querySelector(".b3-text-field");r.value!==r.dataset.template&&!n.getAttribute("data-loading")&&(U(t,[{action:"updateAttrViewColTemplate",id:l,avID:o,data:r.value,type:"template"}],[{action:"updateAttrViewColTemplate",id:l,avID:o,data:r.dataset.template,type:"template"}]),n.setAttribute("data-loading","true"))}else Tn(t,n,e==="checkbox"?{checked:a[0].querySelector("use").getAttribute("xlink:href")==="#iconUncheck"}:s.querySelector(".b3-text-field").value,a);a[0]&&!L(a[0],"custom-attr")&&(a[0].classList.add("av__cell--select"),In(a[0])),document.querySelector(".b3-dialog")||ae(n),document.querySelectorAll(".av__mask").forEach(l=>{l.remove()})},Tn=(t,e,n,a,i,s)=>{const o=[],l=[],r=e.dataset.avId,d=e.dataset.nodeId;let c="";const f=[];let g;a?.length>0?g=a:(g=Array.from(e.querySelectorAll(".av__cell--active, .av__cell--select")),g.length===0&&e.querySelectorAll(".av__row--select:not(.av__row--header)").forEach(h=>{h.querySelectorAll(".av__cell").forEach(m=>{g.push(m)})}));const p=L(g[0],"custom-attr");return g.forEach((h,m)=>{const b=L(h,"av__row");if(!b||(e.contains(h)||(h=g[m]=e.querySelector(`.av__row[data-id="${b.dataset.id}"] .av__cell[data-col-id="${h.dataset.colId}"]`)||e.querySelector(`.fn__flex-1[data-col-id="${h.dataset.colId}"]`)),!h))return;const y=vn(h)||h.dataset.type;if(["created","updated","template","rollup"].includes(y))return;const w=b.getAttribute("data-id"),_=h.dataset.id,x=h.dataset.colId;c+=go(h)+(g[m+1]&&h.nextElementSibling&&h.nextElementSibling.isSameNode(g[m+1])?"	":`

`);const S=ga(y,h);(m===0||!g[m-1].isSameNode(h.previousElementSibling))&&f.push([]),f[f.length-1].push(S);let k=n;if(y==="mAsset"){if(Array.isArray(n))k=S.mAsset.concat(n);else if(typeof n<"u"){let $=t.lute.GetLinkDest(n),M="",C="";if(!$&&n.startsWith("assets/")&&($=n,M=Jr(n)+Ee().extname(n)),s){const N=document.createElement("template");N.innerHTML=s;const O=N.content.querySelector('[data-type~="a"]');if(O)$=O.getAttribute("data-href"),M=O.textContent;else{const te=N.content.querySelector(".img img");te&&(C=te.getAttribute("data-src"))}}if($||(M=n),!$&&!M&&!C)return;C?k=S.mAsset.concat({type:"image",content:C,name:""}):k=S.mAsset.concat({type:"file",content:$,name:M})}}else if(y==="mSelect"){if(typeof n=="string"){const $=[];let M=S.mSelect.length;[...new Set(n.split(",").map(C=>C.trim().replace(/\n|\r\n|\r|\u2028|\u2029/g,"")))].forEach(C=>{if(!C)return;let N=!1;S.mSelect.find(O=>{if(O.content===C)return N=!0,!0}),!N&&(M++,$.push({content:C,color:M.toString()}))}),k=S.mSelect.concat($)}}else y==="block"&&typeof n=="string"&&S.block.id&&(k={content:n,id:S.block.id},S.block.icon&&(k.icon=S.block.icon));const A=si(y,k);if(A.id=_,!(A.type==="date"&&typeof A.date=="string"||A.type==="relation"&&typeof A.relation=="string")){if(i&&(y==="select"||y==="mSelect")){const $=j_(i.find(M=>M.id===x),A,r);o.push(...$.doOperations),l.push(...$.undoOperations)}tn(A,S)||(o.push({action:"updateAttrViewCell",id:_,avID:r,keyID:x,rowID:w,data:A}),l.push({action:"updateAttrViewCell",id:_,avID:r,keyID:x,rowID:w,data:S}),p?h.innerHTML=Ci(A):gn(h,A))}}),o.length>0&&(o.push({action:"doUpdateUpdated",id:d,data:Y().format("YYYYMMDDHHmmss")}),l.push({action:"doUpdateUpdated",id:d,data:e.getAttribute("updated")}),U(t,o,l)),{text:c.substring(0,c.length-2),json:f}},Sm=(t,e)=>{e.type==="checkbox"?e.checkbox.checked?(t.classList.add("av__cell-check"),t.classList.remove("av__cell-uncheck")):(t.classList.remove("av__cell-check"),t.classList.add("av__cell-uncheck")):e.type==="block"&&(e.block.id&&t.setAttribute("data-block-id",e.block.id),e.isDetached?t.setAttribute("data-detached","true"):t.removeAttribute("data-detached"))},kc=(t,e=0)=>{let n="";if(t.type==="template")n=`<span class="av__celltext">${t&&t.template.content||""}</span>`;else if(t.type==="text")n=`<span class="av__celltext">${t?Lute.EscapeHTMLStr(t.text.content||""):""}</span>`;else if(["email","phone"].includes(t.type))n=`<span class="av__celltext av__celltext--url" data-type="${t.type}">${t?Lute.EscapeHTMLStr(t[t.type].content||""):""}</span>`;else if(t.type==="url")n=tv(t?.url?.content||"");else if(t.type==="block")t?.isDetached?n=`<span class="av__celltext">${Lute.EscapeHTMLStr(t.block.content||"")}</span><span class="b3-chip b3-chip--info b3-chip--small" data-type="block-more">${window.siyuan.languages.more}</span>`:n=`<span class="b3-menu__avemoji" data-unicode="${t.block.icon||""}">${ge(t.block.icon||window.siyuan.storage[u.LOCAL_IMAGES].file)}</span><span data-type="block-ref" data-id="${t.block.id}" data-subtype="s" class="av__celltext av__celltext--ref">${Lute.EscapeHTMLStr(t.block.content)}</span><span class="b3-chip b3-chip--info b3-chip--small" data-type="block-more">${window.siyuan.languages.update}</span>`;else if(t.type==="number")n=`<span class="av__celltext" data-content="${t?.number.isNotEmpty?t?.number.content:""}">${t?.number.formattedContent||t?.number.content||""}</span>`;else if(t.type==="mSelect"||t.type==="select")t?.mSelect?.forEach((a,i)=>{t.type==="select"&&i>0||(n+=`<span class="b3-chip" style="background-color:var(--b3-font-background${a.color});color:var(--b3-font-color${a.color})">${pe(a.content)}</span>`)});else if(t.type==="date"){const a=t?t.date:null;n=`<span class="av__celltext" data-value='${JSON.stringify(a)}'>`,a&&a.isNotEmpty&&(n+=Y(a.content).format(a.isNotTime?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")),a&&a.hasEndDate&&a.isNotEmpty&&a.isNotEmpty2&&(n+=`<svg class="av__cellicon"><use xlink:href="#iconForward"></use></svg>${Y(a.content2).format(a.isNotTime?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")}`),n+="</span>"}else if(["created","updated"].includes(t.type)){const a=t?t[t.type]:null;n=`<span class="av__celltext" data-value='${JSON.stringify(a)}'>`,a&&a.isNotEmpty&&(n+=Y(a.content).format("YYYY-MM-DD HH:mm")),n+="</span>"}else["lineNumber"].includes(t.type)?n=`<span class="av__celltext" data-value='${e+1}'>${e+1}</span>`:t.type==="mAsset"?t?.mAsset?.forEach(a=>{a.type==="image"?n+=`<img class="av__cellassetimg ariaLabel" aria-label="${a.content}" src="${a.content}">`:n+=`<span class="b3-chip av__celltext--url ariaLabel" aria-label="${Xe(a.content)}" data-name="${Xe(a.name)}" data-url="${Xe(a.content)}">${a.name||a.content}</span>`}):t.type==="checkbox"?n+=`<svg class="av__checkbox"><use xlink:href="#icon${t?.checkbox?.checked?"Check":"Uncheck"}"></use></svg>`:t.type==="rollup"?(t?.rollup?.contents?.forEach(a=>{const i=["select","mSelect","mAsset","checkbox","relation"].includes(a.type)?kc(a):Cx(a);i&&(n+=i+", ")}),n&&n.endsWith(", ")&&(n=n.substring(0,n.length-2))):t.type==="relation"&&(t?.relation?.contents?.forEach(a=>{a&&a.block&&(a?.isDetached?n+=`<span class="av__cell--relation"><span>\u2796 </span><span class="av__celltext" data-id="${a.block?.id}">${Lute.EscapeHTMLStr(a.block.content||window.siyuan.languages.untitled)}</span></span>`:n+=`<span class="av__cell--relation" data-block-id="${a.block.id}"><span class="b3-menu__avemoji" data-unicode="${a.block.icon||""}">${ge(a.block.icon||window.siyuan.storage[u.LOCAL_IMAGES].file)}</span><span data-type="block-ref" data-id="${a.block.id}" data-subtype="s" class="av__celltext av__celltext--ref">${Lute.EscapeHTMLStr(a.block.content||window.siyuan.languages.untitled)}</span></span>`)}),n&&n.endsWith(", ")&&(n=n.substring(0,n.length-2)));return(["text","template","url","email","phone","number","date","created","updated"].includes(t.type)&&t[t.type]?.content||t.type==="lineNumber"||t.type==="block"&&t.block?.content)&&(n+=`<span ${t.type!=="number"?"":'style="right:auto;left:5px"'} data-type="copy" class="block__icon"><svg><use xlink:href="#iconCopy"></use></svg></span>`),n},Cx=t=>{let e="";if(["text"].includes(t.type))e=t&&t[t.type].content||"";else if(["email","phone"].includes(t.type)){const n=t?t[t.type].content:"";n&&(e=`<span class="av__celltext av__celltext--url" data-type="${t.type}">${n}</span>`)}else if(t.type==="url"){const n=t?.url?.content||"";n&&(e=tv(n))}else if(t.type==="block")t?.isDetached?e=`<span class="av__celltext" data-id="${t.block?.id}">${Lute.EscapeHTMLStr(t.block?.content||window.siyuan.languages.untitled)}</span>`:e=`<span data-type="block-ref" data-id="${t.block?.id}" data-subtype="s" class="av__celltext av__celltext--ref">${Lute.EscapeHTMLStr(t.block?.content||window.siyuan.languages.untitled)}</span>`;else if(t.type==="number")e=t?.number.formattedContent||t?.number.content.toString()||"";else if(t.type==="date"){const n=t?t.date:null;n.formattedContent?e=n.formattedContent:(n&&n.isNotEmpty&&(e=Y(n.content).format(n.isNotTime?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")),n&&n.hasEndDate&&n.isNotEmpty&&n.isNotEmpty2&&(e=`<svg class="av__cellicon"><use xlink:href="#iconForward"></use></svg>${Y(n.content2).format(n.isNotTime?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")}`)),e&&(e=`<span class="av__celltext">${e}</span>`)}return e},Tx=(t,e)=>{if(typeof e.icon<"u"&&(t.dataset.icon=e.icon,t.querySelector(".av__cellheadericon").outerHTML=e.icon?ge(e.icon,"av__cellheadericon",!0):`<svg class="av__cellheadericon"><use xlink:href="#${sn(t.dataset.dtype)}"></use></svg>`),typeof e.name<"u"&&(t.querySelector(".av__celltext").textContent=e.name),typeof e.pin<"u"){const n=t.querySelector(".av__celltext");e.pin?t.querySelector(".av__cellheadericon--pin")||n.insertAdjacentHTML("afterend",'<svg class="av__cellheadericon av__cellheadericon--pin"><use xlink:href="#iconPin"></use></svg>'):t.querySelector(".av__cellheadericon--pin")?.remove()}},Sc=t=>{let e=L(t,"av__row");if(!e)return;let n=-1;for(;e;)e=e.previousElementSibling,n++;let a=-2;for(;t;)t=t.previousElementSibling,t&&t.classList.contains("av__colsticky")&&(t=t.lastElementChild),a++;return{rowIndex:n,celIndex:a}},Ix=(t,e,n,a)=>{e.querySelector(".av__drag-fill")?.remove();const i={};e.querySelectorAll(".av__cell--active").forEach(d=>{if(a.includes(d.dataset.id))return;const c=L(d,"av__row");if(!c)return;i[c.dataset.id]||(i[c.dataset.id]=[]);const f=ga(vn(d),d);f.colId=d.dataset.colId,f.element=d,i[c.dataset.id].push(f)});const s=[],o=[],l=e.dataset.avId,r=Object.keys(n);Object.keys(i).forEach((d,c)=>{i[d].forEach((f,g)=>{if(["rollup","template","created","updated"].includes(f.type)||f.type==="block"&&f.element.getAttribute("data-detached")!=="true")return;const p=JSON.parse(JSON.stringify(n[r[c%r.length]][g]));p.id=f.id;const h=f.colId;p.type==="block"&&(p.isDetached=!0,delete p.block.id),s.push({action:"updateAttrViewCell",id:f.id,avID:l,keyID:h,rowID:d,data:p}),f.element.innerHTML=kc(p),Sm(f.element,p),delete f.colId,delete f.element,o.push({action:"updateAttrViewCell",id:f.id,avID:l,keyID:h,rowID:d,data:f})})}),ae(e),s.length>0&&U(t,s,o)},In=t=>{t&&(t.classList.add("av__cell--active"),t.querySelector(".av__drag-fill")||t.insertAdjacentHTML("beforeend",`<div aria-label="${window.siyuan.languages.dragFill}" class="av__drag-fill ariaLabel"></div>`))},nv=t=>{if(["select","number","date","created","updated"].includes(t))return"=";if(["checkbox"].includes(t))return"Is false";if(["rollup","relation","rollup","text","mSelect","url","block","email","phone","template"].includes(t))return"Contains"},av=(t,e,n)=>{const a=L(t,"b3-menu");if(a){if(["date","updated","created"].includes(n)){const i=a.querySelector('.b3-menu__item div[data-type="filter1"]'),s=i.nextElementSibling;e==="Is between"?(s.classList.remove("fn__none"),i.classList.remove("fn__none")):e==="Is empty"||e==="Is not empty"?(s.classList.add("fn__none"),i.classList.add("fn__none")):(i.classList.remove("fn__none"),s.classList.add("fn__none"));return}a.querySelectorAll("input, .b3-chip").forEach(i=>{const s=L(i,"b3-menu__item");s&&(e!=="Is empty"&&e!=="Is not empty"?s.classList.remove("fn__none"):s.classList.add("fn__none"))})}},iv=t=>{window.siyuan.menus.menu.element.querySelectorAll(".b3-menu__item").forEach(e=>{const n=e.querySelector(".b3-chip.b3-chip--middle");if(n){const a=n.dataset.name.toLowerCase();!t||t.indexOf(a)>-1||a.indexOf(t)>-1?e.classList.remove("fn__none"):e.classList.add("fn__none")}})},Lm=async t=>{let e=t.target.getBoundingClientRect();e.height===0&&(e=t.protyle.wysiwyg.element.querySelector(`[data-col-id="${t.target.dataset.colId}"]`).getBoundingClientRect());const n=t.blockElement.getAttribute("data-node-id"),a=new st("set-filter-"+t.filter.column,()=>{const f=JSON.parse(JSON.stringify(t.data.view.filters)),g=a.element.querySelector(".b3-select");if(!g||!g.value)return;const p={column:t.filter.column,value:{type:t.filter.value.type},operator:g.value};let h=!1,m;if(o.type==="select"||o.type==="mSelect"){const w=[];window.siyuan.menus.menu.element.querySelectorAll("svg").forEach(_=>{if(_.firstElementChild.getAttribute("xlink:href")==="#iconCheck"){const x=_.nextElementSibling.firstElementChild;w.push({color:x.dataset.color,content:x.dataset.name})}}),m=si(o.type,w)}else if(["date","updated","created"].includes(o.type)){const w=a.element.querySelector('.b3-select[data-type="dateType"]'),_=a.element.querySelectorAll('.b3-select[data-type="dataDirection"]');w.value==="custom"?(p.relativeDate={count:parseInt(_[0].parentElement.querySelector(".b3-text-field").value||"1"),unit:parseInt(_[0].parentElement.lastElementChild.value),direction:parseInt(_[0].value)},p.relativeDate2={count:parseInt(_[1].parentElement.querySelector(".b3-text-field").value||"1"),unit:parseInt(_[1].parentElement.lastElementChild.value),direction:parseInt(_[1].value)},m={type:o.type}):(m=si(o.type,{isNotEmpty2:c[2].value!=="",isNotEmpty:c[0].value!=="",content:c[0].value?new Date(c[0].value+" 00:00").getTime():null,content2:c[2].value?new Date(c[2].value+" 00:00").getTime():null,hasEndDate:p.operator==="Is between",isNotTime:!0}),p.relativeDate=null,p.relativeDate2=null)}else["text","url","block","email","phone","template","relation","number"].includes(o.type)?m=si(o.type,c[0].value):o.type==="checkbox"?m=si(o.type,{checked:p.operator==="Is true"}):m=si(o.type,void 0);t.filter.value.type==="rollup"?p.value={rollup:{contents:[m]},type:"rollup"}:p.value=m;let b=!1;if(t.data.view.filters.find((w,_)=>{if(w.column===t.filter.column&&w.value.type===t.filter.value.type)return w.value.type==="checkbox"?(h=!0,t.data.view.filters[_]=p,!0):tn(w,p)?(b=!0,!0):(t.data.view.filters[_]=p,h=!0,!0)}),b||!h)return;U(t.protyle,[{action:"setAttrViewFilters",avID:t.data.id,data:t.data.view.filters,blockID:n}],[{action:"setAttrViewFilters",avID:t.data.id,data:f,blockID:n}]);const y=L(t.target,"b3-menu");y&&(y.innerHTML=cs(t.data.view))});if(a.isOpen)return;let i="",s;t.data.view.columns.find(f=>{if(f.id===t.filter.column)return s=f,!0});let o=JSON.parse(JSON.stringify(t.filter.value));if(s.type==="rollup"){if(!s.rollup||!s.rollup.relationKeyID||!s.rollup.keyID){j(window.siyuan.languages.plsChoose),hn({protyle:t.protyle,blockElement:t.blockElement,type:"edit",colId:s.id});return}let f="";t.data.view.columns.find(p=>{if(p.id===s.rollup.relationKeyID)return f=p.relation.avID,!0}),(await Re("/api/av/getAttributeView",{id:f})).data.av.keyValues.find(p=>{if(p.key.id===s.rollup.keyID)return o.type=p.key.type,!0}),t.data.view.filters.find(p=>{if(p.column===s.id&&p.value.type==="rollup")return!p.value.rollup||!p.value.rollup.contents||p.value.rollup.contents.length===0?o={[o.type]:si(o.type,o.type==="checkbox"?{checked:void 0}:""),type:o.type}:o=p.value.rollup.contents[0],!0})}let l=!1;switch(o.type==="checkbox"&&(l=typeof o.checkbox>"u"||typeof o.checkbox.checked>"u"),o.type){case"checkbox":i=`<option ${t.filter.operator==="Is true"&&!l?"selected":""} value="Is true">${window.siyuan.languages.checked}</option>
<option ${t.filter.operator==="Is false"&&!l?"selected":""} value="Is false">${window.siyuan.languages.unchecked}</option>`,l&&(i=`<option selected></option>${i}`);break;case"block":case"text":case"url":case"phone":case"email":i=`<option ${t.filter.operator==="="?"selected":""} value="=">${window.siyuan.languages.filterOperatorIs}</option>
<option ${t.filter.operator==="!="?"selected":""} value="!=">${window.siyuan.languages.filterOperatorIsNot}</option>
<option ${t.filter.operator==="Contains"?"selected":""} value="Contains">${window.siyuan.languages.filterOperatorContains}</option>
<option ${t.filter.operator==="Does not contains"?"selected":""} value="Does not contains">${window.siyuan.languages.filterOperatorDoesNotContain}</option>
<option ${t.filter.operator==="Starts with"?"selected":""} value="Starts with">${window.siyuan.languages.filterOperatorStartsWith}</option>
<option ${t.filter.operator==="Ends with"?"selected":""} value="Ends with">${window.siyuan.languages.filterOperatorEndsWith}</option>
<option ${t.filter.operator==="Is empty"?"selected":""} value="Is empty">${window.siyuan.languages.filterOperatorIsEmpty}</option>
<option ${t.filter.operator==="Is not empty"?"selected":""} value="Is not empty">${window.siyuan.languages.filterOperatorIsNotEmpty}</option>`;break;case"template":i=`<option ${t.filter.operator==="="?"selected":""} value="=">${window.siyuan.languages.filterOperatorIs}</option>
<option ${t.filter.operator==="!="?"selected":""} value="!=">${window.siyuan.languages.filterOperatorIsNot}</option>
<option ${t.filter.operator==="Contains"?"selected":""} value="Contains">${window.siyuan.languages.filterOperatorContains}</option>
<option ${t.filter.operator==="Does not contains"?"selected":""} value="Does not contains">${window.siyuan.languages.filterOperatorDoesNotContain}</option>
<option ${t.filter.operator==="Starts with"?"selected":""} value="Starts with">${window.siyuan.languages.filterOperatorStartsWith}</option>
<option ${t.filter.operator==="Ends with"?"selected":""} value="Ends with">${window.siyuan.languages.filterOperatorEndsWith}</option>
<option ${t.filter.operator==="Is empty"?"selected":""} value="Is empty">${window.siyuan.languages.filterOperatorIsEmpty}</option>
<option ${t.filter.operator==="Is not empty"?"selected":""} value="Is not empty">${window.siyuan.languages.filterOperatorIsNotEmpty}</option>
<option ${t.filter.operator===">"?"selected":""} value=">">&gt;</option>
<option ${t.filter.operator==="<"?"selected":""} value="<">&lt;</option>
<option ${t.filter.operator===">="?"selected":""} value=">=">&GreaterEqual;</option>
<option ${t.filter.operator==="<="?"selected":""} value="<=">&le;</option>`;break;case"date":case"created":case"updated":i=`<option ${t.filter.operator==="="?"selected":""} value="=">${window.siyuan.languages.filterOperatorIs}</option>
<option ${t.filter.operator===">"?"selected":""} value=">">${window.siyuan.languages.filterOperatorIsAfter}</option>
<option ${t.filter.operator==="<"?"selected":""} value="<">${window.siyuan.languages.filterOperatorIsBefore}</option>
<option ${t.filter.operator===">="?"selected":""} value=">=">${window.siyuan.languages.filterOperatorIsOnOrAfter}</option>
<option ${t.filter.operator==="<="?"selected":""} value="<=">${window.siyuan.languages.filterOperatorIsOnOrBefore}</option>
<option ${t.filter.operator==="Is between"?"selected":""} value="Is between">${window.siyuan.languages.filterOperatorIsBetween}</option>
<option ${t.filter.operator==="Is empty"?"selected":""} value="Is empty">${window.siyuan.languages.filterOperatorIsEmpty}</option>
<option ${t.filter.operator==="Is not empty"?"selected":""} value="Is not empty">${window.siyuan.languages.filterOperatorIsNotEmpty}</option>`;break;case"number":i=`<option ${t.filter.operator==="="?"selected":""} value="=">=</option>
<option ${t.filter.operator==="!="?"selected":""} value="!=">!=</option>
<option ${t.filter.operator===">"?"selected":""} value=">">&gt;</option>
<option ${t.filter.operator==="<"?"selected":""} value="<">&lt;</option>
<option ${t.filter.operator===">="?"selected":""} value=">=">&GreaterEqual;</option>
<option ${t.filter.operator==="<="?"selected":""} value="<=">&le;</option>
<option ${t.filter.operator==="Is empty"?"selected":""} value="Is empty">${window.siyuan.languages.filterOperatorIsEmpty}</option>
<option ${t.filter.operator==="Is not empty"?"selected":""} value="Is not empty">${window.siyuan.languages.filterOperatorIsNotEmpty}</option>`;break;case"mSelect":case"relation":i=`<option ${t.filter.operator==="Contains"?"selected":""} value="Contains">${window.siyuan.languages.filterOperatorContains}</option>
<option ${t.filter.operator==="Does not contains"?"selected":""} value="Does not contains">${window.siyuan.languages.filterOperatorDoesNotContain}</option>
<option ${t.filter.operator==="Is empty"?"selected":""} value="Is empty">${window.siyuan.languages.filterOperatorIsEmpty}</option>
<option ${t.filter.operator==="Is not empty"?"selected":""} value="Is not empty">${window.siyuan.languages.filterOperatorIsNotEmpty}</option>`;break;case"select":i=`<option ${t.filter.operator==="="?"selected":""} value="=">${window.siyuan.languages.filterOperatorIs}</option>
<option ${t.filter.operator==="!="?"selected":""} value="!=">${window.siyuan.languages.filterOperatorIsNot}</option>
<option ${t.filter.operator==="Is empty"?"selected":""} value="Is empty">${window.siyuan.languages.filterOperatorIsEmpty}</option>
<option ${t.filter.operator==="Is not empty"?"selected":""} value="Is not empty">${window.siyuan.languages.filterOperatorIsNotEmpty}</option>`;break}if(a.addItem({iconHTML:"",type:"readonly",label:`<select style="margin: 4px 0" class="b3-select fn__size200">${i}</select>`}),o.type==="select"||o.type==="mSelect")s.options?.length>0&&a.addItem({iconHTML:"",type:"readonly",label:`<input class="b3-text-field fn__size200" style="margin: 4px 0" placeholder="${window.siyuan.languages.search}">`,bind(f){const g=f.querySelector("input");g.addEventListener("keydown",p=>{if(p.isComposing)return;let h=xn(a.element.querySelector(".b3-menu__items"),p,"b3-menu__item--current",f.nextElementSibling);p.key==="Enter"&&(h||(h=a.element.querySelector(".b3-menu__item--current")),h.dispatchEvent(new CustomEvent("click")))}),g.addEventListener("input",p=>{p.isComposing||iv(g.value.toLowerCase())}),g.addEventListener("compositionend",()=>{iv(g.value.toLowerCase())})}}),s.options?.forEach(f=>{let g="iconUncheck";o?.mSelect?.find(p=>{p.content===f.name&&(g="iconCheck")}),a.addItem({icon:g,label:`<span class="b3-chip b3-chip--middle" data-name="${f.name}" data-color="${f.color}" style="max-width: 178px;margin:3px 0;background-color:var(--b3-font-background${f.color});color:var(--b3-font-color${f.color})">
    <span class="fn__ellipsis">${f.name}</span>
</span>`,bind(p){p.addEventListener("click",()=>{const h=p.querySelector("use");h.getAttribute("xlink:href")==="#iconUncheck"?h.setAttribute("xlink:href","#iconCheck"):h.setAttribute("xlink:href","#iconUncheck")})}})});else if(["text","url","block","email","phone","template","relation"].includes(o.type)){let f="";o&&(o.type==="relation"?f=o.relation.blockIDs[0]||"":f=o[o.type].content||""),a.addItem({iconHTML:"",type:"readonly",label:`<input style="margin: 4px 0" value="${f}" class="b3-text-field fn__size200">`})}else if(o.type==="number")a.addItem({iconHTML:"",type:"readonly",label:`<input style="margin: 4px 0" value="${o?.number.isNotEmpty?o.number.content:""}" class="b3-text-field fn__size200">`});else if(["date","updated","created"].includes(o.type)){const f=o?o[o.type]:null,g=!t.filter.relativeDate?.direction,p=!t.filter.relativeDate2?.direction;a.addItem({iconHTML:"",type:"readonly",label:`<div data-type="filter1">
    <div class="fn__size200">
        <select class="b3-select fn__block" data-type="dateType">
            <option value="time"${t.filter.relativeDate?"":" selected"}>${window.siyuan.languages.includeTime}</option>
            <option value="custom"${t.filter.relativeDate?" selected":""}>${window.siyuan.languages.relativeToToday}</option>
        </select>
    </div>
    <div class="fn__hr"></div>
    <div class="fn__size200 ${t.filter.relativeDate?"fn__none":""}">
        <input value="${f&&(f.isNotEmpty||o.type!=="date")?Y(f.content).format("YYYY-MM-DD"):""}" type="date" max="9999-12-31" class="b3-text-field fn__block">
    </div>
    <div class="fn__flex fn__size200 ${t.filter.relativeDate?"":"fn__none"}">
        <select class="b3-select" data-type="dataDirection">
            <option value="-1"${t.filter.relativeDate?.direction===-1?" selected":""}>${window.siyuan.languages.pastDate}</option>
            <option value="1"${t.filter.relativeDate?.direction===1?" selected":""}>${window.siyuan.languages.nextDate}</option>
            <option value="0"${g?" selected":""}>${window.siyuan.languages.current}</option>
        </select>
        <span class="fn__space"></span>
        <input type="number" min="1" oninput="this.value = Math.max(this.value, 1)" step="1" value="${t.filter.relativeDate?.count||1}" class="b3-text-field fn__flex-1${g?" fn__none":""}"/>
        <span class="fn__space${g?" fn__none":""}"></span>
        <select class="b3-select fn__flex-1">
            <option value="0"${t.filter.relativeDate?.unit===0?" selected":""}>${window.siyuan.languages.day}</option>
            <option value="1"${!t.filter.relativeDate||t.filter.relativeDate?.unit===1?" selected":""}>${window.siyuan.languages.week}</option>
            <option value="2"${t.filter.relativeDate?.unit===2?" selected":""}>${window.siyuan.languages.month}</option>
            <option value="3"${t.filter.relativeDate?.unit===3?" selected":""}>${window.siyuan.languages.year}</option>
        </select>
    </div>
    <div class="fn__hr--small"></div>
</div>
<div data-type="filter2 fn__none">
    <div class="fn__hr--small"></div>
    <div class="fn__size200 ${t.filter.relativeDate2?"fn__none":""}">
        <input value="${f&&f.isNotEmpty2?Y(f.content2).format("YYYY-MM-DD"):""}" type="date" max="9999-12-31" class="b3-text-field fn__block">
    </div>
    <div class="fn__flex fn__size200 ${t.filter.relativeDate2?"":"fn__none"}">
        <select class="b3-select" data-type="dataDirection">
            <option value="-1"${t.filter.relativeDate2?.direction===-1?" selected":""}>${window.siyuan.languages.pastDate}</option>
            <option value="1"${t.filter.relativeDate2?.direction===1?" selected":""}>${window.siyuan.languages.nextDate}</option>
            <option value="0"${p?" selected":""}>${window.siyuan.languages.current}</option>
        </select>
        <span class="fn__space"></span>
        <input type="number" min="1" step="1" oninput="this.value = Math.max(this.value, 1)" value="${t.filter.relativeDate2?.count||1}" class="b3-text-field fn__flex-1${p?" fn__none":""}"/>
        <span class="fn__space${p?" fn__none":""}"></span>
        <select class="b3-select fn__flex-1">
            <option value="0"${t.filter.relativeDate2?.unit===0?" selected":""}>${window.siyuan.languages.day}</option>
            <option value="1"${!t.filter.relativeDate2||t.filter.relativeDate2?.unit===1?" selected":""}>${window.siyuan.languages.week}</option>
            <option value="2"${t.filter.relativeDate2?.unit===2?" selected":""}>${window.siyuan.languages.month}</option>
            <option value="3"${t.filter.relativeDate2?.unit===3?" selected":""}>${window.siyuan.languages.year}</option>
        </select>
    </div>
    <div class="fn__hr--small"></div>
</div>`})}a.addItem({icon:"iconTrashcan",label:window.siyuan.languages.removeFilters,click(){const f=Object.assign([],t.data.view.filters);t.data.view.filters.find((p,h)=>{if(p.column===t.filter.column&&t.filter.value.type===p.value.type)return t.data.view.filters.splice(h,1),!0}),U(t.protyle,[{action:"setAttrViewFilters",avID:t.data.id,data:t.data.view.filters,blockID:n}],[{action:"setAttrViewFilters",avID:t.data.id,data:f,blockID:n}]);const g=L(t.target,"b3-menu");g&&(g.innerHTML=cs(t.data.view))}});const r=a.element.querySelector(".b3-select");r.addEventListener("change",()=>{av(r,r.value,o.type)});const d=a.element.querySelector('.b3-select[data-type="dateType"]');d?.addEventListener("change",()=>{const f=a.element.querySelectorAll('[data-type="dataDirection"]'),g=f[0].parentElement,p=f[1].parentElement,h=g.previousElementSibling,m=p.previousElementSibling;d.value==="custom"?(g.classList.remove("fn__none"),p.classList.remove("fn__none"),h.classList.add("fn__none"),m.classList.add("fn__none")):(g.classList.add("fn__none"),p.classList.add("fn__none"),h.classList.remove("fn__none"),m.classList.remove("fn__none"))}),a.element.querySelectorAll('.b3-select[data-type="dataDirection"]').forEach(f=>{f.addEventListener("change",()=>{const g=f.nextElementSibling.nextElementSibling;f.value==="0"?(g.classList.add("fn__none"),g.nextElementSibling.classList.add("fn__none")):(g.classList.remove("fn__none"),g.nextElementSibling.classList.remove("fn__none"))})});const c=a.element.querySelectorAll(".b3-text-field");o.type!=="select"&&o.type!=="mSelect"&&c.forEach(f=>{f.addEventListener("keydown",g=>{if(g.isComposing){g.preventDefault();return}g.key==="Enter"&&(a.close(),g.preventDefault())})}),av(r,r.value,o.type),a.open({x:e.left,y:e.bottom}),c.length>0&&c[0].select()},Dx=t=>{const e=new st("av-add-filter");t.data.view.columns.forEach(n=>{let a;t.data.view.filters.find(i=>{if(i.column===n.id&&i.value.type===n.type)return a=i,!0}),!a&&n.type!=="mAsset"&&n.type!=="lineNumber"&&e.addItem({label:n.name,iconHTML:n.icon?ge(n.icon,"b3-menu__icon",!0):`<svg class="b3-menu__icon"><use xlink:href="#${sn(n.type)}"></use></svg>`,click:()=>{const i=si(n.type,n.type==="checkbox"?{checked:void 0}:"");a={column:n.id,operator:nv(n.type),value:i},t.data.view.filters.push(a),t.menuElement.innerHTML=cs(t.data.view),ke(t.menuElement,t.tabRect.right-t.menuElement.clientWidth,t.tabRect.bottom,t.tabRect.height);const s=t.menuElement.querySelector(`[data-id="${n.id}"] .b3-chip`);Lm({filter:a,protyle:t.protyle,data:t.data,target:s,blockElement:t.blockElement})}})}),e.open({x:t.rect.left,y:t.rect.bottom,h:t.rect.height})},cs=t=>{let e="";const n=a=>{let i="";return t.columns.find(s=>{if(s.id===a.column&&s.type===a.value.type){let o="";const l=s.type==="rollup"?a.value.rollup?.contents?.length>0?a.value.rollup.contents[0]:{type:"rollup"}:a.value;if(a.operator==="Is empty")o=": "+window.siyuan.languages.filterOperatorIsEmpty;else if(a.operator==="Is not empty")o=": "+window.siyuan.languages.filterOperatorIsNotEmpty;else if(a.operator==="Is false")(l.type!=="checkbox"||typeof l.checkbox.checked=="boolean")&&(o=": "+window.siyuan.languages.unchecked);else if(a.operator==="Is true")(l.type!=="checkbox"||typeof l.checkbox.checked=="boolean")&&(o=": "+window.siyuan.languages.checked);else if(["created","updated","date"].includes(l.type)){let r="",d="";a.relativeDate?(r=`${window.siyuan.languages[["pastDate","current","nextDate"][a.relativeDate.direction+1]]}
 ${a.relativeDate.direction?a.relativeDate.count:""}
 ${window.siyuan.languages[["day","week","month","year"][a.relativeDate.unit]]}`,a.relativeDate2&&(d=`${window.siyuan.languages[["pastDate","current","nextDate"][a.relativeDate2.direction+1]]}
 ${a.relativeDate2.direction?a.relativeDate2.count:""}
 ${window.siyuan.languages[["day","week","month","year"][a.relativeDate2.unit]]}`)):l&&l[l.type]?.content&&(r=Y(l[l.type].content).format("YYYY-MM-DD"),d=Y(l[l.type].content2).format("YYYY-MM-DD")),r&&(a.operator==="Is between"?o=` ${window.siyuan.languages.filterOperatorIsBetween} ${r} ${d}`:a.operator==="="?o=`: ${r}`:[">","<"].includes(a.operator)?o=` ${a.operator} ${r}`:a.operator===">="?o=` \u2265 ${r}`:a.operator==="<="&&(o=` \u2264 ${r}`))}else if(["mSelect","select"].includes(l.type)&&l.mSelect?.length>0){let r="";l.mSelect.forEach((d,c)=>{r+=d.content,c!==l.mSelect.length-1&&(r+=", ")}),a.operator==="Contains"?o=`: ${r}`:a.operator==="Does not contains"?o=` ${window.siyuan.languages.filterOperatorDoesNotContain} ${r}`:a.operator==="="?o=`: ${r}`:a.operator==="!="&&(o=` ${window.siyuan.languages.filterOperatorIsNot} ${r}`)}else if(l.type==="number"&&l.number&&l.number.isNotEmpty)["=","!=",">","<"].includes(a.operator)?o=` ${a.operator} ${l.number.content}`:a.operator===">="?o=` \u2265 ${l.number.content}`:a.operator==="<="&&(o=` \u2264 ${l.number.content}`);else if(["text","block","url","phone","email","relation","template"].includes(l.type)&&l[l.type]){const r=l[l.type].content||l.relation?.blockIDs[0]||"";["=","Contains"].includes(a.operator)?o=`: ${r}`:a.operator==="Does not contains"?o=` ${window.siyuan.languages.filterOperatorDoesNotContain} ${r}`:a.operator==="!="?o=` ${window.siyuan.languages.filterOperatorIsNot} ${r}`:a.operator==="Starts with"?o=` ${window.siyuan.languages.filterOperatorStartsWith} ${r}`:a.operator==="Ends with"?o=` ${window.siyuan.languages.filterOperatorEndsWith} ${r}`:[">","<"].includes(a.operator)?o=` ${a.operator} ${r}`:a.operator===">="?o=` \u2265 ${r}`:a.operator==="<="&&(o=` \u2264 ${r}`)}return i+=`<span data-type="setFilter" class="b3-chip${o?" b3-chip--primary":""}">
    ${s.icon?ge(s.icon,"icon",!0):`<svg class="icon"><use xlink:href="#${sn(s.type)}"></use></svg>`}
    <span class="fn__ellipsis">${s.name}${o}</span>
</span>`,!0}}),i};return t.filters.forEach(a=>{const i=n(a);i&&(e+=`<button class="b3-menu__item" draggable="true" data-id="${a.column}" data-filter-type="${a.value.type}">
    <svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>
    <div class="fn__flex-1">${i}</div>
    <svg class="b3-menu__action" data-type="removeFilter"><use xlink:href="#iconTrashcan"></use></svg>
</button>`)}),`<div class="b3-menu__items">
<button class="b3-menu__item" data-type="nobg">
    <span class="block__icon" style="padding: 8px;margin-left: -4px;" data-type="go-config">
        <svg><use xlink:href="#iconLeft"></use></svg>
    </span>
    <span class="b3-menu__label ft__center">${window.siyuan.languages.filter}</span>
</button>
<button class="b3-menu__separator"></button>
${e}
<button class="b3-menu__item${t.filters.length===t.columns.length?" fn__none":""}" data-type="addFilter">
    <svg class="b3-menu__icon"><use xlink:href="#iconAdd"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.addFilter}</span>
</button>
<button class="b3-menu__item${e?"":" fn__none"}" data-type="removeFilters">
    <svg class="b3-menu__icon"><use xlink:href="#iconTrashcan"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.removeFilters}</span>
</button>
</div>`},sv=t=>{let e;t.data.view.columns.find((i,s)=>{if(i.id===t.colId)return e=JSON.parse(JSON.stringify(i)),t.data.view.columns.splice(s+1,0,e),!0}),e.name=yl(e.name),e.id=Lute.NewNodeID();const n=Y().format("YYYYMMDDHHmmss"),a=t.blockElement.getAttribute("data-node-id");U(t.protyle,[{action:"duplicateAttrViewKey",keyID:t.colId,nextID:e.id,avID:t.data.id},{action:"doUpdateUpdated",id:a,data:n}],[{action:"removeAttrViewCol",id:e.id,avID:t.data.id},{action:"doUpdateUpdated",id:a,data:t.blockElement.getAttribute("updated")}]),mn({blockElement:t.blockElement,protyle:t.protyle,type:e.type,name:e.name,icon:e.icon,previousID:t.colId,data:t.data,id:e.id}),t.blockElement.setAttribute("updated",n)},Ra=t=>{let e;t.data.view.columns.find(a=>{if(a.id===t.colId)return e=a,!0});let n=`<button class="b3-menu__item" data-type="nobg" data-col-id="${t.colId}">
    <span class="block__icon${t.isCustomAttr?" fn__none":""}" style="padding: 8px;margin-left: -4px;" data-type="go-properties">
        <svg><use xlink:href="#iconLeft"></use></svg>
    </span>
    <span class="b3-menu__label ft__center">${window.siyuan.languages.edit}</span>
</button>
<button class="b3-menu__separator" data-id="separator_1"></button>
<button class="b3-menu__item" data-type="nobg">
    <div class="fn__block">
        <div class="fn__flex">
            <span class="b3-menu__avemoji" data-col-type="${e.type}" data-icon="${e.icon}" data-type="update-icon">${e.icon?ge(e.icon):`<svg style="width: 14px;height: 14px"><use xlink:href="#${sn(e.type)}"></use></svg>`}</span>
            <div class="b3-form__icona fn__block">
                <input data-type="name" class="b3-text-field b3-form__icona-input" type="text">
                <svg data-position="north" class="b3-form__icona-icon ariaLabel" aria-label="${e.desc?Rt(e.desc):window.siyuan.languages.addDesc}"><use xlink:href="#iconInfo"></use></svg>
            </div>
        </div>
        <div class="fn__none">
            <div class="fn__hr"></div>
            <textarea style="margin-left: 22px;width: calc(100% - 22px);" placeholder="${window.siyuan.languages.addDesc}" rows="1" data-type="desc" class="b3-text-field fn__size200" type="text" data-value="${Xe(e.desc)}">${e.desc}</textarea>
        </div>
        <div class="fn__hr--small"></div>
    </div>
</button>
<button class="b3-menu__item" data-type="goUpdateColType" ${e.type==="block"?"disabled":""}>
    <span class="b3-menu__label">${window.siyuan.languages.type}</span>
    <span class="fn__space"></span>
    <svg class="b3-menu__icon"><use xlink:href="#${sn(e.type)}"></use></svg>
    <span class="b3-menu__accelerator" style="margin-left: 0">${Nl(e.type)}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>`;if(["mSelect","select"].includes(e.type))n+=`<button class="b3-menu__separator" data-id="separator_2"></button>
<button class="b3-menu__item" data-type="nobg">
    <svg class="b3-menu__icon"><use xlink:href="#iconAdd"></use></svg>
    <input data-type="addOption" class="b3-text-field fn__block" type="text" placeholder="${window.siyuan.languages.enterKey} ${window.siyuan.languages.addAttr}" style="margin: 4px 0">
</button>`,e.options||(e.options=[]),e.options.forEach(a=>{const i=a.desc?`${Rt(a.name)}<div class='ft__on-surface'>${Rt(a.desc||"")}</div>`:"";n+=`<button class="b3-menu__item${n?"":" b3-menu__item--current"}" draggable="true" data-name="${Xe(a.name)}" data-desc="${Xe(a.desc||"")}" data-color="${a.color}">
    <svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>
    <div class="fn__flex-1 ariaLabel" data-position="parentW" aria-label="${i}">
        <span class="b3-chip" style="background-color:var(--b3-font-background${a.color});color:var(--b3-font-color${a.color})">
            <span class="fn__ellipsis">${pe(a.name)}</span>
        </span>
    </div>
    <svg class="b3-menu__action" data-type="setColOption"><use xlink:href="#iconEdit"></use></svg>
</button>`});else if(e.type==="number")n+=`<button class="b3-menu__separator" data-id="separator_2"></button>
<button class="b3-menu__item" data-type="numberFormat" data-format="${e.numberFormat}">
    <svg class="b3-menu__icon"><use xlink:href="#iconFormat"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.format}</span>
    <span class="b3-menu__accelerator">${K_(e.numberFormat)}</span>
</button>`;else if(e.type==="template")n+=`<button class="b3-menu__separator" data-id="separator_2"></button>
<button class="b3-menu__item" data-type="nobg">
    <textarea spellcheck="false" rows="${Math.min(e.template.split(`
`).length,8)}" placeholder="${window.siyuan.languages.template}" data-type="updateTemplate" style="margin: 4px 0" rows="1" class="fn__block b3-text-field">${e.template}</textarea>
</button>`;else if(e.type==="relation"){const a=e.relation?.avID===t.data.id;n+=`<button class="b3-menu__separator" data-id="separator_2"></button>
<button class="b3-menu__item" data-type="goSearchAV" data-av-id="${e.relation?.avID||""}" data-old-value='${JSON.stringify(e.relation||{})}'>
    <span class="b3-menu__label">${window.siyuan.languages.relatedTo}</span>
    <span class="b3-menu__accelerator">${a?window.siyuan.languages.thisDatabase:""}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<label class="b3-menu__item">
    <span class="fn__flex-center">${window.siyuan.languages.backRelation}</span>
    <svg class="b3-menu__icon b3-menu__icon--small fn__none"><use xlink:href="#iconHelp"></use></svg>
    <span class="fn__space fn__flex-1"></span>
    <input data-type="backRelation" type="checkbox" class="b3-switch b3-switch--menu" ${e.relation?.isTwoWay?"checked":""}>
</label>
<div class="b3-menu__item fn__flex-column fn__none" data-type="nobg">
    <input data-old-value="" data-type="colName" style="margin: 8px 0 4px" class="b3-text-field fn__block" placeholder="${t.data.name} ${e.name}">
</div>
<div class="b3-menu__item fn__flex-column fn__none" data-type="nobg">
    <button style="margin: 4px 0 8px;" class="b3-button fn__block" data-type="updateRelation">${window.siyuan.languages.confirm}</button>
</div>`}else e.type==="rollup"?n+='<button class="b3-menu__separator" data-id="separator_2"></button>'+Q_({colData:e}):e.type==="date"&&(n+=`<button class="b3-menu__separator" data-id="separator_2"></button>
<label class="b3-menu__item">
    <span class="fn__flex-center">${window.siyuan.languages.fillCreated}</span>
    <span class="fn__space fn__flex-1"></span>
    <input data-type="fillCreated" type="checkbox" class="b3-switch b3-switch--menu" ${e.date?.autoFillNow?"checked":""}>
</label>`);return e.type!=="block"&&(n+=`<button class="b3-menu__separator" data-id="separator_3"></button>
<button class="b3-menu__item" data-type="${e.hidden?"showCol":"hideCol"}">
    <svg class="b3-menu__icon" style=""><use xlink:href="#icon${e.hidden?"Eye":"Eyeoff"}"></use></svg>
    <span class="b3-menu__label">${e.hidden?window.siyuan.languages.showCol:window.siyuan.languages.hideCol}</span>
</button>
<button class="b3-menu__item${e.type==="relation"?" fn__none":""}" data-type="duplicateCol">
    <svg class="b3-menu__icon" style=""><use xlink:href="#iconCopy"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.duplicate}</span>
</button>
<button class="b3-menu__item" data-type="removeCol">
    <svg class="b3-menu__icon" style=""><use xlink:href="#iconTrashcan"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.delete}</span>
</button>`),`<div class="b3-menu__items">
    ${n}
    <button class="b3-menu__separator" data-id="separator_4"></button>
    <label class="b3-menu__item" data-type="wrap">
        <span class="fn__flex-center">${window.siyuan.languages.wrap}</span>
        <span class="fn__space fn__flex-1"></span>
        <input data-type="wrap" type="checkbox" class="b3-switch b3-switch--menu" ${e.wrap?" checked":""}>
    </label>
</div>
<div class="b3-menu__items fn__none">
    <button class="b3-menu__item" data-type="nobg" data-col-id="${e.id}">
        <span class="block__icon" style="padding: 8px;margin-left: -4px;" data-type="goEditCol">
            <svg><use xlink:href="#iconLeft"></use></svg>
        </span>
        <span class="b3-menu__label ft__center">${window.siyuan.languages.edit}</span>
    </button>
    <button class="b3-menu__separator"></button>
    ${En("text",e.type)}
    ${En("number",e.type)}
    ${En("select",e.type)}
    ${En("mSelect",e.type)}
    ${En("date",e.type)}
    ${En("mAsset",e.type)}
    ${En("checkbox",e.type)}
    ${En("url",e.type)}
    ${En("email",e.type)}
    ${En("phone",e.type)}
    ${En("template",e.type)}
    ${En("relation",e.type)}
    ${En("rollup",e.type)}
    ${En("lineNumber",e.type)}
    ${En("created",e.type)}
    ${En("updated",e.type)}
</div>`},Oa=t=>{const e=t.data.id,n=t.menuElement.querySelector(".b3-menu__item").getAttribute("data-col-id"),a=t.data.view.columns.find(f=>f.id===n),i=t.menuElement.querySelector('[data-type="name"]');i.addEventListener("blur",()=>{const f=i.value;f!==a.name&&(U(t.protyle,[{action:"updateAttrViewCol",id:n,avID:e,name:f,type:a.type}],[{action:"updateAttrViewCol",id:n,avID:e,name:a.name,type:a.type}]),a.name=f,gn(t.protyle.wysiwyg.element.querySelector(`.av__row--header .av__cell[data-col-id="${n}"]`),void 0,{name:f}))}),i.addEventListener("keydown",f=>{f.isComposing||(f.key==="Escape"?t.menuElement.parentElement.remove():f.key==="Enter"&&(i.dispatchEvent(new CustomEvent("blur")),t.menuElement.parentElement.remove()))}),i.addEventListener("keyup",f=>{if(f.isComposing)return;const g=t.menuElement.querySelector('[data-type="colName"]');g&&g.setAttribute("placeholder",`${t.data.name} ${i.value}`)}),i.select(),i.value=a.name;const s=t.menuElement.querySelector('.b3-text-field[data-type="desc"]');i.nextElementSibling.addEventListener("click",()=>{const f=s.parentElement;f.classList.toggle("fn__none"),f.classList.contains("fn__none")||s.focus()}),s.addEventListener("blur",()=>{const f=s.value;f!==a.desc&&(U(t.protyle,[{action:"setAttrViewColDesc",id:n,avID:e,data:f}],[{action:"setAttrViewColDesc",id:n,avID:e,data:a.desc}]),a.desc=f)}),s.addEventListener("keydown",f=>{f.isComposing||(f.key==="Escape"?t.menuElement.parentElement.remove():f.key==="Enter"&&(s.dispatchEvent(new CustomEvent("blur")),t.menuElement.parentElement.remove()))}),s.addEventListener("input",()=>{i.nextElementSibling.setAttribute("aria-label",s.value?pe(s.value):window.siyuan.languages.addDesc)});const o=t.menuElement.querySelector('[data-type="updateTemplate"]');o&&(o.addEventListener("blur",()=>{const f=o.value;f!==a.template&&(U(t.protyle,[{action:"updateAttrViewColTemplate",id:n,avID:e,data:f,type:a.type}],[{action:"updateAttrViewColTemplate",id:n,avID:e,data:a.template,type:a.type}]),a.template=f)}),o.addEventListener("keydown",f=>{f.isComposing||(f.key==="Escape"?t.menuElement.parentElement.remove():f.key==="Enter"&&!f.shiftKey&&(o.dispatchEvent(new CustomEvent("blur")),t.menuElement.parentElement.remove()))}));const l=t.menuElement.querySelector('.b3-switch[data-type="wrap"]');l&&l.addEventListener("change",()=>{U(t.protyle,[{action:"setAttrViewColWrap",id:n,avID:e,data:l.checked,blockID:t.blockID}],[{action:"setAttrViewColWrap",id:n,avID:e,data:!l.checked,blockID:t.blockID}])});const r=t.menuElement.querySelector('[data-type="addOption"]');r&&r.addEventListener("keydown",f=>{if(!f.isComposing&&(f.key==="Escape"&&t.menuElement.parentElement.remove(),f.key==="Enter")){let g=!1;if(a.options.find(p=>{if(r.value===p.name)return g=!0,!0}),g||!r.value)return;a.options.push({color:((a.options.length||0)%14+1).toString(),name:r.value}),U(t.protyle,[{action:"updateAttrViewColOptions",id:n,avID:e,data:a.options}],[{action:"removeAttrViewColOption",id:n,avID:e,data:r.value}]),t.menuElement.innerHTML=Ra({protyle:t.protyle,colId:n,data:t.data,isCustomAttr:t.isCustomAttr}),Oa({protyle:t.protyle,menuElement:t.menuElement,data:t.data,isCustomAttr:t.isCustomAttr,blockID:t.blockID}),t.menuElement.querySelector('[data-type="addOption"]').focus()}});const d=t.menuElement.querySelector('[data-type="fillCreated"]');d&&d.addEventListener("change",()=>{U(t.protyle,[{avID:e,action:"setAttrViewColDate",id:n,data:d.checked}],[{avID:e,action:"setAttrViewColDate",id:n,data:!d.checked}])});const c=t.menuElement.querySelector('[data-type="backRelation"]');if(c){c.addEventListener("change",()=>{uc(t.menuElement,e)});const f=t.menuElement.querySelector('[data-type="goSearchAV"]'),g=JSON.parse(f.getAttribute("data-old-value")),p=t.menuElement.querySelector('[data-type="colName"]');p.addEventListener("input",()=>{uc(t.menuElement,e)}),g.avID?E("/api/av/getAttributeView",{id:g.avID},h=>{f.querySelector(".b3-menu__accelerator").textContent=g.avID===e?window.siyuan.languages.thisDatabase:h.data.av.name||window.siyuan.languages.title,h.data.av.keyValues.find(m=>{if(m.key.id===g.backKeyID)return p.setAttribute("data-old-value",m.key.name||window.siyuan.languages.title),p.value=m.key.name||window.siyuan.languages.title,!0}),uc(t.menuElement,e)}):uc(t.menuElement,e)}ev(t)},Nl=t=>{switch(t){case"text":case"number":case"select":case"date":case"phone":case"email":case"template":return window.siyuan.languages[t];case"mSelect":return window.siyuan.languages.multiSelect;case"relation":return window.siyuan.languages.relation;case"rollup":return window.siyuan.languages.rollup;case"updated":return window.siyuan.languages.updatedTime;case"created":return window.siyuan.languages.createdTime;case"url":return window.siyuan.languages.link;case"mAsset":return window.siyuan.languages.assets;case"checkbox":return window.siyuan.languages.checkbox;case"block":return window.siyuan.languages._attrView.key;case"lineNumber":return window.siyuan.languages.lineNumber}},sn=t=>{switch(t){case"text":return"iconAlignLeft";case"block":return"iconKey";case"number":return"iconNumber";case"select":return"iconListItem";case"mSelect":return"iconList";case"relation":return"iconOpen";case"rollup":return"iconSearch";case"date":return"iconCalendar";case"updated":case"created":return"iconClock";case"url":return"iconLink";case"mAsset":return"iconImage";case"email":return"iconEmail";case"phone":return"iconPhone";case"template":return"iconMath";case"checkbox":return"iconCheck";case"lineNumber":return"iconOrderedList"}},mn=t=>{if(!t.blockElement)return;const e=t.blockElement.getAttribute("data-node-id");t.blockElement.classList.contains("av")?t.blockElement.querySelectorAll(".av__row").forEach((a,i)=>{let s;t.previousID?s=a.querySelector(`[data-col-id="${t.previousID}"]`):s=a.lastElementChild.previousElementSibling;let o="";i===0?o=`<div class="av__cell av__cell--header" draggable="true" data-icon="${t.icon||""}" data-col-id="${t.id}" data-dtype="${t.type}" data-wrap="false" style="width: 200px;">
    ${t.icon?ge(t.icon,"av__cellheadericon",!0):`<svg class="av__cellheadericon"><use xlink:href="#${sn(t.type)}"></use></svg>`}
    <span class="av__celltext fn__flex-1">${t.name}</span>
    <div class="av__widthdrag av__pulse"></div>
</div>`:o='<div class="av__cell" style="width: 200px"><span class="av__pulse"></span></div>',s.insertAdjacentHTML("afterend",o)}):t.blockElement.querySelector(".fn__hr").insertAdjacentHTML("beforebegin",`<div class="block__icons av__row" data-id="${e}" data-col-id="${t.id}">
    <div class="block__icon" draggable="true"><svg><use xlink:href="#iconDrag"></use></svg></div>
    <div class="block__logo ariaLabel fn__pointer" data-type="editCol" data-position="parentW" aria-label="${Nl(t.type)}">
        <svg class="block__logoicon"><use xlink:href="#${sn(t.type)}"></use></svg>
        <span>${Nl(t.type)}</span>
    </div>
    <div data-col-id="${t.id}" data-block-id="${e}" data-type="${t.type}" data-options="[]" class="fn__flex-1 fn__flex">
        <div class="fn__flex-1"></div>
    </div>
</div>`);const n=document.querySelector(".av__panel .b3-menu");if(n&&t.data&&t.blockElement.classList.contains("av")){n.innerHTML=Ra({protyle:t.protyle,data:t.data,colId:t.id,isCustomAttr:!1}),Oa({protyle:t.protyle,data:t.data,menuElement:n,isCustomAttr:!1,blockID:e});const a=t.blockElement.querySelector(".av__views").getBoundingClientRect();a&&ke(n,a.right-n.clientWidth,a.bottom,a.height);return}hn({protyle:t.protyle,blockElement:t.blockElement,type:"edit",colId:t.id,editData:{previousID:t.previousID,colData:$x(t.type,t.id,t.name)}}),window.siyuan.menus.menu.remove()},ov=(t,e,n)=>{const a=n.getAttribute("data-dtype"),i=n.getAttribute("data-col-id"),s=e.getAttribute("data-av-id"),o=e.getAttribute("data-node-id"),l=n.querySelector(".av__celltext").textContent.trim(),r=n.dataset.desc,d=new st("av-header-cell",()=>{const p=d.element.querySelector(".b3-text-field").value;p!==l&&(U(t,[{action:"updateAttrViewCol",id:i,avID:s,name:p,type:a}],[{action:"updateAttrViewCol",id:i,avID:s,name:l,type:a}]),gn(e.querySelector(`.av__row--header .av__cell[data-col-id="${i}"]`),void 0,{name:p}));const h=d.element.querySelector("textarea").value;h!==r&&U(t,[{action:"setAttrViewColDesc",id:i,avID:s,data:h}],[{action:"setAttrViewColDesc",id:i,avID:s,data:r}]),ae(e)});d.addItem({iconHTML:"",type:"empty",label:`<div class="fn__hr"></div><div class="fn__flex">
    <span class="b3-menu__avemoji">${n.dataset.icon?ge(n.dataset.icon):`<svg style="height: 14px;width: 14px;"><use xlink:href="#${sn(a)}"></use></svg>`}</span>
    <div class="b3-form__icona fn__block">
        <input class="b3-text-field b3-form__icona-input" type="text">
        <svg data-position="north" class="b3-form__icona-icon ariaLabel" aria-label="${r?Rt(r):window.siyuan.languages.addDesc}"><use xlink:href="#iconInfo"></use></svg>
    </div>
</div>
<div class="fn__none">
    <div class="fn__hr"></div>
    <textarea style="margin-left: 22px;width: calc(100% - 22px);" placeholder="${window.siyuan.languages.addDesc}" rows="1" class="b3-text-field fn__size200" type="text" data-value="${Xe(r)}">${r}</textarea>
</div>
<div class="fn__hr--small"></div>`,bind(p){const h=p.querySelector(".b3-menu__avemoji");h.addEventListener("click",y=>{const w=h.getBoundingClientRect();Za("","av",{x:w.left,y:w.bottom+4,h:w.height,w:w.width},_=>{U(t,[{action:"setAttrViewColIcon",id:i,avID:s,data:_}],[{action:"setAttrViewColIcon",id:i,avID:s,data:n.dataset.icon}]),h.innerHTML=_?ge(_):`<svg style="height: 14px;width: 14px"><use xlink:href="#${sn(a)}"></use></svg>`,gn(e.querySelector(`.av__row--header .av__cell[data-col-id="${i}"]`),void 0,{icon:_})},h.querySelector("img")),y.preventDefault(),y.stopPropagation()});const m=p.querySelector("input");m.value=l,m.addEventListener("keydown",y=>{y.isComposing||y.key==="Enter"&&(d.close(),y.preventDefault())});const b=p.querySelector("textarea");m.nextElementSibling.addEventListener("click",()=>{const y=b.parentElement;y.classList.toggle("fn__none"),y.classList.contains("fn__none")||b.focus()}),b.addEventListener("keydown",y=>{y.isComposing||y.key==="Enter"&&(d.close(),y.preventDefault())}),b.addEventListener("input",()=>{m.nextElementSibling.setAttribute("aria-label",b.value?pe(b.value):window.siyuan.languages.addDesc)})}}),d.addItem({id:"edit",icon:"iconEdit",label:window.siyuan.languages.edit,click(){const p=d.element.querySelector(".b3-text-field").value;hn({protyle:t,blockElement:e,type:"edit",colId:i,cb(h){const m=h.querySelector('.b3-text-field[data-type="name"]');m.value=p,m.select()}})}}),d.addSeparator({id:"separator_1"}),a!=="lineNumber"&&(d.addItem({id:"asc",icon:"iconUp",label:window.siyuan.languages.asc,click(){E("/api/av/renderAttributeView",{id:s},p=>{U(t,[{action:"setAttrViewSorts",avID:p.data.id,data:[{column:i,order:"ASC"}],blockID:o}],[{action:"setAttrViewSorts",avID:p.data.id,data:p.data.view.sorts,blockID:o}])})}}),d.addItem({id:"desc",icon:"iconDown",label:window.siyuan.languages.desc,click(){E("/api/av/renderAttributeView",{id:s},p=>{U(t,[{action:"setAttrViewSorts",avID:p.data.id,data:[{column:i,order:"DESC"}],blockID:o}],[{action:"setAttrViewSorts",avID:p.data.id,data:p.data.view.sorts,blockID:o}])})}}),a!=="mAsset"&&d.addItem({id:"filter",icon:"iconFilter",label:window.siyuan.languages.filter,click(){E("/api/av/renderAttributeView",{id:s},p=>{const h=p.data;let m;h.view.filters.find(b=>{if(b.column===i&&b.value.type===a)return m=b,!0}),m||(m={column:i,operator:nv(a),value:si(a,"")},h.view.filters.push(m)),Lm({filter:m,protyle:t,data:h,blockElement:e,target:e.querySelector(`.av__row--header .av__cell[data-col-id="${i}"]`)})})}}),d.addSeparator({id:"separator_2"})),d.addItem({id:"insertColumnLeft",icon:"iconInsertLeft",label:window.siyuan.languages.insertColumnLeft,click(){const p=Lc(t,e,n.previousElementSibling?.getAttribute("data-col-id")||"");e.contains(n)||(n=e.querySelector(`.av__row--header .av__cell--header[data-col-id="${i}"]`));const h=n.getBoundingClientRect();p.open({x:h.left,y:h.bottom,h:h.height})}}),d.addItem({id:"insertColumnRight",icon:"iconInsertRight",label:window.siyuan.languages.insertColumnRight,click(){const p=Lc(t,e,i);e.contains(n)||(n=e.querySelector(`.av__row--header .av__cell--header[data-col-id="${i}"]`));const h=n.getBoundingClientRect();p.open({x:h.left,y:h.bottom,h:h.height})}}),a!=="block"&&d.addItem({id:"hide",icon:"iconEyeoff",label:window.siyuan.languages.hide,click(){U(t,[{action:"setAttrViewColHidden",id:i,avID:s,data:!0,blockID:o}],[{action:"setAttrViewColHidden",id:i,avID:s,data:!1,blockID:o}])}});const c=n.dataset.pin==="true";d.addItem({id:c?"unfreezeCol":"freezeCol",icon:c?"iconUnpin":"iconPin",label:c?window.siyuan.languages.unfreezeCol:window.siyuan.languages.freezeCol,click(){U(t,[{action:"setAttrViewColPin",id:i,avID:s,data:!c,blockID:o}],[{action:"setAttrViewColPin",id:i,avID:s,data:c,blockID:o}]),gn(e.querySelector(`.av__row--header .av__cell[data-col-id="${i}"]`),void 0,{pin:!c})}}),a!=="block"&&(a!=="relation"&&d.addItem({id:"duplicate",icon:"iconCopy",label:window.siyuan.languages.duplicate,click(){E("/api/av/renderAttributeView",{id:s},p=>{sv({blockElement:e,viewID:e.getAttribute(u.CUSTOM_SY_AV_VIEW),protyle:t,colId:i,data:p.data})})}}),d.addItem({id:"delete",icon:"iconTrashcan",label:window.siyuan.languages.delete,async click(){if(a==="relation"){const h=(await Re("/api/av/getAttributeView",{id:s})).data.av.keyValues.find(m=>m.key.id===i);if(h.key.relation?.isTwoWay){const m=await Re("/api/av/getAttributeView",{id:h.key.relation.avID}),b=new we({title:window.siyuan.languages.removeCol.replace("${x}",h.key.name),content:`<div class="b3-dialog__content">
    ${window.siyuan.languages.confirmRemoveRelationField.replace("${x}",m.data.av.name)}
    <div class="fn__hr--b"></div>
    <button class="fn__block b3-button b3-button--remove" data-action="delete">${window.siyuan.languages.delete}</button>
    <div class="fn__hr"></div>
    <button class="fn__block b3-button b3-button--remove" data-action="keep-relation">${window.siyuan.languages.removeButKeepRelationField}</button>
    <div class="fn__hr"></div>
    <button class="fn__block b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button>
</div>`});b.element.addEventListener("click",y=>{let w=y.target;const _=typeof y.detail=="string";for(;w&&!w.isSameNode(b.element)||_;){const x=w.getAttribute("data-action");if(x==="delete"||_&&y.detail==="Enter"){xm({protyle:t,colId:i,avID:s,blockID:o,oldValue:l,type:a,cellElement:n,blockElement:e,removeDest:!0}),b.destroy();break}else if(x==="keep-relation"){xm({protyle:t,colId:i,avID:s,blockID:o,oldValue:l,type:a,cellElement:n,blockElement:e,removeDest:!1}),b.destroy();break}else if(w.classList.contains("b3-button--cancel")||_&&y.detail==="Escape"){b.destroy();break}w=w.parentElement}}),b.element.querySelector("button").focus(),b.element.setAttribute("data-key",u.DIALOG_CONFIRM);return}}xm({protyle:t,colId:i,avID:s,blockID:o,oldValue:l,type:a,cellElement:n,blockElement:e,removeDest:!1})}}),d.addSeparator({id:"separator_3"})),d.addItem({id:"wrap",label:`<label class="fn__flex"><span class="fn__flex-center">${window.siyuan.languages.wrap}</span><span class="fn__space fn__flex-1"></span>
<input type="checkbox" class="b3-switch b3-switch--menu"${n.dataset.wrap==="true"?" checked":""}></label>`,bind(p){const h=p.querySelector("input");h.addEventListener("change",()=>{U(t,[{action:"setAttrViewColWrap",id:i,avID:s,data:h.checked,blockID:o}],[{action:"setAttrViewColWrap",id:i,avID:s,data:!h.checked,blockID:o}])})}});const f=n.getBoundingClientRect();d.open({x:f.left,y:f.bottom,h:f.height});const g=window.siyuan.menus.menu.element.querySelector(".b3-text-field");g&&(g.select(),g.focus())},xm=t=>{const e=Y().format("YYYYMMDDHHmmss");U(t.protyle,[{action:"removeAttrViewCol",id:t.colId,avID:t.avID,removeDest:t.removeDest},{action:"doUpdateUpdated",id:t.blockID,data:e}],[{action:"addAttrViewCol",name:t.oldValue,avID:t.avID,type:t.type,id:t.colId,previousID:t.cellElement.previousElementSibling?.getAttribute("data-col-id")||""},{action:"doUpdateUpdated",id:t.blockID,data:t.blockElement.getAttribute("updated")}]),z_(t.blockElement,t.colId),t.blockElement.setAttribute("updated",e)},Am=t=>{const e=t.menuElement.querySelector(".b3-menu__item").getAttribute("data-col-id");let n="";const a=t.data.view.columns.find((s,o)=>{if(s.id===e)return n=t.data.view.columns[o-1]?.id,t.data.view.columns.splice(o,1),!0}),i=Y().format("YYYYMMDDHHmmss");U(t.protyle,[{action:"removeAttrViewCol",id:e,avID:t.avID,removeDest:t.isTwoWay},{action:"doUpdateUpdated",id:t.blockID,data:i}],[{action:"addAttrViewCol",name:a.name,avID:t.avID,type:a.type,id:e,previousID:n},{action:"doUpdateUpdated",id:t.blockID,data:t.blockElement.getAttribute("updated")}]),z_(t.blockElement,e),t.blockElement.setAttribute("updated",i),t.isCustomAttr?t.avPanelElement.remove():(t.menuElement.innerHTML=rs(t.data.view),ke(t.menuElement,t.tabRect.right-t.menuElement.clientWidth,t.tabRect.bottom,t.tabRect.height))},En=(t,e)=>`<button class="b3-menu__item" data-type="updateColType" data-old-type="${e}" data-new-type="${t}">
    <svg class="b3-menu__icon"><use xlink:href="#${sn(t)}"></use></svg>
    <span class="b3-menu__label">${Nl(t)}</span>
    ${t===e?'<svg class="b3-menu__checked"><use xlink:href="#iconSelect"></use></svg></span>':""}
</button>`,Lc=(t,e,n)=>{const a=new st("av-header-add"),i=e.getAttribute("data-av-id");typeof n>"u"&&(n=Array.from(e.querySelectorAll(".av__row--header .av__cell")).pop().getAttribute("data-col-id"));const s=e.getAttribute("data-node-id");return a.addItem({id:"text",icon:"iconAlignLeft",label:window.siyuan.languages.text,click(){const o=Lute.NewNodeID(),l=Y().format("YYYYMMDDHHmmss");U(t,[{action:"addAttrViewCol",name:window.siyuan.languages.text,avID:i,type:"text",id:o,previousID:n},{action:"doUpdateUpdated",id:s,data:l}],[{action:"removeAttrViewCol",id:o,avID:i},{action:"doUpdateUpdated",id:s,data:e.getAttribute("updated")}]),mn({blockElement:e,protyle:t,type:"text",name:window.siyuan.languages.text,id:o,previousID:n}),e.setAttribute("updated",l)}}),a.addItem({id:"number",icon:"iconNumber",label:window.siyuan.languages.number,click(){const o=Lute.NewNodeID(),l=Y().format("YYYYMMDDHHmmss");U(t,[{action:"addAttrViewCol",name:window.siyuan.languages.number,avID:i,type:"number",id:o,previousID:n},{action:"doUpdateUpdated",id:s,data:l}],[{action:"removeAttrViewCol",id:o,avID:i},{action:"doUpdateUpdated",id:s,data:e.getAttribute("updated")}]),mn({blockElement:e,protyle:t,type:"number",name:window.siyuan.languages.number,id:o,previousID:n}),e.setAttribute("updated",l)}}),a.addItem({id:"select",icon:"iconListItem",label:window.siyuan.languages.select,click(){const o=Lute.NewNodeID(),l=Y().format("YYYYMMDDHHmmss");U(t,[{action:"addAttrViewCol",name:window.siyuan.languages.select,avID:i,type:"select",id:o,previousID:n},{action:"doUpdateUpdated",id:s,data:l}],[{action:"removeAttrViewCol",id:o,avID:i},{action:"doUpdateUpdated",id:s,data:e.getAttribute("updated")}]),mn({blockElement:e,protyle:t,type:"select",name:window.siyuan.languages.select,id:o,previousID:n}),e.setAttribute("updated",l)}}),a.addItem({id:"multiSelect",icon:"iconList",label:window.siyuan.languages.multiSelect,click(){const o=Lute.NewNodeID(),l=Y().format("YYYYMMDDHHmmss");U(t,[{action:"addAttrViewCol",name:window.siyuan.languages.multiSelect,avID:i,type:"mSelect",id:o,previousID:n},{action:"doUpdateUpdated",id:s,data:l}],[{action:"removeAttrViewCol",id:o,avID:i},{action:"doUpdateUpdated",id:s,data:e.getAttribute("updated")}]),mn({blockElement:e,protyle:t,type:"mSelect",name:window.siyuan.languages.multiSelect,id:o,previousID:n}),e.setAttribute("updated",l)}}),a.addItem({id:"date",icon:"iconCalendar",label:window.siyuan.languages.date,click(){const o=Lute.NewNodeID(),l=Y().format("YYYYMMDDHHmmss");U(t,[{action:"addAttrViewCol",name:window.siyuan.languages.date,avID:i,type:"date",id:o,previousID:n},{action:"doUpdateUpdated",id:s,data:l}],[{action:"removeAttrViewCol",id:o,avID:i},{action:"doUpdateUpdated",id:s,data:e.getAttribute("updated")}]),mn({blockElement:e,protyle:t,type:"date",name:window.siyuan.languages.date,id:o,previousID:n}),e.setAttribute("updated",l)}}),a.addItem({id:"assets",icon:"iconImage",label:window.siyuan.languages.assets,click(){const o=Lute.NewNodeID(),l=Y().format("YYYYMMDDHHmmss");U(t,[{action:"addAttrViewCol",name:window.siyuan.languages.assets,avID:i,type:"mAsset",id:o,previousID:n},{action:"doUpdateUpdated",id:s,data:l}],[{action:"removeAttrViewCol",id:o,avID:i},{action:"doUpdateUpdated",id:s,data:e.getAttribute("updated")}]),mn({blockElement:e,protyle:t,type:"mAsset",name:window.siyuan.languages.assets,id:o,previousID:n}),e.setAttribute("updated",l)}}),a.addItem({id:"checkbox",icon:"iconCheck",label:window.siyuan.languages.checkbox,click(){const o=Lute.NewNodeID(),l=Y().format("YYYYMMDDHHmmss");U(t,[{action:"addAttrViewCol",name:window.siyuan.languages.checkbox,avID:i,type:"checkbox",id:o,previousID:n},{action:"doUpdateUpdated",id:s,data:l}],[{action:"removeAttrViewCol",id:o,avID:i},{action:"doUpdateUpdated",id:s,data:e.getAttribute("updated")}]),mn({blockElement:e,protyle:t,type:"checkbox",name:window.siyuan.languages.checkbox,id:o,previousID:n}),e.setAttribute("updated",l)}}),a.addItem({id:"link",icon:"iconLink",label:window.siyuan.languages.link,click(){const o=Lute.NewNodeID(),l=Y().format("YYYYMMDDHHmmss");U(t,[{action:"addAttrViewCol",name:window.siyuan.languages.link,avID:i,type:"url",id:o,previousID:n},{action:"doUpdateUpdated",id:s,data:l}],[{action:"removeAttrViewCol",id:o,avID:i},{action:"doUpdateUpdated",id:s,data:e.getAttribute("updated")}]),mn({blockElement:e,protyle:t,type:"url",name:window.siyuan.languages.link,id:o,previousID:n}),e.setAttribute("updated",l)}}),a.addItem({id:"email",icon:"iconEmail",label:window.siyuan.languages.email,click(){const o=Lute.NewNodeID(),l=Y().format("YYYYMMDDHHmmss");U(t,[{action:"addAttrViewCol",name:window.siyuan.languages.email,avID:i,type:"email",id:o,previousID:n},{action:"doUpdateUpdated",id:s,data:l}],[{action:"removeAttrViewCol",id:o,avID:i},{action:"doUpdateUpdated",id:s,data:e.getAttribute("updated")}]),mn({blockElement:e,protyle:t,type:"email",name:window.siyuan.languages.email,id:o,previousID:n}),e.setAttribute("updated",l)}}),a.addItem({id:"phone",icon:"iconPhone",label:window.siyuan.languages.phone,click(){const o=Lute.NewNodeID(),l=Y().format("YYYYMMDDHHmmss");U(t,[{action:"addAttrViewCol",name:window.siyuan.languages.phone,avID:i,type:"phone",id:o,previousID:n},{action:"doUpdateUpdated",id:s,data:l}],[{action:"removeAttrViewCol",id:o,avID:i},{action:"doUpdateUpdated",id:s,data:e.getAttribute("updated")}]),mn({blockElement:e,protyle:t,type:"phone",name:window.siyuan.languages.phone,id:o,previousID:n}),e.setAttribute("updated",l)}}),a.addItem({id:"template",icon:"iconMath",label:window.siyuan.languages.template,click(){const o=Lute.NewNodeID(),l=Y().format("YYYYMMDDHHmmss");U(t,[{action:"addAttrViewCol",name:window.siyuan.languages.template,avID:i,type:"template",id:o,previousID:n},{action:"doUpdateUpdated",id:s,data:l}],[{action:"removeAttrViewCol",id:o,avID:i},{action:"doUpdateUpdated",id:s,data:e.getAttribute("updated")}]),mn({blockElement:e,protyle:t,type:"template",name:window.siyuan.languages.template,id:o,previousID:n}),e.setAttribute("updated",l)}}),a.addItem({id:"relation",icon:"iconOpen",label:window.siyuan.languages.relation,click(){const o=Lute.NewNodeID(),l=Y().format("YYYYMMDDHHmmss");U(t,[{action:"addAttrViewCol",name:window.siyuan.languages.relation,avID:i,type:"relation",id:o,previousID:n},{action:"doUpdateUpdated",id:s,data:l}],[{action:"removeAttrViewCol",id:o,avID:i},{action:"doUpdateUpdated",id:s,data:e.getAttribute("updated")}]),mn({blockElement:e,protyle:t,type:"relation",name:window.siyuan.languages.relation,id:o,previousID:n}),e.setAttribute("updated",l)}}),a.addItem({id:"rollup",icon:"iconSearch",label:window.siyuan.languages.rollup,click(){const o=Lute.NewNodeID(),l=Y().format("YYYYMMDDHHmmss");U(t,[{action:"addAttrViewCol",name:window.siyuan.languages.rollup,avID:i,type:"rollup",id:o,previousID:n},{action:"doUpdateUpdated",id:s,data:l}],[{action:"removeAttrViewCol",id:o,avID:i},{action:"doUpdateUpdated",id:s,data:e.getAttribute("updated")}]),mn({blockElement:e,protyle:t,type:"rollup",name:window.siyuan.languages.rollup,id:o,previousID:n}),e.setAttribute("updated",l)}}),a.addItem({id:"lineNumber",icon:"iconOrderedList",label:window.siyuan.languages.lineNumber,click(){const o=Lute.NewNodeID(),l=Y().format("YYYYMMDDHHmmss");U(t,[{action:"addAttrViewCol",name:window.siyuan.languages.lineNumber,avID:i,type:"lineNumber",id:o,previousID:n},{action:"doUpdateUpdated",id:s,data:l}],[{action:"removeAttrViewCol",id:o,avID:i},{action:"doUpdateUpdated",id:s,data:e.getAttribute("updated")}]),mn({blockElement:e,protyle:t,type:"lineNumber",name:window.siyuan.languages.lineNumber,id:o,previousID:n}),e.setAttribute("updated",l)}}),a.addItem({id:"createdTime",icon:"iconClock",label:window.siyuan.languages.createdTime,click(){const o=Lute.NewNodeID(),l=Y().format("YYYYMMDDHHmmss");U(t,[{action:"addAttrViewCol",name:window.siyuan.languages.createdTime,avID:i,type:"created",id:o,previousID:n},{action:"doUpdateUpdated",id:s,data:l}],[{action:"removeAttrViewCol",id:o,avID:i},{action:"doUpdateUpdated",id:s,data:e.getAttribute("updated")}]),mn({blockElement:e,protyle:t,type:"created",name:window.siyuan.languages.createdTime,id:o,previousID:n}),e.setAttribute("updated",l)}}),a.addItem({id:"updatedTime",icon:"iconClock",label:window.siyuan.languages.updatedTime,click(){const o=Lute.NewNodeID(),l=Y().format("YYYYMMDDHHmmss");U(t,[{action:"addAttrViewCol",name:window.siyuan.languages.updatedTime,avID:i,type:"updated",id:o,previousID:n},{action:"doUpdateUpdated",id:s,data:l}],[{action:"removeAttrViewCol",id:o,avID:i},{action:"doUpdateUpdated",id:s,data:e.getAttribute("updated")}]),mn({blockElement:e,protyle:t,type:"updated",name:window.siyuan.languages.updatedTime,id:o,previousID:n}),e.setAttribute("updated",l)}}),a},$x=(t,e,n)=>({hidden:!1,icon:"",id:e,name:n,desc:"",numberFormat:"",pin:!1,template:"",type:t,width:"",wrap:!1,calc:null}),dt=(t,e,n,a,i=!0)=>{let s=[];t.getAttribute("data-type")==="NodeAttributeView"?s=[t]:s=Array.from(t.querySelectorAll('[data-type="NodeAttributeView"]')),s.length!==0&&s.length>0&&s.forEach(o=>{if(o.getAttribute("data-render")==="true")return;const l=o.style.alignSelf;if(o.firstElementChild.innerHTML===""){o.style.alignSelf="";let A="";[1,2,3].forEach(()=>{A+=`<div class="av__row">
    <div style="width: 24px;flex-shrink: 0"></div>
    <div class="av__cell" style="width: 200px"><span class="av__pulse"></span></div>
    <div class="av__cell" style="width: 200px"><span class="av__pulse"></span></div>
    <div class="av__cell" style="width: 200px"><span class="av__pulse"></span></div>
    <div class="av__cell" style="width: 200px"><span class="av__pulse"></span></div>
</div>`}),o.firstElementChild.innerHTML=A}const r=o.querySelector(".av__scroll")?.scrollLeft||0,d=o.querySelector(".av__row--header")?.style.transform,c=o.querySelector(".av__row--footer")?.style.transform,f=[];o.querySelectorAll(".av__row--select").forEach(A=>{const $=A.getAttribute("data-id");$&&f.push($)});let g="";const p=o.querySelector(".av__cell--select");p&&(g=L(p,"av__row").dataset.id+u.ZWSP+p.getAttribute("data-col-id"));let h="";const m=o.querySelector(".av__drag-fill");m&&(h=L(m,"av__row").dataset.id+u.ZWSP+m.parentElement.getAttribute("data-col-id"));const b=[];o.querySelectorAll(".av__cell--active").forEach(A=>{b.push(L(A,"av__row").dataset.id+u.ZWSP+A.getAttribute("data-col-id"))});const y=e.options.history?.created,w=e.options.history?.snapshot;let _=o.getAttribute(u.CUSTOM_SY_AV_VIEW)||"";if(typeof a=="string"){const A=o.querySelector(`.av__views > .layout-tab-bar > .item[data-id="${a}"]`);A&&(o.dataset.pageSize=A.dataset.page),_=a,E("/api/av/setDatabaseBlockView",{id:o.dataset.nodeId,viewID:a}),o.setAttribute(u.CUSTOM_SY_AV_VIEW,_)}let x=o.querySelector('[data-type="av-search"]');const S=x&&document.activeElement.isSameNode(x),k=x?.value||"";E(y?"/api/av/renderHistoryAttributeView":w?"/api/av/renderSnapshotAttributeView":"/api/av/renderAttributeView",{id:o.getAttribute("data-av-id"),created:y,snapshot:w,pageSize:parseInt(o.dataset.pageSize)||void 0,viewID:_,query:k.trim()},A=>{const $=A.data.view;o.dataset.pageSize||(o.dataset.pageSize=$.pageSize.toString());let M='<div class="av__row av__row--header"><div class="av__colsticky"><div class="av__firstcol"><svg><use xlink:href="#iconUncheck"></use></svg></div></div>',C="",N=-1,O=-1,te=0;const ne=o.clientWidth;let oe=!1;$.columns.forEach((ie,_e)=>{oe||$.filters.find(ye=>{if(ye.value.type===ie.type&&ie.id===ye.column)return oe=!0,!0}),ie.hidden||(ie.pin&&(N=_e),te<ne-200&&(te+=parseInt(ie.width)||200,O=_e))}),N=Math.min(N,O),N>-1&&(M='<div class="av__row av__row--header"><div class="av__colsticky"><div class="av__firstcol"><svg><use xlink:href="#iconUncheck"></use></svg></div>',C='<div class="av__colsticky">');let ce=!1;$.columns.forEach((ie,_e)=>{ie.hidden||(M+=`<div class="av__cell av__cell--header" data-col-id="${ie.id}"  draggable="true" 
data-icon="${ie.icon}" data-dtype="${ie.type}" data-wrap="${ie.wrap}" data-pin="${ie.pin}" 
data-desc="${Xe(ie.desc)}" data-position="north" 
style="width: ${ie.width||"200px"};">
    ${ie.icon?ge(ie.icon,"av__cellheadericon",!0):`<svg class="av__cellheadericon"><use xlink:href="#${sn(ie.type)}"></use></svg>`}
    <span class="av__celltext fn__flex-1">${pe(ie.name)}</span>
    ${ie.pin?'<svg class="av__cellheadericon av__cellheadericon--pin"><use xlink:href="#iconPin"></use></svg>':""}
    <div class="av__widthdrag"></div>
</div>`,N===_e&&(M+="</div>"),ie.type==="lineNumber"?C+=`<div data-col-id="${ie.id}" data-dtype="${ie.type}" class="av__calc" style="width: ${ie.width||"200px"}">&nbsp;</div>`:C+=`<div class="av__calc${ie.calc&&ie.calc.operator!==""?" av__calc--ashow":""}" data-col-id="${ie.id}" data-dtype="${ie.type}" data-operator="${ie.calc?.operator||""}" 
style="width: ${ie.width||"200px"}">${wx(ie)||`<svg><use xlink:href="#iconDown"></use></svg><small>${window.siyuan.languages.calc}</small>`}</div>`,ie.calc&&ie.calc.operator!==""&&(ce=!0),N===_e&&(C+="</div>"))}),M+=`<div class="block__icons" style="min-height: auto">
    <div class="block__icon block__icon--show" data-type="av-header-more"><svg><use xlink:href="#iconMore"></use></svg></div>
    <div class="fn__space"></div>
    <div class="block__icon block__icon--show ariaLabel" aria-label="${window.siyuan.languages.newCol}" data-type="av-header-add" data-position="4south"><svg><use xlink:href="#iconAdd"></use></svg></div>
</div>
</div>`,$.rows.forEach((ie,_e)=>{M+=`<div class="av__row" data-id="${ie.id}">`,N>-1?M+='<div class="av__colsticky"><div class="av__firstcol"><svg><use xlink:href="#iconUncheck"></use></svg></div>':M+='<div class="av__colsticky"><div class="av__firstcol"><svg><use xlink:href="#iconUncheck"></use></svg></div></div>',ie.cells.forEach((ye,qt)=>{if($.columns[qt].hidden)return;let Ca="";ye.valueType==="checkbox"&&(Ca=ye.value?.checkbox?.checked?" av__cell-check":" av__cell-uncheck"),M+=`<div class="av__cell${Ca}" data-id="${ye.id}" data-col-id="${$.columns[qt].id}"
${ye.valueType==="block"?'data-block-id="'+(ye.value.block.id||"")+'"':""} data-wrap="${$.columns[qt].wrap}" 
data-dtype="${$.columns[qt].type}" 
${ye.value?.isDetached?' data-detached="true"':""} 
style="width: ${$.columns[qt].width||"200px"};
${ye.valueType==="number"?"text-align: right;":""}
${ye.bgColor?`background-color:${ye.bgColor};`:""}
${ye.color?`color:${ye.color};`:""}">${kc(ye.value,_e)}</div>`,N===qt&&(M+="</div>")}),M+="<div></div></div>"});let Ge="",$e;A.data.views.forEach(ie=>{Ge+=`<div data-position="north" data-id="${ie.id}" data-page="${ie.pageSize}" data-desc="${Rt(ie.desc||"")}" class="ariaLabel item${ie.id===A.data.viewID?" item--focus":""}">
    ${ie.icon?ge(ie.icon,"item__graphic",!0):'<svg class="item__graphic"><use xlink:href="#iconTable"></use></svg>'}
    <span class="item__text">${pe(ie.name)}</span>
</div>`,ie.id===A.data.viewID&&($e=ie)});const Ie=`<div class="av__body">
    ${M}
    <div class="av__row--util${$.rowCount>$.rows.length?" av__readonly--show":""}">
        <div class="av__colsticky">
            <button class="b3-button" data-type="av-add-bottom">
                <svg><use xlink:href="#iconAdd"></use></svg>
                <span>${window.siyuan.languages.newRow}</span>
            </button>
            <span class="fn__space"></span>
            <button class="b3-button${$.rowCount>$.rows.length?"":" fn__none"}" data-type="av-load-more">
                <svg><use xlink:href="#iconArrowDown"></use></svg>
                <span>${window.siyuan.languages.loadMore}</span>
                <svg data-type="set-page-size" data-size="${$.pageSize}"><use xlink:href="#iconMore"></use></svg>
            </button>
        </div>
    </div>
    <div class="av__row--footer${ce?" av__readonly--show":""}">${C}</div>
</div>`;i?o.firstElementChild.outerHTML=`<div class="av__container">
    <div class="av__header">
        <div class="fn__flex av__views${S||k?" av__views--show":""}">
            <div class="layout-tab-bar fn__flex">
                ${Ge}
            </div>
            <div class="fn__space"></div>
            <span data-type="av-add" class="block__icon ariaLabel" data-position="8south" aria-label="${window.siyuan.languages.newView}">
                <svg><use xlink:href="#iconAdd"></use></svg>
            </span>
            <div class="fn__flex-1"></div>
            <div class="fn__space"></div>
            <span data-type="av-switcher" class="block__icon${A.data.views.length>0?"":" fn__none"}">
                <svg><use xlink:href="#iconDown"></use></svg>
                <span class="fn__space"></span>
                <small>${A.data.views.length}</small>
            </span>
            <div class="fn__space"></div>
            <span data-type="av-filter" class="block__icon${oe?" block__icon--active":""}">
                <svg><use xlink:href="#iconFilter"></use></svg>
            </span>
            <div class="fn__space"></div>
            <span data-type="av-sort" class="block__icon${$.sorts.length>0?" block__icon--active":""}">
                <svg><use xlink:href="#iconSort"></use></svg>
            </span>
            <div class="fn__space"></div>
            <span data-type="av-search-icon" class="block__icon">
                <svg><use xlink:href="#iconSearch"></use></svg>
            </span>
            <div style="position: relative" class="fn__flex">
                <input style="${S||k?"width:128px":"width:0;padding-left: 0;padding-right: 0;"}" data-type="av-search" class="b3-text-field b3-text-field--text" placeholder="${window.siyuan.languages.search}">
            </div>
            <div class="fn__space"></div>
            <span data-type="av-more" class="block__icon">
                <svg><use xlink:href="#iconMore"></use></svg>
            </span>
            <div class="fn__space"></div>
            <span data-type="av-add-more" class="block__icon ariaLabel" data-position="8south" aria-label="${window.siyuan.languages.newRow}">
                <svg><use xlink:href="#iconAdd"></use></svg>
            </span>
            <div class="fn__space"></div>
            ${A.data.isMirror?` <span data-av-id="${A.data.id}" data-popover-url="/api/av/getMirrorDatabaseBlocks" class="popover__block block__icon block__icon--show ariaLabel" data-position="8south" aria-label="${window.siyuan.languages.mirrorTip}">
    <svg><use xlink:href="#iconSplitLR"></use></svg></span><div class="fn__space"></div>`:""}
        </div>
        <div contenteditable="${e.disabled||B(o,"data-type","NodeBlockQueryEmbed")?"false":"true"}" spellcheck="${window.siyuan.config.editor.spellcheck.toString()}" class="av__title${$e.hideAttrViewName?" fn__none":""}" data-title="${A.data.name||""}" data-tip="${window.siyuan.languages.title}">${A.data.name||""}</div>
        <div class="av__counter fn__none"></div>
    </div>
    <div class="av__scroll">
        ${Ie}
    </div>
    <div class="av__cursor" contenteditable="true">${u.ZWSP}</div>
</div>`:o.firstElementChild.querySelector(".av__scroll").innerHTML=Ie,o.setAttribute("data-render","true"),o.style.margin="",r&&(o.querySelector(".av__scroll").scrollLeft=r),l&&(o.style.alignSelf=l);const Fe=e.contentElement.getBoundingClientRect();if(d?o.querySelector(".av__row--header").style.transform=d:setTimeout(()=>{is(o,Fe,"top")},u.TIMEOUT_LOAD),c?o.querySelector(".av__row--footer").style.transform=c:setTimeout(()=>{is(o,Fe,"bottom")},u.TIMEOUT_LOAD),g){const ie=o.querySelector(`.av__row[data-id="${g.split(u.ZWSP)[0]}"] .av__cell[data-col-id="${g.split(u.ZWSP)[1]}"]`);ie&&ie.classList.add("av__cell--select");const _e=document.querySelector(".av__mask");_e?_e.querySelector("textarea, input")?.focus():!document.querySelector(".av__panel")&&!S&&ae(o),Ii(o,ie)}if(f.forEach((ie,_e)=>{const ye=o.querySelector(`.av__row[data-id="${ie}"]`);ye&&(ye.classList.add("av__row--select"),ye.querySelector(".av__firstcol use").setAttribute("xlink:href","#iconCheck")),_e===f.length-1&&ye&&as(ye)}),h&&In(o.querySelector(`.av__row[data-id="${h.split(u.ZWSP)[0]}"] .av__cell[data-col-id="${h.split(u.ZWSP)[1]}"]`)),b.forEach(ie=>{o.querySelector(`.av__row[data-id="${ie.split(u.ZWSP)[0]}"] .av__cell[data-col-id="${ie.split(u.ZWSP)[1]}"]`)?.classList.add("av__cell--active")}),getSelection().rangeCount>0){const ie=getSelection().getRangeAt(0);if(!L(ie.startContainer,"av__title")){const _e=P(ie.startContainer);_e&&o.isSameNode(_e)&&!S&&ae(o)}}if(o.querySelector(".layout-tab-bar").scrollLeft=o.querySelector(".layout-tab-bar .item--focus").offsetLeft,n&&n(),!i)return;const mt=o.querySelector(".av__views");x=o.querySelector('[data-type="av-search"]'),x.value=k||"",S&&x.focus(),x.addEventListener("compositionstart",ie=>{ie.stopPropagation()}),x.addEventListener("keydown",ie=>{ie.isComposing||ni(ie)}),x.addEventListener("input",ie=>{ie.stopPropagation(),!ie.isComposing&&(x.value||document.activeElement.isSameNode(x)?mt.classList.add("av__views--show"):mt.classList.remove("av__views--show"),Cm(o,e))}),x.addEventListener("compositionend",()=>{Cm(o,e)}),x.addEventListener("blur",ie=>{ie.isComposing||x.value||(mt.classList.remove("av__views--show"),x.style.width="0",x.style.paddingLeft="0",x.style.paddingRight="0")}),Pf({inputElement:x,right:0,width:"1em",height:x.clientHeight,clearCB(){mt.classList.remove("av__views--show"),x.style.width="0",x.style.paddingLeft="0",x.style.paddingRight="0",ae(o),Cm(o,e)}})})})};let lv;const Cm=(t,e)=>{clearTimeout(lv),lv=window.setTimeout(()=>{t.removeAttribute("data-render"),dt(t,e,void 0,void 0,!1)},u.TIMEOUT_INPUT)},rv={},Mx=(t,e)=>{e.action==="setAttrViewName"&&Array.from(t.wysiwyg.element.querySelectorAll(`[data-av-id="${e.id}"]`)).forEach(n=>{const a=n.querySelector(".av__title");a&&(a.textContent=e.data,a.dataset.title=e.data)}),clearTimeout(rv[t.id]),rv[t.id]=window.setTimeout(()=>{if(e.action==="setAttrViewColWidth")Array.from(t.wysiwyg.element.querySelectorAll(`[data-av-id="${e.avID}"]`)).forEach(n=>{const a=n.querySelector(`.av__cell[data-col-id="${e.id}"]`);!a||a.style.width===e.data||n.getAttribute("custom-sy-av-view")!==e.keyID||n.querySelectorAll(".av__row").forEach(i=>{i.querySelector(`[data-col-id="${e.id}"]`).style.width=e.data})});else{const n=e.action==="setAttrViewName"?e.id:e.avID;Array.from(t.wysiwyg.element.querySelectorAll(`[data-av-id="${n}"]`)).forEach(a=>{a.removeAttribute("data-render");const i=a.querySelector('.av__row[data-need-update="true"]');(e.action==="sortAttrViewCol"||e.action==="sortAttrViewRow")&&(a.querySelectorAll(".av__cell--active").forEach(s=>{s.classList.remove("av__cell--active"),s.querySelector(".av__drag-fill")?.remove()}),In(a.querySelector(".av__cell--select"))),dt(a,t,()=>{const s=document.querySelector(`.b3-dialog--open[data-key="${u.DIALOG_ATTR}"] div[data-av-id="${n}"]`);s?ym(s.parentElement,s.dataset.nodeId,t):e.action==="insertAttrViewBlock"&&i&&!a.querySelector(`.av__row[data-id="${i.getAttribute("data-id")}"]`)&&(j(window.siyuan.languages.insertRowTip),document.querySelector(".av__mask")?.remove()),a.removeAttribute("data-loading")})})}},["insertAttrViewBlock"].includes(e.action)?2:100)},cv=(t,e)=>{t.block.showAll=!0;let n="";e.forEach((a,i)=>{n+=fv(a.blockPaths,!1,i)+uv(a.dom,a.expand)}),t.wysiwyg.element.innerHTML=n,Tm(t.wysiwyg.element),yt(t.wysiwyg.element),ze(t.wysiwyg.element),dt(t.wysiwyg.element,t),Be(t,t.wysiwyg.element),Ac(t),(window.siyuan.config.readonly||window.siyuan.config.editor.readOnly)&&Zn(t)},dv=(t,e)=>{e.firstElementChild.classList.contains("li")?t?e.querySelectorAll(".li .li").forEach(n=>{n.childElementCount>3&&n.setAttribute("fold","1")}):e.firstElementChild.setAttribute("fold","1"):e.firstElementChild.getAttribute("data-type")==="NodeHeading"&&Array.from(e.children).forEach((n,a)=>{(t&&a>2||!t&&a>1)&&((t&&a===3||!t&&a===2)&&n.insertAdjacentHTML("beforebegin",'<div style="max-width: 100%;justify-content: center;" contenteditable="false" class="protyle-breadcrumb__item"><svg style="transform: rotate(90deg);"><use xlink:href="#iconMore"></use></svg></div>'),n.classList.add("fn__none"))})},uv=(t,e)=>{const n=document.createElement("template");return n.innerHTML=t,dv(e,n.content),n.innerHTML},Px=(t,e)=>{E("/api/filetree/getDoc",{id:e.getAttribute("data-id"),size:u.SIZE_GET_MAX},n=>{e.parentElement.querySelector(".protyle-breadcrumb__item--active").classList.remove("protyle-breadcrumb__item--active"),e.classList.add("protyle-breadcrumb__item--active");let a=e.parentElement.nextElementSibling;for(;a&&!a.classList.contains("protyle-breadcrumb__bar");){const i=a;a=a.nextElementSibling,i.remove()}e.parentElement.insertAdjacentHTML("afterend",uv(n.data.content,!0)),yt(e.parentElement.parentElement),dt(e.parentElement.parentElement,t),Be(t,e.parentElement.parentElement),n.data.isSyncing?xv(t):window.siyuan.config.readonly||window.siyuan.config.editor.readOnly?Zn(t):e.parentElement.parentElement.classList.contains("protyle-wysiwyg__embed")&&e.parentElement.parentElement.querySelectorAll('[contenteditable="true"][spellcheck]').forEach(i=>{i.setAttribute("contenteditable","false")})})},Nx=t=>{let e=t.nextElementSibling;for(;e&&!e.classList.contains("protyle-breadcrumb__bar");)e.classList.remove("fn__none"),e=e.nextElementSibling;t.remove()},fv=(t,e,n)=>{if(1>t.length)return`<div contenteditable="false" style="border-top: ${n===0?0:1}px solid var(--b3-border-color);min-height: 0;width: 100%;" class="protyle-breadcrumb__bar"><span></span></div>`;let a="";return t.forEach((i,s)=>{s===0&&!e||(a+=`<span class="protyle-breadcrumb__item${s===t.length-1?" protyle-breadcrumb__item--active":""}" data-id="${i.id}">
    <svg class="popover__block" data-id="${i.id}"><use xlink:href="#${Rn(i.type,i.subType)}"></use></svg>
    <span class="protyle-breadcrumb__text" title="${i.name}">${i.name}</span>
</span>`,s!==t.length-1&&(a+='<svg class="protyle-breadcrumb__arrow"><use xlink:href="#iconRight"></use></svg>'))}),`<div contenteditable="false" class="protyle-breadcrumb__bar protyle-breadcrumb__bar--nowrap">${a}</div>`},Tm=t=>{t.querySelectorAll(".protyle-breadcrumb__bar").forEach(e=>{e.classList.remove("protyle-breadcrumb__bar--nowrap");const n=Array.from(e.querySelectorAll(".protyle-breadcrumb__text"));if(n.length===0)return;let a=!1;for(;e.scrollHeight>30&&!a&&n.length>1;)n.find((i,s)=>{if(s>0){if(!i.classList.contains("protyle-breadcrumb__text--ellipsis"))return i.classList.add("protyle-breadcrumb__text--ellipsis"),!0;s===n.length-1&&i.classList.contains("protyle-breadcrumb__text--ellipsis")&&(a=!0)}});e.classList.add("protyle-breadcrumb__bar--nowrap"),e.lastElementChild&&(e.scrollLeft=e.lastElementChild.offsetLeft-e.clientWidth+14)})},Be=(t,e,n)=>{let a=[];e.getAttribute("data-type")==="NodeBlockQueryEmbed"?a=[e]:a=Array.from(e.querySelectorAll('[data-type="NodeBlockQueryEmbed"]')),a.length!==0&&a.forEach(i=>{if(i.getAttribute("data-render")==="true")return;i.setAttribute("data-render","true"),i.style.height=i.clientHeight-8+"px",i.innerHTML=`<div class="protyle-icons${F(i)?" fn__none":""}">
    <span aria-label="${window.siyuan.languages.refresh}" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-action__reload protyle-icon--first"><svg class="fn__rotate"><use xlink:href="#iconRefresh"></use></svg></span>
    <span aria-label="${window.siyuan.languages.update} SQL" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-action__edit"><svg><use xlink:href="#iconEdit"></use></svg></span>
    <span aria-label="${window.siyuan.languages.more}" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-action__menu protyle-icon--last"><svg><use xlink:href="#iconMore"></use></svg></span>
</div>${i.lastElementChild.outerHTML}`;const s=Lute.UnEscapeHTMLStr(i.getAttribute("data-content"));let o=i.getAttribute("breadcrumb");if(o?o=o==="true":o=window.siyuan.config.editor.embedBlockBreadcrumb,Le(i,"sb")&&(o=!1),s.startsWith("//!js"))try{const r=new Function("fetchSyncPost","item","protyle","top",s)(Re,i,t,n);if(r instanceof Promise)r.then(d=>{if(Array.isArray(d))E("/api/search/getEmbedBlock",{embedBlockID:i.getAttribute("data-node-id"),includeIDs:d,headingMode:i.getAttribute("custom-heading-mode")==="1"?1:0,breadcrumb:o},c=>{xc(c.data.blocks||[],t,i,n)});else return}).catch(()=>{xc([],t,i,n)});else if(Array.isArray(r))E("/api/search/getEmbedBlock",{embedBlockID:i.getAttribute("data-node-id"),includeIDs:r,headingMode:i.getAttribute("custom-heading-mode")==="1"?1:0,breadcrumb:o},d=>{xc(d.data.blocks||[],t,i,n)});else return}catch{xc([],t,i,n)}else E("/api/search/searchEmbedBlock",{embedBlockID:i.getAttribute("data-node-id"),stmt:s,headingMode:i.getAttribute("custom-heading-mode")==="1"?1:0,excludeIDs:[i.getAttribute("data-node-id"),t.block.rootID],breadcrumb:o},r=>{xc(r.data.blocks,t,i,n)})})},xc=(t,e,n,a)=>{const i=n.querySelector(".fn__rotate");i&&i.classList.remove("fn__rotate");let s="";t.forEach(r=>{let d="";r.blockPaths.length!==0&&(d=fv(r.blockPaths,!0)),s+=`<div class="protyle-wysiwyg__embed" data-id="${r.block.id}">${d}${r.block.content}</div>`}),t.length>0?(n.lastElementChild.insertAdjacentHTML("beforebegin",s+`<div style="position: absolute;">${u.ZWSP}</div>`),Tm(n.querySelector(".protyle-wysiwyg__embed"))):n.lastElementChild.insertAdjacentHTML("beforebegin",`<div class="ft__smaller ft__secondary b3-form__space--small" contenteditable="false">${window.siyuan.languages.refExpired}</div>
<div style="position: absolute;">${u.ZWSP}</div>`),yt(n),ze(n),dt(n,e),a&&(e.contentElement.scrollTop=a);let o=0,l=n;for(;o<4&&l;)l=B(l.parentElement,"data-type","NodeBlockQueryEmbed"),o++;o<4&&n.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(r=>{Be(e,r)}),n.style.height=""},pv=(t,e)=>{const n=Je(t),a=[];if(n.isSameNode(t)||(t.remove(),a.push({action:"delete",id:n.getAttribute("data-node-id")})),n.remove(),e.wysiwyg.element.childElementCount===0)if(e.block.rootID===e.block.id){const i=Lute.NewNodeID(),s=pa(!1,!1,i);a.push({action:"insert",data:s.outerHTML,id:i,parentID:e.block.parentID}),e.wysiwyg.element.innerHTML=s.outerHTML}else Vt({protyle:e,id:e.block.rootID,isPushBack:!1,focusId:e.block.id});a.length>0&&U(e,a,[])},gv=()=>{if(window.siyuan.transactions.length===0)return;const t=window.siyuan.transactions[0].protyle,e=window.siyuan.transactions[0].doOperations,n=window.siyuan.transactions[0].undoOperations;window.siyuan.transactions.splice(0,1),E("/api/transactions",{session:t.id,app:u.SIYUAN_APPID,transactions:[{doOperations:e,undoOperations:n}]},a=>{window.siyuan.transactions.length===0?bn([],t.block.rootID,!0):gv();let i;if(getSelection().rangeCount>0&&(i=getSelection().getRangeAt(0)),a.data[0].doOperations.forEach(s=>{if(s.action==="unfoldHeading"||s.action==="foldHeading"){wv(s,t);return}if(s.action==="update"){t.options.backlinkData&&(Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${s.id}"]`)).forEach(o=>{F(o)||i&&(o.isSameNode(i.startContainer)||o.contains(i.startContainer))||(o.outerHTML=s.data.replace("<wbr>",""))}),yt(t.wysiwyg.element),ze(t.wysiwyg.element),dt(t.wysiwyg.element,t),Be(t,t.wysiwyg.element)),Im(t,s);return}if(s.action==="delete"||s.action==="append"){t.options.backlinkData&&Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${s.id}"]`)).forEach(o=>{F(o)||o.remove()}),t.wysiwyg.element.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(o=>{o.querySelector(`[data-node-id="${s.id}"]`)&&(o.removeAttribute("data-render"),Be(t,o))}),Q(["gutter"],t);return}if(s.action==="move"){if(t.options.backlinkData){const o=[];Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${s.id}"]`)).forEach(r=>{if(!F(r)&&!r.contains(i.startContainer)){o.push(r);return}});let l=!1;s.previousID&&o.length>0?Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${s.previousID}"]`)).forEach(r=>{!F(r)&&!r.nextElementSibling.contains(i.startContainer)&&(r.after(Xa(o[0].cloneNode(!0))),l=!0)}):o.length>0&&Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${s.parentID}"]`)).forEach(r=>{!F(r)&&!it(r).contains(i.startContainer)&&(r.firstElementChild?.classList.contains("protyle-action")?r.firstElementChild.after(Xa(o[0].cloneNode(!0))):r.prepend(Xa(o[0].cloneNode(!0))),l=!0)}),o.forEach(r=>{l?r.remove():!l&&r.parentElement&&pv(r,t)})}t.wysiwyg.element.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(o=>{o.querySelector(`[data-node-id="${s.id}"]`)&&(o.removeAttribute("data-render"),Be(t,o))});return}if(s.action==="insert"&&t.options.backlinkData){const o=[];s.previousID?Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${s.previousID}"]`)).forEach(l=>{l.nextElementSibling?.getAttribute("data-node-id")!==s.id&&!B(l,"data-node-id",s.id)&&!F(l)&&(l.insertAdjacentHTML("afterend",s.data),o.push(l.nextElementSibling))}):Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${s.parentID}"]`)).forEach(l=>{F(l)||(l.firstElementChild&&l.firstElementChild.classList.contains("protyle-action")&&l.firstElementChild.nextElementSibling.getAttribute("data-node-id")!==s.id?(l.firstElementChild.insertAdjacentHTML("afterend",s.data),o.push(l.firstElementChild.nextElementSibling)):l.firstElementChild&&l.firstElementChild.getAttribute("data-node-id")!==s.id&&(l.insertAdjacentHTML("afterbegin",s.data),o.push(l.firstElementChild)))}),t.wysiwyg.element.querySelectorAll('[data-type="NodeHeading"]').forEach(l=>{l.lastElementChild.getAttribute("spin")==="1"&&l.lastElementChild.remove()}),o.forEach(l=>{yt(l),ze(l),dt(l,t),Be(t,l);const r=l.querySelector("wbr");r&&r.remove()})}}),t.wysiwyg.element.childElementCount===0&&!t.block.showAll){const s=Lute.NewNodeID(),o=pa(!1,!0,s);t.wysiwyg.element.insertAdjacentElement("afterbegin",o),U(t,[{action:"insert",data:o.outerHTML,id:s,parentID:t.block.parentID}]),he(o,i)}})},Im=(t,e)=>{let n=!1;t.wysiwyg.element.querySelectorAll(`[data-type="NodeBlockQueryEmbed"] [data-node-id="${e.id}"]`).forEach(a=>{const i=document.createElement("div");i.innerHTML=e.data,i.querySelectorAll('[contenteditable="true"]').forEach(o=>{o.setAttribute("contenteditable","false")});const s=i.querySelector("wbr");s&&s.remove(),a.outerHTML=i.innerHTML,n=!0}),n&&(yt(t.wysiwyg.element),ze(t.wysiwyg.element),dt(t.wysiwyg.element,t))},hv=(t,e,n,a)=>{a&&wb(t[0]),t.forEach(i=>{if(a)i.remove();else{const s=Je(i);s&&s.remove()}}),n.wysiwyg.element.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(i=>{i.querySelector(`[data-node-id="${e}"]`)&&(i.removeAttribute("data-render"),Be(n,i))})},mv=(t,e,n,a)=>{t.forEach(s=>{s.getAttribute("data-subtype")==="echarts"?s.outerHTML=e.lute.SpinBlockDOM(n.data):s.outerHTML=n.data}),Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${n.id}"]`)).find(s=>{if(!F(s))return t[0]=s,!0});const i=t[0].querySelector("wbr");if(a){const s=me(t[0]);i?he(t[0],s):ae(t[0])}else i&&i.remove();yt(t.length===1?t[0]:e.wysiwyg.element),ze(t.length===1?t[0]:e.wysiwyg.element),dt(t.length===1?t[0]:e.wysiwyg.element,e),Be(e,t.length===1?t[0]:e.wysiwyg.element),Im(e,n)},Dm=(t,e,n)=>{const a=[];if(Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`)).forEach(i=>{F(i)||a.push(i)}),e.action==="setAttrs"){t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`).forEach(i=>{JSON.parse(e.data).fold==="1"?i.setAttribute("fold","1"):i.removeAttribute("fold")});return}if(e.action==="unfoldHeading"){const i=t.contentElement.scrollTop;t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`).forEach(s=>{if(s.removeAttribute("fold"),n)return;const o=F(s);if(o){o.removeAttribute("data-render"),Be(t,o);return}e.retData&&(bv(e.retData,t),s.insertAdjacentHTML("afterend",e.retData)),e.data==="remove"&&s.remove()}),e.retData&&(t.disabled&&Zn(t),yt(t.wysiwyg.element),ze(t.wysiwyg.element),dt(t.wysiwyg.element,t),Be(t,t.wysiwyg.element),t.contentElement.scrollTop=i,t.scroll.lastScrollTop=i);return}if(e.action==="foldHeading"){if(t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`).forEach(i=>{i.setAttribute("fold","1"),e.retData||t_(i)}),n)return;e.retData&&(e.retData.forEach(i=>{let s;Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${i}"]`)).find(o=>{if(s=F(o),s)return!0;o.remove()}),s&&(s.removeAttribute("data-render"),Be(t,s))}),t.wysiwyg.element.childElementCount===0&&Vt({protyle:t,id:t.block.rootID,isPushBack:!1,focusId:e.id}));return}if(e.action==="delete"){a.length>0||!n?hv(a,e.id,t,n):n&&Vt({protyle:t,id:t.block.rootID,isPushBack:!1,focusId:e.id,callback(){Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`)).forEach(i=>{F(i)||a.push(i)}),hv(a,e.id,t,n)}});return}if(e.action==="update"){a.length>0?mv(a,t,e,n):n?Vt({protyle:t,id:t.block.rootID,isPushBack:!1,focusId:e.id,callback(){Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`)).forEach(i=>{F(i)||a.push(i)}),mv(a,t,e,n)}}):Im(t,e);return}if(e.action==="updateAttrs"){const i=e.data,s={};let o="",l="",r="",d="",c="";Object.keys(i.new).forEach(g=>{s[g]=i.new[g];const p=Lute.EscapeHTMLStr(i.new[g]);g==="bookmark"?o=`<div class="protyle-attr--bookmark">${p}</div>`:g==="name"?l=`<div class="protyle-attr--name"><svg><use xlink:href="#iconN"></use></svg>${p}</div>`:g==="alias"?r=`<div class="protyle-attr--alias"><svg><use xlink:href="#iconA"></use></svg>${p}</div>`:g==="memo"?d=`<div class="protyle-attr--memo b3-tooltips b3-tooltips__sw" aria-label="${p}"><svg><use xlink:href="#iconM"></use></svg></div>`:g==="custom-avs"&&i.new["av-names"]&&(c=`<div class="protyle-attr--av"><svg><use xlink:href="#iconDatabase"></use></svg>${i.new["av-names"]}</div>`)});let f=o+l+r+d+c;if(t.block.rootID===e.id){if(t.title){i.new["custom-avs"]&&!i.new["av-names"]&&(f+=t.title.element.querySelector(".protyle-attr--av")?.outerHTML||"");const g=t.title.element.querySelector(".protyle-attr--refcount");g&&(f+=g.outerHTML),i.new[u.CUSTOM_RIFF_DECKS]&&i.new[u.CUSTOM_RIFF_DECKS]!==i.old[u.CUSTOM_RIFF_DECKS]?(t.title.element.style.animation="addCard 450ms linear",t.title.element.setAttribute(u.CUSTOM_RIFF_DECKS,i.new[u.CUSTOM_RIFF_DECKS]),setTimeout(()=>{t.title.element.style.animation=""},450)):i.new[u.CUSTOM_RIFF_DECKS]||t.title.element.removeAttribute(u.CUSTOM_RIFF_DECKS),t.title.element.querySelector(".protyle-attr").innerHTML=f}if(t.wysiwyg.renderCustom(s),i.new[u.CUSTOM_SY_FULLWIDTH]!==i.old[u.CUSTOM_SY_FULLWIDTH]&&Jt(t),i.new[u.CUSTOM_SY_READONLY]!==i.old[u.CUSTOM_SY_READONLY]){let g=i.new[u.CUSTOM_SY_READONLY];g||(g=window.siyuan.config.editor.readOnly?"true":"false"),g==="true"?Zn(t):sp(t)}i.new.icon!==i.old.icon&&t.background&&t.background.ial.icon!==i.new.icon&&(t.background.ial.icon=i.new.icon,t.background.render(t.background.ial,t.block.rootID),t.model?.parent.setDocIcon(i.new.icon));return}t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`).forEach(g=>{if(g.getAttribute("data-type")==="NodeThematicBreak")return;Object.keys(i.old).forEach(h=>{g.removeAttribute(h)}),i.new.style&&i.new[u.CUSTOM_RIFF_DECKS]&&i.new[u.CUSTOM_RIFF_DECKS]!==i.old[u.CUSTOM_RIFF_DECKS]&&(i.new.style+=";animation:addCard 450ms linear"),Object.keys(i.new).forEach(h=>{g.setAttribute(h,i.new[h]),h===u.CUSTOM_RIFF_DECKS&&i.new[u.CUSTOM_RIFF_DECKS]!==i.old[u.CUSTOM_RIFF_DECKS]&&(g.style.animation="addCard 450ms linear",setTimeout(()=>{g.parentElement?g.style.animation="":t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`).forEach(m=>{m.style.animation=""})},450))}),i.new["custom-avs"]&&!i.new["av-names"]&&(f+=g.lastElementChild.querySelector(".protyle-attr--av")?.outerHTML||"");const p=g.lastElementChild.querySelector(".protyle-attr--refcount");p&&(f+=p.outerHTML),g.lastElementChild.innerHTML=f+u.ZWSP});return}if(e.action==="move"){let i;n&&getSelection().rangeCount>0&&(i=getSelection().getRangeAt(0),i.insertNode(document.createElement("wbr"))),a.length===0&&Ce().editor.forEach(o=>{const l=o.editor.protyle.wysiwyg.element.querySelector(`[data-node-id="${e.id}"]`);l&&a.push(l.cloneNode(!0))}),a.length===0&&window.siyuan.blockPanels.forEach(o=>{const l=o.element.querySelector(`[data-node-id="${e.id}"]`);l&&a.push(l.cloneNode(!0))});let s=!1;e.previousID&&a.length>0?Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.previousID}"]`)).forEach(o=>{F(o)||(o.after(Xa(a[0].cloneNode(!0))),s=!0)}):a.length>0&&(!t.options.backlinkData&&e.parentID===t.block.parentID?(t.wysiwyg.element.prepend(Xa(a[0].cloneNode(!0))),s=!0):Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.parentID}"]`)).forEach(o=>{F(o)||(o.firstElementChild?.classList.contains("protyle-action")?o.firstElementChild.after(Xa(a[0].cloneNode(!0))):o.prepend(Xa(a[0].cloneNode(!0))),s=!0)})),a.forEach(o=>{s?o.remove():!s&&o.parentElement&&pv(o,t)}),n&&i&&(e.data==="focus"?(Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`)).find(o=>{if(!F(o))return ae(o),!0}),document.querySelector("wbr")?.remove()):he(t.wysiwyg.element,i)),t.wysiwyg.element.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(o=>{o.querySelector(`[data-node-id="${e.id}"],[data-node-id="${e.parentID}"],[data-node-id="${e.previousID}"]`)&&(o.removeAttribute("data-render"),Be(t,o))});return}if(e.action==="insert"){const i=[];if(e.previousID?Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.previousID}"]`)).forEach(s=>{const o=F(s);o?(o.removeAttribute("data-render"),Be(t,o)):(s.insertAdjacentHTML("afterend",e.data),i.push(s.nextElementSibling))}):e.nextID?Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.nextID}"]`)).forEach(s=>{const o=F(s);o?(o.removeAttribute("data-render"),Be(t,o)):(s.insertAdjacentHTML("beforebegin",e.data),i.push(s.previousElementSibling))}):!t.options.backlinkData&&e.parentID===t.block.parentID?(t.wysiwyg.element.insertAdjacentHTML("afterbegin",e.data),i.push(t.wysiwyg.element.firstElementChild)):Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.parentID}"]`)).forEach(s=>{F(s)||(s.firstElementChild?.classList.contains("protyle-action")?(s.firstElementChild.insertAdjacentHTML("afterend",e.data),i.push(s.firstElementChild.nextElementSibling)):(s.insertAdjacentHTML("afterbegin",e.data),i.push(s.firstElementChild)))}),t.wysiwyg.element.querySelectorAll('[data-type="NodeHeading"]').forEach(s=>{s.lastElementChild.getAttribute("spin")==="1"&&s.lastElementChild.remove()}),i.length===0)return;i.forEach(s=>{yt(s),ze(s),dt(s,t),Be(t,s);const o=s.querySelector("wbr");if(n){const l=me(s);o?he(s,l):ae(s)}else o&&o.remove()});return}if(e.action==="append"){t.options.backlinkData||ei(t,!1);return}if(["addAttrViewCol","insertAttrViewBlock","updateAttrViewCol","updateAttrViewColOptions","updateAttrViewColOption","updateAttrViewCell","sortAttrViewRow","sortAttrViewCol","setAttrViewColHidden","setAttrViewColWrap","setAttrViewColWidth","removeAttrViewColOption","setAttrViewName","setAttrViewFilters","setAttrViewSorts","setAttrViewColCalc","removeAttrViewCol","updateAttrViewColNumberFormat","removeAttrViewBlock","replaceAttrViewBlock","updateAttrViewColTemplate","setAttrViewColPin","addAttrViewView","setAttrViewColIcon","removeAttrViewView","setAttrViewViewName","setAttrViewViewIcon","duplicateAttrViewView","sortAttrViewView","updateAttrViewColRelation","setAttrViewPageSize","updateAttrViewColRollup","sortAttrViewKey","duplicateAttrViewKey","setAttrViewViewDesc","setAttrViewColDesc"].includes(e.action)){n?e.action==="setAttrViewName"&&Array.from(t.wysiwyg.element.querySelectorAll(`[data-av-id="${e.id}"]`)).forEach(i=>{const s=i.querySelector(".av__title");s&&(s.textContent=e.data,s.dataset.title=e.data)}):Mx(t,e);return}if(e.action==="doUpdateUpdated"){a.forEach(i=>{i.setAttribute("updated",e.data)});return}},Dn=t=>{let e;const n=Lute.NewNodeID();if(t.type==="BlocksMergeSuperBlock")e=T_(t.level,n);else if(t.type==="Blocks2Blockquote")e=document.createElement("div"),e.classList.add("bq"),e.setAttribute("data-node-id",n),e.setAttribute("data-type","NodeBlockquote"),e.innerHTML='<div class="protyle-attr" contenteditable="false"></div>';else if(t.type.endsWith("Ls")){e=document.createElement("div"),e.classList.add("list"),e.setAttribute("data-node-id",n),e.setAttribute("data-type","NodeList"),t.type==="Blocks2ULs"?e.setAttribute("data-subtype","u"):t.type==="Blocks2OLs"?e.setAttribute("data-subtype","o"):e.setAttribute("data-subtype","t");let r="";t.selectsElement.forEach((d,c)=>{t.type==="Blocks2ULs"?r+=`<div data-marker="*" data-subtype="u" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div class="protyle-action" draggable="true"><svg><use xlink:href="#iconDot"></use></svg></div><div class="protyle-attr" contenteditable="false"></div></div>`:t.type==="Blocks2OLs"?r+=`<div data-marker="${c+1}." data-subtype="o" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div class="protyle-action protyle-action--order" contenteditable="false" draggable="true">${c+1}.</div><div class="protyle-attr" contenteditable="false"></div></div>`:r+=`<div data-marker="*" data-subtype="t" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#iconUncheck"></use></svg></div><div class="protyle-attr" contenteditable="false"></div></div>`}),e.innerHTML=r+'<div class="protyle-attr" contenteditable="false"></div>'}const a=t.selectsElement[0].getAttribute("data-node-id"),i=t.selectsElement[0].parentElement.getAttribute("data-node-id")||t.protyle.block.parentID,s=[{action:"insert",id:n,data:e.outerHTML,nextID:a,parentID:i}],o=[];t.selectsElement[0].previousElementSibling?t.selectsElement[0].before(e):t.selectsElement[0].parentElement.prepend(e);let l;t.selectsElement.forEach((r,d)=>{r.classList.remove("protyle-wysiwyg--select"),r.removeAttribute("select-start"),r.removeAttribute("select-end");const c=r.getAttribute("data-node-id");o.push({action:"move",id:c,previousID:l||n,parentID:i}),t.type.endsWith("Ls")?(s.push({action:"move",id:c,parentID:e.children[d].getAttribute("data-node-id")}),e.children[d].firstElementChild.after(r)):(s.push({action:"move",id:c,previousID:l,parentID:n}),e.lastElementChild.before(r)),l=r.getAttribute("data-node-id"),d===t.selectsElement.length-1&&o.push({action:"delete",id:n}),r.getAttribute("data-type")==="NodeBlockQueryEmbed"&&(r.removeAttribute("data-render"),Be(t.protyle,r))}),U(t.protyle,s,o),ae(t.protyle.wysiwyg.element.querySelector(`[data-node-id="${t.selectsElement[0].getAttribute("data-node-id")}"]`)),Q(["gutter"],t.protyle)},bv=(t,e)=>{const n=document.createElement("template");n.innerHTML=t,Array.from(n.content.children).forEach(a=>{e.wysiwyg.element.querySelector(`:scope > [data-node-id="${a.getAttribute("data-node-id")}"]`)?.remove()})},Ba=t=>{let e=t.selectsElement,n;if(t.nodeElement){n=getSelection().getRangeAt(0),n.insertNode(document.createElement("wbr")),e=Array.from(t.protyle.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select")),e.length===0&&(e=[t.nodeElement]);let l=!1,r=!1,d=!1;if(e.find((c,f)=>{if(c.classList.contains("li"))return d=!0,!0;if((c.classList.contains("bq")||c.classList.contains("sb")||c.classList.contains("p"))&&(r=!0),c.nextElementSibling&&e[f+1]&&c.nextElementSibling.isSameNode(e[f+1]))l=!0;else if(f!==e.length-1)return l=!1,!0}),d||r&&t.type==="Blocks2Ps")return;e.length===1&&t.type==="Blocks2Hs"&&e[0].getAttribute("data-type")==="NodeHeading"&&t.level===parseInt(e[0].getAttribute("data-subtype").substr(1))&&(t.type="Blocks2Ps"),t.isContinue=l}let a="";const i=[],s=[],o=document.createElement("div");e.forEach((l,r)=>{(t.type==="Blocks2Ps"||t.type==="Blocks2Hs")&&l.getAttribute("data-type")==="NodeHeading"&&l.getAttribute("fold")==="1"&&an(t.protyle,l,void 0,void 0,!1),l.classList.remove("protyle-wysiwyg--select"),l.removeAttribute("select-start"),l.removeAttribute("select-end"),a+=l.outerHTML;const d=l.getAttribute("data-node-id");s.push({action:"update",id:d,data:l.outerHTML,parentID:l.parentElement?.getAttribute("data-node-id")||t.protyle.block.parentID||t.protyle.block.rootID,previousID:s[s.length-1]?.id||l.previousElementSibling?.getAttribute("data-node-id")}),t.isContinue?r===e.length-1?(o.innerHTML=t.protyle.lute[t.type](a,t.level),l.outerHTML=o.innerHTML):l.remove():l.outerHTML=t.protyle.lute[t.type](l.outerHTML,t.level)}),s.forEach(l=>{const r=t.protyle.wysiwyg.element.querySelector(`[data-node-id="${l.id}"]`);r?i.push({action:"update",id:l.id,data:r.outerHTML}):(l.action="insert",i.push({action:"delete",id:l.id}))}),Array.from(o.children).forEach(l=>{const r=l.getAttribute("data-node-id");let d=!1;s.find(c=>{if(r===c.id)return d=!0,!0}),d||(i.push({action:"insert",id:r,previousID:l.previousElementSibling?.getAttribute("data-node-id")||s[0].previousID,data:l.outerHTML,parentID:l.parentElement?.getAttribute("data-node-id")||t.protyle.block.parentID||t.protyle.block.rootID}),s.splice(0,0,{action:"delete",id:r}))}),U(t.protyle,i,s),yt(t.protyle.wysiwyg.element),ze(t.protyle.wysiwyg.element),dt(t.protyle.wysiwyg.element,t.protyle),Be(t.protyle,t.protyle.wysiwyg.element),n||t.range?he(t.protyle.wysiwyg.element,n||t.range):ae(t.protyle.wysiwyg.element.querySelector(`[data-node-id="${e[0].getAttribute("data-node-id")}"]`)),Q(["gutter"],t.protyle)},Hl=async t=>{if(t.nodeElement.querySelector("wbr")||le(t.nodeElement)?.insertAdjacentHTML("afterbegin","<wbr>"),t.type==="CancelList"||t.type==="CancelBlockquote")for await(const s of t.nodeElement.querySelectorAll('[data-type="NodeHeading"][fold="1"]')){const o=s.getAttribute("data-node-id");s.removeAttribute("fold");const l=await Re("/api/transactions",{session:t.protyle.id,app:u.SIYUAN_APPID,transactions:[{doOperations:[{action:"unfoldHeading",id:o}],undoOperations:[{action:"foldHeading",id:o}]}]});t.protyle.undo.add([{action:"unfoldHeading",id:o}],[{action:"foldHeading",id:o}],t.protyle),s.insertAdjacentHTML("afterend",l.data[0].doOperations[0].retData)}const e=t.nodeElement.outerHTML,n=t.nodeElement.previousElementSibling?.getAttribute("data-node-id"),a=t.nodeElement.parentElement.getAttribute("data-node-id")||t.protyle.block.parentID,i=t.protyle.lute[t.type](t.nodeElement.outerHTML,t.level);if(t.nodeElement.outerHTML=i,t.type==="CancelList"||t.type==="CancelBlockquote"){const s=document.createElement("template");s.innerHTML=i;const o=[{action:"delete",id:t.id}],l=[];let r=n;Array.from(s.content.children).forEach(d=>{const c=d.getAttribute("data-node-id");o.push({action:"insert",data:d.outerHTML,id:c,previousID:r,parentID:a}),l.push({action:"delete",id:c}),r=c}),l.push({action:"insert",data:e,id:t.id,previousID:n,parentID:a}),U(t.protyle,o,l)}else J(t.protyle,t.id,i,e);he(t.protyle.wysiwyg.element,me(t.protyle.wysiwyg.element)),t.protyle.wysiwyg.element.querySelectorAll('[data-type~="block-ref"]').forEach(s=>{s.textContent===""&&E("/api/block/getRefText",{id:s.getAttribute("data-id")},o=>{s.innerHTML=o.data})}),Be(t.protyle,t.protyle.wysiwyg.element),yt(t.protyle.wysiwyg.element),ze(t.protyle.wysiwyg.element),dt(t.protyle.wysiwyg.element,t.protyle)};let yv;const U=(t,e,n)=>{if(e.length===0)return;if(!t){E("/api/transactions",{session:u.SIYUAN_APPID,app:u.SIYUAN_APPID,transactions:[{doOperations:e}]});return}const a=window.siyuan.transactions[window.siyuan.transactions.length-1];let i=!1;const s=new Date().getTime();if(a&&a.doOperations.length===1&&a.doOperations[0].action==="update"&&e.length===1&&e[0].action==="update"&&a.doOperations[0].id===e[0].id&&t.transactionTime-s<u.TIMEOUT_INPUT&&(i=!0),n&&(window.siyuan.config.fileTree.openFilesUseCurrentTab&&t.model&&t.model.headElement.classList.remove("item--unupdate"),t.updated=!0,i?t.undo.replace(e,t):t.undo.add(e,n,t)),window.clearTimeout(yv),e.length===1&&(e[0].action==="unfoldHeading"||e[0].action==="setAttrs"&&e[0].data.startsWith('{"fold":'))){t.transactionTime=s+u.TIMEOUT_INPUT*2,E("/api/transactions",{session:t.id,app:u.SIYUAN_APPID,transactions:[{doOperations:e,undoOperations:n}]},o=>{o.data[0].doOperations.forEach(l=>{if(l.action==="unfoldHeading"||l.action==="foldHeading")wv(l,t);else if(l.action==="setAttrs"){const r=t.gutter.element.querySelector('[data-type="fold"]');r&&r.removeAttribute("disabled"),t.wysiwyg.element.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(d=>{d.querySelector(`[data-node-id="${l.id}"]`)&&(d.removeAttribute("data-render"),Be(t,d))})}})});return}i?(window.siyuan.transactions[window.siyuan.transactions.length-1].protyle=t,window.siyuan.transactions[window.siyuan.transactions.length-1].doOperations=e):window.siyuan.transactions.push({protyle:t,doOperations:e,undoOperations:n}),t.transactionTime=s,yv=window.setTimeout(()=>{gv()},u.TIMEOUT_INPUT*2),e.find(o=>{if(o.action==="insert")return t.observerLoad?.disconnect(),!0})},wv=(t,e)=>{if(t.action==="unfoldHeading"||t.action==="foldHeading"){const n=e.gutter.element.querySelector('[data-type="fold"]');if(n&&n.removeAttribute("disabled"),t.action==="unfoldHeading"){const a=e.contentElement.scrollTop;e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.id}"]`).forEach(i=>{const s=F(i);if(s){s.removeAttribute("data-render"),Be(e,s);return}if(i.lastElementChild.classList.contains("protyle-attr")||i.lastElementChild.remove(),bv(t.retData,e),i.insertAdjacentHTML("afterend",t.retData),t.data==="remove"){const o=getSelection();o.rangeCount>0&&i.contains(o.getRangeAt(0).startContainer)&&ae(i.nextElementSibling,void 0,!0),i.remove()}}),e.disabled&&Zn(e),yt(e.wysiwyg.element),ze(e.wysiwyg.element),dt(e.wysiwyg.element,e),Be(e,e.wysiwyg.element),e.contentElement.scrollTop=a,e.scroll.lastScrollTop=a;return}e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.id}"]`).forEach(a=>{const i=F(a);i&&(i.removeAttribute("data-render"),Be(e,i))}),e.wysiwyg.element.lastElementChild.getAttribute("data-eof")!=="2"&&!e.scroll.element.classList.contains("fn__none")&&e.contentElement.scrollHeight-e.contentElement.scrollTop<e.contentElement.clientHeight*2&&E("/api/filetree/getDoc",{id:e.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),mode:2,size:window.siyuan.config.editor.dynamicLoadBlocks},a=>{rt({data:a,protyle:e,action:[u.CB_GET_APPEND,u.CB_GET_UNCHANGEID]})});return}},J=(t,e,n,a)=>{n!==a&&U(t,[{id:e,data:n,action:"update"}],[{id:e,data:a,action:"update"}])},ds=(t,e,n)=>{const a=[],i=[];t.forEach(s=>{const o=s.getAttribute("data-node-id");s.classList.remove("protyle-wysiwyg--select"),s.removeAttribute("select-start"),s.removeAttribute("select-end"),i.push({action:"update",id:o,data:s.outerHTML}),n(s),a.push({action:"update",id:o,data:s.outerHTML})}),U(e,a,i)};class us extends Vn{constructor(e){super({app:e.app,id:e.tab.id,callback(){this.type==="local"&&E("/api/block/checkBlockExist",{id:this.blockId},n=>{n.data||this.parent.parent.removeTab(this.parent.id)})},msgCallback(n){if(n)switch(n.cmd){case"savedoc":this.onTransaction(n);break;case"rename":this.type==="local"&&this.blockId===n.data.id?this.parent.updateTitle(n.data.title):this.updateDocTitle({title:n.data.title,icon:u.ZWSP});break;case"unmount":this.type==="local"&&E("/api/block/checkBlockExist",{id:this.blockId},a=>{a.data||this.parent.parent.removeTab(this.parent.id)});break;case"removeDoc":n.data.ids.includes(this.blockId)&&this.type==="local"&&this.parent.parent.removeTab(this.parent.id);break}}}),this.openNodes={},this.isPreview=e.isPreview,this.blockId=e.blockId,this.type=e.type,e.tab.panelElement.classList.add("fn__flex-column","file-tree","sy__outline"),e.tab.panelElement.innerHTML=`<div class="block__icons">
    <div class="block__logo">
        <svg class="block__logoicon"><use xlink:href="#iconAlignCenter"></use></svg>${window.siyuan.languages.outline}
    </div>
    <span class="fn__flex-1 fn__space"></span>
    <span data-type="expand" class="block__icon b3-tooltips b3-tooltips__sw${window.siyuan.storage[u.LOCAL_OUTLINE].keepExpand?" block__icon--active":""}" aria-label="${window.siyuan.languages.stickOpen} ${X(window.siyuan.config.keymap.editor.general.expand.custom)}">
        <svg><use xlink:href="#iconExpand"></use></svg>
    </span>
    <span class="fn__space"></span>
    <span data-type="collapse" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.collapse} ${X(window.siyuan.config.keymap.editor.general.collapse.custom)}">
        <svg><use xlink:href="#iconContract"></use></svg>
    </span>
    <span class="${this.type==="local"?"fn__none ":""}fn__space"></span>
    <span data-type="min" class="${this.type==="local"?"fn__none ":""}block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.min} ${X(window.siyuan.config.keymap.general.closeTab.custom)}"><svg><use xlink:href='#iconMin'></use></svg></span>
</div>
<div class="b3-list-item fn__none"></div>
<div class="fn__flex-1" style="padding: 3px 0 8px"></div>`,this.element=e.tab.panelElement.lastElementChild,this.headerElement=e.tab.panelElement.firstElementChild,this.tree=new ec({element:e.tab.panelElement.lastElementChild,data:null,click:n=>{const a=n.getAttribute("data-node-id");if(this.isPreview){const i=document.getElementById(a);if(i){const s=Le(i,"protyle");if(s){const o=Bt(s.getAttribute("data-id"));o.parent.switchTab(o.headElement)}i.scrollIntoView()}else de({app:e.app,id:this.blockId,mode:"preview"})}else Ke(a,i=>{de({app:e.app,id:a,action:i?[u.CB_GET_FOCUS,u.CB_GET_ALL,u.CB_GET_HTML]:[u.CB_GET_FOCUS,u.CB_GET_SETID,u.CB_GET_CONTEXT,u.CB_GET_HTML]})})},ctrlClick(n){const a=n.getAttribute("data-node-id");de({app:e.app,id:a,action:[u.CB_GET_FOCUS,u.CB_GET_ALL,u.CB_GET_HTML],zoomIn:!0})}}),e.tab.panelElement.querySelector('[data-type="collapse"]').addEventListener("click",()=>{this.tree.collapseAll()}),e.tab.panelElement.querySelector('[data-type="expand"]').addEventListener("click",n=>{const a=L(n.target,"block__icon");a&&(a.classList.contains("block__icon--active")?(a.classList.remove("block__icon--active"),window.siyuan.storage[u.LOCAL_OUTLINE].keepExpand=!1):(a.classList.add("block__icon--active"),window.siyuan.storage[u.LOCAL_OUTLINE].keepExpand=!0,this.tree.expandAll()),ue(u.LOCAL_OUTLINE,window.siyuan.storage[u.LOCAL_OUTLINE]))}),e.tab.panelElement.addEventListener("click",n=>{let a=n.target,i=!0;for(;a&&!a.isEqualNode(e.tab.panelElement);){if(a.classList.contains("block__icon")){switch(a.getAttribute("data-type")){case"min":Qe("outline").toggleModel("outline",!1,!0);break}break}else if(this.blockId&&(a.isSameNode(this.headerElement.nextElementSibling)||a.classList.contains("block__icons"))){de({app:e.app,id:this.blockId,afterOpen:s=>{s&&(this.isPreview?s.editor.protyle.preview.element.querySelector(".b3-typography").scrollTop=0:sm(s.editor.protyle))}}),i=!1;break}a=a.parentElement}i&&(this.type==="local"?tt(e.tab.panelElement.parentElement.parentElement):tt(e.tab.panelElement))}),this.bindSort(),E("/api/outline/getDocOutline",{id:this.blockId,preview:this.isPreview},n=>{this.update(n)})}bindSort(){this.element.addEventListener("mousedown",e=>{const n=L(e.target,"b3-list-item");if(!n||n.tagName!=="LI"||this.element.getAttribute("data-loading")==="true")return;const a=document;a.ondragstart=()=>!1;let i,s,o;Ce().editor.find(r=>{if(r.editor.protyle.block.rootID===this.blockId)return o=r.editor.protyle,!0});const l=this.element.getBoundingClientRect();a.onmousemove=r=>{if(!o||o.disabled||Math.abs(r.clientY-e.clientY)<3&&Math.abs(r.clientX-e.clientX)<3)return;if(r.preventDefault(),r.stopPropagation(),i||(n.style.opacity="0.38",i=n.cloneNode(!0),this.element.append(i),i.setAttribute("id","dragGhost"),i.firstElementChild.setAttribute("style","padding-left:4px"),i.setAttribute("style",`border-radius: var(--b3-border-radius);background-color: var(--b3-list-hover);position: fixed; top: ${e.clientY}px; left: ${e.clientX}px; z-index:999997;`)),i.style.top=r.clientY+"px",i.style.left=r.clientX+"px",!this.element.contains(r.target)){this.element.querySelectorAll(".dragover__top, .dragover__bottom, .dragover, .dragover__current").forEach(f=>{f.classList.remove("dragover__top","dragover__bottom","dragover","dragover__current")});return}if((r.clientY<l.top+u.SIZE_SCROLL_TB||r.clientY>l.bottom-u.SIZE_SCROLL_TB)&&this.element.scroll({top:this.element.scrollTop+(r.clientY<l.top+u.SIZE_SCROLL_TB?-u.SIZE_SCROLL_STEP:u.SIZE_SCROLL_STEP),behavior:"smooth"}),s=L(r.target,"b3-list-item"),!s||s.tagName!=="LI"||s.style.position==="fixed")return;if(this.element.querySelectorAll(".dragover__top, .dragover__bottom, .dragover, .dragover__current").forEach(f=>{f.classList.remove("dragover__top","dragover__bottom","dragover","dragover__current")}),s.isSameNode(n)){s.classList.add("dragover__current");return}const d=s.getBoundingClientRect(),c=d.height*.2;r.clientY>d.bottom-c?s.classList.add("dragover__bottom"):r.clientY<d.top+c?s.classList.add("dragover__top"):s.classList.add("dragover")},a.onmouseup=()=>{a.onmousemove=null,a.onmouseup=null,a.ondragstart=null,a.onselectstart=null,a.onselect=null,i?.remove(),n.style.opacity="",s||(s=this.element.querySelector(".dragover__top, .dragover__bottom, .dragover"));let r=!0;if(s&&o&&(s.classList.contains("dragover__top")||s.classList.contains("dragover__bottom")||s.classList.contains("dragover"))){let d,c;const f=n.previousElementSibling&&n.previousElementSibling.tagName==="UL"?n.previousElementSibling.previousElementSibling.getAttribute("data-node-id"):n.previousElementSibling?.getAttribute("data-node-id"),g=n.parentElement.previousElementSibling?.getAttribute("data-node-id");if(s.classList.contains("dragover")?(c=s.getAttribute("data-node-id"),s.nextElementSibling&&s.nextElementSibling.tagName==="UL"?s.nextElementSibling.insertAdjacentElement("afterbegin",n):(s.insertAdjacentHTML("afterend",`<ul>${n.outerHTML}</ul>`),n.remove())):s.classList.contains("dragover__top")?(c=s.parentElement.previousElementSibling?.getAttribute("data-node-id"),s.previousElementSibling&&s.previousElementSibling.tagName==="UL"?d=s.previousElementSibling.previousElementSibling.getAttribute("data-node-id"):d=s.previousElementSibling?.getAttribute("data-node-id"),d===n.dataset.nodeId||c===n.dataset.nodeId?r=!1:s.before(n)):s.classList.contains("dragover__bottom")&&(d=s.getAttribute("data-node-id"),d===n.previousElementSibling?.getAttribute("data-node-id")?r=!1:s.after(n)),r)return this.element.setAttribute("data-loading","true"),U(o,[{action:"moveOutlineHeading",id:n.dataset.nodeId,previousID:d,parentID:c}],[{action:"moveOutlineHeading",id:n.dataset.nodeId,previousID:f,parentID:g}]),o.wysiwyg.element.querySelectorAll('[data-type="NodeHeading"] [contenteditable="true"][spellcheck]').forEach(p=>{p.setAttribute("contenteditable","false")}),!0}this.element.querySelectorAll(".dragover__top, .dragover__bottom, .dragover, .dragover__current").forEach(d=>{d.classList.remove("dragover__top","dragover__bottom","dragover","dragover__current")})}})}updateDocTitle(e){const n=this.headerElement.nextElementSibling;if(this.type==="pin")if(e){let a=`${ge(e.icon||window.siyuan.storage[u.LOCAL_IMAGES].file,"b3-list-item__graphic",!0)}`;e.icon===u.ZWSP&&n.firstElementChild&&(a=n.firstElementChild.outerHTML),n.innerHTML=`${a}
<span class="b3-list-item__text">${pe(e.title)}</span>`,n.setAttribute("title",e.title),n.classList.remove("fn__none")}else n.classList.add("fn__none");else n.classList.add("fn__none")}onTransaction(e){if(e.data.rootID!==this.blockId)return;let n=!1;const a=e.data.sources[0];a.doOperations.find(i=>{if(i.action==="update"&&(this.element.querySelector(`.b3-list-item[data-node-id="${i.id}"]`)||i.data.indexOf('data-type="NodeHeading"')>-1))return n=!0,!0;if(i.action==="insert"&&i.data.indexOf('data-type="NodeHeading"')>-1)return n=!0,!0;if(i.action==="delete"||i.action==="move")return n=!0,!0}),!n&&a.undoOperations&&a.undoOperations.find(i=>{if(i.action==="update"&&i.data.indexOf('data-type="NodeHeading"')>-1)return n=!0,!0}),n&&E("/api/outline/getDocOutline",{id:this.blockId,preview:this.isPreview},i=>{if(e.data.rootID===this.blockId&&(this.update(i),getSelection().rangeCount>0)){const s=P(getSelection().getRangeAt(0).startContainer);s&&s.getAttribute("data-type")==="NodeHeading"&&this.setCurrent(s)}})}setCurrent(e){if(e)if(e.getAttribute("data-type")==="NodeHeading")this.setCurrentById(e.getAttribute("data-node-id"));else{let n=Pe(e);for(;n&&n.getAttribute("data-type")!=="NodeHeading";)n=Pe(n);n?this.setCurrentById(n.getAttribute("data-node-id")):E("/api/block/getBlockBreadcrumb",{id:e.getAttribute("data-node-id"),excludeTypes:[]},a=>{a.data.reverse().find(i=>{if(i.type==="NodeHeading")return this.setCurrentById(i.id),!0})})}}setCurrentByPreview(e){if(!e)return;let n=e;for(;n&&!n.classList.contains("b3-typography")&&!["H1","H2","H3","H4","H5","H6"].includes(n.tagName);)n=n.previousElementSibling||n.parentElement;n&&n.id&&this.setCurrentById(n.id)}setCurrentById(e){this.element.querySelectorAll(".b3-list-item.b3-list-item--focus").forEach(a=>{a.classList.remove("b3-list-item--focus")});let n=this.element.querySelector(`.b3-list-item[data-node-id="${e}"]`);for(;n&&n.clientHeight===0;)n=n.parentElement.previousElementSibling;n&&(n.classList.add("b3-list-item--focus"),this.element.scrollTop=n.offsetTop-this.element.clientHeight/2-30)}update(e,n){let a=this.element.querySelector(".b3-list-item--focus"),i;a&&(i=a.getAttribute("data-node-id")),!this.isPreview&&this.openNodes[this.blockId]&&(this.openNodes[this.blockId]=this.tree.getExpandIds()),typeof n<"u"&&(this.blockId=n),this.tree.updateData(e.data),!this.isPreview&&this.openNodes[this.blockId]&&!this.headerElement.querySelector('[data-type="expand"]').classList.contains("block__icon--active")?this.tree.setExpandIds(this.openNodes[this.blockId]):(this.tree.expandAll(),this.isPreview||(this.openNodes[this.blockId]=this.tree.getExpandIds())),this.isPreview&&this.tree.element.querySelectorAll(".popover__block").forEach(s=>{s.classList.remove("popover__block")}),i&&(a=this.element.querySelector(`[data-node-id="${i}"]`),a&&a.classList.add("b3-list-item--focus")),this.element.removeAttribute("data-loading")}}class fs extends Vn{constructor(e){super({app:e.app,id:e.tab.id,callback(){this.type==="local"&&E("/api/block/checkBlockExist",{id:this.blockId},n=>{n.data||this.parent.parent.removeTab(this.parent.id)})},msgCallback(n){if(n&&this.type==="local")switch(n.cmd){case"rename":this.rootId===n.data.id&&this.parent.updateTitle(n.data.title);break;case"unmount":this.notebookId===n.data.box&&this.type==="local"&&this.parent.parent.removeTab(this.parent.id);break;case"removeDoc":n.data.ids.includes(this.rootId)&&this.type==="local"&&this.parent.parent.removeTab(this.parent.id);break}}}),this.editors=[],this.status={},this.blockId=e.blockId,this.rootId=e.rootId,this.type=e.type,this.element=e.tab.panelElement,this.element.classList.add("fn__flex-column","file-tree","sy__backlink"),this.element.innerHTML=`<div class="block__icons">
    <div class="block__logo">
        <svg class="block__logoicon"><use xlink:href="#iconLink"></use></svg>${window.siyuan.languages.backlinks}
    </div>
    <span class="counter listCount" style="margin-left: 0"></span>
    <span class="fn__flex-1"></span>
    <span class="fn__space"></span>
    <input class="b3-text-field search__label fn__none fn__size200" placeholder="${window.siyuan.languages.filterKeywordEnter}" />
    <span data-type="search" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.filter}"><svg><use xlink:href='#iconFilter'></use></svg></span>
    <span class="fn__space"></span>
    <span data-type="refresh" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.refresh}"><svg><use xlink:href='#iconRefresh'></use></svg></span>
    <span class="fn__space"></span>
    <span data-type="sort" data-sort="3" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.sort}"><svg><use xlink:href='#iconSort'></use></svg></span>
    <span class="fn__space"></span>
    <span data-type="expand" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.expand} ${X(window.siyuan.config.keymap.editor.general.expand.custom)}">
        <svg><use xlink:href="#iconExpand"></use></svg>
    </span>
    <span class="fn__space"></span>
    <span data-type="collapse" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.collapse} ${X(window.siyuan.config.keymap.editor.general.collapse.custom)}">
        <svg><use xlink:href="#iconContract"></use></svg>
    </span>
    <span class="${this.type==="local"?"fn__none ":""}fn__space"></span>
    <span data-type="min" class="${this.type==="local"?"fn__none ":""}block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.min} ${X(window.siyuan.config.keymap.general.closeTab.custom)}"><svg><use xlink:href='#iconMin'></use></svg></span>
</div>
<div class="backlinkList fn__flex-1"></div>
<div class="block__icons">
    <div class="block__logo">
        <svg class="block__logoicon"><use xlink:href="#iconLink"></use></svg>${window.siyuan.languages.mentions}
    </div>
    <span class="counter listMCount" style="margin-left: 0;"></span>
    <span class="fn__flex-1"></span>
    <span class="fn__space"></span>
    <input class="b3-text-field search__label fn__none fn__size200" placeholder="${window.siyuan.languages.filterKeywordEnter}" />
    <span data-type="search" class="block__icon b3-tooltips b3-tooltips__nw" aria-label="${window.siyuan.languages.filter}"><svg><use xlink:href='#iconFilter'></use></svg></span>
    <span class="fn__space"></span>
    <span data-type="mSort" data-sort="3" class="block__icon b3-tooltips b3-tooltips__nw" aria-label="${window.siyuan.languages.sort}"><svg><use xlink:href='#iconSort'></use></svg></span>
    <span class="fn__space"></span>
    <span data-type="mExpand" class="block__icon b3-tooltips b3-tooltips__nw" aria-label="${window.siyuan.languages.expand}">
        <svg><use xlink:href="#iconExpand"></use></svg>
    </span>
    <span class="fn__space"></span>
    <span data-type="mCollapse" class="block__icon b3-tooltips b3-tooltips__nw" aria-label="${window.siyuan.languages.collapse}">
        <svg><use xlink:href="#iconContract"></use></svg>
    </span>
    <span class="fn__space"></span>
    <span data-type="layout" class="block__icon b3-tooltips b3-tooltips__nw" aria-label="${window.siyuan.languages.down}">
        <svg><use xlink:href="#iconDown"></use></svg>
    </span>
</div>
<div class="backlinkMList fn__flex-1"></div>`,this.inputsElement=this.element.querySelectorAll("input"),this.inputsElement.forEach(n=>{n.addEventListener("blur",a=>{const i=a.target;i.classList.add("fn__none");const s=i.nextElementSibling;i.value?(s.classList.add("block__icon--active"),s.setAttribute("aria-label",window.siyuan.languages.filter+" "+i.value)):(s.classList.remove("block__icon--active"),s.setAttribute("aria-label",window.siyuan.languages.filter))}),n.addEventListener("keydown",a=>{!a.isComposing&&a.key==="Enter"&&this.searchBacklinks()}),n.addEventListener("input",a=>{const i=a.target;i.value===""?i.classList.remove("search__input--block"):i.classList.add("search__input--block")})}),this.tree=new ec({element:this.element.querySelector(".backlinkList"),data:null,click:n=>{this.toggleItem(n,!1),this.setFocus(),this.mTree.element.querySelector(".b3-list-item--focus")?.classList.remove("b3-list-item--focus")},ctrlClick:n=>{de({app:e.app,id:n.getAttribute("data-node-id"),action:[u.CB_GET_CONTEXT]}),this.mTree.element.querySelector(".b3-list-item--focus")?.classList.remove("b3-list-item--focus")},altClick(n){de({app:e.app,id:n.getAttribute("data-node-id"),position:"right",action:[u.CB_GET_FOCUS,u.CB_GET_CONTEXT]}),this.mTree.element.querySelector(".b3-list-item--focus")?.classList.remove("b3-list-item--focus")},shiftClick(n){de({app:e.app,id:n.getAttribute("data-node-id"),position:"bottom",action:[u.CB_GET_FOCUS,u.CB_GET_CONTEXT]}),this.mTree.element.querySelector(".b3-list-item--focus")?.classList.remove("b3-list-item--focus")},toggleClick:n=>{this.toggleItem(n,!1),this.setFocus(),this.mTree.element.querySelector(".b3-list-item--focus")?.classList.remove("b3-list-item--focus")}}),this.mTree=new ec({element:this.element.querySelector(".backlinkMList"),data:null,click:n=>{this.toggleItem(n,!0),this.setFocus(),this.tree.element.querySelector(".b3-list-item--focus")?.classList.remove("b3-list-item--focus")},ctrlClick(n){de({app:e.app,id:n.getAttribute("data-node-id"),action:[u.CB_GET_CONTEXT]}),this.tree.element.querySelector(".b3-list-item--focus")?.classList.remove("b3-list-item--focus")},altClick(n){de({app:e.app,id:n.getAttribute("data-node-id"),position:"right",action:[u.CB_GET_FOCUS,u.CB_GET_CONTEXT]}),this.tree.element.querySelector(".b3-list-item--focus")?.classList.remove("b3-list-item--focus")},shiftClick(n){de({app:e.app,id:n.getAttribute("data-node-id"),position:"bottom",action:[u.CB_GET_FOCUS,u.CB_GET_CONTEXT]}),this.tree.element.querySelector(".b3-list-item--focus")?.classList.remove("b3-list-item--focus")},toggleClick:n=>{this.toggleItem(n,!0),this.setFocus(),this.tree.element.querySelector(".b3-list-item--focus")?.classList.remove("b3-list-item--focus")},blockExtHTML:`<span class="b3-list-item__action b3-tooltips b3-tooltips__nw" aria-label="${window.siyuan.languages.more}"><svg><use xlink:href="#iconMore"></use></svg></span>`}),this.tree.element.addEventListener("scroll",()=>{this.tree.element.querySelectorAll(".protyle-gutters").forEach(n=>{n.classList.add("fn__none"),n.innerHTML=""}),this.tree.element.querySelectorAll(".protyle-wysiwyg--hl").forEach(n=>{n.classList.remove("protyle-wysiwyg--hl")})}),this.mTree.element.addEventListener("scroll",()=>{this.mTree.element.querySelectorAll(".protyle-gutters").forEach(n=>{n.classList.add("fn__none"),n.innerHTML=""}),this.mTree.element.querySelectorAll(".protyle-wysiwyg--hl").forEach(n=>{n.classList.remove("protyle-wysiwyg--hl")})}),this.element.querySelector('[data-type="collapse"]').addEventListener("click",()=>{this.tree.element.querySelectorAll(".protyle").forEach(n=>{n.classList.add("fn__none")}),this.tree.element.querySelectorAll(".b3-list-item__arrow").forEach(n=>{n.classList.remove("b3-list-item__arrow--open")})}),this.element.querySelector('[data-type="expand"]').addEventListener("click",()=>{Array.from(this.tree.element.firstElementChild.children).forEach(n=>{n.tagName==="LI"&&!n.querySelector(".b3-list-item__arrow--open")&&this.toggleItem(n,!1)})}),this.element.addEventListener("click",n=>{this.setFocus();let a=n.target;for(;a&&!a.isEqualNode(this.element);){if(a.classList.contains("block__icon")&&a.parentElement.parentElement.isSameNode(this.element)){const i=a.getAttribute("data-type");switch(i){case"refresh":this.refresh();break;case"mExpand":Array.from(this.mTree.element.firstElementChild.children).forEach(s=>{s.tagName==="LI"&&!s.querySelector(".b3-list-item__arrow--open")&&this.toggleItem(s,!0)});break;case"mCollapse":this.mTree.element.querySelectorAll(".protyle").forEach(s=>{s.classList.add("fn__none")}),this.mTree.element.querySelectorAll(".b3-list-item__arrow").forEach(s=>{s.classList.remove("b3-list-item__arrow--open")});break;case"min":Qe("backlink").toggleModel("backlink",!1,!0);break;case"search":a.previousElementSibling.classList.remove("fn__none"),a.previousElementSibling.select();break;case"sort":case"mSort":this.showSortMenu(i,a.getAttribute("data-sort")),window.siyuan.menus.menu.popup({x:n.clientX,y:n.clientY}),n.stopPropagation();break;case"layout":this.mTree.element.style.flex?this.mTree.element.style.height==="0px"?(this.tree.element.classList.remove("fn__none"),this.mTree.element.removeAttribute("style"),a.setAttribute("aria-label",window.siyuan.languages.up),a.querySelector("use").setAttribute("xlink:href","#iconUp")):(this.tree.element.classList.remove("fn__none"),this.mTree.element.removeAttribute("style"),a.setAttribute("aria-label",window.siyuan.languages.down),a.querySelector("use").setAttribute("xlink:href","#iconDown")):a.getAttribute("aria-label")===window.siyuan.languages.down?(this.tree.element.classList.remove("fn__none"),this.mTree.element.setAttribute("style","flex:none;height:0px"),a.setAttribute("aria-label",window.siyuan.languages.up),a.querySelector("use").setAttribute("xlink:href","#iconUp")):(this.tree.element.classList.add("fn__none"),this.mTree.element.setAttribute("style",`flex:none;height:${this.element.clientHeight-this.tree.element.previousElementSibling.clientHeight*2}px`),a.setAttribute("aria-label",window.siyuan.languages.down),a.querySelector("use").setAttribute("xlink:href","#iconDown")),this.tree.element.dispatchEvent(new CustomEvent("scroll")),this.mTree.element.dispatchEvent(new CustomEvent("scroll"));break}}a=a.parentElement}}),this.searchBacklinks(!0)}setFocus(){this.type==="local"?tt(this.element.parentElement.parentElement):tt(this.element)}showSortMenu(e,n){const a=i=>{(e==="sort"?this.tree:this.mTree).element.previousElementSibling.querySelector(`[data-type="${e}"]`).setAttribute("data-sort",i),this.searchBacklinks()};window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.append(new T({icon:n==="0"?"iconSelect":void 0,label:window.siyuan.languages.fileNameASC,click:()=>{a("0")}}).element),window.siyuan.menus.menu.append(new T({icon:n==="1"?"iconSelect":void 0,label:window.siyuan.languages.fileNameDESC,click:()=>{a("1")}}).element),window.siyuan.menus.menu.append(new T({icon:n==="4"?"iconSelect":void 0,label:window.siyuan.languages.fileNameNatASC,click:()=>{a("4")}}).element),window.siyuan.menus.menu.append(new T({icon:n==="5"?"iconSelect":void 0,label:window.siyuan.languages.fileNameNatDESC,click:()=>{a("5")}}).element),window.siyuan.menus.menu.append(new T({type:"separator"}).element),window.siyuan.menus.menu.append(new T({icon:n==="9"?"iconSelect":void 0,label:window.siyuan.languages.createdASC,click:()=>{a("9")}}).element),window.siyuan.menus.menu.append(new T({icon:n==="10"?"iconSelect":void 0,label:window.siyuan.languages.createdDESC,click:()=>{a("10")}}).element),window.siyuan.menus.menu.append(new T({icon:n==="2"?"iconSelect":void 0,label:window.siyuan.languages.modifiedASC,click:()=>{a("2")}}).element),window.siyuan.menus.menu.append(new T({icon:n==="3"?"iconSelect":void 0,label:window.siyuan.languages.modifiedDESC,click:()=>{a("3")}}).element)}toggleItem(e,n){const a=e.firstElementChild?.firstElementChild;if(!a||a.getAttribute("disabled"))return;a.setAttribute("disabled","disabled");const i=e.getAttribute("data-node-id");if(a.classList.contains("b3-list-item__arrow--open"))a.classList.remove("b3-list-item__arrow--open"),this.editors.find((s,o)=>{if(s.protyle.block.rootID===i&&e.nextElementSibling&&s.protyle.element.isSameNode(e.nextElementSibling))return s.destroy(),this.editors.splice(o,1),e.nextElementSibling.remove(),!0}),a.removeAttribute("disabled");else{const s=n?this.inputsElement[1].value:this.inputsElement[0].value;E(n?"/api/ref/getBackmentionDoc":"/api/ref/getBacklinkDoc",{defID:this.blockId,refTreeID:i,highlight:!qn(),keyword:s},o=>{a.removeAttribute("disabled"),a.classList.add("b3-list-item__arrow--open");const l=document.createElement("div");l.style.minHeight="auto",l.setAttribute("data-defid",this.blockId),l.setAttribute("data-ismention",n?"true":"false"),e.after(l);const r=new aa(this.app,l,{blockId:i,backlinkData:n?o.data.backmentions:o.data.backlinks,render:{background:!1,gutter:!0,scroll:!1,breadcrumb:!1}});r.protyle.notebookId=e.getAttribute("data-notebook-id"),ac(r.protyle,o.data.keywords),this.editors.push(r)})}}refresh(){const e=this.element.querySelector('.block__icon[data-type="refresh"] svg');!this.blockId||e.classList.contains("fn__rotate")||(e.classList.add("fn__rotate"),E("/api/ref/refreshBacklink",{id:this.blockId},()=>{e.classList.remove("fn__rotate"),this.searchBacklinks()}))}searchBacklinks(e=!1){const n=this.element.querySelector('.block__icon[data-type="refresh"] svg');n.classList.contains("fn__rotate")||(n.classList.add("fn__rotate"),E("/api/ref/getBacklink2",{sort:this.tree.element.previousElementSibling.querySelector('[data-type="sort"]').getAttribute("data-sort"),mSort:this.mTree.element.previousElementSibling.querySelector('[data-type="mSort"]').getAttribute("data-sort"),k:this.inputsElement[0].value,mk:this.inputsElement[1].value,id:this.blockId},a=>{e||this.saveStatus(),this.render(a.data)}))}saveStatus(){this.status[this.blockId]={sort:this.tree.element.previousElementSibling.querySelector('[data-type="sort"]').getAttribute("data-sort"),mSort:this.mTree.element.previousElementSibling.querySelector('[data-type="mSort"]').getAttribute("data-sort"),scrollTop:this.tree.element.scrollTop,mScrollTop:this.mTree.element.scrollTop,backlinkOpenIds:[],backlinkMOpenIds:[],backlinkMStatus:3},this.tree.element.querySelectorAll(".b3-list-item__arrow--open").forEach(e=>{this.status[this.blockId].backlinkOpenIds.push(e.parentElement.parentElement.getAttribute("data-node-id"))}),this.mTree.element.querySelectorAll(".b3-list-item__arrow--open").forEach(e=>{this.status[this.blockId].backlinkMOpenIds.push(e.parentElement.parentElement.getAttribute("data-node-id"))}),this.mTree.element.style.flex?this.mTree.element.style.height==="0px"?this.status[this.blockId].backlinkMStatus=3:this.status[this.blockId].backlinkMStatus=0:this.mTree.element.previousElementSibling.querySelector('[data-type="layout"]').getAttribute("aria-label")===window.siyuan.languages.down?this.status[this.blockId].backlinkMStatus=1:this.status[this.blockId].backlinkMStatus=2}render(e){e||(e={box:"",backlinks:[],backmentions:[],linkRefsCount:0,mentionsCount:0,k:"",mk:""}),this.editors.forEach(s=>{s.destroy()}),this.editors=[],this.element.querySelector('.block__icon[data-type="refresh"] svg').classList.remove("fn__rotate"),this.notebookId=e.box,this.inputsElement[0].value=e.k,this.inputsElement[1].value=e.mk,this.tree.updateData(e.backlinks),this.mTree.updateData(e.backmentions);const n=this.element.querySelector(".listCount");e.linkRefsCount===0?n.classList.add("fn__none"):(n.classList.remove("fn__none"),n.textContent=e.linkRefsCount.toString());const a=this.element.querySelector(".listMCount");e.mentionsCount===0?a.classList.add("fn__none"):(a.classList.remove("fn__none"),a.textContent=e.mentionsCount.toString()),this.status[this.blockId]||(this.status[this.blockId]={sort:"3",mSort:"3",scrollTop:0,mScrollTop:0,backlinkOpenIds:[],backlinkMOpenIds:[],backlinkMStatus:3},e.mentionsCount===0||window.siyuan.config.editor.backmentionExpandCount===-1?this.status[this.blockId].backlinkMStatus=3:(Array.from({length:window.siyuan.config.editor.backmentionExpandCount}).forEach((s,o)=>{e.backmentions[o]&&this.status[this.blockId].backlinkMOpenIds.push(e.backmentions[o].id)}),e.mentionsCount===0?this.status[this.blockId].backlinkMStatus=3:e.linkRefsCount===0?this.status[this.blockId].backlinkMStatus=0:this.status[this.blockId].backlinkMStatus=1),e.linkRefsCount>0&&Array.from({length:window.siyuan.config.editor.backlinkExpandCount}).forEach((s,o)=>{e.backlinks[o]&&this.status[this.blockId].backlinkOpenIds.push(e.backlinks[o].id)})),this.status[this.blockId].backlinkOpenIds.forEach(s=>{const o=this.tree.element.querySelector(`.b3-list-item[data-node-id="${s}"]`);o&&this.toggleItem(o,!1)}),this.status[this.blockId].backlinkMOpenIds.forEach(s=>{const o=this.mTree.element.querySelector(`.b3-list-item[data-node-id="${s}"]`);o&&this.toggleItem(o,!0)});const i=this.mTree.element.previousElementSibling.querySelector('[data-type="layout"]');this.status[this.blockId].backlinkMStatus===2||this.status[this.blockId].backlinkMStatus===1?(this.tree.element.classList.remove("fn__none"),this.mTree.element.removeAttribute("style"),this.status[this.blockId].backlinkMStatus===1?(i.setAttribute("aria-label",window.siyuan.languages.down),i.querySelector("use").setAttribute("xlink:href","#iconDown")):(i.setAttribute("aria-label",window.siyuan.languages.up),i.querySelector("use").setAttribute("xlink:href","#iconUp"))):this.status[this.blockId].backlinkMStatus===3?(this.tree.element.classList.remove("fn__none"),this.mTree.element.setAttribute("style","flex:none;height:0px"),i.setAttribute("aria-label",window.siyuan.languages.up),i.querySelector("use").setAttribute("xlink:href","#iconUp")):(this.tree.element.classList.add("fn__none"),this.mTree.element.setAttribute("style",`flex:none;height:${this.element.clientHeight-this.tree.element.previousElementSibling.clientHeight*2}px`),i.setAttribute("aria-label",window.siyuan.languages.down),i.querySelector("use").setAttribute("xlink:href","#iconDown")),this.tree.element.previousElementSibling.querySelector('[data-type="sort"]').setAttribute("data-sort",this.status[this.blockId].sort),this.mTree.element.previousElementSibling.querySelector('[data-type="mSort"]').setAttribute("data-sort",this.status[this.blockId].mSort),setTimeout(()=>{this.tree.element.scrollTop=this.status[this.blockId].scrollTop,this.mTree.element.scrollTop=this.status[this.blockId].mScrollTop},u.TIMEOUT_LOAD)}}const Qf=async t=>{if(Ce().backlink.find(s=>{if(s.blockId===t.blockId&&s.type==="local")return s.parent.parent.removeTab(s.parent.id),!0}))return;let n;const a=document.querySelector(".layout__wnd--active");if(a&&(n=Bt(a.getAttribute("data-id"))),n||(n=jl(window.siyuan.layout.centerLayout)),t.rootId){if(!t.title){const s=await Re("api/block/getDocInfo",{id:t.blockId});if(s.code===-1)return;t.title=s.data.name||window.siyuan.languages.untitled}}else{const s=await Re("api/block/getDocInfo",{id:t.blockId});if(s.code===-1)return;t.rootId=s.data.rootID,t.useBlockId=s.data.rootID!==s.data.id,t.title=s.data.name||window.siyuan.languages.untitled}n.split("lr").addTab(new ut({icon:"iconLink",title:t.title,callback(s){s.addModel(new fs({app:t.app,type:"local",tab:s,blockId:t.useBlockId?t.blockId:t.rootId,rootId:t.rootId}))}}))},ep=async t=>{if(Ce().graph.find(s=>{if(s.blockId===t.blockId&&s.type==="local")return s.parent.parent.removeTab(s.parent.id),!0}))return;let n;const a=document.querySelector(".layout__wnd--active");if(a&&(n=Bt(a.getAttribute("data-id"))),n||(n=jl(window.siyuan.layout.centerLayout)),t.rootId){if(!t.title){const s=await Re("api/block/getDocInfo",{id:t.blockId});if(s.code===-1)return;t.title=s.data.name||window.siyuan.languages.untitled}}else{const s=await Re("api/block/getDocInfo",{id:t.blockId});if(s.code===-1)return;t.rootId=s.data.rootID,t.useBlockId=s.data.rootID!==s.data.id,t.title=s.data.name||window.siyuan.languages.untitled}n.split("lr").addTab(new ut({icon:"iconGraph",title:t.title,callback(s){s.addModel(new ri({app:t.app,type:"local",tab:s,blockId:t.blockId,rootId:t.rootId}))}}))},_v=async t=>{if(Ce().outline.find(o=>{if(o.blockId===t.block.rootID&&o.type==="local")return o.parent.parent.removeTab(o.parent.id),!0}))return;let n;const a=document.querySelector(".layout__wnd--active");a&&(n=Bt(a.getAttribute("data-id"))),n||(n=jl(window.siyuan.layout.centerLayout));const i=n.split("lr");let s="";t.title?s=t.title.editElement.textContent||window.siyuan.languages.untitled:s=(await Re("api/block/getDocInfo",{id:t.block.rootID})).data.name||window.siyuan.languages.untitled,i.addTab(new ut({icon:"iconAlignCenter",title:s,callback(o){o.addModel(new us({app:t.app,type:"local",tab:o,blockId:t.block.rootID,isPreview:!t.preview.element.classList.contains("fn__none")}))}}),!1,!1),i.element.style.width="200px",i.element.classList.remove("fn__flex-1"),Nb(i,n),Ob(i.parent),dn()},$m=()=>{!window.siyuan.layout.leftDock.pin&&window.siyuan.layout.leftDock.layout.element.style.opacity==="1"&&window.siyuan.layout.leftDock.showDock(!0),!window.siyuan.layout.rightDock.pin&&window.siyuan.layout.rightDock.layout.element.style.opacity==="1"&&window.siyuan.layout.rightDock.showDock(!0),!window.siyuan.layout.bottomDock.pin&&window.siyuan.layout.bottomDock.layout.element.style.opacity==="1"&&window.siyuan.layout.bottomDock.showDock(!0)},Mm=t=>{const e=t.getAttribute("xlink:href")==="#iconHideDock";e?t.setAttribute("xlink:href","#iconDock"):t.setAttribute("xlink:href","#iconHideDock"),window.siyuan.config.uiLayout.hideDock=e,document.querySelectorAll(".dock").forEach(n=>{e?n.classList.add("fn__none"):n.querySelectorAll(".dock__item").length>1&&n.classList.remove("fn__none")}),ln(),$m()},Di=()=>{const t=Ce();t.outline.find(e=>{if(e.type==="pin"){if(e.blockId==="")return;e.isPreview=!1,e.update({data:[],msg:"",code:0},""),e.updateDocTitle()}}),t.graph.forEach(e=>{if(e.type!=="global"){if(e.type==="local"||e.blockId==="")return;e.blockId="",e.graphData=void 0,e.onGraph(!1)}}),t.backlink.forEach(e=>{e.type!=="local"&&e.blockId!==""&&(e.saveStatus(),e.blockId="",e.render(void 0))})},lt={element:void 0,genHTML:()=>`<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.appearance4}
        <div class="b3-label__text">${window.siyuan.languages.appearance5}</div>
    </div>
    <span class="fn__space"></span>
    <select class="b3-select fn__flex-center fn__size200" id="mode">
      <option value="0" ${window.siyuan.config.appearance.mode===0&&!window.siyuan.config.appearance.modeOS?"selected":""}>${window.siyuan.languages.themeLight}</option>
      <option value="1" ${window.siyuan.config.appearance.mode===1&&!window.siyuan.config.appearance.modeOS?"selected":""}>${window.siyuan.languages.themeDark}</option>
      <option value="2" ${window.siyuan.config.appearance.modeOS?"selected":""}>${window.siyuan.languages.themeOS}</option>
    </select>
</div>
<div class="b3-label">
    <div class="fn__flex">
        <div class="fn__flex-center fn__flex-1">${window.siyuan.languages.theme}</div>
        <span class="fn__space"></span>
        <button class="b3-button b3-button--outline fn__flex-center fn__size200${pt()?" fn__none":""}" id="appearanceOpenTheme">
            <svg><use xlink:href="#iconFolder"></use></svg>
            ${window.siyuan.languages.appearance9}
        </button>
    </div>
    <div class="fn__hr"></div>
    <div class="fn__flex config__item">
        <div class="fn__flex-center fn__flex-1 ft__on-surface">
            ${window.siyuan.languages.theme11}
        </div>
        <span class="fn__space"></span>
        <select class="b3-select fn__flex-center fn__size200" id="themeLight">
          ${Xi(window.siyuan.config.appearance.lightThemes,window.siyuan.config.appearance.themeLight)}
        </select>
    </div>
    <div class="fn__hr"></div>
    <div class="fn__flex config__item">
        <div class="fn__flex-center fn__flex-1 ft__on-surface">
            ${window.siyuan.languages.theme12}
        </div>
        <span class="fn__space"></span>
        <select class="b3-select fn__flex-center fn__size200" id="themeDark">
           ${Xi(window.siyuan.config.appearance.darkThemes,window.siyuan.config.appearance.themeDark)}
        </select>
    </div>
</div>
<div class="b3-label">
    <div class="fn__flex config__item">
        <div class="fn__flex-center fn__flex-1">
            ${window.siyuan.languages.icon}
        </div>
        <span class="fn__space"></span>
        <button class="b3-button b3-button--outline fn__flex-center fn__size200${pt()?" fn__none":""}" id="appearanceOpenIcon">
            <svg><use xlink:href="#iconFolder"></use></svg>
            ${window.siyuan.languages.appearance8}
        </button>
    </div>
    <div class="fn__hr"></div>
    <div class="fn__flex config__item">
        <div class="fn__flex-center fn__flex-1 ft__on-surface">${window.siyuan.languages.theme2}</div>
        <span class="fn__space"></span>
        <select class="b3-select fn__flex-center fn__size200" id="icon">
            ${Xi(window.siyuan.config.appearance.icons,window.siyuan.config.appearance.icon)}
        </select>
    </div>
</div>
<div class="b3-label fn__flex">
    <div class="fn__block">
        <div>
            ${window.siyuan.languages.appearance1}
        </div>
        <div class="fn__hr"></div>
        <div class="fn__flex config__item">
            <div class="fn__flex-center fn__flex-1 ft__on-surface">${window.siyuan.languages.appearance2}</div>
            <span class="fn__space"></span>
            <select id="codeBlockThemeLight" class="b3-select fn__size200">
                ${Xi(u.SIYUAN_CONFIG_APPEARANCE_LIGHT_CODE,window.siyuan.config.appearance.codeBlockThemeLight)}
            </select>
        </div>
        <div class="fn__hr"></div>
        <div class="fn__flex config__item">
            <div class="fn__flex-center fn__flex-1 ft__on-surface">${window.siyuan.languages.appearance3}</div>
            <span class="fn__space"></span>
            <select id="codeBlockThemeDark" class="b3-select fn__size200">
                ${Xi(u.SIYUAN_CONFIG_APPEARANCE_DARK_CODE,window.siyuan.config.appearance.codeBlockThemeDark)}
            </select>
        </div>
    </div>
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.language}
        <div class="b3-label__text">${window.siyuan.languages.language1}</div>
    </div>
    <span class="fn__space"></span>
    <select id="lang" class="b3-select fn__flex-center fn__size200">${QS(window.siyuan.config.langs,window.siyuan.config.appearance.lang)}</select>
</div>
<div class="b3-label config__item${pt()?" fn__none":" fn__flex"}">
    <div class="fn__flex-1">
        ${window.siyuan.languages.customEmoji}
        <div class="b3-label__text">${window.siyuan.languages.customEmojiTip}</div>
    </div>
    <span class="fn__space"></span>
    <button class="b3-button b3-button--outline fn__flex-center fn__size200" id="appearanceOpenEmoji">
        <svg><use xlink:href="#iconFolder"></use></svg>
        ${window.siyuan.languages.showInFolder}
    </button>
</div>
<div class="b3-label fn__flex config__item">
   <div class="fn__flex-1">
        ${window.siyuan.languages.resetLayout}
        <div class="b3-label__text">${window.siyuan.languages.appearance6}</div>
    </div>
    <span class="fn__space"></span>
    <button class="b3-button b3-button--outline fn__flex-center fn__size200" id="resetLayout">
        <svg><use xlink:href="#iconUndo"></use></svg>${window.siyuan.languages.reset}
    </button>
</div>
<div class="b3-label">
    <div class="fn__flex config__item">
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.codeSnippet}
        </div>
        <span class="fn__space"></span>
        <a class="b3-button b3-button--outline fn__flex-center fn__size200${window.siyuan.config.lang!=="zh_CN"?" fn__none":""}" target="_blank" href="https://ld246.com/tag/code-snippet">
            <svg><use xlink:href="#iconUpload"></use></svg>${window.siyuan.languages.visitCommunityShare}
        </a>
    </div>
    <div class="fn__hr"></div>
    <div class="fn__flex config__item">
        <div class="fn__flex-center fn__flex-1 ft__on-surface">
            ${window.siyuan.languages.codeSnippetTip}
        </div>
        <span class="fn__space"></span>
        <button class="b3-button b3-button--outline fn__flex-center fn__size200" id="codeSnippet">
            <svg><use xlink:href="#iconSettings"></use></svg>${window.siyuan.languages.config}
        </button>
    </div>
</div>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.appearance16}
        <div class="b3-label__text">${window.siyuan.languages.appearance17}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="hideStatusBar" type="checkbox"${window.siyuan.config.appearance.hideStatusBar?" checked":""}>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.appearance10}
        <div class="b3-label__text">${window.siyuan.languages.appearance11}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="closeButtonBehavior" type="checkbox"${window.siyuan.config.appearance.closeButtonBehavior===0?"":" checked"}>
</label>`,_send:()=>{const t=lt.element.querySelector("#themeLight").value,e=lt.element.querySelector("#themeDark").value,n=parseInt(lt.element.querySelector("#mode").value),a=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light";E("/api/setting/setAppearance",{icon:lt.element.querySelector("#icon").value,mode:n===2?a==="light"?0:1:n,modeOS:n===2,codeBlockThemeDark:lt.element.querySelector("#codeBlockThemeDark").value,codeBlockThemeLight:lt.element.querySelector("#codeBlockThemeLight").value,themeDark:e,themeLight:t,darkThemes:window.siyuan.config.appearance.darkThemes,lightThemes:window.siyuan.config.appearance.lightThemes,icons:window.siyuan.config.appearance.icons,lang:lt.element.querySelector("#lang").value,closeButtonBehavior:lt.element.querySelector("#closeButtonBehavior").checked?1:0,hideStatusBar:lt.element.querySelector("#hideStatusBar").checked},async i=>{if(window.siyuan.config.appearance.themeJS&&(i.data.mode!==window.siyuan.config.appearance.mode||i.data.mode===window.siyuan.config.appearance.mode&&(i.data.mode===0&&window.siyuan.config.appearance.themeLight!==i.data.themeLight||i.data.mode===1&&window.siyuan.config.appearance.themeDark!==i.data.themeDark)))if(window.destroyTheme)try{await window.destroyTheme(),window.destroyTheme=void 0,document.getElementById("themeScript").remove()}catch(s){console.error("destroyTheme error: "+s)}else{Xt({errorExit:!1,cb(){window.location.reload()}});return}lt.onSetappearance(i.data),i.data.hideStatusBar?document.getElementById("status").classList.add("fn__none"):document.getElementById("status").classList.remove("fn__none"),$m()})},bindEvent:()=>{lt.element.querySelector("#codeSnippet").addEventListener("click",()=>{eL()}),lt.element.querySelector("#resetLayout").addEventListener("click",()=>{xe("\u26A0\uFE0F "+window.siyuan.languages.reset,window.siyuan.languages.appearance6,()=>{bk()})}),lt.element.querySelector("#appearanceOpenIcon").addEventListener("click",()=>{ee.shell.openPath(Ft.join(window.siyuan.config.system.confDir,"appearance","icons"))}),lt.element.querySelector("#appearanceOpenTheme").addEventListener("click",()=>{ee.shell.openPath(Ft.join(window.siyuan.config.system.confDir,"appearance","themes"))}),lt.element.querySelector("#appearanceOpenEmoji").addEventListener("click",()=>{ee.shell.openPath(Ft.join(window.siyuan.config.system.dataDir,"emojis"))}),lt.element.querySelectorAll("select").forEach(t=>{t.addEventListener("change",()=>{lt._send()})}),lt.element.querySelectorAll(".b3-switch").forEach(t=>{t.addEventListener("change",()=>{lt._send()})})},onSetappearance(t){if(t.lang!==window.siyuan.config.appearance.lang){Xt({cb(){window.location.reload()},errorExit:!1});return}if(window.siyuan.config.appearance=t,lt.element){const e=lt.element.querySelector("#mode");e&&(t.modeOS?e.value="2":e.value=t.mode===0?"0":"1");const n=lt.element.querySelector("#themeLight");n&&(n.innerHTML=Xi(window.siyuan.config.appearance.lightThemes,window.siyuan.config.appearance.themeLight));const a=lt.element.querySelector("#themeDark");a&&(a.innerHTML=Xi(window.siyuan.config.appearance.darkThemes,window.siyuan.config.appearance.themeDark));const i=lt.element.querySelector("#icon");i&&(i.innerHTML=Xi(window.siyuan.config.appearance.icons,window.siyuan.config.appearance.icon))}tp(t),document.querySelector("#barMode use")?.setAttribute("xlink:href",`#icon${window.siyuan.config.appearance.modeOS?"Mode":window.siyuan.config.appearance.mode===0?"Light":"Dark"}`)}},vv=(t,e)=>{Ct(t,"iconDefaultScript").then(()=>{if(!["ant","material"].includes(e.icon)){const n=document.getElementById("iconScript");n&&n.remove(),Ct(`/appearance/icons/${e.icon}/icon.js?v=${e.iconVer}`,"iconScript")}})},tp=t=>{const e=document.getElementsByTagName("html")[0];e.setAttribute("lang",window.siyuan.config.appearance.lang),e.setAttribute("data-theme-mode",Sv()),e.setAttribute("data-light-theme",window.siyuan.config.appearance.themeLight),e.setAttribute("data-dark-theme",window.siyuan.config.appearance.themeDark);const n=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light";window.siyuan.config.appearance.modeOS&&(window.siyuan.config.appearance.mode===1&&n==="light"||window.siyuan.config.appearance.mode===0&&n==="dark")&&(E("/api/system/setAppearanceMode",{mode:n==="light"?0:1}),window.siyuan.config.appearance.mode=n==="light"?0:1);const a=document.getElementById("themeDefaultStyle"),i=`/appearance/themes/${t.mode===1?"midnight":"daylight"}/theme.css?v=${u.SIYUAN_VERSION}`;a?a.getAttribute("href").startsWith(i)||a.setAttribute("href",i):Qr(i,"themeDefaultStyle");const s=document.getElementById("themeStyle");if(t.mode===1&&t.themeDark!=="midnight"||t.mode===0&&t.themeLight!=="daylight"){const f=`/appearance/themes/${t.mode===1?t.themeDark:t.themeLight}/theme.css?v=${t.themeVer}`;s?s.getAttribute("href").startsWith(f)||s.setAttribute("href",f):Qr(f,"themeStyle")}else s&&s.remove();Ce().graph.forEach(f=>{f.searchGraph(!1)});const o=window.siyuan.config.appearance.mode===0?window.siyuan.storage[u.LOCAL_PDFTHEME].light:window.siyuan.storage[u.LOCAL_PDFTHEME].dark;document.querySelectorAll(".pdf__outer").forEach(f=>{const g=f.querySelector("#pdfDark"),p=f.querySelector("#pdfLight");o==="dark"?(f.classList.add("pdf__outer--dark"),p.classList.remove("toggled"),g.classList.add("toggled")):(f.classList.remove("pdf__outer--dark"),p.classList.add("toggled"),g.classList.remove("toggled"))}),Ev();const l=document.getElementById("themeScript"),r=`/appearance/themes/${t.mode===1?t.themeDark:t.themeLight}/theme.js?v=${t.themeVer}`;l?l.getAttribute("src").startsWith(r)||(l.remove(),Ct(r,"themeScript")):Ct(r,"themeScript");const d=document.getElementById("iconDefaultScript"),c=`/appearance/icons/${["ant","material"].includes(t.icon)?t.icon:"material"}/icon.js?v=${u.SIYUAN_VERSION}`;if(d){if(!d.getAttribute("src").startsWith(c)){d.remove();let f=document.body.firstElementChild;for(;f.tagName==="svg";){const g=f;f=f.nextElementSibling,g.getAttribute("data-name")||g.remove()}vv(c,t)}}else vv(c,t)},Hx=()=>{const t=document.getElementById("loading");t&&setTimeout(()=>{t.remove()},160),kv(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",e=>{const n=e.matches?"dark":"light";kv(n),window.siyuan.config.appearance.modeOS&&(window.siyuan.config.appearance.mode===0&&n==="light"||window.siyuan.config.appearance.mode===1&&n==="dark"||E("/api/system/setAppearanceMode",{mode:n==="light"?0:1},async a=>{if(window.siyuan.config.appearance.themeJS)if(window.destroyTheme)try{await window.destroyTheme(),window.destroyTheme=void 0,document.getElementById("themeScript").remove()}catch(i){console.error("destroyTheme error: "+i)}else{Xt({cb(){window.location.reload()},errorExit:!1});return}window.siyuan.config.appearance=a.data.appearance,tp(a.data.appearance)}))})},Rx=()=>{if(!window.siyuan.config.system.disableGoogleAnalytics){Ct("https://www.googletagmanager.com/gtag/js?id=G-L7WEXVQCR9","gaScript"),window.dataLayer=window.dataLayer||[];const t=function(...n){window.dataLayer.push(arguments)};t("js",new Date),t("config","G-L7WEXVQCR9",{send_page_view:!1});const e={version:u.SIYUAN_VERSION,container:window.siyuan.config.system.container,os:window.siyuan.config.system.os,osPlatform:window.siyuan.config.system.osPlatform,isLoggedIn:!1,subscriptionStatus:-1,subscriptionPlan:-1,subscriptionType:-1,oneTimePayStatus:-1,syncEnabled:!1,syncProvider:-1,cTreeCount:window.siyuan.config.stat.cTreeCount,cBlockCount:window.siyuan.config.stat.cBlockCount,cDataSize:window.siyuan.config.stat.cDataSize,cAssetsSize:window.siyuan.config.stat.cAssetsSize};window.siyuan.user&&(e.isLoggedIn=!0,e.subscriptionStatus=window.siyuan.user.userSiYuanSubscriptionStatus,e.subscriptionPlan=window.siyuan.user.userSiYuanSubscriptionPlan,e.subscriptionType=window.siyuan.user.userSiYuanSubscriptionType,e.oneTimePayStatus=window.siyuan.user.userSiYuanOneTimePayStatus),window.siyuan.config.sync&&(e.syncEnabled=window.siyuan.config.sync.enabled,e.syncProvider=window.siyuan.config.sync.provider),t("event",u.ANALYTICS_EVT_ON_GET_CONFIG,e)}},Rl=async(t=!0)=>{const e=Math.floor(window.siyuan.config.editor.fontSize*1.625);let n;gt()||Da()||nf()?n=`@font-face {
  font-family: "Emojis Additional";
  src: url(../../../appearance/fonts/Noto-COLRv1-2.047/Noto-COLRv1.woff2) format("woff2");
  unicode-range: U+1fae9, U+1fac6, U+1fabe, U+1fadc, U+e50a, U+1fa89, U+1fadf, U+1f1e6-1f1ff, U+1fa8f;
}
@font-face {
  font-family: "Emojis Reset";
  src: local("Apple Color Emoji"),
  local("Segoe UI Emoji"),
  local("Segoe UI Symbol");
  unicode-range: U+21a9, U+21aa, U+2122, U+2194-2199, U+23cf, U+25b6, U+25c0, U+25fb, U+25fc, U+25aa, U+25ab, U+2600-2603,
  U+260e, U+2611, U+261d, U+2639, U+263a, U+2640, U+2642, U+2660, U+2663, U+2665, U+2666, U+2668, U+267b, U+26aa, U+26ab, 
  U+2702, U+2708, U+2934, U+2935, U+1f170, U+1f171, U+1f17e, U+1f17f, U+1f202, U+1f21a, U+1f22f, U+1f232-1f23a, U+1f250, 
  U+1f251, U+1fae4, U+2049, U+203c, U+3030, U+303d, U+24c2, U+26a0, U+26a1, U+26be, U+27a1, U+2b05-2b07, U+3297, U+3299, U+a9, U+ae;
  size-adjust: 115%;
}
@font-face {
  font-family: "Emojis";
  src: local("Apple Color Emoji"),
  local("Segoe UI Emoji"),
  local("Segoe UI Symbol");
  size-adjust: 115%;
}`:await Yy()?n=`@font-face {
  font-family: "Emojis Additional";
  src: url(../../../appearance/fonts/Noto-COLRv1-2.047/Noto-COLRv1.woff2) format("woff2");
  unicode-range: U+1fae9, U+1fac6, U+1fabe, U+1fadc, U+e50a, U+1fa89, U+1fadf, U+1f1e6-1f1ff, U+1f3f4, U+e0067, U+e0062,
  U+e0065, U+e006e, U+e007f, U+e0073, U+e0063, U+e0074, U+e0077, U+e006c;
  size-adjust: 85%;
}
@font-face {
  font-family: "Emojis Reset";
  src: local("Segoe UI Emoji"),
  local("Segoe UI Symbol");
  unicode-range: U+263a, U+21a9, U+2642, U+303d, U+2197, U+2198, U+2199, U+2196, U+2195, U+2194, U+2660, U+2665, U+2666, 
  U+2663, U+3030, U+21aa, U+25b6, U+25c0, U+2640, U+203c, U+a9, U+ae, U+2122;
  size-adjust: 85%;
}
@font-face {
  font-family: "Emojis";
  src: local("Segoe UI Emoji"),
  local("Segoe UI Symbol");
  size-adjust: 85%;
}`:n=`@font-face {
  font-family: "Emojis Reset";
  src: url(../../../appearance/fonts/Noto-COLRv1-2.047/Noto-COLRv1.woff2) format("woff2");
  unicode-range: U+1f170-1f171, U+1f17e, U+1f17f, U+1f21a, U+1f22f, U+1f232-1f23a, U+1f250, U+1f251, U+1f32b, U+1f3bc,
  U+1f411, U+1f42d, U+1f42e, U+1f431, U+1f435, U+1f441, U+1f4a8, U+1f4ab, U+1f525, U+1f600-1f60d, U+1f60f-1f623,
  U+1f625-1f62b, U+1f62d-1f63f, U+1F643, U+1F640, U+1f79, U+1f8f, U+1fa79, U+1fae4, U+1fae9, U+1fac6, U+1fabe, U+1fadf,
  U+200d, U+203c, U+2049, U+2122, U+2139, U+2194-2199, U+21a9, U+21aa, U+23cf, U+25aa, U+25ab, U+25b6, U+25c0, U+25fb-25fe,
  U+2611, U+2615, U+2618, U+261d, U+2620, U+2622, U+2623, U+2626, U+262a, U+262e, U+2638-263a, U+2640, U+2642, U+2648-2653,
  U+265f, U+2660, U+2663, U+2665, U+2666, U+267b, U+267e, U+267f, U+2692-2697, U+2699, U+269b, U+269c, U+26a0, U+26a1,
  U+26a7, U+26aa, U+26ab, U+26b0, U+26b1, U+2702, U+2708, U+2709, U+270c, U+270d, U+2712, U+2714, U+2716, U+271d, U+2733,
  U+2734, U+2744, U+2747, U+2763, U+2764, U+2934-2935, U+3030, U+303d, U+3297, U+3299, U+fe0f, U+e50a, U+a9, U+ae;
  size-adjust: 92%;
}
@font-face {
  font-family: "Emojis";
  src: url(../../../appearance/fonts/Noto-COLRv1-2.047/Noto-COLRv1.woff2) format("woff2"),
  local("Segoe UI Emoji"),
  local("Segoe UI Symbol"),
  local("Apple Color Emoji"),
  local("Twemoji Mozilla"),
  local("Noto Color Emoji"),
  local("Android Emoji"),
  local("EmojiSymbols");
  size-adjust: 92%;
}`;let a="";if(window.siyuan.config.editor.rtl&&(a=`.protyle-title__input,
.protyle-wysiwyg .p,
.protyle-wysiwyg .code-block .hljs,
.protyle-wysiwyg .table,
.protyle-wysiwyg .render-node protyle-html,
.protyle-wysiwyg .render-node > div[spin="1"],
.protyle-wysiwyg [data-type="NodeHeading"] {direction: rtl}
.protyle-wysiwyg [data-node-id].li > .protyle-action {
    right: 0;
    left: auto;
    direction: rtl;
}
.protyle-wysiwyg [data-node-id].li > [data-node-id] {
    margin-right: 34px;
    margin-left: 0;
}
.protyle-wysiwyg [data-node-id].li::before {
    right: 17px;
    left: auto;
}`),n+=`
:root{--b3-font-size-editor:${window.siyuan.config.editor.fontSize}px}
.b3-typography code:not(.hljs), .protyle-wysiwyg span[data-type~=code] { font-variant-ligatures: ${window.siyuan.config.editor.codeLigatures?"normal":"none"} }
.li > .protyle-action {height:${e+8}px;line-height: ${e+8}px}
/* \u5217\u8868\u9879\u540E\u7684\u5185\u5BB9\u548C\u5217\u8868\u9879\u5BF9\u9F50 https://github.com/siyuan-note/siyuan/issues/2803 */
.protyle-wysiwyg [data-node-id].li > .protyle-action ~ div {line-height:${e}px}
.protyle-wysiwyg [data-node-id].li > .protyle-action ~ div > [spellcheck] {min-height:${e}px}
.protyle-wysiwyg [data-node-id].li::before {height: calc(100% - ${e+12}px);top:${e+12}px}
${a}
.protyle-wysiwyg [data-node-id] {${window.siyuan.config.editor.justify?" text-align: justify;":""}}
.protyle-wysiwyg .li {min-height:${e+8}px}
.protyle-gutters button svg {height:${e}px}`,window.siyuan.config.editor.fontFamily&&(n+=`
.b3-typography:not(.b3-typography--default), .protyle-wysiwyg, .protyle-title {font-family: "Emojis Additional", "Emojis Reset", "${window.siyuan.config.editor.fontFamily}", var(--b3-font-family)}`),"ontouchend"in document&&(n+=`
.b3-menu .b3-menu__action {opacity: 0.68;}`),t){const i=document.getElementById("siyuanStyle");i?i.innerHTML=n:document.querySelector("#pluginsStyle").insertAdjacentHTML("beforebegin",`<style id="siyuanStyle">${n}</style>`)}return n},Ev=(t=u.PROTYLE_CDN)=>{const e=document.getElementById("protyleHljsStyle");let n;window.siyuan.config.appearance.mode===0?(n=window.siyuan.config.appearance.codeBlockThemeLight,u.SIYUAN_CONFIG_APPEARANCE_LIGHT_CODE.includes(n)||(n="default")):(n=window.siyuan.config.appearance.codeBlockThemeDark,u.SIYUAN_CONFIG_APPEARANCE_DARK_CODE.includes(n)||(n="github-dark"));const a=`${t}/js/highlight.js/styles/${n}.min.css?v=11.11.1`;e?e.href.includes(a)||(e.remove(),Qr(a,"protyleHljsStyle")):Qr(a,"protyleHljsStyle")},Pm=t=>{let e=t;t===2&&(window.matchMedia("(prefers-color-scheme: dark)").matches?e=1:e=0),E("/api/setting/setAppearance",Object.assign({},window.siyuan.config.appearance,{mode:e,modeOS:t===2}),async n=>{if(window.siyuan.config.appearance.themeJS&&(n.data.mode!==window.siyuan.config.appearance.mode||n.data.mode===window.siyuan.config.appearance.mode&&(n.data.mode===0&&window.siyuan.config.appearance.themeLight!==n.data.themeLight||n.data.mode===1&&window.siyuan.config.appearance.themeDark!==n.data.themeDark)))if(window.destroyTheme)try{await window.destroyTheme(),window.destroyTheme=void 0,document.getElementById("themeScript").remove()}catch(a){console.error("destroyTheme error: "+a)}else{Xt({errorExit:!1,cb(){window.location.reload()}});return}lt.onSetappearance(n.data)})},Ox=t=>{if(t.startsWith("#"))return t;let e;const n=t.replace(/\s/g,"").match(/^rgba?\((\d+),(\d+),(\d+),?([^,\s)]+)?/i),a=(n&&n[4]||"").trim();let i=n?(n[1]|1<<8).toString(16).slice(1)+(n[2]|1<<8).toString(16).slice(1)+(n[3]|1<<8).toString(16).slice(1):t;return a!==""?e=a:e=1,e=(e*255|1<<8).toString(16).slice(1),i=i+e,i},kv=t=>{(ra()||fn()||pn())&&setTimeout(()=>{const e=Ox(getComputedStyle(document.body).getPropertyValue("--b3-theme-background").trim());let n=window.siyuan.config.appearance.mode;window.siyuan.config.appearance.modeOS&&(t==="dark"?n=1:n=0),ra()?window.webkit.messageHandlers.changeStatusBar.postMessage((e||(n===0?"#fff":"#1e1e1e"))+" "+n):fn()?window.JSAndroid.changeStatusBarColor(e,n):pn()&&window.JSHarmony.changeStatusBarColor(e,n)},500)},Sv=()=>{const t=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light";return window.siyuan.config.appearance.modeOS?t:window.siyuan.config.appearance.mode===0?"light":"dark"},ze=(t,e=u.PROTYLE_CDN)=>{let n,a=!1;t.classList.contains("code-block")?n=t.querySelectorAll(".hljs"):t.classList.contains("item__readme")?(n=t.querySelectorAll("pre code"),n.forEach(i=>{i.parentElement.setAttribute("linenumber","false")})):t.classList.contains("b3-typography")?(n=t.querySelectorAll(".code-block code"),a=!0):n=t.querySelectorAll(".code-block .hljs"),n.length!==0&&(Ev(e),Ct(`${e}/js/highlight.js/highlight.min.js?v=11.11.1`,"protyleHljsScript").then(()=>{Ct(`${e}/js/highlight.js/third-languages.js?v=1.0.1`,"protyleHljsThirdScript").then(()=>{n.forEach(i=>{const s=i.parentElement.querySelectorAll(".protyle-icon");if(s.length===2&&(s[0].setAttribute("aria-label",window.siyuan.languages.copy),s[1].setAttribute("aria-label",window.siyuan.languages.more)),i.getAttribute("data-render")==="true")return;const o=i.querySelector("wbr");let l=0;if(o){let h=o.previousSibling;for(;h;){for(l+=h.textContent.length;!h.previousSibling&&h.parentElement.tagName!=="DIV";)h=h.parentElement;h=h.previousSibling}o.remove()}let r;a?r=i.parentElement.getAttribute("data-language"):i.previousElementSibling?r=i.previousElementSibling.firstElementChild.textContent:r=i.className.replace("language-",""),window.hljs.getLanguage(r)||(r="plaintext"),i.classList.add("hljs"),i.setAttribute("data-render","true");const d=i.parentElement.getAttribute("linewrap"),c=i.parentElement.getAttribute("ligatures"),f=i.parentElement.getAttribute("linenumber"),g=i.lastElementChild?i.lastElementChild:i;d==="true"||d!=="false"&&window.siyuan.config.editor.codeLineWrap?(g.style.setProperty("white-space","pre-wrap"),g.style.setProperty("word-break","break-word")):(g.style.setProperty("white-space","pre"),g.style.setProperty("word-break","initial")),c==="true"||c!=="false"&&window.siyuan.config.editor.codeLigatures?g.style.fontVariantLigatures="normal":g.style.fontVariantLigatures="none";const p=g.textContent;i.firstElementChild&&(!a&&(f==="true"||f!=="false"&&window.siyuan.config.editor.codeSyntaxHighlightLineNum)?(i.firstElementChild.className="protyle-linenumber__rows",i.firstElementChild.setAttribute("contenteditable","false"),Ol(i),i.style.display=""):(i.firstElementChild.className="fn__none",i.firstElementChild.innerHTML="",g.style.paddingLeft="",i.style.display="block")),g.innerHTML=window.hljs.highlight(p+(p.endsWith(`
`)?"":`
`),{language:r,ignoreIllegals:!0}).value,o&&getSelection().rangeCount>0&&na(i,l,l)})})}))},Ol=t=>{const e=t.parentElement.getAttribute("lineNumber");if(e==="false"||!window.siyuan.config.editor.codeSyntaxHighlightLineNum&&e!=="true")return;t.parentElement.style.lineHeight=`${((parseInt(t.parentElement.style.fontSize)||window.siyuan.config.editor.fontSize)*1.625*.85).toFixed(0)}px`;const n=t.lastElementChild;let a="";const i=n.textContent.split(/\r\n|\r|\n|\u2028|\u2029/g);i[i.length-1]===""&&i.length>1&&i.pop(),t.firstElementChild.innerHTML=`<span>${i.length}</span>`,n.style.paddingLeft=`${t.firstElementChild.clientWidth+16}px`;const s=document.createElement("div");s.className="hljs",s.setAttribute("style",`padding-left:${n.style.paddingLeft};
width: ${n.getBoundingClientRect().width}px;
white-space:${n.style.whiteSpace};
word-break:${n.style.wordBreak};
font-variant-ligatures:${n.style.fontVariantLigatures};
padding-right:0;max-height: none;box-sizing: border-box;position: absolute;padding-top:0 !important;padding-bottom:0 !important;min-height:auto !important;`),s.setAttribute("contenteditable","true"),t.insertAdjacentElement("afterend",s);const o=n.style.wordBreak==="break-word";if(i.map(l=>{let r="";o&&(s.textContent=l.trim()?l:"<br>",r=` style="height:${s.clientHeight}px;"`),a+=`<span${r}></span>`}),s.remove(),t.firstElementChild.innerHTML=a,t.scrollHeight>t.clientHeight&&getSelection().rangeCount>0){const l=getSelection().getRangeAt(0);if(t.contains(l.startContainer)){const r=document.createElement("br");l.insertNode(r),r.scrollIntoView({block:"nearest"}),r.remove()}}};let Un=[],Bl=!1;const np=async(t,e)=>{Q(["gutter","toolbar","hint","util","dialog"],e.protyle);let n;if(!document.contains(e.protyle.element)){if(!(await Re("/api/block/checkBlockExist",{id:e.protyle.block.rootID})).data)return!1;let i;const s=document.querySelector(".layout__wnd--active");if(s&&(i=Bt(s.getAttribute("data-id"))),i||(i=jl(window.siyuan.layout.centerLayout)),i){const o=await Re("/api/block/getBlockInfo",{id:e.id});if(o.code===3){j(o.msg);return}const l=new ut({title:o.data.rootTitle,docIcon:o.data.rootIcon,callback(d){const c=ic(e.protyle,!0);c.rootId=e.protyle.block.rootID,c.focusId=e.id,c.focusStart=e.position.start,c.focusEnd=e.position.end,window.siyuan.storage[u.LOCAL_FILEPOSITION][e.protyle.block.rootID]=c;const f=new ht({app:t,tab:d,blockId:e.zoomId||e.protyle.block.rootID,rootId:e.protyle.block.rootID,action:e.zoomId?[u.CB_GET_FOCUS,u.CB_GET_ALL,u.CB_GET_UNUNDO]:[u.CB_GET_FOCUS,u.CB_GET_UNUNDO]});d.addModel(f)}});if(window.siyuan.config.fileTree.openFilesUseCurrentTab){let d;i.children.forEach(c=>{c.headElement&&c.headElement.classList.contains("item--unupdate")&&!c.headElement.classList.contains("item--pin")&&(d=c)}),i.addTab(l),d&&i.removeTab(d.id)}else i.addTab(l);i.showHeading();const r=l.model.editor.protyle;return e.protyle=r,Un.forEach(d=>{!document.contains(d.protyle.element)&&d.protyle.block.rootID===o.data.rootID&&(d.protyle=r)}),window.siyuan.backStack.forEach(d=>{!document.contains(d.protyle.element)&&d.protyle.block.rootID===o.data.rootID&&(d.protyle=r)}),o.data.rootID===e.id?na(r.title.editElement,e.position.start,e.position.end):(Array.from(r.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`)).find(d=>{if(!F(d))return n=d,!0}),na(le(n),e.position.start,e.position.end),Ne(r,n)),!0}else return!1}if(e.protyle.block.rootID===e.id)return e.protyle.title.editElement.getBoundingClientRect().height===0&&(e.protyle.model.parent.parent.switchTab(e.protyle.model.parent.headElement),e.protyle.toolbar.range=void 0),na(e.protyle.title.editElement,e.position.start,e.position.end),!0;if(Array.from(e.protyle.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`)).find(a=>{if(!F(a))return n=a,!0}),n&&(!e.zoomId||e.zoomId&&e.zoomId===e.protyle.block.id))return n.getBoundingClientRect().height===0&&e.protyle.model.parent.parent.switchTab(e.protyle.model.parent.headElement),na(le(n),e.position.start,e.position.end),Ne(e.protyle,n),Ce().outline.forEach(a=>{a.blockId===e.protyle.block.rootID&&a.setCurrent(n)}),!0;if(e.protyle.element.parentElement)return(await Re("/api/block/checkBlockExist",{id:e.id})).data?!n&&!e.zoomId&&!e.protyle.scroll.element.classList.contains("fn__none")?(E("/api/filetree/getDoc",{id:e.id,mode:3,size:window.siyuan.config.editor.dynamicLoadBlocks},i=>{rt({data:i,protyle:e.protyle,afterCB(){Array.from(e.protyle.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`)).find(s=>{if(!F(s))return n=s,!0}),n&&(Ce().outline.forEach(s=>{s.blockId===e.protyle.block.rootID&&s.setCurrent(n)}),na(le(n),e.position.start,e.position.end),Ne(e.protyle,n,!0))}})}),!0):(Vt({protyle:e.protyle,id:e.zoomId||e.protyle.block.rootID,isPushBack:!1,callback:()=>{Array.from(e.protyle.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`)).find(i=>{if(!F(i))return n=i,!0}),n&&(Ce().outline.forEach(i=>{i.blockId===e.protyle.block.rootID&&i.setCurrent(n)}),na(le(n),e.position.start,e.position.end),Ne(e.protyle,n,!0))}}),!0):(getSelection().rangeCount>0&&Z(getSelection().getRangeAt(0)),!1)},ap=async t=>{if(window.siyuan.backStack.length===0){Un.length>0&&await np(t,Un[Un.length-1]);return}document.querySelector("#barForward")?.classList.remove("toolbar__item--disabled"),!Bl&&document.contains(window.siyuan.backStack[window.siyuan.backStack.length-1].protyle.element)&&Un.push(window.siyuan.backStack.pop());let e=window.siyuan.backStack.pop();for(;e;)if(await np(t,e)){Un.push(e);break}else e=window.siyuan.backStack.pop();Bl=!0,window.siyuan.backStack.length===0&&document.querySelector("#barBack")?.classList.add("toolbar__item--disabled")},ip=async t=>{if(Un.length===0){window.siyuan.backStack.length>0&&await np(t,window.siyuan.backStack[window.siyuan.backStack.length-1]);return}document.querySelector("#barBack")?.classList.remove("toolbar__item--disabled"),Bl&&window.siyuan.backStack.push(Un.pop());let e=Un.pop();for(;e;)if(await np(t,e)){window.siyuan.backStack.push(e);break}else e=Un.pop();Bl=!1,Un.length===0&&document.querySelector("#barForward")?.classList.add("toolbar__item--disabled")},ql=(t,e,n)=>{if(!t.model||(!n&&e&&(n=P(e.startContainer)),!n))return;let a;if(n.classList.contains("protyle-title__input")?a=n:a=le(n),a){const i=ct(a,void 0,e),s=n.getAttribute("data-node-id")||t.block.rootID,o=window.siyuan.backStack[window.siyuan.backStack.length-1];o&&o.id===s&&(t.block.showAll&&o.zoomId===t.block.id||!o.zoomId&&!t.block.showAll)?o.position=i:(Un.length>0&&(Bl&&window.siyuan.backStack.push(Un.pop()),Un=[],document.querySelector("#barForward")?.classList.add("toolbar__item--disabled")),window.siyuan.backStack.push({position:i,id:s,protyle:t,zoomId:t.block.showAll?t.block.id:void 0}),window.siyuan.backStack.length>u.SIZE_UNDO&&window.siyuan.backStack.shift(),Bl=!1),window.siyuan.backStack.length>1&&document.querySelector("#barBack")?.classList.remove("toolbar__item--disabled")}},rt=t=>{if(t.action||(t.action=[]),t.protyle.wysiwyg.element.removeAttribute("data-top"),t.data.code===1){t.action.includes(u.CB_GET_APPEND)||(t.protyle.model?t.protyle.model.parent.parent.removeTab(t.protyle.model.parent.id,!1):t.protyle.element.innerHTML=`<div class="ft__smaller ft__secondary b3-form__space--small" contenteditable="false">${window.siyuan.languages.refExpired}</div>`);return}if(t.data.code!==3&&(t.protyle.notebookId=t.data.data.box,t.protyle.path=t.data.data.path,!(t.data.data.eof&&!t.scrollAttr&&(t.action.includes(u.CB_GET_BEFORE)?t.protyle.wysiwyg.element.firstElementChild.setAttribute("data-eof","1"):t.protyle.wysiwyg.element.lastElementChild.setAttribute("data-eof","2"),t.data.data.mode!==4)))){if(Q(["gutterOnly"],t.protyle),t.protyle.block.parentID=t.data.data.parentID,t.protyle.block.parent2ID=t.data.data.parent2ID,t.protyle.block.rootID=t.data.data.rootID,t.protyle.block.showAll=!1,t.protyle.block.mode=t.data.data.mode,t.protyle.block.blockCount=t.data.data.blockCount,t.protyle.block.scroll=t.data.data.scroll,t.protyle.block.action=t.action,t.action.includes(u.CB_GET_UNCHANGEID)||(t.protyle.block.id=t.data.data.id,t.protyle.scroll.lastScrollTop=0,t.protyle.contentElement.scrollTop=0,t.protyle.wysiwyg.element.setAttribute("data-doc-type",t.data.data.type)),t.action.includes(u.CB_GET_APPEND)||t.action.includes(u.CB_GET_BEFORE)||t.action.includes(u.CB_GET_HTML)){Lv({content:t.data.data.content,expand:t.data.data.isBacklinkExpand,action:t.action,scrollAttr:t.scrollAttr,updateReadonly:t.updateReadonly,isSyncing:t.data.data.isSyncing,afterCB:t.afterCB},t.protyle),Ac(t.protyle);return}E("/api/block/getDocInfo",{id:t.protyle.block.rootID},e=>{t.protyle.options.render.title?t.protyle.title.render(t.protyle,e):(t.protyle.options.render.background&&t.protyle.background.render(e.data.ial,t.protyle.block.rootID),t.protyle.wysiwyg.renderCustom(e.data.ial)),Lv({content:t.data.data.content,expand:t.data.data.isBacklinkExpand,action:t.action,scrollAttr:t.scrollAttr,updateReadonly:t.updateReadonly,isSyncing:t.data.data.isSyncing,afterCB:t.afterCB},t.protyle),Ac(t.protyle)})}},Lv=(t,e)=>{if(e.contentElement.classList.contains("fn__none")&&e.wysiwyg.element.innerHTML!=="")return;e.block.showAll=t.action.includes(u.CB_GET_ALL);const n=e.contentElement.clientHeight*8,a=typeof t.updateReadonly>"u"?e.wysiwyg.element.innerHTML==="":t.updateReadonly;if(t.action.includes(u.CB_GET_APPEND)){if(!e.wysiwyg.element.querySelector(".protyle-wysiwyg--select")&&!e.scroll.keepLazyLoad&&e.contentElement.scrollHeight>n){let i=e.wysiwyg.element.firstElementChild;const s=[];for(;e.wysiwyg.element.childElementCount>2&&s&&!e.wysiwyg.element.lastElementChild.isSameNode(i)&&e.contentElement.scrollHeight-i.offsetTop>n;){s.push(i);i=i.nextElementSibling}const o=i.getBoundingClientRect().top;s.forEach(l=>{l.remove()}),e.contentElement.scrollTop=e.contentElement.scrollTop+(i.getBoundingClientRect().top-o),e.scroll.lastScrollTop=e.contentElement.scrollTop,Q(["toolbar"],e)}e.wysiwyg.element.insertAdjacentHTML("beforeend",t.content)}else if(t.action.includes(u.CB_GET_BEFORE)){const i=e.wysiwyg.element.firstElementChild,s=i.getBoundingClientRect().top;if(e.wysiwyg.element.insertAdjacentHTML("afterbegin",t.content),e.contentElement.scrollTop=e.contentElement.scrollTop+(i.getBoundingClientRect().top-s),e.scroll.lastScrollTop=e.contentElement.scrollTop,!e.wysiwyg.element.querySelector(".protyle-wysiwyg--select")&&!e.scroll.keepLazyLoad){const o=[];let l=e.wysiwyg.element.childElementCount,r=e.contentElement.scrollHeight,d=e.wysiwyg.element.lastElementChild;for(;l>2&&r>n&&d.getBoundingClientRect().top>window.innerHeight;)o.push(d),d=d.previousElementSibling,l--,r-=d.clientHeight+8;o.forEach(c=>{c.remove()}),Q(["toolbar"],e)}}else e.wysiwyg.element.innerHTML=t.content;if(!e.block.showAll&&e.wysiwyg.element.childElementCount===1&&e.wysiwyg.element.firstElementChild.classList.contains("p")){const i=le(e.wysiwyg.element.firstElementChild);i&&i.textContent===""&&(i.classList.add("protyle-wysiwyg--empty"),i.setAttribute("placeholder",window.siyuan.languages.emptyPlaceholder))}if(t.action.includes(u.CB_GET_BACKLINK)&&dv(t.expand,e.wysiwyg.element),yt(e.wysiwyg.element),ze(e.wysiwyg.element),dt(e.wysiwyg.element,e),Be(e,e.wysiwyg.element),!t.action.includes(u.CB_GET_HISTORY)){if(e.options.render.scroll&&e.scroll.update(e),t.action.includes(u.CB_GET_FOCUSFIRST)){const i=e.wysiwyg.element.offsetTop-16;Bn(e,i,u.TIMEOUT_INPUT),e.contentElement.scrollTop=i}if(t.isSyncing?xv(e):(e.breadcrumb&&(e.breadcrumb.element.nextElementSibling.textContent=""),e.element.removeAttribute("disabled-forever"),Av(e,a),t.action.includes(u.CB_GET_OPENNEW)&&window.siyuan.config.editor.readOnly&&Hh(e.breadcrumb.element.parentElement.querySelector('.block__icon[data-type="readonly"]'),e)),Bx(e,t.action,t.scrollAttr),t.action.includes(u.CB_GET_SETID)&&(e.block.id=e.block.rootID,e.wysiwyg.element.setAttribute("data-doc-type","NodeDocument")),e.options.defIds?.forEach(i=>{e.wysiwyg.element.querySelectorAll(`[data-id="${i}"]`).forEach(s=>{s.classList.add("def--mark")})}),e.options.defIds=[],t.action.includes(u.CB_GET_APPEND)||t.action.includes(u.CB_GET_BEFORE)){e.app.plugins.forEach(i=>{i.eventBus.emit("loaded-protyle-dynamic",{protyle:e,position:t.action.includes(u.CB_GET_APPEND)?"afterend":"beforebegin"})});return}e.options.render.breadcrumb&&(e.breadcrumb.toggleExit(!t.action.includes(u.CB_GET_ALL)),e.breadcrumb.render(e)),t.afterCB&&t.afterCB(),t.scrollAttr&&!e.scroll.element.classList.contains("fn__none")&&!e.element.classList.contains("block__edit")&&e.wysiwyg.element.lastElementChild.getAttribute("data-eof")!=="2"&&e.contentElement.scrollHeight>0&&!t.action.includes(u.CB_GET_FOCUSFIRST)&&e.contentElement.scrollHeight<=e.contentElement.clientHeight&&E("/api/filetree/getDoc",{id:e.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),mode:2,size:window.siyuan.config.editor.dynamicLoadBlocks},i=>{rt({data:i,protyle:e,action:[u.CB_GET_APPEND,u.CB_GET_UNCHANGEID]})}),t.scrollAttr&&!e.scroll.element.classList.contains("fn__none")&&!e.element.classList.contains("fn__none")&&e.scroll.updateIndex(e,t.scrollAttr.startId,i=>{i>1&&e.block.blockCount>1&&e.contentElement.scrollHeight<=e.contentElement.clientHeight&&j(window.siyuan.languages.scrollGetMore)}),e.app.plugins.forEach(i=>{i.eventBus.emit("loaded-protyle-static",{protyle:e})})}},xv=t=>{Zn(t),t.breadcrumb&&!W()?t.breadcrumb.element.nextElementSibling.textContent=window.siyuan.languages._kernel[81]:j(window.siyuan.languages._kernel[81]),t.element.setAttribute("disabled-forever","true")},Zn=t=>{if(window.siyuan.menus.menu.remove(),Q(["gutter","toolbar","select","hint","util"],t),t.disabled=!0,t.title&&t.title.editElement&&(t.title.editElement.setAttribute("contenteditable","false"),t.title.editElement.style.userSelect="text"),t.background&&(t.background.element.classList.remove("protyle-background--enable"),t.background.element.classList.remove("protyle-background--mobileshow")),t.wysiwyg.element.querySelectorAll(".protyle-icons--show").forEach(e=>{e.classList.remove("protyle-icons--show")}),t.wysiwyg.element.querySelectorAll(".render-node .protyle-action__edit").forEach(e=>{e.classList.add("fn__none"),e.classList.contains("protyle-icon--first")&&e.nextElementSibling?.classList.add("protyle-icon--first")}),t.wysiwyg.element.style.userSelect="text",t.wysiwyg.element.setAttribute("contenteditable","false"),t.wysiwyg.element.setAttribute("data-readonly","true"),t.wysiwyg.element.querySelectorAll('[contenteditable="true"][spellcheck]').forEach(e=>{e.setAttribute("contenteditable","false")}),t.wysiwyg.element.querySelectorAll('.protyle-action[draggable="true"]').forEach(e=>{e.setAttribute("draggable","false")}),t.breadcrumb){t.breadcrumb.element.parentElement.querySelector('[data-type="readonly"] use').setAttribute("xlink:href","#iconLock"),t.breadcrumb.element.parentElement.querySelector('[data-type="readonly"]').setAttribute("aria-label",window.siyuan.config.editor.readOnly?window.siyuan.languages.tempUnlock:window.siyuan.languages.unlockEdit);const e=t.breadcrumb.element.parentElement.querySelector('[data-type="undo"]');e&&!e.classList.contains("fn__none")&&(e.classList.add("fn__none"),t.breadcrumb.element.parentElement.querySelector('[data-type="redo"]').classList.add("fn__none"),t.breadcrumb.element.parentElement.querySelector('[data-type="indent"]').classList.add("fn__none"),t.breadcrumb.element.parentElement.querySelector('[data-type="outdent"]').classList.add("fn__none"))}Zt()},sp=t=>{if(t.element.getAttribute("disabled-forever")==="true")return;t.disabled=!1,W()?document.getElementById("toolbarName").removeAttribute("readonly"):(t.wysiwyg.element.setAttribute("contenteditable","true"),t.wysiwyg.element.style.userSelect=""),t.wysiwyg.element.setAttribute("data-readonly","false"),t.title&&t.title.editElement&&(t.title.editElement.setAttribute("contenteditable","true"),t.title.editElement.style.userSelect=""),t.background&&t.background.element.classList.add("protyle-background--enable"),t.wysiwyg.element.querySelectorAll(".render-node .protyle-action__edit").forEach(n=>{n.classList.remove("fn__none"),n.classList.contains("protyle-icon--first")&&n.nextElementSibling?.classList.remove("protyle-icon--first")}),t.wysiwyg.element.querySelectorAll('[contenteditable="false"][spellcheck]').forEach(n=>{L(n,"protyle-wysiwyg__embed")||n.setAttribute("contenteditable","true")}),t.wysiwyg.element.querySelectorAll('.protyle-action[draggable="false"]').forEach(n=>{n.setAttribute("draggable","true")});const e=t.contentElement.getBoundingClientRect();if(t.wysiwyg.element.querySelectorAll(".av").forEach(n=>{n.querySelector(".av__title")&&is(n,e,"all")}),t.breadcrumb){t.breadcrumb.element.parentElement.querySelector('[data-type="readonly"] use').setAttribute("xlink:href","#iconUnlock"),t.breadcrumb.element.parentElement.querySelector('[data-type="readonly"]').setAttribute("aria-label",window.siyuan.config.editor.readOnly?window.siyuan.languages.cancelTempUnlock:window.siyuan.languages.lockEdit);const n=t.breadcrumb.element.parentElement.querySelector('[data-type="undo"]');n&&n.classList.contains("fn__none")&&(n.classList.remove("fn__none"),t.breadcrumb.element.parentElement.querySelector('[data-type="redo"]').classList.remove("fn__none"),t.breadcrumb.element.parentElement.querySelector('[data-type="indent"]').classList.remove("fn__none"),t.breadcrumb.element.parentElement.querySelector('[data-type="outdent"]').classList.remove("fn__none"))}Zt()},Bx=(t,e,n)=>{let a;if(n&&n.focusId?a=t.wysiwyg.element.querySelector(`[data-node-id="${n.focusId}"]`):Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${t.block.id}"]`)).find(s=>{if(!B(s,"data-type","block-render",!0))return a=s,!0}),t.block.mode===4?(Bn(t),a=t.wysiwyg.element.lastElementChild):(!a||e.includes(u.CB_GET_FOCUSFIRST))&&(a=t.wysiwyg.element.firstElementChild),e.includes(u.CB_GET_HL)&&(Bn(t),rf(a)),e.includes(u.CB_GET_FOCUS)||e.includes(u.CB_GET_FOCUSFIRST)){let s;n&&n.focusId?s=na(a,n.focusStart,n.focusEnd):ae(a),e.includes(u.CB_GET_UNUNDO)||ql(t,s,a)}const i=n&&typeof n.scrollTop=="number";if(i&&(t.contentElement.scrollTop=n.scrollTop),t.observerLoad?.disconnect(),e.includes(u.CB_GET_FOCUS)||e.includes(u.CB_GET_SCROLL)||e.includes(u.CB_GET_HL)||e.includes(u.CB_GET_FOCUSFIRST)){const s=t.contentElement.getBoundingClientRect(),o=a.getBoundingClientRect();!i&&(s.top>o.top||s.bottom<o.bottom)&&Ne(t,a,!0)}else return;t.observerLoad=new ResizeObserver(()=>{if(i&&(t.contentElement.scrollTop=n.scrollTop),e.includes(u.CB_GET_FOCUS)||e.includes(u.CB_GET_HL)||e.includes(u.CB_GET_FOCUSFIRST)){const s=t.contentElement.getBoundingClientRect(),o=a.getBoundingClientRect();!i&&(s.top>o.top||s.bottom<o.bottom)&&Ne(t,a,!0)}}),t.observerLoad.observe(t.wysiwyg.element),t.observer.unobserve(t.wysiwyg.element),setTimeout(()=>{t.observerLoad.disconnect(),t.observer.observe(t.wysiwyg.element)},1e3*3),a.isSameNode(t.wysiwyg.element.firstElementChild)&&!i&&t.observerLoad.disconnect()},Av=(t,e)=>{let n=window.siyuan.config.readonly?"true":"false";e?n==="false"&&(n=window.siyuan.config.editor.readOnly?"true":"false",n==="false"&&(n=t.wysiwyg.element.getAttribute(u.CUSTOM_SY_READONLY))):n=t.disabled?"true":"false",n==="true"?Zn(t):sp(t)};let Cv;const qx=(t,e)=>{e.addEventListener("scroll",()=>{const n=e.getBoundingClientRect();if(!t.toolbar.element.classList.contains("fn__none")){const a=t.toolbar.element.getAttribute("data-inity").split(u.ZWSP),i=parseInt(a[0])+(parseInt(a[1])-e.scrollTop);i<n.top-t.toolbar.toolbarHeight||i>n.bottom-t.toolbar.toolbarHeight?t.toolbar.element.style.display="none":(t.toolbar.element.style.top=i+"px",t.toolbar.element.style.display="")}t.wysiwyg.element.querySelectorAll(".av").forEach(a=>{a.dataset.render==="true"&&is(a,n,"all")}),!t.element.classList.contains("block__edit")&&!W()&&t.contentElement.setAttribute("data-scrolltop",e.scrollTop.toString()),window.siyuan.dragElement||Q(["gutterOnly"],t),t.scroll&&!t.scroll.element.classList.contains("fn__none")&&(clearTimeout(Cv),Cv=window.setTimeout(()=>{let a=document.elementFromPoint(n.left+n.width/2,n.top+10);a.classList.contains("protyle-wysiwyg")&&(a=document.elementFromPoint(n.left+n.width/2,n.top+20));const i=P(a);if(!i){if((t.wysiwyg.element.firstElementChild.getAttribute("data-eof")==="1"||t.wysiwyg.element.firstElementChild.getAttribute("data-node-index")==="0")&&(L(a,"protyle-background")||L(a,"protyle-title"))){const s=t.scroll.element.querySelector(".b3-slider");s.value="1",t.scroll.element.setAttribute("aria-label",`Blocks 1/${t.block.blockCount}`)}return}t.scroll.updateIndex(t,i.getAttribute("data-node-id"))},u.TIMEOUT_LOAD)),!(t.wysiwyg.element.getAttribute("data-top")||t.block.showAll||t.scroll&&t.scroll.element.classList.contains("fn__none")||!t.scroll||t.scroll.lastScrollTop===e.scrollTop||t.scroll.lastScrollTop===-1||!t.wysiwyg.element.firstElementChild)&&(t.scroll.lastScrollTop-e.scrollTop>0?e.scrollTop<e.clientHeight&&t.wysiwyg.element.firstElementChild.getAttribute("data-eof")!=="1"&&(t.contentElement.style.width=t.contentElement.offsetWidth+"px",t.contentElement.style.overflow="hidden",t.wysiwyg.element.setAttribute("data-top",e.scrollTop.toString()),E("/api/filetree/getDoc",{id:t.wysiwyg.element.firstElementChild.getAttribute("data-node-id"),mode:1,size:window.siyuan.config.editor.dynamicLoadBlocks},a=>{t.contentElement.style.overflow="",t.contentElement.style.width="",rt({data:a,protyle:t,action:[u.CB_GET_BEFORE,u.CB_GET_UNCHANGEID]})})):e.scrollTop>e.scrollHeight-e.clientHeight*1.8&&t.wysiwyg.element.lastElementChild&&t.wysiwyg.element.lastElementChild.getAttribute("data-eof")!=="2"&&(t.wysiwyg.element.setAttribute("data-top",e.scrollTop.toString()),E("/api/filetree/getDoc",{id:t.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),mode:2,size:window.siyuan.config.editor.dynamicLoadBlocks},a=>{rt({data:a,protyle:t,action:[u.CB_GET_APPEND,u.CB_GET_UNCHANGEID]})})),t.scroll.lastScrollTop=Math.max(e.scrollTop,0))},{capture:!1,passive:!0,once:!1})},Fx=t=>{t.contentElement=document.createElement("div"),t.contentElement.className="protyle-content",(t.options.render.background||t.options.render.title)&&(t.contentElement.innerHTML='<div class="protyle-top"></div>',t.options.render.background&&t.contentElement.firstElementChild.appendChild(t.background.element),t.options.render.title&&t.contentElement.firstElementChild.appendChild(t.title.element)),t.contentElement.appendChild(t.wysiwyg.element),t.options.action.includes(u.CB_GET_HISTORY)||qx(t,t.contentElement),t.element.append(t.contentElement),t.element.appendChild(t.preview.element),t.upload&&t.element.appendChild(t.upload.element),t.options.render.scroll&&t.element.appendChild(t.scroll.element.parentElement),t.gutter&&t.element.appendChild(t.gutter.element),t.element.appendChild(t.hint.element),t.selectElement=document.createElement("div"),t.selectElement.className="protyle-select fn__none",t.element.appendChild(t.selectElement),t.element.appendChild(t.toolbar.element),t.element.appendChild(t.toolbar.subElement),vh(t.toolbar.subElement,()=>{const s=t.toolbar.subElement.querySelector('.block__icons [data-type="pin"]');s&&(s.querySelector("svg use").setAttribute("xlink:href","#iconUnpin"),s.setAttribute("aria-label",window.siyuan.languages.unpin),t.toolbar.subElement.firstElementChild.setAttribute("data-drag","true"))}),t.element.append(t.highlight.styleElement),ho(t),mo(t,t.options.mode),document.execCommand("DefaultParagraphSeparator",!1,"p");let e;const n=K(),a=gt();t.contentElement.addEventListener("mousewheel",s=>{if(!(!window.siyuan.config.editor.fontSizeScrollZoom||a&&!s.metaKey||!a&&!s.ctrlKey||s.deltaX!==0)){if(s.stopPropagation(),s.deltaY<0)if(window.siyuan.config.editor.fontSize<72)window.siyuan.config.editor.fontSize++;else return;else if(s.deltaY>0)if(window.siyuan.config.editor.fontSize>9)window.siyuan.config.editor.fontSize--;else return;Rl(),clearTimeout(e),j(`${window.siyuan.languages.fontSize} ${window.siyuan.config.editor.fontSize}px<span class="fn__space"></span>
<button class="b3-button b3-button--white">${window.siyuan.languages.reset} 16px</button>`,void 0,void 0,n),e=window.setTimeout(()=>{E("/api/setting/setEditor",window.siyuan.config.editor),t.wysiwyg.element.querySelectorAll(".code-block .protyle-linenumber__rows").forEach(o=>{Ol(o.parentElement)}),document.querySelector(`#message [data-id="${n}"] button`)?.addEventListener("click",()=>{window.siyuan.config.editor.fontSize=16,Rl(),E("/api/setting/setEditor",window.siyuan.config.editor),Ue(n),t.wysiwyg.element.querySelectorAll(".code-block .protyle-linenumber__rows").forEach(o=>{Ol(o.parentElement)})})},u.TIMEOUT_LOAD)}},{passive:!0}),t.contentElement.addEventListener("click",s=>{if(t.disabled||t.contentElement.querySelector(".protyle-wysiwyg--select")||!s.target.classList.contains("protyle-content")&&!s.target.classList.contains("protyle-wysiwyg"))return;if(window.getSelection().rangeCount>0){const r=window.getSelection().getRangeAt(0);if(r.toString()!==""&&t.wysiwyg.element.contains(r.startContainer))return}const o=t.wysiwyg.element.lastElementChild.getBoundingClientRect(),l=document.createRange();if(s.y>o.bottom){const r=le(bt(t.wysiwyg.element.lastElementChild));if(!r||t.wysiwyg.element.lastElementChild.getAttribute("data-type")!=="NodeParagraph"&&t.wysiwyg.element.getAttribute("data-doc-type")!=="NodeListItem"&&!t.options.backlinkData||t.wysiwyg.element.lastElementChild.getAttribute("data-type")==="NodeParagraph"&&le(r).innerHTML!==""){const d=pa(!1,!1);t.wysiwyg.element.insertAdjacentElement("beforeend",d),U(t,[{action:"insert",data:d.outerHTML,id:d.getAttribute("data-node-id"),previousID:d.previousElementSibling.getAttribute("data-node-id"),parentID:t.block.parentID}],[{action:"delete",id:d.getAttribute("data-node-id")}]);const c=le(d);l.selectNodeContents(c),l.collapse(!0),Z(l),t.options.render.breadcrumb&&setTimeout(()=>{t.breadcrumb.render(t)},u.TIMEOUT_TRANSITION)}else r&&(l.selectNodeContents(r),l.collapse(!1),Z(l))}});let i=!1;t.element.addEventListener("mouseover",s=>{const o=L(s.target,"protyle-attr");if(o&&!o.parentElement.classList.contains("protyle-title")){const d=t.wysiwyg.element.querySelector(".protyle-wysiwyg--hl");d&&d.classList.remove("protyle-wysiwyg--hl"),i=!0,o.parentElement.classList.add("protyle-wysiwyg--hl");return}else if(i){const d=t.wysiwyg.element.querySelector(".protyle-wysiwyg--hl");d&&d.classList.remove("protyle-wysiwyg--hl"),i=!1}const l=P(s.target);if(t.options.render.gutter&&l){if(l&&(l.classList.contains("list")||l.classList.contains("li")))return;const d=F(l);d?t.gutter.render(t,d,t.wysiwyg.element):t.gutter.render(t,l,t.wysiwyg.element,s.target);return}const r=q(s.target,"BUTTON");if(r&&r.parentElement.classList.contains("protyle-gutters")){const d=r.getAttribute("data-type");if(d==="fold"||d==="NodeAttributeViewRow"){Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl, .av__row--hl")).forEach(c=>{c.classList.remove("protyle-wysiwyg--hl","av__row--hl")});return}Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${r.getAttribute("data-node-id")}"]`)).find(c=>{if(!F(c)&&t.gutter.isMatchNode(c)){const f=c.querySelector(`.av__row[data-id="${r.dataset.rowId}"]`);return Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl, .av__row--hl")).forEach(g=>{c.isSameNode(g)||g.classList.remove("protyle-wysiwyg--hl"),f&&!f.isSameNode(g)&&f.classList.remove("av__row--hl")}),d==="NodeAttributeViewRowMenu"?f.classList.add("av__row--hl"):c.classList.add("protyle-wysiwyg--hl"),!0}}),s.preventDefault();return}if(t.selectElement.classList.contains("fn__none")){const d=B(s.target,"data-node-id",null);if(d&&d.parentElement.classList.contains("protyle-breadcrumb__bar")){t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl").forEach(f=>{f.classList.remove("protyle-wysiwyg--hl")});const c=t.wysiwyg.element.querySelector(`[data-node-id="${d.getAttribute("data-node-id")}"]`);c&&c.classList.add("protyle-wysiwyg--hl")}}})},ho=(t,e)=>{t.element.removeAttribute("data-loading"),setTimeout(()=>{t.element.getAttribute("data-loading")!=="finished"&&t.element.insertAdjacentHTML("beforeend",`<div style="background-color: var(--b3-theme-background);flex-direction: column;" class="fn__loading wysiwygLoading">
    <img width="48px" src="/stage/loading-pure.svg">
    <div style="color: var(--b3-theme-on-surface);margin-top: 8px;">${e||""}</div>
</div>`)},u.TIMEOUT_LOAD)},Ac=t=>{t.element.setAttribute("data-loading","finished"),t.element.querySelectorAll(".wysiwygLoading").forEach(e=>{e.remove()})},Nm=t=>{if(t.options.action.includes(u.CB_GET_HISTORY))return{width:0,padding:0};const e=parseInt(t.wysiwyg.element.style.paddingLeft),n=Tv(t),a=n.left,i=n.right;if(t.options.backlinkData?t.wysiwyg.element.style.padding=`4px ${i}px 4px ${a}px`:t.wysiwyg.element.style.padding=`${n.top}px ${i}px ${n.bottom}px ${a}px`,t.options.render.background&&t.background.element.querySelector(".protyle-background__ia").setAttribute("style",`margin-left:${a}px;margin-right:${i}px`),t.options.render.title&&(t.title.element.style.margin=`16px ${i}px 0 ${a}px`),window.siyuan.config.editor.displayBookmarkIcon){const l=document.getElementById("editorAttr");l&&(l.innerHTML=`.protyle-wysiwyg--attr .b3-tooltips::after { max-width: ${t.wysiwyg.element.clientWidth-a-i}px; }`)}const s=t.wysiwyg.element.getAttribute("data-realwidth"),o=t.wysiwyg.element.clientWidth-parseInt(t.wysiwyg.element.style.paddingLeft)-parseInt(t.wysiwyg.element.style.paddingRight);return t.wysiwyg.element.setAttribute("data-realwidth",o.toString()),{width:Math.abs(parseInt(s)-o),padding:Math.abs(e-parseInt(t.wysiwyg.element.style.paddingLeft))}},Tv=t=>{let e=16,n=24,a=16;if(t.options.typewriterMode&&(W()?a=window.innerHeight/5:a=t.element.clientHeight/2),!W()){let i=t.wysiwyg.element.getAttribute(u.CUSTOM_SY_FULLWIDTH);i||(i=window.siyuan.config.editor.fullWidth?"true":"false");let s=(t.element.clientWidth-u.SIZE_EDITOR_WIDTH)/2;i==="false"&&s>96?(s>u.SIZE_EDITOR_WIDTH&&(s=t.element.clientWidth*.382/1.382),s=Math.ceil(s),n=s,e=s):t.element.clientWidth>u.SIZE_EDITOR_WIDTH&&(n=96,e=96)}return{left:n,right:e,bottom:a,top:16}},op=()=>{Ce().editor.forEach(t=>{if(t.editor&&t.editor.protyle&&t.element.parentElement&&!t.element.classList.contains("fn__none")){t.editor.protyle.wysiwyg.element.querySelector("[data-resize-top]")?.removeAttribute("data-resize-top");const e=t.editor.protyle.contentElement.getBoundingClientRect();let n=document.elementFromPoint(e.left+e.width/2,e.top);if(n||(n=document.elementFromPoint(e.left+e.width/2,e.top+17)),!n||(n=P(n),!n))return;n.setAttribute("data-resize-top",n.getBoundingClientRect().top.toString())}})},Jt=t=>{Q(["gutterOnly"],t);const e=Nm(t),n=4;setTimeout(()=>{if(t.scroll&&t.scroll.element.parentElement.getAttribute("style")&&t.scroll.element.parentElement.setAttribute("style",`--b3-dynamicscroll-width:${Math.min(t.contentElement.clientHeight-49,200)}px`),!t.disabled){const i=t.contentElement.getBoundingClientRect();t.wysiwyg.element.querySelectorAll(".av").forEach(s=>{s.querySelector(".av__title")&&is(s,i,"all")})}(e.width>n||isNaN(e.width))&&typeof window.echarts<"u"&&t.wysiwyg.element.querySelectorAll('[data-subtype="echarts"], [data-subtype="mindmap"]').forEach(i=>{const s=window.echarts.getInstanceById(i.firstElementChild.nextElementSibling.getAttribute("_echarts_instance_"));s&&s.resize()}),t.wysiwyg.element.querySelectorAll(".code-block .protyle-linenumber__rows").forEach(i=>{i.nextElementSibling.style.wordBreak==="break-word"&&Ol(i.parentElement)});const a=t.wysiwyg.element.querySelector("[data-resize-top]");a&&(a.scrollIntoView(),t.contentElement.scrollTop+=a.getBoundingClientRect().top-parseInt(a.getAttribute("data-resize-top")),a.removeAttribute("data-resize-top"))},u.TIMEOUT_TRANSITION+100)},mo=(t,e)=>{if(e==="preview"){if(!t.preview.element.classList.contains("fn__none"))return;t.preview.element.classList.remove("fn__none"),t.contentElement.classList.add("fn__none"),t.scroll?.element.classList.add("fn__none"),t.options.render.breadcrumb&&(t.breadcrumb?.element.classList.add("fn__none"),t.breadcrumb.toggleExit(!0)),t.preview.render(t),ub(Ce(),t,!0)}else if(e==="wysiwyg"){if(!t.contentElement.classList.contains("fn__none"))return;t.preview.element.classList.add("fn__none"),t.contentElement.classList.remove("fn__none"),t.options.render.scroll&&t.scroll?.element.classList.remove("fn__none"),t.options.render.breadcrumb&&(t.breadcrumb?.element.classList.remove("fn__none"),t.breadcrumb.toggleExit(!t.block.showAll)),ub(Ce(),t,!0),Jt(t)}Q(["gutterOnly","toolbar","select","hint","util"],t)},bo=()=>{if(!ve())return;const t=[];ko(window.siyuan.layout.layout,t),t.forEach(async e=>{const n=e.headersElement.parentElement,a=n.getBoundingClientRect(),i=n.querySelector(".item--readonly .fn__flex-1");a.top<=0?(i.style.height=i.parentElement.clientHeight+"px",i.style.WebkitAppRegion="drag"):i.style.WebkitAppRegion="";const s=n.lastElementChild;if(window.siyuan.config.system.os==="darwin"){const o=await ee.ipcRenderer.invoke(u.SIYUAN_GET,{cmd:"isFullScreen"});a.top<=0&&a.left<=0&&!o?(e.headersElement.style.paddingLeft="var(--b3-toolbar-left-mac)",s.style.paddingRight="42px"):(e.headersElement.style.paddingLeft="",s.style.paddingRight="")}a.top<=0&&a.right+8>=window.innerWidth?s.style.paddingRight=42*(window.siyuan.config.system.os==="darwin"?1:4)+"px":s.style.paddingRight=""})},lp=()=>{if(!ve())return;let t="";ba().forEach(e=>{if(e.model)e.model instanceof ht?t+=e.model.editor.protyle.block.rootID+u.ZWSP:e.model instanceof li&&(t+=e.model.path+u.ZWSP);else{const n=e.headElement.getAttribute("data-initdata");if(n){const a=JSON.parse(n);a.instance==="Editor"&&(t+=a.rootId+u.ZWSP)}}}),window.location.hash=t},Cc="auto",Hm=1,Iv=1.1,Dv=.1,$v=10,Rm=0,Ux=1.25,Mv=40,Pv=5,We={INITIAL:0,RUNNING:1,PAUSED:2,FINISHED:3},on={UNKNOWN:0,NORMAL:1,CHANGING:2,FULLSCREEN:3},Me={UNKNOWN:-1,NONE:0,THUMBS:1,OUTLINE:2,ATTACHMENTS:3,LAYERS:4},qa={DISABLE:0,ENABLE:1,ENABLE_PERMISSIONS:2},Te={UNKNOWN:-1,VERTICAL:0,HORIZONTAL:1,WRAPPED:2,PAGE:3},_t={UNKNOWN:-1,NONE:0,ODD:1,EVEN:2},$n={SELECT:0,HAND:1,ZOOM:2},Wx=/\bprint\s*\(/;function Om(t,e,n=!1){let a=t.offsetParent;if(!a){console.error("offsetParent is not set -- cannot scroll");return}let i=t.offsetTop+t.clientTop,s=t.offsetLeft+t.clientLeft;for(;a.clientHeight===a.scrollHeight&&a.clientWidth===a.scrollWidth||n&&(a.classList.contains("markedContent")||getComputedStyle(a).overflow==="hidden");)if(i+=a.offsetTop,s+=a.offsetLeft,a=a.offsetParent,!a)return;e&&(e.top!==void 0&&(i+=e.top),e.left!==void 0&&(s+=e.left,a.scrollLeft=s)),a.scrollTop=i}function Nv(t,e,n=void 0){const a=function(o){s||(s=window.requestAnimationFrame(function(){s=null;const r=t.scrollLeft,d=i.lastX;r!==d&&(i.right=r>d),i.lastX=r;const c=t.scrollTop,f=i.lastY;c!==f&&(i.down=c>f),i.lastY=c,e(i),t.dataset.scrolltop=t.scrollTop}))},i={right:!0,down:!0,lastX:t.scrollLeft,lastY:t.scrollTop,_eventHandler:a};let s=null;return t.addEventListener("scroll",a,{useCapture:!0,signal:n}),n?.addEventListener("abort",()=>window.cancelAnimationFrame(s),{once:!0}),i}function Tc(t){const e=new Map;for(const[n,a]of new URLSearchParams(t))e.set(n.toLowerCase(),a);return e}const Hv=/[\x00-\x1F]/g;function Fl(t,e=!1){return Hv.test(t)?e?t.replaceAll(Hv,n=>n==="\0"?"":" "):t.replaceAll("\0",""):t}function Ic(t,e,n=0){let a=n,i=t.length-1;if(i<0||!e(t[i]))return t.length;if(e(t[a]))return a;for(;a<i;){const s=a+i>>1,o=t[s];e(o)?i=s:a=s+1}return a}function Rv(t){if(Math.floor(t)===t)return[t,1];const e=1/t,n=8;if(e>n)return[1,n];if(Math.floor(e)===e)return[1,e];const a=t>1?e:t;let i=0,s=1,o=1,l=1;for(;;){const d=i+o,c=s+l;if(c>n)break;a<=d/c?(o=d,l=c):(i=d,s=c)}let r;return a-i/s<o/l-a?r=a===t?[i,s]:[s,i]:r=a===t?[o,l]:[l,o],r}function rp(t,e){return t-t%e}function Yx({view:t,userUnit:e,rotate:n}){const[a,i,s,o]=t,l=n%180!==0,r=(s-a)/72*e,d=(o-i)/72*e;return{width:l?d:r,height:l?r:d}}function zx(t,e,n){if(t<2)return t;let a=e[t].div,i=a.offsetTop+a.clientTop;i>=n&&(a=e[t-1].div,i=a.offsetTop+a.clientTop);for(let s=t-2;s>=0&&(a=e[s].div,!(a.offsetTop+a.clientTop+a.clientHeight<=i));--s)t=s;return t}function Ov({scrollEl:t,views:e,sortByVisibility:n=!1,horizontal:a=!1,rtl:i=!1}){const s=t.scrollTop,o=s+t.clientHeight,l=t.scrollLeft,r=l+t.clientWidth;function d(w){const _=w.div;return _.offsetTop+_.clientTop+_.clientHeight>s}function c(w){const _=w.div,x=_.offsetLeft+_.clientLeft,S=x+_.clientWidth;return i?x<r:S>l}const f=[],g=new Set,p=e.length;let h=Ic(e,a?c:d);h>0&&h<p&&!a&&(h=zx(h,e,s));let m=a?r:-1;for(let w=h;w<p;w++){const _=e[w],x=_.div,S=x.offsetLeft+x.clientLeft,k=x.offsetTop+x.clientTop,A=x.clientWidth,$=x.clientHeight,M=S+A,C=k+$;if(m===-1)C>=o&&(m=C);else if((a?S:k)>m)break;if(C<=s||k>=o||M<=l||S>=r)continue;const N=Math.max(0,s-k)+Math.max(0,C-o),O=Math.max(0,l-S)+Math.max(0,M-r),te=($-N)/$,ne=(A-O)/A,oe=te*ne*100|0;f.push({id:_.id,x:S,y:k,view:_,percent:oe,widthPercent:ne*100|0}),g.add(_.id)}const b=f[0],y=f.at(-1);return n&&f.sort(function(w,_){const x=w.percent-_.percent;return Math.abs(x)>.001?-x:w.id-_.id}),{first:b,last:y,views:f,ids:g}}function Bv(t){let e=Math.hypot(t.deltaX,t.deltaY);const n=Math.atan2(t.deltaY,t.deltaX);return-.25*Math.PI<n&&n<.75*Math.PI&&(e=-e),e}function Vx(t){const e=t.deltaMode;let n=Bv(t);const a=30,i=30;return e===WheelEvent.DOM_DELTA_PIXEL?n/=a*i:e===WheelEvent.DOM_DELTA_LINE&&(n/=i),n}function cp(t){return Number.isInteger(t)&&t%90===0}function qv(t){return Number.isInteger(t)&&Object.values(Te).includes(t)&&t!==Te.UNKNOWN}function Fv(t){return Number.isInteger(t)&&Object.values(_t).includes(t)&&t!==_t.UNKNOWN}function Bm(t){return t.width<=t.height}const Gx=new Promise(function(t){if(typeof PDFJSDev<"u"&&PDFJSDev.test("LIB")&&typeof window>"u"){setTimeout(t,20);return}window.requestAnimationFrame(t)}),Uv=typeof PDFJSDev<"u"&&PDFJSDev.test("LIB")&&typeof document>"u"?null:document.documentElement.style;function jx(t,e,n){return Math.min(Math.max(t,e),n)}class Kx{constructor(e){D(this,ms,null);D(this,Do,null);D(this,bs,0);D(this,Zl,null);D(this,$o,!0);R(this,ms,e.classList),R(this,Zl,e.style)}get percent(){return v(this,bs)}set percent(e){if(R(this,bs,jx(e,0,100)),isNaN(e)){v(this,ms).add("indeterminate");return}v(this,ms).remove("indeterminate"),v(this,Zl).setProperty("--progressBar-percent",`${v(this,bs)}%`)}setWidth(e){if(!e)return;const a=e.parentNode.offsetWidth-e.offsetWidth;a>0&&v(this,Zl).setProperty("--progressBar-end-offset",`${a}px`)}setDisableAutoFetch(e=5e3){v(this,bs)===100||isNaN(v(this,bs))||(v(this,Do)&&clearTimeout(v(this,Do)),this.show(),R(this,Do,setTimeout(()=>{R(this,Do,null),this.hide()},e)))}hide(){v(this,$o)&&(R(this,$o,!1),v(this,ms).add("fn__hidden"))}show(){v(this,$o)||(R(this,$o,!0),v(this,ms).remove("fn__hidden"))}}ms=new WeakMap,Do=new WeakMap,bs=new WeakMap,Zl=new WeakMap,$o=new WeakMap;function Zx(){let t=document,e=t.activeElement||t.querySelector(":focus");for(;e?.shadowRoot;)t=e.shadowRoot,e=t.activeElement||t.querySelector(":focus");return e}function Wv(t){let e=Te.VERTICAL,n=_t.NONE;switch(t){case"SinglePage":e=Te.PAGE;break;case"OneColumn":break;case"TwoPageLeft":e=Te.PAGE;case"TwoColumnLeft":n=_t.ODD;break;case"TwoPageRight":e=Te.PAGE;case"TwoColumnRight":n=_t.EVEN;break}return{scrollMode:e,spreadMode:n}}function Jx(t){switch(t){case"UseNone":return Me.NONE;case"UseThumbs":return Me.THUMBS;case"UseOutlines":return Me.OUTLINE;case"UseAttachments":return Me.ATTACHMENTS;case"UseOC":return Me.LAYERS}return Me.NONE}function Jn(t,e,n=null){t.classList.toggle("toggled",e),t.setAttribute("aria-checked",e),n?.classList.toggle("fn__hidden",!e)}function oi(t,e,n=null){t.classList.toggle("toggled",e),t.setAttribute("aria-expanded",e),n?.classList.toggle("fn__hidden",!e)}const dp=typeof PDFJSDev<"u"&&PDFJSDev.test("MOZCENTRAL")?Math.fround:function(){if(typeof PDFJSDev<"u"&&PDFJSDev.test("LIB")&&typeof document>"u")return e=>e;const t=document.createElement("div");return t.style.width="round(down, calc(1.6666666666666665 * 792px), 1px)",t.style.width==="calc(1320px)"?Math.fround:e=>e}();if(typeof PDFJSDev>"u"||PDFJSDev.test("GENERIC")){var yo=new Map;typeof PDFJSDev<"u"&&PDFJSDev.test("LIB")&&typeof navigator>"u"&&(globalThis.navigator=Object.create(null));const t=navigator.userAgent||"",e=navigator.platform||"",n=navigator.maxTouchPoints||1,a=/Android/.test(t),i=/\b(iPad|iPhone|iPod)(?=;)/.test(t)||e==="MacIntel"&&n>1;(function(){(i||a)&&yo.set("maxCanvasPixels",5242880)})(),function(){a&&yo.set("useSystemFonts",!1)}()}const V={BROWSER:1,VIEWER:2,API:4,WORKER:8,EVENT_DISPATCH:16,PREFERENCE:128},qm={BOOLEAN:1,NUMBER:2,OBJECT:4,STRING:8,UNDEFINED:16},Xn={allowedGlobalEvents:{value:null,kind:V.BROWSER},canvasMaxAreaInBytes:{value:-1,kind:V.BROWSER+V.API},isInAutomation:{value:!1,kind:V.BROWSER},localeProperties:{value:typeof PDFJSDev>"u"||PDFJSDev.test("GENERIC")?{lang:navigator.language||"en-US"}:null,kind:V.BROWSER},nimbusDataStr:{value:"",kind:V.BROWSER},supportsCaretBrowsingMode:{value:!1,kind:V.BROWSER},supportsDocumentFonts:{value:!0,kind:V.BROWSER},supportsIntegratedFind:{value:!1,kind:V.BROWSER},supportsMouseWheelZoomCtrlKey:{value:!0,kind:V.BROWSER},supportsMouseWheelZoomMetaKey:{value:!0,kind:V.BROWSER},supportsPinchToZoom:{value:!0,kind:V.BROWSER},toolbarDensity:{value:0,kind:V.BROWSER+V.EVENT_DISPATCH},altTextLearnMoreUrl:{value:typeof PDFJSDev<"u"&&PDFJSDev.test("MOZCENTRAL")?"https://support.mozilla.org/1/firefox/%VERSION%/%OS%/%LOCALE%/pdf-alt-text":"",kind:V.VIEWER+V.PREFERENCE},annotationEditorMode:{value:0,kind:V.VIEWER+V.PREFERENCE},annotationMode:{value:2,kind:V.VIEWER+V.PREFERENCE},cursorToolOnLoad:{value:0,kind:V.VIEWER+V.PREFERENCE},debuggerSrc:{value:"./debugger.mjs",kind:V.VIEWER},defaultZoomDelay:{value:400,kind:V.VIEWER+V.PREFERENCE},defaultZoomValue:{value:"",kind:V.VIEWER+V.PREFERENCE},disableHistory:{value:!1,kind:V.VIEWER},disablePageLabels:{value:!1,kind:V.VIEWER+V.PREFERENCE},enableAltText:{value:!1,kind:V.VIEWER+V.PREFERENCE},enableAltTextModelDownload:{value:!0,kind:V.VIEWER+V.PREFERENCE+V.EVENT_DISPATCH},enableGuessAltText:{value:!0,kind:V.VIEWER+V.PREFERENCE+V.EVENT_DISPATCH},enableHighlightFloatingButton:{value:typeof PDFJSDev>"u"||PDFJSDev.test("TESTING"),kind:V.VIEWER+V.PREFERENCE},enableNewAltTextWhenAddingImage:{value:!0,kind:V.VIEWER+V.PREFERENCE},enablePermissions:{value:!1,kind:V.VIEWER+V.PREFERENCE},enablePrintAutoRotate:{value:!0,kind:V.VIEWER+V.PREFERENCE},enableScripting:{value:typeof PDFJSDev>"u"||!PDFJSDev.test("CHROME"),kind:V.VIEWER+V.PREFERENCE},enableUpdatedAddImage:{value:!1,kind:V.VIEWER+V.PREFERENCE},externalLinkRel:{value:"noopener noreferrer nofollow",kind:V.VIEWER},externalLinkTarget:{value:0,kind:V.VIEWER+V.PREFERENCE},highlightEditorColors:{value:"yellow=#FFFF98,green=#53FFBC,blue=#80EBFF,pink=#FFCBE6,red=#FF4F5F",kind:V.VIEWER+V.PREFERENCE},historyUpdateUrl:{value:!1,kind:V.VIEWER+V.PREFERENCE},ignoreDestinationZoom:{value:!1,kind:V.VIEWER+V.PREFERENCE},imageResourcesPath:{value:typeof PDFJSDev<"u"&&PDFJSDev.test("MOZCENTRAL")?"resource://pdf.js/web/images/":"./images/",kind:V.VIEWER},maxCanvasPixels:{value:2**25,kind:V.VIEWER},forcePageColors:{value:!1,kind:V.VIEWER+V.PREFERENCE},pageColorsBackground:{value:"Canvas",kind:V.VIEWER+V.PREFERENCE},pageColorsForeground:{value:"CanvasText",kind:V.VIEWER+V.PREFERENCE},pdfBugEnabled:{value:typeof PDFJSDev>"u"||PDFJSDev.test("TESTING"),kind:V.VIEWER+V.PREFERENCE},printResolution:{value:150,kind:V.VIEWER},sidebarViewOnLoad:{value:-1,kind:V.VIEWER+V.PREFERENCE},scrollModeOnLoad:{value:-1,kind:V.VIEWER+V.PREFERENCE},spreadModeOnLoad:{value:-1,kind:V.VIEWER+V.PREFERENCE},textLayerMode:{value:1,kind:V.VIEWER+V.PREFERENCE},viewOnLoad:{value:0,kind:V.VIEWER+V.PREFERENCE},cMapPacked:{value:!0,kind:V.API},cMapUrl:{value:typeof PDFJSDev>"u"?"../external/bcmaps/":PDFJSDev.test("MOZCENTRAL")?"resource://pdf.js/web/cmaps/":"../web/cmaps/",kind:V.API},disableAutoFetch:{value:!1,kind:V.API+V.PREFERENCE},disableFontFace:{value:!1,kind:V.API+V.PREFERENCE},disableRange:{value:!1,kind:V.API+V.PREFERENCE},disableStream:{value:!1,kind:V.API+V.PREFERENCE},docBaseUrl:{value:typeof PDFJSDev>"u"?document.URL.split("#",1)[0]:"",kind:V.API},enableHWA:{value:typeof PDFJSDev<"u"&&!PDFJSDev.test("MOZCENTRAL"),kind:V.API+V.VIEWER+V.PREFERENCE},enableXfa:{value:!0,kind:V.API+V.PREFERENCE},fontExtraProperties:{value:!1,kind:V.API},isEvalSupported:{value:!0,kind:V.API},isOffscreenCanvasSupported:{value:!0,kind:V.API},maxImageSize:{value:-1,kind:V.API},pdfBug:{value:!1,kind:V.API},standardFontDataUrl:{value:typeof PDFJSDev>"u"?"../external/standard_fonts/":PDFJSDev.test("MOZCENTRAL")?"resource://pdf.js/web/standard_fonts/":"../web/standard_fonts/",kind:V.API},useSystemFonts:{value:(typeof PDFJSDev>"u"?window.isGECKOVIEW:PDFJSDev.test("GECKOVIEW"))?!1:void 0,kind:V.API,type:qm.BOOLEAN+qm.UNDEFINED},verbosity:{value:1,kind:V.API},workerPort:{value:null,kind:V.WORKER},workerSrc:{value:typeof PDFJSDev>"u"?"../src/pdf.worker.js":PDFJSDev.test("MOZCENTRAL")?"resource://pdf.js/build/pdf.worker.mjs":"../build/pdf.worker.mjs",kind:V.WORKER}};if((typeof PDFJSDev>"u"||!PDFJSDev.test("MOZCENTRAL"))&&(Xn.defaultUrl={value:typeof PDFJSDev<"u"&&PDFJSDev.test("CHROME")?"":"compressed.tracemonkey-pldi-09.pdf",kind:V.VIEWER},Xn.sandboxBundleSrc={value:typeof PDFJSDev>"u"?"../build/dev-sandbox/pdf.sandbox.mjs":"../build/pdf.sandbox.mjs",kind:V.VIEWER},Xn.viewerCssTheme={value:typeof PDFJSDev<"u"&&PDFJSDev.test("CHROME")?2:0,kind:V.VIEWER+V.PREFERENCE},Xn.enableFakeMLManager={value:!0,kind:V.VIEWER}),typeof PDFJSDev>"u"||PDFJSDev.test("GENERIC")?Xn.disablePreferences={value:typeof PDFJSDev<"u"&&PDFJSDev.test("TESTING"),kind:V.VIEWER}:PDFJSDev.test("CHROME")&&(Xn.disableTelemetry={value:!1,kind:V.VIEWER+V.PREFERENCE}),typeof PDFJSDev>"u"||PDFJSDev.test("TESTING || LIB"))for(const t in Xn){const{value:e,kind:n,type:a}=Xn[t];if(n&V.PREFERENCE){if(n===V.PREFERENCE)throw new Error(`Cannot use only "PREFERENCE" kind: ${t}`);if(n&V.BROWSER)throw new Error(`Cannot mix "PREFERENCE" and "BROWSER" kind: ${t}`);if(a!==void 0)throw new Error(`Cannot have \`type\`-field for "PREFERENCE" kind: ${t}`);if(typeof yo=="object"&&yo.has(t))throw new Error(`Should not have compatibility-value for "PREFERENCE" kind: ${t}`);if(typeof e!="boolean"&&typeof e!="string"&&!Number.isInteger(e))throw new Error(`Invalid value for "PREFERENCE" kind: ${t}`)}else if(n&V.BROWSER){if(a!==void 0)throw new Error(`Cannot have \`type\`-field for "BROWSER" kind: ${t}`);if(typeof yo=="object"&&yo.has(t))throw new Error(`Should not have compatibility-value for "BROWSER" kind: ${t}`);if(e===void 0)throw new Error(`Invalid value for "BROWSER" kind: ${t}`)}}const ws=class{constructor(){if(typeof PDFJSDev>"u"||PDFJSDev.test("TESTING"))throw new Error("Cannot initialize AppOptions.")}static get(e){return v(this,ys).get(e)}static getAll(e=null,n=!1){const a=Object.create(null);for(const i in Xn){const s=Xn[i];e&&!(e&s.kind)||(a[i]=n?s.value:v(this,ys).get(i))}return a}static set(e,n){this.setAll({[e]:n})}static setAll(e,n=!1){(typeof PDFJSDev>"u"||PDFJSDev.test("GENERIC"))&&(this._hasInvokedSet||=!0);let a;for(const i in e){const s=Xn[i],o=e[i];if(!s||!(typeof o==typeof s.value||qm[(typeof o).toUpperCase()]&s.type))continue;const{kind:l}=s;n&&!(l&V.BROWSER||l&V.PREFERENCE)||(this.eventBus&&l&V.EVENT_DISPATCH&&(a||=new Map).set(i,o),v(this,ys).set(i,o))}if(a)for(const[i,s]of a)this.eventBus.dispatch(i.toLowerCase(),{source:this,value:s})}};let se=ws;ys=new WeakMap,qu(se,"eventBus"),D(se,ys,new Map),(()=>{for(const e in Xn)v(ws,ys).set(e,Xn[e].value);if(typeof PDFJSDev>"u"||PDFJSDev.test("GENERIC")){for(const[e,n]of yo)v(ws,ys).set(e,n);ws._hasInvokedSet=!1,ws._checkDisablePreferences=()=>ws.get("disablePreferences")?!0:(ws._hasInvokedSet&&console.warn('The Preferences may override manually set AppOptions; please use the "disablePreferences"-option to prevent that.'),!1)}})();const Xx="noopener noreferrer nofollow",$i={NONE:0,SELF:1,BLANK:2,PARENT:3,TOP:4},Bb=class{constructor({eventBus:e,externalLinkTarget:n=null,externalLinkRel:a=null,ignoreDestinationZoom:i=!1}={}){qu(this,"externalLinkEnabled",!0);this.eventBus=e,this.externalLinkTarget=n,this.externalLinkRel=a,this._ignoreDestinationZoom=i,this.baseUrl=null,this.pdfDocument=null,this.pdfViewer=null,this.pdfHistory=null}setDocument(e,n=null){this.baseUrl=n,this.pdfDocument=e}setViewer(e){this.pdfViewer=e}setHistory(e){this.pdfHistory=e}get pagesCount(){return this.pdfDocument?this.pdfDocument.numPages:0}get page(){return this.pdfDocument?this.pdfViewer.currentPageNumber:1}set page(e){this.pdfDocument&&(this.pdfViewer.currentPageNumber=e)}get rotation(){return this.pdfDocument?this.pdfViewer.pagesRotation:0}set rotation(e){this.pdfDocument&&(this.pdfViewer.pagesRotation=e)}get isInPresentationMode(){return this.pdfDocument?this.pdfViewer.isInPresentationMode:!1}async goToDestination(e){if(!this.pdfDocument)return;let n,a,i;if(typeof e=="string"?(n=e,a=await this.pdfDocument.getDestination(e)):(n=null,a=await e),!Array.isArray(a)){console.error(`goToDestination: "${a}" is not a valid destination array, for dest="${e}".`);return}const[s]=a;if(s&&typeof s=="object"){if(i=this.pdfDocument.cachedPageNumber(s),!i)try{i=await this.pdfDocument.getPageIndex(s)+1}catch{console.error(`goToDestination: "${s}" is not a valid page reference, for dest="${e}".`);return}}else Number.isInteger(s)&&(i=s+1);if(!i||i<1||i>this.pagesCount){console.error(`goToDestination: "${i}" is not a valid page number, for dest="${e}".`);return}this.pdfHistory&&(this.pdfHistory.pushCurrentPosition(),this.pdfHistory.push({namedDest:n,explicitDest:a,pageNumber:i})),this.pdfViewer.scrollPageIntoView({pageNumber:i,destArray:a,ignoreDestinationZoom:this._ignoreDestinationZoom})}goToPage(e){if(!this.pdfDocument)return;const n=typeof e=="string"&&this.pdfViewer.pageLabelToPageNumber(e)||e|0;if(!(Number.isInteger(n)&&n>0&&n<=this.pagesCount)){console.error(`PDFLinkService.goToPage: "${e}" is not a valid page.`);return}this.pdfHistory&&(this.pdfHistory.pushCurrentPosition(),this.pdfHistory.pushPage(n)),this.pdfViewer.scrollPageIntoView({pageNumber:n})}addLinkAttributes(e,n,a=!1){if(!n||typeof n!="string")throw new Error('A valid "url" parameter must provided.');const i=a?$i.BLANK:this.externalLinkTarget,s=this.externalLinkRel;this.externalLinkEnabled?e.href=e.title=n:(e.href="",e.title=`Disabled: ${n}`,e.onclick=()=>!1);let o="";switch(i){case $i.NONE:break;case $i.SELF:o="_self";break;case $i.BLANK:o="_blank";break;case $i.PARENT:o="_parent";break;case $i.TOP:o="_top";break}e.target=o,e.rel=typeof s=="string"?s:Xx}getDestinationHash(e){if(typeof e=="string"){if(e.length>0)return this.getAnchorUrl("#"+escape(e))}else if(Array.isArray(e)){const n=JSON.stringify(e);if(n.length>0)return this.getAnchorUrl("#"+escape(n))}return this.getAnchorUrl("")}getAnchorUrl(e){return this.baseUrl?this.baseUrl+e:e}setHash(e){var i;if(!this.pdfDocument)return;let n,a;if(e.includes("=")){const s=Tc(e);if(s.has("search")){const o=s.get("search").replaceAll('"',""),l=s.get("phrase")==="true";this.eventBus.dispatch("findfromurlhash",{source:this,query:l?o:o.match(/\S+/g)})}if(s.has("page")&&(n=s.get("page")|0||1),s.has("zoom")){const o=s.get("zoom").split(","),l=o[0],r=parseFloat(l);l.includes("Fit")?l==="Fit"||l==="FitB"?a=[null,{name:l}]:l==="FitH"||l==="FitBH"||l==="FitV"||l==="FitBV"?a=[null,{name:l},o.length>1?o[1]|0:null]:l==="FitR"?o.length!==5?console.error('PDFLinkService.setHash: Not enough parameters for "FitR".'):a=[null,{name:l},o[1]|0,o[2]|0,o[3]|0,o[4]|0]:console.error(`PDFLinkService.setHash: "${l}" is not a valid zoom value.`):a=[null,{name:"XYZ"},o.length>1?o[1]|0:null,o.length>2?o[2]|0:null,r?r/100:l]}if(a?this.pdfViewer.scrollPageIntoView({pageNumber:n||this.page,destArray:a,allowNegativeOffset:!0}):n&&(this.page=n),s.has("pagemode")&&this.eventBus.dispatch("pagemode",{source:this,mode:s.get("pagemode")}),s.has("nameddest")&&this.goToDestination(s.get("nameddest")),typeof PDFJSDev>"u"||!PDFJSDev.test("MOZCENTRAL")||!s.has("filename")||!s.has("filedest"))return;e=s.get("filedest")}a=unescape(e);try{a=JSON.parse(a),Array.isArray(a)||(a=a.toString())}catch{}if(typeof a=="string"||I(i=Bb,Bp,kk).call(i,a)){this.goToDestination(a);return}console.error(`PDFLinkService.setHash: "${unescape(e)}" is not a valid destination.`)}executeNamedAction(e){if(this.pdfDocument){switch(e){case"GoBack":this.pdfHistory?.back();break;case"GoForward":this.pdfHistory?.forward();break;case"NextPage":this.pdfViewer.nextPage();break;case"PrevPage":this.pdfViewer.previousPage();break;case"LastPage":this.page=this.pagesCount;break;case"FirstPage":this.page=1;break;default:break}this.eventBus.dispatch("namedaction",{source:this,action:e})}}async executeSetOCGState(e){if(!this.pdfDocument)return;const n=this.pdfDocument,a=await this.pdfViewer.optionalContentConfigPromise;n===this.pdfDocument&&(a.setOCGState(e),this.pdfViewer.optionalContentConfigPromise=Promise.resolve(a))}};let Dc=Bb;Bp=new WeakSet,kk=function(e){if(!Array.isArray(e)||e.length<2)return!1;const[n,a,...i]=e;if(!(typeof n=="object"&&Number.isInteger(n?.num)&&Number.isInteger(n?.gen))&&!Number.isInteger(n)||!(typeof a=="object"&&typeof a?.name=="string"))return!1;const s=i.length;let o=!0;switch(a.name){case"XYZ":if(s<2||s>3)return!1;break;case"Fit":case"FitB":return s===0;case"FitH":case"FitBH":case"FitV":case"FitBV":if(s>1)return!1;break;case"FitR":if(s!==4)return!1;o=!1;break;default:return!1}for(const l of i)if(!(typeof l=="number"||o&&l===null))return!1;return!0},D(Dc,Bp);class Fm extends Dc{setDocument(e,n=null){}}var G=Ze(119);const Yv={EVENT:"event",TIMEOUT:"timeout"};async function zv({target:t,name:e,delay:n=0}){if(typeof t!="object"||!(e&&typeof e=="string")||!(Number.isInteger(n)&&n>=0))throw new Error("waitOnEventOrTimeout - invalid parameters.");const{promise:a,resolve:i}=Promise.withResolvers(),s=new AbortController;function o(d){s.abort(),clearTimeout(r),i(d)}const l=t instanceof Um?"_on":"addEventListener";t[l](e,o.bind(null,Yv.EVENT),{signal:s.signal});const r=setTimeout(o.bind(null,Yv.TIMEOUT),n);return a}class Um{constructor(){D(this,Jl,Object.create(null))}on(e,n,a=null){this._on(e,n,{external:!0,once:a?.once,signal:a?.signal})}off(e,n,a=null){this._off(e,n)}dispatch(e,n){const a=v(this,Jl)[e];if(!a||a.length===0)return;let i;for(const{listener:s,external:o,once:l}of a.slice(0)){if(l&&this._off(e,s),o){(i||=[]).push(s);continue}s(n)}if(i){for(const s of i)s(n);i=null}}_on(e,n,a=null){let i=null;if(a?.signal instanceof AbortSignal){const{signal:o}=a;if(o.aborted){console.error("Cannot use an `aborted` signal.");return}const l=()=>this._off(e,n);i=()=>o.removeEventListener("abort",l),o.addEventListener("abort",l)}(v(this,Jl)[e]||=[]).push({listener:n,external:a?.external===!0,once:a?.once===!0,rmAbort:i})}_off(e,n,a=null){const i=v(this,Jl)[e];if(i)for(let s=0,o=i.length;s<o;s++){const l=i[s];if(l.listener===n){l.rmAbort?.(),i.splice(s,1);return}}}}Jl=new WeakMap;class Qx extends Um{constructor(n,a,i){super();D(this,Gc,void 0);D(this,jc,void 0);D(this,Kc,void 0);R(this,jc,n),R(this,Gc,a),R(this,Kc,i)}dispatch(n,a){if(typeof PDFJSDev<"u"&&!PDFJSDev.test("MOZCENTRAL"))throw new Error("Not implemented: FirefoxEventBus.dispatch");if(super.dispatch(n,a),v(this,Kc)){const i=Object.create(null);if(a)for(const o in a){const l=a[o];if(o==="source"){if(l===window||l===document)return;continue}i[o]=l}const s=new CustomEvent(n,{bubbles:!0,cancelable:!0,detail:i});document.dispatchEvent(s)}v(this,jc)?.has(n)&&v(this,Gc).dispatchGlobalEvent({eventName:n,detail:a})}}Gc=new WeakMap,jc=new WeakMap,Kc=new WeakMap;class Wm{constructor(){if((typeof PDFJSDev>"u"||PDFJSDev.test("TESTING"))&&this.constructor===Wm)throw new Error("Cannot initialize BaseExternalServices.")}updateFindControlState(e){}updateFindMatchesCount(e){}initPassiveLoading(){}reportTelemetry(e){}async createL10n(){throw new Error("Not implemented: createL10n")}createScripting(){throw new Error("Not implemented: createScripting")}updateEditorStates(e){throw new Error("Not implemented: updateEditorStates")}dispatchGlobalEvent(e){}}const qb=class{constructor(){D(this,Mo,Object.freeze(typeof PDFJSDev>"u"?se.getAll(V.PREFERENCE,!0):PDFJSDev.eval("DEFAULT_PREFERENCES")));D(this,Ri,null);if((typeof PDFJSDev>"u"||PDFJSDev.test("TESTING"))&&this.constructor===qb)throw new Error("Cannot initialize BasePreferences.");typeof PDFJSDev<"u"&&PDFJSDev.test("CHROME")&&Object.defineProperty(this,"defaults",{get(){return v(this,Mo)}}),R(this,Ri,this._readFromStorage(v(this,Mo)).then(({browserPrefs:e,prefs:n})=>{(typeof PDFJSDev>"u"||PDFJSDev.test("GENERIC"))&&se._checkDisablePreferences()||se.setAll({...e,...n},!0)})),typeof PDFJSDev<"u"&&PDFJSDev.test("MOZCENTRAL")&&window.addEventListener("updatedPreference",async({detail:{name:e,value:n}})=>{await v(this,Ri),se.setAll({[e]:n},!0)})}async _writeToStorage(e){throw new Error("Not implemented: _writeToStorage")}async _readFromStorage(e){throw new Error("Not implemented: _readFromStorage")}async reset(){if(typeof PDFJSDev<"u"&&PDFJSDev.test("MOZCENTRAL"))throw new Error("Please use `about:config` to change preferences.");await v(this,Ri),se.setAll(v(this,Mo),!0),await this._writeToStorage(v(this,Mo))}async set(e,n){await v(this,Ri),se.setAll({[e]:n},!0),await this._writeToStorage(typeof PDFJSDev<"u"&&PDFJSDev.test("MOZCENTRAL")?{[e]:se.get(e)}:se.getAll(V.PREFERENCE))}async get(e){if(typeof PDFJSDev<"u"&&PDFJSDev.test("MOZCENTRAL"))throw new Error("Not implemented: get");return await v(this,Ri),se.get(e)}get initializedPromise(){return v(this,Ri)}};let Ym=qb;Mo=new WeakMap,Ri=new WeakMap;const Up=class{constructor({lang:e,isRTL:n},a=null){D(this,Zc,void 0);D(this,Xl,new Set);D(this,Ql,void 0);D(this,Yn,void 0);var i,s;R(this,Ql,I(i=Up,qp,Sk).call(i,e)),R(this,Yn,a),R(this,Zc,n??I(s=Up,Fp,Lk).call(s,v(this,Ql))?"rtl":"ltr")}_setL10n(e){R(this,Yn,e),typeof PDFJSDev<"u"&&PDFJSDev.test("TESTING")&&(document.l10n=e)}getLanguage(){return v(this,Ql)}getDirection(){return v(this,Zc)}async get(e,n=null,a){return Array.isArray(e)?(e=e.map(o=>({id:o})),(await v(this,Yn).formatMessages(e)).map(o=>o.value)):(await v(this,Yn).formatMessages([{id:e,args:n}]))[0]?.value||a}async translate(e){v(this,Xl).add(e);try{v(this,Yn).connectRoot(e),await v(this,Yn).translateRoots()}catch{}}async translateOnce(e){try{await v(this,Yn).translateElements([e])}catch(n){console.error(`translateOnce: "${n}".`)}}async destroy(){for(const e of v(this,Xl))v(this,Yn).disconnectRoot(e);v(this,Xl).clear(),v(this,Yn).pauseObserving()}pause(){v(this,Yn).pauseObserving()}resume(){v(this,Yn).resumeObserving()}};let $c=Up;Zc=new WeakMap,Xl=new WeakMap,Ql=new WeakMap,Yn=new WeakMap,qp=new WeakSet,Sk=function(e){return e=e?.toLowerCase()||"en-us",{en:"en-us",es:"es-es",fy:"fy-nl",ga:"ga-ie",gu:"gu-in",hi:"hi-in",hy:"hy-am",nb:"nb-no",ne:"ne-np",nn:"nn-no",pa:"pa-in",pt:"pt-pt",sv:"sv-se",zh:"zh-cn"}[e]||e},Fp=new WeakSet,Lk=function(e){const n=e.split("-",1)[0];return["ar","he","fa","ps","ur"].includes(n)},D($c,qp),D($c,Fp);const C0=null;class eA extends $c{constructor(e){super({lang:e}),this._setL10n({formatMessages:n=>new Promise(a=>{let i=window.siyuan.languages[n[0].id]||n[0].id;n[0].args&&Object.keys(n[0].args).forEach(s=>{i=i.replace("${"+s+"}",n[0].args[s])}),a([{value:i}])}),connectRoot:()=>{},translateRoots:()=>{},translateElements:()=>{},disconnectRoot:()=>{},pauseObserving:()=>{},resumeObserving:()=>{}})}}async function T0(t){const e="",n=e.split("#",1)[0];let{info:a,metadata:i,contentDispositionFilename:s,contentLength:o}=await t.getMetadata();if(!o){const{length:l}=await t.getDownloadInfo();o=l}return{...a,baseURL:n,filesize:o,filename:s||getPdfFilenameFromUrl(e),metadata:i?.getRaw(),authors:i?.get("dc:creator"),numPages:t.numPages,URL:e}}class tA{constructor(e){this._ready=new Promise((n,a)=>{})}async createSandbox(e){(await this._ready).create(e)}async dispatchEventInSandbox(e){const n=await this._ready;setTimeout(()=>n.dispatchEvent(e),0)}async destroySandbox(){(await this._ready).nukeSandbox()}}if(typeof PDFJSDev<"u"&&!PDFJSDev.test("GENERIC"))throw new Error('Module "pdfjs-web/genericcom" shall not be used outside GENERIC build.');function I0(t){}class nA extends Ym{async _writeToStorage(e){localStorage.setItem("pdfjs.preferences",JSON.stringify(e))}async _readFromStorage(e){return{prefs:JSON.parse(localStorage.getItem("pdfjs.preferences"))}}}class aA extends Wm{async createL10n(){return new eA(se.get("localeProperties")?.lang)}createScripting(){return new tA(se.get("sandboxBundleSrc"))}}class Vv{async isEnabledFor(e){return!1}async deleteModel(e){return null}isReady(e){return!1}guess(e){}toggleService(e,n){}static getFakeMLManager(e){return new iA(e)}}class iA{constructor({enableGuessAltText:e,enableAltTextModelDownload:n}){qu(this,"eventBus",null);qu(this,"hasProgress",!1);this.enableGuessAltText=e,this.enableAltTextModelDownload=n}setEventBus(e,n){this.eventBus=e}async isEnabledFor(e){return this.enableGuessAltText}async deleteModel(e){return this.enableAltTextModelDownload=!1,null}async loadModel(e){}async downloadModel(e){this.hasProgress=!0;const{promise:n,resolve:a}=Promise.withResolvers(),i=1e8,s=1.5*i,o=5e6;let l=0;const r=setInterval(()=>{if(l+=o,l<=s){this.eventBus.dispatch("loadaiengineprogress",{source:this,detail:{total:i,totalLoaded:l,finished:l+o>=s}});return}clearInterval(r),this.hasProgress=!1,this.enableAltTextModelDownload=!0,a(!0)},900);return n}isReady(e){return this.enableAltTextModelDownload}guess({request:{data:e}}){return new Promise(n=>{setTimeout(()=>{n(e?{output:"Fake alt text"}:{error:!0})},3e3)})}toggleService(e,n){this.enableGuessAltText=n}}class D0{constructor({descriptionContainer:e,dialog:n,imagePreview:a,cancelButton:i,disclaimer:s,notNowButton:o,saveButton:l,textarea:r,learnMore:d,errorCloseButton:c,createAutomaticallyButton:f,downloadModel:g,downloadModelDescription:p,title:h},m,b){D(this,Oi);D(this,sr);D(this,Ro);D(this,Wp);D(this,od);D(this,ka);D(this,Yp);D(this,ld);D(this,zp);D(this,Vp);D(this,or);D(this,rd);D(this,Gp);D(this,Jc,I(this,Vp,Tk).bind(this));D(this,Xc,void 0);D(this,Qt,null);D(this,Qc,void 0);D(this,ed,void 0);D(this,di,void 0);D(this,td,void 0);D(this,Po,void 0);D(this,No,void 0);D(this,er,void 0);D(this,_s,!1);D(this,ia,void 0);D(this,nd,null);D(this,ad,null);D(this,tr,void 0);D(this,nr,void 0);D(this,Ea,!1);D(this,ar,!1);D(this,ir,void 0);D(this,id,void 0);D(this,vs,void 0);D(this,sa,void 0);D(this,sd,void 0);D(this,Kt,void 0);D(this,Ho,null);R(this,Qc,i),R(this,Xc,f),R(this,ed,e),R(this,di,n),R(this,td,s),R(this,id,o),R(this,tr,a),R(this,sa,r),R(this,ir,d),R(this,sd,h),R(this,Po,g),R(this,No,p),R(this,vs,m),R(this,er,b),n.addEventListener("close",I(this,rd,Yb).bind(this)),n.addEventListener("contextmenu",y=>{y.target!==v(this,sa)&&y.preventDefault()}),i.addEventListener("click",v(this,Jc)),o.addEventListener("click",v(this,Jc)),l.addEventListener("click",I(this,Gp,Ik).bind(this)),c.addEventListener("click",()=>{I(this,sr,sh).call(this,!1)}),f.addEventListener("click",async()=>{const y=f.getAttribute("aria-pressed")!=="true";v(this,Qt)._reportTelemetry({action:"pdfjs.image.alt_text.ai_generation_check",data:{status:y}}),v(this,Kt)&&(v(this,Kt).setPreference("enableGuessAltText",y),await v(this,Kt).mlManager.toggleService("altText",y)),I(this,Ro,Fu).call(this,y,!1)}),r.addEventListener("focus",()=>{R(this,ar,v(this,Ea)),I(this,Oi,hl).call(this,!1),I(this,ka,yi).call(this)}),r.addEventListener("blur",()=>{r.value||I(this,Oi,hl).call(this,v(this,ar)),I(this,ka,yi).call(this)}),r.addEventListener("input",()=>{I(this,ka,yi).call(this)}),b._on("enableguessalttext",({value:y})=>{I(this,Ro,Fu).call(this,y,!1)}),v(this,vs).register(n),v(this,ir).addEventListener("click",()=>{v(this,Qt)._reportTelemetry({action:"pdfjs.image.alt_text.info",data:{topic:"alt_text"}})})}async editAltText(e,n,a){if(v(this,Qt)||!n)return;if(a&&n.hasAltTextData()){n.altTextFinish();return}R(this,_s,a);let{mlManager:i}=e,s=!!i;I(this,ka,yi).call(this),i&&!i.isReady("altText")?(s=!1,i.hasProgress?I(this,zp,Ck).call(this):i=null):v(this,Po).classList.toggle("hidden",!0);const o=i?.isEnabledFor("altText");R(this,Qt,n),R(this,Kt,e),v(this,Kt).removeEditListeners(),{altText:ih(this,Ho)._}=n.altTextData,v(this,sa).value=v(this,Ho)??"";const l=224,r=180;let d,c,f;i?({canvas:d,width:c,height:f,imageData:ih(this,nr)._}=n.copyCanvas(l,r,!0),s&&I(this,Ro,Fu).call(this,await o,!0)):{canvas:d,width:c,height:f}=n.copyCanvas(l,r,!1),d.setAttribute("role","presentation");const{style:g}=d;g.width=`${c}px`,g.height=`${f}px`,v(this,tr).append(d),I(this,Wp,xk).call(this),I(this,od,Ub).call(this,s),I(this,sr,sh).call(this,!1);try{await v(this,vs).open(v(this,di))}catch(p){throw I(this,rd,Yb).call(this),p}}destroy(){R(this,Kt,null),I(this,or,oh).call(this)}}Jc=new WeakMap,Xc=new WeakMap,Qt=new WeakMap,Qc=new WeakMap,ed=new WeakMap,di=new WeakMap,td=new WeakMap,Po=new WeakMap,No=new WeakMap,er=new WeakMap,_s=new WeakMap,ia=new WeakMap,nd=new WeakMap,ad=new WeakMap,tr=new WeakMap,nr=new WeakMap,Ea=new WeakMap,ar=new WeakMap,ir=new WeakMap,id=new WeakMap,vs=new WeakMap,sa=new WeakMap,sd=new WeakMap,Kt=new WeakMap,Ho=new WeakMap,Oi=new WeakSet,hl=function(e){!v(this,Kt)||v(this,Ea)===e||(R(this,Ea,e),v(this,ed).classList.toggle("loading",e))},sr=new WeakSet,sh=function(e){v(this,Kt)&&v(this,di).classList.toggle("error",e)},Ro=new WeakSet,Fu=async function(e,n=!1){if(v(this,Kt))if(v(this,di).classList.toggle("aiDisabled",!e),v(this,Xc).setAttribute("aria-pressed",e),e){const{altTextLearnMoreUrl:a}=v(this,Kt).mlManager;a&&(v(this,ir).href=a),I(this,Yp,Ak).call(this,n)}else I(this,Oi,hl).call(this,!1),R(this,Ea,!1),I(this,ka,yi).call(this)},Wp=new WeakSet,xk=function(){v(this,id).classList.toggle("hidden",!v(this,_s)),v(this,Qc).classList.toggle("hidden",v(this,_s))},od=new WeakSet,Ub=function(e){!v(this,Kt)||v(this,nd)===e||(R(this,nd,e),v(this,di).classList.toggle("noAi",!e),I(this,ka,yi).call(this))},ka=new WeakSet,yi=function(){const e=v(this,Ea)||v(this,ia)&&v(this,ia)===v(this,sa).value;v(this,td).hidden=!e;const n=v(this,Ea)||!!v(this,sa).value;v(this,ad)!==n&&(R(this,ad,n),v(this,sd).setAttribute("data-l10n-id",n?"pdfjs-editor-new-alt-text-dialog-edit-label":"pdfjs-editor-new-alt-text-dialog-add-label"))},Yp=new WeakSet,Ak=async function(e){if(v(this,Ea)||v(this,sa).value||e&&v(this,Ho)!==null)return;if(R(this,ia,v(this,Qt).guessedAltText),v(this,Ho)===null&&v(this,ia)){I(this,ld,Wb).call(this,v(this,ia));return}I(this,Oi,hl).call(this,!0),I(this,ka,yi).call(this);let n=!1;try{const a=await v(this,Qt).mlGuessAltText(v(this,nr),!1);a&&(R(this,ia,a),R(this,ar,v(this,Ea)),v(this,Ea)&&I(this,ld,Wb).call(this,a))}catch(a){console.error(a),n=!0}I(this,Oi,hl).call(this,!1),I(this,ka,yi).call(this),n&&v(this,Kt)&&I(this,sr,sh).call(this,!0)},ld=new WeakSet,Wb=function(e){!v(this,Kt)||v(this,sa).value||(v(this,sa).value=e,I(this,ka,yi).call(this))},zp=new WeakSet,Ck=function(){v(this,Po).classList.toggle("hidden",!1);const e=async({detail:{finished:n,total:a,totalLoaded:i}})=>{i=Math.min(.99*a,i);const o=v(this,No).ariaValueMax=Math.round(a/1e6),l=v(this,No).ariaValueNow=Math.round(i/1e6);if(v(this,No).setAttribute("data-l10n-args",JSON.stringify({totalSize:o,downloadedSize:l})),!n||(v(this,er)._off("loadaiengineprogress",e),v(this,Po).classList.toggle("hidden",!0),I(this,od,Ub).call(this,!0),!v(this,Kt)))return;const{mlManager:r}=v(this,Kt);r.toggleService("altText",!0),I(this,Ro,Fu).call(this,await r.isEnabledFor("altText"),!0)};v(this,er)._on("loadaiengineprogress",e)},Vp=new WeakSet,Tk=function(){v(this,Qt).altTextData={cancel:!0};const e=v(this,sa).value.trim();v(this,Qt)._reportTelemetry({action:"pdfjs.image.alt_text.dismiss",data:{alt_text_type:e?"present":"empty",flow:v(this,_s)?"image_add":"alt_text_edit"}}),v(this,Qt)._reportTelemetry({action:"pdfjs.image.image_added",data:{alt_text_modal:!0,alt_text_type:"skipped"}}),I(this,or,oh).call(this)},or=new WeakSet,oh=function(){v(this,vs).active===v(this,di)&&v(this,vs).close(v(this,di))},rd=new WeakSet,Yb=function(){const e=v(this,tr).firstChild;e.remove(),e.width=e.height=0,R(this,nr,null),I(this,Oi,hl).call(this,!1),v(this,Kt)?.addEditListeners(),v(this,Qt).altTextFinish(),v(this,Kt)?.setSelected(v(this,Qt)),R(this,Qt,null),R(this,Kt,null)},Gp=new WeakSet,Ik=function(){const e=v(this,sa).value.trim();if(v(this,Qt).altTextData={altText:e,decorative:!1},v(this,Qt).altTextData.guessedAltText=v(this,ia),v(this,ia)&&v(this,ia)!==e){const n=new Set(v(this,ia).split(/\s+/)),a=new Set(e.split(/\s+/));v(this,Qt)._reportTelemetry({action:"pdfjs.image.alt_text.user_edit",data:{total_words:n.size,words_removed:n.difference(a).size,words_added:a.difference(n).size}})}v(this,Qt)._reportTelemetry({action:"pdfjs.image.image_added",data:{alt_text_modal:!0,alt_text_type:e?"present":"empty"}}),v(this,Qt)._reportTelemetry({action:"pdfjs.image.alt_text.save",data:{alt_text_type:e?"present":"empty",flow:v(this,_s)?"image_add":"alt_text_edit"}}),I(this,or,oh).call(this)};class $0{constructor({dialog:e,createModelButton:n,aiModelSettings:a,learnMore:i,closeButton:s,deleteModelButton:o,downloadModelButton:l,showAltTextDialogButton:r},d,c,f){D(this,Fo);D(this,dd);D(this,ud);D(this,fd);D(this,Ss);D(this,jp);D(this,Oo,void 0);D(this,ui,void 0);D(this,Bo,void 0);D(this,qo,void 0);D(this,lr,void 0);D(this,Es,void 0);D(this,ks,void 0);D(this,cd,void 0);R(this,qo,e),R(this,Oo,a),R(this,ui,n),R(this,Bo,l),R(this,cd,r),R(this,ks,d),R(this,lr,c),R(this,Es,f);const{altTextLearnMoreUrl:g}=f;g&&(i.href=g),e.addEventListener("contextmenu",noContextMenu),n.addEventListener("click",async p=>{const h=I(this,fd,Gb).call(this,"enableGuessAltText",p);await f.toggleService("altText",h),I(this,Fo,Uu).call(this,{type:"stamp",action:"pdfjs.image.alt_text.settings_ai_generation_check",data:{status:h}})}),r.addEventListener("click",p=>{const h=I(this,fd,Gb).call(this,"enableNewAltTextWhenAddingImage",p);I(this,Fo,Uu).call(this,{type:"stamp",action:"pdfjs.image.alt_text.settings_edit_alt_text_check",data:{status:h}})}),o.addEventListener("click",I(this,ud,Vb).bind(this,!0)),l.addEventListener("click",I(this,dd,zb).bind(this,!0)),s.addEventListener("click",I(this,jp,Dk).bind(this)),i.addEventListener("click",()=>{I(this,Fo,Uu).call(this,{type:"stamp",action:"pdfjs.image.alt_text.info",data:{topic:"ai_generation"}})}),c._on("enablealttextmodeldownload",({value:p})=>{p?I(this,dd,zb).call(this,!1):I(this,ud,Vb).call(this,!1)}),v(this,ks).register(e)}async open({enableGuessAltText:e,enableNewAltTextWhenAddingImage:n}){const{enableAltTextModelDownload:a}=v(this,Es);v(this,ui).disabled=!a,v(this,ui).setAttribute("aria-pressed",a&&e),v(this,cd).setAttribute("aria-pressed",n),v(this,Oo).classList.toggle("download",!a),await v(this,ks).open(v(this,qo)),I(this,Fo,Uu).call(this,{type:"stamp",action:"pdfjs.image.alt_text.settings_displayed"})}}Oo=new WeakMap,ui=new WeakMap,Bo=new WeakMap,qo=new WeakMap,lr=new WeakMap,Es=new WeakMap,ks=new WeakMap,cd=new WeakMap,Fo=new WeakSet,Uu=function(e){v(this,lr).dispatch("reporttelemetry",{source:this,details:{type:"editing",data:e}})},dd=new WeakSet,zb=async function(e=!1){if(e){v(this,Bo).disabled=!0;const n=v(this,Bo).firstChild;n.setAttribute("data-l10n-id","pdfjs-editor-alt-text-settings-downloading-model-button"),await v(this,Es).downloadModel("altText"),n.setAttribute("data-l10n-id","pdfjs-editor-alt-text-settings-download-model-button"),v(this,ui).disabled=!1,I(this,Ss,Br).call(this,"enableGuessAltText",!0),v(this,Es).toggleService("altText",!0),I(this,Ss,Br).call(this,"enableAltTextModelDownload",!0),v(this,Bo).disabled=!1}v(this,Oo).classList.toggle("download",!1),v(this,ui).setAttribute("aria-pressed",!0)},ud=new WeakSet,Vb=async function(e=!1){e&&(await v(this,Es).deleteModel("altText"),I(this,Ss,Br).call(this,"enableGuessAltText",!1),I(this,Ss,Br).call(this,"enableAltTextModelDownload",!1)),v(this,Oo).classList.toggle("download",!0),v(this,ui).disabled=!0,v(this,ui).setAttribute("aria-pressed",!1)},fd=new WeakSet,Gb=function(e,{target:n}){const a=n.getAttribute("aria-pressed")!=="true";return I(this,Ss,Br).call(this,e,a),n.setAttribute("aria-pressed",a),a},Ss=new WeakSet,Br=function(e,n){v(this,lr).dispatch("setpreference",{source:this,name:e,value:n})},jp=new WeakSet,Dk=function(){v(this,ks).active===v(this,qo)&&v(this,ks).close(v(this,qo))};class sA{constructor(e,n){D(this,Kp);this.eventBus=n,I(this,Kp,$k).call(this,e)}}Kp=new WeakSet,$k=function({editorFreeTextFontSize:e,editorFreeTextColor:n,editorInkColor:a,editorInkThickness:i,editorInkOpacity:s,editorStampAddImage:o,editorFreeHighlightThickness:l,editorHighlightShowAll:r}){const d=(c,f)=>{this.eventBus.dispatch("switchannotationeditorparams",{source:this,type:G.AnnotationEditorParamsType[c],value:f})};e.addEventListener("input",function(){d("FREETEXT_SIZE",this.valueAsNumber)}),n.addEventListener("input",function(){d("FREETEXT_COLOR",this.value)}),a.addEventListener("input",function(){d("INK_COLOR",this.value)}),i.addEventListener("input",function(){d("INK_THICKNESS",this.valueAsNumber)}),s.addEventListener("input",function(){d("INK_OPACITY",this.valueAsNumber)}),o.addEventListener("click",()=>{this.eventBus.dispatch("reporttelemetry",{source:this,details:{type:"editing",data:{action:"pdfjs.image.add_image_click"}}}),d("CREATE")}),l.addEventListener("input",function(){d("HIGHLIGHT_THICKNESS",this.valueAsNumber)}),r.addEventListener("click",function(){const c=this.getAttribute("aria-pressed")==="true";this.setAttribute("aria-pressed",!c),d("HIGHLIGHT_SHOW_ALL",!c)}),this.eventBus._on("annotationeditorparamschanged",c=>{for(const[f,g]of c.details)switch(f){case G.AnnotationEditorParamsType.FREETEXT_SIZE:e.value=g;break;case G.AnnotationEditorParamsType.FREETEXT_COLOR:n.value=g;break;case G.AnnotationEditorParamsType.INK_COLOR:a.value=g;break;case G.AnnotationEditorParamsType.INK_THICKNESS:i.value=g;break;case G.AnnotationEditorParamsType.INK_OPACITY:s.value=g;break;case G.AnnotationEditorParamsType.HIGHLIGHT_THICKNESS:l.value=g;break;case G.AnnotationEditorParamsType.HIGHLIGHT_FREE:l.disabled=!g;break;case G.AnnotationEditorParamsType.HIGHLIGHT_SHOW_ALL:r.setAttribute("aria-pressed",g);break}})};const up=.1,Xp=class{constructor(e,n,a,i){D(this,hd);D(this,md);D(this,Zp);D(this,bd);D(this,wd);D(this,Uo);D(this,Jp);D(this,pd,void 0);D(this,rr,0);D(this,gd,void 0);if(R(this,pd,n),R(this,gd,a),!i)return;R(this,rr,i.getBoundingClientRect().height);const s=new ResizeObserver(o=>{for(const l of o)if(l.target===i){R(this,rr,Math.floor(l.borderBoxSize[0].blockSize));break}});s.observe(i),e.addEventListener("abort",()=>s.disconnect(),{once:!0})}moveCaret(e,n){const a=document.getSelection();if(a.rangeCount===0)return;const{focusNode:i}=a,s=i.nodeType!==Node.ELEMENT_NODE?i.parentElement:i,o=s.closest(".textLayer");if(!o)return;const l=document.createTreeWalker(o,NodeFilter.SHOW_TEXT);l.currentNode=i;const r=s.getBoundingClientRect();let d=null;const c=(e?l.previousSibling:l.nextSibling).bind(l);for(;c();){const h=l.currentNode.parentElement;if(!I(this,hd,jb).call(this,r,h.getBoundingClientRect())){d=h;break}}if(!d){const h=I(this,Jp,Pk).call(this,o,e);if(!h)return;if(n){const y=(e?l.firstChild():l.lastChild())||i;a.extend(y,e?0:y.length);const w=document.createRange();w.setStart(h,e?h.length:0),w.setEnd(h,e?h.length:0),a.addRange(w);return}const[m]=I(this,bd,Zb).call(this,a,e),{parentElement:b}=h;I(this,Uo,Wu).call(this,n,a,b,b.getBoundingClientRect(),m);return}const[f,g]=I(this,bd,Zb).call(this,a,e),p=d.getBoundingClientRect();if(I(this,md,Kb).call(this,p,f,g,e)){I(this,Uo,Wu).call(this,n,a,d,p,f);return}for(;c();){const h=l.currentNode.parentElement,m=h.getBoundingClientRect();if(!I(this,hd,jb).call(this,p,m))break;if(I(this,md,Kb).call(this,m,f,g,e)){I(this,Uo,Wu).call(this,n,a,h,m,f);return}}I(this,Uo,Wu).call(this,n,a,d,p,f)}};let fp=Xp;if(pd=new WeakMap,rr=new WeakMap,gd=new WeakMap,hd=new WeakSet,jb=function(e,n){const a=e.y,i=e.bottom,s=e.y+e.height/2,o=n.y,l=n.bottom,r=n.y+n.height/2;return a<=r&&r<=i||o<=s&&s<=l},md=new WeakSet,Kb=function(e,n,a,i){const s=e.y+e.height/2;return(i?a>=s:a<=s)&&e.x-up<=n&&n<=e.right+up},Zp=new WeakSet,Mk=function(e){return e.top>=v(this,rr)&&e.left>=0&&e.bottom<=(window.innerHeight||document.documentElement.clientHeight)&&e.right<=(window.innerWidth||document.documentElement.clientWidth)},bd=new WeakSet,Zb=function(e,n){const{focusNode:a,focusOffset:i}=e,s=document.createRange();s.setStart(a,i),s.setEnd(a,i);const o=s.getBoundingClientRect();return[o.x,n?o.top:o.bottom]},yd=new WeakSet,Jb=function(e,n){if((typeof PDFJSDev>"u"||!PDFJSDev.test("MOZCENTRAL"))&&!document.caretPositionFromPoint){const{startContainer:a,startOffset:i}=document.caretRangeFromPoint(e,n);return{offsetNode:a,offset:i}}return document.caretPositionFromPoint(e,n)},wd=new WeakSet,Xb=function(e,n,a,i,s){var d,c;if(s||=i.getBoundingClientRect(),n<=s.x+up){a?e.extend(i.firstChild,0):e.setPosition(i.firstChild,0);return}if(s.right-up<=n){const{lastChild:f}=i;a?e.extend(f,f.length):e.setPosition(f,f.length);return}const o=s.y+s.height/2;let l=I(d=Xp,yd,Jb).call(d,n,o),r=l.offsetNode?.parentElement;if(r&&r!==i){const f=document.elementsFromPoint(n,o),g=[];for(const p of f){if(p===i)break;const{style:h}=p;g.push([p,h.visibility]),h.visibility="hidden"}l=I(c=Xp,yd,Jb).call(c,n,o),r=l.offsetNode?.parentElement;for(const[p,h]of g)p.style.visibility=h}if(r!==i){a?e.extend(i.firstChild,0):e.setPosition(i.firstChild,0);return}a?e.extend(l.offsetNode,l.offset):e.setPosition(l.offsetNode,l.offset)},Uo=new WeakSet,Wu=function(e,n,a,i,s){if(I(this,Zp,Mk).call(this,i)){I(this,wd,Xb).call(this,n,s,e,a,i);return}v(this,pd).addEventListener("scrollend",I(this,wd,Xb).bind(this,n,s,e,a,null),{once:!0}),a.scrollIntoView()},Jp=new WeakSet,Pk=function(e,n){for(;;){const a=e.closest(".page"),i=parseInt(a.getAttribute("data-page-number")),s=n?i-1:i+1;if(e=v(this,gd).querySelector(`.page[data-page-number="${s}"] .textLayer`),!e)return null;const o=document.createTreeWalker(e,NodeFilter.SHOW_TEXT),l=n?o.lastChild():o.firstChild();if(l)return l}},D(fp,yd),typeof PDFJSDev<"u"&&!PDFJSDev.test("CHROME || GENERIC"))throw new Error('Module "pdfjs-web/download_manager" shall not be used outside CHROME and GENERIC builds.');function Gv(t,e){const n=document.createElement("a");if(!n.click)throw new Error('DownloadManager: "a.click()" is not supported.');n.href=t,n.target="_parent","download"in n&&(n.download=e),(document.body||document.documentElement).append(n),n.click(),n.remove()}class oA{constructor(){D(this,cr,new WeakMap)}downloadData(e,n,a){const i=URL.createObjectURL(new Blob([e],{type:a}));Gv(i,n)}openOrDownloadData(e,n,a=null){const i=(0,G.isPdfFile)(n),s=i?"application/pdf":"";if((typeof PDFJSDev>"u"||!PDFJSDev.test("COMPONENTS"))&&i){let o=v(this,cr).get(e);o||(o=URL.createObjectURL(new Blob([e],{type:s})),v(this,cr).set(e,o));let l;typeof PDFJSDev>"u"||PDFJSDev.test("GENERIC")?l="?file="+encodeURIComponent(o+"#"+n):PDFJSDev.test("CHROME")&&(l=chrome.runtime.getURL("/content/web/viewer.html")+"?file="+encodeURIComponent(o+"#"+n)),a&&(l+=`#${escape(a)}`);try{return window.open(l),!0}catch(r){console.error(`openOrDownloadData: ${r}`),URL.revokeObjectURL(o),v(this,cr).delete(e)}}return this.downloadData(e,n,s),!1}download(e,n,a){let i;if(e)i=URL.createObjectURL(new Blob([e],{type:"application/pdf"}));else{if(!(0,G.createValidAbsoluteUrl)(n,"http://example.com")){console.error(`download - not a valid URL: ${n}`);return}i=n+"#pdfjs.action=download"}Gv(i,a)}}cr=new WeakMap;class lA{constructor(){D(this,Ls,new WeakMap);D(this,Sa,null)}get active(){return v(this,Sa)}async register(e,n=!1){if(typeof e!="object")throw new Error("Not enough parameters.");if(v(this,Ls).has(e))throw new Error("The overlay is already registered.");v(this,Ls).set(e,{canForceClose:n}),e.addEventListener("cancel",a=>{R(this,Sa,null)})}async open(e){if(v(this,Ls).has(e)){if(v(this,Sa)){if(v(this,Sa)===e)throw new Error("The overlay is already active.");if(v(this,Ls).get(e).canForceClose)await this.close();else throw new Error("Another overlay is currently active.")}}else throw new Error("The overlay does not exist.");R(this,Sa,e),e.classList.add("dialog--open")}async close(e=v(this,Sa)){if(v(this,Ls).has(e))if(v(this,Sa)){if(v(this,Sa)!==e)throw new Error("Another overlay is currently active.")}else throw new Error("The overlay is currently not active.");else throw new Error("The overlay does not exist.");e.classList.remove("dialog--open"),R(this,Sa,null)}}Ls=new WeakMap,Sa=new WeakMap;class rA{constructor(e,n,a=!1){D(this,vd);D(this,Qp);D(this,Ed);D(this,Bi,null);D(this,Wo,null);D(this,_d,null);this.dialog=e.dialog,this.label=e.label,this.input=e.input,this.submitButton=e.submitButton,this.cancelButton=e.cancelButton,this.overlayManager=n,this._isViewerEmbedded=a,this.submitButton.addEventListener("click",I(this,vd,Qb).bind(this)),this.cancelButton.addEventListener("click",this.close.bind(this)),this.input.addEventListener("keydown",i=>{i.keyCode===13&&I(this,vd,Qb).call(this)}),this.overlayManager.register(this.dialog,!0),this.dialog.addEventListener("close",I(this,Qp,Nk).bind(this))}async open(){await v(this,Bi)?.promise,R(this,Bi,Promise.withResolvers());try{await this.overlayManager.open(this.dialog)}catch(n){throw v(this,Bi).resolve(),n}const e=v(this,_d)===G.PasswordResponses.INCORRECT_PASSWORD;(!this._isViewerEmbedded||e)&&this.input.focus(),this.label.textContent=window.siyuan.languages[`password_${e?"invalid":"label"}`]}async close(){this.overlayManager.active===this.dialog&&this.overlayManager.close(this.dialog)}async setUpdateCallback(e,n){v(this,Bi)&&await v(this,Bi).promise,R(this,Wo,e),R(this,_d,n)}}Bi=new WeakMap,Wo=new WeakMap,_d=new WeakMap,vd=new WeakSet,Qb=function(){const e=this.input.value;e?.length>0&&I(this,Ed,ey).call(this,e)},Qp=new WeakSet,Nk=function(){I(this,Ed,ey).call(this,new Error("PasswordPrompt cancelled.")),v(this,Bi).resolve()},Ed=new WeakSet,ey=function(e){v(this,Wo)&&(this.close(),this.input.value="",v(this,Wo).call(this,e),R(this,Wo,null))};const cA=-100,jv="selected";class Mc{constructor(e){if((typeof PDFJSDev>"u"||PDFJSDev.test("TESTING"))&&this.constructor===Mc)throw new Error("Cannot initialize BaseTreeViewer.");this.container=e.container,this.eventBus=e.eventBus,this._l10n=e.l10n,this.reset()}reset(){this._pdfDocument=null,this._lastToggleIsShow=!0,this._currentTreeItem=null,this.container.textContent="",this.container.classList.remove("treeWithDeepNesting")}_dispatchEvent(e){throw new Error("Not implemented: _dispatchEvent")}_bindLink(e,n){throw new Error("Not implemented: _bindLink")}_normalizeTextContent(e){return Fl(e,!0)||"\u2013"}_addToggleButton(e,n=!1){const a=document.createElement("div");a.innerHTML='<svg><use xlink:href="#iconDown"></use></svg>',a.className="treeItemToggler",n&&a.classList.add("treeItemsHidden"),a.onclick=i=>{if(i.stopPropagation(),a.classList.toggle("treeItemsHidden"),i.shiftKey){const s=!a.classList.contains("treeItemsHidden");this._toggleTreeItem(e,s)}},e.prepend(a)}_toggleTreeItem(e,n=!1){this._l10n.pause(),this._lastToggleIsShow=n;for(const a of e.querySelectorAll(".treeItemToggler"))a.classList.toggle("treeItemsHidden",!n);this._l10n.resume()}_toggleAllTreeItems(){this._toggleTreeItem(this.container,!this._lastToggleIsShow)}_finishRendering(e,n,a=!1){a&&(this.container.classList.add("treeWithDeepNesting"),this._lastToggleIsShow=!e.querySelector(".treeItemsHidden")),this._l10n.pause(),this.container.append(e),this._l10n.resume(),this._dispatchEvent(n)}render(e){throw new Error("Not implemented: render")}_updateCurrentTreeItem(e=null){this._currentTreeItem&&(this._currentTreeItem.classList.remove(jv),this._currentTreeItem=null),e&&(e.classList.add(jv),this._currentTreeItem=e)}_scrollToCurrentTreeItem(e){if(!e)return;this._l10n.pause();let n=e.parentNode;for(;n&&n!==this.container;)n.classList.contains("treeItem")&&n.firstElementChild?.classList.remove("treeItemsHidden"),n=n.parentNode;this._l10n.resume(),this._updateCurrentTreeItem(e),this.container.scrollTo(e.offsetLeft,e.offsetTop+cA)}}class dA extends Mc{constructor(n){super(n);D(this,eg);this.downloadManager=n.downloadManager,this.eventBus._on("fileattachmentannotation",I(this,eg,Hk).bind(this))}reset(n=!1){super.reset(),this._attachments=null,n||(this._renderedCapability=Promise.withResolvers()),this._pendingDispatchEvent=!1}async _dispatchEvent(n){this._renderedCapability.resolve(),!(n===0&&!this._pendingDispatchEvent&&(this._pendingDispatchEvent=!0,await zv({target:this.eventBus,name:"annotationlayerrendered",delay:1e3}),!this._pendingDispatchEvent))&&(this._pendingDispatchEvent=!1,this.eventBus.dispatch("attachmentsloaded",{source:this,attachmentsCount:n}))}_bindLink(n,{content:a,description:i,filename:s}){i&&(n.title=i),n.onclick=()=>(this.downloadManager.openOrDownloadData(a,s),!1)}render({attachments:n,keepRenderedCapability:a=!1}){if(this._attachments&&this.reset(a),this._attachments=n||null,!n){this._dispatchEvent(0);return}const i=document.createDocumentFragment();let s=0;for(const o in n){const l=n[o],r=document.createElement("div");r.className="treeItem";const d=document.createElement("a");this._bindLink(d,l),d.textContent=this._normalizeTextContent(l.filename),r.append(d),i.append(r),s++}this._finishRendering(i,s)}}eg=new WeakSet,Hk=function(n){const a=this._renderedCapability.promise;a.then(()=>{if(a!==this._renderedCapability.promise)return;const i=this._attachments||Object.create(null);for(const s in i)if(n.filename===s)return;i[n.filename]=n,this.render({attachments:i,keepRenderedCapability:!0})})};const Kv="grab-to-pan-grab";class uA{constructor({element:e}){D(this,tg);D(this,ng);D(this,ag);this.element=e,this.document=e.ownerDocument,this.activate=this.activate.bind(this),this.deactivate=this.deactivate.bind(this),this.toggle=this.toggle.bind(this),this._onMouseDown=I(this,tg,Rk).bind(this),this._onMouseMove=I(this,ng,Ok).bind(this),this._endPan=I(this,ag,Bk).bind(this);const n=this.overlay=document.createElement("div");n.className="grab-to-pan-grabbing"}activate(){this.active||(this.active=!0,this.element.addEventListener("mousedown",this._onMouseDown,!0),this.element.classList.add(Kv))}deactivate(){this.active&&(this.active=!1,this.element.removeEventListener("mousedown",this._onMouseDown,!0),this._endPan(),this.element.classList.remove(Kv))}toggle(){this.active?this.deactivate():this.activate()}ignoreTarget(e){return e.matches("a[href], a[href] *, input, textarea, button, button *, select, option")}}tg=new WeakSet,Rk=function(e){if(e.button!==0||this.ignoreTarget(e.target))return;if(e.originalTarget)try{e.originalTarget.tagName}catch{return}this.scrollLeftStart=this.element.scrollLeft,this.scrollTopStart=this.element.scrollTop,this.clientXStart=e.clientX,this.clientYStart=e.clientY,this.document.addEventListener("mousemove",this._onMouseMove,!0),this.document.addEventListener("mouseup",this._endPan,!0),this.element.addEventListener("scroll",this._endPan,!0),e.preventDefault(),e.stopPropagation();const n=document.activeElement;n&&!n.contains(e.target)&&n.blur()},ng=new WeakSet,Ok=function(e){if(this.element.removeEventListener("scroll",this._endPan,!0),!(e.buttons&1)){this._endPan();return}const n=e.clientX-this.clientXStart,a=e.clientY-this.clientYStart;this.element.scrollTo({top:this.scrollTopStart-a,left:this.scrollLeftStart-n,behavior:"instant"}),this.overlay.parentNode||document.body.append(this.overlay)},ag=new WeakSet,Bk=function(){this.element.removeEventListener("scroll",this._endPan,!0),this.document.removeEventListener("mousemove",this._onMouseMove,!0),this.document.removeEventListener("mouseup",this._endPan,!0),this.overlay.remove()};class fA{constructor({container:e,eventBus:n,cursorToolOnLoad:a=$n.SELECT}){D(this,dr);D(this,ig);D(this,xs,$n.SELECT);D(this,fi,null);this.container=e,this.eventBus=n,I(this,ig,qk).call(this),Promise.resolve().then(()=>{this.switchTool(a)})}get activeTool(){return v(this,xs)}switchTool(e){v(this,fi)===null&&I(this,dr,lh).call(this,e)}get _handTool(){return(0,G.shadow)(this,"_handTool",new uA({element:this.container}))}}xs=new WeakMap,fi=new WeakMap,dr=new WeakSet,lh=function(e,n=!1){if(e===v(this,xs)){v(this,fi)!==null&&this.eventBus.dispatch("cursortoolchanged",{source:this,tool:e,disabled:n});return}const a=()=>{switch(v(this,xs)){case $n.SELECT:break;case $n.HAND:this._handTool.deactivate();break;case $n.ZOOM:}};switch(e){case $n.SELECT:a();break;case $n.HAND:a(),this._handTool.activate();break;case $n.ZOOM:default:console.error(`switchTool: "${e}" is an unsupported value.`);return}R(this,xs,e),this.eventBus.dispatch("cursortoolchanged",{source:this,tool:e,disabled:n})},ig=new WeakSet,qk=function(){this.eventBus._on("switchcursortool",s=>{s.reset?v(this,fi)!==null&&(e=G.AnnotationEditorType.NONE,n=on.NORMAL,i()):this.switchTool(s.tool)});let e=G.AnnotationEditorType.NONE,n=on.NORMAL;const a=()=>{v(this,fi)??R(this,fi,v(this,xs)),I(this,dr,lh).call(this,$n.SELECT,!0)},i=()=>{v(this,fi)!==null&&e===G.AnnotationEditorType.NONE&&n===on.NORMAL&&(I(this,dr,lh).call(this,v(this,fi)),R(this,fi,null))};this.eventBus._on("annotationeditormodechanged",({mode:s})=>{e=s,s===G.AnnotationEditorType.NONE?i():a()}),this.eventBus._on("presentationmodechanged",({state:s})=>{n=s,s===on.NORMAL?i():s===on.FULLSCREEN&&a()})};const pA=["en-us","en-lr","my"],gA={"8.5x11":"pdfjs-document-properties-page-size-name-letter","8.5x14":"pdfjs-document-properties-page-size-name-legal"},Zv={"297x420":"pdfjs-document-properties-page-size-name-a-three","210x297":"pdfjs-document-properties-page-size-name-a-four"};function zm(t,e,n){const a=e?t.width:t.height,i=e?t.height:t.width;return n[`${a}x${i}`]}class hA{constructor({dialog:e,fields:n,closeButton:a},i,s,o,l){D(this,kd);D(this,Yo);D(this,Sd);D(this,sg);D(this,Ld);D(this,og);D(this,La,null);this.dialog=e,this.fields=n,this.overlayManager=i,this.l10n=o,this._fileNameLookup=l,I(this,kd,ty).call(this),a.addEventListener("click",this.close.bind(this)),this.overlayManager.register(this.dialog),s._on("pagechanging",r=>{this._currentPageNumber=r.pageNumber}),s._on("rotationchanging",r=>{this._pagesRotation=r.pagesRotation})}async open(){await Promise.all([this.overlayManager.open(this.dialog),this._dataAvailableCapability.promise]);const e=this._currentPageNumber,n=this._pagesRotation;if(v(this,La)&&e===v(this,La)._currentPageNumber&&n===v(this,La)._pagesRotation){I(this,Yo,Yu).call(this);return}const{info:a,contentLength:i}=await this.pdfDocument.getMetadata(),[s,o,l,r,d,c]=await Promise.all([this._fileNameLookup(),I(this,Sd,ny).call(this,i),I(this,Ld,ay).call(this,a.CreationDate),I(this,Ld,ay).call(this,a.ModDate),this.pdfDocument.getPage(e).then(p=>I(this,sg,Fk).call(this,Yx(p),n)),I(this,og,Uk).call(this,a.IsLinearized)]);R(this,La,Object.freeze({fileName:s,fileSize:o,title:a.Title,author:a.Author,subject:a.Subject,keywords:a.Keywords,creationDate:l,modificationDate:r,creator:a.Creator,producer:a.Producer,version:a.PDFFormatVersion,pageCount:this.pdfDocument.numPages,pageSize:d,linearized:c,_currentPageNumber:e,_pagesRotation:n})),I(this,Yo,Yu).call(this);const{length:f}=await this.pdfDocument.getDownloadInfo();if(i===f)return;const g=Object.assign(Object.create(null),v(this,La));g.fileSize=await I(this,Sd,ny).call(this,f),R(this,La,Object.freeze(g)),I(this,Yo,Yu).call(this)}async close(){this.overlayManager.close(this.dialog)}setDocument(e){this.pdfDocument&&(I(this,kd,ty).call(this),I(this,Yo,Yu).call(this)),e&&(this.pdfDocument=e,this._dataAvailableCapability.resolve())}}La=new WeakMap,kd=new WeakSet,ty=function(){this.pdfDocument=null,R(this,La,null),this._dataAvailableCapability=Promise.withResolvers(),this._currentPageNumber=1,this._pagesRotation=0},Yo=new WeakSet,Yu=function(){if(!(v(this,La)&&this.overlayManager.active!==this.dialog))for(const e in this.fields){const n=v(this,La)?.[e];this.fields[e].textContent=n||n===0?n:"-"}},Sd=new WeakSet,ny=async function(e=0){const n=e/1024,a=n/1024;return n?a>=1?`${a.toPrecision(3)} MB ${e} bytes`:`${n.toPrecision(3)} KB ${e} bytes`:void 0},sg=new WeakSet,Fk=async function(e,n){if(!e)return;n%180!==0&&(e={width:e.height,height:e.width});const a=Bm(e),i=pA.includes(this.l10n.getLanguage());let s={width:Math.round(e.width*100)/100,height:Math.round(e.height*100)/100},o={width:Math.round(e.width*25.4*10)/10,height:Math.round(e.height*25.4*10)/10},l=zm(s,a,gA)||zm(o,a,Zv);if(!l&&!(Number.isInteger(o.width)&&Number.isInteger(o.height))){const p={width:e.width*25.4,height:e.height*25.4},h={width:Math.round(o.width),height:Math.round(o.height)};Math.abs(p.width-h.width)<.1&&Math.abs(p.height-h.height)<.1&&(l=zm(h,a,Zv),l&&(s={width:Math.round(h.width/25.4*100)/100,height:Math.round(h.height/25.4*100)/100},o=h))}const[{width:r,height:d},c,f,g]=await Promise.all([i?s:o,this.l10n.get(i?"unitInches":"unitMillimeters"),l&&this.l10n.get(l),this.l10n.get(a?"document_properties_page_size_orientation_portrait":"document_properties_page_size_orientation_landscape")]);return f?`${r.toLocaleString()} \xD7 ${d.toLocaleString()} ${c} (${f}, ${g})`:`${r.toLocaleString()} \xD7 ${d.toLocaleString()} ${c} (${g})`},Ld=new WeakSet,ay=async function(e){const n=G.PDFDateString.toDateObject(e);return n?`${n.toLocaleDateString()}, ${n.toLocaleTimeString()}`:void 0},og=new WeakSet,Uk=function(e){return this.l10n.get(e?"Yes":"No")};const Fa={SPACE:0,ALPHA_LETTER:1,PUNCT:2,HAN_LETTER:3,KATAKANA_LETTER:4,HIRAGANA_LETTER:5,HALFWIDTH_KATAKANA_LETTER:6,THAI_LETTER:7};function mA(t){return t<11904}function bA(t){return(t&65408)===0}function yA(t){return t>=97&&t<=122||t>=65&&t<=90}function wA(t){return t>=48&&t<=57}function _A(t){return t===32||t===9||t===13||t===10}function vA(t){return t>=13312&&t<=40959||t>=63744&&t<=64255}function EA(t){return t>=12448&&t<=12543}function kA(t){return t>=12352&&t<=12447}function SA(t){return t>=65376&&t<=65439}function LA(t){return(t&65408)===3584}function pp(t){return mA(t)?bA(t)?_A(t)?Fa.SPACE:yA(t)||wA(t)||t===95?Fa.ALPHA_LETTER:Fa.PUNCT:LA(t)?Fa.THAI_LETTER:t===160?Fa.SPACE:Fa.ALPHA_LETTER:vA(t)?Fa.HAN_LETTER:EA(t)?Fa.KATAKANA_LETTER:kA(t)?Fa.HIRAGANA_LETTER:SA(t)?Fa.HALFWIDTH_KATAKANA_LETTER:Fa.ALPHA_LETTER}let Vm;function xA(){if(Vm||="\xA0\xA8\xAA\xAF\xB2-\xB5\xB8-\xBA\xBC-\xBE\u0132-\u0133\u013F-\u0140\u0149\u017F\u01C4-\u01CC\u01F1-\u01F3\u02B0-\u02B8\u02D8-\u02DD\u02E0-\u02E4\u0374\u037A\u037E\u0384-\u0385\u0387\u03D0-\u03D6\u03F0-\u03F2\u03F4-\u03F5\u03F9\u0587\u0675-\u0678\u0958-\u095F\u09DC-\u09DD\u09DF\u0A33\u0A36\u0A59-\u0A5B\u0A5E\u0B5C-\u0B5D\u0E33\u0EB3\u0EDC-\u0EDD\u0F0C\u0F43\u0F4D\u0F52\u0F57\u0F5C\u0F69\u10FC\u1D2C-\u1D2E\u1D30-\u1D3A\u1D3C-\u1D4D\u1D4F-\u1D6A\u1D78\u1D9B-\u1DBF\u1E9A-\u1E9B\u1F71\u1F73\u1F75\u1F77\u1F79\u1F7B\u1F7D\u1FBB\u1FBD-\u1FC1\u1FC9\u1FCB\u1FCD-\u1FCF\u1FD3\u1FDB\u1FDD-\u1FDF\u1FE3\u1FEB\u1FED-\u1FEF\u1FF9\u1FFB\u1FFD-\u1FFE\u2000-\u200A\u2011\u2017\u2024-\u2026\u202F\u2033-\u2034\u2036-\u2037\u203C\u203E\u2047-\u2049\u2057\u205F\u2070-\u2071\u2074-\u208E\u2090-\u209C\u20A8\u2100-\u2103\u2105-\u2107\u2109-\u2113\u2115-\u2116\u2119-\u211D\u2120-\u2122\u2124\u2126\u2128\u212A-\u212D\u212F-\u2131\u2133-\u2139\u213B-\u2140\u2145-\u2149\u2150-\u217F\u2189\u222C-\u222D\u222F-\u2230\u2329-\u232A\u2460-\u24EA\u2A0C\u2A74-\u2A76\u2ADC\u2C7C-\u2C7D\u2D6F\u2E9F\u2EF3\u2F00-\u2FD5\u3000\u3036\u3038-\u303A\u309B-\u309C\u309F\u30FF\u3131-\u318E\u3192-\u319F\u3200-\u321E\u3220-\u3247\u3250-\u327E\u3280-\u33FF\uA69C-\uA69D\uA770\uA7F2-\uA7F4\uA7F8-\uA7F9\uAB5C-\uAB5F\uAB69\uF900-\uFA0D\uFA10\uFA12\uFA15-\uFA1E\uFA20\uFA22\uFA25-\uFA26\uFA2A-\uFA6D\uFA70-\uFAD9\uFB00-\uFB06\uFB13-\uFB17\uFB1D\uFB1F-\uFB36\uFB38-\uFB3C\uFB3E\uFB40-\uFB41\uFB43-\uFB44\uFB46-\uFBB1\uFBD3-\uFD3D\uFD50-\uFD8F\uFD92-\uFDC7\uFDF0-\uFDFC\uFE10-\uFE19\uFE30-\uFE44\uFE47-\uFE52\uFE54-\uFE66\uFE68-\uFE6B\uFE70-\uFE72\uFE74\uFE76-\uFEFC\uFF01-\uFFBE\uFFC2-\uFFC7\uFFCA-\uFFCF\uFFD2-\uFFD7\uFFDA-\uFFDC\uFFE0-\uFFE6",typeof PDFJSDev>"u"||PDFJSDev.test("TESTING")){const t=[],e=[],n=/^\p{M}$/u;for(let a=0;a<65536;a++){const i=String.fromCharCode(a);if(i.normalize("NFKC")!==i&&!n.test(i)){if(e.length!==2){e[0]=e[1]=a;continue}e[1]+1!==a?(e[0]===e[1]?t.push(String.fromCharCode(e[0])):t.push(`${String.fromCharCode(e[0])}-${String.fromCharCode(e[1])}`),e[0]=e[1]=a):e[1]=a}}if(t.join("")!==Vm)throw new Error("getNormalizeWithNFKC - update the `NormalizeWithNFKC` string.")}return Vm}const ha={FOUND:0,NOT_FOUND:1,WRAPPED:2,PENDING:3},AA=250,CA=-50,TA=-400,Jv={"\u2010":"-","\u2018":"'","\u2019":"'","\u201A":"'","\u201B":"'","\u201C":'"',"\u201D":'"',"\u201E":'"',"\u201F":'"',"\xBC":"1/4","\xBD":"1/2","\xBE":"3/4"},Xv=new Set([12441,12442,2381,2509,2637,2765,2893,3021,3149,3277,3387,3388,3405,3530,3642,3770,3972,4153,4154,5908,5940,6098,6752,6980,7082,7083,7154,7155,11647,43014,43052,43204,43347,43456,43766,44013,3158,3953,3954,3962,3963,3964,3965,3968,3956]);let Qv;const IA=/\p{M}+/gu,DA=/([.*+?^${}()|[\]\\])|(\p{P})|(\s+)|(\p{M})|(\p{L})/gu,$A=/([^\p{M}])\p{M}*$/u,MA=/^\p{M}*([^\p{M}])/u,PA=/[\uAC00-\uD7AF\uFA6C\uFACF-\uFAD1\uFAD5-\uFAD7]+/g,eE=new Map,NA="[\\u1100-\\u1112\\ud7a4-\\ud7af\\ud84a\\ud84c\\ud850\\ud854\\ud857\\ud85f]",tE=new Map;let Gm=null,jm=null;function Km(t){const e=[];let n;for(;(n=PA.exec(t))!==null;){let{index:p}=n;for(const h of n[0]){let m=eE.get(h);m||(m=h.normalize("NFD").length,eE.set(h,m)),e.push([m,p++])}}let a;if(e.length===0&&Gm)a=Gm;else if(e.length>0&&jm)a=jm;else{const p=Object.keys(Jv).join(""),h=xA(),w=`([${p}])|([${h}])|((?:\u3099|\u309A)\\n)|(\\p{M}+(?:-\\n)?)|(\\p{Ll}-\\n\\p{Lu})|(\\S-\\n)|((?:\\p{Ideographic}|[\u3040-\u30FF])\\n)|(\\n)`;e.length===0?a=Gm=new RegExp(w+"|(\\u0000)","gum"):a=jm=new RegExp(w+`|(${NA})`,"gum")}const i=[];for(;(n=IA.exec(t))!==null;)i.push([n[0].length,n.index]);let s=t.normalize("NFD");const o=[[0,0]];let l=0,r=0,d=0,c=0,f=0,g=!1;return s=s.replace(a,(p,h,m,b,y,w,_,x,S,k,A)=>{if(A-=c,h){const $=Jv[h],M=$.length;for(let C=1;C<M;C++)o.push([A-d+C,d-C]);return d-=M-1,$}if(m){let $=tE.get(m);$||($=m.normalize("NFKC"),tE.set(m,$));const M=$.length;for(let C=1;C<M;C++)o.push([A-d+C,d-C]);return d-=M-1,$}if(b)return g=!0,A+f===i[l]?.[1]?++l:(o.push([A-1-d+1,d-1]),d-=1,c+=1),o.push([A-d+1,d]),c+=1,f+=1,b.charAt(0);if(y){const $=y.endsWith(`
`),M=$?y.length-2:y.length;g=!0;let C=M;A+f===i[l]?.[1]&&(C-=i[l][0],++l);for(let N=1;N<=C;N++)o.push([A-1-d+N,d-N]);return d-=C,c+=C,$?(A+=M-1,o.push([A-d+1,1+d]),d+=1,c+=1,f+=1,y.slice(0,M)):y}if(w)return o.push([A-d+3,1+d]),d+=1,c+=1,f+=1,w.replace(`
`,"");if(_){const $=_.length-2;return o.push([A-d+$,1+d]),d+=1,c+=1,f+=1,_.slice(0,-2)}if(x){const $=x.length-1;return o.push([A-d+$,d]),c+=1,f+=1,x.slice(0,-1)}if(S)return o.push([A-d+1,d-1]),d-=1,c+=1,f+=1," ";if(A+f===e[r]?.[1]){const $=e[r][0]-1;++r;for(let M=1;M<=$;M++)o.push([A-(d-M),d-M]);d-=$,c+=$}return k}),o.push([s.length,d]),[s,o,g]}function HA(t,e,n){if(!t)return[e,n];const a=e,i=e+n-1;let s=Ic(t,c=>c[0]>=a);t[s][0]>a&&--s;let o=Ic(t,c=>c[0]>=i,s);t[o][0]>i&&--o;const l=a+t[s][1],d=i+t[o][1]+1-l;return[l,d]}class RA{constructor({linkService:e,eventBus:n,updateMatchesCountOnProgress:a=!0}){D(this,lg);D(this,xd);D(this,Ad);D(this,rg);D(this,cg);D(this,Cd);D(this,dg);D(this,ug);D(this,fr);D(this,Vo);D(this,As);D(this,fg);D(this,Td);D(this,Id);D(this,pr);D(this,pg);D(this,Dd);D(this,$d);D(this,Go);D(this,un,null);D(this,ur,!0);D(this,zo,0);this._linkService=e,this._eventBus=n,R(this,ur,a),this.onIsPageVisible=null,I(this,xd,iy).call(this),n._on("find",I(this,lg,Wk).bind(this)),n._on("findbarclose",I(this,pg,Kk).bind(this))}get highlightMatches(){return this._highlightMatches}get pageMatches(){return this._pageMatches}get pageMatchesLength(){return this._pageMatchesLength}get selected(){return this._selected}get state(){return v(this,un)}setDocument(e){this._pdfDocument&&I(this,xd,iy).call(this),e&&(this._pdfDocument=e,this._firstPageCapability.resolve())}scrollMatchIntoView({element:e=null,selectedLeft:n=0,pageIndex:a=-1,matchIndex:i=-1}){if(!this._scrollMatches||!e)return;if(i===-1||i!==this._selected.matchIdx)return;if(a===-1||a!==this._selected.pageIdx)return;this._scrollMatches=!1;const s={top:CA,left:n+TA};Om(e,s,!0)}match(e,n,a){const i=this._hasDiacritics[a];let s=!1;if(typeof e=="string"?[s,e]=I(this,Cd,oy).call(this,e,i):e=e.sort().reverse().map(f=>{const[g,p]=I(this,Cd,oy).call(this,f,i);return s||=g,`(${p})`}).join("|"),!e)return;const{caseSensitive:o,entireWord:l}=v(this,un),r=`g${s?"u":""}${o?"":"i"}`;e=new RegExp(e,r);const d=[];let c;for(;(c=e.exec(n))!==null;)l&&!I(this,cg,zk).call(this,n,c.index,c[0].length)||d.push({index:c.index,length:c[0].length});return d}}un=new WeakMap,ur=new WeakMap,zo=new WeakMap,lg=new WeakSet,Wk=function(e){if(!e)return;const n=this._pdfDocument,{type:a}=e;(v(this,un)===null||I(this,rg,Yk).call(this,e))&&(this._dirtyMatch=!0),R(this,un,e),a!=="highlightallchange"&&I(this,Go,Vu).call(this,ha.PENDING),this._firstPageCapability.promise.then(()=>{if(!this._pdfDocument||n&&this._pdfDocument!==n)return;I(this,ug,Gk).call(this);const i=!this._highlightMatches,s=!!this._findTimeout;this._findTimeout&&(clearTimeout(this._findTimeout),this._findTimeout=null),a?this._dirtyMatch?I(this,As,qr).call(this):a==="again"?(I(this,As,qr).call(this),i&&v(this,un).highlightAll&&I(this,Vo,zu).call(this)):a==="highlightallchange"?(s?I(this,As,qr).call(this):this._highlightMatches=!0,I(this,Vo,zu).call(this)):I(this,As,qr).call(this):this._findTimeout=setTimeout(()=>{I(this,As,qr).call(this),this._findTimeout=null},AA)})},xd=new WeakSet,iy=function(){this._highlightMatches=!1,this._scrollMatches=!1,this._pdfDocument=null,this._pageMatches=[],this._pageMatchesLength=[],R(this,zo,0),R(this,un,null),this._selected={pageIdx:-1,matchIdx:-1},this._offset={pageIdx:null,matchIdx:null,wrapped:!1},this._extractTextPromises=[],this._pageContents=[],this._pageDiffs=[],this._hasDiacritics=[],this._matchesCountTotal=0,this._pagesToSearch=null,this._pendingFindMatches=new Set,this._resumePageIdx=null,this._dirtyMatch=!1,clearTimeout(this._findTimeout),this._findTimeout=null,this._firstPageCapability=Promise.withResolvers()},Ad=new WeakSet,sy=function(){const{query:e}=v(this,un);return typeof e=="string"?(e!==this._rawQuery&&(this._rawQuery=e,[this._normalizedQuery]=Km(e)),this._normalizedQuery):(e||[]).filter(n=>!!n).map(n=>Km(n)[0])},rg=new WeakSet,Yk=function(e){const n=e.query,a=v(this,un).query,i=typeof n;if(i!==typeof a)return!0;if(i==="string"){if(n!==a)return!0}else if(JSON.stringify(n)!==JSON.stringify(a))return!0;switch(e.type){case"again":const o=this._selected.pageIdx+1,l=this._linkService;return o>=1&&o<=l.pagesCount&&o!==l.page&&!(this.onIsPageVisible?.(o)??!0);case"highlightallchange":return!1}return!0},cg=new WeakSet,zk=function(e,n,a){let i=e.slice(0,n).match($A);if(i){const s=e.charCodeAt(n),o=i[1].charCodeAt(0);if(pp(s)===pp(o))return!1}if(i=e.slice(n+a).match(MA),i){const s=e.charCodeAt(n+a-1),o=i[1].charCodeAt(0);if(pp(s)===pp(o))return!1}return!0},Cd=new WeakSet,oy=function(e,n){const{matchDiacritics:a}=v(this,un);let i=!1;e=e.replaceAll(DA,(o,l,r,d,c,f)=>l?`[ ]*\\${l}[ ]*`:r?`[ ]*${r}[ ]*`:d?"[ ]+":a?c||f:c?Xv.has(c.charCodeAt(0))?c:"":n?(i=!0,`${f}\\p{M}*`):f);const s="[ ]*";return e.endsWith(s)&&(e=e.slice(0,e.length-s.length)),a&&n&&(Qv||=String.fromCharCode(...Xv),i=!0,e=`${e}(?=[${Qv}]|[^\\p{M}]|$)`),[i,e]},dg=new WeakSet,Vk=function(e){const n=v(this,Ad,sy);if(n.length===0)return;const a=this._pageContents[e],i=this.match(n,a,e),s=this._pageMatches[e]=[],o=this._pageMatchesLength[e]=[],l=this._pageDiffs[e];i?.forEach(({index:d,length:c})=>{const[f,g]=HA(l,d,c);g&&(s.push(f),o.push(g))}),v(this,un).highlightAll&&I(this,fr,rh).call(this,e),this._resumePageIdx===e&&(this._resumePageIdx=null,I(this,Td,ly).call(this));const r=s.length;this._matchesCountTotal+=r,v(this,ur)?r>0&&I(this,$d,dy).call(this):++ih(this,zo)._===this._linkService.pagesCount&&I(this,$d,dy).call(this)},ug=new WeakSet,Gk=function(){if(this._extractTextPromises.length>0)return;let e=Promise.resolve();const n={disableNormalization:!0};for(let a=0,i=this._linkService.pagesCount;a<i;a++){const{promise:s,resolve:o}=Promise.withResolvers();this._extractTextPromises[a]=s,e=e.then(()=>this._pdfDocument.getPage(a+1).then(l=>l.getTextContent(n)).then(l=>{const r=[];for(const d of l.items)r.push(d.str),d.hasEOL&&r.push(`
`);[this._pageContents[a],this._pageDiffs[a],this._hasDiacritics[a]]=Km(r.join("")),o()},l=>{console.error(`Unable to get text content for page ${a+1}`,l),this._pageContents[a]="",this._pageDiffs[a]=null,this._hasDiacritics[a]=!1,o()}))}},fr=new WeakSet,rh=function(e){this._scrollMatches&&this._selected.pageIdx===e&&(this._linkService.page=e+1),this._eventBus.dispatch("updatetextlayermatches",{source:this,pageIndex:e})},Vo=new WeakSet,zu=function(){this._eventBus.dispatch("updatetextlayermatches",{source:this,pageIndex:-1})},As=new WeakSet,qr=function(){const e=v(this,un).findPrevious,n=this._linkService.page-1,a=this._linkService.pagesCount;if(this._highlightMatches=!0,this._dirtyMatch){this._dirtyMatch=!1,this._selected.pageIdx=this._selected.matchIdx=-1,this._offset.pageIdx=n,this._offset.matchIdx=null,this._offset.wrapped=!1,this._resumePageIdx=null,this._pageMatches.length=0,this._pageMatchesLength.length=0,R(this,zo,0),this._matchesCountTotal=0,I(this,Vo,zu).call(this);for(let o=0;o<a;o++)this._pendingFindMatches.has(o)||(this._pendingFindMatches.add(o),this._extractTextPromises[o].then(()=>{this._pendingFindMatches.delete(o),I(this,dg,Vk).call(this,o)}))}if(v(this,Ad,sy).length===0){I(this,Go,Vu).call(this,ha.FOUND);return}if(this._resumePageIdx)return;const s=this._offset;if(this._pagesToSearch=a,s.matchIdx!==null){const o=this._pageMatches[s.pageIdx].length;if(!e&&s.matchIdx+1<o||e&&s.matchIdx>0){s.matchIdx=e?s.matchIdx-1:s.matchIdx+1,I(this,pr,ch).call(this,!0);return}I(this,Id,ry).call(this,e)}I(this,Td,ly).call(this)},fg=new WeakSet,jk=function(e){const n=this._offset,a=e.length,i=v(this,un).findPrevious;return a?(n.matchIdx=i?a-1:0,I(this,pr,ch).call(this,!0),!0):(I(this,Id,ry).call(this,i),n.wrapped&&(n.matchIdx=null,this._pagesToSearch<0)?(I(this,pr,ch).call(this,!1),!0):!1)},Td=new WeakSet,ly=function(){this._resumePageIdx!==null&&console.error("There can only be one pending page.");let e=null;do{const n=this._offset.pageIdx;if(e=this._pageMatches[n],!e){this._resumePageIdx=n;break}}while(!I(this,fg,jk).call(this,e))},Id=new WeakSet,ry=function(e){const n=this._offset,a=this._linkService.pagesCount;n.pageIdx=e?n.pageIdx-1:n.pageIdx+1,n.matchIdx=null,this._pagesToSearch--,(n.pageIdx>=a||n.pageIdx<0)&&(n.pageIdx=e?a-1:0,n.wrapped=!0)},pr=new WeakSet,ch=function(e=!1){let n=ha.NOT_FOUND;const a=this._offset.wrapped;if(this._offset.wrapped=!1,e){const i=this._selected.pageIdx;this._selected.pageIdx=this._offset.pageIdx,this._selected.matchIdx=this._offset.matchIdx,n=a?ha.WRAPPED:ha.FOUND,i!==-1&&i!==this._selected.pageIdx&&I(this,fr,rh).call(this,i)}I(this,Go,Vu).call(this,n,v(this,un).findPrevious),this._selected.pageIdx!==-1&&(this._scrollMatches=!0,I(this,fr,rh).call(this,this._selected.pageIdx))},pg=new WeakSet,Kk=function(e){const n=this._pdfDocument;this._firstPageCapability.promise.then(()=>{!this._pdfDocument||n&&this._pdfDocument!==n||(this._findTimeout&&(clearTimeout(this._findTimeout),this._findTimeout=null),this._resumePageIdx&&(this._resumePageIdx=null,this._dirtyMatch=!0),I(this,Go,Vu).call(this,ha.FOUND),this._highlightMatches=!1,I(this,Vo,zu).call(this))})},Dd=new WeakSet,cy=function(){const{pageIdx:e,matchIdx:n}=this._selected;let a=0,i=this._matchesCountTotal;if(n!==-1){for(let s=0;s<e;s++)a+=this._pageMatches[s]?.length||0;a+=n+1}return(a<1||a>i)&&(a=i=0),{current:a,total:i}},$d=new WeakSet,dy=function(){this._eventBus.dispatch("updatefindmatchescount",{source:this,matchesCount:I(this,Dd,cy).call(this)})},Go=new WeakSet,Vu=function(e,n=!1){!v(this,ur)&&(v(this,zo)!==this._linkService.pagesCount||e===ha.PENDING)||this._eventBus.dispatch("updatefindcontrolstate",{source:this,state:e,previous:n,entireWord:v(this,un)?.entireWord??null,matchesCount:I(this,Dd,cy).call(this),rawQuery:v(this,un)?.query??null})};const OA=1e3;class BA{constructor(e,n,a){D(this,gg);D(this,Md,void 0);D(this,gr,new ResizeObserver(I(this,gg,Zk).bind(this)));this.opened=!1,this.bar=e.bar,this.toggleButton=e.toggleButton,this.findField=e.findField,this.highlightAll=e.highlightAllCheckbox,this.caseSensitive=e.caseSensitiveCheckbox,this.matchDiacritics=e.matchDiacriticsCheckbox,this.entireWord=e.entireWordCheckbox,this.findMsg=e.findMsg,this.findResultsCount=e.findResultsCount,this.findPreviousButton=e.findPreviousButton,this.findNextButton=e.findNextButton,this.eventBus=a,R(this,Md,n),this.toggleButton.addEventListener("click",()=>{this.toggle()}),this.findField.addEventListener("input",()=>{this.dispatchEvent("")}),this.bar.addEventListener("keydown",i=>{switch(i.keyCode){case 13:i.target===this.findField&&this.dispatchEvent("again",i.shiftKey);break;case 27:this.close();break}}),this.findPreviousButton.addEventListener("click",()=>{this.dispatchEvent("again",!0)}),this.findNextButton.addEventListener("click",()=>{this.dispatchEvent("again",!1)}),this.highlightAll.addEventListener("click",()=>{this.dispatchEvent("highlightallchange"),this.highlightAll.checked?this.highlightAll.parentElement.classList.remove("b3-button--outline"):this.highlightAll.parentElement.classList.add("b3-button--outline")}),this.caseSensitive.addEventListener("click",()=>{this.dispatchEvent("casesensitivitychange"),this.caseSensitive.checked?this.caseSensitive.parentElement.classList.remove("b3-button--outline"):this.caseSensitive.parentElement.classList.add("b3-button--outline")}),this.entireWord.addEventListener("click",()=>{this.dispatchEvent("entirewordchange"),this.entireWord.checked?this.entireWord.parentElement.classList.remove("b3-button--outline"):this.entireWord.parentElement.classList.add("b3-button--outline")}),this.matchDiacritics.addEventListener("click",()=>{this.dispatchEvent("diacriticmatchingchange"),this.matchDiacritics.checked?this.matchDiacritics.parentElement.classList.remove("b3-button--outline"):this.matchDiacritics.parentElement.classList.add("b3-button--outline")})}reset(){this.updateUIState()}dispatchEvent(e,n=!1){this.eventBus.dispatch("find",{source:this,type:e,query:this.findField.value,caseSensitive:this.caseSensitive.checked,entireWord:this.entireWord.checked,highlightAll:this.highlightAll.checked,findPrevious:n,matchDiacritics:this.matchDiacritics.checked})}updateUIState(e,n,a){const{findField:i,findMsg:s}=this;let o="",l="";switch(e){case ha.FOUND:break;case ha.PENDING:l="pending";break;case ha.NOT_FOUND:o=window.siyuan.languages.find_not_found,l="notFound";break;case ha.WRAPPED:o=window.siyuan.languages.find_not_found[`find_reached_${n?"top":"bottom"}`];break}i.setAttribute("data-status",l),i.setAttribute("aria-invalid",e===ha.NOT_FOUND),s.setAttribute("data-status",l),o?s.textContent=o:(s.removeAttribute("data-l10n-id"),s.textContent=""),this.updateResultsCount(a)}updateResultsCount({current:e=0,total:n=0}={}){const{findResultsCount:a}=this;if(n>0){const i=OA;a.textContent=n>i?window.siyuan.languages.find_match_count_limit.replace("{{limit}}",i):window.siyuan.languages.find_match_count.replace("{{current}}",e).replace("{{total}}",n)}else a.removeAttribute("data-l10n-id"),a.textContent=""}open(){this.opened||(v(this,gr).observe(v(this,Md)),v(this,gr).observe(this.bar),this.opened=!0,oi(this.toggleButton,!0,this.bar)),this.findField.select(),this.findField.focus()}close(){this.opened&&(v(this,gr).disconnect(),this.opened=!1,oi(this.toggleButton,!1,this.bar),this.eventBus.dispatch("findbarclose",{source:this}))}toggle(){this.opened?this.close():this.open()}}Md=new WeakMap,gr=new WeakMap,gg=new WeakSet,Zk=function(){const{bar:e}=this;e.classList.remove("wrapContainers");const n=e.clientHeight,a=e.firstElementChild.clientHeight;n>a&&e.classList.add("wrapContainers")};const qA=1e3,Zm=50,nE=1e3;function Jm(){return document.location.hash}class FA{constructor({linkService:e,eventBus:n}){D(this,za);D(this,hr);D(this,mr);D(this,Ts);D(this,br);D(this,Pd);D(this,hg);D(this,mg);D(this,Nd);D(this,bg);D(this,yg);D(this,Cs,null);this.linkService=e,this.eventBus=n,this._initialized=!1,this._fingerprint="",this.reset(),this.eventBus._on("pagesinit",()=>{this._isPagesLoaded=!1,this.eventBus._on("pagesloaded",a=>{this._isPagesLoaded=!!a.pagesCount},{once:!0})})}initialize({fingerprint:e,resetHistory:n=!1,updateUrl:a=!1}){if(!e||typeof e!="string"){console.error('PDFHistory.initialize: The "fingerprint" must be a non-empty string.');return}this._initialized&&this.reset();const i=this._fingerprint!==""&&this._fingerprint!==e;this._fingerprint=e,this._updateUrl=a===!0,this._initialized=!0,I(this,bg,Qk).call(this);const s=window.history.state;if(this._popStateInProgress=!1,this._blockHashChange=0,this._currentHash=Jm(),this._numPositionUpdates=0,this._uid=this._maxUid=0,this._destination=null,this._position=null,!I(this,Ts,Fr).call(this,s,!0)||n){const{hash:l,page:r,rotation:d}=I(this,Pd,uy).call(this,!0);if(!l||i||n){I(this,za,Vi).call(this,null,!0);return}I(this,za,Vi).call(this,{hash:l,page:r,rotation:d},!0);return}const o=s.destination;I(this,br,fh).call(this,o,s.uid,!0),o.rotation!==void 0&&(this._initialRotation=o.rotation),o.dest?(this._initialBookmark=JSON.stringify(o.dest),this._destination.page=null):o.hash?this._initialBookmark=o.hash:o.page&&(this._initialBookmark=`page=${o.page}`)}reset(){this._initialized&&(I(this,Nd,fy).call(this),this._initialized=!1,I(this,yg,eS).call(this)),this._updateViewareaTimeout&&(clearTimeout(this._updateViewareaTimeout),this._updateViewareaTimeout=null),this._initialBookmark=null,this._initialRotation=null}push({namedDest:e=null,explicitDest:n,pageNumber:a}){if(!this._initialized)return;if(e&&typeof e!="string"){console.error(`PDFHistory.push: "${e}" is not a valid namedDest parameter.`);return}else if(Array.isArray(n)){if(!I(this,mr,uh).call(this,a)&&(a!==null||this._destination)){console.error(`PDFHistory.push: "${a}" is not a valid pageNumber parameter.`);return}}else{console.error(`PDFHistory.push: "${n}" is not a valid explicitDest parameter.`);return}const i=e||JSON.stringify(n);if(!i)return;let s=!1;if(this._destination&&(UA(this._destination.hash,i)||WA(this._destination.dest,n))){if(this._destination.page)return;s=!0}this._popStateInProgress&&!s||(I(this,za,Vi).call(this,{dest:n,hash:i,page:a,rotation:this.linkService.rotation},s),this._popStateInProgress||(this._popStateInProgress=!0,Promise.resolve().then(()=>{this._popStateInProgress=!1})))}pushPage(e){if(this._initialized){if(!I(this,mr,uh).call(this,e)){console.error(`PDFHistory.pushPage: "${e}" is not a valid page number.`);return}this._destination?.page!==e&&(this._popStateInProgress||(I(this,za,Vi).call(this,{dest:null,hash:`page=${e}`,page:e,rotation:this.linkService.rotation}),this._popStateInProgress||(this._popStateInProgress=!0,Promise.resolve().then(()=>{this._popStateInProgress=!1}))))}}pushCurrentPosition(){!this._initialized||this._popStateInProgress||I(this,hr,dh).call(this)}back(){if(!this._initialized||this._popStateInProgress)return;const e=window.history.state;I(this,Ts,Fr).call(this,e)&&e.uid>0&&window.history.back()}forward(){if(!this._initialized||this._popStateInProgress)return;const e=window.history.state;I(this,Ts,Fr).call(this,e)&&e.uid<this._maxUid&&window.history.forward()}get popStateInProgress(){return this._initialized&&(this._popStateInProgress||this._blockHashChange>0)}get initialBookmark(){return this._initialized?this._initialBookmark:null}get initialRotation(){return this._initialized?this._initialRotation:null}}Cs=new WeakMap,za=new WeakSet,Vi=function(e,n=!1){const a=n||!this._destination,i={fingerprint:this._fingerprint,uid:a?this._uid:this._uid+1,destination:e};typeof PDFJSDev<"u"&&PDFJSDev.test("CHROME")&&window.history.state?.chromecomState&&(i.chromecomState=window.history.state.chromecomState),I(this,br,fh).call(this,e,i.uid);let s;if(this._updateUrl&&e?.hash){const o=document.location.href.split("#",1)[0];o.startsWith("file://")||(s=`${o}#${e.hash}`)}a?window.history.replaceState(i,"",s):window.history.pushState(i,"",s)},hr=new WeakSet,dh=function(e=!1){if(!this._position)return;let n=this._position;if(e&&(n=Object.assign(Object.create(null),this._position),n.temporary=!0),!this._destination){I(this,za,Vi).call(this,n);return}if(this._destination.temporary){I(this,za,Vi).call(this,n,!0);return}if(this._destination.hash===n.hash||!this._destination.page&&(Zm<=0||this._numPositionUpdates<=Zm))return;let a=!1;if(this._destination.page>=n.first&&this._destination.page<=n.page){if(this._destination.dest!==void 0||!this._destination.first)return;a=!0}I(this,za,Vi).call(this,n,a)},mr=new WeakSet,uh=function(e){return Number.isInteger(e)&&e>0&&e<=this.linkService.pagesCount},Ts=new WeakSet,Fr=function(e,n=!1){if(!e)return!1;if(e.fingerprint!==this._fingerprint)if(n){if(typeof e.fingerprint!="string"||e.fingerprint.length!==this._fingerprint.length)return!1;const[a]=performance.getEntriesByType("navigation");if(a?.type!=="reload")return!1}else return!1;return!(!Number.isInteger(e.uid)||e.uid<0||e.destination===null||typeof e.destination!="object")},br=new WeakSet,fh=function(e,n,a=!1){this._updateViewareaTimeout&&(clearTimeout(this._updateViewareaTimeout),this._updateViewareaTimeout=null),a&&e?.temporary&&delete e.temporary,this._destination=e,this._uid=n,this._maxUid=Math.max(this._maxUid,n),this._numPositionUpdates=0},Pd=new WeakSet,uy=function(e=!1){const n=unescape(Jm()).substring(1),a=Tc(n),i=a.get("nameddest")||"";let s=a.get("page")|0;return(!I(this,mr,uh).call(this,s)||e&&i.length>0)&&(s=null),{hash:n,page:s,rotation:this.linkService.rotation}},hg=new WeakSet,Jk=function({location:e}){this._updateViewareaTimeout&&(clearTimeout(this._updateViewareaTimeout),this._updateViewareaTimeout=null),this._position={hash:e.pdfOpenParams.substring(1),page:this.linkService.page,first:e.pageNumber,rotation:e.rotation},!this._popStateInProgress&&(Zm>0&&this._isPagesLoaded&&this._destination&&!this._destination.page&&this._numPositionUpdates++,nE>0&&(this._updateViewareaTimeout=setTimeout(()=>{this._popStateInProgress||I(this,hr,dh).call(this,!0),this._updateViewareaTimeout=null},nE)))},mg=new WeakSet,Xk=function({state:e}){const n=Jm(),a=this._currentHash!==n;if(this._currentHash=n,typeof PDFJSDev<"u"&&PDFJSDev.test("CHROME")&&e?.chromecomState&&!I(this,Ts,Fr).call(this,e)||!e){this._uid++;const{hash:s,page:o,rotation:l}=I(this,Pd,uy).call(this);I(this,za,Vi).call(this,{hash:s,page:o,rotation:l},!0);return}if(!I(this,Ts,Fr).call(this,e))return;this._popStateInProgress=!0,a&&(this._blockHashChange++,zv({target:window,name:"hashchange",delay:qA}).then(()=>{this._blockHashChange--}));const i=e.destination;I(this,br,fh).call(this,i,e.uid,!0),cp(i.rotation)&&(this.linkService.rotation=i.rotation),i.dest?this.linkService.goToDestination(i.dest):i.hash?this.linkService.setHash(i.hash):i.page&&(this.linkService.page=i.page),Promise.resolve().then(()=>{this._popStateInProgress=!1})},Nd=new WeakSet,fy=function(){(!this._destination||this._destination.temporary)&&I(this,hr,dh).call(this)},bg=new WeakSet,Qk=function(){if(v(this,Cs))return;R(this,Cs,new AbortController);const{signal:e}=v(this,Cs);this.eventBus._on("updateviewarea",I(this,hg,Jk).bind(this),{signal:e}),window.addEventListener("popstate",I(this,mg,Xk).bind(this),{signal:e}),window.addEventListener("pagehide",I(this,Nd,fy).bind(this),{signal:e})},yg=new WeakSet,eS=function(){v(this,Cs)?.abort(),R(this,Cs,null)};function UA(t,e){return typeof t!="string"||typeof e!="string"?!1:t===e||Tc(t).get("nameddest")===e}function WA(t,e){function n(a,i){if(typeof a!=typeof i||Array.isArray(a)||Array.isArray(i))return!1;if(a!==null&&typeof a=="object"&&i!==null){if(Object.keys(a).length!==Object.keys(i).length)return!1;for(const s in a)if(!n(a[s],i[s]))return!1;return!0}return a===i||Number.isNaN(a)&&Number.isNaN(i)}if(!(Array.isArray(t)&&Array.isArray(e))||t.length!==e.length)return!1;for(let a=0,i=t.length;a<i;a++)if(!n(t[a],e[a]))return!1;return!0}class YA extends Mc{constructor(n){super(n);D(this,Hd);this.eventBus._on("optionalcontentconfigchanged",a=>{I(this,Hd,py).call(this,a.promise)}),this.eventBus._on("resetlayers",()=>{I(this,Hd,py).call(this)}),this.eventBus._on("togglelayerstree",this._toggleAllTreeItems.bind(this))}reset(){super.reset(),this._optionalContentConfig=null,this._optionalContentVisibility?.clear(),this._optionalContentVisibility=null}_dispatchEvent(n){this.eventBus.dispatch("layersloaded",{source:this,layersCount:n})}_bindLink(n,{groupId:a,input:i}){const s=()=>{const o=i.checked;this._optionalContentConfig.setVisibility(a,o);const l=this._optionalContentVisibility.get(a);l&&(l.visible=o),this.eventBus.dispatch("optionalcontentconfig",{source:this,promise:Promise.resolve(this._optionalContentConfig)})};n.onclick=o=>o.target===i?(s(),!0):o.target!==n?!0:(i.checked=!i.checked,s(),!1)}_setNestedName(n,{name:a=null}){if(typeof a=="string"){n.textContent=this._normalizeTextContent(a);return}n.textContent=window.siyuan.languages.additionalLayers,n.style.fontStyle="italic",this._l10n.translateOnce(n)}_addToggleButton(n,{name:a=null}){super._addToggleButton(n,a===null)}_toggleAllTreeItems(){this._optionalContentConfig&&super._toggleAllTreeItems()}render({optionalContentConfig:n,pdfDocument:a}){this._optionalContentConfig&&this.reset(),this._optionalContentConfig=n||null,this._pdfDocument=a||null;const i=n?.getOrder();if(!i){this._dispatchEvent(0);return}this._optionalContentVisibility=new Map;const s=document.createDocumentFragment(),o=[{parent:s,groups:i}];let l=0,r=!1;for(;o.length>0;){const d=o.shift();for(const c of d.groups){const f=document.createElement("div");f.className="treeItem";const g=document.createElement("a");if(f.append(g),typeof c=="object"){r=!0,this._addToggleButton(f,c),this._setNestedName(g,c);const p=document.createElement("div");p.className="treeItems",f.append(p),o.push({parent:p,groups:c.order})}else{const p=n.getGroup(c),h=document.createElement("input");this._bindLink(g,{groupId:c,input:h}),h.type="checkbox",h.checked=p.visible,this._optionalContentVisibility.set(c,{input:h,visible:h.checked});const m=document.createElement("label");m.textContent=this._normalizeTextContent(p.name),m.append(h),g.append(m),l++}d.parent.append(f)}}this._finishRendering(s,l,r)}}Hd=new WeakSet,py=async function(n=null){if(!this._optionalContentConfig)return;const a=this._pdfDocument,i=await(n||a.getOptionalContentConfig({intent:"display"}));if(a===this._pdfDocument){if(n){for(const[s,o]of this._optionalContentVisibility){const l=i.getGroup(s);l&&o.visible!==l.visible&&(o.input.checked=o.visible=!o.visible)}return}this.eventBus.dispatch("optionalcontentconfig",{source:this,promise:Promise.resolve(i)}),this.render({optionalContentConfig:i,pdfDocument:this._pdfDocument})}};class zA extends Mc{constructor(e){super(e),this.linkService=e.linkService,this.downloadManager=e.downloadManager,this.eventBus._on("toggleoutlinetree",this._toggleAllTreeItems.bind(this)),this.eventBus._on("currentoutlineitem",this._currentOutlineItem.bind(this)),this.eventBus._on("pagechanging",n=>{this._currentPageNumber=n.pageNumber}),this.eventBus._on("pagesloaded",n=>{this._isPagesLoaded=!!n.pagesCount,this._currentOutlineItemCapability?.resolve(this._isPagesLoaded)}),this.eventBus._on("sidebarviewchanged",n=>{this._sidebarView=n.view})}reset(){super.reset(),this._outline=null,this._pageNumberToDestHashCapability=null,this._currentPageNumber=1,this._isPagesLoaded=null,this._currentOutlineItemCapability?.resolve(!1),this._currentOutlineItemCapability=null}_dispatchEvent(e){this._currentOutlineItemCapability=Promise.withResolvers(),e===0||this._pdfDocument?.loadingParams.disableAutoFetch?this._currentOutlineItemCapability.resolve(!1):this._isPagesLoaded!==null&&this._currentOutlineItemCapability.resolve(this._isPagesLoaded),this.eventBus.dispatch("outlineloaded",{source:this,outlineCount:e,currentOutlineItemPromise:this._currentOutlineItemCapability.promise})}_bindLink(e,{url:n,newWindow:a,action:i,attachment:s,dest:o,setOCGState:l}){const{linkService:r}=this;if(n){r.addLinkAttributes(e,n,a);return}if(i){e.href=r.getAnchorUrl(""),e.onclick=()=>(r.executeNamedAction(i),!1);return}if(s){e.href=r.getAnchorUrl(""),e.onclick=()=>(this.downloadManager.openOrDownloadData(s.content,s.filename),!1);return}if(l){e.href=r.getAnchorUrl(""),e.onclick=()=>(r.executeSetOCGState(l),!1);return}e.href=r.getDestinationHash(o),e.onclick=d=>(this._updateCurrentTreeItem(d.target.parentNode),o&&r.goToDestination(o),!1)}_setStyles(e,{bold:n,italic:a}){n&&(e.style.fontWeight="bold"),a&&(e.style.fontStyle="italic")}_addToggleButton(e,{count:n,items:a}){let i=!1;if(n<0){let s=a.length;if(s>0){const o=[...a];for(;o.length>0;){const{count:l,items:r}=o.shift();l>0&&r.length>0&&(s+=r.length,o.push(...r))}}Math.abs(n)===s&&(i=!0)}super._addToggleButton(e,i)}_toggleAllTreeItems(){this._outline&&super._toggleAllTreeItems()}render({outline:e,pdfDocument:n}){if(this._outline&&this.reset(),this._outline=e||null,this._pdfDocument=n||null,!e){this._dispatchEvent(0);return}const a=document.createDocumentFragment(),i=[{parent:a,items:e}];let s=0,o=!1;for(;i.length>0;){const l=i.shift();for(const r of l.items){const d=document.createElement("div");d.className="treeItem";const c=document.createElement("a");if(this._bindLink(c,r),this._setStyles(c,r),c.textContent=this._normalizeTextContent(r.title),d.append(c),r.items.length>0){o=!0,this._addToggleButton(d,r);const f=document.createElement("div");f.className="treeItems",d.append(f),i.push({parent:f,items:r.items})}l.parent.append(d),s++}}this._finishRendering(a,s,o)}async _currentOutlineItem(){if(!this._isPagesLoaded)throw new Error("_currentOutlineItem: All pages have not been loaded.");if(!this._outline||!this._pdfDocument)return;const e=await this._getPageNumberToDestHash(this._pdfDocument);if(e&&(this._updateCurrentTreeItem(null),this._sidebarView===Me.OUTLINE))for(let n=this._currentPageNumber;n>0;n--){const a=e.get(n);if(!a)continue;const i=this.container.querySelector(`a[href="${a}"]`);if(i){this._scrollToCurrentTreeItem(i.parentNode);break}}}async _getPageNumberToDestHash(e){if(this._pageNumberToDestHashCapability)return this._pageNumberToDestHashCapability.promise;this._pageNumberToDestHashCapability=Promise.withResolvers();const n=new Map,a=new Map,i=[{nesting:0,items:this._outline}];for(;i.length>0;){const s=i.shift(),o=s.nesting;for(const{dest:l,items:r}of s.items){let d,c;if(typeof l=="string"){if(d=await e.getDestination(l),e!==this._pdfDocument)return null}else d=l;if(Array.isArray(d)){const[f]=d;if(f&&typeof f=="object"?c=e.cachedPageNumber(f):Number.isInteger(f)&&(c=f+1),Number.isInteger(c)&&(!n.has(c)||o>a.get(c))){const g=this.linkService.getDestinationHash(l);n.set(c,g),a.set(c,o)}}r.length>0&&i.push({nesting:o+1,items:r})}}return this._pageNumberToDestHashCapability.resolve(n.size>0?n:null),this._pageNumberToDestHashCapability.promise}}const VA=3e3,aE="pdfPresentationMode",Xm="pdfPresentationModeControls",GA=50,jA=.1,iE=50,Qm=Math.PI/6;class KA{constructor({container:e,pdfViewer:n,eventBus:a}){D(this,wg);D(this,jo);D(this,_g);D(this,vg);D(this,Eg);D(this,kg);D(this,Rd);D(this,Sg);D(this,Ko);D(this,Lg);D(this,xg);D(this,Ag);D(this,Cg);D(this,Od);D(this,yr,on.UNKNOWN);D(this,Sn,null);D(this,Is,null);D(this,Ds,null);this.container=e,this.pdfViewer=n,this.eventBus=a,this.contextMenuOpen=!1,this.mouseScrollTimeStamp=0,this.mouseScrollDelta=0,this.touchSwipeState=null}async request(){const{container:e,pdfViewer:n}=this;if(this.active||!n.pagesCount||!e.requestFullscreen)return!1;I(this,Cg,dS).call(this),I(this,jo,Gu).call(this,on.CHANGING);const a=e.requestFullscreen();R(this,Sn,{pageNumber:n.currentPageNumber,scaleValue:n.currentScaleValue,scrollMode:n.scrollMode,spreadMode:null,annotationEditorMode:null}),n.spreadMode!==_t.NONE&&!(n.pageViewsReady&&n.hasEqualPageSizes)&&(console.warn("Ignoring Spread modes when entering PresentationMode, since the document may contain varying page sizes."),v(this,Sn).spreadMode=n.spreadMode),n.annotationEditorMode!==G.AnnotationEditorType.DISABLE&&(v(this,Sn).annotationEditorMode=n.annotationEditorMode);try{return await a,n.focus(),!0}catch{I(this,Od,hy).call(this),I(this,jo,Gu).call(this,on.NORMAL)}return!1}get active(){return v(this,yr)===on.CHANGING||v(this,yr)===on.FULLSCREEN}}yr=new WeakMap,Sn=new WeakMap,Is=new WeakMap,Ds=new WeakMap,wg=new WeakSet,tS=function(e){if(!this.active)return;e.preventDefault();const n=Vx(e),a=Date.now(),i=this.mouseScrollTimeStamp;if(!(a>i&&a-i<GA)&&((this.mouseScrollDelta>0&&n<0||this.mouseScrollDelta<0&&n>0)&&I(this,Ko,ju).call(this),this.mouseScrollDelta+=n,Math.abs(this.mouseScrollDelta)>=jA)){const s=this.mouseScrollDelta;I(this,Ko,ju).call(this),(s>0?this.pdfViewer.previousPage():this.pdfViewer.nextPage())&&(this.mouseScrollTimeStamp=a)}},jo=new WeakSet,Gu=function(e){R(this,yr,e),this.eventBus.dispatch("presentationmodechanged",{source:this,state:e})},_g=new WeakSet,nS=function(){I(this,jo,Gu).call(this,on.FULLSCREEN),this.container.classList.add(aE),setTimeout(()=>{this.pdfViewer.scrollMode=Te.PAGE,v(this,Sn).spreadMode!==null&&(this.pdfViewer.spreadMode=_t.NONE),this.pdfViewer.currentPageNumber=v(this,Sn).pageNumber,this.pdfViewer.currentScaleValue="page-fit",v(this,Sn).annotationEditorMode!==null&&(this.pdfViewer.annotationEditorMode={mode:G.AnnotationEditorType.NONE})},0),I(this,xg,rS).call(this),I(this,Rd,gy).call(this),this.contextMenuOpen=!1,document.getSelection().empty()},vg=new WeakSet,aS=function(){const e=this.pdfViewer.currentPageNumber;this.container.classList.remove(aE),setTimeout(()=>{I(this,Od,hy).call(this),I(this,jo,Gu).call(this,on.NORMAL),this.pdfViewer.scrollMode=v(this,Sn).scrollMode,v(this,Sn).spreadMode!==null&&(this.pdfViewer.spreadMode=v(this,Sn).spreadMode),this.pdfViewer.currentScaleValue=v(this,Sn).scaleValue,this.pdfViewer.currentPageNumber=e,v(this,Sn).annotationEditorMode!==null&&(this.pdfViewer.annotationEditorMode={mode:v(this,Sn).annotationEditorMode}),R(this,Sn,null)},0),I(this,Ag,cS).call(this),I(this,Sg,oS).call(this),I(this,Ko,ju).call(this),this.contextMenuOpen=!1},Eg=new WeakSet,iS=function(e){if(this.contextMenuOpen){this.contextMenuOpen=!1,e.preventDefault();return}e.button===0&&(e.target.href&&e.target.parentNode?.hasAttribute("data-internal-link")||(e.preventDefault(),e.shiftKey?this.pdfViewer.previousPage():this.pdfViewer.nextPage()))},kg=new WeakSet,sS=function(){this.contextMenuOpen=!0},Rd=new WeakSet,gy=function(){this.controlsTimeout?clearTimeout(this.controlsTimeout):this.container.classList.add(Xm),this.controlsTimeout=setTimeout(()=>{this.container.classList.remove(Xm),delete this.controlsTimeout},VA)},Sg=new WeakSet,oS=function(){this.controlsTimeout&&(clearTimeout(this.controlsTimeout),this.container.classList.remove(Xm),delete this.controlsTimeout)},Ko=new WeakSet,ju=function(){this.mouseScrollTimeStamp=0,this.mouseScrollDelta=0},Lg=new WeakSet,lS=function(e){if(this.active){if(e.touches.length>1){this.touchSwipeState=null;return}switch(e.type){case"touchstart":this.touchSwipeState={startX:e.touches[0].pageX,startY:e.touches[0].pageY,endX:e.touches[0].pageX,endY:e.touches[0].pageY};break;case"touchmove":if(this.touchSwipeState===null)return;this.touchSwipeState.endX=e.touches[0].pageX,this.touchSwipeState.endY=e.touches[0].pageY,e.preventDefault();break;case"touchend":if(this.touchSwipeState===null)return;let n=0;const a=this.touchSwipeState.endX-this.touchSwipeState.startX,i=this.touchSwipeState.endY-this.touchSwipeState.startY,s=Math.abs(Math.atan2(i,a));Math.abs(a)>iE&&(s<=Qm||s>=Math.PI-Qm)?n=a:Math.abs(i)>iE&&Math.abs(s-Math.PI/2)<=Qm&&(n=i),n>0?this.pdfViewer.previousPage():n<0&&this.pdfViewer.nextPage();break}}},xg=new WeakSet,rS=function(){if(v(this,Ds))return;R(this,Ds,new AbortController);const{signal:e}=v(this,Ds),n=I(this,Lg,lS).bind(this);window.addEventListener("mousemove",I(this,Rd,gy).bind(this),{signal:e}),window.addEventListener("mousedown",I(this,Eg,iS).bind(this),{signal:e}),window.addEventListener("wheel",I(this,wg,tS).bind(this),{passive:!1,signal:e}),window.addEventListener("keydown",I(this,Ko,ju).bind(this),{signal:e}),window.addEventListener("contextmenu",I(this,kg,sS).bind(this),{signal:e}),window.addEventListener("touchstart",n,{signal:e}),window.addEventListener("touchmove",n,{signal:e}),window.addEventListener("touchend",n,{signal:e})},Ag=new WeakSet,cS=function(){v(this,Ds)?.abort(),R(this,Ds,null)},Cg=new WeakSet,dS=function(){v(this,Is)||(R(this,Is,new AbortController),window.addEventListener("fullscreenchange",()=>{document.fullscreenElement?I(this,_g,nS).call(this):I(this,vg,aS).call(this)},{signal:v(this,Is).signal}))},Od=new WeakSet,hy=function(){v(this,Is)?.abort(),R(this,Is,null)};class sE{constructor({pdfPage:e,annotationStorage:n=null,linkService:a,xfaHtml:i=null}){this.pdfPage=e,this.annotationStorage=n,this.linkService=a,this.xfaHtml=i,this.div=null,this._cancelled=!1}async render(e,n="display"){if(n==="print"){const s={viewport:e.clone({dontFlip:!0}),div:this.div,xfaHtml:this.xfaHtml,annotationStorage:this.annotationStorage,linkService:this.linkService,intent:n};return this.div=document.createElement("div"),s.div=this.div,G.XfaLayer.render(s)}const a=await this.pdfPage.getXfa();if(this._cancelled||!a)return{textDivs:[]};const i={viewport:e.clone({dontFlip:!0}),div:this.div,xfaHtml:a,annotationStorage:this.annotationStorage,linkService:this.linkService,intent:n};return this.div?G.XfaLayer.update(i):(this.div=document.createElement("div"),i.div=this.div,G.XfaLayer.render(i))}cancel(){this._cancelled=!0}hide(){this.div&&(this.div.hidden=!0)}}function ZA(t,e){const n=e.allXfaHtml,a=new Fm,i=Math.round(G.PixelsPerInch.PDF_TO_CSS_UNITS*100)/100;for(const s of n.children){const o=document.createElement("div");o.className="xfaPrintedPage",t.append(o);const l=new sE({pdfPage:null,annotationStorage:e.annotationStorage,linkService:a,xfaHtml:s}),r=(0,G.getXfaPageViewport)(s,{scale:i});l.render(r,"print"),o.append(l.div)}}let Qn=null,Ua=null,ps=null,oE={initialized:!1};function JA(t,e,n,a,i,s,o){const l=Qn.scratchCanvas,r=i/G.PixelsPerInch.PDF;l.width=Math.floor(a.width*r),l.height=Math.floor(a.height*r);const d=l.getContext("2d");return d.save(),d.fillStyle="rgb(255, 255, 255)",d.fillRect(0,0,l.width,l.height),d.restore(),Promise.all([e.getPage(n),o]).then(function([c,f]){const g={canvasContext:d,transform:[r,0,0,r,0,0],viewport:c.getViewport({scale:1,rotation:a.rotation}),intent:"print",annotationMode:G.AnnotationMode.ENABLE_STORAGE,optionalContentConfigPromise:s,printAnnotationStorage:f};return c.render(g).promise.catch(h=>{throw h instanceof G.RenderingCancelledException||console.error(h),h})})}class XA{constructor({pdfDocument:e,pagesOverview:n,printContainer:a,printResolution:i,printAnnotationStoragePromise:s=null}){this.pdfDocument=e,this.pagesOverview=n,this.printContainer=a,this._printResolution=i||150,this._optionalContentConfigPromise=e.getOptionalContentConfig({intent:"print"}),this._printAnnotationStoragePromise=s||Promise.resolve(),this.currentPage=-1,this.scratchCanvas=document.createElement("canvas")}layout(){this.throwIfInactive();const e=document.querySelector("body");e.setAttribute("data-pdfjsprinting",!0);const{width:n,height:a}=this.pagesOverview[0];this.pagesOverview.every(s=>s.width===n&&s.height===a)||console.warn("Not all pages have the same size. The printed result may be incorrect!"),this.pageStyleSheet=document.createElement("style"),this.pageStyleSheet.textContent=`@page { size: ${n}pt ${a}pt;}`,e.append(this.pageStyleSheet)}destroy(){if(Qn!==this)return;this.printContainer.textContent="",document.querySelector("body").removeAttribute("data-pdfjsprinting"),this.pageStyleSheet&&(this.pageStyleSheet.remove(),this.pageStyleSheet=null),this.scratchCanvas.width=this.scratchCanvas.height=0,this.scratchCanvas=null,Qn=null,nb().then(function(){ps.active===Ua&&ps.close(Ua)})}renderPages(){if(this.pdfDocument.isPureXfa)return ZA(this.printContainer,this.pdfDocument),Promise.resolve();const e=this.pagesOverview.length,n=(a,i)=>{if(this.throwIfInactive(),++this.currentPage>=e){rE(e,e),a();return}const s=this.currentPage;rE(s,e),JA(this,this.pdfDocument,s+1,this.pagesOverview[s],this._printResolution,this._optionalContentConfigPromise,this._printAnnotationStoragePromise).then(this.useRenderedPage.bind(this)).then(function(){n(a,i)},i)};return new Promise(n)}useRenderedPage(){this.throwIfInactive();const e=document.createElement("img");this.scratchCanvas.toBlob(o=>{e.src=URL.createObjectURL(o)});const n=document.createElement("div");n.className="printedPage",n.append(e),this.printContainer.append(n);const{promise:a,resolve:i,reject:s}=Promise.withResolvers();return e.onload=i,e.onerror=s,a.catch(()=>{}).then(()=>{URL.revokeObjectURL(e.src)}),a}performPrint(){return this.throwIfInactive(),new Promise(e=>{setTimeout(()=>{if(!this.active){e();return}QA.call(window),setTimeout(e,20)},0)})}get active(){return this===Qn}throwIfInactive(){if(!this.active)throw new Error("This print request was cancelled or completed.")}}const QA=window.print;window.print=function(){if(Qn){console.warn("Ignored window.print() because of a pending print job.");return}nb().then(function(){Qn&&ps.open(Ua)});try{lE("beforeprint")}finally{if(!Qn){console.error("Expected print service to be initialized."),nb().then(function(){ps.active===Ua&&ps.close(Ua)});return}const t=Qn;Qn.renderPages().then(function(){return t.performPrint()}).catch(function(){}).then(function(){t.active&&eb()})}};function lE(t){const e=new CustomEvent(t,{bubbles:!1,cancelable:!1,detail:"custom"});window.dispatchEvent(e)}function eb(){Qn&&(Qn.destroy(),lE("afterprint"))}function rE(t,e){if(typeof PDFJSDev>"u"&&window.isGECKOVIEW)return;Ua||=document.getElementById("printServiceDialog");const n=Math.round(100*t/e),a=Ua.querySelector("progress"),i=Ua.querySelector(".relative-progress");a.value=n,i.setAttribute("data-l10n-args",JSON.stringify({progress:n}))}if("onbeforeprint"in window){const t=function(e){e.detail!=="custom"&&e.stopImmediatePropagation()};window.addEventListener("beforeprint",t),window.addEventListener("afterprint",t)}let tb;function nb(){if(typeof PDFJSDev>"u"&&window.isGECKOVIEW)return Promise.reject(new Error("ensureOverlay not implemented in GECKOVIEW development mode."));if(!tb){if(ps=oE.overlayManager,!ps)throw new Error("The overlay manager has not yet been initialized.");Ua||=document.getElementById("printServiceDialog"),tb=ps.register(Ua,!0),document.getElementById("printCancel").onclick=eb,Ua.addEventListener("close",eb)}return tb}class cE{static initGlobals(e){oE=e}static get supportsPrinting(){return(0,G.shadow)(this,"supportsPrinting",!0)}static createPrintService(e){if(Qn)throw new Error("The print service is created and active.");return Qn=new XA(e)}}const eC=3e4;class dE{constructor(){this.pdfViewer=null,this.pdfThumbnailViewer=null,this.onIdle=null,this.highestPriorityPage=null,this.idleTimeout=null,this.printing=!1,this.isThumbnailViewEnabled=!1,(typeof PDFJSDev>"u"||PDFJSDev.test("GENERIC"))&&Object.defineProperty(this,"hasViewer",{value:()=>!!this.pdfViewer})}setViewer(e){this.pdfViewer=e}setThumbnailViewer(e){this.pdfThumbnailViewer=e}isHighestPriority(e){return this.highestPriorityPage===e.renderingId}renderHighestPriority(e){this.idleTimeout&&(clearTimeout(this.idleTimeout),this.idleTimeout=null),!this.pdfViewer.forceRendering(e)&&(this.isThumbnailViewEnabled&&this.pdfThumbnailViewer?.forceRendering()||this.printing||this.onIdle&&(this.idleTimeout=setTimeout(this.onIdle.bind(this),eC)))}getHighestPriority(e,n,a,i=!1){const s=e.views,o=s.length;if(o===0)return null;for(let f=0;f<o;f++){const g=s[f].view;if(!this.isViewFinished(g))return g}const l=e.first.id,r=e.last.id;if(r-l+1>o){const f=e.ids;for(let g=1,p=r-l;g<p;g++){const h=a?l+g:r-g;if(f.has(h))continue;const m=n[h-1];if(!this.isViewFinished(m))return m}}let d=a?r:l-2,c=n[d];return c&&!this.isViewFinished(c)||i&&(d+=a?1:-1,c=n[d],c&&!this.isViewFinished(c))?c:null}isViewFinished(e){return e.renderingState===We.FINISHED}renderView(e){switch(e.renderingState){case We.FINISHED:return!1;case We.PAUSED:this.highestPriorityPage=e.renderingId,e.resume();break;case We.RUNNING:this.highestPriorityPage=e.renderingId;break;case We.INITIAL:this.highestPriorityPage=e.renderingId,e.draw().finally(()=>{this.renderHighestPriority()}).catch(n=>{n instanceof G.RenderingCancelledException||console.error(`renderView: "${n}"`)});break}return!0}}class tC{constructor({eventBus:e,externalServices:n=null,docProperties:a=null}){D(this,Tg);D(this,_r);D(this,Fd);D(this,Ig);D(this,Qo);D(this,pi,null);D(this,Zo,null);D(this,Bd,null);D(this,Jo,null);D(this,Xo,null);D(this,qd,null);D(this,Nn,null);D(this,qi,null);D(this,wr,!1);D(this,en,null);D(this,xa,null);R(this,Xo,e),R(this,qd,n),R(this,Bd,a),typeof PDFJSDev<"u"&&PDFJSDev.test("TESTING")&&Object.defineProperty(this,"sandboxTrip",{value:()=>setTimeout(()=>v(this,en)?.dispatchEventInSandbox({name:"sandboxtripbegin"}),0)})}setViewer(e){R(this,qi,e)}async setDocument(e){if(v(this,Nn)&&await I(this,Qo,Ku).call(this),R(this,Nn,e),!e)return;const[n,a,i]=await Promise.all([e.getFieldObjects(),e.getCalculationOrderIds(),e.getJSActions()]);if(!n&&!i){await I(this,Qo,Ku).call(this);return}if(e!==v(this,Nn))return;try{R(this,en,I(this,Ig,fS).call(this))}catch(l){console.error(`setDocument: "${l.message}".`),await I(this,Qo,Ku).call(this);return}const s=v(this,Xo);R(this,Jo,new AbortController);const{signal:o}=v(this,Jo);s._on("updatefromsandbox",l=>{l?.source===window&&I(this,Tg,uS).call(this,l.detail)},{signal:o}),s._on("dispatcheventinsandbox",l=>{v(this,en)?.dispatchEventInSandbox(l.detail)},{signal:o}),s._on("pagechanging",({pageNumber:l,previous:r})=>{l!==r&&(I(this,Fd,my).call(this,r),I(this,_r,ph).call(this,l))},{signal:o}),s._on("pagerendered",({pageNumber:l})=>{this._pageOpenPending.has(l)&&l===v(this,qi).currentPageNumber&&I(this,_r,ph).call(this,l)},{signal:o}),s._on("pagesdestroy",async()=>{await I(this,Fd,my).call(this,v(this,qi).currentPageNumber),await v(this,en)?.dispatchEventInSandbox({id:"doc",name:"WillClose"}),v(this,pi)?.resolve()},{signal:o});try{const l=await v(this,Bd).call(this,e);if(e!==v(this,Nn))return;await v(this,en).createSandbox({objects:n,calculationOrder:a,appInfo:{platform:navigator.platform,language:navigator.language},docInfo:{...l,actions:i}}),s.dispatch("sandboxcreated",{source:this})}catch(l){console.error(`setDocument: "${l.message}".`),await I(this,Qo,Ku).call(this);return}await v(this,en)?.dispatchEventInSandbox({id:"doc",name:"Open"}),await I(this,_r,ph).call(this,v(this,qi).currentPageNumber,!0),Promise.resolve().then(()=>{e===v(this,Nn)&&R(this,wr,!0)})}async dispatchWillSave(){return v(this,en)?.dispatchEventInSandbox({id:"doc",name:"WillSave"})}async dispatchDidSave(){return v(this,en)?.dispatchEventInSandbox({id:"doc",name:"DidSave"})}async dispatchWillPrint(){if(v(this,en)){await v(this,xa)?.promise,R(this,xa,Promise.withResolvers());try{await v(this,en).dispatchEventInSandbox({id:"doc",name:"WillPrint"})}catch(e){throw v(this,xa).resolve(),R(this,xa,null),e}await v(this,xa).promise}}async dispatchDidPrint(){return v(this,en)?.dispatchEventInSandbox({id:"doc",name:"DidPrint"})}get destroyPromise(){return v(this,Zo)?.promise||null}get ready(){return v(this,wr)}get _pageOpenPending(){return(0,G.shadow)(this,"_pageOpenPending",new Set)}get _visitedPages(){return(0,G.shadow)(this,"_visitedPages",new Map)}}pi=new WeakMap,Zo=new WeakMap,Bd=new WeakMap,Jo=new WeakMap,Xo=new WeakMap,qd=new WeakMap,Nn=new WeakMap,qi=new WeakMap,wr=new WeakMap,en=new WeakMap,xa=new WeakMap,Tg=new WeakSet,uS=async function(e){const n=v(this,qi),a=n.isInPresentationMode||n.isChangingPresentationMode,{id:i,siblings:s,command:o,value:l}=e;if(!i){if(typeof PDFJSDev<"u"&&PDFJSDev.test("TESTING")&&o==="sandboxTripEnd"){window.setTimeout(()=>{window.dispatchEvent(new CustomEvent("sandboxtripend"))},0);return}switch(o){case"clear":console.clear();break;case"error":console.error(l);break;case"layout":if(!a){const d=Wv(l);n.spreadMode=d.spreadMode}break;case"page-num":n.currentPageNumber=l+1;break;case"print":await n.pagesPromise,v(this,Xo).dispatch("print",{source:this});break;case"println":console.log(l);break;case"zoom":a||(n.currentScaleValue=l);break;case"SaveAs":v(this,Xo).dispatch("download",{source:this});break;case"FirstPage":n.currentPageNumber=1;break;case"LastPage":n.currentPageNumber=n.pagesCount;break;case"NextPage":n.nextPage();break;case"PrevPage":n.previousPage();break;case"ZoomViewIn":a||n.increaseScale();break;case"ZoomViewOut":a||n.decreaseScale();break;case"WillPrintFinished":v(this,xa)?.resolve(),R(this,xa,null);break}return}if(a&&e.focus)return;delete e.id,delete e.siblings;const r=s?[i,...s]:[i];for(const d of r){const c=document.querySelector(`[data-element-id="${d}"]`);c?c.dispatchEvent(new CustomEvent("updatefromsandbox",{detail:e})):v(this,Nn)?.annotationStorage.setValue(d,e)}},_r=new WeakSet,ph=async function(e,n=!1){const a=v(this,Nn),i=this._visitedPages;if(n&&R(this,pi,Promise.withResolvers()),!v(this,pi))return;const s=v(this,qi).getPageView(e-1);if(s?.renderingState!==We.FINISHED){this._pageOpenPending.add(e);return}this._pageOpenPending.delete(e);const o=(async()=>{const l=await(i.has(e)?null:s.pdfPage?.getJSActions());a===v(this,Nn)&&await v(this,en)?.dispatchEventInSandbox({id:"page",name:"PageOpen",pageNumber:e,actions:l})})();i.set(e,o)},Fd=new WeakSet,my=async function(e){const n=v(this,Nn),a=this._visitedPages;if(!v(this,pi)||this._pageOpenPending.has(e))return;const i=a.get(e);i&&(a.set(e,null),await i,n===v(this,Nn)&&await v(this,en)?.dispatchEventInSandbox({id:"page",name:"PageClose",pageNumber:e}))},Ig=new WeakSet,fS=function(){if(R(this,Zo,Promise.withResolvers()),v(this,en))throw new Error("#initScripting: Scripting already exists.");return v(this,qd).createScripting()},Qo=new WeakSet,Ku=async function(){if(!v(this,en)){R(this,Nn,null),v(this,Zo)?.resolve();return}v(this,pi)&&(await Promise.race([v(this,pi).promise,new Promise(e=>{setTimeout(e,1e3)})]).catch(()=>{}),R(this,pi,null)),R(this,Nn,null);try{await v(this,en).destroySandbox()}catch{}v(this,xa)?.reject(new Error("Scripting destroyed.")),R(this,xa,null),v(this,Jo)?.abort(),R(this,Jo,null),this._pageOpenPending.clear(),this._visitedPages.clear(),R(this,en,null),R(this,wr,!1),v(this,Zo)?.resolve()};const nC="--sidebar-width",uE=200,gp="sidebarResizing",fE="pdfSidebarNotification";class aC{constructor({elements:e,eventBus:n,l10n:a}){D(this,Ms);D(this,Dg);D(this,Yd);D(this,$g);D(this,vr);D(this,Mg);D(this,zd);D(this,Ud,!1);D(this,el,null);D(this,Wd,null);D(this,$s,null);this.isOpen=!1,this.active=Me.THUMBS,this.isInitialViewSet=!1,this.isInitialEventDispatched=!1,this.onToggled=null,this.onUpdateThumbnails=null,this.outerContainer=e.outerContainer,this.sidebarContainer=e.sidebarContainer,this.toggleButton=e.toggleButton,this.resizer=e.resizer,this.thumbnailButton=e.thumbnailButton,this.outlineButton=e.outlineButton,this.attachmentsButton=e.attachmentsButton,this.layersButton=e.layersButton,this.thumbnailView=e.thumbnailView,this.outlineView=e.outlineView,this.attachmentsView=e.attachmentsView,this.layersView=e.layersView,this._currentOutlineItemButton=e.currentOutlineItemButton,this.eventBus=n,R(this,Ud,!1),I(this,$g,gS).call(this)}reset(){this.isInitialViewSet=!1,this.isInitialEventDispatched=!1,I(this,Yd,by).call(this,!0),this.switchView(Me.THUMBS),this.outlineButton.disabled=!1,this.attachmentsButton.disabled=!1,this.layersButton.disabled=!1,this._currentOutlineItemButton.disabled=!0}get visibleView(){return this.isOpen?this.active:Me.NONE}setInitialView(e=Me.NONE){if(!this.isInitialViewSet){if(this.isInitialViewSet=!0,e===Me.NONE||e===Me.UNKNOWN){I(this,Ms,Ur).call(this);return}this.switchView(e,!0),this.isInitialEventDispatched||I(this,Ms,Ur).call(this)}}switchView(e,n=!1){const a=e!==this.active;let i=!1;switch(e){case Me.NONE:this.isOpen&&this.close();return;case Me.THUMBS:this.isOpen&&a&&(i=!0);break;case Me.OUTLINE:if(this.outlineButton.disabled)return;break;case Me.ATTACHMENTS:if(this.attachmentsButton.disabled)return;break;case Me.LAYERS:if(this.layersButton.disabled)return;break;default:console.error(`PDFSidebar.switchView: "${e}" is not a valid view.`);return}if(this.active=e,Jn(this.thumbnailButton,e===Me.THUMBS,this.thumbnailView),Jn(this.outlineButton,e===Me.OUTLINE,this.outlineView),Jn(this.attachmentsButton,e===Me.ATTACHMENTS,this.attachmentsView),Jn(this.layersButton,e===Me.LAYERS,this.layersView),n&&!this.isOpen){this.open();return}i&&(this.onUpdateThumbnails(),this.onToggled()),a&&I(this,Ms,Ur).call(this)}open(){this.isOpen||(this.isOpen=!0,oi(this.toggleButton,!0),this.outerContainer.classList.add("sidebarMoving","sidebarOpen"),this.active===Me.THUMBS&&this.onUpdateThumbnails(),this.onToggled(),I(this,Ms,Ur).call(this),I(this,Yd,by).call(this))}close(e=null){this.isOpen&&(this.isOpen=!1,oi(this.toggleButton,!1),this.outerContainer.classList.add("sidebarMoving"),this.outerContainer.classList.remove("sidebarOpen"),this.onToggled(),I(this,Ms,Ur).call(this),e?.detail>0&&this.toggleButton.blur())}toggle(e=null){this.isOpen?this.close(e):this.open()}get outerContainerWidth(){return v(this,Wd)||R(this,Wd,this.outerContainer.clientWidth)}}Ud=new WeakMap,el=new WeakMap,Wd=new WeakMap,$s=new WeakMap,Ms=new WeakSet,Ur=function(){this.isInitialViewSet&&(this.isInitialEventDispatched||=!0),this.eventBus.dispatch("sidebarviewchanged",{source:this,view:this.visibleView})},Dg=new WeakSet,pS=function(){this.toggleButton.title=window.siyuan.languages.toggleSidebarNotification2Title,this.isOpen||this.toggleButton.classList.add(fE)},Yd=new WeakSet,by=function(e=!1){(this.isOpen||e)&&this.toggleButton.classList.remove(fE),e&&(this.toggleButton.title=window.siyuan.languages.toggleSidebarTitle)},$g=new WeakSet,gS=function(){const{eventBus:e,outerContainer:n}=this;this.sidebarContainer.addEventListener("transitionend",i=>{i.target===this.sidebarContainer&&(n.classList.remove("sidebarMoving"),e.dispatch("resize",{source:this}))}),this.toggleButton.addEventListener("click",i=>{this.toggle(i)}),this.thumbnailButton.addEventListener("click",()=>{this.switchView(Me.THUMBS)}),this.outlineButton.addEventListener("click",()=>{this.switchView(Me.OUTLINE)}),this.outlineButton.addEventListener("dblclick",()=>{e.dispatch("toggleoutlinetree",{source:this})}),this.attachmentsButton.addEventListener("click",()=>{this.switchView(Me.ATTACHMENTS)}),this.layersButton.addEventListener("click",()=>{this.switchView(Me.LAYERS)}),this.layersButton.addEventListener("dblclick",()=>{e.dispatch("resetlayers",{source:this})}),this._currentOutlineItemButton.addEventListener("click",()=>{e.dispatch("currentoutlineitem",{source:this})});const a=(i,s,o)=>{s.disabled=!i,i?I(this,Dg,pS).call(this):this.active===o&&this.switchView(Me.THUMBS)};e._on("outlineloaded",i=>{a(i.outlineCount,this.outlineButton,Me.OUTLINE),i.currentOutlineItemPromise.then(s=>{this.isInitialViewSet&&(this._currentOutlineItemButton.disabled=!s)})}),e._on("attachmentsloaded",i=>{a(i.attachmentsCount,this.attachmentsButton,Me.ATTACHMENTS)}),e._on("layersloaded",i=>{a(i.layersCount,this.layersButton,Me.LAYERS)}),e._on("presentationmodechanged",i=>{i.state===on.NORMAL&&this.visibleView===Me.THUMBS&&this.onUpdateThumbnails()}),this.resizer.addEventListener("mousedown",i=>{if(i.button!==0)return;n.classList.add(gp),R(this,el,new AbortController);const s={signal:v(this,el).signal};window.addEventListener("mousemove",I(this,Mg,hS).bind(this),s),window.addEventListener("mouseup",I(this,zd,yy).bind(this),s),window.addEventListener("blur",I(this,zd,yy).bind(this),s)}),e._on("resize",i=>{if(i.source!==window||(R(this,Wd,null),!v(this,$s)))return;if(!this.isOpen){I(this,vr,gh).call(this,v(this,$s));return}n.classList.add(gp);const s=I(this,vr,gh).call(this,v(this,$s));Promise.resolve().then(()=>{n.classList.remove(gp),s&&e.dispatch("resize",{source:this})})})},vr=new WeakSet,gh=function(e=0){const n=Math.floor(this.outerContainerWidth/2);return e>n&&(e=n),e<uE&&(e=uE),e===v(this,$s)?!1:(R(this,$s,e),Uv.setProperty(nC,`${e}px`),!0)},Mg=new WeakSet,hS=function(e){let n=e.clientX-this.outerContainer.getBoundingClientRect().left;v(this,Ud)&&(n=this.outerContainerWidth-n),I(this,vr,gh).call(this,n)},zd=new WeakSet,yy=function(e){this.outerContainer.classList.remove(gp),this.eventBus.dispatch("resize",{source:this}),v(this,el)?.abort(),R(this,el,null)};const pE=2,gE=3,iC=98;class ab{static getCanvas(e,n){const a=v(this,Er)||R(this,Er,document.createElement("canvas"));a.width=e,a.height=n;const i=a.getContext("2d",{alpha:!1});return i.save(),i.fillStyle="rgb(255, 255, 255)",i.fillRect(0,0,e,n),i.restore(),[a,a.getContext("2d")]}static destroyCanvas(){const e=v(this,Er);e&&(e.width=0,e.height=0),R(this,Er,null)}}Er=new WeakMap,D(ab,Er,null);class sC{constructor({container:e,eventBus:n,id:a,defaultViewport:i,optionalContentConfigPromise:s,linkService:o,renderingQueue:l,pageColors:r,enableHWA:d}){D(this,Vd);D(this,Gd);D(this,jd);D(this,Kd);D(this,Pg);D(this,Fi);this.id=a,this.renderingId="thumbnail"+a,this.pageLabel=null,this.pdfPage=null,this.rotation=0,this.viewport=i,this.pdfPageRotate=i.rotation,this._optionalContentConfigPromise=s||null,this.pageColors=r||null,this.enableHWA=d||!1,this.eventBus=n,this.linkService=o,this.renderingQueue=l,this.renderTask=null,this.renderingState=We.INITIAL,this.resume=null;const c=document.createElement("a");c.href=o.getAnchorUrl("#page="+a),c.title=window.siyuan.languages.thumbPageTitle.replace("{{page}}",JSON.parse(v(this,Fi,ml)).page),c.setAttribute("data-l10n-id","pdfjs-thumb-page-title"),c.setAttribute("data-l10n-args",v(this,Fi,ml)),c.onclick=function(){return o.goToPage(a),!1},this.anchor=c;const f=document.createElement("div");f.className="thumbnail",f.setAttribute("data-page-number",this.id),this.div=f,I(this,Vd,wy).call(this);const g=document.createElement("div");g.className="thumbnailImage",this._placeholderImg=g,f.append(g),c.append(f),e.append(c)}setPdfPage(e){this.pdfPage=e,this.pdfPageRotate=e.rotate;const n=(this.rotation+this.pdfPageRotate)%360;this.viewport=e.getViewport({scale:1,rotation:n}),this.reset()}reset(){this.cancelRendering(),this.renderingState=We.INITIAL,this.div.removeAttribute("data-loaded"),this.image?.replaceWith(this._placeholderImg),I(this,Vd,wy).call(this),this.image&&(this.image.removeAttribute("src"),delete this.image)}update({rotation:e=null}){typeof e=="number"&&(this.rotation=e);const n=(this.rotation+this.pdfPageRotate)%360;this.viewport=this.viewport.clone({scale:1,rotation:n}),this.reset()}cancelRendering(){this.renderTask&&(this.renderTask.cancel(),this.renderTask=null),this.resume=null}async draw(){if(this.renderingState!==We.INITIAL){console.error("Must be in new state before drawing");return}const{pdfPage:e}=this;if(!e)throw this.renderingState=We.FINISHED,new Error("pdfPage is not loaded");this.renderingState=We.RUNNING;const{ctx:n,canvas:a,transform:i}=I(this,Gd,_y).call(this,pE),s=this.viewport.clone({scale:pE*this.scale}),o=c=>{if(!this.renderingQueue.isHighestPriority(this)){this.renderingState=We.PAUSED,this.resume=()=>{this.renderingState=We.RUNNING,c()};return}c()},l={canvasContext:n,transform:i,viewport:s,optionalContentConfigPromise:this._optionalContentConfigPromise,pageColors:this.pageColors},r=this.renderTask=e.render(l);r.onContinue=o;const d=r.promise.then(()=>I(this,Kd,Ey).call(this,r,a),c=>I(this,Kd,Ey).call(this,r,a,c));return d.finally(()=>{a.width=0,a.height=0,this.eventBus.dispatch("thumbnailrendered",{source:this,pageNumber:this.id,pdfPage:this.pdfPage})}),d}setImage(e){if(this.renderingState!==We.INITIAL)return;const{thumbnailCanvas:n,pdfPage:a,scale:i}=e;n&&(this.pdfPage||this.setPdfPage(a),!(i<this.scale)&&(this.renderingState=We.FINISHED,I(this,jd,vy).call(this,n)))}setPageLabel(e){this.pageLabel=typeof e=="string"?e:null,this.anchor.title=window.siyuan.languages.thumbPageTitle.replace("{{page}}",JSON.parse(v(this,Fi,ml)).page),this.anchor.setAttribute("data-l10n-args",v(this,Fi,ml)),this.renderingState===We.FINISHED&&this.image?.setAttribute("data-l10n-args",v(this,Fi,ml))}}Vd=new WeakSet,wy=function(){const{width:e,height:n}=this.viewport,a=e/n;this.canvasWidth=iC,this.canvasHeight=this.canvasWidth/a|0,this.scale=this.canvasWidth/e;const{style:i}=this.div;i.setProperty("--thumbnail-width",`${this.canvasWidth}px`),i.setProperty("--thumbnail-height",`${this.canvasHeight}px`)},Gd=new WeakSet,_y=function(e=1,n=this.enableHWA){const a=document.createElement("canvas"),i=a.getContext("2d",{alpha:!1,willReadFrequently:!n}),s=new G.OutputScale;a.width=e*this.canvasWidth*s.sx|0,a.height=e*this.canvasHeight*s.sy|0;const o=s.scaled?[s.sx,0,0,s.sy,0,0]:null;return{ctx:i,canvas:a,transform:o}},jd=new WeakSet,vy=function(e){if(this.renderingState!==We.FINISHED)throw new Error("#convertCanvasToImage: Rendering has not finished.");const n=I(this,Pg,mS).call(this,e),a=document.createElement("img");a.className="thumbnailImage",a.setAttribute("data-l10n-id","pdfjs-thumb-page-canvas"),a.setAttribute("data-l10n-args",v(this,Fi,ml)),a.src=n.toDataURL(),this.image=a,this.div.setAttribute("data-loaded",!0),this._placeholderImg.replaceWith(a),n.width=0,n.height=0},Kd=new WeakSet,Ey=async function(e,n,a=null){if(e===this.renderTask&&(this.renderTask=null),!(a instanceof G.RenderingCancelledException)&&(this.renderingState=We.FINISHED,I(this,jd,vy).call(this,n),a))throw a},Pg=new WeakSet,mS=function(e){const{ctx:n,canvas:a}=I(this,Gd,_y).call(this,1,!0);if(e.width<=2*a.width)return n.drawImage(e,0,0,e.width,e.height,0,0,a.width,a.height),a;let i=a.width<<gE,s=a.height<<gE;const[o,l]=ab.getCanvas(i,s);for(;i>e.width||s>e.height;)i>>=1,s>>=1;for(l.drawImage(e,0,0,e.width,e.height,0,0,i,s);i>2*a.width;)l.drawImage(o,0,0,i,s,0,0,i>>1,s>>1),i>>=1,s>>=1;return n.drawImage(o,0,0,i,s,0,0,a.width,a.height),a},Fi=new WeakSet,ml=function(){return JSON.stringify({page:this.pageLabel??this.id})};const oC=-19,ib="selected";class lC{constructor({container:e,eventBus:n,linkService:a,renderingQueue:i,pageColors:s,abortSignal:o,enableHWA:l}){D(this,Ng);D(this,Zd);D(this,Jd);D(this,Hg);D(this,Rg);D(this,Og);this.container=e,this.eventBus=n,this.linkService=a,this.renderingQueue=i,this.pageColors=s||null,this.enableHWA=l||!1,this.scroll=Nv(this.container,I(this,Ng,bS).bind(this),o),I(this,Jd,Sy).call(this)}getThumbnail(e){return this._thumbnails[e]}scrollThumbnailIntoView(e){if(!this.pdfDocument)return;const n=this._thumbnails[e-1];if(!n){console.error('scrollThumbnailIntoView: Invalid "pageNumber" parameter.');return}e!==this._currentPageNumber&&(this._thumbnails[this._currentPageNumber-1].div.classList.remove(ib),n.div.classList.add(ib));const{first:a,last:i,views:s}=I(this,Zd,ky).call(this);if(s.length>0){let o=!1;if(e<=a.id||e>=i.id)o=!0;else for(const{id:l,percent:r}of s)if(l===e){o=r<100;break}o&&Om(n.div,{top:oC})}this._currentPageNumber=e}get pagesRotation(){return this._pagesRotation}set pagesRotation(e){if(!cp(e))throw new Error("Invalid thumbnails rotation angle.");if(!this.pdfDocument||this._pagesRotation===e)return;this._pagesRotation=e;const n={rotation:e};for(const a of this._thumbnails)a.update(n)}cleanup(){for(const e of this._thumbnails)e.renderingState!==We.FINISHED&&e.reset();ab.destroyCanvas()}setDocument(e){if(this.pdfDocument&&(I(this,Hg,yS).call(this),I(this,Jd,Sy).call(this)),this.pdfDocument=e,!e)return;const n=e.getPage(1),a=e.getOptionalContentConfig({intent:"display"});n.then(i=>{const s=e.numPages,o=i.getViewport({scale:1});for(let r=1;r<=s;++r){const d=new sC({container:this.container,eventBus:this.eventBus,id:r,defaultViewport:o.clone(),optionalContentConfigPromise:a,linkService:this.linkService,renderingQueue:this.renderingQueue,pageColors:this.pageColors,enableHWA:this.enableHWA});this._thumbnails.push(d)}this._thumbnails[0]?.setPdfPage(i),this._thumbnails[this._currentPageNumber-1].div.classList.add(ib)}).catch(i=>{console.error("Unable to initialize thumbnail viewer",i)})}setPageLabels(e){if(this.pdfDocument){e?Array.isArray(e)&&this.pdfDocument.numPages===e.length?this._pageLabels=e:(this._pageLabels=null,console.error("PDFThumbnailViewer_setPageLabels: Invalid page labels.")):this._pageLabels=null;for(let n=0,a=this._thumbnails.length;n<a;n++)this._thumbnails[n].setPageLabel(this._pageLabels?.[n]??null)}}forceRendering(){const e=I(this,Zd,ky).call(this),n=I(this,Og,_S).call(this,e),a=this.renderingQueue.getHighestPriority(e,this._thumbnails,n);return a?(I(this,Rg,wS).call(this,a).then(()=>{this.renderingQueue.renderView(a)}),!0):!1}}Ng=new WeakSet,bS=function(){this.renderingQueue.renderHighestPriority()},Zd=new WeakSet,ky=function(){return Ov({scrollEl:this.container,views:this._thumbnails})},Jd=new WeakSet,Sy=function(){this._thumbnails=[],this._currentPageNumber=1,this._pageLabels=null,this._pagesRotation=0,this.container.textContent=""},Hg=new WeakSet,yS=function(){for(const e of this._thumbnails)e.cancelRendering()},Rg=new WeakSet,wS=async function(e){if(e.pdfPage)return e.pdfPage;try{const n=await this.pdfDocument.getPage(e.id);return e.pdfPage||e.setPdfPage(n),n}catch(n){return console.error("Unable to get page for thumb view",n),null}},Og=new WeakSet,_S=function(e){return e.first?.id===1?!0:e.last?.id===this._thumbnails.length?!1:this.scroll.down};class rC{constructor(e){D(this,Xd,null);D(this,Qd,null);D(this,eu,null);D(this,tu,null);D(this,nu,null);D(this,kr,void 0);this.pdfPage=e.pdfPage,this.accessibilityManager=e.accessibilityManager,this.l10n=e.l10n,(typeof PDFJSDev>"u"||PDFJSDev.test("GENERIC"))&&(this.l10n||=new GenericL10n),this.annotationEditorLayer=null,this.div=null,this._cancelled=!1,R(this,kr,e.uiManager),R(this,Xd,e.annotationLayer||null),R(this,nu,e.textLayer||null),R(this,Qd,e.drawLayer||null),R(this,eu,e.onAppend||null),R(this,tu,e.structTreeLayer||null)}async render(e,n="display"){var o;if(n!=="display"||this._cancelled)return;const a=e.clone({dontFlip:!0});if(this.div){this.annotationEditorLayer.update({viewport:a}),this.show();return}const i=this.div=document.createElement("div");i.className="annotationEditorLayer",i.hidden=!0,i.dir=v(this,kr).direction,(o=v(this,eu))==null||o.call(this,i),this.annotationEditorLayer=new G.AnnotationEditorLayer({uiManager:v(this,kr),div:i,structTreeLayer:v(this,tu),accessibilityManager:this.accessibilityManager,pageIndex:this.pdfPage.pageNumber-1,l10n:this.l10n,viewport:a,annotationLayer:v(this,Xd),textLayer:v(this,nu),drawLayer:v(this,Qd)});const s={viewport:a,div:i,annotations:null,intent:n};this.annotationEditorLayer.render(s),this.show()}cancel(){this._cancelled=!0,this.div&&this.annotationEditorLayer.destroy()}hide(){this.div&&(this.div.hidden=!0)}show(){!this.div||this.annotationEditorLayer.isInvisible||(this.div.hidden=!1)}}Xd=new WeakMap,Qd=new WeakMap,eu=new WeakMap,tu=new WeakMap,nu=new WeakMap,kr=new WeakMap;class cC{constructor({pdfPage:e,linkService:n,downloadManager:a,annotationStorage:i=null,imageResourcesPath:s="",renderForms:o=!0,enableScripting:l=!1,hasJSActionsPromise:r=null,fieldObjectsPromise:d=null,annotationCanvasMap:c=null,accessibilityManager:f=null,annotationEditorUIManager:g=null,onAppend:p=null}){D(this,iu);D(this,au,null);D(this,Ps,null);this.pdfPage=e,this.linkService=n,this.downloadManager=a,this.imageResourcesPath=s,this.renderForms=o,this.annotationStorage=i,this.enableScripting=l,this._hasJSActionsPromise=r||Promise.resolve(!1),this._fieldObjectsPromise=d||Promise.resolve(null),this._annotationCanvasMap=c,this._accessibilityManager=f,this._annotationEditorUIManager=g,R(this,au,p),this.annotationLayer=null,this.div=null,this._cancelled=!1,this._eventBus=n.eventBus}async render(e,n,a="display"){var r;if(this.div){if(this._cancelled||!this.annotationLayer)return;this.annotationLayer.update({viewport:e.clone({dontFlip:!0})});return}const[i,s,o]=await Promise.all([this.pdfPage.getAnnotations({intent:a}),this._hasJSActionsPromise,this._fieldObjectsPromise]);if(this._cancelled)return;const l=this.div=document.createElement("div");if(l.className="annotationLayer",(r=v(this,au))==null||r.call(this,l),i.length===0){this.hide();return}this.annotationLayer=new G.AnnotationLayer({div:l,accessibilityManager:this._accessibilityManager,annotationCanvasMap:this._annotationCanvasMap,annotationEditorUIManager:this._annotationEditorUIManager,page:this.pdfPage,viewport:e.clone({dontFlip:!0}),structTreeLayer:n?.structTreeLayer||null}),await this.annotationLayer.render({annotations:i,imageResourcesPath:this.imageResourcesPath,renderForms:this.renderForms,linkService:this.linkService,downloadManager:this.downloadManager,annotationStorage:this.annotationStorage,enableScripting:this.enableScripting,hasJSActions:s,fieldObjects:o}),this.linkService.isInPresentationMode&&I(this,iu,Ly).call(this,on.FULLSCREEN),v(this,Ps)||(R(this,Ps,new AbortController),this._eventBus?._on("presentationmodechanged",d=>{I(this,iu,Ly).call(this,d.state)},{signal:v(this,Ps).signal}))}cancel(){this._cancelled=!0,v(this,Ps)?.abort(),R(this,Ps,null)}hide(){this.div&&(this.div.hidden=!0)}hasEditableAnnotations(){return!!this.annotationLayer?.hasEditableAnnotations()}}au=new WeakMap,Ps=new WeakMap,iu=new WeakSet,Ly=function(e){if(!this.div)return;let n=!1;switch(e){case on.FULLSCREEN:n=!0;break;case on.NORMAL:break;default:return}for(const a of this.div.childNodes)a.hasAttribute("data-internal-link")||(a.inert=n)};class dC{constructor(e){D(this,gi,null);this.pageIndex=e.pageIndex}async render(e="display"){e!=="display"||v(this,gi)||this._cancelled||R(this,gi,new G.DrawLayer({pageIndex:this.pageIndex}))}cancel(){this._cancelled=!0,v(this,gi)&&(v(this,gi).destroy(),R(this,gi,null))}setParent(e){v(this,gi)?.setParent(e)}getDrawLayer(){return v(this,gi)}}gi=new WeakMap;const hE={Document:null,DocumentFragment:null,Part:"group",Sect:"group",Div:"group",Aside:"note",NonStruct:"none",P:null,H:"heading",Title:null,FENote:"note",Sub:"group",Lbl:null,Span:null,Em:null,Strong:null,Link:"link",Annot:"note",Form:"form",Ruby:null,RB:null,RT:null,RP:null,Warichu:null,WT:null,WP:null,L:"list",LI:"listitem",LBody:null,Table:"table",TR:"row",TH:"columnheader",TD:"cell",THead:"columnheader",TBody:null,TFoot:null,Caption:null,Figure:"figure",Formula:null,Artifact:null},uC=/^H(\d+)$/;class fC{constructor(e,n){D(this,su);D(this,Bg);D(this,ou);D(this,Sr,void 0);D(this,Va,null);D(this,Lr,void 0);D(this,xr,new Map);D(this,Ar,void 0);D(this,Ns,null);R(this,Sr,e.getStructTree()),R(this,Ar,n)}async render(){if(v(this,Lr))return v(this,Lr);const{promise:e,resolve:n,reject:a}=Promise.withResolvers();R(this,Lr,e);try{R(this,Va,I(this,ou,Ay).call(this,await v(this,Sr)))}catch(i){a(i)}return R(this,Sr,null),v(this,Va)?.classList.add("structTree"),n(v(this,Va)),e}async getAriaAttributes(e){return await this.render(),v(this,xr).get(e)}hide(){v(this,Va)&&!v(this,Va).hidden&&(v(this,Va).hidden=!0)}show(){v(this,Va)?.hidden&&(v(this,Va).hidden=!1)}addElementsToTextLayer(){if(v(this,Ns)){for(const[e,n]of v(this,Ns))document.getElementById(e)?.append(n);v(this,Ns).clear(),R(this,Ns,null)}}}Sr=new WeakMap,Va=new WeakMap,Lr=new WeakMap,xr=new WeakMap,Ar=new WeakMap,Ns=new WeakMap,su=new WeakSet,xy=function(e,n){const{alt:a,id:i,lang:s}=e;if(a!==void 0){let o=!1;const l=Fl(a);for(const r of e.children)if(r.type==="annotation"){let d=v(this,xr).get(r.id);d||(d=new Map,v(this,xr).set(r.id,d)),d.set("aria-label",l),o=!0}o||n.setAttribute("aria-label",l)}i!==void 0&&n.setAttribute("aria-owns",i),s!==void 0&&n.setAttribute("lang",Fl(s,!0))},Bg=new WeakSet,vS=function(e,n){const{alt:a,bbox:i,children:s}=e,o=s?.[0];if(!v(this,Ar)||!a||!i||o?.type!=="content")return!1;const{id:l}=o;if(!l)return!1;n.setAttribute("aria-owns",l);const r=document.createElement("span");(v(this,Ns)||R(this,Ns,new Map)).set(l,r),r.setAttribute("role","img"),r.setAttribute("aria-label",Fl(a));const{pageHeight:d,pageX:c,pageY:f}=v(this,Ar),g="calc(var(--scale-factor)*",{style:p}=r;return p.width=`${g}${i[2]-i[0]}px)`,p.height=`${g}${i[3]-i[1]}px)`,p.left=`${g}${i[0]-c}px)`,p.top=`${g}${d-i[3]+f}px)`,!0},ou=new WeakSet,Ay=function(e){if(!e)return null;const n=document.createElement("span");if("role"in e){const{role:a}=e,i=a.match(uC);if(i?(n.setAttribute("role","heading"),n.setAttribute("aria-level",i[1])):hE[a]&&n.setAttribute("role",hE[a]),a==="Figure"&&I(this,Bg,vS).call(this,e,n))return n}if(I(this,su,xy).call(this,e,n),e.children)if(e.children.length===1&&"id"in e.children[0])I(this,su,xy).call(this,e.children[0],n);else for(const a of e.children)n.append(I(this,ou,Ay).call(this,a));return n};const ru=class{constructor(){D(this,lu);D(this,Ui,!1);D(this,Aa,null);D(this,Wi,new Map);D(this,Hs,new Map)}setTextMapping(e){R(this,Aa,e)}enable(){if(v(this,Ui))throw new Error("TextAccessibilityManager is already enabled.");if(!v(this,Aa))throw new Error("Text divs and strings have not been set.");if(R(this,Ui,!0),R(this,Aa,v(this,Aa).slice()),v(this,Aa).sort(I(ru,Cr,hh)),v(this,Wi).size>0){const e=v(this,Aa);for(const[n,a]of v(this,Wi)){if(!document.getElementById(n)){v(this,Wi).delete(n);continue}I(this,lu,Cy).call(this,n,e[a])}}for(const[e,n]of v(this,Hs))this.addPointerInTextLayer(e,n);v(this,Hs).clear()}disable(){v(this,Ui)&&(v(this,Hs).clear(),R(this,Aa,null),R(this,Ui,!1))}removePointerInTextLayer(e){if(!v(this,Ui)){v(this,Hs).delete(e);return}const n=v(this,Aa);if(!n||n.length===0)return;const{id:a}=e,i=v(this,Wi).get(a);if(i===void 0)return;const s=n[i];v(this,Wi).delete(a);let o=s.getAttribute("aria-owns");o?.includes(a)&&(o=o.split(" ").filter(l=>l!==a).join(" "),o?s.setAttribute("aria-owns",o):(s.removeAttribute("aria-owns"),s.setAttribute("role","presentation")))}addPointerInTextLayer(e,n){const{id:a}=e;if(!a)return null;if(!v(this,Ui))return v(this,Hs).set(e,n),null;n&&this.removePointerInTextLayer(e);const i=v(this,Aa);if(!i||i.length===0)return null;const s=Ic(i,d=>{var c;return I(c=ru,Cr,hh).call(c,e,d)<0}),o=Math.max(0,s-1),l=i[o];I(this,lu,Cy).call(this,a,l),v(this,Wi).set(a,o);const r=l.parentNode;return r?.classList.contains("markedContent")?r.id:null}moveElementInDOM(e,n,a,i){const s=this.addPointerInTextLayer(a,i);if(!e.hasChildNodes())return e.append(n),s;const o=Array.from(e.childNodes).filter(d=>d!==n);if(o.length===0)return s;const l=a||n,r=Ic(o,d=>{var c;return I(c=ru,Cr,hh).call(c,l,d)<0});return r===0?o[0].before(n):o[r-1].after(n),s}};let hp=ru;Ui=new WeakMap,Aa=new WeakMap,Wi=new WeakMap,Hs=new WeakMap,Cr=new WeakSet,hh=function(e,n){const a=e.getBoundingClientRect(),i=n.getBoundingClientRect();if(a.width===0&&a.height===0)return 1;if(i.width===0&&i.height===0)return-1;const s=a.y,o=a.y+a.height,l=a.y+a.height/2,r=i.y,d=i.y+i.height,c=i.y+i.height/2;if(l<=r&&c>=o)return-1;if(c<=s&&l>=d)return 1;const f=a.x+a.width/2,g=i.x+i.width/2;return f-g},lu=new WeakSet,Cy=function(e,n){const a=n.getAttribute("aria-owns");a?.includes(e)||n.setAttribute("aria-owns",a?`${a} ${e}`:e),n.removeAttribute("role")},D(hp,Cr);class pC{constructor({findController:e,eventBus:n,pageIndex:a}){D(this,Rs,null);this.findController=e,this.matches=[],this.eventBus=n,this.pageIdx=a,this.textDivs=null,this.textContentItemsStr=null,this.enabled=!1}setTextMapping(e,n){this.textDivs=e,this.textContentItemsStr=n}enable(){if(!this.textDivs||!this.textContentItemsStr)throw new Error("Text divs and strings have not been set.");if(this.enabled)throw new Error("TextHighlighter is already enabled.");this.enabled=!0,v(this,Rs)||(R(this,Rs,new AbortController),this.eventBus._on("updatetextlayermatches",e=>{(e.pageIndex===this.pageIdx||e.pageIndex===-1)&&this._updateMatches()},{signal:v(this,Rs).signal})),this._updateMatches()}disable(){this.enabled&&(this.enabled=!1,v(this,Rs)?.abort(),R(this,Rs,null),this._updateMatches(!0))}_convertMatches(e,n){if(!e)return[];const{textContentItemsStr:a}=this;let i=0,s=0;const o=a.length-1,l=[];for(let r=0,d=e.length;r<d;r++){let c=e[r];for(;i!==o&&c>=s+a[i].length;)s+=a[i].length,i++;i===a.length&&console.error("Could not find a matching mapping");const f={begin:{divIdx:i,offset:c-s}};for(c+=n[r];i!==o&&c>s+a[i].length;)s+=a[i].length,i++;f.end={divIdx:i,offset:c-s},l.push(f)}return l}_renderMatches(e){if(e.length===0)return;const{findController:n,pageIdx:a}=this,{textContentItemsStr:i,textDivs:s}=this,o=a===n.selected.pageIdx,l=n.selected.matchIdx,r=n.state.highlightAll;let d=null;const c={divIdx:-1,offset:void 0};function f(y,w){const _=y.divIdx;return s[_].textContent="",g(_,0,y.offset,w)}function g(y,w,_,x){let S=s[y];if(S.nodeType===Node.TEXT_NODE){const $=document.createElement("span");S.before($),$.append(S),s[y]=$,S=$}const k=i[y].substring(w,_),A=document.createTextNode(k);if(x){const $=document.createElement("span");return $.className=`${x} appended`,$.append(A),S.append($),x.includes("selected")?$.offsetLeft:0}return S.append(A),0}let p=l,h=p+1;if(r)p=0,h=e.length;else if(!o)return;let m=-1,b=-1;for(let y=p;y<h;y++){const w=e[y],_=w.begin;if(_.divIdx===m&&_.offset===b)continue;m=_.divIdx,b=_.offset;const x=w.end,S=o&&y===l,k=S?" selected":"";let A=0;if(!d||_.divIdx!==d.divIdx?(d!==null&&g(d.divIdx,d.offset,c.offset),f(_)):g(d.divIdx,d.offset,_.offset),_.divIdx===x.divIdx)A=g(_.divIdx,_.offset,x.offset,"highlight"+k);else{A=g(_.divIdx,_.offset,c.offset,"highlight begin"+k);for(let $=_.divIdx+1,M=x.divIdx;$<M;$++)s[$].className="highlight middle"+k;f(x,"highlight end"+k)}d=x,S&&n.scrollMatchIntoView({element:s[_.divIdx],selectedLeft:A,pageIndex:a,matchIndex:l})}d&&g(d.divIdx,d.offset,c.offset)}_updateMatches(e=!1){if(!this.enabled&&!e)return;const{findController:n,matches:a,pageIdx:i}=this,{textContentItemsStr:s,textDivs:o}=this;let l=-1;for(const c of a){const f=Math.max(l,c.begin.divIdx);for(let g=f,p=c.end.divIdx;g<=p;g++){const h=o[g];h.textContent=s[g],h.className=""}l=c.end.divIdx+1}if(!n?.highlightMatches||e)return;const r=n.pageMatches[i]||null,d=n.pageMatchesLength[i]||null;this.matches=this._convertMatches(r,d),this._renderMatches(this.matches)}}Rs=new WeakMap;const gC=(t,e)=>{wo(e);const n=e.appConfig,a=n.toolbar.rectAnno;a.addEventListener("click",()=>{a.classList.contains("toggled")?(a.classList.remove("toggled"),n.mainContainer.classList.remove("rect-to-annotation")):(e.pdfCursorTools.switchTool(0),a.classList.add("toggled"),n.mainContainer.classList.add("rect-to-annotation"),getSelection().rangeCount>0&&getSelection().getRangeAt(0).collapse(!0),gs(t))});const i=n.mainContainer.lastElementChild;return n.mainContainer.addEventListener("mousedown",s=>{if(s.button===2||!a.classList.contains("toggled"))return;let o=e.pdfViewer._getVisiblePages().first.view.canvas.getBoundingClientRect();s.clientX>o.right&&(o=e.pdfViewer._getVisiblePages().last.view.canvas.getBoundingClientRect());const l=n.mainContainer.getBoundingClientRect(),r=o.left,d=o.right,c=l.bottom;let f=s.clientX;s.clientX>d?f=d:s.clientX<r&&(f=r);const g=l.top,p=s.clientY,h=document;h.onmousemove=m=>{i.classList.remove("fn__none");let b=0,y=0,w=0,_=0;m.clientX<f?(m.clientX<r?y=r:y=m.clientX,w=f-y):m.clientX>d?(y=f,w=d-y):(y=f,w=m.clientX-f),m.clientY>p?m.clientY>c?(b=p,_=c-p):(b=p,_=m.clientY-p):(m.clientY<g?b=g:b=m.clientY,_=p-b),i.setAttribute("style",`top:${b}px;height:${_}px;left:${y}px;width:${w}px;background-color:${m.altKey?"var(--b3-pdf-background1)":""}`)},h.onmouseup=()=>{h.onmousemove=null,h.onmouseup=null,h.ondragstart=null,h.onselectstart=null,h.onselect=null,a.classList.remove("toggled"),n.mainContainer.classList.remove("rect-to-annotation");const m=mC(e,window.siyuan.storage[u.LOCAL_PDFTHEME].annoColor||"var(--b3-pdf-background1)",i,i.style.backgroundColor?"text":"border");i.classList.add("fn__none"),m?m.forEach((b,y)=>{const w=mp(b,e);y===0&&(Mt=w,bp(`${e.appConfig.file.replace(location.origin,"").substr(1)}/${Mt.getAttribute("data-node-id")}`,e.appConfig.file.replace(location.origin,"").substr(8).replace(/-\d{14}-\w{7}.pdf$/,""),e))}):Mt=null}}),t.addEventListener("click",s=>{let o=!1,l=s.target;if(typeof s.detail=="string"){window.siyuan.storage[u.LOCAL_PDFTHEME].annoColor=s.detail==="0"?window.siyuan.storage[u.LOCAL_PDFTHEME].annoColor||"var(--b3-pdf-background1)":`var(--b3-pdf-background${s.detail})`,ue(u.LOCAL_PDFTHEME,window.siyuan.storage[u.LOCAL_PDFTHEME]);const r=yE(e,window.siyuan.storage[u.LOCAL_PDFTHEME].annoColor);r&&r.forEach((d,c)=>{const f=mp(d,e);c===0&&(Mt=f,bp(`${e.appConfig.file.replace(location.origin,"").substr(1)}/${Mt.getAttribute("data-node-id")}`,e.appConfig.file.replace(location.origin,"").substr(8).replace(/-\d{14}-\w{7}.pdf$/,""),e))}),gs(t);return}for(;l&&!l.classList.contains("pdf__outer");){const r=l.getAttribute("data-type");if(l.classList.contains("color__square")){const d=l.style.backgroundColor;if(window.siyuan.storage[u.LOCAL_PDFTHEME].annoColor=d,ue(u.LOCAL_PDFTHEME,window.siyuan.storage[u.LOCAL_PDFTHEME]),Mt){const c=wo(e),f=c[Mt.getAttribute("data-node-id")];f.color=d,t.querySelectorAll(`.pdf__rect[data-node-id="${Mt.getAttribute("data-node-id")}"]`).forEach(g=>{Array.from(g.children).forEach(p=>{p.style.border="2px solid "+d,f.type==="text"?p.style.backgroundColor=d:p.style.backgroundColor="transparent"})}),E("/api/asset/setFileAnnotation",{path:e.appConfig.file.replace(location.origin,"").substr(1)+".sya",data:JSON.stringify(c)})}else{const c=yE(e,d);c&&c.forEach((f,g)=>{const p=mp(f,e);g===0&&(Mt=p,bp(`${e.appConfig.file.replace(location.origin,"").substr(1)}/${Mt.getAttribute("data-node-id")}`,e.appConfig.file.replace(location.origin,"").substr(8).replace(/-\d{14}-\w{7}.pdf$/,""),e))})}gs(t),o=!0,s.preventDefault(),s.stopPropagation();break}else if(l.classList.contains("pdf__rect")){mE(t,void 0,l),s.preventDefault(),s.stopPropagation(),o=!0;break}else if(r==="remove"){const d=e.appConfig.file.replace(location.origin,"").substr(1),c=wo(e),f=Mt.getAttribute("data-node-id");delete c[f],t.querySelectorAll(`[data-node-id="${f}"]`).forEach(g=>{g.remove()}),E("/api/asset/setFileAnnotation",{path:d+".sya",data:JSON.stringify(c)}),gs(t),s.preventDefault(),s.stopPropagation(),o=!0;break}else if(r==="copy"){gs(t),bp(`${e.appConfig.file.replace(location.origin,"").substr(1)}/${Mt.getAttribute("data-node-id")}`,e.appConfig.file.replace(location.origin,"").substr(8).replace(/-\d{14}-\w{7}.pdf$/,""),e),s.preventDefault(),s.stopPropagation(),o=!0;break}else if(r==="relate"){hC(e),gs(t),s.preventDefault(),s.stopPropagation(),o=!0;break}else if(r==="toggle"){const d=wo(e),c=d[Mt.getAttribute("data-node-id")];c.type==="border"?c.type="text":c.type="border",t.querySelectorAll(`.pdf__rect[data-node-id="${Mt.getAttribute("data-node-id")}"]`).forEach(f=>{Array.from(f.children).forEach(g=>{c.type==="text"?g.style.backgroundColor=g.style.border.replace("2px solid ",""):g.style.backgroundColor=""})}),E("/api/asset/setFileAnnotation",{path:e.appConfig.file.replace(location.origin,"").substr(1)+".sya",data:JSON.stringify(d)}),s.preventDefault(),s.stopPropagation(),o=!0,gs(t);break}l=l.parentElement}o||setTimeout(()=>{let r=!1;const d=window.getSelection();if(d.rangeCount>0){const c=d.getRangeAt(0);c.toString()!==""&&L(c.commonAncestorContainer,"pdfViewer")&&(mE(t,c),r=!0)}r||gs(t)})}),e},sb=t=>{if(!t)return`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;let e="";return t.forEach(n=>{e+=`<li data-id="${n}" class="popover__block b3-list-item b3-list-item--narrow b3-list-item--hide-action">
    <span class="b3-list-item__text">${n}</span>
    <span data-type="clear" class="b3-tooltips b3-tooltips__w b3-list-item__action" aria-label="${window.siyuan.languages.delete}">
        <svg><use xlink:href="#iconTrashcan"></use></svg>
    </span>
</li>`}),e},hC=t=>{const e=wo(t),n=e[Mt.getAttribute("data-node-id")];n.ids||(n.ids=[]);const a=new we({title:window.siyuan.languages.relation,content:`<div class="b3-dialog__content">
    <div class="fn__flex">
        <input class="b3-text-field fn__flex-1" placeholder="${window.siyuan.languages.fileAnnoRefPlaceholder}">
        <div class="fn__space"></div>
        <button class="b3-button b3-button--text" data-type="add">${window.siyuan.languages.addAttr}</button>
    </div>
    <div class="fn__hr"></div>
    <ul class="b3-list b3-list--background">${sb(n.ids)}</ul>
</div>`,width:"520px"}),i=()=>{/\d{14}-\w{7}/.test(o.value)?(n.ids.includes(o.value)||(n.ids.push(o.value),s(t,e),Mt.dataset.relations=n.ids,a.element.querySelector(".b3-list").innerHTML=sb(n.ids)),o.value=""):j("ID "+window.siyuan.languages.invalid)},s=(l,r)=>{E("/api/asset/setFileAnnotation",{path:l.appConfig.file.replace(location.origin,"").substr(1)+".sya",data:JSON.stringify(r)})},o=a.element.querySelector(".b3-text-field");o.focus(),o.addEventListener("keydown",l=>{l.isComposing||l.key==="Enter"&&i()}),a.element.addEventListener("click",l=>{let r=l.target;for(;r&&!r.classList.contains("b3-dialog__content");){const d=r.getAttribute("data-type");if(d==="add"){i(),l.preventDefault(),l.stopPropagation();break}else d==="clear"&&(n.ids.splice(n.ids.indexOf(r.parentElement.textContent.trim()),1),s(t,e),Mt.dataset.relations=n.ids,a.element.querySelector(".b3-list").innerHTML=sb(n.ids));r=r.parentElement}})},gs=t=>{t.querySelector(".pdf__util").classList.add("fn__none")};let Mt;const mE=(t,e,n)=>{n&&(n.setAttribute("prevent-popover","true"),setTimeout(()=>{n.removeAttribute("prevent-popover")},620));const a=t.querySelector(".pdf__util");if(a.classList.remove("fn__none"),e){a.classList.add("pdf__util--hide");const s=e.getClientRects(),o=s[s.length-1];ke(a,o.left,o.bottom),Mt=null;return}Mt=n,a.classList.remove("pdf__util--hide");const i=n.firstElementChild.getBoundingClientRect();ke(a,i.left,i.top+i.height+4)},bE=(t,e)=>{const n=t.querySelectorAll('span[role="presentation"]');let a=e?0:n.length-1;for(;n[a]&&!n[a].textContent;)e?a++:a--;return n[a]},yE=(t,e)=>{const n=window.getSelection().getRangeAt(0),a=L(n.startContainer,"page");if(!a)return;const i=parseInt(a.getAttribute("data-page-number"))-1,s=L(n.endContainer,"page");if(!s)return;const o=parseInt(s.getAttribute("data-page-number"))-1,l=n.cloneContents();Array.from(l.children).forEach(w=>{if(w.tagName==="BR"&&w.previousElementSibling&&w.nextElementSibling){const _=w.previousElementSibling.textContent,x=w.nextElementSibling.textContent;/^[A-Za-z]$/.test(_.substring(_.length-2,_.length-1))&&/^[A-Za-z]$/.test(x.substring(0,1))&&(_.endsWith("-")?w.previousElementSibling.textContent=_.substring(0,_.length-1):w.insertAdjacentText("afterend"," "))}});const r=Lute.EscapeHTMLStr(l.textContent.replace(/[\x00]|\n/g,"")),d=t.pdfViewer.getPageView(i),c=d.canvas.getClientRects()[0],f=d.viewport,g=n.cloneRange();i!==o&&n.setEndAfter(bE(d.textLayer.div,!1));const p=[];wE(n).forEach(function(w){p.push(f.convertToPdfPoint(w.left-c.x,w.top-c.y).concat(f.convertToPdfPoint(w.right-c.x,w.bottom-c.y)))});const h=[];if(i!==o){Z(g);const w=t.pdfViewer.getPageView(o),_=w.canvas.getClientRects()[0],x=w.viewport;g.setStart(bE(w.textLayer.div,!0),0),wE(g).forEach(function(S){h.push(x.convertToPdfPoint(S.left-_.x,S.top-_.y).concat(x.convertToPdfPoint(S.right-_.x,S.bottom-_.y)))})}const m=Lute.NewNodeID(),b=[],y=[];if(p.length>0&&(b.push({index:i,positions:p}),y.push({index:i,coords:p,id:m,color:e,content:r,type:"text",mode:"text"})),h.length>0&&(b.push({index:o,positions:h}),y.push({index:o,coords:h,id:m,color:e,content:r,type:"text",mode:"text"})),b.length!==0)return EE(t,m,{pages:b,content:r,color:e,type:"text",mode:"text"}),y},mC=(t,e,n,a)=>{const i=n.getBoundingClientRect(),s=L(document.elementFromPoint(i.left,i.top-1),"page");if(!s)return;const o=parseInt(s.getAttribute("data-page-number"))-1,l=t.pdfViewer.getPageView(o),r=l.canvas.getClientRects()[0],d=l.viewport,c=d.convertToPdfPoint(i.left-r.x,i.top-r.y).concat(d.convertToPdfPoint(i.right-r.x,i.bottom-r.y)),f=[{index:l.id-1,positions:[c]}],g=Lute.NewNodeID(),p=`${t.appConfig.file.replace(location.origin,"").substr(8).replace(/-\d{14}-\w{7}.pdf$/,"")}-P${l.id}-${g}`,h=[{index:l.id-1,coords:[c],id:g,color:e,content:p,type:a,mode:"rect"}];let m=document.elementFromPoint(i.right,i.bottom+1);if(m=L(m,"page"),m){const b=parseInt(m.getAttribute("data-page-number"))-1;if(b!==o){const y=t.pdfViewer.getPageView(b),w=y.canvas.getClientRects()[0],_=y.viewport,x=_.convertToPdfPoint(i.left-w.x,i.top-w.y).concat(_.convertToPdfPoint(i.right-w.x,i.bottom-w.y));f.push({index:y.id-1,positions:[x]}),h.push({index:y.id-1,coords:[x],id:g,color:e,content:p,type:a,mode:"rect"})}}return EE(t,g,{pages:f,content:p,color:e,type:a,mode:"rect"}),h},wE=t=>{const e=t.getClientRects(),n=[];let a;return Array.from(e).forEach(i=>{i.height===0||i.width===0||(typeof a>"u"||Math.abs(a-i.top)>4?(n.push({left:i.left,top:i.top,right:i.right,bottom:i.bottom}),a=i.top):n[n.length-1].right=i.right)}),n},ob=t=>{let e;return Ce().asset.find(n=>{if(n.pdfObject&&t&&n.element&&typeof n.element.contains<"u"&&n.element.contains(t))return e=n.pdfObject,!0}),e},_E=t=>{const e=ob(t);if(!e)return;const n=parseInt(t.parentElement.getAttribute("data-page-number"))-1,a=wo(e);Object.keys(a).find(i=>{const s=a[i],o=s.pages.find(l=>{if(l.index===n)return!0});o&&mp({index:n,coords:o.positions,id:i,color:s.color,content:s.content,type:s.type,mode:s.mode||"",ids:s.ids},e,e.annoId===i)})},mp=(t,e,n)=>{const a=t.index,i=e.pdfViewer.getPageView(a),s=i.textLayer.div;if(!s.lastElementChild)return;const o=i.viewport.clone({rotation:0});let l=s.querySelector(".pdf__rects");l||(s.insertAdjacentHTML("beforeend","<div class='pdf__rects'></div>"),l=s.querySelector(".pdf__rects"));let r=`<div class="pdf__rect popover__block" data-node-id="${t.id}" data-relations="${t.ids||""}" data-mode="${t.mode}">`;return t.coords.forEach(d=>{const c=o.convertToViewportRectangle(d),f=Math.abs(c[0]-c[2]);if(f<=0)return;let g=`border: 2px solid ${t.color};background-color: ${t.color};`;t.type==="border"&&(g=`border: 2px solid ${t.color};`),r+=`<div style="${g}
left:${Math.min(c[0],c[2])}px;
top:${Math.min(c[1],c[3])}px;
width:${f}px;
height: ${Math.abs(c[1]-c[3])}px"></div>`}),l.insertAdjacentHTML("beforeend",r+"</div>"),l.lastElementChild.setAttribute("data-content",t.content),n&&vE(l,t.id),l.lastElementChild},vE=(t,e)=>{t.querySelectorAll(`.pdf__rect[data-node-id="${e}"]`).forEach(n=>{if(n&&n.firstElementChild){const a=B(n,"id","viewerContainer");if(a){const i=n.firstElementChild.getBoundingClientRect(),s=a.getBoundingClientRect();i.top<s.top?a.scrollTop=a.scrollTop-(s.top-i.top)-(s.height-i.height)/2:i.bottom>s.bottom&&(a.scrollTop=a.scrollTop+(i.bottom-s.bottom)+(s.height-i.height)/2)}n.classList.add("pdf__rect--hl"),setTimeout(()=>{n.classList.remove("pdf__rect--hl")},1500)}})},bp=(t,e,n)=>{const a=Mt.getAttribute("data-mode"),i=Mt.getAttribute("data-content");setTimeout(()=>{a==="rect"||a===""&&Mt.childElementCount===1&&i.startsWith(e)?yC(n).then(s=>{fetch(s).then(o=>o.blob()).then(o=>{const l=new FormData,r=i+".png";l.append("file[]",o,r),l.append("skipIfDuplicated","true"),E(u.UPLOAD_ADDRESS,l,d=>{De(`<<${t} "${i}">>
![](${d.data.succMap[r]})`)})})}):De(`<<${t} "${i}">>`)},u.TIMEOUT_DBLCLICK)},bC=async(t,e)=>{const n=await t.pdfDocument.getPage(e),a=n.getViewport({scale:1.5*t.pdfViewer.currentScale*window.pdfjsLib.PixelsPerInch.PDF_TO_CSS_UNITS}),i=document.createElement("canvas");return i.width=Math.floor(a.width),i.height=Math.floor(a.height),await n.render({canvasContext:i.getContext("2d"),viewport:a}).promise,i};async function yC(t){const e=L(Mt,"page");if(!e)return;const n=await bC(t,parseInt(e.getAttribute("data-page-number"))),a=Mt.firstElementChild.style,i=1.5,s=n.getContext("2d").getImageData(i*parseFloat(a.left),i*parseFloat(a.top),i*parseFloat(a.width),i*parseFloat(a.height)),o=document.createElement("canvas");return o.width=s.width,o.height=s.height,o.getContext("2d").putImageData(s,0,0),o.toDataURL()}const EE=(t,e,n)=>{const a=wo(t);a[e]=n,E("/api/asset/setFileAnnotation",{path:t.appConfig.file.replace(location.origin,"").substr(1)+".sya",data:JSON.stringify(a)})},wo=t=>{if(t.appConfig.config)return t.appConfig.config;const e=t.appConfig.file.replace(location.origin,"").substr(1)+".sya";E("/api/asset/getFileAnnotation",{path:e},n=>{let a={};n.code!==1&&(a=JSON.parse(n.data.data)),t.appConfig.config=a})},uu=class{constructor({pdfPage:e,highlighter:n=null,accessibilityManager:a=null,enablePermissions:i=!1,onAppend:s=null}){D(this,qg);D(this,cu,!1);D(this,du,null);D(this,tl,!1);D(this,hi,null);this.pdfPage=e,this.highlighter=n,this.accessibilityManager=a,R(this,cu,i===!0),R(this,du,s),this.div=document.createElement("div"),this.div.tabIndex=0,this.div.className="textLayer"}async render(e,n=null){var o;if(v(this,tl)&&v(this,hi)){v(this,hi).update({viewport:e,onBefore:this.hide.bind(this)}),this.show(),this.div.querySelector(".pdf__rects")?.remove(),_E(this.div);return}this.cancel(),R(this,hi,new G.TextLayer({textContentSource:this.pdfPage.streamTextContent(n||{includeMarkedContent:!0,disableNormalization:!0}),container:this.div,viewport:e}));const{textDivs:a,textContentItemsStr:i}=v(this,hi);this.highlighter?.setTextMapping(a,i),this.accessibilityManager?.setTextMapping(a),await v(this,hi).render(),R(this,tl,!0);const s=document.createElement("div");s.className="endOfContent",this.div.append(s),I(this,qg,ES).call(this,s),(o=v(this,du))==null||o.call(this,this.div),this.highlighter?.enable(),_E(this.div),this.accessibilityManager?.enable()}hide(){!this.div.hidden&&v(this,tl)&&(this.highlighter?.disable(),this.div.hidden=!0)}show(){this.div.hidden&&v(this,tl)&&(this.div.hidden=!1,this.highlighter?.enable())}cancel(){var e;v(this,hi)?.cancel(),R(this,hi,null),this.highlighter?.disable(),this.accessibilityManager?.disable(),I(e=uu,Fg,kS).call(e,this.div)}};let _o=uu;cu=new WeakMap,du=new WeakMap,tl=new WeakMap,hi=new WeakMap,zn=new WeakMap,Os=new WeakMap,qg=new WeakSet,ES=function(e){var a;const{div:n}=this;n.addEventListener("mousedown",()=>{n.classList.add("selecting")}),n.addEventListener("copy",i=>{if(!v(this,cu)){const s=document.getSelection();i.clipboardData.setData("text/plain",Fl((0,G.normalizeUnicode)(s.toString())))}i.preventDefault(),i.stopPropagation()}),v(uu,zn).set(n,e),I(a=uu,Ug,SS).call(a)},Fg=new WeakSet,kS=function(e){v(this,zn).delete(e),v(this,zn).size===0&&(v(this,Os)?.abort(),R(this,Os,null))},Ug=new WeakSet,SS=function(){if(v(this,Os))return;R(this,Os,new AbortController);const{signal:e}=v(this,Os),n=(o,l)=>{(typeof PDFJSDev>"u"||!PDFJSDev.test("MOZCENTRAL"))&&(l.append(o),o.style.width="",o.style.height=""),l.classList.remove("selecting")};let a=!1;if(document.addEventListener("pointerdown",()=>{a=!0},{signal:e}),document.addEventListener("pointerup",()=>{a=!1,v(this,zn).forEach(n)},{signal:e}),window.addEventListener("blur",()=>{a=!1,v(this,zn).forEach(n)},{signal:e}),document.addEventListener("keyup",()=>{a||v(this,zn).forEach(n)},{signal:e}),typeof PDFJSDev>"u"||!PDFJSDev.test("MOZCENTRAL"))var i,s;document.addEventListener("selectionchange",()=>{const o=document.getSelection();if(o.rangeCount===0){v(this,zn).forEach(n);return}const l=new Set;for(let p=0;p<o.rangeCount;p++){const h=o.getRangeAt(p);for(const m of v(this,zn).keys())!l.has(m)&&h.intersectsNode(m)&&l.add(m)}for(const[p,h]of v(this,zn))l.has(p)?p.classList.add("selecting"):n(h,p);if(typeof PDFJSDev<"u"&&PDFJSDev.test("MOZCENTRAL")||(typeof PDFJSDev>"u"||!PDFJSDev.test("CHROME"))&&(i??=getComputedStyle(v(this,zn).values().next().value).getPropertyValue("-moz-user-select")==="none",i))return;const r=o.getRangeAt(0),d=s&&(r.compareBoundaryPoints(Range.END_TO_END,s)===0||r.compareBoundaryPoints(Range.START_TO_END,s)===0);let c=d?r.startContainer:r.endContainer;c.nodeType===Node.TEXT_NODE&&(c=c.parentNode);const f=c.parentElement.closest(".textLayer"),g=v(this,zn).get(f);g&&(g.style.width=f.style.width,g.style.height=f.style.height,c.parentElement.insertBefore(g,d?c:c.nextSibling)),s=r.cloneRange()},{signal:e})},D(_o,Fg),D(_o,Ug),D(_o,zn,new Map),D(_o,Os,null);const wC=typeof PDFJSDev>"u"||!PDFJSDev.test("COMPONENTS")?null:{annotationEditorUIManager:null,annotationStorage:null,downloadManager:null,enableScripting:!1,fieldObjectsPromise:null,findController:null,hasJSActionsPromise:null,get linkService(){return new Fm}},_C=new Map([["canvasWrapper",0],["textLayer",1],["annotationLayer",2],["annotationEditorLayer",3],["xfaLayer",3]]);class vC{constructor(e){D(this,Us);D(this,Dr);D(this,ol);D(this,bu);D(this,yu);D(this,wu);D(this,_u);D(this,vu);D(this,Wg);D(this,Yg);D(this,Eu);D(this,nl,G.AnnotationMode.ENABLE_FORMS);D(this,fu,!1);D(this,al,!1);D(this,pu,!1);D(this,Bs,null);D(this,qs,null);D(this,gu,null);D(this,hu,1);D(this,mu,1);D(this,il,null);D(this,Tr,We.INITIAL);D(this,Ir,qa.ENABLE);D(this,Yi,{directDrawing:!0,initialOptionalContent:!0,regularAnnotations:!0});D(this,sl,new WeakMap);D(this,Fs,[null,null,null,null]);const n=e.container,a=e.defaultViewport;this.id=e.id,this.renderingId="page"+this.id,R(this,Bs,e.layerProperties||wC),this.pdfPage=null,this.pageLabel=null,this.rotation=0,this.scale=e.scale||Hm,this.viewport=a,this.pdfPageRotate=a.rotation,this._optionalContentConfigPromise=e.optionalContentConfigPromise||null,R(this,Ir,e.textLayerMode??qa.ENABLE),R(this,nl,e.annotationMode??G.AnnotationMode.ENABLE_FORMS),this.imageResourcesPath=e.imageResourcesPath||"",this.maxCanvasPixels=e.maxCanvasPixels??se.get("maxCanvasPixels"),this.pageColors=e.pageColors||null,R(this,fu,e.enableHWA||!1),this.eventBus=e.eventBus,this.renderingQueue=e.renderingQueue,this.l10n=e.l10n,(typeof PDFJSDev>"u"||PDFJSDev.test("GENERIC"))&&(this.l10n||=new GenericL10n),this.renderTask=null,this.resume=null,(typeof PDFJSDev>"u"||PDFJSDev.test("GENERIC"))&&(this._isStandalone=!this.renderingQueue?.hasViewer(),this._container=n),this._annotationCanvasMap=null,this.annotationLayer=null,this.annotationEditorLayer=null,this.textLayer=null,this.zoomLayer=null,this.xfaLayer=null,this.structTreeLayer=null,this.drawLayer=null;const i=document.createElement("div");if(i.className="page",i.setAttribute("data-page-number",this.id),i.setAttribute("role","region"),i.setAttribute("aria-label",window.siyuan.languages.thumbPageTitle.replace("{{page}}",this.id)),this.div=i,I(this,Dr,mh).call(this),n?.append(i),(typeof PDFJSDev>"u"||PDFJSDev.test("GENERIC"))&&this._isStandalone){n?.style.setProperty("--scale-factor",this.scale*G.PixelsPerInch.PDF_TO_CSS_UNITS),this.pageColors?.background&&n?.style.setProperty("--page-bg-color",this.pageColors.background);const{optionalContentConfigPromise:s}=e;s&&s.then(o=>{s===this._optionalContentConfigPromise&&(v(this,Yi).initialOptionalContent=o.hasInitialVisibility)}),e.l10n||this.l10n.translate(this.div)}}get renderingState(){return v(this,Tr)}set renderingState(e){if(e!==v(this,Tr))switch(R(this,Tr,e),v(this,qs)&&(clearTimeout(v(this,qs)),R(this,qs,null)),e){case We.PAUSED:this.div.classList.remove("loading");break;case We.RUNNING:this.div.classList.add("loadingIcon"),R(this,qs,setTimeout(()=>{this.div.classList.add("loading"),R(this,qs,null)},0));break;case We.INITIAL:case We.FINISHED:this.div.classList.remove("loadingIcon","loading");break}}setPdfPage(e){(typeof PDFJSDev>"u"||PDFJSDev.test("GENERIC"))&&this._isStandalone&&(this.pageColors?.foreground==="CanvasText"||this.pageColors?.background==="Canvas")&&(this._container?.style.setProperty("--hcm-highlight-filter",e.filterFactory.addHighlightHCMFilter("highlight","CanvasText","Canvas","HighlightText","Highlight")),this._container?.style.setProperty("--hcm-highlight-selected-filter",e.filterFactory.addHighlightHCMFilter("highlight_selected","CanvasText","Canvas","HighlightText","Highlight"))),this.pdfPage=e,this.pdfPageRotate=e.rotate;const n=(this.rotation+this.pdfPageRotate)%360;this.viewport=e.getViewport({scale:this.scale*G.PixelsPerInch.PDF_TO_CSS_UNITS,rotation:n}),I(this,Dr,mh).call(this),this.reset()}destroy(){this.reset(),this.pdfPage?.cleanup()}hasEditableAnnotations(){return!!this.annotationLayer?.hasEditableAnnotations()}get _textHighlighter(){return(0,G.shadow)(this,"_textHighlighter",new pC({pageIndex:this.id-1,eventBus:this.eventBus,findController:v(this,Bs).findController}))}_resetZoomLayer(e=!1){if(!this.zoomLayer)return;const n=this.zoomLayer.firstChild;v(this,sl).delete(n),n.width=0,n.height=0,e&&this.zoomLayer.remove(),this.zoomLayer=null}reset({keepZoomLayer:e=!1,keepAnnotationLayer:n=!1,keepAnnotationEditorLayer:a=!1,keepXfaLayer:i=!1,keepTextLayer:s=!1}={}){this.cancelRendering({keepAnnotationLayer:n,keepAnnotationEditorLayer:a,keepXfaLayer:i,keepTextLayer:s}),this.renderingState=We.INITIAL;const o=this.div,l=o.childNodes,r=e&&this.zoomLayer||null,d=n&&this.annotationLayer?.div||null,c=a&&this.annotationEditorLayer?.div||null,f=i&&this.xfaLayer?.div||null,g=s&&this.textLayer?.div||null;for(let p=l.length-1;p>=0;p--){const h=l[p];switch(h){case r:case d:case c:case f:case g:continue}h.remove();const m=v(this,Fs).indexOf(h);m>=0&&(v(this,Fs)[m]=null)}o.removeAttribute("data-loaded"),d&&this.annotationLayer.hide(),c&&this.annotationEditorLayer.hide(),f&&this.xfaLayer.hide(),g&&this.textLayer.hide(),this.structTreeLayer?.hide(),r||(this.canvas&&(v(this,sl).delete(this.canvas),this.canvas.width=0,this.canvas.height=0,delete this.canvas),this._resetZoomLayer())}toggleEditingMode(e){this.hasEditableAnnotations()&&(R(this,pu,e),this.reset({keepZoomLayer:!0,keepAnnotationLayer:!0,keepAnnotationEditorLayer:!0,keepXfaLayer:!0,keepTextLayer:!0}))}update({scale:e=0,rotation:n=null,optionalContentConfigPromise:a=null,drawingDelay:i=-1}){this.scale=e||this.scale,typeof n=="number"&&(this.rotation=n),a instanceof Promise&&(this._optionalContentConfigPromise=a,a.then(o=>{a===this._optionalContentConfigPromise&&(v(this,Yi).initialOptionalContent=o.hasInitialVisibility)})),v(this,Yi).directDrawing=!0;const s=(this.rotation+this.pdfPageRotate)%360;if(this.viewport=this.viewport.clone({scale:this.scale*G.PixelsPerInch.PDF_TO_CSS_UNITS,rotation:s}),I(this,Dr,mh).call(this),(typeof PDFJSDev>"u"||PDFJSDev.test("GENERIC"))&&this._isStandalone&&this._container?.style.setProperty("--scale-factor",this.viewport.scale),this.canvas){let o=!1;if(v(this,al)){if((typeof PDFJSDev>"u"||PDFJSDev.test("GENERIC"))&&this.maxCanvasPixels===0)o=!0;else if(this.maxCanvasPixels>0){const{width:r,height:d}=this.viewport,{sx:c,sy:f}=this.outputScale;o=(Math.floor(r)*c|0)*(Math.floor(d)*f|0)>this.maxCanvasPixels}}const l=i>=0&&i<1e3;if(l||o){if(l&&!o&&this.renderingState!==We.FINISHED&&(this.cancelRendering({keepZoomLayer:!0,keepAnnotationLayer:!0,keepAnnotationEditorLayer:!0,keepXfaLayer:!0,keepTextLayer:!0,cancelExtraDelay:i}),this.renderingState=We.FINISHED,v(this,Yi).directDrawing=!1),this.cssTransform({target:this.canvas,redrawAnnotationLayer:!0,redrawAnnotationEditorLayer:!0,redrawXfaLayer:!0,redrawTextLayer:!l,hideTextLayer:l}),l)return;this.eventBus.dispatch("pagerendered",{source:this,pageNumber:this.id,cssTransform:!0,timestamp:performance.now(),error:v(this,il)});return}!this.zoomLayer&&!this.canvas.hidden&&(this.zoomLayer=this.canvas.parentNode,this.zoomLayer.style.position="absolute")}this.zoomLayer&&this.cssTransform({target:this.zoomLayer.firstChild}),this.reset({keepZoomLayer:!0,keepAnnotationLayer:!0,keepAnnotationEditorLayer:!0,keepXfaLayer:!0,keepTextLayer:!0})}cancelRendering({keepAnnotationLayer:e=!1,keepAnnotationEditorLayer:n=!1,keepXfaLayer:a=!1,keepTextLayer:i=!1,cancelExtraDelay:s=0}={}){this.renderTask&&(this.renderTask.cancel(s),this.renderTask=null),this.resume=null,this.textLayer&&(!i||!this.textLayer.div)&&(this.textLayer.cancel(),this.textLayer=null),this.annotationLayer&&(!e||!this.annotationLayer.div)&&(this.annotationLayer.cancel(),this.annotationLayer=null,this._annotationCanvasMap=null),this.structTreeLayer&&!this.textLayer&&(this.structTreeLayer=null),this.annotationEditorLayer&&(!n||!this.annotationEditorLayer.div)&&(this.drawLayer&&(this.drawLayer.cancel(),this.drawLayer=null),this.annotationEditorLayer.cancel(),this.annotationEditorLayer=null),this.xfaLayer&&(!a||!this.xfaLayer.div)&&(this.xfaLayer.cancel(),this.xfaLayer=null,this._textHighlighter?.disable())}cssTransform({target:e,redrawAnnotationLayer:n=!1,redrawAnnotationEditorLayer:a=!1,redrawXfaLayer:i=!1,redrawTextLayer:s=!1,hideTextLayer:o=!1}){if((typeof PDFJSDev>"u"||PDFJSDev.test("TESTING"))&&!(e instanceof HTMLCanvasElement))throw new Error("Expected `target` to be a canvas.");if(!e.hasAttribute("zooming")){e.setAttribute("zooming",!0);const{style:r}=e;r.width=r.height=""}const l=v(this,sl).get(e);if(this.viewport!==l){const r=this.viewport.rotation-l.rotation,d=Math.abs(r);let c=1,f=1;if(d===90||d===270){const{width:g,height:p}=this.viewport;c=p/g,f=g/p}e.style.transform=`rotate(${r}deg) scale(${c}, ${f})`}n&&this.annotationLayer&&I(this,bu,Ty).call(this),a&&this.annotationEditorLayer&&(this.drawLayer&&I(this,wu,Dy).call(this),I(this,yu,Iy).call(this)),i&&this.xfaLayer&&I(this,_u,$y).call(this),this.textLayer&&(o?(this.textLayer.hide(),this.structTreeLayer?.hide()):s&&I(this,vu,My).call(this))}get width(){return this.viewport.width}get height(){return this.viewport.height}getPagePoint(e,n){return this.viewport.convertToPdfPoint(e,n)}async draw(){this.renderingState!==We.INITIAL&&(console.error("Must be in new state before drawing"),this.reset());const{div:e,l10n:n,pageColors:a,pdfPage:i,viewport:s}=this;if(!i)throw this.renderingState=We.FINISHED,new Error("pdfPage is not loaded");this.renderingState=We.RUNNING;const o=document.createElement("div");if(o.classList.add("canvasWrapper"),I(this,Us,Wr).call(this,o,"canvasWrapper"),!this.textLayer&&v(this,Ir)!==qa.DISABLE&&!i.isPureXfa&&(this._accessibilityManager||=new hp,this.textLayer=new _o({pdfPage:i,highlighter:this._textHighlighter,accessibilityManager:this._accessibilityManager,enablePermissions:v(this,Ir)===qa.ENABLE_PERMISSIONS,onAppend:M=>{this.l10n.pause(),I(this,Us,Wr).call(this,M,"textLayer"),this.l10n.resume()}})),!this.annotationLayer&&v(this,nl)!==G.AnnotationMode.DISABLE){const{annotationStorage:M,annotationEditorUIManager:C,downloadManager:N,enableScripting:O,fieldObjectsPromise:te,hasJSActionsPromise:ne,linkService:oe}=v(this,Bs);this._annotationCanvasMap||=new Map,this.annotationLayer=new cC({pdfPage:i,annotationStorage:M,imageResourcesPath:this.imageResourcesPath,renderForms:v(this,nl)===G.AnnotationMode.ENABLE_FORMS,linkService:oe,downloadManager:N,enableScripting:O,hasJSActionsPromise:ne,fieldObjectsPromise:te,annotationCanvasMap:this._annotationCanvasMap,accessibilityManager:this._accessibilityManager,annotationEditorUIManager:C,onAppend:ce=>{I(this,Us,Wr).call(this,ce,"annotationLayer")}})}const l=M=>{if(g?.(!1),this.renderingQueue&&!this.renderingQueue.isHighestPriority(this)){this.renderingState=We.PAUSED,this.resume=()=>{this.renderingState=We.RUNNING,M()};return}M()},{width:r,height:d}=s,c=document.createElement("canvas");c.setAttribute("role","presentation"),c.hidden=!0;const f=!!(a?.background&&a?.foreground);let g=M=>{(!f||M)&&(c.hidden=!1,g=null)};o.append(c),this.canvas=c;const p=c.getContext("2d",{alpha:!1,willReadFrequently:!v(this,fu)}),h=this.outputScale=new G.OutputScale;if((typeof PDFJSDev>"u"||PDFJSDev.test("GENERIC"))&&this.maxCanvasPixels===0){const M=1/this.scale;h.sx*=M,h.sy*=M,R(this,al,!0)}else if(this.maxCanvasPixels>0){const M=r*d,C=Math.sqrt(this.maxCanvasPixels/M);h.sx>C||h.sy>C?(h.sx=C,h.sy=C,R(this,al,!0)):R(this,al,!1)}const m=Rv(h.sx),b=Rv(h.sy),y=c.width=rp(dp(r*h.sx),m[0]),w=c.height=rp(dp(d*h.sy),b[0]),_=rp(dp(r),m[1]),x=rp(dp(d),b[1]);h.sx=y/_,h.sy=w/x,v(this,hu)!==m[1]&&(e.style.setProperty("--scale-round-x",`${m[1]}px`),R(this,hu,m[1])),v(this,mu)!==b[1]&&(e.style.setProperty("--scale-round-y",`${b[1]}px`),R(this,mu,b[1])),v(this,sl).set(c,s);const S=h.scaled?[h.sx,0,0,h.sy,0,0]:null,k={canvasContext:p,transform:S,viewport:s,annotationMode:v(this,nl),optionalContentConfigPromise:this._optionalContentConfigPromise,annotationCanvasMap:this._annotationCanvasMap,pageColors:a,isEditing:v(this,pu)},A=this.renderTask=i.render(k);A.onContinue=l;const $=A.promise.then(async()=>{g?.(!0),await I(this,Eu,Py).call(this,A),this.structTreeLayer||=new fC(i,s.rawDims),I(this,vu,My).call(this),this.annotationLayer&&await I(this,bu,Ty).call(this);const{annotationEditorUIManager:M}=v(this,Bs);M&&(this.drawLayer||=new dC({pageIndex:this.id}),await I(this,wu,Dy).call(this),this.drawLayer.setParent(o),this.annotationEditorLayer||=new rC({uiManager:M,pdfPage:i,l10n:n,structTreeLayer:this.structTreeLayer,accessibilityManager:this._accessibilityManager,annotationLayer:this.annotationLayer?.annotationLayer,textLayer:this.textLayer,drawLayer:this.drawLayer.getDrawLayer(),onAppend:C=>{I(this,Us,Wr).call(this,C,"annotationEditorLayer")}}),I(this,yu,Iy).call(this))},M=>(M instanceof G.RenderingCancelledException||g?.(!0),I(this,Eu,Py).call(this,A,M)));if(i.isPureXfa){if(!this.xfaLayer){const{annotationStorage:M,linkService:C}=v(this,Bs);this.xfaLayer=new sE({pdfPage:i,annotationStorage:M,linkService:C})}I(this,_u,$y).call(this)}return e.setAttribute("data-loaded",!0),this.eventBus.dispatch("pagerender",{source:this,pageNumber:this.id}),$}setPageLabel(e){this.pageLabel=typeof e=="string"?e:null,this.div.setAttribute("data-l10n-args",JSON.stringify({page:this.pageLabel??this.id})),this.pageLabel!==null?this.div.setAttribute("data-page-label",this.pageLabel):this.div.removeAttribute("data-page-label")}get thumbnailCanvas(){const{directDrawing:e,initialOptionalContent:n,regularAnnotations:a}=v(this,Yi);return e&&n&&a?this.canvas:null}}nl=new WeakMap,fu=new WeakMap,al=new WeakMap,pu=new WeakMap,Bs=new WeakMap,qs=new WeakMap,gu=new WeakMap,hu=new WeakMap,mu=new WeakMap,il=new WeakMap,Tr=new WeakMap,Ir=new WeakMap,Yi=new WeakMap,sl=new WeakMap,Fs=new WeakMap,Us=new WeakSet,Wr=function(e,n){const a=_C.get(n),i=v(this,Fs)[a];if(v(this,Fs)[a]=e,i){i.replaceWith(e);return}for(let s=a-1;s>=0;s--){const o=v(this,Fs)[s];if(o){o.after(e);return}}this.div.prepend(e)},Dr=new WeakSet,mh=function(){const{viewport:e}=this;if(this.pdfPage){if(v(this,gu)===e.rotation)return;R(this,gu,e.rotation)}(0,G.setLayerDimensions)(this.div,e,!0,!1)},ol=new WeakSet,Zu=function(e,n){this.eventBus.dispatch(e,{source:this,pageNumber:this.id,error:n})},bu=new WeakSet,Ty=async function(){let e=null;try{await this.annotationLayer.render(this.viewport,{structTreeLayer:this.structTreeLayer},"display")}catch(n){console.error(`#renderAnnotationLayer: "${n}".`),e=n}finally{I(this,ol,Zu).call(this,"annotationlayerrendered",e)}},yu=new WeakSet,Iy=async function(){let e=null;try{await this.annotationEditorLayer.render(this.viewport,"display")}catch(n){console.error(`#renderAnnotationEditorLayer: "${n}".`),e=n}finally{I(this,ol,Zu).call(this,"annotationeditorlayerrendered",e)}},wu=new WeakSet,Dy=async function(){try{await this.drawLayer.render("display")}catch(e){console.error(`#renderDrawLayer: "${e}".`)}},_u=new WeakSet,$y=async function(){let e=null;try{const n=await this.xfaLayer.render(this.viewport,"display");n?.textDivs&&this._textHighlighter&&I(this,Yg,xS).call(this,n.textDivs)}catch(n){console.error(`#renderXfaLayer: "${n}".`),e=n}finally{this.xfaLayer?.div&&(this.l10n.pause(),I(this,Us,Wr).call(this,this.xfaLayer.div,"xfaLayer"),this.l10n.resume()),I(this,ol,Zu).call(this,"xfalayerrendered",e)}},vu=new WeakSet,My=async function(){if(!this.textLayer)return;let e=null;await this.textLayer.render(this.viewport),I(this,ol,Zu).call(this,"textlayerrendered",e),I(this,Wg,LS).call(this)},Wg=new WeakSet,LS=async function(){if(!this.textLayer)return;const e=await this.structTreeLayer?.render();e&&(this.l10n.pause(),this.structTreeLayer?.addElementsToTextLayer(),this.canvas&&e.parentNode!==this.canvas&&this.canvas.append(e),this.l10n.resume()),this.structTreeLayer?.show()},Yg=new WeakSet,xS=async function(e){const n=await this.pdfPage.getTextContent(),a=[];for(const i of n.items)a.push(i.str);this._textHighlighter.setTextMapping(e,a),this._textHighlighter.enable()},Eu=new WeakSet,Py=async function(e,n=null){if(e===this.renderTask&&(this.renderTask=null),n instanceof G.RenderingCancelledException){R(this,il,null);return}if(R(this,il,n),this.renderingState=We.FINISHED,this._resetZoomLayer(!0),v(this,Yi).regularAnnotations=!e.separateAnnots,this.eventBus.dispatch("pagerendered",{source:this,pageNumber:this.id,cssTransform:!1,timestamp:performance.now(),error:v(this,il)}),n)throw n};const kE=10,Pc={FORCE_SCROLL_MODE_PAGE:1e4,FORCE_LAZY_PAGE_INIT:5e3,PAUSE_EAGER_PAGE_INIT:250};function SE(t){return Object.values(G.AnnotationEditorType).includes(t)&&t!==G.AnnotationEditorType.DISABLE}class EC{constructor(e){D(this,ku);D(this,zi,new Set);D(this,ll,0);R(this,ll,e)}push(e){const n=v(this,zi);n.has(e)&&n.delete(e),n.add(e),n.size>v(this,ll)&&I(this,ku,Ny).call(this)}resize(e,n=null){R(this,ll,e);const a=v(this,zi);if(n){const i=a.size;let s=1;for(const o of a)if(n.has(o.id)&&(a.delete(o),a.add(o)),++s>i)break}for(;a.size>v(this,ll);)I(this,ku,Ny).call(this)}has(e){return v(this,zi).has(e)}[Symbol.iterator](){return v(this,zi).keys()}}zi=new WeakMap,ll=new WeakMap,ku=new WeakSet,Ny=function(){const e=v(this,zi).keys().next().value;e?.destroy(),v(this,zi).delete(e)};class kC{constructor(e){D(this,zg);D(this,Vg);D(this,Gg);D(this,pl);D(this,Hr);D(this,jg);D(this,Mu);D(this,Kg);D(this,bi);D(this,Pu);D(this,Zg);D(this,Jg);D(this,Xg);D(this,Nu);D(this,Qg);D(this,Rr);D(this,Ws,null);D(this,Su,null);D(this,Lu,null);D(this,mi,G.AnnotationEditorType.NONE);D(this,oa,null);D(this,rl,G.AnnotationMode.ENABLE_FORMS);D(this,xu,null);D(this,Au,!1);D(this,Cu,!1);D(this,Tu,!1);D(this,Iu,!1);D(this,Du,!1);D(this,Ys,null);D(this,cl,null);D(this,dl,null);D(this,ul,null);D(this,$r,!1);D(this,zs,null);D(this,Mr,!1);D(this,$u,0);D(this,Pr,new ResizeObserver(I(this,Qg,NS).bind(this)));D(this,fl,null);D(this,Vs,null);D(this,Nr,qa.ENABLE);if(this.container=e.container,this.viewer=e.viewer||e.container.firstElementChild,typeof PDFJSDev>"u"||PDFJSDev.test("GENERIC")){if(this.container?.tagName!=="DIV"||this.viewer?.tagName!=="DIV")throw new Error("Invalid `container` and/or `viewer` option.");if(this.container.offsetParent&&getComputedStyle(this.container).position!=="absolute")throw new Error("The `container` must be absolutely positioned.")}v(this,Pr).observe(this.container),this.eventBus=e.eventBus,this.linkService=e.linkService||new Fm,this.downloadManager=e.downloadManager||null,this.findController=e.findController||null,R(this,Su,e.altTextManager||null),this.findController&&(this.findController.onIsPageVisible=a=>this._getVisiblePages().ids.has(a)),this._scriptingManager=e.scriptingManager||null,R(this,Nr,e.textLayerMode??qa.ENABLE),R(this,rl,e.annotationMode??G.AnnotationMode.ENABLE_FORMS),R(this,mi,e.annotationEditorMode??G.AnnotationEditorType.NONE),R(this,Lu,e.annotationEditorHighlightColors||null),R(this,Cu,e.enableHighlightFloatingButton===!0),R(this,Iu,e.enableUpdatedAddImage===!0),R(this,Du,e.enableNewAltTextWhenAddingImage===!0),this.imageResourcesPath=e.imageResourcesPath||"",this.enablePrintAutoRotate=e.enablePrintAutoRotate||!1,(typeof PDFJSDev>"u"||PDFJSDev.test("GENERIC"))&&(this.removePageBorders=e.removePageBorders||!1),this.maxCanvasPixels=e.maxCanvasPixels,this.l10n=e.l10n,(typeof PDFJSDev>"u"||PDFJSDev.test("GENERIC"))&&(this.l10n||=new GenericL10n),R(this,Tu,e.enablePermissions||!1),this.pageColors=e.pageColors||null,R(this,cl,e.mlManager||null),R(this,Au,e.enableHWA||!1),this.defaultRenderingQueue=!e.renderingQueue,(typeof PDFJSDev>"u"||PDFJSDev.test("GENERIC"))&&this.defaultRenderingQueue?(this.renderingQueue=new dE,this.renderingQueue.setViewer(this)):this.renderingQueue=e.renderingQueue;const{abortSignal:n}=e;n?.addEventListener("abort",()=>{v(this,Pr).disconnect(),R(this,Pr,null)},{once:!0}),this.scroll=Nv(this.container,this._scrollUpdate.bind(this),n),this.presentationModeState=on.UNKNOWN,this._resetView(),(typeof PDFJSDev>"u"||PDFJSDev.test("GENERIC"))&&this.removePageBorders&&this.viewer.classList.add("removePageBorders"),I(this,Nu,Oy).call(this),this.eventBus._on("thumbnailrendered",({pageNumber:a,pdfPage:i})=>{const s=this._pages[a-1];v(this,Ws).has(s)||i?.cleanup()}),(typeof PDFJSDev>"u"||PDFJSDev.test("GENERIC"))&&!e.l10n&&this.l10n.translate(this.container)}get pagesCount(){return this._pages.length}getPageView(e){return this._pages[e]}getCachedPageViews(){return new Set(v(this,Ws))}get pageViewsReady(){return this._pages.every(e=>e?.pdfPage)}get renderForms(){return v(this,rl)===G.AnnotationMode.ENABLE_FORMS}get enableScripting(){return!!this._scriptingManager}get currentPageNumber(){return this._currentPageNumber}set currentPageNumber(e){if(!Number.isInteger(e))throw new Error("Invalid page number.");this.pdfDocument&&(this._setCurrentPageNumber(e,!0)||console.error(`currentPageNumber: "${e}" is not a valid page.`))}_setCurrentPageNumber(e,n=!1){if(this._currentPageNumber===e)return n&&I(this,Pu,Ry).call(this),!0;if(!(0<e&&e<=this.pagesCount))return!1;const a=this._currentPageNumber;return this._currentPageNumber=e,this.eventBus.dispatch("pagechanging",{source:this,pageNumber:e,pageLabel:this._pageLabels?.[e-1]??null,previous:a}),n&&I(this,Pu,Ry).call(this),!0}get currentPageLabel(){return this._pageLabels?.[this._currentPageNumber-1]??null}set currentPageLabel(e){if(!this.pdfDocument)return;let n=e|0;if(this._pageLabels){const a=this._pageLabels.indexOf(e);a>=0&&(n=a+1)}this._setCurrentPageNumber(n,!0)||console.error(`currentPageLabel: "${e}" is not a valid page.`)}get currentScale(){return this._currentScale!==Rm?this._currentScale:Hm}set currentScale(e){if(isNaN(e))throw new Error("Invalid numeric scale.");this.pdfDocument&&I(this,bi,js).call(this,e,{noScroll:!1})}get currentScaleValue(){return this._currentScaleValue}set currentScaleValue(e){this.pdfDocument&&I(this,bi,js).call(this,e,{noScroll:!1})}get pagesRotation(){return this._pagesRotation}set pagesRotation(e){if(!cp(e))throw new Error("Invalid pages rotation angle.");if(!this.pdfDocument||(e%=360,e<0&&(e+=360),this._pagesRotation===e))return;this._pagesRotation=e;const n=this._currentPageNumber;this.refresh(!0,{rotation:e}),this._currentScaleValue&&I(this,bi,js).call(this,this._currentScaleValue,{noScroll:!0}),this.eventBus.dispatch("rotationchanging",{source:this,pagesRotation:e,pageNumber:n}),this.defaultRenderingQueue&&this.update()}get firstPagePromise(){return this.pdfDocument?this._firstPageCapability.promise:null}get onePageRendered(){return this.pdfDocument?this._onePageRenderedCapability.promise:null}get pagesPromise(){return this.pdfDocument?this._pagesCapability.promise:null}get _layerProperties(){const e=this;return(0,G.shadow)(this,"_layerProperties",{get annotationEditorUIManager(){return v(e,oa)},get annotationStorage(){return e.pdfDocument?.annotationStorage},get downloadManager(){return e.downloadManager},get enableScripting(){return!!e._scriptingManager},get fieldObjectsPromise(){return e.pdfDocument?.getFieldObjects()},get findController(){return e.findController},get hasJSActionsPromise(){return e.pdfDocument?.hasJSActions()},get linkService(){return e.linkService}})}async getAllText(){const e=[],n=[];for(let a=1,i=this.pdfDocument.numPages;a<=i;++a){if(v(this,Mr))return null;n.length=0;const s=await this.pdfDocument.getPage(a),{items:o}=await s.getTextContent();for(const l of o)l.str&&n.push(l.str),l.hasEOL&&n.push(`
`);e.push(Fl(n.join("")))}return e.join(`
`)}setDocument(e){if(this.pdfDocument&&(this.eventBus.dispatch("pagesdestroy",{source:this}),this._cancelRendering(),this._resetView(),this.findController?.setDocument(null),this._scriptingManager?.setDocument(null),v(this,oa)?.destroy(),R(this,oa,null)),this.pdfDocument=e,!e)return;const n=e.numPages,a=e.getPage(1),i=e.getOptionalContentConfig({intent:"display"}),s=v(this,Tu)?e.getPermissions():Promise.resolve(),{eventBus:o,pageColors:l,viewer:r}=this;R(this,Ys,new AbortController);const{signal:d}=v(this,Ys);if(n>Pc.FORCE_SCROLL_MODE_PAGE){console.warn("Forcing PAGE-scrolling for performance reasons, given the length of the document.");const g=this._scrollMode=Te.PAGE;o.dispatch("scrollmodechanged",{source:this,mode:g})}this._pagesCapability.promise.then(()=>{o.dispatch("pagesloaded",{source:this,pagesCount:n})},()=>{});const c=g=>{const p=this._pages[g.pageNumber-1];p&&v(this,Ws).push(p)};o._on("pagerender",c,{signal:d});const f=g=>{g.cssTransform||(this._onePageRenderedCapability.resolve({timestamp:g.timestamp}),o._off("pagerendered",f))};o._on("pagerendered",f,{signal:d}),Promise.all([a,s]).then(([g,p])=>{if(e!==this.pdfDocument)return;this._firstPageCapability.resolve(g),this._optionalContentConfigPromise=i;const{annotationEditorMode:h,annotationMode:m,textLayerMode:b}=I(this,zg,AS).call(this,p);if(b!==qa.DISABLE){const x=R(this,zs,document.createElement("div"));x.id="hiddenCopyElement",r.before(x)}if((typeof PDFJSDev<"u"&&PDFJSDev.test("MOZCENTRAL")||typeof AbortSignal.any=="function")&&h!==G.AnnotationEditorType.DISABLE){const x=h;e.isPureXfa?console.warn("Warning: XFA-editing is not implemented."):SE(x)?(R(this,oa,new G.AnnotationEditorUIManager(this.container,r,v(this,Su),o,e,l,v(this,Lu),v(this,Cu),v(this,Iu),v(this,Du),v(this,cl))),o.dispatch("annotationeditoruimanager",{source:this,uiManager:v(this,oa)}),x!==G.AnnotationEditorType.NONE&&(x===G.AnnotationEditorType.STAMP&&v(this,cl)?.loadModel("altText"),v(this,oa).updateMode(x))):console.error(`Invalid AnnotationEditor mode: ${x}`)}const y=this._scrollMode===Te.PAGE?null:r,w=this.currentScale,_=g.getViewport({scale:w*G.PixelsPerInch.PDF_TO_CSS_UNITS});r.style.setProperty("--scale-factor",_.scale),l?.background&&r.style.setProperty("--page-bg-color",l.background),(l?.foreground==="CanvasText"||l?.background==="Canvas")&&(r.style.setProperty("--hcm-highlight-filter",e.filterFactory.addHighlightHCMFilter("highlight","CanvasText","Canvas","HighlightText","Highlight")),r.style.setProperty("--hcm-highlight-selected-filter",e.filterFactory.addHighlightHCMFilter("highlight_selected","CanvasText","Canvas","HighlightText","ButtonText")));for(let x=1;x<=n;++x){const S=new vC({container:y,eventBus:o,id:x,scale:w,defaultViewport:_.clone(),optionalContentConfigPromise:i,renderingQueue:this.renderingQueue,textLayerMode:b,annotationMode:m,imageResourcesPath:this.imageResourcesPath,maxCanvasPixels:this.maxCanvasPixels,pageColors:l,l10n:this.l10n,layerProperties:this._layerProperties,enableHWA:v(this,Au)});this._pages.push(S)}this._pages[0]?.setPdfPage(g),this._scrollMode===Te.PAGE?I(this,pl,Ju).call(this):this._spreadMode!==_t.NONE&&this._updateSpreadMode(),I(this,Vg,CS).call(this,d).then(async()=>{if(e!==this.pdfDocument)return;if(this.findController?.setDocument(e),this._scriptingManager?.setDocument(e),v(this,zs)&&document.addEventListener("copy",I(this,Gg,TS).bind(this,b),{signal:d}),v(this,oa)&&o.dispatch("annotationeditormodechanged",{source:this,mode:v(this,mi)}),e.loadingParams.disableAutoFetch||n>Pc.FORCE_LAZY_PAGE_INIT){this._pagesCapability.resolve();return}let x=n-1;if(x<=0){this._pagesCapability.resolve();return}for(let S=2;S<=n;++S){const k=e.getPage(S).then(A=>{const $=this._pages[S-1];$.pdfPage||$.setPdfPage(A),--x===0&&this._pagesCapability.resolve()},A=>{console.error(`Unable to get page ${S} to initialize viewer`,A),--x===0&&this._pagesCapability.resolve()});S%Pc.PAUSE_EAGER_PAGE_INIT===0&&await k}}),o.dispatch("pagesinit",{source:this}),e.getMetadata().then(({info:x})=>{e===this.pdfDocument&&x.Language&&(r.lang=x.Language)}),this.defaultRenderingQueue&&this.update()}).catch(g=>{console.error("Unable to initialize viewer",g),this._pagesCapability.reject(g)})}setPageLabels(e){if(this.pdfDocument){e?Array.isArray(e)&&this.pdfDocument.numPages===e.length?this._pageLabels=e:(this._pageLabels=null,console.error("setPageLabels: Invalid page labels.")):this._pageLabels=null;for(let n=0,a=this._pages.length;n<a;n++)this._pages[n].setPageLabel(this._pageLabels?.[n]??null)}}_resetView(){this._pages=[],this._currentPageNumber=1,this._currentScale=Rm,this._currentScaleValue=null,this._pageLabels=null,R(this,Ws,new EC(kE)),this._location=null,this._pagesRotation=0,this._optionalContentConfigPromise=null,this._firstPageCapability=Promise.withResolvers(),this._onePageRenderedCapability=Promise.withResolvers(),this._pagesCapability=Promise.withResolvers(),this._scrollMode=Te.VERTICAL,this._previousScrollMode=Te.UNKNOWN,this._spreadMode=_t.NONE,R(this,fl,{previousPageNumber:1,scrollDown:!0,pages:[]}),v(this,Ys)?.abort(),R(this,Ys,null),this.viewer.textContent="",this._updateScrollMode(),this.viewer.removeAttribute("lang"),v(this,zs)?.remove(),R(this,zs,null),I(this,Rr,yh).call(this)}_scrollUpdate(){this.pagesCount!==0&&this.update()}pageLabelToPageNumber(e){if(!this._pageLabels)return null;const n=this._pageLabels.indexOf(e);return n<0?null:n+1}scrollPageIntoView({pageNumber:e,destArray:n=null,allowNegativeOffset:a=!1,ignoreDestinationZoom:i=!1}){if(!this.pdfDocument)return;const s=Number.isInteger(e)&&this._pages[e-1];if(!s){console.error(`scrollPageIntoView: "${e}" is not a valid pageNumber parameter.`);return}if(this.isInPresentationMode||!n){this._setCurrentPageNumber(e,!0);return}let o=0,l=0,r=0,d=0,c,f;const g=s.rotation%180!==0,p=(g?s.height:s.width)/s.scale/G.PixelsPerInch.PDF_TO_CSS_UNITS,h=(g?s.width:s.height)/s.scale/G.PixelsPerInch.PDF_TO_CSS_UNITS;let m=0;switch(n[1].name){case"XYZ":o=n[2],l=n[3],m=n[4],o=o!==null?o:0,l=l!==null?l:h;break;case"Fit":case"FitB":m="page-fit";break;case"FitH":case"FitBH":l=n[2],m="page-width",l===null&&this._location?(o=this._location.left,l=this._location.top):(typeof l!="number"||l<0)&&(l=h);break;case"FitV":case"FitBV":o=n[2],r=p,d=h,m="page-height";break;case"FitR":o=n[2],l=n[3],r=n[4]-o,d=n[5]-l;let _=Mv,x=Pv;(typeof PDFJSDev>"u"||PDFJSDev.test("GENERIC"))&&this.removePageBorders&&(_=x=0),c=(this.container.clientWidth-_)/r/G.PixelsPerInch.PDF_TO_CSS_UNITS,f=(this.container.clientHeight-x)/d/G.PixelsPerInch.PDF_TO_CSS_UNITS,m=Math.min(Math.abs(c),Math.abs(f));break;default:console.error(`scrollPageIntoView: "${n[1].name}" is not a valid destination type.`);return}if(i||(m&&m!==this._currentScale?this.currentScaleValue=m:this._currentScale===Rm&&(this.currentScaleValue=Cc)),m==="page-fit"&&!n[4]){I(this,Hr,bh).call(this,s);return}const b=[s.viewport.convertToViewportPoint(o,l),s.viewport.convertToViewportPoint(o+r,l+d)];let y=Math.min(b[0][0],b[1][0]),w=Math.min(b[0][1],b[1][1]);a||(y=Math.max(y,0),w=Math.max(w,0)),I(this,Hr,bh).call(this,s,{left:y,top:w})}_updateLocation(e){const n=this._currentScale,a=this._currentScaleValue,i=parseFloat(a)===n?Math.round(n*1e4)/100:a,s=e.id,o=this._pages[s-1],l=this.container,r=o.getPagePoint(l.scrollLeft-e.x,l.scrollTop-e.y),d=Math.round(r[0]),c=Math.round(r[1]);let f=`#page=${s}`;this.isInPresentationMode||(f+=`&zoom=${i},${d},${c}`),this._location={pageNumber:s,scale:i,top:c,left:d,rotation:this._pagesRotation,pdfOpenParams:f}}update(){const e=this._getVisiblePages(),n=e.views,a=n.length;if(a===0)return;const i=Math.max(kE,2*a+1);v(this,Ws).resize(i,e.ids),this.renderingQueue.renderHighestPriority(e);const s=this._spreadMode===_t.NONE&&(this._scrollMode===Te.PAGE||this._scrollMode===Te.VERTICAL),o=this._currentPageNumber;let l=!1;for(const r of n){if(r.percent<100)break;if(r.id===o&&s){l=!0;break}}this._setCurrentPageNumber(l?o:n[0].id),this._updateLocation(e.first),this.eventBus.dispatch("updateviewarea",{source:this,location:this._location})}containsElement(e){return this.container.contains(e)}focus(){this.container.focus(),this.container.parentElement.querySelector("#sidebarToggleButton").focus()}get _isContainerRtl(){return getComputedStyle(this.container).direction==="rtl"}get isInPresentationMode(){return this.presentationModeState===on.FULLSCREEN}get isChangingPresentationMode(){return this.presentationModeState===on.CHANGING}get isHorizontalScrollbarEnabled(){return this.isInPresentationMode?!1:this.container.scrollWidth>this.container.clientWidth}get isVerticalScrollbarEnabled(){return this.isInPresentationMode?!1:this.container.scrollHeight>this.container.clientHeight}_getVisiblePages(){const e=this._scrollMode===Te.PAGE?v(this,fl).pages:this._pages,n=this._scrollMode===Te.HORIZONTAL,a=n&&this._isContainerRtl;return Ov({scrollEl:this.container,views:e,sortByVisibility:!0,horizontal:n,rtl:a})}cleanup(){for(const e of this._pages)e.renderingState!==We.FINISHED&&e.reset()}_cancelRendering(){for(const e of this._pages)e.cancelRendering()}forceRendering(e){const n=e||this._getVisiblePages(),a=I(this,Xg,PS).call(this,n),i=this._spreadMode!==_t.NONE&&this._scrollMode!==Te.HORIZONTAL,s=this.renderingQueue.getHighestPriority(n,this._pages,a,i);return s?(I(this,Jg,MS).call(this,s).then(()=>{this.renderingQueue.renderView(s)}),!0):!1}get hasEqualPageSizes(){const e=this._pages[0];for(let n=1,a=this._pages.length;n<a;++n){const i=this._pages[n];if(i.width!==e.width||i.height!==e.height)return!1}return!0}getPagesOverview(){let e;return this._pages.map(n=>{const a=n.pdfPage.getViewport({scale:1}),i=Bm(a);if(e===void 0)e=i;else if(this.enablePrintAutoRotate&&i!==e)return{width:a.height,height:a.width,rotation:(a.rotation-90)%360};return{width:a.width,height:a.height,rotation:a.rotation}})}get optionalContentConfigPromise(){return this.pdfDocument?this._optionalContentConfigPromise?this._optionalContentConfigPromise:(console.error("optionalContentConfigPromise: Not initialized yet."),this.pdfDocument.getOptionalContentConfig({intent:"display"})):Promise.resolve(null)}set optionalContentConfigPromise(e){if(!(e instanceof Promise))throw new Error(`Invalid optionalContentConfigPromise: ${e}`);this.pdfDocument&&this._optionalContentConfigPromise&&(this._optionalContentConfigPromise=e,this.refresh(!1,{optionalContentConfigPromise:e}),this.eventBus.dispatch("optionalcontentconfigchanged",{source:this,promise:e}))}get scrollMode(){return this._scrollMode}set scrollMode(e){if(!(typeof PDFJSDev>"u"?window.isGECKOVIEW:PDFJSDev.test("GECKOVIEW"))&&this._scrollMode!==e){if(!qv(e))throw new Error(`Invalid scroll mode: ${e}`);this.pagesCount>Pc.FORCE_SCROLL_MODE_PAGE||(this._previousScrollMode=this._scrollMode,this._scrollMode=e,this.eventBus.dispatch("scrollmodechanged",{source:this,mode:e}),this._updateScrollMode(this._currentPageNumber))}}_updateScrollMode(e=null){const n=this._scrollMode,a=this.viewer;a.classList.toggle("scrollHorizontal",n===Te.HORIZONTAL),a.classList.toggle("scrollWrapped",n===Te.WRAPPED),!(!this.pdfDocument||!e)&&(n===Te.PAGE?I(this,pl,Ju).call(this):this._previousScrollMode===Te.PAGE&&this._updateSpreadMode(),this._currentScaleValue&&isNaN(this._currentScaleValue)&&I(this,bi,js).call(this,this._currentScaleValue,{noScroll:!0}),this._setCurrentPageNumber(e,!0),this.update())}get spreadMode(){return this._spreadMode}set spreadMode(e){if(!(typeof PDFJSDev>"u"?window.isGECKOVIEW:PDFJSDev.test("GECKOVIEW"))&&this._spreadMode!==e){if(!Fv(e))throw new Error(`Invalid spread mode: ${e}`);this._spreadMode=e,this.eventBus.dispatch("spreadmodechanged",{source:this,mode:e}),this._updateSpreadMode(this._currentPageNumber)}}_updateSpreadMode(e=null){if(!this.pdfDocument)return;const n=this.viewer,a=this._pages;if(this._scrollMode===Te.PAGE)I(this,pl,Ju).call(this);else if(n.textContent="",this._spreadMode===_t.NONE)for(const i of this._pages)n.append(i.div);else{const i=this._spreadMode-1;let s=null;for(let o=0,l=a.length;o<l;++o)s===null?(s=document.createElement("div"),s.className="spread",n.append(s)):o%2===i&&(s=s.cloneNode(!1),n.append(s)),s.append(a[o].div)}e&&(this._currentScaleValue&&isNaN(this._currentScaleValue)&&I(this,bi,js).call(this,this._currentScaleValue,{noScroll:!0}),this._setCurrentPageNumber(e,!0),this.update())}_getPageAdvance(e,n=!1){switch(this._scrollMode){case Te.WRAPPED:{const{views:a}=this._getVisiblePages(),i=new Map;for(const{id:s,y:o,percent:l,widthPercent:r}of a){if(l===0||r<100)continue;let d=i.get(o);d||i.set(o,d||=[]),d.push(s)}for(const s of i.values()){const o=s.indexOf(e);if(o===-1)continue;const l=s.length;if(l===1)break;if(n)for(let r=o-1,d=0;r>=d;r--){const c=s[r],f=s[r+1]-1;if(c<f)return e-f}else for(let r=o+1,d=l;r<d;r++){const c=s[r],f=s[r-1]+1;if(c>f)return f-e}if(n){const r=s[0];if(r<e)return e-r+1}else{const r=s[l-1];if(r>e)return r-e+1}break}break}case Te.HORIZONTAL:break;case Te.PAGE:case Te.VERTICAL:{if(this._spreadMode===_t.NONE)break;const a=this._spreadMode-1;if(n&&e%2!==a)break;if(!n&&e%2===a)break;const{views:i}=this._getVisiblePages(),s=n?e-1:e+1;for(const{id:o,percent:l,widthPercent:r}of i)if(o===s){if(l>0&&r===100)return 2;break}break}}return 1}nextPage(){const e=this._currentPageNumber,n=this.pagesCount;if(e>=n)return!1;const a=this._getPageAdvance(e,!1)||1;return this.currentPageNumber=Math.min(e+a,n),!0}previousPage(){const e=this._currentPageNumber;if(e<=1)return!1;const n=this._getPageAdvance(e,!0)||1;return this.currentPageNumber=Math.max(e-n,1),!0}updateScale({drawingDelay:e,scaleFactor:n=null,steps:a=null,origin:i}){if(a===null&&n===null)throw new Error("Invalid updateScale options: either `steps` or `scaleFactor` must be provided.");if(!this.pdfDocument)return;let s=this._currentScale;if(n>0&&n!==1)s=Math.round(s*n*100)/100;else if(a){const o=a>0?Iv:1/Iv,l=a>0?Math.ceil:Math.floor;a=Math.abs(a);do s=l((s*o).toFixed(2)*10)/10;while(--a>0)}s=Math.max(Dv,Math.min($v,s)),I(this,bi,js).call(this,s,{noScroll:!1,drawingDelay:e,origin:i})}increaseScale(e={}){this.updateScale({...e,steps:e.steps??1})}decreaseScale(e={}){this.updateScale({...e,steps:-(e.steps??1)})}get containerTopLeft(){return v(this,xu)||R(this,xu,[this.container.offsetTop,this.container.offsetLeft])}get annotationEditorMode(){return v(this,oa)?v(this,mi):G.AnnotationEditorType.DISABLE}set annotationEditorMode({mode:e,editId:n=null,isFromKeyboard:a=!1}){if(!v(this,oa))throw new Error("The AnnotationEditor is not enabled.");if(v(this,mi)===e)return;if(!SE(e))throw new Error(`Invalid AnnotationEditor mode: ${e}`);if(!this.pdfDocument)return;e===G.AnnotationEditorType.STAMP&&v(this,cl)?.loadModel("altText");const{eventBus:i}=this,s=()=>{I(this,Rr,yh).call(this),R(this,mi,e),v(this,oa).updateMode(e,n,a),i.dispatch("annotationeditormodechanged",{source:this,mode:e})};if(e===G.AnnotationEditorType.NONE||v(this,mi)===G.AnnotationEditorType.NONE){const o=e!==G.AnnotationEditorType.NONE;o||this.pdfDocument.annotationStorage.resetModifiedIds();for(const r of this._pages)r.toggleEditingMode(o);const l=I(this,Zg,$S).call(this);if(o&&l){I(this,Rr,yh).call(this),R(this,dl,new AbortController);const r=AbortSignal.any([v(this,Ys).signal,v(this,dl).signal]);i._on("pagerendered",({pageNumber:d})=>{l.delete(d),l.size===0&&R(this,ul,setTimeout(s,0))},{signal:r});return}}s()}refresh(e=!1,n=Object.create(null)){if(this.pdfDocument){for(const a of this._pages)a.update(n);v(this,Vs)!==null&&(clearTimeout(v(this,Vs)),R(this,Vs,null)),e||this.update()}}}Ws=new WeakMap,Su=new WeakMap,Lu=new WeakMap,mi=new WeakMap,oa=new WeakMap,rl=new WeakMap,xu=new WeakMap,Au=new WeakMap,Cu=new WeakMap,Tu=new WeakMap,Iu=new WeakMap,Du=new WeakMap,Ys=new WeakMap,cl=new WeakMap,dl=new WeakMap,ul=new WeakMap,$r=new WeakMap,zs=new WeakMap,Mr=new WeakMap,$u=new WeakMap,Pr=new WeakMap,fl=new WeakMap,Vs=new WeakMap,Nr=new WeakMap,zg=new WeakSet,AS=function(e){const n={annotationEditorMode:v(this,mi),annotationMode:v(this,rl),textLayerMode:v(this,Nr)};return e&&(!e.includes(G.PermissionFlag.COPY)&&v(this,Nr)===qa.ENABLE&&(n.textLayerMode=qa.ENABLE_PERMISSIONS),e.includes(G.PermissionFlag.MODIFY_CONTENTS)||(n.annotationEditorMode=G.AnnotationEditorType.DISABLE),!e.includes(G.PermissionFlag.MODIFY_ANNOTATIONS)&&!e.includes(G.PermissionFlag.FILL_INTERACTIVE_FORMS)&&v(this,rl)===G.AnnotationMode.ENABLE_FORMS&&(n.annotationMode=G.AnnotationMode.ENABLE)),n},Vg=new WeakSet,CS=async function(e){if(document.visibilityState==="hidden"||!this.container.offsetParent||this._getVisiblePages().views.length===0)return;const n=Promise.withResolvers(),a=new AbortController;document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&n.resolve()},{signal:typeof PDFJSDev<"u"&&PDFJSDev.test("MOZCENTRAL")||typeof AbortSignal.any=="function"?AbortSignal.any([e,a.signal]):e}),await Promise.race([this._onePageRenderedCapability.promise,n.promise]),a.abort()},Gg=new WeakSet,TS=function(e,n){const a=document.getSelection(),{focusNode:i,anchorNode:s}=a;if(s&&i&&a.containsNode(v(this,zs))){if(v(this,$r)||e===qa.ENABLE_PERMISSIONS){n.preventDefault(),n.stopPropagation();return}R(this,$r,!0);const{classList:o}=this.viewer;o.add("copyAll");const l=new AbortController;window.addEventListener("keydown",r=>R(this,Mr,r.key==="Escape"),{signal:l.signal}),this.getAllText().then(async r=>{r!==null&&await navigator.clipboard.writeText(r)}).catch(r=>{console.warn(`Something goes wrong when extracting the text: ${r.message}`)}).finally(()=>{R(this,$r,!1),R(this,Mr,!1),l.abort(),o.remove("copyAll")}),n.preventDefault(),n.stopPropagation()}},pl=new WeakSet,Ju=function(){if(this._scrollMode!==Te.PAGE)throw new Error("#ensurePageViewVisible: Invalid scrollMode value.");const e=this._currentPageNumber,n=v(this,fl),a=this.viewer;if(a.textContent="",n.pages.length=0,this._spreadMode===_t.NONE&&!this.isInPresentationMode){const i=this._pages[e-1];a.append(i.div),n.pages.push(i)}else{const i=new Set,s=this._spreadMode-1;s===-1?i.add(e-1):e%2!==s?(i.add(e-1),i.add(e)):(i.add(e-2),i.add(e-1));const o=document.createElement("div");if(o.className="spread",this.isInPresentationMode){const l=document.createElement("div");l.className="dummyPage",o.append(l)}for(const l of i){const r=this._pages[l];r&&(o.append(r.div),n.pages.push(r))}a.append(o)}n.scrollDown=e>=n.previousPageNumber,n.previousPageNumber=e},Hr=new WeakSet,bh=function(e,n=null){const{div:a,id:i}=e;if(this._currentPageNumber!==i&&this._setCurrentPageNumber(i),this._scrollMode===Te.PAGE&&(I(this,pl,Ju).call(this),this.update()),!n&&!this.isInPresentationMode){const s=a.offsetLeft+a.clientLeft,o=s+a.clientWidth,{scrollLeft:l,clientWidth:r}=this.container;(this._scrollMode===Te.HORIZONTAL||s<l||o>l+r)&&(n={left:0,top:0})}Om(a,n),!this._currentScaleValue&&this._location&&(this._location=null)},jg=new WeakSet,IS=function(e){return e===this._currentScale||Math.abs(e-this._currentScale)<1e-15},Mu=new WeakSet,Hy=function(e,n,{noScroll:a=!1,preset:i=!1,drawingDelay:s=-1,origin:o=null}){if(this._currentScaleValue=n.toString(),I(this,jg,IS).call(this,e)){i&&this.eventBus.dispatch("scalechanging",{source:this,scale:e,presetValue:n});return}this.viewer.style.setProperty("--scale-factor",e*G.PixelsPerInch.PDF_TO_CSS_UNITS);const l=s>=0&&s<1e3;this.refresh(!0,{scale:e,drawingDelay:l?s:-1}),l&&R(this,Vs,setTimeout(()=>{R(this,Vs,null),this.refresh()},s));const r=this._currentScale;if(this._currentScale=e,!a){let d=this._currentPageNumber,c;if(this._location&&!(this.isInPresentationMode||this.isChangingPresentationMode)&&(d=this._location.pageNumber,c=[null,{name:"XYZ"},this._location.left,this._location.top,null]),this.scrollPageIntoView({pageNumber:d,destArray:c,allowNegativeOffset:!0}),Array.isArray(o)){const f=e/r-1,[g,p]=this.containerTopLeft;this.container.scrollLeft+=(o[0]-p)*f,this.container.scrollTop+=(o[1]-g)*f}}this.eventBus.dispatch("scalechanging",{source:this,scale:e,presetValue:i?n:void 0}),this.defaultRenderingQueue&&this.update()},Kg=new WeakSet,DS=function(){return this._spreadMode!==_t.NONE&&this._scrollMode!==Te.HORIZONTAL?2:1},bi=new WeakSet,js=function(e,n){let a=parseFloat(e);if(a>0)n.preset=!1,I(this,Mu,Hy).call(this,a,e,n);else{const i=this._pages[this._currentPageNumber-1];if(!i)return;let s=Mv,o=Pv;this.isInPresentationMode?(s=o=4,this._spreadMode!==_t.NONE&&(s*=2)):(typeof PDFJSDev>"u"||PDFJSDev.test("GENERIC"))&&this.removePageBorders?s=o=0:this._scrollMode===Te.HORIZONTAL&&([s,o]=[o,s]);const l=(this.container.clientWidth-s)/i.width*i.scale/v(this,Kg,DS),r=(this.container.clientHeight-o)/i.height*i.scale;switch(e){case"page-actual":a=1;break;case"page-width":a=l;break;case"page-height":a=r;break;case"page-fit":a=Math.min(l,r);break;case"auto":const d=Bm(i)?l:Math.min(r,l);a=Math.min(Ux,d);break;default:console.error(`#setScale: "${e}" is an unknown zoom value.`);return}n.preset=!0,I(this,Mu,Hy).call(this,a,e,n)}},Pu=new WeakSet,Ry=function(){const e=this._pages[this._currentPageNumber-1];this.isInPresentationMode&&I(this,bi,js).call(this,this._currentScaleValue,{noScroll:!0}),I(this,Hr,bh).call(this,e)},Zg=new WeakSet,$S=function(){const e=this._getVisiblePages(),n=[],{ids:a,views:i}=e;for(const s of i){const{view:o}=s;if(!o.hasEditableAnnotations()){a.delete(o.id);continue}n.push(s)}return n.length===0?null:(this.renderingQueue.renderHighestPriority({first:n[0],last:n.at(-1),views:n,ids:a}),a)},Jg=new WeakSet,MS=async function(e){if(e.pdfPage)return e.pdfPage;try{const n=await this.pdfDocument.getPage(e.id);return e.pdfPage||e.setPdfPage(n),n}catch(n){return console.error("Unable to get page for page view",n),null}},Xg=new WeakSet,PS=function(e){if(e.first?.id===1)return!0;if(e.last?.id===this.pagesCount)return!1;switch(this._scrollMode){case Te.PAGE:return v(this,fl).scrollDown;case Te.HORIZONTAL:return this.scroll.right}return this.scroll.down},Nu=new WeakSet,Oy=function(e=this.container.clientHeight){e!==v(this,$u)&&(R(this,$u,e),Uv.setProperty("--viewer-container-height",`${e}px`))},Qg=new WeakSet,NS=function(e){for(const n of e)if(n.target===this.container){I(this,Nu,Oy).call(this,Math.floor(n.borderBoxSize[0].blockSize)),R(this,xu,null);break}},Rr=new WeakSet,yh=function(){v(this,dl)?.abort(),R(this,dl,null),v(this,ul)!==null&&(clearTimeout(v(this,ul)),R(this,ul,null))};class SC{constructor(e,n){D(this,Or);D(this,eh);D(this,th);D(this,Hu);D(this,Ru);D(this,Ga,void 0);R(this,Ga,e);const a=[{element:e.presentationModeButton,eventName:"presentationmode",close:!0},{element:e.printButton,eventName:"print",close:!0},{element:e.downloadButton,eventName:"download",close:!0},{element:e.viewBookmarkButton,eventName:null,close:!0},{element:e.firstPageButton,eventName:"firstpage",close:!0},{element:e.lastPageButton,eventName:"lastpage",close:!0},{element:e.pageRotateCwButton,eventName:"rotatecw",close:!1},{element:e.pageRotateCcwButton,eventName:"rotateccw",close:!1},{element:e.cursorSelectToolButton,eventName:"switchcursortool",eventDetails:{tool:$n.SELECT},close:!0},{element:e.cursorHandToolButton,eventName:"switchcursortool",eventDetails:{tool:$n.HAND},close:!0},{element:e.scrollPageButton,eventName:"switchscrollmode",eventDetails:{mode:Te.PAGE},close:!0},{element:e.scrollVerticalButton,eventName:"switchscrollmode",eventDetails:{mode:Te.VERTICAL},close:!0},{element:e.scrollHorizontalButton,eventName:"switchscrollmode",eventDetails:{mode:Te.HORIZONTAL},close:!0},{element:e.scrollWrappedButton,eventName:"switchscrollmode",eventDetails:{mode:Te.WRAPPED},close:!0},{element:e.spreadNoneButton,eventName:"switchspreadmode",eventDetails:{mode:_t.NONE},close:!0},{element:e.spreadOddButton,eventName:"switchspreadmode",eventDetails:{mode:_t.ODD},close:!0},{element:e.spreadEvenButton,eventName:"switchspreadmode",eventDetails:{mode:_t.EVEN},close:!0},{element:e.imageAltTextSettingsButton,eventName:"imagealttextsettings",close:!0},{element:e.documentPropertiesButton,eventName:"documentproperties",close:!0}];(typeof PDFJSDev>"u"||PDFJSDev.test("GENERIC"))&&a.push({element:e.openFileButton,eventName:"openfile",close:!0}),this.eventBus=n,this.opened=!1,I(this,eh,HS).call(this,a),this.reset()}get isOpen(){return this.opened}setPageNumber(e){this.pageNumber=e,I(this,Or,wh).call(this)}setPagesCount(e){this.pagesCount=e,I(this,Or,wh).call(this)}reset(){this.pageNumber=0,this.pagesCount=0,I(this,Or,wh).call(this),this.eventBus.dispatch("switchcursortool",{source:this,reset:!0}),I(this,Hu,By).call(this,{mode:Te.VERTICAL}),I(this,Ru,qy).call(this,{mode:_t.NONE})}open(){if(this.opened)return;this.opened=!0;const{toggleButton:e,toolbar:n}=v(this,Ga);oi(e,!0,n)}close(){if(!this.opened)return;this.opened=!1;const{toggleButton:e,toolbar:n}=v(this,Ga);oi(e,!1,n)}toggle(){this.opened?this.close():this.open()}}Ga=new WeakMap,Or=new WeakSet,wh=function(){const{firstPageButton:e,lastPageButton:n,pageRotateCwButton:a,pageRotateCcwButton:i}=v(this,Ga);e.disabled=this.pageNumber<=1,n.disabled=this.pageNumber>=this.pagesCount,a.disabled=this.pagesCount===0,i.disabled=this.pagesCount===0},eh=new WeakSet,HS=function(e){const{eventBus:n}=this,{toggleButton:a}=v(this,Ga);a.addEventListener("click",this.toggle.bind(this));for(const{element:i,eventName:s,close:o,eventDetails:l}of e)i.addEventListener("click",r=>{s!==null&&n.dispatch(s,{source:this,...l}),o&&this.close(),n.dispatch("reporttelemetry",{source:this,details:{type:"buttons",data:{id:i.id}}})});n._on("cursortoolchanged",I(this,th,RS).bind(this)),n._on("scrollmodechanged",I(this,Hu,By).bind(this)),n._on("spreadmodechanged",I(this,Ru,qy).bind(this))},th=new WeakSet,RS=function({tool:e,disabled:n}){const{cursorSelectToolButton:a,cursorHandToolButton:i}=v(this,Ga);Jn(a,e===$n.SELECT),Jn(i,e===$n.HAND),a.disabled=n,i.disabled=n},Hu=new WeakSet,By=function({mode:e}){const{scrollPageButton:n,scrollVerticalButton:a,scrollHorizontalButton:i,scrollWrappedButton:s,spreadNoneButton:o,spreadOddButton:l,spreadEvenButton:r}=v(this,Ga);Jn(n,e===Te.PAGE),Jn(a,e===Te.VERTICAL),Jn(i,e===Te.HORIZONTAL),Jn(s,e===Te.WRAPPED);const d=this.pagesCount>Pc.FORCE_SCROLL_MODE_PAGE;n.disabled=d,a.disabled=d,i.disabled=d,s.disabled=d;const c=e===Te.HORIZONTAL;o.disabled=c,l.disabled=c,r.disabled=c},Ru=new WeakSet,qy=function({mode:e}){const{spreadNoneButton:n,spreadOddButton:a,spreadEvenButton:i}=v(this,Ga);Jn(n,e===_t.NONE),Jn(a,e===_t.ODD),Jn(i,e===_t.EVEN)};class LE{constructor(e,n,a=0){D(this,Ou);D(this,nh);D(this,ah);D(this,Bu);D(this,gl);D(this,Gs,void 0);R(this,Gs,e),this.eventBus=n;const i=[{element:e.previous,eventName:"previouspage"},{element:e.next,eventName:"nextpage"},{element:e.zoomIn,eventName:"zoomin"},{element:e.zoomOut,eventName:"zoomout"},{element:e.print,eventName:"print"},{element:e.download,eventName:"download"},{element:e.editorFreeTextButton,eventName:"switchannotationeditormode",eventDetails:{get mode(){const{classList:s}=e.editorFreeTextButton;return s.contains("toggled")?G.AnnotationEditorType.NONE:G.AnnotationEditorType.FREETEXT}}},{element:e.editorHighlightButton,eventName:"switchannotationeditormode",eventDetails:{get mode(){const{classList:s}=e.editorHighlightButton;return s.contains("toggled")?G.AnnotationEditorType.NONE:G.AnnotationEditorType.HIGHLIGHT}}},{element:e.editorInkButton,eventName:"switchannotationeditormode",eventDetails:{get mode(){const{classList:s}=e.editorInkButton;return s.contains("toggled")?G.AnnotationEditorType.NONE:G.AnnotationEditorType.INK}}},{element:e.editorStampButton,eventName:"switchannotationeditormode",eventDetails:{get mode(){const{classList:s}=e.editorStampButton;return s.contains("toggled")?G.AnnotationEditorType.NONE:G.AnnotationEditorType.STAMP}},telemetry:{type:"editing",data:{action:"pdfjs.image.icon_click"}}}];I(this,ah,BS).call(this,i),I(this,Ou,Fy).call(this,{value:a}),this.reset()}setPageNumber(e,n){this.pageNumber=e,this.pageLabel=n,I(this,gl,Xu).call(this,!1)}setPagesCount(e,n){this.pagesCount=e,this.hasPageLabels=n,I(this,gl,Xu).call(this,!0)}setPageScale(e,n){this.pageScaleValue=(e||n).toString(),this.pageScale=n,I(this,gl,Xu).call(this,!1)}reset(){this.pageNumber=0,this.pageLabel=null,this.hasPageLabels=!1,this.pagesCount=0,this.pageScaleValue=Cc,this.pageScale=Hm,I(this,gl,Xu).call(this,!0),this.updateLoadingIndicatorState(),I(this,Bu,Uy).call(this,{mode:G.AnnotationEditorType.DISABLE})}updateLoadingIndicatorState(e=!1){const{pageNumber:n}=v(this,Gs);n.classList.toggle("loading",e)}}Gs=new WeakMap,Ou=new WeakSet,Fy=function({value:e}){let n="normal";switch(e){case 1:n="compact";break;case 2:n="touch";break}document.documentElement.setAttribute("data-toolbar-density",n)},nh=new WeakSet,OS=function(e,n){const a=new G.ColorPicker({uiManager:e});e.setMainHighlightColorPicker(a),n.append(a.renderMainDropdown())},ah=new WeakSet,BS=function(e){const{eventBus:n}=this,{editorHighlightColorPicker:a,editorHighlightButton:i,pageNumber:s,scaleSelect:o}=v(this,Gs),l=this;for(const{element:r,eventName:d,eventDetails:c,telemetry:f}of e)r.addEventListener("click",g=>{d!==null&&n.dispatch(d,{source:this,...c,isFromKeyboard:g.detail===0}),f&&n.dispatch("reporttelemetry",{source:this,details:f})});s.addEventListener("click",function(){this.select()}),s.addEventListener("change",function(){n.dispatch("pagenumberchanged",{source:l,value:this.value})}),o.addEventListener("change",function(){this.value!=="custom"&&n.dispatch("scalechanged",{source:l,value:this.value})}),o.addEventListener("click",function({target:r}){this.value===l.pageScaleValue&&r.tagName.toUpperCase()==="OPTION"&&this.blur()}),o.oncontextmenu=G.noContextMenu,n._on("annotationeditormodechanged",I(this,Bu,Uy).bind(this)),n._on("showannotationeditorui",({mode:r})=>{switch(r){case G.AnnotationEditorType.HIGHLIGHT:i.click();break}}),n._on("toolbardensity",I(this,Ou,Fy).bind(this)),a&&n._on("annotationeditoruimanager",({uiManager:r})=>{I(this,nh,OS).call(this,r,a)},{once:!0})},Bu=new WeakSet,Uy=function({mode:e}){const{editorFreeTextButton:n,editorFreeTextParamsToolbar:a,editorHighlightButton:i,editorHighlightParamsToolbar:s,editorInkButton:o,editorInkParamsToolbar:l,editorStampButton:r,editorStampParamsToolbar:d}=v(this,Gs);oi(n,e===G.AnnotationEditorType.FREETEXT,a),oi(i,e===G.AnnotationEditorType.HIGHLIGHT,s),oi(o,e===G.AnnotationEditorType.INK,l),oi(r,e===G.AnnotationEditorType.STAMP,d);const c=e===G.AnnotationEditorType.DISABLE;n.disabled=c,i.disabled=c,o.disabled=c,r.disabled=c},gl=new WeakSet,Xu=function(e=!1){const{pageNumber:n,pagesCount:a,pageScaleValue:i,pageScale:s}=this,o=v(this,Gs);e&&(this.hasPageLabels?(o.pageNumber.type="text",o.numPages.setAttribute("data-l10n-id","pdfjs-page-of-pages")):(o.pageNumber.type="number",o.numPages.textContent="/ "+a),o.pageNumber.max=a),this.hasPageLabels?(o.pageNumber.value=this.pageLabel,o.numPages.textContent=`(${n} / ${a})`):o.pageNumber.value=n,o.previous.disabled=n<=1,o.next.disabled=n>=a,o.zoomOut.disabled=s<=Dv,o.zoomIn.disabled=s>=$v;let l=!1;for(const r of o.scaleSelect.options){if(r.value!==i){r.selected=!1;continue}r.selected=!0,l=!0}l||(o.customScaleOption.selected=!0,o.customScaleOption.textContent=`${Math.round(s*1e4)/100}%`)};const LC=20;class xC{constructor(e,n=LC){this.fingerprint=e,this.cacheSize=n,this._initializedPromise=this._readFromStorage().then(a=>{const i=JSON.parse(a||"{}");let s=-1;if(!Array.isArray(i.files))i.files=[];else{for(;i.files.length>=this.cacheSize;)i.files.shift();for(let o=0,l=i.files.length;o<l;o++)if(i.files[o].fingerprint===this.fingerprint){s=o;break}}s===-1&&(s=i.files.push({fingerprint:this.fingerprint})-1),this.file=i.files[s],this.database=i})}async _writeToStorage(){const e=JSON.stringify(this.database);if(typeof PDFJSDev<"u"&&PDFJSDev.test("MOZCENTRAL")){sessionStorage.setItem("pdfjs.history",e);return}window.siyuan.storage["pdfjs.history"]=e,ue("pdfjs.history",e)}async _readFromStorage(){return typeof PDFJSDev<"u"&&PDFJSDev.test("MOZCENTRAL")?sessionStorage.getItem("pdfjs.history"):window.siyuan.storage["pdfjs.history"]}async set(e,n){return await this._initializedPromise,this.file[e]=n,this._writeToStorage()}async setMultiple(e){await this._initializedPromise;for(const n in e)this.file[n]=e[n];return this._writeToStorage()}async get(e,n){await this._initializedPromise;const a=this.file[e];return a!==void 0?a:n}async getMultiple(e){await this._initializedPromise;const n=Object.create(null);for(const a in e){const i=this.file[a];n[a]=i!==void 0?i:e[a]}return n}}const AC=1e4,lb={UNKNOWN:-1,PREVIOUS:0,INITIAL:1};class xE{constructor(e){this.pdfId=e,this.initialBookmark=document.location.hash.substring(1),this._initializedCapability={...Promise.withResolvers(),settled:!1},this.appConfig=null,this.pdfDocument=null,this.pdfLoadingTask=null,this.printService=null,this.pdfViewer=null,this.pdfThumbnailViewer=null,this.pdfRenderingQueue=null,this.pdfPresentationMode=null,this.pdfDocumentProperties=null,this.pdfLinkService=null,this.pdfHistory=null,this.pdfSidebar=null,this.pdfOutlineViewer=null,this.pdfAttachmentViewer=null,this.pdfLayerViewer=null,this.pdfCursorTools=null,this.pdfScriptingManager=null,this.store=null,this.downloadManager=null,this.overlayManager=null,this.preferences=new nA,this.toolbar=null,this.secondaryToolbar=null,this.eventBus=null,this.l10n=null,this.annotationEditorParams=null,this.imageAltTextSettings=null,this.isInitialViewSet=!1,this.isViewerEmbedded=!0,this.url="",this.baseUrl="",this.mlManager=null,this._downloadUrl="",this._eventBusAbortController=null,this._windowAbortController=null,this._globalAbortController=new AbortController,this.documentInfo=null,this.metadata=null,this._contentDispositionFilename=null,this._contentLength=null,this._saveInProgress=!1,this._wheelUnusedTicks=0,this._wheelUnusedFactor=1,this._touchUnusedTicks=0,this._touchUnusedFactor=1,this._PDFBug=null,this._hasAnnotationEditors=!1,this._title=document.title,this._printAnnotationStoragePromise=null,this._touchInfo=null,this._isCtrlKeyDown=!1,this._caretBrowsing=null,this._isScrolling=!1}async initialize(e){this.appConfig=e;try{await this.preferences.initializedPromise}catch(n){console.error(`initialize: "${n.message}".`)}if(se.get("pdfBugEnabled")&&await this._parseHashParams(),typeof PDFJSDev>"u"||!PDFJSDev.test("MOZCENTRAL")){let n;switch(se.get("viewerCssTheme")){case 1:n="is-light";break;case 2:n="is-dark";break}n&&document.documentElement.classList.add(n),(typeof PDFJSDev>"u"||PDFJSDev.test("TESTING"))&&se.get("enableFakeMLManager")&&(this.mlManager=Vv.getFakeMLManager?.({enableGuessAltText:se.get("enableGuessAltText"),enableAltTextModelDownload:se.get("enableAltTextModelDownload")})||null)}else se.get("enableAltText")&&(this.mlManager=new Vv({enableGuessAltText:se.get("enableGuessAltText"),enableAltTextModelDownload:se.get("enableAltTextModelDownload"),altTextLearnMoreUrl:se.get("altTextLearnMoreUrl")}));this.l10n=await this.externalServices.createL10n(),document.getElementsByTagName("html")[0].dir=this.l10n.getDirection(),(typeof PDFJSDev>"u"||!PDFJSDev.test("MOZCENTRAL"))&&this.l10n.translate(e.appContainer||document.documentElement),this.isViewerEmbedded&&se.get("externalLinkTarget")===$i.NONE&&se.set("externalLinkTarget",$i.TOP),await this._initializeViewerComponents(),this.bindEvents(),this.bindWindowEvents(),this._initializedCapability.settled=!0,this._initializedCapability.resolve()}async _parseHashParams(){const e=document.location.hash.substring(1);if(!e)return;const{mainContainer:n,viewerContainer:a}=this.appConfig,i=Tc(e),s=async()=>{this._PDFBug};if(i.get("disableworker")==="true")try{G.GlobalWorkerOptions.workerSrc||=se.get("workerSrc"),typeof PDFJSDev>"u"?globalThis.pdfjsWorker=await Ze(843)(`${u.PROTYLE_CDN}/js/pdf/pdf.worker.mjs`):await __non_webpack_import__(G.PDFWorker.workerSrc)}catch(l){console.error(`_parseHashParams: "${l.message}".`)}if(i.has("textlayer"))switch(i.get("textlayer")){case"off":se.set("textLayerMode",qa.DISABLE);break;case"visible":case"shadow":case"hover":a.classList.add(`textLayer-${i.get("textlayer")}`);try{await s(),this._PDFBug.loadCSS()}catch(l){console.error(`_parseHashParams: "${l.message}".`)}break}if(i.has("pdfbug")){se.setAll({pdfBug:!0,fontExtraProperties:!0});const l=i.get("pdfbug").split(",");try{await s(),this._PDFBug.init(n,l)}catch(r){console.error(`_parseHashParams: "${r.message}".`)}}(typeof PDFJSDev>"u"||PDFJSDev.test("GENERIC"))&&i.has("locale")&&se.set("localeProperties",{lang:i.get("locale")});const o={disableAutoFetch:l=>l==="true",disableFontFace:l=>l==="true",disableHistory:l=>l==="true",disableRange:l=>l==="true",disableStream:l=>l==="true",verbosity:l=>l|0};typeof PDFJSDev<"u"&&PDFJSDev.test("TESTING")&&Object.assign(o,{enableAltText:l=>l==="true",enableFakeMLManager:l=>l==="true",enableGuessAltText:l=>l==="true",enableUpdatedAddImage:l=>l==="true",highlightEditorColors:l=>l,maxCanvasPixels:l=>parseInt(l),spreadModeOnLoad:l=>parseInt(l),supportsCaretBrowsingMode:l=>l==="true"});for(const l in o){const r=o[l],d=l.toLowerCase();i.has(d)&&se.set(l,r(i.get(d)))}}async _initializeViewerComponents(){const{appConfig:e,externalServices:n,l10n:a}=this,i=typeof PDFJSDev<"u"&&PDFJSDev.test("MOZCENTRAL")?new Qx(se.get("allowedGlobalEvents"),n,se.get("isInAutomation")):new Um;this.eventBus=se.eventBus=i,this.mlManager?.setEventBus(i,this._globalAbortController.signal),this.overlayManager=new lA;const s=new dE;s.onIdle=this._cleanup.bind(this),this.pdfRenderingQueue=s;const o=new Dc({eventBus:i,externalLinkTarget:se.get("externalLinkTarget"),externalLinkRel:se.get("externalLinkRel"),ignoreDestinationZoom:se.get("ignoreDestinationZoom")});this.pdfLinkService=o;const l=this.downloadManager=new oA,r=new RA({linkService:o,eventBus:i,updateMatchesCountOnProgress:typeof PDFJSDev>"u"?!window.isGECKOVIEW:!PDFJSDev.test("GECKOVIEW")});this.findController=r;const d=new tC({eventBus:i,externalServices:n,docProperties:this._scriptingDocProperties.bind(this)});this.pdfScriptingManager=d;const c=e.mainContainer,f=e.viewerContainer,g=se.get("annotationEditorMode"),p=se.get("forcePageColors")||window.matchMedia("(forced-colors: active)").matches?{background:se.get("pageColorsBackground"),foreground:se.get("pageColorsForeground")}:null;let h;const m=se.get("enableHWA"),b=new kC({container:c,viewer:f,eventBus:i,renderingQueue:s,linkService:o,downloadManager:l,altTextManager:h,findController:r,scriptingManager:se.get("enableScripting")&&d,l10n:a,textLayerMode:se.get("textLayerMode"),annotationMode:se.get("annotationMode"),annotationEditorMode:g,annotationEditorHighlightColors:se.get("highlightEditorColors"),enableHighlightFloatingButton:se.get("enableHighlightFloatingButton"),enableUpdatedAddImage:se.get("enableUpdatedAddImage"),enableNewAltTextWhenAddingImage:se.get("enableNewAltTextWhenAddingImage"),imageResourcesPath:se.get("imageResourcesPath"),enablePrintAutoRotate:se.get("enablePrintAutoRotate"),maxCanvasPixels:se.get("maxCanvasPixels"),enablePermissions:se.get("enablePermissions"),pageColors:p,mlManager:this.mlManager,abortSignal:this._globalAbortController.signal,enableHWA:m});if(this.pdfViewer=b,s.setViewer(b),o.setViewer(b),d.setViewer(b),e.sidebar?.thumbnailView&&(this.pdfThumbnailViewer=new lC({container:e.sidebar.thumbnailView,eventBus:i,renderingQueue:s,linkService:o,pageColors:p,abortSignal:this._globalAbortController.signal,enableHWA:m}),s.setThumbnailViewer(this.pdfThumbnailViewer)),!this.isViewerEmbedded&&!se.get("disableHistory")&&(this.pdfHistory=new FA({linkService:o,eventBus:i}),o.setHistory(this.pdfHistory)),!this.supportsIntegratedFind&&e.findBar&&(this.findBar=new BA(e.findBar,e.principalContainer,i)),e.annotationEditorParams)if((typeof PDFJSDev<"u"&&PDFJSDev.test("MOZCENTRAL")||typeof AbortSignal.any=="function")&&g!==G.AnnotationEditorType.DISABLE)this.annotationEditorParams=new sA(e.annotationEditorParams,i);else for(const y of["editorModeButtons","editorModeSeparator"])document.getElementById(y)?.classList.add("hidden");if(this.mlManager&&e.secondaryToolbar?.imageAltTextSettingsButton,e.documentProperties&&(this.pdfDocumentProperties=new hA(e.documentProperties,this.overlayManager,i,a,()=>this._docFilename)),e.secondaryToolbar?.cursorHandToolButton&&(this.pdfCursorTools=new fA({container:c,eventBus:i,cursorToolOnLoad:se.get("cursorToolOnLoad")})),e.toolbar)if(typeof PDFJSDev>"u"?window.isGECKOVIEW:PDFJSDev.test("GECKOVIEW")){const y=JSON.parse(se.get("nimbusDataStr")||"null");this.toolbar=new LE(e.toolbar,i,y)}else this.toolbar=new LE(e.toolbar,i,se.get("toolbarDensity"));e.secondaryToolbar&&(se.get("enableAltText")&&(e.secondaryToolbar.imageAltTextSettingsButton?.classList.remove("hidden"),e.secondaryToolbar.imageAltTextSettingsSeparator?.classList.remove("hidden")),this.secondaryToolbar=new SC(e.secondaryToolbar,i)),this.supportsFullscreen&&e.secondaryToolbar?.presentationModeButton&&(this.pdfPresentationMode=new KA({container:c,pdfViewer:b,eventBus:i})),e.passwordOverlay&&(this.passwordPrompt=new rA(e.passwordOverlay,this.overlayManager,this.isViewerEmbedded)),e.sidebar?.outlineView&&(this.pdfOutlineViewer=new zA({container:e.sidebar.outlineView,eventBus:i,l10n:a,linkService:o,downloadManager:l})),e.sidebar?.attachmentsView&&(this.pdfAttachmentViewer=new dA({container:e.sidebar.attachmentsView,eventBus:i,l10n:a,downloadManager:l})),e.sidebar?.layersView&&(this.pdfLayerViewer=new YA({container:e.sidebar.layersView,eventBus:i,l10n:a})),e.sidebar&&(this.pdfSidebar=new aC({elements:e.sidebar,eventBus:i,l10n:a}),this.pdfSidebar.onToggled=this.forceRendering.bind(this),this.pdfSidebar.onUpdateThumbnails=()=>{for(const y of b.getCachedPageViews())y.renderingState===We.FINISHED&&this.pdfThumbnailViewer.getThumbnail(y.id-1)?.setImage(y);this.pdfThumbnailViewer.scrollThumbnailIntoView(b.currentPageNumber)})}async run(e){await this.initialize(e);const{appConfig:n,eventBus:a}=this;let i;if(typeof PDFJSDev>"u"||PDFJSDev.test("GENERIC")){const s=document.location.search.substring(1);i=Tc(s).get("file")??se.get("defaultUrl"),CC(i)}else PDFJSDev.test("MOZCENTRAL")?i=window.location.href:PDFJSDev.test("CHROME")&&(i=se.get("defaultUrl"));if(typeof PDFJSDev>"u"||PDFJSDev.test("GENERIC")){const s=this._openFileInput=document.createElement("input");s.id="fileInput",s.hidden=!0,s.type="file",s.value=null,document.body.append(s),s.addEventListener("change",function(o){const{files:l}=o.target;!l||l.length===0||a.dispatch("fileinputchange",{source:this,fileInput:o.target})}),n.mainContainer.addEventListener("dragover",function(o){for(const l of o.dataTransfer.items)if(l.type==="application/pdf"){o.dataTransfer.dropEffect=o.dataTransfer.effectAllowed==="copy"?"copy":"move",o.preventDefault(),o.stopPropagation();return}}),n.mainContainer.addEventListener("drop",function(o){o.dataTransfer.files?.[0].type==="application/pdf"&&(o.preventDefault(),o.stopPropagation(),a.dispatch("fileinputchange",{source:this,fileInput:o.dataTransfer}))})}if(se.get("supportsDocumentFonts")||(se.set("disableFontFace",!0),this.l10n.get("pdfjs-web-fonts-disabled").then(s=>{console.warn(s)})),this.supportsPrinting||(n.toolbar?.print?.classList.add("hidden"),n.secondaryToolbar?.printButton.classList.add("hidden")),this.supportsFullscreen||n.secondaryToolbar?.presentationModeButton.classList.add("hidden"),this.supportsIntegratedFind&&n.findBar?.toggleButton?.classList.add("hidden"),typeof PDFJSDev>"u"||PDFJSDev.test("GENERIC"))i?this.open({url:i}):this._hideViewBookmark();else if(PDFJSDev.test("MOZCENTRAL || CHROME"))this.setTitleUsingUrl(i,i),this.externalServices.initPassiveLoading();else throw new Error("Not implemented: run")}get externalServices(){return(0,G.shadow)(this,"externalServices",new aA)}get initialized(){return this._initializedCapability.settled}get initializedPromise(){return this._initializedCapability.promise}updateZoom(e,n,a){this.pdfViewer.isInPresentationMode||this.pdfViewer.updateScale({drawingDelay:se.get("defaultZoomDelay"),steps:e,scaleFactor:n,origin:a})}zoomIn(){this.updateZoom(1)}zoomOut(){this.updateZoom(-1)}zoomReset(){this.pdfViewer.isInPresentationMode||(this.pdfViewer.currentScaleValue=Cc)}get pagesCount(){return this.pdfDocument?this.pdfDocument.numPages:0}get page(){return this.pdfViewer.currentPageNumber}set page(e){this.pdfViewer.currentPageNumber=e}get supportsPrinting(){return cE.supportsPrinting}get supportsFullscreen(){return(0,G.shadow)(this,"supportsFullscreen",document.fullscreenEnabled)}get supportsPinchToZoom(){return(0,G.shadow)(this,"supportsPinchToZoom",se.get("supportsPinchToZoom"))}get supportsIntegratedFind(){return(0,G.shadow)(this,"supportsIntegratedFind",se.get("supportsIntegratedFind"))}get loadingBar(){const e=this.appConfig.appContainer.querySelector("#loadingBar"),n=e?new Kx(e):null;return(0,G.shadow)(this,"loadingBar",n)}get supportsMouseWheelZoomCtrlKey(){return(0,G.shadow)(this,"supportsMouseWheelZoomCtrlKey",se.get("supportsMouseWheelZoomCtrlKey"))}get supportsMouseWheelZoomMetaKey(){return(0,G.shadow)(this,"supportsMouseWheelZoomMetaKey",se.get("supportsMouseWheelZoomMetaKey"))}get supportsCaretBrowsingMode(){return se.get("supportsCaretBrowsingMode")}moveCaret(e,n){this._caretBrowsing||=new fp(this._globalAbortController.signal,this.appConfig.mainContainer,this.appConfig.viewerContainer,this.appConfig.toolbar?.container),this._caretBrowsing.moveCaret(e,n)}setTitleUsingUrl(e="",n=null){this.url=e,this.baseUrl=e.split("#",1)[0],n&&(this._downloadUrl=n===e?this.baseUrl:n.split("#",1)[0]),(0,G.isDataScheme)(e)?this._hideViewBookmark():typeof PDFJSDev<"u"&&PDFJSDev.test("MOZCENTRAL || CHROME")&&se.set("docBaseUrl",this.baseUrl);let a=(0,G.getPdfFilenameFromUrl)(e,"");if(!a)try{a=decodeURIComponent((0,G.getFilenameFromUrl)(e))}catch{}this.setTitle(a||e)}setTitle(e=this._title){if(this._title=e,this.isViewerEmbedded)return;const n=this._hasAnnotationEditors&&!this.pdfRenderingQueue.printing;document.title=`${n?"* ":""}${e}`}get _docFilename(){return this._contentDispositionFilename||(0,G.getPdfFilenameFromUrl)(this.url)}_hideViewBookmark(){const{secondaryToolbar:e}=this.appConfig;e?.viewBookmarkButton.classList.add("fn__hidden"),e?.presentationModeButton.classList.contains("fn__hidden")&&document.getElementById("viewBookmarkSeparator")?.classList.add("fn__hidden")}async close(){if(this._unblockDocumentLoadEvent(),this._hideViewBookmark(),!this.pdfLoadingTask)return;if((typeof PDFJSDev>"u"||PDFJSDev.test("GENERIC && !TESTING"))&&this.pdfDocument?.annotationStorage.size>0&&this._annotationStorageModified)try{await this.save()}catch{}const e=[];e.push(this.pdfLoadingTask.destroy()),this.pdfLoadingTask=null,this.pdfDocument&&(this.pdfDocument=null,this.pdfThumbnailViewer?.setDocument(null),this.pdfViewer.setDocument(null),this.pdfLinkService.setDocument(null),this.pdfDocumentProperties?.setDocument(null)),this.pdfLinkService.externalLinkEnabled=!0,this.store=null,this.isInitialViewSet=!1,this.url="",this.baseUrl="",this._downloadUrl="",this.documentInfo=null,this.metadata=null,this._contentDispositionFilename=null,this._contentLength=null,this._saveInProgress=!1,this._hasAnnotationEditors=!1,e.push(this.pdfScriptingManager.destroyPromise,this.passwordPrompt.close()),this.setTitle(),this.pdfSidebar?.reset(),this.pdfOutlineViewer?.reset(),this.pdfAttachmentViewer?.reset(),this.pdfLayerViewer?.reset(),this.pdfHistory?.reset(),this.findBar?.reset(),this.toolbar?.reset(),this.secondaryToolbar?.reset(),this._PDFBug?.cleanup(),await Promise.all(e)}async open(e){this.pdfLoadingTask&&await this.close();const n=se.getAll(V.WORKER);Object.assign(G.GlobalWorkerOptions,n),typeof PDFJSDev<"u"&&PDFJSDev.test("MOZCENTRAL")?e.data&&(0,G.isPdfFile)(e.filename)&&(this._contentDispositionFilename=e.filename):e.url&&this.setTitleUsingUrl(e.originalUrl||e.url,e.url);const a=se.getAll(V.API),i=(0,G.getDocument)({...a,...e});return this.pdfLoadingTask=i,i.onPassword=(s,o)=>{this.isViewerEmbedded&&this._unblockDocumentLoadEvent(),this.pdfLinkService.externalLinkEnabled=!1,this.passwordPrompt.setUpdateCallback(s,o),this.passwordPrompt.open()},i.onProgress=({loaded:s,total:o})=>{this.progress(s/o)},i.promise.then(s=>{this.load(s)},s=>{if(i!==this.pdfLoadingTask)return;let o="loadingError";return s instanceof G.InvalidPDFException?o="invalidFileError":s instanceof G.MissingPDFException?o="missingFileError":s instanceof G.UnexpectedResponseException&&(o="unexpectedResponseError"),this._documentError(window.siyuan.languages[o],{message:s.message}).then(()=>{throw s})})}async download(){let e;try{e=await this.pdfDocument.getData()}catch{}this.downloadManager.download(e,this._downloadUrl,this._docFilename)}async save(){if(!this._saveInProgress){this._saveInProgress=!0,await this.pdfScriptingManager.dispatchWillSave();try{const e=await this.pdfDocument.saveDocument();this.downloadManager.download(e,this._downloadUrl,this._docFilename)}catch(e){console.error(`Error when saving the document: ${e.message}`),await this.download()}finally{await this.pdfScriptingManager.dispatchDidSave(),this._saveInProgress=!1}this._hasAnnotationEditors&&this.externalServices.reportTelemetry({type:"editing",data:{type:"save",stats:this.pdfDocument?.annotationStorage.editorStats}})}}async downloadOrSave(){const{classList:e}=this.appConfig.appContainer;e.add("wait"),await(this.pdfDocument?.annotationStorage.size>0?this.save():this.download()),e.remove("wait")}async _documentError(e,n=null){this._unblockDocumentLoadEvent();const a=await this._otherError(e||"pdfjs-loading-error",n);this.eventBus.dispatch("documenterror",{source:this,message:a,reason:n?.message??null})}async _otherError(e,n=null){const a=window.siyuan.languages[e]||e,i=[`PDF.js v${G.version||"?"} (build: ${G.build||"?"})`];return n&&(i.push(`Message: ${n.message}`),n.stack?i.push(`Stack: ${n.stack}`):(n.filename&&i.push(`File: ${n.filename}`),n.lineNumber&&i.push(`Line: ${n.lineNumber}`))),console.error(`${a}

${i.join(`
`)}`),a}progress(e){const n=Math.round(e*100);!this.loadingBar||n<=this.loadingBar.percent||(this.loadingBar.percent=n,(this.pdfDocument?.loadingParams.disableAutoFetch??se.get("disableAutoFetch"))&&this.loadingBar.setDisableAutoFetch())}load(e){this.pdfDocument=e,e.getDownloadInfo().then(({length:c})=>{this._contentLength=c,this.loadingBar?.hide(),o.then(()=>{this.eventBus.dispatch("documentloaded",{source:this})})});const n=e.getPageLayout().catch(()=>{}),a=e.getPageMode().catch(()=>{}),i=e.getOpenAction().catch(()=>{});if(this.toolbar?.setPagesCount(e.numPages,!1),this.secondaryToolbar?.setPagesCount(e.numPages),typeof PDFJSDev<"u"&&PDFJSDev.test("CHROME")){const c=location.href.split("#",1)[0];this.pdfLinkService.setDocument(e,(0,G.isDataScheme)(c)?null:c)}else this.pdfLinkService.setDocument(e);this.pdfDocumentProperties?.setDocument(e);const s=this.pdfViewer;s.setDocument(e);const{firstPagePromise:o,onePageRendered:l,pagesPromise:r}=s;this.pdfThumbnailViewer?.setDocument(e);const d=(this.store=new xC(e.fingerprints[0])).getMultiple({page:null,zoom:Cc,scrollLeft:"0",scrollTop:"0",rotation:null,sidebarView:Me.UNKNOWN,scrollMode:Te.UNKNOWN,spreadMode:_t.UNKNOWN}).catch(()=>{});o.then(c=>{this.loadingBar?.setWidth(this.appConfig.viewerContainer),this._initializeAnnotationStorageCallbacks(e),Promise.all([Gx,d,n,a,i]).then(async([f,g,p,h,m])=>{const b=se.get("viewOnLoad");this._initializePdfHistory({fingerprint:e.fingerprints[0],viewOnLoad:b,initialDest:m?.dest});const y=this.initialBookmark,w=se.get("defaultZoomValue");let _=w?`zoom=${w}`:null,x=null,S=se.get("sidebarViewOnLoad"),k=se.get("scrollModeOnLoad"),A=se.get("spreadModeOnLoad");g.page=this.pdfId||g.page,g?.page&&b!==lb.INITIAL&&(_=`page=${g.page}&zoom=${w||g.zoom},${g.scrollLeft}${this.pdfId?"":","+g.scrollTop}`,x=parseInt(g.rotation,10),S===Me.UNKNOWN&&(S=g.sidebarView|0),k===Te.UNKNOWN&&(k=g.scrollMode|0),A===_t.UNKNOWN&&(A=g.spreadMode|0)),_.indexOf("page=")===-1&&this.pdfId&&(_+=`&page=${this.pdfId}`),h&&S===Me.UNKNOWN&&(S=Jx(h)),p&&k===Te.UNKNOWN&&A===_t.UNKNOWN&&(A=Wv(p).spreadMode),this.setInitialView(_,{rotation:x,sidebarView:S,scrollMode:k,spreadMode:A}),this.eventBus.dispatch("documentinit",{source:this}),this.isViewerEmbedded||s.focus(),await Promise.race([r,new Promise($=>{setTimeout($,AC)})]),!(!y&&!_)&&(s.hasEqualPageSizes||(this.initialBookmark=y,s.currentScaleValue=s.currentScaleValue,this.setInitialView(_)))}).catch(()=>{this.setInitialView()}).then(function(){s.update();const f=L(s.container,"fn__flex-1");f&&f.removeAttribute("data-loading")})}),r.then(()=>{this._unblockDocumentLoadEvent(),this._initializeAutoPrint(e,i)},c=>{this._documentError("pdfjs-loading-error",{message:c.message})}),l.then(c=>{this.externalServices.reportTelemetry({type:"pageInfo",timestamp:c.timestamp}),this.pdfOutlineViewer&&e.getOutline().then(f=>{e===this.pdfDocument&&this.pdfOutlineViewer.render({outline:f,pdfDocument:e})}),this.pdfAttachmentViewer&&e.getAttachments().then(f=>{e===this.pdfDocument&&this.pdfAttachmentViewer.render({attachments:f})}),this.pdfLayerViewer&&s.optionalContentConfigPromise.then(f=>{e===this.pdfDocument&&this.pdfLayerViewer.render({optionalContentConfig:f,pdfDocument:e})})}),this._initializePageLabels(e),this._initializeMetadata(e)}async _scriptingDocProperties(e){return!this.documentInfo&&(await new Promise(n=>{this.eventBus._on("metadataloaded",n,{once:!0})}),e!==this.pdfDocument)||!this._contentLength&&(await new Promise(n=>{this.eventBus._on("documentloaded",n,{once:!0})}),e!==this.pdfDocument)?null:{...this.documentInfo,baseURL:this.baseUrl,filesize:this._contentLength,filename:this._docFilename,metadata:this.metadata?.getRaw(),authors:this.metadata?.get("dc:creator"),numPages:this.pagesCount,URL:this.url}}async _initializeAutoPrint(e,n){const[a,i]=await Promise.all([n,this.pdfViewer.enableScripting?null:e.getJSActions()]);if(e!==this.pdfDocument)return;let s=a?.action==="Print";if(i){console.warn("Warning: JavaScript support is not enabled");for(const o in i){if(s)break;switch(o){case"WillClose":case"WillSave":case"DidSave":case"WillPrint":case"DidPrint":continue}s=i[o].some(l=>Wx.test(l))}}s&&this.triggerPrinting()}async _initializeMetadata(e){const{info:n,metadata:a,contentDispositionFilename:i,contentLength:s}=await e.getMetadata();if(e!==this.pdfDocument)return;this.documentInfo=n,this.metadata=a,this._contentDispositionFilename??=i,this._contentLength??=s;let o=n.Title;const l=a?.get("dc:title");l&&l!=="Untitled"&&!/[\uFFF0-\uFFFF]/g.test(l)&&(o=l),o?this.setTitle(`${o} - ${this._contentDispositionFilename||this._title}`):this._contentDispositionFilename&&this.setTitle(this._contentDispositionFilename),n.IsXFAPresent&&!n.IsAcroFormPresent&&!e.isPureXfa?e.loadingParams.enableXfa?console.warn("Warning: XFA Foreground documents are not supported"):console.warn("Warning: XFA support is not enabled"):(n.IsAcroFormPresent||n.IsXFAPresent)&&!this.pdfViewer.renderForms&&console.warn("Warning: Interactive form support is not enabled"),n.IsSignaturesPresent&&console.warn("Warning: Digital signatures validation is not supported"),this.eventBus.dispatch("metadataloaded",{source:this})}async _initializePageLabels(e){if(typeof PDFJSDev>"u"?window.isGECKOVIEW:PDFJSDev.test("GECKOVIEW"))return;const n=await e.getPageLabels();if(e!==this.pdfDocument||!n||se.get("disablePageLabels"))return;const a=n.length;let i=0,s=0;for(let d=0;d<a;d++){const c=n[d];if(c===(d+1).toString())i++;else if(c==="")s++;else break}if(i>=a||s>=a)return;const{pdfViewer:o,pdfThumbnailViewer:l,toolbar:r}=this;o.setPageLabels(n),l?.setPageLabels(n),r?.setPagesCount(a,!0),r?.setPageNumber(o.currentPageNumber,o.currentPageLabel)}_initializePdfHistory({fingerprint:e,viewOnLoad:n,initialDest:a=null}){this.pdfHistory&&(this.pdfHistory.initialize({fingerprint:e,resetHistory:n===lb.INITIAL,updateUrl:se.get("historyUpdateUrl")}),this.pdfHistory.initialBookmark&&(this.initialBookmark=this.pdfHistory.initialBookmark,this.initialRotation=this.pdfHistory.initialRotation),a&&!this.initialBookmark&&n===lb.UNKNOWN&&(this.initialBookmark=JSON.stringify(a),this.pdfHistory.push({explicitDest:a,pageNumber:null})))}_initializeAnnotationStorageCallbacks(e){if(e!==this.pdfDocument)return;const{annotationStorage:n}=e;n.onSetModified=()=>{(typeof PDFJSDev>"u"||PDFJSDev.test("GENERIC"))&&(this._annotationStorageModified=!0)},n.onResetModified=()=>{(typeof PDFJSDev>"u"||PDFJSDev.test("GENERIC"))&&delete this._annotationStorageModified},n.onAnnotationEditor=a=>{this._hasAnnotationEditors=!!a,this.setTitle()}}setInitialView(e,{rotation:n,sidebarView:a,scrollMode:i,spreadMode:s}={}){const o=r=>{cp(r)&&(this.pdfViewer.pagesRotation=r)},l=(r,d)=>{qv(r)&&(this.pdfViewer.scrollMode=r),Fv(d)&&(this.pdfViewer.spreadMode=d)};this.isInitialViewSet=!0,this.pdfSidebar?.setInitialView(a),l(i,s),this.initialBookmark?(o(this.initialRotation),delete this.initialRotation,this.pdfLinkService.setHash(this.initialBookmark),this.initialBookmark=null):e&&(o(n),this.pdfLinkService.setHash(e)),this.toolbar?.setPageNumber(this.pdfViewer.currentPageNumber,this.pdfViewer.currentPageLabel),this.secondaryToolbar?.setPageNumber(this.pdfViewer.currentPageNumber),this.pdfViewer.currentScaleValue||(this.pdfViewer.currentScaleValue=Cc)}_cleanup(){this.pdfDocument&&(this.pdfViewer.cleanup(),this.pdfThumbnailViewer?.cleanup(),this.pdfDocument.cleanup(se.get("fontExtraProperties")))}forceRendering(){this.pdfRenderingQueue.printing=!!this.printService,this.pdfRenderingQueue.isThumbnailViewEnabled=this.pdfSidebar?.visibleView===Me.THUMBS,this.pdfRenderingQueue.renderHighestPriority()}beforePrint(){if(this._printAnnotationStoragePromise=this.pdfScriptingManager.dispatchWillPrint().catch(()=>{}).then(()=>this.pdfDocument?.annotationStorage.print),!this.printService){if(!this.supportsPrinting){this._otherError(window.siyuan.languages.printingNotSupported);return}if(!this.pdfViewer.pageViewsReady){this.l10n.get("pdfjs-printing-not-ready").then(e=>{window.alert(e)});return}this.printService=cE.createPrintService({pdfDocument:this.pdfDocument,pagesOverview:this.pdfViewer.getPagesOverview(),printContainer:this.appConfig.printContainer,printResolution:se.get("printResolution"),printAnnotationStoragePromise:this._printAnnotationStoragePromise}),this.forceRendering(),this.setTitle(),this.printService.layout(),this._hasAnnotationEditors&&this.externalServices.reportTelemetry({type:"editing",data:{type:"print",stats:this.pdfDocument?.annotationStorage.editorStats}})}}afterPrint(){this._printAnnotationStoragePromise&&(this._printAnnotationStoragePromise.then(()=>{this.pdfScriptingManager.dispatchDidPrint()}),this._printAnnotationStoragePromise=null),this.printService&&(this.printService.destroy(),this.printService=null,this.pdfDocument?.annotationStorage.resetModified()),this.forceRendering(),this.setTitle()}rotatePages(e){this.pdfViewer.pagesRotation+=e}requestPresentationMode(){this.pdfPresentationMode?.request()}triggerPrinting(){this.supportsPrinting&&window.print()}bindEvents(){if(this._eventBusAbortController)return;this._eventBusAbortController=new AbortController;const{eventBus:e,externalServices:n,pdfDocumentProperties:a,pdfViewer:i,preferences:s,_eventBusAbortController:{signal:o}}=this;e._on("resize",RC.bind(this),{signal:o}),e._on("hashchange",OC.bind(this),{signal:o}),e._on("beforeprint",this.beforePrint.bind(this),{signal:o}),e._on("afterprint",this.afterPrint.bind(this),{signal:o}),e._on("pagerender",DC.bind(this),{signal:o}),e._on("pagerendered",$C.bind(this),{signal:o}),e._on("updateviewarea",HC.bind(this),{signal:o}),e._on("pagechanging",zC.bind(this),{signal:o}),e._on("scalechanging",WC.bind(this),{signal:o}),e._on("rotationchanging",YC.bind(this),{signal:o}),e._on("sidebarviewchanged",NC.bind(this),{signal:o}),e._on("pagemode",MC.bind(this),{signal:o}),e._on("namedaction",PC.bind(this),{signal:o}),e._on("presentationmodechanged",l=>i.presentationModeState=l.state,{signal:o}),e._on("presentationmode",this.requestPresentationMode.bind(this),{signal:o}),e._on("switchannotationeditormode",l=>i.annotationEditorMode=l,{signal:o}),e._on("print",this.triggerPrinting.bind(this),{signal:o}),e._on("download",this.downloadOrSave.bind(this),{signal:o}),e._on("firstpage",()=>this.page=1,{signal:o}),e._on("lastpage",()=>this.page=this.pagesCount,{signal:o}),e._on("nextpage",()=>i.nextPage(),{signal:o}),e._on("previouspage",()=>i.previousPage(),{signal:o}),e._on("zoomin",this.zoomIn.bind(this),{signal:o}),e._on("zoomout",this.zoomOut.bind(this),{signal:o}),e._on("zoomreset",this.zoomReset.bind(this),{signal:o}),e._on("pagenumberchanged",rb.bind(this),{signal:o}),e._on("scalechanged",l=>i.currentScaleValue=l.value,{signal:o}),e._on("rotatecw",this.rotatePages.bind(this,90),{signal:o}),e._on("rotateccw",this.rotatePages.bind(this,-90),{signal:o}),e._on("optionalcontentconfig",l=>i.optionalContentConfigPromise=l.promise,{signal:o}),e._on("switchscrollmode",l=>i.scrollMode=l.mode,{signal:o}),e._on("scrollmodechanged",AE.bind(this,"scrollMode"),{signal:o}),e._on("switchspreadmode",l=>i.spreadMode=l.mode,{signal:o}),e._on("spreadmodechanged",AE.bind(this,"spreadMode"),{signal:o}),e._on("imagealttextsettings",BC.bind(this),{signal:o}),e._on("documentproperties",()=>a?.open(),{signal:o}),e._on("findfromurlhash",qC.bind(this),{signal:o}),e._on("updatefindmatchescount",FC.bind(this),{signal:o}),e._on("updatefindcontrolstate",UC.bind(this),{signal:o}),(typeof PDFJSDev>"u"||PDFJSDev.test("GENERIC"))&&(e._on("fileinputchange",TC.bind(this),{signal:o}),e._on("openfile",IC.bind(this),{signal:o})),typeof PDFJSDev<"u"&&PDFJSDev.test("MOZCENTRAL")&&(e._on("annotationeditorstateschanged",l=>n.updateEditorStates(l),{signal:o}),e._on("reporttelemetry",l=>n.reportTelemetry(l.details),{signal:o})),(typeof PDFJSDev>"u"||PDFJSDev.test("TESTING || MOZCENTRAL"))&&e._on("setpreference",l=>s.set(l.name,l.value),{signal:o})}bindWindowEvents(){if(this._windowAbortController)return;this._windowAbortController=new AbortController;const{eventBus:e,appConfig:{mainContainer:n},pdfViewer:a,_windowAbortController:{signal:i}}=this;function s(d=null){d&&a.refresh(),window.matchMedia(`(resolution: ${window.devicePixelRatio||1}dppx)`).addEventListener("change",s,{once:!0,signal:i})}s();const o=L(n,"pdf__outer");if(o.addEventListener("wheel",VC.bind(this),{passive:!1,signal:i}),o.addEventListener("touchstart",GC.bind(this),{passive:!1,signal:i}),o.addEventListener("touchmove",jC.bind(this),{passive:!1,signal:i}),o.addEventListener("touchend",KC.bind(this),{passive:!1,signal:i}),o.addEventListener("click",ZC.bind(this),{signal:i}),window.removeEventListener("keydown",TE,{signal:i}),window.addEventListener("keydown",TE,{signal:i}),window.removeEventListener("keyup",CE,{signal:i}),window.addEventListener("keyup",CE,{signal:i}),(typeof PDFJSDev>"u"||!PDFJSDev.test("MOZCENTRAL"))&&!("onscrollend"in document.documentElement))return;(typeof PDFJSDev>"u"||!PDFJSDev.test("MOZCENTRAL"))&&({scrollTop:this._lastScrollTop,scrollLeft:this._lastScrollLeft}=n);const l=()=>{(typeof PDFJSDev>"u"||!PDFJSDev.test("MOZCENTRAL"))&&({scrollTop:this._lastScrollTop,scrollLeft:this._lastScrollLeft}=n),this._isScrolling=!1,n.addEventListener("scroll",r,{passive:!0,signal:i}),n.removeEventListener("scrollend",l),n.removeEventListener("blur",l)},r=()=>{this._isCtrlKeyDown||(typeof PDFJSDev>"u"||!PDFJSDev.test("MOZCENTRAL"))&&this._lastScrollTop===n.scrollTop&&this._lastScrollLeft===n.scrollLeft||(n.removeEventListener("scroll",r,{passive:!0}),this._isScrolling=!0,n.addEventListener("scrollend",l,{signal:i}),n.addEventListener("blur",l,{signal:i}))};n.addEventListener("scroll",r,{passive:!0,signal:i})}unbindEvents(){this._eventBusAbortController?.abort(),this._eventBusAbortController=null}unbindWindowEvents(){this._windowAbortController?.abort(),this._windowAbortController=null}async testingClose(){this.unbindEvents(),this.unbindWindowEvents(),this._globalAbortController?.abort(),this._globalAbortController=null,this.findBar?.close(),await Promise.all([this.l10n?.destroy(),this.close()])}_accumulateTicks(e,n){(this[n]>0&&e<0||this[n]<0&&e>0)&&(this[n]=0),this[n]+=e;const a=Math.trunc(this[n]);return this[n]-=a,a}_accumulateFactor(e,n,a){if(n===1)return 1;(this[a]>1&&n<1||this[a]<1&&n>1)&&(this[a]=1);const i=Math.floor(e*n*this[a]*100)/(100*e);return this[a]=n/i,i}_unblockDocumentLoadEvent(){document.blockUnblockOnload?.(!1),this._unblockDocumentLoadEvent=()=>{}}get scriptingReady(){return this.pdfScriptingManager.ready}}if(typeof PDFJSDev>"u"||PDFJSDev.test("MOZCENTRAL"),typeof PDFJSDev>"u"||PDFJSDev.test("GENERIC")){const t=["null","http://mozilla.github.io","https://mozilla.github.io"];var CC=function(e){if(e)try{const n=new URL(window.location.href).origin||"null";if(t.includes(n))return;if(new URL(e,window.location.href).origin!==n)throw new Error("file origin does not match viewer's")}catch(n){throw console.log(window.siyuan.languages.loadingError,n.message),n}},TC=function(e){if(this.pdfViewer?.isInPresentationMode)return;const n=e.fileInput.files[0];this.open({url:URL.createObjectURL(n),originalUrl:n.name})},IC=function(e){this._openFileInput?.click()}}function DC({pageNumber:t}){t===this.page&&this.toolbar?.updateLoadingIndicatorState(!0)}function $C({pageNumber:t,error:e}){if(t===this.page&&this.toolbar?.updateLoadingIndicatorState(!1),this.pdfSidebar?.visibleView===Me.THUMBS){const n=this.pdfViewer.getPageView(t-1),a=this.pdfThumbnailViewer?.getThumbnail(t-1);n&&a?.setImage(n)}e&&this._otherError("pdfjs-rendering-error",e)}function MC({mode:t}){let e;switch(t){case"thumbs":e=Me.THUMBS;break;case"bookmarks":case"outline":e=Me.OUTLINE;break;case"attachments":e=Me.ATTACHMENTS;break;case"layers":e=Me.LAYERS;break;case"none":e=Me.NONE;break;default:console.error('Invalid "pagemode" hash parameter: '+t);return}this.pdfSidebar?.switchView(e,!0)}function PC(t){switch(t.action){case"GoToPage":this.appConfig.toolbar?.pageNumber.select();break;case"Find":this.supportsIntegratedFind||this.findBar?.toggle();break;case"Print":this.triggerPrinting();break;case"SaveAs":this.downloadOrSave();break}}function NC({view:t}){this.pdfRenderingQueue.isThumbnailViewEnabled=t===Me.THUMBS,this.isInitialViewSet&&this.store?.set("sidebarView",t).catch(()=>{})}function HC({location:t}){this.isInitialViewSet&&this.store?.setMultiple({page:t.pageNumber,zoom:t.scale,scrollLeft:t.left,scrollTop:t.top,rotation:t.rotation}).catch(()=>{}),this.appConfig.secondaryToolbar&&(this.appConfig.secondaryToolbar.viewBookmarkButton.href=this.pdfLinkService.getAnchorUrl(t.pdfOpenParams))}function AE(t,e){this.isInitialViewSet&&!this.pdfViewer.isInPresentationMode&&this.store?.set(t,e.mode).catch(()=>{})}function RC(){const{pdfDocument:t,pdfViewer:e,pdfRenderingQueue:n}=this;if(n.printing&&window.matchMedia("print").matches||!t)return;const a=e.currentScaleValue;(a==="auto"||a==="page-fit"||a==="page-width")&&(e.currentScaleValue=a),e.update()}function OC(t){const e=t.hash;e&&(this.isInitialViewSet?this.pdfHistory?.popStateInProgress||this.pdfLinkService.setHash(e):this.initialBookmark=e)}function rb(t){let e=this;t.pdfInstance&&(e=t.pdfInstance);const{pdfViewer:n}=e;t.value!==""&&e.pdfLinkService.goToPage(t.value),t.id&&vE(e.pdfViewer.container,t.id),t.value!==n.currentPageNumber.toString()&&t.value!==n.currentPageLabel&&e.toolbar?.setPageNumber(n.currentPageNumber,n.currentPageLabel)}function BC(){this.imageAltTextSettings?.open({enableGuessAltText:se.get("enableGuessAltText"),enableNewAltTextWhenAddingImage:se.get("enableNewAltTextWhenAddingImage")})}function qC(t){this.eventBus.dispatch("find",{source:t.source,type:"",query:t.query,caseSensitive:!1,entireWord:!1,highlightAll:!0,findPrevious:!1,matchDiacritics:!0})}function FC({matchesCount:t}){this.supportsIntegratedFind?this.externalServices.updateFindMatchesCount(t):this.findBar?.updateResultsCount(t)}function UC({state:t,previous:e,entireWord:n,matchesCount:a,rawQuery:i}){this.supportsIntegratedFind?this.externalServices.updateFindControlState({result:t,findPrevious:e,entireWord:n,matchesCount:a,rawQuery:i}):this.findBar?.updateUIState(t,e,a)}function WC(t){this.toolbar?.setPageScale(t.presetValue,t.scale),this.pdfViewer.update()}function YC(t){this.pdfThumbnailViewer&&(this.pdfThumbnailViewer.pagesRotation=t.pagesRotation),this.forceRendering(),this.pdfViewer.currentPageNumber=t.pageNumber}function zC({pageNumber:t,pageLabel:e}){this.toolbar?.setPageNumber(t,e),this.secondaryToolbar?.setPageNumber(t),this.pdfSidebar?.visibleView===Me.THUMBS&&this.pdfThumbnailViewer?.scrollThumbnailIntoView(t);const n=this.pdfViewer.getPageView(t-1);this.toolbar?.updateLoadingIndicatorState(n?.renderingState===We.RUNNING)}function VC(t){const{pdfViewer:e,supportsMouseWheelZoomCtrlKey:n,supportsMouseWheelZoomMetaKey:a,supportsPinchToZoom:i}=this;if(e.isInPresentationMode)return;const s=t.deltaMode;let o=Math.exp(-t.deltaY/100);const l=typeof PDFJSDev<"u"&&PDFJSDev.test("MOZCENTRAL")&&G.FeatureTest.platform.isMac,r=t.ctrlKey&&!this._isCtrlKeyDown&&s===WheelEvent.DOM_DELTA_PIXEL&&t.deltaX===0&&(Math.abs(o-1)<.05||l)&&t.deltaZ===0,d=[t.clientX,t.clientY];if(r||t.ctrlKey&&n||t.metaKey&&a){if(t.preventDefault(),this._isScrolling||document.visibilityState==="hidden"||this.overlayManager.active)return;if(r&&i)o=this._accumulateFactor(e.currentScale,o,"_wheelUnusedFactor"),this.updateZoom(null,o,d);else{const c=Bv(t);let f=0;s===WheelEvent.DOM_DELTA_LINE||s===WheelEvent.DOM_DELTA_PAGE?f=Math.abs(c)>=1?Math.sign(c):this._accumulateTicks(c,"_wheelUnusedTicks"):f=this._accumulateTicks(c/30,"_wheelUnusedTicks"),this.updateZoom(f,null,d)}}}function GC(t){if(this.pdfViewer.isInPresentationMode||t.touches.length<2)return;if(t.preventDefault(),t.touches.length!==2||this.overlayManager.active){this._touchInfo=null;return}let[e,n]=t.touches;e.identifier>n.identifier&&([e,n]=[n,e]),this._touchInfo={touch0X:e.pageX,touch0Y:e.pageY,touch1X:n.pageX,touch1Y:n.pageY}}function jC(t){if(!this._touchInfo||t.touches.length!==2)return;const{pdfViewer:e,_touchInfo:n,supportsPinchToZoom:a}=this;let[i,s]=t.touches;i.identifier>s.identifier&&([i,s]=[s,i]);const{pageX:o,pageY:l}=i,{pageX:r,pageY:d}=s,{touch0X:c,touch0Y:f,touch1X:g,touch1Y:p}=n;if(Math.abs(c-o)<=1&&Math.abs(f-l)<=1&&Math.abs(g-r)<=1&&Math.abs(p-d)<=1)return;if(n.touch0X=o,n.touch0Y=l,n.touch1X=r,n.touch1Y=d,c===o&&f===l){const y=g-o,w=p-l,_=r-o,x=d-l,S=y*x-w*_;if(Math.abs(S)>.02*Math.hypot(y,w)*Math.hypot(_,x))return}else if(g===r&&p===d){const y=c-r,w=f-d,_=o-r,x=l-d,S=y*x-w*_;if(Math.abs(S)>.02*Math.hypot(y,w)*Math.hypot(_,x))return}else{const y=o-c,w=r-g,_=l-f,x=d-p;if(y*w+_*x>=0)return}t.preventDefault();const h=[(o+r)/2,(l+d)/2],m=Math.hypot(o-r,l-d)||1,b=Math.hypot(c-g,f-p)||1;if(a){const y=this._accumulateFactor(e.currentScale,m/b,"_touchUnusedFactor");this.updateZoom(null,y,h)}else{const w=this._accumulateTicks((m-b)/30,"_touchUnusedTicks");this.updateZoom(w,null,h)}}function KC(t){this._touchInfo&&(t.preventDefault(),this._touchInfo=null,this._touchUnusedTicks=0,this._touchUnusedFactor=1)}function ZC(t){if(["SELECT","TEXTAREA","INPUT"].includes(t.target.tagName)||this.pdfViewer.focus(),!this.secondaryToolbar?.isOpen)return;const e=this.appConfig;(this.pdfViewer.containsElement(t.target)||e.toolbar?.container.contains(t.target)&&!e.secondaryToolbar?.toggleButton.contains(t.target))&&this.secondaryToolbar.close()}function CE(t){const e=ob(t.target);e&&(["SELECT","TEXTAREA","INPUT"].includes(t.target.tagName)||e.pdfViewer.focus(),t.key==="Control"&&(e._isCtrlKeyDown=!1),([92,91,68].includes(t.keyCode)||t.ctrlKey||t.altKey)&&e.appConfig.toolbar.rectAnno.classList.contains("toggled")&&e.appConfig.toolbar.rectAnno.dispatchEvent(new MouseEvent("click")))}function TE(t){const e=ob(t.target);if(!e||(e._isCtrlKeyDown=t.key==="Control",e.overlayManager.active))return;const{eventBus:n,pdfViewer:a}=e,i=a.isInPresentationMode;let s=!1,o=!1;const l=(t.ctrlKey?1:0)|(t.altKey?2:0)|(t.shiftKey?4:0)|(t.metaKey?8:0);if(l===0&&[38,40].includes(t.keyCode)){document.activeElement&&document.activeElement.blur(),setTimeout(()=>{a.focus()});return}if(!t.repeat&&(l===8||l===1||l===2)&&t.keyCode===68&&!e.appConfig.toolbar.rectAnno.classList.contains("toggled")){e.appConfig.toolbar.rectAnno.dispatchEvent(new MouseEvent("click")),t.preventDefault();return}if(!t.repeat&&l!==1&&l!==2&&l!==4&&l!==8&&[48,49,50,51,52,53,54,55].includes(t.keyCode)&&getSelection().rangeCount>0&&!e.appConfig.toolbar.rectAnno.classList.contains("toggled")){const c=getSelection().getRangeAt(0);if(c.toString()!==""&&L(c.commonAncestorContainer,"pdfViewer")){e.appConfig.appContainer.dispatchEvent(new CustomEvent("click",{detail:(t.keyCode-48).toString()})),t.preventDefault();return}}if(l===1||l===8||l===5||l===12)switch(t.keyCode){case 70:!e.supportsIntegratedFind&&!t.shiftKey&&(e.findBar?.open(),s=!0);break;case 71:if(!e.supportsIntegratedFind){const{state:c}=e.findController;if(c){const f={source:window,type:"again",findPrevious:l===5||l===12};n.dispatch("find",{...c,...f})}s=!0}break;case 61:case 107:case 187:case 171:e.zoomIn(),s=!0;break;case 173:case 109:case 189:e.zoomOut(),s=!0;break;case 48:case 96:i||(setTimeout(()=>{e.zoomReset()}),s=!1);break;case 38:(i||e.page>1)&&(e.page=1,s=!0,o=!0);break;case 40:(i||e.page<e.pagesCount)&&(e.page=e.pagesCount,s=!0,o=!0);break}if((typeof PDFJSDev>"u"||PDFJSDev.test("GENERIC || CHROME"))&&(l===1||l===8))switch(t.keyCode){case 83:n.dispatch("download",{source:window}),s=!0;break;case 79:(typeof PDFJSDev>"u"||PDFJSDev.test("GENERIC"))&&(n.dispatch("openfile",{source:window}),s=!0);break}if(l===3||l===10)switch(t.keyCode){case 80:e.requestPresentationMode(),s=!0,e.externalServices.reportTelemetry({type:"buttons",data:{id:"presentationModeKeyboard"}});break;case 71:e.appConfig.toolbar&&(e.appConfig.toolbar.pageNumber.select(),s=!0);break}if(s){o&&!i&&a.focus(),t.preventDefault();return}const r=Zx(),d=r?.tagName.toUpperCase();if(!((d==="INPUT"||d==="TEXTAREA"||d==="SELECT"||d==="BUTTON"&&(t.keyCode===13||t.keyCode===32)||r?.isContentEditable)&&t.keyCode!==27)){if(l===0){let c=0,f=!1;switch(t.keyCode){case 38:if(e.supportsCaretBrowsingMode){e.moveCaret(!0,!1),s=!0;break}case 33:a.isVerticalScrollbarEnabled&&(f=!0),c=-1;break;case 8:i||(f=!0),c=-1;break;case 37:if(e.supportsCaretBrowsingMode)return;a.isHorizontalScrollbarEnabled&&(f=!0);case 75:case 80:c=-1;break;case 27:e.secondaryToolbar?.isOpen&&(e.secondaryToolbar.close(),s=!0),!e.supportsIntegratedFind&&e.findBar?.opened&&(e.findBar.close(),s=!0);break;case 40:if(e.supportsCaretBrowsingMode){e.moveCaret(!1,!1),s=!0;break}case 34:a.isVerticalScrollbarEnabled&&(f=!0),c=1;break;case 13:case 32:i||(f=!0),c=1;break;case 39:if(e.supportsCaretBrowsingMode)return;a.isHorizontalScrollbarEnabled&&(f=!0);case 74:case 78:c=1;break;case 36:(i||e.page>1)&&(e.page=1,s=!0,o=!0);break;case 35:(i||e.page<e.pagesCount)&&(e.page=e.pagesCount,s=!0,o=!0);break;case 83:e.pdfCursorTools?.switchTool($n.SELECT);break;case 72:e.pdfCursorTools?.switchTool($n.HAND);break;case 82:e.rotatePages(90);break;case 115:e.pdfSidebar?.toggle();break}c!==0&&(!f||a.currentScaleValue==="page-fit")&&(c>0?a.nextPage():a.previousPage(),s=!0)}if(l===4)switch(t.keyCode){case 13:case 32:if(!i&&a.currentScaleValue!=="page-fit")break;a.previousPage(),s=!0;break;case 38:e.moveCaret(!0,!0),s=!0;break;case 40:e.moveCaret(!1,!0),s=!0;break;case 82:e.rotatePages(-90);break}!s&&!i&&(t.keyCode>=33&&t.keyCode<=40||t.keyCode===32&&d!=="BUTTON")&&(o=!0),o&&!a.containsElement(r)&&a.focus(),s&&t.preventDefault()}}function M0(t){return t.preventDefault(),t.returnValue="",!1}const P0=typeof PDFJSDev<"u"?PDFJSDev.eval("BUNDLE_VERSION"):void 0,N0=typeof PDFJSDev<"u"?PDFJSDev.eval("BUNDLE_BUILD"):void 0,H0=typeof PDFJSDev>"u"||PDFJSDev.test("GENERIC")?{LinkTarget:$i,RenderingStates:We,ScrollMode:Te,SpreadMode:_t}:null;function JC(t){return{appContainer:t,principalContainer:t.querySelector("#mainContainer"),mainContainer:t.querySelector("#viewerContainer"),viewerContainer:t.querySelector("#viewer"),toolbar:{rectAnno:t.querySelector("#rectAnno"),container:t.querySelector("#toolbarContainer"),numPages:t.querySelector("#numPages"),pageNumber:t.querySelector("#pageNumber"),scaleSelect:t.querySelector("#scaleSelect"),customScaleOption:t.querySelector("#customScaleOption"),previous:t.querySelector("#previous"),next:t.querySelector("#next"),zoomIn:t.querySelector("#zoomInButton"),zoomOut:t.querySelector("#zoomOutButton"),print:t.querySelector("#printButton"),editorFreeTextButton:t.querySelector("#editorFreeTextButton"),editorFreeTextParamsToolbar:t.querySelector("#editorFreeTextParamsToolbar"),editorHighlightButton:t.querySelector("#editorHighlightButton"),editorHighlightParamsToolbar:t.querySelector("#editorHighlightParamsToolbar"),editorHighlightColorPicker:t.querySelector("#editorHighlightColorPicker"),editorInkButton:t.querySelector("#editorInkButton"),editorInkParamsToolbar:t.querySelector("#editorInkParamsToolbar"),editorStampButton:t.querySelector("#editorStampButton"),editorStampParamsToolbar:t.querySelector("#editorStampParamsToolbar"),download:t.querySelector("#downloadButton")},secondaryToolbar:{toolbar:t.querySelector("#secondaryToolbar"),toggleButton:t.querySelector("#secondaryToolbarToggleButton"),presentationModeButton:t.querySelector("#presentationMode"),openFileButton:typeof PDFJSDev>"u"||PDFJSDev.test("GENERIC")?t.querySelector("#secondaryOpenFile"):null,printButton:t.querySelector("#secondaryPrint"),downloadButton:t.querySelector("#secondaryDownload"),viewBookmarkButton:t.querySelector("#viewBookmark"),firstPageButton:t.querySelector("#firstPage"),lastPageButton:t.querySelector("#lastPage"),pageRotateCwButton:t.querySelector("#pageRotateCw"),pageRotateCcwButton:t.querySelector("#pageRotateCcw"),cursorSelectToolButton:t.querySelector("#cursorSelectTool"),cursorHandToolButton:t.querySelector("#cursorHandTool"),scrollPageButton:t.querySelector("#scrollPage"),scrollVerticalButton:t.querySelector("#scrollVertical"),scrollHorizontalButton:t.querySelector("#scrollHorizontal"),scrollWrappedButton:t.querySelector("#scrollWrapped"),spreadNoneButton:t.querySelector("#spreadNone"),spreadOddButton:t.querySelector("#spreadOdd"),spreadEvenButton:t.querySelector("#spreadEven"),imageAltTextSettingsButton:t.querySelector("#imageAltTextSettings"),imageAltTextSettingsSeparator:t.querySelector("#imageAltTextSettingsSeparator"),documentPropertiesButton:t.querySelector("#documentProperties")},sidebar:{outerContainer:t.querySelector("#outerContainer"),sidebarContainer:t.querySelector("#sidebarContainer"),toggleButton:t.querySelector("#sidebarToggleButton"),resizer:t.querySelector("#sidebarResizer"),thumbnailButton:t.querySelector("#viewThumbnail"),outlineButton:t.querySelector("#viewOutline"),attachmentsButton:t.querySelector("#viewAttachments"),layersButton:t.querySelector("#viewLayers"),thumbnailView:t.querySelector("#thumbnailView"),outlineView:t.querySelector("#outlineView"),attachmentsView:t.querySelector("#attachmentsView"),layersView:t.querySelector("#layersView"),currentOutlineItemButton:t.querySelector("#currentOutlineItem")},findBar:{bar:t.querySelector("#findbar"),toggleButton:t.querySelector("#viewFindButton"),findField:t.querySelector("#findInput"),highlightAllCheckbox:t.querySelector("#findHighlightAll"),caseSensitiveCheckbox:t.querySelector("#findMatchCase"),matchDiacriticsCheckbox:t.querySelector("#findMatchDiacritics"),entireWordCheckbox:t.querySelector("#findEntireWord"),findMsg:t.querySelector("#findMsg"),findResultsCount:t.querySelector("#findResultsCount"),findPreviousButton:t.querySelector("#findPreviousButton"),findNextButton:t.querySelector("#findNextButton")},passwordOverlay:{dialog:t.querySelector("#passwordDialog"),label:t.querySelector("#passwordText"),input:t.querySelector("#password"),submitButton:t.querySelector("#passwordSubmit"),cancelButton:t.querySelector("#passwordCancel")},documentProperties:{dialog:t.querySelector("#documentPropertiesDialog"),closeButton:t.querySelector("#documentPropertiesClose"),fields:{fileName:t.querySelector("#fileNameField"),fileSize:t.querySelector("#fileSizeField"),title:t.querySelector("#titleField"),author:t.querySelector("#authorField"),subject:t.querySelector("#subjectField"),keywords:t.querySelector("#keywordsField"),creationDate:t.querySelector("#creationDateField"),modificationDate:t.querySelector("#modificationDateField"),creator:t.querySelector("#creatorField"),producer:t.querySelector("#producerField"),version:t.querySelector("#versionField"),pageCount:t.querySelector("#pageCountField"),pageSize:t.querySelector("#pageSizeField"),linearized:t.querySelector("#linearizedField")}},altTextDialog:{dialog:t.querySelector("#altTextDialog"),optionDescription:t.querySelector("#descriptionButton"),optionDecorative:t.querySelector("#decorativeButton"),textarea:t.querySelector("#descriptionTextarea"),cancelButton:t.querySelector("#altTextCancel"),saveButton:t.querySelector("#altTextSave")},newAltTextDialog:{dialog:t.querySelector("#newAltTextDialog"),title:t.querySelector("#newAltTextTitle"),descriptionContainer:t.querySelector("#newAltTextDescriptionContainer"),textarea:t.querySelector("#newAltTextDescriptionTextarea"),disclaimer:t.querySelector("#newAltTextDisclaimer"),learnMore:t.querySelector("#newAltTextLearnMore"),imagePreview:t.querySelector("#newAltTextImagePreview"),createAutomatically:t.querySelector("#newAltTextCreateAutomatically"),createAutomaticallyButton:t.querySelector("#newAltTextCreateAutomaticallyButton"),downloadModel:t.querySelector("#newAltTextDownloadModel"),downloadModelDescription:t.querySelector("#newAltTextDownloadModelDescription"),error:t.querySelector("#newAltTextError"),errorCloseButton:t.querySelector("#newAltTextCloseButton"),cancelButton:t.querySelector("#newAltTextCancel"),notNowButton:t.querySelector("#newAltTextNotNow"),saveButton:t.querySelector("#newAltTextSave")},altTextSettingsDialog:{dialog:t.querySelector("#altTextSettingsDialog"),createModelButton:t.querySelector("#createModelButton"),aiModelSettings:t.querySelector("#aiModelSettings"),learnMore:t.querySelector("#altTextSettingsLearnMore"),deleteModelButton:t.querySelector("#deleteModelButton"),downloadModelButton:t.querySelector("#downloadModelButton"),showAltTextDialogButton:t.querySelector("#showAltTextDialogButton"),altTextSettingsCloseButton:t.querySelector("#altTextSettingsCloseButton"),closeButton:t.querySelector("#altTextSettingsCloseButton")},annotationEditorParams:{editorFreeTextFontSize:t.querySelector("#editorFreeTextFontSize"),editorFreeTextColor:t.querySelector("#editorFreeTextColor"),editorInkColor:t.querySelector("#editorInkColor"),editorInkThickness:t.querySelector("#editorInkThickness"),editorInkOpacity:t.querySelector("#editorInkOpacity"),editorStampAddImage:t.querySelector("#editorStampAddImage"),editorFreeHighlightThickness:t.querySelector("#editorFreeHighlightThickness"),editorHighlightShowAll:t.querySelector("#editorHighlightShowAll")},printContainer:t.querySelector("#printContainer")}}function IE(t,e,n,a){se.set("workerSrc",`${u.PROTYLE_CDN}/js/pdf/pdf.worker.min.mjs?v=4.7.85`),se.set("defaultUrl",t),se.set("cMapUrl","cmaps/"),se.set("standardFontDataUrl","standard_fonts/"),se.set("annotationEditorMode",G.AnnotationEditorType.DISABLE);const i=new xE(n);i.annoId=a;const s=JC(e);if(s.file=t,typeof PDFJSDev<"u"&&PDFJSDev.test("GENERIC")){const o=new CustomEvent("webviewerloaded",{bubbles:!0,cancelable:!0,detail:{source:window}});try{parent.document.dispatchEvent(o)}catch(l){console.error(`webviewerloaded: ${l}`),document.dispatchEvent(o)}}return i.run(s),gC(e,i),i}document.blockUnblockOnload?.(!0);class li extends Vn{constructor(e){if(super({app:e.app,id:e.tab.id}),window.siyuan.config.fileTree.openFilesUseCurrentTab&&e.tab.headElement.classList.add("item--unupdate"),this.element=e.tab.panelElement,this.path=e.path,this.pdfId=e.page,this.element.addEventListener("click",n=>{Di(),tt(this.element.parentElement.parentElement),this.app.plugins.forEach(a=>{a.eventBus.emit("click-pdf",{event:n})})}),typeof this.pdfId=="string"){this.getPdfId(()=>{this.render()});return}else typeof this.pdfId=="number"&&(this.pdfPage=this.pdfId);this.render()}getPdfId(e){E("/api/asset/getFileAnnotation",{path:this.path+".sya"},n=>{if(n.code!==1){const a=JSON.parse(n.data.data);a[this.pdfId]?this.pdfPage=a[this.pdfId].page?a[this.pdfId].page+1:a[this.pdfId].pages[0].index+1:this.pdfPage=void 0}e()})}goToPage(e){if(!(typeof e>"u"||e===null)){if(this.pdfId=e,typeof e=="string"){this.getPdfId(()=>{this.pdfPage&&rb({value:this.pdfPage,pdfInstance:this.pdfObject,id:this.pdfId})});return}typeof e=="number"&&!isNaN(e)&&rb({value:this.pdfId,pdfInstance:this.pdfObject})}}render(){const e=this.path.substr(this.path.lastIndexOf(".")).toLowerCase();if(u.SIYUAN_ASSETS_IMAGE.includes(e))this.element.innerHTML=`<div class="asset"><img src="${this.path.startsWith("file")?this.path:document.getElementById("baseURL").getAttribute("href")+"/"+this.path}"></div>`;else if(u.SIYUAN_ASSETS_AUDIO.includes(e))this.element.innerHTML=`<div class="asset"><audio controls="controls" src="${this.path.startsWith("file")?this.path:document.getElementById("baseURL").getAttribute("href")+"/"+this.path}"></audio></div>`;else if(u.SIYUAN_ASSETS_VIDEO.includes(e))this.element.innerHTML=`<div class="asset"><video controls="controls" src="${this.path.startsWith("file")?this.path:document.getElementById("baseURL").getAttribute("href")+"/"+this.path}"></video></div>`;else if(e===".pdf"){this.element.innerHTML=`<div class="pdf__outer" id="outerContainer">
      <div id="sidebarContainer">
        <div id="toolbarSidebar">
          <div id="toolbarSidebarLeft">
              <button id="viewThumbnail" class="toolbarButton toggled b3-tooltips b3-tooltips__ne" aria-label="${window.siyuan.languages.thumbsTitle}">
                <svg><use xlink:href="#iconImage"></use></svg>
              </button>
              <button id="viewOutline" class="toolbarButton b3-tooltips b3-tooltips__ne" aria-label="${window.siyuan.languages.outline}">
                 <svg><use xlink:href="#iconAlignCenter"></use></svg>
              </button>
              <button id="viewAttachments" class="toolbarButton fn__none" data-l10n-id="attachments">
                 <span data-l10n-id="attachments_label">Attachments</span>
              </button>
              <button id="viewLayers" class="toolbarButton fn__none" data-l10n-id="layers">
                 <span data-l10n-id="layers_label">Layers</span>
              </button>
          </div>
          <div class="fn__flex-1"></div>
          <div id="toolbarSidebarRight">
            <div id="outlineOptionsContainer" class="fn__hidden">
              <button id="currentOutlineItem" class="toolbarButton b3-tooltips b3-tooltips__nw" disabled="disabled" aria-label="${window.siyuan.languages.focusOutline}">
                <svg><use xlink:href="#iconFocus"></use></svg>
              </button>
            </div>
          </div>
        </div>
        <div id="sidebarContent">
          <div id="thumbnailView">
          </div>
          <div id="outlineView" class="fn__hidden">
          </div>
          <div id="attachmentsView" class="fn__hidden">
          </div>
          <div id="layersView" class="fn__hidden">
          </div>
        </div>
        <div id="sidebarResizer"></div>
      </div>
      <div id="mainContainer">
        <div class="findbar b3-menu fn__hidden doorHanger" id="findbar">
            <input id="findInput" class="toolbarField b3-text-field" placeholder="${window.siyuan.languages.search}">
            <div class="fn__space"></div>
            <button id="findPreviousButton" class="toolbarButton findPrevious b3-tooltips b3-tooltips__n" aria-label="${window.siyuan.languages.previous}">
                <svg><use xlink:href="#iconUp"></use></svg>
            </button>
            <button id="findNextButton" class="toolbarButton findNext b3-tooltips b3-tooltips__n" aria-label="${window.siyuan.languages.next}">
                <svg><use xlink:href="#iconDown"></use></svg>
            </button>
            <label class="b3-button b3-button--outline b3-button--small">
                <input type="checkbox" id="findHighlightAll" class="toolbarField">
                ${window.siyuan.languages.findHighlight}
            </label>
            <div class="fn__space"></div>
            <label class="b3-button b3-button--outline b3-button--small">
                <input type="checkbox" id="findMatchCase" class="toolbarField">
                ${window.siyuan.languages.searchCaseSensitive}
            </label>
            <div class="fn__space"></div>
            <label class="b3-button b3-button--outline b3-button--small">
                <input type="checkbox" id="findMatchDiacritics" class="toolbarField">
                ${window.siyuan.languages.matchDiacritics}
            </label>
            <div class="fn__space"></div>
            <label class="b3-button b3-button--outline b3-button--small">
                <input type="checkbox" id="findEntireWord" class="toolbarField">
                ${window.siyuan.languages.findEntireWord}
            </label>
            <div class="fn__space"></div>
            <span id="findResultsCount" class="b3-button b3-button--small b3-button--cancel"></span>
            <span id="findMsg" class="b3-button b3-button--small b3-button--cancel"></span>
        </div>  <!-- findbar -->
        <div id="secondaryToolbar" class="secondaryToolbar fn__hidden doorHangerRight b3-menu">
          <div id="secondaryToolbarButtonContainer" class="b3-menu__items">
            <button id="pdfLight" class="secondaryToolbarButton b3-menu__item toggled">
              <svg class="b3-menu__icon"><use xlink:href="#iconLight"></use></svg> 
              <span class="b3-menu__label">${window.siyuan.languages.themeLight}</span>
            </button>
            <button id="pdfDark" class="secondaryToolbarButton b3-menu__item">
              <svg class="b3-menu__icon"><use xlink:href="#iconDark"></use></svg> 
              <span class="b3-menu__label">${window.siyuan.languages.themeDark}</span>
            </button>
            <div class="horizontalToolbarSeparator b3-menu__separator"></div>
            <button id="previous" class="secondaryToolbarButton b3-menu__item pageUp">
              <svg class="b3-menu__icon"><use xlink:href="#iconUp"></use></svg> 
              <span class="b3-menu__label">${window.siyuan.languages.previousLabel}</span>
              <span class="b3-menu__accelerator">${X("P")}/${X("K")}</span>
            </button>
            <button id="next" class="secondaryToolbarButton b3-menu__item pageDown">
              <svg class="b3-menu__icon"><use xlink:href="#iconDown"></use></svg> 
              <span class="b3-menu__label">${window.siyuan.languages.nextLabel}</span>
              <span class="b3-menu__accelerator">${X("J")}/${X("N")}</span>
            </button>
            <button id="firstPage" class="secondaryToolbarButton b3-menu__item firstPage">
              <svg class="b3-menu__icon"><use xlink:href="#iconBack"></use></svg> 
              <span class="b3-menu__label">${window.siyuan.languages.firstPage}</span>
              <span class="b3-menu__accelerator">Home</span>
            </button>
            <button id="lastPage" class="secondaryToolbarButton b3-menu__item lastPage">
              <svg class="b3-menu__icon"><use xlink:href="#iconForward"></use></svg> 
              <span class="b3-menu__label">${window.siyuan.languages.lastPage}</span>
              <span class="b3-menu__accelerator">End</span>
            </button>
            <div class="horizontalToolbarSeparator b3-menu__separator"></div>
            <button id="zoomOutButton" class="secondaryToolbarButton b3-menu__item zoomOut">
               <svg class="b3-menu__icon"><use xlink:href="#iconLine"></use></svg> 
               <span class="b3-menu__label">${window.siyuan.languages.zoomOut}</span>
               <span class="b3-menu__accelerator">${X("\u2318-")}</span>
            </button>
            <button id="zoomInButton" class="secondaryToolbarButton b3-menu__item zoomIn">
               <svg class="b3-menu__icon"><use xlink:href="#iconAdd"></use></svg> 
               <span class="b3-menu__label">${window.siyuan.languages.zoomIn}</span>
               <span class="b3-menu__accelerator">${X("\u2318=")}</span>
            </button>
            <button id="pageRotateCw" class="secondaryToolbarButton b3-menu__item rotateCw">
               <svg class="b3-menu__icon"><use xlink:href="#iconRedo"></use></svg> 
               <span class="b3-menu__label">${window.siyuan.languages.rotateCw}</span>
               <span class="b3-menu__accelerator">R</span>
            </button>
            <button id="pageRotateCcw" class="secondaryToolbarButton b3-menu__item rotateCcw">
               <svg class="b3-menu__icon"><use xlink:href="#iconUndo"></use></svg> 
               <span class="b3-menu__label">${window.siyuan.languages.rotateCcw}</span>
               <span class="b3-menu__accelerator">\u21E7R</span>
            </button>

            <div class="horizontalToolbarSeparator b3-menu__separator"></div>

            <button id="cursorSelectTool" class="secondaryToolbarButton b3-menu__item selectTool toggled">
               <svg class="b3-menu__icon"><use xlink:href="#iconSelectText"></use></svg> 
               <span class="b3-menu__label">${window.siyuan.languages.cursorText}</span>
               <span class="b3-menu__accelerator">S</span>
            </button>
            <button id="cursorHandTool" class="secondaryToolbarButton b3-menu__item handTool">
              <svg class="b3-menu__icon"><use xlink:href="#iconHand"></use></svg> 
              <span class="b3-menu__label">${window.siyuan.languages.cursorHand}</span>
              <span class="b3-menu__accelerator">H</span>
            </button>
            <div class="horizontalToolbarSeparator b3-menu__separator"></div>
            <button id="scrollVertical" class="secondaryToolbarButton b3-menu__item scrollModeButtons scrollVertical toggled">
             <svg class="b3-menu__icon"><use xlink:href="#iconScrollVert"></use></svg> 
              <span class="b3-menu__label">${window.siyuan.languages.scrollVertical}</span>
            </button>
            <button id="scrollHorizontal" class="secondaryToolbarButton b3-menu__item scrollModeButtons scrollHorizontal">
              <svg class="b3-menu__icon"><use xlink:href="#iconScrollHoriz"></use></svg> 
              <span class="b3-menu__label">${window.siyuan.languages.scrollHorizontal}</span>
            </button>
            <button id="scrollWrapped" class="secondaryToolbarButton b3-menu__item scrollModeButtons scrollWrapped">
             <svg class="b3-menu__icon"><use xlink:href="#iconScrollWrapped"></use></svg> 
              <span class="b3-menu__label">${window.siyuan.languages.scrollWrapped}</span>
            </button>

            <div class="horizontalToolbarSeparator b3-menu__separator scrollModeButtons"></div>

            <button id="spreadNone" class="secondaryToolbarButton b3-menu__item spreadModeButtons spreadNone toggled">
              <svg class="b3-menu__icon"><use xlink:href="#iconFile"></use></svg> 
              <span class="b3-menu__label">${window.siyuan.languages.spreadNone}</span>
            </button>
            <button id="spreadOdd" class="secondaryToolbarButton b3-menu__item spreadModeButtons spreadOdd">
              <svg class="b3-menu__icon"><use xlink:href="#iconSpreadOdd"></use></svg> 
              <span class="b3-menu__label">${window.siyuan.languages.spreadOdd}</span>
            </button>
            <button id="spreadEven" class="secondaryToolbarButton b3-menu__item spreadModeButtons spreadEven">
              <svg class="b3-menu__icon"><use xlink:href="#iconSpreadEven"></use></svg> 
              <span class="b3-menu__label">${window.siyuan.languages.spreadEven}</span>
            </button>
            <button id="presentationMode" class="secondaryToolbarButton b3-menu__item presentationMode">
              <svg class="b3-menu__icon"><use xlink:href="#iconPlay"></use></svg>
              <span class="b3-menu__label">${window.siyuan.languages.presentationMode}</span>
              <span class="b3-menu__accelerator">${X("\u2325\u2318P")}</span>
            </button>
            <div class="horizontalToolbarSeparator b3-menu__separator spreadModeButtons"></div>
            <button id="documentProperties" class="secondaryToolbarButton b3-menu__item documentProperties">
              <svg class="b3-menu__icon"><use xlink:href="#iconInfo"></use></svg> 
              <span class="b3-menu__label">${window.siyuan.languages.attr}</span>
            </button>
          </div>
        </div>  <!-- secondaryToolbar -->

        <div class="pdf__toolbar">
          <div id="toolbarContainer">
            <div id="toolbarViewer">
                <button id="sidebarToggleButton" class="toolbarButton b3-tooltips b3-tooltips__se" aria-expanded="false" aria-controls="sidebarContainer" aria-label="${window.siyuan.languages.toggleSidebarNotification2Title} ${X("F4")}">
                    <svg><use xlink:href="#iconLayoutRight"></use></svg>
                </button>
                <button id="viewFindButton" class="toolbarButton b3-tooltips b3-tooltips__se" aria-expanded="false" aria-controls="findbar" aria-label="${window.siyuan.languages.search} ${X("\u2318F")}">
                  <svg><use xlink:href="#iconSearch"></use></svg>
                </button>
                <button id="rectAnno" class="toolbarButton b3-tooltips b3-tooltips__se" aria-expanded="false" aria-controls="findbar" aria-label="${window.siyuan.languages.rectAnnotation} ${X("\u2318D")}/${X("\u2325D")}">
                  <svg><use xlink:href="#iconLeftTop"></use></svg>
                </button>
                <input type="number" id="pageNumber" class="toolbarField pageNumber b3-text-field" value="1" size="4" min="1" autocomplete="off">
                <span id="numPages"></span>
                <div class="fn__flex-1"></div>
                <span id="scaleSelectContainer" class="dropdownToolbarButton">
                  <select id="scaleSelect" class="b3-select">
                    <option id="pageAutoOption" value="auto" selected="selected">${window.siyuan.languages.pageScaleAuto}</option>
                    <option id="pageActualOption" value="page-actual">${window.siyuan.languages.pageScaleActual}</option>
                    <option id="pageFitOption" value="page-fit">${window.siyuan.languages.pageScaleFit}</option>
                    <option id="pageWidthOption" value="page-width">${window.siyuan.languages.pageScaleWidth}</option>
                    <option id="customScaleOption" value="custom" disabled="disabled" hidden="true"></option>
                    <option value="0.5">50%</option>
                    <option value="0.75">75%</option>
                    <option value="1">100%</option>
                    <option value="1.25">125%</option>
                    <option value="1.5">150%</option>
                    <option value="2">200%</option>
                    <option value="3">300%</option>
                    <option value="4">400%</option>
                  </select>
                </span>
                <span id="scrollPage" class="fn__none"></span>
                <span id="printButton" class="fn__none"></span>
                <span id="secondaryPrint" class="fn__none"></span>
                <span id="viewBookmark" class="fn__none"></span>
                <span id="secondaryViewBookmark" class="fn__none"></span>
                <button id="secondaryToolbarToggleButton" class="toolbarButton b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.more}" aria-expanded="false" aria-controls="secondaryToolbar">
                  <svg><use xlink:href="#iconMore"></use></svg>
                </button>
            </div>
            <div id="loadingBar">
              <div class="progress">
                <div class="glimmer">
                </div>
              </div>
            </div>
          </div>
        </div>

        <div id="viewerContainer">
          <div id="viewer" class="pdfViewer"></div>
          <div class="pdf__resize fn__none"></div>
        </div>
        <div id="errorWrapper" hidden='true'>
          <div id="errorMessageLeft">
            <span id="errorMessage"></span>
            <button id="errorShowMore" data-l10n-id="error_more_info">
              More Information
            </button>
            <button id="errorShowLess" data-l10n-id="error_less_info" hidden='true'>
              Less Information
            </button>
          </div>
          <div id="errorMessageRight">
            <button id="errorClose" data-l10n-id="error_close">
              Close
            </button>
          </div>
          <div class="clearBoth"></div>
          <textarea id="errorMoreInfo" hidden='true' readonly="readonly"></textarea>
        </div>
      </div>
      <div id="dialogContainer">
        <div class="dialog" id="passwordDialog">
            <div class="row">
              <p id="passwordText" data-l10n-id="password_label">Enter the password to open this PDF file:</p>
            </div>
            <div class="row">
              <input type="password" id="password" class="toolbarField">
            </div>
            <div class="buttonRow">
              <button id="passwordCancel" class="overlayButton"><span data-l10n-id="password_cancel">Cancel</span></button>
              <button id="passwordSubmit" class="overlayButton"><span data-l10n-id="password_ok">OK</span></button>
            </div>
        </div>
        <div class="dialog" id="documentPropertiesDialog">
            <div class="row">
              <span>${window.siyuan.languages.fileName}</span> <p id="fileNameField">-</p>
            </div>
            <div class="row">
              <span>${window.siyuan.languages.fileSize}</span> <p id="fileSizeField">-</p>
            </div>
            <div class="separator"></div>
            <div class="row">
              <span>${window.siyuan.languages.title1}</span> <p id="titleField">-</p>
            </div>
            <div class="row">
              <span>${window.siyuan.languages.author}</span> <p id="authorField">-</p>
            </div>
            <div class="row">
              <span>${window.siyuan.languages.subject}</span> <p id="subjectField">-</p>
            </div>
            <div class="row">
              <span>${window.siyuan.languages.keywords}</span> <p id="keywordsField">-</p>
            </div>
            <div class="row">
              <span>${window.siyuan.languages.creationDate}</span> <p id="creationDateField">-</p>
            </div>
            <div class="row">
              <span>${window.siyuan.languages.modificationDate}</span> <p id="modificationDateField">-</p>
            </div>
            <div class="row">
              <span>${window.siyuan.languages.creator}</span> <p id="creatorField">-</p>
            </div>
            <div class="separator"></div>
            <div class="row">
              <span>PDF ${window.siyuan.languages.producer}</span> <p id="producerField">-</p>
            </div>
            <div class="row">
              <span>PDF ${window.siyuan.languages.version}</span> <p id="versionField">-</p>
            </div>
            <div class="row">
              <span>${window.siyuan.languages.pageCount}</span> <p id="pageCountField">-</p>
            </div>
            <div class="row">
              <span>${window.siyuan.languages.pageSize}</span> <p id="pageSizeField">-</p>
            </div>
            <div class="separator"></div>
            <div class="row">
              <span>${window.siyuan.languages.linearized}</span> <p id="linearizedField">-</p>
            </div>
            <div class="buttonRow">
              <button id="documentPropertiesClose" class="b3-button"><span>${window.siyuan.languages.close}</span></button>
            </div>
        </div>
        <div class="dialog" id="printServiceOverlay">
            <div class="row">
              <span data-l10n-id="print_progress_message">Preparing document for printing\u2026</span>
            </div>
            <div class="row">
              <progress value="0" max="100"></progress>
              <span data-l10n-id="print_progress_percent" data-l10n-args='{ "progress": 0 }' class="relative-progress">0%</span>
            </div>
            <div class="buttonRow">
              <button id="printCancel" class="overlayButton"><span data-l10n-id="print_progress_close">Cancel</span></button>
            </div>
        </div>
      </div>
      <div class="pdf__util b3-menu fn__none pdf__util--hide">
        <div class="fn__flex" style="padding: 0 4px">
            <button class="color__square" style="background-color:var(--b3-pdf-background1)"></button>
            <button class="color__square" style="background-color:var(--b3-pdf-background2)"></button>
            <button class="color__square" style="background-color:var(--b3-pdf-background3)"></button>
            <button class="color__square" style="background-color:var(--b3-pdf-background4)"></button>
            <button class="color__square" style="background-color:var(--b3-pdf-background5)"></button>
            <button class="color__square" style="background-color:var(--b3-pdf-background6)"></button>
            <button class="color__square" style="background-color:var(--b3-pdf-background7)"></button>
        </div>
        <div class="b3-menu__separator pdf__util__hide" style="margin-top: 8px"></div>
        <button class="b3-menu__item pdf__util__hide" data-type="toggle">
            <svg class="b3-menu__icon"><use xlink:href="#iconFilesRoot"></use></svg>
            <span class="b3-menu__label">${window.siyuan.languages.showHideBg}</span>
        </button>
        <button class="b3-menu__item pdf__util__hide" data-type="copy">
            <svg class="b3-menu__icon"><use xlink:href="#iconRef"></use></svg>
            <span class="b3-menu__label">${window.siyuan.languages.copyAnnotation}</span>
        </button>
        <button class="b3-menu__item pdf__util__hide" data-type="relate">
            <svg class="b3-menu__icon"><use xlink:href="#iconParagraph"></use></svg>
            <span class="b3-menu__label">${window.siyuan.languages.relation}</span>
        </button>
        <button class="b3-menu__item pdf__util__hide" data-type="remove">
            <svg class="b3-menu__icon"><use xlink:href="#iconTrashcan"></use></svg>
            <span class="b3-menu__label">${window.siyuan.languages.remove}</span>
        </button>
      </div>
      <div class="fn__none">
        <input id="editorFreeTextFontSize">
        <input id="editorFreeTextColor">
        <input id="editorInkColor">
        <input id="editorInkThickness">
        <input id="editorInkOpacity">
        <input id="editorStampAddImage">
        <input id="editorFreeHighlightThickness">
        <input id="editorHighlightShowAll">
        <input id="downloadButton">
        <input id="secondaryDownload">
        <input id="editorFreeTextButton">
        <input id="openFile">
        <input id="editorInkButton">
        <input id="editorStampButton">
        <input id="editorHighlightButton">
        <input id="imageAltTextSettings">
        <input id="secondaryOpenFile">
      </div>
    </div> <!-- outerContainer -->
    <div id="printContainer"></div>`;const n=window.siyuan.storage[u.LOCAL_PDFTHEME],a=window.siyuan.config.appearance.mode===0?n.light:n.dark,i=this.element.querySelector("#pdfDark"),s=this.element.querySelector("#pdfLight");a==="dark"?(this.element.firstElementChild.classList.add("pdf__outer--dark"),s.classList.remove("toggled"),i.classList.add("toggled")):(s.classList.add("toggled"),i.classList.remove("toggled")),s.addEventListener("click",()=>{window.siyuan.config.appearance.mode===0?n.light="light":n.dark="light",this.element.firstElementChild.classList.remove("pdf__outer--dark"),s.classList.add("toggled"),i.classList.remove("toggled"),ue(u.LOCAL_PDFTHEME,window.siyuan.storage[u.LOCAL_PDFTHEME])}),i.addEventListener("click",()=>{window.siyuan.config.appearance.mode===0?n.light="dark":n.dark="dark",this.element.firstElementChild.classList.add("pdf__outer--dark"),s.classList.remove("toggled"),i.classList.add("toggled"),ue(u.LOCAL_PDFTHEME,window.siyuan.storage[u.LOCAL_PDFTHEME])}),setTimeout(()=>{if(this.element.clientWidth===0){const o=new MutationObserver(()=>{this.pdfObject=IE(this.path.startsWith("file")?this.path:document.getElementById("baseURL").getAttribute("href")+"/"+this.path,this.element,this.pdfPage,this.pdfId),this.element.setAttribute("data-loading","true"),o.disconnect()});o.observe(this.element,{attributeFilter:["class"]})}else this.pdfObject=IE(this.path.startsWith("file")?this.path:document.getElementById("baseURL").getAttribute("href")+"/"+this.path,this.element,this.pdfPage,this.pdfId),this.element.setAttribute("data-loading","true");lp()},u.TIMEOUT_LOAD)}}}class Mi extends Vn{constructor(e){super({app:e.app,id:e.tab.id}),window.siyuan.config.fileTree.openFilesUseCurrentTab&&e.tab.headElement?.classList.add("item--unupdate"),this.element=e.tab.panelElement,this.config=e.config,this.editors=Xw(e.app,this.config,this.element),this.element.addEventListener("click",()=>{Di(),tt(this.element.parentElement.parentElement)})}updateSearch(e,n){const a=this.element.querySelector(".b3-text-field");if(e===""){a.select();return}const i=a.value;i!==e&&(n||(i.indexOf(e)>-1?e=i.replace(e+" ","").replace(" "+e,""):i!==""&&(e=i+" "+e)),a.value=e,a.select(),a.dispatchEvent(new CustomEvent("input")))}}class Wa extends Vn{constructor(e){super({app:e.app,id:e.tab.id}),this.editors=[],window.siyuan.config.fileTree.openFilesUseCurrentTab&&e.tab.headElement?.classList.add("item--unupdate"),this.element=e.tab.panelElement,this.tab=e.tab,this.data=e.data,this.type=e.type,this.init=e.init,this.destroy=e.destroy,this.beforeDestroy=e.beforeDestroy,this.resize=e.resize,this.update=e.update,this.init(this)}}const cb=t=>{let e;const n=new Wa({app:t.app,type:"siyuan-card",tab:t.tab,data:t.data,async init(){if(t.data.cardsData){for(let a=0;a<t.app.plugins.length;a++)t.data.cardsData=await t.app.plugins[a].updateCards(t.data.cardsData);this.element.innerHTML=kf({id:this.data.id,cardType:this.data.cardType,cardsData:t.data.cardsData,isTab:!0}),e=await Rh({app:t.app,element:this.element,id:this.data.id,title:this.data.title,cardType:this.data.cardType,cardsData:t.data.cardsData,index:t.data.index}),n.editors.push(e),delete t.data.cardsData,delete t.data.index}else E(this.data.cardType==="all"?"/api/riff/getRiffDueCards":this.data.cardType==="doc"?"/api/riff/getTreeRiffDueCards":"/api/riff/getNotebookRiffDueCards",{rootID:this.data.id,deckID:this.data.id,notebook:this.data.id},async a=>{let i=a.data;for(let s=0;s<t.app.plugins.length;s++)i=await t.app.plugins[s].updateCards(a.data);this.element.innerHTML=kf({id:this.data.id,cardType:this.data.cardType,cardsData:i,isTab:!0}),e=await Rh({app:t.app,element:this.element,id:this.data.id,title:this.data.title,cardType:this.data.cardType,cardsData:i}),n.editors.push(e)})},destroy(){e&&e.destroy()},resize(){e&&e.resize()},update(){E(this.data.cardType==="all"?"/api/riff/getRiffDueCards":this.data.cardType==="doc"?"/api/riff/getTreeRiffDueCards":"/api/riff/getNotebookRiffDueCards",{rootID:this.data.id,deckID:this.data.id,notebook:this.data.id},async a=>{for(let i=0;i<t.app.plugins.length;i++)t.data.cardsData=await t.app.plugins[i].updateCards(t.data.cardsData);this.element.innerHTML=kf({id:this.data.id,cardType:this.data.cardType,cardsData:a.data,isTab:!0})})}});return n.element.addEventListener("click",()=>{Di(),tt(n.element.parentElement.parentElement)}),n},de=async t=>{const e=await Re("/api/block/getBlockInfo",{id:t.id});if(e.code!==-1){if(e.code===3){j(e.msg);return}return ma({app:t.app,fileName:e.data.rootTitle,rootIcon:e.data.rootIcon,rootID:e.data.rootID,id:t.id,position:t.position,mode:t.mode,action:t.action,zoomIn:t.zoomIn,keepCursor:t.keepCursor,removeCurrentTab:t.removeCurrentTab,afterOpen:t.afterOpen,openNewTab:t.openNewTab})}},Ul=(t,e,n,a)=>{const i=Ee().extname(e.split("?page")[0]);u.SIYUAN_ASSETS_EXTS.includes(i)&&ma({app:t,assetPath:e,page:n,position:a,removeCurrentTab:!0})},ma=async t=>{typeof t.removeCurrentTab>"u"&&(t.removeCurrentTab=!0),document.querySelectorAll(".av__panel, .av__mask").forEach(i=>{i.remove()}),document.activeElement instanceof HTMLElement&&document.activeElement.blur();const e=Ce();if(t.assetPath){Di();const i=e.asset.find(s=>{if(s.path==t.assetPath)return Io(s.parent.parent.element)||(s.parent.parent.switchTab(s.parent.headElement),s.parent.parent.showHeading(),s.goToPage(t.page)),!0});if(i)return t.afterOpen&&t.afterOpen(i),i.parent}else if(t.custom){Di();const i=e.custom.find(o=>{if(tn(o.data,t.custom.data)&&(!t.custom.id||t.custom.id===o.type))return Io(o.parent.parent.element)||(o.parent.parent.switchTab(o.parent.headElement),o.parent.parent.showHeading()),!0});if(i)return t.afterOpen&&t.afterOpen(i),i.parent;const s=db(t);if(s)return t.afterOpen&&t.afterOpen(s.model),s}else if(t.searchData){Di();const i=e.search.find(s=>{if(tn(s.config,t.searchData))return Io(s.parent.parent.element)||(s.parent.parent.switchTab(s.parent.headElement),s.parent.parent.showHeading()),!0});if(i)return i.parent}else if(!t.position&&!t.openNewTab){let i,s;if(e.editor.find(l=>{if(l.editor.protyle.block.rootID===t.rootID&&(L(l.element,"layout__wnd--active")&&(s=l),(!i||l.headElement.getAttribute("data-activetime")>i.headElement.getAttribute("data-activetime"))&&(i=l)),s)return!0}),s&&(i=s),i)return Io(i.parent.parent.element)||DE(i,t,e),t.afterOpen&&t.afterOpen(i),i.parent;const o=db(t);if(o)return t.afterOpen&&t.afterOpen(o.model),o}if(!t.position||t.position==="right"&&t.assetPath){let i=!1;const s={};if(Object.keys(t).forEach(o=>{o!=="app"&&t[o]&&typeof t[o]!="function"&&(s[o]=JSON.parse(JSON.stringify(t[o])))}),i=await ee.ipcRenderer.invoke(u.SIYUAN_GET,{cmd:u.SIYUAN_OPEN_FILE,options:JSON.stringify(s)}),i){t.afterOpen&&t.afterOpen();return}}let n;const a=document.querySelector(".layout__wnd--active");if(a&&(n=Bt(a.getAttribute("data-id"))),n||(n=jl(window.siyuan.layout.centerLayout)),n){let i;if((t.position==="right"||t.position==="bottom")&&n.children[0].headElement){const s=t.position==="right"?"lr":"tb";let o;if(n.parent.children.length>1&&n.parent instanceof wa&&n.parent.direction===s&&n.parent.children.find((l,r)=>{if(l.id===n.id){let d=n.parent.children[r+1];for(d||(d=n);d instanceof wa;)d=d.children[0];return o=d,!0}}),o){if(Io(o.element)){t.afterOpen&&t.afterOpen();return}let l=o.children.find(r=>{if(r.model&&r.model instanceof ht&&r.model.editor.protyle.block.rootID===t.rootID)return DE(r.model,t,e),!0});l||(l=db(t),i=l),l||(i=Nc(t),o.addTab(i))}else i=Nc(t),n.split(s).addTab(i);return n.showHeading(),t.afterOpen&&t.afterOpen(i?i.model:void 0),i}if(Io(n.element)){t.afterOpen&&t.afterOpen();return}if(t.keepCursor&&n.children[0].headElement)i=Nc(t),i.headElement.setAttribute("keep-cursor",t.id),n.addTab(i,t.keepCursor);else if(window.siyuan.config.fileTree.openFilesUseCurrentTab){let s;n.children.find(o=>{if(o.headElement&&o.headElement.classList.contains("item--unupdate")&&!o.headElement.classList.contains("item--pin")&&(s=o,o.headElement.classList.contains("item--focus")))return!0}),i=Nc(t),n.addTab(i),s&&t.removeCurrentTab&&n.removeTab(s.id,!1,!1)}else i=Nc(t),n.addTab(i);return n.showHeading(),t.afterOpen&&t.afterOpen(i.model),i}},db=t=>ba().find(e=>{const n=e.headElement?.getAttribute("data-initdata");if(n){const a=JSON.parse(n);if(a.instance==="Editor"&&(a.rootId===t.rootID||a.blockId===t.rootID))return a.blockId=t.id,a.mode=t.mode,t.zoomIn?a.action=[u.CB_GET_ALL,u.CB_GET_FOCUS]:a.action=t.action,e.headElement.setAttribute("data-initdata",JSON.stringify(a)),e.parent.switchTab(e.headElement),!0;if(a.instance==="Custom"&&t.custom&&tn(a.customModelData,t.custom.data))return e.parent.switchTab(e.headElement),!0}}),DE=(t,e,n)=>{if(e.keepCursor)return t.parent.headElement.setAttribute("keep-cursor",e.id),!0;if(t.parent.parent.switchTab(t.parent.headElement),t.parent.parent.showHeading(),e.mode!=="preview"&&!t.editor.protyle.preview.element.classList.contains("fn__none"))return!0;if(e.zoomIn)return Vt({protyle:t.editor.protyle,id:e.id}),!0;let a;if(Array.from(t.editor.protyle.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`)).find(i=>{if(!F(i))return a=i,!0}),(!a||a?.clientHeight===0)&&e.id!==e.rootID)E("/api/filetree/getDoc",{id:e.id,mode:e.action&&e.action.includes(u.CB_GET_CONTEXT)?3:0,size:window.siyuan.config.editor.dynamicLoadBlocks},i=>{rt({data:i,protyle:t.editor.protyle,action:e.action}),fb(n,t.editor.protyle)});else{if(Bn(t.editor.protyle),e.action?.includes(u.CB_GET_HL))cf(t.editor.protyle,e.id,!0);else if(e.action?.includes(u.CB_GET_FOCUS))if(a){const i=ae(a);i&&(t.editor.protyle.toolbar.range=i),Ne(t.editor.protyle,a,!0)}else t.editor.protyle.block.rootID===e.id||t.editor.protyle.toolbar.range&&(a=P(t.editor.protyle.toolbar.range.startContainer),Z(t.editor.protyle.toolbar.range),a&&Ne(t.editor.protyle,a));ql(t.editor.protyle,void 0,a||t.editor.protyle.wysiwyg.element.firstElementChild)}e.mode&&mo(t.editor.protyle,e.mode)},Nc=t=>{let e;if(t.assetPath){const n=Ee().extname(t.assetPath.split("?page")[0]);if(u.SIYUAN_ASSETS_EXTS.includes(n)){let a="iconPDF";u.SIYUAN_ASSETS_IMAGE.includes(n)?a="iconImage":u.SIYUAN_ASSETS_AUDIO.includes(n)?a="iconRecord":u.SIYUAN_ASSETS_VIDEO.includes(n)&&(a="iconVideo"),e=new ut({icon:a,title:nt(t.assetPath),callback(i){i.addModel(new li({app:t.app,tab:i,path:t.assetPath,page:t.page})),tt(i.panelElement.parentElement.parentElement)}})}}else t.custom?e=new ut({icon:t.custom.icon,title:t.custom.title,callback(n){t.custom.id?t.custom.id==="siyuan-card"?n.addModel(cb({app:t.app,tab:n,data:t.custom.data})):t.app.plugins.find(a=>{if(a.models[t.custom.id])return n.addModel(a.models[t.custom.id]({tab:n,data:t.custom.data})),!0}):(console.warn("0.8.3 \u5C06\u79FB\u9664 custom.fn \u53C2\u6570\uFF0C\u8BF7\u53C2\u7167 https://github.com/siyuan-note/plugin-sample/blob/91a716358941791b4269241f21db25fd22ae5ff5/src/index.ts \u5C06\u5176\u4FEE\u6539\u4E3A custom.id"),n.addModel(t.custom.fn({tab:n,data:t.custom.data}))),tt(n.panelElement.parentElement.parentElement)}}):t.searchData?e=new ut({icon:"iconSearch",title:window.siyuan.languages.search,callback(n){n.addModel(new Mi({app:t.app,tab:n,config:t.searchData})),tt(n.panelElement.parentElement.parentElement)}}):e=new ut({title:nt(t.fileName,!0,!0),docIcon:t.rootIcon,callback(n){let a;t.zoomIn?a=new ht({app:t.app,tab:n,blockId:t.id,rootId:t.rootID,action:[u.CB_GET_ALL,u.CB_GET_FOCUS]}):a=new ht({app:t.app,tab:n,blockId:t.id,rootId:t.rootID,mode:t.mode,action:t.action}),n.addModel(a)}});return e},Wl=t=>{if(t.protyle&&t.protyle.path){if(t.protyle.element.classList.contains("fn__none")||!L(t.protyle.element,"layout__wnd--active")&&document.querySelector(".layout__wnd--active"))return;if(t.resize&&Jt(t.protyle),t.focus&&(t.protyle.toolbar.range?(Z(t.protyle.toolbar.range),Lo(t.protyle.toolbar.range,t.protyle.block.rootID),t.pushBackStack&&t.protyle.preview.element.classList.contains("fn__none")&&ql(t.protyle,t.protyle.toolbar.range)):(ae(t.protyle.wysiwyg.element.firstElementChild),t.pushBackStack&&t.protyle.preview.element.classList.contains("fn__none")&&ql(t.protyle,void 0,t.protyle.wysiwyg.element.firstElementChild),bn([],t.protyle.block.rootID))),window.siyuan.config.fileTree.alwaysSelectOpenedFile&&t.protyle){const n=Qe("file")?.data.file;if(n instanceof Li){const a=n.element.querySelector(`li[data-path="${t.protyle.path}"]`);(!a||a&&!a.classList.contains("b3-list-item--focus"))&&n.selectItem(t.protyle.notebookId,t.protyle.path)}}t.protyle.app.plugins.forEach(n=>{n.eventBus.emit("switch-protyle",{protyle:t.protyle})})}const e=Ce();ub(e,t.protyle,t.reload),fb(e,t.protyle)},$E=t=>{const e=document.querySelector(".layout__wnd--active > .fn__flex > .layout-tab-bar > .item--focus");if(e){const n=Bt(e.getAttribute("data-id"));if(n instanceof ut&&n.model instanceof ht&&(n.model.editor.protyle.block.rootID===t||n.model.editor.protyle.block.parentID===t||n.model.editor.protyle.block.id===t))return!0}return!1},ub=(t,e,n=!1)=>{t.outline.find(a=>{if(n||a.type==="pin"&&(!e||a.blockId!==e.block?.rootID||a.isPreview===e.preview.element.classList.contains("fn__none"))){let i="";if(e&&e.block&&(i=e.block.rootID),i===a.blockId&&!n&&a.isPreview!==e.preview.element.classList.contains("fn__none"))return;E("/api/outline/getDocOutline",{id:i,preview:!e.preview.element.classList.contains("fn__none")},s=>{if(!(!n&&(!$E(i)||a.blockId===i)&&a.isPreview!==e.preview.element.classList.contains("fn__none")))if(a.isPreview=!e.preview.element.classList.contains("fn__none"),a.update(s,i),e){if(a.updateDocTitle(e.background.ial),getSelection().rangeCount>0){const o=getSelection().getRangeAt(0).startContainer;if(e.wysiwyg.element.contains(o)){const l=B(o,"data-node-id",null);l&&a.setCurrent(l)}}}else a.updateDocTitle()})}})},fb=(t,e)=>{e&&e.element.classList.contains("fn__none")||e&&!L(e.element,"layout__wnd--active")&&document.querySelector(".layout__wnd--active")||(t.graph.forEach(n=>{if(n.type!=="global"&&(!e||n.blockId!==e.block?.id)){if(n.type==="local"&&n.rootId!==e?.block?.rootID)return;let a="";if(e&&e.block&&(a=e.block.showAll?e.block.id:e.block.parentID),a===n.blockId)return;n.searchGraph(!0,a)}}),t.backlink.forEach(n=>{if(n.type==="local"&&n.rootId!==e?.block?.rootID)return;let a="";e&&e.block&&(a=e.block.showAll?e.block.id:e.block.parentID),a!==n.blockId&&(n.element.querySelector('.block__icon[data-type="refresh"] svg').classList.add("fn__rotate"),E("/api/ref/getBacklink2",{sort:n.status[a]?n.status[a].sort:"3",mSort:n.status[a]?n.status[a].mSort:"3",id:a||"",k:n.inputsElement[0].value,mk:n.inputsElement[1].value},i=>{if(!$E(a)||n.blockId===a){n.element.querySelector('.block__icon[data-type="refresh"] svg').classList.remove("fn__rotate");return}n.saveStatus(),n.blockId=a,n.render(i.data)}))}))},ea=(t,e)=>{if(t.startsWith("assets/")){E("/api/asset/resolveAssetPath",{path:t.replace(/\.pdf\?page=\d{1,}$/,".pdf")},a=>{e==="app"?ee.shell.openPath(a.data):e==="folder"&&Ja(a.data)});return}let n="";window.siyuan.config.system.os==="windows"?n=t.replace("file:///","").replace("file://\\","").replace("file://","").replace(/\//g,"\\"):n=t.replace("file://",""),n=n.replace(/\\\)/g,")").replace(/\\\(/g,"("),e==="app"?ee.shell.openPath(n):e==="folder"&&(window.siyuan.config.system.os==="windows"&&(n.startsWith("\\\\")||(n=n.replace(/\\\\/g,"\\"))),Ja(n))};class Hc{constructor(e){this.editors=[],this.id=K(),this.targetElement=e.targetElement,this.refDefs=e.refDefs,this.app=e.app,this.x=e.x,this.y=e.y,this.isBacklink=e.isBacklink,this.originalRefBlockIDs=e.originalRefBlockIDs,this.element=document.createElement("div"),this.element.classList.add("block__popover");const n=L(this.targetElement,"block__popover",!0);let a=1;n?(this.element.setAttribute("data-oid",n.getAttribute("data-oid")),a=parseInt(n.getAttribute("data-level"))+1):this.element.setAttribute("data-oid",this.refDefs[0].refID),this.element.setAttribute("data-level",a.toString());for(let i=0;i<window.siyuan.blockPanels.length;i++){const s=window.siyuan.blockPanels[i];s.element.getAttribute("data-pin")==="false"&&s.targetElement&&parseInt(s.element.getAttribute("data-level"))>=a&&(s.destroy(),i--)}document.body.insertAdjacentElement("beforeend",this.element),this.targetElement&&(this.targetElement.style.cursor="wait"),this.element.setAttribute("data-pin","false"),this.element.addEventListener("dblclick",i=>{const s=i.target,o=L(s,"block__icons");if(o){const l=o.querySelector('[data-type="pin"]');this.element.getAttribute("data-pin")==="true"?(l.setAttribute("aria-label",window.siyuan.languages.pin),l.querySelector("use").setAttribute("xlink:href","#iconPin"),this.element.setAttribute("data-pin","false")):(l.setAttribute("aria-label",window.siyuan.languages.unpin),l.querySelector("use").setAttribute("xlink:href","#iconUnpin"),this.element.setAttribute("data-pin","true")),i.preventDefault(),i.stopPropagation()}}),this.element.addEventListener("click",i=>{this.element&&window.siyuan.blockPanels.length>1&&(this.element.style.zIndex=(++window.siyuan.zIndex).toString());let s=i.target;for(;s&&!s.isEqualNode(this.element);){if(s.classList.contains("block__icon")||s.classList.contains("block__logo")){const o=s.getAttribute("data-type");o==="close"?this.destroy():o==="pin"?this.element.getAttribute("data-pin")==="true"?(s.setAttribute("aria-label",window.siyuan.languages.pin),s.querySelector("use").setAttribute("xlink:href","#iconPin"),this.element.setAttribute("data-pin","false")):(s.setAttribute("aria-label",window.siyuan.languages.unpin),s.querySelector("use").setAttribute("xlink:href","#iconUnpin"),this.element.setAttribute("data-pin","true")):o==="open"?Xr(this.refDefs[0].refID):o==="stickTab"&&(Ke(this.refDefs[0].refID,(l,r)=>{de({app:e.app,id:this.refDefs[0].refID,action:r,zoomIn:l,openNewTab:!0})}),this.destroy()),i.preventDefault(),i.stopPropagation();break}s=s.parentElement}}),vh(this.element,()=>{const i=this.element.firstElementChild.querySelector('[data-type="pin"]');i.setAttribute("aria-label",window.siyuan.languages.unpin),i.querySelector("use").setAttribute("xlink:href","#iconUnpin"),this.element.setAttribute("data-pin","true")}),this.render()}initProtyle(e,n){const a=parseInt(e.getAttribute("data-index"));E("/api/block/getBlockInfo",{id:this.refDefs[a].refID},i=>{if(i.code===3){j(i.msg);return}if(!this.targetElement&&typeof this.x>"u"&&typeof this.y>"u")return;const s=[];i.data.rootID!==this.refDefs[a].refID?s.push(u.CB_GET_ALL):s.push(u.CB_GET_CONTEXT),this.isBacklink&&s.push(u.CB_GET_BACKLINK);const o=new aa(this.app,e,{blockId:this.refDefs[a].refID,defIds:this.refDefs[a].defIDs||[],originalRefBlockIDs:this.isBacklink?this.originalRefBlockIDs:void 0,action:s,render:{scroll:!0,gutter:!0,breadcrumbDocName:!0},typewriterMode:!1,after:l=>{i.data.rootID!==this.refDefs[a].refID&&l.protyle.breadcrumb.element.parentElement.lastElementChild.classList.remove("fn__none"),n&&n(),(l.protyle.element.nextElementSibling||l.protyle.element.previousElementSibling)&&(l.protyle.element.style.minHeight=Math.min(30+l.protyle.wysiwyg.element.clientHeight,window.innerHeight/3)+"px"),l.protyle.scroll.element.parentElement.setAttribute("style",`--b3-dynamicscroll-width:${Math.min(l.protyle.contentElement.clientHeight-49,200)}px;`)}});this.editors.push(o)})}destroy(){this.observerResize?.disconnect(),this.observerLoad?.disconnect(),window.siyuan.blockPanels.find((a,i)=>{if(a.id===this.id)return window.siyuan.blockPanels.splice(i,1),!0}),this.editors.length>0&&(this.editors.forEach(a=>{Q(["util"],a.protyle),a.destroy()}),this.editors=[]);const e=parseInt(this.element.dataset.level);this.element.remove(),this.element=void 0,this.targetElement=void 0;const n=parseInt(window.siyuan.menus.menu.element.dataset.from);window.siyuan.menus.menu.element.dataset.from!=="app"&&n&&n>=e&&window.siyuan.menus.menu.remove()}render(){if(!document.body.contains(this.element)){this.destroy();return}let e="";this.refDefs.length===1&&(e=`<span data-type="stickTab" class="block__icon block__icon--show b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.openInNewTab} ${X(window.siyuan.config.keymap.editor.general.openInNewTab.custom)}"><svg><use xlink:href="#iconOpen"></use></svg></span>
<span class="fn__space"></span>`,e+=`<span data-type="open" class="block__icon block__icon--show b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.openByNewWindow}"><svg><use xlink:href="#iconOpenWindow"></use></svg></span>
<span class="fn__space"></span>`);let n=`<div class="block__icons block__icons--menu">
    <span class="fn__space fn__flex-1 resize__move"></span>${e}
    <span data-type="pin" class="block__icon block__icon--show b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.pin}"><svg><use xlink:href="#iconPin"></use></svg></span>
    <span class="fn__space"></span>
    <span data-type="close" class="block__icon block__icon--show b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.close}"><svg style="width: 12px;margin: 0 1px;"><use xlink:href="#iconClose"></use></svg></span>
</div>
<div class="block__content">`;this.refDefs.length===0?n+=`<div class="ft__smaller ft__smaller ft__secondary b3-form__space--small" contenteditable="false">${window.siyuan.languages.refExpired}</div>`:this.refDefs.forEach((i,s)=>{n+=`<div class="block__edit fn__flex-1 protyle" data-index="${s}"></div>`}),n&&(n+='</div><div class="resize__rd"></div><div class="resize__ld"></div><div class="resize__lt"></div><div class="resize__rt"></div><div class="resize__r"></div><div class="resize__d"></div><div class="resize__t"></div><div class="resize__l"></div>'),this.element.innerHTML=n;let a;this.observerResize=new ResizeObserver(()=>{clearTimeout(a),a=window.setTimeout(()=>{this.editors.forEach(i=>{Jt(i.protyle)})},u.TIMEOUT_TRANSITION)}),this.observerResize.observe(this.element),this.observerLoad=new IntersectionObserver(i=>{i.forEach(s=>{s.isIntersecting&&s.target.innerHTML===""&&this.initProtyle(s.target)})},{threshold:0}),this.element.querySelectorAll(".block__edit").forEach((i,s)=>{s<5?this.initProtyle(i,s===0?()=>{if(!document.contains(this.element))return;let o;if(this.targetElement&&this.targetElement.classList.contains("protyle-wysiwyg__embed")){o=this.targetElement.getBoundingClientRect();let r=o.top;const d=L(this.targetElement,"protyle-content",!0);if(d){const c=d.getBoundingClientRect().top;o.top<c&&(r=c)}this.element.style.height=Math.min(window.innerHeight-u.SIZE_TOOLBAR_HEIGHT,o.height+42)+"px",ke(this.element,o.left,Math.max(r-42,u.SIZE_TOOLBAR_HEIGHT),-42,0)}else this.targetElement?(this.targetElement.classList.contains("pdf__rect")?o=this.targetElement.firstElementChild.getBoundingClientRect():o=this.targetElement.getBoundingClientRect(),window.innerHeight-o.bottom-4>o.top+12&&(this.element.style.maxHeight=Math.floor(window.innerHeight-o.bottom-12)+"px"),ke(this.element,o.left,o.bottom+4,o.height+12,8)):typeof this.x=="number"&&typeof this.y=="number"&&(ke(this.element,this.x,this.y),this.element.style.maxHeight=Math.floor(window.innerHeight-Math.max(this.y,u.SIZE_TOOLBAR_HEIGHT)-12)+"px");const l=this.element.getBoundingClientRect();this.targetElement&&!this.targetElement.classList.contains("protyle-wysiwyg__embed")&&(l.top<o.top?this.element.style.maxHeight=Math.floor(o.top-l.top-8)+"px":this.element.style.maxHeight=Math.floor(window.innerHeight-l.top-8)+"px"),this.element.classList.add("block__popover--open"),this.element.style.zIndex=(++window.siyuan.zIndex).toString()}:void 0):this.observerLoad.observe(i)}),this.targetElement&&(this.targetElement.style.cursor=""),this.element.querySelector(".block__content").addEventListener("scroll",()=>{this.editors.forEach(i=>{Q(["gutter"],i.protyle)})})}}class ri extends Vn{constructor(e){super({app:e.app,id:e.tab.id,callback(){this.type==="local"&&E("/api/block/checkBlockExist",{id:this.blockId},a=>{a.data||this.parent.parent.removeTab(this.parent.id)})},msgCallback(a){if(a)switch(a.cmd){case"mount":this.type==="global"&&a.code!==1&&this.searchGraph(!1);break;case"rename":this.graphData&&a.data.box===this.graphData.box&&this.rootId===a.data.id&&(this.searchGraph(!1),this.type==="local"&&this.parent.updateTitle(a.data.title)),this.type==="global"&&this.searchGraph(!1);break;case"unmount":this.type==="local"&&this.graphData&&this.graphData.box===a.data.box&&this.parent.parent.removeTab(this.parent.id);break;case"removeDoc":this.type==="local"&&a.data.ids.includes(this.rootId)&&this.parent.parent.removeTab(this.parent.id);break}}}),this.element=e.tab.panelElement,this.blockId=e.blockId,this.rootId=e.rootId,this.type=e.type,this.element.classList.add("graph","file-tree",this.type==="global"?"sy__globalGraph":"sy__graph");let n;this.type==="global"?n=`
<label>
    <span>${window.siyuan.languages.headings}</span> 
    <input data-type="heading" type="checkbox" class="b3-switch"${window.siyuan.config.graph.global.type.heading?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.list1}</span> 
    <input data-type="list" type="checkbox" class="b3-switch"${window.siyuan.config.graph.global.type.list?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.listItem}</span> 
    <input data-type="listItem" type="checkbox" class="b3-switch"${window.siyuan.config.graph.global.type.listItem?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.quote}</span> 
    <input data-type="blockquote" type="checkbox" class="b3-switch"${window.siyuan.config.graph.global.type.blockquote?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.superBlock}</span> 
    <input data-type="super" type="checkbox" class="b3-switch"${window.siyuan.config.graph.global.type.super?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.table}</span> 
    <input data-type="table" type="checkbox" class="b3-switch"${window.siyuan.config.graph.global.type.table?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.math}</span> 
    <input data-type="math" type="checkbox" class="b3-switch"${window.siyuan.config.graph.global.type.math?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.code}</span> 
    <input data-type="code" type="checkbox" class="b3-switch"${window.siyuan.config.graph.global.type.code?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.paragraph}</span> 
    <input data-type="paragraph" type="checkbox" class="b3-switch"${window.siyuan.config.graph.global.type.paragraph?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.dailyNote}</span>  
    <input data-type="dailyNote" type="checkbox" class="b3-switch"${window.siyuan.config.graph.global.dailyNote?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.tag}</span>  
    <input data-type="tag" type="checkbox" class="b3-switch"${window.siyuan.config.graph.global.type.tag?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.arrow}</span> 
    <input data-type="arrow" type="checkbox" class="b3-switch"${window.siyuan.config.graph.global.d3.arrow?" checked":""}/>
</label>
<label> 
    <span>${window.siyuan.languages.graphConfig2}</span>  
    <input data-type="minRefs" class="b3-slider b3-tooltips__n b3-tooltips" max="16" min="0" step="1" type="range" value="${window.siyuan.config.graph.global.minRefs}" aria-label="${window.siyuan.config.graph.global.minRefs}" />
</label>
<label>
    <span>${window.siyuan.languages.nodeSize}</span> 
    <input data-type="nodeSize" class="b3-slider b3-tooltips__n b3-tooltips" aria-label="${window.siyuan.config.graph.global.d3.nodeSize}" max="32" min="4" step="2" type="range" value="${window.siyuan.config.graph.global.d3.nodeSize}" />
</label>
<label>
    <span>${window.siyuan.languages.lineWidth}</span> 
    <input data-type="linkWidth" class="b3-tooltips b3-tooltips__n b3-slider" max="32" min="4" step="2" type="range" value="${window.siyuan.config.graph.global.d3.linkWidth}" aria-label="${window.siyuan.config.graph.global.d3.linkWidth}"/>
</label>
<label>
    <span>${window.siyuan.languages.lineOpacity}</span> 
    <input data-type="lineOpacity" class="b3-tooltips b3-tooltips__n b3-slider" max="1" min="0.1" step="0.01" type="range" value="${window.siyuan.config.graph.global.d3.lineOpacity}" aria-label="${window.siyuan.config.graph.global.d3.lineOpacity}"/>
</label>
<label>
    <span>${window.siyuan.languages.centerStrength}</span> 
    <input data-type="centerStrength" class="b3-tooltips b3-tooltips__n b3-slider" max="0.1" min="0.005" step="0.01" type="range" value="${window.siyuan.config.graph.global.d3.centerStrength}" aria-label="${window.siyuan.config.graph.global.d3.centerStrength}"/>
</label>
<label>
    <span>${window.siyuan.languages.collideRadius}</span> 
    <input data-type="collideRadius" class="b3-tooltips b3-tooltips__n b3-slider" max="5000" min="400" step="200" type="range" value="${window.siyuan.config.graph.global.d3.collideRadius}" aria-label="${window.siyuan.config.graph.global.d3.collideRadius}"/>
</label>
<label>
    <span>${window.siyuan.languages.collideStrength}</span> 
    <input data-type="collideStrength" class="b3-tooltips b3-tooltips__n b3-slider" max="1" min="0.01" step="0.01" type="range" value="${window.siyuan.config.graph.global.d3.collideStrength}" aria-label="${window.siyuan.config.graph.global.d3.collideStrength}"/>
</label>
<label>
    <span>${window.siyuan.languages.linkDistance}</span> 
    <input data-type="linkDistance" class="b3-tooltips b3-tooltips__n b3-slider" max="2000" min="100" step="100" type="range" value="${window.siyuan.config.graph.global.d3.linkDistance}" aria-label="${window.siyuan.config.graph.global.d3.linkDistance}"/>
</label>
<div class="fn__hr"></div>
<button class="b3-button b3-button--small fn__block">${window.siyuan.languages.reset}</button>`:n=`
<label>
    <span>${window.siyuan.languages.headings}</span> 
    <input data-type="heading" type="checkbox" class="b3-switch"${window.siyuan.config.graph.local.type.heading?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.list1}</span> 
    <input data-type="list" type="checkbox" class="b3-switch"${window.siyuan.config.graph.local.type.list?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.listItem}</span> 
    <input data-type="listItem" type="checkbox" class="b3-switch"${window.siyuan.config.graph.local.type.listItem?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.quote}</span> 
    <input data-type="blockquote" type="checkbox" class="b3-switch"${window.siyuan.config.graph.local.type.blockquote?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.superBlock}</span> 
    <input data-type="super" type="checkbox" class="b3-switch"${window.siyuan.config.graph.local.type.super?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.table}</span> 
    <input data-type="table" type="checkbox" class="b3-switch"${window.siyuan.config.graph.local.type.table?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.math}</span> 
    <input data-type="math" type="checkbox" class="b3-switch"${window.siyuan.config.graph.local.type.math?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.code}</span> 
    <input data-type="code" type="checkbox" class="b3-switch"${window.siyuan.config.graph.local.type.code?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.paragraph}</span> 
    <input data-type="paragraph" type="checkbox" class="b3-switch"${window.siyuan.config.graph.local.type.paragraph?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.dailyNote}</span>  
    <input data-type="dailyNote" type="checkbox" class="b3-switch"${window.siyuan.config.graph.local.dailyNote?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.tag}</span>  
    <input data-type="tag" type="checkbox" class="b3-switch"${window.siyuan.config.graph.local.type.tag?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.arrow}</span> 
    <input data-type="arrow" type="checkbox" class="b3-switch"${window.siyuan.config.graph.local.d3.arrow?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.nodeSize}</span> 
    <input data-type="nodeSize" class="b3-slider b3-tooltips__n b3-tooltips" aria-label="${window.siyuan.config.graph.local.d3.nodeSize}" max="32" min="4" step="2" type="range" value="${window.siyuan.config.graph.local.d3.nodeSize}" />
</label>
<label>
    <span>${window.siyuan.languages.lineWidth}</span> 
    <input data-type="linkWidth" class="b3-tooltips b3-tooltips__n b3-slider" max="32" min="4" step="2" type="range" value="${window.siyuan.config.graph.local.d3.linkWidth}" aria-label="${window.siyuan.config.graph.local.d3.linkWidth}"/>
</label>
<label>
    <span>${window.siyuan.languages.lineOpacity}</span> 
    <input data-type="lineOpacity" class="b3-tooltips b3-tooltips__n b3-slider" max="1" min="0.1" step="0.01" type="range" value="${window.siyuan.config.graph.local.d3.lineOpacity}" aria-label="${window.siyuan.config.graph.local.d3.lineOpacity}"/>
</label>
<label>
    <span>${window.siyuan.languages.centerStrength}</span> 
    <input data-type="centerStrength" class="b3-tooltips b3-tooltips__n b3-slider" max="0.1" min="0.005" step="0.01" type="range" value="${window.siyuan.config.graph.local.d3.centerStrength}" aria-label="${window.siyuan.config.graph.local.d3.centerStrength}"/>
</label>
<label>
    <span>${window.siyuan.languages.collideRadius}</span> 
    <input data-type="collideRadius" class="b3-tooltips b3-tooltips__n b3-slider" max="5000" min="400" step="200" type="range" value="${window.siyuan.config.graph.local.d3.collideRadius}" aria-label="${window.siyuan.config.graph.local.d3.collideRadius}"/>
</label>
<label>
    <span>${window.siyuan.languages.collideStrength}</span> 
    <input data-type="collideStrength" class="b3-tooltips b3-tooltips__n b3-slider" max="1" min="0.01" step="0.01" type="range" value="${window.siyuan.config.graph.local.d3.collideStrength}" aria-label="${window.siyuan.config.graph.local.d3.collideStrength}"/>
</label>
<label>
    <span>${window.siyuan.languages.linkDistance}</span> 
    <input data-type="linkDistance" class="b3-tooltips b3-tooltips__n b3-slider" max="2000" min="100" step="100" type="range" value="${window.siyuan.config.graph.local.d3.linkDistance}" aria-label="${window.siyuan.config.graph.local.d3.linkDistance}"/>
</label>
<div class="fn__hr"></div>
<button class="b3-button b3-button--small fn__block">${window.siyuan.languages.reset}</button>`,this.element.innerHTML=`<div class="block__icons"> 
    <div class="block__logo">
        <svg class="block__logoicon"><use xlink:href="#icon${this.type==="global"?"GlobalGraph":"Graph"}"></use></svg>${this.type==="global"?window.siyuan.languages.globalGraph:window.siyuan.languages.graphView}
    </div>
    <span class="fn__flex-1"></span>
    <span class="fn__space"></span>
    <input class="b3-text-field search__label fn__size200 fn__none" placeholder="${window.siyuan.languages.search}" />
    <span data-type="search" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.search}"><svg><use xlink:href='#iconFilter'></use></svg></span>
    <span class="fn__space"></span>
    <span data-type="refresh" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.refresh}"><svg><use xlink:href='#iconRefresh'></use></svg></span>
    <div class="fn__space"></div>
    <div data-type="fullscreen" class="b3-tooltips b3-tooltips__sw block__icon" aria-label="${window.siyuan.languages.fullscreen}">
        <svg><use xlink:href="#iconFullscreen"></use></svg>
    </div>
    <div class="fn__space"></div>
    <div data-type="menu" class="b3-tooltips b3-tooltips__sw block__icon" aria-label="${window.siyuan.languages.more}">
        <svg><use xlink:href="#iconMore"></use></svg>
    </div> 
    <span class="${this.type==="local"?"fn__none ":""}fn__space"></span>
    <span data-type="min"  class="${this.type==="local"?"fn__none ":""}block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.min} ${X(window.siyuan.config.keymap.general.closeTab.custom)}"><svg><use xlink:href='#iconMin'></use></svg></span>
</div>
<div class="graph__panel">
    ${n}
</div>
<div class="fn__flex-1 graph__svg"></div>`,this.graphElement=this.element.querySelector(".graph__svg"),this.inputElement=this.element.querySelector("input"),this.panelElement=this.element.querySelector(".graph__panel"),this.element.addEventListener("click",a=>{this.type==="local"?tt(this.element.parentElement.parentElement):tt(this.element);let i=a.target;for(;i&&!i.isEqualNode(this.element);){if(i.classList.contains("b3-button")){this.type==="global"?E("/api/graph/resetGraph",{},s=>{this.reset(s.data.conf)}):E("/api/graph/resetLocalGraph",{},s=>{this.reset(s.data.conf)});break}else if(i.classList.contains("block__icon")){const s=i.getAttribute("data-type");if(s==="min")Qe(this.type==="global"?"globalGraph":"graph").toggleModel(this.type==="global"?"globalGraph":"graph",!1,!0);else if(s==="menu")i.classList.contains("ft__primary")?(i.classList.remove("ft__primary"),this.panelElement.style.right=""):(i.classList.add("ft__primary"),this.panelElement.style.right="0");else if(s==="search")i.previousElementSibling.classList.remove("fn__none"),i.previousElementSibling.select();else if(s==="refresh")this.searchGraph(!1,void 0,!0);else if(s==="fullscreen"){to(this.element,i);const o=this.element.querySelector('.block__icons .block__icon[data-type="min"]');this.element.className.includes("fullscreen")?o.classList.add("fn__none"):o.classList.remove("fn__none")}break}else if(i.classList.contains("graph__svg")){this.element.querySelectorAll(".block__icon.ft__primary").forEach(s=>{s.classList.remove("ft__primary")}),this.panelElement.style.right="";break}i=i.parentElement}}),this.inputElement.addEventListener("compositionend",()=>{this.searchGraph(!1),this.inputElement.classList.add("search__input--block")}),this.inputElement.addEventListener("blur",a=>{a.target.classList.add("fn__none")}),this.inputElement.addEventListener("input",a=>{a.isComposing||(this.inputElement.value===""?this.inputElement.classList.remove("search__input--block"):this.inputElement.classList.add("search__input--block"),this.searchGraph(!1))}),this.element.querySelectorAll(".b3-slider").forEach(a=>{a.addEventListener("input",()=>{a.setAttribute("aria-label",a.value),this.searchGraph(!1)})}),this.element.querySelectorAll(".b3-switch").forEach(a=>{a.addEventListener("change",()=>{this.searchGraph(!1)})}),this.searchGraph(e.type!=="global")}reset(e){this.type==="global"?(window.siyuan.config.graph.global=e,this.panelElement.querySelector("[data-type='minRefs']").setAttribute("aria-label",window.siyuan.config.graph.global.minRefs.toString()),this.panelElement.querySelector("[data-type='minRefs']").value=window.siyuan.config.graph.global.minRefs.toString()):window.siyuan.config.graph.local=e,this.inputElement.value="",this.panelElement.querySelector("[data-type='nodeSize']").setAttribute("aria-label",e.d3.nodeSize.toString()),this.panelElement.querySelector("[data-type='centerStrength']").setAttribute("aria-label",e.d3.centerStrength.toString()),this.panelElement.querySelector("[data-type='collideRadius']").setAttribute("aria-label",e.d3.collideRadius.toString()),this.panelElement.querySelector("[data-type='collideStrength']").setAttribute("aria-label",e.d3.collideStrength.toString()),this.panelElement.querySelector("[data-type='lineOpacity']").setAttribute("aria-label",e.d3.lineOpacity.toString()),this.panelElement.querySelector("[data-type='linkDistance']").setAttribute("aria-label",e.d3.linkDistance.toString()),this.panelElement.querySelector("[data-type='linkWidth']").setAttribute("aria-label",e.d3.linkWidth.toString()),this.panelElement.querySelector("[data-type='nodeSize']").value=e.d3.nodeSize.toString(),this.panelElement.querySelector("[data-type='centerStrength']").value=e.d3.centerStrength.toString(),this.panelElement.querySelector("[data-type='collideRadius']").value=e.d3.collideRadius.toString(),this.panelElement.querySelector("[data-type='collideStrength']").value=e.d3.collideStrength.toString(),this.panelElement.querySelector("[data-type='lineOpacity']").value=e.d3.lineOpacity.toString(),this.panelElement.querySelector("[data-type='linkDistance']").value=e.d3.linkDistance.toString(),this.panelElement.querySelector("[data-type='linkWidth']").value=e.d3.linkWidth.toString(),this.panelElement.querySelector("[data-type='list']").checked=e.type.list,this.panelElement.querySelector("[data-type='listItem']").checked=e.type.listItem,this.panelElement.querySelector("[data-type='math']").checked=e.type.math,this.panelElement.querySelector("[data-type='paragraph']").checked=e.type.paragraph,this.panelElement.querySelector("[data-type='super']").checked=e.type.super,this.panelElement.querySelector("[data-type='table']").checked=e.type.table,this.panelElement.querySelector("[data-type='tag']").checked=e.type.tag,this.panelElement.querySelector("[data-type='dailyNote']").checked=e.dailyNote,this.panelElement.querySelector("[data-type='heading']").checked=e.type.heading,this.panelElement.querySelector("[data-type='arrow']").checked=e.d3.arrow,this.panelElement.querySelector("[data-type='blockquote']").checked=e.type.blockquote,this.panelElement.querySelector("[data-type='code']").checked=e.type.code,this.searchGraph(!1)}searchGraph(e,n,a=!1){const i=this.element.querySelector('.block__icon[data-type="refresh"] svg');if(i.classList.contains("fn__rotate")&&!n)return;i.classList.add("fn__rotate");const s={list:this.panelElement.querySelector("[data-type='list']").checked,listItem:this.panelElement.querySelector("[data-type='listItem']").checked,math:this.panelElement.querySelector("[data-type='math']").checked,paragraph:this.panelElement.querySelector("[data-type='paragraph']").checked,super:this.panelElement.querySelector("[data-type='super']").checked,table:this.panelElement.querySelector("[data-type='table']").checked,tag:this.panelElement.querySelector("[data-type='tag']").checked,heading:this.panelElement.querySelector("[data-type='heading']").checked,blockquote:this.panelElement.querySelector("[data-type='blockquote']").checked,code:this.panelElement.querySelector("[data-type='code']").checked},o={arrow:this.panelElement.querySelector("[data-type='arrow']").checked,nodeSize:parseFloat(this.panelElement.querySelector("[data-type='nodeSize']").value),centerStrength:parseFloat(this.panelElement.querySelector("[data-type='centerStrength']").value),collideRadius:parseFloat(this.panelElement.querySelector("[data-type='collideRadius']").value),collideStrength:parseFloat(this.panelElement.querySelector("[data-type='collideStrength']").value),lineOpacity:parseFloat(this.panelElement.querySelector("[data-type='lineOpacity']").value),linkDistance:parseFloat(this.panelElement.querySelector("[data-type='linkDistance']").value),linkWidth:parseFloat(this.panelElement.querySelector("[data-type='linkWidth']").value)};this.type==="global"?E("/api/graph/getGraph",{k:this.inputElement.value,conf:{type:s,d3:o,dailyNote:this.panelElement.querySelector("[data-type='dailyNote']").checked,minRefs:parseFloat(this.panelElement.querySelector("[data-type='minRefs']").value)}},l=>{this.graphData=l.data,window.siyuan.config.graph.global=l.data.conf,this.onGraph(!1),i.classList.remove("fn__rotate")}):E("/api/graph/getLocalGraph",{type:this.type,k:this.inputElement.value,id:n||this.blockId,conf:{type:s,d3:o,dailyNote:this.panelElement.querySelector("[data-type='dailyNote']").checked}},l=>{i.classList.remove("fn__rotate"),n&&(this.blockId=n),!(!a&&this.type==="pin"&&this.blockId&&!Array.from(document.querySelectorAll(".fn__flex > .layout-tab-bar > .item--focus")).find(d=>{const c=Bt(d.getAttribute("data-id"));if(c instanceof ut&&c.model instanceof ht&&(c.model.editor.protyle.block.rootID===this.blockId||c.model.editor.protyle.block.parentID===this.blockId||c.model.editor.protyle.block.id===this.blockId))return!0}))&&(this.graphData=l.data,window.siyuan.config.graph.local=l.data.conf,this.onGraph(e))})}hlNode(e){this.graphElement.clientHeight===0||!this.network||this.network.findNode(e).length===0||(this.network.focus(e,{animation:{duration:1e3,easingFunction:"easeInOutQuad"}}),this.network.selectNodes([e]))}destroy(){this.network?.destroy()}onGraph(e){if(this.graphElement.clientHeight===0||(this.network?.destroy(),!this.graphData||!this.graphData.nodes||this.graphData.nodes.length===0))return;const n=getComputedStyle(document.body);this.graphData.nodes.forEach(a=>{switch(a.type){case"NodeDocument":a.color={background:n.getPropertyValue("--b3-graph-doc-point").trim()};break;case"NodeParagraph":a.color={background:n.getPropertyValue("--b3-graph-p-point").trim()};break;case"NodeHeading":a.color={background:n.getPropertyValue("--b3-graph-heading-point").trim()};break;case"NodeMathBlock":a.color={background:n.getPropertyValue("--b3-graph-math-point").trim()};break;case"NodeCodeBlock":a.color={background:n.getPropertyValue("--b3-graph-code-point").trim()};break;case"NodeTable":a.color={background:n.getPropertyValue("--b3-graph-table-point").trim()};break;case"NodeList":a.color={background:n.getPropertyValue("--b3-graph-list-point").trim()};break;case"NodeListItem":a.color={background:n.getPropertyValue("--b3-graph-listitem-point").trim()};break;case"NodeBlockquote":a.color={background:n.getPropertyValue("--b3-graph-bq-point").trim()};break;case"NodeSuperBlock":a.color={background:n.getPropertyValue("--b3-graph-super-point").trim()};break;case"tag":case"textmark tag":a.color={background:n.getPropertyValue("--b3-graph-tag-point").trim()};break;default:a.color={background:n.getPropertyValue("--b3-graph-p-point").trim()};break}}),this.graphData.links.forEach(a=>{a.ref?a.color={color:n.getPropertyValue("--b3-graph-ref-line").trim()}:a.color={color:n.getPropertyValue("--b3-graph-line").trim()}}),Ct(`${u.PROTYLE_CDN}/js/vis/vis-network.min.js?v=9.1.2`,"protyleVisScript").then(()=>{if(this.network?.destroy(),!this.graphData||!this.graphData.nodes||this.graphData.nodes.length===0)return;const a=window.siyuan.config.graph[this.type==="global"?"global":"local"],i=32<this.graphData.nodes.length?.1:.5;let s=this.graphData.nodes.length;this.graphData.nodes.length>1024&&(s=1024),this.graphData.nodes.length<256&&(s=256);let o=this.graphData.nodes.length;this.graphData.nodes.length>64&&(o=64),this.graphData.nodes.length<16&&(o=8);const l={autoResize:!0,interaction:{hover:!0},nodes:{borderWidth:0,borderWidthSelected:5,shape:"dot",font:{face:n.getPropertyValue("--b3-font-family-graph").trim(),size:32,color:n.getPropertyValue("--b3-theme-on-background").trim()},color:{hover:{border:n.getPropertyValue("--b3-graph-hl-point").trim(),background:n.getPropertyValue("--b3-graph-hl-point").trim()},highlight:{border:n.getPropertyValue("--b3-graph-hl-point").trim(),background:n.getPropertyValue("--b3-graph-hl-point").trim()}}},edges:{width:a.d3.linkWidth,arrowStrikethrough:!1,smooth:!1,color:{opacity:a.d3.lineOpacity,hover:n.getPropertyValue("--b3-graph-hl-line").trim(),highlight:n.getPropertyValue("--b3-graph-hl-line").trim()}},layout:{randomSeed:0,improvedLayout:!1},physics:{enabled:!0,forceAtlas2Based:{theta:.5,gravitationalConstant:-a.d3.collideRadius,centralGravity:a.d3.centerStrength,springConstant:a.d3.collideStrength,springLength:a.d3.linkDistance,damping:.4,avoidOverlap:.5},maxVelocity:s,minVelocity:o,solver:"forceAtlas2Based",stabilization:{enabled:!0,iterations:64,updateInterval:64,onlyDynamicEdges:!1,fit:!0},timestep:i,adaptiveTimestep:!0,wind:{x:0,y:0}}};let r=Math.max(Math.ceil(this.graphData.nodes.length*.1),128),d=Math.max(Math.ceil(this.graphData.links.length*.1),128);const c=new vis.DataSet(this.graphData.nodes.slice(0,r)),f=new vis.DataSet(this.graphData.links.slice(0,d)),g=new vis.Network(this.graphElement,{nodes:c,edges:f},l),p=Math.max(.03,1-.3*Math.floor(this.graphData.nodes.length/128));p!==1&&g.moveTo({position:{x:0,y:0},scale:p,animation:!1});const h=256,m=Math.max(Math.ceil(h/8),32);let b=this.graphData.nodes.length/h/2;b<64&&(b=64),b>256&&(b=256);const y=setInterval(()=>{if(!g.images){clearInterval(w);return}const _=this.graphData.nodes.slice(r,r+b);if(_.length===0){clearInterval(y);return}g.body.data.nodes.add(_),r+=b},m),w=setInterval(()=>{if(!g.images){clearInterval(w);return}const _=this.graphData.links.slice(d,d+b);if(_.length===0){clearInterval(w),g.fit({animation:!0});return}g.body.data.edges.add(_),d+=b},h);this.network=g,g.on("stabilizationIterationsDone",()=>{g.physics.stopSimulation(),e&&this.hlNode(this.blockId)}),g.on("dragEnd",()=>{setTimeout(()=>{g.physics.stopSimulation()},3e3)}),g.on("click",_=>{if(_.nodes.length!==1)return;const x=this.graphData.nodes.find(S=>S.id===_.nodes[0]);if(x){if(-1<x.type.indexOf("tag")){ti(this.app,`#${x.id}#`,!window.siyuan.ctrlIsPressed,{method:0});return}window.siyuan.shiftIsPressed?Ke(x.id,(S,k)=>{de({app:this.app,id:x.id,position:"bottom",action:k,zoomIn:S})}):window.siyuan.altIsPressed?Ke(x.id,(S,k)=>{de({app:this.app,id:x.id,position:"right",action:k,zoomIn:S})}):window.siyuan.ctrlIsPressed?window.siyuan.blockPanels.push(new Hc({app:this.app,isBacklink:!1,x:_.event.center.x,y:_.event.center.y,refDefs:[{refID:x.id}]})):Ke(x.id,(S,k)=>{de({app:this.app,id:x.id,action:k,zoomIn:S})})}})})}}const ME=(t,e,n)=>{if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="bookmarkMenu"){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove();const a=t.getAttribute("data-node-id");!a&&!window.siyuan.config.readonly&&window.siyuan.menus.menu.append(new T({id:"rename",icon:"iconEdit",label:window.siyuan.languages.rename,click:()=>{const i=t.querySelector(".b3-list-item__text").textContent,s=new we({title:window.siyuan.languages.rename,content:`<div class="b3-dialog__content"><input class="b3-text-field fn__block"></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:W()?"92vw":"520px"});s.element.setAttribute("data-key",u.DIALOG_RENAMEBOOKMARK);const o=s.element.querySelectorAll(".b3-button");o[0].addEventListener("click",()=>{s.destroy()});const l=s.element.querySelector("input");s.bindInput(l,()=>{o[1].click()}),l.value=i,l.focus(),l.select(),o[1].addEventListener("click",()=>{E("/api/bookmark/renameBookmark",{oldBookmark:i,newBookmark:l.value},()=>{s.destroy()})})}}).element),a&&window.siyuan.menus.menu.append(new T({id:"copy",label:window.siyuan.languages.copy,type:"submenu",icon:"iconCopy",submenu:ls([t.getAttribute("data-node-id")],!1)}).element),window.siyuan.config.readonly||window.siyuan.menus.menu.append(new T({id:"remove",icon:"iconTrashcan",label:window.siyuan.languages.remove,click:()=>{const i=t.querySelector(".b3-list-item__text").textContent;xe(window.siyuan.languages.deleteOpConfirm,window.siyuan.languages.removeBookmark.replace("${x}",`<b>${pe(i)}</b>`),()=>{a?(E("/api/attr/setBlockAttrs",{id:a,attrs:{bookmark:""}},()=>{n.update()}),document.querySelectorAll(`.protyle-wysiwyg [data-node-id="${a}"]`).forEach(s=>{s.setAttribute("bookmark","");const o=s.querySelector(".protyle-attr--bookmark");o&&o.remove()})):E("/api/bookmark/removeBookmark",{bookmark:i})},void 0,!0)}}).element),window.siyuan.menus.menu.element.setAttribute("data-name","bookmarkMenu"),window.siyuan.menus.menu.popup({x:e.clientX-11,y:e.clientY+11,h:22,w:12})};class vo extends Vn{constructor(e,n){super({app:e,id:n.id,msgCallback(a){if(a)switch(a.cmd){case"transactions":a.data[0].doOperations.forEach(i=>{let s=!1;((i.action==="update"||i.action==="insert")&&i.data.indexOf('class="protyle-attr--bookmark"')>-1||i.action==="delete")&&(s=!0),s&&E("/api/bookmark/getBookmark",{},o=>{this.update(o.data)})});break;case"unmount":case"removeDoc":case"mount":(a.cmd!=="mount"||a.code!==1)&&E("/api/bookmark/getBookmark",{},i=>{this.update(i.data)});break}}}),this.element=n.panelElement,this.element.classList.add("fn__flex-column","file-tree","sy__bookmark"),this.element.innerHTML=`<div class="block__icons">
    <div class="block__logo">
        <svg class="block__logoicon"><use xlink:href="#iconBookmark"></use></svg>${window.siyuan.languages.bookmark}
    </div>
    <span class="fn__flex-1"></span>
    <span class="fn__space"></span>
    <span data-type="refresh" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.refresh}"><svg><use xlink:href='#iconRefresh'></use></svg></span>
    <span class="fn__space"></span>
    <span data-type="expand" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.expand} ${X(window.siyuan.config.keymap.editor.general.expand.custom)}">
        <svg><use xlink:href="#iconExpand"></use></svg>
    </span>
    <span class="fn__space"></span>
    <span data-type="collapse" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.collapse} ${X(window.siyuan.config.keymap.editor.general.collapse.custom)}">
        <svg><use xlink:href="#iconContract"></use></svg>
    </span>
    <span class="fn__space"></span>
    <span data-type="min" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.min} ${X(window.siyuan.config.keymap.general.closeTab.custom)}"><svg><use xlink:href='#iconMin'></use></svg></span>
</div>
<div class="fn__flex-1" style="margin-bottom: 8px"></div>`,this.tree=new ec({element:this.element.lastElementChild,data:null,click:(a,i)=>{if(i){const o=L(i.target,"b3-list-item__action");if(o){ME(o.parentElement,i,this);return}}const s=a.getAttribute("data-node-id");Ke(s,(o,l)=>{de({app:e,id:s,action:l,zoomIn:o})})},rightClick:(a,i)=>{ME(a,i,this)},ctrlClick:a=>{const i=a.getAttribute("data-node-id");Ke(i,s=>{de({app:e,id:i,keepCursor:!0,action:s?[u.CB_GET_HL,u.CB_GET_ALL]:[u.CB_GET_HL,u.CB_GET_CONTEXT,u.CB_GET_ROOTSCROLL],zoomIn:s})})},altClick:a=>{const i=a.getAttribute("data-node-id");Ke(i,(s,o)=>{de({app:e,id:i,position:"bottom",action:o,zoomIn:s})})},shiftClick:a=>{const i=a.getAttribute("data-node-id");Ke(i,(s,o)=>{de({app:e,id:i,position:"bottom",action:o,zoomIn:s})})},blockExtHTML:'<span class="b3-list-item__action"><svg><use xlink:href="#iconMore"></use></svg></span>',topExtHTML:'<span class="b3-list-item__action"><svg><use xlink:href="#iconMore"></use></svg></span>'}),this.element.querySelector('[data-type="collapse"]').addEventListener("click",()=>{this.tree.collapseAll()}),this.element.querySelector('[data-type="expand"]').addEventListener("click",()=>{this.tree.expandAll()}),this.element.addEventListener("click",a=>{tt(this.element);let i=a.target;for(;i&&!i.isEqualNode(this.element);){if(i.classList.contains("block__icon"))switch(i.getAttribute("data-type")){case"min":Qe("bookmark").toggleModel("bookmark",!1,!0);break;case"refresh":this.update();break}i=i.parentElement}}),this.update()}update(){const e=this.element.querySelector('.block__icon[data-type="refresh"] svg');e.classList.contains("fn__rotate")||(e.classList.add("fn__rotate"),E("/api/bookmark/getBookmark",{},n=>{this.openNodes&&(this.openNodes=this.tree.getExpandIds()),this.tree.updateData(n.data),this.openNodes?this.tree.setExpandIds(this.openNodes):this.openNodes=this.tree.getExpandIds(),e.classList.remove("fn__rotate")}))}}const PE=(t,e,n)=>{if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="tagMenu"){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.append(new T({icon:"iconEdit",label:window.siyuan.languages.rename,click:()=>{gw(n)}}).element),window.siyuan.menus.menu.append(new T({icon:"iconTrashcan",label:window.siyuan.languages.remove,click:()=>{xe(window.siyuan.languages.deleteOpConfirm,`${window.siyuan.languages.confirmDelete} <b>${pe(n)}</b>?`,()=>{E("/api/tag/removeTag",{label:n})},void 0,!0)}}).element),window.siyuan.menus.menu.element.setAttribute("data-name","tagMenu"),window.siyuan.menus.menu.popup({x:e.clientX-11,y:e.clientY+11,h:22,w:12})};class Eo extends Vn{constructor(e,n){super({app:e,id:n.id,msgCallback(a){if(a)switch(a.cmd){case"transactions":a.data[0].doOperations.forEach(i=>{let s=!1;((i.action==="update"||i.action==="insert")&&i.data.indexOf('data-type="tag"')>-1||i.action==="delete")&&(s=!0),s&&this.update()});break;case"unmount":case"removeDoc":case"mount":(a.cmd!=="mount"||a.code!==1)&&this.update();break}}}),this.element=n.panelElement,this.element.classList.add("fn__flex-column","file-tree","sy__tag"),this.element.innerHTML=`<div class="block__icons">
    <div class="block__logo">
        <svg class="block__logoicon"><use xlink:href="#iconTags"></use></svg>${window.siyuan.languages.tag}
    </div>
    <span class="fn__flex-1"></span>
    <span class="fn__space"></span>
    <span data-type="refresh" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.refresh}"><svg><use xlink:href='#iconRefresh'></use></svg></span>
    <span class="fn__space"></span>
    <span data-type="sort" class="block__icon b3-tooltips b3-tooltips__sw${window.siyuan.config.readonly?" fn__none":""}" aria-label="${window.siyuan.languages.sort}">
        <svg><use xlink:href="#iconSort"></use></svg>
    </span>
    <span class="fn__space${window.siyuan.config.readonly?" fn__none":""}"></span>
    <span data-type="expand" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.expand} ${X(window.siyuan.config.keymap.editor.general.expand.custom)}">
        <svg><use xlink:href="#iconExpand"></use></svg>
    </span>
    <span class="fn__space"></span>
    <span data-type="collapse" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.collapse} ${X(window.siyuan.config.keymap.editor.general.collapse.custom)}">
        <svg><use xlink:href="#iconContract"></use></svg>
    </span>
    <span class="fn__space"></span>
    <span data-type="min" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.min} ${X(window.siyuan.config.keymap.general.closeTab.custom)}"><svg><use xlink:href='#iconMin'></use></svg></span>
</div>
<div class="fn__flex-1" style="margin-bottom: 8px"></div>`,this.tree=new ec({element:this.element.lastElementChild,data:null,click(a,i){const s=a.getAttribute("data-label");if(i){const o=L(i.target,"b3-list-item__action");if(o){PE(o.parentElement,i,s);return}}ti(e,`#${a.getAttribute("data-label")}#`,!window.siyuan.ctrlIsPressed,{method:0})},rightClick:(a,i)=>{PE(a,i,a.getAttribute("data-label"))},blockExtHTML:window.siyuan.config.readonly?void 0:'<span class="b3-list-item__action"><svg><use xlink:href="#iconMore"></use></svg></span>',topExtHTML:window.siyuan.config.readonly?void 0:'<span class="b3-list-item__action"><svg><use xlink:href="#iconMore"></use></svg></span>'}),this.element.querySelector('[data-type="collapse"]').addEventListener("click",()=>{this.tree.collapseAll()}),this.element.querySelector('[data-type="expand"]').addEventListener("click",()=>{this.tree.expandAll()}),this.element.addEventListener("click",a=>{tt(this.element);let i=a.target;for(;i&&!i.isEqualNode(this.element);){if(i.classList.contains("block__icon"))switch(i.getAttribute("data-type")){case"min":Qe("tag").toggleModel("tag",!1,!0);break;case"sort":window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.append(new T({icon:window.siyuan.config.tag.sort===0?"iconSelect":void 0,label:window.siyuan.languages.fileNameASC,click:()=>{window.siyuan.config.tag.sort=0,this.update()}}).element),window.siyuan.menus.menu.append(new T({icon:window.siyuan.config.tag.sort===1?"iconSelect":void 0,label:window.siyuan.languages.fileNameDESC,click:()=>{window.siyuan.config.tag.sort=1,this.update()}}).element),window.siyuan.menus.menu.append(new T({icon:window.siyuan.config.tag.sort===4?"iconSelect":void 0,label:window.siyuan.languages.fileNameNatASC,click:()=>{window.siyuan.config.tag.sort=4,this.update()}}).element),window.siyuan.menus.menu.append(new T({icon:window.siyuan.config.tag.sort===5?"iconSelect":void 0,label:window.siyuan.languages.fileNameNatDESC,click:()=>{window.siyuan.config.tag.sort=5,this.update()}}).element),window.siyuan.menus.menu.append(new T({icon:window.siyuan.config.tag.sort===7?"iconSelect":void 0,label:window.siyuan.languages.refCountASC,click:()=>{window.siyuan.config.tag.sort=7,this.update()}}).element),window.siyuan.menus.menu.append(new T({icon:window.siyuan.config.tag.sort===8?"iconSelect":void 0,label:window.siyuan.languages.refCountDESC,click:()=>{window.siyuan.config.tag.sort=8,this.update()}}).element),window.siyuan.menus.menu.popup({x:a.clientX,y:a.clientY}),a.preventDefault(),a.stopPropagation();break;case"refresh":this.update();break}i=i.parentElement}}),this.update()}update(){const e=this.element.querySelector('.block__icon[data-type="refresh"] svg');e.classList.contains("fn__rotate")||(e.classList.add("fn__rotate"),E("/api/tag/getTag",{sort:window.siyuan.config.tag.sort},n=>{this.openNodes&&(this.openNodes=this.tree.getExpandIds()),this.tree.updateData(n.data),this.openNodes?this.tree.setExpandIds(this.openNodes):this.openNodes=this.tree.getExpandIds(),e.classList.remove("fn__rotate")}))}}const pb=async t=>{for(let e=0;e<t.plugins.length;e++)try{await t.plugins[e].onunload()}catch(n){console.error(n)}ee.ipcRenderer.send(u.SIYUAN_CMD,"destroy")};var XC=(t,e,n)=>{if(!e.has(t))throw TypeError("Cannot "+n)},QC=(t,e,n)=>{if(e.has(t))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(t):e.set(t,n)},NE=(t,e,n)=>(XC(t,e,"access private method"),n),yp,gb;const wp=class{constructor(t,e,n){QC(this,yp),this.children=[],this.removeTabAction=(o,l=!1,r=!0,d=!0)=>{if(cT(),this.children.find((c,f)=>{if(c.id===o){if(c.model instanceof Wa&&c.model.beforeDestroy&&c.model.beforeDestroy(),c.model instanceof ht&&ic(c.model.editor.protyle),this.children.length===1){this.destroyModel(this.children[0].model),this.children=[],["bottom","left","right"].includes(this.parent.type)?c.panelElement.remove():(op(),this.remove());const g=Ce().editor;g.length===0?Di():g.forEach(p=>{if(!p.element.classList.contains("fn__none")){tt(p.parent.parent.headersElement.parentElement.parentElement),Wl({protyle:p.editor.protyle,focus:!0,pushBackStack:!0,reload:!1,resize:!0});return}});return}if(c.headElement){if(c.headElement.classList.contains("item--focus")){let g;Array.from(c.headElement.parentElement.children).forEach(p=>{!p.isSameNode(c.headElement)&&p.style.maxWidth!=="0px"&&(g?p.getAttribute("data-activetime")>g.getAttribute("data-activetime")&&(g=p):g=p)}),g&&!l&&(this.switchTab(g,!0,!0,!1,!1),this.showHeading())}r?(c.headElement.setAttribute("style","max-width: 0px;"),setTimeout(()=>{c.headElement.remove()},200)):c.headElement.remove()}return c.panelElement.remove(),this.destroyModel(c.model),this.children.splice(f,1),ln(!1),!0}}),window.siyuan.layout.centerLayout&&!jl(window.siyuan.layout.centerLayout)){if(ve()){pb(this.app);return}const f=new wp(this.app);window.siyuan.layout.centerLayout.addWnd(f),f.addTab(JE(this.app),!1,!1),Oc(window.siyuan.languages.siyuanNote)}d&&dn(),ee.webFrame.clearCache(),ee.ipcRenderer.send(u.SIYUAN_CMD,"clearCache"),bo(),lp()},this.id=K(),this.app=t,this.resize=e,this.element=document.createElement("div"),this.element.classList.add("fn__flex-1","fn__flex");let a='<div class="layout-tab-container__drag fn__none"></div>';(n==="left"||n==="right"||n==="bottom")&&(a=""),this.element.innerHTML=`<div data-type="wnd" data-id="${this.id}" class="fn__flex-column fn__flex fn__flex-1">
    <div class="fn__flex fn__none">
        <ul class="fn__flex layout-tab-bar"></ul>
        <ul class="layout-tab-bar layout-tab-bar--readonly fn__flex-1">
            <li class="item item--readonly">
                <span data-type="new" class="block__icon block__icon--show ariaLabel${window.siyuan.config.readonly?" fn__none":""}" aria-label="${window.siyuan.languages.newFile}"><svg><use xlink:href="#iconAdd"></use></svg></span>
                <span class="fn__flex-1"></span>
                <span data-type="more" data-menu="true" class="block__icon block__icon--show ariaLabel" aria-label="${window.siyuan.languages.switchTab}"><svg><use xlink:href="#iconDown"></use></svg></span>
            </li>
        </ul>
    </div>
    <div class="layout-tab-container fn__flex-1">${a}</div>
</div>`,this.headersElement=this.element.querySelector(".layout-tab-bar");const i=this.element.querySelector(".layout-tab-container__drag");if(!i)return;this.headersElement.addEventListener("mousedown",o=>{if(o.button!==1)return;let l=o.target;for(;l&&!l.isEqualNode(this.headersElement);){if(l.tagName==="LI"){this.removeTab(l.getAttribute("data-id")),window.siyuan.menus.menu.remove(),o.stopPropagation(),o.preventDefault();const r=xt();if(["desktop","desktop-window"].includes(r)&&window.siyuan.config.system.os==="linux"||r==="browser-desktop"&&navigator.userAgent.indexOf("Linux")!==-1){const d=document.activeElement;window.addEventListener("paste",NE(this,yp,gb),{capture:!0,once:!0}),d instanceof HTMLElement&&d.focus(),setTimeout(()=>{window.removeEventListener("paste",NE(this,yp,gb),{capture:!0})},u.TIMEOUT_INPUT)}break}l=l.parentElement}}),this.headersElement.addEventListener("mousewheel",o=>{this.headersElement.scrollLeft=this.headersElement.scrollLeft+o.deltaY},{passive:!0}),this.headersElement.parentElement.addEventListener("click",o=>{let l=o.target;for(;l&&!l.isEqualNode(this.headersElement);){if(l.classList.contains("block__icon")&&l.getAttribute("data-type")==="new"){tt(this.headersElement.parentElement.parentElement),xi({app:t,useSavePath:!0});break}else if(l.classList.contains("block__icon")&&l.getAttribute("data-type")==="more"){this.renderTabList(l);break}else if(l.tagName==="LI"&&l.getAttribute("data-id")&&!Io(this.element)){l.classList.contains("item--focus")?this.switchTab(l,!0,!0,!1,!1):this.switchTab(l,!0);break}l=l.parentElement}}),this.headersElement.parentElement.addEventListener("dblclick",o=>{let l=o.target;for(;l&&!l.isEqualNode(this.headersElement);){if(window.siyuan.config.fileTree.openFilesUseCurrentTab&&l.getAttribute("data-type")==="tab-header"){l.classList.remove("item--unupdate");break}l=l.parentElement}}),this.headersElement.parentElement.addEventListener("dragover",function(o){const l=this;if(window.siyuan.currentDragOverTabHeadersElement?window.siyuan.currentDragOverTabHeadersElement.isSameNode(l)||(window.siyuan.currentDragOverTabHeadersElement.classList.remove("layout-tab-bars--drag"),window.siyuan.currentDragOverTabHeadersElement.querySelectorAll(".layout-tab-bar li[data-clone='true']").forEach(f=>{f.remove()}),window.siyuan.currentDragOverTabHeadersElement=l):window.siyuan.currentDragOverTabHeadersElement=l,o.dataTransfer.types.includes(u.SIYUAN_DROP_FILE)){o.preventDefault(),l.classList.add("layout-tab-bars--drag");return}if(!o.dataTransfer.types.includes(u.SIYUAN_DROP_TAB))return;o.preventDefault();let r=window.siyuan.dragElement,d=!1;if(Array.from(l.firstElementChild.childNodes).find(f=>{if(f.style?.opacity==="0.1")return r=f,d=!0,!0}),!d&&r){if(r.classList.contains("item--pin"))return;r=r.cloneNode(!0),r.setAttribute("data-clone","true"),l.firstElementChild.append(r);return}else!d&&!r&&(r=document.createElement("li"),r.style.opacity="0.1",r.innerHTML='<svg class="svg"><use xlink:href="#iconFile"></use></svg>',r.setAttribute("data-clone","true"),l.firstElementChild.append(r));const c=B(o.target,"data-type","tab-header");if(!c){r.classList.contains("item--pin")||l.classList.add("layout-tab-bars--drag");return}if(l.classList.remove("layout-tab-bars--drag"),!c.isSameNode(r)&&(r.classList.contains("item--pin")&&c.classList.contains("item--pin")||!r.classList.contains("item--pin")&&!c.classList.contains("item--pin"))){const f=c.getClientRects()[0];o.clientX>f.left+f.width/2?c.after(r):c.before(r)}}),this.headersElement.parentElement.addEventListener("dragend",()=>{document.querySelectorAll(".layout-tab-bars--drag").forEach(o=>{o.classList.remove("layout-tab-bars--drag")}),document.querySelectorAll(".layout-tab-bar li[data-clone='true']").forEach(o=>{o.remove()})}),this.headersElement.parentElement.addEventListener("drop",function(o){document.querySelectorAll(".layout-tab-bars--drag").forEach(p=>{p.classList.remove("layout-tab-bars--drag")});const l=this;if(o.dataTransfer.types.includes(u.SIYUAN_DROP_FILE)){tt(l.parentElement),o.dataTransfer.getData(u.SIYUAN_DROP_FILE).split(",").forEach(p=>{p&&de({app:t,id:p,action:[u.CB_GET_FOCUS,u.CB_GET_SCROLL]})}),window.siyuan.dragElement=void 0;return}const r=JSON.parse(o.dataTransfer.getData(u.SIYUAN_DROP_TAB));let d=Bt(r.id);const c=Bt(l.parentElement.getAttribute("data-id"));if(d||c instanceof wp&&(zc(t,r,c),d=c.children[c.children.length-1],ee.ipcRenderer.send(u.SIYUAN_SEND_WINDOWS,{cmd:"closetab",data:r.id}),l.querySelector("li[data-clone='true']").remove(),c.switchTab(d.headElement),ee.ipcRenderer.send(u.SIYUAN_CMD,"focus")),!d)return;const f=Array.from(l.firstElementChild.childNodes).find(p=>{if(p.style?.opacity==="0.1")return!0})?.nextElementSibling;if(!l.contains(d.headElement)){const p=l.querySelector("[data-clone='true']");if(!p)return;p.before(d.headElement),p.remove(),c.moveTab(d,f?f.getAttribute("data-id"):void 0),ln();return}let g;d.parent.children.find((p,h)=>{if(p.id===d.id)return g=d.parent.children.splice(h,1)[0],!0}),f?d.parent.children.find((p,h)=>{if(p.id===f.getAttribute("data-id"))return d.parent.children.splice(h,0,g),!0}):d.parent.children.push(g),dn()});let s=0;this.element.addEventListener("dragenter",o=>{if(s++,o.dataTransfer.types.includes(u.SIYUAN_DROP_TAB)){if(L(o.target,"layout-tab-bar"))return;L(o.target,"layout-tab-container",!0)&&(i.classList.remove("fn__none"),this.updateDragElement(o,i.parentElement.getBoundingClientRect(),i))}}),this.element.addEventListener("dragleave",()=>{s--,s===0&&(i.classList.add("fn__none"),i.removeAttribute("style"))}),i.addEventListener("dragover",o=>{document.querySelectorAll(".layout-tab-bars--drag").forEach(l=>{l.classList.remove("layout-tab-bars--drag")}),o.preventDefault(),i.nextElementSibling&&this.updateDragElement(o,i.parentElement.getBoundingClientRect(),i)}),i.addEventListener("dragleave",()=>{i.classList.add("fn__none"),i.removeAttribute("style")}),i.addEventListener("drop",o=>{i.classList.add("fn__none");const l=o.target.parentElement.parentElement,r=Bt(l.getAttribute("data-id")),d=JSON.parse(o.dataTransfer.getData(u.SIYUAN_DROP_TAB));let c=Bt(d.id);if(c||(zc(t,d,this),c=this.children[this.children.length-1],ee.ipcRenderer.send(u.SIYUAN_SEND_WINDOWS,{cmd:"closetab",data:d.id}),ee.ipcRenderer.send(u.SIYUAN_CMD,"focus")),!c){i.removeAttribute("style");return}if(i.style.height==="50%"||i.style.width==="50%"){if(i.style.height==="50%"){const f=r.split("tb");f.headersElement.append(c.headElement),f.headersElement.parentElement.classList.remove("fn__none"),f.moveTab(c),i.style.bottom==="50%"&&f.element.previousElementSibling&&r.element.parentElement&&Nb(f,r)}else if(i.style.width==="50%"){const f=r.split("lr");f.headersElement.append(c.headElement),f.headersElement.parentElement.classList.remove("fn__none"),f.moveTab(c),i.style.right==="50%"&&f.element.previousElementSibling&&r.element.parentElement&&Nb(f,r)}ln(),bo(),i.removeAttribute("style");return}i.removeAttribute("style"),!l.contains(document.querySelector(`[data-id="${d.id}"]`))&&r&&(r.headersElement.append(c.headElement),r.headersElement.parentElement.classList.remove("fn__none"),r.moveTab(c),ln())})}isPointWithinLines(t,e,n,a){const i=n.k*t+n.b,s=a.k*t+a.b;return e>=Math.min(i,s)&&e<=Math.max(i,s)}updateDragElement(t,e,n){const a=e.height,i=e.width,s=t.clientX-e.left,o=t.clientY-e.top;s<i/5&&this.isPointWithinLines(s,o,{k:1.5*a/i,b:-.15*a},{k:-1.25*a/i,b:1.05*a})?n.setAttribute("style","height:100%;width:50%;right:50%;bottom:0;left:0;top:0"):s>i*.8&&this.isPointWithinLines(s,o,{k:-1.5*a/i,b:1.35*a},{k:1.25*a/i,b:-.2*a})?n.setAttribute("style","height:100%;width:50%;right:0;bottom:0;left:50%;top:0"):o<a*.15?n.setAttribute("style","height:50%;width:100%;right:0;bottom:50%;left:0;top:0"):o>a*.8?n.setAttribute("style","height:50%;width:100%;right:0;bottom:0;left:0;top:50%"):n.setAttribute("style","height:100%;width:100%;right:0;bottom:0;left:0;top:0")}showHeading(){const t=this.headersElement.querySelector(".item--focus");t&&(t.offsetLeft+t.clientWidth>this.headersElement.scrollLeft+this.headersElement.clientWidth?this.headersElement.scrollLeft=t.offsetLeft+t.clientWidth-this.headersElement.clientWidth:t.offsetLeft<this.headersElement.scrollLeft&&(this.headersElement.scrollLeft=t.offsetLeft))}switchTab(t,e=!1,n=!0,a=!0,i=!0){let s,o=!1;if(this.children.forEach(l=>{t===l.headElement?(l.headElement&&l.headElement.classList.contains("fn__none")||(l.headElement&&(l.headElement.classList.add("item--focus"),l.headElement.getAttribute("data-init-active")==="true"?(l.headElement.removeAttribute("data-init-active"),o=!0):l.headElement.setAttribute("data-activetime",new Date().getTime().toString())),l.panelElement.classList.remove("fn__none")),s=l):(l.headElement?.classList.remove("item--focus"),l.panelElement.classList.contains("fn__none")||l.panelElement.classList.add("fn__none"))}),o||tt(this.headersElement.parentElement.parentElement,i),s&&s.headElement){const l=s.headElement.getAttribute("data-initdata");if(l){s.addModel(wk(this.app,s,JSON.parse(l))),s.headElement.removeAttribute("data-initdata"),i&&dn();return}}if(s&&t===s.headElement&&(s.model instanceof ri?s.model.onGraph(!1):s.model instanceof li&&s.model.pdfObject&&s.model.pdfObject.pdfViewer&&s.model.pdfObject.pdfViewer.container.focus()),s&&s.model instanceof ht){const l=s.headElement.getAttribute("keep-cursor");if(l){let r;if(Array.from(s.model.editor.protyle.wysiwyg.element.querySelectorAll(`[data-node-id="${l}"]`)).find(d=>{if(!F(d))return r=d,!0}),r){if(!s.model.editor.protyle.toolbar.range){const d=document.createRange();d.selectNodeContents(r),d.collapse(),s.model.editor.protyle.toolbar.range=d}Ne(s.model.editor.protyle,r,!0)}else de({app:this.app,id:l,action:[u.CB_GET_FOCUS,u.CB_GET_SCROLL]});s.headElement.removeAttribute("keep-cursor")}n&&Wl({protyle:s.model.editor.protyle,focus:!0,pushBackStack:e,reload:!1,resize:a}),window.siyuan.editorIsFullscreen&&(to(s.model.editor.protyle.element),Nm(s.model.editor.protyle))}else Di();i&&dn()}addTab(t,e=!1,n=!0,a){e&&(t.headElement?.classList.remove("item--focus"),t.panelElement.classList.add("fn__none"));let i=0;this.children.forEach((o,l)=>{if(o.headElement&&o.headElement.classList.contains("item--focus")){i=l;let r=o.headElement.nextElementSibling;for(;r&&r.classList.contains("item--pin");)i++,r=r.nextElementSibling}e||(o.headElement?.classList.remove("item--focus"),o.panelElement.classList.add("fn__none"))}),this.children.splice(i+1,0,t),t.headElement&&(this.headersElement.parentElement.classList.remove("fn__none"),this.headersElement.childElementCount===0?this.headersElement.append(t.headElement):this.headersElement.children[i].after(t.headElement),t.headElement.querySelector(".item__close").addEventListener("click",o=>{t.headElement.classList.contains("item--pin")?t.unpin():t.parent.removeTab(t.id),window.siyuan.menus.menu.remove(),o.stopPropagation(),o.preventDefault()}),t.headElement.setAttribute("data-activetime",a||new Date().getTime().toString()));const s=this.element.querySelector(".layout-tab-container");s.querySelector(".fn__flex-1")?s.querySelector(".layout-tab-container__drag")?s.children[i+1].after(t.panelElement):s.children[i].after(t.panelElement):s.append(t.panelElement),t.parent=this,t.callback&&t.callback(t),this.parent.type==="center"&&this.children.length===2&&!this.children[0].headElement?this.removeTab(this.children[0].id):this.children.length>window.siyuan.config.fileTree.maxOpenTabCount&&this.removeOverCounter(n),bo(),lp(),n&&dn()}renderTabList(t){if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="tabList"){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.classList.add("b3-menu--list"),Array.from(this.headersElement.children).forEach(n=>{const a=n.querySelector(".item__icon"),i=n.querySelector(".item__graphic");let s;a?a.firstElementChild?.tagName==="IMG"?s=`<img src="${a.firstElementChild.getAttribute("src")}"  class="b3-menu__icon">`:s=`<span class="b3-menu__icon">${a.innerHTML}</span>`:i||(s=ge(window.siyuan.storage[u.LOCAL_IMAGES].file,"b3-menu__icon",!0)),window.siyuan.menus.menu.append(new T({label:pe(n.querySelector(".item__text").textContent),action:"iconCloseRound",iconHTML:s,icon:i?i.firstElementChild.getAttribute("xlink:href").substring(1):"",bind:o=>{o.addEventListener("click",l=>{L(l.target,"b3-menu__action")?(this.removeTab(n.getAttribute("data-id")),o.previousElementSibling||o.nextElementSibling?(o.remove(),ke(window.siyuan.menus.menu.element,e.left+e.width-window.siyuan.menus.menu.element.clientWidth,e.top+e.height)):window.siyuan.menus.menu.remove()):(this.switchTab(n,!0),this.showHeading(),window.siyuan.menus.menu.remove()),l.preventDefault(),l.stopPropagation()})},current:n.classList.contains("item--focus")}).element)}),window.siyuan.menus.menu.element.setAttribute("data-name","tabList");const e=t.getBoundingClientRect();window.siyuan.menus.menu.popup({x:e.left+e.width,y:e.top+e.height,isLeft:!0})}removeOverCounter(t=!1){let e,n,a=0;this.children.forEach((i,s)=>{i.headElement.classList.contains("item--pin")||i.headElement.classList.contains("item--focus")||(a++,n?i.headElement.getAttribute("data-activetime")<n&&(n=i.headElement.getAttribute("data-activetime"),e=this.children[s].id):(n=i.headElement.getAttribute("data-activetime"),e=this.children[s].id))}),e&&(this.removeTab(e,!1,!1,t),a--),a>0&&this.children.length>window.siyuan.config.fileTree.maxOpenTabCount&&this.removeOverCounter(t)}destroyModel(t){if(t){if(t instanceof ht&&t.editor){window.siyuan.blockPanels.forEach(e=>{e.element&&t.editor.protyle.wysiwyg.element.contains(e.element)&&e.destroy()}),t.editor.destroy();return}if(t instanceof Mi){t.editors.edit.destroy(),t.editors.unRefEdit.destroy();return}t instanceof li&&t.pdfObject&&t.pdfObject.pdfLoadingTask&&t.pdfObject.pdfLoadingTask.destroy(),t instanceof Wa&&t.destroy&&t.destroy(),t.send("closews",{})}}removeTab(t,e=!1,n=!0,a=!0){for(let i=0;i<this.children.length;i++){const s=this.children[i];if(s.id===t){if(s.model instanceof ht&&s.model.editor?.protyle){if(s.model.editor.protyle.upload.isUploading){j(window.siyuan.languages.uploading);return}this.removeTabAction(t,e,n,a)}else this.removeTabAction(t,e,n,a);return}}}moveTab(t,e){let n;if(t.model instanceof ht&&t.model.editor.protyle.toolbar.range){const i=P(t.model.editor.protyle.toolbar.range.startContainer);if(i){const s=ct(i,void 0,t.model.editor.protyle.toolbar.range);n={id:i.getAttribute("data-node-id"),start:s.start,end:s.end}}}if(this.element.querySelector(".layout-tab-container").append(t.panelElement),n&&t.model instanceof ht){const i=na(t.model.editor.protyle.wysiwyg.element.querySelector(`[data-node-id="${n.id}"]`),n.start,n.end);i&&(t.model.editor.protyle.toolbar.range=i)}e?this.children.find((i,s)=>{if(i.id===e)return this.children.splice(s,0,t),!0}):this.children.push(t),this.children.length>window.siyuan.config.fileTree.maxOpenTabCount&&this.removeOverCounter();const a=t.parent;if(a.children.length===1)a.children=[],a.remove();else if(a.children.find((i,s)=>{if(i.id===t.id)return a.children.splice(s,1),ln(),!0}),!a.headersElement.querySelector(".item--focus")){let i;Array.from(a.headersElement.children).forEach(s=>{i?s.getAttribute("data-activetime")>i.getAttribute("data-activetime")&&(i=s):i=s}),i&&a.switchTab(i,!0)}this.switchTab(t.headElement),t.parent=this,Ji(["toolbar"]),bo()}split(t){if(this.children.length===1&&!this.children[0].headElement)return this;const e=new wp(this.app,t);return t===this.parent.direction?this.parent.addWnd(e,this.id):this.parent.children.length===1?(this.parent.direction=t,t==="tb"?(this.parent.element.classList.add("fn__flex-column"),this.parent.element.classList.remove("fn__flex")):(this.parent.element.classList.remove("fn__flex-column"),this.parent.element.classList.add("fn__flex")),this.parent.addWnd(e,this.id)):this.parent.children.find((n,a)=>{if(n.id===this.id){const i=new wa({resize:n.resize,direction:t});this.parent.addLayout(i,n.id);const s=this.parent.children.splice(a,1)[0];return s.resize&&(s.element.previousElementSibling.remove(),s.resize=void 0),i.addWnd.call(i,s),i.addWnd.call(i,e),t==="tb"&&s.element.style.width?(i.element.style.width=s.element.style.width,i.element.classList.remove("fn__flex-1"),s.element.style.width="",s.element.classList.add("fn__flex-1")):t==="lr"&&s.element.style.height&&(i.element.style.height=s.element.style.height,i.element.classList.remove("fn__flex-1"),s.element.style.height="",s.element.classList.add("fn__flex-1")),!0}}),e}remove(){let t=this.parent,e=this.element,n=this.id;for(;t&&t.children.length===1&&t.type!=="center";)n=t.id,e=t.element,t=t.parent;t.children.find((a,i)=>{if(a.id===n){if(t.children.length>1){let s=t.children[i-1];i===0&&(s=t.children[1]),t.children.length===2&&(t.direction==="lr"?s.element.style.width="":s.element.style.height="",s.resize=void 0,s.element.classList.add("fn__flex-1")),t.children.length>2&&i===0&&(t.children[1].resize=void 0)}return t.children.splice(i,1),!0}}),e.previousElementSibling&&e.previousElementSibling.classList.contains("layout__resize")?e.previousElementSibling.remove():e.nextElementSibling&&e.nextElementSibling.classList.contains("layout__resize")&&e.nextElementSibling.remove(),e.remove(),Ob(t),ln()}};let Rc=wp;yp=new WeakSet,gb=function(t){t.preventDefault(),t.stopPropagation()};const Mn=()=>{const t=[],e=Ce();return e.editor.forEach(n=>{t.push(n.editor)}),e.search.forEach(n=>{t.push(n.editors.edit),t.push(n.editors.unRefEdit)}),e.custom.forEach(n=>{n.editors?.forEach(a=>{t.push(a)})}),e.backlink.forEach(n=>{n.editors.forEach(a=>{t.push(a)})}),window.siyuan.dialogs.forEach(n=>{n.editors&&Object.keys(n.editors).forEach(a=>{t.push(n.editors[a])})}),window.siyuan.blockPanels.forEach(n=>{n.editors.forEach(a=>{t.push(a)})}),t},Ce=()=>{const t={editor:[],graph:[],asset:[],outline:[],backlink:[],search:[],inbox:[],files:[],bookmark:[],tag:[],custom:[]},e=n=>{for(let a=0;a<n.children.length;a++){const i=n.children[a];if(i instanceof ut){const s=i.model;s instanceof ht?t.editor.push(s):s instanceof ri?t.graph.push(s):s instanceof us?t.outline.push(s):s instanceof fs?t.backlink.push(s):s instanceof li?t.asset.push(s):s instanceof Mi?t.search.push(s):s instanceof Li?t.files.push(s):s instanceof vo?t.bookmark.push(s):s instanceof Eo?t.tag.push(s):s instanceof Wa&&t.custom.push(s)}else e(i)}};return window.siyuan.layout.layout&&e(window.siyuan.layout.layout),t},ko=(t,e)=>{for(let n=0;n<t.children.length;n++){const a=t.children[n];a instanceof Rc?e.push(a):a instanceof wa&&ko(a,e)}},ba=()=>{const t=[],e=n=>{for(let a=0;a<n.children.length;a++){const i=n.children[a];i instanceof ut?t.push(i):e(i)}};return window.siyuan.layout.centerLayout&&e(window.siyuan.layout.centerLayout),t},_p=()=>{const t=[];return window.siyuan.config.uiLayout.left.data.forEach(e=>{e.forEach(n=>{t.push(n)})}),window.siyuan.config.uiLayout.right.data.forEach(e=>{e.forEach(n=>{t.push(n)})}),window.siyuan.config.uiLayout.bottom.data.forEach(e=>{e.forEach(n=>{t.push(n)})}),t},vp=(t,e,n)=>{E("/api/block/getDocInfo",{id:t},a=>{e.updateTitle(a.data.name),n&&n.title&&n.title.setTitle(a.data.name)})},hb=(t,e,n=!0,a=!0,i=!1)=>{n&&Ue();const s=Ce();s.editor.forEach(o=>{e.upsertRootIDs.includes(o.editor.protyle.block.rootID)?E("/api/block/getDocInfo",{id:o.editor.protyle.block.rootID},l=>{o.editor.protyle.wysiwyg.renderCustom(l.data.ial),ei(o.editor.protyle,!1,a),vp(o.editor.protyle.block.rootID,o.parent,o.editor.protyle)}):e.removeRootIDs.includes(o.editor.protyle.block.rootID)&&(o.parent.parent.removeTab(o.parent.id,!1,!1),delete window.siyuan.storage[u.LOCAL_FILEPOSITION][o.editor.protyle.block.rootID],ue(u.LOCAL_FILEPOSITION,window.siyuan.storage[u.LOCAL_FILEPOSITION]))}),s.graph.forEach(o=>{o.type==="local"&&e.removeRootIDs.includes(o.rootId)?o.parent.parent.removeTab(o.parent.id,!1,!1):(o.type!=="local"||e.upsertRootIDs.includes(o.rootId))&&(o.searchGraph(!1),o.type==="local"&&vp(o.rootId,o.parent))}),s.outline.forEach(o=>{o.type==="local"&&e.removeRootIDs.includes(o.blockId)?o.parent.parent.removeTab(o.parent.id,!1,!1):(o.type!=="local"||e.upsertRootIDs.includes(o.blockId))&&(E("/api/outline/getDocOutline",{id:o.blockId,preview:o.isPreview},l=>{o.update(l)}),o.type==="local"&&vp(o.blockId,o.parent))}),s.backlink.forEach(o=>{o.type==="local"&&e.removeRootIDs.includes(o.rootId)?o.parent.parent.removeTab(o.parent.id,!1,!1):(o.refresh(),o.type==="local"&&vp(o.rootId,o.parent))}),i||s.files.forEach(o=>{Ei(()=>{o.init(!1)})}),s.bookmark.forEach(o=>{o.update()}),s.tag.forEach(o=>{o.update()}),s.search.forEach(o=>{o.parent.panelElement.querySelector("#searchInput").dispatchEvent(new CustomEvent("input"))}),s.custom.forEach(o=>{o.update&&o.update()})},eT=t=>{Mn().forEach(e=>{e.protyle.wysiwyg.element.querySelectorAll(`[data-node-id="${t.blockID}"] span[data-type="block-ref"][data-subtype="d"][data-id="${t.defBlockID}"]`).forEach(n=>{n.innerHTML=t.refText})})},tT=t=>{Mn().forEach(n=>{if(n.protyle.block.rootID===t.rootID&&n.protyle.title){const a=n.protyle.title.element.querySelector(".protyle-attr"),i=a.querySelector(".protyle-attr--refcount");i?t.rootRefCount===0?i.remove():i.textContent=t.rootRefCount.toString():t.rootRefCount>0&&a.insertAdjacentHTML("beforeend",`<div class="protyle-attr--refcount popover__block">${t.rootRefCount}</div>`)}t.rootID!==t.blockID&&n.protyle.wysiwyg.element.querySelectorAll(`[data-node-id="${t.blockID}"]`).forEach(a=>{const i=a.lastElementChild.querySelector(".protyle-attr--refcount");if(i)t.refCount===0?i.remove():i.textContent=t.refCount.toString();else if(t.refCount>0){const s=a.lastElementChild;s.childElementCount>0?s.lastElementChild.insertAdjacentHTML("afterend",`<div class="protyle-attr--refcount popover__block">${t.refCount}</div>`):s.innerHTML=`<div class="protyle-attr--refcount popover__block">${t.refCount}</div>${u.ZWSP}`}t.refCount===0?a.removeAttribute("refcount"):a.setAttribute("refcount",t.refCount.toString())})});let e;if(e=Qe("file").data.file.element.querySelector(`li[data-node-id="${t.rootID}"]`),e){const n=e.querySelector(".counter");n?t.rootRefCount===0?n.remove():n.textContent=t.rootRefCount.toString():t.rootRefCount>0&&e.insertAdjacentHTML("beforeend",`<span class="popover__block counter b3-tooltips b3-tooltips__nw" aria-label="${window.siyuan.languages.ref}">${t.rootRefCount}</span>`)}},Ep=t=>{window.siyuan.config.readonly||(t.plugins.forEach(e=>{e.eventBus.emit("lock-screen")}),ee.ipcRenderer.send(u.SIYUAN_SEND_WINDOWS,{cmd:"lockscreen"}))},HE=()=>{if(document.querySelector("#errorLog"))return;let t="";ra()&&(t=`<div class="fn__hr"></div><div class="fn__flex"><div class="fn__flex-1"></div><button class="b3-button">${window.siyuan.languages.retry}</button></div>`);const e=new we({disableClose:!0,title:`\u{1F494} ${window.siyuan.languages.kernelFault0} <small>v${u.SIYUAN_VERSION}</small>`,width:W()?"92vw":"520px",content:`<div class="b3-dialog__content">
<div class="ft__breakword">
    <div>${window.siyuan.languages.kernelFault1}</div>
    <div class="fn__hr"></div>
    <div>${window.siyuan.languages.kernelFault2}</div>
    ${t}
</div>
</div>`});e.element.id="errorLog",e.element.setAttribute("data-key",u.DIALOG_KERNELFAULT);const n=e.element.querySelector(".b3-button");n&&n.addEventListener("click",()=>{e.destroy(),window.webkit.messageHandlers.startKernelFast.postMessage("startKernelFast")})},So=async()=>{Ji(["util"]),E("/api/system/exit",{force:!1},t=>{if(t.code===1){const e=j(t.msg,t.data.closeTimeout,"error"),n=document.querySelector(`#message [data-id="${e}"] button`);n&&n.addEventListener("click",()=>{E("/api/system/exit",{force:!0},()=>{ee.ipcRenderer.send(u.SIYUAN_QUIT,location.port)})})}else t.code===2?(Ue(),window.siyuan.config.system.container==="std"&&ee.ipcRenderer.send(u.SIYUAN_SHOW_WINDOW),xe(window.siyuan.languages.tip,t.msg,()=>{E("/api/system/exit",{force:!0,execInstallPkg:2},()=>{setTimeout(()=>{ee.ipcRenderer.send(u.SIYUAN_CMD,"hide")},2e3),setTimeout(()=>{ee.ipcRenderer.send(u.SIYUAN_QUIT,location.port)},4e3)})},()=>{E("/api/system/exit",{force:!0,execInstallPkg:1},()=>{ee.ipcRenderer.send(u.SIYUAN_QUIT,location.port)})})):ee.ipcRenderer.send(u.SIYUAN_QUIT,location.port)})},nT=()=>{if(document.getElementById("transactionError"))return;const t=new we({disableClose:!0,title:`${window.siyuan.languages.stateExcepted} v${u.SIYUAN_VERSION}`,content:`<div class="b3-dialog__content" id="transactionError">${window.siyuan.languages.rebuildIndexTip}</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--text">${window.siyuan.languages._kernel[97]}</button>
    <div class="fn__space"></div>
    <button class="b3-button">${window.siyuan.languages.rebuildIndex}</button>
</div>`,width:W()?"92vw":"520px"});t.element.setAttribute("data-key",u.DIALOG_STATEEXCEPTED);const e=t.element.querySelectorAll(".b3-button");e[0].addEventListener("click",()=>{Xt({errorExit:!0,cb:So})}),e[1].addEventListener("click",()=>{RE(),t.destroy()})},RE=t=>{window.siyuan.storage[u.LOCAL_FILEPOSITION]={},ue(u.LOCAL_FILEPOSITION,window.siyuan.storage[u.LOCAL_FILEPOSITION]),E("/api/filetree/refreshFiletree",{},()=>{t&&t()})};let kp;const aT=t=>{const e=document.querySelector("#status");if(e)if(W()){if(!document.querySelector("#keyboardToolbar").classList.contains("fn__none"))return;clearTimeout(kp),e.innerHTML=t.msg,e.style.bottom="0",kp=window.setTimeout(()=>{e.style.bottom=""},12e3)}else{const n=e.querySelector(".status__msg");n&&(clearTimeout(kp),n.innerHTML=t.msg,kp=window.setTimeout(()=>{n.innerHTML=""},12e3))}},iT=t=>{let e=document.getElementById("progress");if(e||(document.body.insertAdjacentHTML("beforeend",`<div id="progress" style="z-index: ${++window.siyuan.zIndex}"></div>`),e=document.getElementById("progress")),t.code===2){e.remove();return}t.code===0?e.innerHTML=`<div class="b3-dialog__scrim" style="opacity: 1"></div>
<div class="b3-dialog__loading">
    <div style="text-align: right">${t.data.current}/${t.data.total}</div>
    <div style="margin: 8px 0;height: 8px;border-radius: var(--b3-border-radius);overflow: hidden;background-color:#fff;"><div style="width: ${t.data.current/t.data.total*100}%;transition: var(--b3-transition);background-color: var(--b3-theme-primary);height: 8px;"></div></div>
    <div class="ft__breakword">${t.msg}</div>
</div>`:t.code===1&&(e.lastElementChild?e.lastElementChild.lastElementChild.innerHTML=t.msg:e.innerHTML=`<div class="b3-dialog__scrim" style="opacity: 1"></div>
<div class="b3-dialog__loading">
    <div style="margin: 8px 0;height: 8px;border-radius: var(--b3-border-radius);overflow: hidden;background-color:#fff;"><div style="background-color: var(--b3-theme-primary);height: 8px;background-image: linear-gradient(-45deg, rgba(255, 255, 255, 0.2) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, 0.2) 50%, rgba(255, 255, 255, 0.2) 75%, transparent 75%, transparent);animation: stripMove 450ms linear infinite;background-size: 50px 50px;"></div></div>
    <div class="ft__breakword">${t.msg}</div>
</div>`)},sT=t=>{const e=document.querySelector(".status__backgroundtask");e&&(t.length===0?(e.classList.add("fn__none"),!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="statusBackgroundTask"&&window.siyuan.menus.menu.remove()):(e.classList.remove("fn__none"),e.setAttribute("data-tasks",JSON.stringify(t)),e.innerHTML=t[0].action+"<div><div></div></div>"))},oT=()=>{E("/api/sync/getBootSync",{},t=>{if(t.code===1){const e=new we({width:W()?"92vw":"50vw",title:"\u{1F329}\uFE0F "+window.siyuan.languages.bootSyncFailed,content:`<div class="b3-dialog__content">${t.msg}</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.syncNow}</button>
</div>`});e.element.setAttribute("data-key",u.DIALOG_BOOTSYNCFAILED);const n=e.element.querySelectorAll(".b3-button");n[0].addEventListener("click",()=>{e.destroy()}),n[1].addEventListener("click",()=>{n[1].getAttribute("disabled")||(n[1].setAttribute("disabled","disabled"),E("/api/sync/performBootSync",{},a=>{a.code===0&&e.destroy(),n[1].removeAttribute("disabled")}))})}})},Oc=t=>{const e=document.getElementById("drag"),n=hw();if(t===window.siyuan.languages.siyuanNote){const a=`${n} - ${window.siyuan.languages.siyuanNote} v${u.SIYUAN_VERSION}`;document.title=a,e&&(e.textContent=a,e.setAttribute("title",a))}else{if(t=t||window.siyuan.languages.untitled,document.title=`${t} - ${n} - ${window.siyuan.languages.siyuanNote} v${u.SIYUAN_VERSION}`,!e)return;e.setAttribute("title",t),e.innerHTML=pe(t)}},lT=t=>{const e=document.querySelector("#configBazaarReadme .item__side");if(!e||t.id!==JSON.parse(e.getAttribute("data-obj")).repoURL)return;const n=e.querySelector('[data-type="install"]');n&&(t.percent>=1?(n.parentElement.classList.add("fn__none"),n.parentElement.nextElementSibling.classList.add("fn__none")):(n.classList.add("b3-button--progress"),n.parentElement.nextElementSibling.firstElementChild.classList.add("b3-button--progress"),n.innerHTML=`<span style="width: ${t.percent*100}%"></span>`,n.parentElement.nextElementSibling.firstElementChild.innerHTML=`<span style="width: ${t.percent*100}%"></span>`))},Ya=(t,e)=>{const n=document.querySelector("#barSync");if(!n)return;const a=n.querySelector("use");if(!t){n.classList.remove("toolbar__item--active"),!window.siyuan.config.sync.enabled||window.siyuan.config.sync.provider===0&&Si("")?a.setAttribute("xlink:href","#iconCloudOff"):a.setAttribute("xlink:href","#iconCloudSucc");return}n.firstElementChild.classList.remove("fn__rotate"),t.code===0?(n.classList.add("toolbar__item--active"),n.firstElementChild.classList.add("fn__rotate"),a.setAttribute("xlink:href","#iconRefresh")):t.code===2?(n.classList.remove("toolbar__item--active"),a.setAttribute("xlink:href","#iconCloudError")):t.code===1&&(n.classList.remove("toolbar__item--active"),a.setAttribute("xlink:href","#iconCloudSucc")),e.forEach(i=>{t.code===0?i.eventBus.emit("sync-start",t):t.code===1?i.eventBus.emit("sync-end",t):t.code===2&&i.eventBus.emit("sync-fail",t)})},E=(t,e,n,a)=>{const i={method:"POST"};e&&(["/api/search/searchRefBlock","/api/graph/getGraph","/api/graph/getLocalGraph","/api/block/getRecentUpdatedBlocks","/api/search/fullTextSearchBlock"].includes(t)&&(window.siyuan.reqIds[t]=new Date().getTime(),e.type==="local"&&t==="/api/graph/getLocalGraph"||(e.reqId=window.siyuan.reqIds[t])),t==="/api/transactions"&&(e.reqId=new Date().getTime()),e instanceof FormData?i.body=e:i.body=JSON.stringify(e)),a&&(i.headers=a),fetch(t,i).then(s=>{switch(s.status){case 403:case 404:return{data:null,msg:s.statusText,code:-s.status};default:return s.headers.get("content-type")?.indexOf("application/json")>-1?s.json():s.text()}}).then(s=>{if(typeof s=="string"){n&&n(s);return}["/api/search/searchRefBlock","/api/graph/getGraph","/api/graph/getLocalGraph","/api/block/getRecentUpdatedBlocks","/api/search/fullTextSearchBlock"].includes(t)&&s.data.reqId&&window.siyuan.reqIds[t]&&window.siyuan.reqIds[t]>s.data.reqId||(typeof s=="object"&&typeof s.msg=="string"&&typeof s.code=="number"?_h(s)&&n&&n(s):n&&n(s))}).catch(s=>{if(console.warn("fetch post failed ["+s+"], url ["+t+"]"),t==="/api/transactions"&&(s.message==="Failed to fetch"||s.message==="Unexpected end of JSON input")){HE();return}(t==="/api/system/exit"||t==="/api/system/setWorkspaceDir"||["/api/system/setUILayout"].includes(t)&&e.errorExit)&&ee.ipcRenderer.send(u.SIYUAN_QUIT,location.port)})},Re=async(t,e)=>{const n={method:"POST"};e&&(e instanceof FormData?n.body=e:n.body=JSON.stringify(e));const i=await(await fetch(t,n)).json();return _h(i),i},mb=(t,e)=>{fetch(t).then(n=>n.headers.get("content-type")?.indexOf("application/json")>-1?n.json():n.text()).then(n=>{e(n)})},rT=(t=!1)=>{let e="";t||(e=`<div id="barDock" class="toolbar__item ariaLabel${window.siyuan.config.readonly||t?" fn__none":""}" aria-label="${window.siyuan.languages.toggleDock} ${X(window.siyuan.config.keymap.general.toggleDock.custom)}">
    <svg>
        <use xlink:href="#${window.siyuan.config.uiLayout.hideDock?"iconDock":"iconHideDock"}"></use>
    </svg>
</div>`),document.getElementById("status").innerHTML=`${e}
<div class="status__msg"></div>
<div class="fn__flex-1"></div>
<div class="status__backgroundtask fn__none"></div>
<div class="status__counter"></div>
<div id="statusHelp" class="toolbar__item ariaLabel" aria-label="${window.siyuan.languages.help}">
    <svg><use xlink:href="#iconHelp"></use></svg>
</div>`,document.querySelector("#status").addEventListener("click",n=>{let a=n.target;for(;a.id!=="status";){if(a.id==="barDock"){Mm(a.firstElementChild.firstElementChild),n.stopPropagation();break}else if(a.classList.contains("status__backgroundtask")){if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="statusBackgroundTask"){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name","statusBackgroundTask"),JSON.parse(a.getAttribute("data-tasks")).forEach(s=>{window.siyuan.menus.menu.append(new T({type:"readonly",iconHTML:"",label:s.action}).element)});const i=a.getBoundingClientRect();window.siyuan.menus.menu.popup({x:i.right,y:i.top,isLeft:!0}),n.stopPropagation();break}else if(a.id==="statusHelp"){if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="statusHelp"){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name","statusHelp"),window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.userGuide,icon:"iconHelp",ignore:Da()||window.siyuan.config.readonly,click:()=>{$f()}}).element),window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.feedback,icon:"iconFeedback",click:()=>{window.siyuan.config.lang==="zh_CN"||window.siyuan.config.lang==="zh_CHT"?window.open("https://ld246.com/article/1649901726096"):window.open("https://liuyun.io/article/1686530886208")}}).element),window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.debug,icon:"iconBug",click:()=>{ee.ipcRenderer.send(u.SIYUAN_CMD,"openDevTools")}}).element),window.siyuan.menus.menu.append(new T({label:window.siyuan.languages._trayMenu.officialWebsite,icon:"iconSiYuan",click:()=>{window.open("https://b3log.org/siyuan")}}).element),window.siyuan.menus.menu.append(new T({label:window.siyuan.languages._trayMenu.openSource,icon:"iconGithub",click:()=>{window.open("https://github.com/siyuan-note/siyuan")}}).element);const i=a.getBoundingClientRect();window.siyuan.menus.menu.popup({x:i.right,y:i.top,isLeft:!0}),n.stopPropagation();break}else if(a.classList.contains("b3-menu__item")){const i=a.getAttribute("data-type");if(Qe(i).toggleModel(i),i==="file"&&getSelection().rangeCount>0){const s=getSelection().getRangeAt(0),o=L(s.startContainer,"protyle-wysiwyg",!0);o&&o.blur()}a.parentElement.classList.add("fn__none"),n.stopPropagation();break}a=a.parentElement}}),window.siyuan.config.appearance.hideStatusBar&&document.getElementById("status").classList.add("fn__none")};let hs,Bc;const Lo=(t,e)=>{document.getElementById("status").classList.contains("fn__none")||(clearTimeout(Bc),Bc=window.setTimeout(()=>{t.toString()?(E("/api/block/getContentWordCount",{content:t.toString()},a=>{Sp(a.data.stat)}),hs=""):e&&e!==hs&&(hs=e,E("/api/block/getTreeStat",{id:e},a=>{Sp(a.data.stat)}))},u.TIMEOUT_COUNT))},bn=(t,e,n=!1)=>{if(!document.getElementById("status").classList.contains("fn__none")){if(getSelection().rangeCount>0&&getSelection().getRangeAt(0).toString()&&t.length===0){Lo(getSelection().getRangeAt(0));return}clearTimeout(Bc),Bc=window.setTimeout(()=>{n&&(hs=""),t.length>0?(E("/api/block/getBlocksWordCount",{ids:t},a=>{Sp(a.data.stat)}),hs=""):e&&e!==hs&&(hs=e,E("/api/block/getTreeStat",{id:e},a=>{Sp(a.data.stat)}))},u.TIMEOUT_COUNT)}},cT=()=>{hs="",document.querySelector("#status .status__counter").innerHTML="",clearTimeout(Bc)},Sp=t=>{if(!t)return;let e=`<span class="ft__on-surface">${window.siyuan.languages.runeCount}</span>&nbsp;${t.runeCount}<span class="fn__space"></span>
<span class="ft__on-surface">${window.siyuan.languages.wordCount}</span>&nbsp;${t.wordCount}<span class="fn__space"></span>`;0<t.linkCount&&(e+=`<span class="ft__on-surface">${window.siyuan.languages.linkCount}</span>&nbsp;${t.linkCount}<span class="fn__space"></span>`),0<t.imageCount&&(e+=`<span class="ft__on-surface">${window.siyuan.languages.imgCount}</span>&nbsp;${t.imageCount}<span class="fn__space"></span>`),0<t.refCount&&(e+=`<span class="ft__on-surface">${window.siyuan.languages.refCount}</span>&nbsp;${t.refCount}<span class="fn__space"></span>`),0<t.blockCount&&(e+=`<span class="ft__on-surface">${window.siyuan.languages.blockCount}</span>&nbsp;${t.blockCount}<span class="fn__space"></span>`),document.querySelector("#status .status__counter").innerHTML=e},dT=(t,e)=>{if(!e){if(getSelection().rangeCount===0)return!1;e=getSelection().getRangeAt(0)}const n=e.commonAncestorContainer;return t.isEqualNode(n)||t.contains(n)},bb=t=>{const e=B(t.startContainer,"data-type","NodeTable");if(t.toString()!==""&&e&&t.commonAncestorContainer.nodeType!==3){const n=t.commonAncestorContainer.tagName;if(n!=="TH"&&n!=="TD"){const a=q(t.startContainer,"TD")||q(t.startContainer,"TH"),i=q(t.endContainer,"TD")||q(t.endContainer,"TH");if(!a&&!i){const s=e.querySelector("th")||e.querySelector("td");t.setStart(s.firstChild,0),t.setEnd(s.lastChild,s.lastChild.textContent.length)}else a&&!a.contains(t.endContainer)&&Pt(a,t,!1)}}},Lp=(t,e,n)=>{const a=le(e);if(a){let o;if(a.tagName==="TABLE"){const l=q(n.startContainer,"TD")||q(n.startContainer,"TH");if(l&&(o=ct(l,e,n),o.start!==0||o.end!==l.textContent.length))return n.setStart(l.firstChild,0),n.setEndAfter(l.lastChild),t.toolbar.render(t,n),Lo(n,t.block.rootID),!0}else if(o=ct(a,e,n),o.start!==0||o.end!==a.textContent.length){let l=a.firstChild;for(;l;)if(l.nodeType===3){if(l.textContent!==""){n.setStart(l,0);break}l=l.nextSibling}else{if(l.classList.contains("render-node")||l.classList.contains("img")){n.setStartBefore(l);break}l=l.firstChild}let r=a.lastChild;for(;r;)if(r.nodeType===3){if(r.textContent!==""){n.setEnd(r,r.textContent.length);break}r=r.previousSibling}else{if(r.classList.contains("render-node")||r.classList.contains("img")||r.tagName==="BR"){n.setEndAfter(r);break}r=r.lastChild}return Z(n),t.toolbar.render(t,n),Lo(n,t.block.rootID),!0}}n.collapse(!0);const i=t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(t.wysiwyg.element.childElementCount===i.length&&i[0].parentElement.isSameNode(t.wysiwyg.element))return!0;Q(["select"],t);const s=[];Array.from(t.wysiwyg.element.children).forEach(o=>{const l=o.getAttribute("data-node-id");l&&(o.classList.add("protyle-wysiwyg--select"),s.push(l))}),bn(s,t.block.rootID)},yb=(t,e)=>{const n=document.caretRangeFromPoint(t,e),a=B(n.startContainer,"data-type","img");return a&&(n.setStart(a.nextSibling,0),n.collapse()),n},me=t=>{let e;if(getSelection().rangeCount>0&&(e=getSelection().getRangeAt(0),t.isSameNode(e.startContainer)||t.contains(e.startContainer))){if(e.toString()===""&&e.startContainer.nodeType===1&&e.startOffset===0&&e.startContainer.classList.contains("protyle-wysiwyg")){const a=ae(e.startContainer.firstChild);if(a)return a}return e}t.focus({preventScroll:!0});let n;return t.classList.contains("table")?n=t.querySelector("th")||t.querySelector("td"):(n=le(t),n?n.tagName==="TABLE"&&(n=n.querySelector("th")||t.querySelector("td")):n=t),e=n.ownerDocument.createRange(),e.setStart(n||t,0),e.collapse(!0),e},ta=(t,e)=>{if(e||(e=me(t)),!t.contains(e.startContainer))return{left:0,top:0};let n;if(e.getClientRects().length===0)if(e.startContainer.nodeType===3){const a=e.startContainer.parentElement?.getClientRects(),i=e.startContainer.previousElementSibling?.getClientRects();if(a.length>0||i.length>0)a.length===0||i&&i.length>0&&a[0].top<i[i.length-1].bottom?n={left:i[i.length-1].left,top:i[i.length-1].bottom}:n=a[0];else return{left:0,top:0}}else{const a=e.startContainer.children;if(a[e.startOffset]&&a[e.startOffset].getClientRects().length>0)n=a[e.startOffset].getClientRects()[0];else if(e.startContainer.childNodes.length>0){const i=e.cloneRange();e.selectNode(e.startContainer.childNodes[Math.max(0,e.startOffset-1)]),n=e.getClientRects()[0],e.setEnd(i.endContainer,i.endOffset),e.setStart(i.startContainer,i.startOffset)}else n=e.startContainer.getClientRects()[0];if(!n){let i=e.startContainer.childNodes[e.startOffset];if(i||(i=e.startContainer.childNodes[e.startOffset-1]),!i)n=e.getBoundingClientRect();else{for(;!i.getClientRects||i.getClientRects&&i.getClientRects().length===0;)i=i.parentElement;n=i.getClientRects()[0]}}}else{const a=e.getClientRects();return e.toString()?{left:a[a.length-1].left,top:a[0].top}:{left:a[a.length-1].left,top:a[a.length-1].top}}return{left:n.left,top:n.top}},ct=(t,e,n)=>{const a={end:0,start:0};if(!n){if(getSelection().rangeCount===0)return a;n=window.getSelection().getRangeAt(0)}if(e&&!dT(e,n))return a;const i=n.cloneRange();return t.childNodes[0]&&t.childNodes[0].childNodes[0]?i.setStart(t.childNodes[0].childNodes[0],0):i.selectNodeContents(t),i.setEnd(n.startContainer,n.startOffset),a.start=i.toString().length+i.cloneContents().querySelectorAll("br").length,a.end=a.start+n.toString().length+n.cloneContents().querySelectorAll("br").length,a};function xp(t,e,n,a){if(!e)return!1;if(n(e))return!0;for(let i=0,s=e.childNodes.length;i<s;i++)if(xp(e,e.childNodes[i],n,!0))return!0;if(!a){let i=e;for(;i&&i!==t;){let s=i.nextSibling;for(;s;){if(xp(t,s,n,!0))return!0;s=s.nextSibling}i=i.parentNode}}return!1}const Pt=(t,e,n=!0)=>{if(!t)return e;let a=t.lastChild;for(;a&&a.nodeType!==3;){if(a.nodeType!==3&&a.tagName==="BR")return e;if(!a.lastChild)break;a=a.lastChild}return a||(a=t),n?a.nodeType!==3&&a.classList.contains("render-node")&&a.innerHTML===""?e.setStartAfter(a):e.setStart(a,a.textContent.length):a.nodeType!==3&&a.classList.contains("render-node")&&a.innerHTML===""?e.setStartAfter(a):e.setEnd(a,a.textContent.length),e},xo=(t,e)=>{if(!t)return e;let n=t.firstChild;for(;n&&n.nodeType!==3&&!n.classList.contains("render-node");){if(n.classList.contains("img"))return e.setStartBefore(n),e;n=n.firstChild}return n?(n.nodeType!==3&&n.classList.contains("render-node")?e.setStartBefore(n):e.setStart(n,0),e):(e.selectNodeContents(t),e)},na=(t,e,n,a=!0)=>{if(!t)return!1;const i=le(t);if(i)t=i;else if(Ln(t)||t.classList.contains("av"))return ae(t);let s;xp(t,t.firstChild,r=>{if(r.nodeType===Node.TEXT_NODE){const d=r.data.length;return e<=d?(s=r,!0):(e-=d,n-=d,!1)}});let o;s&&xp(t,s,r=>{if(r.nodeType===Node.TEXT_NODE){const d=r.data.length;return n<=d?(o=r,!0):(n-=d,!1)}});const l=document.createRange();return s?e<s.data.length?l.setStart(s,e):l.setStartAfter(s):e===0?l.setStart(t,0):Pt(le(t),l),o?n<o.data.length?l.setEnd(o,n):l.setEndAfter(o):n===0?l.setEnd(t,0):Pt(le(t),l,!1),a&&Z(l),l},qc=(t,e,n)=>{const a=ct(t,t,e),i=t.cloneNode(!0),s=na(i,a.end,a.end,!1);s&&s.insertNode(document.createElement("wbr")),n.wysiwyg.lastHTMLs[t.getAttribute("data-node-id")]=i.outerHTML},he=(t,e)=>{const n=t.querySelectorAll("wbr");if(n.length===0)return;n.forEach((i,s)=>{s!==0&&i.remove()});const a=n[0];if(!a.previousElementSibling)a.previousSibling?e.setStart(a.previousSibling,a.previousSibling.textContent.length):a.nextSibling?a.nextSibling.nodeType===3?e.setStart(a.nextSibling,0):e.setStartAfter(a):e.setStart(a.parentElement,0);else{const i=At(a);i&&a.previousElementSibling.isSameNode(i)?a.previousElementSibling.lastChild?.nodeType===3?e.setStart(a.previousElementSibling.lastChild,a.previousElementSibling.lastChild.textContent.length):i.nodeType!==3&&i.classList.contains("img")?e.setStartAfter(i):e.setStartBefore(a):e.setStart(a.previousSibling,a.previousSibling.textContent.length)}e.collapse(!0),a.remove(),Z(e)},Z=t=>{if(!t)return;const e=t.startContainer.childNodes[t.startOffset];if(e&&e.nodeType!==3&&["INPUT","TEXTAREA"].includes(e.tagName)){e.focus();return}const n=window.getSelection();n.removeAllRanges(),n.addRange(t)},ae=(t,e,n=!0)=>{if(!t)return!1;if(t.classList.contains("render-node")||t.classList.contains("iframe")||t.classList.contains("hr")||t.classList.contains("av")){const i=document.createRange(),s=t.getAttribute("data-type");let o=!1;if(s==="NodeThematicBreak")i.selectNodeContents(t.firstElementChild),o=!0;else if(s==="NodeBlockQueryEmbed")t.lastElementChild.previousElementSibling?.firstChild?(i.selectNodeContents(t.lastElementChild.previousElementSibling.firstChild),i.collapse(!0)):(i.selectNodeContents(t),i.collapse(!0)),o=!0;else if(["NodeMathBlock","NodeHTMLBlock"].includes(s))t.lastElementChild.previousElementSibling?.lastElementChild?.firstChild?(i.selectNodeContents(t.lastElementChild.previousElementSibling.lastElementChild.firstChild),i.collapse(!0)):t.lastElementChild.previousElementSibling&&(i.selectNodeContents(t.lastElementChild.previousElementSibling),i.collapse(!0)),o=!0;else if(s==="NodeIFrame"||s==="NodeWidget")i.setStart(t,0),o=!0;else if(s==="NodeVideo")i.setStart(t.firstElementChild,0),o=!0;else if(s==="NodeAudio")i.setStart(t.firstElementChild.lastChild,0),o=!0;else if(s==="NodeCodeBlock")i.selectNodeContents(t),i.collapse(!0),o=!0;else if(s==="NodeAttributeView"){const l=t.querySelector(".av__cursor");if(l)i.setStart(l.firstChild,0),o=!0;else return!1}return o?(Z(i),i):(wb(t),!1)}let a;if(n?a=le(t):Array.from(t.querySelectorAll('[contenteditable="true"]')).reverse().find(i=>{if(i.getBoundingClientRect().width>0)return a=i,!0}),a){if(a.tagName==="TABLE")if(n)a=a.querySelector("th, td");else{const s=a.querySelectorAll("th, td");a=s[s.length-1]}let i;if(n)i=xo(a,me(a)),i.collapse(!0);else{let s=!1;if(a.classList.contains("hljs")){let o=a.lastChild;if(o||(a.innerHTML=`
`,o=a.lastChild),o.textContent===""&&o.nodeType===3&&(o=At(a.lastChild)),o&&o.textContent.endsWith(`
`)){if(o.nodeType===1)for(o=o.lastChild;o&&o.textContent.indexOf(`
`)===-1;)o=o.previousSibling;i=me(a),i.setStart(o,o.textContent.length-1),s=!0}}s||(i=Pt(a,me(a))),i.collapse(!1)}return Z(i),i}else if(e)e.focus();else if(t.classList.contains("li"))return ae(t.querySelector("[data-node-id]"),e,n);return!1},wb=t=>{if(t.getAttribute("data-node-id")){let n,a;t.nextElementSibling&&!t.nextElementSibling.classList.contains("protyle-attr")?(a=!0,n=et(t)):t.previousElementSibling&&(a=!1,n=Pe(t)),n||(n=t),ae(n,void 0,a);return}const e=me(t);t.nextSibling?(e.selectNodeContents(t.nextSibling),e.collapse(!0)):t.previousSibling&&(e.selectNodeContents(t.previousSibling),e.collapse(!1)),Z(e)},Ap=(t,e,n)=>{e&&(Pt(le(n[n.length-1]),t.toolbar.range),t.toolbar.range.collapse(!0),wt(e,t,!0,!0),Be(t,t.wysiwyg.element),yt(t.wysiwyg.element),ze(t.wysiwyg.element))},uT=(t,e)=>{const n=new we({title:window.siyuan.languages.update,content:`<div class="b3-dialog__content">
    <input class="b3-text-field fn__block" placeholder="${window.siyuan.languages.memo}">
    <div class="fn__hr"></div>
    <textarea class="b3-text-field fn__block" placeholder="${window.siyuan.languages.aiCustomAction}"></textarea>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--remove">${window.siyuan.languages.delete}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:W()?"92vw":"520px"});n.element.setAttribute("data-key",u.DIALOG_AIUPDATECUSTOMACTION);const a=n.element.querySelector("input");a.value=t;const i=n.element.querySelector("textarea"),s=n.element.querySelectorAll(".b3-button");n.bindInput(i,()=>{s[2].click()}),i.value=e,s[1].addEventListener("click",()=>{n.destroy()}),s[2].addEventListener("click",()=>{window.siyuan.storage[u.LOCAL_AI].find(o=>{if(t===o.name&&e===o.memo)return o.name=a.value,o.memo=i.value,ue(u.LOCAL_AI,window.siyuan.storage[u.LOCAL_AI]),!0}),n.destroy()}),s[0].addEventListener("click",()=>{window.siyuan.storage[u.LOCAL_AI].find((o,l)=>{if(t===o.name&&e===o.memo)return window.siyuan.storage[u.LOCAL_AI].splice(l,1),ue(u.LOCAL_AI,window.siyuan.storage[u.LOCAL_AI]),!0}),n.destroy()}),a.focus()},OE=(t,e,n)=>{const a=new we({title:window.siyuan.languages.aiCustomAction,content:`<div class="b3-dialog__content">
    <input class="b3-text-field fn__block" value="" placeholder="${window.siyuan.languages.memo}">
    <div class="fn__hr"></div>
    <textarea class="b3-text-field fn__block" placeholder="${window.siyuan.languages.aiCustomAction}"></textarea>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.use}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.save}</button>
</div>`,width:W()?"92vw":"520px"});a.element.setAttribute("data-key",u.DIALOG_AICUSTOMACTION);const i=a.element.querySelector("input"),s=a.element.querySelector("textarea"),o=a.element.querySelectorAll(".b3-button");a.bindInput(s,()=>{o[1].click()}),o[0].addEventListener("click",()=>{a.destroy()}),o[1].addEventListener("click",()=>{if(!s.value){j(window.siyuan.languages._kernel[142]);return}E("/api/ai/chatGPTWithAction",{ids:e,action:s.value},l=>{a.destroy(),Ap(t,l.data,n)})}),o[2].addEventListener("click",()=>{if(!i.value&&!s.value){j(window.siyuan.languages._kernel[142]);return}window.siyuan.storage[u.LOCAL_AI].push({name:i.value,memo:s.value}),ue(u.LOCAL_AI,window.siyuan.storage[u.LOCAL_AI]),a.destroy()}),i.focus()},BE=(t,e)=>{t.querySelectorAll(".b3-list-item").forEach(n=>{n.textContent.indexOf(e.value)>-1?n.classList.remove("fn__none"):n.classList.add("fn__none")}),t.querySelectorAll(".b3-menu__separator").forEach(n=>{e.value?n.classList.add("fn__none"):n.classList.remove("fn__none")}),t.querySelector(".b3-list-item--focus").classList.remove("b3-list-item--focus"),t.querySelector(".b3-list-item:not(.fn__none)").classList.add("b3-list-item--focus")},_b=(t,e)=>{window.siyuan.menus.menu.remove();const n=[];t.forEach(l=>{n.push(l.getAttribute("data-node-id"))});const a=new st("ai",()=>{Z(e.toolbar.range)});let i="";window.siyuan.storage[u.LOCAL_AI].forEach((l,r)=>{i+=`<div data-action="${Xe(l.memo||l.name)}" data-index="${r}" class="b3-list-item b3-list-item--narrow ariaLabel" aria-label="${Rt(l.memo)}">
    <span class="b3-list-item__text">${pe(l.name)}</span>
    <span data-type="edit" class="b3-list-item__action"><svg><use xlink:href="#iconEdit"></use></svg></span>
</div>`}),i&&(i=`<div class="b3-menu__separator"></div>${i}`);const s="Clear context";a.addItem({iconHTML:"",type:"empty",label:`<div class="fn__flex-column b3-menu__filter">
    <input class="b3-text-field fn__flex-shrink" placeholder="${window.siyuan.languages.ai}"/>
    <div class="fn__hr"></div>
    <div class="b3-list fn__flex-1 b3-list--background">
       <div class="b3-list-item b3-list-item--narrow b3-list-item--focus" data-action="Continue writing">
            ${window.siyuan.languages.aiContinueWrite}
        </div>
        <div class="b3-menu__separator"></div>
        <div class="b3-list-item b3-list-item--narrow" data-action="${window.siyuan.languages.aiExtractSummary}">
            ${window.siyuan.languages.aiExtractSummary}
        </div>
        <div class="b3-list-item b3-list-item--narrow" data-action="${window.siyuan.languages.aiBrainStorm}">
            ${window.siyuan.languages.aiBrainStorm}
        </div>
        <div class="b3-list-item b3-list-item--narrow" data-action="${window.siyuan.languages.aiFixGrammarSpell}">
            ${window.siyuan.languages.aiFixGrammarSpell}
        </div>
        <div class="b3-list-item b3-list-item--narrow" data-action="${s}">
            ${window.siyuan.languages.clearContext}
        </div>
        <div class="b3-menu__separator"></div>
        <div class="b3-list-item b3-list-item--narrow" data-type="custom">
            ${window.siyuan.languages.aiCustomAction}
        </div>
        ${i}
    </div>
</div>`,bind(l){const r=l.querySelector(".b3-list"),d=l.querySelector("input");d.addEventListener("keydown",c=>{if(c.isComposing)return;if(xn(r,c)&&c.stopPropagation(),c.key==="Enter"){c.preventDefault(),c.stopPropagation();const g=r.querySelector(".b3-list-item--focus");g.dataset.type==="custom"?(OE(e,n,t),a.close()):(E("/api/ai/chatGPTWithAction",{ids:n,action:g.dataset.action},p=>{Ap(e,p.data,t)}),g.dataset.action===s?j(window.siyuan.languages.clearContextSucc):a.close())}}),d.addEventListener("compositionend",()=>{BE(l,d)}),d.addEventListener("input",c=>{c.isComposing||BE(l,d)}),l.addEventListener("click",c=>{let f=c.target;for(;f&&!f.isSameNode(l);){if(f.classList.contains("b3-list-item__action")){const g=window.siyuan.storage[u.LOCAL_AI][f.parentElement.dataset.index];uT(g.name,g.memo),a.close(),c.stopPropagation(),c.preventDefault();break}else if(f.classList.contains("b3-list-item")){f.dataset.type==="custom"?(OE(e,n,t),a.close()):(E("/api/ai/chatGPTWithAction",{ids:n,action:f.dataset.action},g=>{Ap(e,g.data,t)}),f.dataset.action===s?j(window.siyuan.languages.clearContextSucc):a.close()),c.stopPropagation(),c.preventDefault();break}f=f.parentElement}})}}),a.element.querySelector(".b3-menu__items").setAttribute("style","overflow: initial");const o=t[t.length-1].getBoundingClientRect();a.open({x:o.left,y:o.bottom,h:o.height}),a.element.querySelector("input").focus()},qE=(t,e)=>{const n=new we({title:"\u2728 "+window.siyuan.languages.aiWriting,content:`<div class="b3-dialog__content"><textarea class="b3-text-field fn__block"></textarea></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:W()?"92vw":"520px"}),a=n.element.querySelector("textarea"),i=n.element.querySelectorAll(".b3-button");n.bindInput(a,()=>{i[1].click()}),a.focus(),i[0].addEventListener("click",()=>{n.destroy()}),i[1].addEventListener("click",()=>{let s=a.value;E("/api/ai/chatGPT",{msg:s},o=>{n.destroy();let l="";o.data&&o.data!==""&&(l=`

`+o.data),s==="Clear context"&&(s=""),Ap(t,`${s}${l}`,[e])})})};class fT{constructor(e){this.enableSlash=!0,this.enableEmoji=!0,this.enableExtend=!1,this.splitChar="",this.lastIndex=-1,this.element=document.createElement("div"),this.element.setAttribute("data-close","false"),this.element.className="protyle-hint b3-list b3-list--background fn__none",this.element.addEventListener("click",n=>{const a=n.target;if(a.tagName==="INPUT"){n.stopPropagation();return}const i=q(a,"BUTTON");if(i&&!i.classList.contains("emojis__item")&&!i.classList.contains("emojis__type")){this.fill(decodeURIComponent(i.getAttribute("data-value")),e,!1,this.source==="search"?qe(n):Dt(n)),n.preventDefault(),n.stopPropagation();return}const s=this.element.querySelector(".emojis__panel"),o=L(a,"emojis__type");if(o){const r=s.querySelector(`[data-type="${o.getAttribute("data-type")}"]`);if(r){const d=r.nextElementSibling.getAttribute("data-index");if(d){let c="";window.siyuan.emojis[parseInt(d)].items.forEach(f=>{c+=`<button data-unicode="${f.unicode}" class="emojis__item ariaLabel" aria-label="${Xs(f)}">
${ge(f.unicode)}</button>`}),r.nextElementSibling.innerHTML=c,r.nextElementSibling.removeAttribute("data-index")}s.scrollTo({top:r.offsetTop})}return}const l=L(a,"emojis__item");if(l){const r=l.getAttribute("data-unicode");if(this.element.querySelectorAll(".emojis__title").length>2){const d=getSelection().getRangeAt(0);d.endContainer.nodeType!==3?d.endContainer.childNodes[d.endOffset-1]?.remove():d.endContainer.textContent===":"&&(d.endContainer.textContent=""),Zs(r);let c;r.indexOf(".")>-1?c=`:${r.split(".")[0]}: `:c=ge(r)+" ",wt(e.lute.SpinBlockDOM(c),e,!1,!0),this.element.classList.add("fn__none")}else this.fill(r,e)}})}render(e){if(!window.getSelection().focusNode){this.element.classList.add("fn__none"),clearTimeout(this.timeId);return}if(!this.enableExtend){clearTimeout(this.timeId);return}if(e.toolbar.range=getSelection().getRangeAt(0),e.toolbar.range.startContainer.nodeType===3&&e.toolbar.range.startContainer.textContent===""){const s=At(e.toolbar.range.startContainer);if(s&&s.nodeType===3){if(s.wholeText!==s.textContent){let o=s.previousSibling;for(;o&&o.nodeType===3;)if(o.textContent==="")o=o.previousSibling,o.nextSibling.remove();else{s.textContent=o.textContent+s.textContent,o.remove();break}}e.toolbar.range.setStart(s,s.textContent.length),e.toolbar.range.collapse(!0)}}const n=ct(e.toolbar.range.startContainer,e.wysiwyg.element).start,a=e.toolbar.range.startContainer.textContent.substring(0,n)||"",i=this.getKey(a,e.options.hint.extend);if(typeof i>"u"||B(e.toolbar.range.startContainer,"data-type","code")||B(e.toolbar.range.startContainer,"data-type","NodeCodeBlock")){this.element.classList.add("fn__none"),clearTimeout(this.timeId);return}if(this.splitChar==="#"){const s=P(e.toolbar.range.startContainer);if(s&&s.getAttribute("data-type")==="NodeHeading"){const o=ct(e.toolbar.range.startContainer,s).start;if(s.textContent.startsWith("#".repeat(o))){this.element.classList.add("fn__none"),clearTimeout(this.timeId);return}}}if(this.splitChar===":"){clearTimeout(this.timeId),i?this.genEmojiHTML(e,i):this.element.classList.add("fn__none");return}if(this.splitChar==="/"||this.splitChar==="\u3001"){clearTimeout(this.timeId),this.enableSlash&&!W()&&this.genHTML(om(i,e),e,!1,"hint");return}e.options.hint.extend.forEach(s=>{s.key===this.splitChar&&(clearTimeout(this.timeId),this.timeId=window.setTimeout(()=>{this.genHTML(s.hint(i,e,"hint"),e,!1,"hint")},e.options.hint.delay))})}genLoading(e){if(this.element.classList.contains("fn__none")){this.element.innerHTML='<div class="fn__loading" style="height: 128px;position: initial"><img width="64px" src="/stage/loading-pure.svg"></div>',this.element.classList.remove("fn__none");const n=ta(e.wysiwyg.element);ke(this.element,n.left,n.top+26,30)}else this.element.insertAdjacentHTML("beforeend",'<div class="fn__loading"><img width="64px" src="/stage/loading-pure.svg"></div>')}bindUploadEvent(e,n){n.querySelectorAll('input[type="file"]').forEach(a=>{a.addEventListener("change",i=>{if(i.target.files.length===0)return;const s=me(e.wysiwyg.element);this.lastIndex>-1&&s.setStart(s.startContainer,this.lastIndex),s.deleteContents(),ii(e,i.target.files,i.target),Q(["hint","toolbar"],e)})})}getHTMLByData(e){let n='<div style="flex: 1;overflow:auto;">';return this.source!=="hint"&&(n='<input style="margin:0 8px 4px 8px" class="b3-text-field"><div style="flex: 1;overflow:auto;">'),e.forEach((a,i)=>{let s="";(i===1&&e[i].focus||i===0&&(e.length===1||!e[1].focus))&&(s=" b3-list-item--focus"),a.html==="separator"?n+=`<button data-id="${a.id||""}" class="b3-menu__separator"></button>`:n+=`<button data-id="${a.id||""}" style="width: calc(100% - 16px)" class="b3-list-item b3-list-item--two${s}" data-value="${encodeURIComponent(a.value)}">${a.html}</button>`}),`${n}</div>`}genHTML(e,n,a=!1,i){if(this.source=i,e.length===0){(!this.element.querySelector(".fn__loading")||a)&&this.element.classList.add("fn__none");return}if(this.element.innerHTML=this.getHTMLByData(e),this.element.classList.remove("fn__none"),e[0].filter?this.element.classList.add("hint--menu"):this.element.classList.remove("hint--menu"),this.source==="av"){const s=L(n.toolbar.range.startContainer,"av__cell");if(s){const o=s.getBoundingClientRect();ke(this.element,o.left,o.bottom,o.height)}}else{const s=ta(n.wysiwyg.element);ke(this.element,s.left,s.top+26,30)}if(this.element.scrollTop=0,this.bindUploadEvent(n,this.element),this.source!=="hint"){const s=this.element.querySelector("input.b3-text-field"),o=this.element.querySelector("mark")?.textContent||"";s.value=o,s.select(),s.addEventListener("keydown",r=>{r.key!=="Meta"&&r.key!=="Control"&&r.stopPropagation(),!r.isComposing&&(xn(this.element.lastElementChild,r),r.key==="Enter"?(this.fill(decodeURIComponent(this.element.querySelector(".b3-list-item--focus").getAttribute("data-value")),n,!1,qe(r)),r.preventDefault()):r.key==="Escape"&&(this.element.classList.add("fn__none"),Z(n.toolbar.range)))});const l=n.toolbar.range?P(n.toolbar.range.startContainer):!1;s.addEventListener("input",r=>{r.isComposing||(r.stopPropagation(),this.genSearchHTML(n,s,l,o,i))}),s.addEventListener("compositionend",r=>{r.stopPropagation(),this.genSearchHTML(n,s,l,o,i)})}}genSearchHTML(e,n,a,i,s){this.element.lastElementChild.innerHTML='<div class="ft__center"><img style="height:32px;width:32px;" src="/stage/loading-pure.svg"></div>',E("/api/search/searchRefBlock",{k:n.value,id:a?a.getAttribute("data-node-id"):e.block.parentID,beforeLen:Math.floor((Math.max(e.element.clientWidth/2,320)-58)/28.8),rootID:s==="av"?"":e.block.rootID,isDatabase:s==="av"},o=>{let l="";if(o.data.newDoc){const r=`((newFile "${i}"${u.ZWSP}'${o.data.k}${Lute.Caret}'))`;l+=`<button style="width: calc(100% - 16px)" class="b3-list-item b3-list-item--two${o.data.blocks.length===0?" b3-list-item--focus":""}" data-value="${encodeURIComponent(r)}"><div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg>
<span class="b3-list-item__text">${window.siyuan.languages.newFile} <mark>${o.data.k}</mark></span></div></button>`}o.data.blocks.forEach((r,d)=>{let c;if(s==="av"){let f=r.name||r.refText.replace(new RegExp(u.ZWSP,"g"),"");a&&(f=r.ial["custom-sy-av-s-text-"+a.getAttribute("data-av-id")]||f),c=`<span data-type="block-ref" data-id="${r.id}" data-subtype="s">${f}</span>`}else c=`<span data-type="block-ref" data-id="${r.id}" data-subtype="s">${i}</span>`;l+=`<button style="width: calc(100% - 16px)" class="b3-list-item b3-list-item--two${d===0?" b3-list-item--focus":""}" data-value="${encodeURIComponent(c)}">
${lm(r)}
</button>`}),l===""&&(l=`<button style="width: calc(100% - 16px)" class="b3-list-item b3-list-item--two" data-value="">${window.siyuan.languages.emptyContent}</button>`),this.element.lastElementChild.innerHTML=l,ke(this.element,parseInt(this.element.style.left),parseInt(this.element.style.right))})}genEmojiHTML(e,n=""){if(n&&!this.enableEmoji)return;const a=this.element.querySelector(".emojis__panel");a?(a.innerHTML=Kr(n,256),n?a.nextElementSibling.classList.add("fn__none"):a.nextElementSibling.classList.remove("fn__none"),jr(a)):(this.element.innerHTML=`<div style="padding:0;max-height:min(402px,40vh);width:366px" class="emojis">
<div class="emojis__panel">${Kr(n,256)}</div>
<div class="fn__flex${n?" fn__none":""}">
    ${[["2b50",window.siyuan.languages.recentEmoji],["1f527",nn(0)],["1f60d",nn(1)],["1f433",nn(2)],["1f96a",nn(3)],["1f3a8",nn(4)],["1f3dd-fe0f",nn(5)],["1f52e",nn(6)],["267e-fe0f",nn(7)],["1f6a9",nn(8)]].map(([s,o],l)=>`<button data-type="${l}" class="emojis__type ariaLabel" aria-label="${o}">${ge(s)}</button>`).join("")}
</div>
</div>`,af(this.element),jr(this.element));const i=this.element.querySelector(".emojis__item");if(i){i.classList.add("emojis__item--current"),this.element.classList.remove("fn__none");const s=ta(e.wysiwyg.element);ke(this.element,s.left,s.top+26,30),this.element.querySelector(".emojis__panel").scrollTop=0}else this.element.classList.add("fn__none")}fill(e,n,a=!0,i=!1){Q(["hint","toolbar"],n),a&&this.source!=="av"&&(n.toolbar.range=me(n.wysiwyg.element));const s=n.toolbar.range;let o=P(n.toolbar.range.startContainer);if(!o)return;if(this.source==="av"){let c=L(n.toolbar.range.startContainer,"av__cell");if(c||(c=o.querySelector(".av__cell--select")),!c)return;const f=L(c,"av__row");if(!f)return;const g=c.dataset.blockId,p=o.getAttribute("data-av-id");let h=document.createElement("div");if(h.innerHTML=e.replace(/<mark>/g,"").replace(/<\/mark>/g,""),h=h.firstElementChild,e.startsWith("((newFile ")&&e.endsWith(`${Lute.Caret}'))`)){const m=e.substring(11,e.length-4).split(`"${u.ZWSP}'`),b=m.length===1?m[0]:m[1],y=Lute.NewNodeID();f.dataset.id=y,Wh(n.path,n.notebookId,(w,_)=>{E("/api/filetree/createDocWithMd",{notebook:_,path:Ee().join(w,b),parentID:n.notebookId===_?n.block.rootID:"",markdown:"",id:y},()=>{U(n,[{action:"replaceAttrViewBlock",avID:p,previousID:g,nextID:y,isDetached:!1}],[{action:"replaceAttrViewBlock",avID:p,previousID:y,nextID:g,isDetached:!0}])})}),gn(c,{type:"block",isDetached:!1,block:{content:b,id:y}})}else{const m=h.getAttribute("data-id");f.dataset.id=m,U(n,[{action:"replaceAttrViewBlock",avID:p,previousID:g,nextID:m,isDetached:!1}],[{action:"replaceAttrViewBlock",avID:p,previousID:m,nextID:g,isDetached:!0}]),gn(c,{type:"block",isDetached:!1,block:{content:h.textContent,id:m}})}return}this.enableExtend=!1;let l="";o&&(l=o.getAttribute("data-node-id"));const r=o.outerHTML,d=u.BLOCK_HINT_CLOSE_KEYS[this.splitChar];if(u.BLOCK_HINT_KEYS.includes(this.splitChar)&&d&&s.startContainer.nodeType===3&&s.startContainer.wholeText.indexOf(d)>-1&&s.startContainer.wholeText.indexOf(this.splitChar)>-1){let c=0,f=s.startContainer;for(;f&&c<2;){const g=f.textContent.indexOf(d),p=f.textContent.indexOf(this.splitChar);if(g>-1&&(g<p||p<0)){c=2,s.setEnd(f,g+2);break}const h=f.textContent.indexOf(d.substr(1));if(h>-1&&(c+=1),c===2){s.setEnd(f,h+1);break}f=f.nextSibling}}if(this.lastIndex>-1&&(s.setStart(s.startContainer,this.lastIndex),nf()&&Z(s)),u.BLOCK_HINT_KEYS.includes(this.splitChar)&&e.startsWith("((newFile ")&&e.endsWith(`${Lute.Caret}'))`)){const c=e.substring(11,e.length-4).split(`"${u.ZWSP}'`),f=c.length===1?c[0]:c[1];Wh(n.path,n.notebookId,(g,p)=>{E("/api/filetree/createDocWithMd",{notebook:p,path:Ee().join(g,f),parentID:n.notebookId===p?n.block.rootID:"",markdown:""},h=>{n.toolbar.range=s,n.toolbar.setInlineMark(n,"block-ref","range",{type:"id",color:`${h.data}${u.ZWSP}${i?"s":"d"}${u.ZWSP}${(i?c[0]:f).substring(0,window.siyuan.config.editor.blockRefDynamicAnchorTextMaxLen)}`})})});return}if(u.BLOCK_HINT_KEYS.includes(this.splitChar)){if(e===""){const f=le(o);f.textContent===""&&(f.innerHTML="<wbr>",he(f,s));return}let c=document.createElement("div");if(c.innerHTML=e.replace(/<mark>/g,"").replace(/<\/mark>/g,""),c=c.firstElementChild,i){const f=s.toString().replace(this.splitChar,"");f&&(c.setAttribute("data-subtype","s"),c.innerText=f)}else{c.setAttribute("data-subtype","d");const f=c.innerText.split(u.ZWSP);f.length===2&&(c.innerText=f[1])}n.toolbar.setInlineMark(n,"block-ref","range",{type:"id",color:`${c.getAttribute("data-id")}${u.ZWSP}${c.getAttribute("data-subtype")}${u.ZWSP}${c.textContent}`});return}else if(this.splitChar===":"){Zs(e);let c;e.indexOf(".")>-1?c=`:${e.split(".")[0]}: `:c=ge(e)+" ",wt(n.lute.SpinBlockDOM(c),n)}else if(["\u300C\u300C","\u300C\u300E","\u300E\u300C","\u300E\u300E","{{"].includes(this.splitChar)||this.splitChar==="#"||this.splitChar===":"){if(e===""){const c=le(o);c.textContent===""&&(c.innerHTML="<wbr>",he(c,s));return}wt(n.lute.SpinBlockDOM(e),n,!1,W()),Be(n,n.wysiwyg.element);return}else if(this.splitChar==="/"||this.splitChar==="\u3001")if(this.enableExtend=!0,e==="(("||e==="{{"){e==="(("?ss("",n,"hint"):Cl("",n),this.splitChar=e,this.lastIndex=0,s.deleteContents();const c=document.createTextNode(e);s.insertNode(c),s.setEnd(c,e.length),s.collapse(!1),Z(s);return}else if(e===u.ZWSP){s.deleteContents(),this.fixImageCursor(s),n.toolbar.showTpl(n,o,s),J(n,l,o.outerHTML,r);return}else if(e===u.ZWSP+1){s.deleteContents(),this.fixImageCursor(s),n.toolbar.showWidget(n,o,s),J(n,l,o.outerHTML,r);return}else if(e===u.ZWSP+2){s.deleteContents(),this.fixImageCursor(s),n.toolbar.range=s;const c=ta(o,s);dm(n,{x:c.left,y:c.top+26,w:0,h:26}),J(n,l,o.outerHTML,r);return}else if(e===u.ZWSP+3){s.deleteContents();return}else if(e===u.ZWSP+4){xi({app:n.app,notebookId:n.notebookId,useSavePath:!0,currentPath:n.path,afterCB:(c,f)=>{wt(`<span data-type="block-ref" data-id="${c}" data-subtype="d">${f}</span>`,n)}});return}else if(e===u.ZWSP+6){const c=Lute.NewNodeID();E("/api/filetree/createDoc",{notebook:n.notebookId,path:Ee().join(nt(n.path,!1,!0),c+".sy"),title:window.siyuan.languages.untitled,md:""},()=>{wt(`<span data-type="block-ref" data-id="${c}" data-subtype="d">${window.siyuan.languages.untitled}</span>`,n),de({app:n.app,id:c,action:[u.CB_GET_CONTEXT,u.CB_GET_OPENNEW]})});return}else if(e===u.ZWSP+5){s.deleteContents(),qE(n,o);return}else if(u.INLINE_TYPE.includes(e)){if(s.deleteContents(),Z(s),["a","block-ref","inline-math","inline-memo","text"].includes(e)){n.toolbar.element.querySelector(`[data-type="${e}"]`).dispatchEvent(new CustomEvent("click"));return}n.toolbar.setInlineMark(n,e,"range");return}else if(e==="emoji"){s.deleteContents(),s.insertNode(document.createTextNode(":")),s.collapse(!1),Z(s),this.genEmojiHTML(n);return}else if(e.indexOf("style")>-1){s.deleteContents(),this.fixImageCursor(s),o.setAttribute("style",e.split(u.ZWSP)[1]||""),J(n,l,o.outerHTML,r);return}else if(e.startsWith("plugin")){n.app.plugins.find(c=>{const f=e.split(u.ZWSP);if(f[1]===c.name)return c.protyleSlash.find(g=>{if(g.id===f[2])return g.callback(n.getInstance(),o),!0}),!0});return}else{s.deleteContents(),e!=="![]()"&&this.fixImageCursor(s);let c=e;e==="```"&&(c=e+(u.SIYUAN_RENDER_CODE_LANGUAGES.includes(window.siyuan.storage[u.LOCAL_CODELANG])?"":window.siyuan.storage[u.LOCAL_CODELANG])+Lute.Caret+"\n```");const f=le(o);if(e==="![]()"){let g="";s.insertNode(document.createElement("wbr")),s.insertNode(document.createTextNode(e)),g=n.lute.SpinBlockDOM(o.outerHTML),o.outerHTML=g,o=n.wysiwyg.element.querySelector(`[data-node-id="${l}"]`),he(o,s),J(n,l,o.outerHTML,r);let p=s.startContainer.childNodes[s.startOffset-1]||s.startContainer;p&&p.nodeType!==3&&p.classList.contains("img")||(p.previousSibling?.nodeType!==3&&p.previousSibling.classList.contains("img")?p=p.previousSibling:Array.from(o.querySelectorAll(".img")).find(m=>{if(m.querySelector("img").getAttribute("data-src")==="")return p=m,!0}));const h=p.getBoundingClientRect();gm(n,s,p,{clientX:h.left,clientY:h.top});return}else if(f.textContent===""&&o.getAttribute("data-type")==="NodeParagraph"){let g="";e==="<div>"?g=`<div data-node-id="${l}" data-type="NodeHTMLBlock" class="render-node" data-subtype="block">${ki()}<div><protyle-html data-content=""></protyle-html><span style="position: absolute">${u.ZWSP}</span></div><div class="protyle-attr" contenteditable="false"></div></div>`:(f.textContent=c,g=n.lute.SpinBlockDOM(o.outerHTML)),o.outerHTML=g,o=n.wysiwyg.element.querySelector(`[data-node-id="${l}"]`),o.getAttribute("data-type")==="NodeTable"&&(o.querySelectorAll("colgroup col").forEach(p=>{p.style.minWidth="60px"}),g=o.outerHTML),J(n,l,g,r)}else{let g=n.lute.SpinBlockDOM(c);e==="<div>"&&(g=`<div data-node-id="${Lute.NewNodeID()}" data-type="NodeHTMLBlock" class="render-node" data-subtype="block">${ki()}<div><protyle-html data-content=""></protyle-html><span style="position: absolute">${u.ZWSP}</span></div><div class="protyle-attr" contenteditable="false"></div></div>`),o.insertAdjacentHTML("afterend",g);const p=o.outerHTML,h=g.substr(g.indexOf('data-node-id="')+14,22);o=n.wysiwyg.element.querySelector(`[data-node-id="${h}"]`),o.getAttribute("data-type")==="NodeTable"&&o.querySelectorAll("colgroup col").forEach(m=>{m.style.minWidth="60px"}),U(n,[{data:p,id:l,action:"update"},{data:o.outerHTML,id:h,previousID:l,action:"insert"}],[{id:h,action:"delete"},{data:r,id:l,action:"update"}])}if(e==="<div>"||e==="$$"||e.indexOf("```")>-1&&(e.length>3||o.classList.contains("render-node")))n.toolbar.showRender(n,o),yt(o);else if(e.startsWith("```"))ze(o);else if(e.startsWith("<iframe")||e.startsWith("<video")||e.startsWith("<audio")){n.gutter.renderMenu(n,o);const g=o.getBoundingClientRect();window.siyuan.menus.menu.popup({x:g.left,y:g.top,isLeft:!0});const p=window.siyuan.menus.menu.element.querySelector('[data-id="assetVideo"], [data-id="assetAudio"], [data-id="assetIFrame"]');p.classList.add("b3-menu__item--show"),window.siyuan.menus.menu.showSubMenu(p.querySelector(".b3-menu__submenu")),window.siyuan.menus.menu.element.querySelector("textarea").focus()}else e==="---"?ae(o):o.classList.contains("av")?dt(o,n,()=>{o.querySelector(".av__title").focus()}):he(o,s)}}select(e,n){const a=this.element.firstElementChild.classList.contains("emojis");if(this.element.querySelectorAll("button").length===0&&!a)return!1;if(e.key==="Enter"){if(a){const i=this.element.querySelector(".emojis__item--current");if(!i)return!1;const s=i.getAttribute("data-unicode");if(this.element.querySelectorAll(".emojis__title").length>2){const o=getSelection().getRangeAt(0);o.endContainer.nodeType!==3&&o.endContainer.childNodes[o.endOffset-1]?.remove(),Zs(s);let l;s.indexOf(".")>-1?l=`:${s.split(".")[0]}: `:l=ge(s)+" ",wt(n.lute.SpinBlockDOM(l),n),this.element.classList.add("fn__none")}else this.fill(s,n)}else{const i=decodeURIComponent(this.element.querySelector(".b3-list-item--focus").getAttribute("data-value"));i===u.ZWSP+3?this.element.querySelector(".b3-list-item--focus input").click():this.fill(i,n,!0,Dt(e))}return e.preventDefault(),e.stopPropagation(),!0}if(a){const i=this.element.querySelector(".emojis__item--current");if(!i)return!1;let s;if(e.key==="ArrowLeft")i.previousElementSibling?(i.classList.remove("emojis__item--current"),s=i.previousElementSibling):i.parentElement.previousElementSibling?.previousElementSibling&&(i.classList.remove("emojis__item--current"),s=i.parentElement.previousElementSibling.previousElementSibling.lastElementChild);else if(e.key==="ArrowRight")i.nextElementSibling?(i.classList.remove("emojis__item--current"),s=i.nextElementSibling):i.parentElement.nextElementSibling?.nextElementSibling&&(i.classList.remove("emojis__item--current"),s=i.parentElement.nextElementSibling.nextElementSibling.firstElementChild);else if(e.key==="ArrowDown"){if(i.nextElementSibling){i.classList.remove("emojis__item--current");let o=Math.floor(i.parentElement.clientWidth/(i.clientWidth+2));for(s=i;s.nextElementSibling&&o>0;)s=s.nextElementSibling,o--}else{const o=i.parentElement.nextElementSibling?.nextElementSibling;o&&(s=o.firstElementChild,i.classList.remove("emojis__item--current"))}e.preventDefault(),e.stopPropagation()}else if(e.key==="ArrowUp"){if(i.previousElementSibling){i.classList.remove("emojis__item--current");let o=Math.floor(i.parentElement.clientWidth/(i.clientWidth+2));for(s=i;s.previousElementSibling&&o>0;)s=s.previousElementSibling,o--}else{const o=i.parentElement.previousElementSibling?.previousElementSibling;o&&(s=o.lastElementChild,i.classList.remove("emojis__item--current"))}e.preventDefault(),e.stopPropagation()}if(s){s.classList.add("emojis__item--current");const o=this.element.querySelector(".emojis__panel");if(s.offsetTop-8<o.scrollTop)o.scrollTop=s.offsetTop-8;else{const l=o.nextElementSibling.classList.contains("fn__none")?8:36;s.offsetTop+l-this.element.clientHeight+s.clientHeight>o.scrollTop&&(o.scrollTop=s.offsetTop+l-this.element.clientHeight+s.clientHeight)}}return e.preventDefault(),e.stopPropagation(),!0}else if(e.key==="ArrowDown"||e.key==="ArrowUp")return xn(this.element.firstElementChild,e),e.preventDefault(),e.stopPropagation(),!0;return e.key==="ArrowLeft"||e.key==="ArrowRight"?(Q(["hint"],n),!0):!1}fixImageCursor(e){const n=At(e.startContainer);n&&n.nodeType!==3&&n.classList.contains("img")&&(Oe(n)||(e.insertNode(document.createTextNode(u.ZWSP)),e.collapse(!1)))}getKey(e,n){if(this.lastIndex=-1,this.splitChar="",n.forEach(s=>{let o=e.lastIndexOf(s.key);u.BLOCK_HINT_KEYS.includes(s.key)&&o>-1&&e.lastIndexOf(s.key+s.key.substring(0,1))>-1&&(o=Math.min(o,e.lastIndexOf(s.key+s.key.substring(0,1)))),this.lastIndex<o&&(u.BLOCK_HINT_KEYS.includes(this.splitChar)&&(s.key===":"||s.key==="#"||s.key==="/"||s.key==="\u3001")||this.splitChar==="#"&&(s.key==="/"||s.key==="\u3001")||(this.splitChar=s.key,this.lastIndex=o))}),this.lastIndex===-1)return;this.splitChar===":"&&(this.enableEmoji=!(/\d/.test(e.substr(this.lastIndex-1,1))||e.substr(this.lastIndex-1,2)==="::"));const a=e.split(this.splitChar),i=a[a.length-1];if(a.length>1&&i.trimStart()===i&&i.length<u.SIZE_TITLE)return this.splitChar==="\u3010\u3010"&&e.endsWith("\u3010\u3010\u3011")?"":i}}const pT=t=>{const e=Lute.New();if(e.SetSpellcheck(window.siyuan.config.editor.spellcheck),e.SetProtyleMarkNetImg(window.siyuan.config.editor.displayNetImgMark),e.SetFileAnnotationRef(!0),e.SetHTMLTag2TextMark(!0),e.SetTextMark(!0),e.SetHeadingID(!1),e.SetYamlFrontMatter(!1),e.PutEmojis(t.emojis),e.SetEmojiSite(t.emojiSite),e.SetHeadingAnchor(t.headingAnchor),e.SetInlineMathAllowDigitAfterOpenMarker(!0),e.SetToC(!1),e.SetIndentCodeBlock(!1),e.SetParagraphBeginningSpace(!0),e.SetSetext(!1),e.SetFootnotes(!1),e.SetLinkRef(!1),e.SetSanitize(t.sanitize),e.SetChineseParagraphBeginningSpace(t.paragraphBeginningSpace),e.SetRenderListStyle(t.listStyle),e.SetImgPathAllowSpace(!0),e.SetKramdownIAL(!0),e.SetTag(!0),e.SetSuperBlock(!0),e.SetMark(!0),e.SetInlineAsterisk(window.siyuan.config.editor.markdown.inlineAsterisk),e.SetInlineUnderscore(window.siyuan.config.editor.markdown.inlineUnderscore),e.SetSup(window.siyuan.config.editor.markdown.inlineSup),e.SetSub(window.siyuan.config.editor.markdown.inlineSub),e.SetTag(window.siyuan.config.editor.markdown.inlineTag),e.SetInlineMath(window.siyuan.config.editor.markdown.inlineMath),e.SetGFMStrikethrough1(!1),e.SetGFMStrikethrough(window.siyuan.config.editor.markdown.inlineStrikethrough),e.SetMark(window.siyuan.config.editor.markdown.inlineMark),e.SetSpin(!0),e.SetProtyleWYSIWYG(!0),t.lazyLoadImage&&e.SetImageLazyLoading(t.lazyLoadImage),e.SetBlockRef(!0),window.siyuan.emojis[0].items.length>0){const n={};window.siyuan.emojis[0].items.forEach(a=>{n[a.keywords]=t.emojiSite+"/"+a.unicode}),e.PutEmojis(n)}return e},gT=(t,e)=>{if(typeof speechSynthesis>"u"||typeof SpeechSynthesisUtterance>"u")return;const n='<svg><use xlink:href="#iconPlay"></use></svg>',a='<svg><use xlink:href="#iconPause"></use></svg>';let i=document.querySelector(".protyle-speech");if(!i){i=document.createElement("div"),i.className="protyle-speech",document.body.insertAdjacentElement("beforeend",i);const s=()=>{const l=speechSynthesis.getVoices();let r,d;return l.forEach(c=>{c.lang===e.replace("_","-")&&(r=c),c.default&&(d=c)}),r||(r=d),r};speechSynthesis.onvoiceschanged!==void 0&&(speechSynthesis.onvoiceschanged=s);const o=s();i.onclick=()=>{if(i.className==="protyle-speech"){const l=new SpeechSynthesisUtterance(i.getAttribute("data-text"));l.voice=o,l.onend=()=>{i.className="protyle-speech",speechSynthesis.cancel(),i.innerHTML=n},speechSynthesis.speak(l),i.className="protyle-speech protyle-speech--current",i.innerHTML=a}else speechSynthesis.speaking&&(speechSynthesis.paused?(speechSynthesis.resume(),i.innerHTML=a):(speechSynthesis.pause(),i.innerHTML=n));Z(window.protyleSpeechRange)},document.body.addEventListener("click",()=>{getSelection().toString().trim()===""&&i.style.display==="block"&&(i.className="protyle-speech",speechSynthesis.cancel(),i.style.display="none")})}t.addEventListener("mouseup",s=>{const o=getSelection().toString().trim();if(speechSynthesis.cancel(),getSelection().toString().trim()===""){i.style.display==="block"&&(i.className="protyle-speech",i.style.display="none");return}window.protyleSpeechRange=getSelection().getRangeAt(0).cloneRange();const l=getSelection().getRangeAt(0).getBoundingClientRect();i.innerHTML=n,i.style.display="block",i.style.top=l.top+l.height+document.querySelector("html").scrollTop-20+"px",i.style.left=s.screenX+2+"px",i.setAttribute("data-text",o)})};class hT{constructor(e){this.element=document.createElement("div"),this.element.className="protyle-preview fn__none";const n=document.createElement("div");n.className="b3-typography",e.options.classes.preview&&n.classList.add(e.options.classes.preview);const a=e.options.preview.actions,i=document.createElement("div");i.className="protyle-preview__action";const s=[];for(let o=0;o<a.length;o++){const l=a[o];if(typeof l=="object"){s.push(`<button type="button" data-type="${l.key}" class="${l.className}">${l.text}</button>`);continue}switch(l){case"desktop":s.push(`<button type="button" class="protyle-preview__action--current" data-type="desktop">${window.siyuan.languages.desktop}</button>`);break;case"tablet":s.push(`<button type="button" data-type="tablet">${window.siyuan.languages.tablet}</button>`);break;case"mobile":s.push(`<button type="button" data-type="mobile">${window.siyuan.languages.mobile}</button>`);break;case"mp-wechat":s.push(`<button type="button" data-type="mp-wechat" class="b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.copyToWechatMP}"><svg><use xlink:href="#iconMp"></use></svg></button>`);break;case"zhihu":s.push(`<button type="button" data-type="zhihu" class="b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.copyToZhihu}"><svg><use xlink:href="#iconZhihu"></use></svg></button>`);break;case"yuque":s.push(`<button type="button" data-type="yuque" class="b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.copyToYuque}"><svg><use xlink:href="#iconYuque"></use></svg></button>`);break}}i.innerHTML=s.join(""),this.element.appendChild(i),this.element.appendChild(n),this.element.addEventListener("click",o=>{let l=o.target;for(;l&&!l.isEqualNode(this.element);){if(l.tagName==="A"){const d=l.getAttribute("href");if(d.startsWith("#")){const c=d.substring(1);n.querySelector('[data-node-id="'+c+'"], [id="'+c+'"]').scrollIntoView(),o.stopPropagation(),o.preventDefault();break}if(W()){Ht(d),o.stopPropagation(),o.preventDefault();break}o.stopPropagation(),o.preventDefault(),Qs(d)?Dt(o)?ea(d,"folder"):o.shiftKey?ea(d,"app"):u.SIYUAN_ASSETS_EXTS.includes(Ee().extname(d.split("?page")[0]))&&Ul(e.app,d.split("?page")[0],parseInt(It("page",d))):ee.shell.openExternal(d).catch(c=>{j(c)});break}else if(l.tagName==="IMG"){$_(o.target.getAttribute("src"),e.block.rootID),o.stopPropagation(),o.preventDefault();break}else if(l.tagName==="BUTTON"){const d=l.getAttribute("data-type"),c=a.find(f=>f?.key===d);c?c.click(d):d==="mp-wechat"||d==="zhihu"||d==="yuque"?this.copyToX(this.element.lastElementChild.cloneNode(!0),e,d):d==="desktop"?(n.style.width="",n.style.padding=e.wysiwyg.element.style.padding):d==="tablet"?(n.style.width="1024px",n.style.padding="8px 16px"):(n.style.width="360px",n.style.padding="8px"),d!=="mp-wechat"&&d!=="zhihu"&&d!=="yuque"&&(i.querySelectorAll("button").forEach(f=>{f.classList.remove("protyle-preview__action--current")}),l.classList.add("protyle-preview__action--current"))}l=l.parentElement}const r=B(o.target,"id",void 0);r&&(this.element.querySelectorAll(".protyle-wysiwyg--select").forEach(d=>{d.classList.remove("selected")}),r.classList.add("selected"),e.model&&Ce().outline.forEach(d=>{d.blockId===e.block.rootID&&d.setCurrentByPreview(r)}))}),this.previewElement=n}render(e){if(this.element.style.display==="none")return;if(this.element.querySelector('.protyle-preview__action [data-type="desktop"]')?.classList.contains("protyle-preview__action--current")){const a=Tv(e);this.previewElement.style.padding=`${a.top}px ${a.left}px ${a.bottom}px ${a.right}px`}let n=this.element.querySelector(".fn__loading");n||(this.element.insertAdjacentHTML("beforeend",`<div style="flex-direction: column;" class="fn__loading">
    <img width="48px" src="/stage/loading-pure.svg">
</div>`),n=this.element.querySelector(".fn__loading")),this.mdTimeoutId=window.setTimeout(()=>{E("/api/export/preview",{id:e.block.parentID||e.options.blockId},a=>{const i=e.preview.previewElement.scrollTop;e.preview.previewElement.innerHTML=a.data.html,yt(e.preview.previewElement),ze(e.preview.previewElement),dt(e.preview.previewElement,e),gT(e.preview.previewElement,e.options.lang),e.preview.previewElement.scrollTop=i,n.remove()})},e.options.preview.delay)}link2online(e){Si("")||e.querySelectorAll("[href],[src]").forEach(n=>{const a=n.getAttribute("href")||n.getAttribute("src");if(a&&a.startsWith("assets/")){const i=u.ASSETS_ADDRESS+window.siyuan.user.userId+"/"+a;n.getAttribute("href")?n.setAttribute("href",i):n.setAttribute("src",i)}})}copyToX(e,n,a){if(a==="mp-wechat")this.link2online(e),e.querySelectorAll(".katex-html .base").forEach(o=>{o.style.display="initial"}),e.querySelectorAll("mjx-container > svg").forEach(o=>{o.setAttribute("width",parseInt(o.getAttribute("width"))*8+"px")});else if(a==="zhihu")this.link2online(e),e.querySelectorAll('[data-subtype="math"]').forEach(o=>{o.outerHTML=`<img class="Formula-image" data-eeimg="true" src="//www.zhihu.com/equation?tex=" alt="${o.getAttribute("data-content")}" style="${o.tagName==="DIV"?"display: block; max-width: 100%;":""}margin: 0 auto;">`}),e.querySelectorAll("blockquote").forEach(o=>{const l=[];this.processZHBlockquote(o,l),l.reverse().forEach(r=>{o.insertAdjacentElement("afterend",r)}),o.remove()}),this.processZHTable(e);else if(a==="yuque"){E("/api/lute/copyStdMarkdown",{id:n.block.rootID},o=>{De(o.data),j(`${window.siyuan.languages.pasteToYuque}`)});return}e.style.backgroundColor="#fff",e.querySelectorAll("code").forEach(o=>{o.style.backgroundImage="none"}),this.element.append(e);let i;getSelection().rangeCount>0&&(i=getSelection().getRangeAt(0).cloneRange());const s=e.ownerDocument.createRange();s.selectNodeContents(e),Z(s),document.execCommand("copy"),this.element.lastElementChild.remove(),Z(i),a&&j(`${a==="zhihu"?window.siyuan.languages.pasteToZhihu:window.siyuan.languages.pasteToWechatMP}`)}processZHBlockquote(e,n){Array.from(e.children).forEach(a=>{if(a.tagName==="BLOCKQUOTE")this.processZHBlockquote(a,n);else if(a.tagName!=="P"||a.querySelector("img"))n.push(a);else{const i=n[n.length-1];(!i||i&&i.tagName!=="BLOCKQUOTE")&&n.push(document.createElement("blockquote")),n[n.length-1].append(a)}})}processZHTable(e){e.querySelectorAll("table").forEach(n=>{const a=n.querySelector("thead");if(!a)return;const i=n.querySelector("tbody");i?i.insertAdjacentElement("afterbegin",a.firstElementChild):n.innerHTML=`<tbody>${a.innerHTML}</tbody>`,a.remove()})}}const vb=(...t)=>{const e={},n=a=>{for(const i in a)a.hasOwnProperty(i)&&(Object.prototype.toString.call(a[i])==="[object Object]"?e[i]=vb(e[i],a[i]):e[i]=a[i])};for(let a=0;a<t.length;a++)n(t[a]);return e};class mT{constructor(e){this.defaultOptions={mode:"wysiwyg",blockId:"",render:{background:!1,title:!1,gutter:!0,scroll:!1,breadcrumb:!0,breadcrumbDocName:!1},action:[],after:void 0,classes:{preview:""},hint:{delay:200,emoji:{"+1":"\u{1F44D}","-1":"\u{1F44E}",confused:"\u{1F615}",eyes:"\u{1F440}\uFE0F",heart:"\u2764\uFE0F",rocket:"\u{1F680}\uFE0F",smile:"\u{1F604}",tada:"\u{1F389}\uFE0F"},emojiPath:"/emojis",extend:[{key:"((",hint:ss},{key:"\u3010\u3010",hint:ss},{key:"\uFF08\uFF08",hint:ss},{key:"[[",hint:ss},{key:"{{",hint:Cl},{key:"\u300C\u300C",hint:Cl},{key:"\u300C\u300E",hint:Cl},{key:"\u300E\u300C",hint:Cl},{key:"\u300E\u300E",hint:Cl},{key:"#",hint:ex},{key:"/",hint:om},{key:"\u3001",hint:om},{key:":"}]},lang:window.siyuan.config.appearance.lang,preview:{actions:["desktop","tablet","mobile","mp-wechat","zhihu","yuque"],delay:0,markdown:{paragraphBeginningSpace:window.siyuan.config.export.paragraphBeginningSpace,listStyle:!1,sanitize:!0},mode:"both"},toolbar:u.PROTYLE_TOOLBAR,typewriterMode:!1,upload:{max:1024*1024*1024*8,url:u.UPLOAD_ADDRESS,extraData:{},fieldName:"file[]",filename:n=>n.replace(/[\\/:*?"'<>|\[\]\(\)~!`&{}=#%$]/g,""),linkToImgUrl:"",withCredentials:!1}},this.options=e}merge(){return this.options&&(this.options.toolbar?this.options.toolbar=this.mergeToolbar(this.options.toolbar):this.options.toolbar=this.mergeToolbar(this.defaultOptions.toolbar),this.options.hint?.emoji&&(this.defaultOptions.hint.emoji=this.options.hint.emoji)),vb(this.defaultOptions,this.options)}mergeToolbar(e){return Uf(e)}}class bT{constructor(e){this.parentElement=document.createElement("div"),this.parentElement.classList.add("protyle-scroll"),this.parentElement.innerHTML=`<div class="protyle-scroll__up ariaLabel" data-position="north" aria-label="${X("\u2318Home")}">
    <svg><use xlink:href="#iconUp"></use></svg>
</div>
<div class="fn__none protyle-scroll__bar ariaLabel" data-position="2west" aria-label="Blocks 1/1">
    <input class="b3-slider" type="range" max="1" min="1" step="1" value="1" />
</div>
<div class="protyle-scroll__down ariaLabel" aria-label="${X("\u2318End")}">
    <svg><use xlink:href="#iconDown"></use></svg>
</div>`,this.element=this.parentElement.querySelector(".protyle-scroll__bar"),this.keepLazyLoad=!1,e.options.render.scroll||this.parentElement.classList.add("fn__none"),this.lastScrollTop=0,this.inputElement=this.element.firstElementChild,this.inputElement.addEventListener("input",()=>{this.element.setAttribute("aria-label",`Blocks ${this.inputElement.value}/${e.block.blockCount}`),Qa(this.element.getAttribute("aria-label"),this.element)}),this.parentElement.addEventListener("click",n=>{const a=n.target;L(a,"protyle-scroll__up")?sm(e):L(a,"protyle-scroll__down")?w_(e):a.classList.contains("b3-slider")&&this.setIndex(e)}),this.parentElement.addEventListener("mousewheel",n=>{n.deltaY!==0&&e.scroll.lastScrollTop!==-1&&(e.contentElement.scrollTop+=n.deltaY)},{passive:!0})}setIndex(e){e.wysiwyg.element.getAttribute("data-top")||(e.wysiwyg.element.setAttribute("data-top",e.wysiwyg.element.scrollTop.toString()),e.contentElement.style.overflow="hidden",E("/api/filetree/getDoc",{index:parseInt(this.inputElement.value),id:e.block.parentID,mode:0,size:window.siyuan.config.editor.dynamicLoadBlocks},n=>{rt({data:n,protyle:e,action:[u.CB_GET_FOCUSFIRST,u.CB_GET_UNCHANGEID],afterCB:()=>{setTimeout(()=>{e.contentElement.style.overflow=""},u.TIMEOUT_INPUT),Qa(this.element.getAttribute("aria-label"),this.element)}})}))}updateIndex(e,n,a){E("/api/block/getBlockIndex",{id:n},i=>{if(!i.data)return;const s=e.scroll.element.querySelector(".b3-slider");s.value=i.data,e.scroll.element.setAttribute("aria-label",`Blocks ${i.data}/${e.block.blockCount}`),a&&a(i.data)})}update(e){typeof e.block.blockCount=="number"&&(this.inputElement.setAttribute("max",e.block.blockCount.toString()),this.element.setAttribute("aria-label",`Blocks ${this.inputElement.value}/${e.block.blockCount}`)),e.block.showAll?this.element.classList.add("fn__none"):e.block.scroll&&!e.contentElement.classList.contains("fn__none")?this.element.classList.remove("fn__none"):this.element.classList.add("fn__none")}}const FE=(t,e,n,a,i,s,o)=>{let l;const r=n.getAttribute("data-node-id"),d=a.getAttribute("data-node-id"),c=[],f=[];return n.insertAdjacentElement(s?"afterend":"beforebegin",a),s?c.push({action:"insert",data:a.outerHTML,id:d,previousID:r}):c.push({action:"insert",data:a.outerHTML,id:d,nextID:r}),e.reverse().forEach((g,p)=>{const h=g.getAttribute("data-node-id");p===e.length-1&&(l=Je(g),l.isSameNode(g)&&(l=void 0,Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${g.getAttribute("data-node-id")}"]`)).find(b=>{if(!F(b)&&b.parentElement.querySelectorAll(".li").length===1)return l=b.parentElement,!0})));const m=Lute.NewNodeID();if(o?f.push({action:"delete",id:m}):f.push({action:"move",id:h,previousID:g.previousElementSibling?.getAttribute("data-node-id"),parentID:g.parentElement.getAttribute("data-node-id")||t.block.rootID}),!i&&!o){const b=t.wysiwyg.element.querySelector(`[data-node-id="${h}"]`);b&&b.remove()}if(o){const b=g.cloneNode(!0);b.setAttribute("data-node-id",m),b.querySelectorAll("[data-node-id]").forEach(y=>{const w=Lute.NewNodeID();y.setAttribute("data-node-id",w),y.setAttribute("updated",w.split("-")[0])}),a.insertAdjacentElement("afterbegin",b),c.push({action:"insert",id:m,data:b.outerHTML,parentID:d})}else a.insertAdjacentElement("afterbegin",g),c.push({action:"move",id:h,parentID:d})}),f.reverse(),a.getAttribute("data-subtype")==="o"&&(f.splice(0,0,{action:"update",id:d,data:a.outerHTML}),ot(a,1),c.push({action:"update",id:d,data:a.outerHTML})),f.push({action:"delete",id:d}),{doOperations:c,undoOperations:f,topSourceElement:l}},UE=async(t,e,n,a,i,s)=>{let o;const l=[],r=[],d=[],c=n.getAttribute("data-node-id");let f=n;e.reverse().forEach((g,p)=>{const h=g.getAttribute("data-node-id"),m=g.parentElement.getAttribute("data-node-id")||t.block.rootID;p===e.length-1&&(o=Je(g),o.isSameNode(g)?o=void 0:o.contains(g)&&o.contains(n)&&(o=n)),s&&g.getAttribute("data-type")==="NodeHeading"&&g.getAttribute("fold")==="1"&&(g.removeAttribute("fold"),d.push({id:h,parentID:m}));let b,y;if(s?(b=Lute.NewNodeID(),r.push({action:"delete",id:b})):r.push({action:"move",id:h,previousID:g.previousElementSibling?.getAttribute("data-node-id"),parentID:m}),!a&&!s){const w=t.wysiwyg.element.querySelector(`[data-node-id="${h}"]`);w&&w.remove()}s?(y=g.cloneNode(!0),y.setAttribute("data-node-id",b),y.querySelectorAll("[data-node-id]").forEach(w=>{const _=Lute.NewNodeID();w.setAttribute("data-node-id",_),w.setAttribute("updated",_.split("-")[0])}),f.insertAdjacentElement(i,y),l.push({action:"insert",id:b,data:y.outerHTML,previousID:i==="afterend"?c:y.previousElementSibling?.getAttribute("data-node-id"),parentID:y.parentElement?.getAttribute("data-node-id")||t.block.parentID||t.block.rootID})):(f.insertAdjacentElement(i,g),l.push({action:"move",id:h,previousID:i==="afterend"?c:g.previousElementSibling?.getAttribute("data-node-id"),parentID:g.parentElement?.getAttribute("data-node-id")||t.block.parentID||t.block.rootID})),i!=="afterend"&&(f=s?y:g)}),r.reverse();for(let g=0;g<d.length;g++){const p=d[g];(await Re("/api/block/getHeadingChildrenIDs",{id:p.id})).data.reverse().forEach(m=>{r.push({action:"move",id:m,previousID:p.id,parentID:p.parentID})}),r.push({action:"foldHeading",id:p.id,data:"remove"}),l.push({action:"unfoldHeading",id:p.id})}return{doOperations:l,undoOperations:r,topSourceElement:o}},WE=async(t,e,n,a,i,s)=>{const o=t.element.contains(e[0]);let l;e[0].getAttribute("data-type")==="NodeListItem"&&n.getAttribute("data-type")!=="NodeListItem"&&(l=document.createElement("div"),l.setAttribute("data-node-id",Lute.NewNodeID()),l.setAttribute("data-type","NodeList"),l.setAttribute("data-subtype",e[0].getAttribute("data-subtype")),l.className="list",l.insertAdjacentHTML("beforeend",`<div class="protyle-attr" contenteditable="false">${u.ZWSP}</div>`));const r=[{action:"move",id:n.getAttribute("data-node-id"),previousID:n.previousElementSibling?.getAttribute("data-node-id"),parentID:n.parentElement?.getAttribute("data-node-id")||t.block.parentID||t.block.rootID}];let d,c=e[0].parentElement;const f=T_(i);n.parentElement.replaceChild(f,n);const g=[{action:"insert",data:f.outerHTML,id:f.getAttribute("data-node-id"),nextID:f.nextElementSibling?.getAttribute("data-node-id"),previousID:f.previousElementSibling?.getAttribute("data-node-id"),parentID:f.parentElement.getAttribute("data-node-id")||t.block.parentID||t.block.rootID}];let p=!1;if(l){const h=l.getAttribute("data-node-id");f.insertAdjacentElement("afterbegin",n),g.push({action:"move",id:n.getAttribute("data-node-id"),parentID:f.getAttribute("data-node-id")}),a?(n.insertAdjacentElement("afterend",l),g.push({action:"insert",data:l.outerHTML,id:h,previousID:n.getAttribute("data-node-id")})):(n.insertAdjacentElement("beforebegin",l),g.push({action:"insert",data:l.outerHTML,id:h,nextID:n.getAttribute("data-node-id")})),e.reverse().forEach((m,b)=>{b===e.length-1&&(d=Je(m),d.isSameNode(m)&&(d=void 0));const y=Lute.NewNodeID();if(s?r.push({action:"delete",id:y}):r.push({action:"move",id:m.getAttribute("data-node-id"),previousID:m.previousElementSibling?.getAttribute("data-node-id"),parentID:m.parentElement.getAttribute("data-node-id")||t.block.rootID}),!o&&!s){const w=t.wysiwyg.element.querySelector(`[data-node-id="${m.getAttribute("data-node-id")}"]`);w&&w.remove()}if(s){const w=m.cloneNode(!0);w.setAttribute("data-node-id",y),w.querySelectorAll("[data-node-id]").forEach(_=>{const x=Lute.NewNodeID();_.setAttribute("data-node-id",x),_.setAttribute("updated",x.split("-")[0])}),l.insertAdjacentElement("afterbegin",w),g.push({action:"insert",id:y,data:w.outerHTML,parentID:h})}else l.insertAdjacentElement("afterbegin",m),g.push({action:"move",id:m.getAttribute("data-node-id"),parentID:h})}),r.reverse(),r.push({action:"delete",id:h})}else{const h=[];let m;e.reverse().forEach((b,y)=>{const w=b.getAttribute("data-node-id"),_=b.parentElement.getAttribute("data-node-id")||t.block.rootID;y===e.length-1&&(d=Je(b),d.isSameNode(b)&&(d=void 0));const x=Lute.NewNodeID();if(y===0&&(m=s?x:w),b.getAttribute("data-type")==="NodeHeading"&&b.getAttribute("fold")==="1"&&(s&&(b.removeAttribute("fold"),h.push({id:w,parentID:_})),p=!0),s?r.push({action:"delete",id:x}):r.push({action:"move",id:w,previousID:b.previousElementSibling?.getAttribute("data-node-id"),parentID:_}),!o&&!s){const S=t.wysiwyg.element.querySelector(`[data-node-id="${w}"]`);S&&S.remove()}if(s){const S=b.cloneNode(!0);S.setAttribute("data-node-id",x),S.querySelectorAll("[data-node-id]").forEach(k=>{const A=Lute.NewNodeID();k.setAttribute("data-node-id",A),k.setAttribute("updated",A.split("-")[0])}),f.insertAdjacentElement("afterbegin",S),g.push({action:"insert",id:x,data:S.outerHTML,parentID:f.getAttribute("data-node-id")})}else f.insertAdjacentElement("afterbegin",b),g.push({action:"move",id:w,parentID:f.getAttribute("data-node-id")})}),r.reverse();for(let b=0;b<h.length;b++){const y=h[b],w=await Re("/api/block/getHeadingChildrenIDs",{id:y.id});w.data.reverse().forEach(_=>{r.push({action:"move",id:_,previousID:y.id,parentID:y.parentID})}),b===0&&(m=w.data[0]),r.push({action:"foldHeading",id:y.id,data:"remove"}),g.push({action:"unfoldHeading",id:y.id})}a?(f.insertAdjacentElement("afterbegin",n),g.push({action:"move",id:n.getAttribute("data-node-id"),parentID:f.getAttribute("data-node-id")})):(f.lastElementChild.insertAdjacentElement("beforebegin",n),g.push({action:"move",id:n.getAttribute("data-node-id"),previousID:m}))}if(r.push({action:"delete",id:f.getAttribute("data-node-id")}),!s&&c&&c.classList.contains("list")&&c.getAttribute("data-subtype")==="o"&&!c.isSameNode(e[0].parentElement)&&c.childElementCount>1&&(Array.from(c.children).forEach(h=>{h.classList.contains("protyle-attr")||r.splice(0,0,{action:"update",id:h.getAttribute("data-node-id"),data:h.outerHTML})}),ot(c,1),Array.from(c.children).forEach(h=>{h.classList.contains("protyle-attr")||g.push({action:"update",id:h.getAttribute("data-node-id"),data:h.outerHTML})})),!s&&d){if(g.push({action:"delete",id:d.getAttribute("data-node-id")}),r.splice(0,0,{action:"insert",data:d.outerHTML,id:d.getAttribute("data-node-id"),previousID:d.previousElementSibling?.getAttribute("data-node-id"),parentID:d.parentElement?.getAttribute("data-node-id")||t.block.parentID||t.block.rootID}),!o){const h=t.wysiwyg.element.querySelector(`[data-node-id="${d.getAttribute("data-node-id")}"]`);h&&h.remove()}c=d.parentElement,d.remove()}if(!s&&c&&c.classList.contains("sb")&&c.childElementCount===2)if(o){const h=ai(t,c);g.push(h.doOperations[0],h.doOperations[1]),r.splice(0,0,h.undoOperations[0],h.undoOperations[1])}else{const h=L(c,"protyle",!0);h&&Mn().find(m=>{if(m.protyle.element.isSameNode(h)){const b=ai(m.protyle,c);return g.push(b.doOperations[0],b.doOperations[1]),r.splice(0,0,b.undoOperations[0],b.undoOperations[1]),m.protyle.undo.clear(),!0}})}else if(!s&&c&&c.classList.contains("protyle-wysiwyg")&&c.innerHTML===""){const h=L(c,"protyle",!0);h&&Mn().find(m=>{if(m.protyle.element.isSameNode(h)){if(m.protyle.block.id===m.protyle.block.rootID){const b=Lute.NewNodeID();g.splice(0,0,{action:"insert",id:b,data:pa(!1,!1,b).outerHTML,parentID:m.protyle.block.parentID}),r.splice(0,0,{action:"delete",id:b})}else Vt({protyle:m.protyle,id:m.protyle.block.rootID});return!0}})}o||s?U(t,g,r):U(t,g),!s&&i==="col"&&(n.getAttribute("data-type")==="NodeHeading"&&n.getAttribute("fold")==="1"&&Dn({protyle:t,selectsElement:[n],type:"BlocksMergeSuperBlock",level:"row"}),(e.length>1||p)&&Dn({protyle:t,selectsElement:e.reverse(),type:"BlocksMergeSuperBlock",level:"row"})),ae(e[0])},YE=async(t,e,n,a,i)=>{const s=t.element.contains(e[0]),o=[],l=[];let r;e[0].getAttribute("data-type")==="NodeListItem"&&n.getAttribute("data-type")!=="NodeListItem"&&(r=document.createElement("div"),r.setAttribute("data-node-id",Lute.NewNodeID()),r.setAttribute("data-type","NodeList"),r.setAttribute("data-subtype",e[0].getAttribute("data-subtype")),r.className="list",r.insertAdjacentHTML("beforeend",`<div class="protyle-attr" contenteditable="false">${u.ZWSP}</div>`));let d,c=e[0].parentElement;if(a)if(r){const g=FE(t,e,n,r,s,a,i);o.push(...g.doOperations),l.push(...g.undoOperations),d=g.topSourceElement}else{const g=await UE(t,e,n,s,"afterend",i);o.push(...g.doOperations),l.push(...g.undoOperations),d=g.topSourceElement}else if(r){const g=FE(t,e,n,r,s,a,i);o.push(...g.doOperations),l.push(...g.undoOperations),d=g.topSourceElement}else{const g=await UE(t,e,n,s,"beforebegin",i);o.push(...g.doOperations),l.push(...g.undoOperations),d=g.topSourceElement}if(n.getAttribute("data-type")==="NodeListItem"&&n.getAttribute("data-subtype")==="o"&&(Array.from(n.parentElement.children).forEach(g=>{g.classList.contains("protyle-attr")||l.splice(0,0,{action:"update",id:g.getAttribute("data-node-id"),data:g.outerHTML})}),ot(n.parentElement,1),Array.from(n.parentElement.children).forEach(g=>{g.classList.contains("protyle-attr")||o.push({action:"update",id:g.getAttribute("data-node-id"),data:g.outerHTML})})),!i&&s&&c&&c.classList.contains("list")&&c.getAttribute("data-subtype")==="o"&&!c.isSameNode(e[0].parentElement)&&c.childElementCount>1&&(Array.from(c.children).forEach(g=>{g.classList.contains("protyle-attr")||(c.contains(n)?l.splice(0,0,{action:"update",id:g.getAttribute("data-node-id"),data:g.outerHTML}):l.splice(n.parentElement.childElementCount-1,0,{action:"update",id:g.getAttribute("data-node-id"),data:g.outerHTML}))}),ot(c,1),Array.from(c.children).forEach(g=>{g.classList.contains("protyle-attr")||o.push({action:"update",id:g.getAttribute("data-node-id"),data:g.outerHTML})})),!i&&d&&(o.push({action:"delete",id:d.getAttribute("data-node-id")}),l.splice(0,0,{action:"insert",data:d.outerHTML,id:d.getAttribute("data-node-id"),previousID:d.previousElementSibling?.getAttribute("data-node-id"),parentID:d.parentElement?.getAttribute("data-node-id")||t.block.parentID||t.block.rootID}),c=d.parentElement,d.remove(),!s)){const g=t.wysiwyg.element.querySelector(`[data-node-id="${d.getAttribute("data-node-id")}"]`);g&&g.remove()}if(!i&&c&&c.classList.contains("sb")&&c.childElementCount===2)if(s){const g=ai(t,c);o.push(g.doOperations[0],g.doOperations[1]),l.splice(0,0,g.undoOperations[0],g.undoOperations[1])}else{const g=L(c,"protyle",!0);g&&Mn().find(p=>{if(p.protyle.element.isSameNode(g)){const h=ai(p.protyle,c);return o.push(h.doOperations[0],h.doOperations[1]),l.splice(0,0,h.undoOperations[0],h.undoOperations[1]),p.protyle.undo.clear(),!0}})}else if(!i&&c&&c.classList.contains("protyle-wysiwyg")&&c.childElementCount===0){const g=L(c,"protyle",!0);g&&Mn().find(p=>{if(p.protyle.element.isSameNode(g)){if(p.protyle.block.id===p.protyle.block.rootID){const h=Lute.NewNodeID();o.splice(0,0,{action:"insert",id:h,data:pa(!1,!1,h).outerHTML,parentID:p.protyle.block.parentID}),l.splice(0,0,{action:"delete",id:h})}else Vt({protyle:p.protyle,id:p.protyle.block.rootID});return!0}})}s||i?U(t,o,l):U(t,o);let f=!1;e.find(g=>{if(g.getAttribute("data-type")==="NodeHeading"&&g.getAttribute("fold")==="1")return f=!0,!0}),!i&&(e.length>1||f)&&e[0].parentElement.classList.contains("sb")&&e[0].parentElement.getAttribute("data-sb-layout")==="col"&&Dn({protyle:t,selectsElement:e.reverse(),type:"BlocksMergeSuperBlock",level:"row"}),ae(e[0])},yT=(t,e)=>{e.addEventListener("dragstart",s=>{const o=s.target;if(o.tagName==="IMG"){window.siyuan.dragElement=void 0,s.preventDefault();return}if(o.classList){if(L(o,"protyle-wysiwyg__embed"))window.siyuan.dragElement=void 0,s.preventDefault();else if(o.classList.contains("protyle-action")){o.parentElement.classList.add("protyle-wysiwyg--select");const l=document.createElement("div");l.className=t.wysiwyg.element.className,l.append(Xa(o.parentElement.cloneNode(!0))),l.setAttribute("style",`position:fixed;opacity:.1;width:${o.parentElement.clientWidth}px;padding:0;`),document.body.append(l),s.dataTransfer.setDragImage(l,0,0),setTimeout(()=>{l.remove()}),window.siyuan.dragElement=t.wysiwyg.element,s.dataTransfer.setData(`${u.SIYUAN_DROP_GUTTER}NodeListItem${u.ZWSP}${o.parentElement.getAttribute("data-subtype")}${u.ZWSP}${[o.parentElement.getAttribute("data-node-id")]}`,t.wysiwyg.element.innerHTML);return}else if(o.classList.contains("av__cell--header")){window.siyuan.dragElement=o,s.dataTransfer.setData(`${u.SIYUAN_DROP_GUTTER}NodeAttributeView${u.ZWSP}Col${u.ZWSP}${[o.getAttribute("data-col-id")]}`,o.outerHTML);return}}s.dataTransfer.setData(u.SIYUAN_DROP_EDITOR,u.SIYUAN_DROP_EDITOR),t.element.style.userSelect="auto",document.onmousemove=null,document.onmouseup=null}),e.addEventListener("drop",async s=>{if(i=0,t.disabled||s.dataTransfer.getData(u.SIYUAN_DROP_EDITOR)){s.preventDefault(),s.stopPropagation();return}let o="";for(const r of s.dataTransfer.items)r.type.startsWith(u.SIYUAN_DROP_GUTTER)&&(o=r.type);const l=e.querySelector(".dragover__left, .dragover__right, .dragover__bottom, .dragover__top");if(l&&(l.classList.remove("dragover"),l.removeAttribute("select-start"),l.removeAttribute("select-end")),o){const r=[],d=o.replace(u.SIYUAN_DROP_GUTTER,"").split(u.ZWSP),c=d[2].split(",");if(s.altKey||s.shiftKey)if(s.y>t.wysiwyg.element.lastElementChild.getBoundingClientRect().bottom)_n(t,"afterend",t.wysiwyg.element.lastElementChild.getAttribute("data-node-id"));else{const f=yb(s.clientX,s.clientY);if(B(f.startContainer,"data-type","NodeBlockQueryEmbed"))return;Z(f)}if(s.altKey){let f="";for(let g=0;g<c.length;g++){const p=await Re("/api/block/getRefText",{id:c[g]});f+=t.lute.Md2BlockDOM(`((${c[g]} '${p.data}'))`)}wt(f,t)}else if(s.shiftKey){let f="";c.forEach(g=>{f+=`{{select * from blocks where id='${g}'}}
`}),wt(t.lute.SpinBlockDOM(f),t,!0),Be(t,t.wysiwyg.element)}else if(l&&l.className.indexOf("dragover__")>-1){let f="";if(c.forEach(m=>{f+=`[data-node-id="${m}"],`}),window.siyuan.dragElement)window.siyuan.dragElement.querySelectorAll(f.substring(0,f.length-1)).forEach(m=>{F(m)||r.push(m)});else if(window.siyuan.config.system.workspaceDir.toLowerCase()===d[3]){const m=document.createElement("template");m.innerHTML=`<div>${s.dataTransfer.getData(o)}</div>`,m.content.querySelectorAll(f.substring(0,f.length-1)).forEach(b=>{F(b)||r.push(b)})}const g=[],p=[];r.forEach(m=>{m.classList.remove("protyle-wysiwyg--hl"),m.removeAttribute("select-start"),m.removeAttribute("select-end"),m.querySelectorAll('[data-type="search-mark"]').forEach(y=>{y.outerHTML=y.innerHTML});const b=m.getAttribute("data-node-id");g.push(b),p.push({id:b,isDetached:!1})}),Q(["gutter"],t);const h=l.className.split(" ");if(l.classList.remove("dragover__bottom","dragover__top","dragover__left","dragover__right"),l.classList.contains("av__cell")){const m=P(l);if(m){const b=m.getAttribute("data-av-id");let y="";h.includes("dragover__left")?l.previousElementSibling&&(l.previousElementSibling.classList.contains("av__colsticky")?y=l.previousElementSibling.lastElementChild.getAttribute("data-col-id"):y=l.previousElementSibling.getAttribute("data-col-id")):y=l.getAttribute("data-col-id");let w="";const _=L(l,"av__row");if(_){const x=_.querySelector(`[data-col-id="${d[2]}"`)?.previousElementSibling;x&&(x.classList.contains("av__colsticky")?w=x.lastElementChild.getAttribute("data-col-id"):w=x.getAttribute("data-col-id"))}y!==w&&y!==d[2]&&U(t,[{action:"sortAttrViewCol",avID:b,previousID:y,id:d[2],blockID:m.dataset.nodeId}],[{action:"sortAttrViewCol",avID:b,previousID:w,id:d[2],blockID:m.dataset.nodeId}])}}else if(l.classList.contains("av__row")){const m=P(l);if(m){let b="";h.includes("dragover__bottom")?b=l.getAttribute("data-id")||"":b=l.previousElementSibling?.getAttribute("data-id")||"";const y=m.getAttribute("data-av-id");if(d[0]==="nodeattributeviewrowmenu"){const w=[],_=[],x=m.querySelector(`.av__row[data-id="${c[0]}"]`).previousElementSibling.getAttribute("data-id")||"";c.reverse().forEach(S=>{b!==S&&x!==b&&(w.push({action:"sortAttrViewRow",avID:y,previousID:b,id:S,blockID:m.dataset.nodeId}),_.push({action:"sortAttrViewRow",avID:y,previousID:x,id:S,blockID:m.dataset.nodeId}))}),U(t,w,_)}else{const w=Y().format("YYYYMMDDHHmmss");U(t,[{action:"insertAttrViewBlock",avID:y,previousID:b,srcs:p,blockID:m.dataset.nodeId},{action:"doUpdateUpdated",id:m.dataset.nodeId,data:w}],[{action:"removeAttrViewBlock",srcIDs:g,avID:y},{action:"doUpdateUpdated",id:m.dataset.nodeId,data:m.getAttribute("updated")}]),m.setAttribute("updated",w),Yf(t,m,g,b)}}}else r.length>0&&(l.parentElement.getAttribute("data-type")==="NodeSuperBlock"&&l.parentElement.getAttribute("data-sb-layout")==="col"?h.includes("dragover__left")||h.includes("dragover__right")?YE(t,r,l,h.includes("dragover__right"),s.ctrlKey):WE(t,r,l,h.includes("dragover__bottom"),"row",s.ctrlKey):h.includes("dragover__left")||h.includes("dragover__right")?WE(t,r,l,h.includes("dragover__right"),"col",s.ctrlKey):YE(t,r,l,h.includes("dragover__bottom"),s.ctrlKey),e.querySelectorAll(".protyle-wysiwyg--empty").forEach(m=>{m.classList.remove("protyle-wysiwyg--empty")}),r.forEach(m=>{m.getAttribute("data-type")==="NodeBlockQueryEmbed"&&(m.removeAttribute("data-render"),Be(t,m))}),l.getAttribute("data-type")==="NodeBlockQueryEmbed"&&(l.removeAttribute("data-render"),Be(t,l)));n=void 0}}else if(s.dataTransfer.getData(u.SIYUAN_DROP_FILE)?.split("-").length>1){const r=s.dataTransfer.getData(u.SIYUAN_DROP_FILE).split(",");if(!s.altKey&&(!l||!l.classList.contains("av__row"))){if(s.y>t.wysiwyg.element.lastElementChild.getBoundingClientRect().bottom)_n(t,"afterend",t.wysiwyg.element.lastElementChild.getAttribute("data-node-id"));else{const c=yb(s.clientX,s.clientY);if(B(c.startContainer,"data-type","NodeBlockQueryEmbed"))return;Z(c)}let d="";for(let c=0;c<r.length;c++){r.length>1&&(d+="* ");const f=await Re("/api/block/getRefText",{id:r[c]});d+=`((${r[c]} '${f.data}'))`,r.length>1&&c!==r.length-1&&(d+=`
`)}wt(t.lute.Md2BlockDOM(d),t)}else if(l&&!t.options.backlinkData&&l.className.indexOf("dragover__")>-1){const d=t.contentElement.scrollTop;if(l.classList.contains("av__row")){const c=P(l);if(c){let f="";l.classList.contains("dragover__bottom")?f=l.getAttribute("data-id")||"":f=l.previousElementSibling?.getAttribute("data-id")||"";const g=c.getAttribute("data-av-id"),p=Y().format("YYYYMMDDHHmmss"),h=[];r.forEach(m=>{h.push({id:m,isDetached:!1})}),U(t,[{action:"insertAttrViewBlock",avID:g,previousID:f,srcs:h,blockID:c.dataset.nodeId},{action:"doUpdateUpdated",id:c.dataset.nodeId,data:p}],[{action:"removeAttrViewBlock",srcIDs:r,avID:g},{action:"doUpdateUpdated",id:c.dataset.nodeId,data:c.getAttribute("updated")}]),Yf(t,c,r,f),c.setAttribute("updated",p)}}else{if(l.classList.contains("dragover__bottom"))for(let c=r.length-1;c>-1;c--)r[c]&&await Re("/api/filetree/doc2Heading",{srcID:r[c],after:!0,targetID:l.getAttribute("data-node-id")});else for(let c=0;c<r.length;c++)r[c]&&await Re("/api/filetree/doc2Heading",{srcID:r[c],after:!1,targetID:l.getAttribute("data-node-id")});E("/api/filetree/getDoc",{id:t.block.id,size:window.siyuan.config.editor.dynamicLoadBlocks},c=>{rt({data:c,protyle:t}),Wl({protyle:t,focus:!1,pushBackStack:!1,reload:!0,resize:!1}),setTimeout(()=>{t.contentElement.scrollTop=d,t.scroll.lastScrollTop=d-1},u.TIMEOUT_LOAD)})}l.classList.remove("dragover__bottom","dragover__top","dragover__left","dragover__right")}}else if(!window.siyuan.dragElement&&(s.dataTransfer.types[0]==="Files"||s.dataTransfer.types.includes("text/html"))){const r=L(s.target,"av");if(r){const d=L(s.target,"av__cell");if(d&&r.querySelector(`.av__row--header [data-col-id="${d.dataset.colId}"]`)?.getAttribute("data-dtype")==="mAsset"&&s.dataTransfer.types[0]==="Files"&&!pt()){const f=[];for(let g=0;g<s.dataTransfer.files.length;g++)f.push(ee.webUtils.getPathForFile(s.dataTransfer.files[g]));N_(f,t,d)}}else{if(Z(yb(s.clientX,s.clientY)),s.dataTransfer.types[0]==="Files"&&!pt()){const d=[];for(let c=0;c<s.dataTransfer.files.length;c++)d.push(ee.webUtils.getPathForFile(s.dataTransfer.files[c]));jf(d,t,!s.altKey)}else wl(t,s);t.wysiwyg.element.querySelectorAll(".av__cell--select, .av__cell--active").forEach(d=>{d.classList.remove("av__cell--select","av__cell--active"),d.querySelector(".av__drag-fill")?.remove()})}}window.siyuan.dragElement&&(window.siyuan.dragElement.style.opacity="",window.siyuan.dragElement=void 0)});let n,a;e.addEventListener("dragover",s=>{if(t.disabled||s.dataTransfer.types.includes(u.SIYUAN_DROP_EDITOR)){s.preventDefault(),s.stopPropagation(),s.dataTransfer.dropEffect="none";return}const o=t.contentElement.getBoundingClientRect();!L(s.target,"av__cell")&&(s.clientY<o.top+u.SIZE_SCROLL_TB||s.clientY>o.bottom-u.SIZE_SCROLL_TB)&&t.contentElement.scroll({top:t.contentElement.scrollTop+(s.clientY<o.top+u.SIZE_SCROLL_TB?-u.SIZE_SCROLL_STEP:u.SIZE_SCROLL_STEP),behavior:"smooth"});let l;if(s.dataTransfer.types.includes("Files")){if(l=L(s.target,"av__cell"),l&&l.getAttribute("data-dtype")==="mAsset"&&!l.classList.contains("av__cell--header")){if(s.preventDefault(),n&&l.isSameNode(n))return;P(l)&&(t.wysiwyg.element.querySelectorAll(".av__cell--select, .av__cell--active").forEach(g=>{g.classList.remove("av__cell--select","av__cell--active"),g.querySelector(".av__drag-fill")?.remove()}),l.classList.add("av__cell--select"),In(l),n=l)}return}let r="";for(const f of s.dataTransfer.items)f.type.startsWith(u.SIYUAN_DROP_GUTTER)&&(r=f.type);if(!r&&!window.siyuan.dragElement){s.preventDefault();return}const d=s.dataTransfer.types.includes(u.SIYUAN_DROP_FILE)&&window.siyuan.dragElement?window.siyuan.dragElement.innerText:"";if(s.shiftKey||s.altKey&&d.indexOf("-")===-1){const f=P(s.target);f?(f.classList.remove("dragover__top","protyle-wysiwyg--select","dragover__bottom","dragover__left","dragover__right"),f.removeAttribute("select-start"),f.removeAttribute("select-end")):e.querySelectorAll(".dragover__top, .protyle-wysiwyg--select, .dragover__bottom, .dragover__left, .dragover__right").forEach(g=>{g.classList.remove("dragover__top","protyle-wysiwyg--select","dragover__bottom","dragover__left","dragover__right"),g.removeAttribute("select-start"),g.removeAttribute("select-end")}),s.preventDefault();return}s.preventDefault(),l=L(s.target,"av__row")||L(s.target,"av__row--util")||P(s.target);const c={x:s.clientX,y:s.clientY,className:""};if(l&&(l.classList.contains("bq")||l.classList.contains("sb")||l.classList.contains("list")||l.classList.contains("li"))){let f=P(document.elementFromPoint(c.x,c.y-6));for(;f&&l.contains(f);)f.nextElementSibling?.getAttribute("data-node-id")&&(l=f),f=f.parentElement}if(l)l&&l.classList.contains("list")&&(r&&r.replace(u.SIYUAN_DROP_GUTTER,"").split(u.ZWSP)[0]!=="nodelistitem"?l=P(document.elementFromPoint(s.clientX,s.clientY-6)):l=L(document.elementFromPoint(s.clientX,s.clientY-6),"li"));else if(s.clientY>e.lastElementChild.getBoundingClientRect().bottom)l=e.lastElementChild,c.className="dragover__bottom";else if(s.clientY<e.firstElementChild.getBoundingClientRect().top)l=e.firstElementChild,c.className="dragover__top";else if(o){const f={left:o.left+parseInt(e.style.paddingLeft),right:o.left+t.contentElement.clientWidth-parseInt(e.style.paddingRight)};s.clientX<f.left?(c.x=f.left,c.className="dragover__left"):s.clientX>=f.right&&(c.x=f.right-6,c.className="dragover__right"),l=document.elementFromPoint(c.x,c.y),l.classList.contains("protyle-wysiwyg")&&(l=document.elementFromPoint(c.x,c.y-6)),l=re(l,"data-node-id",null)}if(r&&r.startsWith(`${u.SIYUAN_DROP_GUTTER}NodeAttributeView${u.ZWSP}Col${u.ZWSP}`.toLowerCase())){if(l=L(s.target,"av__cell"),l){const f=L(l,"av__row--header"),g=L(window.siyuan.dragElement,"av__row--header");(l.isSameNode(window.siyuan.dragElement)||!f||!g||f&&g&&!f.isSameNode(g))&&(l=!1)}}else l&&r&&r.startsWith(`${u.SIYUAN_DROP_GUTTER}NodeAttributeViewRowMenu${u.ZWSP}`.toLowerCase())&&(!l.classList.contains("av__row")&&!l.classList.contains("av__row--util")||window.siyuan.dragElement&&!window.siyuan.dragElement.contains(l))&&(l=!1);if(l){if(l&&n&&l.isSameNode(n)){const f=l.getBoundingClientRect();if(e.querySelectorAll(".dragover__left, .dragover__right, .dragover__bottom, .dragover__top, .dragover").forEach(g=>{g.classList.remove("dragover__top","dragover__bottom","dragover__left","dragover__right","dragover"),g.removeAttribute("select-start"),g.removeAttribute("select-end")}),d.indexOf("-")>-1&&!l.classList.contains("av__row")&&!l.classList.contains("av__row--util"))if(s.altKey){if(d.split(",").includes(t.block.rootID)&&s.altKey)return}else return;if(l.getAttribute("data-type")==="NodeAttributeView"&&q(s.target,"TD"))return;if(c.className){l.classList.add(c.className),Ao(l);return}if(l.getAttribute("data-type")==="NodeListItem"){s.clientY>f.top+f.height/2?(l.classList.add("dragover__bottom"),Ao(l)):l.classList.contains("av__row--header")||(l.classList.add("dragover__top"),Ao(l));return}if(l.classList.contains("av__cell")){s.clientX<f.left+f.width/2&&s.clientX>f.left&&!l.classList.contains("av__row")&&!l.previousElementSibling.isSameNode(window.siyuan.dragElement)?l.classList.add("dragover__left"):s.clientX>f.right-f.width/2&&s.clientX<=f.right+1&&!l.classList.contains("av__row")&&!l.isSameNode(window.siyuan.dragElement.previousElementSibling)&&(window.siyuan.dragElement.previousElementSibling.classList.contains("av__colsticky")&&l.isSameNode(window.siyuan.dragElement.previousElementSibling.lastElementChild)||l.classList.add("dragover__right"));return}s.clientX<f.left+32&&s.clientX>=f.left-1&&!l.classList.contains("av__row")?(l.classList.add("dragover__left"),Ao(l)):s.clientX>f.right-32&&s.clientX<f.right&&!l.classList.contains("av__row")?(l.classList.add("dragover__right"),Ao(l)):l.classList.contains("av__row--header")?l.classList.add("dragover__bottom"):l.classList.contains("av__row--util")?l.previousElementSibling.classList.add("dragover__bottom"):s.clientY>f.top+f.height/2&&a!=="bottom"?(l.classList.add("dragover__bottom"),Ao(l)):a!=="top"&&(l.classList.add("dragover__top"),Ao(l));return}if(d.indexOf("-")>-1){d.split(",").includes(t.block.rootID)&&!l.classList.contains("av__row")&&!l.classList.contains("av__row--util")&&s.altKey?(n=void 0,e.querySelectorAll(".dragover__left, .dragover__right, .dragover__bottom, .dragover__top, .dragover").forEach(f=>{f.classList.remove("dragover__top","dragover__bottom","dragover__left","dragover__right","dragover"),f.removeAttribute("select-start"),f.removeAttribute("select-end")})):n=l;return}if(r){a="",n&&(n.classList.remove("dragover__top","dragover__bottom","dragover__left","dragover__right","dragover"),n=void 0);const f=r.replace(u.SIYUAN_DROP_GUTTER,"").split(u.ZWSP);if(f[0]==="nodeattributeview"&&f[1]==="col"&&l.getAttribute("data-id")===f[2]||f[0]==="nodeattributeviewrowmenu"&&f[2]===l.getAttribute("data-id")||f[2].split(",").find(p=>{if(p&&B(l,"data-node-id",p))return!0})&&f[0]!=="nodeattributeviewrowmenu"||F(l)||f[0]==="nodelistitem"&&f[1]!==l.getAttribute("data-subtype")&&l.getAttribute("data-type")==="NodeListItem"||f[0]!=="nodelistitem"&&l.getAttribute("data-type")==="NodeListItem")return;f[0]==="nodelistitem"&&l.parentElement.classList.contains("li")&&l.previousElementSibling?.classList.contains("protyle-action")&&(a="top"),f[0]==="nodelistitem"&&l.nextElementSibling?.classList.contains("list")&&(a="bottom"),l&&l.classList.contains("av__row--header")&&(a="top"),n=l}}});let i=0;e.addEventListener("dragleave",s=>{if(t.disabled){s.preventDefault(),s.stopPropagation();return}i--,i===0&&(e.querySelectorAll(".dragover__left, .dragover__right, .dragover__bottom, .dragover__top, .dragover").forEach(o=>{o.classList.remove("dragover__top","dragover__bottom","dragover__left","dragover__right","dragover")}),n=void 0)}),e.addEventListener("dragenter",s=>{s.preventDefault(),i++})},Ao=t=>{(t.classList.contains("sb")||t.classList.contains("li")||t.classList.contains("list")||t.classList.contains("bq"))&&t.classList.add("dragover")},wT=(t,e,n)=>{if(!e.classList.contains("av")||!window.siyuan.menus.menu.element.classList.contains("fn__none"))return!1;if(t.isComposing)return!0;if(H("\u2318B",t)||H("\u2318I",t)||H("\u2318U",t))return t.preventDefault(),!0;const a=e.querySelector(".av__cell--select");if(a){const s=L(a,"av__row");if(!s)return!1;const o=document.querySelector(".av__panel");if(o&&(t.key==="Backspace"||t.key==="Delete"||t.key==="Escape"||t.key.startsWith("ArrowLeft")||t.key==="Enter"||H("\u21E5",t)||H("\u21E7\u21E5",t)))return o.remove(),t.preventDefault(),t.stopPropagation(),!0;if(t.key==="Backspace"||t.key==="Delete")return Tn(n,e,void 0,Array.from(e.querySelectorAll(".av__cell--active, .av__cell--select"))),t.preventDefault(),!0;if(t.key==="Escape")return e.querySelectorAll(".av__cell--select, .av__cell--active").forEach(r=>{r.classList.remove("av__cell--select","av__cell--active"),r.querySelector(".av__drag-fill")?.remove()}),Ha(s.querySelector(".av__firstcol"),"select"),t.preventDefault(),!0;if(t.key==="Enter")return Kn(n,[a]),t.preventDefault(),!0;let l;if(t.key==="ArrowLeft"||H("\u21E7\u21E5",t)){const r=s.previousElementSibling;if(a.previousElementSibling&&!a.previousElementSibling.classList.contains("av__firstcol"))a.previousElementSibling.classList.contains("av__cell")?l=a.previousElementSibling:l=a.previousElementSibling.lastElementChild;else if(r&&!r.classList.contains("av__row--header")){const d=r.querySelectorAll(".av__cell");l=d[d.length-1]}return l&&(a.classList.remove("av__cell--select","av__cell--active"),a.querySelector(".av__drag-fill")?.remove(),l.classList.add("av__cell--select"),In(l),Ii(e,l,!1)),t.preventDefault(),!0}if(t.key==="ArrowRight"||H("\u21E5",t)){const r=s.nextElementSibling;return a.nextElementSibling&&a.nextElementSibling.classList.contains("av__cell")?l=a.nextElementSibling:!a.nextElementSibling&&a.parentElement.nextElementSibling?l=a.parentElement.nextElementSibling:r&&!r.classList.contains("av__row--footer")&&(l=r.querySelector(".av__cell")),l&&(a.classList.remove("av__cell--select","av__cell--active"),a.querySelector(".av__drag-fill")?.remove(),l.classList.add("av__cell--select"),In(l),Ii(e,l,!1)),t.preventDefault(),!0}if(t.key==="ArrowUp"){const r=s.previousElementSibling;return r&&!r.classList.contains("av__row--header")&&(l=r.querySelector(`.av__cell[data-col-id="${a.dataset.colId}"]`)),l&&(a.classList.remove("av__cell--select","av__cell--active"),a.querySelector(".av__drag-fill")?.remove(),l.classList.add("av__cell--select"),In(l),Ii(e,l)),t.preventDefault(),!0}if(t.key==="ArrowDown"){const r=s.nextElementSibling;return r&&!r.classList.contains("av__row--footer")&&(l=r.querySelector(`.av__cell[data-col-id="${a.dataset.colId}"]`)),l&&(a.classList.remove("av__cell--select","av__cell--active"),a.querySelector(".av__drag-fill")?.remove(),l.classList.add("av__cell--select"),In(l),Ii(e,l)),t.preventDefault(),!0}if(!u.KEYCODELIST[t.keyCode]||u.KEYCODELIST[t.keyCode].length===1&&!t.metaKey&&!t.ctrlKey&&!["\u21E7","\u2303","\u2325","\u2318"].includes(u.KEYCODELIST[t.keyCode]))return a.style.backgroundColor?t.preventDefault():Kn(n,[a]),!0}const i=e.querySelectorAll(".av__row--select:not(.av__row--header)");if(i.length>0){if(H("\u2318/",t))return t.stopPropagation(),t.preventDefault(),Zf(n,i[0],{x:e.querySelector(".layout-tab-bar").getBoundingClientRect().left,y:i[0].getBoundingClientRect().bottom}),!0;if(t.key==="Escape")return t.preventDefault(),Ha(i[0].querySelector(".av__firstcol"),"unselectAll"),!0;if(t.key==="Backspace")return t.preventDefault(),S_(e,n),!0;if(t.key==="Enter")return Ha(i[0].querySelector(".av__firstcol"),"unselectAll"),Kn(n,[i[0].querySelector(".av__cell")]),t.preventDefault(),!0;if(t.key==="ArrowUp"){const s=i[0].previousElementSibling;return Ha(i[0].querySelector(".av__firstcol"),"unselectAll"),s&&!s.classList.contains("av__row--header")?(Ha(s.querySelector(".av__firstcol"),"select"),Ii(e,s)):e.classList.add("protyle-wysiwyg--select"),t.preventDefault(),!0}if(t.key==="ArrowDown"){const s=i[i.length-1].nextElementSibling;return Ha(i[0].querySelector(".av__firstcol"),"unselectAll"),s&&!s.classList.contains("av__row--util")?(Ha(s.querySelector(".av__firstcol"),"select"),Ii(e,s)):e.classList.add("protyle-wysiwyg--select"),t.preventDefault(),!0}}return!1},Fc=t=>{if(t.command==="switchReadonly")return Hh(t.protyle.breadcrumb.element.parentElement.querySelector('.block__icon[data-type="readonly"]'),t.protyle),!0;if(t.command==="switchAdjust"){let n;const a=t.protyle.wysiwyg.element.getAttribute(u.CUSTOM_SY_FULLWIDTH);return a?n=a==="true"?"false":"true":n=window.siyuan.config.editor.fullWidth?"false":"true",E("/api/attr/setBlockAttrs",{id:t.protyle.block.rootID,attrs:{[u.CUSTOM_SY_FULLWIDTH]:n}}),!0}const e=P(t.previousRange.startContainer);if(!e)return!1;if(t.command==="enter"){let n=Je(e);n.parentElement.classList.contains("li")&&n.parentElement.parentElement.classList.contains("list")&&n.nextElementSibling?.classList.contains("list")&&n.previousElementSibling.classList.contains("protyle-action")&&(n=n.parentElement);const a=n.getAttribute("data-node-id");return t.protyle.options.backlinkData?Ke(a,(i,s)=>{de({app:t.protyle.app,id:a,action:s,zoomIn:i})}):Vt({protyle:t.protyle,id:a}),!0}return t.command==="enterBack"?(pm(t.protyle,e.getAttribute("data-node-id")),!0):!1},Eb=(t,e)=>{let n="";Array.from(t.cloneContents().childNodes).forEach(a=>{a.nodeType===3?n+=a.textContent:n+=a.outerHTML}),E("/api/block/getDOMText",{dom:n},a=>{e(a.data)})},_T=(t,e)=>{e.addEventListener("keydown",n=>{if(n.target.localName==="protyle-html"||n.target.localName==="input"){n.stopPropagation();return}if(t.disabled||!t.selectElement.classList.contains("fn__none")){n.stopPropagation(),n.preventDefault();return}t.wysiwyg.preventKeyup=!1,Q(["util"],t),n.shiftKey&&n.key.indexOf("Arrow")>-1||!n.repeat&&n.code!==""&&Q(["toolbar"],t);const a=me(t.wysiwyg.element),i=P(a.startContainer);if(!i)return;const s=P(a.endContainer);if(!H("\u2318C",n)&&s&&!i.isSameNode(s)){n.stopPropagation(),n.preventDefault();return}if(wT(n,i,t))return;if(i.classList.contains("protyle-wysiwyg--select")&&qe(n)&&!n.shiftKey&&!n.altKey){if(n.key.toLowerCase()==="a")return n.stopPropagation(),n.preventDefault(),t.wysiwyg.element.blur(),setTimeout(()=>{_n(t,"afterend")},100),!1;if(n.key.toLowerCase()==="b")return n.stopPropagation(),n.preventDefault(),t.wysiwyg.element.blur(),setTimeout(()=>{_n(t,"beforebegin")},100),!1}if(n.isComposing){n.stopPropagation();return}if(["\u2318","\u21E7","\u2325","\u2303"].includes(u.KEYCODELIST[n.keyCode])||(u.KEYCODELIST[n.keyCode]==="/"||n.key==="/"||n.code==="Slash"&&n.key==="Process"&&n.keyCode===229?t.hint.enableSlash=!0:(u.KEYCODELIST[n.keyCode]==="\\"||n.key==="\\"||n.key===","&&n.keyCode===229||n.code==="Backslash"&&n.key==="Process"&&n.keyCode===229)&&(t.hint.enableSlash=!1,Q(["hint"],t))),n.key!=="PageUp"&&n.key!=="PageDown"&&n.key!=="Home"&&n.key!=="End"&&n.key.indexOf("Arrow")===-1&&n.key!=="Escape"&&n.key!=="Shift"&&n.key!=="Meta"&&n.key!=="Alt"&&n.key!=="Control"&&n.key!=="CapsLock"&&!Ln(i)&&!/^F\d{1,2}$/.test(n.key)&&n.key!=="Process"&&(qc(i,a,t),t.wysiwyg.preventKeyup=!0),!window.siyuan.menus.menu.element.classList.contains("fn__none")&&(["\u2190","\u2191","\u2192","\u2193"].includes(u.KEYCODELIST[n.keyCode])||u.KEYCODELIST[n.keyCode]==="\u21A9")&&!n.altKey&&!n.shiftKey&&qe(n)){n.preventDefault();return}else n.key!=="Escape"&&window.siyuan.menus.menu.remove();if(!["Alt","Meta","Shift","Control","CapsLock","Escape"].includes(n.key)&&t.options.render.breadcrumb&&t.breadcrumb.hide(),!n.altKey&&!n.shiftKey&&qe(n)&&(n.key==="ArrowDown"||n.key==="ArrowUp")){const p=t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(p.length>0){if(n.preventDefault(),n.stopPropagation(),Q(["select"],t),n.key==="ArrowDown"){const h=p[p.length-1];let m=et(h);if(m)if(m.getBoundingClientRect().width===0){const y=re(m,"fold","1");y?(m=et(y),m?m=it(m):m=h):m=h}else m.getAttribute("fold")==="1"&&(m.classList.contains("sb")||m.classList.contains("bq"))||(m=it(m));else m=h;m.classList.add("protyle-wysiwyg--select"),bn([m.getAttribute("data-node-id")]);const b=m.getBoundingClientRect().bottom-t.contentElement.getBoundingClientRect().bottom;b>0&&(t.contentElement.scrollTop=t.contentElement.scrollTop+b,t.scroll.lastScrollTop=t.contentElement.scrollTop-1),ae(m)}else if(n.key==="ArrowUp"){let h=Pe(p[0]);if(h){if(h=bt(h),h.getBoundingClientRect().width===0){const m=re(h,"fold","1");m?h=it(m):h=p[0]}else if(h){const m=re(h,"fold","1");m&&(m.classList.contains("sb")||m.classList.contains("bq"))&&(h=m)}}else if(t.title&&t.title.editElement&&(t.wysiwyg.element.firstElementChild.getAttribute("data-eof")==="1"||t.contentElement.scrollTop===0)){const m=Pt(t.title.editElement,a,!1);m.collapse(!1),Z(m),n.stopPropagation(),n.preventDefault()}else t.contentElement.scrollTop!==0?(t.contentElement.scrollTop=0,t.scroll.lastScrollTop=8):h=p[0];if(h){h.classList.add("protyle-wysiwyg--select"),bn([h.getAttribute("data-node-id")]);const m=h.getBoundingClientRect().top-t.contentElement.getBoundingClientRect().top;m<0&&(t.contentElement.scrollTop=t.contentElement.scrollTop+m,t.scroll.lastScrollTop=t.contentElement.scrollTop+1),ae(h)}}return}}if(n.key!=="PageUp"&&n.key!=="PageDown"&&n.key!=="Home"&&n.key!=="End"&&n.key.indexOf("Arrow")===-1&&qe(n)&&n.key!=="Escape"&&!n.shiftKey&&!n.altKey&&!/^F\d{1,2}$/.test(n.key)&&n.key!=="Enter"&&n.key!=="Tab"&&n.key!=="Backspace"&&n.key!=="Delete"&&n.key!=="ContextMenu")return n.stopPropagation(),Q(["select"],t),!1;if(H(window.siyuan.config.keymap.editor.general.collapse.custom,n)&&!n.repeat){const p=t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");return p.length>0?an(t,p[0]):i.parentElement.getAttribute("data-type")==="NodeListItem"?i.parentElement.childElementCount>3?an(t,i.parentElement):an(t,i):i.getAttribute("data-type")==="NodeHeading"?an(t,i):an(t,Je(i)),n.stopPropagation(),n.preventDefault(),!1}if(H(window.siyuan.config.keymap.editor.general.expand.custom,n)&&!n.repeat){const p=t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");p.length>0?an(t,p[0],!0):i.parentElement.getAttribute("data-type")==="NodeListItem"?i.parentElement.childElementCount>3?an(t,i.parentElement,!0):an(t,i,!0):i.getAttribute("data-type")==="NodeHeading"?an(t,i,!0):an(t,Je(i),!0),n.stopPropagation(),n.preventDefault();return}if(n.shiftKey&&(n.key==="ArrowLeft"||n.key==="ArrowRight")){if(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").length>0){n.stopPropagation(),n.preventDefault();return}if(!a.toString()){if(n.key==="ArrowRight"&&Ia(a)){n.preventDefault(),n.stopPropagation();return}const h=le(i);if(ct(h,t.wysiwyg.element,a).start===0&&n.key==="ArrowLeft"){n.preventDefault(),n.stopPropagation();return}}}if(H(window.siyuan.config.keymap.editor.general.expandUp.custom,n)){b_({protyle:t,event:n,nodeElement:i,editorElement:e,range:a,cb(p){const h=p[0].previousElementSibling;if(h&&h.getAttribute("data-node-id")){h.classList.add("protyle-wysiwyg--select"),p.forEach(b=>{b.removeAttribute("select-end")}),h.setAttribute("select-end","true");const m=h.getBoundingClientRect().top-t.contentElement.getBoundingClientRect().top;m<0&&(t.contentElement.scrollTop=t.contentElement.scrollTop+m,t.scroll.lastScrollTop=t.contentElement.scrollTop+1)}else p[0].parentElement.classList.contains("protyle-wysiwyg")||(Q(["select"],t),p[0].parentElement.classList.add("protyle-wysiwyg--select"))}});return}if(H(window.siyuan.config.keymap.editor.general.expandDown.custom,n)){y_({protyle:t,event:n,nodeElement:i,editorElement:e,range:a,cb(p){const h=p[p.length-1],m=h.nextElementSibling;if(m&&m.getAttribute("data-node-id")){m.classList.add("protyle-wysiwyg--select"),p.forEach(y=>{y.removeAttribute("select-end")}),m.setAttribute("select-end","true");const b=m.getBoundingClientRect().bottom-t.contentElement.getBoundingClientRect().bottom;b>0&&(t.contentElement.scrollTop=t.contentElement.scrollTop+b,t.scroll.lastScrollTop=t.contentElement.scrollTop-1)}else h.parentElement.classList.contains("protyle-wysiwyg")||(Q(["select"],t),h.parentElement.classList.add("protyle-wysiwyg--select"))}});return}if(H("\u21E7\u2191",n)){b_({protyle:t,event:n,nodeElement:i,editorElement:e,range:a,cb(p){const h=Wf(p);if(h.startElement.getBoundingClientRect().top>=h.endElement.getBoundingClientRect().top){const m=h.endElement.previousElementSibling;if(m&&m.getAttribute("data-node-id")){m.classList.add("protyle-wysiwyg--select"),m.setAttribute("select-end","true"),h.endElement.removeAttribute("select-end");const b=m.getBoundingClientRect().top-t.contentElement.getBoundingClientRect().top;b<0&&(t.contentElement.scrollTop=t.contentElement.scrollTop+b,t.scroll.lastScrollTop=t.contentElement.scrollTop+1)}else h.endElement.parentElement.classList.contains("protyle-wysiwyg")||(Q(["select"],t),h.endElement.parentElement.classList.add("protyle-wysiwyg--select"))}else{h.endElement.classList.remove("protyle-wysiwyg--select"),h.endElement.removeAttribute("select-end");const m=Pe(h.endElement);m&&(m.setAttribute("select-end","true"),m.getBoundingClientRect().top<=t.contentElement.getBoundingClientRect().top&&(Bn(t),m.scrollIntoView(!0)))}}});return}if(H("\u21E7\u2193",n)){y_({protyle:t,event:n,nodeElement:i,editorElement:e,range:a,cb(p){const h=Wf(p);if(h.startElement.getBoundingClientRect().top<=h.endElement.getBoundingClientRect().top){const m=h.endElement.nextElementSibling;if(m&&m.getAttribute("data-node-id"))if(m.getBoundingClientRect().width===0)Q(["select"],t),h.endElement.parentElement.classList.add("protyle-wysiwyg--select");else{m.classList.add("protyle-wysiwyg--select"),m.setAttribute("select-end","true"),h.endElement.removeAttribute("select-end");const b=m.getBoundingClientRect().bottom-t.contentElement.getBoundingClientRect().bottom;b>0&&(t.contentElement.scrollTop=t.contentElement.scrollTop+b,t.scroll.lastScrollTop=t.contentElement.scrollTop-1)}else h.endElement.parentElement.classList.contains("protyle-wysiwyg")||(Q(["select"],t),h.endElement.parentElement.classList.add("protyle-wysiwyg--select"))}else{h.endElement.classList.remove("protyle-wysiwyg--select"),h.endElement.removeAttribute("select-end");const m=et(h.endElement);m&&(m.setAttribute("select-end","true"),m.getBoundingClientRect().bottom>=t.contentElement.getBoundingClientRect().bottom&&(Bn(t),m.scrollIntoView(!1)))}}});return}if(H(window.siyuan.config.keymap.general.enter.custom,n)){Fc({protyle:t,command:"enter",previousRange:a}),n.preventDefault(),n.stopPropagation();return}if(H(window.siyuan.config.keymap.general.enterBack.custom,n)){Fc({protyle:t,command:"enterBack",previousRange:a}),n.preventDefault(),n.stopPropagation();return}if(n.shiftKey&&!n.altKey&&qe(n)&&(n.key==="Home"||n.key==="End")&&gt()||n.shiftKey&&!n.altKey&&Dt(n)&&(n.key==="Home"||n.key==="End")&&!gt()){const p=re(i,"data-node-id",null);if(p){p.querySelectorAll(".protyle-wysiwyg--select").forEach(m=>{m.classList.remove("protyle-wysiwyg--select")}),p.classList.add("protyle-wysiwyg--select");let h=n.key==="Home"?p.previousElementSibling:p.nextElementSibling;for(;h;)h.classList.add("protyle-wysiwyg--select"),h=n.key==="Home"?h.previousElementSibling:h.nextElementSibling;n.key==="Home"?t.wysiwyg.element.firstElementChild.scrollIntoView():t.wysiwyg.element.lastElementChild.scrollIntoView(!1)}n.stopPropagation(),n.preventDefault();return}if((n.key==="Home"||n.key==="End")&&!n.shiftKey&&!n.altKey&&qe(n)&&Q(["hint"],t),!n.altKey&&!n.shiftKey&&qe(n)&&(n.key==="PageUp"||n.key==="PageDown")){n.key==="PageUp"?(t.contentElement.scrollTop=t.contentElement.scrollTop-t.contentElement.clientHeight+60,t.scroll.lastScrollTop=t.contentElement.scrollTop+1):(t.contentElement.scrollTop=t.contentElement.scrollTop+t.contentElement.clientHeight-60,t.scroll.lastScrollTop=t.contentElement.scrollTop-1);const p=t.contentElement.getBoundingClientRect();let h=document.elementFromPoint(p.x+p.width/2,p.y+p.height/2);h.classList.contains("protyle-wysiwyg")&&(h=document.elementFromPoint(p.x+p.width/2,p.y+p.height/2+u.SIZE_TOOLBAR_HEIGHT));const m=P(h);m&&!m.isSameNode(i)&&ae(m,void 0,!1),n.stopPropagation(),n.preventDefault();return}if(!n.altKey&&!n.shiftKey&&(n.key.indexOf("Arrow")>-1&&qe(n)||n.key==="Enter")&&!t.hint.element.classList.contains("fn__none")&&t.hint.select(n,t))return;if(H("\u2318/",n)){n.stopPropagation(),n.preventDefault();const p=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(p.length===0){const m=B(a.startContainer,"data-type",null);if(m&&m.tagName==="SPAN"){const b=m.getAttribute("data-type").split(" ");if(b.length>0&&(t.toolbar.range=a,h_(m)),b.includes("block-ref")){fm(t,m);return}else if(b.includes("inline-memo")){t.toolbar.showRender(t,m);return}else if(b.includes("file-annotation-ref")){um(t,m);return}else if(b.includes("a")){bc(t,m);return}else if(b.includes("tag")){hm(t,m);return}}if(a.startOffset===0&&a.startContainer.nodeType===3){const b=At(a.startContainer);if(b&&b.nodeType!==3&&b.getAttribute("data-type")?.indexOf("inline-math")>-1){zf(t,b);return}else if(!b&&a.startContainer.parentElement.previousSibling&&a.startContainer.parentElement.previousSibling.isSameNode(a.startContainer.parentElement.previousElementSibling)&&a.startContainer.parentElement.previousElementSibling.getAttribute("data-type")?.indexOf("inline-math")>-1){zf(t,a.startContainer.parentElement.previousElementSibling);return}}p.push(i)}p.length===1?t.gutter.renderMenu(t,p[0]):t.gutter.renderMultipleMenu(t,p);const h=i.getBoundingClientRect();window.siyuan.menus.menu.popup({x:h.left,y:h.top,isLeft:!0});return}if(dL(t,n,a)){n.preventDefault();return}const o=a.toString();if(!n.altKey&&!n.shiftKey&&qe(n)&&!n.isComposing&&n.key.indexOf("Arrow")>-1){const p=q(a.startContainer,"TD")||q(a.startContainer,"TH"),h=p||le(i)||i,m=ct(h,t.wysiwyg.element,a);if(i.classList.contains("code-block")&&m.end===h.innerText.length&&(m.end-=1),n.key==="ArrowDown"&&h?.innerText.trimRight().substr(m.start).indexOf(`
`)===-1&&(p&&!p.parentElement.nextElementSibling&&i.getAttribute("data-type")==="NodeTable"&&!et(i)||i.getAttribute("data-type")==="NodeCodeBlock"&&!et(i)||i.parentElement.getAttribute("data-type")==="NodeBlockquote"&&i.nextElementSibling.classList.contains("protyle-attr")&&!et(i.parentElement)))i.parentElement.getAttribute("data-type")==="NodeBlockquote"?_n(t,"afterend",i.parentElement.getAttribute("data-node-id")):_n(t,"afterend",i.getAttribute("data-node-id"));else if(n.key==="ArrowUp"){const b=le(t.wysiwyg.element.firstElementChild);if(!Pe(i)&&i.contains(b)||!b&&i.isSameNode(t.wysiwyg.element.firstElementChild)){if(ta(h,a).top-h.getBoundingClientRect().top<20||i.classList.contains("av"))if(t.title&&t.title.editElement&&(t.wysiwyg.element.firstElementChild.getAttribute("data-eof")==="1"||t.contentElement.scrollTop===0)){const y=Pt(t.title.editElement,a,!1);y.collapse(!1),Z(y),n.stopPropagation(),n.preventDefault()}else t.contentElement.scrollTop=0,t.scroll.lastScrollTop=8}else if((h?.innerText.substr(0,m.end).indexOf(`
`)===-1||m.start===0)&&ta(h,a).top-h.getBoundingClientRect().top<20){let y=Pe(i);if(y&&(y=bt(y),y)){const w=B(y,"fold","1");!w&&y.classList.contains("code-block")?(ae(y,void 0,!1),Ne(t,y),n.stopPropagation(),n.preventDefault()):w&&w.getAttribute("data-type")!=="NodeListItem"&&(w.scrollTop=0,ae(w,void 0,!0),Ne(t,w),n.stopPropagation(),n.preventDefault())}}}else if(o===""&&(n.key==="ArrowDown"||n.key==="ArrowRight")&&i.isSameNode(bt(t.wysiwyg.element.lastElementChild))&&!q(a.startContainer,"TD")&&!q(a.startContainer,"TH")){const b=le(i);b&&!b.querySelector(".emoji")&&b.textContent.replace(/\n$/,"").length<=ct(b,void 0,a).end&&(n.stopPropagation(),n.preventDefault(),Z(a))}else if(o===""&&n.key==="ArrowLeft"&&i.isSameNode(it(t.wysiwyg.element.firstElementChild))){const b=le(i);b&&ct(b,void 0,a).start===0&&(n.stopPropagation(),n.preventDefault(),Z(a))}if(n.key==="ArrowDown"){if(h?.innerText.trimRight().substr(m.start).indexOf(`
`)===-1&&i.isSameNode(t.wysiwyg.element.lastElementChild)){Pt(le(h),a,!1),a.collapse(!1),n.stopPropagation(),n.preventDefault();return}const b=B(a.startContainer,"fold","1");if(b){let y=et(b);y&&(y.getAttribute("fold")==="1"&&(y.classList.contains("sb")||y.classList.contains("bq"))||(y=it(y)),ae(y),Ne(t,y)),n.stopPropagation(),n.preventDefault()}else if(h?.innerText.substr(m.end).indexOf(`
`)===-1||m.end>=h.innerText.trimEnd().length){a.collapse(!1);const y=et(i);y&&(y.getAttribute("fold")==="1"||y.classList.contains("code-block"))&&h.getBoundingClientRect().bottom-ta(i,a).top<40&&(ae(y),Ne(t,y),n.stopPropagation(),n.preventDefault())}}return}if(!n.altKey&&(n.key==="Backspace"||n.key==="Delete")||H("\u2303D",n)){if(t.wysiwyg.element.querySelector(".protyle-wysiwyg--select")){fa(t,i,a,n.key==="Backspace"?"Backspace":"Delete"),n.stopPropagation(),n.preventDefault();return}if(o===""&&n.key==="Backspace"&&a.startOffset===a.startContainer.textContent.length&&a.startContainer.textContent.endsWith(`
`+u.ZWSP)){a.setStart(a.startContainer,a.startOffset-1),a.collapse(!0),n.stopPropagation(),n.preventDefault();return}const p=At(a.startContainer);if(a.startOffset===1&&a.startContainer.textContent===u.ZWSP&&p&&p.nodeType!==3&&n.key==="Backspace"){if(p.classList.contains("img"))p.classList.add("img--select");else if(p.getAttribute("data-type")?.indexOf("inline-math")>-1){p.after(document.createElement("wbr"));const m=i.outerHTML;a.startContainer.textContent="",p.remove(),J(t,i.getAttribute("data-node-id"),i.outerHTML,m),he(i,a),n.stopPropagation(),n.preventDefault();return}}const h=t.wysiwyg.element.querySelector(".img--select");if(h){if(h.classList.remove("img--select"),i.contains(h)){mm(h,i,a,t),n.stopPropagation(),n.preventDefault();return}}else if(o===""){if(i.classList.contains("table")&&i.querySelector(".table__select").clientHeight>0){Cw(t,i),n.stopPropagation(),n.preventDefault();return}const m=le(i);if(!m){i.classList.add("protyle-wysiwyg--select"),fa(t,i,a,n.key==="Backspace"?"Backspace":"Delete"),n.stopPropagation(),n.preventDefault();return}const b=ct(m,t.wysiwyg.element,a);if(n.key==="Delete"||H("\u2303D",n)){if(a.startOffset===0&&a.startContainer.textContent.length===1){const y=At(a.startContainer),w=Oe(a.startContainer);if(y&&y.nodeType===1&&y.classList.contains("img")&&w&&w.nodeType===1&&w.classList.contains("img")){const _=document.createElement("wbr");a.insertNode(_);const x=i.outerHTML;_.nextSibling.textContent=u.ZWSP,J(t,i.getAttribute("data-node-id"),i.outerHTML,x),he(i,a),n.preventDefault();return}}if(b.end===m.innerText.length||b.end===m.innerText.length-1&&m.innerText.endsWith(`
`)||b.end===m.innerText.length-1&&m.innerText.endsWith(u.ZWSP)){const y=et(Je(i));if(y){const w=ae(y);if(w){const _=P(w.startContainer);_&&fa(t,_,w,"Delete")}n.stopPropagation(),n.preventDefault();return}}else if(b.end===m.innerText.length-1&&i.getAttribute("data-type")==="NodeCodeBlock"){n.stopPropagation(),n.preventDefault();return}else{let y=Oe(a.startContainer);if(y){if(y.nodeType===3&&y.textContent===u.ZWSP){if(!y.nextSibling){const w=et(i);w&&fa(t,w,a,"remove"),n.stopPropagation(),n.preventDefault();return}y=y.nextSibling}if(y.nodeType===1&&y.classList.contains("img")&&ct(a.startContainer,t.wysiwyg.element,a).start===a.startContainer.textContent.length){mm(y,i,a,t),n.stopPropagation(),n.preventDefault();return}}}}else{const y=a.startContainer.childNodes[a.startOffset-1];if(b.start===0&&(a.startOffset===0||y&&y.nodeType===3&&!At(y)&&y.textContent==="")){fa(t,i,a,"Backspace"),n.stopPropagation(),n.preventDefault();return}if(a.startContainer.nodeType!==3&&i.getAttribute("data-type")==="NodeTable"&&a.startContainer.children[a.startOffset-1]?.tagName==="TABLE"){i.classList.add("protyle-wysiwyg--select"),fa(t,i,a,"Backspace"),n.stopPropagation(),n.preventDefault();return}if(y&&y.nodeType!==3&&y.classList.contains("img")){mm(y,i,a,t),n.stopPropagation(),n.preventDefault();return}if(a.startOffset===1&&a.startContainer.textContent.length===1){const _=At(a.startContainer),x=Oe(a.startContainer);if(_&&_.nodeType===1&&_.classList.contains("img")&&x&&x.nodeType===1&&x.classList.contains("img")){const S=document.createElement("wbr");a.insertNode(S);const k=i.outerHTML;S.previousSibling.textContent=u.ZWSP,J(t,i.getAttribute("data-node-id"),i.outerHTML,k),he(i,a),n.preventDefault();return}}if(i.classList.contains("code-block")&&Dt(n)&&a.startContainer.nodeType===3&&a.startContainer.textContent.substring(a.startOffset-1,a.startOffset)===`
`){n.stopPropagation(),n.preventDefault();return}const w=q(a.startContainer,"SPAN");if(b.start===2&&w&&ct(w,t.wysiwyg.element,a).start===1&&w.innerText.startsWith(u.ZWSP)&&m.innerText.startsWith(u.ZWSP)){ae(i),n.stopPropagation(),n.preventDefault();return}if(b.start===1&&!w&&m.innerText.startsWith(u.ZWSP)&&m.innerText.length>1){xo(m,a),fa(t,i,a,"Backspace"),n.stopPropagation(),n.preventDefault();return}}}else if(i.classList.contains("code-block")&&le(i).textContent===`
`){a.collapse(!0),n.stopPropagation(),n.preventDefault();return}}if(H("\u21E7\u21A9",n)&&o===""&&jL(a,i,t)){n.stopPropagation(),n.preventDefault();return}if(qe(n)&&n.key==="Enter"){if(n.altKey)sx(t,i,a);else if(!n.shiftKey){VL(i,a,t),n.stopPropagation(),n.preventDefault();return}}if(H("\u2318A",n))return n.preventDefault(),Lp(t,i,a),!0;if(H(window.siyuan.config.keymap.editor.general.undo.custom,n)){t.undo.undo(t),n.preventDefault(),n.stopPropagation();return}if(H(window.siyuan.config.keymap.editor.general.redo.custom,n)){t.undo.redo(t),n.preventDefault(),n.stopPropagation();return}if(m_(t,n,i))return!0;if(H(window.siyuan.config.keymap.editor.general.copyText.custom,n)){if(o!=="")Eb(a,p=>{De(`${p.trim()} ((${i.getAttribute("data-node-id")} "*"))`)});else{const p=t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");p.length>0?(p[0].setAttribute("data-reftext","true"),Z(me(i)),document.execCommand("copy")):De(`((${i.getAttribute("data-node-id")} "*"))`)}return n.preventDefault(),n.stopPropagation(),!0}if(H(window.siyuan.config.keymap.editor.general.attr.custom,n)){const p=Je(i);if(o===""){const h=t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");let m;h.length===1?m=h[0]:m=p,Ti(m,"bookmark",t)}else Eb(a,h=>{const m=p.outerHTML,b=p.lastElementChild.querySelector(".protyle-attr--name");b?b.innerHTML=`<svg><use xlink:href="#iconN"></use></svg>${h.trim()}`:p.lastElementChild.insertAdjacentHTML("afterbegin",`<div class="protyle-attr--name"><svg><use xlink:href="#iconN"></use></svg>${h.trim()}</div>`),p.setAttribute("name",h.trim()),J(t,p.getAttribute("data-node-id"),p.outerHTML,m)});return n.preventDefault(),n.stopPropagation(),!0}if(H(window.siyuan.config.keymap.editor.general.rename.custom,n)&&!t.disabled){o===""?E("/api/block/getDocInfo",{id:t.block.rootID},p=>{Th({notebookId:t.notebookId,path:t.path,name:p.data.ial.title,range:a,type:"file"})}):E("/api/filetree/renameDoc",{notebook:t.notebookId,path:t.path,title:On(o)}),n.preventDefault(),n.stopPropagation();return}const l=H(window.siyuan.config.keymap.editor.general.newNameFile.custom,n);if(l||H(window.siyuan.config.keymap.editor.general.newNameSettingFile.custom,n)){!o.trim()&&(i.querySelector("tr")||i.querySelector("span"))||(!o.trim()&&le(i).textContent&&Lp(t,i,a),l?E("/api/filetree/getHPathByPath",{notebook:t.notebookId,path:t.path},p=>{Yw(t,o,i,p.data,t.notebookId)}):Wh(t.path,t.notebookId,(p,h)=>{Yw(t,o,i,p,h)})),n.preventDefault(),n.stopPropagation();return}if(H(window.siyuan.config.keymap.editor.general.newContentFile.custom,n)){rL(t),n.preventDefault(),n.stopPropagation();return}if(H(window.siyuan.config.keymap.editor.general.alignLeft.custom,n)){const p=i.querySelectorAll(".img--select");if(p.length>0)v_(t,i,Array.from(p),i.getAttribute("data-node-id"),i.outerHTML);else{let h=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));h.length===0&&(h=[i]),ds(h,t,m=>{m.classList.contains("av")?m.style.justifyContent="":m.style.textAlign="left"})}n.stopPropagation(),n.preventDefault();return}if(H(window.siyuan.config.keymap.editor.general.alignCenter.custom,n)){const p=i.querySelectorAll(".img--select");if(p.length>0)__(t,i,Array.from(p),i.getAttribute("data-node-id"),i.outerHTML);else{let h=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));h.length===0&&(h=[i]),ds(h,t,m=>{m.classList.contains("av")?m.style.justifyContent="center":m.style.textAlign="center"})}n.stopPropagation(),n.preventDefault();return}if(H(window.siyuan.config.keymap.editor.general.alignRight.custom,n)){let p=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));p.length===0&&(p=[i]),ds(p,t,h=>{h.classList.contains("av")?h.style.justifyContent="flex-end":h.style.textAlign="right"}),n.stopPropagation(),n.preventDefault();return}if(H(window.siyuan.config.keymap.editor.general.rtl.custom,n)){let p=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));p.length===0&&(p=[i]),ds(p,t,h=>{h.style.direction="rtl"}),n.stopPropagation(),n.preventDefault();return}if(H(window.siyuan.config.keymap.editor.general.ltr.custom,n)){let p=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));p.length===0&&(p=[i]),ds(p,t,h=>{h.style.direction="ltr"}),n.stopPropagation(),n.preventDefault();return}if(n.key==="Escape"){if(n.repeat){const p=L(a.startContainer,"card__main",!0);p&&document.activeElement&&document.activeElement.classList.contains("protyle-wysiwyg")&&(p.querySelector(".card__action:not(.fn__none) button:not([disabled])").focus(),Q(["select"],t))}else!t.toolbar.element.classList.contains("fn__none")||!t.hint.element.classList.contains("fn__none")||!t.toolbar.subElement.classList.contains("fn__none")?(Q(["toolbar","hint","util"],t),t.hint.enableExtend=!1):i.classList.contains("protyle-wysiwyg--select")?(Q(["select"],t),bn([],t.block.rootID)):window.siyuan.menus.menu.element.classList.contains("fn__none")?(Q(["select"],t),a.collapse(!1),i.classList.add("protyle-wysiwyg--select"),bn([i.getAttribute("data-node-id")],t.block.rootID)):window.siyuan.menus.menu.remove();n.stopPropagation(),n.preventDefault();return}if(H(window.siyuan.config.keymap.editor.heading.paragraph.custom,n)){const p=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(p.length===0&&p.push(i),p.length>1)Ba({protyle:t,nodeElement:p[0],type:"Blocks2Ps"});else{const h=p[0].getAttribute("data-type");h==="NodeHeading"?Ba({protyle:t,nodeElement:p[0],type:"Blocks2Ps"}):h==="NodeList"?Hl({protyle:t,nodeElement:p[0],id:p[0].getAttribute("data-node-id"),type:"CancelList"}):h==="NodeBlockquote"&&Hl({protyle:t,nodeElement:p[0],id:p[0].getAttribute("data-node-id"),type:"CancelBlockquote"})}return n.preventDefault(),n.stopPropagation(),!0}if(H(window.siyuan.config.keymap.editor.heading.heading1.custom,n))return Ba({protyle:t,nodeElement:i,type:"Blocks2Hs",level:1}),n.preventDefault(),n.stopPropagation(),!0;if(H(window.siyuan.config.keymap.editor.heading.heading2.custom,n))return Ba({protyle:t,nodeElement:i,type:"Blocks2Hs",level:2}),n.preventDefault(),n.stopPropagation(),!0;if(H(window.siyuan.config.keymap.editor.heading.heading3.custom,n))return Ba({protyle:t,nodeElement:i,type:"Blocks2Hs",level:3}),n.preventDefault(),n.stopPropagation(),!0;if(H(window.siyuan.config.keymap.editor.heading.heading4.custom,n))return Ba({protyle:t,nodeElement:i,type:"Blocks2Hs",level:4}),n.preventDefault(),n.stopPropagation(),!0;if(H(window.siyuan.config.keymap.editor.heading.heading5.custom,n))return Ba({protyle:t,nodeElement:i,type:"Blocks2Hs",level:5}),n.preventDefault(),n.stopPropagation(),!0;if(H(window.siyuan.config.keymap.editor.heading.heading6.custom,n))return Ba({protyle:t,nodeElement:i,type:"Blocks2Hs",level:6}),n.preventDefault(),n.stopPropagation(),!0;if(H(window.siyuan.config.keymap.editor.insert.code.custom,n)&&!["NodeCodeBlock","NodeHeading"].includes(i.getAttribute("data-type"))){const p=i.getAttribute("data-node-id"),h=i.outerHTML,m=le(i);m.innerHTML="```"+window.siyuan.storage[u.LOCAL_CODELANG]+`
`+Lute.EscapeHTMLStr(m.textContent)+"<wbr>\n```";const b=t.lute.SpinBlockDOM(i.outerHTML);i.outerHTML=b;const y=t.wysiwyg.element.querySelector(`[data-node-id="${p}"]`);return J(t,p,b,h),ze(y),n.preventDefault(),n.stopPropagation(),!0}if(H(window.siyuan.config.keymap.editor.insert.lastUsed.custom,n)){t.toolbar.range=a;const p=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));o===""&&p.length===0&&p.push(i),ns(t,p),n.stopPropagation(),n.preventDefault();return}if(!i.classList.contains("code-block")&&!n.repeat&&!F(i)){let p=!1;if(t.options.toolbar.find(h=>{if(!h.hotkey)return!1;if(H(h.hotkey,n))return t.toolbar.range=a,["block-ref"].includes(h.name)&&t.toolbar.range.toString()===""||(p=!0,["a","block-ref","inline-math","inline-memo","text"].includes(h.name)?t.toolbar.element.querySelector(`[data-type="${h.name}"]`).dispatchEvent(new CustomEvent("click")):u.INLINE_TYPE.includes(h.name)?t.toolbar.setInlineMark(t,h.name,"range"):h.click&&h.click(t.getInstance())),!0}),p)return n.preventDefault(),n.stopPropagation(),t.wysiwyg.preventKeyup=!0,!0}if(H(window.siyuan.config.keymap.editor.list.outdent.custom,n)){const p=t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(p.length>0){let h=!0;return p.forEach((m,b)=>{m.nextElementSibling&&p[b+1]&&(p[b+1].isSameNode(m.nextElementSibling)||(h=!1))}),h&&(p[0].classList.contains("li")||p[0].parentElement.classList.contains("li"))&&yc(t,Array.from(p),a),n.preventDefault(),n.stopPropagation(),!0}else if(i.parentElement.classList.contains("li")&&i.getAttribute("data-type")!=="NodeCodeBlock")return yc(t,[i.parentElement],a),n.preventDefault(),n.stopPropagation(),!0}if(H(window.siyuan.config.keymap.editor.list.indent.custom,n)){const p=t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(p.length>0){let h=!0;return p.forEach((m,b)=>{m.nextElementSibling&&p[b+1]&&(p[b+1].isSameNode(m.nextElementSibling)||(h=!1))}),h&&(p[0].classList.contains("li")||p[0].parentElement.classList.contains("li"))&&bm(t,Array.from(p),a),n.preventDefault(),n.stopPropagation(),!0}else if(i.parentElement.classList.contains("li")&&i.getAttribute("data-type")!=="NodeCodeBlock")return bm(t,[i.parentElement],a),n.preventDefault(),n.stopPropagation(),!0}const r=H(window.siyuan.config.keymap.editor.insert.list.custom,n),d=H(window.siyuan.config.keymap.editor.insert.check.custom,n),c=H(window.siyuan.config.keymap.editor.insert["ordered-list"].custom,n),f=H(window.siyuan.config.keymap.editor.insert.quote.custom,n);if(r||c||d||f){const p=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(p.length===0&&p.push(i),p.length===1){const h=p[0].dataset.subtype,m=p[0].dataset.type;if(f)["NodeHeading","NodeParagraph","NodeList"].includes(m)?Dn({protyle:t,selectsElement:p,type:"Blocks2Blockquote"}):(t.hint.splitChar="/",t.hint.lastIndex=-1,t.hint.fill(">"+Lute.Caret,t));else if(m==="NodeParagraph")Dn({protyle:t,selectsElement:p,type:d?"Blocks2TLs":r?"Blocks2ULs":"Blocks2OLs"});else if(m==="NodeList"){const b=p[0].dataset.nodeId;h==="o"&&(r||d)?Hl({protyle:t,nodeElement:p[0],id:b,type:d?"UL2TL":"OL2UL"}):h==="t"&&(r||c)?Hl({protyle:t,nodeElement:p[0],id:b,type:r?"TL2UL":"TL2OL"}):h==="u"&&(d||c)&&Hl({protyle:t,nodeElement:p[0],id:b,type:d?"OL2TL":"UL2OL"})}else t.hint.splitChar="/",t.hint.lastIndex=-1,t.hint.fill((d?"* [ ] ":r?"* ":"1. ")+Lute.Caret,t)}else{let h=!1,m=!1;p.find((b,y)=>{if(b.classList.contains("li"))return h=!0,!0;if(b.nextElementSibling&&p[y+1]&&b.nextElementSibling.isSameNode(p[y+1]))m=!0;else if(y!==p.length-1)return m=!1,!0}),!h&&m&&Dn({protyle:t,selectsElement:p,type:f?"Blocks2Blockquote":d?"Blocks2TLs":r?"Blocks2ULs":"Blocks2OLs"})}n.preventDefault(),n.stopPropagation();return}if(H(window.siyuan.config.keymap.editor.insert.table.custom,n)){t.hint.splitChar="/",t.hint.lastIndex=-1,t.hint.fill(`| ${Lute.Caret} |  |  |
| --- | --- | --- |
|  |  |  |
|  |  |  |`,t),n.preventDefault(),n.stopPropagation();return}if(H(window.siyuan.config.keymap.editor.list.checkToggle.custom,n)){const p=B(a.startContainer,"data-subtype","t");if(!p)return;const h=p.outerHTML;p.classList.contains("protyle-task--done")?(p.querySelector("use").setAttribute("xlink:href","#iconUncheck"),p.classList.remove("protyle-task--done")):(p.querySelector("use").setAttribute("xlink:href","#iconCheck"),p.classList.add("protyle-task--done")),p.setAttribute("updated",Y().format("YYYYMMDDHHmmss")),J(t,p.getAttribute("data-node-id"),p.outerHTML,h),n.preventDefault(),n.stopPropagation();return}if(H(window.siyuan.config.keymap.editor.general.insertBefore.custom,n))return _n(t,"beforebegin"),n.preventDefault(),!0;if(H(window.siyuan.config.keymap.editor.general.insertAfter.custom,n))return _n(t,"afterend"),n.preventDefault(),n.stopPropagation(),!0;if(H(window.siyuan.config.keymap.editor.general.jumpToParentNext.custom,n))return Il(t,i,"next"),n.preventDefault(),n.stopPropagation(),!0;if(H(window.siyuan.config.keymap.editor.general.jumpToParent.custom,n))return Il(t,i,"parent"),n.preventDefault(),n.stopPropagation(),!0;if(H(window.siyuan.config.keymap.editor.general.jumpToParentPrev.custom,n))return Il(t,i,"previous"),n.preventDefault(),n.stopPropagation(),!0;if(H(window.siyuan.config.keymap.editor.general.moveToUp.custom,n)){n.preventDefault(),n.stopPropagation(),HL(t,i,a);return}if(H(window.siyuan.config.keymap.editor.general.moveToDown.custom,n)){n.preventDefault(),n.stopPropagation(),RL(t,i,a);return}if(H(window.siyuan.config.keymap.editor.general.vLayout.custom,n)){n.preventDefault(),n.stopPropagation();const p=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(p.length===1&&p[0].getAttribute("data-type")==="NodeSuperBlock"){if(p[0].getAttribute("data-sb-layout")==="col"){const h=p[0].outerHTML;p[0].setAttribute("data-sb-layout","row"),p[0].setAttribute("updated",Y().format("YYYYMMDDHHmmss")),J(t,p[0].getAttribute("data-node-id"),p[0].outerHTML,h)}else{a.insertNode(document.createElement("wbr"));const h=ai(t,p[0]);U(t,h.doOperations,h.undoOperations),he(t.wysiwyg.element,a)}return}if(p.length<2||p[0]?.classList.contains("li"))return;Dn({protyle:t,selectsElement:p,type:"BlocksMergeSuperBlock",level:"row"});return}if(H(window.siyuan.config.keymap.editor.general.hLayout.custom,n)){n.preventDefault(),n.stopPropagation();const p=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(p.length===1&&p[0].getAttribute("data-type")==="NodeSuperBlock"){if(p[0].getAttribute("data-sb-layout")==="row"){const h=p[0].outerHTML;p[0].setAttribute("data-sb-layout","col"),p[0].setAttribute("updated",Y().format("YYYYMMDDHHmmss")),J(t,p[0].getAttribute("data-node-id"),p[0].outerHTML,h)}else{a.insertNode(document.createElement("wbr"));const h=ai(t,p[0]);U(t,h.doOperations,h.undoOperations),he(t.wysiwyg.element,a)}return}if(p.length<2||p[0]?.classList.contains("li"))return;Dn({protyle:t,selectsElement:p,type:"BlocksMergeSuperBlock",level:"col"});return}if(!n.repeat&&H(window.siyuan.config.keymap.editor.general.ai.custom,n)){n.preventDefault(),n.stopPropagation();let p=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));p.length===0&&(p=[i]),_b(p,t);return}if(!n.repeat&&H(window.siyuan.config.keymap.editor.general.aiWriting.custom,n)){n.preventDefault(),n.stopPropagation(),qE(t,i);return}if(!n.repeat&&H(window.siyuan.config.keymap.editor.general.openInNewTab.custom,n)){n.preventDefault(),n.stopPropagation();const p=window.siyuan.blockPanels.find(m=>{if(m.element.contains(i))return!0}),h=i.getAttribute("data-node-id");Ke(h,(m,b)=>{de({app:t.app,id:h,action:b,zoomIn:m,openNewTab:!0}),p.destroy()});return}if(n.key==="Tab"&&qe(n)&&!n.altKey){n.preventDefault();const p=window.siyuan.config.editor.codeTabSpaces===0?"	":"".padStart(window.siyuan.config.editor.codeTabSpaces," ");if(i.getAttribute("data-type")==="NodeCodeBlock"&&o!==""){!Oe(a.endContainer)&&a.endContainer.textContent.endsWith(`
`)&&a.endOffset>0&&a.setEnd(a.endContainer,a.endOffset-1);const h=document.createElement("wbr");a.insertNode(h),a.setStartAfter(h);const m=i.outerHTML;let b="";n.shiftKey?a.extractContents().textContent.split(`
`).forEach(_=>{_.startsWith(p)?b+=_.replace(p,"")+`
`:b+=_+`
`}):a.extractContents().textContent.split(`
`).forEach(_=>{b+=p+_+`
`});let y=i.querySelector(".protyle-action__language").textContent;window.hljs.getLanguage(y)||(y="plaintext"),h.insertAdjacentHTML("afterend",window.hljs.highlight(b.substr(0,b.length-1),{language:y,ignoreIllegals:!0}).value+"<br>"),a.setStart(h.nextSibling,0);const w=h.parentElement.querySelector("br");Pt(w.previousSibling,a,!1),w.remove(),J(t,i.getAttribute("data-node-id"),i.outerHTML,m),h.remove();return}if(!n.shiftKey){const h=document.createElement("wbr");a.insertNode(h);const m=i.outerHTML;return a.extractContents(),a.insertNode(document.createTextNode(p)),a.collapse(!1),Z(a),h.remove(),J(t,i.getAttribute("data-node-id"),i.outerHTML,m),!0}}if(n.key==="ContextMenu"){const p=ta(i,a);t.wysiwyg.element.dispatchEvent(new CustomEvent("contextmenu",{detail:{target:i,y:p.top+8,x:p.left}})),n.preventDefault(),n.stopPropagation();return}const g=B(a.startContainer,"data-type","block-ref");if(g){const p=g.getAttribute("data-id");if(H(window.siyuan.config.keymap.editor.general.openBy.custom,n))return Ke(p,(h,m,b)=>{b||m.push(u.CB_GET_HL),de({app:t.app,id:p,action:m,zoomIn:h})}),n.preventDefault(),n.stopPropagation(),!0;if(H(window.siyuan.config.keymap.editor.general.refTab.custom,n))return Ke(p,h=>{de({app:t.app,id:p,action:h?[u.CB_GET_HL,u.CB_GET_ALL]:[u.CB_GET_HL,u.CB_GET_CONTEXT,u.CB_GET_ROOTSCROLL],keepCursor:!0,zoomIn:h})}),n.preventDefault(),n.stopPropagation(),!0;if(H(window.siyuan.config.keymap.editor.general.insertRight.custom,n))return Ke(p,(h,m,b)=>{b||m.push(u.CB_GET_HL),de({app:t.app,id:p,position:"right",action:m,zoomIn:h})}),n.preventDefault(),n.stopPropagation(),!0;if(H(window.siyuan.config.keymap.editor.general.insertBottom.custom,n))return Ke(p,(h,m,b)=>{b||m.push(u.CB_GET_HL),de({app:t.app,id:p,position:"bottom",action:m,zoomIn:h})}),n.preventDefault(),n.stopPropagation(),!0;if(H(window.siyuan.config.keymap.editor.general.refPopover.custom,n))return window.siyuan.blockPanels.push(new Hc({app:t.app,isBacklink:!1,targetElement:g,refDefs:[{refID:p}]})),n.preventDefault(),n.stopPropagation(),!0}if(H("\u21E7\u2318V",n)){n.returnValue=!1,n.preventDefault(),n.stopPropagation(),Mh(t);return}if(H(window.siyuan.config.keymap.editor.general.showInFolder.custom,n)){const p=B(a.startContainer,"data-type","a");if(p){const h=p.getAttribute("data-href");Qs(h)&&(ea(h,"folder"),n.preventDefault(),n.stopPropagation())}return}if(H(window.siyuan.config.keymap.editor.general.openBy.custom,n)){const p=B(a.startContainer,"data-type","a");if(p){wc(t,p.getAttribute("data-href"),void 0,!1),n.preventDefault(),n.stopPropagation();return}const h=B(a.startContainer,"data-type","file-annotation-ref");if(h){const b=`assets/${h.getAttribute("data-id").split("/")[1]}`;wc(t,b,void 0,!1),n.preventDefault(),n.stopPropagation();return}return}if(qe(n)&&n.key!=="Backspace"&&n.key!=="Escape"&&n.key!=="Delete"&&!n.shiftKey&&!n.altKey&&n.key!=="Enter"&&Q(["select"],t),H("\u2318B",n)||H("\u2318I",n)||H("\u2318U",n)){n.preventDefault(),n.stopPropagation();return}})},zE=(t,e,n)=>{const a=W(),i=L(t.target,"protyle-attr--bookmark");if(i)return!a&&Dt(t)?ti(e.app,i.textContent.trim(),!0):n?Gn(n,"bookmark",e):Ti(i.parentElement.parentElement,"bookmark",e),t.stopPropagation(),!0;const s=L(t.target,"protyle-attr--name");if(s)return!a&&Dt(t)?ti(e.app,s.textContent.trim(),!0):n?Gn(n,"name",e):Ti(s.parentElement.parentElement,"name",e),t.stopPropagation(),!0;const o=L(t.target,"protyle-attr--av");if(o)return n?Gn(n,"av",e):Ti(o.parentElement.parentElement,"av",e),t.stopPropagation(),!0;const l=L(t.target,"protyle-attr--alias");if(l)return!a&&Dt(t)?ti(e.app,l.textContent.trim(),!0):n?Gn(n,"alias",e):Ti(l.parentElement.parentElement,"alias",e),t.stopPropagation(),!0;const r=L(t.target,"protyle-attr--memo");if(r)return!a&&Dt(t)?ti(e.app,r.getAttribute("aria-label").trim(),!0):n?Gn(n,"memo",e):Ti(r.parentElement.parentElement,"memo",e),t.stopPropagation(),!0},VE=()=>{const t=document.getElementById("dragGhost");if(t){if(t.dataset.ghostType==="dock")t.parentElement.querySelectorAll(".dock__item").forEach(e=>{e.style.opacity=""}),document.querySelector("#dockMoveItem")?.remove();else{const e=t.parentElement.querySelector(`[data-node-id="${t.getAttribute("data-node-id")}"]`);e&&(e.style.opacity=""),t.parentElement.querySelectorAll(".dragover__top, .dragover__bottom, .dragover, .dragover__current").forEach(n=>{n.classList.remove("dragover__top","dragover__bottom","dragover","dragover__current"),n.style.opacity=""})}t.remove(),document.onmousemove=null}},GE=t=>{!window.siyuan.menus.menu.element.contains(t)&&!B(t,"data-menu","true")&&(getSelection().rangeCount>0&&window.siyuan.menus.menu.element.contains(getSelection().getRangeAt(0).startContainer)&&window.siyuan.menus.menu.element.contains(document.activeElement)||window.siyuan.menus.menu.remove())},vT=t=>{VE(),GE(t.target),L(t.target,"pdf__outer")||Ji(["pdfutil"]),!ve()&&window.siyuan.layout.leftDock&&!L(t.target,"b3-dialog--open",!0)&&!L(t.target,"b3-menu")&&!L(t.target,"block__popover")&&!L(t.target,"dock")&&!L(t.target,"layout--float",!0)&&(window.siyuan.layout.bottomDock.hideDock(),window.siyuan.layout.leftDock.hideDock(),window.siyuan.layout.rightDock.hideDock());const e=L(t.target,"protyle",!0);if(e){const i=e.querySelector(".protyle-wysiwyg");(i.getAttribute("data-readonly")==="true"||!i.contains(t.target))&&i.dispatchEvent(new Event("focusin"))}const n=Le(t.target,"protyle-action__copy");if(n){let i=n.parentElement.nextElementSibling.textContent.replace(/\n$/,"");i=i.replace(/\u00A0/g," "),De(i),j(window.siyuan.languages.copied,2e3),t.preventDefault();return}if(B(t.target,"id","secondaryToolbarToggleButton")||B(t.target,"id","viewFindButton")||B(t.target,"id","findbar"))return;let a;Ce().asset.find(i=>{if(i.pdfObject&&!i.pdfObject.appConfig.appContainer.classList.contains("fn__none"))return a=i.pdfObject,!0}),a&&(a.secondaryToolbar.isOpen&&a.secondaryToolbar.close(),!a.supportsIntegratedFind&&a.findBar.opened&&a.findBar.close())};class ET{constructor(e){this.lastHTMLs={},this.element=document.createElement("div"),this.element.className="protyle-wysiwyg",this.element.setAttribute("spellcheck","false"),W()?this.element.setAttribute("contenteditable","false"):this.element.setAttribute("contenteditable","true"),window.siyuan.config.editor.displayBookmarkIcon&&this.element.classList.add("protyle-wysiwyg--attr"),this.bindCommonEvent(e),!e.options.action.includes(u.CB_GET_HISTORY)&&(this.bindEvent(e),_T(e,this.element),yT(e,this.element))}renderCustom(e){let n=e[u.CUSTOM_SY_FULLWIDTH];n||(n=window.siyuan.config.editor.fullWidth?"true":"false"),n==="true"?this.element.parentElement.setAttribute("data-fullwidth","true"):this.element.parentElement.removeAttribute("data-fullwidth");const a=Object.keys(e);for(let i=0;i<this.element.attributes.length;i++){const s=this.element.attributes[i].nodeName;!["type","class","spellcheck","contenteditable","data-doc-type","style","data-realwidth","data-readonly"].includes(s)&&!a.includes(s)&&(this.element.removeAttribute(s),i--)}a.forEach(i=>{["title-img","title","updated","icon","id","type","class","spellcheck","contenteditable","data-doc-type","style","data-realwidth","data-readonly"].includes(i)||this.element.setAttribute(i,e[i])})}escapeInline(e,n,a){if(!a.data&&a.inputType!=="insertLineBreak")return;const i=a.data;e.toolbar.range=n;const s=n.startContainer.parentElement,o=e.toolbar.getCurrentType();if(a.inputType==="insertLineBreak"){o.length>0&&n.toString()===""&&s.tagName==="SPAN"&&s.textContent.startsWith(`
`)&&n.startContainer.previousSibling&&n.startContainer.previousSibling.textContent===`
`&&s.before(n.startContainer.previousSibling);return}let l=i.length;if(i==="<"||i===">"?l=4:i==="&"&&(l=5),o.length>0&&n.toString()===""&&n.startOffset===i.length&&s.tagName==="SPAN"&&s.textContent.replace(u.ZWSP,"")!==i&&s.textContent.replace(u.ZWSP,"").length>=i.length&&!At(n.startContainer)&&!At(s)){const r=s.innerHTML.replace(u.ZWSP,"");s.innerHTML=r.substr(l);const d=document.createTextNode(i);s.before(d),n.selectNodeContents(d),n.collapse(!1);return}if(s.tagName==="SPAN"&&s.textContent!==i&&!o.includes("search-mark")&&!o.includes("code")&&!o.includes("kbd")&&!o.includes("tag")&&n.toString()===""&&n.startContainer.nodeType===3&&(o.includes("inline-memo")||o.includes("text")||o.includes("block-ref")||o.includes("file-annotation-ref")||o.includes("a"))&&!Oe(n.startContainer)&&n.startContainer.textContent.length===n.startOffset&&s.textContent.length>i.length){const r=ct(s,e.wysiwyg.element,n),d=s.innerHTML;if(r.start===s.textContent.length){s.innerHTML=d.substr(0,d.length-l);const c=document.createTextNode(i);s.after(c),n.selectNodeContents(c),n.collapse(!1)}}}setEmptyOutline(e,n){e.wysiwyg.element.querySelectorAll(".img--select, .av__cell--select, .av__cell--active, .av__row--select").forEach(i=>{i.classList.contains("av__row--select")&&!L(n,"av")?(i.classList.remove("av__row--select"),i.querySelector(".av__firstcol use").setAttribute("xlink:href","#iconUncheck"),as(i)):(i.classList.remove("img--select","av__cell--select","av__cell--active"),i.querySelector(".av__drag-fill")?.remove())});let a=n;if(!n.getAttribute("data-node-id")){const i=P(n);if(!i)return;a=i}e.model&&Ce().outline.forEach(i=>{i.blockId===e.block.rootID&&i.setCurrent(a)})}emojiToMd(e){e.querySelectorAll(".emoji").forEach(n=>{n.outerHTML=`:${n.getAttribute("alt")}:`})}bindCommonEvent(e){this.element.addEventListener("copy",n=>{if(window.siyuan.ctrlIsPressed=!1,n.target.tagName==="PROTYLE-HTML"||n.target.localName==="input"){n.stopPropagation();return}n.stopPropagation(),n.preventDefault();const a=me(e.wysiwyg.element),i=P(a.startContainer);if(!i)return;const s=i.querySelector(".img--select"),o=i.querySelector(".av__row--select, .av__cell--select"),l=i.querySelector(".table__select")?.clientWidth>0;let r=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));r.length===0&&a.toString()===""&&!a.cloneContents().querySelector("img")&&!s&&!o&&!l&&(i.classList.add("protyle-wysiwyg--select"),bn([i.getAttribute("data-node-id")]),r=[i]);let d="",c="";if(r.length>0){const f=r[0].getAttribute("data-reftext")==="true";r[0].getAttribute("data-type")==="NodeListItem"&&r[0].parentElement.classList.contains("list")&&r[0].parentElement.childElementCount-1===r.length?f?d=$h(r[0].parentElement):d=r[0].parentElement.outerHTML:r.forEach((g,p)=>{f&&p===0?d+=$h(g)+`

`:d+=ff(g)}),f&&r[0].removeAttribute("data-reftext")}else if(o){const f=Array.from(i.querySelectorAll(".av__cell--active, .av__cell--select"))||[];f.length===0&&i.querySelectorAll(".av__row--select:not(.av__row--header)").forEach(g=>{g.querySelectorAll(".av__cell").forEach(p=>{f.push(p)})}),f.length>0&&(d="[",f.forEach((g,p)=>{const h=go(g);(p===0||!f[p-1].isSameNode(g.previousElementSibling))&&(d+="["),d+=JSON.stringify(ga(vn(g),g))+",",(p===f.length-1||!f[p+1].isSameNode(g.nextElementSibling))&&(d=d.substring(0,d.length-1)+"],"),c+=h+(f[p+1]&&g.nextElementSibling&&g.nextElementSibling.isSameNode(f[p+1])?"	":`

`)}),c=c.substring(0,c.length-2),d=d.substring(0,d.length-1)+"]")}else if(l){const f=[],g=i.firstElementChild.scrollLeft,p=i.querySelector(".table__select");d="<table>",i.querySelectorAll("th, td").forEach(h=>{!h.classList.contains("fn__none")&&h.offsetLeft+6>p.offsetLeft+g&&h.offsetLeft+h.clientWidth-6<p.offsetLeft+g+p.clientWidth&&h.offsetTop+6>p.offsetTop&&h.offsetTop+h.clientHeight-6<p.offsetTop+p.clientHeight&&f.push(h)}),f.forEach((h,m)=>{(m===0||!h.previousElementSibling||!h.previousElementSibling.isSameNode(f[m-1]))&&(d+="<tr>"),d+=h.outerHTML,(!h.nextElementSibling||!f[m+1]||!h.nextElementSibling.isSameNode(f[m+1]))&&(d+="</tr>")}),d+="</table>",c=e.lute.HTML2Md(d)}else{const f=document.createElement("div"),g=e.toolbar.getCurrentType(a),p=q(a.startContainer,"SPAN"),h=B(a.startContainer,"data-type","NodeHeading");if(g.length>0&&p&&p.textContent.replace(u.ZWSP,"")===a.toString()||h&&h.textContent.replace(u.ZWSP,"")===a.toString())h?f.append(h.cloneNode(!0)):["DIV","TD","TH","TR"].includes(a.startContainer.parentElement.tagName)?(f.append(a.cloneContents()),this.emojiToMd(f)):(f.append(a.startContainer.parentElement.cloneNode(!0)),this.emojiToMd(f)),d=f.innerHTML,c=a.toString();else if(s)d=s.outerHTML,c=s.querySelector("img").getAttribute("data-src");else if(g.length>0&&a.startContainer.nodeType===3&&a.startContainer.parentElement.tagName==="SPAN"&&a.startContainer.parentElement.isSameNode(a.endContainer.parentElement)){const m=a.startContainer.parentElement.attributes,b=document.createElement("span");for(let y=0;y<m.length;y++)b.setAttribute(m[y].name,m[y].value);b.getAttribute("data-type").indexOf("block-ref")>-1&&b.getAttribute("data-subtype")==="d"&&b.setAttribute("data-subtype","s"),b.textContent=a.toString(),d=b.outerHTML,c=a.toString()}else{f.append(a.cloneContents()),this.emojiToMd(f);const m=B(a.commonAncestorContainer,"data-type","inline-math");m?d=m.outerHTML:d=f.innerHTML,c=f.textContent,B(a.startContainer,"data-type","NodeCodeBlock")?Ia(a)&&(c=c.replace(/\n$/,"")):q(a.startContainer,"CODE")||(c=a.toString())}}e.disabled&&(d=lL(d)),c=c||e.lute.BlockDOM2StdMd(d).trimEnd(),c=c.replace(/\u00A0/g," ").replace(new RegExp(u.ZWSP,"g"),""),n.clipboardData.setData("text/plain",c),n.clipboardData.setData("text/html",l?d:e.lute.BlockDOM2HTML(o?c:d)),n.clipboardData.setData("text/siyuan",l?e.lute.HTML2BlockDOM(d):d)}),this.element.addEventListener("mousedown",n=>{if(e.wysiwyg.element.classList.remove("protyle-wysiwyg--hiderange"),n.button===2||window.siyuan.ctrlIsPressed)return;window.siyuan.shiftIsPressed&&getSelection().rangeCount>0&&(this.shiftStartElement=P(getSelection().getRangeAt(0).startContainer)),window.siyuan.shiftIsPressed||Q(["select"],e);let a=n.target;if(L(a,"protyle-action")||L(a,"av__cell--header")&&!L(a,"av__widthdrag"))return;const i=document,s=e.element.getBoundingClientRect(),o=s.left+(parseInt(e.wysiwyg.element.style.paddingLeft)||24)+1,l=o+(e.wysiwyg.element.clientWidth-(parseInt(e.wysiwyg.element.style.paddingLeft)||24)-(parseInt(e.wysiwyg.element.style.paddingRight)||16))-2,r=s.bottom,d=n.clientY,c=e.contentElement.getBoundingClientRect();if(!e.disabled&&a.classList.contains("av__widthdrag")){const k=P(a);if(!k)return;const A=k.getAttribute("data-av-id"),$=k.dataset.nodeId,M=a.parentElement,C=M.clientWidth,N=M.getAttribute("data-col-id");let O;const te=k.querySelector(".av__scroll");i.onmousemove=ne=>{O=Math.max(C+(ne.clientX-n.clientX),25),te.querySelectorAll(".av__row, .av__row--footer").forEach(oe=>{oe.querySelector(`[data-col-id="${N}"]`).style.width=O+"px"}),is(k,c,"bottom")},i.onmouseup=()=>{if(i.onmousemove=null,i.onmouseup=null,i.ondragstart=null,i.onselectstart=null,i.onselect=null,!O||O===C)return;const ne=k.getAttribute("custom-sy-av-view");U(e,[{action:"setAttrViewColWidth",id:N,avID:A,data:O+"px",blockID:$,keyID:ne}],[{action:"setAttrViewColWidth",id:N,avID:A,data:C+"px",blockID:$,keyID:ne}])},this.preventClick=!0,n.preventDefault();return}const f=L(a,"av__drag-fill");if(!e.disabled&&f){const k=P(f);if(!k)return;const A={};let $;const M=[];k.querySelectorAll(".av__cell--active").forEach(ne=>{const oe=L(ne,"av__row");oe&&(A[oe.dataset.id]||(A[oe.dataset.id]=[]),A[oe.dataset.id].push(ga(vn(ne),ne)),$=ne,M.push(ne.dataset.id))});const C=Sc($),N=Sc(k.querySelector(".av__cell--active"));let O,te;return i.onmousemove=ne=>{const oe=L(ne.target,"av__cell");if(!(O&&oe&&oe.isSameNode(O))&&(O=oe,O&&O.dataset.id)){const ce=Sc(O);if(k.querySelectorAll(".av__cell--active").forEach(Ge=>{M.includes(Ge.dataset.id)||Ge.classList.remove("av__cell--active")}),ce.celIndex!==C.celIndex){te=void 0;return}k.querySelectorAll(".av__row").forEach((Ge,$e)=>{(ce.rowIndex<N.rowIndex&&$e>=ce.rowIndex&&$e<N.rowIndex||ce.rowIndex>C.rowIndex&&$e<=ce.rowIndex&&$e>C.rowIndex)&&Ge.querySelectorAll(".av__cell").forEach((Ie,Fe)=>{Fe>=N.celIndex&&Fe<=ce.celIndex&&(Ie.classList.add("av__cell--active"),te=Ie)})})}},i.onmouseup=()=>{if(i.onmousemove=null,i.onmouseup=null,i.ondragstart=null,i.onselectstart=null,i.onselect=null,te){Ix(e,k,A,M);const ne=k.querySelectorAll(".av__cell--active");In(ne[ne.length-1])}return!1},this.preventClick=!0,!1}const g=L(a,"av__cell");if(!e.disabled&&g&&g.dataset.id&&!F(g)){const k=P(g);if(!k)return;k.querySelectorAll(".av__cell--select").forEach(O=>{O.classList.remove("av__cell--select")}),k.querySelectorAll(".av__drag-fill").forEach(O=>{O.remove()}),g.classList.add("av__cell--select");const A=Sc(g);let $,M;const C=k.getBoundingClientRect(),N=k.querySelector(".av__scroll");return i.onmousemove=O=>{const te=L(O.target,"av__cell");if(N.scrollWidth>N.clientWidth+2&&(O.clientX>C.right-10?N.scrollLeft+=10:O.clientX<C.left+34&&(N.scrollLeft-=10),O.clientY<c.top+48?e.contentElement.scrollTop-=5:O.clientY>c.bottom-48&&(e.contentElement.scrollTop+=5)),!($&&te&&te.isSameNode($))&&te&&te.dataset.id&&(n.clientX!==O.clientX||n.clientY!==O.clientY)){const ne=Sc(te);k.querySelectorAll(".av__cell--active").forEach(oe=>{oe.classList.remove("av__cell--active")}),k.querySelectorAll(".av__row").forEach((oe,ce)=>{ce>=Math.min(A.rowIndex,ne.rowIndex)&&ce<=Math.max(A.rowIndex,ne.rowIndex)&&oe.querySelectorAll(".av__cell").forEach((Ge,$e)=>{$e>=Math.min(A.celIndex,ne.celIndex)&&$e<=Math.max(A.celIndex,ne.celIndex)&&(Ge.classList.add("av__cell--active"),M=Ge)})}),$=te}},i.onmouseup=()=>(i.onmousemove=null,i.onmouseup=null,i.ondragstart=null,i.onselectstart=null,i.onselect=null,M&&(Ha(k.querySelector(".av__firstcol"),"unselectAll"),ae(k),In(M),this.preventClick=!0),!1),!1}if(!e.disabled&&a.classList.contains("protyle-action__drag")){const k=P(a);if(!k)return;let A=!0;["NodeIFrame","NodeWidget","NodeVideo"].includes(k.getAttribute("data-type"))?(k.classList.add("iframe--drag"),(k.style.textAlign==="left"||k.style.textAlign==="right")&&(A=!1)):a.parentElement.parentElement.getAttribute("data-type")==="img"&&a.parentElement.parentElement.classList.add("img--drag");const $=k.getAttribute("data-node-id"),M=k.outerHTML,C=n.clientX,N=a.previousElementSibling,O=N.clientWidth,te=N.clientHeight,ne=N.parentElement.parentElement;N.tagName==="IMG"&&co(ne),i.onmousemove=oe=>{if(N.tagName==="IMG"&&(N.style.height=""),oe.clientX>C-O+8&&oe.clientX<l){const ce=N.tagName==="IMG"&&!ne.style.minWidth&&k.style.textAlign!=="center"||!A?1:2;N.tagName==="IMG"?N.parentElement.style.width=Math.max(17,O+(oe.clientX-C)*ce)+"px":N.style.width=Math.max(17,O+(oe.clientX-C)*ce)+"px"}N.tagName!=="IMG"&&oe.clientY>d-te+8&&oe.clientY<r&&(N.style.height=te+(oe.clientY-d)+"px")},i.onmouseup=()=>{i.onmousemove=null,i.onmouseup=null,i.ondragstart=null,i.onselectstart=null,i.onselect=null,a.classList.contains("protyle-action__drag")&&k&&J(e,$,k.outerHTML,M),k.classList.remove("iframe--drag"),a.parentElement.parentElement.classList.remove("img--drag")};return}let p;const h=q(a,"TH")||q(a,"TD");if(h&&(a=h),(a.tagName==="TH"||a.tagName==="TD"||a.firstElementChild?.tagName==="TABLE"||a.classList.contains("table__resize")||a.classList.contains("table__select"))&&(p=P(a),p&&(p.querySelector(".table__select").removeAttribute("style"),window.siyuan.menus.menu.remove(),Q(["toolbar"],e),n.stopPropagation())),!e.disabled&&a.classList.contains("table__resize")){const k=P(a);if(!k)return;const A=k.outerHTML;getSelection().rangeCount>0&&getSelection().getRangeAt(0).collapse(!1),k.firstElementChild.style.webkitUserModify="read-only",k.style.cursor="col-resize",a.removeAttribute("style");const $=k.getAttribute("data-node-id"),M=n.clientX,C=parseInt(a.getAttribute("data-col-index")),N=k.querySelectorAll("table col")[C];N.style.minWidth&&(N.style.width=k.querySelectorAll("table td, table th")[C].offsetWidth+"px",N.style.minWidth=""),k.querySelectorAll("tr").forEach(ne=>{ne.cells[C].style.width=""});const O=N.clientWidth,te=k.firstElementChild.clientWidth<k.firstElementChild.scrollWidth;i.onmousemove=ne=>{k.style.textAlign==="center"&&!te?N.style.width=O+(ne.clientX-M)*2+"px":N.style.width=O+(ne.clientX-M)+"px"},i.onmouseup=()=>{k.firstElementChild.style.webkitUserModify="",k.style.cursor="",i.onmousemove=null,i.onmouseup=null,i.ondragstart=null,i.onselectstart=null,i.onselect=null,k&&J(e,$,k.outerHTML,A)};return}let m=n.clientX;n.clientX>l?m=l:n.clientX<o&&(m=o);const b=s.top+(e.options.render.breadcrumb?e.breadcrumb.element.parentElement.clientHeight:0);let y,w,_,x;this.element.querySelectorAll("iframe").forEach(k=>{k.style.pointerEvents="none"});const S=["IMG","VIDEO","AUDIO"].includes(a.tagName)||a.classList.contains("img");i.onmousemove=k=>{let A=k.target;if(p&&p.contains(A)&&!L(p,"protyle-wysiwyg__embed")){if(A.classList.contains("table__select")){A.classList.add("fn__none");const Ie=document.elementFromPoint(k.clientX,k.clientY);A.classList.remove("fn__none"),A=q(Ie,"TH")||q(Ie,"TD")}if(A&&A.isSameNode(a))return p.querySelector(".table__select").removeAttribute("style"),e.wysiwyg.element.classList.remove("protyle-wysiwyg--hiderange"),w=A,!1;if(A&&(A.tagName==="TH"||A.tagName==="TD")&&(!w||!w.isSameNode(A))){p.firstElementChild.style.webkitUserModify="read-only";let Ie=a.offsetLeft+a.clientWidth-A.offsetLeft,Fe=A.offsetLeft;a.offsetLeft===A.offsetLeft?Ie=Math.max(a.clientWidth,A.clientWidth):a.offsetLeft<A.offsetLeft&&(Ie=A.offsetLeft+A.clientWidth-a.offsetLeft,Fe=a.offsetLeft);let mt=a.offsetTop+a.clientHeight-A.offsetTop,ie=A.offsetTop;a.offsetTop===A.offsetTop?mt=Math.max(a.clientHeight,A.clientHeight):a.offsetTop<A.offsetTop&&(mt=A.offsetTop+A.clientHeight-a.offsetTop,ie=a.offsetTop),Array.from(p.querySelectorAll("th, td")).find(_e=>{const ye=_e.offsetLeft<Fe+Ie&&_e.offsetLeft+_e.clientWidth>Fe+Ie,qt=_e.offsetLeft<Fe&&_e.offsetLeft+_e.clientWidth>Fe;_e.offsetTop<ie&&_e.offsetTop+_e.clientHeight>ie?((_e.offsetLeft+6>Fe&&_e.offsetLeft+_e.clientWidth-6<Fe+Ie||ye||qt)&&(mt=ie+mt-_e.offsetTop,ie=_e.offsetTop),ye&&(Ie=_e.offsetLeft+_e.clientWidth-Fe),qt&&(Ie=Fe+Ie-_e.offsetLeft,Fe=_e.offsetLeft)):_e.offsetTop<ie+mt&&_e.offsetTop+_e.clientHeight>ie+mt?((_e.offsetLeft+6>Fe&&_e.offsetLeft+_e.clientWidth-6<Fe+Ie||ye||qt)&&(mt=_e.clientHeight+_e.offsetTop-ie),ye&&(Ie=_e.offsetLeft+_e.clientWidth-Fe),qt&&(Ie=Fe+Ie-_e.offsetLeft,Fe=_e.offsetLeft)):qt&&_e.offsetTop+6>ie&&_e.offsetTop+_e.clientHeight-6<ie+mt?(Ie=Fe+Ie-_e.offsetLeft,Fe=_e.offsetLeft):ye&&_e.offsetTop+6>ie&&_e.offsetTop+_e.clientHeight-6<ie+mt&&(Ie=_e.offsetLeft+_e.clientWidth-Fe)}),e.wysiwyg.element.classList.add("protyle-wysiwyg--hiderange"),p.querySelector(".table__select").setAttribute("style",`left:${Fe-p.firstElementChild.scrollLeft}px;top:${ie}px;height:${mt}px;width:${Ie+1}px;`),w=A}return}S&&(k.clientY<c.top+u.SIZE_SCROLL_TB||k.clientY>c.bottom-u.SIZE_SCROLL_TB)&&e.contentElement.scroll({top:e.contentElement.scrollTop+(k.clientY<c.top+u.SIZE_SCROLL_TB?-u.SIZE_SCROLL_STEP:u.SIZE_SCROLL_STEP),behavior:"smooth"}),e.selectElement.classList.remove("fn__none"),Q(["gutter"],e);let $=0,M=0,C=0,N=0;if(k.clientX<m?(k.clientX<o?M=o:M=k.clientX,C=m-M):k.clientX>l?(M=m,C=l-M):(M=m,C=k.clientX-m),k.clientY>d?k.clientY>r?($=d,N=r-d):($=d,N=k.clientY-d):(k.clientY<b?$=b:$=k.clientY,N=d-$),N<4)return;e.selectElement.setAttribute("style",`background-color: ${e.selectElement.style.backgroundColor};top:${$}px;height:${N}px;left:${M+2}px;width:${C-2}px;`);const O=document.elementFromPoint(k.clientX,k.clientY);if(y&&y.isSameNode(O)&&!y.classList.contains("protyle-wysiwyg")&&!y.classList.contains("list")&&!y.classList.contains("bq")&&!y.classList.contains("sb"))return;y=O,Q(["select"],e);let te;if(k.clientY>d?(te=_||document.elementFromPoint(M,$),x=void 0):(te=document.elementFromPoint(M,$),_=void 0),!te||((te.classList.contains("protyle-wysiwyg")||te.classList.contains("list")||te.classList.contains("li")||te.classList.contains("sb")||te.classList.contains("bq"))&&(te=document.elementFromPoint(M,$+16)),!te))return;let ne=P(te);!ne&&te.classList.contains("protyle-breadcrumb__bar")&&(ne=te.nextElementSibling),k.clientY>d?_||(ne||(ne=e.wysiwyg.element.firstElementChild,ne.classList.contains("protyle-breadcrumb__bar")&&(ne=ne.nextElementSibling)),_=ne):!ne&&k.clientY<e.wysiwyg.element.lastElementChild.getBoundingClientRect().bottom&&(ne=e.wysiwyg.element.firstElementChild,ne.classList.contains("protyle-breadcrumb__bar")&&(ne=ne.nextElementSibling));let oe=[],ce=ne;if(ce){const Ie=F(ce);Ie&&(ce=Ie)}let Ge=!1;const $e=x?x.getBoundingClientRect().bottom:$+N;for(;ce;)if(ce&&!ce.classList.contains("protyle-attr")){const Ie=ce.getBoundingClientRect();if(Ie.height>0&&Ie.top<$e&&Ie.left<M+C)if(Ge)if(ce.nextElementSibling&&!ce.nextElementSibling.classList.contains("protyle-attr")){const Fe=ce.nextElementSibling.getBoundingClientRect();if(Fe.top<$e&&Fe.left<M+C)oe=[ce],ce=ce.nextElementSibling,Ge=!1;else if(ce.parentElement.classList.contains("sb"))ce=P(ce.parentElement),Ge=!0;else break}else ce=P(ce.parentElement),Ge=!0;else ce.classList.contains("protyle-breadcrumb__bar")||oe.push(ce),ce=ce.nextElementSibling;else if(ce.parentElement.classList.contains("sb"))ce=P(ce.parentElement),Ge=!0;else if(Ie.height===0&&Ie.width===0&&ce.parentElement.getAttribute("fold")==="1")ce=ce.parentElement,oe=[];else break}else ce=P(ce.parentElement),Ge=!0;k.clientY<=d&&!x&&(x=oe[oe.length-1]),oe.length===1&&!oe[0].classList.contains("list")&&!oe[0].classList.contains("bq")&&!oe[0].classList.contains("sb")?e.selectElement.style.backgroundColor="transparent":(oe.forEach(Ie=>{L(Ie,"protyle-wysiwyg__embed")||Ie.classList.add("protyle-wysiwyg--select")}),e.selectElement.style.backgroundColor="")},i.onmouseup=k=>{if(i.onmousemove=null,i.onmouseup=null,i.ondragstart=null,i.onselectstart=null,i.onselect=null,_=void 0,x=void 0,this.element.querySelectorAll("iframe").forEach(M=>{M.style.pointerEvents=""}),e.selectElement.classList.add("fn__none"),e.selectElement.removeAttribute("style"),p){p.firstElementChild.style.webkitUserModify="";const M=p.querySelector(".table__select");M.getAttribute("style")&&(getSelection().rangeCount>0&&getSelection().getRangeAt(0).collapse(!1),window.siyuan.menus.menu.remove(),e.disabled||(window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.mergeCell,click:()=>{if(p){const C=[],N=[],O=p.querySelectorAll("th").length;let te=0;const ne=p.firstElementChild.scrollLeft;let oe=!1,ce=!1;p.querySelectorAll("th, td").forEach((ye,qt)=>{ye.classList.contains("fn__none")?(ye.previousElementSibling&&ye.previousElementSibling.isSameNode(C[C.length-1])||qt<te&&N.includes((qt+1)%O))&&(C.push(ye),!oe&&ye.parentElement.parentElement.tagName==="THEAD"?oe=!0:!ce&&ye.parentElement.parentElement.tagName==="TBODY"&&(ce=!0)):ye.offsetLeft+6>M.offsetLeft+ne&&ye.offsetLeft+ye.clientWidth-6<M.offsetLeft+ne+M.clientWidth&&ye.offsetTop+6>M.offsetTop&&ye.offsetTop+ye.clientHeight-6<M.offsetTop+M.clientHeight&&(C.push(ye),!oe&&ye.parentElement.parentElement.tagName==="THEAD"?oe=!0:!ce&&ye.parentElement.parentElement.tagName==="TBODY"&&(ce=!0),N.push((qt+1)%O),te=Math.max((ye.rowSpan-1)*O+qt+1,te))}),M.removeAttribute("style");const Ge=p.outerHTML;let $e=C[0],Ie=$e.colSpan,Fe=1;for(;$e.nextElementSibling&&$e.nextElementSibling.isSameNode(C[Fe]);)$e=$e.nextElementSibling,$e.classList.contains("fn__none")||(Ie+=$e.colSpan),Fe++;let mt="",ie=C[0].parentElement,_e=C[0].rowSpan;if(C.forEach((ye,qt)=>{let Ca=ye.innerHTML.trim();Ca.endsWith("<br>")&&(Ca=Ca.substr(0,Ca.length-4)),mt+=Ca+(!Ca||qt===C.length-1?"":"<br>"),qt!==0&&(ie.isSameNode(ye.parentElement)||(ye.classList.contains("fn__none")||(_e+=ye.rowSpan),ie=ye.parentElement,C[0].parentElement.parentElement.tagName==="THEAD"&&ye.parentElement.parentElement.tagName!=="THEAD"&&C[0].parentElement.parentElement.insertAdjacentElement("beforeend",ye.parentElement)),ye.classList.add("fn__none"),ye.innerHTML="")}),oe&&ce)for(ie=ie.parentElement.nextElementSibling.firstElementChild;ie&&ie.parentElement.tagName!=="THEAD";){let ye=0,qt=0;if(Array.from(ie.children).forEach(Ca=>{ye+=Ca.colSpan-1,Ca.classList.contains("fn__none")&&qt++}),ye!==qt)C[0].parentElement.parentElement.insertAdjacentElement("beforeend",ie),ie=ie.parentElement.nextElementSibling.firstElementChild;else break}setTimeout(()=>{p&&(C[0].innerHTML=mt+"<wbr>",C[0].colSpan=Ie,C[0].rowSpan=_e,he(C[0],document.createRange()),J(e,p.getAttribute("data-node-id"),p.outerHTML,Ge))})}}}).element),window.siyuan.menus.menu.append(new T({type:"separator"}).element),window.siyuan.menus.menu.append(new T({icon:"iconAlignLeft",accelerator:window.siyuan.config.keymap.editor.general.alignLeft.custom,label:window.siyuan.languages.alignLeft,click:()=>{if(p){const C=[],N=p.firstElementChild.scrollLeft;p.querySelectorAll("th, td").forEach(O=>{!O.classList.contains("fn__none")&&O.offsetLeft+6>M.offsetLeft+N&&O.offsetLeft+O.clientWidth-6<M.offsetLeft+N+M.clientWidth&&O.offsetTop+6>M.offsetTop&&O.offsetTop+O.clientHeight-6<M.offsetTop+M.clientHeight&&(C.length===0||C.length>0&&O.offsetTop===C[0].offsetTop)&&C.push(O)}),M.removeAttribute("style"),Pa(e,C,p,"left",me(p))}}}).element),window.siyuan.menus.menu.append(new T({icon:"iconAlignCenter",accelerator:window.siyuan.config.keymap.editor.general.alignCenter.custom,label:window.siyuan.languages.alignCenter,click:()=>{if(p){const C=[],N=p.firstElementChild.scrollLeft;p.querySelectorAll("th, td").forEach(O=>{!O.classList.contains("fn__none")&&O.offsetLeft+6>M.offsetLeft+N&&O.offsetLeft+O.clientWidth-6<M.offsetLeft+N+M.clientWidth&&O.offsetTop+6>M.offsetTop&&O.offsetTop+O.clientHeight-6<M.offsetTop+M.clientHeight&&(C.length===0||C.length>0&&O.offsetTop===C[0].offsetTop)&&C.push(O)}),M.removeAttribute("style"),Pa(e,C,p,"center",me(p))}}}).element),window.siyuan.menus.menu.append(new T({icon:"iconAlignRight",accelerator:window.siyuan.config.keymap.editor.general.alignRight.custom,label:window.siyuan.languages.alignRight,click:()=>{if(p){const C=[],N=p.firstElementChild.scrollLeft;p.querySelectorAll("th, td").forEach(O=>{!O.classList.contains("fn__none")&&O.offsetLeft+6>M.offsetLeft+N&&O.offsetLeft+O.clientWidth-6<M.offsetLeft+N+M.clientWidth&&O.offsetTop+6>M.offsetTop&&O.offsetTop+O.clientHeight-6<M.offsetTop+M.clientHeight&&(C.length===0||C.length>0&&O.offsetTop===C[0].offsetTop)&&C.push(O)}),M.removeAttribute("style"),Pa(e,C,p,"right",me(p))}}}).element),window.siyuan.menus.menu.append(new T({icon:"",label:window.siyuan.languages.useDefaultAlign,click:()=>{if(p){const C=[],N=p.firstElementChild.scrollLeft;p.querySelectorAll("th, td").forEach(O=>{!O.classList.contains("fn__none")&&O.offsetLeft+6>M.offsetLeft+N&&O.offsetLeft+O.clientWidth-6<M.offsetLeft+N+M.clientWidth&&O.offsetTop+6>M.offsetTop&&O.offsetTop+O.clientHeight-6<M.offsetTop+M.clientHeight&&(C.length===0||C.length>0&&O.offsetTop===C[0].offsetTop)&&C.push(O)}),M.removeAttribute("style"),Pa(e,C,p,"",me(p))}}}).element),window.siyuan.menus.menu.append(new T({type:"separator"}).element)),window.siyuan.menus.menu.append(new T({icon:"iconCopy",accelerator:"\u2318C",label:window.siyuan.languages.copy,click(){p&&(Z(me(p)),document.execCommand("copy"))}}).element),e.disabled||(window.siyuan.menus.menu.append(new T({icon:"iconCut",accelerator:"\u2318X",label:window.siyuan.languages.cut,click(){p&&(Z(me(p)),document.execCommand("cut"))}}).element),window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.clear,icon:"iconTrashcan",accelerator:"\u2326",click(){Cw(e,p)}}).element),window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.paste,icon:"iconPaste",accelerator:"\u2318V",async click(){if(document.queryCommandSupported("paste"))document.execCommand("paste");else if(p)try{const C=await ef();wl(e,Object.assign(C,{target:p}))}catch(C){console.log(C)}}}).element)),window.siyuan.menus.menu.popup({x:k.clientX-8,y:k.clientY-16}))}const A=[],$=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if($.forEach(M=>{A.push(M.getAttribute("data-node-id"))}),bn(A),getSelection().rangeCount>0){const M=getSelection().getRangeAt(0);if((M.toString()===""||window.siyuan.shiftIsPressed)&&n.detail>2){let O=P(M.startContainer);if(O){if(O.nextElementSibling?.classList.contains("table"))Pt(le(O),M,!1);else if(O.classList.contains("table")){const te=O.querySelectorAll("th, td");O=te[te.length-1],O.contains(M.startContainer)&&Pt(O,M,!1)}}return}if($.length>0){M.collapse(!0);return}const C=P(M.startContainer);let N;k.detail>2&&M.endContainer.nodeType!==3&&M.endContainer.tagName==="DIV"&&M.endOffset===0?M.endContainer.classList.contains("protyle-attr")&&C&&Pt(le(C),M,!1):N=P(M.endContainer),C&&N&&!N.isSameNode(C)&&(M.startContainer.nodeType===1&&M.startContainer.tagName==="DIV"&&M.startContainer.classList.contains("protyle-attr")||n.clientY>k.clientY?xo(le(N),M):M.endOffset===0&&M.endContainer.nodeType===1&&M.endContainer.tagName==="DIV"?Pt(le(C),M,!1):M.collapse(!0))}}})}bindEvent(e){e.observer=new ResizeObserver(()=>{const o=e.contentElement.getBoundingClientRect();e.wysiwyg.element.querySelectorAll(".av").forEach(l=>{l.querySelector(".av__title")&&is(l,o,"all")})}),this.element.addEventListener("focusout",()=>{if(getSelection().rangeCount===0)return;const o=getSelection().getRangeAt(0);(this.element.isSameNode(o.startContainer)||this.element.contains(o.startContainer))&&(e.toolbar.range=o)}),this.element.addEventListener("cut",o=>{if(window.siyuan.ctrlIsPressed=!1,e.disabled)return;if(o.target.tagName==="PROTYLE-HTML"||o.target.localName==="input"){o.stopPropagation();return}e.options.render.breadcrumb&&e.breadcrumb.hide();const l=me(e.wysiwyg.element);let r=P(l.startContainer);if(!r){o.stopPropagation(),o.preventDefault();return}const d=F(r);d&&(r=d),o.stopPropagation(),o.preventDefault();const c=r.querySelector(".img--select"),f=r.querySelector(".av__row--select, .av__cell--select"),g=r.querySelector(".table__select")?.clientWidth>0;let p=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));p.length===0&&l.toString()===""&&!l.cloneContents().querySelector("img")&&!c&&!f&&!g&&(r.classList.add("protyle-wysiwyg--select"),p=[r]);let h="",m="";if(p.length>0){p[0].getAttribute("data-type")==="NodeListItem"&&p[0].parentElement.classList.contains("list")&&p[0].parentElement.childElementCount-1===p.length?h=p[0].parentElement.outerHTML:(p.forEach(y=>{const w=Je(y);y.getAttribute("data-type")==="NodeHeading"&&y.getAttribute("fold")==="1"?h+=ff(w).replace('fold="1"',""):h+=ff(w)}),p[0].getAttribute("data-type")==="NodeListItem"&&(h=`<div data-subtype="${p[0].getAttribute("data-subtype")}" data-node-id="${Lute.NewNodeID()}" data-type="NodeList" class="list">${h}<div class="protyle-attr" contenteditable="false">${u.ZWSP}</div></div>`));const b=et(p[p.length-1]);fa(e,r,l,"remove"),b&&ae(b)}else if(f){const b=Tn(e,r);h=JSON.stringify(b.json),m=b.text}else if(g){const b=[],y=r.firstElementChild.scrollLeft,w=r.querySelector(".table__select");if(h="<table>",r.querySelectorAll("th, td").forEach(x=>{!x.classList.contains("fn__none")&&x.offsetLeft+6>w.offsetLeft+y&&x.offsetLeft+x.clientWidth-6<w.offsetLeft+y+w.clientWidth&&x.offsetTop+6>w.offsetTop&&x.offsetTop+x.clientHeight-6<w.offsetTop+w.clientHeight&&b.push(x)}),w.removeAttribute("style"),getSelection().rangeCount>0){const x=getSelection().getRangeAt(0);r.contains(x.startContainer)&&x.insertNode(document.createElement("wbr"))}const _=r.outerHTML;r.querySelector("wbr")?.remove(),r.setAttribute("updated",Y().format("YYYYMMDDHHmmss")),b.forEach((x,S)=>{(S===0||!x.previousElementSibling||!x.previousElementSibling.isSameNode(b[S-1]))&&(h+="<tr>"),h+=x.outerHTML,(!x.nextElementSibling||!b[S+1]||!x.nextElementSibling.isSameNode(b[S+1]))&&(h+="</tr>"),x.innerHTML=""}),h+="</table>",m=e.lute.HTML2Md(h),J(e,r.getAttribute("data-node-id"),r.outerHTML,_)}else{const b=r.getAttribute("data-node-id");qc(r,l,e);const y=e.wysiwyg.lastHTMLs[b]||r.outerHTML,w=document.createElement("div");let _=l.startContainer;if(_.nodeType===3&&_.textContent===""){const S=Oe(l.startContainer);S&&(_=S)}const x=B(_,"data-type","NodeHeading");if(x&&l.toString()===x.firstElementChild.textContent)w.insertAdjacentHTML("afterbegin",x.firstElementChild.innerHTML),x.firstElementChild.innerHTML="";else if(l.toString()!==""&&_.isSameNode(l.endContainer)&&l.startContainer.nodeType===3&&l.endOffset===l.endContainer.textContent.length&&l.startOffset===0&&!["DIV","TD","TH","TR"].includes(l.startContainer.parentElement.tagName))w.append(l.startContainer.parentElement);else if(c)w.append(c);else if(l.startContainer.nodeType===3&&l.startContainer.parentElement.tagName==="SPAN"&&l.startContainer.parentElement.getAttribute("data-type")&&l.startContainer.parentElement.isSameNode(l.endContainer.parentElement)){const S=l.startContainer.parentElement,k=S.attributes,A=document.createElement("span");for(let $=0;$<k.length;$++)A.setAttribute(k[$].name,k[$].value);S.getAttribute("data-type").indexOf("block-ref")>-1&&S.getAttribute("data-subtype")==="d"&&(A.setAttribute("data-subtype","s"),S.setAttribute("data-subtype","s")),A.textContent=l.toString(),l.deleteContents(),w.append(A)}else if(l.cloneContents().querySelectorAll("td, th").length>0){const S=document.createElement("wbr");l.insertNode(S),l.setStartAfter(S),w.append(l.extractContents()),r.outerHTML=e.lute.SpinBlockDOM(r.outerHTML),r=e.wysiwyg.element.querySelector(`[data-node-id="${b}"]`),Ma(r),he(r,l)}else{const S=B(l.commonAncestorContainer,"data-type","inline-math");if(S)w.append(S);else{w.append(l.extractContents());let k;r.classList.contains("av")?vm(e,r):r.classList.contains("table")?k=q(l.startContainer,"TD")||q(l.startContainer,"TH"):k=le(r),k&&Array.from(k.children).forEach(A=>{A.textContent===""&&A.nodeType===1&&!["BR","IMG"].includes(A.tagName)&&A.remove()})}}if(this.emojiToMd(w),h=w.innerHTML,(B(l.startContainer,"data-type","NodeCodeBlock")||q(l.startContainer,"CODE"))&&(m=w.textContent.replace(u.ZWSP,"")),!r.classList.contains("table")){const S=le(r);S&&S.textContent===""&&(S.innerHTML="")}r.setAttribute("updated",Y().format("YYYYMMDDHHmmss")),r.getAttribute("data-type")==="NodeCodeBlock"&&(l.insertNode(document.createElement("wbr")),r.querySelector('[data-render="true"]')?.removeAttribute("data-render"),ze(r)),r.parentElement.parentElement&&!r.classList.contains("av")&&(qc(r,l,e),J(e,b,e.wysiwyg.lastHTMLs[b]||r.outerHTML,y))}e.hint.render(e),f||(m=m||e.lute.BlockDOM2StdMd(h).trimEnd()),m=m.replace(/\u00A0/g," "),o.clipboardData.setData("text/plain",m),o.clipboardData.setData("text/html",g?h:e.lute.BlockDOM2HTML(f?m:h)),o.clipboardData.setData("text/siyuan",g?e.lute.HTML2BlockDOM(h):h)});let n;this.element.addEventListener("contextmenu",o=>{if(o.shiftKey)return;o.stopPropagation(),o.preventDefault();const l=o.clientX||o.detail.x,r=o.clientY||o.detail.y,d=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(d.length>1){Q(["util"],e),e.gutter.renderMenu(e,d[0]),window.siyuan.menus.menu.popup({x:l,y:r});return}const c=o.detail.target||o.target,f=F(c);if(f)return getSelection().rangeCount===0&&wb(f),e.gutter.renderMenu(e,f),window.siyuan.menus.menu.popup({x:l,y:r}),!1;const g=P(c);if(!g)return!1;const p=L(c,"av__cell");if(p){if(p.classList.contains("av__cell--header")){e.disabled||ov(e,g,p),o.stopPropagation(),o.preventDefault();return}if(vn(p)==="mAsset"){const y=L(c,"av__cellassetimg")||L(c,"av__celltext--url");if(y){let w=0;Array.from(p.children).find((_,x)=>{if(_===y)return w=x,!0}),Kf({protyle:e,cellElements:[p],blockElement:P(y),content:c.tagName==="IMG"?c.getAttribute("src"):c.getAttribute("data-url"),type:c.tagName==="IMG"?"image":"file",name:c.tagName==="IMG"?"":c.getAttribute("data-name"),index:w,rect:c.getBoundingClientRect()}),o.stopPropagation(),o.preventDefault();return}}}const h=L(c,"av__row");if(h&&Zf(e,h,{x:o.clientX,y:h.getBoundingClientRect().bottom,h:h.clientHeight})){o.stopPropagation(),o.preventDefault();return}const m=L(c,"item");if(g.classList.contains("av")&&m){m.classList.contains("item--focus")?Ec({protyle:e,blockElement:g,element:m}):(g.removeAttribute("data-render"),dt(g,e,()=>{Ec({protyle:e,blockElement:g,element:g.querySelector(".item.item--focus")})},m.dataset.id)),o.stopPropagation(),o.preventDefault();return}if(e.toolbar.range=me(e.element),c.tagName==="SPAN"&&!Ln(g)){let y=c.getAttribute("data-type")?.split(" ")||[];if(y.length===0&&(y=(c.dataset.type||"").split(" ")),y.length>0&&h_(c),y.includes("block-ref"))return fm(e,c),c.setAttribute("prevent-popover","true"),setTimeout(()=>{c.removeAttribute("prevent-popover")},620),!1;if(y.includes("file-annotation-ref")&&!e.disabled)return um(e,c),!1;if(y.includes("tag")&&!e.disabled)return hm(e,c),!1;if(y.includes("inline-memo"))return e.toolbar.showRender(e,c),!1;if(y.includes("a"))return bc(e,c),window.siyuan.config.editor.floatWindowMode===0&&c.getAttribute("data-href")?.startsWith("siyuan://blocks")&&(c.setAttribute("prevent-popover","true"),setTimeout(()=>{c.removeAttribute("prevent-popover")},620)),!1}const b=B(c,"data-type","inline-math");if(b)return zf(e,b),!1;if(c.tagName==="IMG"&&L(c,"img"))return gm(e,e.toolbar.range,c.parentElement.parentElement,{clientX:l+4,clientY:r}),!1;!Ln(g)&&!g.classList.contains("protyle-wysiwyg--select")&&!L(c,"protyle-action")&&(W()||o.detail.target||n&&g.contains(n.startContainer))?(!W()||e.toolbar?.element.classList.contains("fn__none"))&&!g.classList.contains("av")&&(tx(e,g),window.siyuan.menus.menu.popup({x:l,y:r+13,h:26}),e.toolbar?.element.classList.add("fn__none"),g.classList.contains("table")&&g.querySelector(".table__select").removeAttribute("style")):e.toolbar.range.toString()===""&&(Q(["util"],e),e.gutter&&e.gutter.renderMenu(e,g),window.siyuan.menus.menu.popup({x:l,y:r}),e.toolbar?.element.classList.add("fn__none"))}),this.element.addEventListener("pointerdown",()=>{getSelection().rangeCount>0?n=getSelection().getRangeAt(0):n=void 0});let a=!1;this.element.addEventListener("mousewheel",o=>{if(Zt(),!a&&o.deltaY<0&&!e.scroll.element.classList.contains("fn__none")&&e.contentElement.clientHeight===e.contentElement.scrollHeight&&e.wysiwyg.element.firstElementChild.getAttribute("data-eof")!=="1"&&(E("/api/filetree/getDoc",{id:e.wysiwyg.element.firstElementChild.getAttribute("data-node-id"),mode:1,size:window.siyuan.config.editor.dynamicLoadBlocks},r=>{a=!1,rt({data:r,protyle:e,action:[u.CB_GET_BEFORE,u.CB_GET_UNCHANGEID]})}),a=!0),o.deltaX===0)return;const l=L(o.target,"table");if(l){const r=l.querySelector(".table__select");r?.style.width&&(r.removeAttribute("style"),window.siyuan.menus.menu.remove())}},{passive:!0}),this.element.addEventListener("paste",o=>{if(o.target.localName==="input"&&o.target.getAttribute("data-type")==="av-search")return;if(e.disabled){o.stopPropagation(),o.preventDefault();return}if(window.siyuan.ctrlIsPressed=!1,o.target.tagName==="PROTYLE-HTML"||o.target.localName==="input"){o.stopPropagation();return}if(!B(o.target,"contenteditable","true")){o.stopPropagation(),o.preventDefault();return}const l=P(o.target);if(l&&!le(l)){o.stopPropagation(),o.preventDefault();return}if(!l)return;const r=getSelection().getRangeAt(0),d=r.startContainer.parentElement;if(r.toString()===""&&d.tagName==="SPAN"){const c=(d.getAttribute("data-type")||"").split(" ");if(c.includes("inline-memo")||c.includes("text")||c.includes("block-ref")||c.includes("file-annotation-ref")||c.includes("a")){const f=ct(d,l,r);f.start===0?(r.setStartBefore(d),r.collapse(!0)):f.start===d.textContent.length&&(r.setEndAfter(d),r.collapse(!1))}}wl(e,o)});let i=!1;this.element.addEventListener("compositionstart",o=>{i=!0;const l=me(e.wysiwyg.element),r=P(l.startContainer);!gt()&&r&&qc(r,l,e),o.stopPropagation()}),this.element.addEventListener("compositionend",o=>{o.stopPropagation(),i=!1;const l=me(this.element),r=P(l.startContainer);if(r)if(o.data!=="")this.escapeInline(e,l,o),Gf(e,r,l,!0);else{const d=r.getAttribute("data-node-id");e.wysiwyg.lastHTMLs[d]&&J(e,d,r.outerHTML,e.wysiwyg.lastHTMLs[d])}});let s;this.element.addEventListener("input",o=>{const l=o.target;if(l.tagName==="VIDEO"||l.tagName==="AUDIO"||o.inputType==="historyRedo")return;if(o.inputType==="historyUndo"){ee.ipcRenderer.send(u.SIYUAN_CMD,"redo"),window.siyuan.menus.menu.remove();return}const r=me(this.element),d=P(r.startContainer);d&&([":","(","\u3010","\uFF08","[","{","\u300C","\u300E","#","/","\u3001"].includes(o.data)&&(e.hint.enableExtend=!0),!(o.isComposing||i||o.inputType==="deleteByDrag"||o.inputType==="insertFromDrop")&&(this.escapeInline(e,r,o),/^\d{1}$/.test(o.data)||o.data==="\u2018"||o.data==="\u201C"||o.data==="\u201D"||o.data==="\u300C"?(clearTimeout(s),s=window.setTimeout(()=>{Gf(e,d,r,!0)})):Gf(e,d,r,!0,o),o.stopPropagation()))}),this.element.addEventListener("keyup",o=>{const l=me(this.element).cloneRange(),r=P(l.startContainer);if(o.key!=="PageUp"&&o.key!=="PageDown"&&o.key!=="Home"&&o.key!=="End"&&o.key.indexOf("Arrow")===-1&&o.key!=="Escape"&&o.key!=="Shift"&&o.key!=="Meta"&&o.key!=="Alt"&&o.key!=="Control"&&o.key!=="CapsLock"&&!o.ctrlKey&&!o.shiftKey&&!o.metaKey&&!o.altKey&&!/^F\d{1,2}$/.test(o.key)){!gt()&&r&&!i&&(typeof e.wysiwyg.lastHTMLs[r.getAttribute("data-node-id")]>"u"||l.toString()!==""||!this.preventKeyup)&&qc(r,l,e),this.preventKeyup=!1;return}if(this.preventKeyup){this.preventKeyup=!1;return}if((o.shiftKey||Dt(o))&&!o.isComposing&&l.toString()!==""&&(e.toolbar.render(e,l,o),Lo(l)),o.eventPhase!==3&&!o.shiftKey&&(o.key.indexOf("Arrow")>-1||o.key==="Home"||o.key==="End"||o.key==="PageUp"||o.key==="PageDown")&&!o.isComposing){if(r&&(this.setEmptyOutline(e,r),l.toString()===""&&!r.classList.contains("protyle-wysiwyg--select")&&Lo(l,e.block.rootID),e.breadcrumb)){const d=e.breadcrumb.element.parentElement.querySelector('[data-type="indent"]');if(d){const c=e.breadcrumb.element.parentElement.querySelector('[data-type="outdent"]');r.parentElement.classList.contains("li")?(d.removeAttribute("disabled"),c.removeAttribute("disabled")):(d.setAttribute("disabled","true"),c.setAttribute("disabled","true"))}}o.stopPropagation()}if((o.key==="ArrowLeft"||o.key==="ArrowRight")&&r&&!r.classList.contains("protyle-wysiwyg--select")){const d=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));let c=!1;d.find(f=>{if(f.contains(l.startContainer))return c=!0,!0}),!c&&d.length>0&&(d.forEach(f=>{f.classList.remove("protyle-wysiwyg--select")}),r.classList.add("protyle-wysiwyg--select"))}}),this.element.addEventListener("dblclick",o=>{if(o.target.tagName==="IMG"&&!o.target.classList.contains("emoji")){$_(o.target.getAttribute("src"),e.block.rootID);return}}),this.element.addEventListener("click",o=>{if(this.preventClick){this.preventClick=!1;return}e.app.plugins.forEach(C=>{C.eventBus.emit("click-editorcontent",{protyle:e,event:o})}),Q(["hint","util"],e);const l=Dt(o),r=L(o.target,"protyle-breadcrumb__item");if(r){const C=r.getAttribute("data-id");C?l&&!o.shiftKey&&!o.altKey?Ke(C,N=>{de({app:e.app,id:C,action:N?[u.CB_GET_FOCUS,u.CB_GET_ALL]:[u.CB_GET_FOCUS,u.CB_GET_CONTEXT],zoomIn:N})}):Px(e,r):Nx(r),o.stopPropagation();return}o.shiftKey||(this.shiftStartElement=void 0),this.setEmptyOutline(e,o.target);const d=L(o.target,"table");this.element.querySelectorAll(".table").forEach(C=>{(!d||!C.isSameNode(d))&&C.querySelector(".table__select").removeAttribute("style"),d&&d.isSameNode(C)&&C.querySelector(".table__select").getAttribute("style")&&o.stopPropagation()}),e.options.render.breadcrumb&&e.breadcrumb.render(e,!1,P(o.target));const c=me(this.element);c.startContainer.nodeType!==3&&c.startContainer.classList.contains("protyle-action")&&c.startContainer.parentElement.classList.contains("code-block")&&xo(c.startContainer.parentElement.querySelector(".hljs").lastElementChild,c);const f=B(o.target,"data-type","a")||L(o.target,"av__celltext--url");let g=f&&f.getAttribute("data-href")||"";f&&!g&&f.classList.contains("av__celltext--url")&&(g=f.textContent.trim(),f.dataset.type==="phone"?g="tel:"+g:f.dataset.type==="email"?g="mailto:"+g:f.classList.contains("b3-chip")&&(g=f.dataset.url));const p=B(o.target,"data-type","block-ref");if((p||g.startsWith("siyuan://blocks/"))&&(o.stopPropagation(),o.preventDefault(),Q(["dialog","toolbar"],e),c.toString()===""||o.shiftKey)){let C;if(p?C=p.getAttribute("data-id"):f&&(C=g.substring(16,38)),Ke(C,(N,O,te)=>{te||O.push(u.CB_GET_HL),o.shiftKey?(de({app:e.app,id:C,position:"bottom",action:O,zoomIn:N}),window.dispatchEvent(new KeyboardEvent("keydown",{key:"Escape"}))):o.altKey?de({app:e.app,id:C,position:"right",action:O,zoomIn:N}):de(l?{app:e.app,id:C,keepCursor:!0,action:N?[u.CB_GET_HL,u.CB_GET_ALL]:[u.CB_GET_HL,u.CB_GET_CONTEXT,u.CB_GET_ROOTSCROLL],zoomIn:N}:{app:e.app,id:C,action:O,zoomIn:N})}),e.model){let N;p?N=P(p):f&&(N=P(f)),N&&ql(e,me(this.element),N)}return}const h=B(o.target,"data-type","file-annotation-ref");if(h&&c.toString()===""){o.stopPropagation(),o.preventDefault(),wc(e,h.getAttribute("data-id"),o,l);return}if(f&&(o.shiftKey||c.toString()==="")&&g){o.stopPropagation(),o.preventDefault(),wc(e,g,o,l);return}if(f&&f.classList.contains("av__celltext--url")&&!g){let C=0;Array.from(f.parentElement.children).find((N,O)=>{if(N===f)return C=O,!0}),Kf({protyle:e,cellElements:[f.parentElement],blockElement:P(f),content:f.getAttribute("data-url"),type:"file",name:f.getAttribute("data-name"),index:C,rect:f.getBoundingClientRect()});return}const m=B(o.target,"data-type","tag");if(m&&!o.altKey&&!o.shiftKey&&c.toString()===""){ti(e.app,`#${m.textContent}#`,!l,{method:0}),Q(["dialog"]);return}const b=L(o.target,"protyle-wysiwyg__embed");if(b){const C=b.getAttribute("data-id");if(Ke(C,(N,O)=>{o.shiftKey?de({app:e.app,id:C,position:"bottom",action:O,zoomIn:N}):o.altKey?de({app:e.app,id:C,position:"right",action:O,zoomIn:N}):l?de({app:e.app,id:C,action:N?[u.CB_GET_HL,u.CB_GET_ALL]:[u.CB_GET_HL,u.CB_GET_CONTEXT],zoomIn:N,keepCursor:!0}):e.disabled||window.siyuan.blockPanels.push(new Hc({app:e.app,targetElement:b,isBacklink:!1,refDefs:[{refID:C}]}))}),!l){o.stopPropagation();return}}if(zE(o,e)||Le(o.target,"protyle-action__copy"))return;const y=L(o.target,"protyle-action__edit");if(y&&!e.disabled){e.toolbar.showRender(e,y.parentElement.parentElement),o.stopPropagation(),o.preventDefault();return}const w=L(o.target,"protyle-action__menu");if(w){e.gutter.renderMenu(e,w.parentElement.parentElement);const C=w.getBoundingClientRect();window.siyuan.menus.menu.popup({x:C.left,y:C.top,isLeft:!0}),o.stopPropagation(),o.preventDefault();return}const _=L(o.target,"protyle-action__reload");if(_){const C=F(_);C&&(C.removeAttribute("data-render"),Be(e,C)),o.stopPropagation(),o.preventDefault();return}const x=L(o.target,"protyle-action__language");if(x&&!e.disabled&&!l){e.toolbar.showCodeLanguage(e,x),o.stopPropagation(),o.preventDefault();return}const S=B(o.target,"data-subtype","math");if(!o.shiftKey&&!l&&S&&!e.disabled){e.toolbar.showRender(e,S),o.stopPropagation();return}const k=L(o.target,"protyle-action");if(k){if(k.parentElement.parentElement.getAttribute("data-type")==="img"&&!e.disabled){gm(e,c,k.parentElement.parentElement,{clientX:o.clientX+4,clientY:o.clientY}),o.stopPropagation();return}else if(k.parentElement.classList.contains("li")){const N=k.parentElement.getAttribute("data-node-id");if(o.altKey&&!e.disabled){if(k.parentElement.parentElement.classList.contains("protyle-wysiwyg"))an(e,k.parentElement);else{let O=!0;const te=k.parentElement.parentElement.outerHTML;Array.from(k.parentElement.parentElement.children).find(ne=>{if(ne.classList.contains("li")&&ne.getAttribute("fold")!=="1"&&ne.childElementCount>3)return O=!1,!0}),Array.from(k.parentElement.parentElement.children).find(ne=>{ne.classList.contains("li")&&(O?ne.removeAttribute("fold"):ne.childElementCount>3&&ne.setAttribute("fold","1"))}),J(e,k.parentElement.parentElement.getAttribute("data-node-id"),k.parentElement.parentElement.outerHTML,te)}Q(["gutter"],e)}else if(o.shiftKey&&!e.disabled)Ti(k.parentElement,"bookmark",e);else if(l)Vt({protyle:e,id:N});else if(k.classList.contains("protyle-action--task")){if(!e.disabled){const O=k.parentElement.outerHTML;k.parentElement.classList.contains("protyle-task--done")?(k.querySelector("use").setAttribute("xlink:href","#iconUncheck"),k.parentElement.classList.remove("protyle-task--done")):(k.querySelector("use").setAttribute("xlink:href","#iconCheck"),k.parentElement.classList.add("protyle-task--done")),k.parentElement.setAttribute("updated",Y().format("YYYYMMDDHHmmss")),J(e,N,k.parentElement.outerHTML,O)}}else window.siyuan.config.editor.listItemDotNumberClickFocus&&(e.block.showAll&&e.block.id===N?pm(e,N):Vt({protyle:e,id:N}));o.stopPropagation();return}}const A=L(o.target,"hr")||L(o.target,"iframe");if(!o.shiftKey&&!l&&A){A.classList.add("protyle-wysiwyg--select"),GE(o.target),o.stopPropagation();return}const $=Le(o.target,"img");if(!o.shiftKey&&!l&&$){$.classList.add("img--select");const C=Oe($);C&&(C.textContent.startsWith(u.ZWSP)?c.setStart(C,1):c.setStart(C,0),c.collapse(!0),Z(c),e.options.render.breadcrumb&&e.breadcrumb.render(e));return}const M=Le(o.target,"emoji");if(!e.disabled&&!o.shiftKey&&!l&&M){const C=P(M);if(C){const N=M.getBoundingClientRect();Za("","av",{x:N.left,y:N.bottom,h:N.height,w:N.width},O=>{M.insertAdjacentHTML("afterend","<wbr>");const te=C.outerHTML;let ne;if(O.startsWith("api/icon/getDynamicIcon"))ne=`<img class="emoji" src="${O}"/>`;else if(O.indexOf(".")>-1){const oe=O.split(".");ne=`<img alt="${oe[0]}" class="emoji" src="/emojis/${O}" title="${oe[0]}">`}else ne=ge(O);M.outerHTML=ne,Q(["dialog"]),J(e,C.getAttribute("data-node-id"),C.outerHTML,te),he(C,c)},M)}return}if(!Ex(e,o)){if(setTimeout(()=>{let C=me(this.element);const N=L(C.endContainer,"protyle-attr");N&&(C=Pt(N.previousElementSibling,C,!1)),C.toString().replace(u.ZWSP,"")!==""?e.toolbar.render(e,C):e.toolbar.range=C,e.wysiwyg.element.querySelector(".protyle-wysiwyg--select")||Lo(C,e.block.rootID),getSelection().rangeCount===0&&Z(C),ql(e,C)},W()||ra()?520:0),e.hint.enableExtend=!1,o.shiftKey){o.preventDefault(),o.stopPropagation();let C=this.shiftStartElement,N=P(o.target);if(this.shiftStartElement&&N&&!this.shiftStartElement.isSameNode(N)){let O=!0;c.collapse(!0);const te=C.getBoundingClientRect(),ne=N.getBoundingClientRect();let oe=te.top,ce=ne.top;if(oe===ce&&(oe=te.left,ce=ne.left),oe>ce){const Fe=N;N=C,C=Fe;const mt=ce;ce=oe,oe=mt,O=!1}let Ge=[],$e=C,Ie=!1;for(;$e;)if($e&&!$e.classList.contains("protyle-attr")){const Fe=$e.getBoundingClientRect();if(te.top===ne.top?Fe.left<=ce:Fe.top<=ce)if(Ie)if($e.nextElementSibling&&!$e.nextElementSibling.classList.contains("protyle-attr")){const mt=$e.nextElementSibling.getBoundingClientRect();if(te.top===ne.top?mt.left<=ce&&mt.bottom<=ne.bottom:mt.top<=ce)Ge=[$e],$e=$e.nextElementSibling,Ie=!1;else if($e.parentElement.classList.contains("sb"))$e=P($e.parentElement),Ie=!0;else break}else $e=P($e.parentElement),Ie=!0;else Ge.push($e),$e=$e.nextElementSibling;else if($e.parentElement.classList.contains("sb"))$e=P($e.parentElement),Ie=!0;else break}else $e=P($e.parentElement),Ie=!0;if(Ge.length===1&&!Ge[0].classList.contains("list")&&!Ge[0].classList.contains("bq")&&!Ge[0].classList.contains("sb"))this.shiftStartElement=void 0;else{const Fe=[];!e.wysiwyg.element.querySelector(".protyle-wysiwyg--select")&&e.scroll&&!e.scroll.element.classList.contains("fn__none")&&!e.scroll.keepLazyLoad&&(C.getBoundingClientRect().top<-e.contentElement.clientHeight*2||N.getBoundingClientRect().bottom>e.contentElement.clientHeight*2)&&j(window.siyuan.languages.crossKeepLazyLoad),Ge.forEach(mt=>{mt.classList.add("protyle-wysiwyg--select"),Fe.push(mt.getAttribute("data-node-id")),mt.querySelectorAll(".protyle-wysiwyg--select").forEach(ie=>{ie.classList.remove("protyle-wysiwyg--select")})}),bn(Fe),ae(O?Ge[Ge.length-1]:Ge[0],e.wysiwyg.element,!1)}}}if(this.element.querySelector(".protyle-wysiwyg--select")&&c.toString()!==""&&(c.collapse(!1),Z(c)),l&&c.toString()===""&&!o.shiftKey&&!o.altKey){let C=P(o.target);if(C){const N=F(C);N&&(C=N),C=Je(C),C.classList.contains("protyle-wysiwyg--select")?(C.classList.remove("protyle-wysiwyg--select"),C.removeAttribute("select-start"),C.removeAttribute("select-end")):C.classList.add("protyle-wysiwyg--select"),C.querySelectorAll(".protyle-wysiwyg--select").forEach(ne=>{ne.classList.remove("protyle-wysiwyg--select"),ne.removeAttribute("select-start"),ne.removeAttribute("select-end")});const O=L(C.parentElement,"protyle-wysiwyg--select");O&&(O.classList.remove("protyle-wysiwyg--select"),O.removeAttribute("select-start"),O.removeAttribute("select-end"));const te=[];e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").forEach(ne=>{te.push(ne.getAttribute("data-node-id"))}),bn(te)}}}})}}class kT{constructor(){this.element=document.createElement("div"),this.element.className="protyle-toolbar__divider"}}class ST extends ro{constructor(e,n){super(e,n),this.element.addEventListener("click",async a=>{e.toolbar.element.classList.add("fn__none"),a.stopPropagation();const i=e.toolbar.range;if(!P(i.startContainer))return;const o=B(i.startContainer,"data-type","a");if(o){bc(e,o);return}const l=i.toString().trim().replace(u.ZWSP,"");let r="",d="";try{const c=await Qu();if(r=e.lute.GetLinkDest(l),r||(r=e.lute.GetLinkDest(c)),!r){const f=c.lastIndexOf(" ");f>-1&&(r=e.lute.GetLinkDest(c.substring(f)),r&&(d=c.substring(0,f)))}!r&&c.startsWith("assets/")&&(r=c)}catch(c){console.log(c)}e.toolbar.setInlineMark(e,"a","range",{type:"a",color:r+(d?u.ZWSP+d:"")})})}}class LT extends ro{constructor(e,n){super(e,n),this.element.addEventListener("click",a=>{e.toolbar.range.toString()!==""&&(bb(e.toolbar.range),ss(e.toolbar.range.toString(),e,"search"),e.toolbar.element.classList.add("fn__none"),a.stopPropagation())})}}class xT extends ro{constructor(e,n){super(e,n),this.element.addEventListener("click",async a=>{e.toolbar.element.classList.add("fn__none"),a.stopPropagation();const i=e.toolbar.range;if(!P(i.startContainer))return;let o=B(i.startContainer,"data-type","inline-math");if(!o&&i.startContainer.nodeType!==3&&i.startContainer.childNodes[i.startOffset]){const l=At(i.startContainer.childNodes[i.startOffset]);l&&l.nodeType!==3&&l.getAttribute("data-type").indexOf("inline-math")>-1&&(o=l)}if(!o&&i.startOffset===i.startContainer.textContent.length&&i.startContainer.nodeType===3){let l=!0,r=!1;if(i.cloneContents().childNodes.forEach(d=>{d.nodeType!==3&&(d.getAttribute("data-type")||"").indexOf("inline-math")>-1||d.nodeType==3&&d.textContent===""?r=!0:l=!1}),l&&r){const d=Oe(i.startContainer);if(d&&d.nodeType!==3&&d.getAttribute("data-type").indexOf("inline-math")>-1)o=d;else{const c=At(i.startContainer);i.startOffset===0&&c&&c.nodeType!==3&&c.getAttribute("data-type").indexOf("inline-math")>-1&&(o=c)}}}if(o){e.toolbar.showRender(e,o);return}e.toolbar.setInlineMark(e,"inline-math","range",{type:"inline-math"})})}}class AT extends ro{constructor(e,n){super(e,n),this.element.addEventListener("click",async a=>{e.toolbar.element.classList.add("fn__none"),a.stopPropagation();const i=e.toolbar.range;if(!P(i.startContainer))return;const o=B(i.startContainer,"data-type","inline-memo");if(o&&o.textContent===i.toString()){e.toolbar.showRender(e,o);return}i.toString()!==""&&e.toolbar.setInlineMark(e,"inline-memo","range",{type:"inline-memo"})})}}class CT{constructor(e){const n=e.options,a=document.createElement("div");a.className="protyle-toolbar fn__none",this.element=a,this.subElement=document.createElement("div"),this.subElement.className="protyle-util fn__none",this.toolbarHeight=29,e.app.plugins.forEach(i=>{const s=i.updateProtyleToolbar(n.toolbar);s.forEach(o=>{typeof o=="string"||u.INLINE_TYPE.concat("|").includes(o.name)||!o.hotkey||window.siyuan.config.keymap.plugin&&window.siyuan.config.keymap.plugin[i.name]&&window.siyuan.config.keymap.plugin[i.name][o.name]&&(o.hotkey=window.siyuan.config.keymap.plugin[i.name][o.name].custom)}),n.toolbar=Uf(s)}),n.toolbar.forEach(i=>{const s=this.genItem(e,i);this.element.appendChild(s)})}update(e){this.element.innerHTML="",e.options.toolbar=Uf(u.PROTYLE_TOOLBAR),e.app.plugins.forEach(n=>{const a=n.updateProtyleToolbar(e.options.toolbar);a.forEach(i=>{typeof i=="string"||u.INLINE_TYPE.concat("|").includes(i.name)||!i.hotkey||window.siyuan.config.keymap.plugin&&window.siyuan.config.keymap.plugin[n.name]&&window.siyuan.config.keymap.plugin[n.name][i.name]&&(i.hotkey=window.siyuan.config.keymap.plugin[n.name][i.name].custom)}),e.options.toolbar=Uf(a)}),e.options.toolbar.forEach(n=>{const a=this.genItem(e,n);this.element.appendChild(a)})}render(e,n,a){this.range=n;let i=P(n.startContainer);if(W()||!i||e.disabled||i.classList.contains("av")){this.element.classList.add("fn__none");return}let s=!1;if(Array.from(n.cloneContents().childNodes).find(f=>{if(f.textContent.length>0&&f.textContent!==u.ZWSP&&!(f.nodeType===1&&f.classList.contains("img")))return s=!0,!0}),!s||n.commonAncestorContainer.nodeType!==3&&n.commonAncestorContainer.classList.contains("img")){this.element.classList.add("fn__none");return}const o=P(n.startContainer),l=P(n.endContainer);if(o&&l&&!o.isSameNode(l)){if(a)if(a.key==="ArrowLeft")this.range=Pt(le(o),n,!1);else if(a.key==="ArrowRight")this.range=xo(le(l),n),this.range.collapse(!1);else if(a.key==="ArrowUp"){if(this.range=xo(le(l),n),i=P(l),!i)return}else a.key==="ArrowDown"&&(this.range=Pt(le(o),n,!1));else this.range=Pt(le(i),n,!1);if(Z(this.range),this.range.toString()===""){this.element.classList.add("fn__none");return}}if(i.getAttribute("data-type")==="NodeCodeBlock"){this.element.classList.add("fn__none");return}const r=ta(i,n);this.element.classList.remove("fn__none"),this.toolbarHeight=this.element.clientHeight;const d=r.top-this.toolbarHeight-4;this.element.setAttribute("data-inity",d+u.ZWSP+e.contentElement.scrollTop.toString()),ke(this.element,r.left-52,Math.max(d,e.element.getBoundingClientRect().top+30)),this.element.querySelectorAll(".protyle-toolbar__item--current").forEach(f=>{f.classList.remove("protyle-toolbar__item--current")}),this.getCurrentType().forEach(f=>{if(["search-mark","a","block-ref","virtual-block-ref","text","file-annotation-ref","inline-math","inline-memo","","backslash"].includes(f))return;const g=this.element.querySelector(`[data-type="${f}"]`);g&&g.classList.add("protyle-toolbar__item--current")})}getCurrentType(e=this.range){let n=[],a=e.startContainer;if(a.nodeType===3?a=a.parentElement:a.childElementCount>0&&a.childNodes[e.startOffset]?.nodeType!==3&&(a=a.childNodes[e.startOffset]),!a||a.nodeType===3)return[];["DIV","TD","TH","TR"].includes(a.tagName)||(n=(a.getAttribute("data-type")||"").split(" "));let i=e.endContainer;return i.nodeType===3?i=i.parentElement:i.childElementCount>0&&i.childNodes[e.endOffset]?.nodeType!==3&&(i=i.childNodes[e.endOffset]),!i||i.nodeType===3?[]:(!["DIV","TD","TH","TR"].includes(i.tagName)&&!a.isSameNode(i)&&(n=n.concat((i.getAttribute("data-type")||"").split(" "))),e.cloneContents().childNodes.forEach(s=>{s.nodeType!==3&&(n=n.concat((s.getAttribute("data-type")||"").split(" ")))}),n=[...new Set(n)],n.find((s,o)=>{if(s==="")return n.splice(o,1),!0}),n)}setInlineMark(e,n,a,i){const s=P(this.range.startContainer);if(!s||s.getAttribute("data-type")==="NodeCodeBlock")return;const o=P(this.range.endContainer);if(!o)return;s.isSameNode(o)||(this.range=Pt(le(s),this.range,!1));const l=this.getCurrentType(this.range);if(l.length===1&&["block-ref","file-annotation-ref","a","inline-memo","inline-math","tag"].includes(l[0])&&n==="clear")return;const r=this.range.toString();bb(this.range);let d,c,f,g;const p=At(this.range.startContainer);["DIV","TD","TH","TR"].includes(this.range.startContainer.parentElement.tagName)?p&&p.nodeType!==3&&this.range.startOffset===0&&(d=p):this.range.startOffset===0&&!p?(d=this.range.startContainer.parentElement.previousSibling,this.range.setStartBefore(this.range.startContainer.parentElement)):d=this.range.startContainer.parentElement;let h=!1;const m=Oe(this.range.endContainer);["DIV","TD","TH","TR"].includes(this.range.endContainer.parentElement.tagName)?m&&m.nodeType!==3&&this.range.endOffset===this.range.endContainer.textContent.length&&(c=m):this.range.endOffset===this.range.endContainer.textContent.length&&!m?(c=this.range.endContainer.parentElement.nextSibling,this.range.setEndAfter(this.range.endContainer.parentElement),r===""&&(h=!0,this.range.collapse(!1))):c=this.range.endContainer.parentElement,this.range.insertNode(document.createElement("wbr"));const b=s.outerHTML,y=this.range.extractContents();if(this.mergeNode(y.childNodes),d&&c&&d.isSameNode(c)&&y.firstChild?.nodeType===3){const A=d.attributes;y.childNodes.forEach($=>{const M=document.createElement("span");for(let C=0;C<A.length;C++)M.setAttribute(A[C].name,A[C].value);M.innerHTML=$.textContent,$.replaceWith(M)})}const w=W()?document.querySelector("#keyboardToolbar .keyboard__dynamic").nextElementSibling:this.element,_=a==="toolbar"?w.querySelector(`[data-type="${n}"]`):void 0,x=[];if(n==="clear"||_?.classList.contains("protyle-toolbar__item--current")||a==="range"&&l.length>0&&l.includes(n)&&!i){if(n==="clear"?w.querySelectorAll('[data-type="strong"],[data-type="em"],[data-type="u"],[data-type="s"],[data-type="mark"],[data-type="sup"],[data-type="sub"],[data-type="kbd"],[data-type="mark"],[data-type="code"]').forEach(A=>{A.classList.remove("protyle-toolbar__item--current")}):_&&_.classList.remove("protyle-toolbar__item--current"),y.childNodes.length===0)if(l.find((A,$)=>{if(n===A)return l.splice($,1),!0}),l.length===0||n==="clear")x.push(document.createTextNode(u.ZWSP));else{let A=0;for(;A<l.length;)["inline-memo","text","block-ref","file-annotation-ref","a"].includes(l[A])?l.splice(A,1):++A;const $=document.createElement("span");$.setAttribute("data-type",l.join(" ")),$.textContent=u.ZWSP,x.push($)}y.childNodes.forEach((A,$)=>{if(A.nodeType!==3&&A.tagName!=="BR"&&A.tagName!=="IMG"&&!A.classList.contains("img")){if(A.textContent==="")return;const M=(A.getAttribute("data-type")||"").split(" ");if(n==="clear")for(let C=0;C<M.length;C++)i&&i.type==="text"?M[C]==="text"&&(M.splice(C,1),C--):["kbd","text","strong","em","u","s","mark","sup","sub","code"].includes(M[C])&&(M.splice(C,1),C--);else M.find((C,N)=>{if(n===C)return M.splice(N,1),!0});if(M.length===0)A.textContent===""&&(A.textContent=u.ZWSP),x.push(document.createTextNode(A.textContent));else{if(r&&n==="clear"&&i&&i.type==="text"&&A.style.color===""&&A.style.webkitTextFillColor===""&&A.style.webkitTextStroke===""&&A.style.textShadow===""&&A.style.backgroundColor===""&&A.style.fontSize==="")return A.setAttribute("data-type",M.join(" ")),x.push(A),!0;n==="clear"&&(A.style.color="",A.style.webkitTextFillColor="",A.style.webkitTextStroke="",A.style.textShadow="",A.style.backgroundColor="",A.style.fontSize=""),$===0&&d&&d.nodeType!==3&&je(M,(d.getAttribute("data-type")||"").split(" "))&&Ll(A,d,i)?(f=d.textContent.length,d.innerHTML=d.innerHTML+A.innerHTML):$===y.childNodes.length-1&&c&&c.nodeType!==3&&je(M,(c.getAttribute("data-type")||"").split(" "))&&Ll(A,c,i)?(g=A.textContent.length,c.innerHTML=A.innerHTML+c.innerHTML):(A.setAttribute("data-type",M.join(" ")),x.push(A))}}else x.push(A)})}else if(!this.element.classList.contains("fn__none")&&n!=="text"&&_&&_.classList.add("protyle-toolbar__item--current"),r===""){const A=document.createElement("span");if(l.push(n),h){let $=0;for(;$<l.length;)["inline-memo","text","block-ref","file-annotation-ref","a"].includes(l[$])?l.splice($,1):++$}A.setAttribute("data-type",[...new Set(l)].join(" ")),A.textContent=u.ZWSP,Qh(A,i),x.push(A)}else{if(n==="block-ref")for(;y.childNodes.length>1;)y.childNodes[0].remove();y.childNodes.forEach((A,$)=>{let M="";if(A.nodeType===3)if($===0&&d&&d.nodeType!==3&&n===d.getAttribute("data-type")&&Ll(A,d,i))f=d.textContent.length,d.innerHTML=d.innerHTML+A.textContent;else if($===y.childNodes.length-1&&c&&c.nodeType!==3&&n===c.getAttribute("data-type")&&Ll(A,c,i))g=A.textContent.length,c.innerHTML=A.textContent+c.innerHTML;else if(A.textContent!==u.ZWSP||A.textContent===u.ZWSP&&!l.includes("img")){for(A.textContent.startsWith(u.ZWSP)&&(x.push(document.createTextNode(u.ZWSP)),A.textContent=A.textContent.substring(1));A.textContent.endsWith(`
`);)A.textContent=A.textContent.substring(0,A.textContent.length-1),M+=`
`;const C=document.createElement("span");C.setAttribute("data-type",n),C.textContent=A.textContent,Qh(C,i),n==="text"&&!C.getAttribute("style")?x.push(A):x.push(C)}else x.push(A);else{let C=(A.getAttribute("data-type")||"").split(" ");for(let N=0;N<C.length;N++)["backslash","virtual-block-ref","search-mark"].includes(C[N])&&(C.splice(N,1),N--);if(C.includes("img")||C.push(n),(C.includes("code")||C.includes("tag")||C.includes("kbd"))&&!A.textContent.startsWith(u.ZWSP)&&A.insertAdjacentText("afterbegin",u.ZWSP),n==="sub"&&C.includes("sup")?C.find((N,O)=>{if(N==="sup")return C.splice(O,1),w.querySelector('[data-type="sup"]').classList.remove("protyle-toolbar__item--current"),!0}):n==="sup"&&C.includes("sub")?C.find((N,O)=>{if(N==="sub")return C.splice(O,1),w.querySelector('[data-type="sub"]').classList.remove("protyle-toolbar__item--current"),!0}):n==="block-ref"&&(C.includes("a")||C.includes("file-annotation-ref"))?C.find((N,O)=>{if(N==="a"||N==="file-annotation-ref")return C.splice(O,1),!0}):n==="a"&&(C.includes("block-ref")||C.includes("file-annotation-ref"))?C.find((N,O)=>{if(N==="block-ref"||N==="file-annotation-ref")return C.splice(O,1),!0}):n==="file-annotation-ref"&&(C.includes("block-ref")||C.includes("a"))?C.find((N,O)=>{if(N==="block-ref"||N==="a")return C.splice(O,1),!0}):n==="inline-memo"&&C.includes("inline-math")?(C.find((N,O)=>{if(N==="inline-math")return C.splice(O,1),!0}),A.querySelector(".katex")&&(A.textContent=A.getAttribute("data-content"))):n==="inline-math"&&C.includes("inline-memo")&&C.find((N,O)=>{if(N==="inline-memo")return C.splice(O,1),!0}),C=[...new Set(C)],$===0&&d&&d.nodeType!==3&&je(C,(d.getAttribute("data-type")||"").split(" "))&&Ll(A,d,i))f=d.textContent.length,d.innerHTML=d.innerHTML+A.innerHTML;else if($===y.childNodes.length-1&&c&&c.nodeType!==3&&je(C,(c.getAttribute("data-type")||"").split(" "))&&Ll(A,c,i))g=A.textContent.length,c.innerHTML=A.innerHTML+c.innerHTML;else if(A.tagName!=="BR"&&A.tagName!=="IMG")if(A.setAttribute("data-type",C.join(" ")),Qh(A,i),C.includes("text")&&!A.getAttribute("style"))if(C.length===1){const N=document.createTextNode(A.textContent);x.push(N)}else C.splice(C.indexOf("text"),1),A.setAttribute("data-type",C.join(" ")),x.push(A);else x.push(A);else x.push(A)}M&&x.push(document.createTextNode(M))})}if(this.range.startContainer.nodeType!==3&&this.range.startContainer.tagName==="SPAN"&&this.range.startContainer.isSameNode(this.range.endContainer)&&!h){const A=this.range.startContainer,$=document.createElement("span"),M=A.attributes;for(let N=0;N<M.length;N++)$.setAttribute(M[N].name,M[N].value);this.range.setEnd(A.lastChild,A.lastChild.textContent.length),$.append(this.range.extractContents()),A.after($);const C=A.getAttribute("data-type").split(" ");C.includes("code")||C.includes("tag")||C.includes("kbd")?($.insertAdjacentText("beforebegin",u.ZWSP+u.ZWSP),$.insertAdjacentText("afterbegin",u.ZWSP),this.range.setStart($.previousSibling,1)):this.range.setStartBefore($),this.range.collapse(!0)}for(let A=0;A<x.length;A++){const $=x[A],M=x[A+1],C=$.nodeType!==3&&$.getAttribute("data-type")||"";if($.nodeType!==3&&M&&M.nodeType!==3&&M.tagName===$.tagName&&$.tagName!=="BR"&&je((M.getAttribute("data-type")||"").split(" "),C.split(" "))&&$.getAttribute("data-id")===M.getAttribute("data-id")&&$.getAttribute("data-subtype")===M.getAttribute("data-subtype")&&$.style.color===M.style.color&&$.style.webkitTextFillColor===M.style.webkitTextFillColor&&$.style.webkitTextStroke===M.style.webkitTextStroke&&$.style.textShadow===M.style.textShadow&&$.style.fontSize===M.style.fontSize&&$.style.backgroundColor===M.style.backgroundColor)C.indexOf("inline-math")>-1?M.setAttribute("data-content",$.getAttribute("data-content")+M.getAttribute("data-content")):(M.innerHTML=$.innerHTML+M.innerHTML,C.indexOf("inline-memo")>-1&&M.setAttribute("data-inline-memo-content",($.getAttribute("data-inline-memo-content")||"")+(M.getAttribute("data-inline-memo-content")||""))),x.splice(A,1),A--;else{if(this.range.insertNode($),$.nodeType===1&&["code","tag","kbd"].includes(n)){const N=At($);(!N||N.textContent.endsWith(`
`))&&$.before(document.createTextNode(u.ZWSP)),$.textContent.startsWith(u.ZWSP)||($.textContent=u.ZWSP+$.textContent);const O=Oe($);(!O||O&&(O.nodeType!==3||O.nodeType===3&&!O.textContent.startsWith(u.ZWSP)))&&$.after(document.createTextNode(u.ZWSP))}else if($.nodeType===3&&["code","tag","kbd","clear"].includes(n)){const N=At($);let O=!1;if(N)if(N.nodeType===1){const oe=N.dataset.type.split(" ");(oe.includes("code")||oe.includes("tag")||oe.includes("kbd"))&&(O=!0)}else N.textContent.endsWith(u.ZWSP)&&(N.textContent=N.textContent.substring(0,N.textContent.length-1));const te=Oe($);let ne=!1;if(te)if(te.nodeType===1){const oe=te.dataset.type.split(" ");(oe.includes("code")||oe.includes("tag")||oe.includes("kbd"))&&(ne=!0)}else te.textContent.startsWith(u.ZWSP)&&(te.textContent=te.textContent.substring(1));$&&(O?$.textContent.startsWith(u.ZWSP)||($.textContent=u.ZWSP+$.textContent):$.textContent.startsWith(u.ZWSP)&&($.textContent=$.textContent.substring(1)),ne?te.textContent.startsWith(u.ZWSP)||(te.textContent=u.ZWSP+te.textContent):$.textContent.endsWith(u.ZWSP)&&($.textContent=$.textContent.substring(0,$.textContent.length-1)))}this.range.collapse(!1)}}if(d&&(d.nodeType!==3&&d.textContent===u.ZWSP?d.remove():this.mergeNode(d.childNodes)),c&&this.mergeNode(c.childNodes),f?this.range.setStart(d.firstChild,f):x.length>0?x[0].nodeType!==3&&x[0].getAttribute("data-type")==="inline-math"||(x[0].firstChild?x[0].firstChild.textContent===u.ZWSP?this.range.setStart(x[0].firstChild,1):this.range.setStart(x[0].firstChild,0):x[0].nodeType===3?this.range.setStart(x[0],0):this.range.setStartBefore(x[0])):c&&this.range.setStart(c.firstChild,0),g)this.range.setEnd(c.lastChild,g);else if(x.length>0){const A=x[x.length-1];if(A.nodeType!==3&&A.getAttribute("data-type").indexOf("inline-math")>-1){const $=At(A);$&&$.nodeType===3?this.range.setStart($,$.textContent.length):this.range.setStartBefore(A);const M=Oe(A);M&&M.nodeType===3?this.range.setEnd(M,0):this.range.setEndAfter(A)}else A.lastChild?A.lastChild.textContent===u.ZWSP?this.range.collapse(!0):this.range.setEnd(A.lastChild,A.lastChild.textContent.length):A.nodeType===3?(this.range.setEnd(A,A.textContent.length),A.textContent===u.ZWSP&&this.range.collapse(!1)):this.range.setEndAfter(A)}else d&&this.range.setEnd(d.firstChild,d.firstChild.textContent.length);let S=!0;if(n==="inline-math"){if(Ma(s),r===""){e.toolbar.showRender(e,x[0],void 0,b);return}}else if(n==="inline-memo"){e.toolbar.showRender(e,x[0],x,b);return}else if(n==="block-ref")this.range.collapse(!1);else if(n==="a"){const A=x[0];A.textContent.replace(u.ZWSP,"")===""||!A.getAttribute("data-href")?(S=!1,bc(e,A,!!A.getAttribute("data-href"))):this.range.collapse(!1)}s.setAttribute("updated",Y().format("YYYYMMDDHHmmss")),J(e,s.getAttribute("data-node-id"),s.outerHTML,b);const k=s.querySelector("wbr");k&&k.remove(),S&&Z(this.range)}showRender(e,n,a,i){const s=P(n);if(!s)return;Q(["hint"],e),window.siyuan.menus.menu.remove();const o=s.getAttribute("data-node-id"),l=(n.getAttribute("data-type")||"").split(" "),r=i||s.outerHTML;let d="HTML",c="";const f=l.includes("inline-memo");switch(n.getAttribute("data-subtype")){case"abc":d=window.siyuan.languages.staff;break;case"echarts":d=window.siyuan.languages.chart;break;case"flowchart":d="Flow Chart";break;case"graphviz":d="Graphviz";break;case"mermaid":d="Mermaid";break;case"mindmap":c=`- foo
  - bar
- baz`,d=window.siyuan.languages.mindmap;break;case"plantuml":d="UML";break;case"math":l.includes("NodeMathBlock")?d=window.siyuan.languages.math:d=window.siyuan.languages["inline-math"];break}l.includes("NodeBlockQueryEmbed")?d=window.siyuan.languages.blockEmbed:f&&(d=window.siyuan.languages.memo);const g=this.subElement.querySelector('[data-type="pin"]')?.getAttribute("aria-label")===window.siyuan.languages.unpin,p={};if(g){const _=this.subElement.querySelector(".b3-text-field");p.styleH=_.style.height,p.styleW=_.style.width}else this.subElement.style.width="",this.subElement.style.padding="0";this.subElement.innerHTML=`<div ${g&&this.subElement.firstElementChild.getAttribute("data-drag")==="true"?'data-drag="true"':""}><div class="block__icons block__icons--menu fn__flex" style="border-radius: var(--b3-border-radius-b) var(--b3-border-radius-b) 0 0;">
    <span class="fn__flex-1 resize__move">
        ${d}
    </span>
    <span class="fn__space"></span>
    <button data-type="refresh" class="block__icon block__icon--show b3-tooltips b3-tooltips__nw${g&&!this.subElement.querySelector('[data-type="refresh"]').classList.contains("block__icon--active")?"":" block__icon--active"}${l.includes("NodeBlockQueryEmbed")?" fn__none":""}" aria-label="${window.siyuan.languages.refresh}"><svg><use xlink:href="#iconRefresh"></use></svg></button>
    <span class="fn__space"></span>
    <button data-type="before" class="block__icon block__icon--show b3-tooltips b3-tooltips__nw${e.disabled?" fn__none":""}" aria-label="${window.siyuan.languages["insert-before"]}"><svg><use xlink:href="#iconBefore"></use></svg></button>
    <span class="fn__space${e.disabled?" fn__none":""}"></span>
    <button data-type="after" class="block__icon block__icon--show b3-tooltips b3-tooltips__nw${e.disabled?" fn__none":""}" aria-label="${window.siyuan.languages["insert-after"]}"><svg><use xlink:href="#iconAfter"></use></svg></button>
    <span class="fn__space${e.disabled?" fn__none":""}"></span>
    <button data-type="export" class="block__icon block__icon--show b3-tooltips b3-tooltips__nw" aria-label="${window.siyuan.languages.export} ${window.siyuan.languages.image}"><svg><use xlink:href="#iconImage"></use></svg></button>
    <span class="fn__space"></span>
    <button data-type="pin" class="block__icon block__icon--show b3-tooltips b3-tooltips__nw" aria-label="${g?window.siyuan.languages.unpin:window.siyuan.languages.pin}"><svg><use xlink:href="#icon${g?"Unpin":"Pin"}"></use></svg></button>
    <span class="fn__space"></span>
    <button data-type="close" class="block__icon block__icon--show b3-tooltips b3-tooltips__nw" aria-label="${window.siyuan.languages.close}"><svg style="width: 10px;margin: 0 2px;"><use xlink:href="#iconClose"></use></svg></button>
</div>
<textarea ${e.disabled?" readonly":""} spellcheck="false" class="b3-text-field b3-text-field--text fn__block" placeholder="${c}" style="${W()?"":"width:"+Math.max(480,n.clientWidth*.7)+"px"};max-height:calc(80vh - 44px);min-height: 48px;min-width: 268px;border-radius: 0 0 var(--b3-border-radius-b) var(--b3-border-radius-b);font-family: var(--b3-font-family-code);"></textarea></div>`;const h=()=>{if(y.style.height=y.scrollHeight+"px",W()){ke(this.subElement,0,0);return}if(this.subElement.firstElementChild.getAttribute("data-drag")==="true"){y.getBoundingClientRect().bottom>window.innerHeight&&(this.subElement.style.top=window.innerHeight-this.subElement.clientHeight+"px");return}const _=w.bottom===w.top?w.bottom+26:w.bottom;this.subElement.clientHeight<=window.innerHeight-_||this.subElement.clientHeight<=w.top?l.includes("inline-math")||f?ke(this.subElement,w.left,_,w.height||26):ke(this.subElement,w.left+(w.width-this.subElement.clientWidth)/2,_,w.height||26):ke(this.subElement,w.right,_)},m=this.subElement.querySelector(".block__icons");m.addEventListener("click",_=>{const x=_.target,S=L(x,"b3-tooltips");if(!S){if(_.detail===2){const k=m.querySelector('[data-type="pin"]');k.getAttribute("aria-label")===window.siyuan.languages.unpin?(k.querySelector("svg use").setAttribute("xlink:href","#iconPin"),k.setAttribute("aria-label",window.siyuan.languages.pin)):(k.querySelector("svg use").setAttribute("xlink:href","#iconUnpin"),k.setAttribute("aria-label",window.siyuan.languages.unpin)),_.preventDefault(),_.stopPropagation()}return}switch(_.stopPropagation(),S.getAttribute("data-type")){case"close":this.subElement.querySelector('[data-type="pin"]').setAttribute("aria-label",window.siyuan.languages.pin),Q(["util"],e);break;case"pin":S.getAttribute("aria-label")===window.siyuan.languages.unpin?(S.querySelector("svg use").setAttribute("xlink:href","#iconPin"),S.setAttribute("aria-label",window.siyuan.languages.pin)):(S.querySelector("svg use").setAttribute("xlink:href","#iconUnpin"),S.setAttribute("aria-label",window.siyuan.languages.unpin));break;case"refresh":S.classList.toggle("block__icon--active");break;case"before":_n(e,"beforebegin",o),Q(["util"],e);break;case"after":_n(e,"afterend",o),Q(["util"],e);break;case"export":b();break}});const b=()=>{const _=j(window.siyuan.languages.exporting,0);if(n.getAttribute("data-subtype")==="plantuml"){fetch(n.querySelector("img").getAttribute("src")).then(function(x){return x.blob()}).then(function(x){const S=new FormData;S.append("file",x),S.append("type","image/png"),E("/api/export/exportAsFile",S,k=>{Ht(k.data.file),Ue(_)})});return}setTimeout(()=>{Ct("/stage/protyle/js/html2canvas.min.js?v=1.4.1","protyleHtml2canvas").then(()=>{window.html2canvas(n,{useCORS:!0}).then(x=>{x.toBlob(S=>{const k=new FormData;k.append("file",S),k.append("type","image/png"),E("/api/export/exportAsFile",k,A=>{Ht(A.data.file),Ue(_)})})})})},u.TIMEOUT_LOAD)},y=this.subElement.querySelector(".b3-text-field");l.includes("NodeHTMLBlock")?y.value=Lute.UnEscapeHTMLStr(n.querySelector("protyle-html").getAttribute("data-content")||""):f?y.value=Lute.UnEscapeHTMLStr(n.getAttribute("data-inline-memo-content")||""):y.value=Lute.UnEscapeHTMLStr(n.getAttribute("data-content")||""),y.addEventListener("input",_=>{if(n.parentElement&&(y.clientHeight!==y.scrollHeight&&h(),!!this.subElement.querySelector('[data-type="refresh"]').classList.contains("block__icon--active"))){if(l.includes("NodeHTMLBlock"))n.querySelector("protyle-html").setAttribute("data-content",Lute.EscapeHTMLStr(y.value));else if(f){let x;a?x=a:x=[n],x.forEach(S=>{S.setAttribute("data-inline-memo-content",Lute.EscapeHTMLStr(y.value))})}else n.setAttribute("data-content",Lute.EscapeHTMLStr(y.value)),n.removeAttribute("data-render");(!l.includes("NodeBlockQueryEmbed")||!l.includes("NodeHTMLBlock")||!f)&&yt(n),_.stopPropagation()}}),y.addEventListener("keydown",_=>{if(_.stopPropagation(),H(window.siyuan.config.keymap.editor.insert["inline-math"].custom,_)){_.preventDefault();return}if(!_.isComposing){if(_.key==="Escape"||H("\u2318\u21A9",_))this.subElement.querySelector('[data-type="pin"]').setAttribute("aria-label",window.siyuan.languages.pin),Q(["util"],e);else if(_.key==="Tab")document.execCommand("insertText",!1,"	"),_.preventDefault();else if(ni(_))return}}),this.subElementCloseCB=()=>{if(!n.parentElement||e.disabled)return;let _;if(l.includes("NodeHTMLBlock")){let x=y.value;x&&(x=x.trim().replace(/\n+/g,`
`),x.startsWith("<div>")&&x.endsWith("</div>")||(x=`<div>
${x}
</div>`)),n.querySelector("protyle-html").setAttribute("data-content",Lute.EscapeHTMLStr(x))}else if(f){let x;a?x=a:x=[n],x.forEach((S,k)=>{if(y.value)S.setAttribute("data-inline-memo-content",Lute.EscapeHTMLStr(y.value));else{const A=S.getAttribute("data-type").split(" ");A.length===1&&A[0]==="inline-memo"?S.outerHTML=S.innerHTML+(k===x.length-1?"<wbr>":""):(A.find(($,M)=>{if($==="inline-memo")return A.splice(M,1),!0}),S.setAttribute("data-type",A.join(" ")),S.removeAttribute("data-inline-memo-content")),k===x.length-1&&(_=S)}})}else l.includes("inline-math")?y.value?(n.setAttribute("data-content",Lute.EscapeHTMLStr(y.value)),n.removeAttribute("data-render"),yt(n)):(_=n,n.outerHTML="<wbr>"):(n.setAttribute("data-content",Lute.EscapeHTMLStr(y.value)),n.removeAttribute("data-render"),l.includes("NodeBlockQueryEmbed")?Be(e,n):yt(n));if(getSelection().rangeCount===0||getSelection().rangeCount>0&&L(getSelection().getRangeAt(0).startContainer,"protyle-util")?n.tagName==="SPAN"?_?_.parentElement?(this.range.setStartAfter(_),this.range.collapse(!0),Z(this.range)):he(s,this.range):n.parentElement&&(this.range.setStartAfter(n),this.range.collapse(!0),Z(this.range)):(ae(n),n.classList.add("protyle-wysiwyg--select")):s.querySelector("wbr")?.remove(),s.setAttribute("updated",Y().format("YYYYMMDDHHmmss")),l.includes("NodeHTMLBlock")){const x=document.createElement("template");x.innerHTML=e.lute.SpinBlockDOM(s.outerHTML),x.content.childElementCount>1&&j(window.siyuan.languages.htmlBlockTip)}J(e,o,s.outerHTML,r)},this.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),this.subElement.classList.remove("fn__none");const w=n.getBoundingClientRect();this.element.classList.add("fn__none"),g?(y.style.width=p.styleW,y.style.height=p.styleH):h(),e.disabled||y.select(),e.app.plugins.forEach(_=>{_.eventBus.emit("open-noneditableblock",{protyle:e,toolbar:this,blockElement:s,renderElement:n})})}showCodeLanguage(e,n){const a=P(n);if(!a)return;Q(["hint"],e),window.siyuan.menus.menu.remove(),this.range=me(a);const i=a.getAttribute("data-node-id");let s=a.outerHTML,o=`<div class="b3-list-item">${window.siyuan.languages.clear}</div>`;const l=u.ALIAS_CODE_LANGUAGES.concat(window.hljs?.listLanguages()??[]).sort();l.forEach((f,g)=>{o+=`<div class="b3-list-item${g===0?" b3-list-item--focus":""}">${f}</div>`}),this.subElement.style.width="",this.subElement.style.padding="",this.subElement.innerHTML=`<div class="fn__flex-column" style="max-height:50vh">
    <input placeholder="${window.siyuan.languages.search}" style="margin: 0 8px 4px 8px" class="b3-text-field"/>
    <div class="b3-list fn__flex-1 b3-list--background" style="position: relative">${o}</div>
</div>`;const r=this.subElement.lastElementChild.lastElementChild,d=this.subElement.querySelector("input");d.addEventListener("keydown",f=>{if(f.stopPropagation(),!f.isComposing){if(xn(r,f),f.key==="Enter"){s=this.updateLanguage(n,e,i,a,s,this.subElement.querySelector(".b3-list-item--focus").textContent),f.preventDefault(),f.stopPropagation();return}f.key==="Escape"&&(this.subElement.classList.add("fn__none"),Z(this.range))}}),d.addEventListener("input",f=>{const g=d.value.toLowerCase(),p=l.filter(b=>b.includes(g));let h="",m=!1;p.sort((b,y)=>b.startsWith(g)&&y.startsWith(g)?b.length<y.length?-1:b.length===y.length?0:1:b.startsWith(g)?-1:y.startsWith(g)?1:0).forEach(b=>{d.value===b&&(m=!0),h+=`<div class="b3-list-item">${b.replace(g,"<b>"+g+"</b>")}</div>`}),d.value.trim()&&!m&&(h=`<div class="b3-list-item"><b>${pe(d.value.replace(/`| /g,"_"))}</b></div>${h}`),h=`<div class="b3-list-item">${window.siyuan.languages.clear}</div>`+h,r.innerHTML=h,r.firstElementChild.nextElementSibling?r.firstElementChild.nextElementSibling.classList.add("b3-list-item--focus"):r.firstElementChild.classList.add("b3-list-item--focus"),f.stopPropagation()}),r.addEventListener("click",f=>{const g=f.target,p=L(g,"b3-list-item");p&&(s=this.updateLanguage(n,e,i,a,s,p.textContent))}),this.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),this.subElement.classList.remove("fn__none"),this.subElementCloseCB=void 0;const c=n.getBoundingClientRect();ke(this.subElement,c.left,c.bottom,c.height),this.element.classList.add("fn__none"),d.select()}showTpl(e,n,a){this.range=a,Q(["hint"],e),window.siyuan.menus.menu.remove(),this.subElement.style.width="",this.subElement.style.padding="",this.subElement.innerHTML=`<div style="max-height:50vh" class="fn__flex">
<div class="fn__flex-column" style="${W()?"width: 100%":"width: 256px"}">
    <div class="fn__flex" style="margin: 0 8px 4px 8px">
        <input class="b3-text-field fn__flex-1"/>
        <span class="fn__space"></span>
        <span data-type="previous" class="block__icon block__icon--show"><svg><use xlink:href="#iconLeft"></use></svg></span>
        <span class="fn__space"></span>
        <span data-type="next" class="block__icon block__icon--show"><svg><use xlink:href="#iconRight"></use></svg></span>
    </div>
    <div class="b3-list fn__flex-1 b3-list--background" style="position: relative"><img style="margin: 0 auto;display: block;width: 64px;height: 64px" src="/stage/loading-pure.svg"></div>
</div>
<div class="toolbarResize" style="    cursor: col-resize;
    box-shadow: 2px 0 0 0 var(--b3-theme-surface) inset, 3px 0 0 0 var(--b3-border-color) inset;
    width: 5px;
    margin-left: -2px;"></div>
<div style="width: 520px;${W()||window.outerWidth<window.outerWidth/2+520?"display:none;":""}overflow: auto;"></div>
</div>`;const i=this.subElement.querySelector(".b3-list");xf(this.subElement.querySelector(".toolbarResize"),i.parentElement);const s=this.subElement.firstElementChild.lastElementChild;let o;i.addEventListener("mouseover",r=>{const d=r.target,c=L(d,"b3-list-item");if(!c)return;const f=c.getAttribute("data-value");o!==f&&(o=f,xl(o,s,e.block.parentID),r.stopPropagation())});const l=this.subElement.querySelector("input");l.addEventListener("keydown",r=>{if(r.stopPropagation(),r.isComposing)return;const d=!this.subElement.querySelector(".b3-list-item");if(!d){const c=xn(i,r);if(c){const f=c.getAttribute("data-value");if(o===f)return;o=f,xl(o,s,e.block.parentID)}}r.key==="Enter"?(d?Z(this.range):L_(decodeURIComponent(this.subElement.querySelector(".b3-list-item--focus").getAttribute("data-value")),e,n),this.subElement.classList.add("fn__none"),r.preventDefault()):r.key==="Escape"&&(this.subElement.classList.add("fn__none"),Z(this.range))}),l.addEventListener("input",r=>{r.stopPropagation(),E("/api/search/searchTemplate",{k:l.value},d=>{let c="";d.data.blocks.forEach((g,p)=>{c+=`<div data-value="${g.path}" class="b3-list-item${p===0?" b3-list-item--focus":""}">${g.content}</div>`}),i.innerHTML=c||`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;const f=d.data.blocks[0]?.path;o!==f&&(o=f,xl(o,s,e.block.parentID))})}),this.subElement.lastElementChild.addEventListener("click",r=>{const d=r.target;if(d.classList.contains("b3-list--empty")){this.subElement.classList.add("fn__none"),Z(this.range),r.stopPropagation();return}const c=L(d,"b3-list-item__action");if(c&&c.getAttribute("data-type")==="open"){ea(c.parentElement.getAttribute("data-value"),"folder"),r.stopPropagation();return}if(c&&c.getAttribute("data-type")==="remove"){xe(window.siyuan.languages.remove,window.siyuan.languages.confirmDelete+"?",()=>{E("/api/search/removeTemplate",{path:c.parentElement.getAttribute("data-value")},()=>{if(c.parentElement.parentElement.childElementCount===1)c.parentElement.parentElement.innerHTML=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`,xl("",s,e.block.parentID);else{if(c.parentElement.classList.contains("b3-list-item--focus")){const h=c.parentElement.previousElementSibling||c.parentElement.nextElementSibling;h.classList.add("b3-list-item--focus");const m=h.getAttribute("data-value");if(o===m)return;o=m,xl(o,s,e.block.parentID)}c.parentElement.remove()}})}),r.stopPropagation();return}if(B(d,"data-type","previous")){l.dispatchEvent(new KeyboardEvent("keydown",{key:"ArrowUp"})),r.stopPropagation();return}if(B(d,"data-type","next")){l.dispatchEvent(new KeyboardEvent("keydown",{key:"ArrowDown"})),r.stopPropagation();return}const p=L(d,"b3-list-item");p&&(L_(decodeURIComponent(p.getAttribute("data-value")),e,n),r.stopPropagation())}),this.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),this.subElement.classList.remove("fn__none"),this.subElementCloseCB=void 0,this.element.classList.add("fn__none"),l.select(),E("/api/search/searchTemplate",{k:""},r=>{let d="";r.data.blocks.forEach((f,g)=>{d+=`<div data-value="${f.path}" class="b3-list-item--hide-action b3-list-item${g===0?" b3-list-item--focus":""}">
<span class="b3-list-item__text">${f.content}</span>`,d+=`<span data-type="open" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.showInFolder}">
    <svg><use xlink:href="#iconFolder"></use></svg>
</span>`,d+=`<span data-type="remove" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.remove}">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
</span></div>`}),this.subElement.querySelector(".b3-list--background").innerHTML=d||`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;const c=ta(n,a);ke(this.subElement,c.left,c.top+18,u.SIZE_TOOLBAR_HEIGHT),this.subElement.firstElementChild.style.maxHeight=Math.min(window.innerHeight*.8,window.innerHeight-this.subElement.getBoundingClientRect().top)-16+"px",o=i.firstElementChild.getAttribute("data-value"),xl(o,s,e.block.parentID)})}showWidget(e,n,a){this.range=a,Q(["hint"],e),window.siyuan.menus.menu.remove(),this.subElement.style.width="",this.subElement.style.padding="",this.subElement.innerHTML=`<div class="fn__flex-column" style="max-height:50vh">
    <input style="margin: 0 8px 4px 8px" class="b3-text-field"/>
    <div class="b3-list fn__flex-1 b3-list--background" style="position: relative"><img style="margin: 0 auto;display: block;width: 64px;height:64px" src="/stage/loading-pure.svg"></div>
</div>`;const i=this.subElement.lastElementChild.lastElementChild,s=this.subElement.querySelector("input");s.addEventListener("keydown",o=>{o.stopPropagation(),!o.isComposing&&(xn(i,o),o.key==="Enter"?(x_(this.subElement.querySelector(".b3-list-item--focus").getAttribute("data-content"),e),this.subElement.classList.add("fn__none"),o.preventDefault()):o.key==="Escape"&&(this.subElement.classList.add("fn__none"),Z(this.range)))}),s.addEventListener("input",o=>{o.stopPropagation(),E("/api/search/searchWidget",{k:s.value},l=>{let r="";l.data.blocks.forEach((d,c)=>{r+=`<div data-value="${d.path}" data-content="${d.content}" class="b3-list-item${c===0?" b3-list-item--focus":""}">
    ${d.name}
    <span class="b3-list-item__meta">${d.content}</span>
</div>`}),i.innerHTML=r})}),this.subElement.lastElementChild.addEventListener("click",o=>{const l=o.target,r=L(l,"b3-list-item");r&&x_(r.dataset.content,e)}),this.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),this.subElement.classList.remove("fn__none"),this.subElementCloseCB=void 0,this.element.classList.add("fn__none"),s.select(),E("/api/search/searchWidget",{k:""},o=>{let l="";o.data.blocks.forEach((d,c)=>{l+=`<div class="b3-list-item${c===0?" b3-list-item--focus":""}" data-content="${d.content}">
${d.name}
<span class="b3-list-item__meta">${d.content}</span>
</div>`}),this.subElement.querySelector(".b3-list--background").innerHTML=l;const r=ta(n,a);ke(this.subElement,r.left,r.top+18,u.SIZE_TOOLBAR_HEIGHT)})}showContent(e,n,a){this.range=n,Q(["hint"],e),this.subElement.style.width="auto",this.subElement.style.padding="0 8px";let i="";const s=n.toString()!==""||n.cloneContents().childNodes[0]?.classList?.contains("emoji");s&&(i+='<button class="keyboard__action" data-action="copy"><svg><use xlink:href="#iconCopy"></use></svg></button>',e.disabled||(i+=`<button class="keyboard__action" data-action="cut"><svg><use xlink:href="#iconCut"></use></svg></button>
<button class="keyboard__action" data-action="delete"><svg><use xlink:href="#iconTrashcan"></use></svg></button>`)),e.disabled||(i+=`<button class="keyboard__action" data-action="paste"><svg><use xlink:href="#iconPaste"></use></svg></button>
<button class="keyboard__action" data-action="select"><svg><use xlink:href="#iconSelect"></use></svg></button>`),(s||!e.disabled)&&(i+='<button class="keyboard__action" data-action="more"><svg><use xlink:href="#iconMore"></use></svg></button>'),this.subElement.innerHTML=`<div class="fn__flex">${i}</div>`,this.subElement.lastElementChild.addEventListener("click",async l=>{const r=L(l.target,"keyboard__action");if(!r)return;const d=r.getAttribute("data-action");if(d==="copy")Z(me(a)),document.execCommand("copy"),this.subElement.classList.add("fn__none");else if(d==="cut")Z(me(a)),document.execCommand("cut"),this.subElement.classList.add("fn__none");else if(d==="delete"){const c=me(a);c.insertNode(document.createElement("wbr"));const f=a.outerHTML;c.extractContents(),he(a,c),Z(c),J(e,a.getAttribute("data-node-id"),a.outerHTML,f),this.subElement.classList.add("fn__none")}else if(d==="paste"){if(document.queryCommandSupported("paste"))document.execCommand("paste");else try{const c=await ef();wl(e,Object.assign(c,{target:a}))}catch(c){console.log(c)}this.subElement.classList.add("fn__none")}else d==="select"?(Lp(e,a,n),this.subElement.classList.add("fn__none")):d==="copyPlainText"?(Z(me(a)),Zi(getSelection().getRangeAt(0).toString()),this.subElement.classList.add("fn__none")):d==="pasteAsPlainText"?(Z(me(a)),Mh(e),this.subElement.classList.add("fn__none")):d==="pasteEscaped"?(Tw(e,a),this.subElement.classList.add("fn__none")):d==="back"?this.subElement.lastElementChild.innerHTML=i:d==="more"&&(this.subElement.lastElementChild.innerHTML=`<button class="keyboard__action${s?"":" fn__none"}" data-action="copyPlainText"><span>${window.siyuan.languages.copyPlainText}</span></button>
<div class="keyboard__split${s?"":" fn__none"}"></div>
<button class="keyboard__action${e.disabled?" fn__none":""}" data-action="pasteAsPlainText"><span>${window.siyuan.languages.pasteAsPlainText}</span></button>
<div class="keyboard__split${e.disabled?" fn__none":""}"></div>
<button class="keyboard__action${e.disabled?" fn__none":""}" data-action="pasteEscaped"><span>${window.siyuan.languages.pasteEscaped}</span></button>
<div class="keyboard__split${e.disabled?" fn__none":""}"></div>
<button class="keyboard__action" data-action="back"><svg><use xlink:href="#iconBack"></use></svg></button>`,ke(this.subElement,o.left,o.top+28,u.SIZE_TOOLBAR_HEIGHT))}),this.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),this.subElement.classList.remove("fn__none"),this.subElementCloseCB=void 0,this.element.classList.add("fn__none");const o=ta(a,n);ke(this.subElement,o.left,o.top-48,u.SIZE_TOOLBAR_HEIGHT)}genItem(e,n){let a;switch(n.name){case"strong":case"em":case"s":case"code":case"mark":case"tag":case"u":case"sup":case"clear":case"sub":case"kbd":a=new ro(e,n);break;case"block-ref":a=new LT(e,n);break;case"inline-math":a=new xT(e,n);break;case"inline-memo":a=new AT(e,n);break;case"|":a=new kT;break;case"text":a=new zL(e,n);break;case"a":a=new ST(e,n);break;default:a=new ro(e,n);break}if(a)return a.element}mergeNode(e){for(let n=0;n<e.length;n++)e[n].nodeType!==3&&e[n].tagName==="WBR"&&(e[n].remove(),n--);for(let n=0;n<e.length;n++)e[n].nodeType===3&&(e[n].textContent===""?(e[n].remove(),n--):e[n+1]&&e[n+1].nodeType===3&&(e[n].textContent=e[n].textContent+e[n+1].textContent,e[n+1].remove(),n--))}updateLanguage(e,n,a,i,s,o){e.textContent=o===window.siyuan.languages.clear?"":o,u.SIYUAN_RENDER_CODE_LANGUAGES.includes(e.textContent)||(window.siyuan.storage[u.LOCAL_CODELANG]=e.textContent,ue(u.LOCAL_CODELANG,window.siyuan.storage[u.LOCAL_CODELANG]));const l=le(i);return u.SIYUAN_RENDER_CODE_LANGUAGES.includes(e.textContent)?(i.dataset.content=l.textContent.trim(),i.dataset.subtype=e.textContent,i.className="render-node",i.innerHTML=`<div spin="1"></div><div class="protyle-attr" contenteditable="false">${u.ZWSP}</div>`,yt(i)):(l.textContent=l.textContent,l.parentElement.removeAttribute("data-render"),ze(i)),i.setAttribute("updated",Y().format("YYYYMMDDHHmmss")),J(n,a,i.outerHTML,s),this.subElement.classList.add("fn__none"),Z(this.range),i.outerHTML}}const jE=t=>{window.siyuan.menus.menu.append(new T({id:"transferBlockRef",label:window.siyuan.languages.transferBlockRef,icon:"iconScrollHoriz",click(){const e=new we({title:window.siyuan.languages.transferBlockRef,content:`<div class="b3-dialog__content">
    <input class="b3-text-field fn__block" placeholder="${window.siyuan.languages.targetBlockID}">
    <div class="b3-label__text">${window.siyuan.languages.transferBlockRefTip}</div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:W()?"92vw":"520px"});e.element.setAttribute("data-key",u.DIALOG_TRANSFERBLOCKREF);const n=e.element.querySelector("input"),a=e.element.querySelectorAll(".b3-button");e.bindInput(n,()=>{a[1].click()}),n.focus(),a[0].addEventListener("click",()=>{e.destroy()}),a[1].addEventListener("click",()=>{E("/api/block/transferBlockRef",{fromID:t,toID:n.value}),e.destroy()})}}).element)};class TT{constructor(e){gt()?this.gutterTip=window.siyuan.languages.gutterTip.replace("\u2325\u2192",X(window.siyuan.config.keymap.general.enter.custom)):this.gutterTip=window.siyuan.languages.gutterTip.replace("\u2325\u2192",X(window.siyuan.config.keymap.general.enter.custom)).replace("\u2318\u2191",X(window.siyuan.config.keymap.editor.general.collapse.custom)).replace("\u2325\u2318A",X(window.siyuan.config.keymap.editor.general.attr.custom)).replace(/⌘/g,"Ctrl+").replace(/⌥/g,"Alt+").replace(/⇧/g,"Shift+").replace(/⌃/g,"Ctrl+"),e.options.backlinkData&&(this.gutterTip=this.gutterTip.replace(window.siyuan.languages.enter,window.siyuan.languages.openBy)),this.element=document.createElement("div"),this.element.className="protyle-gutters",this.element.addEventListener("dragstart",n=>{Zt(),window.siyuan.menus.menu.remove();const a=n.target.parentElement;let i=[],s=[],o;if(a.dataset.rowId){o=Array.from(e.wysiwyg.element.querySelectorAll(`.av[data-node-id="${a.dataset.nodeId}"]`)).find(d=>{if(!F(d))return!0});const r=o.querySelector(`.av__row[data-id="${a.dataset.rowId}"]`);r.classList.add("av__row--select"),r.querySelector(".av__firstcol use").setAttribute("xlink:href","#iconCheck"),as(r),o.querySelectorAll(".av__row--select:not(.av__row--header)").forEach(d=>{i.push(d.getAttribute("data-id")),s.push(d)})}else{const r=a.getAttribute("data-node-id");s=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));let d=!1;if(s.forEach(c=>{const f=c.getAttribute("data-node-id");f===r&&(d=!0),i.push(f)}),!d){let c;Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${r}"]`)).find(f=>{if(!F(f)&&this.isMatchNode(f))return c=f,!0}),c&&(s.forEach(f=>{f.classList.remove("protyle-wysiwyg--select")}),c.classList.add("protyle-wysiwyg--select"),s=[c],i=[r])}}const l=document.createElement("div");l.className=e.wysiwyg.element.className,s.forEach(r=>{if(r.querySelector("iframe")){const d=r.getAttribute("data-type"),c=pa();c.classList.add("protyle-wysiwyg--select"),le(c).innerHTML=`<svg class="svg"><use xlink:href="${a.querySelector("use").getAttribute("xlink:href")}"></use></svg> ${lx(d)}`,l.append(c)}else l.append(Xa(r.cloneNode(!0)))}),l.setAttribute("style",`position:fixed;opacity:.1;width:${s[0].clientWidth}px;padding:0;`),document.body.append(l),n.dataTransfer.setDragImage(l,0,0),setTimeout(()=>{l.remove()}),a.style.opacity="0.1",window.siyuan.dragElement=o||e.wysiwyg.element,n.dataTransfer.setData(`${u.SIYUAN_DROP_GUTTER}${a.getAttribute("data-type")}${u.ZWSP}${a.getAttribute("data-subtype")}${u.ZWSP}${i}${u.ZWSP}${window.siyuan.config.system.workspaceDir}`,e.wysiwyg.element.innerHTML)}),this.element.addEventListener("dragend",()=>{this.element.querySelectorAll("button").forEach(n=>{n.style.opacity=""}),window.siyuan.dragElement=void 0}),this.element.addEventListener("click",n=>{const a=q(n.target,"BUTTON");if(!a)return;n.preventDefault(),n.stopPropagation(),Zt();const i=a.getAttribute("data-node-id");if(!i){if(a.getAttribute("disabled"))return;a.setAttribute("disabled","disabled");let o;if(Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${(a.previousElementSibling||a.nextElementSibling).getAttribute("data-node-id")}"]`)).find(l=>{if(!F(l)&&this.isMatchNode(l))return o=l,!0}),!o)return;if(n.altKey){let l=!0;Array.from(o.children).find(c=>{if(c.classList.contains("list")&&Array.from(c.children).find(g=>{if(g.classList.contains("li")&&g.getAttribute("fold")!=="1"&&g.childElementCount>3)return l=!1,!0}))return!0});const r=[],d=[];Array.from(o.children).forEach(c=>{c.classList.contains("list")&&Array.from(c.children).forEach(f=>{if(f.classList.contains("li")){l?f.removeAttribute("fold"):f.childElementCount>3&&f.setAttribute("fold","1");const g=f.getAttribute("data-node-id");r.push({action:"setAttrs",id:g,data:JSON.stringify({fold:l?"":"1"})}),d.push({action:"setAttrs",id:g,data:JSON.stringify({fold:l?"1":""})})}})}),U(e,r,d),a.removeAttribute("disabled")}else{const l=an(e,o);l===1?a.firstElementChild.style.transform="":l===0&&(a.firstElementChild.style.transform="rotate(90deg)")}Q(["select"],e),window.siyuan.menus.menu.remove();return}const s=a.getBoundingClientRect();if(a.dataset.type==="NodeAttributeViewRowMenu"||a.dataset.type==="NodeAttributeViewRow"){const o=Array.from(e.wysiwyg.element.querySelectorAll(`.av[data-node-id="${a.dataset.nodeId}"] .av__row[data-id="${a.dataset.rowId}"]`)).find(r=>{if(!F(r))return!0});if(!o)return;const l=P(o);if(!l)return;if(a.dataset.type==="NodeAttributeViewRow"){l.querySelectorAll(".av__cell--select, .av__cell--active").forEach(g=>{g.classList.remove("av__cell--select","av__cell--active"),g.querySelector(".av__drag-fill")?.remove()});const r=l.getAttribute("data-av-id"),d=[Lute.NewNodeID()],c=n.altKey?o.previousElementSibling.getAttribute("data-id")||"":a.dataset.rowId,f=Y().format("YYYYMMDDHHmmss");U(e,[{action:"insertAttrViewBlock",avID:r,previousID:c,srcs:[{id:d[0],isDetached:!0,content:""}],blockID:i},{action:"doUpdateUpdated",id:i,data:f}],[{action:"removeAttrViewBlock",srcIDs:d,avID:r},{action:"doUpdateUpdated",id:i,data:l.getAttribute("updated")}]),Yf(e,l,d,c,r),n.altKey&&this.element.querySelectorAll("button").forEach(g=>{g.dataset.rowId=d[0]}),l.setAttribute("updated",f)}else{if(!e.disabled&&n.shiftKey){const r=o.querySelector('[data-dtype="block"] .av__celltext--ref')?.getAttribute("data-id");if(r){E("/api/attr/getBlockAttrs",{id:r},d=>{Gn(d.data,"av",e)});return}}Zf(e,o,{x:s.left,y:s.bottom,w:s.width,h:s.height,isLeft:!0})}return}if(Dt(n))e.options.backlinkData?Ke(i,(o,l)=>{de({app:e.app,id:i,action:l,zoomIn:o})}):Vt({protyle:e,id:i});else if(n.altKey){let o;if(Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${i}"]`)).find(l=>{if(!F(l)&&this.isMatchNode(l))return o=l,!0}),!o)return;if(a.getAttribute("data-type")==="NodeListItem"&&o.parentElement.getAttribute("data-node-id")){let l=!0;Array.from(o.parentElement.children).find(c=>{if(c.classList.contains("li")&&c.getAttribute("fold")!=="1"&&c.childElementCount>3)return l=!1,!0}),a.parentElement.querySelector("[data-type='fold'] > svg").style.transform=l?"rotate(90deg)":"";const r=[],d=[];Array.from(o.parentElement.children).find(c=>{if(c.classList.contains("li")){l?c.removeAttribute("fold"):c.childElementCount>3&&c.setAttribute("fold","1");const f=c.getAttribute("data-node-id");r.push({action:"setAttrs",id:f,data:JSON.stringify({fold:l?"":"1"})}),d.push({action:"setAttrs",id:f,data:JSON.stringify({fold:l?"1":""})})}}),U(e,r,d)}else{const l=an(e,o),r=a.parentElement.querySelector("[data-type='fold'] > svg");l!==-1&&r&&(r.style.transform=l===0?"rotate(90deg)":"")}o.classList.remove("protyle-wysiwyg--hl")}else if(window.siyuan.shiftIsPressed&&!e.disabled)Ti(e.wysiwyg.element.querySelector(`[data-node-id="${i}"]`),"bookmark",e);else if(!window.siyuan.ctrlIsPressed&&!window.siyuan.altIsPressed&&!window.siyuan.shiftIsPressed){this.renderMenu(e,a),e.toolbar.range||(e.toolbar.range=me(e.wysiwyg.element.querySelector(`[data-node-id="${i}"]`)||e.wysiwyg.element.firstElementChild)),window.siyuan.menus.menu.popup({x:s.left,y:s.bottom,isLeft:!0});const o=Le(e.element,"block__popover",!0);window.siyuan.menus.menu.element.setAttribute("data-from",o?o.dataset.level+"popover":"app"),Z(e.toolbar.range)}}),this.element.addEventListener("contextmenu",n=>{const a=q(n.target,"BUTTON");if(!(!a||a.getAttribute("data-type")==="fold")){if(!window.siyuan.ctrlIsPressed&&!window.siyuan.altIsPressed&&!window.siyuan.shiftIsPressed){Zt();const i=a.getBoundingClientRect();if(a.dataset.type==="NodeAttributeViewRowMenu"){const s=Array.from(e.wysiwyg.element.querySelectorAll(`.av[data-node-id="${a.dataset.nodeId}"] .av__row[data-id="${a.dataset.rowId}"]`)).find(o=>{if(!F(o))return!0});s&&Zf(e,s,{x:i.left,y:i.bottom,w:i.width,h:i.height,isLeft:!0})}else if(a.dataset.type!=="NodeAttributeViewRow"){this.renderMenu(e,a),e.toolbar.range||(e.toolbar.range=me(e.wysiwyg.element.querySelector(`[data-node-id="${a.getAttribute("data-node-id")}"]`)||e.wysiwyg.element.firstElementChild)),window.siyuan.menus.menu.popup({x:i.left,y:i.bottom,isLeft:!0});const s=Le(e.element,"block__popover",!0);window.siyuan.menus.menu.element.setAttribute("data-from",s?s.dataset.level+"popover":"app"),Z(e.toolbar.range)}}n.preventDefault(),n.stopPropagation()}}),this.element.addEventListener("mouseleave",n=>{Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl, .av__row--hl")).forEach(a=>{a.classList.remove("protyle-wysiwyg--hl","av__row--hl")}),n.preventDefault(),n.stopPropagation()}),this.element.addEventListener("mousewheel",n=>{Q(["gutter"],e),n.stopPropagation()},{passive:!0})}isMatchNode(e){const n=e.getBoundingClientRect();let a=this.element.getBoundingClientRect().top+6;return n.height<Math.floor(window.siyuan.config.editor.fontSize*1.625)+8&&(a=a-(n.height-this.element.clientHeight)/2),n.top<=a&&n.bottom>=a}turnsOneInto(e){return{id:e.menuId,icon:e.icon,label:e.label,accelerator:e.accelerator,click(){Hl(e)}}}turnsIntoOne(e){return{id:e.menuId,icon:e.icon,label:e.label,accelerator:e.accelerator,click(){Dn(e)}}}turnsInto(e){return{id:e.menuId,icon:e.icon,label:e.label,accelerator:e.accelerator,click(){Ba(e)}}}showMobileAppearance(e){const n=document.getElementById("keyboardToolbar"),a=n.querySelectorAll("#keyboardToolbar .keyboard__dynamic");a[0].classList.add("fn__none"),a[1].classList.remove("fn__none"),n.querySelector('.keyboard__action[data-type="text"]').classList.add("protyle-toolbar__item--current"),n.querySelector('.keyboard__action[data-type="done"] use').setAttribute("xlink:href","#iconCloseRound"),n.classList.remove("fn__none");const i=e.contentElement.scrollTop+333.5;f_(e,n),em(i)}renderMultipleMenu(e,n){let a=!1,i=!1,s=!1;if(n.find((c,f)=>{if(c.classList.contains("li"))return a=!0,!0;if((c.classList.contains("sb")||c.classList.contains("p"))&&(s=!0),c.nextElementSibling&&n[f+1]&&c.nextElementSibling.isSameNode(n[f+1]))i=!0;else if(f!==n.length-1)return i=!1,!0}),!a&&!e.disabled){const c=[];i&&(c.push(this.turnsIntoOne({menuId:"list",icon:"iconList",label:window.siyuan.languages.list,protyle:e,accelerator:window.siyuan.config.keymap.editor.insert.list.custom,selectsElement:n,type:"Blocks2ULs"})),c.push(this.turnsIntoOne({menuId:"orderedList",icon:"iconOrderedList",label:window.siyuan.languages["ordered-list"],accelerator:window.siyuan.config.keymap.editor.insert["ordered-list"].custom,protyle:e,selectsElement:n,type:"Blocks2OLs"})),c.push(this.turnsIntoOne({menuId:"check",icon:"iconCheck",label:window.siyuan.languages.check,accelerator:window.siyuan.config.keymap.editor.insert.check.custom,protyle:e,selectsElement:n,type:"Blocks2TLs"})),c.push(this.turnsIntoOne({menuId:"quote",icon:"iconQuote",label:window.siyuan.languages.quote,accelerator:window.siyuan.config.keymap.editor.insert.quote.custom,protyle:e,selectsElement:n,type:"Blocks2Blockquote"}))),s||c.push(this.turnsInto({menuId:"paragraph",icon:"iconParagraph",label:window.siyuan.languages.paragraph,accelerator:window.siyuan.config.keymap.editor.heading.paragraph.custom,protyle:e,selectsElement:n,type:"Blocks2Ps",isContinue:i})),c.push(this.turnsInto({menuId:"heading1",icon:"iconH1",label:window.siyuan.languages.heading1,accelerator:window.siyuan.config.keymap.editor.heading.heading1.custom,protyle:e,selectsElement:n,level:1,type:"Blocks2Hs",isContinue:i})),c.push(this.turnsInto({menuId:"heading2",icon:"iconH2",label:window.siyuan.languages.heading2,accelerator:window.siyuan.config.keymap.editor.heading.heading2.custom,protyle:e,selectsElement:n,level:2,type:"Blocks2Hs",isContinue:i})),c.push(this.turnsInto({menuId:"heading3",icon:"iconH3",label:window.siyuan.languages.heading3,accelerator:window.siyuan.config.keymap.editor.heading.heading3.custom,protyle:e,selectsElement:n,level:3,type:"Blocks2Hs",isContinue:i})),c.push(this.turnsInto({menuId:"heading4",icon:"iconH4",label:window.siyuan.languages.heading4,accelerator:window.siyuan.config.keymap.editor.heading.heading4.custom,protyle:e,selectsElement:n,level:4,type:"Blocks2Hs",isContinue:i})),c.push(this.turnsInto({menuId:"heading5",icon:"iconH5",label:window.siyuan.languages.heading5,accelerator:window.siyuan.config.keymap.editor.heading.heading5.custom,protyle:e,selectsElement:n,level:5,type:"Blocks2Hs",isContinue:i})),c.push(this.turnsInto({menuId:"heading6",icon:"iconH6",label:window.siyuan.languages.heading6,accelerator:window.siyuan.config.keymap.editor.heading.heading6.custom,protyle:e,selectsElement:n,level:6,type:"Blocks2Hs",isContinue:i})),window.siyuan.menus.menu.append(new T({id:"turnInto",icon:"iconRefresh",label:window.siyuan.languages.turnInto,type:"submenu",submenu:c}).element),i&&!(n[0].parentElement.classList.contains("sb")&&n.length+1===n[0].parentElement.childElementCount)&&window.siyuan.menus.menu.append(new T({id:"mergeSuperBlock",icon:"iconSuper",label:window.siyuan.languages.merge+" "+window.siyuan.languages.superBlock,type:"submenu",submenu:[this.turnsIntoOne({menuId:"hLayout",label:window.siyuan.languages.hLayout,accelerator:window.siyuan.config.keymap.editor.general.hLayout.custom,icon:"iconSplitLR",protyle:e,selectsElement:n,type:"BlocksMergeSuperBlock",level:"col"}),this.turnsIntoOne({menuId:"vLayout",label:window.siyuan.languages.vLayout,accelerator:window.siyuan.config.keymap.editor.general.vLayout.custom,icon:"iconSplitTB",protyle:e,selectsElement:n,type:"BlocksMergeSuperBlock",level:"row"})]}).element)}e.disabled||window.siyuan.menus.menu.append(new T({id:"ai",icon:"iconSparkles",label:window.siyuan.languages.ai,accelerator:window.siyuan.config.keymap.editor.general.ai.custom,click(){_b(n,e)}}).element);const o=ls(Array.from(n).map(c=>c.getAttribute("data-node-id")),!0,n[0]).concat([{id:"copyPlainText",iconHTML:"",label:window.siyuan.languages.copyPlainText,accelerator:window.siyuan.config.keymap.editor.general.copyPlainText.custom,click(){let c="";n.forEach(f=>{c+=nc(f)+`
`}),Zi(c.trimEnd()),ae(n[0])}},{id:"copy",iconHTML:"",label:window.siyuan.languages.copy,accelerator:"\u2318C",click(){Ln(n[0])?ae(n[0]):Z(me(n[0])),document.execCommand("copy")}},{id:"duplicate",iconHTML:"",label:window.siyuan.languages.duplicate,accelerator:window.siyuan.config.keymap.editor.general.duplicate.custom,disabled:e.disabled,click(){im(n,e)}}]);o.splice(4,1,{id:"copyHPath",iconHTML:"",label:window.siyuan.languages.copyHPath,accelerator:window.siyuan.config.keymap.editor.general.copyHPath.custom,click:()=>{$t([n[0].getAttribute("data-node-id")],"hPath"),ae(n[0])}});const l=this.genCopyTextRef(n);if(l&&o.splice(7,0,l),window.siyuan.menus.menu.append(new T({id:"copy",label:window.siyuan.languages.copy,icon:"iconCopy",type:"submenu",submenu:o}).element),e.disabled)return;window.siyuan.menus.menu.append(new T({id:"cut",label:window.siyuan.languages.cut,accelerator:"\u2318X",icon:"iconCut",click:()=>{ae(n[0]),document.execCommand("cut")}}).element),window.siyuan.menus.menu.append(new T({id:"move",label:window.siyuan.languages.move,accelerator:window.siyuan.config.keymap.general.move.custom,icon:"iconMove",click:()=>{vi(c=>{rm(c[0],n,e)})}}).element);const r=getSelection().rangeCount>0?getSelection().getRangeAt(0):void 0;window.siyuan.menus.menu.append(new T({id:"addToDatabase",label:window.siyuan.languages.addToDatabase,accelerator:window.siyuan.config.keymap.general.addToDatabase.custom,icon:"iconDatabase",click:()=>{Cf(e,r)}}).element),window.siyuan.menus.menu.append(new T({id:"delete",label:window.siyuan.languages.delete,icon:"iconTrashcan",accelerator:"\u232B",click:()=>{e.breadcrumb?.hide(),fa(e,n[0],me(n[0]),"Backspace")}}).element),window.siyuan.menus.menu.append(new T({id:"separator_appearance",type:"separator"}).element);const d=new T({id:"appearance",label:window.siyuan.languages.appearance,icon:"iconFont",accelerator:window.siyuan.config.keymap.editor.insert.appearance.custom,click:()=>{e.toolbar.element.classList.add("fn__none"),e.toolbar.subElement.innerHTML="",e.toolbar.subElement.style.width="",e.toolbar.subElement.style.padding="",e.toolbar.subElement.append(Xh(e,n)),e.toolbar.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),e.toolbar.subElement.classList.remove("fn__none"),e.toolbar.subElementCloseCB=void 0;const c=n[0].getBoundingClientRect();ke(e.toolbar.subElement,c.left,c.top)}}).element;return window.siyuan.menus.menu.append(d),W()||d.lastElementChild.classList.add("b3-menu__submenu--row"),this.genAlign(n,e),this.genWidths(n,e),window.siyuan.config.readonly||(window.siyuan.menus.menu.append(new T({id:"separator_quickMakeCard",type:"separator"}).element),window.siyuan.menus.menu.append(new T({id:"quickMakeCard",label:window.siyuan.languages.quickMakeCard,accelerator:window.siyuan.config.keymap.editor.general.quickMakeCard.custom,iconHTML:'<svg class="b3-menu__icon" style="color:var(--b3-theme-primary)"><use xlink:href="#iconRiffCard"></use></svg>',icon:"iconRiffCard",click(){cc(e,n)}}).element),window.siyuan.menus.menu.append(new T({id:"addToDeck",label:window.siyuan.languages.addToDeck,icon:"iconRiffCard",ignore:!window.siyuan.config.flashcard.deck,click(){const c=[];n.forEach(f=>{f.getAttribute("data-type")!=="NodeThematicBreak"&&c.push(f.getAttribute("data-node-id"))}),rc(e.app,c)}}).element)),e?.app?.plugins&&An({plugins:e.app.plugins,type:"click-blockicon",detail:{protyle:e,blockElements:n},separatorPosition:"top"}),window.siyuan.menus.menu}renderMenu(e,n){if(!n)return;Q(["util","toolbar","hint"],e),window.siyuan.menus.menu.remove(),W()&&Ff();const a=n.getAttribute("data-node-id"),i=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(i.length>1&&Array.from(i).find(p=>{if(a===p.getAttribute("data-node-id"))return!0}))return this.renderMultipleMenu(e,Array.from(i));let s;if(n.tagName==="BUTTON"?Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${a}"]`)).find(g=>{if(!F(g)&&this.isMatchNode(g))return s=g,!0}):s=n,!s)return;const o=s.getAttribute("data-type"),l=s.getAttribute("data-subtype"),r=[];Q(["select"],e),s.classList.add("protyle-wysiwyg--select"),bn([a],e.block.rootID),o==="NodeParagraph"&&!e.disabled?(r.push(this.turnsIntoOne({menuId:"list",icon:"iconList",label:window.siyuan.languages.list,accelerator:window.siyuan.config.keymap.editor.insert.list.custom,protyle:e,selectsElement:[s],type:"Blocks2ULs"})),r.push(this.turnsIntoOne({menuId:"orderedList",icon:"iconOrderedList",label:window.siyuan.languages["ordered-list"],accelerator:window.siyuan.config.keymap.editor.insert["ordered-list"].custom,protyle:e,selectsElement:[s],type:"Blocks2OLs"})),r.push(this.turnsIntoOne({menuId:"check",icon:"iconCheck",label:window.siyuan.languages.check,accelerator:window.siyuan.config.keymap.editor.insert.check.custom,protyle:e,selectsElement:[s],type:"Blocks2TLs"})),r.push(this.turnsIntoOne({menuId:"quote",icon:"iconQuote",label:window.siyuan.languages.quote,accelerator:window.siyuan.config.keymap.editor.insert.quote.custom,protyle:e,selectsElement:[s],type:"Blocks2Blockquote"})),r.push(this.turnsInto({menuId:"heading1",icon:"iconH1",label:window.siyuan.languages.heading1,accelerator:window.siyuan.config.keymap.editor.heading.heading1.custom,protyle:e,selectsElement:[s],level:1,type:"Blocks2Hs"})),r.push(this.turnsInto({menuId:"heading2",icon:"iconH2",label:window.siyuan.languages.heading2,accelerator:window.siyuan.config.keymap.editor.heading.heading2.custom,protyle:e,selectsElement:[s],level:2,type:"Blocks2Hs"})),r.push(this.turnsInto({menuId:"heading3",icon:"iconH3",label:window.siyuan.languages.heading3,accelerator:window.siyuan.config.keymap.editor.heading.heading3.custom,protyle:e,selectsElement:[s],level:3,type:"Blocks2Hs"})),r.push(this.turnsInto({menuId:"heading4",icon:"iconH4",label:window.siyuan.languages.heading4,accelerator:window.siyuan.config.keymap.editor.heading.heading4.custom,protyle:e,selectsElement:[s],level:4,type:"Blocks2Hs"})),r.push(this.turnsInto({menuId:"heading5",icon:"iconH5",label:window.siyuan.languages.heading5,accelerator:window.siyuan.config.keymap.editor.heading.heading5.custom,protyle:e,selectsElement:[s],level:5,type:"Blocks2Hs"})),r.push(this.turnsInto({menuId:"heading6",icon:"iconH6",label:window.siyuan.languages.heading6,accelerator:window.siyuan.config.keymap.editor.heading.heading6.custom,protyle:e,selectsElement:[s],level:6,type:"Blocks2Hs"}))):o==="NodeHeading"&&!e.disabled?(r.push(this.turnsInto({menuId:"paragraph",icon:"iconParagraph",label:window.siyuan.languages.paragraph,accelerator:window.siyuan.config.keymap.editor.heading.paragraph.custom,protyle:e,selectsElement:[s],type:"Blocks2Ps"})),r.push(this.turnsIntoOne({menuId:"quote",icon:"iconQuote",label:window.siyuan.languages.quote,accelerator:window.siyuan.config.keymap.editor.insert.quote.custom,protyle:e,selectsElement:[s],type:"Blocks2Blockquote"})),l!=="h1"&&r.push(this.turnsInto({menuId:"heading1",icon:"iconH1",label:window.siyuan.languages.heading1,accelerator:window.siyuan.config.keymap.editor.heading.heading1.custom,protyle:e,selectsElement:[s],level:1,type:"Blocks2Hs"})),l!=="h2"&&r.push(this.turnsInto({menuId:"heading2",icon:"iconH2",label:window.siyuan.languages.heading2,accelerator:window.siyuan.config.keymap.editor.heading.heading2.custom,protyle:e,selectsElement:[s],level:2,type:"Blocks2Hs"})),l!=="h3"&&r.push(this.turnsInto({menuId:"heading3",icon:"iconH3",label:window.siyuan.languages.heading3,accelerator:window.siyuan.config.keymap.editor.heading.heading3.custom,protyle:e,selectsElement:[s],level:3,type:"Blocks2Hs"})),l!=="h4"&&r.push(this.turnsInto({menuId:"heading4",icon:"iconH4",label:window.siyuan.languages.heading4,accelerator:window.siyuan.config.keymap.editor.heading.heading4.custom,protyle:e,selectsElement:[s],level:4,type:"Blocks2Hs"})),l!=="h5"&&r.push(this.turnsInto({menuId:"heading5",icon:"iconH5",label:window.siyuan.languages.heading5,accelerator:window.siyuan.config.keymap.editor.heading.heading5.custom,protyle:e,selectsElement:[s],level:5,type:"Blocks2Hs"})),l!=="h6"&&r.push(this.turnsInto({menuId:"heading6",icon:"iconH6",label:window.siyuan.languages.heading6,accelerator:window.siyuan.config.keymap.editor.heading.heading6.custom,protyle:e,selectsElement:[s],level:6,type:"Blocks2Hs"}))):o==="NodeList"&&!e.disabled?(r.push(this.turnsOneInto({menuId:"paragraph",id:a,icon:"iconParagraph",label:window.siyuan.languages.paragraph,accelerator:window.siyuan.config.keymap.editor.heading.paragraph.custom,protyle:e,nodeElement:s,type:"CancelList"})),r.push(this.turnsIntoOne({menuId:"quote",icon:"iconQuote",label:window.siyuan.languages.quote,accelerator:window.siyuan.config.keymap.editor.insert.quote.custom,protyle:e,selectsElement:[s],type:"Blocks2Blockquote"})),s.getAttribute("data-subtype")==="o"?(r.push(this.turnsOneInto({menuId:"list",id:a,icon:"iconList",label:window.siyuan.languages.list,accelerator:window.siyuan.config.keymap.editor.insert.list.custom,protyle:e,nodeElement:s,type:"OL2UL"})),r.push(this.turnsOneInto({menuId:"check",id:a,icon:"iconCheck",label:window.siyuan.languages.check,accelerator:window.siyuan.config.keymap.editor.insert.check.custom,protyle:e,nodeElement:s,type:"UL2TL"}))):s.getAttribute("data-subtype")==="t"?(r.push(this.turnsOneInto({menuId:"list",id:a,icon:"iconList",label:window.siyuan.languages.list,accelerator:window.siyuan.config.keymap.editor.insert.list.custom,protyle:e,nodeElement:s,type:"TL2UL"})),r.push(this.turnsOneInto({menuId:"orderedList",id:a,icon:"iconOrderedList",label:window.siyuan.languages["ordered-list"],accelerator:window.siyuan.config.keymap.editor.insert["ordered-list"].custom,protyle:e,nodeElement:s,type:"TL2OL"}))):(r.push(this.turnsOneInto({menuId:"orderedList",id:a,icon:"iconOrderedList",label:window.siyuan.languages["ordered-list"],accelerator:window.siyuan.config.keymap.editor.insert["ordered-list"].custom,protyle:e,nodeElement:s,type:"UL2OL"})),r.push(this.turnsOneInto({menuId:"check",id:a,icon:"iconCheck",label:window.siyuan.languages.check,accelerator:window.siyuan.config.keymap.editor.insert.check.custom,protyle:e,nodeElement:s,type:"OL2TL"})))):o==="NodeBlockquote"&&!e.disabled&&r.push(this.turnsOneInto({menuId:"paragraph",id:a,icon:"iconParagraph",label:window.siyuan.languages.paragraph,accelerator:window.siyuan.config.keymap.editor.heading.paragraph.custom,protyle:e,nodeElement:s,type:"CancelBlockquote"})),r.length>0&&!e.disabled&&window.siyuan.menus.menu.append(new T({id:"turnInto",icon:"iconRefresh",label:window.siyuan.languages.turnInto,type:"submenu",submenu:r}).element),!e.disabled&&!s.classList.contains("hr")&&window.siyuan.menus.menu.append(new T({id:"ai",icon:"iconSparkles",label:window.siyuan.languages.ai,accelerator:window.siyuan.config.keymap.editor.general.ai.custom,click(){_b([s],e)}}).element);const d=ls([a],!0,s).concat([{id:"copyPlainText",iconHTML:"",label:window.siyuan.languages.copyPlainText,accelerator:window.siyuan.config.keymap.editor.general.copyPlainText.custom,click(){Zi(nc(s).trimEnd()),ae(s)}},{id:o==="NodeAttributeView"?"copyMirror":"copy",iconHTML:"",label:o==="NodeAttributeView"?window.siyuan.languages.copyMirror:window.siyuan.languages.copy,accelerator:"\u2318C",click(){Ln(s)?ae(s):Z(me(s)),document.execCommand("copy")}},{id:o==="NodeAttributeView"?"duplicateMirror":"duplicate",iconHTML:"",label:o==="NodeAttributeView"?window.siyuan.languages.duplicateMirror:window.siyuan.languages.duplicate,accelerator:window.siyuan.config.keymap.editor.general.duplicate.custom,disabled:e.disabled,click(){im([s],e)}}]);o==="NodeAttributeView"&&d.push({id:"duplicateCompletely",iconHTML:"",label:window.siyuan.languages.duplicateCompletely,accelerator:window.siyuan.config.keymap.editor.general.duplicateCompletely.custom,disabled:e.disabled,click(){V_(e,s)}});const c=this.genCopyTextRef([s]);if(c&&d.splice(7,0,c),window.siyuan.menus.menu.append(new T({id:"copy",icon:"iconCopy",label:window.siyuan.languages.copy,type:"submenu",submenu:d}).element),!e.disabled){window.siyuan.menus.menu.append(new T({id:"cut",icon:"iconCut",label:window.siyuan.languages.cut,accelerator:"\u2318X",click:()=>{ae(s),document.execCommand("cut")}}).element),window.siyuan.menus.menu.append(new T({id:"move",icon:"iconMove",label:window.siyuan.languages.move,accelerator:window.siyuan.config.keymap.general.move.custom,click:()=>{vi(p=>{rm(p[0],[s],e)})}}).element);const g=getSelection().rangeCount>0?getSelection().getRangeAt(0):void 0;window.siyuan.menus.menu.append(new T({id:"addToDatabase",icon:"iconDatabase",label:window.siyuan.languages.addToDatabase,accelerator:window.siyuan.config.keymap.general.addToDatabase.custom,click:()=>{Cf(e,g)}}).element),window.siyuan.menus.menu.append(new T({id:"delete",icon:"iconTrashcan",label:window.siyuan.languages.delete,accelerator:"\u232B",click:()=>{e.breadcrumb?.hide(),fa(e,s,me(s),"Backspace")}}).element)}if(o==="NodeSuperBlock"&&!e.disabled){window.siyuan.menus.menu.append(new T({id:"separator_cancelSuperBlock",type:"separator"}).element);const g=s.getAttribute("data-sb-layout")==="col";window.siyuan.menus.menu.append(new T({id:"cancelSuperBlock",label:window.siyuan.languages.cancel+" "+window.siyuan.languages.superBlock,accelerator:window.siyuan.config.keymap.editor.general[g?"hLayout":"vLayout"].custom,click(){const p=ai(e,s);U(e,p.doOperations,p.undoOperations),ae(e.wysiwyg.element.querySelector(`[data-node-id="${p.previousId}"]`)),Q(["gutter"],e)}}).element),window.siyuan.menus.menu.append(new T({id:"turnInto"+(g?"VLayout":"HLayout"),accelerator:window.siyuan.config.keymap.editor.general[g?"vLayout":"hLayout"].custom,label:window.siyuan.languages.turnInto+" "+window.siyuan.languages[g?"vLayout":"hLayout"],click(){const p=s.outerHTML;g?s.setAttribute("data-sb-layout","row"):s.setAttribute("data-sb-layout","col"),s.setAttribute("updated",Y().format("YYYYMMDDHHmmss")),J(e,a,s.outerHTML,p),Z(e.toolbar.range),Q(["gutter"],e)}}).element)}else if(o==="NodeCodeBlock"&&!e.disabled&&!s.getAttribute("data-subtype")){window.siyuan.menus.menu.append(new T({id:"separator_code",type:"separator"}).element);const g=s.getAttribute("linewrap"),p=s.getAttribute("ligatures"),h=s.getAttribute("linenumber");window.siyuan.menus.menu.append(new T({id:"code",type:"submenu",icon:"iconCode",label:window.siyuan.languages.code,submenu:[{id:"md31",iconHTML:"",label:`<div class="fn__flex" style="margin-bottom: 4px"><span>${window.siyuan.languages.md31}</span><span class="fn__space fn__flex-1"></span>
<input type="checkbox" class="b3-switch fn__flex-center"${g==="true"||window.siyuan.config.editor.codeLineWrap&&g!=="false"?" checked":""}></div>`,bind(m){m.addEventListener("click",b=>{const y=m.querySelector("input");b.target.tagName!=="INPUT"&&(y.checked=!y.checked),s.setAttribute("linewrap",y.checked.toString()),s.querySelector(".hljs").removeAttribute("data-render"),ze(s),E("/api/attr/setBlockAttrs",{id:a,attrs:{linewrap:y.checked.toString()}}),window.siyuan.menus.menu.remove()})}},{id:"md2",iconHTML:"",label:`<div class="fn__flex" style="margin-bottom: 4px"><span>${window.siyuan.languages.md2}</span><span class="fn__space fn__flex-1"></span>
<input type="checkbox" class="b3-switch fn__flex-center"${p==="true"||window.siyuan.config.editor.codeLigatures&&p!=="false"?" checked":""}></div>`,bind(m){m.addEventListener("click",b=>{const y=m.querySelector("input");b.target.tagName!=="INPUT"&&(y.checked=!y.checked),s.setAttribute("ligatures",y.checked.toString()),s.querySelector(".hljs").removeAttribute("data-render"),ze(s),E("/api/attr/setBlockAttrs",{id:a,attrs:{ligatures:y.checked.toString()}}),window.siyuan.menus.menu.remove()})}},{id:"md27",iconHTML:"",label:`<div class="fn__flex" style="margin-bottom: 4px"><span>${window.siyuan.languages.md27}</span><span class="fn__space fn__flex-1"></span>
<input type="checkbox" class="b3-switch fn__flex-center"${h==="true"||window.siyuan.config.editor.codeSyntaxHighlightLineNum&&h!=="false"?" checked":""}></div>`,bind(m){m.addEventListener("click",b=>{const y=m.querySelector("input");b.target.tagName!=="INPUT"&&(y.checked=!y.checked),s.setAttribute("linenumber",y.checked.toString()),s.querySelector(".hljs").removeAttribute("data-render"),ze(s),E("/api/attr/setBlockAttrs",{id:a,attrs:{linenumber:y.checked.toString()}}),window.siyuan.menus.menu.remove()})}}]}).element)}else if(o==="NodeCodeBlock"&&!e.disabled&&["echarts","mindmap"].includes(s.getAttribute("data-subtype"))){window.siyuan.menus.menu.append(new T({id:"separator_chart",type:"separator"}).element);const g=s.style.height;let p=s.outerHTML;window.siyuan.menus.menu.append(new T({id:"chart",label:window.siyuan.languages.chart,icon:"iconCode",submenu:[{id:"height",label:`${window.siyuan.languages.height}<span class="fn__space"></span>
<input style="margin: 4px 0;width: 84px" type="number" step="1" min="148" class="b3-text-field" value="${g?parseInt(g):"420"}">`,bind:h=>{h.querySelector("input").addEventListener("change",m=>{const b=(m.target.value||"420")+"px";s.style.height=b,s.firstElementChild.nextElementSibling.style.height=b,J(e,a,s.outerHTML,p),p=s.outerHTML,m.stopPropagation();const y=window.echarts.getInstanceById(s.firstElementChild.nextElementSibling.getAttribute("_echarts_instance_"));y&&y.resize()})}},{id:"update",label:window.siyuan.languages.update,icon:"iconEdit",click(){e.toolbar.showRender(e,s)}}]}).element)}else if(o==="NodeTable"&&!e.disabled){let g=me(s);const p=s.querySelector("table");p.contains(g.startContainer)||(g=me(p.querySelector("th")));const h=q(g.startContainer,"TD")||q(g.startContainer,"TH");h&&(window.siyuan.menus.menu.append(new T({id:"separator_table",type:"separator"}).element),window.siyuan.menus.menu.append(new T({id:"table",type:"submenu",icon:"iconTable",label:window.siyuan.languages.table,submenu:C_(e,s,h,g).menus}).element))}else if(o==="NodeAttributeView"&&!e.disabled)window.siyuan.menus.menu.append(new T({id:"separator_exportCSV",type:"separator"}).element),window.siyuan.menus.menu.append(new T({id:"exportCSV",icon:"iconDatabase",label:window.siyuan.languages.export+" CSV",click(){E("/api/export/exportAttributeView",{id:s.getAttribute("data-av-id"),blockID:a},g=>{Ht(g.data.zip)})}}).element);else if((o==="NodeVideo"||o==="NodeAudio")&&!e.disabled)window.siyuan.menus.menu.append(new T({id:"separator_VideoOrAudio",type:"separator"}).element),window.siyuan.menus.menu.append(new T({id:o==="NodeVideo"?"assetVideo":"assetAudio",type:"submenu",icon:o==="NodeVideo"?"iconVideo":"iconRecord",label:window.siyuan.languages.assets,submenu:ax(e,s,o)}).element);else if(o==="NodeIFrame"&&!e.disabled)window.siyuan.menus.menu.append(new T({id:"separator_IFrame",type:"separator"}).element),window.siyuan.menus.menu.append(new T({id:"assetIFrame",type:"submenu",icon:"iconLanguage",label:window.siyuan.languages.assets,submenu:nx(e,s)}).element);else if(o==="NodeHTMLBlock"&&!e.disabled)window.siyuan.menus.menu.append(new T({id:"separator_html",type:"separator"}).element),window.siyuan.menus.menu.append(new T({id:"html",icon:"iconHTML5",label:"HTML",click(){e.toolbar.showRender(e,s)}}).element);else if(o==="NodeBlockQueryEmbed"&&!e.disabled){window.siyuan.menus.menu.append(new T({id:"separator_blockEmbed",type:"separator"}).element);const g=s.getAttribute("breadcrumb");window.siyuan.menus.menu.append(new T({id:"blockEmbed",type:"submenu",icon:"iconSQL",label:window.siyuan.languages.blockEmbed,submenu:[{id:"refresh",icon:"iconRefresh",label:`${window.siyuan.languages.refresh} SQL`,click(){s.removeAttribute("data-render"),Be(e,s)}},{id:"update",icon:"iconEdit",label:`${window.siyuan.languages.update} SQL`,click(){e.toolbar.showRender(e,s)}},{type:"separator"},{id:"embedBlockBreadcrumb",label:`<div class="fn__flex" style="margin-bottom: 4px"><span>${window.siyuan.languages.embedBlockBreadcrumb}</span><span class="fn__space fn__flex-1"></span>
<input type="checkbox" class="b3-switch fn__flex-center"${g==="true"||window.siyuan.config.editor.embedBlockBreadcrumb&&g!=="false"?" checked":""}></div>`,bind(p){p.addEventListener("click",h=>{const m=p.querySelector("input");h.target.tagName!=="INPUT"&&(m.checked=!m.checked),s.setAttribute("breadcrumb",m.checked.toString()),E("/api/attr/setBlockAttrs",{id:a,attrs:{breadcrumb:m.checked.toString()}}),s.removeAttribute("data-render"),Be(e,s),window.siyuan.menus.menu.remove()})}},{id:"hideHeadingBelowBlocks",label:`<div class="fn__flex" style="margin-bottom: 4px"><span>${window.siyuan.languages.hideHeadingBelowBlocks}</span><span class="fn__space fn__flex-1"></span>
<input type="checkbox" class="b3-switch fn__flex-center"${s.getAttribute("custom-heading-mode")==="1"?" checked":""}></div>`,bind(p){p.addEventListener("click",h=>{const m=p.querySelector("input");h.target.tagName!=="INPUT"&&(m.checked=!m.checked),s.setAttribute("custom-heading-mode",m.checked?"1":"0"),E("/api/attr/setBlockAttrs",{id:a,attrs:{"custom-heading-mode":m.checked?"1":"0"}}),s.removeAttribute("data-render"),Be(e,s),window.siyuan.menus.menu.remove()})}}]}).element)}else if(o==="NodeHeading"&&!e.disabled){window.siyuan.menus.menu.append(new T({id:"separator_1",type:"separator"}).element);const g=[];l!=="h1"&&g.push(this.genHeadingTransform(e,a,1)),l!=="h2"&&g.push(this.genHeadingTransform(e,a,2)),l!=="h3"&&g.push(this.genHeadingTransform(e,a,3)),l!=="h4"&&g.push(this.genHeadingTransform(e,a,4)),l!=="h5"&&g.push(this.genHeadingTransform(e,a,5)),l!=="h6"&&g.push(this.genHeadingTransform(e,a,6)),window.siyuan.menus.menu.append(new T({id:"tWithSubtitle",type:"submenu",icon:"iconRefresh",label:window.siyuan.languages.tWithSubtitle,submenu:g}).element),window.siyuan.menus.menu.append(new T({id:"copyHeadings1",icon:"iconCopy",label:`${window.siyuan.languages.copy} ${window.siyuan.languages.headings1}`,click(){E("/api/block/getHeadingChildrenDOM",{id:a},p=>{fn()?window.JSAndroid.writeHTMLClipboard(e.lute.BlockDOM2StdMd(p.data).trimEnd(),p.data+u.ZWSP):pn()?window.JSHarmony.writeHTMLClipboard(e.lute.BlockDOM2StdMd(p.data).trimEnd(),p.data+u.ZWSP):De(p.data+u.ZWSP)})}}).element),window.siyuan.menus.menu.append(new T({id:"cutHeadings1",icon:"iconCut",label:`${window.siyuan.languages.cut} ${window.siyuan.languages.headings1}`,click(){E("/api/block/getHeadingChildrenDOM",{id:a},p=>{fn()?window.JSAndroid.writeHTMLClipboard(e.lute.BlockDOM2StdMd(p.data).trimEnd(),p.data+u.ZWSP):pn()?window.JSHarmony.writeHTMLClipboard(e.lute.BlockDOM2StdMd(p.data).trimEnd(),p.data+u.ZWSP):De(p.data+u.ZWSP),E("/api/block/getHeadingDeleteTransaction",{id:a},h=>{h.data.doOperations.forEach(m=>{e.wysiwyg.element.querySelectorAll(`[data-node-id="${m.id}"]`).forEach(b=>{b.remove()})}),U(e,h.data.doOperations,h.data.undoOperations)})})}}).element),window.siyuan.menus.menu.append(new T({id:"deleteHeadings1",icon:"iconTrashcan",label:`${window.siyuan.languages.delete} ${window.siyuan.languages.headings1}`,click(){E("/api/block/getHeadingDeleteTransaction",{id:a},p=>{p.data.doOperations.forEach(h=>{e.wysiwyg.element.querySelectorAll(`[data-node-id="${h.id}"]`).forEach(m=>{m.remove()})}),U(e,p.data.doOperations,p.data.undoOperations)})}}).element)}if(window.siyuan.menus.menu.append(new T({id:"separator_2",type:"separator"}).element),e.options.backlinkData?window.siyuan.menus.menu.append(new T({id:"enter",accelerator:`${X(window.siyuan.config.keymap.general.enter.custom)}/${X("\u2318"+window.siyuan.languages.click)}`,label:window.siyuan.languages.openBy,click:()=>{Ke(a,(g,p)=>{de({app:e.app,id:a,action:p,zoomIn:g})})}}).element):(window.siyuan.menus.menu.append(new T({id:"enter",accelerator:`${X(window.siyuan.config.keymap.general.enter.custom)}/${X("\u2318"+window.siyuan.languages.click)}`,label:window.siyuan.languages.enter,click:()=>{Vt({protyle:e,id:a})}}).element),window.siyuan.menus.menu.append(new T({id:"enterBack",accelerator:window.siyuan.config.keymap.general.enterBack.custom,label:window.siyuan.languages.enterBack,click:()=>{pm(e,a)}}).element)),!e.disabled){window.siyuan.menus.menu.append(new T({id:"insertBefore",icon:"iconBefore",label:window.siyuan.languages["insert-before"],accelerator:window.siyuan.config.keymap.editor.general.insertBefore.custom,click(){Q(["select"],e),bn([],e.block.rootID),_n(e,"beforebegin",a)}}).element),window.siyuan.menus.menu.append(new T({id:"insertAfter",icon:"iconAfter",label:window.siyuan.languages["insert-after"],accelerator:window.siyuan.config.keymap.editor.general.insertAfter.custom,click(){Q(["select"],e),bn([],e.block.rootID),_n(e,"afterend",a)}}).element);const g=s.lastElementChild.querySelector(".protyle-attr--refcount");g&&g.textContent&&jE(a)}if(window.siyuan.menus.menu.append(new T({id:"jumpToParentNext",label:window.siyuan.languages.jumpToParentNext,accelerator:window.siyuan.config.keymap.editor.general.jumpToParentNext.custom,click(){Q(["select"],e),Il(e,s,"next")}}).element),window.siyuan.menus.menu.append(new T({id:"jumpToParentPrev",label:window.siyuan.languages.jumpToParentPrev,accelerator:window.siyuan.config.keymap.editor.general.jumpToParentPrev.custom,click(){Q(["select"],e),Il(e,s,"previous")}}).element),window.siyuan.menus.menu.append(new T({id:"jumpToParent",label:window.siyuan.languages.jumpToParent,accelerator:window.siyuan.config.keymap.editor.general.jumpToParent.custom,click(){Q(["select"],e),Il(e,s,"parent")}}).element),window.siyuan.menus.menu.append(new T({id:"separator_3",type:"separator"}).element),o!=="NodeThematicBreak"&&(window.siyuan.menus.menu.append(new T({id:"fold",label:window.siyuan.languages.fold,accelerator:`${X(window.siyuan.config.keymap.editor.general.collapse.custom)}/${X("\u2325"+window.siyuan.languages.click)}`,click(){an(e,s),ae(s)}}).element),e.disabled||window.siyuan.menus.menu.append(new T({id:"attr",label:window.siyuan.languages.attr,icon:"iconAttr",accelerator:window.siyuan.config.keymap.editor.general.attr.custom+"/"+X("\u21E7"+window.siyuan.languages.click),click(){Ti(s,"bookmark",e)}}).element)),!e.disabled){const g=new T({id:"appearance",label:window.siyuan.languages.appearance,icon:"iconFont",accelerator:window.siyuan.config.keymap.editor.insert.appearance.custom,click:()=>{e.toolbar.element.classList.add("fn__none"),e.toolbar.subElement.innerHTML="",e.toolbar.subElement.style.width="",e.toolbar.subElement.style.padding="",e.toolbar.subElement.append(Xh(e,[s])),e.toolbar.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),e.toolbar.subElement.classList.remove("fn__none"),e.toolbar.subElementCloseCB=void 0;const p=s.getBoundingClientRect();ke(e.toolbar.subElement,p.left,p.top)}}).element;window.siyuan.menus.menu.append(g),W()||g.lastElementChild.classList.add("b3-menu__submenu--row"),this.genAlign([s],e),this.genWidths([s],e)}window.siyuan.menus.menu.append(new T({id:"separator_4",type:"separator"}).element),window.siyuan.config.cloudRegion===0&&!["NodeThematicBreak","NodeBlockQueryEmbed","NodeIFrame","NodeHTMLBlock","NodeWidget","NodeVideo","NodeAudio"].includes(o)&&le(s)?.textContent.trim()!==""&&(o!=="NodeCodeBlock"||o==="NodeCodeBlock"&&!s.getAttribute("data-subtype"))&&window.siyuan.menus.menu.append(new T({id:"wechatReminder",icon:"iconMp",label:window.siyuan.languages.wechatReminder,ignore:window.siyuan.config.readonly,click(){bx(s)}}).element),o!=="NodeThematicBreak"&&!window.siyuan.config.readonly&&(window.siyuan.menus.menu.append(new T({id:"quickMakeCard",icon:"iconRiffCard",label:window.siyuan.languages.quickMakeCard,accelerator:window.siyuan.config.keymap.editor.general.quickMakeCard.custom,iconHTML:'<svg class="b3-menu__icon" style="color:var(--b3-theme-primary)"><use xlink:href="#iconRiffCard"></use></svg>',click(){cc(e,[s])}}).element),window.siyuan.menus.menu.append(new T({id:"addToDeck",label:window.siyuan.languages.addToDeck,ignore:!window.siyuan.config.flashcard.deck,icon:"iconRiffCard",click(){rc(e.app,[a])}}).element),window.siyuan.menus.menu.append(new T({id:"separator_5",type:"separator"}).element)),e?.app?.plugins&&An({plugins:e.app.plugins,type:"click-blockicon",detail:{protyle:e,blockElements:[s]},separatorPosition:"bottom"});let f=s.getAttribute("updated")||"";return f&&(f=`${window.siyuan.languages.modifiedAt} ${Y(f).format("YYYY-MM-DD HH:mm:ss")}<br>`),window.siyuan.menus.menu.append(new T({id:"updateAndCreatedAt",iconHTML:"",type:"readonly",label:`${f}${window.siyuan.languages.createdAt} ${Y(a.substr(0,14)).format("YYYY-MM-DD HH:mm:ss")}`}).element),window.siyuan.menus.menu}genHeadingTransform(e,n,a){return{id:"heading"+a,iconHTML:"",icon:"iconHeading"+a,label:window.siyuan.languages["heading"+a],click(){E("/api/block/getHeadingLevelTransaction",{id:n,level:a},i=>{i.data.doOperations.forEach((s,o)=>{e.wysiwyg.element.querySelectorAll(`[data-node-id="${s.id}"]`).forEach(l=>{l.outerHTML=s.data}),e.wysiwyg.element.querySelectorAll(`[data-node-id="${s.id}"]`).forEach(l=>{Ma(l)}),o===0&&ae(e.wysiwyg.element.querySelector(`[data-node-id="${s.id}"]`),e.wysiwyg.element,!0)}),U(e,i.data.doOperations,i.data.undoOperations)})}}}genClick(e,n,a){ds(e,n,a),ae(e[0])}genAlign(e,n){window.siyuan.menus.menu.append(new T({id:"layout",label:window.siyuan.languages.layout,type:"submenu",submenu:[{id:"alignLeft",icon:"iconAlignLeft",label:window.siyuan.languages.alignLeft,accelerator:window.siyuan.config.keymap.editor.general.alignLeft.custom,click:()=>{this.genClick(e,n,a=>{a.classList.contains("av")?a.style.justifyContent="":a.style.textAlign="left"})}},{id:"alignCenter",icon:"iconAlignCenter",label:window.siyuan.languages.alignCenter,accelerator:window.siyuan.config.keymap.editor.general.alignCenter.custom,click:()=>{this.genClick(e,n,a=>{a.classList.contains("av")?a.style.justifyContent="center":a.style.textAlign="center"})}},{id:"alignRight",icon:"iconAlignRight",label:window.siyuan.languages.alignRight,accelerator:window.siyuan.config.keymap.editor.general.alignRight.custom,click:()=>{this.genClick(e,n,a=>{a.classList.contains("av")?a.style.justifyContent="flex-end":a.style.textAlign="right"})}},{id:"justify",icon:"iconMenu",label:window.siyuan.languages.justify,click:()=>{this.genClick(e,n,a=>{a.style.textAlign="justify"})}},{id:"separator_1",type:"separator"},{id:"ltr",icon:"iconLtr",label:window.siyuan.languages.ltr,accelerator:window.siyuan.config.keymap.editor.general.ltr.custom,click:()=>{this.genClick(e,n,a=>{a.style.direction="ltr"})}},{id:"rtl",icon:"iconRtl",label:window.siyuan.languages.rtl,accelerator:window.siyuan.config.keymap.editor.general.rtl.custom,click:()=>{this.genClick(e,n,a=>{a.classList.contains("av")||(a.style.direction="rtl")})}},{id:"separator_2",type:"separator"},{id:"clearFontStyle",icon:"iconTrashcan",label:window.siyuan.languages.clearFontStyle,click:()=>{this.genClick(e,n,a=>{a.classList.contains("av")?a.style.justifyContent="":(a.style.textAlign="",a.style.direction="")})}}]}).element)}updateNodeElements(e,n,a){const i=[],s=[];e.forEach(o=>{i.push({action:"update",id:o.getAttribute("data-node-id"),data:o.outerHTML})}),a.addEventListener(a.type==="number"?"blur":"change",()=>{e.forEach(o=>{s.push({action:"update",id:o.getAttribute("data-node-id"),data:o.outerHTML})}),U(n,s,i),window.siyuan.menus.menu.remove(),ae(e[0])})}genWidths(e,n){let a;const i=e[0],s=[{id:"widthInput",iconHTML:"",type:"readonly",label:`<div class="fn__flex-center">
<input class="b3-text-field" value="${i.style.width.endsWith("px")?parseInt(i.style.width):""}" type="number" style="margin: 4px" placeholder="${window.siyuan.languages.width}"> px
</div>`,bind:l=>{const r=l.querySelector("input");r.addEventListener("input",()=>{e.forEach(d=>{d.style.width=r.value+"px",d.style.flex="none"}),a.value="0",a.parentElement.setAttribute("aria-label",r.value+"px")}),this.updateNodeElements(e,n,r)}}];["25%","33%","50%","67%","75%","100%"].forEach(l=>{s.push({id:"width_"+l,iconHTML:"",label:l,click:()=>{this.genClick(e,n,r=>{r.style.width=l,r.style.flex="none"})}})}),s.push({id:"separator_1",type:"separator"});const o=i.style.width.endsWith("%")?parseInt(i.style.width):0;window.siyuan.menus.menu.append(new T({id:"width",label:window.siyuan.languages.width,submenu:s.concat([{id:"widthDrag",iconHTML:"",type:"readonly",label:`<div style="margin: 4px 0;"  aria-label="${i.style.width.endsWith("px")?i.style.width:i.style.width||window.siyuan.languages.default}" class="b3-tooltips b3-tooltips__n${W()?"":" fn__size200"}">
    <input style="box-sizing: border-box" value="${o}" class="b3-slider fn__block" max="100" min="1" step="1" type="range">
</div>`,bind:l=>{a=l.querySelector("input"),a.addEventListener("input",()=>{e.forEach(r=>{r.style.width=a.value+"%",r.style.flex="none"}),a.parentElement.setAttribute("aria-label",`${a.value}%`)}),this.updateNodeElements(e,n,a)}},{id:"separator_2",type:"separator"},{id:"default",iconHTML:"",label:window.siyuan.languages.default,click:()=>{this.genClick(e,n,l=>{l.style.width&&(l.style.width="",l.style.flex="")})}}])}).element)}genHeights(e,n){if(e.find(r=>{if(!r.classList.contains("p")&&!r.classList.contains("code-block")&&!r.classList.contains("render-node"))return!0}))return;let i;const s=e[0],o=[{id:"heightInput",iconHTML:"",type:"readonly",label:`<div class="fn__flex-center">
<input class="b3-text-field" value="${s.style.height.endsWith("px")?parseInt(s.style.height):""}" type="number" style="margin: 4px" placeholder="${window.siyuan.languages.height}"> px
</div>`,bind:r=>{const d=r.querySelector("input");d.addEventListener("input",()=>{e.forEach(c=>{c.style.height=d.value+"px",c.style.flex="none"}),i.value="0",i.parentElement.setAttribute("aria-label",d.value+"px")}),this.updateNodeElements(e,n,d)}}];["25%","33%","50%","67%","75%","100%"].forEach(r=>{o.push({id:"height_"+r,iconHTML:"",label:r,click:()=>{this.genClick(e,n,d=>{d.style.height=r,d.style.flex="none"})}})}),o.push({type:"separator"});const l=s.style.height.endsWith("%")?parseInt(s.style.height):0;window.siyuan.menus.menu.append(new T({id:"heightDrag",label:window.siyuan.languages.height,submenu:o.concat([{iconHTML:"",type:"readonly",label:`<div style="margin: 4px 0;"  aria-label="${s.style.height.endsWith("px")?s.style.height:s.style.height||window.siyuan.languages.default}" class="b3-tooltips b3-tooltips__n${W()?"":" fn__size200"}">
    <input style="box-sizing: border-box" value="${l}" class="b3-slider fn__block" max="100" min="1" step="1" type="range">
</div>`,bind:r=>{i=r.querySelector("input"),i.addEventListener("input",()=>{e.forEach(d=>{d.style.height=i.value+"%",d.style.flex="none"}),i.parentElement.setAttribute("aria-label",`${i.value}%`)}),this.updateNodeElements(e,n,i)}},{type:"separator"},{id:"default",iconHTML:"",label:window.siyuan.languages.default,click:()=>{this.genClick(e,n,r=>{r.style.height&&(r.style.height="",r.style.overflow="")})}}])}).element)}genCopyTextRef(e){return Ln(e[0])?!1:{id:"copyText",iconHTML:"",accelerator:window.siyuan.config.keymap.editor.general.copyText.custom,label:window.siyuan.languages.copyText,click(){e[0].setAttribute("data-reftext","true"),Z(me(e[0])),document.execCommand("copy")}}}render(e,n,a,i){if(e.title&&e.title.element.getAttribute("data-render")!=="true")return;const s=a.parentElement.parentElement.querySelector(".protyle-select");if(s&&!s.classList.contains("fn__none"))return;let o="",l=n,r=0,d=0,c,f=!1;for(;l;){const w=!f||f&&l.getAttribute("fold")==="1";if(!F(l)){let x;w&&(x=l.getAttribute("data-type"));let S=l.getAttribute("data-node-id");if(x==="NodeAttributeView"&&i){const C=L(i,"av__row");if(C&&!C.classList.contains("av__row--header")){n=C;let N=gt()?window.siyuan.languages.rowTip:window.siyuan.languages.rowTip.replace("\u21E7","Shift+");e.disabled?N=window.siyuan.languages.rowTip.substring(0,window.siyuan.languages.rowTip.indexOf("<br")):C.querySelector('[data-dtype="block"]')?.getAttribute("data-detached")==="true"&&(N=window.siyuan.languages.rowTip.substring(0,window.siyuan.languages.rowTip.lastIndexOf("<br"))),o=`<button data-type="NodeAttributeViewRowMenu" data-node-id="${S}" data-row-id="${C.dataset.id}" class="ariaLabel" data-position="west" aria-label="${N}"><svg><use xlink:href="#iconDrag"></use></svg><span ${e.disabled?"":'draggable="true" class="fn__grab"'}></span></button>`,e.disabled||(o=`<button data-type="NodeAttributeViewRow" data-node-id="${S}" data-row-id="${C.dataset.id}" class="ariaLabel" data-position="west" aria-label="${gt()?window.siyuan.languages.addBelowAbove:window.siyuan.languages.addBelowAbove.replace("\u2325","Alt+")}"><svg><use xlink:href="#iconAdd"></use></svg></button>${o}`);break}}if(d===0){if(["NodeBlockquote","NodeList","NodeSuperBlock"].includes(x))return;const C=Je(l);c=C.querySelector(".li")||C.querySelector(".list"),F(c)&&(c=void 0),!C.isSameNode(l)&&x!=="NodeHeading"&&(l=C,x=l.getAttribute("data-type"),S=l.getAttribute("data-node-id"))}x==="NodeListItem"&&d===1&&!w&&(o=""),d+=1;let k=this.gutterTip;e.disabled&&(k=this.gutterTip.split("<br>").splice(0,2).join("<br>"));let A="";e.options.backlinkData&&(A=`class="popover__block" data-id="${S}"`);const $=`<button class="ariaLabel" data-position="west" aria-label="${k}" 
data-type="${x}" data-subtype="${l.getAttribute("data-subtype")}" data-node-id="${S}">
    <svg><use xlink:href="#${Rn(x,l.getAttribute("data-subtype"))}"></use></svg>
    <span ${A} ${e.disabled?"":'draggable="true"'}></span>
</button>`;w&&(o=$+o);let M="";if(x==="NodeListItem"&&l.childElementCount>3||x==="NodeHeading"){const C=l.getAttribute("fold");M=`<button class="ariaLabel" data-position="west" aria-label="${window.siyuan.languages.fold}" 
data-type="fold" style="cursor:inherit;"><svg style="width: 10px${C&&C==="1"?"":";transform:rotate(90deg)"}"><use xlink:href="#iconPlay"></use></svg></button>`}(x==="NodeListItem"||x==="NodeList")&&(c=l,x==="NodeListItem"&&l.childElementCount>3&&(o=$+M)),x==="NodeHeading"&&(o=o+M),x==="NodeBlockquote"&&(r+=8),l.previousElementSibling&&l.previousElementSibling.getAttribute("data-node-id")&&(f=!0)}const _=P(l.parentElement);if(_)l=_;else break}let g=!0;const p=this.element.querySelectorAll("button");if(p.length!==o.split("</button>").length-1?g=!1:Array.from(p).find(w=>{const _=w.getAttribute("data-node-id");if(_&&o.indexOf(_)===-1)return g=!1,!0;const x=w.getAttribute("data-row-id");if(x&&o.indexOf(x)===-1||!x&&o.indexOf("NodeAttributeViewRowMenu")>-1)return g=!1,!0}),g&&this.element.childElementCount>0){this.element.classList.remove("fn__none");return}this.element.innerHTML=o,this.element.classList.remove("fn__none"),this.element.style.width="";const h=a.parentElement.getBoundingClientRect().top;let m=n.getBoundingClientRect(),b=0;if(c&&!window.siyuan.config.editor.rtl){const w=c.firstElementChild.getBoundingClientRect();w.right<=m.right&&(m=w,r=0)}else l.getAttribute("data-type")==="NodeBlockQueryEmbed"?(m=l.getBoundingClientRect(),r=0):n.classList.contains("av__row")||(m.height<Math.floor(window.siyuan.config.editor.fontSize*1.625)+8||m.height>Math.floor(window.siyuan.config.editor.fontSize*1.625)+8&&m.height<Math.floor(window.siyuan.config.editor.fontSize*1.625)*2+8?b=(m.height-this.element.clientHeight)/2:(l.getAttribute("data-type")==="NodeAttributeView"||n.getAttribute("data-type")==="NodeAttributeView")&&h<m.top&&(b=8));this.element.style.top=`${Math.max(m.top,h)+b}px`;let y=m.left-this.element.clientWidth-r;l.getAttribute("data-type")==="NodeBlockQueryEmbed"&&this.element.childElementCount===1?y=l.getBoundingClientRect().left-this.element.clientWidth-r:n.classList.contains("av__row")&&(y=l.getBoundingClientRect().left-this.element.clientWidth-r+parseInt(getComputedStyle(l).paddingLeft)),this.element.style.left=`${y}px`,y<this.element.parentElement.getBoundingClientRect().left?(this.element.style.width="24px",this.element.style.left=`${m.left-this.element.clientWidth-r/2+3}px`,o="",Array.from(this.element.children).reverse().forEach((w,_)=>{_!==0&&(w.firstElementChild.style.height="14px"),o+=w.outerHTML}),this.element.innerHTML=o):this.element.querySelectorAll("svg").forEach(w=>{w.style.height=""})}}class IT{constructor(e){this.SAMPLE_RATE=44100,this.isRecording=!1,this.readyFlag=!1,this.leftChannel=[],this.rightChannel=[],this.recordingLength=0;let n;if(typeof AudioContext<"u")n=new AudioContext;else if(webkitAudioContext)n=new webkitAudioContext;else return;this.DEFAULT_SAMPLE_RATE=n.sampleRate;const a=n.createGain();n.createMediaStreamSource(e).connect(a),this.recorder=n.createScriptProcessor(2048,2,1),this.recorder.onaudioprocess=null,a.connect(this.recorder),this.recorder.connect(n.destination),this.readyFlag=!0}cloneChannelData(e,n){this.leftChannel.push(new Float32Array(e)),this.rightChannel.push(new Float32Array(n)),this.recordingLength+=2048}startRecordingNewWavFile(){this.readyFlag&&(this.isRecording=!0,this.leftChannel.length=this.rightChannel.length=0,this.recordingLength=0)}stopRecording(){this.isRecording=!1}buildWavFileBlob(){const e=this.mergeBuffers(this.leftChannel),n=this.mergeBuffers(this.rightChannel);let a=new Float32Array(e.length);for(let f=0;f<e.length;++f)a[f]=.5*(e[f]+n[f]);this.DEFAULT_SAMPLE_RATE>this.SAMPLE_RATE&&(a=this.downSampleBuffer(a,this.SAMPLE_RATE));const i=44+a.length*2,s=new ArrayBuffer(i),o=new DataView(s);this.writeUTFBytes(o,0,"RIFF"),o.setUint32(4,i,!0),this.writeUTFBytes(o,8,"WAVE"),this.writeUTFBytes(o,12,"fmt "),o.setUint32(16,16,!0),o.setUint16(20,1,!0),o.setUint16(22,1,!0),o.setUint32(24,this.SAMPLE_RATE,!0),o.setUint32(28,this.SAMPLE_RATE*2,!0),o.setUint16(32,2,!0),o.setUint16(34,16,!0);const l=a.length*2;this.writeUTFBytes(o,36,"data"),o.setUint32(40,l,!0);const r=a.length;let d=44;const c=1;for(let f=0;f<r;f++)o.setInt16(d,a[f]*(32767*c),!0),d+=2;return new Blob([o],{type:"audio/wav"})}downSampleBuffer(e,n){if(n===this.DEFAULT_SAMPLE_RATE||n>this.DEFAULT_SAMPLE_RATE)return e;const a=this.DEFAULT_SAMPLE_RATE/n,i=Math.round(e.length/a),s=new Float32Array(i);let o=0,l=0;for(;o<s.length;){const r=Math.round((o+1)*a);let d=0,c=0;for(let f=l;f<r&&f<e.length;f++)d+=e[f],c++;s[o]=d/c,o++,l=r}return s}mergeBuffers(e){const n=new Float32Array(this.recordingLength);let a=0;const i=e.length;for(let s=0;s<i;++s){const o=e[s];n.set(o,a),a+=o.length}return n}writeUTFBytes(e,n,a){const i=a.length;for(let s=0;s<i;s++)e.setUint8(n+s,a.charCodeAt(s))}}const kb=(t,e)=>{if(Zt(),!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="titleMenu"){window.siyuan.menus.menu.remove();return}E("/api/block/getDocInfo",{id:t.block.rootID},n=>{if(window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name","titleMenu"),window.siyuan.menus.menu.append(new T({id:"copy",label:window.siyuan.languages.copy,icon:"iconCopy",type:"submenu",submenu:ls([t.block.rootID])}).element),!t.disabled){window.siyuan.menus.menu.append(wm([t.path]));const i=getSelection().rangeCount>0?getSelection().getRangeAt(0):void 0;window.siyuan.menus.menu.append(new T({id:"addToDatabase",label:window.siyuan.languages.addToDatabase,accelerator:window.siyuan.config.keymap.general.addToDatabase.custom,icon:"iconDatabase",click:()=>{Cf(t,i,"title")}}).element),window.siyuan.menus.menu.append(new T({id:"delete",icon:"iconTrashcan",label:window.siyuan.languages.delete,click:()=>{Mw(t.notebookId,t.path)}}).element)}if(window.siyuan.menus.menu.append(new T({id:"separator_1",type:"separator"}).element),window.siyuan.menus.menu.append(new T({id:"outline",icon:"iconAlignCenter",label:window.siyuan.languages.outline,accelerator:window.siyuan.config.keymap.editor.general.outline.custom,click:()=>{_v(t)}}).element),window.siyuan.menus.menu.append(new T({id:"backlinks",icon:"iconLink",label:window.siyuan.languages.backlinks,accelerator:window.siyuan.config.keymap.editor.general.backlinks.custom,click:()=>{Qf({app:t.app,blockId:t.block.id,rootId:t.block.rootID,useBlockId:t.block.showAll,title:t.title?t.title.editElement.textContent||window.siyuan.languages.untitled:null})}}).element),window.siyuan.menus.menu.append(new T({id:"graphView",icon:"iconGraph",label:window.siyuan.languages.graphView,accelerator:window.siyuan.config.keymap.editor.general.graphView.custom,click:()=>{ep({app:t.app,blockId:t.block.id,rootId:t.block.rootID,useBlockId:t.block.showAll,title:t.title?t.title.editElement.textContent||window.siyuan.languages.untitled:null})}}).element),window.siyuan.menus.menu.append(new T({id:"separator_2",type:"separator"}).element),window.siyuan.menus.menu.append(new T({id:"attr",label:window.siyuan.languages.attr,icon:"iconAttr",accelerator:window.siyuan.config.keymap.editor.general.attr.custom+"/"+X("\u21E7"+window.siyuan.languages.click),click(){Gn(n.data.ial,"bookmark",t)}}).element),!window.siyuan.config.readonly){window.siyuan.config.cloudRegion===0&&window.siyuan.menus.menu.append(new T({id:"wechatReminder",label:window.siyuan.languages.wechatReminder,icon:"iconMp",click(){yx(t)}}).element);const i=[{id:"spaceRepetition",iconHTML:"",label:window.siyuan.languages.spaceRepetition,accelerator:window.siyuan.config.keymap.editor.general.spaceRepetition.custom,click:()=>{E("/api/riff/getTreeRiffDueCards",{rootID:t.block.rootID},s=>{no(t.app,s.data,"doc",t.block.rootID,s.data.name)})}},{id:"manage",iconHTML:"",label:window.siyuan.languages.manage,click:()=>{E("/api/filetree/getHPathByID",{id:t.block.rootID},s=>{vl(t.app,t.block.rootID,Ee().join($a(t.notebookId),s.data),"Tree")})}},{id:"quickMakeCard",iconHTML:"",label:window.siyuan.languages.quickMakeCard,accelerator:window.siyuan.config.keymap.editor.general.quickMakeCard.custom,click:()=>{let s=t.title?.element;s||(s=document.createElement("div"),s.setAttribute("data-node-id",t.block.rootID),s.setAttribute(u.CUSTOM_RIFF_DECKS,n.data.ial[u.CUSTOM_RIFF_DECKS])),cc(t,[s])}}];window.siyuan.config.flashcard.deck&&i.push({id:"addToDeck",iconHTML:"",label:window.siyuan.languages.addToDeck,click:()=>{rc(t.app,[t.block.rootID])}}),window.siyuan.menus.menu.append(new T({id:"riffCard",label:window.siyuan.languages.riffCard,type:"submenu",icon:"iconRiffCard",submenu:i}).element)}window.siyuan.menus.menu.append(new T({id:"search",label:window.siyuan.languages.search,icon:"iconSearch",accelerator:window.siyuan.config.keymap.general.search.custom,async click(){const i=nt(t.path,!1,!0);wn({app:t.app,hotkey:u.DIALOG_SEARCH,notebookId:t.notebookId,searchPath:i})}}).element),t.disabled||jE(t.block.rootID),window.siyuan.menus.menu.append(new T({id:"separator_3",type:"separator"}).element),t.model||window.siyuan.menus.menu.append(new T({id:"openBy",label:window.siyuan.languages.openBy,icon:"iconOpen",click(){de({app:t.app,id:t.block.id,action:t.block.rootID!==t.block.id?[u.CB_GET_ALL,u.CB_GET_FOCUS]:[u.CB_GET_CONTEXT]})}}).element),window.siyuan.menus.menu.append(new T({id:"openByNewWindow",label:window.siyuan.languages.openByNewWindow,icon:"iconOpenWindow",click(){Xr(t.block.rootID)}}).element),window.siyuan.menus.menu.append(new T({id:"showInFolder",icon:"iconFolder",label:window.siyuan.languages.showInFolder,click:()=>{Ja(Ft.join(window.siyuan.config.system.dataDir,t.notebookId,t.path))}}).element),t.disabled||window.siyuan.menus.menu.append(new T({id:"fileHistory",label:window.siyuan.languages.fileHistory,icon:"iconHistory",click(){Hw({app:t.app,id:t.block.rootID,notebookId:t.notebookId,pathString:n.data.name})}}).element),Fh(t.notebookId,t.path),window.siyuan.menus.menu.append(O_(t.block.showAll?t.block.id:t.block.rootID)),window.siyuan.menus.menu.append(new T({id:"separator_4",type:"separator"}).element),t?.app?.plugins&&An({plugins:t.app.plugins,type:"click-editortitleicon",detail:{protyle:t,data:n.data},separatorPosition:"bottom"}),window.siyuan.menus.menu.append(new T({id:"updateAndCreatedAt",iconHTML:"",type:"readonly",label:`${window.siyuan.languages.modifiedAt} ${Y(n.data.ial.updated).format("YYYY-MM-DD HH:mm:ss")}<br>${window.siyuan.languages.createdAt} ${Y(n.data.ial.id.substr(0,14)).format("YYYY-MM-DD HH:mm:ss")}`}).element),window.siyuan.menus.menu.popup(e);const a=Le(t.element,"block__popover",!0);window.siyuan.menus.menu.element.setAttribute("data-from",a?a.dataset.level+"popover":"app")})};class DT{constructor(e){const n=document.createElement("div");n.className="protyle-breadcrumb";let a="";n.innerHTML=`${W()?`<button class="protyle-breadcrumb__icon" data-type="mobile-menu">${window.siyuan.languages.breadcrumb}</button>`:'<div class="protyle-breadcrumb__bar"></div>'}
<span class="protyle-breadcrumb__space"></span>
<button class="protyle-breadcrumb__icon fn__none ariaLabel" aria-label="${X(window.siyuan.config.keymap.editor.general.exitFocus.custom)}" data-type="exit-focus">${window.siyuan.languages.exitFocus}</button>
${a}
<button class="block__icon fn__flex-center ariaLabel${window.siyuan.config.readonly?" fn__none":""}" aria-label="${window.siyuan.languages.lockEdit}" data-type="readonly"><svg><use xlink:href="#iconUnlock"></use></svg></button>
<button class="block__icon fn__flex-center ariaLabel" data-type="doc" aria-label="${gt()?window.siyuan.languages.gutterTip2:window.siyuan.languages.gutterTip2.replace("\u21E7","Shift+")}"><svg><use xlink:href="#iconFile"></use></svg></button>
<button class="block__icon fn__flex-center ariaLabel" data-type="more" aria-label="${window.siyuan.languages.more}"><svg><use xlink:href="#iconMore"></use></svg></button>
<button class="block__icon fn__flex-center fn__none ariaLabel" data-type="context" aria-label="${window.siyuan.languages.context}"><svg><use xlink:href="#iconAlignCenter"></use></svg></button>`,this.element=n.firstElementChild,n.addEventListener("click",i=>{let s=i.target;for(;s&&!s.isEqualNode(n);){const o=s.getAttribute("data-node-id"),l=s.getAttribute("data-type");if(o){e.options.render.breadcrumbDocName&&window.siyuan.ctrlIsPressed?de({app:e.app,id:o,action:o===e.block.rootID?[u.CB_GET_FOCUS]:[u.CB_GET_FOCUS,u.CB_GET_ALL]}):Vt({protyle:e,id:o}),i.preventDefault();break}else if(l==="mobile-menu"){this.genMobileMenu(e),i.preventDefault(),i.stopPropagation();break}else if(l==="doc"){if(window.siyuan.shiftIsPressed)E("/api/block/getDocInfo",{id:e.block.rootID},r=>{Gn(r.data.ial,"bookmark",e)});else{const r=s.getBoundingClientRect();kb(e,{x:r.right,y:r.bottom,isLeft:!0})}i.stopPropagation(),i.preventDefault();break}else if(l==="more"){const r=s.getBoundingClientRect();this.showMenu(e,{x:r.right,y:r.bottom,isLeft:!0}),i.stopPropagation(),i.preventDefault();break}else if(l==="readonly"){Hh(s,e),i.stopPropagation(),i.preventDefault();break}else if(l==="exit-focus"){Vt({protyle:e,id:e.block.rootID,focusId:e.block.id}),i.stopPropagation(),i.preventDefault();break}else if(l==="context"){i.stopPropagation(),i.preventDefault(),s.classList.contains("block__icon--active")?(Vt({protyle:e,id:e.options.blockId}),s.classList.remove("block__icon--active")):(E("/api/filetree/getDoc",{id:e.options.blockId,mode:3,size:window.siyuan.config.editor.dynamicLoadBlocks},r=>{rt({data:r,protyle:e,action:[u.CB_GET_HL]})}),s.classList.add("block__icon--active"));break}else if(l==="undo"){e.undo.undo(e),i.preventDefault(),i.stopPropagation();break}else if(l==="redo"){e.undo.redo(e),i.preventDefault(),i.stopPropagation();break}else if(l==="outdent"){if(e.toolbar.range){const r=P(e.toolbar.range.startContainer);r&&yc(e,[r.parentElement],e.toolbar.range)}i.preventDefault(),i.stopPropagation();break}else if(l==="indent"){if(e.toolbar.range){const r=P(e.toolbar.range.startContainer);r&&bm(e,[r.parentElement],e.toolbar.range)}i.preventDefault(),i.stopPropagation();break}s=s.parentElement}}),n.addEventListener("mouseleave",()=>{e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl").forEach(i=>{i.classList.remove("protyle-wysiwyg--hl")})}),this.element.addEventListener("mousewheel",i=>{this.element.scrollLeft=this.element.scrollLeft+i.deltaY},{passive:!0})}startRecord(e){this.messageId=j(`<div class="fn__flex fn__flex-wrap">
<span class="fn__flex-center">${window.siyuan.languages.recording}</span><span class="fn__space"></span>
<button class="b3-button b3-button--white">${window.siyuan.languages.endRecord}</button></div>`,-1),document.querySelector(`#message [data-id="${this.messageId}"] button`).addEventListener("click",()=>{this.mediaRecorder.stopRecording(),Ue(this.messageId);const n=new File([this.mediaRecorder.buildWavFileBlob()],`record${new Date().getTime()}.wav`,{type:"video/webm"});ii(e,[n])}),this.mediaRecorder.startRecordingNewWavFile()}genMobileMenu(e){const n=new st("breadcrumb-mobile-path");let a;if(getSelection().rangeCount>0){const s=getSelection().getRangeAt(0);!e.wysiwyg.element.isEqualNode(s.startContainer)&&!e.wysiwyg.element.contains(s.startContainer)?a=Hn(e.wysiwyg.element.firstElementChild)||e.wysiwyg.element.firstElementChild:a=P(s.startContainer)}a||(a=Hn(e.wysiwyg.element.firstElementChild)||e.wysiwyg.element.firstElementChild);const i=a.getAttribute("data-node-id");E("/api/block/getBlockBreadcrumb",{id:i,excludeTypes:[]},s=>{s.data.forEach(o=>{let l=!1;(!e.block.showAll&&o.id===e.block.parentID||e.block.showAll&&o.id===e.block.id)&&(l=!0),n.addItem({current:l,icon:Rn(o.type,o.subType),label:o.name,click(){Vt({protyle:e,id:o.id,focusId:i})}})}),n.fullscreen()})}toggleExit(e){const n=this.element.parentElement.querySelector('[data-type="exit-focus"]');e?n.classList.add("fn__none"):n.classList.remove("fn__none")}showMenu(e,n){if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="breadcrumbMore"){window.siyuan.menus.menu.remove();return}let a;const i=P(me(e.element).startContainer);i&&(a=i.getAttribute("data-node-id")),E("/api/block/getTreeStat",{id:a||(e.block.showAll?e.block.id:e.block.rootID)},s=>{if(window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name","breadcrumbMore"),!e.contentElement.classList.contains("fn__none")&&!e.disabled){let l="";l='<input class="b3-form__upload" type="file" multiple="multiple"',e.options.upload.accept?l+=` accept="${e.options.upload.accept}">`:l+=">";const r=new T({id:"insertAsset",icon:"iconDownload",label:`${window.siyuan.languages.insertAsset}${l}`}).element;r.querySelector("input").addEventListener("change",d=>{d.target.files.length!==0&&(ii(e,d.target.files,d.target),window.siyuan.menus.menu.remove())}),window.siyuan.menus.menu.append(r),!fn()&&!pn()&&window.siyuan.menus.menu.append(new T({id:this.mediaRecorder?.isRecording?"endRecord":"startRecord",current:this.mediaRecorder&&this.mediaRecorder.isRecording,icon:"iconRecord",label:this.mediaRecorder?.isRecording?window.siyuan.languages.endRecord:window.siyuan.languages.startRecord,click:async()=>{if(window.siyuan.config.system.os==="darwin"){const d=await ee.ipcRenderer.invoke(u.SIYUAN_GET,{cmd:"getMicrophone"});if(["denied","restricted","unknown"].includes(d)){j(window.siyuan.languages.microphoneDenied);return}else if(d==="not-determined"&&!await ee.ipcRenderer.invoke(u.SIYUAN_GET,{cmd:"askMicrophone"})){j(window.siyuan.languages.microphoneNotAccess);return}}if(!this.mediaRecorder){navigator.mediaDevices.getUserMedia({audio:!0}).then(d=>{this.mediaRecorder=new IT(d),this.mediaRecorder.recorder.onaudioprocess=c=>{if(!this.mediaRecorder.isRecording)return;const f=c.inputBuffer.getChannelData(0),g=c.inputBuffer.getChannelData(1);this.mediaRecorder.cloneChannelData(f,g)},this.startRecord(e)}).catch(()=>{j(window.siyuan.languages["record-tip"])});return}if(this.mediaRecorder.isRecording){this.mediaRecorder.stopRecording(),Ue(this.messageId);const d=new File([this.mediaRecorder.buildWavFileBlob()],`record${new Date().getTime()}.wav`,{type:"video/webm"});ii(e,[d])}else Ue(this.messageId),this.startRecord(e)}}).element)}if(e.disabled||(window.siyuan.menus.menu.append(new T({id:"netImg2LocalAsset",label:window.siyuan.languages.netImg2LocalAsset,icon:"iconImgDown",accelerator:window.siyuan.config.keymap.editor.general.netImg2LocalAsset.custom,click(){vf(e,"Img")}}).element),window.siyuan.menus.menu.append(new T({id:"netAssets2LocalAssets",label:window.siyuan.languages.netAssets2LocalAssets,icon:"iconTransform",accelerator:window.siyuan.config.keymap.editor.general.netAssets2LocalAssets.custom,click(){vf(e,"Assets")}}).element),window.siyuan.menus.menu.append(new T({id:"uploadAssets2CDN",label:window.siyuan.languages.uploadAssets2CDN,icon:"iconCloudSucc",click(){Si()||xe("\u{1F4E6} "+window.siyuan.languages.uploadAssets2CDN,window.siyuan.languages.uploadAssets2CDNConfirmTip,()=>{E("/api/asset/uploadCloud",{id:e.block.parentID})})}}).element),window.siyuan.user&&window.siyuan.menus.menu.append(new T({id:"share2Liandi",label:window.siyuan.languages.share2Liandi,icon:"iconLiandi",click(){xe("\u{1F680} "+window.siyuan.languages.share2Liandi,window.siyuan.languages.share2LiandiConfirmTip,()=>{E("/api/export/export2Liandi",{id:e.block.parentID})})}}).element)),e.scroll?.element.classList.contains("fn__none")||window.siyuan.menus.menu.append(new T({id:"keepLazyLoad",current:e.scroll.keepLazyLoad,label:window.siyuan.languages.keepLazyLoad,click:()=>{e.scroll.keepLazyLoad=!e.scroll.keepLazyLoad}}).element),window.siyuan.menus.menu.element.lastElementChild.childElementCount>0&&window.siyuan.menus.menu.append(new T({id:"separator_1",type:"separator"}).element),window.siyuan.menus.menu.append(new T({id:"refresh",icon:"iconRefresh",accelerator:window.siyuan.config.keymap.editor.general.refresh.custom,label:window.siyuan.languages.refresh,click:()=>{ei(e,!W())}}).element),e.disabled||window.siyuan.menus.menu.append(new T({id:"optimizeTypography",label:window.siyuan.languages.optimizeTypography,accelerator:window.siyuan.config.keymap.editor.general.optimizeTypography.custom,icon:"iconFormat",click:()=>{Q(["toolbar"],e),E("/api/format/autoSpace",{id:e.block.rootID})}}).element),window.siyuan.menus.menu.append(new T({id:"fullscreen",icon:e.element.className.includes("fullscreen")?"iconFullscreenExit":"iconFullscreen",accelerator:window.siyuan.config.keymap.editor.general.fullscreen.custom,label:window.siyuan.languages.fullscreen,click:()=>{to(e.element),Jt(e)}}).element),window.siyuan.menus.menu.append(new T({id:"editMode",icon:"iconEdit",label:window.siyuan.languages["edit-mode"],type:"submenu",submenu:[{id:"wysiwyg",current:!e.contentElement.classList.contains("fn__none"),label:window.siyuan.languages.wysiwyg,accelerator:window.siyuan.config.keymap.editor.general.wysiwyg.custom,click:()=>{mo(e,"wysiwyg"),e.scroll.lastScrollTop=0,E("/api/filetree/getDoc",{id:e.block.parentID,size:window.siyuan.config.editor.dynamicLoadBlocks},l=>{rt({data:l,protyle:e})}),dn()}},{id:"preview",current:!e.preview.element.classList.contains("fn__none"),icon:"iconPreview",label:window.siyuan.languages.preview,accelerator:window.siyuan.config.keymap.editor.general.preview.custom,click:()=>{mo(e,"preview"),window.siyuan.menus.menu.remove(),dn()}}]}).element),!window.siyuan.config.editor.readOnly&&!window.siyuan.config.readonly){const l=e.wysiwyg.element.getAttribute(u.CUSTOM_SY_READONLY);window.siyuan.menus.menu.append(new T({id:"editReadonly",label:window.siyuan.languages.editReadonly,icon:"iconLock",type:"submenu",submenu:[{id:"enable",iconHTML:"",current:l==="true",label:window.siyuan.languages.enable,click(){E("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{[u.CUSTOM_SY_READONLY]:"true"}})}},{id:"disable",iconHTML:"",current:!l||l==="false",label:window.siyuan.languages.disable,click(){E("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{[u.CUSTOM_SY_READONLY]:"false"}})}}]}).element)}if(!e.disabled){const l=e.wysiwyg.element.getAttribute(u.CUSTOM_SY_FULLWIDTH);window.siyuan.menus.menu.append(new T({id:"fullWidth",label:window.siyuan.languages.fullWidth,icon:"iconDock",type:"submenu",submenu:[{id:"enable",iconHTML:"",current:l==="true",label:window.siyuan.languages.enable,click(){E("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{[u.CUSTOM_SY_FULLWIDTH]:"true"}})}},{id:"disable",iconHTML:"",current:l==="false",label:window.siyuan.languages.disable,click(){E("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{[u.CUSTOM_SY_FULLWIDTH]:"false"}})}},{id:"default",iconHTML:"",current:!l,label:window.siyuan.languages.default,click(){E("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{[u.CUSTOM_SY_FULLWIDTH]:""}})}}]}).element)}e?.app?.plugins&&An({plugins:e.app.plugins,type:"open-menu-breadcrumbmore",detail:{protyle:e,data:s.data.stat},separatorPosition:"top"}),window.siyuan.menus.menu.append(new T({id:"separator_2",type:"separator"}).element),window.siyuan.menus.menu.append(new T({id:"docInfo",iconHTML:"",type:"readonly",label:`<div class="fn__flex">${window.siyuan.languages.runeCount}<span class="fn__space fn__flex-1"></span>${s.data.stat.runeCount}</div><div class="fn__flex">${window.siyuan.languages.wordCount}<span class="fn__space fn__flex-1"></span>${s.data.stat.wordCount}</div><div class="fn__flex">${window.siyuan.languages.linkCount}<span class="fn__space fn__flex-1"></span>${s.data.stat.linkCount}</div><div class="fn__flex">${window.siyuan.languages.imgCount}<span class="fn__space fn__flex-1"></span>${s.data.stat.imageCount}</div><div class="fn__flex">${window.siyuan.languages.refCount}<span class="fn__space fn__flex-1"></span>${s.data.stat.refCount}</div><div class="fn__flex">${window.siyuan.languages.blockCount}<span class="fn__space fn__flex-1"></span>${s.data.stat.blockCount}</div>`}).element),window.siyuan.menus.menu.popup(n);const o=Le(e.element,"block__popover",!0);window.siyuan.menus.menu.element.setAttribute("data-from",o?o.dataset.level+"popover":"app")})}render(e,n=!1,a){let i,s;a&&!a.classList.contains("list")?s=a:getSelection().rangeCount>0&&(i=getSelection().getRangeAt(0),!e.wysiwyg.element.isEqualNode(i.startContainer)&&!e.wysiwyg.element.contains(i.startContainer)?e.element.id==="searchPreview"?s=P(e.wysiwyg.element.querySelector('[data-type="search-mark"]')):s=Hn(e.wysiwyg.element.firstElementChild)||e.wysiwyg.element.firstElementChild:s=P(i.startContainer)),s||(s=Hn(e.wysiwyg.element.firstElementChild)||e.wysiwyg.element.firstElementChild);const o=s.getAttribute("data-node-id");if(o===this.id&&!n){e.breadcrumb.element.querySelectorAll(".protyle-breadcrumb__item--active").forEach(d=>{d.classList.remove("protyle-breadcrumb__item--active")});const r=e.breadcrumb.element.querySelector(`[data-node-id="${e.block.showAll?e.block.id:e.block.parentID}"]`);r&&r.classList.add("protyle-breadcrumb__item--active");return}this.id=o;const l=[];this.element.parentElement?.parentElement&&this.element.parentElement.parentElement.classList.contains("card__block")&&l.push("NodeTextMark-mark"),E("/api/block/getBlockBreadcrumb",{id:o,excludeTypes:l},r=>{let d="";r.data.forEach((c,f)=>{let g=!1;(!e.block.showAll&&c.id===e.block.parentID||e.block.showAll&&c.id===e.block.id)&&(g=!0),f===0&&!e.options.render.breadcrumbDocName?d+=`<span class="protyle-breadcrumb__item${g?" protyle-breadcrumb__item--active":""}" data-node-id="${c.id}"${r.data.length===1?' style="max-width:none"':""}>
    <svg class="popover__block" data-id="${c.id}"><use xlink:href="#${Rn(c.type,c.subType)}"></use></svg>
</span>`:d+=`<span class="protyle-breadcrumb__item${g?" protyle-breadcrumb__item--active":""}" data-node-id="${c.id}"${r.data.length===1||f===0?' style="max-width:none"':""}>
    <svg class="popover__block" data-id="${c.id}"><use xlink:href="#${Rn(c.type,c.subType)}"></use></svg>
    <span class="protyle-breadcrumb__text" title="${c.name}">${c.name}</span>
</span>`,f!==r.data.length-1&&(d+='<svg class="protyle-breadcrumb__arrow"><use xlink:href="#iconRight"></use></svg>')}),this.element.innerHTML=d,Tm(this.element.parentElement)})}hide(){W()||(this.element.classList.add("protyle-breadcrumb__bar--hide"),window.siyuan.hideBreadcrumb=!0)}}const KE=t=>t.replace(/\u00a0/g," ");class $T{constructor(e){this.element=document.createElement("div"),this.element.className="protyle-title",window.siyuan.config.editor.displayBookmarkIcon&&this.element.classList.add("protyle-wysiwyg--attr"),this.element.innerHTML=`<span aria-label="${gt()?window.siyuan.languages.gutterTip2:window.siyuan.languages.gutterTip2.replace("\u21E7","Shift+")}" data-position="west" class="protyle-title__icon ariaLabel"><svg><use xlink:href="#iconFile"></use></svg></span>
<div contenteditable="true" spellcheck="${window.siyuan.config.editor.spellcheck}" class="protyle-title__input" data-tip="${window.siyuan.languages._kernel[16]}"> </div><div class="protyle-attr"></div>`,this.editElement=this.element.querySelector(".protyle-title__input"),this.editElement.addEventListener("paste",a=>{a.stopPropagation(),a.preventDefault();let i=a.clipboardData.getData("text/siyuan");i?i=e.lute.BlockDOM2Content(i):i=a.clipboardData.getData("text/plain"),setTimeout(function(){document.execCommand("insertText",!1,On(i))},0),this.rename(e)}),this.editElement.addEventListener("click",()=>{e.toolbar?.element.classList.add("fn__none")}),this.editElement.addEventListener("input",a=>{a.isComposing||(this.editElement.textContent===""&&this.editElement.querySelectorAll("br").forEach(i=>{i.remove()}),this.rename(e))}),this.editElement.addEventListener("compositionend",()=>{this.rename(e)}),this.editElement.addEventListener("drop",a=>{a.stopPropagation(),a.preventDefault()}),this.editElement.addEventListener("keydown",a=>{if(!a.isComposing){if(m_(e,a))return!0;if(H("\u21E7\u2318V",a)&&(navigator.clipboard.readText().then(i=>{i=i.replace(/</g,";;;lt;;;").replace(/>/g,";;;gt;;;"),Ph(e);let s=e.lute.BlockDOM2EscapeMarkerContent(e.lute.Md2BlockDOM(i));yf(e),s=s.replace(/;;;lt;;;[^;]+;;;gt;;;/g,""),document.execCommand("insertText",!1,On(s)),this.rename(e)}),a.preventDefault(),a.stopPropagation()),H(window.siyuan.config.keymap.general.enterBack.custom,a)){const i=e.path.split("/");i.length>2&&de({app:e.app,id:i[i.length-2],action:[u.CB_GET_FOCUS,u.CB_GET_SCROLL]}),a.preventDefault(),a.stopPropagation();return}if(!ni(a))if(a.key==="ArrowDown"){const i=getSelection().getRangeAt(0).getClientRects();if(i.length===0||this.editElement.getBoundingClientRect().bottom-i[i.length-1].bottom<25){const s=Hn(e.wysiwyg.element.firstElementChild);s&&ae(s,e.wysiwyg.element),a.preventDefault(),a.stopPropagation()}}else if(a.key==="Enter"){const i=le(e.wysiwyg.element.firstElementChild);if(i&&i.textContent===""&&!e.wysiwyg.element.firstElementChild.classList.contains("av"))ae(e.wysiwyg.element.firstElementChild,e.wysiwyg.element);else{const s=Lute.NewNodeID(),o=pa(!1,!0,s);e.wysiwyg.element.insertAdjacentElement("afterbegin",o),he(o,e.toolbar.range||me(o)),U(e,[{action:"insert",data:o.outerHTML,id:s,parentID:e.block.parentID}],[{action:"delete",id:s}])}a.preventDefault(),a.stopPropagation()}else H(window.siyuan.config.keymap.editor.general.attr.custom,a)?(E("/api/block/getDocInfo",{id:e.block.rootID},i=>{Gn(i.data.ial,"bookmark",e)}),a.preventDefault(),a.stopPropagation()):H("\u2318A",a)&&(me(this.editElement).selectNodeContents(this.editElement),a.preventDefault(),a.stopPropagation())}});const n=this.element.querySelector(".protyle-title__icon");n.addEventListener("click",()=>{if(window.siyuan.shiftIsPressed)E("/api/block/getDocInfo",{id:e.block.rootID},a=>{Gn(a.data.ial,"bookmark",e)});else{const a=n.getBoundingClientRect();kb(e,{x:a.left,y:a.bottom})}}),this.element.addEventListener("contextmenu",a=>{if(a.shiftKey)return;if(getSelection().rangeCount===0){kb(e,{x:a.clientX,y:a.clientY});return}e.toolbar?.element.classList.add("fn__none"),window.siyuan.menus.menu.remove();const i=me(this.editElement);i.toString()!==""&&(window.siyuan.menus.menu.append(new T({id:"copy",icon:"iconCopy",accelerator:"\u2318C",label:window.siyuan.languages.copy,click:()=>{Z(me(this.editElement)),document.execCommand("copy")}}).element),window.siyuan.menus.menu.append(new T({id:"cut",icon:"iconCut",accelerator:"\u2318X",label:window.siyuan.languages.cut,click:()=>{Z(me(this.editElement)),document.execCommand("cut"),setTimeout(()=>{this.rename(e)},u.TIMEOUT_INPUT)}}).element),window.siyuan.menus.menu.append(new T({id:"delete",icon:"iconTrashcan",accelerator:"\u232B",label:window.siyuan.languages.delete,click:()=>{const s=me(this.editElement);s.extractContents(),Z(s),setTimeout(()=>{this.rename(e)},u.TIMEOUT_INPUT)}}).element)),window.siyuan.menus.menu.append(new T({id:"paste",label:window.siyuan.languages.paste,icon:"iconPaste",accelerator:"\u2318V",click:async()=>{if(Z(me(this.editElement)),document.queryCommandSupported("paste"))document.execCommand("paste");else try{const s=await Qu();document.execCommand("insertText",!1,On(s)),this.rename(e)}catch(s){console.log(s)}}}).element),window.siyuan.menus.menu.append(new T({id:"pasteAsPlainText",label:window.siyuan.languages.pasteAsPlainText,accelerator:"\u21E7\u2318V",click:async()=>{navigator.clipboard.readText().then(s=>{s=s.replace(/</g,";;;lt;;;").replace(/>/g,";;;gt;;;"),Ph(e);let o=e.lute.BlockDOM2EscapeMarkerContent(e.lute.Md2BlockDOM(s));yf(e),o=o.replace(/;;;lt;;;[^;]+;;;gt;;;/g,""),document.execCommand("insertText",!1,On(o)),this.rename(e)})}}).element),window.siyuan.menus.menu.append(new T({id:"selectAll",label:window.siyuan.languages.selectAll,icon:"iconSelect",accelerator:"\u2318A",click:()=>{i.selectNodeContents(this.editElement),Z(i)}}).element),window.siyuan.menus.menu.popup({x:a.clientX,y:a.clientY})}),this.element.querySelector(".protyle-attr").addEventListener("click",a=>{E("/api/block/getDocInfo",{id:e.block.rootID},i=>{zE(a,e,i.data.ial)})})}rename(e){if(clearTimeout(this.timeout),!pf(this.editElement.textContent,this.editElement)){const n=ct(this.editElement);return this.setTitle(this.editElement.textContent.substring(0,u.SIZE_TITLE)),na(this.editElement,n.start,n.end),!1}Zt(),this.timeout=window.setTimeout(()=>{const n=On(this.editElement.textContent);E("/api/filetree/renameDoc",{notebook:e.notebookId,path:e.path,title:n}),this.setTitle(n),Oc(n)},u.TIMEOUT_INPUT)}setTitle(e){KE(e)!==KE(this.editElement.textContent)&&(this.editElement.textContent=e===window.siyuan.languages.untitled?"":e)}render(e,n){if(this.element.getAttribute("data-render")==="true")return!1;this.element.setAttribute("data-node-id",e.block.rootID),n.data.ial[u.CUSTOM_RIFF_DECKS]&&this.element.setAttribute(u.CUSTOM_RIFF_DECKS,n.data.ial[u.CUSTOM_RIFF_DECKS]),e.background?.render(n.data.ial,e.block.rootID),e.wysiwyg.renderCustom(n.data.ial),this.element.setAttribute("data-render","true"),this.setTitle(n.data.ial.title);let a="";if(n.data.ial.bookmark&&(a+=`<div class="protyle-attr--bookmark">${Lute.EscapeHTMLStr(n.data.ial.bookmark)}</div>`),n.data.ial.name&&(a+=`<div class="protyle-attr--name"><svg><use xlink:href="#iconN"></use></svg>${Lute.EscapeHTMLStr(n.data.ial.name)}</div>`),n.data.ial.alias&&(a+=`<div class="protyle-attr--alias"><svg><use xlink:href="#iconA"></use></svg>${Lute.EscapeHTMLStr(n.data.ial.alias)}</div>`),n.data.ial.memo&&(a+=`<div class="protyle-attr--memo b3-tooltips b3-tooltips__sw" aria-label="${Lute.EscapeHTMLStr(n.data.ial.memo)}"><svg><use xlink:href="#iconM"></use></svg></div>`),n.data.ial["custom-avs"]){let i="";n.data.attrViews.forEach(s=>{i+=`<span data-av-id="${s.id}" data-popover-url="/api/av/getMirrorDatabaseBlocks" class="popover__block">${s.name}</span>&nbsp;`}),i&&(i=i.substring(0,i.length-6)),a+=`<div class="protyle-attr--av"><svg><use xlink:href="#iconDatabase"></use></svg>${i}</div>`}if(this.element.querySelector(".protyle-attr").innerHTML=a,n.data.refCount!==0&&this.element.querySelector(".protyle-attr").insertAdjacentHTML("beforeend",`<div class="protyle-attr--refcount popover__block">${n.data.refCount}</div>`),this.editElement&&new Date().getTime()-Y(n.data.id.split("-")[0]).toDate().getTime()<2e3){const i=this.editElement.ownerDocument.createRange();i.selectNodeContents(this.editElement),Z(i)}}}const Cp=["background:radial-gradient(black 3px, transparent 4px),radial-gradient(black 3px, transparent 4px),linear-gradient(#fff 4px, transparent 0),linear-gradient(45deg, transparent 74px, transparent 75px, #a4a4a4 75px, #a4a4a4 76px, transparent 77px, transparent 109px),linear-gradient(-45deg, transparent 75px, transparent 76px, #a4a4a4 76px, #a4a4a4 77px, transparent 78px, transparent 109px),#fff;background-size: 109px 109px, 109px 109px,100% 6px, 109px 109px, 109px 109px;background-position: 54px 55px, 0px 0px, 0px 0px, 0px 0px, 0px 0px;","background: linear-gradient(45deg, #dca 12%, transparent 0, transparent 88%, #dca 0),linear-gradient(135deg, transparent 37%, #a85 0, #a85 63%, transparent 0),linear-gradient(45deg, transparent 37%, #dca 0, #dca 63%, transparent 0) #753;background-size: 25px 25px;","background: linear-gradient(315deg, transparent 75%, #d45d55 0)-10px 0, linear-gradient(45deg, transparent 75%, #d45d55 0)-10px 0, linear-gradient(135deg, #a7332b 50%, transparent 0) 0 0, linear-gradient(45deg, #6a201b 50%, #561a16 0) 0 0 #561a16;background-size: 20px 20px;","background: linear-gradient(#ffffff 50%, rgba(255,255,255,0) 0) 0 0, radial-gradient(circle closest-side, #FFFFFF 53%, rgba(255,255,255,0) 0) 0 0, radial-gradient(circle closest-side, #FFFFFF 50%, rgba(255,255,255,0) 0) 55px 0 #48B;background-size: 110px 200px;background-repeat: repeat-x;","background:radial-gradient(circle farthest-side at 0% 50%,#fb1 23.5%,rgba(240,166,17,0) 0)21px 30px, radial-gradient(circle farthest-side at 0% 50%,#B71 24%,rgba(240,166,17,0) 0)19px 30px, linear-gradient(#fb1 14%,rgba(240,166,17,0) 0, rgba(240,166,17,0) 85%,#fb1 0)0 0, linear-gradient(150deg,#fb1 24%,#B71 0,#B71 26%,rgba(240,166,17,0) 0,rgba(240,166,17,0) 74%,#B71 0,#B71 76%,#fb1 0)0 0, linear-gradient(30deg,#fb1 24%,#B71 0,#B71 26%,rgba(240,166,17,0) 0,rgba(240,166,17,0) 74%,#B71 0,#B71 76%,#fb1 0)0 0, linear-gradient(90deg,#B71 2%,#fb1 0,#fb1 98%,#B71 0%)0 0 #fb1;background-size: 40px 60px;","background-color: gray;background-image: linear-gradient(transparent 50%, rgba(255,255,255,.5) 50%);background-size: 50px 50px;","background-color: gray;background-image: linear-gradient(90deg, transparent 50%, rgba(255,255,255,.5) 50%);background-size: 50px 50px;","background-color: #026873;background-image: linear-gradient(90deg, rgba(255,255,255,.07) 50%, transparent 50%),linear-gradient(90deg, rgba(255,255,255,.13) 50%, transparent 50%),linear-gradient(90deg, transparent 50%, rgba(255,255,255,.17) 50%),linear-gradient(90deg, transparent 50%, rgba(255,255,255,.19) 50%);background-size: 13px, 29px, 37px, 53px;","background-color: gray;background-image: repeating-linear-gradient(45deg, transparent, transparent 35px, rgba(255,255,255,.5) 35px, rgba(255,255,255,.5) 70px);","background-color:white;background-image: linear-gradient(90deg, rgba(200,0,0,.5) 50%, transparent 50%),linear-gradient(rgba(200,0,0,.5) 50%, transparent 50%);background-size:50px 50px;","background-color:#269;background-image: linear-gradient(white 2px, transparent 2px),linear-gradient(90deg, white 2px, transparent 2px),linear-gradient(rgba(255,255,255,.3) 1px, transparent 1px),linear-gradient(90deg, rgba(255,255,255,.3) 1px, transparent 1px);background-size: 100px 100px, 100px 100px, 20px 20px, 20px 20px;background-position:-2px -2px, -2px -2px, -1px -1px, -1px -1px;","background-color: #fff;background-image:linear-gradient(90deg, transparent 79px, #abced4 79px, #abced4 81px, transparent 81px),linear-gradient(#eee .1em, transparent .1em);background-size: 100% 1.2em;","background-color: hsl(34, 53%, 82%);background-image: repeating-linear-gradient(45deg, transparent 5px, hsla(197, 62%, 11%, 0.5) 5px, hsla(197, 62%, 11%, 0.5) 10px, hsla(5, 53%, 63%, 0) 10px, hsla(5, 53%, 63%, 0) 35px, hsla(5, 53%, 63%, 0.5) 35px, hsla(5, 53%, 63%, 0.5) 40px, hsla(197, 62%, 11%, 0.5) 40px, hsla(197, 62%, 11%, 0.5) 50px, hsla(197, 62%, 11%, 0) 50px, hsla(197, 62%, 11%, 0) 60px, hsla(5, 53%, 63%, 0.5) 60px, hsla(5, 53%, 63%, 0.5) 70px, hsla(35, 91%, 65%, 0.5) 70px, hsla(35, 91%, 65%, 0.5) 80px, hsla(35, 91%, 65%, 0) 80px, hsla(35, 91%, 65%, 0) 90px, hsla(5, 53%, 63%, 0.5) 90px, hsla(5, 53%, 63%, 0.5) 110px, hsla(5, 53%, 63%, 0) 110px, hsla(5, 53%, 63%, 0) 120px, hsla(197, 62%, 11%, 0.5) 120px, hsla(197, 62%, 11%, 0.5) 140px),repeating-linear-gradient(135deg, transparent 5px, hsla(197, 62%, 11%, 0.5) 5px, hsla(197, 62%, 11%, 0.5) 10px, hsla(5, 53%, 63%, 0) 10px, hsla(5, 53%, 63%, 0) 35px, hsla(5, 53%, 63%, 0.5) 35px, hsla(5, 53%, 63%, 0.5) 40px, hsla(197, 62%, 11%, 0.5) 40px, hsla(197, 62%, 11%, 0.5) 50px, hsla(197, 62%, 11%, 0) 50px, hsla(197, 62%, 11%, 0) 60px, hsla(5, 53%, 63%, 0.5) 60px, hsla(5, 53%, 63%, 0.5) 70px, hsla(35, 91%, 65%, 0.5) 70px, hsla(35, 91%, 65%, 0.5) 80px, hsla(35, 91%, 65%, 0) 80px, hsla(35, 91%, 65%, 0) 90px, hsla(5, 53%, 63%, 0.5) 90px, hsla(5, 53%, 63%, 0.5) 110px, hsla(5, 53%, 63%, 0) 110px, hsla(5, 53%, 63%, 0) 140px, hsla(197, 62%, 11%, 0.5) 140px, hsla(197, 62%, 11%, 0.5) 160px);","background-color: hsl(2, 57%, 40%);background-image: repeating-linear-gradient(transparent, transparent 50px, rgba(0,0,0,.4) 50px, rgba(0,0,0,.4) 53px, transparent 53px, transparent 63px, rgba(0,0,0,.4) 63px, rgba(0,0,0,.4) 66px, transparent 66px, transparent 116px, rgba(0,0,0,.5) 116px, rgba(0,0,0,.5) 166px, rgba(255,255,255,.2) 166px, rgba(255,255,255,.2) 169px, rgba(0,0,0,.5) 169px, rgba(0,0,0,.5) 179px, rgba(255,255,255,.2) 179px, rgba(255,255,255,.2) 182px, rgba(0,0,0,.5) 182px, rgba(0,0,0,.5) 232px, transparent 232px),repeating-linear-gradient(270deg, transparent, transparent 50px, rgba(0,0,0,.4) 50px, rgba(0,0,0,.4) 53px, transparent 53px, transparent 63px, rgba(0,0,0,.4) 63px, rgba(0,0,0,.4) 66px, transparent 66px, transparent 116px, rgba(0,0,0,.5) 116px, rgba(0,0,0,.5) 166px, rgba(255,255,255,.2) 166px, rgba(255,255,255,.2) 169px, rgba(0,0,0,.5) 169px, rgba(0,0,0,.5) 179px, rgba(255,255,255,.2) 179px, rgba(255,255,255,.2) 182px, rgba(0,0,0,.5) 182px, rgba(0,0,0,.5) 232px, transparent 232px),repeating-linear-gradient(125deg, transparent, transparent 2px, rgba(0,0,0,.2) 2px, rgba(0,0,0,.2) 3px, transparent 3px, transparent 5px, rgba(0,0,0,.2) 5px);","background-color: #eee;background-image: linear-gradient(45deg, black 25%, transparent 25%, transparent 75%, black 75%, black),linear-gradient(-45deg, black 25%, transparent 25%, transparent 75%, black 75%, black);background-size: 60px 60px;","background-color: #eee;background-image: linear-gradient(45deg, black 25%, transparent 25%, transparent 75%, black 75%, black),linear-gradient(45deg, black 25%, transparent 25%, transparent 75%, black 75%, black);background-size: 60px 60px;background-position: 0 0, 30px 30px;","background:linear-gradient(-45deg, white 25%, transparent 25%, transparent 75%, black 75%, black) 0 0, linear-gradient(-45deg, black 25%, transparent 25%, transparent 75%, white 75%, white) 1em 1em, linear-gradient(45deg, black 17%, transparent 17%, transparent 25%, black 25%, black 36%, transparent 36%, transparent 64%, black 64%, black 75%, transparent 75%, transparent 83%, black 83%) 1em 1em;background-color: white;background-size: 2em 2em;","background-color:#001;background-image: radial-gradient(white 15%, transparent 16%),radial-gradient(white 15%, transparent 16%);background-size: 60px 60px;background-position: 0 0, 30px 30px;","background-color:#556;background-image: linear-gradient(30deg, #445 12%, transparent 12.5%, transparent 87%, #445 87.5%, #445),linear-gradient(150deg, #445 12%, transparent 12.5%, transparent 87%, #445 87.5%, #445),linear-gradient(30deg, #445 12%, transparent 12.5%, transparent 87%, #445 87.5%, #445),linear-gradient(150deg, #445 12%, transparent 12.5%, transparent 87%, #445 87.5%, #445),linear-gradient(60deg, #99a 25%, transparent 25.5%, transparent 75%, #99a 75%, #99a),linear-gradient(60deg, #99a 25%, transparent 25.5%, transparent 75%, #99a 75%, #99a);background-size:80px 140px;background-position: 0 0, 0 0, 40px 70px, 40px 70px, 0 0, 40px 70px;","background-color:silver;background-image:radial-gradient(circle at 100% 150%, silver 24%, white 24%, white 28%, silver 28%, silver 36%, white 36%, white 40%, transparent 40%, transparent),radial-gradient(circle at 0    150%, silver 24%, white 24%, white 28%, silver 28%, silver 36%, white 36%, white 40%, transparent 40%, transparent),radial-gradient(circle at 50%  100%, white 10%, silver 10%, silver 23%, white 23%, white 30%, silver 30%, silver 43%, white 43%, white 50%, silver 50%, silver 63%, white 63%, white 71%, transparent 71%, transparent),radial-gradient(circle at 100% 50%, white 5%, silver 5%, silver 15%, white 15%, white 20%, silver 20%, silver 29%, white 29%, white 34%, silver 34%, silver 44%, white 44%, white 49%, transparent 49%, transparent),radial-gradient(circle at 0    50%, white 5%, silver 5%, silver 15%, white 15%, white 20%, silver 20%, silver 29%, white 29%, white 34%, silver 34%, silver 44%, white 44%, white 49%, transparent 49%, transparent);background-size: 100px 50px;","background-color: silver;background-image: linear-gradient(335deg, #b00 23px, transparent 23px),linear-gradient(155deg, #d00 23px, transparent 23px),linear-gradient(335deg, #b00 23px, transparent 23px),linear-gradient(155deg, #d00 23px, transparent 23px);background-size: 58px 58px;background-position: 0px 2px, 4px 35px, 29px 31px, 34px 6px;","background-color:#def;background-image: radial-gradient(closest-side, transparent 98%, rgba(0,0,0,.3) 99%),radial-gradient(closest-side, transparent 98%, rgba(0,0,0,.3) 99%);background-size:80px 80px;background-position:0 0, 40px 40px;","background-image:radial-gradient(closest-side, transparent 0%, transparent 75%, #B6CC66 76%, #B6CC66 85%, #EDFFDB 86%, #EDFFDB 94%, #FFFFFF 95%, #FFFFFF 103%, #D9E6A7 104%, #D9E6A7 112%, #798B3C 113%, #798B3C 121%, #FFFFFF 122%, #FFFFFF 130%, #E0EAD7 131%, #E0EAD7 140%),radial-gradient(closest-side, transparent 0%, transparent 75%, #B6CC66 76%, #B6CC66 85%, #EDFFDB 86%, #EDFFDB 94%, #FFFFFF 95%, #FFFFFF 103%, #D9E6A7 104%, #D9E6A7 112%, #798B3C 113%, #798B3C 121%, #FFFFFF 122%, #FFFFFF 130%, #E0EAD7 131%, #E0EAD7 140%);background-size: 110px 110px;background-color: #C8D3A7;background-position: 0 0, 55px 55px;","background:linear-gradient(324deg, #232927 4%,   transparent 4%) -70px 43px, linear-gradient( 36deg, #232927 4%,   transparent 4%) 30px 43px, linear-gradient( 72deg, #e3d7bf 8.5%, transparent 8.5%) 30px 43px, linear-gradient(288deg, #e3d7bf 8.5%, transparent 8.5%) -70px 43px, linear-gradient(216deg, #e3d7bf 7.5%, transparent 7.5%) -70px 23px, linear-gradient(144deg, #e3d7bf 7.5%, transparent 7.5%) 30px 23px, linear-gradient(324deg, #232927 4%,   transparent 4%) -20px 93px, linear-gradient( 36deg, #232927 4%,   transparent 4%) 80px 93px, linear-gradient( 72deg, #e3d7bf 8.5%, transparent 8.5%) 80px 93px, linear-gradient(288deg, #e3d7bf 8.5%, transparent 8.5%) -20px 93px, linear-gradient(216deg, #e3d7bf 7.5%, transparent 7.5%) -20px 73px, linear-gradient(144deg, #e3d7bf 7.5%, transparent 7.5%) 80px 73px;background-color: #232927;background-size: 100px 100px;","background:radial-gradient(circle at 50% 59%, #D2CAAB 3%, #364E27 4%, #364E27 11%, rgba(54,78,39,0) 12%, rgba(54,78,39,0)) 50px 0, radial-gradient(circle at 50% 41%, #364E27 3%, #D2CAAB 4%, #D2CAAB 11%, rgba(210,202,171,0) 12%, rgba(210,202,171,0)) 50px 0, radial-gradient(circle at 50% 59%, #D2CAAB 3%, #364E27 4%, #364E27 11%, rgba(54,78,39,0) 12%, rgba(54,78,39,0)) 0 50px, radial-gradient(circle at 50% 41%, #364E27 3%, #D2CAAB 4%, #D2CAAB 11%, rgba(210,202,171,0) 12%, rgba(210,202,171,0)) 0 50px, radial-gradient(circle at 100% 50%, #D2CAAB 16%, rgba(210,202,171,0) 17%),radial-gradient(circle at 0% 50%, #364E27 16%, rgba(54,78,39,0) 17%),radial-gradient(circle at 100% 50%, #D2CAAB 16%, rgba(210,202,171,0) 17%) 50px 50px, radial-gradient(circle at 0% 50%, #364E27 16%, rgba(54,78,39,0) 17%) 50px 50px;background-color:#63773F;background-size:100px 100px;","background:radial-gradient(circle, transparent 20%, slategray 20%, slategray 80%, transparent 80%, transparent),radial-gradient(circle, transparent 20%, slategray 20%, slategray 80%, transparent 80%, transparent) 50px 50px, linear-gradient(#A8B1BB 8px, transparent 8px) 0 -4px, linear-gradient(90deg, #A8B1BB 8px, transparent 8px) -4px 0;background-color: slategray;background-size:100px 100px, 100px 100px, 50px 50px, 50px 50px;","background:radial-gradient(circle at 100% 50%, transparent 20%, rgba(255,255,255,.3) 21%, rgba(255,255,255,.3) 34%, transparent 35%, transparent),radial-gradient(circle at 0% 50%, transparent 20%, rgba(255,255,255,.3) 21%, rgba(255,255,255,.3) 34%, transparent 35%, transparent) 0 -50px;background-color: slategray;background-size:75px 100px;","background-color: #FF7D9D;background-size: 58px 58px;background-position: 0px 2px, 4px 35px, 29px 31px, 33px 6px, 0px 36px, 4px 2px, 29px 6px, 33px 30px;background-image:linear-gradient(335deg, #C90032 23px, transparent 23px),linear-gradient(155deg, #C90032 23px, transparent 23px),linear-gradient(335deg, #C90032 23px, transparent 23px),linear-gradient(155deg, #C90032 23px, transparent 23px),linear-gradient(335deg, #C90032 10px, transparent 10px),linear-gradient(155deg, #C90032 10px, transparent 10px),linear-gradient(335deg, #C90032 10px, transparent 10px),linear-gradient(155deg, #C90032 10px, transparent 10px);","background-color: #6d695c;background-image:repeating-linear-gradient(120deg, rgba(255,255,255,.1), rgba(255,255,255,.1) 1px, transparent 1px, transparent 60px),repeating-linear-gradient(60deg, rgba(255,255,255,.1), rgba(255,255,255,.1) 1px, transparent 1px, transparent 60px),linear-gradient(60deg, rgba(0,0,0,.1) 25%, transparent 25%, transparent 75%, rgba(0,0,0,.1) 75%, rgba(0,0,0,.1)),linear-gradient(120deg, rgba(0,0,0,.1) 25%, transparent 25%, transparent 75%, rgba(0,0,0,.1) 75%, rgba(0,0,0,.1));background-size: 70px 120px;","background:radial-gradient(circle closest-side at 60% 43%, #b03 26%, rgba(187,0,51,0) 27%),radial-gradient(circle closest-side at 40% 43%, #b03 26%, rgba(187,0,51,0) 27%),radial-gradient(circle closest-side at 40% 22%, #d35 45%, rgba(221,51,85,0) 46%),radial-gradient(circle closest-side at 60% 22%, #d35 45%, rgba(221,51,85,0) 46%),radial-gradient(circle closest-side at 50% 35%, #d35 30%, rgba(221,51,85,0) 31%),radial-gradient(circle closest-side at 60% 43%, #b03 26%, rgba(187,0,51,0) 27%) 50px 50px, radial-gradient(circle closest-side at 40% 43%, #b03 26%, rgba(187,0,51,0) 27%) 50px 50px, radial-gradient(circle closest-side at 40% 22%, #d35 45%, rgba(221,51,85,0) 46%) 50px 50px, radial-gradient(circle closest-side at 60% 22%, #d35 45%, rgba(221,51,85,0) 46%) 50px 50px, radial-gradient(circle closest-side at 50% 35%, #d35 30%, rgba(221,51,85,0) 31%) 50px 50px;background-color:#b03;background-size:100px 100px;","background:radial-gradient(black 15%, transparent 16%) 0 0, radial-gradient(black 15%, transparent 16%) 8px 8px, radial-gradient(rgba(255,255,255,.1) 15%, transparent 20%) 0 1px, radial-gradient(rgba(255,255,255,.1) 15%, transparent 20%) 8px 9px;background-color:#282828;background-size:16px 16px;","background:linear-gradient(27deg, #151515 5px, transparent 5px) 0 5px, linear-gradient(207deg, #151515 5px, transparent 5px) 10px 0px, linear-gradient(27deg, #222 5px, transparent 5px) 0px 10px, linear-gradient(207deg, #222 5px, transparent 5px) 10px 5px, linear-gradient(90deg, #1b1b1b 10px, transparent 10px),linear-gradient(#1d1d1d 25%, #1a1a1a 25%, #1a1a1a 50%, transparent 50%, transparent 75%, #242424 75%, #242424);background-color: #131313;background-size: 20px 20px;","background:radial-gradient(rgba(255,255,255,0) 0, rgba(255,255,255,.15) 30%, rgba(255,255,255,.3) 32%, rgba(255,255,255,0) 33%) 0 0, radial-gradient(rgba(255,255,255,0) 0, rgba(255,255,255,.1) 11%, rgba(255,255,255,.3) 13%, rgba(255,255,255,0) 14%) 0 0, radial-gradient(rgba(255,255,255,0) 0, rgba(255,255,255,.2) 17%, rgba(255,255,255,.43) 19%, rgba(255,255,255,0) 20%) 0 110px, radial-gradient(rgba(255,255,255,0) 0, rgba(255,255,255,.2) 11%, rgba(255,255,255,.4) 13%, rgba(255,255,255,0) 14%) -130px -170px, radial-gradient(rgba(255,255,255,0) 0, rgba(255,255,255,.2) 11%, rgba(255,255,255,.4) 13%, rgba(255,255,255,0) 14%) 130px 370px, radial-gradient(rgba(255,255,255,0) 0, rgba(255,255,255,.1) 11%, rgba(255,255,255,.2) 13%, rgba(255,255,255,0) 14%) 0 0, linear-gradient(45deg, #343702 0%, #184500 20%, #187546 30%, #006782 40%, #0b1284 50%, #760ea1 60%, #83096e 70%, #840b2a 80%, #b13e12 90%, #e27412 100%);background-size: 470px 470px, 970px 970px, 410px 410px, 610px 610px, 530px 530px, 730px 730px, 100% 100%;background-color: #840b2a;","background-color:white;background-image:radial-gradient(midnightblue 9px, transparent 10px),repeating-radial-gradient(midnightblue 0, midnightblue 4px, transparent 5px, transparent 20px, midnightblue 21px, midnightblue 25px, transparent 26px, transparent 50px);background-size: 30px 30px, 90px 90px;background-position: 0 0;","background-color:black;background-image:radial-gradient(white, rgba(255,255,255,.2) 2px, transparent 40px),radial-gradient(white, rgba(255,255,255,.15) 1px, transparent 30px),radial-gradient(white, rgba(255,255,255,.1) 2px, transparent 40px),radial-gradient(rgba(255,255,255,.4), rgba(255,255,255,.1) 2px, transparent 30px);background-size: 550px 550px, 350px 350px, 250px 250px, 150px 150px;background-position: 0 0, 40px 60px, 130px 270px, 70px 100px;","background:radial-gradient(hsl(0, 100%, 27%) 4%, hsl(0, 100%, 18%) 9%, hsla(0, 100%, 20%, 0) 9%) 0 0, radial-gradient(hsl(0, 100%, 27%) 4%, hsl(0, 100%, 18%) 8%, hsla(0, 100%, 20%, 0) 10%) 50px 50px, radial-gradient(hsla(0, 100%, 30%, 0.8) 20%, hsla(0, 100%, 20%, 0)) 50px 0, radial-gradient(hsla(0, 100%, 30%, 0.8) 20%, hsla(0, 100%, 20%, 0)) 0 50px, radial-gradient(hsla(0, 100%, 20%, 1) 35%, hsla(0, 100%, 20%, 0) 60%) 50px 0, radial-gradient(hsla(0, 100%, 20%, 1) 35%, hsla(0, 100%, 20%, 0) 60%) 100px 50px, radial-gradient(hsla(0, 100%, 15%, 0.7), hsla(0, 100%, 20%, 0)) 0 0, radial-gradient(hsla(0, 100%, 15%, 0.7), hsla(0, 100%, 20%, 0)) 50px 50px, linear-gradient(45deg, hsla(0, 100%, 20%, 0) 49%, hsla(0, 100%, 0%, 1) 50%, hsla(0, 100%, 20%, 0) 70%) 0 0, linear-gradient(-45deg, hsla(0, 100%, 20%, 0) 49%, hsla(0, 100%, 0%, 1) 50%, hsla(0, 100%, 20%, 0) 70%) 0 0;background-color: #300;background-size: 100px 100px;","background:linear-gradient(135deg, #708090 21px, #d9ecff 22px, #d9ecff 24px, transparent 24px, transparent 67px, #d9ecff 67px, #d9ecff 69px, transparent 69px),linear-gradient(225deg, #708090 21px, #d9ecff 22px, #d9ecff 24px, transparent 24px, transparent 67px, #d9ecff 67px, #d9ecff 69px, transparent 69px)0 64px;background-color:#708090;background-size: 64px 128px;","background:linear-gradient(135deg, #ECEDDC 25%, transparent 25%) -50px 0, linear-gradient(225deg, #ECEDDC 25%, transparent 25%) -50px 0, linear-gradient(315deg, #ECEDDC 25%, transparent 25%),linear-gradient(45deg, #ECEDDC 25%, transparent 25%);background-size: 100px 100px;background-color: #EC173A;","background:linear-gradient(45deg, #92baac 45px, transparent 45px)64px 64px, linear-gradient(45deg, #92baac 45px, transparent 45px,transparent 91px, #e1ebbd 91px, #e1ebbd 135px, transparent 135px),linear-gradient(-45deg, #92baac 23px, transparent 23px, transparent 68px,#92baac 68px,#92baac 113px,transparent 113px,transparent 158px,#92baac 158px);background-color:#e1ebbd;background-size: 128px 128px;","background:linear-gradient(63deg, #999 23%, transparent 23%) 7px 0,linear-gradient(63deg, transparent 74%, #999 78%),linear-gradient(63deg, transparent 34%, #999 38%, #999 58%, transparent 62%),#444;background-size: 16px 48px;","background:#36c;background:linear-gradient(115deg, transparent 75%, rgba(255,255,255,.8) 75%) 0 0,linear-gradient(245deg, transparent 75%, rgba(255,255,255,.8) 75%) 0 0,linear-gradient(115deg, transparent 75%, rgba(255,255,255,.8) 75%) 7px -15px,linear-gradient(245deg, transparent 75%, rgba(255,255,255,.8) 75%) 7px -15px,#36c;background-size: 15px 30px;","background:radial-gradient(circle at 0% 50%, rgba(96, 16, 48, 0) 9px, #613 10px, rgba(96, 16, 48, 0) 11px) 0px 10px,radial-gradient(at 100% 100%,rgba(96, 16, 48, 0) 9px, #613 10px, rgba(96, 16, 48, 0) 11px),#8a3;background-size: 20px 20px;","background-image:linear-gradient(to top, #a18cd1 0%, #fbc2eb 100%)","background-image:linear-gradient(to top, #fbc2eb 0%, #a6c1ee 100%)","background-image:linear-gradient(120deg, #a6c0fe 0%, #f68084 100%)","background-image:linear-gradient(120deg, #e0c3fc 0%, #8ec5fc 100%)","background-image:linear-gradient(to right, #fa709a 0%, #fee140 100%)","background-image:linear-gradient(to top, #30cfd0 0%, #330867 100%)","background-image:linear-gradient(to top, #a8edea 0%, #fed6e3 100%)","background-image:linear-gradient(to top, #d299c2 0%, #fef9d7 100%)","background-image:linear-gradient(to top, #fddb92 0%, #d1fdff 100%)","background-image:linear-gradient(to top, #9890e3 0%, #b1f4cf 100%)","background-image:linear-gradient(to top, #96fbc4 0%, #f9f586 100%)","background-image:linear-gradient(to right, #eea2a2 0%, #bbc1bf 19%, #57c6e1 42%, #b49fda 79%, #7ac5d8 100%)","background-image:linear-gradient(to top, #9795f0 0%, #fbc8d4 100%)","background-image:linear-gradient(to top, #3f51b1 0%, #5a55ae 13%, #7b5fac 25%, #8f6aae 38%, #a86aa4 50%, #cc6b8e 62%, #f18271 75%, #f3a469 87%, #f7c978 100%)","background-image:linear-gradient(to top, #f43b47 0%, #453a94 100%)","background-image:linear-gradient(to top, #88d3ce 0%, #6e45e2 100%)","background-image:linear-gradient(to top, #d9afd9 0%, #97d9e1 100%)","background-image:linear-gradient(-20deg, #b721ff 0%, #21d4fd 100%)","background-image:linear-gradient(60deg, #abecd6 0%, #fbed96 100%)","background-image:linear-gradient(to top, #3b41c5 0%, #a981bb 49%, #ffc8a9 100%)","background-image:linear-gradient(to top, #0fd850 0%, #f9f047 100%)","background-image:linear-gradient(to top, #d5dee7 0%, #ffafbd 0%, #c9ffbf 100%)","background-image:linear-gradient(to top, #65bd60 0%, #5ac1a8 25%, #3ec6ed 50%, #b7ddb7 75%, #fef381 100%)","background-image:linear-gradient(to top, #50cc7f 0%, #f5d100 100%)","background-image:linear-gradient(to top, #df89b5 0%, #bfd9fe 100%)","background-image:linear-gradient(to top, #e14fad 0%, #f9d423 100%)","background-image:linear-gradient(to right, #ec77ab 0%, #7873f5 100%)","background-image:linear-gradient(-225deg, #2CD8D5 0%, #C5C1FF 56%, #FFBAC3 100%)","background-image:linear-gradient(-225deg, #5271C4 0%, #B19FFF 48%, #ECA1FE 100%)","background-image:linear-gradient(-225deg, #FF3CAC 0%, #562B7C 52%, #2B86C5 100%)","background-image:linear-gradient(-225deg, #69EACB 0%, #EACCF8 48%, #6654F1 100%)","background-image:linear-gradient(-225deg, #231557 0%, #44107A 29%, #FF1361 67%, #FFF800 100%)"];class MT{constructor(e){this.transparentData="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=",this.element=document.createElement("div"),this.element.className="protyle-background",this.element.innerHTML=`<div class="protyle-background__img">
    <img src="${this.transparentData}">
    <div class="protyle-icons">
        <span class="protyle-icon protyle-icon--first" style="position: relative;overflow: hidden"><input aria-label="${window.siyuan.languages.upload}" class="ariaLabel" type="file" style="position: absolute;height: 100%;top: 0;right: 0;opacity: .001;overflow: hidden;cursor: pointer;"><svg><use xlink:href="#iconUpload"></use></svg></span>
        <span class="protyle-icon ariaLabel" data-type="link" aria-label="${window.siyuan.languages.link}"><svg><use xlink:href="#iconLink"></use></svg></span>
        <span class="protyle-icon ariaLabel" data-type="asset" aria-label="${window.siyuan.languages.assets}"><svg><use xlink:href="#iconImage"></use></svg></span>
        <span class="protyle-icon ariaLabel" data-type="show-random" aria-label="${window.siyuan.languages.builtIn}"><svg><use xlink:href="#iconRefresh"></use></svg></span>
        <span class="protyle-icon ariaLabel fn__none" data-type="position" aria-label="${window.siyuan.languages.dragPosition}"><svg><use xlink:href="#iconMove"></use></svg></span>
        <span class="protyle-icon protyle-icon--last ariaLabel" data-type="remove" aria-label="${window.siyuan.languages.remove}"><svg><use xlink:href="#iconTrashcan"></use></svg></span>
    </div>
    <div class="protyle-icons fn__none"><span class="protyle-icon protyle-icon--text">${window.siyuan.languages.dragPosition}</span></div>
    <div class="protyle-icons fn__none" style="opacity: .86;">
        <span class="protyle-icon protyle-icon--first" data-type="cancel">${window.siyuan.languages.cancel}</span>
        <span class="protyle-icon protyle-icon--last" data-type="confirm">${window.siyuan.languages.confirm}</span>
    </div>
</div>
<div class="protyle-background__ia">
    <div class="protyle-background__icon" data-menu="true" data-type="open-emoji"></div>
    <div class="b3-chips b3-chips__doctag fn__none"></div>
    <div class="protyle-background__action">
        <button class="b3-button b3-button--cancel" data-menu="true" data-type="tag">
            <svg><use xlink:href="#iconTags"></use></svg>
            ${window.siyuan.languages.addTag}
        </button>
        <button class="b3-button b3-button--cancel" data-type="icon">
            <svg><use xlink:href="#iconEmoji"></use></svg>
            ${window.siyuan.languages.addIcon}
        </button>
        <button class="b3-button b3-button--cancel" data-type="random">
            <svg><use xlink:href="#iconImage"></use></svg>
            ${window.siyuan.languages.titleBg}
        </button>
    </div>
</div>`,this.tagsElement=this.element.querySelector(".b3-chips"),this.iconElement=this.element.querySelector(".protyle-background__icon"),this.imgElement=this.element.querySelector(".protyle-background__img img"),this.actionElements=this.element.querySelectorAll(".protyle-background__action:not(.fn__flex-center) .b3-button"),this.element.addEventListener("dragover",async n=>{n.preventDefault()}),this.element.addEventListener("drop",async n=>{n.dataTransfer.types[0]==="Files"&&n.dataTransfer.files[0].type.indexOf("image")!==-1&&ii(e,[n.dataTransfer.files[0]],void 0,a=>{const i=JSON.parse(a),s=`background-image:url("${i.data.succMap[Object.keys(i.data.succMap)[0]]}")`;this.ial["title-img"]=s,this.render(this.ial,e.block.rootID),E("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{"title-img":s}})})}),this.imgElement.addEventListener("mousedown",n=>{if(n.preventDefault(),!this.element.firstElementChild.querySelector(".protyle-icons").classList.contains("fn__none"))return;const a=n.clientY,i=document,s=this.imgElement.naturalHeight*this.imgElement.clientWidth/this.imgElement.naturalWidth-this.imgElement.clientHeight;let o=parseFloat(this.imgElement.style.objectPosition.substring(7))||50;this.imgElement.style.objectPosition.endsWith("px")&&(o=-parseInt(this.imgElement.style.objectPosition.substring(7))/s*100),i.onmousemove=l=>{this.imgElement.style.objectPosition=`center ${((a-l.clientY)/s*100+o).toFixed(2)}%`,n.preventDefault()},i.onmouseup=()=>{i.onmousemove=null,i.onmouseup=null,i.ondragstart=null,i.onselectstart=null,i.onselect=null}}),this.element.querySelector("input").addEventListener("change",n=>{n.target.files.length!==0&&ii(e,n.target.files,n.target,a=>{const i=JSON.parse(a),s=`background-image:url("${i.data.succMap[Object.keys(i.data.succMap)[0]]}")`;this.ial["title-img"]=s,this.render(this.ial,e.block.rootID),E("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{"title-img":s}})})}),this.element.addEventListener(Gr(),n=>{if(e.disabled)return;let a=n.target;for(Q(["gutter"],e);a&&!a.isEqualNode(this.element);){const i=a.getAttribute("data-type");if(a.tagName==="IMG"&&a.parentElement.classList.contains("protyle-background__img")){const s=a.getAttribute("src");n.detail>1&&!s.startsWith("data:image/png;base64")&&(_c(s),n.preventDefault(),n.stopPropagation()),window.siyuan.menus.menu.remove();break}else if(i==="position"){const s=this.element.firstElementChild.querySelectorAll(".protyle-icons");s[0].classList.add("fn__none"),s[1].classList.remove("fn__none"),s[2].classList.remove("fn__none"),this.imgElement.style.cursor="move",n.preventDefault(),n.stopPropagation();break}else if(i==="cancel"||i==="confirm"){this.imgElement.style.cursor="";const s=this.element.firstElementChild.querySelectorAll(".protyle-icons");if(s[0].classList.remove("fn__none"),s[1].classList.add("fn__none"),s[2].classList.add("fn__none"),i==="confirm"){const o=`background-image:url("${this.imgElement.getAttribute("src")}");object-position:${this.imgElement.style.objectPosition}`;this.ial["title-img"]=o,E("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{"title-img":o}})}else this.render(this.ial,e.block.rootID);n.preventDefault(),n.stopPropagation();break}else if(i==="open-emoji"){const s=this.iconElement.getBoundingClientRect();Za(e.block.rootID,"doc",{x:s.left,y:s.bottom,h:s.height,w:s.width},void 0,a.querySelector("img")),n.preventDefault(),n.stopPropagation();break}else if(i==="show-random"){let s="";Cp.forEach((l,r)=>{s+=`<div data-index="${r}" style="height: 128px;${l}" class="b3-card b3-card--wrap"></div>`});const o=new we({title:window.siyuan.languages.builtIn,content:`<div class="b3-cards">${s}</div>`,width:W()?"92vw":"912px",height:W()?"80vh":"70vh"});o.element.setAttribute("data-key",u.DIALOG_BACKGROUNDRANDOM),o.element.addEventListener("click",l=>{const r=l.target;r.classList.contains("b3-card")&&(this.ial["title-img"]=Cp[parseInt(r.getAttribute("data-index"))],this.render(this.ial,e.block.rootID),E("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{"title-img":this.ial["title-img"]}}),o.destroy())}),n.preventDefault(),n.stopPropagation();break}else if(i==="random"){this.ial["title-img"]=Cp[Tt(0,Cp.length-1)],this.render(this.ial,e.block.rootID),E("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{"title-img":this.ial["title-img"]}}),n.preventDefault(),n.stopPropagation();break}else if(i==="asset"){const s=a.getBoundingClientRect();dm(e,{x:a.parentElement.getBoundingClientRect().right,y:s.bottom+8,isLeft:!0},o=>{this.ial["title-img"]=`background-image:url("${o}")`,this.render(this.ial,e.block.rootID),E("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{"title-img":this.ial["title-img"]}})},u.SIYUAN_ASSETS_IMAGE),n.preventDefault(),n.stopPropagation();break}else if(i==="remove"){delete this.ial["title-img"],this.render(this.ial,e.block.rootID),E("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{"title-img":""}}),n.preventDefault(),n.stopPropagation();break}else if(i==="icon"){const s=Gy();if(s){Js(s,e.block.rootID),sf(s,e.block.rootID),E("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{icon:s}}),e.model&&e.model.parent.setDocIcon(s),this.iconElement.classList.remove("fn__none");const o=this.iconElement.getBoundingClientRect();Za(e.block.rootID,"doc",{x:o.left,y:o.bottom,h:o.height,w:o.width})}n.preventDefault(),n.stopPropagation();break}else if(i==="tag"){this.openTag(e,a),n.preventDefault(),n.stopPropagation();break}else if(i==="link"){const s=new we({title:window.siyuan.languages.link,width:W()?"92vw":"520px",content:`<div class="b3-dialog__content">
        <input class="b3-text-field fn__block" value="${this.imgElement.src.startsWith("data:")?"":this.imgElement.getAttribute("src")}">
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`});s.element.setAttribute("data-key",u.DIALOG_BACKGROUNDLINK);const o=s.element.querySelectorAll(".b3-button");o[0].addEventListener("click",()=>{s.destroy()}),o[1].addEventListener("click",()=>{const l=`background-image:url("${s.element.querySelector("input").value}");`;this.ial["title-img"]=l,this.render(this.ial,e.block.rootID),E("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{"title-img":this.ial["title-img"]}}),s.destroy()}),s.element.querySelector("input").focus(),n.preventDefault(),n.stopPropagation();break}else if(i==="open-search"){ti(e.app,`#${a.textContent}#`,!window.siyuan.ctrlIsPressed,{method:0}),n.preventDefault(),n.stopPropagation();break}else if(i==="remove-tag"){a.parentElement.remove(),this.removeTag(e),n.preventDefault(),n.stopPropagation();break}a=a.parentElement}})}removeTag(e){const n=this.getTags();E("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{tags:n.toString()}}),n.length===0?delete this.ial.tags:this.ial.tags=n.toString(),this.render(this.ial,e.block.rootID)}render(e,n){const a=e["title-img"],i=e.icon,s=e.tags;if(this.ial=e,this.element.setAttribute("data-node-id",n),s){let o="";const l=["secondary","primary","info","success","warning","error","pink"];Array.from(new Set(s.split(",").map(r=>r.trim()))).forEach((r,d)=>{r.replace(/ /g,"")&&(o+=`<div class="b3-chip b3-chip--middle b3-chip--pointer b3-chip--${l[d%7]}" data-type="open-search">${pe(r)}<svg class="b3-chip__close" data-type="remove-tag"><use xlink:href="#iconCloseRound"></use></svg></div>`)}),this.tagsElement.innerHTML=`${o}
<div class="protyle-background__action fn__flex-center">
    <button class="b3-button b3-button--cancel" style="margin-bottom: 8px" data-menu="true" data-type="tag"><svg><use xlink:href="#iconAdd"></use></svg>${window.siyuan.languages.addTag}</button>
</div>`,this.tagsElement.classList.remove("fn__none"),this.actionElements[0].classList.add("fn__none")}else this.tagsElement.classList.add("fn__none"),this.actionElements[0].classList.remove("fn__none");if(i?(this.iconElement.classList.remove("fn__none"),this.iconElement.innerHTML=ge(i),this.actionElements[1].classList.add("fn__none")):(this.actionElements[1].classList.remove("fn__none"),this.iconElement.classList.add("fn__none")),a){if(this.imgElement.setAttribute("style",Lute.UnEscapeHTMLStr(a)),a.indexOf("url(")>-1){const o=this.imgElement.style.backgroundPosition||this.imgElement.style.objectPosition,l=this.imgElement.style.backgroundImage?.replace(/^url\(["']?/,"").replace(/["']?\)$/,"");this.imgElement.removeAttribute("style"),this.imgElement.setAttribute("src",l),this.imgElement.style.objectPosition=o,this.element.querySelector('[data-type="position"]').classList.remove("fn__none")}else this.imgElement.setAttribute("src",this.transparentData),this.element.querySelector('[data-type="position"]').classList.add("fn__none");this.actionElements[2].classList.add("fn__none"),this.imgElement.parentElement.classList.remove("fn__none"),this.iconElement.style.marginTop=""}else this.imgElement.parentElement.classList.add("fn__none"),this.actionElements[2].classList.remove("fn__none"),this.iconElement.style.marginTop="8px";a||i?this.iconElement.parentElement.style.marginTop="":this.iconElement.parentElement.style.marginTop="8px"}openTag(e,n){window.siyuan.menus.menu.remove();const a=new st;a.addItem({iconHTML:"",type:"empty",label:`<div class="fn__flex-column b3-menu__filter">
    <input class="b3-text-field fn__flex-shrink" placeholder="${window.siyuan.languages.tag}"/>
    <div class="fn__hr"></div>
    <div class="b3-list fn__flex-1 b3-list--background">
        <img style="margin: 0 auto;display: block;width: 64px;height: 64px" src="/stage/loading-pure.svg">
    </div>
</div>`,bind:o=>{const l=o.querySelector(".b3-list--background");E("/api/search/searchTag",{k:""},d=>{let c="";const f=this.getTags();d.data.tags.forEach((g,p)=>{c+=`<div class="b3-list-item b3-list-item--narrow${p===0?" b3-list-item--focus":""}">
    <div class="fn__flex-1">${g}</div>
    ${f.includes(Lute.UnEscapeHTMLStr(g))?'<svg class="b3-menu__checked"><use xlink:href="#iconSelect"></use></svg>':""}
</div>`}),l.innerHTML=c});const r=o.querySelector("input");r.addEventListener("keydown",d=>{if(d.stopPropagation(),!d.isComposing)if(xn(l,d),d.key==="Enter"){const c=l.querySelector(".b3-list-item--focus");c?this.addTags(c.textContent.trim(),e):this.addTags(r.value.trim(),e),r.value="",r.dispatchEvent(new CustomEvent("input"))}else d.key==="Escape"&&window.siyuan.menus.menu.remove()}),r.addEventListener("input",d=>{d.stopPropagation(),E("/api/search/searchTag",{k:r.value},c=>{let f="",g=!1;const p=this.getTags();c.data.tags.forEach(h=>{f+=`<div class="b3-list-item b3-list-item--narrow">
    <div class="fn__flex-1">${h}</div>
    ${p.includes(Lute.UnEscapeHTMLStr(h.replace(/<mark>/g,"").replace(/<\/mark>/g,"")))?'<svg class="b3-menu__checked"><use xlink:href="#iconSelect"></use></svg>':""}
</div>`,h===`<mark>${c.data.k}</mark>`&&(g=!0)}),!g&&c.data.k&&(f=`<div class="b3-list-item b3-list-item--narrow"><mark>${pe(c.data.k)}</mark></div>`+f),l.innerHTML=f,l.firstElementChild.classList.add("b3-list-item--focus")})}),l.addEventListener("click",d=>{const c=d.target,f=L(c,"b3-list-item");f&&(this.addTags(f.textContent.trim(),e),r.dispatchEvent(new CustomEvent("input")))})}}),a.element.querySelector(".b3-menu__items").setAttribute("style","overflow: initial");const s=n.getBoundingClientRect();a.open({x:s.left,y:s.top+s.height}),a.element.querySelector("input").focus()}getTags(e){const n=[];return this.tagsElement.querySelectorAll(".b3-chip").forEach(a=>{const i=a.textContent.trim();e&&i===e&&a.remove(),n.push(i)}),n}addTags(e,n){const a=this.getTags(e);if(a.includes(e)){this.removeTag(n);return}a.push(e),E("/api/attr/setBlockAttrs",{id:n.block.rootID,attrs:{tags:a.toString()}}),this.ial.tags=a.toString(),this.render(this.ial,n.block.rootID)}}class aa{constructor(e,n,a){this.version=u.SIYUAN_VERSION;let i=a;e.plugins.forEach(l=>{l.protyleOptions&&(i=vb(i,l.protyleOptions))});const o=new mT(i).merge();if(this.protyle={getInstance:()=>this,app:e,transactionTime:new Date().getTime(),id:K(),disabled:!1,updated:!1,element:n,options:o,block:{},highlight:{mark:qn()?new Highlight:void 0,markHL:qn()?new Highlight:void 0,ranges:[],rangeIndex:0,styleElement:document.createElement("style")}},qn()){const l=K();this.protyle.highlight.styleElement.dataset.uuid=l,this.protyle.highlight.styleElement.textContent=`.protyle-wysiwyg::highlight(search-mark-${l}) {background-color: var(--b3-highlight-background);color: var(--b3-highlight-color);}
  .protyle-wysiwyg::highlight(search-mark-hl-${l}) {color: var(--b3-highlight-color);background-color: var(--b3-highlight-current-background)}`}if(this.protyle.hint=new fT(this.protyle),o.render.breadcrumb&&(this.protyle.breadcrumb=new DT(this.protyle)),o.render.title&&(this.protyle.title=new $T(this.protyle)),o.render.background&&(this.protyle.background=new MT(this.protyle)),this.protyle.element.innerHTML="",this.protyle.element.classList.add("protyle"),o.render.breadcrumb&&this.protyle.element.appendChild(this.protyle.breadcrumb.element.parentElement),this.protyle.undo=new NL,this.protyle.wysiwyg=new ET(this.protyle),this.protyle.toolbar=new CT(this.protyle),this.protyle.scroll=new bT(this.protyle),this.protyle.options.render.gutter&&(this.protyle.gutter=new TT(this.protyle)),(o.upload.url||o.upload.handler)&&(this.protyle.upload=new px),this.init(),o.action.includes(u.CB_GET_HISTORY))this.protyle.contentElement.classList.add("protyle-content--transition");else{if(this.protyle.ws=new Vn({app:e,id:this.protyle.id,type:"protyle",msgCallback:l=>{switch(l.cmd){case"reload":l.data===this.protyle.block.rootID&&(ei(this.protyle,!1),Ce().outline.forEach(r=>{r.blockId===l.data&&E("/api/outline/getDocOutline",{id:r.blockId,preview:r.isPreview},d=>{r.update(d)})}));break;case"refreshAttributeView":Array.from(this.protyle.wysiwyg.element.querySelectorAll(`[data-av-id="${l.data.id}"]`)).forEach(r=>{r.removeAttribute("data-render"),dt(r,this.protyle)});break;case"addLoading":l.data===this.protyle.block.rootID&&ho(this.protyle,l.msg);break;case"transactions":l.data[0].doOperations.find(r=>{if(!this.protyle.preview.element.classList.contains("fn__none")&&r.action!=="updateAttrs")this.protyle.preview.render(this.protyle);else{if(a.backlinkData&&["delete","move"].includes(r.action))return Ce().backlink.find(d=>{if(d.element.contains(this.protyle.element))return d.refresh(),!0}),!0;Dm(this.protyle,r,!1)}});break;case"readonly":window.siyuan.config.editor.readOnly=l.data,Av(this.protyle,!0);break;case"heading2doc":case"li2doc":this.protyle.block.rootID===l.data.srcRootBlockID&&(this.protyle.block.showAll&&l.cmd==="heading2doc"&&!this.protyle.options.backlinkData?E("/api/filetree/getDoc",{id:this.protyle.block.rootID,size:window.siyuan.config.editor.dynamicLoadBlocks},r=>{rt({data:r,protyle:this.protyle})}):ei(this.protyle,!1),l.cmd==="heading2doc"&&Wl({protyle:this.protyle,focus:!1,pushBackStack:!1,reload:!0,resize:!1}));break;case"rename":this.protyle.path===l.data.path&&(this.protyle.model&&this.protyle.model.parent.updateTitle(l.data.title),this.protyle.background&&(this.protyle.background.ial.title=l.data.title)),this.protyle.options.render.title&&this.protyle.block.parentID===l.data.id&&(!document.body.classList.contains("body--blur")&&getSelection().rangeCount>0&&this.protyle.title.editElement?.contains(getSelection().getRangeAt(0).startContainer)||this.protyle.title.setTitle(l.data.title)),this.protyle.wysiwyg.element.querySelectorAll(`[data-type~="block-ref"][data-id="${l.data.id}"]`).forEach(r=>{r.getAttribute("data-subtype")==="d"&&(r.innerHTML=l.data.refText)});break;case"moveDoc":this.protyle.path===l.data.fromPath&&(this.protyle.path=l.data.newPath,this.protyle.notebookId=l.data.toNotebook);break;case"unmount":this.protyle.notebookId===l.data.box&&this.protyle.model&&this.protyle.model.parent.parent.removeTab(this.protyle.model.parent.id,!1);break;case"removeDoc":l.data.ids.includes(this.protyle.block.rootID)&&(this.protyle.model&&this.protyle.model.parent.parent.removeTab(this.protyle.model.parent.id,!1),delete window.siyuan.storage[u.LOCAL_FILEPOSITION][this.protyle.block.rootID],ue(u.LOCAL_FILEPOSITION,window.siyuan.storage[u.LOCAL_FILEPOSITION]));break}}}),a.backlinkData){this.protyle.block.rootID=a.blockId,cv(this.protyle,a.backlinkData),this.protyle.wysiwyg.element.style.paddingLeft="16px";return}if(!a.blockId){Ac(this.protyle);return}this.protyle.options.mode!=="preview"&&a.rootId&&window.siyuan.storage[u.LOCAL_FILEPOSITION][a.rootId]&&(o.action.includes(u.CB_GET_SCROLL)||o.action.includes(u.CB_GET_ROOTSCROLL)&&a.rootId===a.blockId)?Nh({protyle:this.protyle,scrollAttr:window.siyuan.storage[u.LOCAL_FILEPOSITION][a.rootId],mergedOptions:o,cb:()=>{this.afterOnGet(o)}}):this.getDoc(o)}}getDoc(e){E("/api/filetree/getDoc",{id:e.blockId,isBacklink:e.action.includes(u.CB_GET_BACKLINK),originalRefBlockIDs:e.originalRefBlockIDs,mode:e.action&&e.action.includes(u.CB_GET_CONTEXT)?3:0,size:e.action?.includes(u.CB_GET_ALL)?u.SIZE_GET_MAX:window.siyuan.config.editor.dynamicLoadBlocks},n=>{rt({data:n,protyle:this.protyle,action:e.action,afterCB:()=>{this.afterOnGet(e)}})})}afterOnGet(e){this.protyle.model&&((e.action?.includes(u.CB_GET_FOCUS)||e.action?.includes(u.CB_GET_OPENNEW))&&tt(this.protyle.model.element.parentElement.parentElement),Wl({protyle:this.protyle,focus:!1,pushBackStack:!1,reload:!1,resize:!1})),Jt(this.protyle),this.protyle.wysiwyg.element.addEventListener("focusin",()=>{if(this.protyle&&this.protyle.model){let n=!0;if(this.protyle.model.element.parentElement.parentElement.classList.contains("layout__wnd--active")&&this.protyle.model.headElement.classList.contains("item--focus")&&(n=!1),!n)return;tt(this.protyle.model.element.parentElement.parentElement),Wl({protyle:this.protyle,focus:!1,pushBackStack:!1,reload:!1,resize:!1})}else document.querySelectorAll(".layout__tab--active").forEach(n=>{n.classList.remove("layout__tab--active")}),document.querySelectorAll(".layout__wnd--active").forEach(n=>{n.classList.remove("layout__wnd--active")})}),e.after&&e.after(this),this.protyle.contentElement.classList.add("protyle-content--transition")}init(){this.protyle.lute=pT({emojiSite:this.protyle.options.hint.emojiPath,emojis:this.protyle.options.hint.emoji,headingAnchor:!1,listStyle:this.protyle.options.preview.markdown.listStyle,paragraphBeginningSpace:this.protyle.options.preview.markdown.paragraphBeginningSpace,sanitize:this.protyle.options.preview.markdown.sanitize}),this.protyle.preview=new hT(this.protyle),Fx(this.protyle)}focus(){this.protyle.wysiwyg.element.focus()}isUploading(){return this.protyle.upload.isUploading}clearStack(){this.protyle.undo.clear()}destroy(){I_(this.protyle)}resize(){Jt(this.protyle)}reload(e){ei(this.protyle,e)}insert(e,n=!1,a=!1){wt(e,this.protyle,n,a)}transaction(e,n){U(this.protyle,e,n)}turnIntoOneTransaction(e,n,a){Dn({protyle:this.protyle,selectsElement:e,type:n,level:a})}turnIntoTransaction(e,n,a){Ba({protyle:this.protyle,nodeElement:e,type:n,level:a})}updateTransaction(e,n,a){J(this.protyle,e,n,a)}updateBatchTransaction(e,n){ds(e,this.protyle,n)}getRange(e){return me(e)}hasClosestBlock(e){return P(e)}focusBlock(e,n=!0){return ae(e,void 0,n)}disable(){Zn(this.protyle)}enable(){sp(this.protyle)}renderAVAttribute(e,n,a){ym(e,n,this.protyle,a)}}class ht extends Vn{constructor(e){super({app:e.app,id:e.tab.id}),window.siyuan.config.fileTree.openFilesUseCurrentTab&&e.tab.headElement.classList.add("item--unupdate"),this.headElement=e.tab.headElement,this.element=e.tab.panelElement,this.initProtyle(e)}initProtyle(e){this.editor=new aa(this.app,this.element,{action:e.action||[],blockId:e.blockId,rootId:e.rootId,mode:e.mode,render:{title:!0,background:!0,scroll:!0},typewriterMode:!0,after:n=>{window.siyuan.editorIsFullscreen&&(to(n.protyle.element),Nm(n.protyle)),bn([],n.protyle.block.rootID),lp()}}),this.editor.protyle.model=this}}class ut{constructor(e){if(this.id=K(),this.callback=e.callback,e.title||e.icon){this.title=e.title,this.icon=e.icon,this.docIcon=e.docIcon,this.headElement=document.createElement("li"),this.headElement.setAttribute("data-type","tab-header"),this.headElement.setAttribute("draggable","true"),this.headElement.setAttribute("data-id",this.id),this.headElement.classList.add("item","item--focus");let n="";e.icon?n=`<svg class="item__graphic"><use xlink:href="#${e.icon}"></use></svg>`:e.docIcon&&(n=`<span class="item__icon">${ge(e.docIcon)}</span>`),this.headElement.innerHTML=`${n}<span class="item__text">${pe(e.title)}</span>
<span class="item__close"><svg><use xlink:href="#iconClose"></use></svg></span>`,this.headElement.addEventListener("mouseenter",a=>{if(a.stopPropagation(),a.preventDefault(),Array.from(this.headElement.parentElement.childNodes).find(o=>{if(o.style?.opacity==="0.1")return!0})){Zt();return}let s="";if(this.model instanceof ht&&this.model.editor?.protyle?.block?.rootID)s=this.model.editor.protyle.block.rootID;else if(!this.model){const o=JSON.parse(this.headElement.getAttribute("data-initdata")||"{}");o&&o.instance==="Editor"&&(s=o.blockId)}s?E("/api/filetree/getFullHPathByID",{id:s},o=>{this.headElement.getAttribute("aria-label")||Qa(Ka(o.data),this.headElement),this.headElement.setAttribute("aria-label",Ka(o.data))}):this.headElement.setAttribute("aria-label",Ka(this.title))}),this.headElement.addEventListener("dragstart",a=>{if(St()){a.stopPropagation(),a.preventDefault();return}window.getSelection().removeAllRanges(),Zt();const i=q(a.target,"LI");if(i){a.dataTransfer.setData("text/html",i.outerHTML);const s={id:this.id};Hi(this,s),a.dataTransfer.setData(u.SIYUAN_DROP_TAB,JSON.stringify(s)),a.dataTransfer.dropEffect="move",i.style.opacity="0.1",window.siyuan.dragElement=this.headElement}}),this.headElement.addEventListener("dragend",a=>{const i=q(a.target,"LI");i&&(i.style.opacity="1",document.querySelectorAll(".layout-tab-bar li[data-clone='true']").forEach(s=>{s.remove()})),setTimeout(()=>{document.body.contains(this.panelElement)&&(a.clientX<0||a.clientY<0||a.clientX>window.innerWidth||a.clientY>window.innerHeight)&&lf(this)},u.TIMEOUT_LOAD),window.siyuan.dragElement=void 0,a.dataTransfer.dropEffect==="none"&&this.parent.children.forEach((s,o)=>{const l=this.headElement.parentElement.children[o];s.headElement.isSameNode(l)||(o===0?this.headElement.parentElement.firstElementChild.before(s.headElement):this.headElement.parentElement.children[o-1].after(s.headElement))})})}this.panelElement=document.createElement("div"),this.panelElement.classList.add("fn__flex-1"),this.panelElement.innerHTML=e.panel||"",this.panelElement.setAttribute("data-id",this.id)}updateTitle(e){this.title=e,this.headElement.querySelector(".item__text").innerHTML=pe(e)}addModel(e){this.model=e,e.parent=this}pin(){if(!(!this.headElement.previousElementSibling||this.headElement.previousElementSibling&&this.headElement.previousElementSibling.classList.contains("item--pin"))){let e,n=0,a;this.parent.children.find((i,s)=>{if(i.headElement.classList.contains("item--pin")&&(n=s+1,a=i.headElement),i.id===this.id)return e=this.parent.children.splice(s,1)[0],!0}),a?a.after(e.headElement):this.parent.children[0].headElement.before(e.headElement),this.parent.children.splice(n,0,e)}this.headElement.classList.add("item--pin"),(this.docIcon||this.icon)&&this.headElement.querySelector(".item__text").classList.add("fn__none"),dn()}setDocIcon(e){if(this.docIcon=e,this.docIcon){const n=this.headElement.querySelector(".item__icon");n?n.innerHTML=ge(e):this.headElement.querySelector(".item__text").insertAdjacentHTML("beforebegin",`<span class="item__icon">${ge(e)}</span>`),this.headElement.classList.contains("item--pin")&&this.headElement.querySelector(".item__text").classList.add("fn__none")}else this.headElement.querySelector(".item__icon")?.remove(),this.headElement.querySelector(".item__text").classList.remove("fn__none")}unpin(){if(!(!this.headElement.nextElementSibling||this.headElement.nextElementSibling&&!this.headElement.nextElementSibling.classList.contains("item--pin"))){let e,n=0,a;for(let i=0;i<this.parent.children.length;i++)this.parent.children[i].id===this.id&&(e=this.parent.children.splice(i,1)[0],i--),i>-1&&this.parent.children[i].headElement.classList.contains("item--pin")&&(n=i+1,a=this.parent.children[i].headElement);a.after(e.headElement),this.parent.children.splice(n,0,e)}this.headElement.classList.remove("item--pin"),(this.docIcon||this.icon)&&this.headElement.querySelector(".item__text").classList.remove("fn__none"),dn()}close(){this.parent.removeTab(this.id)}}const Sb=async(t,e,n)=>{let a="",i=0;t.forEach(r=>{(!n||r.title.toLowerCase().includes(n.toLowerCase()))&&(a+=`<li data-index="${i}" data-node-id="${r.rootID}" class="b3-list-item${i===0?" b3-list-item--focus":""}">
${ge(r.icon||window.siyuan.storage[u.LOCAL_IMAGES].file,"b3-list-item__graphic",!0)}
<span class="b3-list-item__text">${pe(r.title)}</span>
</li>`,i++)});let s="";if(a){const r=await Re("/api/filetree/getFullHPathByID",{id:t[0].rootID});s=pe(r.data)}let o="";if(!ve()){o='<ul class="b3-list b3-list--background" style="overflow: auto;width: 200px;">',(!n||window.siyuan.languages.riffCard.toLowerCase().includes(n.toLowerCase()))&&(o+=`<li data-type="riffCard" data-index="0" class="b3-list-item${s?"":" b3-list-item--focus"}">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconRiffCard"></use></svg>
    <span class="b3-list-item__text">${window.siyuan.languages.riffCard}</span>
    <span class="b3-list-item__meta">${X(window.siyuan.config.keymap.general.riffCard.custom)}</span>
</li>`,s||(s=window.siyuan.languages.riffCard));let r=1;_p().forEach(d=>{(!n||d.title.toLowerCase().includes(n.toLowerCase()))&&(o+=`<li data-type="${d.type}" data-index="${r}" class="b3-list-item${s?"":" b3-list-item--focus"}">
    <svg class="b3-list-item__graphic"><use xlink:href="#${d.icon}"></use></svg>
    <span class="b3-list-item__text">${d.title}</span>
    <span class="b3-list-item__meta">${X(d.hotkey||"")}</span>
</li>`,r++,s||(s=window.siyuan.languages.riffCard))}),o=o+"</ul>"}const l=e.querySelector(".switch-doc__path");l.innerHTML=s,l.previousElementSibling.innerHTML=`<div class="fn__flex fn__flex-1" style="overflow:auto;">
        ${o}
        <ul style="${ve()?"border-left:0;":""}min-width:360px;" class="b3-list b3-list--background fn__flex-1">${a}</ul>
    </div>`},Tp=()=>{if(window.siyuan.dialogs.find(e=>{if(e.element.getAttribute("data-key")===u.DIALOG_RECENTDOCS)return!0})){Q(["dialog"]);return}E("/api/storage/getRecentDocs",{},e=>{let n;getSelection().rangeCount>0&&(n=getSelection().getRangeAt(0));const a=new we({positionId:u.DIALOG_RECENTDOCS,title:`<div class="fn__flex">
<div class="fn__flex-center">${window.siyuan.languages.recentDocs}</div>
<div class="fn__flex-1"></div>
<div class="b3-form__icon fn__size200">
    <svg class="b3-form__icon-icon"><use xlink:href="#iconSearch"></use></svg>
    <input placeholder="${window.siyuan.languages.search}" class="b3-text-field fn__block b3-form__icon-input">
</div>
</div>`,content:`<div class="fn__flex-column switch-doc">
    <div class="fn__flex fn__flex-1" style="overflow:auto;"></div>
    <div class="switch-doc__path"></div>
</div>`,height:"80vh",destroyCallback:()=>{n&&n.getBoundingClientRect().height!==0&&Z(n)}}),i=a.element.querySelector("input");i.focus(),i.addEventListener("compositionend",()=>{Sb(e.data,a.element,i.value)}),i.addEventListener("input",s=>{s.isComposing||Sb(e.data,a.element,i.value)}),a.element.setAttribute("data-key",u.DIALOG_RECENTDOCS),a.element.addEventListener("click",s=>{const o=L(s.target,"b3-list-item");o&&(a.element.querySelector(".b3-list-item--focus").classList.remove("b3-list-item--focus"),o.classList.add("b3-list-item--focus"),window.dispatchEvent(new KeyboardEvent("keydown",{key:"Enter"})),s.stopPropagation(),s.preventDefault())}),Sb(e.data,a.element)})},ya=(t=!0)=>{const e=document.querySelector(".layout__wnd--active .item--focus");let n;return e&&(n=Bt(e.getAttribute("data-id"))),!n&&!t&&ba().find(a=>{a.headElement?.classList.contains("item--focus")&&(n=a)}),n},Wt=t=>{const e=document.querySelector(".dock .dock__item--activefocus");if(e){let a=e.parentElement.children[t];t===-1?(a=e.parentElement.lastElementChild,a.getAttribute("data-type")||(a=a.previousElementSibling)):t===-2?(a=e.previousElementSibling,a||(a=e.parentElement.lastElementChild,a.classList.contains("dock__item--pin")&&(a=a.previousElementSibling))):t===-3&&(a=e.nextElementSibling,(!a||a.classList.contains("dock__item--pin"))&&(a=e.parentElement.firstElementChild));const i=a?.getAttribute("data-type");i&&Qe(i)?.toggleModel(i,!0,!1);return}const n=ya(!1);if(n){let a=n.parent.headersElement.children[t];t===-1?a=n.parent.headersElement.lastElementChild:t===-2?(a=n.headElement.previousElementSibling,a||(a=n.headElement.parentElement.lastElementChild)):t===-3&&(a=n.headElement.nextElementSibling,a||(a=n.headElement.parentElement.firstElementChild)),a&&(n.parent.switchTab(a,!0),n.parent.showHeading())}};let ZE;const ln=(t=!0)=>{clearTimeout(ZE),ZE=window.setTimeout(()=>{const e=Ce();e.editor.forEach(n=>{n.editor&&n.editor.protyle&&n.element.parentElement&&!n.element.classList.contains("fn__none")&&n.editor.resize()}),e.backlink.forEach(n=>{const a=n.element.querySelector(".backlinkMList");a.style.height&&a.style.height!=="0px"&&n.element.clientHeight!==0&&(a.style.height=n.element.clientHeight-a.previousElementSibling.clientHeight*2+"px"),n.editors.forEach(i=>{Q(["gutter"],i.protyle),i.resize()})}),e.search.forEach(n=>{n.element.querySelector("#searchUnRefPanel").classList.contains("fn__none")?n.editors.edit.resize():n.editors.unRefEdit.resize()}),e.custom.forEach(n=>{n.resize&&n.resize()}),qL(),Ji(["gutter"]),t&&dn()},200)},Qe=t=>{if(window.siyuan.layout.leftDock){if(window.siyuan.layout.leftDock.data[t])return window.siyuan.layout.leftDock;if(window.siyuan.layout.rightDock.data[t])return window.siyuan.layout.rightDock;if(window.siyuan.layout.bottomDock.data[t])return window.siyuan.layout.bottomDock}},JE=t=>new ut({panel:`<div class="layout__empty b3-list">
    <div class="${window.siyuan.config.readonly?"":" fn__none"}">
        <div class="config-about__logo">
            <img src="/stage/icon.png">
            ${window.siyuan.languages.siyuanNote}
        </div>
        <div class="b3-label__text">${window.siyuan.languages.slogan}</div>
    </div>
    <div class="fn__hr"></div>
    <div class="b3-list-item" id="editorEmptySearch">
        <svg class="b3-list-item__graphic"><use xlink:href="#iconSearch"></use></svg>
        <span>${window.siyuan.languages.search}</span>
        <span class="b3-list-item__meta">${X(window.siyuan.config.keymap.general.globalSearch.custom)}</span>
    </div>
    <div id="editorEmptyRecent" class="b3-list-item">
        <svg class="b3-list-item__graphic"><use xlink:href="#iconList"></use></svg>
        <span>${window.siyuan.languages.recentDocs}</span>
        <span class="b3-list-item__meta">${X(window.siyuan.config.keymap.general.recentDocs.custom)}</span>
    </div>
    <div id="editorEmptyHistory" class="b3-list-item${window.siyuan.config.readonly?" fn__none":""}">
        <svg class="b3-list-item__graphic"><use xlink:href="#iconHistory"></use></svg>
        <span>${window.siyuan.languages.dataHistory}</span>
        <span class="b3-list-item__meta">${X(window.siyuan.config.keymap.general.dataHistory.custom)}</span>
    </div>
    <div class="b3-list-item${window.siyuan.config.readonly?" fn__none":""}" id="editorEmptyFile">
        <svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg>
        <span>${window.siyuan.languages.newFile}</span>
        <span class="b3-list-item__meta">${X(window.siyuan.config.keymap.general.newFile.custom)}</span>
    </div>
    <div class="b3-list-item${window.siyuan.config.readonly?" fn__none":""}" id="editorEmptyNewNotebook">
        <svg class="b3-list-item__graphic"><use xlink:href="#iconFilesRoot"></use></svg>
        <span>${window.siyuan.languages.newNotebook}</span>
    </div>
    <div class="b3-list-item${Da()||window.siyuan.config.readonly?" fn__none":""}" id="editorEmptyHelp">
        <svg class="b3-list-item__graphic"><use xlink:href="#iconHelp"></use></svg>
        <span>${window.siyuan.languages.userGuide}</span>
    </div>
</div>`,callback(e){e.panelElement.addEventListener("click",n=>{let a=n.target;for(;a&&!a.isEqualNode(e.panelElement);){if(a.id==="editorEmptySearch"){wn({app:t,hotkey:u.DIALOG_GLOBALSEARCH}),n.stopPropagation(),n.preventDefault();break}else if(a.id==="editorEmptyRecent"){Tp(),n.stopPropagation(),n.preventDefault();break}else if(a.id==="editorEmptyHistory"){Bf(t),n.stopPropagation(),n.preventDefault();break}else if(a.id==="editorEmptyFile"){xi({app:t,useSavePath:!0}),n.stopPropagation(),n.preventDefault();break}else if(a.id==="editorEmptyNewNotebook"){Ww(),n.stopPropagation(),n.preventDefault();break}else if(a.id==="editorEmptyHelp"){$f(),n.stopPropagation(),n.preventDefault();break}a=a.parentElement}})}}),Ip=(t,e)=>new ut({icon:e.icon,docIcon:e.docIcon,title:e.title,callback(n){let a;if(e.model instanceof ht){const i=[];e.model.editor.protyle.block.action.forEach(s=>{s!==u.CB_GET_APPEND&&s!==u.CB_GET_BEFORE&&s!==u.CB_GET_HTML&&i.push(s)}),a=new ht({app:t,tab:n,blockId:e.model.editor.protyle.block.id,rootId:e.model.editor.protyle.block.rootID,action:i})}else if(e.model instanceof li)a=new li({app:t,tab:n,path:e.model.path});else if(e.model instanceof ri)a=new ri({app:t,tab:n,blockId:e.model.blockId,rootId:e.model.rootId,type:e.model.type});else if(e.model instanceof Li)a=new Li({app:t,tab:n});else if(e.model instanceof us)a=new us({app:t,tab:n,blockId:e.model.blockId,type:e.model.type,isPreview:e.model.isPreview});else if(e.model instanceof fs)a=new fs({app:t,tab:n,blockId:e.model.blockId,rootId:e.model.rootId,type:e.model.type});else if(e.model instanceof vo)a=new vo(t,n);else if(e.model instanceof Eo)a=new Eo(t,n);else if(e.model instanceof Mi)a=new Mi({app:t,tab:n,config:e.model.config});else if(e.model instanceof Wa){const i=e.model;i.type==="siyuan-card"?a=cb({app:t,tab:n,data:i.data}):t.plugins.find(s=>{if(s.models[i.type])return a=s.models[i.type]({tab:n,data:i.data}),!0})}else if(!e.model&&e.headElement){const i=JSON.parse(e.headElement.getAttribute("data-initdata")||"{}");i&&(a=wk(t,n,i))}n.addModel(a)}}),Pi=async(t,e,n)=>{if(e==="closeOthers")for(let a=0;a<t.parent.children.length;a++)t.parent.children[a].id!==t.id&&!t.parent.children[a].headElement.classList.contains("item--pin")&&(await t.parent.children[a].parent.removeTab(t.parent.children[a].id,!0,!1),a--);else if(e==="closeAll")for(let a=0;a<t.parent.children.length;a++)t.parent.children[a].headElement.classList.contains("item--pin")||(await t.parent.children[a].parent.removeTab(t.parent.children[a].id,!0),a--);else if(n.length>0)for(let a=0;a<n.length;a++)n[a].headElement.classList.contains("item--pin")||await n[a].parent.removeTab(n[a].id);t.headElement.parentElement&&!t.headElement.parentElement.querySelector(".item--focus")?t.parent.switchTab(t.headElement,!0):t.parent.children.length>0&&t.parent.switchTab(t.parent.children[t.parent.children.length-1].headElement,!0)};class wa{constructor(e){const n=Object.assign({direction:"tb",size:"auto",type:"normal"},e);this.id=K(),this.direction=n.direction,this.type=n.type,this.size=n.size,this.resize=e.resize,this.children=[],this.element=e.element||document.createElement("div"),this.type==="center"&&this.element.classList.add("layout__center"),n.direction==="tb"?this.element.classList.add("fn__flex-column"):this.element.classList.add("fn__flex"),n.type==="left"&&this.element.classList.add("fn__flex-shrink")}addLayout(e,n){n?this.children.find((a,i)=>{if(a.id===n)return this.children.splice(i+1,0,e),a.element.after(e.element),!0}):(this.children.splice(this.children.length,0,e),this&&this.element.append(e.element)),e.size==="auto"?e.element.classList.add("fn__flex-1"):e.element.style[this&&this.direction==="lr"?"width":"height"]=e.size,_k(e),e.parent=this}addWnd(e,n){op(),n?this.children.find((a,i)=>{if(a.id===n)return this.children.splice(i+1,0,e),this.direction==="lr"&&a.element.querySelectorAll(".protyle-content").forEach(s=>{s.parentElement.classList.contains("fn__none")||(s.classList.remove("protyle-content--transition"),s.querySelector(".protyle-wysiwyg").style.padding="",s.classList.add("protyle-content--transition"))}),a.element.after(e.element),!0}):(this.children.splice(this.children.length,0,e),this.element.append(e.element)),n&&Ob(this),_k(e),ln(!1),e.parent=this}}class PT extends Vn{constructor(e,n){super({app:e,id:n.id}),this.selectIds=[],this.currentPage=1,this.pageCount=1,this.data={},n instanceof Element?this.element=n:this.element=n.panelElement,this.element.classList.add("fn__flex-column","file-tree","sy__inbox"),this.element.innerHTML=`<div class="block__icons">
    <div class="block__logo">
        <svg class="block__logoicon"><use xlink:href="#iconInbox"></use></svg>${window.siyuan.languages.inbox}&nbsp;
        <span class="inboxSelectCount"></span>
    </div>
    <span class="fn__flex-1"></span>
    <span class="fn__space"></span>
    <span data-type="selectall" class="block__icon"><svg><use xlink:href="#iconUncheck"></use></svg></span>
    <span class="fn__space"></span>
    <span data-type="previous" class="block__icon b3-tooltips b3-tooltips__w" disabled="disabled" aria-label="${window.siyuan.languages.previousLabel}"><svg><use xlink:href="#iconLeft"></use></svg></span>
    <span class="fn__space"></span>
    <span data-type="next" class="block__icon b3-tooltips b3-tooltips__w" disabled="disabled" aria-label="${window.siyuan.languages.nextLabel}"><svg><use xlink:href="#iconRight"></use></svg></span>
    <span class="fn__space"></span>
    <span data-type="more" data-menu="true" class="block__icon b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.more}"><svg><use xlink:href="#iconMore"></use></svg></span>
    <span class="fn__space"></span>
    <span data-type="min" class="block__icon b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.min} ${X(window.siyuan.config.keymap.general.closeTab.custom)}"><svg><use xlink:href="#iconMin"></use></svg></span>
</div>
<div class="fn__loading fn__none">
    <img width="64px" src="/stage/loading-pure.svg"></div>
</div>
<div class="fn__flex-1 fn__none inboxDetails fn__flex-column" style="min-height: auto;background-color: var(--b3-theme-background)"></div>
<div class="fn__flex-1"></div>`;const a=this.element.querySelector(".inboxSelectCount"),i=this.element.querySelector(".inboxDetails"),s=this.element.firstElementChild.querySelector('[data-type="selectall"]');this.element.lastElementChild.addEventListener("contextmenu",o=>{const l=L(o.target,"b3-list-item");l&&this.more(o,l)}),this.element.addEventListener("click",o=>{tt(this.element);let l=o.target;for(;l&&!l.isEqualNode(this.element);){if(l.tagName==="A"){o.stopPropagation();break}const r=l.getAttribute("data-type");if(r==="min"){Qe("inbox").toggleModel("inbox",!1,!0),o.preventDefault();break}else if(r==="selectall"){const d=l.querySelector("use");d.getAttribute("xlink:href")==="#iconUncheck"?(this.element.lastElementChild.querySelectorAll(".b3-list-item").forEach(c=>{c.querySelector("use").setAttribute("xlink:href","#iconCheck"),this.selectIds.push(c.getAttribute("data-id")),this.selectIds=[...new Set(this.selectIds)]}),d.setAttribute("xlink:href","#iconCheck")):(this.element.lastElementChild.querySelectorAll(".b3-list-item").forEach(c=>{c.querySelector("use").setAttribute("xlink:href","#iconUncheck"),this.selectIds.splice(this.selectIds.indexOf(c.getAttribute("data-id")),1)}),d.setAttribute("xlink:href","#iconUncheck")),a.innerHTML=`${this.selectIds.length.toString()}/${this.pageCount.toString()}`,window.siyuan.menus.menu.remove(),o.stopPropagation();break}else if(r==="select"){const d=l.querySelector("use");d.getAttribute("xlink:href")==="#iconUncheck"?(this.selectIds.push(l.parentElement.getAttribute("data-id")),this.selectIds=[...new Set(this.selectIds)],d.setAttribute("xlink:href","#iconCheck")):(this.selectIds.splice(this.selectIds.indexOf(l.parentElement.getAttribute("data-id")),1),d.setAttribute("xlink:href","#iconUncheck")),a.innerHTML=`${this.selectIds.length.toString()}/${this.pageCount.toString()}`,s.querySelector("use").setAttribute("xlink:href",this.element.lastElementChild.querySelectorAll('[*|href="#iconCheck"]').length===this.element.lastElementChild.querySelectorAll(".b3-list-item").length?"#iconCheck":"#iconUncheck"),window.siyuan.menus.menu.remove(),o.stopPropagation();break}else if(r==="previous"){l.getAttribute("disabled")!=="disabled"&&(this.currentPage--,this.update()),o.preventDefault();break}else if(r==="next"){l.getAttribute("disabled")!=="disabled"&&(this.currentPage++,this.update()),o.preventDefault();break}else if(r==="back"){this.back(),o.preventDefault();break}else if(r==="more"){this.more(o),o.stopPropagation(),o.preventDefault();break}else if(l.classList.contains("b3-list-item")){const d=this.data[l.getAttribute("data-id")];s.classList.add("fn__none"),this.element.firstElementChild.querySelector('[data-type="previous"]').classList.add("fn__none"),this.element.firstElementChild.querySelector('[data-type="next"]').classList.add("fn__none"),i.innerHTML=this.genDetail(d),i.setAttribute("data-id",d.oId),i.classList.remove("fn__none"),i.scrollTop=0,this.element.lastElementChild.classList.add("fn__none"),o.preventDefault();break}l=l.parentElement}}),this.update()}back(){this.element.firstElementChild.querySelector('[data-type="selectall"]').classList.remove("fn__none"),this.element.firstElementChild.querySelector('[data-type="previous"]').classList.remove("fn__none"),this.element.firstElementChild.querySelector('[data-type="next"]').classList.remove("fn__none"),this.element.querySelector(".inboxDetails").classList.add("fn__none"),this.element.lastElementChild.classList.remove("fn__none")}genDetail(e){let n="";return e.shorthandURL&&(n=`<span class="fn__space"></span><a href="${e.shorthandURL}" target="_blank" class="block__icon block__icon--show b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.link}">
        <svg><use xlink:href="#iconLink"></use></svg>
    </a>`),`<div class="block__icons">
    <div class="block__logo fn__pointer fn__flex-1" data-type="back">
        <svg class="block__logoicon"><use xlink:href="#iconLeft"></use></svg><span class="ft__breakword">${e.shorthandTitle}</span>
    </div>
    ${n}
</div>
<div class="b3-typography b3-typography--default" style="padding: 0 8px 8px;user-select: text" data-type="textMenu">
${e.shorthandContent}
</div>`}genItemHTML(e){return`<li style="padding-left: 0" data-id="${e.oId}" class="b3-list-item">
    <span data-type="select" class="b3-list-item__action">
        <svg><use xlink:href="#icon${this.selectIds.includes(e.oId)?"Check":"Uncheck"}"></use></svg> 
    </span>
    <span class="fn__space--small"></span>
    <span class="b3-list-item__text" title="${e.shorthandTitle}${e.shorthandTitle===e.shorthandDesc?"":`
`+e.shorthandDesc}">${e.shorthandTitle}</span>
    <span class="b3-list-item__meta">${e.hCreated}</span>
</li>`}more(e,n){const a=this.element.querySelector(".inboxDetails");window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.refresh,icon:"iconRefresh",click:()=>{n?E("/api/inbox/getShorthand",{id:n.dataset.id},s=>{this.data[s.data.oId]=s.data,n.outerHTML=this.genItemHTML(s.data)}):a.classList.contains("fn__none")?(this.currentPage=1,this.update()):E("/api/inbox/getShorthand",{id:a.getAttribute("data-id")},s=>{this.data[s.data.oId]=s.data,a.innerHTML=this.genDetail(s.data),a.scrollTop=0})}}).element);let i=[];n?i=[n.dataset.id]:a.classList.contains("fn__none")?i=this.selectIds:i=[a.getAttribute("data-id")],i.length>0&&(window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.move,icon:"iconMove",click:()=>{this.move(i)}}).element),window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.remove,icon:"iconTrashcan",click:()=>{let s="";i.forEach((o,l)=>{s+='<code class="fn__code">'+pe(this.data[o].shorthandTitle)+"</code>"+(l===i.length-1?"":", ")}),xe(window.siyuan.languages.deleteOpConfirm,`${window.siyuan.languages.confirmDelete} ${s}?`,()=>{n?this.remove(n.dataset.id):a.classList.contains("fn__none")?this.remove():this.remove(a.getAttribute("data-id"))},void 0,!0)}}).element)),this.app.plugins&&An({plugins:this.app.plugins,type:"open-menu-inbox",detail:{ids:i,element:n||a},separatorPosition:"top"}),window.siyuan.menus.menu.popup({x:e.clientX,y:e.clientY+16})}remove(e){let n;e?n=[e]:n=this.selectIds,E("/api/inbox/removeShorthands",{ids:n},()=>{e?(this.back(),this.selectIds.find((a,i)=>{if(a===e)return this.selectIds.splice(i,1),!0})):this.selectIds=[],this.currentPage=1,this.update()})}move(e){vi((n,a)=>{e.forEach(i=>{E("/api/inbox/getShorthand",{id:i},s=>{this.data[s.data.oId]=s.data;let o=s.data.shorthandMd;o===""&&s.data.shorthandContent===""&&s.data.shorthandURL!=""&&(o="["+s.data.shorthandTitle+"]("+s.data.shorthandURL+")"),E("/api/filetree/createDoc",{notebook:a[0],path:Ee().join(nt(n[0],!1,!0),Lute.NewNodeID()+".sy"),title:On(s.data.shorthandTitle),md:o,listDocTree:!0},()=>{this.remove(i)})})})})}update(){const e=this.element.querySelector(".fn__loading");if(Si("")){this.element.lastElementChild.innerHTML=`<ul class="b3-list b3-list--background">
    <li class="b3-list--empty">
        ${window.siyuan.languages.inboxTip}
    </li>
    <li class="b3-list--empty">
        ${window.siyuan.config.system.container==="ios"?window.siyuan.languages._kernel[122]:window.siyuan.languages._kernel[29].replace("${url}",yn("subscribe/siyuan"))}
    </li>
</ul>`,e.classList.add("fn__none");return}e.classList.contains("fn__none")&&(e.classList.remove("fn__none"),E("/api/inbox/getShorthands",{page:this.currentPage},n=>{e.classList.add("fn__none");let a="";n.data.data.shorthands.length===0?a=`<ul class="b3-list b3-list--background"><li class="b3-list--empty">${window.siyuan.languages.inboxTip}</li></ul>`:(a='<ul style="padding: 8px 0" class="b3-list b3-list--background">',n.data.data.shorthands.forEach(l=>{a+=this.genItemHTML(l),this.data[l.oId]=l}),a+="</ul>"),this.element.lastElementChild.innerHTML=a,this.pageCount=n.data.data.pagination.paginationRecordCount,this.element.querySelector(".inboxSelectCount").innerHTML=`${this.selectIds.length}/${this.pageCount}`;const i=this.element.querySelector('[data-type="previous"]'),s=this.element.querySelector('[data-type="next"]');n.data.data.pagination.paginationPageCount>this.currentPage?s.removeAttribute("disabled"):s.setAttribute("disabled","disabled"),this.currentPage===1?i.setAttribute("disabled","disabled"):i.removeAttribute("disabled");const o=this.element.lastElementChild.querySelectorAll(".b3-list-item").length;this.element.firstElementChild.querySelector('[data-type="selectall"] use').setAttribute("xlink:href",this.element.lastElementChild.querySelectorAll('[*|href="#iconCheck"]').length===o&&o!==0?"#iconCheck":"#iconUncheck"),this.element.lastElementChild.scrollTop=0}))}}const Lb=["file","outline","inbox","bookmark","tag","graph","globalGraph","backlink"];class xb{constructor(e){switch(this.pin=!0,e.position){case"Left":this.layout=window.siyuan.layout.layout.children[0].children[0],this.resizeElement=this.layout.element.nextElementSibling,this.layout.element.classList.add("layout__dockl"),this.layout.element.insertAdjacentHTML("beforeend",'<div class="layout__dockresize layout__dockresize--lr"></div>');break;case"Right":this.layout=window.siyuan.layout.layout.children[0].children[2],this.resizeElement=this.layout.element.previousElementSibling,this.layout.element.classList.add("layout__dockr"),this.layout.element.insertAdjacentHTML("beforeend",'<div class="layout__dockresize layout__dockresize--lr"></div>');break;case"Bottom":this.layout=window.siyuan.layout.layout.children[1],this.resizeElement=this.layout.element.previousElementSibling,this.layout.element.classList.add("layout__dockb"),this.layout.element.insertAdjacentHTML("beforeend",'<div class="layout__dockresize"></div>');break}this.app=e.app,this.element=document.getElementById("dock"+e.position);const n=e.position==="Bottom"?' class="fn__flex dock__items"':' class="dock__items"';this.element.innerHTML=`<div${n}></div><div class="fn__flex-1 dock__item--space"></div><div${n}></div>`,this.position=e.position,this.pin=e.data.pin,this.data={};let a=!1;e.data.data.length!==0&&(a||e.data.data[0].find(s=>{if(Lb.includes(s.type))return a=!0,!0}),!a&&e.data.data[1]&&e.data.data[1].find(s=>{if(Lb.includes(s.type))return a=!0,!0})),a?(this.genButton(e.data.data[0],0),e.data.data[1]&&this.genButton(e.data.data[1],1),this.element.classList.remove("fn__none")):(this.element.firstElementChild.innerHTML=`<span class="dock__item dock__item--pin ariaLabel" aria-label="${this.pin?window.siyuan.languages.unpin:window.siyuan.languages.pin}">
    <svg><use xlink:href="#icon${this.pin?"Unpin":"Pin"}"></use></svg>
</span>`,this.element.classList.add("fn__none"));const i=this.element.querySelectorAll(".dock__item--active");this.element.querySelectorAll(".dock__item").forEach(s=>{s.getAttribute("data-type")==="file"&&!s.classList.contains("dock__item--active")&&(this.toggleModel("file",!0,!1,!1,!1),this.toggleModel("file",!1,!1,!1,!1))}),i.length===0?this.resizeElement.classList.add("fn__none"):i.forEach(s=>{this.toggleModel(s.getAttribute("data-type"),!0,!1,!1,!1)}),this.element.addEventListener("click",s=>{let o=s.target;for(;o&&!o.isEqualNode(this.element);){const l=o.getAttribute("data-type");if(l){this.toggleModel(l,!1,!0),s.preventDefault();break}else if(o.classList.contains("dock__item")){this.togglePin(),o.setAttribute("aria-label",this.pin?window.siyuan.languages.unpin:window.siyuan.languages.pin),o.querySelector("use").setAttribute("xlink:href",this.pin?"#iconUnpin":"#iconPin"),s.preventDefault();break}o=o.parentElement}}),this.element.addEventListener("mousedown",s=>{const o=L(s.target,"dock__item");if(!o||!o.getAttribute("data-type"))return;const l=document;l.ondragstart=()=>!1;let r,d;const c=document.createElement("span");c.classList.add("dock__item","fn__none"),c.style.background="var(--b3-theme-primary-light)",c.innerHTML="<svg></svg>",c.id="dockMoveItem",l.onmousemove=f=>{if(window.siyuan.config.readonly||Math.abs(f.clientY-s.clientY)<3&&Math.abs(f.clientX-s.clientX)<3)return;f.preventDefault(),f.stopPropagation(),r||(o.style.opacity="0.38",r=o.cloneNode(!0),r.setAttribute("data-ghost-type","dock"),this.element.append(r),r.setAttribute("data-original",JSON.stringify({position:this.position,index:o.getAttribute("data-index"),previousType:o.previousElementSibling?.getAttribute("data-type"),type:o.getAttribute("data-type")})),r.setAttribute("id","dragGhost"),r.setAttribute("style",`background-color:var(--b3-theme-background-light);position: fixed; top: ${s.clientY}px; left: ${s.clientX}px; z-index:999997;`)),this.position==="Bottom"?(r.style.top=f.clientY-40+"px",r.style.left=f.clientX-20+"px"):(r.style.top=f.clientY-20+"px",this.position==="Left"?r.style.left=f.clientX+"px":r.style.left=f.clientX-40+"px");const g=L(f.target,"dock__item")||L(f.target,"dock__items")||L(f.target,"dock__item--space");if(g&&d&&g.isSameNode(d)){if(d.classList.contains("dock__item--space")){const p=d.getBoundingClientRect();if(d.parentElement.id==="dockBottom"){if(f.clientX<p.right&&f.clientX>p.right-40){const h=d.nextElementSibling.firstElementChild;h&&h.isSameNode(o)?c.classList.add("fn__none"):(c.classList.remove("fn__none"),h.before(c))}}else if(f.clientY<p.bottom&&f.clientY>p.bottom-40){const h=d.nextElementSibling.firstElementChild;h&&h.isSameNode(o)?c.classList.add("fn__none"):(c.classList.remove("fn__none"),h.before(c))}}else if(d.classList.contains("dock__item--pin"))o.nextElementSibling?.isSameNode(d)?c.classList.add("fn__none"):(c.classList.remove("fn__none"),d.before(c));else if(d.classList.contains("dock__item")){const p=d.getBoundingClientRect();d.parentElement.parentElement.id==="dockBottom"?p.left+p.width/2>f.clientX?o.nextElementSibling?.isSameNode(d)?c.classList.add("fn__none"):(c.classList.remove("fn__none"),d.before(c)):o.previousElementSibling?.isSameNode(d)?c.classList.add("fn__none"):(c.classList.remove("fn__none"),d.after(c)):p.top+p.height/2>f.clientY?o.nextElementSibling?.isSameNode(d)?c.classList.add("fn__none"):(c.classList.remove("fn__none"),d.before(c)):o.previousElementSibling?.isSameNode(d)?c.classList.add("fn__none"):(c.classList.remove("fn__none"),d.after(c))}else d.childElementCount===0?(c.classList.remove("fn__none"),d.append(c)):d.childElementCount===1&&d.firstElementChild.id==="dockMoveItem"?c.classList.remove("fn__none"):d.childElementCount===1&&d.firstElementChild.classList.contains("dock__item--pin")?(c.classList.remove("fn__none"),d.insertAdjacentElement("afterbegin",c)):d.childElementCount===2&&d.firstElementChild.id==="dockMoveItem"&&d.lastElementChild.classList.contains("dock__item--pin")&&c.classList.remove("fn__none");return}if(!g||g.style.position==="fixed"||g.isSameNode(o)||g.id==="dockMoveItem"){g&&g.isSameNode(o)&&c.classList.add("fn__none");return}d=g},l.onmouseup=()=>{if(l.onmousemove=null,l.onmouseup=null,l.ondragstart=null,l.onselectstart=null,l.onselect=null,r?.remove(),o.style.opacity==="0.38"){if(o.style.opacity="",!c.classList.contains("fn__none")){let f;c.parentElement.parentElement.id==="dockBottom"?f=window.siyuan.layout.bottomDock:c.parentElement.parentElement.id==="dockLeft"?f=window.siyuan.layout.leftDock:c.parentElement.parentElement.id==="dockRight"&&(f=window.siyuan.layout.rightDock),f.add(c.parentElement.isSameNode(f.element.firstElementChild)?0:1,o,c.previousElementSibling?.getAttribute("data-type"))}c.remove()}}}),this.layout.element.addEventListener("mouseleave",s=>{s.buttons!==0||this.pin||s.toElement?.classList.contains("b3-menu")||s.toElement?.classList.contains("tooltip")||this.position==="Left"&&s.clientX<43||this.position==="Right"&&s.clientX>window.innerWidth-43||this.position==="Bottom"&&s.clientY>window.innerHeight-73||this.hideDock()}),this.layout.element.querySelector(".layout__dockresize").addEventListener("mousedown",s=>{const o=document,l=this.position==="Bottom"?"tb":"lr",r=s[l==="lr"?"clientX":"clientY"],d=l==="lr"?this.layout.element.clientWidth:this.layout.element.clientHeight;o.onmousemove=c=>{c.preventDefault(),c.stopPropagation();let f;this.position==="Left"?f=d+(c.clientX-r):this.position==="Right"?f=d+(r-c.clientX):f=d+(r-c.clientY);let g=232;Array.from(this.layout.element.querySelectorAll(".file-tree")).find(p=>{if((p.classList.contains("sy__backlink")||p.classList.contains("sy__graph")||p.classList.contains("sy__globalGraph")||p.classList.contains("sy__inbox"))&&!p.classList.contains("fn__none")&&!L(p,"fn__none"))return g=320,!0}),!(f<g&&l==="lr")&&(f<64&&l==="tb"||(this.layout.element.style[l==="lr"?"width":"height"]=f+"px"))},o.onmouseup=()=>{o.onmousemove=null,o.onmouseup=null,o.ondragstart=null,o.onselectstart=null,o.onselect=null,this.setSize(),this.element.querySelectorAll(".dock__item--active").forEach(c=>{const f=this.data[c.getAttribute("data-type")];f&&f instanceof Wa&&f.resize&&f.resize()})}}),window.siyuan.config.uiLayout.hideDock&&this.element.classList.add("fn__none"),this.pin||setTimeout(()=>{this.resetDockPosition(!1),this.hideDock(!0),this.layout.element.classList.add("layout--float"),this.resizeElement.classList.add("fn__none")})}togglePin(){this.pin=!this.pin;const e=this.element.querySelector(".dock__item--active");this.pin?(this.layout.element.style.opacity="",this.layout.element.style.transform="",this.layout.element.style.zIndex="",e&&this.resizeElement.classList.remove("fn__none")):(this.resetDockPosition(!!e),this.resizeElement.classList.add("fn__none"),e?this.showDock(!0):this.hideDock(!0)),this.layout.element.classList.toggle("layout--float"),ln()}resetDockPosition(e){this.position==="Left"?this.layout.element.setAttribute("style",`width:${this.layout.element.clientWidth}px;opacity:${e?1:0};`):this.position==="Right"?this.layout.element.setAttribute("style",`width:${this.layout.element.clientWidth}px;opacity:${e?1:0};`):this.layout.element.setAttribute("style",`height:${this.layout.element.clientHeight}px;opacity:${e?1:0};`)}showDock(e=!1){!e&&(this.pin||!this.element.querySelector(".dock__item--active")||this.layout.element.style.opacity==="1")||!e&&(this.position==="Left"||this.position==="Right")&&this.layout.element.clientWidth===0&&this.layout.element.style.width.startsWith("0")||!e&&this.position==="Bottom"&&this.layout.element.clientHeight===0&&this.layout.element.style.height.startsWith("0")||(document.querySelector(".b3-dialog")||document.querySelector(".block__popover")||document.querySelector("#commonMenu:not(.fn__none)"))&&(window.siyuan.layout.leftDock?.layout.element.style.opacity==="1"||window.siyuan.layout.rightDock?.layout.element.style.opacity==="1"||window.siyuan.layout.bottomDock?.layout.element.style.opacity==="1")||(e||(this.layout.element.style.opacity="1"),this.layout.element.style.transform="",this.layout.element.style.zIndex=(++window.siyuan.zIndex).toString(),this.position==="Left"?this.layout.element.style.left=`${this.element.clientWidth}px`:this.position==="Right"?this.layout.element.style.right=`${this.element.clientWidth}px`:this.position==="Bottom"&&(this.layout.element.style.bottom=`${this.element.offsetHeight+document.getElementById("status").offsetHeight}px`))}hideDock(e=!1){if(!e&&(this.layout.element.style.opacity==="0"||this.pin))return;const n=this.layout.element.querySelector(".fullscreen");if(n&&n.clientHeight>0||document.activeElement&&this.layout.element.contains(document.activeElement)&&document.activeElement.classList.contains("b3-text-field"))return;const a=document.querySelector(".b3-dialog"),i=document.querySelector(".block__popover"),s=document.querySelector("#commonMenu:not(.fn__none)");a&&a.style.zIndex>this.layout.element.style.zIndex||i&&i.style.zIndex>this.layout.element.style.zIndex||s&&s.style.zIndex>this.layout.element.style.zIndex||(this.position==="Left"?(this.layout.element.style.transform=`translateX(-${this.layout.element.clientWidth+8}px)`,this.layout.element.style.left=""):this.position==="Right"?(this.layout.element.style.transform=`translateX(${this.layout.element.clientWidth+8}px)`,this.layout.element.style.right=""):this.position==="Bottom"&&(this.layout.element.style.transform=`translateY(${this.layout.element.clientHeight+8}px)`,this.layout.element.style.bottom=""),!e&&(this.layout.element.style.opacity="0",this.element.querySelector(".dock__item--activefocus")?.classList.remove("dock__item--activefocus"),this.layout.element.querySelector(".layout__tab--active")?.classList.remove("layout__tab--active")))}toggleModel(e,n=!1,a=!1,i=!1,s=!0){if(!e)return;op();const o=this.element.querySelector(`[data-type="${e}"]`);n&&o.classList.contains("dock__item--active")&&o.classList.remove("dock__item--active","dock__item--activefocus");const l=parseInt(o.getAttribute("data-index")),r=this.layout.children[l];if(o.classList.contains("dock__item--active")||i){if(!a){let p=!1;if(Array.from(r.element.querySelector(".layout-tab-container").children).find(h=>{if(h.getAttribute("data-id")===o.getAttribute("data-id"))return h.classList.contains("layout__tab--active")||(tt(h),p=!0),!0}),p){document.activeElement&&document.activeElement.blur(),this.showDock();return}}if(o.classList.remove("dock__item--active","dock__item--activefocus"),this.element.querySelectorAll(".dock__item--active").length===0&&(this.position==="Left"||this.position==="Right"?this.layout.element.style.width="0px":this.layout.element.style.height="0px",this.resizeElement.classList.add("fn__none"),clearTimeout(this.hideResizeTimeout),this.hideDock()),(e==="graph"||e==="globalGraph")&&(this.layout.element.querySelector(".fullscreen")&&document.getElementById("drag")?.classList.remove("fn__hidden"),this.data[e].destroy()),s&&!document.querySelector(".layout__center .layout__wnd--active")){const p=document.querySelector(".layout__center ul.layout-tab-bar .item--focus");p&&ba().find(h=>{if(h.id===p.getAttribute("data-id"))return h.parent.switchTab(h.headElement,!1,!0,!1),!0})}}else{if(this.element.querySelectorAll(`.dock__item--active[data-index="${l}"]`).forEach(p=>{p.classList.remove("dock__item--active","dock__item--activefocus")}),o.classList.add("dock__item--active","dock__item--activefocus"),o.getAttribute("data-id"))Array.from(r.element.querySelector(".layout-tab-container").children).forEach(p=>{p.getAttribute("data-id")===o.getAttribute("data-id")?(p.classList.remove("fn__none"),tt(p)):p.classList.add("fn__none")});else{let p;Ce().editor.find(b=>{if(b.parent.headElement.classList.contains("item--focus")&&b.editor?.protyle?.path)return p=b.editor,!0});let m;switch(e){case"file":m=new ut({callback:b=>{b.addModel(new Li({tab:b,app:this.app}))}});break;case"bookmark":m=new ut({callback:b=>{b.addModel(new vo(this.app,b))}});break;case"tag":m=new ut({callback:b=>{b.addModel(new Eo(this.app,b))}});break;case"outline":m=new ut({callback:b=>{const y=new us({app:this.app,type:"pin",tab:b,blockId:p?.protyle?.block?.rootID,isPreview:p?.protyle?.preview?!p.protyle.preview.element.classList.contains("fn__none"):!1});p?.protyle?.title?.editElement&&y.updateDocTitle(p.protyle?.background?.ial),b.addModel(y)}});break;case"graph":m=new ut({callback:b=>{b.addModel(new ri({app:this.app,tab:b,blockId:p?.protyle?.block?.rootID,type:"pin"}))}});break;case"globalGraph":m=new ut({callback:b=>{b.addModel(new ri({app:this.app,tab:b,type:"global"}))}});break;case"backlink":m=new ut({callback:b=>{b.addModel(new fs({app:this.app,type:"pin",tab:b,blockId:p?.protyle?.block?.rootID}))}});break;case"inbox":m=new ut({callback:b=>{b.addModel(new PT(this.app,b))}});break;default:m=new ut({callback:b=>{let y;this.app.plugins.find(w=>{if(w.docks[e])return y=w.docks[e].model({tab:b}),!0}),y&&b.addModel(y)}});break}r.addTab(m,!1,!1),o.setAttribute("data-id",m.id),this.data[e]=m.model,tt(m.panelElement)}this.position==="Left"||this.position==="Right"?this.layout.element.style.width=this.getMaxSize()+"px":this.layout.element.style.height=this.getMaxSize()+"px",(e==="graph"||e==="globalGraph")&&this.layout.element.querySelector(".fullscreen")&&document.getElementById("drag")?.classList.add("fn__hidden"),this.pin&&(this.layout.element.style.opacity="",this.hideResizeTimeout=window.setTimeout(()=>{this.resizeElement.classList.remove("fn__none")},200)),document.activeElement&&document.activeElement.blur()}const d=l===0?1:0,c=this.layout.children[d],f=this.element.querySelectorAll(`.dock__item--active[data-index="${d}"]`).length>0,g=this.element.querySelectorAll(`.dock__item--active[data-index="${l}"]`).length>0;if(g&&f){let p=r;d===0?c.element.nextElementSibling.classList.remove("fn__none"):(p=c,c.element.previousElementSibling.classList.remove("fn__none"));const h=this.element.querySelector('.dock__item--active[data-index="1"]');if(this.position==="Left"||this.position==="Right"){const m=parseInt(h.getAttribute("data-height"));m!==0&&!isNaN(m)&&(p.element.style.height=m+"px",p.element.classList.remove("fn__flex-1"))}else{const m=parseInt(h.getAttribute("data-width"));m!==0&&!isNaN(m)&&(p.element.style.width=m+"px",p.element.classList.remove("fn__flex-1"))}}else d===0?c.element.nextElementSibling.classList.add("fn__none"):c.element.previousElementSibling.classList.add("fn__none");f?c.element.classList.remove("fn__none"):c.element.classList.add("fn__none"),g?r.element.classList.remove("fn__none"):r.element.classList.add("fn__none"),g&&!f?(r.element.classList.add("fn__flex-1"),r.element.style.height="",r.element.style.width=""):!g&&f&&(c.element.classList.add("fn__flex-1"),c.element.style.height="",c.element.style.width=""),ln(s),this.showDock(),o.classList.contains("dock__item--active")&&!i&&(e==="graph"||e==="globalGraph")&&this.data[e].onGraph(!1)}add(e,n,a){n.setAttribute("data-height",""),n.setAttribute("data-width","");const i=n.getAttribute("data-type"),s=Qe(i);s.element.querySelectorAll(".dock__item").length===2&&s.element.classList.add("fn__none");const o=s.layout.children[parseInt(n.getAttribute("data-index"))];n.getAttribute("data-id")&&(o.removeTab(n.getAttribute("data-id")),n.removeAttribute("data-id"));const r=n.classList.contains("dock__item--active");r&&s.toggleModel(i),delete s.data[i],n.setAttribute("data-index",e.toString()),a?this.element.querySelector(`[data-type="${a}"]`).after(n):e===0?this.element.firstElementChild.insertAdjacentElement("afterbegin",n):this.element.lastElementChild.insertAdjacentElement("afterbegin",n),this.element.classList.remove("fn__none"),$m(),this.data[i]=!0,r&&this.toggleModel(i,!0,!1,!1,!1),dn()}remove(e){this.toggleModel(e,!1,!0,!0),this.element.querySelector(`[data-type="${e}"]`).remove();const n=this.data[e];n.parent&&n.parent.parent.removeTab(n.parent.id),delete this.data[e]}setSize(){const e=this.element.querySelectorAll(".dock__item--active");e.forEach(n=>{if(this.position==="Left"||this.position==="Right"){if(n.getAttribute("data-index")==="1"&&e.length>1){const a=this.data[n.getAttribute("data-type")].parent.parent.element;n.setAttribute("data-height",a.style.height?a.clientHeight.toString():"")}n.setAttribute("data-width",this.layout.element.clientWidth.toString())}else{if(n.getAttribute("data-index")==="1"&&e.length>1){const a=this.data[n.getAttribute("data-type")].parent.parent.element;n.setAttribute("data-width",a.style.width?a.clientWidth.toString():"")}n.setAttribute("data-height",this.layout.element.clientHeight.toString())}})}getMaxSize(){let e=0;return this.element.querySelectorAll(".dock__item--active").forEach(n=>{let a;this.position==="Left"||this.position==="Right"?a=parseInt(n.getAttribute("data-width"))||(["graph","globalGraph","backlink"].includes(n.getAttribute("data-type"))?320:232):a=parseInt(n.getAttribute("data-height"))||232,a>e&&(e=a)}),e}genButton(e,n,a){let i="";e.forEach(s=>{typeof a>"u"&&!Lb.includes(s.type)||(i+=`<span data-height="${s.size.height}" data-width="${s.size.width}" data-type="${s.type}" data-index="${n}" data-hotkey="${s.hotkey||""}" data-hotkeyLangId="${s.hotkeyLangId||""}" data-title="${s.title}" class="dock__item${s.show?" dock__item--active":""} ariaLabel" aria-label="<span style='white-space:pre'>${s.title} ${s.hotkey?X(s.hotkey):""}${window.siyuan.languages.dockTip}</span>">
    <svg><use xlink:href="#${s.icon}"></use></svg>
</span>`,this.data[s.type]=!0)}),n===0?typeof a=="number"?this.element.firstElementChild.children[a]?this.element.firstElementChild.children[a].insertAdjacentHTML("beforebegin",i):this.element.firstElementChild.lastElementChild.insertAdjacentHTML("beforebegin",i):this.element.firstElementChild.innerHTML=`${i}<span class="dock__item dock__item--pin ariaLabel" aria-label="${this.pin?window.siyuan.languages.unpin:window.siyuan.languages.pin}">
    <svg><use xlink:href="#icon${this.pin?"Unpin":"Pin"}"></use></svg>
</span>`:typeof a=="number"?this.element.lastElementChild.children[a]?this.element.lastElementChild.children[a].insertAdjacentHTML("beforebegin",i):this.element.lastElementChild.insertAdjacentHTML("beforeend",i):this.element.lastElementChild.innerHTML=i,typeof a=="number"&&(window.siyuan.config.uiLayout.hideDock||this.element.classList.remove("fn__none"),e[0].show&&this.toggleModel(e[0].type,!0,!1,!1,!1))}}class XE{constructor(e){this.data={},this.protyleSlash=[],this.customBlockRenders={},this.topBarIcons=[],this.statusBarIcons=[],this.commands=[],this.models={},this.docks={},this.addFloatLayer=n=>{window.siyuan.blockPanels.push(new Hc({app:this.app,targetElement:n.targetElement,isBacklink:n.isBacklink,x:n.x,y:n.y,refDefs:n.refDefs}))},this.app=e.app,this.i18n=e.i18n,this.displayName=e.displayName,this.eventBus=new gL(e.name),Object.defineProperty(this,"name",{value:e.name,writable:!1}),this.updateProtyleToolbar([]).forEach(n=>{typeof n=="string"||u.INLINE_TYPE.concat("|").includes(n.name)||!n.hotkey||(window.siyuan.config.keymap.plugin||(window.siyuan.config.keymap.plugin={}),window.siyuan.config.keymap.plugin[e.name]||(window.siyuan.config.keymap.plugin[e.name]={[n.name]:{default:n.hotkey,custom:n.hotkey}}),window.siyuan.config.keymap.plugin[e.name][n.name]||(window.siyuan.config.keymap.plugin[e.name][n.name]={default:n.hotkey,custom:n.hotkey}))})}onload(){}onunload(){}uninstall(){}async updateCards(e){return e}onLayoutReady(){}addCommand(e){window.siyuan.config.keymap.plugin||(window.siyuan.config.keymap.plugin={}),window.siyuan.config.keymap.plugin[this.name]?window.siyuan.config.keymap.plugin[this.name][e.langKey]?window.siyuan.config.keymap.plugin[this.name][e.langKey]&&(typeof window.siyuan.config.keymap.plugin[this.name][e.langKey].custom=="string"?e.customHotkey=window.siyuan.config.keymap.plugin[this.name][e.langKey].custom:e.customHotkey=e.hotkey,window.siyuan.config.keymap.plugin[this.name][e.langKey].default=e.hotkey):(e.customHotkey=e.hotkey,window.siyuan.config.keymap.plugin[this.name][e.langKey]={default:e.hotkey,custom:e.hotkey}):(e.customHotkey=e.hotkey,window.siyuan.config.keymap.plugin[this.name]={[e.langKey]:{default:e.hotkey,custom:e.hotkey}}),typeof e.customHotkey!="string"?console.error(`${this.name} - commands data is error and has been removed.`):this.commands.push(e)}addIcons(e){document.body.insertAdjacentHTML("afterbegin",`<svg data-name="${this.name}" style="position: absolute; width: 0; height: 0; overflow: hidden;" xmlns="http://www.w3.org/2000/svg">
<defs>${e}</defs></svg>`)}addTopBar(e){if(!e.icon.startsWith("icon")&&!e.icon.startsWith("<svg")){console.error(`plugin ${this.name} addTopBar error: icon must be svg id or svg tag`);return}const n=document.createElement("div");return n.setAttribute("data-menu","true"),n.addEventListener("click",e.callback),n.id=`plugin_${this.name}_${this.topBarIcons.length}`,W()?(n.className="b3-menu__item",n.innerHTML=(e.icon.startsWith("icon")?`<svg class="b3-menu__icon"><use xlink:href="#${e.icon}"></use></svg>`:e.icon)+`<span class="b3-menu__label">${e.title}</span>`):ve()||(n.className="toolbar__item ariaLabel",n.setAttribute("aria-label",e.title),n.innerHTML=e.icon.startsWith("icon")?`<svg><use xlink:href="#${e.icon}"></use></svg>`:e.icon,n.addEventListener("click",e.callback),n.setAttribute("data-location",e.position||"right")),this.topBarIcons.push(n),n}addStatusBar(e){return e.element.setAttribute("data-location",e.position||"right"),this.statusBarIcons.push(e.element),e.element}openSetting(){this.setting&&this.setting.open(this.name)}loadData(e){return typeof this.data[e]>"u"&&(this.data[e]=""),new Promise(n=>{E("/api/file/getFile",{path:`/data/storage/petal/${this.name}/${e}`},a=>{a.code!==404&&(this.data[e]=a),n(this.data[e])})})}saveData(e,n){return new Promise(a=>{const i=`/data/storage/petal/${this.name}/${e}`;let s;typeof n=="object"?s=new File([new Blob([JSON.stringify(n)],{type:"application/json"})],i.split("/").pop()):s=new File([new Blob([n])],i.split("/").pop());const o=new FormData;o.append("path",i),o.append("file",s),o.append("isDir","false"),E("/api/file/putFile",o,l=>{this.data[e]=n,a(l)})})}removeData(e){return new Promise(n=>{this.data||(this.data={}),E("/api/file/removeFile",{path:`/data/storage/petal/${this.name}/${e}`},a=>{delete this.data[e],n(a)})})}getOpenedTab(){const e={},n=Object.keys(this.models);return n.forEach(a=>{e[a.replace(this.name,"")]=[]}),Ce().custom.find(a=>{n.includes(a.type)&&e[a.type.replace(this.name,"")].push(a)}),e}addTab(e){const n=this.name+e.type;return this.models[n]=a=>{const i=new Wa({app:this.app,tab:a.tab,type:n,data:a.data,init:e.init,beforeDestroy:e.beforeDestroy,destroy:e.destroy,resize:e.resize,update:e.update});return i.element.addEventListener("click",()=>{Di(),tt(i.element.parentElement.parentElement)}),i},this.models[n]}addDock(e){const n=this.name+e.type;return typeof e.config.index>"u"&&(e.config.index=1e3),this.docks[n]={config:e.config,model:a=>{const i=new Wa({app:this.app,tab:a.tab,type:n,data:e.data,init:e.init,destroy:e.destroy,resize:e.resize,update:e.update});return i.element.addEventListener("click",s=>{tt(i.element),B(s.target,"data-type","min")&&Qe(n).toggleModel(n)}),i.element.classList.add("sy__"+n),i}},window.siyuan.config.keymap.plugin||(window.siyuan.config.keymap.plugin={}),e.config.hotkey&&(window.siyuan.config.keymap.plugin[this.name]?window.siyuan.config.keymap.plugin[this.name][n]?window.siyuan.config.keymap.plugin[this.name][n]&&(typeof window.siyuan.config.keymap.plugin[this.name][n].custom!="string"&&(window.siyuan.config.keymap.plugin[this.name][n].custom=e.config.hotkey),window.siyuan.config.keymap.plugin[this.name][n].default=e.config.hotkey):window.siyuan.config.keymap.plugin[this.name][n]={default:e.config.hotkey,custom:e.config.hotkey}:window.siyuan.config.keymap.plugin[this.name]={[n]:{default:e.config.hotkey,custom:e.config.hotkey}}),this.docks[n]}updateProtyleToolbar(e){return e}set protyleOptions(e){this.protyleOptionsValue=e}get protyleOptions(){return this.protyleOptionsValue}}class NT{constructor(e){this.items=[],this.confirmCallback=e.confirmCallback,this.destroyCallback=e.destroyCallback,this.width=e.width||(W()?"92vw":"768px"),this.height=e.height||"80vh"}addItem(e){this.items.push(e)}open(e){const n=new we({title:e,content:`<div class="b3-dialog__content">
</div>
<div class="b3-dialog__action${this.confirmCallback?"":" fn__none"}">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button>
    <div class="fn__space${this.confirmCallback?"":" fn__none"}"></div>
    <button class="b3-button b3-button--text${this.confirmCallback?"":" fn__none"}">${window.siyuan.languages.save}</button>
</div>`,width:this.width,height:this.height,destroyCallback:()=>{this.destroyCallback&&this.destroyCallback()}}),a=n.element.querySelector(".b3-dialog__content");this.items.forEach(s=>{let o="",l=s.actionElement;!s.actionElement&&s.createActionElement&&(l=s.createActionElement());const r=l?.classList.contains("b3-switch")?"label":"div";typeof s.direction>"u"&&(s.direction=!l||l.tagName==="TEXTAREA"?"row":"column"),s.direction==="row"?o=`<${r} class="b3-label">
    <div class="fn__block">
        ${s.title}
        ${s.description?`<div class="b3-label__text">${s.description}</div>`:""}
        <div class="fn__hr"></div>
    </div>
</${r}>`:o=`<${r} class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${s.title}
        ${s.description?`<div class="b3-label__text">${s.description}</div>`:""}
    </div>
    <span class="fn__space${l?"":" fn__none"}"></span>
</${r}>`,a.insertAdjacentHTML("beforeend",o),l&&(["INPUT","TEXTAREA"].includes(l.tagName)&&n.bindInput(l,()=>{i[1].dispatchEvent(new CustomEvent("click"))},l.tagName==="INPUT"),s.direction==="row"?(a.lastElementChild.lastElementChild.insertAdjacentElement("beforeend",l),l.classList.add("fn__block")):(l.classList.remove("fn__block"),l.classList.add("fn__flex-center","fn__size200"),a.lastElementChild.insertAdjacentElement("beforeend",l)))}),a.querySelector("input, textarea")?.focus();const i=n.element.querySelectorAll(".b3-dialog__action .b3-button");i[0].addEventListener("click",()=>{n.destroy()}),i[1].addEventListener("click",()=>{this.confirmCallback&&this.confirmCallback(),n.destroy()}),this.dialog=n}}const Ab=t=>{window.siyuan.config.editor.readOnly=t,E("/api/setting/setEditor",window.siyuan.config.editor)},Ae={element:void 0,genHTML:()=>`<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.fullWidth}
        <div class="b3-label__text">${window.siyuan.languages.fullWidthTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="fullWidth" type="checkbox"${window.siyuan.config.editor.fullWidth?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.justify}
        <div class="b3-label__text">${window.siyuan.languages.justifyTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="justify" type="checkbox"${window.siyuan.config.editor.justify?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.rtl}
        <div class="b3-label__text">${window.siyuan.languages.rtlTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="rtl" type="checkbox"${window.siyuan.config.editor.rtl?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.editReadonly} 
        <code class="fn__code">${X(window.siyuan.config.keymap.general.editReadonly.custom)}</code>
        <div class="b3-label__text">${window.siyuan.languages.editReadonlyTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="readOnly" type="checkbox"${window.siyuan.config.editor.readOnly?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.md12}
        <div class="b3-label__text">${window.siyuan.languages.md16}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="displayBookmarkIcon" type="checkbox"${window.siyuan.config.editor.displayBookmarkIcon?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.md7}
        <div class="b3-label__text">${window.siyuan.languages.md8}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="displayNetImgMark" type="checkbox"${window.siyuan.config.editor.displayNetImgMark?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.embedBlockBreadcrumb}
        <div class="b3-label__text">${window.siyuan.languages.embedBlockBreadcrumbTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="embedBlockBreadcrumb" type="checkbox"${window.siyuan.config.editor.embedBlockBreadcrumb?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.outlineOutdent}
        <div class="b3-label__text">${window.siyuan.languages.outlineOutdentTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="listLogicalOutdent" type="checkbox"${window.siyuan.config.editor.listLogicalOutdent?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.listItemDotNumberClickFocus}
        <div class="b3-label__text">${window.siyuan.languages.listItemDotNumberClickFocusTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="listItemDotNumberClickFocus" type="checkbox"${window.siyuan.config.editor.listItemDotNumberClickFocus?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.spellcheck}
        <div class="b3-label__text">${window.siyuan.languages.spellcheckTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="spellcheck" type="checkbox"${window.siyuan.config.editor.spellcheck?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.onlySearchForDoc}
        <div class="b3-label__text">${window.siyuan.languages.onlySearchForDocTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="onlySearchForDoc" type="checkbox"${window.siyuan.config.editor.onlySearchForDoc?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.md31}
        <div class="b3-label__text">${window.siyuan.languages.md32}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="codeLineWrap" type="checkbox"${window.siyuan.config.editor.codeLineWrap?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.md2}
        <div class="b3-label__text">${window.siyuan.languages.md3}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="codeLigatures" type="checkbox"${window.siyuan.config.editor.codeLigatures?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.md27}
        <div class="b3-label__text">${window.siyuan.languages.md28}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="codeSyntaxHighlightLineNum" type="checkbox"${window.siyuan.config.editor.codeSyntaxHighlightLineNum?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.md33}
        <div class="b3-label__text">${window.siyuan.languages.md34}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="virtualBlockRef" type="checkbox"${window.siyuan.config.editor.virtualBlockRef?" checked":""}/>
</label>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.md9}
        <div class="b3-label__text">${window.siyuan.languages.md36}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" id="virtualBlockRefInclude" value="${window.siyuan.config.editor.virtualBlockRefInclude}" />
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.md35}
        <div class="b3-label__text">${window.siyuan.languages.md36}</div>
        <div class="b3-label__text">${window.siyuan.languages.md41}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" id="virtualBlockRefExclude" value="${window.siyuan.config.editor.virtualBlockRefExclude}" />
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.md39}
        <div class="b3-label__text">${window.siyuan.languages.md40}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" id="plantUMLServePath" value="${window.siyuan.config.editor.plantUMLServePath}"/>
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.dynamicLoadBlocks}
        <div class="b3-label__text">${window.siyuan.languages.dynamicLoadBlocksTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" id="dynamicLoadBlocks" type="number" min="48" value="${window.siyuan.config.editor.dynamicLoadBlocks}"/>
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.md37}
        <div class="b3-label__text">${window.siyuan.languages.md38}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" id="blockRefDynamicAnchorTextMaxLen" type="number" min="1" max="5120" value="${window.siyuan.config.editor.blockRefDynamicAnchorTextMaxLen}"/>
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.backlinkExpand}
        <div class="b3-label__text">${window.siyuan.languages.backlinkExpandTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" id="backlinkExpandCount" type="number" min="0" max="512" value="${window.siyuan.config.editor.backlinkExpandCount}"/>
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.backmentionExpand}
        <div class="b3-label__text">${window.siyuan.languages.backmentionExpandTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" id="backmentionExpandCount" type="number" min="-1" max="512" value="${window.siyuan.config.editor.backmentionExpandCount}"/>
</div>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.backlinkContainChildren}
        <div class="b3-label__text">${window.siyuan.languages.backlinkContainChildrenTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="backlinkContainChildren" type="checkbox"${window.siyuan.config.editor.backlinkContainChildren?" checked":""}/>
</label>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.generateHistory}
        <div class="b3-label__text">${window.siyuan.languages.generateHistoryInterval}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" id="generateHistoryInterval" type="number" min="0" max="120" value="${window.siyuan.config.editor.generateHistoryInterval}"/>
</div>
<div class="b3-label">
    <div>
        ${window.siyuan.languages.historyRetentionDaysTip}
    </div>
    <div class="fn__hr"></div>
    <div class="fn__flex config__item">
        <div class="fn__flex-center fn__flex-1 ft__on-surface">${window.siyuan.languages.clearHistory}</div>
        <span class="fn__space"></span>
        <button id="clearHistory" class="b3-button b3-button--outline fn__size200 fn__flex-center">
            <svg><use xlink:href="#iconTrashcan"></use></svg>${window.siyuan.languages.purge}
        </button>
    </div>
    <div class="fn__hr"></div>
    <div class="fn__flex config__item">
        <div class="fn__flex-center fn__flex-1 ft__on-surface">${window.siyuan.languages.historyRetentionDays}</div>
        <span class="fn__space"></span>
        <input class="b3-text-field fn__flex-center fn__size200" id="historyRetentionDays" type="number" min="0" value="${window.siyuan.config.editor.historyRetentionDays}"/>
    </div>
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.floatWindowMode}
        <div class="b3-label__text">${window.siyuan.languages.floatWindowModeTip}</div>
    </div>
    <span class="fn__space"></span>
    <select class="b3-select fn__flex-center fn__size200" id="floatWindowMode">
      <option value="0" ${window.siyuan.config.editor.floatWindowMode===0?"selected":""}>${window.siyuan.languages.floatWindowMode0}</option>
      <option value="1" ${window.siyuan.config.editor.floatWindowMode===1?"selected":""}>${window.siyuan.languages.floatWindowMode1.replace("${hotkey}",X("\u2318"))}</option>
      <option value="2" ${window.siyuan.config.editor.floatWindowMode===2?"selected":""}>${window.siyuan.languages.floatWindowMode2}</option>
    </select>    
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.font}
        <div class="b3-label__text">${window.siyuan.languages.font1}</div>
    </div>
    <span class="fn__space"></span>
    <input readonly="readonly" placeholder="${window.siyuan.languages.default}" id="fontFamily" class="b3-text-field fn__flex-center fn__size200" style="font-family:'${window.siyuan.config.editor.fontFamily}',var(--b3-font-family);" value="${window.siyuan.config.editor.fontFamily}"/>
</div>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.fontSizeScrollZoom}
        <div class="b3-label__text">${window.siyuan.languages.fontSizeScrollZoomTip.replace("Ctrl",X("\u2318"))}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="fontSizeScrollZoom" type="checkbox"${window.siyuan.config.editor.fontSizeScrollZoom?" checked":""}/>
</label>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.fontSize}
        <div class="b3-label__text">${window.siyuan.languages.fontSizeTip}</div>
    </div>
    <span class="fn__space"></span>
    <div class="b3-tooltips b3-tooltips__n fn__flex-center" aria-label="${window.siyuan.config.editor.fontSize}">   
        <input class="b3-slider fn__size200" id="fontSize" max="72" min="9" step="1" type="range" value="${window.siyuan.config.editor.fontSize}">
    </div>
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.md29}
        <div class="b3-label__text">${window.siyuan.languages.md30}</div>
    </div>
    <span class="fn__space"></span>
    <div class="b3-tooltips b3-tooltips__n fn__flex-center" aria-label="${window.siyuan.config.editor.codeTabSpaces}">   
        <input class="b3-slider fn__size200" id="codeTabSpaces" max="8" min="0" step="2" type="range" value="${window.siyuan.config.editor.codeTabSpaces}">
    </div>
</div>
<div class="b3-label">
    <div class="fn__block">
        ${window.siyuan.languages.katexMacros}
        <div class="b3-label__text">${window.siyuan.languages.katexMacrosTip}</div>
        <div class="fn__hr"></div>
        <textarea class="b3-text-field fn__block" id="katexMacros" spellcheck="false">${window.siyuan.config.editor.katexMacros}</textarea>
    </div>
</div>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.allowHTMLBLockScript}
        <div class="b3-label__text">${window.siyuan.languages.allowHTMLBLockScriptTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="allowHTMLBLockScript" type="checkbox"${window.siyuan.config.editor.allowHTMLBLockScript?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.editorMarkdownInlineAsterisk}
        <div class="b3-label__text">${window.siyuan.languages.editorMarkdownInlineAsteriskTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="editorMarkdownInlineAsterisk" type="checkbox"${window.siyuan.config.editor.markdown.inlineAsterisk?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.editorMarkdownInlineUnderscore}
        <div class="b3-label__text">${window.siyuan.languages.editorMarkdownInlineUnderscoreTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="editorMarkdownInlineUnderscore" type="checkbox"${window.siyuan.config.editor.markdown.inlineUnderscore?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.editorMarkdownInlineSup}
        <div class="b3-label__text">${window.siyuan.languages.editorMarkdownInlineSupTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="editorMarkdownInlineSup" type="checkbox"${window.siyuan.config.editor.markdown.inlineSup?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.editorMarkdownInlineSub}
        <div class="b3-label__text">${window.siyuan.languages.editorMarkdownInlineSubTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="editorMarkdownInlineSub" type="checkbox"${window.siyuan.config.editor.markdown.inlineSub?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.editorMarkdownInlineTag}
        <div class="b3-label__text">${window.siyuan.languages.editorMarkdownInlineTagTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="editorMarkdownInlineTag" type="checkbox"${window.siyuan.config.editor.markdown.inlineTag?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.editorMarkdownInlineMath}
        <div class="b3-label__text">${window.siyuan.languages.editorMarkdownInlineMathTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="editorMarkdownInlineMath" type="checkbox"${window.siyuan.config.editor.markdown.inlineMath?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.editorMarkdownInlineStrikethrough}
        <div class="b3-label__text">${window.siyuan.languages.editorMarkdownInlineStrikethroughTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="editorMarkdownInlineStrikethrough" type="checkbox"${window.siyuan.config.editor.markdown.inlineStrikethrough?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.editorMarkdownInlineMark}
        <div class="b3-label__text">${window.siyuan.languages.editorMarkdownInlineMarkTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="editorMarkdownInlineMark" type="checkbox"${window.siyuan.config.editor.markdown.inlineMark?" checked":""}/>
</label>`,bindEvent:()=>{const t=Ae.element.querySelector("#fontFamily");t.addEventListener("click",()=>{E("/api/system/getSysFonts",{},n=>{const a=new st;a.addItem({iconHTML:"",checked:window.siyuan.config.editor.fontFamily==="",label:`<div style='var(--b3-font-family);'>${window.siyuan.languages.default}</div>`,click:()=>{window.siyuan.config.editor.fontFamily!==""&&(t.value="",t.style.fontFamily="",e())}}),n.data.forEach(s=>{a.addItem({iconHTML:"",checked:window.siyuan.config.editor.fontFamily===s,label:`<div style='font-family:"${s}",var(--b3-font-family);'>${s}</div>`,click:()=>{s!==window.siyuan.config.editor.fontFamily&&(t.value=s,t.style.fontFamily=s+",var(--b3-font-family)",e())}})});const i=t.getBoundingClientRect();a.open({x:i.left,y:i.bottom})})}),Ae.element.querySelector("#clearHistory").addEventListener("click",()=>{xe(window.siyuan.languages.clearHistory,window.siyuan.languages.confirmClearHistory,()=>{E("/api/history/clearWorkspaceHistory",{})})});const e=()=>{let n=parseInt(Ae.element.querySelector("#dynamicLoadBlocks").value);48>n&&(n=48,Ae.element.querySelector("#dynamicLoadBlocks").value="48"),E("/api/setting/setEditor",{fullWidth:Ae.element.querySelector("#fullWidth").checked,markdown:{inlineAsterisk:Ae.element.querySelector("#editorMarkdownInlineAsterisk").checked,inlineUnderscore:Ae.element.querySelector("#editorMarkdownInlineUnderscore").checked,inlineSup:Ae.element.querySelector("#editorMarkdownInlineSup").checked,inlineSub:Ae.element.querySelector("#editorMarkdownInlineSub").checked,inlineTag:Ae.element.querySelector("#editorMarkdownInlineTag").checked,inlineMath:Ae.element.querySelector("#editorMarkdownInlineMath").checked,inlineStrikethrough:Ae.element.querySelector("#editorMarkdownInlineStrikethrough").checked,inlineMark:Ae.element.querySelector("#editorMarkdownInlineMark").checked},allowHTMLBLockScript:Ae.element.querySelector("#allowHTMLBLockScript").checked,justify:Ae.element.querySelector("#justify").checked,rtl:Ae.element.querySelector("#rtl").checked,readOnly:Ae.element.querySelector("#readOnly").checked,displayBookmarkIcon:Ae.element.querySelector("#displayBookmarkIcon").checked,displayNetImgMark:Ae.element.querySelector("#displayNetImgMark").checked,codeSyntaxHighlightLineNum:Ae.element.querySelector("#codeSyntaxHighlightLineNum").checked,embedBlockBreadcrumb:Ae.element.querySelector("#embedBlockBreadcrumb").checked,listLogicalOutdent:Ae.element.querySelector("#listLogicalOutdent").checked,listItemDotNumberClickFocus:Ae.element.querySelector("#listItemDotNumberClickFocus").checked,spellcheck:Ae.element.querySelector("#spellcheck").checked,onlySearchForDoc:Ae.element.querySelector("#onlySearchForDoc").checked,floatWindowMode:parseInt(Ae.element.querySelector("#floatWindowMode").value),plantUMLServePath:Ae.element.querySelector("#plantUMLServePath").value,katexMacros:Ae.element.querySelector("#katexMacros").value,codeLineWrap:Ae.element.querySelector("#codeLineWrap").checked,virtualBlockRef:Ae.element.querySelector("#virtualBlockRef").checked,virtualBlockRefInclude:Ae.element.querySelector("#virtualBlockRefInclude").value,virtualBlockRefExclude:Ae.element.querySelector("#virtualBlockRefExclude").value,blockRefDynamicAnchorTextMaxLen:parseInt(Ae.element.querySelector("#blockRefDynamicAnchorTextMaxLen").value),backlinkExpandCount:parseInt(Ae.element.querySelector("#backlinkExpandCount").value),backmentionExpandCount:parseInt(Ae.element.querySelector("#backmentionExpandCount").value),backlinkContainChildren:Ae.element.querySelector("#backlinkContainChildren").checked,dynamicLoadBlocks:n,codeLigatures:Ae.element.querySelector("#codeLigatures").checked,codeTabSpaces:parseInt(Ae.element.querySelector("#codeTabSpaces").value),fontSize:parseInt(Ae.element.querySelector("#fontSize").value),fontSizeScrollZoom:Ae.element.querySelector("#fontSizeScrollZoom").checked,generateHistoryInterval:parseInt(Ae.element.querySelector("#generateHistoryInterval").value),historyRetentionDays:parseInt(Ae.element.querySelector("#historyRetentionDays").value),fontFamily:t.value,emoji:window.siyuan.config.editor.emoji},a=>{Ae._onSetEditor(a.data)})};Ae.element.querySelectorAll("input.b3-switch, select.b3-select, input.b3-slider").forEach(n=>{n.addEventListener("change",()=>{e()})}),Ae.element.querySelectorAll("textarea.b3-text-field, input.b3-text-field, input.b3-slider").forEach(n=>{n.getAttribute("readonly")||n.addEventListener("blur",()=>{e()})}),Ae.element.querySelectorAll("input.b3-slider").forEach(n=>{n.addEventListener("input",a=>{const i=a.target;i.parentElement.setAttribute("aria-label",i.value)})})},_onSetEditor:t=>{t.readOnly!==window.siyuan.config.editor.readOnly&&Ab(t.readOnly),window.siyuan.config.editor=t,Ce().editor.forEach(n=>{ei(n.editor.protyle,!1);let a=n.editor.protyle.wysiwyg.element.getAttribute(u.CUSTOM_SY_FULLWIDTH);a||(a=window.siyuan.config.editor.fullWidth?"true":"false"),!(a==="true"&&n.editor.protyle.contentElement.getAttribute("data-fullwidth")==="true")&&(Jt(n.editor.protyle),a==="true"?n.editor.protyle.contentElement.setAttribute("data-fullwidth","true"):n.editor.protyle.contentElement.removeAttribute("data-fullwidth"))}),Rl()}},HT=t=>{const e=new we({title:window.siyuan.languages.cloudSyncDir,content:`<div class="b3-dialog__content">
    <input class="b3-text-field fn__block" value="main">
    <div class="b3-label__text">${window.siyuan.languages.reposTip}</div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:W()?"92vw":"520px"});e.element.setAttribute("data-key",u.DIALOG_SYNCADDCLOUDDIR);const n=e.element.querySelector("input"),a=e.element.querySelectorAll(".b3-button");e.bindInput(n,()=>{a[1].click()}),n.focus(),n.select(),a[0].addEventListener("click",()=>{e.destroy()}),a[1].addEventListener("click",()=>{t.innerHTML='<img style="margin: 0 auto;display: block;width: 64px;height: 100%" src="/stage/loading-pure.svg">',E("/api/sync/createCloudSyncDir",{name:n.value},()=>{e.destroy(),Uc(t,!0)})})},QE=(t,e)=>{t.addEventListener("click",n=>{let a=n.target;for(;a&&!a.isEqualNode(t);){const i=a.getAttribute("data-type");if(i){switch(i){case"addCloud":HT(t);break;case"removeCloud":xe(window.siyuan.languages.deleteOpConfirm,`${window.siyuan.languages.confirmDeleteCloudDir} <i>${a.parentElement.getAttribute("data-name")}</i>`,()=>{t.innerHTML='<img style="margin: 0 auto;display: block;width: 64px;height: 100%" src="/stage/loading-pure.svg">',E("/api/sync/removeCloudSyncDir",{name:a.parentElement.getAttribute("data-name")},s=>{window.siyuan.config.sync.cloudName=s.data,Uc(t,!0,e)})},void 0,!0);break;case"selectCloud":t.innerHTML='<img style="margin: 0 auto;display: block;width: 64px;height: 100%" src="/stage/loading-pure.svg">',E("/api/sync/setCloudSyncDir",{name:a.getAttribute("data-name")},()=>{window.siyuan.config.sync.cloudName=a.getAttribute("data-name"),Uc(t,!0,e)});break}n.preventDefault(),n.stopPropagation();break}a=a.parentElement}})},Uc=(t,e=!1,n)=>{!e&&t.firstElementChild.tagName!=="IMG"||E("/api/sync/listCloudSyncDir",{},a=>{let i=`<ul><li style="padding: 0 16px" class="b3-list--empty">${window.siyuan.languages.emptyCloudSyncList}</li></ul>`;a.code===1?i=`<ul>
    <li class="b3-list--empty ft__error">
        ${a.msg}
    </li>
    <li class="b3-list--empty">
        ${window.siyuan.languages.cloudConfigTip}
    </li>
</ul>`:a.code!==1&&(i='<ul class="b3-list b3-list--background fn__flex-1" style="overflow: auto;">',a.data.syncDirs.forEach(s=>{i+=`<li data-type="selectCloud" data-name="${s.cloudName}" class="b3-list-item b3-list-item--narrow b3-list-item--hide-action">
<input type="radio" name="cloudName"${s.cloudName===a.data.checkedSyncDir?" checked":""}/>
<span class="fn__space"></span>
<span>${s.cloudName}</span>
<span class="fn__space"></span>
<span class="ft__on-surface">${s.hSize}</span>
<span class="b3-list-item__meta">${s.updated}</span>
<span class="fn__flex-1 fn__space"></span>
<span data-type="removeCloud" class="b3-tooltips b3-tooltips__w b3-list-item__action${window.siyuan.config.sync.provider===2||window.siyuan.config.sync.provider===3?" fn__none":""}" aria-label="${window.siyuan.languages.delete}">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
</span></li>`}),i+=`</ul>
<div class="fn__hr"></div>
<div class="fn__flex">
    <div class="fn__flex-1"></div>
    <button class="b3-button b3-button--outline${window.siyuan.config.sync.provider===2||window.siyuan.config.sync.provider===3?" fn__none":""}" data-type="addCloud"><svg><use xlink:href="#iconAdd"></use></svg>${window.siyuan.languages.addAttr}</button>
</div>`),t.innerHTML=i,n&&n()})},Dp=t=>{if(!window.siyuan.config.readonly&&!document.querySelector("#barSync")?.classList.contains("toolbar__item--active")){if(window.siyuan.config.sync.provider===0&&Si("")&&t){const e=To(t);window.siyuan.user?e.element.querySelector('.b3-tab-bar [data-name="repos"]').dispatchEvent(new CustomEvent("click")):(e.element.querySelector('.b3-tab-bar [data-name="account"]').dispatchEvent(new CustomEvent("click")),e.element.querySelector('.config__tab-container[data-name="account"]').setAttribute("data-action","go-repos"));return}if(window.siyuan.config.sync.provider!==0&&!es()&&t){j(window.siyuan.languages._kernel[214]);return}if(!window.siyuan.config.repo.key){tk(!0);return}if(!window.siyuan.config.sync.enabled){ek();return}Cb()}},Cb=()=>{if(window.siyuan.config.sync.mode!==3){E("/api/sync/performSync",{});return}const t=new we({title:window.siyuan.languages.chooseSyncDirection,content:`<div class="b3-dialog__content">
    <label class="fn__flex b3-label">
        <input type="radio" name="upload" value="true">
        <span class="fn__space"></span>
        <div>
            ${window.siyuan.languages.uploadData2Cloud}
            <div class="b3-label__text">${window.siyuan.languages.uploadData2CloudTip}</div>
        </div>
    </label>
    <label class="fn__flex b3-label">
        <input type="radio" name="upload" value="false">
        <span class="fn__space"></span>
        <div>
            ${window.siyuan.languages.downloadDataFromCloud}
            <div class="b3-label__text">${window.siyuan.languages.downloadDataFromCloudTip}</div>
        </div>
    </label>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:W()?"92vw":"520px"});t.element.setAttribute("data-key",u.DIALOG_SYNCCHOOSEDIRECTION);const e=t.element.querySelectorAll(".b3-button");e[0].addEventListener("click",()=>{t.destroy()}),e[1].addEventListener("click",()=>{const n=t.element.querySelector("input[name=upload]:checked");if(!n){j(window.siyuan.languages.plsChoose);return}E("/api/sync/performSync",{upload:n.value==="true"}),t.destroy()})},ek=(t,e)=>{if(t&&(window.siyuan.config.repo.key=t),window.siyuan.config.sync.enabled)e&&e.destroy(),xe("\u{1F504} "+window.siyuan.languages.syncConfGuide4,window.siyuan.languages.syncConfGuide5,()=>{Cb()});else{const n=`<div class="b3-dialog__content">
    <div class="ft__on-surface">${window.siyuan.languages.syncConfGuide3}</div>
    <div class="fn__hr--b"></div>
    <div style="display: flex;flex-direction: column;height: 40vh;">
        <img style="margin: 0 auto;display: block;width: 64px;height: 100%" src="/stage/loading-pure.svg">
    </div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button" disabled="disabled">${window.siyuan.languages.openSyncTip1}</button>
</div>`;e?(e.element.querySelector(".b3-dialog__header").innerHTML="\u{1F5C2}\uFE0F "+window.siyuan.languages.cloudSyncDir,e.element.querySelector(".b3-dialog__body").innerHTML=n):e=new we({title:"\u{1F5C2}\uFE0F "+window.siyuan.languages.cloudSyncDir,content:n,width:W()?"92vw":"520px"}),e.element.setAttribute("data-key",u.DIALOG_SYNCCHOOSEDIR);const a=e.element.querySelector(".b3-dialog__content").lastElementChild,i=e.element.querySelector(".b3-button");QE(a,()=>{a.querySelector("input[checked]")?i.removeAttribute("disabled"):i.setAttribute("disabled","disabled")}),Uc(a,!1,()=>{a.querySelector("input[checked]")?i.removeAttribute("disabled"):i.setAttribute("disabled","disabled")}),i.addEventListener("click",()=>{e.destroy(),E("/api/sync/setSyncEnable",{enabled:!0},()=>{window.siyuan.config.sync.enabled=!0,Ya(),xe("\u{1F504} "+window.siyuan.languages.syncConfGuide4,window.siyuan.languages.syncConfGuide5,()=>{Cb()})})})}},tk=(t,e)=>{const n=new we({title:"\u{1F511} "+window.siyuan.languages.syncConfGuide1,content:`<div class="b3-dialog__content ft__center">
    <img style="width: 260px" src="/stage/images/sync-guide.svg"/>
    <div class="fn__hr--b"></div>
    <div class="ft__on-surface">${window.siyuan.languages.syncConfGuide2}</div>
    <div class="fn__hr--b"></div>
    <input class="b3-text-field fn__block ft__center" placeholder="${window.siyuan.languages.passphrase}">
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__block ft__center" placeholder="${window.siyuan.languages.reEnterPassphrase}">
</div>
<div class="b3-dialog__action">
    <label class="fn__flex">
        <input type="checkbox" class="b3-switch fn__flex-center">
        <span class="fn__space"></span>
        ${window.siyuan.languages.confirmPassword}
    </label>
    <span class="fn__flex-1"></span>
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button>
    <span class="fn__space"></span>
    <button class="b3-button b3-button--text" id="initKeyByPW" disabled>
        ${window.siyuan.languages.confirm}
    </button>
</div>`,width:W()?"92vw":"520px"});n.element.setAttribute("data-key",u.DIALOG_SETPASSWORD),n.element.querySelector(".b3-button--cancel").addEventListener("click",()=>{n.destroy()});const a=n.element.querySelector("#initKeyByPW");n.element.querySelector(".b3-switch").addEventListener("change",function(){this.checked?a.removeAttribute("disabled"):a.setAttribute("disabled","disabled")});const i=n.element.querySelectorAll(".b3-text-field");a.addEventListener("click",()=>{if(!i[0].value||!i[1].value){j(window.siyuan.languages._kernel[142]);return}if(i[0].value!==i[1].value){j(window.siyuan.languages.passwordNoMatch);return}xe("\u{1F511} "+window.siyuan.languages.genKeyByPW,window.siyuan.languages.initRepoKeyTip,()=>{t||n.destroy(),E("/api/repo/initRepoKeyFromPassphrase",{pass:i[0].value},s=>{window.siyuan.config.repo.key=s.data.key,e&&e(),t&&ek(s.data.key,n)})})}),i[0].focus()},vt={element:void 0,genHTML:()=>{const t=window.siyuan.config.system.isMicrosoftStore?`<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.currentVer} v${u.SIYUAN_VERSION}
        <span id="isInsider"></span>
        <div class="b3-label__text">${window.siyuan.languages.isMsStoreVerTip}</div>
    </div>
</div>`:`<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.currentVer} v${u.SIYUAN_VERSION}
        <span id="isInsider"></span>
        <div class="b3-label__text">${window.siyuan.languages.downloadLatestVer}</div>
    </div>
    <div class="fn__space"></div>
    <div class="fn__flex-center fn__size200 config__item-line">
        <button id="checkUpdateBtn" class="b3-button b3-button--outline fn__block">
            <svg><use xlink:href="#iconRefresh"></use></svg>${window.siyuan.languages.checkUpdate}
        </button>
    </div>
</div>`;return`<div class="fn__flex b3-label config__item${pt()||window.siyuan.config.system.isMicrosoftStore||window.siyuan.config.system.container!=="std"||window.siyuan.config.system.os==="linux"?" fn__none":""}">
    <div class="fn__flex-1">
        ${window.siyuan.languages.autoLaunch}
        <div class="b3-label__text">${window.siyuan.languages.autoLaunchTip}</div>
    </div>
    <span class="fn__space"></span>
    <select class="b3-select fn__flex-center fn__size200" id="autoLaunch">
      <option value="0" ${window.siyuan.config.system.autoLaunch2===0?"selected":""}>${window.siyuan.languages.autoLaunchMode0}</option>
      <option value="1" ${window.siyuan.config.system.autoLaunch2===1?"selected":""}>${window.siyuan.languages.autoLaunchMode1}</option>
      ${gt()?"":`<option value="2" ${window.siyuan.config.system.autoLaunch2===2?"selected":""}>${window.siyuan.languages.autoLaunchMode2}</option>`}
    </select>    
</div>
<label class="fn__flex b3-label${pt()||window.siyuan.config.system.isMicrosoftStore||window.siyuan.config.system.container!=="std"||window.siyuan.config.system.os==="linux"?" fn__none":""}">
    <div class="fn__flex-1">
        ${window.siyuan.languages.autoDownloadUpdatePkg}
        <div class="b3-label__text">${window.siyuan.languages.autoDownloadUpdatePkgTip}</div>
    </div>
    <div class="fn__space"></div>
    <input class="b3-switch fn__flex-center" id="downloadInstallPkg" type="checkbox"${window.siyuan.config.system.downloadInstallPkg?" checked":""}>
</label>
<label class="b3-label fn__flex">
    <div class="fn__flex-1">
        ${window.siyuan.languages.googleAnalytics}
        <div class="b3-label__text">${window.siyuan.languages.googleAnalyticsTip}</div>
    </div>
    <div class="fn__space"></div>
    <input class="b3-switch fn__flex-center" id="googleAnalytics" type="checkbox"${window.siyuan.config.system.disableGoogleAnalytics?"":" checked"}>
</label>
<label class="b3-label fn__flex">
    <div class="fn__flex-1">
        ${window.siyuan.languages.about11}
        <div class="b3-label__text">${window.siyuan.languages.about12}</div>
    </div>
    <div class="fn__space"></div>
    <input class="b3-switch fn__flex-center" id="networkServe" type="checkbox"${window.siyuan.config.system.networkServe?" checked":""}>
</label>
<div class="b3-label${window.siyuan.config.readonly||pt()&&!ra()&&!fn()&&!Da()&&!pn()?" fn__none":""}">
    <div class="fn__flex">
        <div class="fn__flex-1">
            ${window.siyuan.languages.about5}
            <div class="b3-label__text">${window.siyuan.languages.about6}</div>
        </div>
        <div class="fn__space"></div>
        <button class="fn__flex-center b3-button b3-button--outline fn__size200" id="authCode">
            <svg><use xlink:href="#iconLock"></use></svg>${window.siyuan.languages.config}
        </button>
    </div>
    <label class="b3-label fn__flex${!window.siyuan.config.accessAuthCode||pt()?" fn__none":""}">
        <div class="fn__flex-1">
            ${window.siyuan.languages.about7}
            <div class="b3-label__text">${window.siyuan.languages.about8}</div>
        </div>
        <div class="fn__space"></div>
        <input class="b3-switch fn__flex-center" id="lockScreenMode" type="checkbox"${window.siyuan.config.system.lockScreenMode===1?" checked":""}>
    </label>
</div>
<div class="b3-label config__item${pt()&&!fn()&&!ra()&&!pn()?" fn__none":" fn__flex"}">
    <div class="fn__flex-1">
       ${window.siyuan.languages.about2}
        <div class="b3-label__text">${window.siyuan.languages.about3.replace("${port}",location.port)}</div>
        <div class="b3-label__text"><code class="fn__code">${window.siyuan.config.localIPs.filter(e=>!(e.startsWith("[")&&e.endsWith("]"))).join("</code> <code class='fn__code'>")}</code></div>
        <div class="b3-label__text"><code class="fn__code">${window.siyuan.config.localIPs.filter(e=>e.startsWith("[")&&e.endsWith("]")).join("</code> <code class='fn__code'>")}</code></div>
        <div class="b3-label__text">${window.siyuan.languages.about18}</div>
    </div>
    <div class="fn__space"></div>
    <button data-type="open" data-url="http://${window.siyuan.config.system.networkServe?window.siyuan.config.localIPs[0]:"127.0.0.1"}:${location.port}" class="b3-button b3-button--outline fn__size200 fn__flex-center">
        <svg><use xlink:href="#iconLink"></use></svg>${window.siyuan.languages.about4}
    </button>
</div>
<div class="b3-label fn__flex config__item">
    <div class="fn__flex-1 fn__flex-center">
        ${window.siyuan.languages.dataRepoKey}
        <div class="b3-label__text">${window.siyuan.languages.dataRepoKeyTip1}</div>
        <div class="b3-label__text"><span class="ft__error">${window.siyuan.languages.dataRepoKeyTip2}</span></div>
    </div>
    <div class="fn__space"></div>
    <div class="fn__size200 config__item-line fn__flex-center${window.siyuan.config.repo.key?" fn__none":""}">
        <button class="b3-button b3-button--outline fn__block" id="importKey">
            <svg><use xlink:href="#iconDownload"></use></svg>${window.siyuan.languages.importKey}
        </button>
        <div class="fn__hr"></div>
        <button class="b3-button b3-button--outline fn__block" id="initKey">
            <svg><use xlink:href="#iconLock"></use></svg>${window.siyuan.languages.genKey}
        </button>
        <div class="fn__hr"></div>
        <button class="b3-button b3-button--outline fn__block" id="initKeyByPW">
            <svg><use xlink:href="#iconHand"></use></svg>${window.siyuan.languages.genKeyByPW}
        </button>
    </div>
    <div class="fn__size200 config__item-line fn__flex-center${window.siyuan.config.repo.key?"":" fn__none"}">
        <button class="b3-button b3-button--outline fn__block" id="copyKey">
            <svg><use xlink:href="#iconCopy"></use></svg>${window.siyuan.languages.copyKey}
        </button>
        <div class="fn__hr"></div>
        <button class="b3-button b3-button--outline fn__block" id="resetRepo">
            <svg><use xlink:href="#iconUndo"></use></svg>${window.siyuan.languages.resetRepo}
        </button>
    </div>
</div>
<div class="b3-label">
    <div>
        ${window.siyuan.languages.dataRepoPurge}
    </div>
    <div class="fn__hr"></div>
    <div class="fn__flex config__item">
        <div class="fn__flex-center fn__flex-1 ft__on-surface">${window.siyuan.languages.dataRepoPurgeTip}</div>
        <span class="fn__space"></span>
        <button id="purgeRepo" class="b3-button b3-button--outline fn__size200 fn__flex-center">
            <svg><use xlink:href="#iconTrashcan"></use></svg>${window.siyuan.languages.purge}
        </button>
    </div>
    <div class="fn__hr"></div>
    <div class="fn__flex config__item">
        <div class="fn__flex-center fn__flex-1 ft__on-surface">${window.siyuan.languages.dataRepoAutoPurgeIndexRetentionDays}</div>
        <span class="fn__space"></span>
        <input class="b3-text-field fn__flex-center fn__size200" min="1" type="number" id="indexRetentionDays" value="${window.siyuan.config.repo.indexRetentionDays}">
    </div>
    <div class="fn__hr"></div>
    <div class="fn__flex config__item">
        <div class="fn__flex-center fn__flex-1 ft__on-surface">${window.siyuan.languages.dataRepoAutoPurgeRetentionIndexesDaily}</div>
        <span class="fn__space"></span>
        <input class="b3-text-field fn__flex-center fn__size200" min="1" type="number" id="retentionIndexesDaily" value="${window.siyuan.config.repo.retentionIndexesDaily}">
    </div>
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.systemLog}
        <div class="b3-label__text">${window.siyuan.languages.systemLogTip}</div>
    </div>
    <div class="fn__space"></div>
    <button id="exportLog" class="b3-button b3-button--outline fn__size200 fn__flex-center">
        <svg><use xlink:href="#iconUpload"></use></svg>${window.siyuan.languages.export}
    </button>
</div>
${t}
<div class="fn__flex config__item  b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.about13}
         <div class="b3-label__text" id="tokenTip">${window.siyuan.languages.about14.replace("${token}",window.siyuan.config.api.token)}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" id="token" value="${window.siyuan.config.api.token}">
</div>
<div class="b3-label">
    ${window.siyuan.languages.networkProxy}
    <div class="b3-label__text">
        ${window.siyuan.languages.about17}
    </div>
    <div class="b3-label__text fn__flex config__item" style="padding: 4px 0 4px 4px;">
        <select id="aboutScheme" class="b3-select">
            <option value="" ${window.siyuan.config.system.networkProxy.scheme===""?"selected":""}>${window.siyuan.languages.directConnection}</option>
            <option value="socks5" ${window.siyuan.config.system.networkProxy.scheme==="socks5"?"selected":""}>SOCKS5</option>
            <option value="https" ${window.siyuan.config.system.networkProxy.scheme==="https"?"selected":""}>HTTPS</option>
            <option value="http" ${window.siyuan.config.system.networkProxy.scheme==="http"?"selected":""}>HTTP</option>
        </select>
        <span class="fn__space"></span>
        <input id="aboutHost" placeholder="user:pass@IP" class="b3-text-field fn__block" value="${window.siyuan.config.system.networkProxy.host}"/>
        <span class="fn__space"></span>
        <input id="aboutPort" placeholder="Port" class="b3-text-field fn__block" value="${window.siyuan.config.system.networkProxy.port}" type="number"/>
        <span class="fn__space"></span>
        <button id="aboutConfirm" class="b3-button fn__size200 b3-button--outline">${window.siyuan.languages.confirm}</button>
    </div>
</div>
<div class="b3-label">
    <div class="config-about__logo">
        <img src="/stage/icon.png">
        <span>${window.siyuan.languages.siyuanNote}</span>
        <span class="fn__space"></span>
        <span class="ft__on-surface">${window.siyuan.languages.slogan}</span>
        <span class="fn__space"></span>
        <span style="color:var(--b3-theme-background);font-family: cursive;">\u4F1A\u6CFD\u767E\u5BB6&nbsp;\u81F3\u516C\u5929\u4E0B</span>
    </div>
    <div class='fn__hr'></div>
    ${window.siyuan.languages.about1} ${window.siyuan.config.system.container==="harmony"?" \u2022 "+window.siyuan.languages.feedback+" 845765@qq.com":""} 
</div>`},bindEvent:()=>{window.siyuan.config.system.isInsider&&(vt.element.querySelector("#isInsider").innerHTML="<span class='ft__secondary'>Insider Preview</span>");const t=vt.element.querySelector("#indexRetentionDays");t.addEventListener("change",()=>{E("/api/repo/setRepoIndexRetentionDays",{days:parseInt(t.value)},()=>{window.siyuan.config.repo.indexRetentionDays=parseInt(t.value)})});const e=vt.element.querySelector("#retentionIndexesDaily");e.addEventListener("change",()=>{E("/api/repo/setRetentionIndexesDaily",{indexes:parseInt(e.value)},()=>{window.siyuan.config.repo.retentionIndexesDaily=parseInt(e.value)})});const n=vt.element.querySelector("#token");n.addEventListener("click",()=>{n.select()}),n.addEventListener("change",()=>{E("/api/system/setAPIToken",{token:n.value},()=>{window.siyuan.config.api.token=n.value,vt.element.querySelector("#tokenTip").innerHTML=window.siyuan.languages.about14.replace("${token}",window.siyuan.config.api.token)})}),vt.element.querySelector("#exportLog").addEventListener("click",()=>{E("/api/system/exportLog",{},c=>{Ht(c.data.zip)})});const a=vt.element.querySelector("#checkUpdateBtn");a?.addEventListener("click",()=>{a.firstElementChild.classList.contains("fn__rotate")||(a.innerHTML=`<svg class="fn__rotate"><use xlink:href="#iconRefresh"></use></svg>${window.siyuan.languages.checkUpdate}`,E("/api/system/checkUpdate",{showMsg:!0},()=>{a.innerHTML=`<svg><use xlink:href="#iconRefresh"></use></svg>${window.siyuan.languages.checkUpdate}`}))}),vt.element.querySelectorAll('[data-type="open"]').forEach(c=>{c.addEventListener("click",()=>{const f=c.getAttribute("data-url");f.startsWith("http")?ee.shell.openExternal(f):ee.shell.openPath(f)})}),vt.element.querySelector("#authCode").addEventListener("click",()=>{iL()});const i=vt.element.querySelector("#importKey");i.addEventListener("click",()=>{const c=new we({title:"\u{1F511} "+window.siyuan.languages.key,content:`<div class="b3-dialog__content">
    <textarea spellcheck="false" style="resize: vertical;" class="b3-text-field fn__block" placeholder="${window.siyuan.languages.keyPlaceholder}"></textarea>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:"520px"});c.element.setAttribute("data-key",u.DIALOG_PASSWORD);const f=c.element.querySelector("textarea");f.focus();const g=c.element.querySelectorAll(".b3-button");g[0].addEventListener("click",()=>{c.destroy()}),g[1].addEventListener("click",()=>{E("/api/repo/importRepoKey",{key:f.value},p=>{window.siyuan.config.repo.key=p.data.key,i.parentElement.classList.add("fn__none"),i.parentElement.nextElementSibling.classList.remove("fn__none"),c.destroy()})})}),vt.element.querySelector("#initKey").addEventListener("click",()=>{xe("\u{1F511} "+window.siyuan.languages.genKey,window.siyuan.languages.initRepoKeyTip,()=>{E("/api/repo/initRepoKey",{},c=>{window.siyuan.config.repo.key=c.data.key,i.parentElement.classList.add("fn__none"),i.parentElement.nextElementSibling.classList.remove("fn__none")})})}),vt.element.querySelector("#initKeyByPW").addEventListener("click",()=>{tk(!1,()=>{i.parentElement.classList.add("fn__none"),i.parentElement.nextElementSibling.classList.remove("fn__none")})}),vt.element.querySelector("#copyKey").addEventListener("click",()=>{j(window.siyuan.languages.copied),De(window.siyuan.config.repo.key)}),vt.element.querySelector("#resetRepo").addEventListener("click",()=>{xe("\u26A0\uFE0F "+window.siyuan.languages.resetRepo,window.siyuan.languages.resetRepoTip,()=>{E("/api/repo/resetRepo",{},()=>{window.siyuan.config.repo.key="",window.siyuan.config.sync.enabled=!1,Ya(),i.parentElement.classList.remove("fn__none"),i.parentElement.nextElementSibling.classList.add("fn__none")})})}),vt.element.querySelector("#purgeRepo").addEventListener("click",()=>{xe("\u267B\uFE0F "+window.siyuan.languages.dataRepoPurge,window.siyuan.languages.dataRepoPurgeConfirm,()=>{E("/api/repo/purgeRepo")})});const s=vt.element.querySelector("#networkServe");s.addEventListener("change",()=>{E("/api/system/setNetworkServe",{networkServe:s.checked},()=>{Xt({errorExit:!0,cb:So})})});const o=vt.element.querySelector("#lockScreenMode");o.addEventListener("change",()=>{E("/api/system/setFollowSystemLockScreen",{lockScreenMode:o.checked?1:0},()=>{window.siyuan.config.system.lockScreenMode=o.checked?1:0})});const l=vt.element.querySelector("#googleAnalytics");l.addEventListener("change",()=>{E("/api/system/setGoogleAnalytics",{googleAnalytics:l.checked},()=>{Xt({errorExit:!1,cb(){window.location.reload()}})})});const r=vt.element.querySelector("#downloadInstallPkg");r.addEventListener("change",()=>{E("/api/system/setDownloadInstallPkg",{downloadInstallPkg:r.checked},()=>{window.siyuan.config.system.downloadInstallPkg=r.checked})});const d=vt.element.querySelector("#autoLaunch");d.addEventListener("change",()=>{const c=parseInt(d.value);E("/api/system/setAutoLaunch",{autoLaunch:c},()=>{window.siyuan.config.system.autoLaunch2=c,ee.ipcRenderer.send(u.SIYUAN_AUTO_LAUNCH,{openAtLogin:c!==0,openAsHidden:c===2})})}),vt.element.querySelector("#aboutConfirm").addEventListener("click",()=>{const c=vt.element.querySelector("#aboutScheme").value,f=vt.element.querySelector("#aboutHost").value,g=vt.element.querySelector("#aboutPort").value;E("/api/system/setNetworkProxy",{scheme:c,host:f,port:g},async()=>{window.siyuan.config.system.networkProxy.scheme=c,window.siyuan.config.system.networkProxy.host=f,window.siyuan.config.system.networkProxy.port=g,ee.ipcRenderer.invoke(u.SIYUAN_GET,{cmd:"setProxy",proxyURL:`${window.siyuan.config.system.networkProxy.scheme}://${window.siyuan.config.system.networkProxy.host}:${window.siyuan.config.system.networkProxy.port}`}).then(()=>{Xt({errorExit:!1,cb(){window.location.reload()}})})})})}},_a={element:void 0,genHTML:()=>`<div class="fn__flex-column" style="height: 100%">
    <div class="layout-tab-bar fn__flex">
        <div class="item item--full item--focus" data-type="remove">
            <span class="fn__flex-1"></span>
            <span class="item__text">${window.siyuan.languages.unreferencedAssets}</span>
            <span class="fn__flex-1"></span>
        </div>
        <div class="item item--full" data-type="missing">
            <span class="fn__flex-1"></span>
            <span class="item__text">${window.siyuan.languages.missingAssets}</span>
            <span class="fn__flex-1"></span>
        </div>
    </div>
    <div class="fn__flex-1">
        <div class="config-assets" data-type="remove" data-init="true">
            <div class="fn__hr--b"></div>
            <div class="fn__flex">
                <div class="fn__space"></div>
                <button id="removeAll" class="b3-button b3-button--outline fn__flex-center fn__size200">
                    <svg class="svg"><use xlink:href="#iconTrashcan"></use></svg>
                    ${window.siyuan.languages.delete}
                </button>
            </div>
            <div class="fn__hr"></div>
            <ul class="b3-list b3-list--background config-assets__list">
                <li class="fn__loading"><img src="/stage/loading-pure.svg"></li>
            </ul>
            <div class="config-assets__preview"></div>
        </div>
        <div class="fn__none config-assets" data-type="missing">
            <div class="fn__hr"></div>
            <ul class="b3-list b3-list--background config-assets__list">
                <li class="fn__loading"><img src="/stage/loading-pure.svg"></li>
            </ul>
            <div class="fn__hr"></div>
        </div>
    </div>
</div>`,bindEvent:()=>{const t=_a.element.querySelector(".config-assets__list");_a.element.addEventListener("click",e=>{let n=e.target;for(;n&&!n.isEqualNode(_a.element);){const a=n.getAttribute("data-type");if(n.id==="removeAll")xe(window.siyuan.languages.deleteOpConfirm,`${window.siyuan.languages.clearAll}`,()=>{E("/api/asset/removeUnusedAssets",{},i=>{Ce().asset.forEach(s=>{i.data.paths.includes(s.path)&&s.parent.close()}),t.innerHTML=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`,_a.element.querySelector(".config-assets__preview").innerHTML=""})},void 0,!0);else if(n.classList.contains("item")&&!n.classList.contains("item--focus")){_a.element.querySelector(".layout-tab-bar .item--focus").classList.remove("item--focus"),n.classList.add("item--focus"),_a.element.querySelectorAll(".config-assets").forEach(i=>{a===i.getAttribute("data-type")?(i.classList.remove("fn__none"),i.getAttribute("data-init")||(E("/api/asset/getMissingAssets",{},s=>{_a._renderList(s.data.missingAssets,i.querySelector(".config-assets__list"),!1)}),i.setAttribute("data-init","true"))):i.classList.add("fn__none")}),e.preventDefault(),e.stopPropagation();break}else if(a==="copy")De(n.parentElement.querySelector(".b3-list-item__text").textContent.trim().replace("assets/",""));else if(a==="open")ea(n.parentElement.getAttribute("data-path"),"folder");else if(a==="clear"){const i=n.parentElement.getAttribute("data-path");xe(window.siyuan.languages.deleteOpConfirm,`${window.siyuan.languages.delete} <b>${Ee().basename(i)}</b>`,()=>{E("/api/asset/removeUnusedAsset",{path:i},s=>{Ce().asset.forEach(l=>{s.data.path===l.path&&l.parent.parent.removeTab(l.parent.id)});const o=n.parentElement;o.parentElement.querySelectorAll("li").length===1?o.parentElement.innerHTML=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`:o.remove(),_a.element.querySelector(".config-assets__preview").innerHTML=""})},void 0,!0),e.preventDefault(),e.stopPropagation();break}n=n.parentElement}}),t.addEventListener("mouseover",e=>{const n=L(e.target,"b3-list-item");if(n&&n.getAttribute("data-path")!==t.nextElementSibling.getAttribute("data-path")){const a=n.getAttribute("data-path");t.nextElementSibling.setAttribute("data-path",a),t.nextElementSibling.innerHTML=so(a)}}),E("/api/asset/getUnusedAssets",{},e=>{_a._renderList(e.data.unusedAssets,t)})},_renderList:(t,e,n=!0)=>{let a="",i="";!pt()&&n&&(i=`<span data-type="open" class="ariaLabel b3-list-item__action" aria-label="${window.siyuan.languages.showInFolder}">
    <svg><use xlink:href="#iconFolder"></use></svg>
</span>`);let s="";n&&(s=`<span data-type="clear" class="ariaLabel b3-list-item__action" aria-label="${window.siyuan.languages.delete}">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
</span>`),t.forEach(o=>{const l=o.indexOf("assets/"),r=o.substr(l);a+=`<li data-path="${r}"  class="b3-list-item b3-list-item--hide-action">
    <span class="b3-list-item__text">${pe(o)}</span>
    <span data-type="copy" class="ariaLabel b3-list-item__action" aria-label="${window.siyuan.languages.copy}">
        <svg><use xlink:href="#iconCopy"></use></svg>
    </span>
    ${i}
    ${s}
</li>`}),e.innerHTML=a||`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`}},nk=t=>{const e=new we({positionId:u.DIALOG_SAVEWORKSPACE,title:t?window.siyuan.languages.edit:window.siyuan.languages.save,content:`<div class="b3-dialog__content">
        <input class="b3-text-field fn__block" value="${t||""}" placeholder="${window.siyuan.languages.memo}">
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--remove${t?"":" fn__none"}">${window.siyuan.languages.delete}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text${t?"":" fn__none"}">${window.siyuan.languages.rename}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages[t?"updateLayout":"confirm"]}</button>
</div>`,width:"520px"});e.element.setAttribute("data-key",u.DIALOG_SAVEWORKSPACE);const n=e.element.querySelectorAll(".b3-button"),a=e.element.querySelector("input");a.select(),a.focus(),e.bindInput(a,()=>{n[3].dispatchEvent(new CustomEvent("click"))}),n[0].addEventListener("click",()=>{window.siyuan.storage[u.LOCAL_LAYOUTS].find((i,s)=>{if(i.name===t)return window.siyuan.storage[u.LOCAL_LAYOUTS].splice(s,1),ue(u.LOCAL_LAYOUTS,window.siyuan.storage[u.LOCAL_LAYOUTS]),!0}),e.destroy()}),n[1].addEventListener("click",()=>{e.destroy()}),n[2].addEventListener("click",()=>{const i=a.value;if(!i){j(window.siyuan.languages._kernel[142]);return}e.destroy(),window.siyuan.storage[u.LOCAL_LAYOUTS].find(s=>{if(s.name===t)return s.name=i,s.time=new Date().getTime(),ue(u.LOCAL_LAYOUTS,window.siyuan.storage[u.LOCAL_LAYOUTS]),!0})}),n[3].addEventListener("click",()=>{const i=a.value;if(!i){j(window.siyuan.languages._kernel[142]);return}if(e.destroy(),t){window.siyuan.storage[u.LOCAL_LAYOUTS].find(o=>{if(o.name===t)return o.name=i,o.time=new Date().getTime(),o.layout=Hb(),o.filesPaths=window.siyuan.storage[u.LOCAL_FILESPATHS],ue(u.LOCAL_LAYOUTS,window.siyuan.storage[u.LOCAL_LAYOUTS]),!0});return}window.siyuan.storage[u.LOCAL_LAYOUTS].find(o=>{if(o.name===i)return xe(window.siyuan.languages.save,window.siyuan.languages.exportTplTip,()=>{o.layout=Hb(),o.time=new Date().getTime(),o.filesPaths=window.siyuan.storage[u.LOCAL_FILESPATHS],ue(u.LOCAL_LAYOUTS,window.siyuan.storage[u.LOCAL_LAYOUTS])}),!0})||(window.siyuan.storage[u.LOCAL_LAYOUTS].push({name:i,time:new Date().getTime(),layout:Hb(),filesPaths:window.siyuan.storage[u.LOCAL_FILESPATHS]}),ue(u.LOCAL_LAYOUTS,window.siyuan.storage[u.LOCAL_LAYOUTS]))})},Tb=(t,e,n)=>({id:t,label:`${e.pin?window.siyuan.languages.unpin:window.siyuan.languages.pin}`,icon:n,current:!e.pin,click(){e.togglePin()}}),Ib=(t,e)=>{if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="barWorkspace"){window.siyuan.menus.menu.remove();return}E("/api/system/getWorkspaces",{},n=>{window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name","barWorkspace"),window.siyuan.config.readonly||window.siyuan.menus.menu.append(new T({id:"config",label:window.siyuan.languages.config,icon:"iconSettings",accelerator:window.siyuan.config.keymap.general.config.custom,click:()=>{To(t)}}).element);const a=[];if(_p().forEach(s=>{a.push({id:s.type,icon:s.icon,accelerator:s.hotkey,label:s.title,click(){Qe(s.type).toggleModel(s.type)}})}),window.siyuan.config.readonly||(a.push({id:"separator_1",type:"separator"}),a.push(Tb("leftDock",window.siyuan.layout.leftDock,"iconLeftTop")),a.push(Tb("rightDock",window.siyuan.layout.rightDock,"iconRightTop")),a.push(Tb("bottomDock",window.siyuan.layout.bottomDock,"iconBottomLeft"))),window.siyuan.menus.menu.append(new T({id:"panels",label:window.siyuan.languages.panels,icon:"iconDock",type:"submenu",submenu:a}).element),!window.siyuan.config.readonly){let s;s=[{id:"newOrOpenBy",label:`${window.siyuan.languages.new} / ${window.siyuan.languages.openBy}`,iconHTML:"",click:async()=>{const o=await ee.ipcRenderer.invoke(u.SIYUAN_GET,{cmd:"showOpenDialog",defaultPath:window.siyuan.config.system.homeDir,properties:["openDirectory","createDirectory"]});o.filePaths.length!==0&&E("/api/system/checkWorkspaceDir",{path:o.filePaths[0]},l=>{l.data.isWorkspace?$p(o.filePaths[0]):xe("\u{1F3D7}\uFE0F "+window.siyuan.languages.createWorkspace,window.siyuan.languages.createWorkspaceTip+`<br><br><code class="fn__code">${o.filePaths[0]}</code>`,()=>{$p(o.filePaths[0])})})}}],s.push({id:"separator_1",type:"separator"}),n.data.forEach(o=>{s.push(RT(o))}),(!pt()||ra()||fn()||pn())&&window.siyuan.menus.menu.append(new T({id:"workspaceList",label:window.siyuan.languages.workspaceList,icon:"iconWorkspace",type:"submenu",submenu:s}).element)}const i=[{id:"save",iconHTML:"",label:window.siyuan.languages.save,click(){nk()}}];if(window.siyuan.storage[u.LOCAL_LAYOUTS].length>0&&i.push({id:"separator_1",type:"separator"}),window.siyuan.storage[u.LOCAL_LAYOUTS].forEach(s=>{i.push({iconHTML:"",action:"iconEdit",label:`${s.name} <span class="ft__smaller ft__on-surface">${s.time?Y(s.time).format("YYYY-MM-DD HH:mm"):""}</span>`,bind(o){o.addEventListener("click",l=>{if(L(l.target,"b3-menu__action")){l.preventDefault(),l.stopPropagation(),nk(s.name),window.siyuan.menus.menu.remove();return}window.siyuan.config.readonly?window.location.reload():E("/api/system/setUILayout",{layout:s.layout},()=>{s.filesPaths?(window.siyuan.storage[u.LOCAL_FILESPATHS]=s.filesPaths,ue(u.LOCAL_FILESPATHS,s.filesPaths,()=>{window.location.reload()})):window.location.reload()})})}})}),window.siyuan.menus.menu.append(new T({id:"layout",label:window.siyuan.languages.layout,icon:"iconLayout",type:"submenu",submenu:i}).element),window.siyuan.menus.menu.append(new T({id:"separator_1",type:"separator"}).element),!window.siyuan.config.readonly){if(Lh()<2)window.siyuan.menus.menu.append(new T({id:"dailyNote",label:window.siyuan.languages.dailyNote,icon:"iconCalendar",accelerator:window.siyuan.config.keymap.general.dailyNote.custom,click:()=>{Uh(t)}}).element);else{const s=[];window.siyuan.notebooks.forEach(o=>{o.closed||s.push({label:pe(o.name),iconHTML:ge(o.icon||window.siyuan.storage[u.LOCAL_IMAGES].note,"b3-menu__icon",!0),accelerator:window.siyuan.storage[u.LOCAL_DAILYNOTEID]===o.id?window.siyuan.config.keymap.general.dailyNote.custom:"",click:()=>{Df(t,o.id),window.siyuan.storage[u.LOCAL_DAILYNOTEID]=o.id,ue(u.LOCAL_DAILYNOTEID,window.siyuan.storage[u.LOCAL_DAILYNOTEID])}})}),window.siyuan.menus.menu.append(new T({id:"dailyNote",label:window.siyuan.languages.dailyNote,icon:"iconCalendar",type:"submenu",submenu:s}).element)}window.siyuan.config.readonly||window.siyuan.menus.menu.append(new T({id:"riffCard",label:window.siyuan.languages.riffCard,type:"submenu",icon:"iconRiffCard",submenu:[{id:"spaceRepetition",iconHTML:"",label:window.siyuan.languages.spaceRepetition,accelerator:window.siyuan.config.keymap.general.riffCard.custom,click:()=>{_l(t)}},{id:"manage",iconHTML:"",label:window.siyuan.languages.manage,click:()=>{vl(t,"",window.siyuan.languages.all,"")}}]}).element),window.siyuan.menus.menu.append(new T({id:"recentDocs",label:window.siyuan.languages.recentDocs,icon:"iconFile",accelerator:window.siyuan.config.keymap.general.recentDocs.custom,click:()=>{Tp()}}).element),window.siyuan.menus.menu.append(new T({id:"lockScreen",label:window.siyuan.languages.lockScreen,icon:"iconLock",accelerator:window.siyuan.config.keymap.general.lockScreen.custom,click:()=>{Ep(t)}}).element),window.siyuan.menus.menu.append(new T({id:"dataHistory",label:window.siyuan.languages.dataHistory,icon:"iconHistory",accelerator:window.siyuan.config.keymap.general.dataHistory.custom,click:()=>{Bf(t)}}).element),window.siyuan.menus.menu.append(new T({id:"separator_2",type:"separator"}).element)}window.siyuan.menus.menu.append(new T({id:"userGuide",label:window.siyuan.languages.userGuide,icon:"iconHelp",ignore:Da()||window.siyuan.config.readonly,click:()=>{$f()}}).element),window.siyuan.menus.menu.append(new T({id:"feedback",label:window.siyuan.languages.feedback,icon:"iconFeedback",click:()=>{window.siyuan.config.lang==="zh_CN"||window.siyuan.config.lang==="zh_CHT"?window.open("https://ld246.com/article/1649901726096"):window.open("https://liuyun.io/article/1686530886208")}}).element),window.siyuan.menus.menu.append(new T({id:"debug",label:window.siyuan.languages.debug,icon:"iconBug",click:()=>{ee.ipcRenderer.send(u.SIYUAN_CMD,"openDevTools")}}).element),(Da()||fn()||pn()||!pt())&&(window.siyuan.menus.menu.append(new T({id:"separator_3",type:"separator"}).element),window.siyuan.menus.menu.append(new T({id:"safeQuit",label:window.siyuan.languages.safeQuit,icon:"iconQuit",warning:!0,click:()=>{Xt({errorExit:!0,cb:So})}}).element)),window.siyuan.menus.menu.popup({x:e.left,y:e.bottom})})},$p=t=>{t!==window.siyuan.config.system.workspaceDir&&E("/api/system/setWorkspaceDir",{path:t},()=>{ee.ipcRenderer.send(u.SIYUAN_OPEN_WORKSPACE,{workspace:t,lang:window.siyuan.config.appearance.lang})})},RT=t=>{const e=[{id:"showInFolder",icon:"iconFolder",label:window.siyuan.languages.showInFolder,click(){Ja(t.path)}},{id:"copyPath",icon:"iconCopy",label:window.siyuan.languages.copyPath,click(){De(t.path),j(window.siyuan.languages.copied)}}];return t.path!==window.siyuan.config.system.workspaceDir&&(e.splice(0,0,{id:"openBy",icon:"iconOpenWindow",label:window.siyuan.languages.openBy,click(){$p(t.path)}}),t.closed&&e.push({id:"removeWorkspaceTip",icon:"iconTrashcan",label:window.siyuan.languages.removeWorkspaceTip,click(){E("/api/system/removeWorkspaceDir",{path:t.path})}})),{label:`<div aria-label="${t.path}" class="fn__ellipsis ariaLabel" style="max-width: 256px">
    ${GS().basename(t.path)}
</div>`,current:!t.closed,iconHTML:"",type:"submenu",submenu:e,click(){$p(t.path)}}},OT=t=>{const e=[],n=[],a=[];let i=-1;t.parent.children.forEach((s,o)=>{const l=s.model;(!l||l.editor?.protyle&&!l.editor?.protyle.updated)&&e.push(s),s.id===t.id&&(i=o),i===-1?n.push(s):o>i&&a.push(s)}),window.siyuan.menus.menu.append(new T({id:"close",icon:"iconClose",label:window.siyuan.languages.close,accelerator:window.siyuan.config.keymap.general.closeTab.custom,click:()=>{t.parent.removeTab(t.id)}}).element),t.parent.children.length>1&&(window.siyuan.menus.menu.append(new T({id:"closeOthers",label:window.siyuan.languages.closeOthers,accelerator:window.siyuan.config.keymap.general.closeOthers.custom,click(){Pi(t,"closeOthers")}}).element),window.siyuan.menus.menu.append(new T({id:"closeAll",label:window.siyuan.languages.closeAll,accelerator:window.siyuan.config.keymap.general.closeAll.custom,click(){Pi(t,"closeAll")}}).element),e.length>0&&window.siyuan.menus.menu.append(new T({id:"closeUnmodified",label:window.siyuan.languages.closeUnmodified,accelerator:window.siyuan.config.keymap.general.closeUnmodified.custom,click(){Pi(t,"other",e)}}).element),n.length>0&&window.siyuan.menus.menu.append(new T({id:"closeLeft",label:window.siyuan.languages.closeLeft,accelerator:window.siyuan.config.keymap.general.closeLeft.custom,click:async()=>{Pi(t,"other",n)}}).element),a.length>0&&window.siyuan.menus.menu.append(new T({id:"closeRight",label:window.siyuan.languages.closeRight,accelerator:window.siyuan.config.keymap.general.closeRight.custom,click(){Pi(t,"other",a)}}).element)),window.siyuan.menus.menu.append(new T({id:"separator_1",type:"separator"}).element)},BT=(t,e)=>{const n=[{id:"splitLR",icon:"iconSplitLR",accelerator:window.siyuan.config.keymap.general.splitLR.custom,label:window.siyuan.languages.splitLR,click:()=>{e.parent.split("lr").addTab(Ip(t,e))}}];e.parent.children.length>1&&n.push({id:"splitMoveR",icon:"iconLayoutRight",accelerator:window.siyuan.config.keymap.general.splitMoveR.custom,label:window.siyuan.languages.splitMoveR,click:()=>{const i=e.parent.split("lr");i.headersElement.append(e.headElement),i.headersElement.parentElement.classList.remove("fn__none"),i.moveTab(e),ln()}}),n.push({id:"splitTB",icon:"iconSplitTB",accelerator:window.siyuan.config.keymap.general.splitTB.custom,label:window.siyuan.languages.splitTB,click:()=>{e.parent.split("tb").addTab(Ip(t,e))}}),e.parent.children.length>1&&n.push({id:"splitMoveB",icon:"iconLayoutBottom",accelerator:window.siyuan.config.keymap.general.splitMoveB.custom,label:window.siyuan.languages.splitMoveB,click:()=>{const i=e.parent.split("tb");i.headersElement.append(e.headElement),i.headersElement.parentElement.classList.remove("fn__none"),i.moveTab(e),ln()}});let a=[];return ko(window.siyuan.layout.centerLayout,a),a.length>1&&(n.push({id:"unsplit",label:window.siyuan.languages.unsplit,accelerator:window.siyuan.config.keymap.general.unsplit.custom,click:()=>{let i=e.parent.parent;for(;i.id!==window.siyuan.layout.centerLayout.id&&(a=[],ko(i,a),!(a.length>1));)i=i.parent;Wc(e.parent.parent.children[0],i,!0),ln()}}),n.push({id:"unsplitAll",label:window.siyuan.languages.unsplitAll,accelerator:window.siyuan.config.keymap.general.unsplitAll.custom,click:()=>{Wc(window.siyuan.layout.centerLayout,window.siyuan.layout.centerLayout,!1),ln()}})),n},ak=(t,e)=>{window.siyuan.menus.menu.remove(),OT(e),window.siyuan.menus.menu.append(new T({id:"split",label:window.siyuan.languages.split,submenu:BT(t,e)}).element);const n=e.model;let a;if(n&&n instanceof ht)a=n.editor.protyle.block.rootID;else{const i=e.headElement.getAttribute("data-initdata");if(i){const s=JSON.parse(i);s&&s.instance==="Editor"&&(a=s.rootId||s.blockId)}}return a?window.siyuan.menus.menu.append(new T({id:"copy",label:window.siyuan.languages.copy,icon:"iconCopy",type:"submenu",submenu:ls([a],!1)}).element):n&&n instanceof li&&window.siyuan.menus.menu.append(new T({id:"copy",label:window.siyuan.languages.copy,icon:"iconCopy",click(){De(`[${Jr(n.parent.title)}${Ee().extname(n.path)}](${n.path})`)}}).element),e.headElement.classList.contains("item--pin")?window.siyuan.menus.menu.append(new T({id:"unpin",label:window.siyuan.languages.unpin,icon:"iconUnpin",click:()=>{e.unpin()}}).element):window.siyuan.menus.menu.append(new T({id:"pin",label:window.siyuan.languages.pin,icon:"iconPin",click:()=>{e.pin()}}).element),window.siyuan.menus.menu.append(new T({id:"tabToWindow",label:window.siyuan.languages.tabToWindow,accelerator:window.siyuan.config.keymap.general.tabToWindow.custom,icon:"iconOpenWindow",click:()=>{lf(e)}}).element),window.siyuan.menus.menu},Wc=(t,e,n)=>{let a=t;for(;a instanceof wa;)a=a.children[0];for(let i=0;i<e.children.length;i++){const s=e.children[i];if(s instanceof wa&&!n)Wc(a,s,n);else if(s instanceof Rc&&s.id!==a.id&&s.children.length>0){for(let o=0;o<s.children.length;o++){const l=s.children[o];a.headersElement.append(l.headElement),a.moveTab(l),o--}i--}}},qT=()=>{const t=Qe("file");if(!t)return!1;const e=t.data.file,n=document.querySelector(".layout__wnd--active > .fn__flex > .layout-tab-bar > .item--focus")||document.querySelector("ul.layout-tab-bar > .item--focus");if(n){const a=Bt(n.getAttribute("data-id"));a&&a.model instanceof ht&&(a.model.editor.protyle.wysiwyg.element.blur(),a.model.editor.protyle.title.editElement.blur(),e.selectItem(a.model.editor.protyle.notebookId,a.model.editor.protyle.path))}t.toggleModel("file",!0)},ci=(t,e)=>{switch(t){case"fileTree":return Qe("file").toggleModel("file"),!0;case"outline":return Qe("outline").toggleModel("outline"),!0;case"bookmark":case"tag":case"inbox":return Qe(t).toggleModel(t),!0;case"backlinks":return Qe("backlink").toggleModel("backlink"),!0;case"graphView":return Qe("graph").toggleModel("graph"),!0;case"globalGraph":return Qe("globalGraph").toggleModel("globalGraph"),!0;case"config":return To(e),!0;case"globalSearch":return wn({app:e,hotkey:u.DIALOG_GLOBALSEARCH,key:(getSelection().rangeCount>0?getSelection().getRangeAt(0):document.createRange()).toString()}),!0;case"stickSearch":return ti(e,(getSelection().rangeCount>0?getSelection().getRangeAt(0):document.createRange()).toString(),!0),!0;case"goBack":return ap(e),!0;case"goForward":return ip(e),!0;case"goToTab1":return Wt(0),!0;case"goToTab2":return Wt(1),!0;case"goToTab3":return Wt(2),!0;case"goToTab4":return Wt(3),!0;case"goToTab5":return Wt(4),!0;case"goToTab6":return Wt(5),!0;case"goToTab7":return Wt(6),!0;case"goToTab8":return Wt(7),!0;case"goToTab9":return Wt(-1),!0;case"goToTabNext":return Wt(-3),!0;case"goToTabPrev":return Wt(-2),!0;case"mainMenu":return ve()||Ib(e,document.querySelector("#barWorkspace").getBoundingClientRect()),!0;case"recentDocs":return Tp(),!0;case"toggleDock":return Mm(document.querySelector("#barDock use")),!0;case"toggleWin":return ee.ipcRenderer.send(u.SIYUAN_CMD,"hide"),ee.ipcRenderer.send(u.SIYUAN_CMD,"minimize"),!0}if(t==="goToEditTabNext"||t==="goToEditTabPrev"){let n=document.querySelector(".layout__wnd--active ul.layout-tab-bar > .item--focus");if(n||(n=document.querySelector("ul.layout-tab-bar > .item--focus")),!n)return!0;const a=ba().sort((s,o)=>s.headElement.getAttribute("data-activetime")>o.headElement.getAttribute("data-activetime")?-1:1),i=n.getAttribute("data-id");return a.find((s,o)=>{if(i===s.id){let l;t==="goToEditTabPrev"?o===0?l=a[a.length-1]:l=a[o-1]:o===a.length-1?l=a[0]:l=a[o+1];const r=Bt(l.id);r.parent.switchTab(l.headElement),r.parent.showHeading()}}),!0}if(t==="closeUnmodified"){const n=ya(!1);if(n){const a=[];n.parent.children.forEach(i=>{const s=i.model;(!s||s.editor?.protyle&&!s.editor?.protyle.updated)&&a.push(i)}),a.length>0&&Pi(n,"other",a)}return!0}if(t==="unsplitAll")return Wc(window.siyuan.layout.centerLayout,window.siyuan.layout.centerLayout,!1),!0;if(t==="unsplit"){const n=ya(!1);if(n){let a=[],i=n.parent.parent;for(;i.id!==window.siyuan.layout.centerLayout.id&&(a=[],ko(i,a),!(a.length>1));)i=i.parent;Wc(n.parent.parent.children[0],i,!0),ln()}return!0}if(t==="closeTab"){const n=document.querySelector(".layout__tab--active");if(n&&n.getBoundingClientRect().width>0){let i;return Array.from(n.classList).find(s=>{if(s.startsWith("sy__"))return i=s.replace("sy__",""),!0}),i&&Qe(i)?.toggleModel(i,!1,!0),!0}const a=ya(!1);return a&&a.parent.removeTab(a.id),!0}if(t==="closeOthers"||t==="closeAll"){const n=ya(!1);return n&&Pi(n,t),!0}if(t==="closeLeft"||t==="closeRight"){const n=ya(!1);if(n){const a=[],i=[];let s=-1;n.parent.children.forEach((o,l)=>{o.id===n.id&&(s=l),s===-1?a.push(o):l>s&&i.push(o)}),t==="closeLeft"?a.length>0&&Pi(n,"other",a):i.length>0&&Pi(n,"other",i)}return!0}if(t==="splitLR"){const n=ya(!1);return n&&n.parent.split("lr").addTab(Ip(e,n)),!0}if(t==="splitTB"){const n=ya(!1);return n&&n.parent.split("tb").addTab(Ip(e,n)),!0}if(t==="splitMoveB"||t==="splitMoveR"){const n=ya(!1);if(n&&n.parent.children.length>1){const a=n.parent.split(t==="splitMoveB"?"tb":"lr");a.headersElement.append(n.headElement),a.headersElement.parentElement.classList.remove("fn__none"),a.moveTab(n),ln()}return!0}if(t==="tabToWindow"){const n=ya(!1);return n&&lf(n),!0}switch(t){case"dailyNote":return Uh(e),!0;case"dataHistory":return Bf(e),!0;case"editReadonly":return Ab(!window.siyuan.config.editor.readOnly),!0;case"lockScreen":return Ep(e),!0;case"newFile":return xi({app:e,useSavePath:!0}),!0;case"riffCard":return _l(e),!0;case"selectOpen1":return qT(),!0;case"syncNow":return Dp(e),!0}return!1},ik=t=>{const e=getSelection().rangeCount>0?getSelection().getRangeAt(0):void 0,n=new we({width:W()?"92vw":"80vw",height:W()?"80vh":"70vh",title:window.siyuan.languages.commandPanel,content:`<div class="fn__flex-column">
    <div class="b3-form__icon search__header" style="border-top: 0;border-bottom: 1px solid var(--b3-theme-surface-lighter);">
        <svg class="b3-form__icon-icon"><use xlink:href="#iconSearch"></use></svg>
        <input class="b3-text-field b3-text-field--text" style="padding-left: 32px !important;">
    </div>
    <ul class="b3-list b3-list--background search__list" id="commands"></ul>
    <div class="search__tip">
        <kbd>\u2191/\u2193</kbd> ${window.siyuan.languages.searchTip1}
        <kbd>${window.siyuan.languages.enterKey}/${window.siyuan.languages.click}</kbd> ${window.siyuan.languages.confirm}
        <kbd>Esc</kbd> ${window.siyuan.languages.close}
    </div>
</div>`});n.element.setAttribute("data-key",u.DIALOG_COMMANDPANEL);const a=n.element.querySelector("#commands");let i="";if(Object.keys(window.siyuan.config.keymap.general).forEach(o=>{let l;l=["addToDatabase","fileTree","outline","bookmark","tag","dailyNote","inbox","backlinks","graphView","globalGraph","closeAll","closeLeft","closeOthers","closeRight","closeTab","closeUnmodified","config","dataHistory","editReadonly","enter","enterBack","globalSearch","goBack","goForward","goToEditTabNext","goToEditTabPrev","goToTab1","goToTab2","goToTab3","goToTab4","goToTab5","goToTab6","goToTab7","goToTab8","goToTab9","goToTabNext","goToTabPrev","lockScreen","mainMenu","move","newFile","recentDocs","replace","riffCard","search","selectOpen1","syncNow","splitLR","splitMoveB","splitMoveR","splitTB","tabToWindow","stickSearch","toggleDock","unsplitAll","unsplit"],l.push("toggleWin"),l.includes(o)&&(i+=`<li class="b3-list-item" data-command="${o}">
    <span class="b3-list-item__text">${window.siyuan.languages[o]}</span>
    <span class="b3-list-item__meta${W()?" fn__none":""}">${X(window.siyuan.config.keymap.general[o].custom)}</span>
</li>`)}),Object.keys(window.siyuan.config.keymap.editor.general).forEach(o=>{["switchReadonly","switchAdjust"].includes(o)&&(i+=`<li class="b3-list-item" data-command="${o}">
    <span class="b3-list-item__text">${window.siyuan.languages[o]}</span>
    <span class="b3-list-item__meta${W()?" fn__none":""}">${X(window.siyuan.config.keymap.editor.general[o].custom)}</span>
</li>`)}),a.insertAdjacentHTML("beforeend",i),t.plugins.forEach(o=>{o.commands.forEach(l=>{const r=document.createElement("li");r.classList.add("b3-list-item"),r.innerHTML=`<span class="b3-list-item__text">${o.displayName}: ${l.langText||o.i18n[l.langKey]}</span>
<span class="b3-list-item__meta${W()?" fn__none":""}">${X(l.customHotkey)}</span>`,r.addEventListener("click",d=>{l.callback?l.callback():l.globalCallback&&l.globalCallback(),n.destroy(),d.preventDefault(),d.stopPropagation()}),a.insertAdjacentElement("beforeend",r)})}),a.childElementCount===0){const o=document.createElement("li");o.classList.add("b3-list-item","b3-list-item--focus"),o.innerHTML=`<span class="b3-list-item__text" style="-webkit-line-clamp: inherit;">${window.siyuan.languages._kernel[122]}</span>`,o.addEventListener("click",()=>{n.destroy()}),a.insertAdjacentElement("beforeend",o)}else a.firstElementChild.classList.add("b3-list-item--focus");const s=n.element.querySelector(".b3-text-field");s.focus(),a.addEventListener("click",o=>{const l=L(o.target,"b3-list-item");if(l){const r=l.getAttribute("data-command");r&&(rn({command:r,app:t,previousRange:e}),n.destroy(),o.preventDefault(),o.stopPropagation())}}),s.addEventListener("keydown",o=>{if(o.stopPropagation(),!o.isComposing)if(xn(a,o),o.key==="Enter"){const l=a.querySelector(".b3-list-item--focus");if(l){const r=l.getAttribute("data-command");r?rn({command:r,app:t,previousRange:e}):l.dispatchEvent(new CustomEvent("click"))}n.destroy()}else o.key==="Escape"&&n.destroy()}),s.addEventListener("compositionend",()=>{sk(s,a)}),s.addEventListener("input",o=>{o.isComposing||(o.stopPropagation(),sk(s,a))})},sk=(t,e)=>{const n=t.value.toLowerCase();e.querySelector(".b3-list-item--focus")?.classList.remove("b3-list-item--focus");let a=!1;Array.from(e.children).forEach(i=>{const s=i.querySelector(".b3-list-item__text").textContent.toLowerCase(),o=i.dataset.command;n.indexOf(s)>-1||s.indexOf(n)>-1||n.indexOf(o)>-1||o?.indexOf(n)>-1?(a||i.classList.add("b3-list-item--focus"),a=!0,i.classList.remove("fn__none")):i.classList.add("fn__none")})},rn=async t=>{if(ci(t.command,t.app))return;const e=document.querySelector(".layout__tab--active")?.classList.contains("sy__file");let n=t.protyle;const a=t.previousRange||(getSelection().rangeCount>0?getSelection().getRangeAt(0):document.createRange());let i=t.fileLiElements;if(!e&&!n){a&&window.siyuan.dialogs.find(o=>{if(o.editors&&(Object.keys(o.editors).find(l=>{if(o.editors[l].protyle.element.contains(a.startContainer))return n=o.editors[l].protyle,!0}),n))return!0});const s=ya();if(!n&&s)s.model instanceof ht?n=s.model.editor.protyle:s.model instanceof Mi?s.model.element.querySelector("#searchUnRefPanel").classList.contains("fn__none")?n=s.model.editors.edit.protyle:n=s.model.editors.unRefEdit.protyle:s.model instanceof Wa&&s.model.editors?.length>0&&a&&s.model.editors.find(o=>{if(o.protyle.element.contains(a.startContainer))return n=o.protyle,!0});else if(!n){!n&&a&&window.siyuan.blockPanels.find(l=>{if(l.editors.find(r=>{if(r.protyle.element.contains(a.startContainer))return n=r.protyle,!0}),n)return!0});const o=Ce();n||o.backlink.find(l=>{if(l.element.classList.contains("layout__tab--active"))return a&&l.editors.find(r=>{if(r.protyle.element.contains(a.startContainer))return n=r.protyle,!0}),!n&&l.editors.length>0&&(n=l.editors[0].protyle),!0}),n||o.editor.find(l=>{if(l.parent.headElement.classList.contains("item--focus"))return n=l.editor.protyle,!0})}}if(!(!e&&n&&Fc({command:t.command,previousRange:a,protyle:n}))){if(e&&!i){const s=Qe("file");if(!s)return!1;const o=s.data.file;i=Array.from(o.element.querySelectorAll(".b3-list-item--focus"))}if(!n&&!e||e&&(!i||i.length===0)||W()&&!document.getElementById("empty").classList.contains("fn__none")){t.command==="replace"?wn({app:t.app,hotkey:u.DIALOG_REPLACE,key:a.toString()}):t.command==="search"&&wn({app:t.app,hotkey:u.DIALOG_SEARCH,key:a.toString()});return}switch(t.command){case"replace":if(!e)wn({app:t.app,hotkey:u.DIALOG_REPLACE,key:a.toString(),notebookId:n.notebookId,searchPath:n.path});else{const s=fe(i[0],"UL");if(!s)return!1;const o=s.getAttribute("data-url"),l=i[0].getAttribute("data-path"),r=i[0].getAttribute("data-type")==="navigation-file";wn(r?{app:t.app,hotkey:u.DIALOG_REPLACE,notebookId:o,searchPath:nt(l,!1,!0)}:{app:t.app,hotkey:u.DIALOG_REPLACE,notebookId:o})}break;case"search":if(!e)wn({app:t.app,hotkey:u.DIALOG_SEARCH,key:a.toString(),notebookId:n.notebookId,searchPath:n.path});else{const s=fe(i[0],"UL");if(!s)return!1;const o=s.getAttribute("data-url"),l=i[0].getAttribute("data-path"),r=i[0].getAttribute("data-type")==="navigation-file";wn(r?{app:t.app,hotkey:u.DIALOG_SEARCH,notebookId:o,searchPath:nt(l,!1,!0)}:{app:t.app,hotkey:u.DIALOG_SEARCH,notebookId:o})}break;case"addToDatabase":e?qh(i):Cf(n,a);break;case"move":if(e){const s=Eh(i);vi((o,l)=>{kh(s,l[0],o[0])},s)}else{const s=P(a.startContainer);if(n.title?.editElement.contains(a.startContainer)||!s||window.siyuan.menus.menu.element.getAttribute("data-name")==="titleMenu")vi((o,l)=>{kh([n.path],l[0],o[0])},[n.path],a);else if(s&&a&&n.element.contains(a.startContainer)){let o=Array.from(n.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));o.length===0&&(o=[s]),vi(l=>{rm(l[0],o,n)})}}break}}},FT=(t,e)=>{const n=new st("topBarPlugin");n.addItem({icon:"iconSettings",label:window.siyuan.languages.manage,ignore:tf()||window.siyuan.config.readonly,click(){To(t).element.querySelector('.b3-tab-bar [data-name="bazaar"]').dispatchEvent(new CustomEvent("click"))}}),n.addSeparator(void 0,tf()||window.siyuan.config.readonly);let a=!1;if(t.plugins.forEach(i=>{const s=i.setting||i.__proto__.hasOwnProperty("openSetting");let o=!1;i.topBarIcons.forEach(l=>{const r=window.siyuan.storage[u.LOCAL_PLUGINTOPUNPIN].includes(l.id),d=[{icon:r?"iconPin":"iconUnpin",label:r?window.siyuan.languages.pin:window.siyuan.languages.unpin,click(){r?(window.siyuan.storage[u.LOCAL_PLUGINTOPUNPIN].splice(window.siyuan.storage[u.LOCAL_PLUGINTOPUNPIN].indexOf(l.id),1),l.classList.remove("fn__none")):(window.siyuan.storage[u.LOCAL_PLUGINTOPUNPIN].push(l.id),window.siyuan.storage[u.LOCAL_PLUGINTOPUNPIN]=Array.from(new Set(window.siyuan.storage[u.LOCAL_PLUGINTOPUNPIN])),l.classList.add("fn__none")),ue(u.LOCAL_PLUGINTOPUNPIN,window.siyuan.storage[u.LOCAL_PLUGINTOPUNPIN])}}];s&&d.push({icon:"iconSettings",label:window.siyuan.languages.config,click(){i.openSetting()}});const c=e?l.getAttribute("aria-label"):l.textContent.trim();e||d.push({icon:"iconPlay",label:c,click(){return l.dispatchEvent(new CustomEvent("click")),!0}});const f={icon:"iconInfo",label:c,click:e?()=>{l.dispatchEvent(new CustomEvent("click"))}:void 0,type:"submenu",submenu:d};if(l.querySelector("use"))f.icon=l.querySelector("use").getAttribute("xlink:href").replace("#","");else{const g=l.querySelector("svg").cloneNode(!0);g.classList.add("b3-menu__icon"),f.iconHTML=g.outerHTML}n.addItem(f),a=!0,o=!0}),!o&&s&&(a=!0,n.addItem({icon:"iconSettings",label:i.displayName,click(){i.openSetting()}}))}),a||(e?window.siyuan.menus.menu.element.querySelector(".b3-menu__separator")?.remove():n.addItem({iconHTML:"",type:"readonly",label:window.siyuan.languages.emptyContent})),e){let i=e.getBoundingClientRect();i.width===0&&(i=document.querySelector("#barMore").getBoundingClientRect()),n.open({x:i.right,y:i.bottom,isLeft:!0})}else n.fullscreen()},UT=t=>{const e=document.getElementById("toolbar");e.innerHTML=`
<div id="barWorkspace" class="ariaLabel toolbar__item toolbar__item--active" aria-label="${window.siyuan.languages.mainMenu} ${X(window.siyuan.config.keymap.general.mainMenu.custom)}">
    <span class="toolbar__text">${hw()}</span>
    <svg class="toolbar__svg"><use xlink:href="#iconDown"></use></svg>
</div>
<div id="barSync" class="ariaLabel toolbar__item${window.siyuan.config.readonly?" fn__none":""}">
    <svg><use xlink:href="#iconCloudSucc"></use></svg>
</div>
<button id="barBack" class="ariaLabel toolbar__item toolbar__item--disabled" aria-label="${window.siyuan.languages.goBack} ${X(window.siyuan.config.keymap.general.goBack.custom)}">
    <svg><use xlink:href="#iconBack"></use></svg>
</button>
<button id="barForward" class="ariaLabel toolbar__item toolbar__item--disabled" aria-label="${window.siyuan.languages.goForward} ${X(window.siyuan.config.keymap.general.goForward.custom)}">
    <svg><use xlink:href="#iconForward"></use></svg>
</button>
<div class="fn__flex-1 fn__ellipsis" id="drag"><span class="fn__none">\u5F00\u53D1\u7248\uFF0C\u4F7F\u7528\u524D\u8BF7\u8FDB\u884C\u5907\u4EFD Development version, please backup before use</span></div>
<div id="toolbarVIP" class="fn__flex${window.siyuan.config.readonly?" fn__none":""}"></div>
<div id="barPlugins" class="toolbar__item ariaLabel" aria-label="${window.siyuan.languages.plugin}">
    <svg><use xlink:href="#iconPlugin"></use></svg>
</div>
<div id="barCommand" class="toolbar__item ariaLabel" aria-label="${window.siyuan.languages.commandPanel} ${X(window.siyuan.config.keymap.general.commandPanel.custom)}">
    <svg><use xlink:href="#iconTerminal"></use></svg>
</div>
<div id="barSearch" class="toolbar__item ariaLabel" aria-label="${window.siyuan.languages.globalSearch} ${X(window.siyuan.config.keymap.general.globalSearch.custom)}">
    <svg><use xlink:href="#iconSearch"></use></svg>
</div>
<div id="barZoom" class="toolbar__item ariaLabel${window.siyuan.storage[u.LOCAL_ZOOM]===1||pt()?" fn__none":""}" aria-label="${window.siyuan.languages.zoom}">
    <svg><use xlink:href="#iconZoom${window.siyuan.storage[u.LOCAL_ZOOM]>1?"In":"Out"}"></use></svg>
</div>
<div id="barMode" class="toolbar__item ariaLabel${window.siyuan.config.readonly?" fn__none":""}" aria-label="${window.siyuan.languages.appearanceMode}">
    <svg><use xlink:href="#icon${window.siyuan.config.appearance.modeOS?"Mode":window.siyuan.config.appearance.mode===0?"Light":"Dark"}"></use></svg>
</div>
<div id="barExit" class="ft__error toolbar__item ariaLabel${ra()||fn()||pn()?"":" fn__none"}" aria-label="${window.siyuan.languages.safeQuit}">
    <svg><use xlink:href="#iconQuit"></use></svg>
</div>
<div id="barMore" class="toolbar__item ariaLabel" aria-label="${window.siyuan.languages.more}">
    <svg><use xlink:href="#iconMore"></use></svg>
</div>
<div class="fn__flex" id="windowControls"></div>`,Ya(),e.addEventListener("click",a=>{let i=a.target;for(typeof a.detail=="string"&&(i=e.querySelector("#"+a.detail));!i.classList.contains("toolbar");){const s=typeof a.detail=="string"?a.detail:i.id;if(s==="barBack"){ap(t),a.stopPropagation();break}else if(s==="barMore"){if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="barmore"){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name","barmore"),(i.getAttribute("data-hideids")||"").split(",").forEach(l=>{const r=e.querySelector("#"+l),d=r.querySelector("use"),c={label:l==="toolbarVIP"?window.siyuan.languages.account:r.getAttribute("aria-label"),icon:l==="toolbarVIP"?"iconAccount":d?d.getAttribute("xlink:href").substring(1):void 0,click:()=>{l.startsWith("plugin")?r.dispatchEvent(new CustomEvent("click")):e.dispatchEvent(new CustomEvent("click",{detail:l}))}};if(!d&&r.querySelector("svg")){const f=r.querySelector("svg").cloneNode(!0);f.classList.add("b3-menu__icon"),c.iconHTML=f.outerHTML}window.siyuan.menus.menu.append(new T(c).element)});const o=i.getBoundingClientRect();window.siyuan.menus.menu.popup({x:o.right,y:o.bottom,isLeft:!0}),a.stopPropagation();break}else if(s==="barForward"){ip(t),a.stopPropagation();break}else if(s==="barSync"){Dp(t),a.stopPropagation();break}else if(s==="barWorkspace"){Ib(t,i.getBoundingClientRect()),a.stopPropagation();break}else if(s==="barExit"){a.stopPropagation(),Xt({errorExit:!0,cb:So});break}else if(s==="barMode"){if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="barmode"){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name","barmode"),window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.themeLight,icon:"iconLight",current:window.siyuan.config.appearance.mode===0&&!window.siyuan.config.appearance.modeOS,click:()=>{Pm(0)}}).element),window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.themeDark,current:window.siyuan.config.appearance.mode===1&&!window.siyuan.config.appearance.modeOS,icon:"iconDark",click:()=>{Pm(1)}}).element),window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.themeOS,current:window.siyuan.config.appearance.modeOS,icon:"iconMode",click:()=>{Pm(2)}}).element);let o=i.getBoundingClientRect();o.width===0&&(o=e.querySelector("#barMore").getBoundingClientRect()),window.siyuan.menus.menu.popup({x:o.right,y:o.bottom,isLeft:!0}),a.stopPropagation();break}else if(s==="toolbarVIP"){window.siyuan.config.readonly||To(t).element.querySelector('.b3-tab-bar [data-name="account"]').dispatchEvent(new CustomEvent("click")),a.stopPropagation();break}else if(s==="barSearch"){wn({app:t,hotkey:u.DIALOG_GLOBALSEARCH}),a.stopPropagation();break}else if(s==="barPlugins"){FT(t,i),a.stopPropagation();break}else if(s==="barCommand"){ik(t),a.stopPropagation();break}else if(s==="barZoom"){if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="barZoom"){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name","barZoom"),window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.zoomIn,icon:"iconZoomIn",accelerator:"\u2318=",click:()=>{Yl("zoomIn")}}).element),window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.zoomOut,accelerator:"\u2318-",icon:"iconZoomOut",click:()=>{Yl("zoomOut")}}).element),window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.reset,accelerator:"\u23180",click:()=>{Yl("restore")}}).element);let o=i.getBoundingClientRect();o.width===0&&(o=e.querySelector("#barMore").getBoundingClientRect()),window.siyuan.menus.menu.popup({x:o.right,y:o.bottom,isLeft:!0}),a.stopPropagation();break}i=i.parentElement}});const n=e.querySelector("#barSync");n.addEventListener("mouseenter",a=>{a.stopPropagation(),a.preventDefault(),E("/api/sync/getSyncInfo",{},i=>{let s="";!window.siyuan.config.sync.enabled||window.siyuan.config.sync.provider===0&&Si("")?s=i.data.stat:(s=window.siyuan.languages._kernel[82].replace("%s",Y(i.data.synced).format("YYYY-MM-DD HH:mm"))+"<br>",s+="&emsp;"+i.data.stat,i.data.kernels.length>0&&(s+="<br>",s+=window.siyuan.languages.currentKernel+"<br>",s+="&emsp;"+i.data.kernel+"/"+window.siyuan.config.system.kernelVersion+" ("+window.siyuan.config.system.os+"/"+window.siyuan.config.system.name+")<br>",s+=window.siyuan.languages.otherOnlineKernels+"<br>",i.data.kernels.forEach(o=>{s+=`&emsp;${o.id}/${o.ver} (${o.os}/${o.hostname}) <br>`}))),n.setAttribute("aria-label",s)})}),n.setAttribute("aria-label",window.siyuan.config.sync.stat||window.siyuan.languages.syncNow+" "+X(window.siyuan.config.keymap.general.syncNow.custom))},Yl=t=>{let e=1;if(t==="zoomIn"?u.SIZE_ZOOM.find((n,a)=>{if(n.zoom===window.siyuan.storage[u.LOCAL_ZOOM])return e=u.SIZE_ZOOM[a+1]?.zoom||3,!0}):t==="zoomOut"&&u.SIZE_ZOOM.find((n,a)=>{if(n.zoom===window.siyuan.storage[u.LOCAL_ZOOM])return e=u.SIZE_ZOOM[a-1]?.zoom||.67,!0}),ee.webFrame.setZoomFactor(e),ee.ipcRenderer.send(u.SIYUAN_CMD,{cmd:"setTrafficLightPosition",zoom:e,position:u.SIZE_ZOOM.find(n=>n.zoom===e).position}),window.siyuan.storage[u.LOCAL_ZOOM]=e,ue(u.LOCAL_ZOOM,e),!ve()){const n=document.getElementById("barZoom");e===1?n.classList.add("fn__none"):(e>1?n.querySelector("use").setAttribute("xlink:href","#iconZoomIn"):n.querySelector("use").setAttribute("xlink:href","#iconZoomOut"),n.classList.remove("fn__none"))}},ok=t=>(window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.append(new T({id:"copy",label:window.siyuan.languages.copy,type:"submenu",submenu:ls([t])}).element),window.siyuan.menus.menu),WT=(t,e)=>{if(getSelection().rangeCount===0)return!1;const n=getSelection().getRangeAt(0);if(L(n.startContainer,"protyle",!0))return!1;let a,i,s,o,l;if(window.siyuan.dialogs.find(w=>{if(w.element.contains(n.startContainer)&&w.element.querySelector("#searchList"))return a=w.element.querySelector(".b3-dialog__body"),i=w,l=i.data,s=i.editors.edit,o=i.editors.unRefEdit,!0}),a||Ce().search.find(w=>{if(w.element.contains(n.startContainer))return a=w.element,s=w.editors.edit,l=w.config,o=w.editors.unRefEdit,!0}),!a)return!1;const r=a.querySelector("#searchAssets"),d=a.querySelector("#searchUnRefPanel"),c=r.classList.contains("fn__none")?d.classList.contains("fn__none")?"doc":"unRef":"asset",f=c==="asset"?r.querySelector("#searchAssetList"):c==="doc"?a.querySelector("#searchList"):d.querySelector("#searchUnRefList"),g=a.querySelector("#searchInput");if(c==="doc"&&H(window.siyuan.config.keymap.general.newFile.custom,e))return l.method===0&&Yh(t,g.value),!0;const p=e.target.id;if(e.key==="ArrowDown"&&e.altKey)return c==="asset"?Kw(r):c==="doc"&&(p==="replaceInput"?Gw(a.querySelector("#replaceInput")):jw(a,l,s)),!0;const h=window.siyuan.storage[u.LOCAL_SEARCHASSET];if(!window.siyuan.menus.menu.element.classList.contains("fn__none"))return!1;let m=f.querySelector(".b3-list-item--focus");if(!m)return!1;if(m.getAttribute("data-type")==="search-new")return e.key==="Enter"&&l.method===0?(Yh(t,g.value),!0):!1;if(c!=="asset"){if(H(window.siyuan.config.keymap.editor.general.insertRight.custom,e)){const _=m.getAttribute("data-node-id");return Ke(_,(x,S)=>{de({app:t,id:_,position:"right",action:S,zoomIn:x}),i&&i.destroy({focus:"false"})}),!0}const w=m.getAttribute("data-node-id");if(H("\u2318/",e)){const _=m.getBoundingClientRect();return ok(w).popup({x:_.left+30,y:_.bottom}),!0}if(H(window.siyuan.config.keymap.editor.general.copyBlockRef.custom,e))return E("/api/block/getRefText",{id:w},_=>{De(`((${w} '${_.data}'))`)}),!0;if(H(window.siyuan.config.keymap.editor.general.copyBlockEmbed.custom,e))return De(`{{select * from blocks where id='${w}'}}`),!0;if(H(window.siyuan.config.keymap.editor.general.copyProtocol.custom,e))return De(`siyuan://blocks/${w}`),!0;if(H(window.siyuan.config.keymap.editor.general.copyProtocolInMd.custom,e))return E("/api/block/getRefText",{id:w},_=>{De(`[${_.data}](siyuan://blocks/${w})`)}),!0;if(H(window.siyuan.config.keymap.editor.general.copyHPath.custom,e))return E("/api/filetree/getHPathByID",{id:w},_=>{De(_.data)}),!0;if(H(window.siyuan.config.keymap.editor.general.copyID.custom,e))return De(w),!0}if(u.KEYCODELIST[e.keyCode]==="PageUp"){if(c==="asset"){if(!r.querySelector('[data-type="assetPrevious"]').getAttribute("disabled")){let w=parseInt(r.querySelector("#searchAssetResult .fn__flex-center").textContent.split("/")[0]);w>1&&(w--,Fn(r,h,w))}}else if(c==="doc")a.querySelector('[data-type="previous"]').getAttribute("disabled")||l.page>1&&(l.page--,cn(a,l,s));else if(c==="unRef"&&!a.querySelector('[data-type="unRefPrevious"]').getAttribute("disabled")){let w=parseInt(d.querySelector("#searchUnRefResult").textContent);w>1&&(w--,El(d,o,w))}return!0}if(u.KEYCODELIST[e.keyCode]==="PageDown"){if(c==="asset"){if(!r.querySelector('[data-type="assetNext"]').getAttribute("disabled")){const w=r.querySelector("#searchAssetResult .fn__flex-center").textContent.split("/");let _=parseInt(w[0]);_<parseInt(w[1])&&(_++,Fn(r,h,_))}}else if(c==="doc"){const w=a.querySelector('[data-type="next"]');w.getAttribute("disabled")||l.page<parseInt(w.parentElement.querySelector("#searchResult").getAttribute("data-pagecount"))&&(l.page++,cn(a,l,s))}else if(c==="unRef"&&!a.querySelector('[data-type="unRefNext"]').getAttribute("disabled")){let w=parseInt(d.querySelector("#searchUnRefResult").textContent);w<parseInt(d.querySelector("#searchUnRefResult").textContent.split("/")[1])&&(w++,El(d,o,w))}return!0}if(!window.siyuan.menus.menu.element.classList.contains("fn__none"))return!1;if(e.key==="Enter"){if(c!=="asset")if(p==="replaceInput")Gh(a,l,s,!1);else{const w=m.getAttribute("data-node-id");Ke(w,(_,x)=>{de({app:t,id:w,action:x,zoomIn:_}),i&&i.destroy({focus:"false"})})}else Ja(Ft.join(window.siyuan.config.system.dataDir,m.lastElementChild.getAttribute("aria-label")));return!0}const b=28,y=r.querySelector("#searchAssetPreview");return e.key==="ArrowDown"?(m.classList.remove("b3-list-item--focus"),m.nextElementSibling?m.nextElementSibling.classList.add("b3-list-item--focus"):l.group===1&&c==="doc"?m.parentElement.nextElementSibling?m.parentElement.nextElementSibling.nextElementSibling.firstElementChild.classList.add("b3-list-item--focus"):f.children[1].firstElementChild.classList.add("b3-list-item--focus"):f.firstElementChild.classList.add("b3-list-item--focus"),m=f.querySelector(".b3-list-item--focus"),(f.scrollTop<m.offsetTop-f.clientHeight+b||f.scrollTop>m.offsetTop)&&(f.scrollTop=m.offsetTop-f.clientHeight+b),c==="asset"?Nf(y,m.dataset.id,g.value,h.method):Ai(c==="doc"?{id:m.getAttribute("data-node-id"),config:l,value:g.value,edit:s}:{id:m.getAttribute("data-node-id"),edit:o}),!0):e.key==="ArrowUp"?(m.classList.remove("b3-list-item--focus"),m.previousElementSibling?m.previousElementSibling.classList.add("b3-list-item--focus"):l.group===1&&c==="doc"?m.parentElement.previousElementSibling.previousElementSibling?m.parentElement.previousElementSibling.previousElementSibling.lastElementChild.classList.add("b3-list-item--focus"):f.lastElementChild.lastElementChild.classList.add("b3-list-item--focus"):f.lastElementChild.classList.add("b3-list-item--focus"),m=f.querySelector(".b3-list-item--focus"),(f.scrollTop<m.offsetTop-f.clientHeight+b||f.scrollTop>m.offsetTop-b*2)&&(f.scrollTop=m.offsetTop-b*2),c==="asset"?Nf(y,m.dataset.id,g.value,h.method):c==="doc"?Ai({id:m.getAttribute("data-node-id"),config:l,value:g.value,edit:s}):c==="unRef"&&Ai({id:m.getAttribute("data-node-id"),edit:o}),!0):!1},YT=(t,e)=>{let n=e.element.querySelector(".history__side .b3-list-item--focus");const a=Array.from(e.element.querySelectorAll(".history__side .b3-list-item[data-id]"));if(a.length<2)return;n?(n.classList.remove("b3-list-item--focus"),t.key==="Home"?n=a[0]:t.key==="End"?n=a[a.length-1]:a.find((l,r)=>{if(l.isSameNode(n))return t.key==="ArrowUp"?r===0?n=a[a.length-1]:n=a[r-1]:t.key==="ArrowDown"&&(r===a.length-1?n=a[0]:n=a[r+1]),!0})):n=a[0],n.classList.add("b3-list-item--focus"),n.parentElement.classList.contains("fn__none")&&(n.parentElement.classList.remove("fn__none"),n.parentElement.previousElementSibling.querySelector("svg").classList.add("b3-list-item__arrow--open"));const i=n.getBoundingClientRect(),o=e.element.querySelector(".history__side").getBoundingClientRect();i.bottom>o.bottom?n.scrollIntoView(!1):i.top<o.top&&n.scrollIntoView(),e.element.dispatchEvent(new CustomEvent("click",{detail:t.key.toLowerCase()}))};let Se,Co;const zT=t=>{let e,n;document.addEventListener("mouseover",a=>{if(!window.siyuan.config||!window.siyuan.menus)return;const i=B(a.target,"data-type","a",!0)||L(a.target,"ariaLabel")||B(a.target,"data-type","tab-header")||B(a.target,"data-type","inline-memo")||L(a.target,"av__calc--ashow")||L(a.target,"av__cell");if(i){let s="",o=i.getAttribute("aria-label")||"";if(i.classList.contains("av__cell"))if(i.classList.contains("av__cell--header")){const l=i.querySelector(".av__celltext"),r=i.getAttribute("data-desc");(l.scrollWidth>l.clientWidth+2||r)&&(r?o=`${go(i)}<div class='ft__on-surface'>${Rt(r)}</div>`:o=go(i))}else i.firstElementChild?.getAttribute("data-type")==="url"&&i.firstElementChild.textContent.indexOf("...")>-1&&(o=Lute.EscapeHTMLStr(i.firstElementChild.getAttribute("data-href")),s="href"),!o&&i.dataset.wrap!=="true"&&a.target.dataset.type!=="block-more"&&!L(a.target,"block__icon")&&(i.style.overflow="auto",i.scrollWidth>i.clientWidth+2&&(o=Lute.EscapeHTMLStr(go(i))),i.style.overflow="");else if(i.parentElement.parentElement.classList.contains("av__views")&&i.parentElement.classList.contains("layout-tab-bar")){const l=i.querySelector(".item__text"),r=i.getAttribute("data-desc");(l.scrollWidth>l.clientWidth+2||r)&&(r?o=`${l.textContent}<div class='ft__on-surface'>${Rt(r)}</div>`:o=l.textContent)}else if(i.classList.contains("av__celltext--url")){const l=i.getAttribute("data-name")||"";o=o?`<span style="word-break: break-all">${o.substring(0,u.SIZE_TITLE)}</span>${l?'<div class="fn__hr"></div><span>'+l+"</span>":""}`:l,s="href"}else if(i.classList.contains("av__calc--ashow")&&i.clientWidth+2<i.scrollWidth)o=i.lastChild.textContent+" "+i.firstElementChild.textContent;else if(i.getAttribute("data-type")==="setRelationCell"){const l=i.querySelector(".b3-menu__label");l&&l.clientWidth<l.scrollWidth&&(o=l.textContent)}if(o||(o=i.getAttribute("data-inline-memo-content"),o&&(s="memo")),!o){const l=i.getAttribute("data-href")||"";l&&(o=`<span style="word-break: break-all">${l.substring(0,u.SIZE_TITLE)}</span>`,s="href");const r=i.getAttribute("data-title");if(o&&Qs(l)&&!i.classList.contains("b3-tooltips")){let d=o;E("/api/asset/statAsset",{path:l},c=>{c.code===1?r&&(d+='<div class="fn__hr"></div><span>'+r+"</span>"):d+=` ${c.data.hSize}${r?'<div class="fn__hr"></div><span>'+r+"</span>":""}<br>${window.siyuan.languages.modifiedAt} ${c.data.hUpdated}<br>${window.siyuan.languages.createdAt} ${c.data.hCreated}`,Qa(d,i,s)}),o=""}else r&&(o+='<div class="fn__hr"></div><span>'+r+"</span>")}if(Co=L(a.target,"b3-list-item__text"),Co&&Co.parentElement.getAttribute("data-type")==="navigation-root"&&E("/api/notebook/getNotebookInfo",{notebook:Co.parentElement.parentElement.getAttribute("data-url")},l=>{const r=l.data.boxInfo,d=`${r.name} <small class='ft__on-surface'>${r.hSize}</small>${r.docCount!==0?window.siyuan.languages.includeSubFile.replace("x",r.docCount):""}<br>${window.siyuan.languages.modifiedAt} ${r.hMtime}<br>${window.siyuan.languages.createdAt} ${r.hCtime}`,c=L(a.target,"b3-list-item__text");Co&&c&&Co.isSameNode(c)&&Qa(d,Co),c&&c.parentElement.getAttribute("data-type")==="navigation-root"&&c.parentElement.parentElement.getAttribute("data-url")===r.id&&c.setAttribute("aria-label",d)}),o&&!i.classList.contains("b3-tooltips")){try{Qa(decodeURIComponent(o),i,s)}catch{Qa(o,i,s)}a.stopPropagation()}else Zt()}else if(!i){const s=B(a.target,"id","tooltip",!0);(!s||s&&s.clientHeight>=s.scrollHeight&&s.clientWidth>=s.scrollWidth)&&Zt()}if(window.siyuan.config.editor.floatWindowMode===1||window.siyuan.shiftIsPressed){if(clearTimeout(n),n=window.setTimeout(()=>{lk(a)},u.TIMEOUT_INPUT),!rk(a,i)||a.relatedTarget&&!document.contains(a.relatedTarget))return;window.siyuan.ctrlIsPressed?(clearTimeout(n),Yc(t)):window.siyuan.shiftIsPressed&&(clearTimeout(n),Yc(t,!0));return}clearTimeout(e),clearTimeout(n),n=window.setTimeout(()=>{lk(a)&&!Se&&!i&&clearTimeout(e)},u.TIMEOUT_INPUT),e=window.setTimeout(()=>{!rk(a,i)||St()||(clearTimeout(n),Yc(t))},620)})},lk=t=>{const e=St()?document.elementFromPoint(t.clientX,t.clientY):t.target;if(!e||e.id&&e.tagName!=="svg"&&(e.id.startsWith("minder_node")||e.id.startsWith("kity_")||e.id.startsWith("node_"))||e.classList.contains("counter")||e.tagName==="circle")return!1;const n=L(e,"av__panel")||L(e,"av__mask");if(n){if(window.siyuan.blockPanels.find(s=>{if(s.element.style.zIndex<n.style.zIndex)return!0}))return!1}else{const i=L(e,"b3-menu");if(i&&i.getAttribute("data-name")!=="docTreeMore"&&window.siyuan.blockPanels.find(o=>{if(o.element.style.zIndex<i.style.zIndex)return!0}))return!1}Se=B(e,"data-type","block-ref")||B(e,"data-type","virtual-block-ref"),Se&&Se.classList.contains("b3-tooltips")&&(Se=void 0),Se||(Se=L(e,"popover__block"));const a=B(e,"data-type","a",!0);if(!Se&&a&&a.getAttribute("data-href")?.startsWith("siyuan://blocks")&&(Se=a),!Se||Se&&window.siyuan.menus.menu.data?.isSameNode(Se)){let i=e;!i.parentElement&&t.path&&t.path[1]&&(i=t.path[1]);const s=L(i,"block__popover",!0),o={oid:0};window.siyuan.blockPanels.forEach(r=>{if((r.targetElement||typeof r.x=="number")&&r.element.getAttribute("data-pin")==="true"){const d=parseInt(r.element.getAttribute("data-level")),c=r.element.getAttribute("data-oid");o[c]?d>o[c]&&(o[c]=d):o[c]=d}});const l=parseInt(window.siyuan.menus.menu.element.dataset.from);if(s)for(let r=window.siyuan.blockPanels.length-1;r>=0;r--){const d=window.siyuan.blockPanels[r],c=parseInt(d.element.getAttribute("data-level"));(d.targetElement||typeof d.x=="number")&&c>(o[d.element.getAttribute("data-oid")]||0)&&d.element.getAttribute("data-pin")==="false"&&c>parseInt(s.getAttribute("data-level"))&&(l&&l>=c||d.destroy())}else for(let r=window.siyuan.blockPanels.length-1;r>=0;r--){const d=window.siyuan.blockPanels[r],c=parseInt(d.element.getAttribute("data-level"));(d.targetElement||typeof d.x=="number")&&d.element.getAttribute("data-pin")==="false"&&(l&&l>=c||d.targetElement&&d.targetElement.classList.contains("protyle-wysiwyg__embed")&&d.targetElement.contains(i)||d.destroy())}}},rk=(t,e)=>{if(window.siyuan.config.editor.floatWindowMode===2||L(t.target,"history__repo",!0))return!1;if(Se=B(t.target,"data-type","block-ref")||B(t.target,"data-type","virtual-block-ref"),Se&&Se.classList.contains("b3-tooltips")&&(Se=void 0),Se||(Se=L(t.target,"popover__block")),!Se&&e){if(e.getAttribute("data-href")?.startsWith("siyuan://blocks")&&e.getAttribute("prevent-popover")!=="true")Se=e;else if(e.classList.contains("av__cell")){const n=e.querySelector(".av__celltext--url");n&&n.dataset.type==="url"&&n.dataset.href?.startsWith("siyuan://blocks")&&(Se=n)}}if(!Se||window.siyuan.altIsPressed||window.siyuan.config.editor.floatWindowMode===0&&window.siyuan.ctrlIsPressed||Se&&Se.getAttribute("prevent-popover")==="true")return!1;if(Se&&getSelection().rangeCount>0){const n=getSelection().getRangeAt(0);if(n.toString()!==""&&Se.contains(n.startContainer))return!1}return!0},Yc=async(t,e=!1)=>{if(!Se||window.siyuan.menus.menu.data?.isSameNode(Se))return;let n=[],a;const i=Se.getAttribute("data-id");if(i)if(e){const o=await Re("/api/block/getRefIDs",{id:i});n=o.data.refDefs,a=o.data.originalRefBlockIDs}else i.startsWith("[")?JSON.parse(i).forEach(o=>{n.push({refID:o})}):n=[{refID:i}];else if(Se.getAttribute("data-type")?.indexOf("virtual-block-ref")>-1){const o=P(Se);o&&(n=(await Re("/api/block/getBlockDefIDsByRefText",{anchor:Se.textContent,excludeIDs:[o.getAttribute("data-node-id")]})).data.refDefs)}else if(Se.getAttribute("data-type")?.split(" ").includes("a"))n=[{refID:Zr(Se.getAttribute("data-href"))}];else if(Se.dataset.type==="url")n=[{refID:Zr(Se.textContent.trim())}];else if(Se.dataset.popoverUrl)n=(await Re(Se.dataset.popoverUrl,{avID:Se.dataset.avId})).data.refDefs;else{let o,l="/api/block/getRefIDs";if(Se.classList.contains("protyle-attr--refcount"))o=Se.parentElement.parentElement.getAttribute("data-node-id");else if(Se.classList.contains("pdf__rect")){const r=Se.getAttribute("data-relations");r?(r.split(",").forEach(d=>{n.push({refID:d})}),l=""):(o=Se.getAttribute("data-node-id"),l="/api/block/getRefIDsByFileAnnotationID")}else o||(o=Se.parentElement.getAttribute("data-node-id"));if(l){const r=await Re(l,{id:o});n=r.data.refDefs,a=r.data.originalRefBlockIDs}}if(n.length===0)return;let s=!1;window.siyuan.blockPanels.find(o=>{if((o.targetElement||typeof o.x=="number")&&o.element.getAttribute("data-pin")==="true"&&JSON.stringify(n)===JSON.stringify(o.refDefs))return s=!0,!0}),!s&&Se.parentElement&&Se.parentElement.style.opacity!=="0.1"&&window.siyuan.blockPanels.push(new Hc({app:t,targetElement:Se,isBacklink:e||Se.classList.contains("protyle-attr--refcount")||Se.classList.contains("counter"),refDefs:n,originalRefBlockIDs:a}))},zl=(t,e,n)=>{if(e==="general"){if(!window.siyuan.config.keymap[e])return ee.ipcRenderer.send(u.SIYUAN_CMD,{cmd:"writeLog",msg:"window.siyuan.config.keymap.general is not found"}),window.siyuan.config.keymap[e]=t,!1}else{if(!window.siyuan.config.keymap[e])return ee.ipcRenderer.send(u.SIYUAN_CMD,{cmd:"writeLog",msg:"window.siyuan.config.keymap.editor is not found"}),window.siyuan.config.keymap[e]=JSON.parse(JSON.stringify(u.SIYUAN_KEYMAP.editor)),!1;if(!window.siyuan.config.keymap[e][n])return ee.ipcRenderer.send(u.SIYUAN_CMD,{cmd:"writeLog",msg:`window.siyuan.config.keymap.editor.${n} is not found`}),window.siyuan.config.keymap[e][n]=t,!1}let a=!0;return Object.keys(t).forEach(i=>{e==="general"?(!window.siyuan.config.keymap[e][i]||window.siyuan.config.keymap[e][i].default!==t[i].default)&&(ee.ipcRenderer.send(u.SIYUAN_CMD,{cmd:"writeLog",msg:`window.siyuan.config.keymap.${e}.${i} is not found or match: ${window.siyuan.config.keymap[e][i]?.default}`}),a=!1,window.siyuan.config.keymap[e][i]=t[i]):(!window.siyuan.config.keymap[e][n][i]||window.siyuan.config.keymap[e][n][i].default!==t[i].default)&&(ee.ipcRenderer.send(u.SIYUAN_CMD,{cmd:"writeLog",msg:`window.siyuan.config.keymap.${e}.${n}.${i} is not found or match: ${window.siyuan.config.keymap[e][n][i]?.default}`}),a=!1,window.siyuan.config.keymap[e][n][i]=t[i])}),a},Vl=(t,e,n)=>{let a=!0;return e==="editor"?Object.keys(window.siyuan.config.keymap[e][n]).length!==Object.keys(u.SIYUAN_KEYMAP[e][n]).length&&Object.keys(window.siyuan.config.keymap[e][n]).forEach(i=>{u.SIYUAN_KEYMAP[e][n][i]||(a=!1,delete window.siyuan.config.keymap[e][n][i])}):Object.keys(window.siyuan.config.keymap[e]).length!==Object.keys(u.SIYUAN_KEYMAP[e]).length&&Object.keys(window.siyuan.config.keymap[e]).forEach(i=>{u.SIYUAN_KEYMAP[e][i]||(a=!1,delete window.siyuan.config.keymap[e][i])}),a},VT=t=>{const e=zl(u.SIYUAN_KEYMAP.general,"general"),n=zl(u.SIYUAN_KEYMAP.editor.general,"editor","general"),a=zl(u.SIYUAN_KEYMAP.editor.insert,"editor","insert"),i=zl(u.SIYUAN_KEYMAP.editor.heading,"editor","heading"),s=zl(u.SIYUAN_KEYMAP.editor.list,"editor","list"),o=zl(u.SIYUAN_KEYMAP.editor.table,"editor","table"),l=Vl(u.SIYUAN_KEYMAP.general,"general"),r=Vl(u.SIYUAN_KEYMAP.editor.general,"editor","general"),d=Vl(u.SIYUAN_KEYMAP.editor.insert,"editor","insert"),c=Vl(u.SIYUAN_KEYMAP.editor.heading,"editor","heading"),f=Vl(u.SIYUAN_KEYMAP.editor.list,"editor","list"),g=Vl(u.SIYUAN_KEYMAP.editor.table,"editor","table");!window.siyuan.config.readonly&&(!e||!n||!a||!i||!s||!o||!l||!r||!d||!c||!f||!g)&&(ee.ipcRenderer.send(u.SIYUAN_CMD,{cmd:"writeLog",msg:"update keymap"}),E("/api/setting/setKeymap",{data:window.siyuan.config.keymap},()=>{Gl(t)}))},GT=(t,e)=>{if(document.getElementById("progress")||document.getElementById("errorLog")||t.isComposing)return!0;const n=t.target;if(t.isTrusted&&qe(t)&&!t.shiftKey&&!t.altKey&&!["INPUT","TEXTAREA"].includes(n.tagName)&&["0","1","2","3","4","j","k","l",";","s"," ","p","enter","a","s","d","f","q","x"].includes(t.key.toLowerCase())){let a;if(window.siyuan.dialogs.find(i=>{if(i.element.getAttribute("data-key")===u.DIALOG_OPENCARD)return a=i.element,!0}),a||(a=document.querySelector(`.layout__wnd--active div[data-key="${u.DIALOG_OPENCARD}"]:not(.fn__none)`)),a)return t.preventDefault(),a.dispatchEvent(new CustomEvent("click",{detail:t.key.toLowerCase()})),!0}if(qe(t)&&t.key!=="Escape"&&!t.shiftKey&&!t.altKey&&u.KEYCODELIST[t.keyCode]!=="PageUp"&&u.KEYCODELIST[t.keyCode]!=="PageDown"&&t.key!=="Home"&&t.key!=="End"&&!/^F\d{1,2}$/.test(t.key)&&t.key.indexOf("Arrow")===-1&&t.key!=="Enter"&&t.key!=="Backspace"&&t.key!=="Delete")return!0;!t.altKey&&!t.shiftKey&&Dt(t)&&((gt()?t.key==="Meta":t.key==="Control")||Dt(t)?(window.siyuan.ctrlIsPressed=!0,(t.key==="Meta"||t.key==="Control")&&window.siyuan.config.editor.floatWindowMode===1&&!t.repeat&&Yc(e)):window.siyuan.ctrlIsPressed=!1),!t.altKey&&t.shiftKey&&qe(t)&&(t.key==="Shift"?(window.siyuan.shiftIsPressed=!0,t.repeat||Yc(e,!0)):window.siyuan.shiftIsPressed=!1),t.altKey&&!t.shiftKey&&qe(t)&&(t.key==="Alt"?window.siyuan.altIsPressed=!0:window.siyuan.altIsPressed=!1)},ck=(t,e)=>{e.preventDefault();let n=e.target;for(;!n.isSameNode(va.element);){if(n.classList.contains("b3-list-item")){const a=n.getAttribute("data-type");if(a)a==="riffCard"?_l(t):Qe(a).toggleModel(a,!0);else{const i=n.getAttribute("data-id");ba().find(s=>{if(s.id===i)return s.parent.switchTab(s.headElement),s.parent.showHeading(),!0})}va.destroy(),va=void 0;break}n=n.parentElement}},dk=(t,e,n)=>{let a=e.querySelector(".b3-list-item--focus");if(a){if(a.classList.remove("b3-list-item--focus"),n.key==="ArrowUp")a.previousElementSibling?a.previousElementSibling.classList.add("b3-list-item--focus"):a.parentElement.lastElementChild.classList.add("b3-list-item--focus");else if(n.key==="ArrowDown")a.nextElementSibling?a.nextElementSibling.classList.add("b3-list-item--focus"):a.parentElement.firstElementChild.classList.add("b3-list-item--focus");else if(n.key==="ArrowLeft"||n.key==="ArrowRight"){const r=a.parentElement.previousElementSibling||a.parentElement.nextElementSibling;if(r){const d=r.querySelector(`[data-index="${a.getAttribute("data-index")}"]`)||r.lastElementChild;d?d.classList.add("b3-list-item--focus"):a.classList.add("b3-list-item--focus")}else a.classList.add("b3-list-item--focus")}else if(n.key==="Enter"){const r=a.getAttribute("data-type");r?r==="riffCard"?_l(t):Qe(r).toggleModel(r,!0):de({app:t,id:a.getAttribute("data-node-id"),action:[u.CB_GET_FOCUS,u.CB_GET_SCROLL]}),Q(["dialog"]);return}a=e.querySelector(".b3-list-item--focus");const i=a.getAttribute("data-node-id"),s=e.querySelector(".switch-doc__path");i?E("/api/filetree/getFullHPathByID",{id:i},r=>{s.innerHTML=pe(r.data)}):s.innerHTML=a.querySelector(".b3-list-item__text").innerHTML;const o=a.getBoundingClientRect(),l=a.parentElement.getBoundingClientRect();o.top<l.top?a.scrollIntoView(!0):o.bottom>l.bottom&&a.scrollIntoView(!1)}},jT=(t,e)=>{let n,a;getSelection().rangeCount>0&&(a=getSelection().getRangeAt(0));const i=document.querySelector(".layout__tab--active");let s=!1;i&&i.classList.contains("sy__file")&&(s=!0),a&&window.siyuan.dialogs.find(r=>{if(r.editors&&(Object.keys(r.editors).find(d=>{if(r.editors[d].protyle.element.contains(a.startContainer))return n=r.editors[d].protyle,s=!1,!0}),n))return!0});const o=ya();if(!n&&o){if(o.model instanceof ht?n=o.model.editor.protyle:o.model instanceof Mi?o.model.element.querySelector("#searchUnRefPanel").classList.contains("fn__none")?n=o.model.editors.edit.protyle:n=o.model.editors.unRefEdit.protyle:o.model instanceof Wa&&o.model.editors?.length>0&&a&&o.model.editors.find(r=>{if(r.protyle.element.contains(a.startContainer))return n=r.protyle,!0}),!n)return}else if(!n){!n&&a&&window.siyuan.blockPanels.find(d=>{if(d.editors.find(c=>{if(c.protyle.element.contains(a.startContainer))return n=c.protyle,!0}),n)return!0});const r=Ce();if(n||r.backlink.find(d=>{if(d.element.classList.contains("layout__tab--active"))return a&&d.editors.find(c=>{if(c.protyle.element.contains(a.startContainer))return n=c.protyle,!0}),!n&&d.editors.length>0&&(n=d.editors[0].protyle),!0}),n||r.editor.find(d=>{if(d.parent.headElement.classList.contains("item--focus"))return n=d.editor.protyle,!0}),!n)return!1}if(!s&&H(window.siyuan.config.keymap.general.replace.custom,e))return rn({command:"replace",app:t,protyle:n,previousRange:a}),e.preventDefault(),!0;if(!s&&H(window.siyuan.config.keymap.general.search.custom,e))return rn({command:"search",app:t,protyle:n,previousRange:a}),e.preventDefault(),!0;if(!s&&H(window.siyuan.config.keymap.editor.general.quickMakeCard.custom,e)&&!window.siyuan.config.readonly){if(n.title?.editElement.contains(a.startContainer))cc(n,[n.title.element]);else{const r=[];if(n.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").forEach(d=>{r.push(d)}),r.length===0){const d=P(a.startContainer);d&&r.push(d)}cc(n,r)}return e.preventDefault(),!0}if(!s&&H(window.siyuan.config.keymap.general.addToDatabase.custom,e))return rn({command:"addToDatabase",app:t,protyle:n,previousRange:a}),e.preventDefault(),!0;if(!s&&H(window.siyuan.config.keymap.editor.general.spaceRepetition.custom,e)&&!window.siyuan.config.readonly)return E("/api/riff/getTreeRiffDueCards",{rootID:n.block.rootID},r=>{no(t,r.data,"doc",n.block.rootID,n.title?.editElement.textContent||window.siyuan.languages.untitled)}),e.preventDefault(),!0;if(!s&&H(window.siyuan.config.keymap.general.move.custom,e))return rn({command:"move",app:t,protyle:n,previousRange:a}),e.preventDefault(),!0;if(!s&&!e.repeat&&!n.disabled&&H(window.siyuan.config.keymap.editor.general.duplicate.custom,e)){e.preventDefault(),e.stopPropagation();let r=Array.from(n.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(r.length===0){const d=P(a.startContainer);d&&(r=[d])}return im(r,n),!0}const l=e.target;if(l.tagName!=="TABLE"&&["INPUT","TEXTAREA"].includes(l.tagName))return!1;if(!e.altKey&&!e.shiftKey&&Dt(e)&&e.key==="Home"){sm(n),Q(["select"],n),e.stopPropagation(),e.preventDefault();return}if(!e.altKey&&!e.shiftKey&&Dt(e)&&e.key==="End"){w_(n),Q(["select"],n),e.stopPropagation(),e.preventDefault();return}if(H(window.siyuan.config.keymap.editor.general.exitFocus.custom,e))return e.preventDefault(),Vt({protyle:n,id:n.block.rootID,focusId:n.block.id}),!0;if(H(window.siyuan.config.keymap.editor.general.switchReadonly.custom,e))return e.preventDefault(),Fc({protyle:n,command:"switchReadonly",previousRange:a}),!0;if(H(window.siyuan.config.keymap.editor.general.switchAdjust.custom,e))return e.preventDefault(),Fc({protyle:n,command:"switchAdjust",previousRange:a}),!0;if(H(window.siyuan.config.keymap.editor.general.backlinks.custom,e)){if(e.preventDefault(),a){const r=B(a.startContainer,"data-type","block-ref");if(r)return Qf({app:n.app,blockId:r.dataset.id}),!0}return Qf({app:n.app,blockId:n.block.id,rootId:n.block.rootID,useBlockId:n.block.showAll,title:n.title?n.title.editElement.textContent||window.siyuan.languages.untitled:null}),!0}if(H(window.siyuan.config.keymap.editor.general.graphView.custom,e)){if(e.preventDefault(),a){const r=B(a.startContainer,"data-type","block-ref");if(r)return ep({app:n.app,blockId:r.dataset.id}),!0}return ep({app:n.app,blockId:n.block.id,rootId:n.block.rootID,useBlockId:n.block.showAll,title:n.title?n.title.editElement.textContent||window.siyuan.languages.untitled:null}),!0}if(H(window.siyuan.config.keymap.editor.general.outline.custom,e)){e.preventDefault();const r=ct(l);return _v(n),na(l,r.start,r.end),!0}if(H(window.siyuan.config.keymap.editor.general.copyPlainText.custom,e)){const r=P(a.startContainer);if(!r)return!1;if(a.toString()===""){const d=Array.from(n.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));let c="";d.length===0&&d.push(r),d.forEach(f=>{c+=nc(f)+`
`}),Zi(c.trimEnd())}else Zi(a.toString());return e.preventDefault(),!0}if(H(window.siyuan.config.keymap.editor.general.duplicateCompletely.custom,e)){const r=P(a.startContainer);return!r||!r.classList.contains("av")?!1:(V_(n,r),e.preventDefault(),!0)}if(H(window.siyuan.config.keymap.editor.general.refresh.custom,e))return ei(n,!0),e.preventDefault(),!0;if(H(window.siyuan.config.keymap.editor.general.fullscreen.custom,e))return to(n.element),Jt(n),e.preventDefault(),!0;if(H(window.siyuan.config.keymap.editor.general.preview.custom,e))return mo(n,"preview"),e.preventDefault(),!0;if(H(window.siyuan.config.keymap.editor.general.wysiwyg.custom,e)&&!n.options.backlinkData)return mo(n,"wysiwyg"),n.scroll.lastScrollTop=0,E("/api/filetree/getDoc",{id:n.block.parentID,size:window.siyuan.config.editor.dynamicLoadBlocks},r=>{rt({data:r,protyle:n})}),e.preventDefault(),!0;if(a&&!s&&H(window.siyuan.config.keymap.editor.general.copyBlockRef.custom,e)){if(e.preventDefault(),e.stopPropagation(),L(a.startContainer,"protyle-title"))$t([n.block.rootID],"ref");else{const r=P(a.startContainer);if(!r)return!1;const d=r.querySelector(".img--select");if(d)return Ch(d.querySelector("img").getAttribute("src")),!0;const c=Array.from(n.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select")).map(f=>f.getAttribute("data-node-id"));if(c.length>0)return $t(c,"ref"),!0;a.toString()!==""?Eb(a,f=>{De(`((${r.getAttribute("data-node-id")} "${f.trim()}"))`)}):$t([r.getAttribute("data-node-id")],"ref")}return!0}return L(l,"protyle-title__input")?!1:H(window.siyuan.config.keymap.editor.general.undo.custom,e)?(n.undo.undo(n),e.preventDefault(),!0):H(window.siyuan.config.keymap.editor.general.redo.custom,e)?(n.undo.redo(n),e.preventDefault(),!0):!1},KT=(t,e)=>{const n=Qe("file");if(!n)return!1;const a=n.data.file;if(H(window.siyuan.config.keymap.general.selectOpen1.custom,e)){e.preventDefault(),ci("selectOpen1",t);return}if(!a.element.parentElement.classList.contains("layout__tab--active"))return!1;let i=!1;if(t.plugins.find(g=>{if(g.commands.find(p=>{if(p.fileTreeCallback&&H(p.customHotkey,e))return i=!0,p.fileTreeCallback(a),!0}),i)return!0}),i)return!0;const s=Array.from(a.element.querySelectorAll(".b3-list-item--focus"));if(s.length===0){if(e.key.startsWith("Arrow")&&qe(e)){const g=a.element.querySelector(".b3-list-item");g&&g.classList.add("b3-list-item--focus"),e.preventDefault()}return!1}const o=fe(s[0],"UL");if(!o)return!1;const l=o.getAttribute("data-url"),r=s[0].getAttribute("data-path"),d=s[0].getAttribute("data-type")==="navigation-file",c=[];if(s.forEach(g=>{g.getAttribute("data-type")==="navigation-file"&&c.push(g.getAttribute("data-node-id"))}),H(window.siyuan.config.keymap.editor.general.spaceRepetition.custom,e)&&!window.siyuan.config.readonly){if(d){const g=s[0].getAttribute("data-node-id");E("/api/riff/getTreeRiffDueCards",{rootID:g},p=>{no(t,p.data,"doc",g,nt(s[0].getAttribute("data-name"),!1,!0))})}else E("/api/riff/getNotebookRiffDueCards",{notebook:l},g=>{no(t,g.data,"notebook",l,$a(l))});return e.preventDefault(),!0}if(H(window.siyuan.config.keymap.editor.general.quickMakeCard.custom,e))return c.length>0&&U(void 0,[{action:"addFlashcards",deckID:u.QUICK_DECK_ID,blockIDs:c}],[{action:"removeFlashcards",deckID:u.QUICK_DECK_ID,blockIDs:c}]),e.preventDefault(),!0;if(H(window.siyuan.config.keymap.general.addToDatabase.custom,e))return rn({command:"addToDatabase",app:t,fileLiElements:s}),e.preventDefault(),!0;if(H(window.siyuan.config.keymap.editor.general.rename.custom,e))return window.siyuan.menus.menu.remove(),Th({notebookId:l,path:r,name:d?nt(s[0].getAttribute("data-name"),!1,!0):$a(l),type:d?"file":"notebook"}),e.preventDefault(),!0;if(H("\u2318/",e)){const g=s[0].getBoundingClientRect();return d?If(t,l,r,s[0]).popup({x:g.right-15,y:g.top+15}):Tf(t,s[0]).popup({x:g.right-15,y:g.top+15}),!0}if(!e.repeat&&H(window.siyuan.config.keymap.editor.general.duplicate.custom,e))return e.preventDefault(),e.stopPropagation(),c.forEach(g=>{E("/api/filetree/duplicateDoc",{id:g})}),!0;if(!e.repeat&&H(window.siyuan.config.keymap.editor.general.copyBlockRef.custom,e))return e.preventDefault(),e.stopPropagation(),$t(c,"ref"),!0;if(!e.repeat&&H(window.siyuan.config.keymap.editor.general.copyBlockEmbed.custom,e))return e.preventDefault(),e.stopPropagation(),$t(c,"blockEmbed"),!0;if(!e.repeat&&H(window.siyuan.config.keymap.editor.general.copyProtocol.custom,e))return e.preventDefault(),e.stopPropagation(),$t(c,"protocol"),!0;if(!e.repeat&&H(window.siyuan.config.keymap.editor.general.copyProtocolInMd.custom,e))return e.preventDefault(),e.stopPropagation(),$t(c,"protocolMd"),!0;if(!e.repeat&&H(window.siyuan.config.keymap.editor.general.copyHPath.custom,e))return e.preventDefault(),e.stopPropagation(),$t(c,"hPath"),!0;if(!e.repeat&&H(window.siyuan.config.keymap.editor.general.copyID.custom,e))return e.preventDefault(),e.stopPropagation(),$t(c,"id"),!0;if(d&&H(window.siyuan.config.keymap.general.move.custom,e))return window.siyuan.menus.menu.remove(),rn({command:"move",app:t,fileLiElements:s}),e.preventDefault(),!0;if(d&&H(window.siyuan.config.keymap.editor.general.insertRight.custom,e))return window.siyuan.menus.menu.remove(),de({app:t,id:s[0].getAttribute("data-node-id"),action:[u.CB_GET_FOCUS],position:"right"}),e.preventDefault(),!0;if(H(window.siyuan.config.keymap.general.replace.custom,e))return window.siyuan.menus.menu.remove(),rn({command:"replace",app:t,fileLiElements:s}),e.preventDefault(),!0;if(H(window.siyuan.config.keymap.general.search.custom,e))return window.siyuan.menus.menu.remove(),rn({command:"search",app:t,fileLiElements:s}),e.preventDefault(),!0;const f=e.target;if(["INPUT","TEXTAREA"].includes(f.tagName)||B(f,"contenteditable",null)||L(f,"protyle",!0))return!1;if(e.shiftKey){if(e.key==="ArrowUp"){const g=Wf(s);let p;if(g.startElement.getBoundingClientRect().top>=g.endElement.getBoundingClientRect().top?(p=Wy(g.endElement),p&&(p.classList.add("b3-list-item--focus"),p.setAttribute("select-end","true"),g.endElement.removeAttribute("select-end"))):(g.endElement.classList.remove("b3-list-item--focus"),g.endElement.removeAttribute("select-end"),p=Wy(g.endElement),p&&p.setAttribute("select-end","true")),p){const h=p.getBoundingClientRect(),m=a.element.getBoundingClientRect();(h.top<m.top||h.bottom>m.bottom)&&p.scrollIntoView(h.top<m.top)}}else if(e.key==="ArrowDown"){const g=Wf(s);let p;if(g.startElement.getBoundingClientRect().top<=g.endElement.getBoundingClientRect().top?(p=Ks(g.endElement),p&&(p.classList.add("b3-list-item--focus"),p.setAttribute("select-end","true"),g.endElement.removeAttribute("select-end"))):(g.endElement.classList.remove("b3-list-item--focus"),g.endElement.removeAttribute("select-end"),p=Ks(g.endElement),p&&p.setAttribute("select-end","true")),p){const h=p.getBoundingClientRect(),m=a.element.getBoundingClientRect();(h.top<m.top||h.bottom>m.bottom)&&p.scrollIntoView(h.top<m.top)}}return}else if(qe(e)){if(a.element.querySelector('[select-end="true"]')?.removeAttribute("select-end"),a.element.querySelector('[select-start="true"]')?.removeAttribute("select-start"),e.key==="ArrowRight"&&!s[0].querySelector(".b3-list-item__arrow--open")&&!s[0].querySelector(".b3-list-item__toggle").classList.contains("fn__hidden")||e.key==="ArrowLeft"&&s[0].querySelector(".b3-list-item__arrow--open"))return a.getLeaf(s[0],l),s.forEach((g,p)=>{p!==0&&g.classList.remove("b3-list-item--focus")}),e.preventDefault(),!0;if(e.key==="ArrowLeft"){let g=s[0].parentElement.previousElementSibling;if(g){g.tagName!=="LI"&&(g=a.element.querySelector(".b3-list-item")),s.forEach(m=>{m.classList.remove("b3-list-item--focus")}),g.classList.add("b3-list-item--focus");const p=g.getBoundingClientRect(),h=a.element.getBoundingClientRect();(p.top<h.top||p.bottom>h.bottom)&&g.scrollIntoView(p.top<h.top)}return e.preventDefault(),!0}if(e.key==="ArrowDown"||e.key==="ArrowRight"){let g=s[0];for(;g;)if(g.nextElementSibling){g.nextElementSibling.tagName==="UL"?g=g.nextElementSibling.firstElementChild:g=g.nextElementSibling;break}else{if(g.parentElement.classList.contains("fn__flex-1"))break;g=g.parentElement}if(g.classList.contains("b3-list-item")){s.forEach(m=>{m.classList.remove("b3-list-item--focus")}),g.classList.add("b3-list-item--focus");const p=g.getBoundingClientRect(),h=a.element.getBoundingClientRect();(p.top<h.top||p.bottom>h.bottom)&&g.scrollIntoView(p.top<h.top)}return e.preventDefault(),!0}if(e.key==="ArrowUp"){let g=s[0];for(;g;)if(g.previousElementSibling){if(g.previousElementSibling.tagName==="LI")g=g.previousElementSibling;else{const p=g.previousElementSibling.querySelectorAll(".b3-list-item");g=p[p.length-1]}break}else{if(g.parentElement.classList.contains("fn__flex-1"))break;g=g.parentElement}if(g.classList.contains("b3-list-item")){s.forEach(m=>{m.classList.remove("b3-list-item--focus")}),g.classList.add("b3-list-item--focus");const p=g.getBoundingClientRect(),h=a.element.getBoundingClientRect();(p.top<h.top||p.bottom>h.bottom)&&g.scrollIntoView(p.top<h.top)}return e.preventDefault(),!0}}if(e.key==="Delete"||e.key==="Backspace"&&gt())return window.siyuan.menus.menu.remove(),document.querySelector(`.b3-dialog--open[data-key="${u.DIALOG_CONFIRM}"]`)?void 0:(_f(s),!0);if(e.key==="Enter")return window.siyuan.menus.menu.remove(),s.forEach(g=>{if(g.getAttribute("data-type")==="navigation-file")de({app:t,id:g.getAttribute("data-node-id"),action:[u.CB_GET_FOCUS]});else{const p=fe(g,"UL");p&&a.getLeaf(g,p.getAttribute("data-url"))}}),!0},ZT=(t,e)=>{const n=e.target;if(["INPUT","TEXTAREA"].includes(n.tagName)||B(n,"contenteditable",null)||L(n,"protyle",!0))return!1;let a=document.querySelector(".layout__tab--active");if(a||Array.from(document.querySelectorAll(".layout__wnd--active .layout-tab-container > div")).find(c=>{if(!c.classList.contains("fn__none")&&c.className.indexOf("sy__")>-1)return a=c,!0}),!a||a.className.indexOf("sy__")===-1)return!1;let i=!1;if(t.plugins.find(c=>{if(c.commands.find(f=>{if(f.dockCallback&&H(f.customHotkey,e))return i=!0,f.dockCallback(a),!0}),i)return!0}),i)return!0;if(!H(window.siyuan.config.keymap.editor.general.collapse.custom,e)&&!H(window.siyuan.config.keymap.editor.general.expand.custom,e)&&!e.key.startsWith("Arrow")&&e.key!=="Enter")return!1;if(!e.repeat&&H(window.siyuan.config.keymap.editor.general.collapse.custom,e)){const c=a.querySelector('.block__icon[data-type="collapse"]');if(c)return c.dispatchEvent(new CustomEvent("click")),e.preventDefault(),!0}if(!e.repeat&&H(window.siyuan.config.keymap.editor.general.expand.custom,e)){const c=a.querySelector('.block__icon[data-type="expand"]');if(c)return c.dispatchEvent(new CustomEvent("click")),e.preventDefault(),!0}if(a.classList.contains("sy__inbox")||a.classList.contains("sy__globalGraph")||a.classList.contains("sy__graph"))return!1;const s=Bt(a.getAttribute("data-id"),window.siyuan.layout.layout)?.model;if(!s)return!1;let o=a.querySelector(".b3-list-item--focus");if(!o)return o=a.querySelector(".b3-list .b3-list-item"),o&&o.classList.add("b3-list-item--focus"),!1;let l=s.tree;if(o.parentElement.parentElement.classList.contains("backlinkMList")&&(l=s.mTree),!l)return!1;if(e.key==="Enter")return l.click(o),e.preventDefault(),!0;const r=o.querySelector(".b3-list-item__arrow");if(e.key==="ArrowRight"&&!r.classList.contains("b3-list-item__arrow--open")&&!r.parentElement.classList.contains("fn__hidden")||e.key==="ArrowLeft"&&r.classList.contains("b3-list-item__arrow--open")&&!r.parentElement.classList.contains("fn__hidden"))return l.toggleBlocks(o),e.preventDefault(),!0;const d=L(o,"b3-list");if(!d)return!1;if(e.key==="ArrowLeft"){let c=o.parentElement.previousElementSibling;if(c){c.tagName!=="LI"&&(c=d.querySelector(".b3-list-item")),o.classList.remove("b3-list-item--focus"),c.classList.add("b3-list-item--focus");const f=c.getBoundingClientRect(),g=d.parentElement.getBoundingClientRect();(f.top<g.top||f.bottom>g.bottom)&&c.scrollIntoView(f.top<g.top)}return e.preventDefault(),!0}if(e.key==="ArrowDown"||e.key==="ArrowRight"){let c=o;for(;c;)if(c.nextElementSibling){c.nextElementSibling.tagName==="UL"?c.nextElementSibling.classList.contains("fn__none")?c.nextElementSibling.nextElementSibling&&(c=c.nextElementSibling.nextElementSibling):c=c.nextElementSibling.firstElementChild:c.nextElementSibling.classList.contains("protyle")?c.nextElementSibling.nextElementSibling&&(c=c.nextElementSibling.nextElementSibling):c=c.nextElementSibling;break}else{if(c.parentElement.classList.contains("fn__flex-1"))break;c=c.parentElement}if(c.classList.contains("b3-list-item")&&!c.classList.contains("b3-list-item--focus")){o.classList.remove("b3-list-item--focus"),c.classList.add("b3-list-item--focus");const f=c.getBoundingClientRect(),g=d.parentElement.getBoundingClientRect();(f.top<g.top||f.bottom>g.bottom)&&c.scrollIntoView(f.top<g.top)}return e.preventDefault(),!0}if(e.key==="ArrowUp"){let c=o;for(;c;)if(c.previousElementSibling){if(c.previousElementSibling.tagName==="LI")c=c.previousElementSibling;else if(c.previousElementSibling.classList.contains("protyle"))c.previousElementSibling.previousElementSibling&&(c=c.previousElementSibling.previousElementSibling);else if(c.previousElementSibling.tagName==="UL"&&c.previousElementSibling.classList.contains("fn__none"))c.previousElementSibling.previousElementSibling&&(c=c.previousElementSibling.previousElementSibling);else{const f=c.previousElementSibling.querySelectorAll(".b3-list-item");c=f[f.length-1]}break}else{if(c.parentElement.classList.contains("fn__flex-1"))break;c=c.parentElement}if(c.classList.contains("b3-list-item")&&!c.classList.contains("b3-list-item--focus")){o.classList.remove("b3-list-item--focus"),c.classList.add("b3-list-item--focus");const f=c.getBoundingClientRect(),g=d.parentElement.getBoundingClientRect();(f.top<g.top||f.bottom>g.bottom)&&c.scrollIntoView(f.top<g.top)}return e.preventDefault(),!0}return!1};let va;const JT=(t,e)=>{if(GT(e,t))return;if(va&&(Zy(window.siyuan.config.keymap.general.goToEditTabNext.custom,e)||Zy(window.siyuan.config.keymap.general.goToEditTabPrev.custom,e))&&e.key.startsWith("Arrow")){dk(t,va.element,e);return}if(WT(t,e)){e.preventDefault(),e.stopPropagation();return}const n=ve();if(H(window.siyuan.config.keymap.general.goToEditTabNext.custom,e)||H(window.siyuan.config.keymap.general.goToEditTabPrev.custom,e)){if(va&&va.element.parentElement)return;let l="",r=document.querySelector(".layout__wnd--active ul.layout-tab-bar > .item--focus");if(r||(r=document.querySelector("ul.layout-tab-bar > .item--focus")),r){const c=r.getAttribute("data-id");ba().sort((f,g)=>f.headElement.getAttribute("data-activetime")>g.headElement.getAttribute("data-activetime")?-1:1).forEach((f,g)=>{let p=`<svg class="b3-list-item__graphic"><use xlink:href="#${f.icon}"></use></svg>`,h="";const m=f.headElement.getAttribute("data-initdata");if(f.model instanceof ht)h=` data-node-id="${f.model.editor.protyle.block.rootID}"`,p=ge(f.docIcon||window.siyuan.storage[u.LOCAL_IMAGES].file,"b3-list-item__graphic",!0);else if(m){const b=JSON.parse(m);b.instance==="Editor"&&(h=` data-node-id="${b.rootId}"`,p=ge(f.docIcon||window.siyuan.storage[u.LOCAL_IMAGES].file,"b3-list-item__graphic",!0))}l+=`<li data-index="${g}" data-id="${f.id}"${h} class="b3-list-item${c===f.id?" b3-list-item--focus":""}"${c===f.id?' data-original="true"':""}>${p}<span class="b3-list-item__text">${pe(f.title)}</span></li>`})}let d="";n||(d=`<ul class="b3-list b3-list--background" style="overflow: auto;width: 200px;">
<li data-type="riffCard" data-index="0" class="b3-list-item${l?"":" b3-list-item--focus"}">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconRiffCard"></use></svg>
    <span class="b3-list-item__text">${window.siyuan.languages.riffCard}</span>
    <span class="b3-list-item__meta">${X(window.siyuan.config.keymap.general.riffCard.custom)}</span>
</li>`,_p().forEach((c,f)=>{d+=`<li data-type="${c.type}" data-index="${f+1}" class="b3-list-item">
    <svg class="b3-list-item__graphic"><use xlink:href="#${c.icon}"></use></svg>
    <span class="b3-list-item__text">${c.title}</span>
    <span class="b3-list-item__meta">${X(c.hotkey||"")}</span>
</li>`}),d=d+"</ul>"),Q(["dialog"]),va=new we({positionId:u.DIALOG_SWITCHTAB,title:window.siyuan.languages.switchTab,content:`<div class="fn__flex-column switch-doc">
    <input style="opacity: 0;height: 0.1px;box-sizing: border-box;margin: 0;padding: 0;border: 0;">
    <div class="fn__flex" style="overflow:auto;">${d}
        <ul${n?' style="border-left:0"':""} class="b3-list b3-list--background fn__flex-1">${l}</ul>
    </div>
    <div class="switch-doc__path"></div>
</div>`}),va.element.setAttribute("data-key",u.DIALOG_SWITCHTAB),va.element.querySelector("input").focus(),gt()&&va.element.addEventListener("contextmenu",c=>{ck(t,c)}),va.element.addEventListener("click",c=>{ck(t,c)});return}if(qe(e)&&!e.shiftKey&&!e.altKey&&(e.key.startsWith("Arrow")||e.key==="Enter")){const l=window.siyuan.dialogs.find(r=>{if(r.element.getAttribute("data-key")===u.DIALOG_RECENTDOCS)return!0});if(l){e.preventDefault(),dk(t,l.element,e);return}}if(H(window.siyuan.config.keymap.general.recentDocs.custom,e)){Tp(),e.preventDefault();return}if(nL(e)){e.preventDefault();return}if(["Home","End","ArrowUp","ArrowDown"].includes(e.key)){let l;if(window.siyuan.dialogs.forEach(r=>{[u.DIALOG_VIEWCARDS,u.DIALOG_HISTORYCOMPARE].includes(r.element.getAttribute("data-key"))&&(l=r)}),l){l.element.getAttribute("data-key")===u.DIALOG_VIEWCARDS?l.element.dispatchEvent(new CustomEvent("click",{detail:e.key.toLowerCase()})):l.element.getAttribute("data-key")===u.DIALOG_HISTORYCOMPARE&&YT(e,l),e.preventDefault();return}}const a=e.target;if(H("\u2318=",e)&&!L(a,"pdf__outer")){Yl("zoomIn"),e.preventDefault();return}if(H("\u23180",e)){Yl("restore"),e.preventDefault();return}if(H("\u2318-",e)&&!L(a,"pdf__outer")){Yl("zoomOut"),e.preventDefault();return}if(!n&&H(window.siyuan.config.keymap.general.syncNow.custom,e)){e.preventDefault(),Dp(t);return}if(H(window.siyuan.config.keymap.general.commandPanel.custom,e)){e.preventDefault(),ik(t);return}if(H(window.siyuan.config.keymap.general.editReadonly.custom,e)){e.preventDefault(),Ab(!window.siyuan.config.editor.readOnly);return}if(H(window.siyuan.config.keymap.general.lockScreen.custom,e)){Ep(t),e.preventDefault();return}if(H(window.siyuan.config.keymap.general.dataHistory.custom,e)){Bf(t),e.preventDefault();return}if(!n&&H(window.siyuan.config.keymap.general.toggleDock.custom,e)){Mm(document.querySelector("#barDock use")),e.preventDefault();return}if(!n&&!window.siyuan.config.readonly&&H(window.siyuan.config.keymap.general.config.custom,e)){To(t),e.preventDefault();return}if(H("\u2318A",e)&&!["INPUT","TEXTAREA"].includes(a.tagName)){e.preventDefault();return}if(_p().find(l=>{if(H(l.hotkey,e))return Qe(l.type).toggleModel(l.type),e.preventDefault(),!0}))return;if(!n&&H(window.siyuan.config.keymap.general.riffCard.custom,e)){_l(t),document.activeElement&&document.activeElement.blur(),e.preventDefault();return}if(!n&&H(window.siyuan.config.keymap.general.dailyNote.custom,e)){Uh(t),e.stopPropagation(),e.preventDefault();return}if(H(window.siyuan.config.keymap.general.newFile.custom,e)){xi({app:t,useSavePath:!0}),e.preventDefault();return}const s=document.querySelector('.b3-dialog--open[data-key="dialog-confirm"]');if(s){if(e.key==="Enter"){s.dispatchEvent(new CustomEvent("click",{detail:e.key})),e.preventDefault();return}else if(e.key==="Escape"){s.dispatchEvent(new CustomEvent("click",{detail:e.key})),e.preventDefault();return}}if(e.key==="Escape"&&!e.isComposing){VE();const l=document.querySelector(".protyle-img");if(l){l.remove();return}if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&!(window.siyuan.dialogs.length>0&&window.siyuan.menus.menu.element.style.zIndex<window.siyuan.dialogs[0].element.querySelector(".b3-dialog").style.zIndex)){window.siyuan.menus.menu.remove();return}const r=document.querySelector(".av__panel");if(r){const g=document.querySelector(".av__cell--select");g&&ae(P(g)),r.remove();return}if(document.activeElement&&L(document.activeElement,"card__action"))return;if(window.siyuan.dialogs.length>0){window.siyuan.dialogs[window.siyuan.dialogs.length-1].destroy();return}const d={oid:0};window.siyuan.blockPanels.forEach(g=>{if((g.targetElement||typeof g.x=="number")&&g.element.getAttribute("data-pin")==="true"){const p=parseInt(g.element.getAttribute("data-level")),h=g.element.getAttribute("data-oid");d[h]?p>d[h]&&(d[h]=p):d[h]=1}});let c=!1;for(let g=0;g<window.siyuan.blockPanels.length;g++){const p=window.siyuan.blockPanels[g];(p.targetElement||typeof p.x=="number")&&p.element.getAttribute("data-pin")==="false"&&(p.destroy(),c=!0,g--)}if(c)return;if(getSelection().rangeCount>0){const g=getSelection().getRangeAt(0);if(L(g.startContainer,"protyle-content",!0)){Z(g);return}}const f=window.siyuan.backStack[window.siyuan.backStack.length-1];if(f&&f.protyle.toolbar.range)Z(f.protyle.toolbar.range);else{const g=Ce().editor[0];g&&ae(g.editor.protyle.wysiwyg.element.firstElementChild)}e.preventDefault();return}if(!n&&H(window.siyuan.config.keymap.general.mainMenu.custom,e)){Ib(t,document.querySelector("#barWorkspace").getBoundingClientRect()),e.preventDefault();return}if(H(window.siyuan.config.keymap.general.goForward.custom,e)){ip(t),e.preventDefault();return}if(H(window.siyuan.config.keymap.general.goBack.custom,e)){ap(t),e.preventDefault();return}if(H(window.siyuan.config.keymap.general.closeTab.custom,e)&&!e.repeat){rn({command:"closeTab"}),e.preventDefault();return}if(H(window.siyuan.config.keymap.general.goToTab1.custom,e)&&!e.repeat){Wt(0),e.preventDefault();return}if(H(window.siyuan.config.keymap.general.goToTab2.custom,e)&&!e.repeat){Wt(1),e.preventDefault();return}if(H(window.siyuan.config.keymap.general.goToTab3.custom,e)&&!e.repeat){Wt(2),e.preventDefault();return}if(H(window.siyuan.config.keymap.general.goToTab4.custom,e)&&!e.repeat){Wt(3),e.preventDefault();return}if(H(window.siyuan.config.keymap.general.goToTab5.custom,e)&&!e.repeat){Wt(4),e.preventDefault();return}if(H(window.siyuan.config.keymap.general.goToTab6.custom,e)&&!e.repeat){Wt(5),e.preventDefault();return}if(H(window.siyuan.config.keymap.general.goToTab7.custom,e)&&!e.repeat){Wt(6),e.preventDefault();return}if(H(window.siyuan.config.keymap.general.goToTab8.custom,e)&&!e.repeat){Wt(7),e.preventDefault();return}if(H(window.siyuan.config.keymap.general.goToTab9.custom,e)&&!e.repeat){Wt(-1),e.preventDefault();return}if(H(window.siyuan.config.keymap.general.goToTabNext.custom,e)&&!e.repeat){Wt(-3),e.preventDefault();return}if(H(window.siyuan.config.keymap.general.goToTabPrev.custom,e)&&!e.repeat){Wt(-2),e.preventDefault();return}if(H(window.siyuan.config.keymap.general.closeOthers.custom,e)&&!e.repeat){rn({command:"closeOthers"}),e.preventDefault();return}if(H(window.siyuan.config.keymap.general.closeAll.custom,e)&&!e.repeat){rn({command:"closeAll"}),e.preventDefault();return}if(H(window.siyuan.config.keymap.general.closeUnmodified.custom,e)&&!e.repeat){rn({command:"closeUnmodified"}),e.preventDefault();return}if(H(window.siyuan.config.keymap.general.closeLeft.custom,e)&&!e.repeat){rn({command:"closeLeft"}),e.preventDefault();return}if(H(window.siyuan.config.keymap.general.closeRight.custom,e)&&!e.repeat){rn({command:"closeRight"}),e.preventDefault();return}if(H(window.siyuan.config.keymap.general.splitLR.custom,e)&&!e.repeat){e.preventDefault(),ci("splitLR",t);return}if(H(window.siyuan.config.keymap.general.splitMoveR.custom,e)&&!e.repeat){e.preventDefault(),ci("splitMoveR",t);return}if(H(window.siyuan.config.keymap.general.splitTB.custom,e)&&!e.repeat){e.preventDefault(),ci("splitTB",t);return}if(H(window.siyuan.config.keymap.general.tabToWindow.custom,e)&&!e.repeat){e.preventDefault(),ci("tabToWindow",t);return}if(H(window.siyuan.config.keymap.general.splitMoveB.custom,e)&&!e.repeat){e.preventDefault(),ci("splitMoveB",t);return}if(H(window.siyuan.config.keymap.general.stickSearch.custom,e)){ci("stickSearch",t),e.preventDefault();return}if(H(window.siyuan.config.keymap.general.unsplit.custom,e)&&!e.repeat){e.preventDefault(),ci("unsplit",t);return}if(H(window.siyuan.config.keymap.general.unsplitAll.custom,e)&&!e.repeat){e.preventDefault(),ci("unsplitAll",t);return}if(jT(t,e)||!n&&KT(t,e)||!n&&ZT(t,e))return;let o=!1;if(t.plugins.find(l=>{if(l.commands.find(r=>{if(r.callback&&!r.fileTreeCallback&&!r.editorCallback&&!r.dockCallback&&!r.globalCallback&&H(r.customHotkey,e))return o=!0,r.callback(),!0}),o)return!0}),o)return e.stopPropagation(),e.preventDefault(),!0;if(H(window.siyuan.config.keymap.general.replace.custom,e)){rn({command:"replace",app:t}),e.preventDefault();return}if(H(window.siyuan.config.keymap.general.globalSearch.custom,e)){rn({command:"globalSearch",app:t}),e.preventDefault();return}if(!L(a,"pdf__outer")&&H(window.siyuan.config.keymap.general.search.custom,e)){rn({command:"search",app:t}),e.preventDefault();return}if(H("\u2318S",e))return e.preventDefault(),!0},Gl=t=>{const e=[window.siyuan.config.keymap.general.toggleWin.custom];t.plugins.forEach(n=>{n.commands.forEach(a=>{a.globalCallback&&e.push(a.customHotkey)})}),ee.ipcRenderer.send(u.SIYUAN_HOTKEY,{languages:window.siyuan.languages._trayMenu,hotkeys:e})},at={element:void 0,_genItem(t,e){let n="";return Object.keys(t).forEach(a=>{if(window.siyuan.languages[a]){const i=X(t[a].custom);let s=window.siyuan.languages[a];"editor"+u.ZWSP+"general"===e&&a==="duplicate"&&(s=`${window.siyuan.languages.duplicate} / ${window.siyuan.languages.duplicateMirror}`),n+=`<label class="b3-list-item b3-list-item--narrow b3-list-item--hide-action">
    <span class="b3-list-item__text">${s}</span>
    <span data-type="reset" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.reset}">
        <svg><use xlink:href="#iconUndo"></use></svg>
    </span>
    <span data-type="clear" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.remove}">
        <svg><use xlink:href="#iconTrashcan"></use></svg>
    </span>
    <span data-type="update" class="config-keymap__key">${i}</span>
    <input data-key="${e+u.ZWSP+a}" data-value="${t[a].custom}" data-default="${t[a].default}" class="b3-text-field fn__none" value="${i}" spellcheck="false">
</label>`}}),n},genHTML(t){let e="";return t.plugins.forEach(n=>{let a="";n.commands.forEach(i=>{const s=X(i.customHotkey);a+=`<label class="b3-list-item b3-list-item--narrow b3-list-item--hide-action">
    <span class="b3-list-item__text">${i.langText||(n.i18n?n.i18n[i.langKey]:"")||i.langKey}</span>
    <span data-type="reset" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.reset}">
        <svg><use xlink:href="#iconUndo"></use></svg>
    </span>
    <span data-type="clear" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.remove}">
        <svg><use xlink:href="#iconTrashcan"></use></svg>
    </span>
    <span data-type="update" class="config-keymap__key">${s}</span>
    <input data-key="plugin${u.ZWSP}${n.name}${u.ZWSP}${i.langKey}" data-value="${i.customHotkey}" data-default="${i.hotkey}" class="b3-text-field fn__none" value="${s}" spellcheck="false">
</label>`}),n.updateProtyleToolbar([]).forEach(i=>{if(typeof i=="string"||u.INLINE_TYPE.concat("|").includes(i.name)||!i.hotkey)return;const s=window.siyuan.config.keymap.plugin[n.name][i.name],o=X(s.custom);a+=`<label class="b3-list-item b3-list-item--narrow b3-list-item--hide-action">
    <span class="b3-list-item__text">${i.tip||window.siyuan.languages[i.lang]}</span>
    <span data-type="reset" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.reset}">
        <svg><use xlink:href="#iconUndo"></use></svg>
    </span>
    <span data-type="clear" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.remove}">
        <svg><use xlink:href="#iconTrashcan"></use></svg>
    </span>
    <span data-type="update" class="config-keymap__key">${o}</span>
    <input data-key="plugin${u.ZWSP}${n.name}${u.ZWSP}${i.name}" data-value="${s.custom}" data-default="${s.default}" class="b3-text-field fn__none" value="${o}" spellcheck="false">
</label>`}),Object.keys(n.docks).forEach(i=>{const s=n.docks[i].config;if(!s.hotkey)return;const o=window.siyuan.config.keymap.plugin[n.name][i],l=X(o.custom);a+=`<label class="b3-list-item b3-list-item--narrow b3-list-item--hide-action">
    <span class="b3-list-item__text">${s.title}</span>
    <span data-type="reset" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.reset}">
        <svg><use xlink:href="#iconUndo"></use></svg>
    </span>
    <span data-type="clear" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.remove}">
        <svg><use xlink:href="#iconTrashcan"></use></svg>
    </span>
    <span data-type="update" class="config-keymap__key">${l}</span>
    <input data-key="plugin${u.ZWSP}${n.name}${u.ZWSP}${i}" data-value="${o.custom}" data-default="${o.default}" class="b3-text-field fn__none" value="${l}" spellcheck="false">
</label>`}),a&&(e+=`<div class="b3-list-item b3-list-item--narrow toggle">
    <span class="b3-list-item__toggle b3-list-item__toggle--hl">
        <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
    </span>
    <span class="b3-list-item__text ft__on-surface">${n.displayName}</span>
</div>
<div class="fn__none b3-list__panel">
    ${a}
</div>`)}),e&&(e=`<div class="b3-list b3-list--border b3-list--background">
    <div class="b3-list-item b3-list-item--narrow toggle">
        <span class="b3-list-item__toggle b3-list-item__toggle--hl">
            <svg class="b3-list-item__arrow b3-list-item__arrow--open"><use xlink:href="#iconRight"></use></svg>
        </span>
        <span class="b3-list-item__text ft__on-surface">${window.siyuan.languages.plugin}</span>
    </div>
    <div class="b3-list__panel">
        ${e}
    </div>
</div>`),`<div class="fn__flex b3-label config__item">
    <span class="fn__flex-center">${window.siyuan.languages.keymapTip}</span>
    <span class="fn__flex-1"></span>
    <button id="keymapRefreshBtn" class="b3-button b3-button--outline fn__flex-center fn__size200">
        <svg><use xlink:href="#iconRefresh"></use></svg>
        ${window.siyuan.languages.refresh}
    </button>
</div>
<div class="fn__flex b3-label config__item">
    <span class="fn__flex-center">${window.siyuan.languages.keymapTip2}</span>
    <span class="fn__flex-1"></span>
    <span class="fn__space"></span>
    <button id="keymapResetBtn" class="b3-button b3-button--outline fn__flex-center fn__size200">
        <svg><use xlink:href="#iconUndo"></use></svg>
        ${window.siyuan.languages.reset}
    </button>
</div>
<div class="b3-label file-tree config-keymap" id="keymapList">
    <div class="fn__flex config__item">
        <label class="b3-form__icon fn__block">
            <svg class="b3-form__icon-icon"><use xlink:href="#iconSearch"></use></svg>
            <input id="keymapInput" class="b3-form__icon-input b3-text-field fn__block" placeholder="${window.siyuan.languages.search}">
        </label>
        <div class="fn__space"></div>
        <label class="b3-form__icon fn__block searchByKeyLabel">
            <svg class="b3-form__icon-icon"><use xlink:href="#iconKeymap"></use></svg>
            <input id="searchByKey" data-value="" class="b3-form__icon-input b3-text-field fn__block" spellcheck="false" placeholder="${window.siyuan.languages.keymap}">
        </label>
        <div class="fn__space"></div>
        <button id="clearSearchBtn" class="b3-button b3-button--outline fn__flex-center fn__size200">
            <svg style="height: 14px"><use xlink:href="#iconClose"></use></svg>
            ${window.siyuan.languages.clear}
        </button>
    </div>
    <div class="fn__hr"></div>
    <div class="b3-list b3-list--border b3-list--background">
        <div class="b3-list-item b3-list-item--narrow toggle">
            <span class="b3-list-item__toggle b3-list-item__toggle--hl"><svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg></span>
            <span class="b3-list-item__text ft__on-surface">${window.siyuan.languages.general}</span>
        </div>
        <div class="fn__none b3-list__panel">${at._genItem(window.siyuan.config.keymap.general,"general")}</div>
    </div>
    <div class="b3-list b3-list--border b3-list--background">
        <div class="b3-list-item b3-list-item--narrow toggle">
            <span class="b3-list-item__toggle b3-list-item__toggle--hl">
                <svg class="b3-list-item__arrow b3-list-item__arrow--open"><use xlink:href="#iconRight"></use></svg>
            </span>
            <span class="b3-list-item__text ft__on-surface">${window.siyuan.languages.editor}</span>
        </div>
        <div class="b3-list__panel">
            <div class="b3-list-item b3-list-item--narrow toggle">
                <span class="b3-list-item__toggle b3-list-item__toggle--hl">
                    <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
                </span>
                <span class="b3-list-item__text ft__on-surface">${window.siyuan.languages.general}</span>
            </div>
            <div class="fn__none b3-list__panel">${at._genItem(window.siyuan.config.keymap.editor.general,"editor"+u.ZWSP+"general")}</div>
            <div class="b3-list-item b3-list-item--narrow toggle">
                <span class="b3-list-item__toggle b3-list-item__toggle--hl">
                    <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
                </span>
                <span class="b3-list-item__text ft__on-surface">${window.siyuan.languages.element}</span>
            </div>
            <div class="fn__none b3-list__panel">${at._genItem(window.siyuan.config.keymap.editor.insert,"editor"+u.ZWSP+"insert")}</div>
            <div class="b3-list-item b3-list-item--narrow toggle">
                <span class="b3-list-item__toggle b3-list-item__toggle--hl">
                    <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
                </span>
                <span class="b3-list-item__text ft__on-surface">${window.siyuan.languages.headings}</span>
            </div>
            <div class="fn__none b3-list__panel">${at._genItem(window.siyuan.config.keymap.editor.heading,"editor"+u.ZWSP+"heading")}</div>
            <div class="b3-list-item b3-list-item--narrow toggle">
                <span class="b3-list-item__toggle b3-list-item__toggle--hl">
                    <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
                </span>
                <span class="b3-list-item__text ft__on-surface">${window.siyuan.languages.list1}</span>
            </div>
            <div class="fn__none b3-list__panel">${at._genItem(window.siyuan.config.keymap.editor.list,"editor"+u.ZWSP+"list")}</div>
            <div class="b3-list-item b3-list-item--narrow toggle">
                <span class="b3-list-item__toggle b3-list-item__toggle--hl">
                    <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
                </span>
                <span class="b3-list-item__text ft__on-surface">${window.siyuan.languages.table}</span>
            </div>
            <div class="fn__none b3-list__panel">${at._genItem(window.siyuan.config.keymap.editor.table,"editor"+u.ZWSP+"table")}</div>
        </div>
    </div>
    ${e}
</div>`},_setkeymap(t){const e=JSON.parse(JSON.stringify(u.SIYUAN_KEYMAP)),n=window.siyuan.config.keymap.general.toggleWin.custom;at.element.querySelectorAll("label.b3-list-item input").forEach(a=>{const i=a.getAttribute("data-key").split(u.ZWSP),s=a.getAttribute("data-value");i[0]==="plugin"?(window.siyuan.config.keymap.plugin[i[1]][i[2]].custom=s,e.plugin=window.siyuan.config.keymap.plugin,t.plugins.forEach(o=>{o.name===i[1]&&o.commands.forEach(l=>{l.langKey===i[2]&&(l.customHotkey=s)})})):i[0]==="general"?e[i[0]][i[1]].custom=s:i[0]==="editor"&&(i[1]==="general"||i[1]==="insert"||i[1]==="heading"||i[1]==="list"||i[1]==="table")&&(e[i[0]][i[1]][i[2]].custom=s)}),window.siyuan.config.keymap=e,E("/api/setting/setKeymap",{data:e},()=>{ee.ipcRenderer.send(u.SIYUAN_CMD,{cmd:"writeLog",msg:"user update keymap:"+JSON.stringify(window.siyuan.config.keymap)}),n!==window.siyuan.config.keymap.general.toggleWin.custom&&ee.ipcRenderer.send(u.SIYUAN_CMD,{cmd:"unregisterGlobalShortcut",accelerator:n}),Gl(t)})},search(t,e){const n=at.element.querySelector("#keymapList");n.querySelectorAll(".b3-list-item--hide-action > .b3-list-item__text").forEach(a=>{const i=a.parentElement;let s=!1;if((e===""||i.querySelector(".b3-text-field").getAttribute("data-value").indexOf(e)>-1)&&(s=!0),(a.textContent.toLowerCase().indexOf(t.toLowerCase())>-1||t.toLowerCase().indexOf(a.textContent.toLowerCase())>-1||t==="")&&s?(i.classList.remove("fn__none"),i.parentElement.classList.remove("fn__none"),i.parentElement.parentElement.classList.remove("fn__none")):i.classList.add("fn__none"),!i.nextElementSibling){const o=i.parentElement.previousElementSibling;t===""&&e===""&&(o.querySelector(".b3-list-item__arrow").classList.contains("b3-list-item__arrow--open")?i.parentElement.classList.remove("fn__none"):i.parentElement.classList.add("fn__none")),i.parentElement.childElementCount===i.parentElement.querySelectorAll(".b3-list-item.fn__none").length?o.classList.add("fn__none"):o.classList.remove("fn__none")}}),this._toggleSearchItem(n.lastElementChild,t,e),n.childElementCount===5&&this._toggleSearchItem(n.lastElementChild.previousElementSibling,t,e)},_toggleSearchItem(t,e,n){e===""&&n===""&&(t.querySelector(".b3-list-item__arrow").classList.contains("b3-list-item__arrow--open")?t.lastElementChild.classList.remove("fn__none"):t.lastElementChild.classList.add("fn__none")),t.querySelectorAll(".b3-list-item--hide-action.fn__none").length===t.querySelectorAll(".b3-list-item--hide-action").length?t.firstElementChild.classList.add("fn__none"):t.firstElementChild.classList.remove("fn__none")},_getTip(t){const e=t.parentElement;let n=e.querySelector(".b3-list-item__text").textContent.trim();const a=e.parentElement.previousElementSibling;n=a.textContent.trim()+"-"+n;const i=a.parentElement.previousElementSibling;return i.classList.contains("b3-list-item")&&(n=i.textContent.trim()+"-"+n),n},bindEvent(t){at.element.querySelector("#keymapRefreshBtn").addEventListener("click",()=>{Xt({cb(){window.location.reload()},errorExit:!1})});const e=at.element.querySelector("#keymapInput"),n=at.element.querySelector("#searchByKey");e.addEventListener("compositionend",()=>{at.search(e.value,n.dataset.value)}),e.addEventListener("input",s=>{s.isComposing||at.search(e.value,n.dataset.value)}),n.addEventListener("focus",()=>{ee.ipcRenderer.send(u.SIYUAN_CMD,{cmd:"unregisterGlobalShortcut",accelerator:window.siyuan.config.keymap.general.toggleWin.custom})}),n.addEventListener("blur",()=>{Gl(t)}),n.addEventListener("keydown",function(s){s.stopPropagation(),s.preventDefault();const o=at._getKeymapString(s);setTimeout(()=>{this.value=X(o)}),this.dataset.keymap=o,at.search(e.value,o)}),at.element.querySelector("#clearSearchBtn").addEventListener("click",()=>{e.value="",n.value="",at.search("","")}),at.element.querySelector("#keymapResetBtn").addEventListener("click",()=>{xe("\u26A0\uFE0F "+window.siyuan.languages.reset,window.siyuan.languages.confirmReset,()=>{E("/api/setting/setKeymap",{data:u.SIYUAN_KEYMAP},()=>{ee.ipcRenderer.send(u.SIYUAN_CMD,{cmd:"writeLog",msg:"user reset keymap"}),window.siyuan.config.keymap.general.toggleWin.default!==window.siyuan.config.keymap.general.toggleWin.custom&&ee.ipcRenderer.send(u.SIYUAN_CMD,{cmd:"unregisterGlobalShortcut",accelerator:window.siyuan.config.keymap.general.toggleWin.custom}),window.location.reload(),Gl(t)})})});const a=at.element.querySelector("#keymapList");a.addEventListener("click",s=>{let o=s.target;for(;o&&!o.isEqualNode(a);){const l=o.getAttribute("data-type");if(l==="reset"){const r=o.parentElement.querySelector(".b3-text-field");r.value=X(r.getAttribute("data-default")),r.setAttribute("data-value",r.getAttribute("data-default")),r.previousElementSibling.textContent=r.value,at._setkeymap(t),s.preventDefault(),s.stopPropagation();break}else if(l==="clear"){const r=o.parentElement.querySelector(".b3-text-field");r.value="",r.previousElementSibling.textContent="",r.setAttribute("data-value",""),at._setkeymap(t),s.preventDefault(),s.stopPropagation();break}else if(l==="update"){o.classList.add("fn__none");const r=o.nextElementSibling;r.classList.remove("fn__none"),r.focus(),s.preventDefault(),s.stopPropagation();break}else if(o.classList.contains("b3-list-item--hide-action")){const r=o.querySelector(".b3-text-field");r.classList.remove("fn__none"),r.focus(),r.previousElementSibling.classList.add("fn__none"),s.preventDefault(),s.stopPropagation();break}else if(o.classList.contains("toggle")){o.nextElementSibling.classList.contains("fn__none")?(o.firstElementChild.firstElementChild.classList.add("b3-list-item__arrow--open"),o.nextElementSibling.classList.remove("fn__none")):(o.firstElementChild.firstElementChild.classList.remove("b3-list-item__arrow--open"),o.nextElementSibling.classList.add("fn__none")),s.preventDefault(),s.stopPropagation();break}o=o.parentElement}});let i;a.querySelectorAll("label.b3-list-item input").forEach(s=>{s.addEventListener("keydown",function(o){o.stopPropagation(),o.preventDefault();const l=at._getKeymapString(o),r=X(l);clearTimeout(i),i=window.setTimeout(()=>{const d=this.getAttribute("data-key").split(u.ZWSP);d[1]==="list"&&(d[1]="list1"),d[1]==="heading"&&(d[1]="headings");let c=!1;const f=["\u2318","\u21E7","\u2325","\u2303"].includes(l.substr(l.length-1,1));if((f||["\u2318A","\u2318X","\u2318C","\u2318V","\u2318-","\u2318=","\u23180","\u21E7\u2318V","\u2318/","\u21E7\u2191","\u21E7\u2193","\u21E7\u2192","\u21E7\u2190","\u21E7\u21E5","\u2303D","\u21E7\u2318\u2192","\u21E7\u2318\u2190","\u2318Home","\u2318End","\u21E7\u21A9","\u21A9","PageUp","PageDown","\u232B","\u2326","Escape"].includes(l)||gt()&&d[0]==="general"&&["goToEditTabNext","goToEditTabPrev"].includes(d[1])&&l.includes("\u2318"))&&(f||j(`${window.siyuan.languages.invalid} [${r}]`),c=!0),Array.from(at.element.querySelectorAll("label.b3-list-item input")).find(g=>{if(!g.isSameNode(this)&&g.getAttribute("data-value")===l){const p=g.getAttribute("data-key").split(u.ZWSP);return p[1]==="list"&&(p[1]="list1"),p[1]==="heading"&&(p[1]="headings"),j(`${window.siyuan.languages.conflict} [${at._getTip(g)} ${r}]`),c=!0,!0}}),c){this.value=X(this.getAttribute("data-value"));return}Ue(),this.setAttribute("data-value",l),this.value=r,at._setkeymap(t)},u.TIMEOUT_TRANSITION)}),s.addEventListener("blur",function(){Gl(t),setTimeout(()=>{this.classList.add("fn__none"),this.previousElementSibling.textContent=this.value,this.previousElementSibling.classList.remove("fn__none")},u.TIMEOUT_INPUT)}),s.addEventListener("focus",()=>{ee.ipcRenderer.send(u.SIYUAN_CMD,{cmd:"unregisterGlobalShortcut",accelerator:window.siyuan.config.keymap.general.toggleWin.custom})})})},_getKeymapString(t){let e="";return t.ctrlKey&&gt()&&(e+="\u2303"),t.altKey&&(e+="\u2325"),t.shiftKey&&(e+="\u21E7"),(t.metaKey||!gt()&&t.ctrlKey)&&(e+="\u2318"),t.key!=="Shift"&&t.key!=="Alt"&&t.key!=="Meta"&&t.key!=="Control"&&t.key!=="Unidentified"&&(t.keyCode===229?t.code==="Minus"?e+="-":t.code==="Semicolon"?e+=";":t.code==="Quote"?e+="'":t.code==="Comma"?e+=",":t.code==="Period"?e+=".":t.code==="Slash"&&(e+="/"):e+=u.KEYCODELIST[t.keyCode]||(t.key.length>1?t.key:t.key.toUpperCase())),e}},Wn=t=>{const e=[];return t.forEach(n=>{e.push(window.siyuan.languages[n])}),e},XT=(t,e)=>{const n=[Wn(["config","fullWidth","md7","md8","md37","md38","editor","md2","md3","md12","md16","md27","md28","md29","md30","md31","md32","md33","md34","md39","md40","fontSizeTip","fontSize","font","font1","generateHistory","generateHistoryInterval","historyRetentionDays","historyRetentionDaysTip","clearHistory","katexMacros","katexMacrosTip","editReadonly","editReadonlyTip","embedBlockBreadcrumb","embedBlockBreadcrumbTip","outlineOutdentTip","outdent","floatWindowMode","floatWindowModeTip","justify","justifyTip","rtl","rtlTip","spellcheck","spellcheckTip","backlinkExpand","backlinkExpandTip","backmentionExpand","backmentionExpandTip","onlySearchForDoc","onlySearchForDocTip","dynamicLoadBlocks","dynamicLoadBlocksTip","fontSizeScrollZoom","fontSizeScrollZoomTip","listItemDotNumberClickFocus","listItemDotNumberClickFocusTip","editorMarkdownInlineAsterisk","editorMarkdownInlineUnderscore","editorMarkdownInlineSup","editorMarkdownInlineSupTip","editorMarkdownInlineSub","editorMarkdownInlineSubTip","editorMarkdownInlineTag","editorMarkdownInlineTagTip","editorMarkdownInlineMath","editorMarkdownInlineMathTip","editorMarkdownInlineStrikethrough","editorMarkdownInlineStrikethroughTip","editorMarkdownInlineMark","editorMarkdownInlineMarkTip","allowHTMLBLockScript","allowHTMLBLockScriptTip","backlinkExpandTip","backmentionExpandTip","backlinkContainChildren","backlinkContainChildrenTip"]),Wn(["selectOpen","tabLimit","fileTree","fileTree2","fileTree3","fileTree4","fileTree5","fileTree6","fileTree7","fileTree8","fileTree9","fileTree10","fileTree12","fileTree13","fileTree15","fileTree16","fileTree17","fileTree21"]),Wn(["riffCard","flashcardNewCardLimit","flashcardNewCardLimitTip","flashcardReviewCardLimit","flashcardNewCardLimit","flashcardReviewCardLimitTip","flashcardMark","flashcardMarkTip","flashcardList","flashcardSuperBlock","flashcardHeading","flashcardDeck","flashcardDeckTip","flashcardFSRSParamRequestRetention","flashcardFSRSParamRequestRetentionTip","flashcardFSRSParamMaximumInterval","flashcardFSRSParamMaximumIntervalTip","flashcardFSRSParamWeights","flashcardFSRSParamWeightsTip","reviewMode","reviewModeTip"]),["AI"].concat(Wn(["ai","apiTimeout","apiTimeoutTip","apiMaxTokens","apiMaxTokensTip","apiKey","apiKeyTip","apiProxy","apiProxyTip","apiBaseURL","apiBaseURLTip","apiUserAgentTip","apiVersion","apiVersionTip","apiProvider","apiProviderTip","apiTemperature","apiTemperatureTip","apiMaxContexts","apiMaxContextsTip"])),Wn(["assets","unreferencedAssets","missingAssets"]),Wn(["paragraphBeginningSpace","md4","export","export1","export2","export5","export11","export13","export14","export15","export19","export20","ref","blockEmbed","export17","export18","export23","export24","export25","export26","export27","export28","export29"]),Wn(["language","language1","appearance","appearance1","appearance2","appearance3","appearance4","appearance5","appearance6","appearance8","appearance9","appearance10","appearance11","appearance16","appearance17","resetLayout","reset","icon","themeLight","themeDark","close","themeOS","theme","theme2","theme11","theme12","customEmoji","customEmojiTip","refresh"]),Wn(["bazaar","theme","template","icon","widget"]),Wn(["search","searchLimit","searchLimit1","memo","name","alias","keywordsLimit","doc","headings","list1","listItem","code","math","table","quote","superBlock","paragraph","indexAssetPath","embedBlock","database","searchBackmention","searchVirtualRef","searchBlockAttr","searchBlockType","searchCaseSensitive"]),Wn(["keymap","keymapTip2"].concat(Object.keys(u.SIYUAN_KEYMAP.general)).concat(Object.keys(u.SIYUAN_KEYMAP.editor.general)).concat(Object.keys(u.SIYUAN_KEYMAP.editor.heading)).concat(Object.keys(u.SIYUAN_KEYMAP.editor.insert)).concat(Object.keys(u.SIYUAN_KEYMAP.editor.list)).concat(Object.keys(u.SIYUAN_KEYMAP.editor.table))),Wn(["accountTip","accountName","password","captcha","forgetPassword","login","register","twoFactorCaptcha","account1","account2","account5"]),Wn(["cloudStorage","trafficStat","sync","backup","cdn","total","sizeLimit","cloudBackup","cloudBackupTip","updatePath","cloudSync","upload","download","syncMode","syncModeTip","generateConflictDoc","generateConflictDocTip","syncProvider","syncProviderTip","syncMode1","syncMode2","reposTip","openSyncTip1","openSyncTip2","cloudSyncDir","cloudSyncDirTip","config"]),Wn(["publishService","publishServiceTip","publishServicePort","publishServicePortTip","publishServiceAddresses","publishServiceAddressesTip","publishServiceAuth","publishServiceAuthTip","publishServiceAuthAccounts","publishServiceAuthAccountsTip"]),Wn(["autoLaunch","autoLaunchTip","about","about1","about2","about3","about4","about5","about6","about7","about8","about11","about12","about13","about14","about17","config","dataRepoKey","dataRepoKeyTip1","dataRepoKeyTip2","slogan","currentVer","checkUpdate","updatePath","systemLog","importKey","genKey","genKeyByPW","copyKey","resetRepo","systemLogTip","export","downloadLatestVer","safeQuit","directConnection","siyuanNote","key","password","copied","resetRepoTip","autoDownloadUpdatePkg","autoDownloadUpdatePkgTip","networkProxy","keyPlaceholder","initRepoKeyTip","googleAnalytics","googleAnalyticsTip","dataRepoPurge","dataRepoPurgeTip","dataRepoAutoPurgeIndexRetentionDays","dataRepoAutoPurgeRetentionIndexesDaily"])],a=t.querySelector(".b3-form__icon input");a.focus();const i=()=>{const s=[],o=a.value;n.map((d,c)=>{d.map(f=>{f||console.warn("Search config miss language: ",d,c),f&&(o.toLowerCase().indexOf(f.toLowerCase())>-1||f.toLowerCase().indexOf(o.toLowerCase())>-1)&&s.push(c)})});let l;t.querySelectorAll(".b3-tab-bar li").forEach((d,c)=>{if(s.includes(c)){l||(l=d);const f=d.getAttribute("data-name");if(d.style.display="",["image","bazaar","account"].includes(f))return;const g=t.querySelector(`.config__tab-container[data-name="${f}"]`);if(g.innerHTML===""&&uk(f,g,e),f==="keymap"){const p=at.element.querySelector("#keymapInput"),h=at.element.querySelector("#searchByKey");p.value=o,h.value="",at.search(p.value,h.value)}else g.querySelectorAll(`.config__tab-container[data-name="${f}"] .b3-label`).forEach(p=>{if(!p.classList.contains("fn__none")){const h=p.textContent.toLowerCase();h.indexOf(o.toLowerCase())>-1||o.toLowerCase().indexOf(h)>-1?p.style.display="":p.style.display="none"}})}else d.style.display="none"});const r=t.querySelectorAll(".config__tab-container");l?l.click():r.forEach(d=>{d.classList.add("fn__none")}),a.focus()};a.addEventListener("compositionend",()=>{i()}),a.addEventListener("input",s=>{s.isComposing||i()})},Gt={element:void 0,genHTML:()=>`<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.selectOpen}
        <div class="b3-label__text">${window.siyuan.languages.fileTree2}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="alwaysSelectOpenedFile" type="checkbox"${window.siyuan.config.fileTree.alwaysSelectOpenedFile?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.fileTree7}
        <div class="b3-label__text">${window.siyuan.languages.fileTree8}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="openFilesUseCurrentTab" type="checkbox"${window.siyuan.config.fileTree.openFilesUseCurrentTab?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.fileTree9}
        <div class="b3-label__text">${window.siyuan.languages.fileTree10}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="closeTabsOnStart" type="checkbox"${window.siyuan.config.fileTree.closeTabsOnStart?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.fileTree18}
        <div class="b3-label__text">${window.siyuan.languages.fileTree19}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="allowCreateDeeper" type="checkbox"${window.siyuan.config.fileTree.allowCreateDeeper?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.fileTree3}
        <div class="b3-label__text">${window.siyuan.languages.fileTree4}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="removeDocWithoutConfirm" type="checkbox"${window.siyuan.config.fileTree.removeDocWithoutConfirm?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.fileTree20}
        <div class="b3-label__text">${window.siyuan.languages.fileTree21}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="useSingleLineSave" type="checkbox"${window.siyuan.config.fileTree.useSingleLineSave?" checked":""}/>
</label>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.fileTree16}
        <div class="b3-label__text">${window.siyuan.languages.fileTree17}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" id="maxListCount" type="number" min="1" max="10240" value="${window.siyuan.config.fileTree.maxListCount}">
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.tabLimit}
        <div class="b3-label__text">${window.siyuan.languages.tabLimit1}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" id="maxOpenTabCount" type="number" min="1" max="32" value="${window.siyuan.config.fileTree.maxOpenTabCount}">
</div>
<div class="b3-label config__item">
    ${window.siyuan.languages.fileTree12}
    <div class="b3-label__text">${window.siyuan.languages.fileTree13}</div>
    <span class="fn__hr"></span>
    <div class="fn__flex">
        <select style="min-width: 200px" class="b3-select" id="docCreateSaveBox">${wf(window.siyuan.config.fileTree.docCreateSaveBox)}</select>
        <div class="fn__space"></div>
        <input class="b3-text-field fn__flex-1" id="docCreateSavePath" value="">
    </div>
</div>
<div class="b3-label config__item">
    ${window.siyuan.languages.fileTree5}
    <div class="b3-label__text">${window.siyuan.languages.fileTree6}</div>
    <span class="fn__hr"></span>
    <div class="fn__flex">
        <select style="min-width: 200px" class="b3-select" id="refCreateSaveBox">${wf(window.siyuan.config.fileTree.refCreateSaveBox)}</select>
        <div class="fn__space"></div>
        <input class="b3-text-field fn__flex-1" id="refCreateSavePath" value="${window.siyuan.config.fileTree.refCreateSavePath}">
    </div>
</div>`,_send(){let t=parseInt(Gt.element.querySelector("#maxOpenTabCount").value);32<t&&(t=32,Gt.element.querySelector("#maxOpenTabCount").value="32"),1>t&&(t=1,Gt.element.querySelector("#maxOpenTabCount").value="1"),E("/api/setting/setFiletree",{sort:window.siyuan.config.fileTree.sort,alwaysSelectOpenedFile:Gt.element.querySelector("#alwaysSelectOpenedFile").checked,refCreateSavePath:Gt.element.querySelector("#refCreateSavePath").value,refCreateSaveBox:Gt.element.querySelector("#refCreateSaveBox").value,docCreateSavePath:Gt.element.querySelector("#docCreateSavePath").value,docCreateSaveBox:Gt.element.querySelector("#docCreateSaveBox").value,openFilesUseCurrentTab:Gt.element.querySelector("#openFilesUseCurrentTab").checked,closeTabsOnStart:Gt.element.querySelector("#closeTabsOnStart").checked,allowCreateDeeper:Gt.element.querySelector("#allowCreateDeeper").checked,removeDocWithoutConfirm:Gt.element.querySelector("#removeDocWithoutConfirm").checked,useSingleLineSave:Gt.element.querySelector("#useSingleLineSave").checked,maxListCount:parseInt(Gt.element.querySelector("#maxListCount").value),maxOpenTabCount:t},e=>{window.siyuan.config.fileTree=e.data})},bindEvent:()=>{Gt.element.querySelector("#docCreateSavePath").value=window.siyuan.config.fileTree.docCreateSavePath,Gt.element.querySelector("#refCreateSavePath").value=window.siyuan.config.fileTree.refCreateSavePath,Gt.element.querySelectorAll("input, select").forEach(t=>{t.addEventListener("change",()=>{Gt._send()})})}},Ve={element:void 0,genHTML:()=>`<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.paragraphBeginningSpace}
        <div class="b3-label__text">${window.siyuan.languages.md4}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="paragraphBeginningSpace" type="checkbox"${window.siyuan.config.export.paragraphBeginningSpace?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.export17}
        <div class="b3-label__text">${window.siyuan.languages.export18}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="addTitle" type="checkbox"${window.siyuan.config.export.addTitle?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.export23}
        <div class="b3-label__text">${window.siyuan.languages.export24}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="markdownYFM" type="checkbox"${window.siyuan.config.export.markdownYFM?" checked":""}/>
</label>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.ref}
        <div class="b3-label__text">${window.siyuan.languages.export11}</div>
    </div>
    <span class="fn__space"></span>
    <select id="blockRefMode" class="b3-select fn__flex-center fn__size200">
        <option value="2" ${window.siyuan.config.export.blockRefMode===2?"selected":""}>${window.siyuan.languages.export2}</option>
        <option value="3" ${window.siyuan.config.export.blockRefMode===3?"selected":""}>${window.siyuan.languages.export3}</option>
        <option value="4" ${window.siyuan.config.export.blockRefMode===4?"selected":""}>${window.siyuan.languages.export4}</option>
    </select>
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.blockEmbed}
        <div class="b3-label__text">${window.siyuan.languages.export12}</div>
    </div>
    <span class="fn__space"></span>
    <select id="blockEmbedMode" class="b3-select fn__flex-center fn__size200">
        <option value="0" ${window.siyuan.config.export.blockEmbedMode===0?"selected":""}>${window.siyuan.languages.export0}</option>
        <option value="1" ${window.siyuan.config.export.blockEmbedMode===1?"selected":""}>${window.siyuan.languages.export1}</option>
    </select>
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.export5}
        <div class="b3-label__text">${window.siyuan.languages.export6}</div>
    </div>
    <span class="fn__space"></span>
    <select id="fileAnnotationRefMode" class="b3-select fn__flex-center fn__size200">
        <option value="0" ${window.siyuan.config.export.fileAnnotationRefMode===0?"selected":""}>${window.siyuan.languages.export7}</option>
        <option value="1" ${window.siyuan.config.export.fileAnnotationRefMode===1?"selected":""}>${window.siyuan.languages.export8}</option>
    </select>
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.export21}
        <div class="b3-label__text">${window.siyuan.languages.export22}</div>
    </div>
    <input class="b3-text-field fn__flex-center fn__size200" id="pdfFooter">
</div>
<div class="b3-label config__item">
    ${window.siyuan.languages.export27}
    <div class="b3-label__text">${window.siyuan.languages.export28}</div>
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__block" id="pdfWatermarkStr">
    <div class="fn__hr"></div>
    <div class="b3-label__text"><a href="https://pdfcpu.io/core/watermark#description" target="_blank">${window.siyuan.languages.export29}</a></div>
    <div class="fn__hr"></div>
    <textarea class="b3-text-field fn__block" id="pdfWatermarkDesc"></textarea>
</div>
<div class="b3-label config__item">
    ${window.siyuan.languages.export30}
    <div class="b3-label__text">${window.siyuan.languages.export28}</div>
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__block" id="imageWatermarkStr">
    <div class="fn__hr"></div>
    <div class="b3-label__text">    
        ${window.siyuan.languages.export29}<br>
        ${window.siyuan.languages.export10}
    </div>
    <div class="fn__hr"></div>
    <textarea class="b3-text-field fn__block" id="imageWatermarkDesc"></textarea>
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.export25}
        <div class="b3-label__text">${window.siyuan.languages.export26}</div>
    </div>
    <input class="b3-text-field fn__flex-center fn__size200" id="docxTemplate" placeholder="F:\\template.docx">
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.export13}
        <div class="b3-label__text">${window.siyuan.languages.export14}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size96" id="blockRefTextLeft">
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size96" id="blockRefTextRight">
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.export15}
        <div class="b3-label__text">${window.siyuan.languages.export16}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size96" id="tagOpenMarker">
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size96" id="tagCloseMarker">
</div>
<div class="fn__flex b3-label config__item${pt()?" fn__none":""}">
    <div class="fn__flex-1">
        ${window.siyuan.languages.export19}
        <span class="fn__space"></span>
        <a href="javascript:void(0)" id="pandocBinPath" style="word-break: break-all">${window.siyuan.config.export.pandocBin}</a>
        <div class="b3-label__text">${window.siyuan.languages.export20}</div>
    </div>
    <span class="fn__space"></span>
    <button class="b3-button b3-button--outline fn__flex-center fn__size200" id="pandocBin"><svg><use xlink:href="#iconSettings"></use></svg>${window.siyuan.languages.config}</button>
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1 fn__flex-center">
        ${window.siyuan.languages.export} Data
        <div class="b3-label__text">${window.siyuan.languages.exportDataTip}</div>
    </div>
    <span class="fn__space"></span>
    <button class="b3-button b3-button--outline fn__flex-center fn__size200" id="exportData">
        <svg><use xlink:href="#iconUpload"></use></svg>${window.siyuan.languages.export}
    </button>
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1 fn__flex-center">
        ${window.siyuan.languages.import} Data
        <div class="b3-label__text">${window.siyuan.languages.importDataTip}</div>
    </div>
    <span class="fn__space"></span>
    <button class="b3-button b3-button--outline fn__flex-center fn__size200" style="position: relative">
        <input id="importData" class="b3-form__upload" type="file">
        <svg><use xlink:href="#iconDownload"></use></svg>${window.siyuan.languages.import}
    </button>
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1 fn__flex-center">
        ${window.siyuan.languages.exportConf}
        <div class="b3-label__text">${window.siyuan.languages.exportConfTip}</div>
    </div>
    <span class="fn__space"></span>
    <button class="b3-button b3-button--outline fn__flex-center fn__size200" id="exportConf">
        <svg><use xlink:href="#iconUpload"></use></svg>${window.siyuan.languages.export}
    </button>
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1 fn__flex-center">
        ${window.siyuan.languages.importConf}
        <div class="b3-label__text">${window.siyuan.languages.importConfTip}</div>
    </div>
    <span class="fn__space"></span>
    <button class="b3-button b3-button--outline fn__flex-center fn__size200" style="position: relative">
        <input id="importConf" class="b3-form__upload" type="file">
        <svg><use xlink:href="#iconDownload"></use></svg>${window.siyuan.languages.import}
    </button>
</div>`,bindEvent:()=>{Ve.element.querySelector("#docxTemplate").value=window.siyuan.config.export.docxTemplate,Ve.element.querySelector("#pdfFooter").value=window.siyuan.config.export.pdfFooter,Ve.element.querySelector("#pdfWatermarkStr").value=window.siyuan.config.export.pdfWatermarkStr,Ve.element.querySelector("#pdfWatermarkDesc").value=window.siyuan.config.export.pdfWatermarkDesc,Ve.element.querySelector("#imageWatermarkStr").value=window.siyuan.config.export.imageWatermarkStr,Ve.element.querySelector("#imageWatermarkDesc").value=window.siyuan.config.export.imageWatermarkDesc,Ve.element.querySelector("#blockRefTextLeft").value=window.siyuan.config.export.blockRefTextLeft,Ve.element.querySelector("#blockRefTextRight").value=window.siyuan.config.export.blockRefTextRight,Ve.element.querySelector("#tagOpenMarker").value=window.siyuan.config.export.tagOpenMarker,Ve.element.querySelector("#tagCloseMarker").value=window.siyuan.config.export.tagCloseMarker;const t=Ve.element.querySelector("#pandocBinPath"),e=a=>{E("/api/setting/setExport",{paragraphBeginningSpace:Ve.element.querySelector("#paragraphBeginningSpace").checked,addTitle:Ve.element.querySelector("#addTitle").checked,markdownYFM:Ve.element.querySelector("#markdownYFM").checked,blockRefMode:parseInt(Ve.element.querySelector("#blockRefMode").value,10),blockEmbedMode:parseInt(Ve.element.querySelector("#blockEmbedMode").value,10),fileAnnotationRefMode:parseInt(Ve.element.querySelector("#fileAnnotationRefMode").value,10),pdfFooter:Ve.element.querySelector("#pdfFooter").value,pdfWatermarkStr:Ve.element.querySelector("#pdfWatermarkStr").value,pdfWatermarkDesc:Ve.element.querySelector("#pdfWatermarkDesc").value,imageWatermarkStr:Ve.element.querySelector("#imageWatermarkStr").value,imageWatermarkDesc:Ve.element.querySelector("#imageWatermarkDesc").value,docxTemplate:Ve.element.querySelector("#docxTemplate").value,blockRefTextLeft:Ve.element.querySelector("#blockRefTextLeft").value,blockRefTextRight:Ve.element.querySelector("#blockRefTextRight").value,tagOpenMarker:Ve.element.querySelector("#tagOpenMarker").value,tagCloseMarker:Ve.element.querySelector("#tagCloseMarker").value,pandocBin:a||window.siyuan.config.export.pandocBin},i=>{Ve.onSetexport(i.data),t.textContent=i.data.pandocBin})};Ve.element.querySelectorAll("select").forEach(a=>{a.addEventListener("change",()=>{e()})}),Ve.element.querySelectorAll("input, textarea").forEach(a=>{a.id=="importData"?a.addEventListener("change",i=>{const s=new FormData;s.append("file",i.target.files[0]),E("/api/import/importData",s)}):a.id==="importConf"?a.addEventListener("change",i=>{const s=new FormData;s.append("file",i.target.files[0]),E("/api/system/importConf",s,o=>{if(o.code!==0){j(o.msg);return}j(window.siyuan.languages.imported),Xt({errorExit:!0,cb:So})})}):a.addEventListener("change",()=>{e()})}),Ve.element.querySelector("#exportData").addEventListener("click",async()=>{const a=await ee.ipcRenderer.invoke(u.SIYUAN_GET,{cmd:"showOpenDialog",title:window.siyuan.languages.export+" Data",properties:["createDirectory","openDirectory"]});if(a.canceled||a.filePaths.length===0)return;const i=j(window.siyuan.languages.exporting,-1);E("/api/export/exportDataInFolder",{folder:a.filePaths[0]},s=>{uf(Ft.join(a.filePaths[0],s.data.name),i)})}),Ve.element.querySelector("#exportConf").addEventListener("click",async()=>{E("/api/system/exportConf",{},a=>{Ht(a.data.zip)})}),t.addEventListener("click",()=>{window.siyuan.config.export.pandocBin&&Ja(window.siyuan.config.export.pandocBin)});const n=Ve.element.querySelector("#pandocBin");n.addEventListener("click",async()=>{const a=await ee.ipcRenderer.invoke(u.SIYUAN_GET,{cmd:"showOpenDialog",defaultPath:window.siyuan.config.system.homeDir,properties:["openFile","showHiddenFiles"]});if(a.filePaths.length===0){n.value=window.siyuan.config.export.pandocBin;return}e(a.filePaths[0])})},onSetexport:t=>{window.siyuan.config.export=t}};var QT=Ze(43);const Db=t=>t===0?Si("")?`<div class="b3-label b3-label--inner">${window.siyuan.config.system.container==="ios"?window.siyuan.languages._kernel[122]:window.siyuan.languages._kernel[29].replace("${url}",yn("subscribe/siyuan"))}</div>
<div class="b3-label b3-label--inner">
    ${window.siyuan.languages.cloudIntro1}
    <div class="b3-label__text">
        <ul class="fn__list">
            <li>${window.siyuan.languages.cloudIntro2}</li>
            <li>${window.siyuan.languages.cloudIntro3}</li>
            <li>${window.siyuan.languages.cloudIntro4}</li>
            <li>${window.siyuan.languages.cloudIntro5}</li>
            <li>${window.siyuan.languages.cloudIntro6}</li>
            <li>${window.siyuan.languages.cloudIntro7}</li>
            <li>${window.siyuan.languages.cloudIntro8}</li>
        </ul>
    </div>
</div>
<div class="b3-label b3-label--inner">
    ${window.siyuan.languages.cloudIntro9}
    <div class="b3-label__text">
        <ul style="padding-left: 2em">
            <li>${window.siyuan.languages.cloudIntro10}</li>
            <li>${window.siyuan.languages.cloudIntro11}</li>
        </ul>
    </div>
</div>`:`<div class="b3-label b3-label--inner">
    ${window.siyuan.languages.syncOfficialProviderIntro}
</div>`:es()?t===2?`<div class="b3-label b3-label--inner">
    ${window.siyuan.languages.syncThirdPartyProviderS3Intro}
    <div class="fn__hr"></div>
    <em>${window.siyuan.languages.proFeature}</em>
    <div class="fn__hr"></div>
    ${window.siyuan.languages.syncThirdPartyProviderTip}
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Endpoint</div>
    <div class="fn__space"></div>
    <input id="endpoint" class="b3-text-field fn__block" value="${window.siyuan.config.sync.s3.endpoint}">
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Access Key</div>
    <div class="fn__space"></div>
    <input id="accessKey" class="b3-text-field fn__block" value="${window.siyuan.config.sync.s3.accessKey}">
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Secret Key</div>
    <div class="fn__space"></div>
    <div class="b3-form__icona fn__block">
        <input id="secretKey" type="password" class="b3-text-field b3-form__icona-input" value="${window.siyuan.config.sync.s3.secretKey}">
        <svg class="b3-form__icona-icon" data-action="togglePassword"><use xlink:href="#iconEye"></use></svg>
    </div>
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Bucket</div>
    <div class="fn__space"></div>
    <input id="bucket" class="b3-text-field fn__block" value="${window.siyuan.config.sync.s3.bucket}">
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Region ID</div>
    <div class="fn__space"></div>
    <input id="region" class="b3-text-field fn__block" value="${window.siyuan.config.sync.s3.region}">
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Timeout (s)</div>
    <div class="fn__space"></div>
    <input id="timeout" class="b3-text-field fn__block" type="number" min="7" max="300" value="${window.siyuan.config.sync.s3.timeout}">
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Addressing</div>
    <div class="fn__space"></div>
    <select class="b3-select fn__block" id="pathStyle">
        <option ${window.siyuan.config.sync.s3.pathStyle?"selected":""} value="true">Path-style</option>
        <option ${window.siyuan.config.sync.s3.pathStyle?"":"selected"} value="false">Virtual-hosted-style</option>
    </select>
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">TLS Verify</div>
    <div class="fn__space"></div>
    <select class="b3-select fn__block" id="s3SkipTlsVerify">
        <option ${window.siyuan.config.sync.s3.skipTlsVerify?"":"selected"} value="false">Verify</option>
        <option ${window.siyuan.config.sync.s3.skipTlsVerify?"selected":""} value="true">Skip</option>
    </select>
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Concurrent Reqs</div>
    <div class="fn__space"></div>
    <input id="s3ConcurrentReqs" class="b3-text-field fn__block" type="number" min="1" max="16" value="${window.siyuan.config.sync.s3.concurrentReqs}">
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-1"></div>
    <button class="b3-button b3-button--outline fn__size200" data-action="purgeData">
        <svg><use xlink:href="#iconTrashcan"></use></svg>${window.siyuan.languages.purge}
    </button>
    <div class="fn__space"></div>
    <button class="b3-button b3-button--outline fn__size200" style="position: relative">
        <input id="importData" class="b3-form__upload" type="file" data-type="s3">
        <svg><use xlink:href="#iconDownload"></use></svg>${window.siyuan.languages.import}
    </button>
    <div class="fn__space"></div>
    <button class="b3-button b3-button--outline fn__size200" data-action="exportData" data-type="s3">
        <svg><use xlink:href="#iconUpload"></use></svg>${window.siyuan.languages.export}
    </button>
</div>`:t===3?`<div class="b3-label b3-label--inner">
    ${window.siyuan.languages.syncThirdPartyProviderWebDAVIntro}
    <div class="fn__hr"></div>
    <em>${window.siyuan.languages.proFeature}</em>
    <div class="fn__hr"></div>
    ${window.siyuan.languages.syncThirdPartyProviderTip}
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Endpoint</div>
    <div class="fn__space"></div>
    <input id="endpoint" class="b3-text-field fn__block" value="${window.siyuan.config.sync.webdav.endpoint}">
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Username</div>
    <div class="fn__space"></div>
    <input id="username" class="b3-text-field fn__block" value="${window.siyuan.config.sync.webdav.username}">
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Password</div>
    <div class="fn__space"></div>
    <div class="b3-form__icona fn__block">
        <input id="password" type="password" class="b3-text-field b3-form__icona-input" value="${window.siyuan.config.sync.webdav.password}">
        <svg class="b3-form__icona-icon" data-action="togglePassword"><use xlink:href="#iconEye"></use></svg>
    </div>
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Timeout (s)</div>
    <div class="fn__space"></div>
    <input id="timeout" class="b3-text-field fn__block" type="number" min="7" max="300" value="${window.siyuan.config.sync.webdav.timeout}">
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">TLS Verify</div>
    <div class="fn__space"></div>
    <select class="b3-select fn__block" id="webdavSkipTlsVerify">
        <option ${window.siyuan.config.sync.webdav.skipTlsVerify?"":"selected"} value="false">Verify</option>
        <option ${window.siyuan.config.sync.webdav.skipTlsVerify?"selected":""} value="true">Skip</option>
    </select>
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Concurrent Reqs</div>
    <div class="fn__space"></div>
    <input id="webdavConcurrentReqs" class="b3-text-field fn__block" type="number" min="1" max="16" value="${window.siyuan.config.sync.webdav.concurrentReqs}">
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-1"></div>
    <button class="b3-button b3-button--outline fn__size200" data-action="purgeData">
        <svg><use xlink:href="#iconTrashcan"></use></svg>${window.siyuan.languages.purge}
    </button>
    <div class="fn__space"></div>
    <button class="b3-button b3-button--outline fn__size200" style="position: relative">
        <input id="importData" class="b3-form__upload" type="file" data-type="webdav">
        <svg><use xlink:href="#iconDownload"></use></svg>${window.siyuan.languages.import}
    </button>
    <div class="fn__space"></div>
    <button class="b3-button b3-button--outline fn__size200" data-action="exportData" data-type="webdav">
        <svg><use xlink:href="#iconUpload"></use></svg>${window.siyuan.languages.export}
    </button>
</div>`:t===4?bl()?`<div class="b3-label b3-label--inner">
    ${window.siyuan.languages.syncThirdPartyProviderLocalIntro}
    <div class="fn__hr"></div>
    <em>${window.siyuan.languages.proFeature}</em>
    <div class="fn__hr"></div>
    ${window.siyuan.languages.deviceNotSupport}
</div>`:`<div class="b3-label b3-label--inner">
    ${window.siyuan.languages.syncThirdPartyProviderLocalIntro}
    <div class="fn__hr"></div>
    <em>${window.siyuan.languages.proFeature}</em>
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Endpoint</div>
    <div class="fn__space"></div>
    <input id="endpoint" class="b3-text-field fn__block" value="${window.siyuan.config.sync.local.endpoint}">
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Timeout (s)</div>
    <div class="fn__space"></div>
    <input id="timeout" class="b3-text-field fn__block" type="number" min="7" max="300" value="${window.siyuan.config.sync.local.timeout}">
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Concurrent Reqs</div>
    <div class="fn__space"></div>
    <input id="localConcurrentReqs" class="b3-text-field fn__block" type="number" min="1" max="1024" value="${window.siyuan.config.sync.local.concurrentReqs}">
</div>`:"":`<div class="b3-label b3-label--inner">${window.siyuan.languages._kernel[214]}</div>`,$b=()=>{const t=Ot.element.querySelector("#importData");t&&t.addEventListener("change",()=>{const s=new FormData;s.append("file",t.files[0]);const o=t.getAttribute("data-type")==="s3";E(o?"/api/sync/importSyncProviderS3":"/api/sync/importSyncProviderWebDAV",s,l=>{o?window.siyuan.config.sync.s3=l.data.s3:window.siyuan.config.sync.webdav=l.data.webdav,Ot.element.querySelector("#syncProviderPanel").innerHTML=Db(window.siyuan.config.sync.provider),$b(),j(window.siyuan.languages.imported),t.value=""})});const e=Ot.element.querySelector("#reposData"),n=Ot.element.querySelector("#reposLoading");if(window.siyuan.config.sync.provider===0){if(Si("")){n.classList.add("fn__none");let s=e;for(;s;)s.classList.add("fn__none"),s=s.nextElementSibling;return}E("/api/cloud/getCloudSpace",{},s=>{if(n.classList.add("fn__none"),s.code===1){e.innerHTML=s.msg;return}else e.innerHTML=`<div class="fn__flex">
    <div class="fn__flex-1">
        ${window.siyuan.languages.cloudStorage}
        <div class="fn__hr"></div>
        <ul class="b3-list" style="margin-left: 12px">
            <li class="b3-list-item" style="cursor: auto;">${window.siyuan.languages.sync}<span class="b3-list-item__meta">${s.data.sync?s.data.sync.hSize:"0B"}</span></li>
            <li class="b3-list-item" style="cursor: auto;">${window.siyuan.languages.backup}<span class="b3-list-item__meta">${s.data.backup?s.data.backup.hSize:"0B"}</span></li>
            <li class="b3-list-item" style="cursor: auto;"><a href="${yn("settings/file?type=3")}" target="_blank">${window.siyuan.languages.cdn}</a><span class="b3-list-item__meta">${s.data.hAssetSize}</span></li>
            <li class="b3-list-item" style="cursor: auto;">${window.siyuan.languages.total}<span class="b3-list-item__meta">${s.data.hSize}</span></li>
            <li class="b3-list-item" style="cursor: auto;">${window.siyuan.languages.sizeLimit}<span class="b3-list-item__meta">${s.data.hTotalSize}</span></li>
            <li class="b3-list-item" style="cursor: auto;"><a href="${yn("settings/point")}" target="_blank">${window.siyuan.languages.pointExchangeSize}</a><span class="b3-list-item__meta">${s.data.hExchangeSize}</span></li>
        </ul>
    </div>
    <div class="fn__flex-1">
        ${window.siyuan.languages.trafficStat}
        <div class="fn__hr"></div>
        <ul class="b3-list" style="margin-left: 12px">
            <li class="b3-list-item" style="cursor: auto;">${window.siyuan.languages.upload}<span class="fn__space"></span><span class="ft__on-surface">${s.data.hTrafficUploadSize}</span></li>
            <li class="b3-list-item" style="cursor: auto;">${window.siyuan.languages.download}<span class="fn__space"></span><span class="ft__on-surface">${s.data.hTrafficDownloadSize}</span></li>
            <li class="b3-list-item" style="cursor: auto;">API GET<span class="fn__space"></span><span class="ft__on-surface">${s.data.hTrafficAPIGet}</span></li>
            <li class="b3-list-item" style="cursor: auto;">API PUT<span class="fn__space"></span><span class="ft__on-surface">${s.data.hTrafficAPIPut}</span></li>
        </ul>
    </div>
</div>`}),e.classList.remove("fn__none");return}n.classList.add("fn__none");let a=e.nextElementSibling;for(;a;)es()?a.classList.remove("fn__none"):a.classList.add("fn__none"),a=a.nextElementSibling;e.classList.add("fn__none");const i=Ot.element.querySelector("#syncProviderPanel");i.querySelectorAll(".b3-text-field, .b3-select").forEach(s=>{s.addEventListener("blur",()=>{if(window.siyuan.config.sync.provider===2){let o=parseInt(i.querySelector("#timeout").value,10);7>o&&(1>o?o=30:o=7),300<o&&(o=300);let l=parseInt(i.querySelector("#s3ConcurrentReqs").value,10);1>l&&(l=1),16<l&&(l=16),i.querySelector("#timeout").value=o.toString();let r=i.querySelector("#endpoint").value;r=r.trim().replace("http://http(s)://","https://"),r=r.replace("http(s)://","https://"),r.startsWith("http")||(r="http://"+r);const d={endpoint:r,accessKey:i.querySelector("#accessKey").value.trim(),secretKey:i.querySelector("#secretKey").value.trim(),bucket:i.querySelector("#bucket").value.trim(),pathStyle:i.querySelector("#pathStyle").value==="true",region:i.querySelector("#region").value.trim(),skipTlsVerify:i.querySelector("#s3SkipTlsVerify").value==="true",timeout:o,concurrentReqs:l};E("/api/sync/setSyncProviderS3",{s3:d},()=>{window.siyuan.config.sync.s3=d})}else if(window.siyuan.config.sync.provider===3){let o=parseInt(i.querySelector("#timeout").value,10);7>o&&(o=7),300<o&&(o=300);let l=parseInt(i.querySelector("#webdavConcurrentReqs").value,10);1>l&&(l=1),16<l&&(l=16),i.querySelector("#timeout").value=o.toString();let r=i.querySelector("#endpoint").value;r=r.trim().replace("http://http(s)://","https://"),r=r.replace("http(s)://","https://"),r.startsWith("http")||(r="http://"+r);const d={endpoint:r,username:i.querySelector("#username").value.trim(),password:i.querySelector("#password").value.trim(),skipTlsVerify:i.querySelector("#webdavSkipTlsVerify").value==="true",timeout:o,concurrentReqs:l};E("/api/sync/setSyncProviderWebDAV",{webdav:d},()=>{window.siyuan.config.sync.webdav=d})}else if(window.siyuan.config.sync.provider===4){let o=parseInt(i.querySelector("#timeout").value,10);7>o&&(o=7),300<o&&(o=300);let l=parseInt(i.querySelector("#localConcurrentReqs").value,10);1>l&&(l=1),1024<l&&(l=1024),i.querySelector("#timeout").value=o.toString();const r={endpoint:i.querySelector("#endpoint").value,timeout:o,concurrentReqs:l};E("/api/sync/setSyncProviderLocal",{local:r},d=>{if(d.code===0){window.siyuan.config.sync.local=d.data.local;const c=i.querySelector("#endpoint");c&&(c.value=d.data.local.endpoint)}else window.siyuan.config.sync.local=r})}})})},Ot={element:void 0,genHTML:()=>`<div>
<div style="position: fixed;width: 800px;height: 434px;box-sizing: border-box;text-align: center;display: flex;align-items: center;justify-content: center;z-index: 1;" id="reposLoading">
    <img src="/stage/loading-pure.svg">
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.syncProvider}
        <div class="b3-label__text">${window.siyuan.languages.syncProviderTip}</div>
    </div>
    <span class="fn__space"></span>
    <select id="syncProvider" class="b3-select fn__flex-center fn__size200">
        <option value="0" ${window.siyuan.config.sync.provider===0?"selected":""}>SiYuan</option>
        <option value="2" ${window.siyuan.config.sync.provider===2?"selected":""}>S3</option>
        <option value="3" ${window.siyuan.config.sync.provider===3?"selected":""}>WebDAV</option>
        <option value="4" ${window.siyuan.config.sync.provider===4?"selected":""}>${window.siyuan.languages.localFlieSystem}</option>
    </select>
</div>
<div id="syncProviderPanel" class="b3-label">
    ${Db(window.siyuan.config.sync.provider)}
</div>
<div id="reposData" class="b3-label">
    <div class="fn__flex">
        <div class="fn__flex-1">
            ${window.siyuan.languages.cloudStorage}
        </div>
        <div class="fn__flex-1">
            ${window.siyuan.languages.trafficStat}
        </div>
    </div>
</div>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.openSyncTip1}
        <div class="b3-label__text">${window.siyuan.languages.openSyncTip2}</div>
    </div>
    <span class="fn__space"></span>
    <input type="checkbox" id="reposCloudSyncSwitch"${window.siyuan.config.sync.enabled?" checked='checked'":""} class="b3-switch fn__flex-center">
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.generateConflictDoc}
        <div class="b3-label__text">${window.siyuan.languages.generateConflictDocTip}</div>
    </div>
    <span class="fn__space"></span>
    <input type="checkbox" id="generateConflictDoc"${window.siyuan.config.sync.generateConflictDoc?" checked='checked'":""} class="b3-switch fn__flex-center">
</label>
<div class="b3-label">
    <div class="fn__flex config__item">
        <div class="fn__flex-1">
            ${window.siyuan.languages.syncMode}
            <div class="b3-label__text">${window.siyuan.languages.syncModeTip}</div>
        </div>
        <span class="fn__space"></span>
        <select id="syncMode" class="b3-select fn__flex-center fn__size200">
            <option value="1" ${window.siyuan.config.sync.mode===1?"selected":""}>${window.siyuan.languages.syncMode1}</option>
            <option value="2" ${window.siyuan.config.sync.mode===2?"selected":""}>${window.siyuan.languages.syncMode2}</option>
            <option value="3" ${window.siyuan.config.sync.mode===3?"selected":""}>${window.siyuan.languages.syncMode3}</option>
        </select>
    </div>
    <div class="fn__flex b3-label${window.siyuan.config.sync.mode!==1?" fn__none":""}">
        <div class="fn__flex-1">
            ${window.siyuan.languages.syncInterval}
            <div class="b3-label__text">${window.siyuan.languages.syncIntervalTip}</div>
        </div>
        <span class="fn__space"></span>
        <input type="number" min="30" max="43200" id="syncInterval" class="b3-text-field fn__flex-center" value="${window.siyuan.config.sync.interval}" >
        <span class="fn__space"></span>        
        <span class="fn__flex-center ft__on-surface">${window.siyuan.languages.second}</span> 
    </div>
    <label class="fn__flex b3-label${window.siyuan.config.sync.mode!==1||window.siyuan.config.system.container==="docker"||window.siyuan.config.sync.provider!==0?" fn__none":""}">
        <div class="fn__flex-1">
            ${window.siyuan.languages.syncPerception}
            <div class="b3-label__text">${window.siyuan.languages.syncPerceptionTip}</div>
        </div>
        <span class="fn__space"></span>
        <input type="checkbox" id="syncPerception"${window.siyuan.config.sync.perception?" checked='checked'":""} class="b3-switch fn__flex-center">
    </label>
</div>
<div class="b3-label">
    <div class="fn__flex config__item">
        <div class="fn__flex-1">
            ${window.siyuan.languages.cloudSyncDir}
            <div class="b3-label__text">${window.siyuan.languages.cloudSyncDirTip}</div>
        </div>
        <div class="fn__space"></div>
        <button class="b3-button b3-button--outline fn__flex-center fn__size200" data-action="config">
            <svg><use xlink:href="#iconSettings"></use></svg>${window.siyuan.languages.config}
        </button>
    </div>
    <div id="reposCloudSyncList" class="fn__none b3-label"><img style="margin: 0 auto;display: block;width: 64px;height: 100%" src="/stage/loading-pure.svg"></div>
</div>
<div class="b3-label fn__flex">
    <div class="fn__flex-center">${window.siyuan.languages.cloudBackup}</div>
    <div class="b3-list-item__meta fn__flex-center">${window.siyuan.languages.cloudBackupTip}</div>
</div>
</div>`,bindEvent:()=>{$b();const t=Ot.element.querySelector("#reposCloudSyncSwitch");t.addEventListener("change",()=>{if(t.checked&&window.siyuan.config.sync.cloudName===""){t.checked=!1,j(window.siyuan.languages._kernel[123]);return}E("/api/sync/setSyncEnable",{enabled:t.checked},()=>{window.siyuan.config.sync.enabled=t.checked,Ya()})});const e=Ot.element.querySelector("#syncInterval");e.addEventListener("change",()=>{let r=parseInt(e.value);30>r&&(r=30),43200<r&&(r=43200),e.value=r.toString(),E("/api/sync/setSyncInterval",{interval:r},()=>{window.siyuan.config.sync.interval=r,Ya()})});const n=Ot.element.querySelector("#syncPerception");n.addEventListener("change",()=>{E("/api/sync/setSyncPerception",{enabled:n.checked},()=>{window.siyuan.config.sync.perception=n.checked,Ya()})});const a=Ot.element.querySelector("#generateConflictDoc");a.addEventListener("change",()=>{E("/api/sync/setSyncGenerateConflictDoc",{enabled:a.checked},()=>{window.siyuan.config.sync.generateConflictDoc=a.checked})});const i=Ot.element.querySelector("#syncMode");i.addEventListener("change",()=>{E("/api/sync/setSyncMode",{mode:parseInt(i.value,10)},()=>{i.value==="1"&&window.siyuan.config.sync.provider===0&&window.siyuan.config.system.container!=="docker"?n.parentElement.classList.remove("fn__none"):n.parentElement.classList.add("fn__none"),i.value==="1"?e.parentElement.classList.remove("fn__none"):e.parentElement.classList.add("fn__none"),window.siyuan.config.sync.mode=parseInt(i.value,10)})});const s=Ot.element.querySelector("#reposCloudSyncList"),o=Ot.element.querySelector("#syncProvider");o.addEventListener("change",()=>{E("/api/sync/setSyncProvider",{provider:parseInt(o.value,10)},r=>{r.code===1?(j(r.msg),o.value="0",window.siyuan.config.sync.provider=0):window.siyuan.config.sync.provider=parseInt(o.value,10),Ot.element.querySelector("#syncProviderPanel").innerHTML=Db(window.siyuan.config.sync.provider),$b(),s.innerHTML="",s.classList.add("fn__none"),window.siyuan.config.sync.mode!==1||window.siyuan.config.system.container==="docker"||window.siyuan.config.sync.provider!==0?n.parentElement.classList.add("fn__none"):n.parentElement.classList.remove("fn__none"),window.siyuan.config.sync.mode!==1?e.parentElement.classList.add("fn__none"):e.parentElement.classList.remove("fn__none")})});const l=Ot.element.querySelector("#reposLoading");l.style.width=Ot.element.clientWidth+"px",l.style.height=Ot.element.clientHeight+"px",QE(s),Ot.element.firstElementChild.addEventListener("click",r=>{let d=r.target;for(;d&&d!==Ot.element;){const c=d.getAttribute("data-action");if(c==="config"){s.classList.contains("fn__none")?(Uc(s,!0),s.classList.remove("fn__none")):s.classList.add("fn__none");break}else if(c==="togglePassword"){const f=d.firstElementChild.getAttribute("xlink:href")==="#iconEye";d.firstElementChild.setAttribute("xlink:href",f?"#iconEyeoff":"#iconEye"),d.previousElementSibling.setAttribute("type",f?"text":"password");break}else if(c==="exportData"){E(d.getAttribute("data-type")==="s3"?"/api/sync/exportSyncProviderS3":"/api/sync/exportSyncProviderWebDAV",{},f=>{Ht(f.data.zip)});break}else if(c==="purgeData"){xe("\u267B\uFE0F "+window.siyuan.languages.cloudStoragePurge,`<div class="b3-typography">${window.siyuan.languages.cloudStoragePurgeConfirm}</div>`,()=>{E("/api/repo/purgeCloudRepo")});break}d=d.parentElement}})}},Mp=()=>{let t="";const e=[];return document.querySelectorAll("body > svg > defs > symbol").forEach(n=>{e.push(n.id)}),Array.from({length:45},()=>{const n=Math.floor(Math.random()*e.length);t+=`<svg><use xlink:href="#${e[n]}"></use></svg>`,e.splice(n,1)}),`<div class="fn__flex config-account__svg">${t}</div>`},jt={element:void 0,genHTML:(t=!1)=>{const e=Da()?" fn__none":"",n=`<a class="b3-button b3-button--big${e}" href="${sL("pricing.html")}" target="_blank">
    <svg><use xlink:href="#iconVIP"></use></svg>${window.siyuan.languages[window.siyuan.user?.userSiYuanOneTimePayStatus===1?"account4":"account1"]}
</a>
<div class="fn__hr--b${e}"></div>
<span class="b3-chip b3-chip--primary b3-chip--hover${window.siyuan.user&&window.siyuan.user.userSiYuanSubscriptionStatus===2?" fn__none":""}" id="trialSub">
    <svg class="ft__secondary"><use xlink:href="#iconVIP"></use></svg>
    ${window.siyuan.languages.freeSub}
</span>
<div class="fn__hr${window.siyuan.user&&window.siyuan.user.userSiYuanSubscriptionStatus===2?" fn__none":""}"></div>
<a href="${yn("sponsor")}" target="_blank" class="b3-chip b3-chip--pink b3-chip--hover">
    <svg version='1.1' xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 32 32'><path fill='#ffe43c' d='M6.4 0h19.2c4.268 0 6.4 2.132 6.4 6.4v19.2c0 4.268-2.132 6.4-6.4 6.4h-19.2c-4.268 0-6.4-2.132-6.4-6.4v-19.2c0-4.268 2.135-6.4 6.4-6.4z'></path> <path fill='#00f5d4' d='M25.6 0h-8.903c-7.762 1.894-14.043 7.579-16.697 15.113v10.487c0 3.533 2.867 6.4 6.4 6.4h19.2c3.533 0 6.4-2.867 6.4-6.4v-19.2c0-3.537-2.863-6.4-6.4-6.4z'></path> <path fill='#01beff' d='M25.6 0h-0.119c-12.739 2.754-20.833 15.316-18.079 28.054 0.293 1.35 0.702 2.667 1.224 3.946h16.974c3.533 0 6.4-2.867 6.4-6.4v-19.2c0-3.537-2.863-6.4-6.4-6.4z'></path> <path fill='#9a5ce5' d='M31.005 2.966c-0.457-0.722-1.060-1.353-1.784-1.849-8.342 3.865-13.683 12.223-13.679 21.416-0.003 3.256 0.67 6.481 1.978 9.463h8.081c0.602 0 1.185-0.084 1.736-0.238-2.1-3.189-3.401-7.624-3.401-12.526 0-7.337 2.921-13.628 7.070-16.266z'></path> <path fill='#f15bb5' d='M32 25.6v-19.2c0-1.234-0.354-2.419-0.998-3.43-4.149 2.638-7.067 8.928-7.067 16.266 0 4.902 1.301 9.334 3.401 12.526 2.693-0.757 4.664-3.231 4.664-6.162z'></path> <path fill='#fff' opacity='0.2' d='M26.972 22.415c-2.889 0.815-4.297 2.21-6.281 3.182 1.552 0.348 3.105 0.461 4.902 0.461 2.644 0 5.363-1.449 6.406-2.519v-1.085c-1.598-0.399-2.664-0.705-5.028-0.039zM4.773 21.612c-0.003 0-0.006-0.003-0.006-0.003-1.726-0.863-3.382-1.205-4.767-1.301v2.487c0.779-0.341 2.396-0.921 4.773-1.182zM17.158 26.599c1.472-0.158 2.57-0.531 3.533-1.002-1.063-0.238-2.126-0.583-3.269-1.079-2.767-1.205-5.63-3.092-10.491-3.034-0.779 0.010-1.495 0.058-2.158 0.132 4.503 2.248 7.882 5.463 12.384 4.983z'></path> <path fill='#fff' opacity='0.2' d='M20.691 25.594c-0.963 0.47-2.061 0.844-3.533 1.002-4.503 0.483-7.882-2.731-12.381-4.983-2.38 0.261-3.994 0.841-4.773 1.179v2.809c0 4.268 2.132 6.4 6.4 6.4h19.197c4.268 0 6.4-2.132 6.4-6.4v-2.065c-1.044 1.069-3.762 2.519-6.406 2.519-1.797 0-3.35-0.113-4.902-0.461z'></path> <path fill='#fff' opacity='0.5' d='M3.479 19.123c0 0.334 0.271 0.606 0.606 0.606s0.606-0.271 0.606-0.606v0c0-0.334-0.271-0.606-0.606-0.606s-0.606 0.271-0.606 0.606v0z'></path> <path fill='#fff' opacity='0.5' d='M29.027 14.266c0 0.334 0.271 0.606 0.606 0.606s0.606-0.271 0.606-0.606v0c0-0.334-0.271-0.606-0.606-0.606s-0.606 0.271-0.606 0.606v0z'></path> <path fill='#fff' d='M9.904 1.688c0 0.167 0.136 0.303 0.303 0.303s0.303-0.136 0.303-0.303v0c0-0.167-0.136-0.303-0.303-0.303s-0.303 0.136-0.303 0.303v0z'></path> <path fill='#fff' d='M2.673 10.468c0 0.167 0.136 0.303 0.303 0.303s0.303-0.136 0.303-0.303v0c0-0.167-0.136-0.303-0.303-0.303s-0.303 0.136-0.303 0.303v0z'></path> <path fill='#fff' opacity='0.6' d='M30.702 9.376c0 0.167 0.136 0.303 0.303 0.303s0.303-0.136 0.303-0.303v0c0-0.167-0.136-0.303-0.303-0.303s-0.303 0.136-0.303 0.303v0z'></path> <path fill='#fff' opacity='0.8' d='M29.236 20.881c0 0.276 0.224 0.499 0.499 0.499s0.499-0.224 0.499-0.499v0c0-0.276-0.224-0.499-0.499-0.499s-0.499 0.224-0.499 0.499v0z'></path> <path fill='#fff' opacity='0.8' d='M15.38 1.591c0.047 0.016 0.101 0.026 0.158 0.026 0.276 0 0.499-0.224 0.499-0.499 0-0.219-0.141-0.406-0.338-0.473l-0.004-0.001c-0.047-0.016-0.101-0.026-0.158-0.026-0.276 0-0.499 0.224-0.499 0.499 0 0.219 0.141 0.406 0.338 0.473l0.004 0.001z'></path> <path fill='#ffdeeb' d='M25.732 8.268c-2.393-2.371-6.249-2.371-8.642 0l-1.089 1.085-1.079-1.089c-2.38-2.39-6.249-2.393-8.639-0.013s-2.393 6.249-0.013 8.639l2.158 2.158 6.474 6.464c0.596 0.593 1.562 0.593 2.158 0l6.474-6.464 2.193-2.158c2.384-2.383 2.384-6.242 0.003-8.622z'></path> <path fill='#fff' d='M17.081 8.268l-1.079 1.085-1.079-1.089c-2.38-2.39-6.249-2.393-8.639-0.013s-2.393 6.249-0.013 8.639l2.158 2.158 2.548 2.487c4.097-1.044 7.627-3.646 9.837-7.254 1.424-2.271 2.284-4.848 2.503-7.518-2.193-0.715-4.606-0.132-6.236 1.504z'></path> </svg>
    ${window.siyuan.languages.sponsor}
</a>
<div class="fn__hr--b"></div>
<div class="fn__flex-1"></div>
<div>
${window.siyuan.languages.accountSupport1}
</div>
<div class="fn__hr--b"></div>
<div>
${window.siyuan.languages.accountSupport2}
</div>`;if(t)return`<div class="fn__flex-1 fn__hr--b"></div>
${Mp()}
<div class="fn__flex-1 fn__hr--b"></div>    
${n}
<div class="fn__flex-1 fn__hr--b"></div>
${Mp()}
<div class="fn__flex-1 fn__hr--b"></div>`;if(window.siyuan.user){let a="";window.siyuan.user.userTitles.length>0&&(a='<div class="b3-chips" style="position: absolute">',window.siyuan.user.userTitles.forEach(o=>{a+=`<div class="b3-chip b3-chip--middle">${o.icon} ${o.name}</div>`}),a+="</div>");let i="",s=`<div class="b3-form__icon fn__block">
   <svg class="ft__secondary b3-form__icon-icon"><use xlink:href="#iconVIP"></use></svg>
   <input class="b3-text-field fn__block b3-form__icon-input" style="padding-right: 44px;" placeholder="${window.siyuan.languages.activationCodePlaceholder}">
   <button id="activationCode" class="b3-button b3-button--text" style="position: absolute;right: 0;top: 0;">${window.siyuan.languages.confirm}</button>
</div>`;if(window.siyuan.user.userSiYuanProExpireTime===-1)s="",i=`<div class="b3-chip b3-chip--secondary">${u.SIYUAN_IMAGE_VIP}${window.siyuan.languages.account12}</div>`;else if(window.siyuan.user.userSiYuanProExpireTime>0){const o=`<div class="fn__hr--b"></div>
<div class="ft__on-surface ft__smaller">
    ${window.siyuan.languages.account6} 
    ${Math.max(0,Math.floor((window.siyuan.user.userSiYuanProExpireTime-new Date().getTime())/1e3/60/60/24))} 
    ${window.siyuan.languages.day} 
    <a class="${e}" href="${yn("subscribe/siyuan")}" target="_blank">${window.siyuan.languages.clickMeToRenew}</a>
</div>`;window.siyuan.user.userSiYuanOneTimePayStatus===1&&(i=`<div class="b3-chip"><svg><use xlink:href="#iconVIP"></use></svg>${window.siyuan.languages.onepay}</div>
<div class="fn__hr--b"></div>`),window.siyuan.user.userSiYuanSubscriptionPlan===2?i+=`<div class="b3-chip b3-chip--primary"><svg><use xlink:href="#iconVIP"></use></svg>${window.siyuan.languages.account3}</div>
${o}
<div class="fn__hr--b"></div>`:i+=`<div class="b3-chip b3-chip--primary"><svg class="ft__secondary"><use xlink:href="#iconVIP"></use></svg>${window.siyuan.languages.account10}</div>${o}`}else window.siyuan.user.userSiYuanOneTimePayStatus===1?i=`<div class="b3-chip"><svg><use xlink:href="#iconVIP"></use></svg>${window.siyuan.languages.onepay}</div>
<div class="fn__hr--b"></div>${n}`:i=n;return`<div class="fn__flex config-account">
<div class="config-account__center">
    <div class="config-account__bg">
        <div class="config-account__cover" style="background-image: url(${window.siyuan.user.userHomeBImgURL})"></div>
        <a href="${yn("settings/avatar")}" class="config-account__avatar" style="background-image: url(${window.siyuan.user.userAvatarURL})" target="_blank"></a>
        <h1 class="config-account__name">
            <a target="_blank" class="fn__a" href="${yn("member/"+window.siyuan.user.userName)}">${window.siyuan.user.userName}</a>
            <span class="ft__on-surface ft__smaller">${window.siyuan.config.cloudRegion===0?"ld246.com":"liuyun.io"}</span>
        </h1>
        ${a}
    </div>
    <div class="config-account__info">
        <div class="fn__flex">
            <a class="b3-button b3-button--text${e}" href="${yn("settings")}" target="_blank">${window.siyuan.languages.manage}</a>
            <span class="fn__space${e}"></span>
            <button class="b3-button b3-button--cancel" id="logout">
                ${window.siyuan.languages.logout}
            </button>
            <span class="fn__space"></span>
            <button class="b3-button b3-button--cancel${window.siyuan.config.system.container==="ios"?"":" fn__none"}" id="deactivateUser">
                ${window.siyuan.languages.deactivateUser}
            </button>
            <span class="fn__flex-1"></span>
            <button class="b3-button b3-button--cancel b3-tooltips b3-tooltips__n" id="refresh" aria-label="${window.siyuan.languages.refresh}">
                <svg style="margin-right: 0"><use xlink:href="#iconRefresh"></use></svg>
            </button>
        </div>
        <div class="fn__hr--b"></div>
        <div class="fn__flex">  
            <label>
                ${window.siyuan.languages.accountDisplayTitle}
                <input class="b3-switch fn__flex-center" id="displayTitle" type="checkbox"${window.siyuan.config.account.displayTitle?" checked":""}/>
            </label>
            <div class="fn__flex-1"></div>
            <label>
                ${window.siyuan.languages.accountDisplayVIP}
                <input class="b3-switch fn__flex-center" id="displayVIP" type="checkbox"${window.siyuan.config.account.displayVIP?" checked":""}/>
            </label>
        </div>
    </div>
</div>
<div class="config-account__center config-account__center--text${window.siyuan.config.system.container==="ios"?" fn__none":""}">
    <div class="fn__flex-1 fn__hr--b"></div>
    ${i}
    <div class="fn__flex-1 fn__hr--b"></div>
    ${s}
</div></div>`}return`<div class="fn__flex config-account">
<div class="b3-form__space config-account__center">
    <div class="config-account__form" id="form1">
        <div class="b3-form__icon">
            <svg class="b3-form__icon-icon"><use xlink:href="#iconAccount"></use></svg>
            <input id="userName" class="b3-text-field fn__block b3-form__icon-input" placeholder="${window.siyuan.languages.accountName}">
        </div>
        <div class="fn__hr--b"></div>
        <div class="b3-form__icon">
            <svg class="b3-form__icon-icon"><use xlink:href="#iconLock"></use></svg>
            <input type="password" id="userPassword" class="b3-text-field b3-form__icon-input fn__block" placeholder="${window.siyuan.languages.password}">
        </div>
        <div class="fn__hr--b"></div>
        <div class="b3-form__icon">
            <svg class="b3-form__icon-icon"><use xlink:href="#iconFocus"></use></svg>
            <select class="b3-select b3-form__icon-input fn__block" id="cloudRegion">
                <option value="0"${window.siyuan.config.cloudRegion===0?" selected":""}>${window.siyuan.languages.cloudRegionChina}</option>
                <option value="1"${window.siyuan.config.cloudRegion===1?" selected":""}>${window.siyuan.languages.cloudRegionNorthAmerica}</option>
            </select>
        </div>
        <div class="b3-form__img fn__none">
            <div class="fn__hr--b"></div>
            <img id="captchaImg" class="fn__pointer" style="top: 17px">
            <input id="captcha" class="b3-text-field fn__block" placeholder="${window.siyuan.languages.captcha}">
        </div>
        <div class="fn__hr--b"></div>
        <label class="ft__smaller ft__on-surface fn__flex">
            <span class="fn__space"></span>
            <input type="checkbox" class="b3-switch fn__flex-center" id="agreeLogin">
            <span class="fn__space"></span>
            <span>${window.siyuan.languages.accountTip}</span>
        </label>
        <div class="fn__hr--b"></div>
        <button id="login" disabled class="b3-button fn__block">${window.siyuan.languages.login}</button>
        <div class="fn__hr--b"></div>
        <div class="ft__center">
            <a href="${yn("forget-pwd")}" class="b3-button b3-button--cancel" target="_blank">${window.siyuan.languages.forgetPassword}</a>
            <span class="fn__space${window.siyuan.config.system.container==="ios"?" fn__none":""}"></span>
            <a href="${yn("register")}" class="b3-button b3-button--cancel${window.siyuan.config.system.container==="ios"?" fn__none":""}" target="_blank">${window.siyuan.languages.register}</a>
        </div>
    </div>
    <div class="fn__none config-account__form" id="form2">
        <div class="b3-form__icon">
            <svg class="b3-form__icon-icon"><use xlink:href="#iconLock"></use></svg>
            <input id="twofactorAuthCode" class="b3-text-field fn__block b3-form__icon-input" placeholder="${window.siyuan.languages.twoFactorCaptcha}">
        </div>
        <div class="fn__hr--b"></div>
        <button id="login2" class="b3-button fn__block">${window.siyuan.languages.login}</button>
    </div>
</div>
<div class="config-account__center config-account__center--text${window.siyuan.config.system.container==="ios"?" fn__none":""}">
    <div class="fn__flex-1 fn__hr--b"></div>
    ${Mp()}
    <div class="fn__flex-1 fn__hr--b"></div>    
    ${n}
    <div class="fn__flex-1 fn__hr--b"></div>
    ${Mp()}
    <div class="fn__flex-1 fn__hr--b"></div>
</div>
</div>`},bindEvent:t=>{const e=t.querySelector("#trialSub");e&&e.addEventListener("click",()=>{E("/api/account/startFreeTrial",{},()=>{t.querySelector("#refresh").dispatchEvent(new Event("click"))})});const n=t.querySelector("#agreeLogin"),a=t.querySelector("#userName");if(!a){const p=t.querySelector("#refresh");p.addEventListener("click",()=>{const m=p.firstElementChild;m.classList.contains("fn__rotate")||(m.classList.add("fn__rotate"),E("/api/setting/getCloudUser",{token:window.siyuan.user.userToken},b=>{window.siyuan.user=b.data,t.innerHTML=jt.genHTML(),jt.bindEvent(t),j(window.siyuan.languages.refreshUser,3e3),jt.onSetaccount(),Ya()}))}),t.querySelector("#logout").addEventListener("click",()=>{E("/api/setting/logoutCloudUser",{},()=>{E("/api/setting/getCloudUser",{},m=>{window.siyuan.user=m.data,t.innerHTML=jt.genHTML(),jt.bindEvent(t),jt.onSetaccount(),Ya()})})}),t.querySelector("#deactivateUser").addEventListener(Gr(),()=>{xe("\u26A0\uFE0F "+window.siyuan.languages.deactivateUser,window.siyuan.languages.deactivateUserTip,()=>{E("/api/account/deactivate",{},()=>{window.siyuan.user=null,t.innerHTML=jt.genHTML(),jt.bindEvent(t),jt.onSetaccount(),Ya()})})}),t.querySelectorAll("input[type='checkbox']").forEach(m=>{m.addEventListener("change",()=>{E("/api/setting/setAccount",{displayTitle:t.querySelector("#displayTitle").checked,displayVIP:t.querySelector("#displayVIP").checked},b=>{window.siyuan.config.account.displayTitle=b.data.displayTitle,window.siyuan.config.account.displayVIP=b.data.displayVIP,jt.onSetaccount()})})});const h=t.querySelector("#activationCode");h.addEventListener("click",()=>{const m=h.previousElementSibling;E("/api/account/checkActivationcode",{data:m.value},b=>{b.code!==0&&(m.value=""),xe(window.siyuan.languages.activationCode,b.msg,()=>{b.code===0&&E("/api/account/useActivationcode",{data:h.previousElementSibling.value},()=>{p.dispatchEvent(new CustomEvent("click"))})})})});return}const i=t.querySelector("#userPassword"),s=t.querySelector("#captchaImg"),o=t.querySelector("#captcha"),l=t.querySelector("#twofactorAuthCode"),r=t.querySelector("#login"),d=t.querySelector("#login2");n.addEventListener("click",()=>{n.checked?r.removeAttribute("disabled"):r.setAttribute("disabled","disabled")}),a.focus(),a.addEventListener("keydown",p=>{if(p.isComposing){p.preventDefault();return}p.key==="Enter"&&(r.click(),p.preventDefault())}),l.addEventListener("keydown",p=>{if(p.isComposing){p.preventDefault();return}p.key==="Enter"&&(d.click(),p.preventDefault())}),o.addEventListener("keydown",p=>{if(p.isComposing){p.preventDefault();return}p.key==="Enter"&&(r.click(),p.preventDefault())}),i.addEventListener("keydown",p=>{if(p.isComposing){p.preventDefault();return}p.key==="Enter"&&(r.click(),p.preventDefault())});let c,f;s.addEventListener("click",()=>{s.setAttribute("src",yn("captcha")+`/login?needCaptcha=${f}&t=${new Date().getTime()}`)});const g=t.querySelector("#cloudRegion");g.addEventListener("change",()=>{window.siyuan.config.cloudRegion=parseInt(g.value),t.querySelector(".config-account__center--text").innerHTML=jt.genHTML(!0),t.querySelector("#form1").lastElementChild.innerHTML=`<a href="${yn("forget-pwd")}" class="b3-button b3-button--cancel" target="_blank">${window.siyuan.languages.forgetPassword}</a>
<span class="fn__space${window.siyuan.config.system.container==="ios"?" fn__none":""}"></span>
<a href="${yn("register")}" class="b3-button b3-button--cancel${window.siyuan.config.system.container==="ios"?" fn__none":""}" target="_blank">${window.siyuan.languages.register}</a>`}),r.addEventListener("click",()=>{E("/api/account/login",{userName:a.value.replace(/(^\s*)|(\s*$)/g,""),userPassword:QT(i.value),captcha:o.value.replace(/(^\s*)|(\s*$)/g,""),cloudRegion:window.siyuan.config.cloudRegion},p=>{let h;if(p.code===1){if(h=j(p.msg),p.data.needCaptcha){f=p.data.needCaptcha,o.parentElement.classList.remove("fn__none"),o.previousElementSibling.setAttribute("src",yn("captcha")+`/login?needCaptcha=${p.data.needCaptcha}`),o.value="";return}return}if(p.code===10){t.querySelector("#form1").classList.add("fn__none"),t.querySelector("#form2").classList.remove("fn__none"),l.focus(),c=p.data.token;return}Ue(h),E("/api/setting/getCloudUser",{token:p.data.token},m=>{jt._afterLogin(m,t)})})}),d.addEventListener("click",()=>{E("/api/setting/login2faCloudUser",{code:l.value,token:c},p=>{E("/api/setting/getCloudUser",{token:p.data.token},h=>{jt._afterLogin(h,t)})})})},_afterLogin(t,e){if(window.siyuan.user=t.data,Ya(),e.innerHTML=jt.genHTML(),jt.bindEvent(e),jt.onSetaccount(),e.getAttribute("data-action")==="go-repos")if(Si("")&&window.siyuan.config.sync.provider===0){const n=L(e,"b3-dialog--open");n&&(n.querySelector('.b3-tab-bar [data-name="repos"]').dispatchEvent(new CustomEvent("click")),e.removeAttribute("data-action"))}else Q(["dialog"]),Dp()},onSetaccount(){if(Ot.element&&(Ot.element.innerHTML=""),window.siyuan.config.system.container==="ios")return;let t="";window.siyuan.config.account.displayVIP&&(window.siyuan.user?(window.siyuan.user.userSiYuanProExpireTime===-1?t=`<div class="toolbar__item ariaLabel" aria-label="${window.siyuan.languages.account12}">${u.SIYUAN_IMAGE_VIP}</div>`:window.siyuan.user.userSiYuanProExpireTime>0?window.siyuan.user.userSiYuanSubscriptionPlan===2?t=`<div class="toolbar__item ariaLabel" aria-label="${window.siyuan.languages.account3}"><svg><use xlink:href="#iconVIP"></use></svg></div>`:t=`<div class="toolbar__item ariaLabel" aria-label="${window.siyuan.languages.account10}"><svg class="ft__secondary"><use xlink:href="#iconVIP"></use></svg></div>`:window.siyuan.user.userSiYuanSubscriptionStatus===-1&&(t=`<div class="toolbar__item ariaLabel" aria-label="${window.siyuan.languages.freeSub}"><svg class="ft__error"><use xlink:href="#iconVIP"></use></svg></div>`),window.siyuan.user.userSiYuanOneTimePayStatus===1&&(t+=`<div class="toolbar__item ariaLabel" aria-label="${window.siyuan.languages.onepay}"><svg><use xlink:href="#iconVIP"></use></svg></div>`)):t=`<div class="toolbar__item ariaLabel" aria-label="${window.siyuan.languages.freeSub}"><svg class="ft__error"><use xlink:href="#iconVIP"></use></svg></div>`),window.siyuan.config.account.displayTitle&&window.siyuan.user&&window.siyuan.user.userTitles.forEach(e=>{t+=`<div class="toolbar__item ariaLabel" aria-label="${e.name}\uFF1A${e.desc}">${e.icon}</div>`}),document.getElementById("toolbarVIP").innerHTML=t}},Pp=(t,e,n=!1)=>{t.plugins.find((a,i)=>{if(a.name===e){try{a.onunload(),n&&(a.uninstall(),window.siyuan.storage[u.LOCAL_PLUGIN_DOCKS][a.name]={},ue(u.LOCAL_PLUGIN_DOCKS,window.siyuan.storage[u.LOCAL_PLUGIN_DOCKS]))}catch(l){console.error(`plugin ${a.name} onunload error:`,l)}const s=Object.keys(a.models);return Ce().custom.forEach(l=>{s.includes(l.type)&&l.parent.parent.removeTab(l.parent.id)}),a.topBarIcons.forEach(l=>{l.remove()}),Rp(),a.statusBarIcons.forEach(l=>{l.remove()}),Object.keys(a.docks).forEach(l=>{Object.keys(window.siyuan.layout.leftDock.data).includes(l)?window.siyuan.layout.leftDock.remove(l):Object.keys(window.siyuan.layout.rightDock.data).includes(l)?window.siyuan.layout.rightDock.remove(l):Object.keys(window.siyuan.layout.bottomDock.data).includes(l)&&window.siyuan.layout.bottomDock.remove(l)}),Array.from(document.childNodes).find(l=>{if(l.nodeType===8&&l.textContent===e)return l.remove(),!0}),t.plugins.splice(i,1),Mn().forEach(l=>{l.protyle.toolbar.update(l.protyle)}),!0}})},be={element:void 0,genHTML(){if(!window.siyuan.config.bazaar.trust)return`<div class="fn__flex-column">
<div class="fn__flex-1"></div>
<div class="b3-label">
    <div>${window.siyuan.languages.bazaarTrust}</div>
    <div class="fn__hr--b"></div>
    <div>${window.siyuan.languages.bazaarTrust3}</div>
</div>
<div class="fn__flex b3-label">
    <svg class="b3-label__icon"><use xlink:href="#iconEye"></use></svg>
    <div>
        ${window.siyuan.languages.bazaarTrustCodeReview}
        <div class="b3-label__text">${window.siyuan.languages.bazaarTrustCodeReviewTip}</div>
    </div>
</div>
<div class="fn__flex b3-label">
    <svg class="b3-label__icon"><use xlink:href="#iconGithub"></use></svg>
    <div>
        ${window.siyuan.languages.bazaarTrustOpenSource}
        <div class="b3-label__text">${window.siyuan.languages.bazaarTrustOpenSourceTip}</div>
    </div>
</div>
<div class="fn__flex b3-label">
    <svg class="b3-label__icon"><use xlink:href="#iconUsers"></use></svg>
    <div>
        ${window.siyuan.languages.bazaarCommunityReview}
        <div class="b3-label__text">${window.siyuan.languages.bazaarPeerReviewTip}</div>
    </div>
</div>
<div class="fn__flex b3-label">
    <svg class="b3-label__icon"><use xlink:href="#iconInfo"></use></svg>
    <div>
        ${window.siyuan.languages.bazaarUserReport}
        <div class="b3-label__text">${window.siyuan.languages.bazaarUserReportTip}</div>
    </div>
</div>
<div class="b3-label b3-label--noborder">
    <div>${window.siyuan.languages.bazaarTrust1}</div>
    <div class="fn__hr--b"></div>
    <diiv>${window.siyuan.languages.bazaarTrust2}</diiv>
</div>
<div class="ft__center b3-label b3-label--noborder">
    <button class="b3-button fn__size200">${window.siyuan.languages.trust}</button>
</div>
<div class="fn__flex-1"></div>
</div>`;const t=window.siyuan.storage[u.LOCAL_BAZAAR],e=`<div style="height: ${be.element.clientHeight-80}px;display: flex;align-items: center;justify-content: center;"><img src="/stage/loading-pure.svg"></div>`;return`<div class="fn__flex-column" style="height: 100%">
<div class="layout-tab-bar fn__flex">
    <div data-type="downloaded" class="item item--full item--focus"><span class="fn__flex-1"></span><span class="item__text">${window.siyuan.languages.downloaded}</span><span class="fn__flex-1"></span></div>
    <div data-type="plugin" class="item item--full"><span class="fn__flex-1"></span><span class="item__text">${window.siyuan.languages.plugin}</span><span class="fn__flex-1"></span></div>
    <div data-type="theme" class="item item--full"><span class="fn__flex-1"></span><span class="item__text">${window.siyuan.languages.theme}</span><span class="fn__flex-1"></span></div>
    <div data-type="icon" class="item item--full"><span class="fn__flex-1"></span><span class="item__text">${window.siyuan.languages.icon}</span><span class="fn__flex-1"></span></div>
    <div data-type="template" class="item item--full"><span class="fn__flex-1"></span><span class="item__text">${window.siyuan.languages.template}</span><span class="fn__flex-1"></span></div>
    <div data-type="widget" class="item item--full"><span class="fn__flex-1"></span><span class="item__text">${window.siyuan.languages.widget}</span><span class="fn__flex-1"></span></div>
</div>
<div class="fn__flex-1">
    <div class="config-bazaar__panel" data-type="downloaded" data-init="true">
        <div data-type="downloaded-update"></div>
        <div class="fn__flex config-bazaar__title">
            <button data-type="myPlugin" class="b3-button">${window.siyuan.languages.plugin}</button>
            <div class="fn__space"></div>
            <button data-type="myTheme" class="b3-button b3-button--outline">${window.siyuan.languages.theme}</button>
            <div class="fn__space"></div>
            <button data-type="myIcon" class="b3-button b3-button--outline">${window.siyuan.languages.icon}</button>
            <div class="fn__space"></div>
            <button data-type="myTemplate" class="b3-button b3-button--outline">${window.siyuan.languages.template}</button>
            <div class="fn__space"></div>
            <button data-type="myWidget" class="b3-button b3-button--outline">${window.siyuan.languages.widget}</button>
            <div class="fn__space"></div>
            <div class="b3-form__icon">
                <svg class="b3-form__icon-icon"><use xlink:href="#iconSearch"></use></svg>
                <input class="b3-text-field b3-form__icon-input fn__block" placeholder="${window.siyuan.languages.enterKey} ${window.siyuan.languages.search}">
            </div>
            <div class="fn__space"></div>
            <div class="fn__flex-1"></div>
            <input ${window.siyuan.config.bazaar.petalDisabled?"":" checked"} data-type="plugins-enable" type="checkbox" class="b3-switch fn__flex-center" style="margin-right: 8px">
            <div class="counter counter--bg fn__none fn__flex-center b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.total}"></div>
        </div>
        <div id="configBazaarDownloaded" class="config-bazaar__content">
            ${e}
        </div>
    </div>
    <div data-type="theme" class="config-bazaar__panel fn__none">
        <div class="fn__flex config-bazaar__title">
            <svg class="svg ft__on-surface fn__flex-center"><use xlink:href="#iconSort"></use></svg>
            <div class="fn__space"></div>
            <select class="b3-select">
                <option ${t.theme==="0"?"selected":""} value="0">${window.siyuan.languages.sortByUpdateTimeDesc}</option>
                <option ${t.theme==="1"?"selected":""} value="1">${window.siyuan.languages.sortByUpdateTimeAsc}</option>
                <option ${t.theme==="2"?"selected":""} value="2">${window.siyuan.languages.sortByDownloadsDesc}</option>
                <option ${t.theme==="3"?"selected":""} value="3">${window.siyuan.languages.sortByDownloadsAsc}</option>
            </select>
            <div class="fn__space"></div>
            <select id="bazaarSelect" class="b3-select">
                <option selected value="2">${window.siyuan.languages.all}</option>
                <option value="0">${window.siyuan.languages.themeLight}</option>
                <option value="1">${window.siyuan.languages.themeDark}</option>
            </select>
            <div class="fn__space"></div>
            <div class="b3-form__icon">
                <svg class="b3-form__icon-icon"><use xlink:href="#iconSearch"></use></svg>
                <input class="b3-text-field b3-form__icon-input fn__block" placeholder="${window.siyuan.languages.enterKey} ${window.siyuan.languages.search}">
            </div>
            <div class="fn__space"></div>
            <div class="fn__flex-1"></div>
            <div class="counter counter--bg fn__flex-center b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.total}"></div>
        </div>
        <div id="configBazaarTheme" class="config-bazaar__content">
            ${e}
        </div>
    </div>
    <div class="fn__none config-bazaar__panel" data-type="template">
        <div class="fn__flex config-bazaar__title">
            <svg class="svg ft__on-surface fn__flex-center"><use xlink:href="#iconSort"></use></svg>
            <div class="fn__space"></div>
            <select class="b3-select">
                <option ${t.template==="0"?"selected":""} value="0">${window.siyuan.languages.sortByUpdateTimeDesc}</option>
                <option ${t.template==="1"?"selected":""} value="1">${window.siyuan.languages.sortByUpdateTimeAsc}</option>
                <option ${t.template==="2"?"selected":""} value="2">${window.siyuan.languages.sortByDownloadsDesc}</option>
                <option ${t.template==="3"?"selected":""} value="3">${window.siyuan.languages.sortByDownloadsAsc}</option>
            </select>
            <div class="fn__space"></div>
            <div class="b3-form__icon">
                <svg class="b3-form__icon-icon"><use xlink:href="#iconSearch"></use></svg>
                <input class="b3-text-field b3-form__icon-input fn__block" placeholder="${window.siyuan.languages.enterKey} ${window.siyuan.languages.search}">
            </div>
            <div class="fn__space"></div>
            <div class="fn__flex-1"></div>
            <div class="counter counter--bg fn__flex-center b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.total}"></div>
        </div>
        <div id="configBazaarTemplate" class="config-bazaar__content">
            ${e}
        </div>
    </div>
    <div class="fn__none config-bazaar__panel" data-type="plugin">
        <div class="fn__flex config-bazaar__title">
            <svg class="svg ft__on-surface fn__flex-center"><use xlink:href="#iconSort"></use></svg>
            <div class="fn__space"></div>
            <select class="b3-select">
                <option ${t.plugin==="0"?"selected":""} value="0">${window.siyuan.languages.sortByUpdateTimeDesc}</option>
                <option ${t.plugin==="1"?"selected":""} value="1">${window.siyuan.languages.sortByUpdateTimeAsc}</option>
                <option ${t.plugin==="2"?"selected":""} value="2">${window.siyuan.languages.sortByDownloadsDesc}</option>
                <option ${t.plugin==="3"?"selected":""} value="3">${window.siyuan.languages.sortByDownloadsAsc}</option>
            </select>
            <div class="fn__space"></div>
            <div class="b3-form__icon">
                <svg class="b3-form__icon-icon"><use xlink:href="#iconSearch"></use></svg>
                <input class="b3-text-field b3-form__icon-input fn__block" placeholder="${window.siyuan.languages.enterKey} ${window.siyuan.languages.search}">
            </div>
            <div class="fn__space"></div>
            <div class="fn__flex-1"></div>
            <div class="counter counter--bg fn__flex-center b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.total}"></div>
        </div>
        <div id="configBazaarPlugin" class="config-bazaar__content">
            ${e}
        </div>
    </div>
    <div class="fn__none config-bazaar__panel" data-type="icon">
        <div class="fn__flex config-bazaar__title">
            <svg class="svg ft__on-surface fn__flex-center"><use xlink:href="#iconSort"></use></svg>
            <div class="fn__space"></div>
            <select class="b3-select">
                <option ${t.icon==="0"?"selected":""} value="0">${window.siyuan.languages.sortByUpdateTimeDesc}</option>
                <option ${t.icon==="1"?"selected":""} value="1">${window.siyuan.languages.sortByUpdateTimeAsc}</option>
                <option ${t.icon==="2"?"selected":""} value="2">${window.siyuan.languages.sortByDownloadsDesc}</option>
                <option ${t.icon==="3"?"selected":""} value="3">${window.siyuan.languages.sortByDownloadsAsc}</option>
            </select>
            <div class="fn__space"></div>
            <div class="b3-form__icon">
                <svg class="b3-form__icon-icon"><use xlink:href="#iconSearch"></use></svg>
                <input class="b3-text-field b3-form__icon-input fn__block" placeholder="${window.siyuan.languages.enterKey} ${window.siyuan.languages.search}">
            </div>
            <div class="fn__space"></div>
            <div class="fn__flex-1"></div>
            <div class="counter counter--bg fn__flex-center b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.total}"></div>
        </div>
        <div id="configBazaarIcon" class="config-bazaar__content">
            ${e}
        </div>
    </div>
    <div class="fn__none config-bazaar__panel" data-type="widget">
        <div class="fn__flex config-bazaar__title">
            <svg class="svg ft__on-surface fn__flex-center"><use xlink:href="#iconSort"></use></svg>
            <div class="fn__space"></div>
            <select class="b3-select">
                <option ${t.widget==="0"?"selected":""} value="0">${window.siyuan.languages.sortByUpdateTimeDesc}</option>
                <option ${t.widget==="1"?"selected":""} value="1">${window.siyuan.languages.sortByUpdateTimeAsc}</option>
                <option ${t.widget==="2"?"selected":""} value="2">${window.siyuan.languages.sortByDownloadsDesc}</option>
                <option ${t.widget==="3"?"selected":""} value="3">${window.siyuan.languages.sortByDownloadsAsc}</option>
            </select>
            <div class="fn__space"></div>
            <div class="b3-form__icon">
                <svg class="b3-form__icon-icon"><use xlink:href="#iconSearch"></use></svg>
                <input class="b3-text-field b3-form__icon-input fn__block" placeholder="${window.siyuan.languages.enterKey} ${window.siyuan.languages.search}">
            </div>
            <div class="fn__space"></div>
            <div class="fn__flex-1"></div>
            <div class="counter counter--bg fn__flex-center b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.total}"></div>
        </div>
        <div id="configBazaarWidget" class="config-bazaar__content">
            ${e}
        </div>
    </div>
</div>
<div id="configBazaarReadme" class="config-bazaar__readme"></div>
</div>`},_genCardHTML(t,e){let n=!1,a="";if(e==="themes"){const o=be.element.querySelector("#bazaarSelect").value;(o==="0"&&t.modes.includes("dark")||o==="1"&&t.modes.includes("light"))&&(n=!0),a=t.modes.toString()}let i=!1;["icons","themes"].includes(e)&&(i=!0);const s={bazaarType:e,themeMode:a,updated:t.updated,name:t.name,repoURL:t.repoURL,repoHash:t.repoHash,downloads:t.downloads,downloaded:!1};return`<div data-obj='${JSON.stringify(s)}' class="b3-card b3-card--wrap${n?" fn__none":""}${t.current?" b3-card--current":""}">
    <div class="b3-card__img">
        <img src="${t.iconURL}" onerror="this.src='/stage/images/icon.png'"/>
    </div>
    <div class="fn__flex-1 fn__flex-column">
        <div class="b3-card__info fn__flex-1">
            ${t.preferredName} <span class="ft__on-surface ft__smaller">${t.name}</span>
            <div class="b3-card__desc" title="${Xe(t.preferredDesc)||""}">
                ${t.preferredDesc||""}
            </div>
        </div>
        <div class="b3-card__actions">
            <span class="block__icon block__icon--show ft__primary">
                <svg><use xlink:href="#iconDownload"></use></svg>
                <span class="fn__space"></span>
                ${t.downloads}
            </span>
            <span class="fn__space"></span>
            ${t.preferredFunding?`<a target="_blank" href="${t.preferredFunding}" class="block__icon block__icon--show ariaLabel" aria-label="${window.siyuan.languages.sponsor} ${t.preferredFunding}"><svg class="ft__pink"><use xlink:href="#iconHeart"></use></svg></a><span class="fn__space"></span>`:""}
            <div class="fn__flex-1"></div>
            <span class="b3-tooltips b3-tooltips__nw block__icon block__icon--show${t.installed?"":" fn__none"}" data-type="uninstall" aria-label="${window.siyuan.languages.uninstall}">
                <svg><use xlink:href="#iconTrashcan"></use></svg>
            </span>
            <div class="fn__space${!t.current&&t.installed&&i?"":" fn__none"}"></div>
            <span class="b3-tooltips b3-tooltips__nw block__icon block__icon--show${!t.current&&t.installed&&i?"":" fn__none"}" data-type="switch" aria-label="${window.siyuan.languages.use}">
                <svg><use xlink:href="#iconSelect"></use></svg>
            </span>
            <div class="fn__space${t.outdated?"":" fn__none"}"></div>
            <span data-type="install-t" class="b3-tooltips b3-tooltips__nw block__icon block__icon--show${t.outdated?"":" fn__none"}" aria-label="${window.siyuan.languages.update}">
                <svg class="ft__primary"><use xlink:href="#iconRefresh"></use></svg>
            </span>
        </div>
    </div>
</div>`},_genUpdateItemHTML(t,e){const n={bazaarType:e,themeMode:t.modes?.toString(),updated:t.updated,name:t.name,repoURL:t.repoURL,repoHash:t.repoHash,downloaded:!0};return`<div class="b3-card" data-obj='${JSON.stringify(n)}'>
    <div class="b3-card__img"><img src="${t.iconURL}" onerror="this.src='/stage/images/icon.png'"/></div>
    <div class="fn__flex-1 fn__flex-column">
        <div class="b3-card__info b3-card__info--left fn__flex-1">
            ${t.preferredName} <span class="ft__on-surface ft__smaller">${t.name}</span>
            <div class="b3-card__desc" title="${Xe(t.preferredDesc)||""}">${t.preferredDesc||""}</div>
        </div>
    </div>
    <div class="b3-card__actions b3-card__actions--right">
        ${t.incompatible?`<span class="fn__space"></span><span class="fn__flex-center b3-tooltips b3-tooltips__nw b3-chip b3-chip--error b3-chip--small" aria-label="${window.siyuan.languages.incompatiblePluginTip}">${window.siyuan.languages.incompatible}</span>`:""}
        ${t.preferredFunding?`<a target="_blank" href="${t.preferredFunding}" class="block__icon block__icon--show ariaLabel" aria-label="${window.siyuan.languages.sponsor} ${t.preferredFunding}"><svg class="ft__pink"><use xlink:href="#iconHeart"></use></svg></a>`:""}
        <span class="b3-tooltips b3-tooltips__nw block__icon block__icon--show${pt()?" fn__none":""}" data-type="open" aria-label="${window.siyuan.languages.showInFolder}">
            <svg><use xlink:href="#iconFolder"></use></svg>
        </span>
        <span data-type="install-t" aria-label="${window.siyuan.languages.update}" class="b3-tooltips b3-tooltips__nw block__icon block__icon--show">
            <svg class="ft__primary"><use xlink:href="#iconRefresh"></use></svg>
        </span>
    </div>
</div>`},_getUpdate(){E("/api/bazaar/getUpdatedPackage",{frontend:xt()},t=>{let e="";t.data.plugins.forEach(a=>{e+=this._genUpdateItemHTML(a,"plugins")}),t.data.themes.forEach(a=>{e+=this._genUpdateItemHTML(a,"themes")}),t.data.icons.forEach(a=>{e+=this._genUpdateItemHTML(a,"icons")}),t.data.templates.forEach(a=>{e+=this._genUpdateItemHTML(a,"templates")}),t.data.widgets.forEach(a=>{e+=this._genUpdateItemHTML(a,"widgets")}),this._data.update=t.data;const n=t.data.themes.length+t.data.icons.length+t.data.widgets.length+t.data.plugins.length+t.data.templates.length;if(n===0){this.element.querySelector('[data-type="downloaded-update"]').innerHTML="";return}this.element.querySelector('[data-type="downloaded-update"]').innerHTML=`<div class="fn__flex config-bazaar__title">
    <div class="fn__flex-1"></div>
    <button class="b3-button" data-type="install-all">${window.siyuan.languages.updateAll}</button>
    <span class="fn__space"></span>
    <div class="counter counter--bg fn__flex-center">${n}</div>
</div>
<div class="config-bazaar__content">${e}</div>`})},_genMyHTML(t,e,n=!0){n&&this._getUpdate();const a=be.element.querySelector("#configBazaarDownloaded");if(a.getAttribute("data-loading")==="true"||a.previousElementSibling.querySelector(`[data-type="my${t.replace(t[0],t[0].toUpperCase()).substring(0,t.length-1)}"]`).classList.contains("b3-button--outline"))return;a.setAttribute("data-loading","true");let i="/api/bazaar/getInstalledTheme";t==="icons"?i="/api/bazaar/getInstalledIcon":t==="widgets"?i="/api/bazaar/getInstalledWidget":t==="templates"?i="/api/bazaar/getInstalledTemplate":t==="plugins"&&(i="/api/bazaar/getInstalledPlugin"),E(i,{frontend:xt(),keyword:a.previousElementSibling.querySelector(".b3-text-field")?.value||""},s=>{a.removeAttribute("data-loading");let o="",l=!1;["icons","themes"].includes(t)&&(l=!0);const r=a.previousElementSibling.querySelector(".counter");s.data.packages.length===0?r.classList.add("fn__none"):(r.classList.remove("fn__none"),r.textContent=s.data.packages.length,s.data.packages.forEach(c=>{const f={bazaarType:t,themeMode:c.modes?.toString(),updated:c.updated,name:c.name,repoURL:c.repoURL,repoHash:c.repoHash,downloaded:!0};let g=!1;t==="plugins"&&e.plugins.find(p=>{if(p.name===f.name)return g=p.setting||p.__proto__.hasOwnProperty("openSetting"),!0}),o+=`<div data-obj='${JSON.stringify(f)}' class="b3-card${c.current?" b3-card--current":""}${window.siyuan.config.bazaar.petalDisabled&&t==="plugins"?" b3-card--disabled":""}">
    <div class="b3-card__img"><img src="${c.iconURL}" onerror="this.src='/stage/images/icon.png'"/></div>
    <div class="fn__flex-1 fn__flex-column">
        <div class="b3-card__info b3-card__info--left fn__flex-1">
            ${c.preferredName} <span class="ft__on-surface ft__smaller">${c.name}</span>
            <div class="b3-card__desc" title="${Xe(c.preferredDesc)||""}">${c.preferredDesc||""}</div>
        </div>
    </div>
    <div class="b3-card__actions b3-card__actions--right">
        ${c.incompatible?`<span class="fn__space"></span><span class="fn__flex-center b3-tooltips b3-tooltips__nw b3-chip b3-chip--error b3-chip--small" aria-label="${window.siyuan.languages.incompatiblePluginTip}">${window.siyuan.languages.incompatible}</span>`:""}
        ${c.preferredFunding?`<a target="_blank" href="${c.preferredFunding}" class="block__icon block__icon--show ariaLabel" aria-label="${window.siyuan.languages.sponsor} ${c.preferredFunding}"><svg class="ft__pink"><use xlink:href="#iconHeart"></use></svg></a>`:""}
        <span class="b3-tooltips b3-tooltips__nw block__icon block__icon--show${g?"":" fn__none"}" data-type="setting" aria-label="${window.siyuan.languages.config}">
            <svg><use xlink:href="#iconSettings"></use></svg>
        </span>
        <span class="b3-tooltips b3-tooltips__nw block__icon block__icon--show" data-type="uninstall" aria-label="${window.siyuan.languages.uninstall}">
            <svg><use xlink:href="#iconTrashcan"></use></svg>
        </span>
        <span class="b3-tooltips b3-tooltips__nw block__icon block__icon--show${pt()?" fn__none":""}" data-type="open" aria-label="${window.siyuan.languages.showInFolder}">
            <svg><use xlink:href="#iconFolder"></use></svg>
        </span>
        <span class="b3-tooltips b3-tooltips__nw block__icon block__icon--show${!c.current&&l?"":" fn__none"}" data-type="switch" aria-label="${window.siyuan.languages.use}">
            <svg><use xlink:href="#iconSelect"></use></svg>
        </span>
        <span data-type="install-t" aria-label="${window.siyuan.languages.update}" class="b3-tooltips b3-tooltips__nw block__icon block__icon--show${c.outdated?"":" fn__none"}">
            <svg class="ft__primary"><use xlink:href="#iconRefresh"></use></svg>
        </span>
        <span class="fn__space${t==="plugins"?"":" fn__none"}"></span>
        <span class="fn__space${t==="plugins"?"":" fn__none"}"></span>
        <input class="b3-switch fn__flex-center${t==="plugins"?"":" fn__none"}" ${c.enabled?"checked":""} data-type="plugin-enable" type="checkbox" ${c.incompatible?" disabled":""}>
    </div>
</div>`})),be._data.downloaded=s.data.packages;const d=a.parentElement.querySelector(".b3-switch");t==="plugins"?d.classList.remove("fn__none"):d.classList.add("fn__none"),a.innerHTML=o||`<div class="fn__hr"></div><ul class="b3-list b3-list--background"><li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li></ul>`})},_data:{themes:[],templates:[],icons:[],widgets:[],plugins:[],downloaded:[],update:{themes:[],templates:[],icons:[],widgets:[],plugins:[]}},_renderReadme(t,e){const n=JSON.parse(t.getAttribute("data-obj"));let a;B(t,"data-type","downloaded-update")?a=be._data.update[e].find(r=>r.repoURL===n.repoURL):a=(n.downloaded?be._data.downloaded:be._data[e]).find(r=>r.repoURL===n.repoURL);const i=be.element.querySelector("#configBazaarReadme"),s=a.repoURL.split("/");s.pop();let o=window.siyuan.languages.icon;e==="themes"?o=window.siyuan.languages.theme:e==="widgets"?o=window.siyuan.languages.widget:e==="templates"?o=window.siyuan.languages.template:e==="plugins"&&(o=window.siyuan.languages.plugin);const l={bazaarType:e,themeMode:a.modes?.toString(),name:a.name,repoURL:a.repoURL,repoHash:a.repoHash,downloaded:!0};if(i.innerHTML=` <div class="item__side" data-obj='${JSON.stringify(l)}'>
    <div class="fn__flex">
        <div style="padding-right: 8px" class="block__icon block__icon--show b3-tooltips b3-tooltips__e" data-type="goBack" aria-label="${window.siyuan.languages.back}">
            <svg><use xlink:href="#iconLeft"></use></svg>
            <span class="fn__space"></span>
            ${o}
        </div>
    </div>
    <img class="item__img" src="${a.iconURL}" onerror="this.src='/stage/images/icon.png'">
    <div>
        <a href="${a.repoURL}" target="_blank" class="item__title" title="GitHub Repo">${a.preferredName}</a>
    </div>
    <div class="fn__hr"></div>
    <div>
        <a href="${a.repoURL}" target="_blank" class="ft__on-surface ft__smaller" title="GitHub Repo">${a.name}</a>
    </div>
    <div class="block__icons">
        <span class="fn__flex-1"></span>
        ${a.preferredFunding?`<a target="_blank" href="${a.preferredFunding}" class="block__icon block__icon--show ariaLabel" aria-label="${window.siyuan.languages.sponsor} ${a.preferredFunding}"><svg class="ft__pink"><use xlink:href="#iconHeart"></use></svg></a>`:`<span class="b3-tooltips b3-tooltips__ne block__icon block__icon--show ft__primary" aria-label="${window.siyuan.languages.author}"><svg><use xlink:href="#iconAccount"></use></svg></span>`}
        <span class="fn__space"></span>
        <a href="${s.join("/")}" target="_blank" title="Creator">${a.author}</a>
        <span class="fn__flex-1"></span>
    </div>
    <div class="fn__hr--b"></div>
    <div class="fn__hr--b"></div>
    <div class="ft__on-surface ft__smaller" style="line-height: 20px;">${window.siyuan.languages.currentVer}<br>v${a.version}</div>
    <div class="fn__hr"></div>
    <div class="ft__on-surface ft__smaller" style="line-height: 20px;">${n.downloaded?window.siyuan.languages.installDate:window.siyuan.languages.releaseDate}<br>${n.downloaded?a.hInstallDate:a.hUpdated}</div>
    <div class="fn__hr${n.downloaded?" fn__none":""}"></div>
    <div class="ft__on-surface ft__smaller${n.downloaded?" fn__none":""}" style="line-height: 20px;">${window.siyuan.languages.pkgSize}<br>${a.hSize}</div>
    <div class="fn__hr"></div>
    <div class="ft__on-surface ft__smaller" style="line-height: 20px;">${window.siyuan.languages.installSize}<br>${a.hInstallSize}</div>
    <div class="fn__hr--b"></div>
    <div class="fn__hr--b"></div>
    <div${a.installed||n.downloaded?' class="fn__none"':""}>
        <button class="b3-button" style="width: 168px"  data-type="install">${window.siyuan.languages.download}</button>
    </div>
    <div${a.outdated&&(a.installed||n.downloaded)?"":' class="fn__none"'}>
        <button class="b3-button" style="width: 168px" data-type="install-t">${window.siyuan.languages.update}</button>
    </div>
    <div class="fn__hr--b"></div>
    <div>
        <a href="${a.repoURL}/issues" target="_blank" title="Feedback via GitHub Issues" class="b3-button b3-button--success" style="width: 168px" data-type="feedback">${window.siyuan.languages.feedback}</a>
    </div>
    <div class="fn__hr--b${n.downloaded?" fn__none":""}"></div>
    <div class="fn__hr--b${n.downloaded?" fn__none":""}"></div>
    <div class="fn__flex${n.downloaded?" fn__none":""}" style="justify-content: center;">
        <svg class="svg ft__on-surface fn__flex-center"><use xlink:href="#iconGithub"></use></svg>
        <span class="fn__space"></span>
        <a href="${a.repoURL}" target="_blank" title="GitHub Repo">Repo</a>
        <span class="fn__space"></span>
        <span class="fn__space"></span>
        <svg class="svg ft__on-surface fn__flex-center"><use xlink:href="#iconStar"></use></svg>
        <span class="fn__space"></span>
        <a href="${a.repoURL}/stargazers" target="_blank" title="Stars">${a.stars}</a>
        <span class="fn__space"></span>
        <span class="fn__space"></span>
        <svg class="svg ft__on-surface fn__flex-center"><use xlink:href="#iconGitHubI"></use></svg>
        <span class="fn__space"></span>
        <a href="${a.repoURL}/issues" target="_blank" title="Open issues">${a.openIssues}</a>
        <span class="fn__space"></span>
        <span class="fn__space"></span>
        <svg class="svg ft__on-surface fn__flex-center"><use xlink:href="#iconDownload"></use></svg>
        <span class="fn__space"></span>
        ${a.downloads}
    </div>
    <div class="fn__hr--b"></div>
    <div class="fn__hr--b"></div>
    <div class="fn__flex-1"></div>
</div>
<div class="item__main">
    <div class="item__preview" style="background-image: url(${a.previewURL})"></div>
    <div class="b3-typography${a.preferredDesc?"":" fn__none"}">
        <blockquote>
            <p>
                ${a.preferredDesc||""}
            </p>
         </blockquote>
    </div>
    <div class="item__readme b3-typography b3-typography--default">
        <img data-type="img-loading" style="height: 64px;width: 100%;padding: 16px 0;" src="/stage/loading-pure.svg">
    </div>
</div>`,n.downloaded){const r=i.querySelector(".item__readme");r.innerHTML=a.preferredReadme,ze(r)}else E("/api/bazaar/getBazaarPackageREAME",{repoURL:a.repoURL,repoHash:a.repoHash,packageType:e},r=>{const d=i.querySelector(".item__readme");d.innerHTML=r.data.html,ze(d)});i.classList.add("config-bazaar__readme--show")},bindEvent(t){if(!window.siyuan.config.bazaar.trust){be.element.querySelector("button").addEventListener("click",()=>{E("/api/setting/setBazaar",{trust:!0,petalDisabled:window.siyuan.config.bazaar.petalDisabled},()=>{window.siyuan.config.bazaar.trust=!0,be.element.innerHTML=be.genHTML(),be.bindEvent(t)})});return}this._genMyHTML("plugins",t),be.element.firstElementChild.addEventListener("click",e=>{let n=e.target;const a=B(n,"data-obj",null);let i;for(a&&(i=JSON.parse(a.getAttribute("data-obj")));n&&!n.isEqualNode(be.element);){const s=n.getAttribute("data-type");if(n.tagName==="A")break;if(s==="open"&&i){const o=i.bazaarType;o==="icons"||o==="themes"?ee.shell.openPath(Ft.join(window.siyuan.config.system.confDir,"appearance",o,i.name)):ee.shell.openPath(Ft.join(window.siyuan.config.system.dataDir,o,i.name)),e.preventDefault(),e.stopPropagation();break}else if(["myTheme","myTemplate","myIcon","myWidget","myPlugin"].includes(s)){n.classList.contains("b3-button--outline")&&!be.element.querySelector("#configBazaarDownloaded").getAttribute("data-loading")&&(n.parentElement.childNodes.forEach(o=>{o.nodeType!==3&&o.classList.contains("b3-button")&&o.classList.add("b3-button--outline")}),n.classList.remove("b3-button--outline"),this._genMyHTML(s.replace("my","").toLowerCase()+"s",t,!1)),e.preventDefault(),e.stopPropagation();break}else if(s==="goBack"){be.element.querySelector("#configBazaarReadme").classList.remove("config-bazaar__readme--show"),e.preventDefault(),e.stopPropagation();break}else if(s==="install"){if(!n.classList.contains("b3-button--progress")){const o=i.bazaarType;let l="/api/bazaar/installBazaarTemplate";o==="themes"?l="/api/bazaar/installBazaarTheme":o==="icons"?l="/api/bazaar/installBazaarIcon":o==="widgets"?l="/api/bazaar/installBazaarWidget":o==="plugins"&&(l="/api/bazaar/installBazaarPlugin"),E(l,{keyword:be.element.querySelector(".config-bazaar__panel:not(.fn__none) .b3-form__icon-input").value,repoURL:i.repoURL,packageName:i.name,repoHash:i.repoHash,mode:i.themeMode==="dark"?1:0,frontend:xt()},async r=>{if(window.siyuan.config.appearance.themeJS&&o==="themes")if(window.destroyTheme){try{await window.destroyTheme(),window.destroyTheme=void 0,document.getElementById("themeScript").remove()}catch(d){console.error("destroyTheme error: "+d)}window.siyuan.config.appearance=r.data.appearance,tp(window.siyuan.config.appearance)}else{Xt({cb(){window.location.reload()},errorExit:!1});return}be._onBazaar(r,o,["themes","icons"].includes(o)),be._genMyHTML(o,t,!1),o==="plugins"&&(window.siyuan.config.bazaar.petalDisabled?xe(window.siyuan.languages.confirm,window.siyuan.languages.enablePluginTip2):xe("\u{1F4A1} "+window.siyuan.languages.enablePlugin,window.siyuan.languages.enablePluginTip,()=>{E("/api/petal/setPetalEnabled",{packageName:i.name,enabled:!0,frontend:xt()},d=>{mk(t,d.data),be._genMyHTML(o,t,!1)})}))})}e.preventDefault(),e.stopPropagation();break}else if(s==="install-all"){xe("\u2B06\uFE0F "+window.siyuan.languages.updateAll,window.siyuan.languages.confirmUpdateAll,()=>{E("/api/bazaar/batchUpdatePackage",{frontend:xt()})}),e.preventDefault(),e.stopPropagation();break}else if(s==="feedback"){e.preventDefault(),e.stopPropagation();break}else if(s==="install-t"){n.classList.contains("b3-button--progress")||xe("\u2B06\uFE0F "+window.siyuan.languages.update,window.siyuan.languages.confirmUpdate,()=>{const o=i.bazaarType;let l="/api/bazaar/installBazaarTemplate";o==="themes"?l="/api/bazaar/installBazaarTheme":o==="icons"?l="/api/bazaar/installBazaarIcon":o==="widgets"?l="/api/bazaar/installBazaarWidget":o==="plugins"&&(l="/api/bazaar/installBazaarPlugin"),n.classList.contains("b3-button")||n.parentElement.insertAdjacentHTML("afterend",'<img data-type="img-loading" style="position: absolute;top: 0;left: 0;height: 100%;width: 100%;padding: 16px;box-sizing: border-box;" src="/stage/loading-pure.svg">'),E(l,{keyword:be.element.querySelector(".config-bazaar__panel:not(.fn__none) .b3-form__icon-input").value,repoURL:i.repoURL,packageName:i.name,repoHash:i.repoHash,mode:i.themeMode==="dark"?1:0,update:!0,frontend:xt()},async r=>{if(this._genMyHTML(o,t),be._onBazaar(r,o,["icons"].includes(o)),o==="themes"&&(window.siyuan.config.appearance.mode===0&&window.siyuan.config.appearance.themeLight===i.name||window.siyuan.config.appearance.mode===1&&window.siyuan.config.appearance.themeDark===i.name)){const d=window.siyuan.config.appearance.mode===1?window.siyuan.config.appearance.themeDark:window.siyuan.config.appearance.themeLight;if(window.siyuan.config.appearance.themeJS)if(window.destroyTheme)try{await window.destroyTheme(),window.destroyTheme=void 0,document.getElementById("themeScript").remove(),Ct(`/appearance/themes/${d}/theme.js?v=${r.data.appearance.themeVer}`,"themeScript")}catch(c){console.error("destroyTheme error: "+c)}else{Xt({cb(){window.location.reload()},errorExit:!1});return}window.siyuan.config.appearance.mode===1&&d==="midnight"||window.siyuan.config.appearance.mode!==1&&d==="daylight"?document.getElementById("themeDefaultStyle").href=`/appearance/themes/${window.siyuan.config.appearance.mode===1?"midnight":"daylight"}/theme.css?v=${u.SIYUAN_VERSION}`:document.getElementById("themeStyle").href=`/appearance/themes/${d}/theme.css?v=${r.data.appearance.themeVer}`}})}),e.preventDefault(),e.stopPropagation();break}else if(s==="uninstall"){const o=i.bazaarType;let l="/api/bazaar/uninstallBazaarTemplate";o==="themes"?l="/api/bazaar/uninstallBazaarTheme":o==="icons"?l="/api/bazaar/uninstallBazaarIcon":o==="widgets"?l="/api/bazaar/uninstallBazaarWidget":o==="plugins"&&(l="/api/bazaar/uninstallBazaarPlugin");const r=i.name;window.siyuan.config.appearance.themeDark===r||window.siyuan.config.appearance.themeLight===r||window.siyuan.config.appearance.icon===r?j(window.siyuan.languages.uninstallTip):xe("\u26A0\uFE0F "+window.siyuan.languages.uninstall,window.siyuan.languages.confirmUninstall.replace("${name}",r),()=>{E(l,{packageName:r,keyword:be.element.querySelector(".config-bazaar__panel:not(.fn__none) .b3-form__icon-input").value,frontend:xt()},d=>{this._genMyHTML(o,t),be._onBazaar(d,o,["themes","icons"].includes(o)),o==="plugins"&&Pp(t,r,!0)})}),e.preventDefault(),e.stopPropagation();break}else if(s==="switch"){const o=i.bazaarType,l=i.name,r=i.themeMode==="dark"?1:0;o==="icons"?E("/api/setting/setAppearance",Object.assign({},window.siyuan.config.appearance,{icon:l}),d=>{this._genMyHTML(o,t,!1),E("/api/bazaar/getBazaarIcon",{},c=>{c.data.appearance=d.data,be._onBazaar(c,"icons",!0),be._data.icons=c.data.packages})}):o==="themes"&&E("/api/setting/setAppearance",Object.assign({},window.siyuan.config.appearance,{mode:r,modeOS:!1,themeDark:r===1?l:window.siyuan.config.appearance.themeDark,themeLight:r===0?l:window.siyuan.config.appearance.themeLight}),async d=>{if((r!==window.siyuan.config.appearance.mode||r===1&&window.siyuan.config.appearance.themeDark!==l||r===0&&window.siyuan.config.appearance.themeLight!==l)&&window.siyuan.config.appearance.themeJS)if(window.destroyTheme){try{await window.destroyTheme(),window.destroyTheme=void 0,document.getElementById("themeScript").remove()}catch(c){console.error("destroyTheme error: "+c)}window.siyuan.config.appearance=d.data,tp(window.siyuan.config.appearance)}else{Xt({cb(){window.location.reload()},errorExit:!1});return}this._genMyHTML("themes",t,!1),E("/api/bazaar/getBazaarTheme",{},c=>{c.data.appearance=d.data,be._onBazaar(c,"themes",!0),be._data.themes=c.data.packages})}),e.preventDefault(),e.stopPropagation();break}else if(s==="setting"){t.plugins.find(o=>{if(o.name===i.name)return o.openSetting(),!0}),e.preventDefault(),e.stopPropagation();break}else if(s==="plugins-enable"){n.getAttribute("disabled")||(n.setAttribute("disabled","disabled"),window.siyuan.config.bazaar.petalDisabled=!n.checked,E("/api/setting/setBazaar",window.siyuan.config.bazaar,()=>{n.removeAttribute("disabled"),window.siyuan.config.bazaar.petalDisabled?be.element.querySelectorAll("#configBazaarDownloaded .b3-card").forEach(o=>{o.classList.add("b3-card--disabled"),Pp(t,JSON.parse(o.getAttribute("data-obj")).name)}):(be.element.querySelectorAll("#configBazaarDownloaded .b3-card").forEach(o=>{o.classList.remove("b3-card--disabled")}),Mb(t).then(()=>{t.plugins.forEach(o=>{Np(o)})}),dn())})),e.stopPropagation();break}else if(s==="plugin-enable"){if(!n.getAttribute("disabled")){n.setAttribute("disabled","disabled");const o=n.checked;E("/api/petal/setPetalEnabled",{packageName:i.name,enabled:o,frontend:xt()},l=>{n.removeAttribute("disabled"),o?mk(t,l.data).then(r=>{r.setting||r.__proto__.hasOwnProperty("openSetting")?n.parentElement.querySelector('[data-type="setting"]').classList.remove("fn__none"):n.parentElement.querySelector('[data-type="setting"]').classList.add("fn__none")}):(Pp(t,i.name),n.parentElement.querySelector('[data-type="setting"]').classList.add("fn__none"))})}e.stopPropagation();break}else if(n.classList.contains("b3-card")){L(e.target,"b3-card__actions--right")||be._renderReadme(n,i.bazaarType),e.preventDefault(),e.stopPropagation();break}else if(n.classList.contains("item")&&!n.classList.contains("item--focus")){be.element.querySelector(".layout-tab-bar .item--focus").classList.remove("item--focus"),n.classList.add("item--focus"),be.element.querySelectorAll(".config-bazaar__panel").forEach(o=>{s===o.getAttribute("data-type")?(o.classList.remove("fn__none"),o.getAttribute("data-init")||(s==="template"?E("/api/bazaar/getBazaarTemplate",{},l=>{be._onBazaar(l,"templates",!1),be._data.templates=l.data.packages}):s==="icon"?E("/api/bazaar/getBazaarIcon",{},l=>{be._onBazaar(l,"icons",!1),be._data.icons=l.data.packages}):s==="widget"?E("/api/bazaar/getBazaarWidget",{},l=>{be._onBazaar(l,"widgets",!1),be._data.widgets=l.data.packages}):s==="theme"?E("/api/bazaar/getBazaarTheme",{},l=>{be._onBazaar(l,"themes",!1),be._data.themes=l.data.packages}):s==="plugin"&&E("/api/bazaar/getBazaarPlugin",{frontend:xt()},l=>{be._onBazaar(l,"plugins",!1),be._data.plugins=l.data.packages}),o.setAttribute("data-init","true"))):o.classList.add("fn__none")}),e.preventDefault(),e.stopPropagation();break}else if(n.classList.contains("item__preview")){n.classList.toggle("item__preview--fullscreen"),e.preventDefault(),e.stopPropagation();break}n=n.parentElement}}),be.element.querySelectorAll(".config-bazaar__panel .b3-form__icon > .b3-text-field").forEach(e=>{e.addEventListener("keydown",n=>{if(!n.isComposing&&n.key==="Enter"){const a=e.value.trim(),i=L(e,"config-bazaar__panel").getAttribute("data-type");if(i==="template")E("/api/bazaar/getBazaarTemplate",{keyword:a},s=>{be._onBazaar(s,"templates",!1),be._data.templates=s.data.packages});else if(i==="icon")E("/api/bazaar/getBazaarIcon",{keyword:a},s=>{be._onBazaar(s,"icons",!1),be._data.icons=s.data.packages});else if(i==="widget")E("/api/bazaar/getBazaarWidget",{keyword:a},s=>{be._onBazaar(s,"widgets",!1),be._data.widgets=s.data.packages});else if(i==="theme")E("/api/bazaar/getBazaarTheme",{keyword:a},s=>{be._onBazaar(s,"themes",!1),be._data.themes=s.data.packages});else if(i==="plugin")E("/api/bazaar/getBazaarPlugin",{frontend:xt(),keyword:a},s=>{be._onBazaar(s,"plugins",!1),be._data.plugins=s.data.packages});else if(i==="downloaded"){const s=e.parentElement.parentElement.querySelector(".b3-button:not(.b3-button--outline)").getAttribute("data-type").replace("my","").toLowerCase()+"s";this._genMyHTML(s,t)}n.preventDefault();return}})}),be.element.querySelectorAll(".b3-select").forEach(e=>{e.addEventListener("change",n=>{if(e.id==="bazaarSelect")be.element.querySelectorAll("#configBazaarTheme .b3-card").forEach(a=>{const i=JSON.parse(a.getAttribute("data-obj"));e.value==="0"?i.themeMode.indexOf("light")>-1?a.classList.remove("fn__none"):a.classList.add("fn__none"):e.value==="1"?i.themeMode.indexOf("dark")>-1?a.classList.remove("fn__none"):a.classList.add("fn__none"):a.classList.remove("fn__none")}),n.target.parentElement.querySelector(".counter").textContent=be.element.querySelectorAll("#configBazaarTheme .b3-card:not(.fn__none)").length.toString();else{const a=window.siyuan.storage[u.LOCAL_BAZAAR],i=e.parentElement.parentElement;let s="";const o=Array.from(i.querySelectorAll(".b3-card"));e.value==="0"?o.sort((l,r)=>JSON.parse(r.getAttribute("data-obj")).updated<JSON.parse(l.getAttribute("data-obj")).updated?-1:1).forEach(l=>{s+=l.outerHTML}):e.value==="1"?o.sort((l,r)=>JSON.parse(r.getAttribute("data-obj")).updated<JSON.parse(l.getAttribute("data-obj")).updated?1:-1).forEach(l=>{s+=l.outerHTML}):e.value==="2"?o.sort((l,r)=>JSON.parse(r.getAttribute("data-obj")).downloads<JSON.parse(l.getAttribute("data-obj")).downloads?-1:1).forEach(l=>{s+=l.outerHTML}):e.value==="3"&&o.sort((l,r)=>JSON.parse(r.getAttribute("data-obj")).downloads<JSON.parse(l.getAttribute("data-obj")).downloads?1:-1).forEach(l=>{s+=l.outerHTML}),a[e.parentElement.parentElement.getAttribute("data-type")]=e.value,ue(u.LOCAL_BAZAAR,window.siyuan.storage[u.LOCAL_BAZAAR]),o.length>1&&(s+='<div class="fn__flex-1" style="margin-left: 15px;min-width: 342px;"></div><div class="fn__flex-1" style="margin-left: 15px;min-width: 342px;"></div>'),i.querySelector(".b3-cards").innerHTML=s}})})},_onBazaar(t,e,n){let a="#configBazaarTemplate";e==="themes"?a="#configBazaarTheme":e==="icons"?a="#configBazaarIcon":e==="widgets"?a="#configBazaarWidget":e==="plugins"&&(a="#configBazaarPlugin");const i=be.element.querySelector(a);t.code===1&&(j(t.msg),i.querySelectorAll("img[data-type='img-loading']").forEach(l=>{l.remove()}));let s="";t.data.packages.forEach(l=>{s+=this._genCardHTML(l,e)}),be._data[e]=t.data.packages,i.innerHTML=`<div class="b3-cards">${s}</div>`,i.parentElement.querySelector(".counter").textContent=i.querySelectorAll(".b3-card:not(.fn__none)").length.toString();const o=window.siyuan.storage[u.LOCAL_BAZAAR];o[e.replace("s","")]==="1"?(s="",Array.from(i.querySelectorAll(".b3-card")).sort((l,r)=>JSON.parse(r.getAttribute("data-obj")).updated<JSON.parse(l.getAttribute("data-obj")).updated?1:-1).forEach(l=>{s+=l.outerHTML})):o[e.replace("s","")]==="2"?(s="",Array.from(i.querySelectorAll(".b3-card")).sort((l,r)=>JSON.parse(r.getAttribute("data-obj")).downloads<JSON.parse(l.getAttribute("data-obj")).downloads?-1:1).forEach(l=>{s+=l.outerHTML})):o[e.replace("s","")]==="3"&&(s="",Array.from(i.querySelectorAll(".b3-card")).sort((l,r)=>JSON.parse(r.getAttribute("data-obj")).downloads<JSON.parse(l.getAttribute("data-obj")).downloads?1:-1).forEach(l=>{s+=l.outerHTML})),t.data.packages.length>1&&(s+='<div class="fn__flex-1" style="margin-left: 15px;min-width: 342px;"></div><div class="fn__flex-1" style="margin-left: 15px;min-width: 342px;"></div>'),i.innerHTML=`<div class="b3-cards">${s}</div>`,n&&lt.onSetappearance(t.data.appearance)}},Ye={element:void 0,genHTML:()=>`<div class="b3-label">
 ${window.siyuan.languages.searchBlockType}
    <div class="fn__flex config-query">
        <label class="fn__flex">
            <svg class="svg"><use xlink:href="#iconMath"></use></svg>
            <span class="fn__space"></span>
            <div class="fn__flex-1">
                ${window.siyuan.languages.math}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="mathBlock" type="checkbox"${window.siyuan.config.search.mathBlock?" checked":""}/>
        </label>
        <label class="fn__flex">
            <svg class="svg"><use xlink:href="#iconTable"></use></svg>
            <span class="fn__space"></span>
            <div class="fn__flex-1">
                ${window.siyuan.languages.table}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="table" type="checkbox"${window.siyuan.config.search.table?" checked":""}/>
        </label>
        <label class="fn__flex">
            <svg class="svg"><use xlink:href="#iconParagraph"></use></svg>
            <span class="fn__space"></span>
            <div class="fn__flex-1">
                ${window.siyuan.languages.paragraph}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="paragraph" type="checkbox"${window.siyuan.config.search.paragraph?" checked":""}/>
        </label>
        <label class="fn__flex">
            <svg class="svg"><use xlink:href="#iconHeadings"></use></svg>
            <span class="fn__space"></span>
            <div class="fn__flex-1">
                ${window.siyuan.languages.headings}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="heading" type="checkbox"${window.siyuan.config.search.heading?" checked":""}/>
        </label>
        <label class="fn__flex">
            <svg class="svg"><use xlink:href="#iconCode"></use></svg>
            <span class="fn__space"></span>
            <div class="fn__flex-1">
                ${window.siyuan.languages.code}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="codeBlock" type="checkbox"${window.siyuan.config.search.codeBlock?" checked":""}/>
        </label>
        <label class="fn__flex">
            <svg class="svg"><use xlink:href="#iconHTML5"></use></svg>
            <span class="fn__space"></span>
            <div class="fn__flex-1">
                HTML
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="htmlBlock" type="checkbox"${window.siyuan.config.search.htmlBlock?" checked":""}/>
        </label>
        <label class="fn__flex">
            <svg class="svg"><use xlink:href="#iconDatabase"></use></svg>
            <span class="fn__space"></span>
            <div class="fn__flex-1">
                ${window.siyuan.languages.database}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="databaseBlock" type="checkbox"${window.siyuan.config.search.databaseBlock?" checked":""}/>
        </label>        
        <label class="fn__flex">
            <svg class="svg"><use xlink:href="#iconSQL"></use></svg>
            <span class="fn__space"></span>
            <div class="fn__flex-1">
                ${window.siyuan.languages.embedBlock}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="embedBlock" type="checkbox"${window.siyuan.config.search.embedBlock?" checked":""}/>
        </label>
        <label class="fn__flex">
            <svg class="svg"><use xlink:href="#iconVideo"></use></svg>
            <span class="fn__space"></span>
            <div class="fn__flex-1">
                ${window.siyuan.languages.video}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="videoBlock" type="checkbox"${window.siyuan.config.search.videoBlock?" checked":""}/>
        </label>
        <label class="fn__flex">
            <svg class="svg"><use xlink:href="#iconRecord"></use></svg>
            <span class="fn__space"></span>
            <div class="fn__flex-1">
                ${window.siyuan.languages.audio}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="audioBlock" type="checkbox"${window.siyuan.config.search.audioBlock?" checked":""}/>
        </label>
        <label class="fn__flex">
            <svg class="svg"><use xlink:href="#iconLanguage"></use></svg>
            <span class="fn__space"></span>
            <div class="fn__flex-1">
                IFrame
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="iframeBlock" type="checkbox"${window.siyuan.config.search.iframeBlock?" checked":""}/>
        </label>
        <label class="fn__flex">
            <svg class="svg"><use xlink:href="#iconBoth"></use></svg>
            <span class="fn__space"></span>
            <div class="fn__flex-1">
                ${window.siyuan.languages.widget}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="widgetBlock" type="checkbox"${window.siyuan.config.search.widgetBlock?" checked":""}/>
        </label>
        <label class="fn__flex">
            <svg class="svg"><use xlink:href="#iconQuote"></use></svg>
            <span class="fn__space"></span>
            <div class="fn__flex-1">
                ${window.siyuan.languages.quote} <sup>[1]</sup>
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="blockquote" type="checkbox"${window.siyuan.config.search.blockquote?" checked":""}/>
        </label>
        <label class="fn__flex">
            <svg class="svg"><use xlink:href="#iconSuper"></use></svg>
            <span class="fn__space"></span>
            <div class="fn__flex-1">
                ${window.siyuan.languages.superBlock} <sup>[1]</sup>
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="superBlock" type="checkbox"${window.siyuan.config.search.superBlock?" checked":""}/>
        </label>
        <label class="fn__flex">
            <svg class="svg"><use xlink:href="#iconList"></use></svg>
            <span class="fn__space"></span>
            <div class="fn__flex-1">
                ${window.siyuan.languages.list1} <sup>[1]</sup>
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="list" type="checkbox"${window.siyuan.config.search.list?" checked":""}/>
        </label>
        <label class="fn__flex">
            <svg class="svg"><use xlink:href="#iconListItem"></use></svg>
            <span class="fn__space"></span>
            <div class="fn__flex-1">
                ${window.siyuan.languages.listItem} <sup>[1]</sup>
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="listItem" type="checkbox"${window.siyuan.config.search.listItem?" checked":""}/>
        </label>
        <label class="fn__flex">
            <svg class="svg"><use xlink:href="#iconFile"></use></svg>
            <span class="fn__space"></span>
            <div class="fn__flex-1">
                ${window.siyuan.languages.doc}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="document" type="checkbox"${window.siyuan.config.search.document?" checked":""}/>
        </label>
    </div>
    <span class="fn__space"></span>
    <div class="fn__flex-1">
        <div class="b3-label__text">[1] ${window.siyuan.languages.containerBlockTip1}</div>
    </div>
</div>
<div class="b3-label">
 ${window.siyuan.languages.searchBlockAttr}
    <div class="config-query">
        <label class="fn__flex">
            <svg class="svg"><use xlink:href="#iconN"></use></svg>
            <span class="fn__space"></span>
            <div class="fn__flex-1">
                ${window.siyuan.languages.name}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="name" type="checkbox"${window.siyuan.config.search.name?" checked":""}/>
        </label>
        <label class="fn__flex">
            <svg class="svg"><use xlink:href="#iconA"></use></svg>
            <span class="fn__space"></span>
            <div class="fn__flex-1">
                ${window.siyuan.languages.alias}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="alias" type="checkbox"${window.siyuan.config.search.alias?" checked":""}/>
        </label>
        <label class="fn__flex">
            <svg class="svg"><use xlink:href="#iconM"></use></svg>
            <span class="fn__space"></span>
            <div class="fn__flex-1">
                ${window.siyuan.languages.memo}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="memo" type="checkbox"${window.siyuan.config.search.memo?" checked":""}/>
        </label>
        <label class="fn__flex">
            <div class="fn__flex-1">
                ${window.siyuan.languages.allAttrs}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="ial" type="checkbox"${window.siyuan.config.search.ial?" checked":""}/>
        </label>
    </div>
</div>
<div class="b3-label">
 ${window.siyuan.languages.searchBackmention}
    <div class="config-query">
        <label class="fn__flex">
            <div class="fn__flex-1">
                ${window.siyuan.languages.name}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="backlinkMentionName" type="checkbox"${window.siyuan.config.search.backlinkMentionName?" checked":""}/>
        </label>
        <label class="fn__flex">
            <div class="fn__flex-1">
                ${window.siyuan.languages.alias}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="backlinkMentionAlias" type="checkbox"${window.siyuan.config.search.backlinkMentionAlias?" checked":""}/>
        </label>
        <label class="fn__flex">
            <div class="fn__flex-1">
                ${window.siyuan.languages.anchor}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="backlinkMentionAnchor" type="checkbox"${window.siyuan.config.search.backlinkMentionAnchor?" checked":""}/>
        </label>
        <label class="fn__flex">
            <div class="fn__flex-1">
                ${window.siyuan.languages.docName}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="backlinkMentionDoc" type="checkbox"${window.siyuan.config.search.backlinkMentionDoc?" checked":""}/>
        </label>
        <div class="fn__flex label" style="flex: 2">
            <div>
                ${window.siyuan.languages.keywordsLimit}
            </div>
            <span class="fn__space"></span>
            <input class="b3-text-field" id="backlinkMentionKeywordsLimit" type="number" min="1" max="10240" value="${window.siyuan.config.search.backlinkMentionKeywordsLimit}">
        </div>
    </div>
</div>
<div class="b3-label">
 ${window.siyuan.languages.searchVirtualRef}
    <div class="config-query">
        <label class="fn__flex">
            <div class="fn__flex-1">
                ${window.siyuan.languages.name}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="virtualRefName" type="checkbox"${window.siyuan.config.search.virtualRefName?" checked":""}/>
        </label>
        <label class="fn__flex">
            <div class="fn__flex-1">
                ${window.siyuan.languages.alias}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="virtualRefAlias" type="checkbox"${window.siyuan.config.search.virtualRefAlias?" checked":""}/>
        </label>
        <label class="fn__flex">
            <div class="fn__flex-1">
                ${window.siyuan.languages.anchor}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="virtualRefAnchor" type="checkbox"${window.siyuan.config.search.virtualRefAnchor?" checked":""}/>
        </label>
        <label class="fn__flex">
            <div class="fn__flex-1">
                ${window.siyuan.languages.docName}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="virtualRefDoc" type="checkbox"${window.siyuan.config.search.virtualRefDoc?" checked":""}/>
        </label>
    </div>
</div>
<div class="b3-label">
 ${window.siyuan.languages.searchIndex}
    <div class="config-query">
        <label class="fn__flex">
            <div class="fn__flex-1">
                ${window.siyuan.languages.indexAssetPath}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="indexAssetPath" type="checkbox"${window.siyuan.config.search.indexAssetPath?" checked":""}/>
        </label>
    </div>
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.searchLimit}
         <div class="b3-label__text">${window.siyuan.languages.searchLimit1}</div>
         <div class="b3-label__text">${window.siyuan.languages.searchLimit2}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" id="limit" type="number" min="32" max="10240" value="${window.siyuan.config.search.limit}">
</div>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.searchCaseSensitive}
         <div class="b3-label__text">${window.siyuan.languages.searchCaseSensitive1}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="caseSensitive" type="checkbox"${window.siyuan.config.search.caseSensitive?" checked":""}/>
</label>`,bindEvent:()=>{Ye.element.querySelectorAll("input").forEach(t=>{t.addEventListener("change",()=>{E("/api/setting/setSearch",{document:Ye.element.querySelector("#document").checked,heading:Ye.element.querySelector("#heading").checked,list:Ye.element.querySelector("#list").checked,listItem:Ye.element.querySelector("#listItem").checked,codeBlock:Ye.element.querySelector("#codeBlock").checked,htmlBlock:Ye.element.querySelector("#htmlBlock").checked,embedBlock:Ye.element.querySelector("#embedBlock").checked,databaseBlock:Ye.element.querySelector("#databaseBlock").checked,audioBlock:Ye.element.querySelector("#audioBlock").checked,videoBlock:Ye.element.querySelector("#videoBlock").checked,iframeBlock:Ye.element.querySelector("#iframeBlock").checked,widgetBlock:Ye.element.querySelector("#widgetBlock").checked,mathBlock:Ye.element.querySelector("#mathBlock").checked,table:Ye.element.querySelector("#table").checked,blockquote:Ye.element.querySelector("#blockquote").checked,superBlock:Ye.element.querySelector("#superBlock").checked,paragraph:Ye.element.querySelector("#paragraph").checked,name:Ye.element.querySelector("#name").checked,alias:Ye.element.querySelector("#alias").checked,memo:Ye.element.querySelector("#memo").checked,ial:Ye.element.querySelector("#ial").checked,indexAssetPath:Ye.element.querySelector("#indexAssetPath").checked,limit:parseInt(Ye.element.querySelector("#limit").value),caseSensitive:Ye.element.querySelector("#caseSensitive").checked,backlinkMentionName:Ye.element.querySelector("#backlinkMentionName").checked,backlinkMentionAlias:Ye.element.querySelector("#backlinkMentionAlias").checked,backlinkMentionAnchor:Ye.element.querySelector("#backlinkMentionAnchor").checked,backlinkMentionDoc:Ye.element.querySelector("#backlinkMentionDoc").checked,backlinkMentionKeywordsLimit:parseInt(Ye.element.querySelector("#backlinkMentionKeywordsLimit").value),virtualRefName:Ye.element.querySelector("#virtualRefName").checked,virtualRefAlias:Ye.element.querySelector("#virtualRefAlias").checked,virtualRefAnchor:Ye.element.querySelector("#virtualRefAnchor").checked,virtualRefDoc:Ye.element.querySelector("#virtualRefDoc").checked},e=>{window.siyuan.config.search=e.data})})})}},kn={element:void 0,genHTML:()=>{let t="";return t=`<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.apiProvider}
        <div class="b3-label__text">${window.siyuan.languages.apiProviderTip}</div>
    </div>
    <span class="fn__space"></span>
    <select id="apiProvider" class="b3-select fn__flex-center fn__size200">
        <option value="OpenAI" ${window.siyuan.config.ai.openAI.apiProvider==="OpenAI"?"selected":""}>OpenAI</option>
        <option value="Azure" ${window.siyuan.config.ai.openAI.apiProvider==="Azure"?"selected":""}>Azure</option>
    </select>
</div>
<div class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.apiTimeout}
        <div class="b3-label__text">${window.siyuan.languages.apiTimeoutTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" type="number" step="1" min="5" max="600" id="apiTimeout" value="${window.siyuan.config.ai.openAI.apiTimeout}"/>
</div>
<div class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.apiMaxTokens}
        <div class="b3-label__text">${window.siyuan.languages.apiMaxTokensTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" type="number" step="1" min="0" id="apiMaxTokens" value="${window.siyuan.config.ai.openAI.apiMaxTokens}"/>
</div>
<div class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.apiTemperature}
        <div class="b3-label__text">${window.siyuan.languages.apiTemperatureTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" type="number" step="0.1" min="0" max="2" id="apiTemperature" value="${window.siyuan.config.ai.openAI.apiTemperature}"/>
</div>
<div class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.apiMaxContexts}
        <div class="b3-label__text">${window.siyuan.languages.apiMaxContextsTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" type="number" step="1" min="1" max="64" id="apiMaxContexts" value="${window.siyuan.config.ai.openAI.apiMaxContexts}"/>
</div>
<div class="fn__flex b3-label">
    <div class="fn__block">
        ${window.siyuan.languages.apiModel}
        <div class="b3-label__text">${window.siyuan.languages.apiModelTip}</div>
        <div class="fn__hr"></div>
        <input class="b3-text-field fn__block" id="apiModel" value="${window.siyuan.config.ai.openAI.apiModel}"/>
    </div>
</div>
<div class="fn__flex b3-label">
    <div class="fn__block">
        ${window.siyuan.languages.apiKey}
        <div class="b3-label__text">${window.siyuan.languages.apiKeyTip}</div>
        <div class="fn__hr"></div>
        <div class="b3-form__icona fn__block">
            <input id="apiKey" type="password" class="b3-text-field b3-form__icona-input" value="${window.siyuan.config.ai.openAI.apiKey}">
            <svg class="b3-form__icona-icon" data-action="togglePassword"><use xlink:href="#iconEye"></use></svg>
        </div>
    </div>
</div>
<div class="fn__flex b3-label">
    <div class="fn__block">
        ${window.siyuan.languages.apiProxy}
        <div class="b3-label__text">${window.siyuan.languages.apiProxyTip}</div>
        <span class="fn__hr"></span>
        <input class="b3-text-field fn__block" id="apiProxy" value="${window.siyuan.config.ai.openAI.apiProxy}"/>
    </div>
</div>
<div class="fn__flex b3-label">
    <div class="fn__block">
        ${window.siyuan.languages.apiBaseURL}
        <div class="b3-label__text">${window.siyuan.languages.apiBaseURLTip}</div>
        <span class="fn__hr"></span>
        <input class="b3-text-field fn__block" id="apiBaseURL" value="${window.siyuan.config.ai.openAI.apiBaseURL}"/>
    </div>
</div>
<div class="fn__flex b3-label">
    <div class="fn__block">
        ${window.siyuan.languages.apiVersion}
        <div class="b3-label__text">${window.siyuan.languages.apiVersionTip}</div>
        <span class="fn__hr"></span>
        <input class="b3-text-field fn__block" id="apiVersion" value="${window.siyuan.config.ai.openAI.apiVersion}"/>
    </div>
</div>
<div class="fn__flex b3-label">
    <div class="fn__block">
        User-Agent
        <div class="b3-label__text">${window.siyuan.languages.apiUserAgentTip}</div>
        <span class="fn__hr"></span>
        <input class="b3-text-field fn__block" id="apiUserAgent" value="${window.siyuan.config.ai.openAI.apiUserAgent}"/>
    </div>
</div>`,`<div class="fn__flex-column" style="height: 100%">
<div class="layout-tab-bar fn__flex">
    <div data-type="openai" class="item item--full item--focus"><span class="fn__flex-1"></span><span class="item__text">OpenAI</span><span class="fn__flex-1"></span></div>
</div>
<div class="fn__flex-1">
    <div data-type="openai">
        ${t}
    </div>
</div>
</div>`},bindEvent:()=>{const t=kn.element.querySelector('.b3-form__icona-icon[data-action="togglePassword"]');t.addEventListener("click",()=>{const e=t.firstElementChild.getAttribute("xlink:href")==="#iconEye";t.firstElementChild.setAttribute("xlink:href",e?"#iconEyeoff":"#iconEye"),t.previousElementSibling.setAttribute("type",e?"text":"password")}),kn.element.querySelectorAll("input, select").forEach(e=>{e.addEventListener("change",()=>{E("/api/setting/setAI",{openAI:{apiUserAgent:kn.element.querySelector("#apiUserAgent").value,apiBaseURL:kn.element.querySelector("#apiBaseURL").value,apiVersion:kn.element.querySelector("#apiVersion").value,apiKey:kn.element.querySelector("#apiKey").value,apiModel:kn.element.querySelector("#apiModel").value,apiMaxTokens:parseInt(kn.element.querySelector("#apiMaxTokens").value),apiTemperature:parseFloat(kn.element.querySelector("#apiTemperature").value),apiMaxContexts:parseInt(kn.element.querySelector("#apiMaxContexts").value),apiProxy:kn.element.querySelector("#apiProxy").value,apiTimeout:parseInt(kn.element.querySelector("#apiTimeout").value),apiProvider:kn.element.querySelector("#apiProvider").value}},n=>{window.siyuan.config.ai=n.data})})})}},Pn={element:void 0,genHTML:()=>{let t=`<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.flashcardMark}
        <div class="b3-label__text">${window.siyuan.languages.flashcardMarkTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="mark" type="checkbox"${window.siyuan.config.flashcard.mark?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.flashcardList}
        <div class="b3-label__text">${window.siyuan.languages.flashcardListTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="list" type="checkbox"${window.siyuan.config.flashcard.list?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.flashcardHeading}
        <div class="b3-label__text">${window.siyuan.languages.flashcardHeadingTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="heading" type="checkbox"${window.siyuan.config.flashcard.heading?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.flashcardSuperBlock}
        <div class="b3-label__text">${window.siyuan.languages.flashcardSuperBlockTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="superBlock" type="checkbox"${window.siyuan.config.flashcard.superBlock?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.flashcardDeck}
        <div class="b3-label__text">${window.siyuan.languages.flashcardDeckTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="deck" type="checkbox"${window.siyuan.config.flashcard.deck?" checked":""}/>
</label>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.reviewMode}
        <div class="b3-label__text">${window.siyuan.languages.reviewModeTip}</div>
    </div>
    <span class="fn__space"></span>
    <select class="b3-select fn__flex-center fn__size200" id="reviewMode">
      <option value="0" ${window.siyuan.config.flashcard.reviewMode===0?"selected":""}>${window.siyuan.languages.reviewMode0}</option>
      <option value="1" ${window.siyuan.config.flashcard.reviewMode===1?"selected":""}>${window.siyuan.languages.reviewMode1}</option>
      <option value="2" ${window.siyuan.config.flashcard.reviewMode===2?"selected":""}>${window.siyuan.languages.reviewMode2}</option>
    </select>    
</div>`;return t=`${t}<div class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.flashcardNewCardLimit}
        <div class="b3-label__text">${window.siyuan.languages.flashcardNewCardLimitTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" id="newCardLimit" step="1" min="0" type="number"${window.siyuan.config.flashcard.newCardLimit?" checked":""} value="${window.siyuan.config.flashcard.newCardLimit}"/>
</div>
<div class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.flashcardReviewCardLimit}
        <div class="b3-label__text">${window.siyuan.languages.flashcardReviewCardLimitTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" id="reviewCardLimit" step="1" min="0" type="number"${window.siyuan.config.flashcard.reviewCardLimit?" checked":""} value="${window.siyuan.config.flashcard.reviewCardLimit}"/>
</div>
<div class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.flashcardFSRSParamRequestRetention}
        <div class="b3-label__text">${window.siyuan.languages.flashcardFSRSParamRequestRetentionTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" id="requestRetention" step="0.01" min="0" max="1" type="number" value="${window.siyuan.config.flashcard.requestRetention}"/>
</div>
<div class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.flashcardFSRSParamMaximumInterval}
        <div class="b3-label__text">${window.siyuan.languages.flashcardFSRSParamMaximumIntervalTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" id="maximumInterval" step="1" min="365" max="36500" type="number" value="${window.siyuan.config.flashcard.maximumInterval}"/>
</div>
<div class="fn__flex b3-label">
    <div class="fn__block">
        ${window.siyuan.languages.flashcardFSRSParamWeights}
        <div class="b3-label__text">${window.siyuan.languages.flashcardFSRSParamWeightsTip}</div>
        <span class="fn__hr"></span>
        <input class="b3-text-field fn__block" id="weights" value="${window.siyuan.config.flashcard.weights}"/>
    </div>
</div>`,t},bindEvent:()=>{Pn.element.querySelectorAll("input, select.b3-select").forEach(t=>{t.addEventListener("change",()=>{E("/api/setting/setFlashcard",{reviewMode:parseInt(Pn.element.querySelector("#reviewMode").value),newCardLimit:parseInt(Pn.element.querySelector("#newCardLimit").value),reviewCardLimit:parseInt(Pn.element.querySelector("#reviewCardLimit").value),mark:Pn.element.querySelector("#mark").checked,list:Pn.element.querySelector("#list").checked,superBlock:Pn.element.querySelector("#superBlock").checked,heading:Pn.element.querySelector("#heading").checked,deck:Pn.element.querySelector("#deck").checked,requestRetention:parseFloat(Pn.element.querySelector("#requestRetention").value),maximumInterval:parseInt(Pn.element.querySelector("#maximumInterval").value),weights:Pn.element.querySelector("#weights").value},e=>{window.siyuan.config.flashcard=e.data})})})}},Yt={element:void 0,genHTML:()=>`
<!-- publish service -->
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.publishService}
        <div class="b3-label__text">${window.siyuan.languages.publishServiceTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="publishEnable" type="checkbox"${window.siyuan.config.publish.enable?" checked":""}/>
</label>

<div class="b3-label">
    <!-- publish service port -->
    <div class="fn__flex">
        <div class="fn__flex-1">
            ${window.siyuan.languages.publishServicePort}
            <div class="b3-label__text">${window.siyuan.languages.publishServicePortTip}</div>
        </div>
        <span class="fn__space"></span>
        <input class="b3-text-field fn__flex-center fn__size200" id="publishPort" type="number" min="0" max="65535" value="${window.siyuan.config.publish.port}">
    </div>

    <!-- publish service address list -->
    <div class="b3-label">
        <div class="fn__flex config__item">
            <div class="fn__flex-1">
                ${window.siyuan.languages.publishServiceAddresses}
                <div class="b3-label__text">${window.siyuan.languages.publishServiceAddressesTip}</div>
            </div>
            <div class="fn__space"></div>
        </div>
        <div class="b3-label" id="publishAddresses">
        </div>
    </div>
</div>

<div class="b3-label">
    <!-- publish service auth -->
    <label class="fn__flex">
        <div class="fn__flex-1">
            ${window.siyuan.languages.publishServiceAuth}
            <div class="b3-label__text">${window.siyuan.languages.publishServiceAuthTip}</div>
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" id="publishAuthEnable" type="checkbox"${window.siyuan.config.publish.auth.enable?" checked":""}/>
    </label>

    <!-- publish service auth accounts -->
    <div class="b3-label">
        <div class="fn__flex config__item">
            <div class="fn__flex-1">
                ${window.siyuan.languages.publishServiceAuthAccounts}
                <div class="b3-label__text">${window.siyuan.languages.publishServiceAuthAccountsTip}</div>
            </div>
            <div class="fn__space"></div>
            <button class="b3-button b3-button--outline fn__size200 fn__flex-center" id="publishAuthAccountAdd">
                <svg><use xlink:href="#iconAdd"></use></svg>${window.siyuan.languages.publishServiceAuthAccountAdd}
            </button>
        </div>
        <div class="fn__flex" id="publishAuthAccounts">
        </div>
    </div>
</div>
`,bindEvent:()=>{Yt.element.querySelector("#publishAuthAccountAdd").addEventListener("click",()=>{window.siyuan.config.publish.auth.accounts.push({username:"",password:"",memo:""}),Yt._renderPublishAuthAccounts(Yt.element)}),Yt.element.querySelectorAll("input").forEach(e=>{e.addEventListener("change",()=>{Yt._savePublish()})}),Yt._refreshPublish()},_refreshPublish:()=>{E("/api/setting/getPublish",{},Yt._updatePublishConfig.bind(null,!0))},_savePublish:(t=!0)=>{const e=Yt.element.querySelector("#publishEnable"),n=Yt.element.querySelector("#publishPort"),a=Yt.element.querySelector("#publishAuthEnable");E("/api/setting/setPublish",{enable:e.checked,port:n.valueAsNumber,auth:{enable:a.checked,accounts:window.siyuan.config.publish.auth.accounts}},Yt._updatePublishConfig.bind(null,t))},_updatePublishConfig:(t,e)=>{e.code===0?(window.siyuan.config.publish=e.data.publish,t&&Yt._renderPublishAuthAccounts(Yt.element),Yt._renderPublishAddressList(Yt.element,e.data.port)):Yt._renderPublishAddressList(Yt.element,0)},_renderPublishAuthAccounts:(t,e=window.siyuan.config.publish.auth.accounts)=>{const n=t.querySelector("#publishAuthAccounts");n.innerHTML=`<ul class="fn__flex-1" style="margin-top: 16px">${e.map((a,i)=>`
                        <li class="b3-label--inner fn__flex" data-index="${i}">
                            <input class="b3-text-field fn__block" data-name="username" value="${a.username}" placeholder="${window.siyuan.languages.userName}">
                            <span class="fn__space"></span>
                            <div class="b3-form__icona fn__block">
                                <input class="b3-text-field fn__block b3-form__icona-input" type="password" data-name="password" value="${a.password}" placeholder="${window.siyuan.languages.password}">
                                <svg class="b3-form__icona-icon" data-action="togglePassword"><use xlink:href="#iconEye"></use></svg>
                            </div>
                            <span class="fn__space"></span>
                            <input class="b3-text-field fn__block" data-name="memo" value="${a.memo}" placeholder="${window.siyuan.languages.memo}">
                            <span class="fn__space"></span>
                            <span data-action="remove" class="block__icon block__icon--show">
                                <svg><use xlink:href="#iconTrashcan"></use></svg>
                            </span>
                        </li>`).join("")}</ul>`,n.querySelectorAll("input").forEach(a=>{a.addEventListener("change",()=>{const i=q(a,"LI");if(i){const s=parseInt(i.dataset.index),o=a.dataset.name;o in window.siyuan.config.publish.auth.accounts[s]&&(window.siyuan.config.publish.auth.accounts[s][o]=a.value,Yt._savePublish(!1))}})}),n.querySelectorAll('.block__icon[data-action="remove"]').forEach(a=>{a.addEventListener("click",()=>{const i=q(a,"LI");if(i){const s=parseInt(i.dataset.index);window.siyuan.config.publish.auth.accounts.splice(s,1),Yt._savePublish()}})}),n.querySelectorAll('.b3-form__icona-icon[data-action="togglePassword"]').forEach(a=>{a.addEventListener("click",()=>{const i=a.firstElementChild.getAttribute("xlink:href")==="#iconEye";a.firstElementChild.setAttribute("xlink:href",i?"#iconEyeoff":"#iconEye"),a.previousElementSibling.setAttribute("type",i?"text":"password")})})},_renderPublishAddressList:(t,e)=>{const n=t.querySelector("#publishAddresses");e===0?n.innerText=window.siyuan.languages.publishServiceNotStarted:n.innerHTML=`<ul class="b3-list b3-list--background fn__flex-1">${window.siyuan.config.localIPs.filter(a=>!(a.startsWith("[")&&a.endsWith("]"))).map(a=>`<li><code class="fn__code">${a}:${e}</code></li>`).join("")}${window.siyuan.config.localIPs.filter(a=>a.startsWith("[")&&a.endsWith("]")).map(a=>`<li><code class="fn__code">${a}:${e}</code></li>`).join("")}</ul>`}},uk=(t,e,n)=>{switch(t){case"filetree":e.innerHTML=Gt.genHTML(),Gt.element=e,Gt.bindEvent();break;case"AI":e.innerHTML=kn.genHTML(),kn.element=e,kn.bindEvent();break;case"card":e.innerHTML=Pn.genHTML(),Pn.element=e,Pn.bindEvent();break;case"image":e.innerHTML=_a.genHTML(),_a.element=e,_a.bindEvent();break;case"export":e.innerHTML=Ve.genHTML(),Ve.element=e,Ve.bindEvent();break;case"appearance":e.innerHTML=lt.genHTML(),lt.element=e,lt.bindEvent();break;case"keymap":e.innerHTML=at.genHTML(n),at.element=e,at.bindEvent(n);break;case"bazaar":be.element=e,e.innerHTML=be.genHTML(),be.bindEvent(n);break;case"account":e.innerHTML=jt.genHTML(),jt.element=e,jt.bindEvent(jt.element);break;case"repos":e.innerHTML=Ot.genHTML(),Ot.element=e,Ot.bindEvent();break;case"about":e.innerHTML=vt.genHTML(),vt.element=e,vt.bindEvent();break;case"search":e.innerHTML=Ye.genHTML(),Ye.element=e,Ye.bindEvent();break;case"publish":e.innerHTML=Yt.genHTML(),Yt.element=e,Yt.bindEvent();break;default:break}},To=t=>{const e=window.siyuan.dialogs.find(a=>{if(a.element.querySelector(".config__tab-container"))return a.destroy(),!0});if(e)return e;const n=new we({content:`<div class="fn__flex-1 fn__flex config__panel" style="overflow: hidden;position: relative">
  <ul class="b3-tab-bar b3-list b3-list--background">
    <div class="config__tab-title resize__move">
        <svg class="b3-list-item__graphic"><use xlink:href="#iconSettings"></use></svg>
        <span class="b3-list-item__text">${window.siyuan.languages.config}</span>
    </div>
    <div class="b3-form__icon"><svg class="b3-form__icon-icon"><use xlink:href="#iconSearch"></use></svg><input placeholder="${window.siyuan.languages.search}" class="b3-text-field fn__block b3-form__icon-input"></div>
    <div class="config__tab-hr"></div>
    <li data-name="editor" class="b3-list-item--focus b3-list-item"><svg class="b3-list-item__graphic"><use xlink:href="#iconEdit"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.editor}</span></li>
    <li data-name="filetree" class="b3-list-item"><svg class="b3-list-item__graphic"><use xlink:href="#iconFiles"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.fileTree}</span></li>
    <li data-name="card" class="b3-list-item"><svg class="b3-list-item__graphic"><use xlink:href="#iconRiffCard"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.riffCard}</span></li>
    <li data-name="AI" class="b3-list-item"><svg class="b3-list-item__graphic"><use xlink:href="#iconSparkles"></use></svg><span class="b3-list-item__text">AI</span></li>
    <li data-name="image" class="b3-list-item"><svg class="b3-list-item__graphic"><use xlink:href="#iconImage"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.assets}</span></li>
    <li data-name="export" class="b3-list-item"><svg class="b3-list-item__graphic"><use xlink:href="#iconUpload"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.export}</span></li>
    <li data-name="appearance" class="b3-list-item"><svg class="b3-list-item__graphic"><use xlink:href="#iconTheme"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.appearance}</span></li>
    <li data-name="bazaar" class="b3-list-item${tf()||pn()?" fn__none":""}"><svg class="b3-list-item__graphic"><use xlink:href="#iconBazaar"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.bazaar}</span></li>
    <li data-name="search" class="b3-list-item"><svg class="b3-list-item__graphic"><use xlink:href="#iconSearch"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.search}</span></li>
    <li data-name="keymap" class="b3-list-item"><svg class="b3-list-item__graphic"><use xlink:href="#iconKeymap"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.keymap}</span></li>
    <li data-name="account" class="b3-list-item"><svg class="b3-list-item__graphic"><use xlink:href="#iconAccount"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.account}</span></li>
    <li data-name="repos" class="b3-list-item"><svg class="b3-list-item__graphic"><use xlink:href="#iconCloud"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.cloud}</span></li>
    <li data-name="publish" class="b3-list-item"><svg class="b3-list-item__graphic"><use xlink:href="#iconLanguage"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.publish}</span></li>
    <li data-name="about" class="b3-list-item"><svg class="b3-list-item__graphic"><use xlink:href="#iconInfo"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.about}</span></li>
  </ul>
  <div class="config__tab-wrap">
      <div class="fn__hr--b resize__move"></div>
      <div class="config__tab-container" data-name="editor">${Ae.genHTML()}</div>
      <div class="config__tab-container fn__none" data-name="filetree"></div>
      <div class="config__tab-container fn__none" data-name="card"></div>
      <div class="config__tab-container config__tab-container--top fn__none" data-name="AI"></div>
      <div class="config__tab-container config__tab-container--top fn__none" data-name="image"></div>
      <div class="config__tab-container fn__none" data-name="export"></div>
      <div class="config__tab-container fn__none" data-name="appearance"></div>
      <div class="config__tab-container config__tab-container--top fn__none" data-name="bazaar"></div>
      <div class="config__tab-container fn__none" data-name="search"></div>
      <div class="config__tab-container fn__none" style="overflow: scroll" data-name="keymap"></div>
      <div class="config__tab-container config__tab-container--full fn__none" data-name="account"></div>
      <div class="config__tab-container fn__none" data-name="repos"></div>
      <div class="config__tab-container fn__none" data-name="publish"></div>
      <div class="config__tab-container fn__none" data-name="about"></div>
      <div class="fn__hr--b"></div>
  </div>
</div>`,width:"90vw",height:"90vh"});return n.element.setAttribute("data-key",u.DIALOG_SETTING),XT(n.element,t),n.element.querySelector(".b3-dialog__container").style.maxWidth="1280px",n.element.querySelectorAll(".b3-tab-bar .b3-list-item").forEach(a=>{a.addEventListener("click",()=>{const i=a.getAttribute("data-name"),s=n.element.querySelector(`.config__tab-container[data-name="${i}"]`);n.element.querySelectorAll(".config__tab-container").forEach(o=>{o.classList.add("fn__none")}),n.element.querySelector(".b3-tab-bar .b3-list-item.b3-list-item--focus").classList.remove("b3-list-item--focus"),a.classList.add("b3-list-item--focus"),s.classList.remove("fn__none"),(s.innerHTML===""||i==="repos"||i==="bazaar")&&uk(i,s,t)})}),Ae.element=n.element.querySelector('.config__tab-container[data-name="editor"]'),Ae.bindEvent(),n};let fk,pk;pk=t=>{if(t.doc&&t.doc.id){Xr(t.doc.id,{position:t.position,width:t.width,height:t.height});return}if(t.tab){lf(t.tab,{position:t.position,width:t.width,height:t.height});return}},fk=t=>{if(t.doc)return t.doc.zoomIn&&(t.doc.action&&!t.doc.action.includes(u.CB_GET_ALL)?t.doc.action.push(u.CB_GET_ALL):t.doc.action=[u.CB_GET_ALL]),t.doc.action||(t.doc.action=[]),de({app:t.app,keepCursor:t.keepCursor,removeCurrentTab:t.removeCurrentTab,position:t.position,afterOpen:t.afterOpen,id:t.doc.id,action:t.doc.action,zoomIn:t.doc.zoomIn});if(t.asset)return ma({app:t.app,keepCursor:t.keepCursor,removeCurrentTab:t.removeCurrentTab,position:t.position,afterOpen:t.afterOpen,assetPath:t.asset.path});if(t.pdf)return ma({app:t.app,keepCursor:t.keepCursor,removeCurrentTab:t.removeCurrentTab,position:t.position,afterOpen:t.afterOpen,assetPath:t.pdf.path,page:t.pdf.id||t.pdf.page});if(t.search)return t.search.idPath||(t.search.idPath=[]),t.search.hPath||(t.search.hPath=""),ma({app:t.app,keepCursor:t.keepCursor,removeCurrentTab:t.removeCurrentTab,position:t.position,afterOpen:t.afterOpen,searchData:t.search});if(t.card)return ma({app:t.app,keepCursor:t.keepCursor,removeCurrentTab:t.removeCurrentTab,position:t.position,afterOpen:t.afterOpen,custom:{icon:"iconRiffCard",title:window.siyuan.languages.spaceRepetition,data:{cardType:t.card.type,id:t.card.id||"",title:t.card.title},id:"siyuan-card"}});if(t.custom)return ma(t)};const e0={adaptHotkey:X,confirm:xe,Constants:u,showMessage:j,fetchPost:E,fetchSyncPost:Re,fetchGet:mb,getFrontend:xt,getBackend:ja,getModelByDockType:t=>Qe(t).data[t],openTab:fk,openWindow:pk,openMobileFileById:YL,lockScreen:Ep,exitSiYuan:So,Protyle:aa,Plugin:XE,Dialog:we,Menu:st,Setting:NT,getAllEditor:Mn,getAllModels:Ce,platformUtils:kt,openSetting:To},gk=t=>({siyuan:e0})[t]??window.require?.(t);window.require instanceof Function&&(gk.__proto__=window.require);const t0=(t,e)=>window.eval("(function anonymous(require, module, exports){".concat(t,`
})
//# sourceURL=`).concat(e,`
`)),Mb=async(t,e)=>{const n=await Re("/api/petal/loadPetals",{frontend:xt()});let a="";n.data.forEach(s=>{(!e||e&&e.includes(s.name))&&hk(t,s),a+=s.css||`
`});const i=document.getElementById("pluginsStyle");i?i.innerHTML=a:document.head.insertAdjacentHTML("beforeend",`<style id="pluginsStyle">${a}</style>`)},hk=async(t,e)=>{const n={},a={exports:n};try{t0(e.js,"plugin:"+encodeURIComponent(e.name))(gk,a,n)}catch(o){console.error(`plugin ${e.name} run error:`,o);return}const i=(a.exports||n).default||a.exports;if(typeof i!="function"){console.error(`plugin ${e.name} has no export`);return}if(!(i.prototype instanceof XE)){console.error(`plugin ${e.name} does not extends Plugin`);return}const s=new i({app:t,displayName:e.displayName,name:e.name,i18n:e.i18n});t.plugins.push(s);try{await s.onload()}catch(o){console.error(`plugin ${e.name} onload error:`,o)}return s},mk=async(t,e)=>{const n=await hk(t,e),a=document.createElement("style");return a.textContent=e.css,document.head.append(a),Np(n),dn(),Mn().forEach(i=>{i.protyle.toolbar.update(i.protyle)}),n},Pb=(t,e,n,a)=>{const i=Object.keys(n.docks);t.forEach((s,o)=>{i.includes(s.type)&&(a==="Left"?n.docks[s.type].config.position=e===0?"LeftTop":"LeftBottom":a==="Right"?n.docks[s.type].config.position=e===0?"RightTop":"RightBottom":a==="Bottom"&&(n.docks[s.type].config.position=e===0?"BottomLeft":"BottomRight"),n.docks[s.type].config.index=o,n.docks[s.type].config.show=s.show,n.docks[s.type].config.size=s.size,window.siyuan.storage[u.LOCAL_PLUGIN_DOCKS][n.name]||(window.siyuan.storage[u.LOCAL_PLUGIN_DOCKS][n.name]={}),window.siyuan.storage[u.LOCAL_PLUGIN_DOCKS][n.name][s.type]=n.docks[s.type].config,ue(u.LOCAL_PLUGIN_DOCKS,window.siyuan.storage[u.LOCAL_PLUGIN_DOCKS]))})},Np=t=>{try{t.onLayoutReady()}catch(e){console.error(`plugin ${t.name} onLayoutReady error:`,e)}(!ve()||W())&&t.topBarIcons.forEach(e=>{W()?window.siyuan.storage[u.LOCAL_PLUGINTOPUNPIN].includes(e.id)||document.querySelector("#menuAbout").after(e):ve()||(window.siyuan.storage[u.LOCAL_PLUGINTOPUNPIN].includes(e.id)&&e.classList.add("fn__none"),document.querySelector("#"+(e.getAttribute("data-location")==="right"?"barPlugins":"drag")).before(e))}),Rp(),t.statusBarIcons.forEach(e=>{const n=document.getElementById("status");e.getAttribute("data-location")==="right"?n.insertAdjacentElement("beforeend",e):n.insertAdjacentElement("afterbegin",e)}),!ve()&&(window.siyuan.config.uiLayout.left.data.forEach((e,n)=>{Pb(e,n,t,"Left")}),window.siyuan.config.uiLayout.right.data.forEach((e,n)=>{Pb(e,n,t,"Right")}),window.siyuan.config.uiLayout.bottom.data.forEach((e,n)=>{Pb(e,n,t,"Bottom")}),Object.keys(t.docks).forEach(e=>{window.siyuan.storage[u.LOCAL_PLUGIN_DOCKS][t.name]&&window.siyuan.storage[u.LOCAL_PLUGIN_DOCKS][t.name][e]&&(t.docks[e].config=window.siyuan.storage[u.LOCAL_PLUGIN_DOCKS][t.name][e]);const n=t.docks[e],a=window.siyuan.config.keymap.plugin[t.name]?window.siyuan.config.keymap.plugin[t.name][e]?.custom:void 0;n.config.position.startsWith("Left")?window.siyuan.layout.leftDock.genButton([{type:e,size:n.config.size,show:n.config.show,icon:n.config.icon,title:n.config.title,hotkey:a}],n.config.position==="LeftBottom"?1:0,n.config.index):n.config.position.startsWith("Bottom")?window.siyuan.layout.bottomDock.genButton([{type:e,size:n.config.size,show:n.config.show,icon:n.config.icon,title:n.config.title,hotkey:a}],n.config.position==="BottomRight"?1:0,n.config.index):n.config.position.startsWith("Right")&&window.siyuan.layout.rightDock.genButton([{type:e,size:n.config.size,show:n.config.show,icon:n.config.icon,title:n.config.title,hotkey:a}],n.config.position==="RightBottom"?1:0,n.config.index)}))},n0=async(t,e)=>{e.removePlugins.concat(e.upsertPlugins).forEach(n=>{Pp(t,n)}),Mb(t,e.upsertPlugins).then(()=>{t.plugins.forEach(n=>{e.upsertPlugins.includes(n.name)&&Np(n)})}),dn()},tt=(t,e=!0)=>{if(t.getAttribute("data-type")==="wnd"&&Oc(t.querySelector('.layout-tab-bar .item--focus[data-type="tab-header"] .item__text')?.textContent||window.siyuan.languages.siyuanNote),!(t.classList.contains("layout__tab--active")||t.classList.contains("layout__wnd--active")))if(document.querySelectorAll(".layout__tab--active").forEach(n=>{n.classList.remove("layout__tab--active")}),document.querySelectorAll(".dock__item--activefocus").forEach(n=>{n.classList.remove("dock__item--activefocus")}),document.querySelectorAll(".layout__wnd--active").forEach(n=>{n.classList.remove("layout__wnd--active")}),t.getAttribute("data-type")==="wnd")t.classList.add("layout__wnd--active"),t.querySelector(".layout-tab-bar .item--focus")?.setAttribute("data-activetime",new Date().getTime().toString()),e&&dn();else{t.classList.add("layout__tab--active"),Array.from(t.classList).find(a=>{if(a.startsWith("sy__"))return document.querySelector(`.dock__item[data-type="${a.substring(4)}"]`).classList.add("dock__item--activefocus"),!0});const n=P(document.activeElement);if(n){const a=le(n);a&&a.blur()}}},Nb=(t,e)=>{const n=[];e.children.forEach(a=>{if(a.model instanceof ht&&a.model.editor.protyle.toolbar.range){const i=P(a.model.editor.protyle.toolbar.range.startContainer);if(i){const s=ct(i,void 0,a.model.editor.protyle.toolbar.range);n.push({id:i.getAttribute("data-node-id"),start:s.start,end:s.end})}}}),t.element.after(e.element),e.children.forEach(a=>{if(a.model instanceof ht){const i=n.splice(0,1)[0];if(!i)return;const s=na(a.model.editor.protyle.wysiwyg.element.querySelector(`[data-node-id="${i.id}"]`),i.start,i.end);s&&(a.model.editor.protyle.toolbar.range=s)}}),t.element.after(t.element.previousElementSibling),t.parent.children.find((a,i)=>{if(a.id===t.id){const s=t.parent.children[i].resize;t.parent.children[i].resize=t.parent.children[i-1].resize,t.parent.children[i-1].resize=s;const o=a;return t.parent.children[i]=t.parent.children[i-1],t.parent.children[i-1]=o,!0}}),bo()},jl=t=>{const e=[];return ko(t,e),e.sort((n,a)=>{if(n.element.querySelector(".fn__flex .item--focus")?.getAttribute("data-activetime")>a.element.querySelector(".fn__flex .item--focus")?.getAttribute("data-activetime"))return-1})[0]},Ni=t=>{const e=[],n=s=>{const o=[];return t.element.querySelectorAll(`span[data-index="${s}"]`).forEach(l=>{o.push({type:l.getAttribute("data-type"),size:{height:parseInt(l.getAttribute("data-height")),width:parseInt(l.getAttribute("data-width"))},title:l.getAttribute("data-title"),show:l.classList.contains("dock__item--active"),icon:l.querySelector("use").getAttribute("xlink:href").substring(1),hotkey:l.getAttribute("data-hotkey")||"",hotkeyLangId:l.getAttribute("data-hotkeyLangId")||""})}),o},a=n(0),i=n(1);return(a.length>0||i.length>0)&&e.push(a),i.length>0&&e.push(i),{pin:t.pin,data:e}},bk=()=>{window.siyuan.config.readonly?window.location.reload():E("/api/system/setUILayout",{layout:{}},()=>{window.siyuan.storage[u.LOCAL_FILEPOSITION]={},ue(u.LOCAL_FILEPOSITION,window.siyuan.storage[u.LOCAL_FILEPOSITION]),window.siyuan.storage[u.LOCAL_DIALOGPOSITION]={},ue(u.LOCAL_DIALOGPOSITION,window.siyuan.storage[u.LOCAL_DIALOGPOSITION]),window.location.reload()})};let Hp=0;const dn=()=>{const t={};let e={};if(ve())e={layout:{}},Hi(window.siyuan.layout.layout,e.layout,t);else{const n=document.querySelector("#barDock use");n&&(e={hideDock:n.getAttribute("xlink:href")==="#iconDock",layout:{},bottom:Ni(window.siyuan.layout.bottomDock),left:Ni(window.siyuan.layout.leftDock),right:Ni(window.siyuan.layout.rightDock)},Hi(window.siyuan.layout.layout,e.layout,t),window.siyuan.config.uiLayout=e)}Object.keys(t).length>0&&Hp<10?(Hp++,setTimeout(()=>{dn()},u.TIMEOUT_LOAD*Hp)):(Hp=0,ve()?sessionStorage.setItem("layout",JSON.stringify(e)):window.siyuan.config.readonly||E("/api/system/setUILayout",{layout:e,errorExit:!1}))},Xt=async t=>{const e=Ce().editor;for(let i=0;i<e.length;i++)await ic(e[i].editor.protyle);if(ve()){const i={layout:{}};Hi(window.siyuan.layout.layout,i.layout),sessionStorage.setItem("layout",JSON.stringify(i)),t.cb();return}const n=document.querySelector("#barDock use");if(!n)return;const a={hideDock:n.getAttribute("xlink:href")==="#iconDock",layout:{},bottom:Ni(window.siyuan.layout.bottomDock),left:Ni(window.siyuan.layout.leftDock),right:Ni(window.siyuan.layout.rightDock)};Hi(window.siyuan.layout.layout,a.layout),window.siyuan.config.readonly?t.cb():E("/api/system/setUILayout",{layout:a,errorExit:t.errorExit},()=>{t.cb()})},Hb=()=>{const t={hideDock:document.querySelector("#barDock use").getAttribute("xlink:href")==="#iconDock",layout:{},bottom:Ni(window.siyuan.layout.bottomDock),left:Ni(window.siyuan.layout.leftDock),right:Ni(window.siyuan.layout.rightDock)};return Hi(window.siyuan.layout.layout,t.layout),t},Rb=t=>{t.forEach(e=>{e.hotkeyLangId&&(e.title=window.siyuan.languages[e.hotkeyLangId],e.hotkey=window.siyuan.config.keymap.general[e.hotkeyLangId].custom)})},a0=(t,e)=>{t.left.data.forEach(n=>{Rb(n)}),t.right.data.forEach(n=>{Rb(n)}),t.bottom.data.forEach(n=>{Rb(n)}),window.siyuan.layout.centerLayout=window.siyuan.layout.layout.children[0].children[1],window.siyuan.layout.leftDock=new xb({position:"Left",data:t.left,app:e}),window.siyuan.layout.rightDock=new xb({position:"Right",data:t.right,app:e}),window.siyuan.layout.bottomDock=new xb({position:"Bottom",data:t.bottom,app:e})},yk=[],zc=(t,e,n)=>{let a;if(e.instance==="Layout"){for(;e.children.length===1&&e.children[0].instance==="Layout"&&e.children[0].type==="normal"&&e.children[0].children.length===1;)e.children=e.children[0].children;n?(a=new wa({direction:e.direction,size:e.size,type:e.type,resize:e.resize}),n.addLayout(a)):window.siyuan.layout.layout=new wa({element:document.getElementById("layouts"),direction:e.direction,size:e.size,type:e.type,resize:e.resize})}else if(e.instance==="Wnd")a=new Rc(t,e.resize,n.type),n.addWnd(a),e.width&&(a.element.classList.remove("fn__flex-1"),a.element.style.width=e.width),e.height&&(a.element.classList.remove("fn__flex-1"),a.element.style.height=e.height);else if(e.instance==="Tab"){if(!e.title)a=JE(t);else{let i=e.title;e.lang&&(i=window.siyuan.languages[e.lang]),a=new ut({icon:e.icon,docIcon:e.docIcon,title:i})}e.pin&&(a.headElement.classList.add("item--pin"),(e.docIcon||e.icon)&&a.headElement.querySelector(".item__text").classList.add("fn__none")),e.active&&a.headElement&&a.headElement.setAttribute("data-init-active","true"),n.addTab(a,!1,!1,e.activeTime)}else e.instance==="Editor"&&e.blockId?(window.siyuan.config.fileTree.openFilesUseCurrentTab&&n.headElement.classList.add("item--unupdate"),n.headElement.setAttribute("data-initdata",JSON.stringify(e))):e.instance==="Asset"?n.addModel(new li({app:t,tab:n,path:e.path,page:e.page})):e.instance==="Backlink"?n.addModel(new fs({app:t,tab:n,blockId:e.blockId,rootId:e.rootId,type:e.type})):e.instance==="Bookmark"?n.addModel(new vo(t,n)):e.instance==="Files"?n.addModel(new Li({app:t,tab:n})):e.instance==="Graph"?n.addModel(new ri({app:t,tab:n,blockId:e.blockId,rootId:e.rootId,type:e.type})):e.instance==="Outline"?n.addModel(new us({app:t,tab:n,blockId:e.blockId,type:e.type,isPreview:e.isPreview})):e.instance==="Tag"?n.addModel(new Eo(t,n)):e.instance==="Search"?n.addModel(new Mi({app:t,tab:n,config:e.config})):e.instance==="Custom"&&(window.siyuan.config.fileTree.openFilesUseCurrentTab&&n.headElement.classList.add("item--unupdate"),n.headElement.setAttribute("data-initdata",JSON.stringify(e)));"children"in e&&(Array.isArray(e.children)?e.children.forEach(i=>{zc(t,i,n?a:window.siyuan.layout.layout)}):e.children&&Object.keys(e.children).length>0?zc(t,e.children,a):a instanceof ut&&yk.push(a))},i0=(t,e)=>{zc(t,window.siyuan.config.uiLayout.layout,void 0),a0(window.siyuan.config.uiLayout,t),window.siyuan.config.fileTree.closeTabsOnStart&&e&&ba().forEach(a=>{a.headElement&&!a.headElement.classList.contains("item--pin")&&a.parent.removeTab(a.id,!1,!1,!1)}),document.querySelectorAll('li[data-type="tab-header"]').forEach(a=>{const i=a.getAttribute("data-initdata");if(i){const s=JSON.parse(i);if(s.instance==="Custom"&&s.customModelType!=="siyuan-card"){let o=!1;if(t.plugins.find(l=>{if(Object.keys(l.models).includes(s.customModelType))return o=!0,!0}),!o){const l=a.getAttribute("data-id"),r=Bt(l);r&&r.parent.removeTab(l,!1,!1,!1)}}}});const n=zS();if(n.id)de({app:t,id:n.id,action:n.isZoomIn?[u.CB_GET_ALL,u.CB_GET_FOCUS]:[u.CB_GET_FOCUS,u.CB_GET_CONTEXT,u.CB_GET_ROOTSCROLL],zoomIn:n.isZoomIn});else{let a;document.querySelectorAll('li[data-type="tab-header"][data-init-active="true"]').forEach(i=>{a?i.dataset.activetime>a.dataset.activetime&&(a=i):a=i;const s=Bt(i.getAttribute("data-id"));s.parent.switchTab(i,!1,!1,!0,!1),s.parent.showHeading()}),a&&tt(a.parentElement.parentElement.parentElement,!1),yk.forEach(i=>{i.parent.removeTab(i.id)})}t.plugins.forEach(a=>{Np(a)}),dn(),Rp()},Hi=(t,e,n)=>{t instanceof wa?(e.direction=t.direction,t.parent&&(t.element.classList.contains("fn__flex-1")?e.size="auto":e.size=(t.parent.direction==="tb"?t.element.clientHeight:t.element.clientWidth)+"px"),e.resize=t.resize,e.type=t.type,e.instance="Layout"):t instanceof Rc?(e.resize=t.resize,e.height=t.element.style.height,e.width=t.element.style.width,e.instance="Wnd"):t instanceof ut?(t.headElement&&(e.title=t.title,e.icon=t.icon,e.docIcon=t.docIcon,e.pin=t.headElement.classList.contains("item--pin"),t.model instanceof Li?e.lang="fileTree":t.model instanceof fs&&t.model.type==="pin"?e.lang="backlinks":t.model instanceof vo?e.lang="bookmark":t.model instanceof ri&&t.model.type!=="local"?e.lang="graphView":t.model instanceof us&&t.model.type!=="local"?e.lang="outline":t.model instanceof Eo&&(e.lang="tag"),t.headElement.classList.contains("item--focus")&&(e.active=!0)),e.instance="Tab",e.activeTime=t.headElement?.getAttribute("data-activetime")):t instanceof ht?(!t.editor.protyle.notebookId&&n&&(n.editor="true"),e.notebookId=t.editor.protyle.notebookId,e.blockId=t.editor.protyle.block.id,e.rootId=t.editor.protyle.block.rootID,e.mode=t.editor.protyle.preview.element.classList.contains("fn__none")?"wysiwyg":"preview",e.action=t.editor.protyle.block.showAll?u.CB_GET_ALL:u.CB_GET_SCROLL,e.instance="Editor"):t instanceof li?(e.path=t.path,t.pdfObject&&(e.page=t.pdfObject.page),e.instance="Asset"):t instanceof fs?(e.blockId=t.blockId,e.rootId=t.rootId,e.type=t.type,e.instance="Backlink"):t instanceof vo?e.instance="Bookmark":t instanceof Li?e.instance="Files":t instanceof ri?(e.blockId=t.blockId,e.rootId=t.rootId,e.type=t.type,e.instance="Graph"):t instanceof us?(e.blockId=t.blockId,e.type=t.type,e.isPreview=t.isPreview,e.instance="Outline"):t instanceof Eo?e.instance="Tag":t instanceof Mi?(e.instance="Search",e.config=t.config):t instanceof Wa&&(e.instance="Custom",e.customModelType=t.type,e.customModelData=Object.assign({},t.data)),t instanceof wa||t instanceof Rc?t instanceof wa&&(t.type==="bottom"||t.type==="left"||t.type==="right")?t.type==="bottom"?e.children=[{instance:"Wnd",children:[]},{instance:"Wnd",resize:"lr",children:[]}]:e.children=[{instance:"Wnd",children:[]},{instance:"Wnd",resize:"tb",children:[]}]:(e.children=[],t.children.forEach(a=>{const i={};e.children.push(i),Hi(a,i,n)})):t instanceof ut&&(t.model?(e.children={},Hi(t.model,e.children,n)):t.headElement?e.children=JSON.parse(t.headElement.getAttribute("data-initdata")||"{}"):e.children={})},Rp=()=>{const t=document.querySelector("#toolbar");if(!t)return;const e=t.querySelector("#drag");e.style.padding="";const n=t.querySelector("#barMore");n.classList.remove("fn__none"),n.removeAttribute("data-hideids"),Array.from(t.querySelectorAll('[data-hide="true"]')).forEach(c=>{c.classList.remove("fn__none"),c.removeAttribute("data-hide")});let a=e.nextElementSibling;const i=[];for(;t.scrollWidth>t.clientWidth+2&&(i.push(a.id),a.classList.add("fn__none"),a.setAttribute("data-hide","true"),a=a.nextElementSibling,a.id!=="barMore"););let s=e.previousElementSibling;for(;t.scrollWidth>t.clientWidth+2&&(i.push(s.id),s.classList.add("fn__none"),s.setAttribute("data-hide","true"),s=s.previousElementSibling,s.id!=="barWorkspace"););i.length>0?n.classList.remove("fn__none"):n.classList.add("fn__none"),n.setAttribute("data-hideids",i.join(","));const o=e.clientWidth,l=e.getBoundingClientRect(),r=l.left,d=window.innerWidth-l.right;r>d&&r-d<o/3?e.style.paddingRight=r-d+"px":r<d&&d-r<o/3&&(e.style.paddingLeft=d-r+"px"),window.siyuan.storage[u.LOCAL_PLUGINTOPUNPIN].forEach(c=>{t.querySelector("#"+c)?.classList.add("fn__none")})},wk=(t,e,n)=>{let a;return n.instance==="Custom"?n.customModelType==="siyuan-card"?a=cb({app:t,tab:e,data:n.customModelData}):t.plugins.find(i=>{if(i.models[n.customModelType])return a=i.models[n.customModelType]({tab:e,data:n.customModelData}),!0}):n.instance==="Editor"&&(a=new ht({app:t,tab:e,rootId:n.rootId,blockId:n.blockId,mode:n.mode,action:typeof n.action=="string"?[n.action]:n.action})),a},Io=t=>{const e=!!t.querySelector('.layout-tab-container > [data-loading="true"]');return e&&j(window.siyuan.languages.pdfIsLoading),e},Bt=(t,e=window.siyuan.layout.centerLayout)=>{const n=(a,i)=>{if(a.id===i)return a;if(!a.children)return;let s;for(let o=0;o<a.children.length;o++)if(s=n(a.children[o],i),s)return s};return n(e,t)},_k=t=>{if(!t.resize)return;const e=i=>{let s=232;return Array.from(i.querySelectorAll(".file-tree")).find(o=>{if((o.classList.contains("sy__backlink")||o.classList.contains("sy__graph")||o.classList.contains("sy__globalGraph")||o.classList.contains("sy__inbox"))&&!o.classList.contains("fn__none")&&!L(o,"fn__none"))return s=320,!0}),s},n=(i,s)=>{const o=(r,d)=>{r.classList.contains("fn__flex-1")&&(d==="lr"?r.style.width=r.clientWidth+"px":r.style.height=r.clientHeight+"px",r.classList.remove("fn__flex-1"))};let l;i.addEventListener("mousedown",r=>{Ce().editor.forEach(m=>{m.editor&&m.editor.protyle&&m.element.parentElement&&Q(["gutter"],m.editor.protyle)}),getSelection().rangeCount>0&&(l=getSelection().getRangeAt(0));const d=document,c=i.nextElementSibling,f=i.previousElementSibling;c.style.overflow="auto",f.style.overflow="auto",c.style.transition="none",f.style.transition="none",!c.nextElementSibling||c.nextElementSibling.classList.contains("layout__dockresize")?o(c,s):o(f,s);const g=r[s==="lr"?"clientX":"clientY"],p=s==="lr"?f.clientWidth:f.clientHeight,h=s==="lr"?c.clientWidth:c.clientHeight;d.ondragstart=()=>(document.querySelectorAll(".sy__file .b3-list-item").forEach(m=>{m.style.opacity==="0.1"&&(m.style.opacity="")}),!1),d.onmousemove=m=>{m.preventDefault(),m.stopPropagation();const b=p+(m[s==="lr"?"clientX":"clientY"]-g),y=h-(m[s==="lr"?"clientX":"clientY"]-g);b<8||y<8||window.siyuan.layout.leftDock?.layout.element.isSameNode(f)&&b<e(f)&&b<p||window.siyuan.layout.rightDock?.layout.element.isSameNode(c)&&y<e(c)&&y<h||window.siyuan.layout.bottomDock?.layout.element.isSameNode(c)&&y<64&&y<h||(f.classList.contains("fn__flex-1")||(f.style[s==="lr"?"width":"height"]=b+"px"),c.classList.contains("fn__flex-1")||(c.style[s==="lr"?"width":"height"]=y+"px"))},d.onmouseup=()=>{d.onmousemove=null,d.onmouseup=null,d.ondragstart=null,d.onselectstart=null,d.onselect=null,Op(ve()?window.siyuan.layout.centerLayout:void 0),ln(),ve()||(window.siyuan.layout.leftDock.setSize(),window.siyuan.layout.bottomDock.setSize(),window.siyuan.layout.rightDock.setSize()),l&&Z(l),c.style.overflow="",f.style.overflow="",c.style.transition="",f.style.transition=""}})},a=document.createElement("div");t.resize==="lr"&&a.classList.add("layout__resize--lr"),a.classList.add("layout__resize"),t.element.insertAdjacentElement("beforebegin",a),n(a,t.resize),a.addEventListener("dblclick",()=>{const i=a.previousElementSibling,s=a.nextElementSibling;if(i&&s){const o=["graph","inbox","globalGraph","backlink"];let l=232;s.style.transition="none",i.style.transition="none",a.classList.contains("layout__resize--lr")?i.classList.contains("layout__dockl")?(document.querySelectorAll("#dockLeft .dock__item--active").forEach(r=>{o.includes(r.getAttribute("data-type"))&&(l=320)}),i.style.width=l+"px",window.siyuan.layout.leftDock.setSize()):s.classList.contains("layout__dockr")?(document.querySelectorAll("#dockRight .dock__item--active").forEach(r=>{o.includes(r.getAttribute("data-type"))&&(l=320)}),s.style.width=l+"px",window.siyuan.layout.rightDock.setSize()):(i.style.width="",s.style.width="",i.classList.add("fn__flex-1"),s.classList.add("fn__flex-1"),a.parentElement.classList.contains("layout__dockb")&&window.siyuan.layout.bottomDock.setSize()):s.classList.contains("layout__dockb")?(s.style.height="232px",window.siyuan.layout.bottomDock.setSize()):(i.style.height="",s.style.height="",i.classList.add("fn__flex-1"),s.classList.add("fn__flex-1"),a.parentElement.classList.contains("layout__dockl")?window.siyuan.layout.leftDock.setSize():a.parentElement.classList.contains("layout__dockr")&&window.siyuan.layout.rightDock.setSize()),ln(),s.style.transition="",i.style.transition=""}})},Op=(t=window.siyuan.layout.centerLayout.parent)=>{t.children.forEach(a=>{a.element.style.maxWidth="",!a.element.style.width&&!a.element.classList.contains("layout__center")?a.element.style.minWidth="8px":a.element.style.minWidth=""});let e,n=Math.floor(window.innerWidth/24);for(;t.element.scrollWidth>t.element.clientWidth+2&&n>0;)t.children.find(a=>{if(a.element.style.width&&a.element.style.width!=="0px"&&(a.element.style.maxWidth=Math.max(Math.min(a.element.clientWidth,window.innerWidth)-8,64)+"px",e=a.element),t.element.scrollWidth<=t.element.clientWidth+2)return!0}),n--;e&&(e.style.maxWidth=Math.max(Math.min(e.clientWidth,window.innerWidth)-8,64)+"px"),t.children.forEach(a=>{a instanceof wa&&a.size!=="0px"&&Op(a)})},Ob=t=>{if(t.children.length<2||t.children[t.children.length-2].element.classList.contains("fn__flex-1"))return;t.children.forEach((n,a)=>{a!==t.children.length-2&&(t.direction==="lr"?n.element.classList.contains("fn__flex-1")&&(n.element.style.width=n.element.clientWidth+"px",n.element.classList.remove("fn__flex-1")):n.element.classList.contains("fn__flex-1")&&(n.element.style.height=n.element.clientHeight+"px",n.element.classList.remove("fn__flex-1")))});const e=t.children[t.children.length-2].element;t.direction==="lr"?e.style.width&&(e.style.width="",e.classList.add("fn__flex-1")):e.style.height&&(e.style.height="",e.classList.add("fn__flex-1"))},Kl=(t,e)=>new T({label:window.siyuan.languages[t],icon:t.replace("moveTo","icon"),click:()=>{t.indexOf("moveToLeft")>-1?window.siyuan.layout.leftDock.add(t.endsWith("Top")?0:1,e):t.indexOf("moveToRight")>-1?window.siyuan.layout.rightDock.add(t.endsWith("Top")?0:1,e):t.indexOf("moveToBottom")>-1&&window.siyuan.layout.bottomDock.add(t.endsWith("Left")?0:1,e)}}),vk=t=>(window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.append(Kl("moveToLeftTop",t).element),window.siyuan.menus.menu.append(Kl("moveToLeftBottom",t).element),window.siyuan.menus.menu.append(Kl("moveToRightTop",t).element),window.siyuan.menus.menu.append(Kl("moveToRightBottom",t).element),window.siyuan.menus.menu.append(Kl("moveToBottomLeft",t).element),window.siyuan.menus.menu.append(Kl("moveToBottomRight",t).element),window.siyuan.menus.menu),s0=t=>{const e=new st;if(!e.isOpen)return e.addItem({id:"copy",label:window.siyuan.languages.copy,icon:"iconCopy",click(){if(getSelection().rangeCount===0)return;getSelection().getRangeAt(0).toString()||getSelection().getRangeAt(0).selectNode(t),document.execCommand("copy")}}),e.addItem({id:"selectAll",label:window.siyuan.languages.selectAll,icon:"iconSelect",click(){getSelection().rangeCount!==0&&getSelection().getRangeAt(0).selectNode(t)}}),e};class o0{constructor(e){this.menu=new tL,window.addEventListener("contextmenu",n=>{if(n.shiftKey)return;let a=n.target;if(L(a,"av__panel")&&!L(a,"b3-menu")){document.querySelector(".av__panel").dispatchEvent(new CustomEvent("click",{detail:"close"})),n.stopPropagation(),n.preventDefault();return}for(a.classList.contains("b3-text-field")||a.tagName==="INPUT"&&a.type==="text"?(ee.ipcRenderer.send(u.SIYUAN_CONTEXT_MENU,{undo:window.siyuan.languages.undo,redo:window.siyuan.languages.redo,copy:window.siyuan.languages.copy,cut:window.siyuan.languages.cut,delete:window.siyuan.languages.delete,paste:window.siyuan.languages.paste,pasteAsPlainText:window.siyuan.languages.pasteAsPlainText,selectAll:window.siyuan.languages.selectAll}),n.stopPropagation()):n.preventDefault();a&&a.parentElement&&!a.parentElement.isEqualNode(document.querySelector("body"));){const i=a.getAttribute("data-type");if(i==="tab-header"){this.unselect(),ak(e,Bt(a.getAttribute("data-id"))).popup({x:n.clientX,y:n.clientY}),n.stopPropagation();break}else if(i==="navigation-root"&&!window.siyuan.config.readonly){if(a.querySelector(".b3-list-item__text").classList.contains("ft__on-surface"))return;this.unselect(),Tf(e,a).popup({x:n.clientX,y:n.clientY}),tt(L(a,"sy__file")),n.stopPropagation();break}else if(i==="navigation-file"){this.unselect(),If(e,this.getDir(a),a.getAttribute("data-path"),a).popup({x:n.clientX,y:n.clientY}),tt(L(a,"sy__file")),n.stopPropagation();break}else if(i==="search-item"){const s=a.getAttribute("data-node-id");s&&ok(s).popup({x:n.clientX,y:n.clientY}),n.stopPropagation();break}else if(i&&a.classList.contains("dock__item")){Zt(),vk(a).popup({x:n.clientX,y:n.clientY}),n.stopPropagation();break}else if(i==="textMenu"){s0(a).open({x:n.clientX,y:n.clientY}),n.stopPropagation(),n.preventDefault();break}a=a.parentElement}},!1)}getDir(e){const n=fe(e,"UL");if(n)return n.getAttribute("data-url")}unselect(){getSelection().rangeCount>0&&getSelection().getRangeAt(0).collapse(!0)}}const l0=t=>{const e=Bt(t.data);e&&e instanceof ut&&e.parent.removeTab(t.data)},r0=t=>{switch(t.cmd){case"closetab":l0(t);break;case"lockscreen":Xt({errorExit:!1,cb(){E("/api/system/logoutAuth",{},()=>{Xy()})}});break;case"lockscreenByMode":window.siyuan.config.system.lockScreenMode===1&&Xt({errorExit:!1,cb(){E("/api/system/logoutAuth",{},()=>{Xy()})}});break}},c0=()=>{E("/api/system/getChangelog",{},t=>{if(!t.data.show)return;const e=new we({title:`\u2728 ${window.siyuan.languages.whatsNewInSiYuan} v${window.siyuan.config.system.kernelVersion}`,width:W()?"92vw":"768px",height:W()?"80vh":"70vh",content:`<div style="overflow:auto;" class="b3-dialog__content b3-typography b3-typography--default">${t.data.html}</div>`});e.element.setAttribute("data-key",u.DIALOG_CHANGELOG),ze(e.element)})},Ek=(t,e,n)=>{let a=1,i=t;for(;i&&(i.classList.contains("list")||i.classList.contains("li"));)i=document.elementFromPoint(e+73*a,n),i=P(i),a++;return i},d0=(t,e)=>{if(document.body.classList.contains("body--blur")||document.getElementById("progress"))return;const n=window.siyuan.coordinates??(window.siyuan.coordinates={pageX:0,pageY:0,clientX:0,clientY:0,screenX:0,screenY:0});n.pageX=t.pageX,n.pageY=t.pageY,n.clientX=t.clientX,n.clientY=t.clientY,n.screenX=t.screenX,n.screenY=t.screenY,window.siyuan.hideBreadcrumb&&(window.siyuan.hideBreadcrumb=!1,Mn().forEach(o=>{o.protyle.breadcrumb?.element.classList.contains("protyle-breadcrumb__bar--hide")&&(o.protyle.breadcrumb.element.classList.remove("protyle-breadcrumb__bar--hide"),o.protyle.breadcrumb.render(o.protyle,!0))}));const a=t.target;!e&&t.buttons===0&&window.siyuan.layout.bottomDock&&!ve()&&(t.clientX<Math.max(document.getElementById("dockLeft").clientWidth+1,16)?!window.siyuan.layout.leftDock.pin&&window.siyuan.layout.leftDock.layout.element.clientWidth>0&&(window.siyuan.layout.leftDock.element.clientWidth>0||window.siyuan.layout.leftDock.element.clientWidth===0&&t.clientX<8)&&(t.clientY>document.getElementById("toolbar").clientHeight&&t.clientY<window.innerHeight-document.getElementById("status").clientHeight-document.getElementById("dockBottom").clientHeight?!L(a,"b3-menu")&&!L(a,"protyle-toolbar")&&!L(a,"protyle-util")&&!L(a,"b3-dialog",!0)&&!L(a,"layout--float")&&window.siyuan.layout.leftDock.showDock():window.siyuan.layout.leftDock.hideDock()):t.clientX>window.innerWidth-Math.max(document.getElementById("dockRight").clientWidth-2,16)&&!window.siyuan.layout.rightDock.pin&&window.siyuan.layout.rightDock.layout.element.clientWidth>0&&(window.siyuan.layout.rightDock.element.clientWidth>0||window.siyuan.layout.rightDock.element.clientWidth===0&&t.clientX>window.innerWidth-8)&&(t.clientY>document.getElementById("toolbar").clientHeight&&t.clientY<window.innerHeight-document.getElementById("status").clientHeight-document.getElementById("dockBottom").clientHeight?!L(a,"b3-menu")&&!L(a,"layout--float")&&!L(a,"protyle-toolbar")&&!L(a,"protyle-util")&&!L(a,"b3-dialog",!0)&&window.siyuan.layout.rightDock.showDock():window.siyuan.layout.rightDock.hideDock()),t.clientY>Math.min(window.innerHeight-10,window.innerHeight-(window.siyuan.config.uiLayout.hideDock?0:document.getElementById("dockBottom").clientHeight)-document.querySelector("#status").clientHeight)&&window.siyuan.layout.bottomDock.showDock());const i=t.composedPath()[0];if(i&&i.nodeType!==3&&i.classList.contains("protyle-wysiwyg")&&i.style.paddingLeft){const o=document.elementFromPoint(i.getBoundingClientRect().left+parseInt(i.style.paddingLeft)+13,t.clientY),l=P(o);if(l){const r=Ek(l,l.getBoundingClientRect().left+1,t.clientY);if(!r)return;let d;r.classList.contains("av")&&(d=L(o,"av__row"));const c=Ce();let f=!1;c.editor.find(g=>{if(g.editor.protyle.wysiwyg.element.isSameNode(i))return g.editor.protyle.gutter.render(g.editor.protyle,r,g.editor.protyle.wysiwyg.element,d),f=!0,!0}),f||window.siyuan.blockPanels.find(g=>{if(g.editors.find(p=>{if(p.protyle.wysiwyg.element.contains(i))return p.protyle.gutter.render(p.protyle,r,p.protyle.wysiwyg.element,d),f=!0,!0}),f)return!0}),f||c.backlink.find(g=>{if(g.editors.find(p=>{if(p.protyle.wysiwyg.element.isSameNode(i))return p.protyle.gutter.render(p.protyle,r,p.protyle.wysiwyg.element,d),f=!0,!0}),f)return!0})}return}if(i&&i.nodeType!==3&&(i.classList.contains("li")||i.classList.contains("list"))){const o=Ek(i,i.getBoundingClientRect().left+1,t.clientY);if(!o)return;const l=Ce();let r=!1;l.editor.find(d=>{if(d.editor.protyle.wysiwyg.element.contains(i))return d.editor.protyle.gutter.render(d.editor.protyle,o,d.editor.protyle.wysiwyg.element),r=!0,!0}),r||window.siyuan.blockPanels.find(d=>{if(d.editors.find(c=>{if(c.protyle.wysiwyg.element.contains(i))return c.protyle.gutter.render(c.protyle,o,c.protyle.wysiwyg.element),r=!0,!0}),r)return!0}),r||l.backlink.find(d=>{if(d.editors.find(c=>{if(c.protyle.wysiwyg.element.contains(i))return c.protyle.gutter.render(c.protyle,o,c.protyle.wysiwyg.element),r=!0,!0}),r)return!0});return}if(i&&i.nodeType!==3&&i.classList.contains("av")&&i.getAttribute("data-type")==="NodeAttributeView"){const o=L(document.elementFromPoint(i.firstElementChild.getBoundingClientRect().left+10,t.clientY),"av__row");if(o&&!o.classList.contains("av__row--header")){Mn().find(l=>{if(l.protyle.wysiwyg.element.contains(i))return l.protyle.gutter.render(l.protyle,i,l.protyle.wysiwyg.element,o),!0});return}}L(a,"protyle",!0)||document.querySelectorAll(".protyle-gutters").forEach(o=>{o.classList.add("fn__none"),o.innerHTML=""});const s=L(a,"table");if(s&&s.style.cursor!=="col-resize"&&!L(s,"protyle-wysiwyg__embed")){const o=q(a,"TH")||q(a,"TD");if(o){const l=s.querySelector("table"),r=s.querySelector("table").clientHeight,d=s.querySelector(".table__resize");s.style.textAlign==="center"||s.style.textAlign==="right"?d.parentElement.style.left=l.offsetLeft+"px":d.parentElement.style.left="";const c=o.getBoundingClientRect();c.right-t.clientX<3&&c.right-t.clientX>0?(d.setAttribute("data-col-index",(ca(o)+o.colSpan-1).toString()),d.setAttribute("style",`height:${r}px;left: ${Math.round(o.offsetWidth+o.offsetLeft-s.firstElementChild.scrollLeft-3)}px;display:block`)):t.clientX-c.left<3&&t.clientX-c.left>0&&o.previousElementSibling&&(d.setAttribute("data-col-index",(ca(o)-1).toString()),d.setAttribute("style",`height:${r}px;left: ${Math.round(o.offsetLeft-s.firstElementChild.scrollLeft-3)}px;display:block`))}}},u0=(t,e)=>{window.siyuan.ctrlIsPressed=!1,window.siyuan.shiftIsPressed=!1,window.siyuan.altIsPressed=!1;const n=window.siyuan.dialogs.find(a=>{if(a.element.getAttribute("data-key")===u.DIALOG_SWITCHTAB)return!0});if(n&&n.element.parentElement){if(window.siyuan.config.keymap.general.goToEditTabNext.custom.endsWith(u.KEYCODELIST[e.keyCode])||window.siyuan.config.keymap.general.goToEditTabPrev.custom.endsWith(u.KEYCODELIST[e.keyCode])){let a=n.element.querySelector(".b3-list-item--focus");if(a.classList.remove("b3-list-item--focus"),H(window.siyuan.config.keymap.general.goToEditTabPrev.custom,e)?a.previousElementSibling?a.previousElementSibling.classList.add("b3-list-item--focus"):a.getAttribute("data-original")?(a.parentElement.lastElementChild.classList.add("b3-list-item--focus"),a.removeAttribute("data-original")):a.parentElement.nextElementSibling?a.parentElement.nextElementSibling.lastElementChild?a.parentElement.nextElementSibling.lastElementChild.classList.add("b3-list-item--focus"):a.parentElement.lastElementChild.classList.add("b3-list-item--focus"):a.parentElement.previousElementSibling&&a.parentElement.previousElementSibling.lastElementChild.classList.add("b3-list-item--focus"):a.nextElementSibling?a.nextElementSibling.classList.add("b3-list-item--focus"):a.getAttribute("data-original")?(a.parentElement.firstElementChild.classList.add("b3-list-item--focus"),a.removeAttribute("data-original")):a.parentElement.nextElementSibling?a.parentElement.nextElementSibling.firstElementChild?a.parentElement.nextElementSibling.firstElementChild.classList.add("b3-list-item--focus"):a.parentElement.firstElementChild.classList.add("b3-list-item--focus"):a.parentElement.previousElementSibling&&a.parentElement.previousElementSibling.firstElementChild.classList.add("b3-list-item--focus"),a=n.element.querySelector(".b3-list-item--focus"),a){const s=a.getAttribute("data-node-id");s?E("/api/filetree/getFullHPathByID",{id:s},r=>{a.parentElement.parentElement.nextElementSibling.innerHTML=pe(r.data)}):a.parentElement.parentElement.nextElementSibling.innerHTML=a.querySelector(".b3-list-item__text").innerHTML;const o=a.getBoundingClientRect(),l=a.parentElement.getBoundingClientRect();o.top<l.top?a.scrollIntoView(!0):o.bottom>l.bottom&&a.scrollIntoView(!1)}const i=n.element.querySelector('[data-original="true"]');i&&i.removeAttribute("data-original")}else if(window.siyuan.config.keymap.general.goToEditTabNext.custom.startsWith(u.KEYCODELIST[e.keyCode])||window.siyuan.config.keymap.general.goToEditTabPrev.custom.startsWith(u.KEYCODELIST[e.keyCode])){let a=n.element.querySelector(".b3-list-item--focus");a.getAttribute("data-original")&&(a.classList.remove("b3-list-item--focus"),H(window.siyuan.config.keymap.general.goToEditTabPrev.custom,e)?a.previousElementSibling?a.previousElementSibling.classList.add("b3-list-item--focus"):(a.parentElement.lastElementChild.classList.add("b3-list-item--focus"),a.removeAttribute("data-original")):a.nextElementSibling?a.nextElementSibling.classList.add("b3-list-item--focus"):a.parentElement.firstElementChild.classList.add("b3-list-item--focus"),a.removeAttribute("data-original"),a=n.element.querySelector(".b3-list-item--focus"));const i=a.getAttribute("data-type");if(i)i==="riffCard"?_l(t):Qe(i).toggleModel(i,!0),document.activeElement&&document.activeElement.blur();else{const s=a.getAttribute("data-id");ba().find(o=>{if(o.id===s)return o.parent.switchTab(o.headElement),o.parent.showHeading(),!0})}n.destroy()}}},f0=t=>{const e=t.target,n=L(e,"protyle-background");if(n&&e.tagName==="IMG"&&n.firstElementChild.querySelector(".protyle-icons").classList.contains("fn__none")){const a=L(e,"protyle-content",!0);if(!a)return!1;a.style.overflow="hidden";const i=t.touches[0].clientY,s=e.naturalHeight*e.clientWidth/e.naturalWidth-e.clientHeight;let o=parseFloat(e.style.objectPosition.substring(7))||50;e.style.objectPosition.endsWith("px")&&(o=-parseInt(e.style.objectPosition.substring(7))/s*100);const l=document;return l.ontouchmove=r=>{e.style.objectPosition=`center ${((i-r.touches[0].clientY)/s*100+o).toFixed(2)}%`},l.ontouchend=()=>{a.style.overflow="",l.ontouchmove=null,l.ontouchstart=null,l.ondragstart=null,l.onselectstart=null,l.onselect=null},t.stopImmediatePropagation(),!0}return n?n.classList.contains("protyle-background--enable")&&n.classList.add("protyle-background--mobileshow"):document.querySelector(".protyle-background--mobileshow")?.classList.remove("protyle-background--mobileshow"),!1},p0=(t,e,n,a)=>{const i=t.target,s=Da();if(typeof e>"u"&&new Date().getTime()-n>900){const o=B(i,"data-type","navigation-root")||B(i,"data-type","navigation-file");if(o){if(!window.siyuan.config.readonly&&o.dataset.type==="navigation-root"){const l=Tf(a,o);if(s){const r=o.getBoundingClientRect();l.popup({x:r.right-52,y:r.bottom,h:r.height}),Zt()}else window.siyuan.menus.menu.fullscreen("bottom")}else if(o.dataset.type==="navigation-file"){const l=fe(o,"UL");if(l){const r=If(a,l.dataset.url,o.dataset.path,o);if(s){const d=o.getBoundingClientRect();r.popup({x:d.right-52,y:d.bottom,h:d.height}),Zt()}else window.siyuan.menus.menu.fullscreen("bottom")}}return!0}if(i.tagName==="SPAN"&&!F(i)){let l;const r=L(i,"protyle",!0);if(r){const f=Bt(r.dataset.id);f instanceof ut&&f.model instanceof ht&&(l=f.model.editor)}if(!l)return!1;const d=(i.getAttribute("data-type")||"").split(" ");if(d.includes("inline-memo")&&l.protyle.toolbar.showRender(l.protyle,i),l.protyle.disabled)return t.stopImmediatePropagation(),t.preventDefault(),!0;if(d.includes("block-ref"))return fm(l.protyle,i),!0;if(d.includes("file-annotation-ref"))return um(l.protyle,i),!0;if(d.includes("tag"))return hm(l.protyle,i),!0;if(d.includes("a"))return bc(l.protyle,i),!0;const c=B(i,"data-type","inline-math");if(c)return zf(l.protyle,c),!0}}return!1},g0=t=>{document.body.addEventListener("mouseleave",()=>{window.siyuan.layout.leftDock&&(window.siyuan.layout.leftDock.hideDock(),window.siyuan.layout.rightDock.hideDock(),window.siyuan.layout.bottomDock.hideDock()),document.querySelectorAll(".protyle-gutters").forEach(a=>{a.classList.add("fn__none"),a.innerHTML=""}),Zt()});let e=!1;document.body.addEventListener("mouseenter",()=>{window.siyuan.layout.leftDock&&(e=!0,setTimeout(()=>{e=!1},u.TIMEOUT_TRANSITION))}),window.addEventListener("mousemove",a=>{d0(a,e)}),window.addEventListener("mouseup",a=>{a.button===3?(a.preventDefault(),ap(t)):a.button===4&&(a.preventDefault(),ip(t))}),window.addEventListener("mousedown",a=>{L(a.target,"protyle-toolbar")||Ji(["toolbar"])}),window.addEventListener("keyup",a=>{u0(t,a)}),window.addEventListener("keydown",a=>{JT(t,a)}),window.addEventListener("blur",()=>{window.siyuan.ctrlIsPressed=!1,window.siyuan.shiftIsPressed=!1,window.siyuan.altIsPressed=!1}),window.addEventListener("click",a=>{vT(a)});let n=0;document.addEventListener("touchstart",a=>{n=new Date().getTime();const i=a.target;if(L(i,"protyle-icons")||L(i,"item")||i.classList.contains("protyle-background__icon"))return;const s=F(i);if(s){s.firstElementChild.classList.toggle("protyle-icons--show");return}f0(a)},!1),document.addEventListener("touchend",a=>{if(Da()){if(p0(a,void 0,n,t)){a.stopImmediatePropagation(),a.preventDefault();return}if(new Date().getTime()-n<=900)return;const i=a.target,s=L(i,"dock__item");if(s&&s.getAttribute("data-type")){const r=s.getBoundingClientRect();vk(s).popup({x:r.right,y:r.top}),a.stopImmediatePropagation(),a.preventDefault();return}const o=B(i,"data-type","tab-header");if(o){const r=o.getBoundingClientRect();ak(t,Bt(o.getAttribute("data-id"))).popup({x:r.left,y:r.bottom}),Zt(),a.stopImmediatePropagation(),a.preventDefault();return}const l=L(i,"protyle-breadcrumb__item");if(l){const r=l.getAttribute("data-id")||l.getAttribute("data-node-id");r&&Ke(r,d=>{de({app:t,id:r,action:d?[u.CB_GET_FOCUS,u.CB_GET_ALL]:[u.CB_GET_FOCUS,u.CB_GET_CONTEXT],zoomIn:d}),window.siyuan.menus.menu.remove()}),a.stopImmediatePropagation(),a.preventDefault();return}}},!1)},h0=(t,e)=>{VT(e),ee.ipcRenderer.invoke(u.SIYUAN_INIT,{languages:window.siyuan.languages._trayMenu,workspaceDir:window.siyuan.config.system.workspaceDir,port:location.port}),ee.webFrame.setZoomFactor(window.siyuan.storage[u.LOCAL_ZOOM]),ee.ipcRenderer.send(u.SIYUAN_CMD,{cmd:"setTrafficLightPosition",zoom:window.siyuan.storage[u.LOCAL_ZOOM],position:u.SIZE_ZOOM.find(i=>i.zoom===window.siyuan.storage[u.LOCAL_ZOOM]).position}),(!window.siyuan.config.uiLayout||window.siyuan.config.uiLayout&&!window.siyuan.config.uiLayout.left)&&(window.siyuan.config.uiLayout=u.SIYUAN_EMPTY_LAYOUT),g0(e),E("/api/system/getEmojiConf",{},i=>{window.siyuan.emojis=i.data;try{i0(e,t),setTimeout(()=>{Op()}),Gl(e),c0()}catch{bk()}}),UT(e),rT(),m0(e),lt.onSetappearance(window.siyuan.config.appearance),Hx(),Rl(),dw();let n=0,a=!0;window.addEventListener("resize",()=>{a&&(op(),a=!1),window.clearTimeout(n),n=window.setTimeout(()=>{Op(),ln(),Rp(),a=!0},200)}),Rx()},Vc=async()=>{const t=document.getElementById("maxWindow"),e=document.getElementById("restoreWindow"),n=await ee.ipcRenderer.invoke(u.SIYUAN_GET,{cmd:"isFullScreen"});await ee.ipcRenderer.invoke(u.SIYUAN_GET,{cmd:"isMaximized"})||n?(e.style.display="flex",t.style.display="none"):(e.style.display="none",t.style.display="flex")},m0=async t=>{const e=(n=!1)=>{Xt({cb(){window.siyuan.config.appearance.closeButtonBehavior===1&&!n?window.siyuan.config.system.os==="windows"?ee.ipcRenderer.send(u.SIYUAN_CONFIG_TRAY,{languages:window.siyuan.languages._trayMenu}):ee.ipcRenderer.send(u.SIYUAN_CMD,"closeButtonBehavior"):So()},errorExit:!0})};if(ee.ipcRenderer.send(u.SIYUAN_EVENT),ee.ipcRenderer.on(u.SIYUAN_EVENT,(n,a)=>{a==="focus"?(window.siyuan.altIsPressed=!1,window.siyuan.ctrlIsPressed=!1,window.siyuan.shiftIsPressed=!1,document.body.classList.remove("body--blur")):a==="blur"?document.body.classList.add("body--blur"):a==="enter-full-screen"?window.siyuan.config.system.os==="darwin"?ve()?bo():document.getElementById("toolbar").style.paddingLeft="0":Vc():a==="leave-full-screen"?window.siyuan.config.system.os==="darwin"?ve()?bo():document.getElementById("toolbar").setAttribute("style",""):Vc():(a==="maximize"||a==="unmaximize")&&Vc()}),ve()||ee.ipcRenderer.on(u.SIYUAN_OPEN_URL,(n,a)=>{let i;try{if(i=new URL(a),i.protocol!=="siyuan:")return}catch{return}if(i&&i.pathname.startsWith("//plugins/")){const s=i.pathname.replace("//plugins/","");if(!s)return;t.plugins.find(o=>{if(s.startsWith(o.name)){if(o.eventBus.emit("open-siyuan-url-plugin",{url:a}),s.split("/")[0]!==o.name){let l=i.searchParams.get("data");try{l=JSON.parse(l||"{}")}catch(r){console.log("Error open plugin tab with protocol:",r)}ma({app:t,custom:{title:i.searchParams.get("title"),icon:i.searchParams.get("icon"),data:l,id:s}})}return!0}});return}if(i&&Jy(a)){const s=Zr(a),o=i.searchParams.get("focus")==="1";E("/api/block/checkBlockExist",{id:s},l=>{l.data&&(Ke(s,r=>{de({app:t,id:s,action:r||o?[u.CB_GET_FOCUS,u.CB_GET_ALL]:[u.CB_GET_FOCUS,u.CB_GET_CONTEXT,u.CB_GET_ROOTSCROLL],zoomIn:r||o})}),ee.ipcRenderer.send(u.SIYUAN_CMD,"show")),t.plugins.forEach(r=>{r.eventBus.emit("open-siyuan-url-block",{url:a,id:s,focus:o,exist:l.data})})});return}}),ee.ipcRenderer.on(u.SIYUAN_OPEN_FILE,(n,a)=>{a.app||(a.app=t),ma(a)}),ee.ipcRenderer.on(u.SIYUAN_SAVE_CLOSE,(n,a)=>{ve()?pb(t):e(a)}),ee.ipcRenderer.on(u.SIYUAN_SEND_WINDOWS,(n,a)=>{r0(a)}),ee.ipcRenderer.on(u.SIYUAN_HOTKEY,(n,a)=>{let i=!1;t.plugins.find(s=>{if(s.commands.find(o=>{if(o.globalCallback&&a.hotkey===o.customHotkey)return i=!0,o.globalCallback(),!0}),i)return!0})}),ee.ipcRenderer.on(u.SIYUAN_EXPORT_PDF,async(n,a)=>{const i=j(window.siyuan.languages.exporting,-1);window.siyuan.storage[u.LOCAL_EXPORTPDF]={removeAssets:a.removeAssets,keepFold:a.keepFold,mergeSubdocs:a.mergeSubdocs,watermark:a.watermark,landscape:a.pdfOptions.landscape,marginType:a.pdfOptions.marginType,pageSize:a.pdfOptions.pageSize,scale:a.pdfOptions.scale,marginTop:a.pdfOptions.margins.top,marginRight:a.pdfOptions.margins.right,marginBottom:a.pdfOptions.margins.bottom,marginLeft:a.pdfOptions.margins.left},ue(u.LOCAL_EXPORTPDF,window.siyuan.storage[u.LOCAL_EXPORTPDF]);try{if(window.siyuan.config.export.pdfFooter.trim()){const d=await Re("/api/template/renderSprig",{template:window.siyuan.config.export.pdfFooter});a.pdfOptions.displayHeaderFooter=!0,a.pdfOptions.headerTemplate="<span></span>",a.pdfOptions.footerTemplate=`<div style="text-align:center;width:100%;font-size:10px;line-height:12px;">
${d.data.replace("%pages","<span class=totalPages></span>").replace("%page","<span class=pageNumber></span>")}
</div>`}const s=await ee.ipcRenderer.invoke(u.SIYUAN_GET,{cmd:"printToPDF",pdfOptions:a.pdfOptions,webContentsId:a.webContentsId}),o=a.filePaths[0];let l=Ft.join(o,mw(a.rootTitle)+".pdf");l=(await Re("/api/file/getUniqueFilename",{path:l})).data.path,E("/api/export/exportHTML",{id:a.rootId,pdf:!0,removeAssets:a.removeAssets,merge:a.mergeSubdocs,savePath:o},()=>{Qi.writeFileSync(l,s),ee.ipcRenderer.send(u.SIYUAN_CMD,{cmd:"destroy",webContentsId:a.webContentsId}),E("/api/export/processPDF",{id:a.rootId,merge:a.mergeSubdocs,path:l,removeAssets:a.removeAssets,watermark:a.watermark},async()=>{if(uf(l,i),a.removeAssets){const d=f=>new Promise(function(g){Qi.stat(f,function(p,h){h&&(h.isDirectory()?Qi.readdir(f,function(m,b){b=b.map(y=>Ft.join(f,y)),Promise.all(b.map(y=>d(y))).then(function(){Qi.rm(f,g)})}):Qi.unlink(f,g))})}),c=Ft.join(o,"assets");await d(c),1>Qi.readdirSync(c).length&&Qi.rmdirSync(c)}})})}catch(s){console.error(s),j(window.siyuan.languages.exportPDFLowMemory,0,"error",i),ee.ipcRenderer.send(u.SIYUAN_CMD,{cmd:"destroy",webContentsId:a.webContentsId})}ee.ipcRenderer.send(u.SIYUAN_CMD,{cmd:"hide",webContentsId:a.webContentsId})}),ve()){document.body.insertAdjacentHTML("beforeend",`<div class="toolbar__window">
<div class="toolbar__item ariaLabel" aria-label="${window.siyuan.languages.pin}" id="pinWindow">
    <svg>
        <use xlink:href="#iconPin"></use>
    </svg>
</div></div>`);const n=document.getElementById("pinWindow");n.addEventListener("click",()=>{n.getAttribute("aria-label")===window.siyuan.languages.pin?(n.querySelector("use").setAttribute("xlink:href","#iconUnpin"),n.setAttribute("aria-label",window.siyuan.languages.unpin),ee.ipcRenderer.send(u.SIYUAN_CMD,"setAlwaysOnTopTrue")):(n.querySelector("use").setAttribute("xlink:href","#iconPin"),n.setAttribute("aria-label",window.siyuan.languages.pin),ee.ipcRenderer.send(u.SIYUAN_CMD,"setAlwaysOnTopFalse"))})}if(window.siyuan.config.system.os!=="darwin"){document.body.classList.add("body--win32");const n=`<div class="toolbar__item ariaLabel toolbar__item--win" aria-label="${window.siyuan.languages.min}" id="minWindow">
    <svg>
        <use xlink:href="#iconMin"></use>
    </svg>
</div>
<div aria-label="${window.siyuan.languages.max}" class="ariaLabel toolbar__item toolbar__item--win" id="maxWindow">
    <svg>
        <use xlink:href="#iconMax"></use>
    </svg>
</div>
<div aria-label="${window.siyuan.languages.restore}" class="ariaLabel toolbar__item toolbar__item--win" id="restoreWindow">
    <svg>
        <use xlink:href="#iconRestore"></use>
    </svg>
</div>
<div aria-label="${window.siyuan.languages.close}" class="ariaLabel toolbar__item toolbar__item--close" id="closeWindow">
    <svg>
        <use xlink:href="#iconClose"></use>
    </svg>
</div>`;ve()?document.querySelector(".toolbar__window").insertAdjacentHTML("beforeend",n):document.getElementById("windowControls").innerHTML=n;const a=document.getElementById("maxWindow");document.getElementById("restoreWindow").addEventListener("click",()=>{ee.ipcRenderer.send(u.SIYUAN_CMD,"restore")}),a.addEventListener("click",()=>{ee.ipcRenderer.send(u.SIYUAN_CMD,"maximize")}),Vc();const s=document.getElementById("minWindow"),o=document.getElementById("closeWindow");s.addEventListener("click",()=>{s.classList.contains("window-controls__item--disabled")||ee.ipcRenderer.send(u.SIYUAN_CMD,"minimize")}),o.addEventListener("click",()=>{ve()?pb(t):e()})}else{const n=document.getElementById("toolbar");await ee.ipcRenderer.invoke(u.SIYUAN_GET,{cmd:"isFullScreen"})&&!ve()&&(n.style.paddingLeft="0")}},b0=(t,e={scope:"/",type:"classic",updateViaCache:"all"})=>{};class y0{constructor(){this.plugins=[],b0(`${u.SERVICE_WORKER_PATH}?v=${u.SIYUAN_VERSION}`),VS(),this.appId=u.SIYUAN_APPID,window.siyuan={zIndex:10,transactions:[],reqIds:{},backStack:[],layout:{},dialogs:[],blockPanels:[],ctrlIsPressed:!1,altIsPressed:!1,ws:new Vn({app:this,id:K(),type:"main",msgCallback:e=>{if(this.plugins.forEach(n=>{n.eventBus.emit("ws-main",e)}),e)switch(e.cmd){case"setDefRefCount":tT(e.data);break;case"setRefDynamicText":eT(e.data);break;case"reloadPlugin":n0(this,e.data);break;case"reloadEmojiConf":YS();break;case"syncMergeResult":hb(this,e.data);break;case"reloaddoc":hb(this,{upsertRootIDs:[e.data],removeRootIDs:[]},!1,!1,!0);break;case"readonly":window.siyuan.config.editor.readOnly=e.data,Ji(["util"]);break;case"setConf":window.siyuan.config=e.data;break;case"progress":iT(e);break;case"setLocalStorageVal":window.siyuan.storage[e.data.key]=e.data.val;break;case"rename":ba().forEach(n=>{if(n.headElement){const a=n.headElement.getAttribute("data-initdata");if(a){const i=JSON.parse(a);i.instance==="Editor"&&i.rootId===e.data.id&&n.updateTitle(e.data.title)}}});break;case"unmount":ba().forEach(n=>{if(n.headElement){const a=n.headElement.getAttribute("data-initdata");if(a){const i=JSON.parse(a);i.instance==="Editor"&&e.data.box===i.notebookId&&n.parent.removeTab(n.id)}}});break;case"removeDoc":ba().forEach(n=>{if(n.headElement){const a=n.headElement.getAttribute("data-initdata");if(a){const i=JSON.parse(a);i.instance==="Editor"&&e.data.ids.includes(i.rootId)&&n.parent.removeTab(n.id)}}});break;case"statusbar":aT(e);break;case"downloadProgress":lT(e.data);break;case"txerr":nT();break;case"syncing":Ya(e,this.plugins);break;case"backgroundtask":sT(e.data.tasks);break;case"refreshtheme":window.siyuan.config.appearance.mode===1&&window.siyuan.config.appearance.themeDark!=="midnight"||window.siyuan.config.appearance.mode===0&&window.siyuan.config.appearance.themeLight!=="daylight"?document.getElementById("themeStyle").href=e.data.theme:document.getElementById("themeDefaultStyle").href=e.data.theme;break;case"openFileById":de({app:this,id:e.data.id,action:[u.CB_GET_FOCUS]});break}}})},E("/api/system/getConf",{},async e=>{US(`${u.PROTYLE_CDN}/js/lute/lute.min.js?v=${u.SIYUAN_VERSION}`,"protyleLuteScript"),Ct(`${u.PROTYLE_CDN}/js/protyle-html.js?v=${u.SIYUAN_VERSION}`,"protyleWcHtmlScript"),window.siyuan.config=e.data.conf,window.siyuan.isPublish=e.data.isPublish,await Mb(this),Vy(()=>{mb(`/appearance/langs/${window.siyuan.config.appearance.lang}.json?v=${u.SIYUAN_VERSION}`,n=>{window.siyuan.languages=n,window.siyuan.menus=new o0(this),oT(),E("/api/setting/getCloudUser",{},a=>{window.siyuan.user=a.data,h0(e.data.start,this),jt.onSetaccount(),Oc(window.siyuan.languages.siyuanNote),qS()})})})}),Ei(),zT(this)}}const w0=new y0;window.openFileByURL=t=>{if(t&&Jy(t)){const e=It("focus",t)==="1";return de({app:w0,id:Zr(t),action:e?[u.CB_GET_ALL,u.CB_GET_FOCUS]:[u.CB_GET_FOCUS,u.CB_GET_CONTEXT,u.CB_GET_ROOTSCROLL],zoomIn:e}),!0}return!1}})()})();
